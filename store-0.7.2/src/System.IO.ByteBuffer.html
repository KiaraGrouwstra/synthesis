<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-2"></a><span class="hs-comment">{-@ LIQUID &quot;--no-termination&quot; @-}</span><span>
</span><a name="line-3"></a><span class="hs-comment">{-@ LIQUID &quot;--short-names&quot;    @-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE DeriveDataTypeable #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-9"></a><span class="hs-comment">{-|
Module: System.IO.ByteBuffer
Description: Provides an efficient buffering abstraction.

A 'ByteBuffer' is a simple buffer for bytes.  It supports two
operations: refilling with the contents of a 'ByteString', and
consuming a fixed number of bytes.

It is implemented as a pointer, together with counters that keep track
of the offset and the number of bytes in the buffer.  Note that the
counters are simple 'IORef's, so 'ByteBuffer's are not thread-safe!

A 'ByteBuffer' is constructed by 'new' with a given starting length,
and will grow (by repeatedly multiplying its size by 1.5) whenever it
is being fed a 'ByteString' that is too large.
-}</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">System.IO.ByteBuffer</span><span>
</span><a name="line-27"></a><span>       </span><span class="hs-special">(</span><span> </span><a href="System.IO.ByteBuffer.html#ByteBuffer"><span class="hs-identifier hs-type">ByteBuffer</span></a><span>
</span><a name="line-28"></a><span>         </span><span class="hs-comment">-- * Allocation and Deallocation</span><span>
</span><a name="line-29"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="System.IO.ByteBuffer.html#new"><span class="hs-identifier hs-var">new</span></a><span class="hs-special">,</span><span> </span><a href="System.IO.ByteBuffer.html#free"><span class="hs-identifier hs-var">free</span></a><span class="hs-special">,</span><span> </span><a href="System.IO.ByteBuffer.html#with"><span class="hs-identifier hs-var">with</span></a><span>
</span><a name="line-30"></a><span>         </span><span class="hs-comment">-- * Query for number of available bytes</span><span>
</span><a name="line-31"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="System.IO.ByteBuffer.html#totalSize"><span class="hs-identifier hs-var">totalSize</span></a><span class="hs-special">,</span><span> </span><a href="System.IO.ByteBuffer.html#isEmpty"><span class="hs-identifier hs-var">isEmpty</span></a><span class="hs-special">,</span><span> </span><a href="System.IO.ByteBuffer.html#availableBytes"><span class="hs-identifier hs-var">availableBytes</span></a><span>
</span><a name="line-32"></a><span>         </span><span class="hs-comment">-- * Feeding new input</span><span>
</span><a name="line-33"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="System.IO.ByteBuffer.html#copyByteString"><span class="hs-identifier hs-var">copyByteString</span></a><span>
</span><a name="line-34"></a><span class="hs-cpp">#ifndef mingw32_HOST_OS
</span><span>       </span><span class="hs-special">,</span><span> </span><a href="System.IO.ByteBuffer.html#fillFromFd"><span class="hs-identifier hs-var">fillFromFd</span></a><span>
</span><a name="line-36"></a><span class="hs-cpp">#endif
</span><span>         </span><span class="hs-comment">-- * Consuming bytes from the buffer</span><span>
</span><a name="line-38"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="System.IO.ByteBuffer.html#consume"><span class="hs-identifier hs-var">consume</span></a><span class="hs-special">,</span><span> </span><a href="System.IO.ByteBuffer.html#unsafeConsume"><span class="hs-identifier hs-var">unsafeConsume</span></a><span>
</span><a name="line-39"></a><span>         </span><span class="hs-comment">-- * Exceptions</span><span>
</span><a name="line-40"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="System.IO.ByteBuffer.html#ByteBufferException"><span class="hs-identifier hs-type">ByteBufferException</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span>       </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Applicative</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Exception</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SomeException</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Exception.Lifted</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Exception</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">bracket</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">catch</span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Control.Monad.Fail</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Fail</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad.IO.Class</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad.Trans.Control</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadBaseControl</span><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.ByteString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString.Internal</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BS</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.IORef</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span class="hs-special">)</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Typeable</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Typeable</span><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Word</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Foreign.ForeignPtr</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Foreign.Marshal.Alloc</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Alloc</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Foreign.Marshal.Utils</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">copyBytes</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">moveBytes</span><span class="hs-special">)</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">GHC.Ptr</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Prelude</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Foreign.C.Error</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">CE</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Foreign.C.Types</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">System.Posix.Types</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Fd</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span>
</span><a name="line-64"></a><span class="hs-comment">-- | A buffer into which bytes can be written.</span><span>
</span><a name="line-65"></a><span class="hs-comment">--</span><span>
</span><a name="line-66"></a><span class="hs-comment">-- Invariants:</span><span>
</span><a name="line-67"></a><span class="hs-comment">--</span><span>
</span><a name="line-68"></a><span class="hs-comment">-- * @size &gt;= containedBytes &gt;= consumedBytes &gt;= 0@</span><span>
</span><a name="line-69"></a><span class="hs-comment">--</span><span>
</span><a name="line-70"></a><span class="hs-comment">-- * The range from @ptr@ to @ptr `plusPtr` size@ will be allocated</span><span>
</span><a name="line-71"></a><span class="hs-comment">--</span><span>
</span><a name="line-72"></a><span class="hs-comment">-- * The range from @ptr@ to @ptr `plusPtr` containedBytes@ will</span><span>
</span><a name="line-73"></a><span class="hs-comment">--   contain bytes previously copied to the buffer</span><span>
</span><a name="line-74"></a><span class="hs-comment">--</span><span>
</span><a name="line-75"></a><span class="hs-comment">-- * The buffer contains @containedBytes - consumedBytes@ bytes of</span><span>
</span><a name="line-76"></a><span class="hs-comment">--   data that have been copied to it, but not yet read.  They are in</span><span>
</span><a name="line-77"></a><span class="hs-comment">--   the range from @ptr `plusPtr` consumedBytes@ to @ptr `plusPtr`</span><span>
</span><a name="line-78"></a><span class="hs-comment">--   containedBytes@.</span><span>
</span><a name="line-79"></a><span class="hs-comment">--</span><span>
</span><a name="line-80"></a><span class="hs-comment">-- The first two invariants are encoded in Liquid Haskell, and can</span><span>
</span><a name="line-81"></a><span class="hs-comment">-- be statically checked.</span><span>
</span><a name="line-82"></a><span class="hs-comment">--</span><span>
</span><a name="line-83"></a><span class="hs-comment">-- If an Exception occurs during an operation that modifies a</span><span>
</span><a name="line-84"></a><span class="hs-comment">-- 'ByteBuffer', the 'ByteBuffer' is invalidated and can no longer be</span><span>
</span><a name="line-85"></a><span class="hs-comment">-- used.  Trying to access the 'ByteBuffer' subsequently will result</span><span>
</span><a name="line-86"></a><span class="hs-comment">-- in a 'ByteBufferException' being thrown.</span><span>
</span><a name="line-87"></a><span class="hs-comment">{-@
data BBRef = BBRef
    { size :: {v: Int | v &gt;= 0 }
    , contained :: { v: Int | v &gt;= 0 &amp;&amp; v &lt;= size }
    , consumed :: { v: Int | v &gt;= 0 &amp;&amp; v &lt;= contained }
    , ptr :: { v: Ptr Word8 | (plen v) = size }
    }
@-}</span><span>
</span><a name="line-95"></a><span>
</span><a name="line-96"></a><span class="hs-keyword">data</span><span> </span><a name="BBRef"><a href="System.IO.ByteBuffer.html#BBRef"><span class="hs-identifier">BBRef</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="BBRef"><a href="System.IO.ByteBuffer.html#BBRef"><span class="hs-identifier">BBRef</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-97"></a><span>      </span><a name="size"><a href="System.IO.ByteBuffer.html#size"><span class="hs-identifier">size</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-98"></a><span>      </span><span class="hs-comment">-- ^ The amount of memory allocated.</span><span>
</span><a name="line-99"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="contained"><a href="System.IO.ByteBuffer.html#contained"><span class="hs-identifier">contained</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-100"></a><span>      </span><span class="hs-comment">-- ^ The number of bytes that the 'ByteBuffer' currently holds.</span><span>
</span><a name="line-101"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="consumed"><a href="System.IO.ByteBuffer.html#consumed"><span class="hs-identifier">consumed</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-102"></a><span>      </span><span class="hs-comment">-- ^ The number of bytes that have already been consumed.</span><span>
</span><a name="line-103"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="ptr"><a href="System.IO.ByteBuffer.html#ptr"><span class="hs-identifier">ptr</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Ptr</span><span> </span><span class="hs-identifier hs-type">Word8</span><span class="hs-special">)</span><span>
</span><a name="line-104"></a><span>      </span><span class="hs-comment">-- ^ This points to the beginning of the memory allocated for</span><span>
</span><a name="line-105"></a><span>      </span><span class="hs-comment">-- the 'ByteBuffer'</span><span>
</span><a name="line-106"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-107"></a><span>
</span><a name="line-108"></a><span class="hs-comment">-- | Exception that is thrown when an invalid 'ByteBuffer' is being used that is no longer valid.</span><span>
</span><a name="line-109"></a><span class="hs-comment">--</span><span>
</span><a name="line-110"></a><span class="hs-comment">-- A 'ByteBuffer' is considered to be invalid if</span><span>
</span><a name="line-111"></a><span class="hs-comment">--</span><span>
</span><a name="line-112"></a><span class="hs-comment">-- - it has explicitly been freed</span><span>
</span><a name="line-113"></a><span class="hs-comment">-- - an Exception has occured during an operation that modified it</span><span>
</span><a name="line-114"></a><span class="hs-keyword">data</span><span> </span><a name="ByteBufferException"><a href="System.IO.ByteBuffer.html#ByteBufferException"><span class="hs-identifier">ByteBufferException</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="ByteBufferException"><a href="System.IO.ByteBuffer.html#ByteBufferException"><span class="hs-identifier">ByteBufferException</span></a></a><span>
</span><a name="line-115"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="_bbeLocation"><a href="System.IO.ByteBuffer.html#_bbeLocation"><span class="hs-identifier">_bbeLocation</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-116"></a><span>      </span><span class="hs-comment">-- ^ function name that caused the exception</span><span>
</span><a name="line-117"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="_bbeException"><a href="System.IO.ByteBuffer.html#_bbeException"><span class="hs-identifier">_bbeException</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-118"></a><span>      </span><span class="hs-comment">-- ^ printed representation of the exception</span><span>
</span><a name="line-119"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-120"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Typeable</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-121"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><a href="System.IO.ByteBuffer.html#ByteBufferException"><span class="hs-identifier hs-type">ByteBufferException</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-122"></a><span>    </span><a name="local-8214565720323784705"><span class="hs-identifier">show</span></a><span> </span><span class="hs-special">(</span><a href="System.IO.ByteBuffer.html#ByteBufferException"><span class="hs-identifier hs-var">ByteBufferException</span></a><span> </span><a name="local-6989586621679522999"><a href="#local-6989586621679522999"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621679523000"><a href="#local-6989586621679523000"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concat</span><span>
</span><a name="line-123"></a><span>        </span><span class="hs-special">[</span><span class="hs-string">&quot;ByteBufferException: ByteBuffer was invalidated because of Exception thrown in &quot;</span><span>
</span><a name="line-124"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679522999"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;: &quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679523000"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">]</span><span>
</span><a name="line-125"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Exception</span><span> </span><a href="System.IO.ByteBuffer.html#ByteBufferException"><span class="hs-identifier hs-type">ByteBufferException</span></a><span>
</span><a name="line-126"></a><span>
</span><a name="line-127"></a><span class="hs-keyword">type</span><span> </span><a name="ByteBuffer"><a href="System.IO.ByteBuffer.html#ByteBuffer"><span class="hs-identifier">ByteBuffer</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">IORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="System.IO.ByteBuffer.html#ByteBufferException"><span class="hs-identifier hs-type">ByteBufferException</span></a><span> </span><a href="System.IO.ByteBuffer.html#BBRef"><span class="hs-identifier hs-type">BBRef</span></a><span class="hs-special">)</span><span>
</span><a name="line-128"></a><span>
</span><a name="line-129"></a><span class="hs-comment">-- | On any Exception, this will invalidate the ByteBuffer and re-throw the Exception.</span><span>
</span><a name="line-130"></a><span class="hs-comment">--</span><span>
</span><a name="line-131"></a><span class="hs-comment">-- Invalidating the 'ByteBuffer' includes freeing the underlying pointer.</span><span>
</span><a name="line-132"></a><span class="hs-identifier">bbHandler</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679523022"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-133"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-134"></a><span>       </span><span class="hs-comment">-- ^ location information: function from which the exception was thrown</span><span>
</span><a name="line-135"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="System.IO.ByteBuffer.html#ByteBuffer"><span class="hs-identifier hs-type">ByteBuffer</span></a><span>
</span><a name="line-136"></a><span>       </span><span class="hs-comment">-- ^ this 'ByteBuffer' will be invalidated when an Exception occurs</span><span>
</span><a name="line-137"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="System.IO.ByteBuffer.html#BBRef"><span class="hs-identifier hs-type">BBRef</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679523023"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-138"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679523022"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679523023"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-139"></a><a name="bbHandler"><a href="System.IO.ByteBuffer.html#bbHandler"><span class="hs-identifier">bbHandler</span></a></a><span> </span><a name="local-6989586621679523024"><a href="#local-6989586621679523024"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621679523025"><a href="#local-6989586621679523025"><span class="hs-identifier">bb</span></a></a><span> </span><a name="local-6989586621679523026"><a href="#local-6989586621679523026"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="System.IO.ByteBuffer.html#useBBRef"><span class="hs-identifier hs-var">useBBRef</span></a><span> </span><a href="#local-6989586621679523026"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679523025"><span class="hs-identifier hs-var">bb</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">catch</span><span class="hs-special">`</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679523027"><a href="#local-6989586621679523027"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-140"></a><span>    </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="#local-6989586621679523025"><span class="hs-identifier hs-var">bb</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><a name="line-141"></a><span>        </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679523028"><a href="#local-6989586621679523028"><span class="hs-identifier">bbref</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-142"></a><span>            </span><span class="hs-identifier hs-var">Alloc.free</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ptr</span><span> </span><a href="#local-6989586621679523028"><span class="hs-identifier hs-var">bbref</span></a><span class="hs-special">)</span><span>
</span><a name="line-143"></a><span>            </span><span class="hs-identifier hs-var">writeIORef</span><span> </span><a href="#local-6989586621679523025"><span class="hs-identifier hs-var">bb</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="System.IO.ByteBuffer.html#ByteBufferException"><span class="hs-identifier hs-var">ByteBufferException</span></a><span> </span><a href="#local-6989586621679523024"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679523027"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-144"></a><span>        </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-145"></a><span>    </span><span class="hs-identifier hs-var">throwIO</span><span> </span><a href="#local-6989586621679523027"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-146"></a><span>
</span><a name="line-147"></a><span class="hs-comment">-- | Try to use the 'BBRef' of a 'ByteBuffer', or throw a 'ByteBufferException' if it's invalid.</span><span>
</span><a name="line-148"></a><span class="hs-identifier">useBBRef</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="System.IO.ByteBuffer.html#BBRef"><span class="hs-identifier hs-type">BBRef</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679523021"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="System.IO.ByteBuffer.html#ByteBuffer"><span class="hs-identifier hs-type">ByteBuffer</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679523021"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-149"></a><a name="useBBRef"><a href="System.IO.ByteBuffer.html#useBBRef"><span class="hs-identifier">useBBRef</span></a></a><span> </span><a name="local-6989586621679523029"><a href="#local-6989586621679523029"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679523030"><a href="#local-6989586621679523030"><span class="hs-identifier">bb</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="#local-6989586621679523030"><span class="hs-identifier hs-var">bb</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">either</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span> </span><a href="#local-6989586621679523029"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-150"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">useBBRef</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-151"></a><span>
</span><a name="line-152"></a><span class="hs-identifier">totalSize</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679523020"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="System.IO.ByteBuffer.html#ByteBuffer"><span class="hs-identifier hs-type">ByteBuffer</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679523020"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-153"></a><a name="totalSize"><a href="System.IO.ByteBuffer.html#totalSize"><span class="hs-identifier">totalSize</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="System.IO.ByteBuffer.html#useBBRef"><span class="hs-identifier hs-var">useBBRef</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">size</span><span class="hs-special">)</span><span>
</span><a name="line-154"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">totalSize</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-155"></a><span>
</span><a name="line-156"></a><span class="hs-identifier">isEmpty</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679523019"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="System.IO.ByteBuffer.html#ByteBuffer"><span class="hs-identifier hs-type">ByteBuffer</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679523019"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-157"></a><a name="isEmpty"><a href="System.IO.ByteBuffer.html#isEmpty"><span class="hs-identifier">isEmpty</span></a></a><span> </span><a name="local-6989586621679523031"><a href="#local-6989586621679523031"><span class="hs-identifier">bb</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="System.IO.ByteBuffer.html#availableBytes"><span class="hs-identifier hs-var">availableBytes</span></a><span> </span><a href="#local-6989586621679523031"><span class="hs-identifier hs-var">bb</span></a><span>
</span><a name="line-158"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">isEmpty</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-159"></a><span>
</span><a name="line-160"></a><span class="hs-comment">-- | Number of available bytes in a 'ByteBuffer' (that is, bytes that</span><span>
</span><a name="line-161"></a><span class="hs-comment">-- have been copied to, but not yet read from the 'ByteBuffer'.</span><span>
</span><a name="line-162"></a><span class="hs-comment">{-@ availableBytes :: MonadIO m =&gt; ByteBuffer -&gt; m {v: Int | v &gt;= 0} @-}</span><span>
</span><a name="line-163"></a><span class="hs-identifier">availableBytes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679523018"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="System.IO.ByteBuffer.html#ByteBuffer"><span class="hs-identifier hs-type">ByteBuffer</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679523018"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-164"></a><a name="availableBytes"><a href="System.IO.ByteBuffer.html#availableBytes"><span class="hs-identifier">availableBytes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="System.IO.ByteBuffer.html#useBBRef"><span class="hs-identifier hs-var">useBBRef</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a href="System.IO.ByteBuffer.html#BBRef"><span class="hs-identifier hs-var">BBRef</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679523033"><span class="hs-identifier hs-var">contained</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679523034"><span class="hs-identifier hs-var">consumed</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-165"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">availableBytes</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-166"></a><span>
</span><a name="line-167"></a><span class="hs-comment">-- | Allocates a new ByteBuffer with a given buffer size filling from</span><span>
</span><a name="line-168"></a><span class="hs-comment">-- the given FillBuffer.</span><span>
</span><a name="line-169"></a><span class="hs-comment">--</span><span>
</span><a name="line-170"></a><span class="hs-comment">-- Note that 'ByteBuffer's created with 'new' have to be deallocated</span><span>
</span><a name="line-171"></a><span class="hs-comment">-- explicitly using 'free'.  For automatic deallocation, consider</span><span>
</span><a name="line-172"></a><span class="hs-comment">-- using 'with' instead.</span><span>
</span><a name="line-173"></a><span class="hs-identifier">new</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679523017"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-174"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-175"></a><span>    </span><span class="hs-comment">-- ^ Size of buffer to allocate.  If 'Nothing', use the default</span><span>
</span><a name="line-176"></a><span>    </span><span class="hs-comment">-- value of 4MB</span><span>
</span><a name="line-177"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679523017"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="System.IO.ByteBuffer.html#ByteBuffer"><span class="hs-identifier hs-type">ByteBuffer</span></a><span>
</span><a name="line-178"></a><span>    </span><span class="hs-comment">-- ^ The byte buffer.</span><span>
</span><a name="line-179"></a><a name="new"><a href="System.IO.ByteBuffer.html#new"><span class="hs-identifier">new</span></a></a><span> </span><a name="local-6989586621679523036"><a href="#local-6989586621679523036"><span class="hs-identifier">ml</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-180"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679523037"><a href="#local-6989586621679523037"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">max</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-special">(</span><span class="hs-number">4</span><span class="hs-operator hs-var">*</span><span class="hs-number">1024</span><span class="hs-operator hs-var">*</span><span class="hs-number">1024</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679523036"><span class="hs-identifier hs-var">ml</span></a><span>
</span><a name="line-181"></a><span>    </span><a name="local-6989586621679523038"><a href="#local-6989586621679523038"><span class="hs-identifier">newPtr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Alloc.mallocBytes</span><span> </span><a href="#local-6989586621679523037"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-182"></a><span>    </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><a href="System.IO.ByteBuffer.html#BBRef"><span class="hs-identifier hs-var">BBRef</span></a><span>
</span><a name="line-183"></a><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679523038"><span class="hs-identifier hs-var">newPtr</span></a><span>
</span><a name="line-184"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">size</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679523037"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-185"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">contained</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-186"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">consumed</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-187"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-188"></a><span>
</span><a name="line-189"></a><span class="hs-comment">-- | Free a byte buffer.</span><span>
</span><a name="line-190"></a><span class="hs-identifier">free</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679523016"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="System.IO.ByteBuffer.html#ByteBuffer"><span class="hs-identifier hs-type">ByteBuffer</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679523016"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-191"></a><a name="free"><a href="System.IO.ByteBuffer.html#free"><span class="hs-identifier">free</span></a></a><span> </span><a name="local-6989586621679523039"><a href="#local-6989586621679523039"><span class="hs-identifier">bb</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="#local-6989586621679523039"><span class="hs-identifier hs-var">bb</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><a name="line-192"></a><span>    </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679523040"><a href="#local-6989586621679523040"><span class="hs-identifier">bbref</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-193"></a><span>        </span><span class="hs-identifier hs-var">Alloc.free</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">ptr</span><span> </span><a href="#local-6989586621679523040"><span class="hs-identifier hs-var">bbref</span></a><span>
</span><a name="line-194"></a><span>        </span><span class="hs-identifier hs-var">writeIORef</span><span> </span><a href="#local-6989586621679523039"><span class="hs-identifier hs-var">bb</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-195"></a><span>            </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a href="System.IO.ByteBuffer.html#ByteBufferException"><span class="hs-identifier hs-var">ByteBufferException</span></a><span> </span><span class="hs-string">&quot;free&quot;</span><span> </span><span class="hs-string">&quot;ByteBuffer has explicitly been freed and is no longer valid.&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-196"></a><span>    </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- the ByteBuffer is either invalid or has already been freed.</span><span>
</span><a name="line-197"></a><span>
</span><a name="line-198"></a><span class="hs-comment">-- | Perform some action with a bytebuffer, with automatic allocation</span><span>
</span><a name="line-199"></a><span class="hs-comment">-- and deallocation.</span><span>
</span><a name="line-200"></a><span class="hs-identifier">with</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679523014"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadBaseControl</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679523014"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-201"></a><span>     </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-202"></a><span>     </span><span class="hs-comment">-- ^ Initial length of the 'ByteBuffer'.  If 'Nothing', use the</span><span>
</span><a name="line-203"></a><span>     </span><span class="hs-comment">-- default value of 4MB.</span><span>
</span><a name="line-204"></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="System.IO.ByteBuffer.html#ByteBuffer"><span class="hs-identifier hs-type">ByteBuffer</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679523014"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679523015"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-205"></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679523014"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679523015"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-206"></a><a name="with"><a href="System.IO.ByteBuffer.html#with"><span class="hs-identifier">with</span></a></a><span> </span><a name="local-6989586621679523041"><a href="#local-6989586621679523041"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621679523042"><a href="#local-6989586621679523042"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-207"></a><span>  </span><span class="hs-identifier hs-var">bracket</span><span>
</span><a name="line-208"></a><span>    </span><span class="hs-special">(</span><a href="System.IO.ByteBuffer.html#new"><span class="hs-identifier hs-var">new</span></a><span> </span><a href="#local-6989586621679523041"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span>
</span><a name="line-209"></a><span>    </span><a href="System.IO.ByteBuffer.html#free"><span class="hs-identifier hs-var">free</span></a><span>
</span><a name="line-210"></a><span>    </span><a href="#local-6989586621679523042"><span class="hs-identifier hs-var">action</span></a><span>
</span><a name="line-211"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">with</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-212"></a><span>
</span><a name="line-213"></a><span class="hs-comment">-- | Reset a 'BBRef', i.e. copy all the bytes that have not yet</span><span>
</span><a name="line-214"></a><span class="hs-comment">-- been consumed to the front of the buffer.</span><span>
</span><a name="line-215"></a><span class="hs-comment">{-@ resetBBRef :: b:BBRef -&gt; IO {v:BBRef | consumed v == 0 &amp;&amp; contained v == contained b - consumed b &amp;&amp; size v == size b} @-}</span><span>
</span><a name="line-216"></a><span class="hs-identifier">resetBBRef</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="System.IO.ByteBuffer.html#BBRef"><span class="hs-identifier hs-type">BBRef</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="System.IO.ByteBuffer.html#BBRef"><span class="hs-identifier hs-type">BBRef</span></a><span>
</span><a name="line-217"></a><a name="resetBBRef"><a href="System.IO.ByteBuffer.html#resetBBRef"><span class="hs-identifier">resetBBRef</span></a></a><span> </span><a name="local-6989586621679523043"><a href="#local-6989586621679523043"><span class="hs-identifier">bbref</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-218"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679523044"><a href="#local-6989586621679523044"><span class="hs-identifier">available</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">contained</span><span> </span><a href="#local-6989586621679523043"><span class="hs-identifier hs-var">bbref</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier">consumed</span><span> </span><a href="#local-6989586621679523043"><span class="hs-identifier hs-var">bbref</span></a><span>
</span><a name="line-219"></a><span>    </span><span class="hs-identifier hs-var">moveBytes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ptr</span><span> </span><a href="#local-6989586621679523043"><span class="hs-identifier hs-var">bbref</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ptr</span><span> </span><a href="#local-6989586621679523043"><span class="hs-identifier hs-var">bbref</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusPtr</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">consumed</span><span> </span><a href="#local-6989586621679523043"><span class="hs-identifier hs-var">bbref</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679523044"><span class="hs-identifier hs-var">available</span></a><span>
</span><a name="line-220"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="System.IO.ByteBuffer.html#BBRef"><span class="hs-identifier hs-var">BBRef</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">size</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">size</span><span> </span><a href="#local-6989586621679523043"><span class="hs-identifier hs-var">bbref</span></a><span>
</span><a name="line-221"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">contained</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679523044"><span class="hs-identifier hs-var">available</span></a><span>
</span><a name="line-222"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">consumed</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-223"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ptr</span><span> </span><a href="#local-6989586621679523043"><span class="hs-identifier hs-var">bbref</span></a><span>
</span><a name="line-224"></a><span>                 </span><span class="hs-special">}</span><span>
</span><a name="line-225"></a><span>
</span><a name="line-226"></a><span class="hs-comment">-- | Make sure the buffer is at least @minSize@ bytes long.</span><span>
</span><a name="line-227"></a><span class="hs-comment">--</span><span>
</span><a name="line-228"></a><span class="hs-comment">-- In order to avoid having to enlarge the buffer too often, we</span><span>
</span><a name="line-229"></a><span class="hs-comment">-- multiply its size by a factor of 1.5 until it is at least @minSize@</span><span>
</span><a name="line-230"></a><span class="hs-comment">-- bytes long.</span><span>
</span><a name="line-231"></a><span class="hs-comment">{-@ enlargeBBRef :: b:BBRef -&gt; i:Nat -&gt; IO {v:BBRef | size v &gt;= i &amp;&amp; contained v == contained b &amp;&amp; consumed v == consumed b} @-}</span><span>
</span><a name="line-232"></a><span class="hs-identifier">enlargeBBRef</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="System.IO.ByteBuffer.html#BBRef"><span class="hs-identifier hs-type">BBRef</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="System.IO.ByteBuffer.html#BBRef"><span class="hs-identifier hs-type">BBRef</span></a><span>
</span><a name="line-233"></a><a name="enlargeBBRef"><a href="System.IO.ByteBuffer.html#enlargeBBRef"><span class="hs-identifier">enlargeBBRef</span></a></a><span> </span><a name="local-6989586621679523045"><a href="#local-6989586621679523045"><span class="hs-identifier">bbref</span></a></a><span> </span><a name="local-6989586621679523046"><a href="#local-6989586621679523046"><span class="hs-identifier">minSize</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-234"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679523047"><a href="#local-6989586621679523047"><span class="hs-identifier">getNewSize</span></a></a><span> </span><a name="local-6989586621679523049"><a href="#local-6989586621679523049"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679523049"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621679523046"><span class="hs-identifier hs-var">minSize</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679523049"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-235"></a><span>            </span><span class="hs-identifier">getNewSize</span><span> </span><a name="local-6989586621679523050"><a href="#local-6989586621679523050"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679523047"><span class="hs-identifier hs-var">getNewSize</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ceiling</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">*</span><span class="hs-special">(</span><span class="hs-number">1.5</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Double</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">max</span><span> </span><span class="hs-number">1</span><span> </span><a href="#local-6989586621679523050"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-236"></a><span>            </span><a name="local-6989586621679523048"><a href="#local-6989586621679523048"><span class="hs-identifier">newSize</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679523047"><span class="hs-identifier hs-var">getNewSize</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">size</span><span> </span><a href="#local-6989586621679523045"><span class="hs-identifier hs-var">bbref</span></a><span class="hs-special">)</span><span>
</span><a name="line-237"></a><span>        </span><span class="hs-comment">-- possible optimisation: since reallocation might copy the</span><span>
</span><a name="line-238"></a><span>        </span><span class="hs-comment">-- bytes anyway, we could discard the consumed bytes,</span><span>
</span><a name="line-239"></a><span>        </span><span class="hs-comment">-- basically 'reset'ting the buffer on the fly.</span><span>
</span><a name="line-240"></a><span>        </span><a name="local-6989586621679523051"><a href="#local-6989586621679523051"><span class="hs-identifier">ptr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Alloc.reallocBytes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ptr</span><span> </span><a href="#local-6989586621679523045"><span class="hs-identifier hs-var">bbref</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679523048"><span class="hs-identifier hs-var">newSize</span></a><span>
</span><a name="line-241"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="System.IO.ByteBuffer.html#BBRef"><span class="hs-identifier hs-var">BBRef</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">size</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679523048"><span class="hs-identifier hs-var">newSize</span></a><span>
</span><a name="line-242"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">contained</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">contained</span><span> </span><a href="#local-6989586621679523045"><span class="hs-identifier hs-var">bbref</span></a><span>
</span><a name="line-243"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">consumed</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">consumed</span><span> </span><a href="#local-6989586621679523045"><span class="hs-identifier hs-var">bbref</span></a><span>
</span><a name="line-244"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679523051"><span class="hs-identifier hs-var">ptr'</span></a><span>
</span><a name="line-245"></a><span>                     </span><span class="hs-special">}</span><span>
</span><a name="line-246"></a><span>
</span><a name="line-247"></a><span class="hs-comment">-- | Copy the contents of a 'ByteString' to a 'ByteBuffer'.</span><span>
</span><a name="line-248"></a><span class="hs-comment">--</span><span>
</span><a name="line-249"></a><span class="hs-comment">-- If necessary, the 'ByteBuffer' is enlarged and/or already consumed</span><span>
</span><a name="line-250"></a><span class="hs-comment">-- bytes are dropped.</span><span>
</span><a name="line-251"></a><span class="hs-identifier">copyByteString</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679523013"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="System.IO.ByteBuffer.html#ByteBuffer"><span class="hs-identifier hs-type">ByteBuffer</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679523013"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-252"></a><a name="copyByteString"><a href="System.IO.ByteBuffer.html#copyByteString"><span class="hs-identifier">copyByteString</span></a></a><span> </span><a name="local-6989586621679523052"><a href="#local-6989586621679523052"><span class="hs-identifier">bb</span></a></a><span> </span><a name="local-6989586621679523053"><a href="#local-6989586621679523053"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-253"></a><span>    </span><a href="System.IO.ByteBuffer.html#bbHandler"><span class="hs-identifier hs-var">bbHandler</span></a><span> </span><span class="hs-string">&quot;copyByteString&quot;</span><span> </span><a href="#local-6989586621679523052"><span class="hs-identifier hs-var">bb</span></a><span> </span><a href="#local-6989586621679523054"><span class="hs-identifier hs-var">go</span></a><span>
</span><a name="line-254"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-255"></a><span>    </span><a name="local-6989586621679523054"><a href="#local-6989586621679523054"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679523055"><a href="#local-6989586621679523055"><span class="hs-identifier">bbref</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-256"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679523056"><a href="#local-6989586621679523056"><span class="hs-identifier">bsFptr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679523057"><a href="#local-6989586621679523057"><span class="hs-identifier">bsOffset</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679523058"><a href="#local-6989586621679523058"><span class="hs-identifier">bsSize</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">BS.toForeignPtr</span><span> </span><a href="#local-6989586621679523053"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-257"></a><span>        </span><span class="hs-comment">-- if the byteBuffer is too small, resize it.</span><span>
</span><a name="line-258"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679523059"><a href="#local-6989586621679523059"><span class="hs-identifier">available</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">contained</span><span> </span><a href="#local-6989586621679523055"><span class="hs-identifier hs-var">bbref</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier">consumed</span><span> </span><a href="#local-6989586621679523055"><span class="hs-identifier hs-var">bbref</span></a><span> </span><span class="hs-comment">-- bytes not yet consumed</span><span>
</span><a name="line-259"></a><span>        </span><a name="local-6989586621679523060"><a href="#local-6989586621679523060"><span class="hs-identifier">bbref'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">size</span><span> </span><a href="#local-6989586621679523055"><span class="hs-identifier hs-var">bbref</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679523058"><span class="hs-identifier hs-var">bsSize</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679523059"><span class="hs-identifier hs-var">available</span></a><span>
</span><a name="line-260"></a><span>                  </span><span class="hs-keyword">then</span><span> </span><a href="System.IO.ByteBuffer.html#enlargeBBRef"><span class="hs-identifier hs-var">enlargeBBRef</span></a><span> </span><a href="#local-6989586621679523055"><span class="hs-identifier hs-var">bbref</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679523058"><span class="hs-identifier hs-var">bsSize</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679523059"><span class="hs-identifier hs-var">available</span></a><span class="hs-special">)</span><span>
</span><a name="line-261"></a><span>                  </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679523055"><span class="hs-identifier hs-var">bbref</span></a><span>
</span><a name="line-262"></a><span>        </span><span class="hs-comment">-- if it is currently too full, reset it</span><span>
</span><a name="line-263"></a><span>        </span><a name="local-6989586621679523061"><a href="#local-6989586621679523061"><span class="hs-identifier">bbref''</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679523058"><span class="hs-identifier hs-var">bsSize</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier">contained</span><span> </span><a href="#local-6989586621679523060"><span class="hs-identifier hs-var">bbref'</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-identifier">size</span><span> </span><a href="#local-6989586621679523060"><span class="hs-identifier hs-var">bbref'</span></a><span>
</span><a name="line-264"></a><span>                   </span><span class="hs-keyword">then</span><span> </span><a href="System.IO.ByteBuffer.html#resetBBRef"><span class="hs-identifier hs-var">resetBBRef</span></a><span> </span><a href="#local-6989586621679523060"><span class="hs-identifier hs-var">bbref'</span></a><span>
</span><a name="line-265"></a><span>                   </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679523060"><span class="hs-identifier hs-var">bbref'</span></a><span>
</span><a name="line-266"></a><span>        </span><span class="hs-comment">-- now we can safely copy.</span><span>
</span><a name="line-267"></a><span>        </span><span class="hs-identifier hs-var">withForeignPtr</span><span> </span><a href="#local-6989586621679523056"><span class="hs-identifier hs-var">bsFptr</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621679523093"><a href="#local-6989586621679523093"><span class="hs-identifier">bsPtr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-268"></a><span>            </span><span class="hs-identifier hs-var">copyBytes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ptr</span><span> </span><a href="#local-6989586621679523061"><span class="hs-identifier hs-var">bbref''</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusPtr</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">contained</span><span> </span><a href="#local-6989586621679523061"><span class="hs-identifier hs-var">bbref''</span></a><span class="hs-special">)</span><span>
</span><a name="line-269"></a><span>            </span><span class="hs-special">(</span><a href="#local-6989586621679523093"><span class="hs-identifier hs-var">bsPtr</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusPtr</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679523057"><span class="hs-identifier hs-var">bsOffset</span></a><span class="hs-special">)</span><span>
</span><a name="line-270"></a><span>            </span><a href="#local-6989586621679523058"><span class="hs-identifier hs-var">bsSize</span></a><span>
</span><a name="line-271"></a><span>        </span><span class="hs-identifier hs-var">writeIORef</span><span> </span><a href="#local-6989586621679523052"><span class="hs-identifier hs-var">bb</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><a href="System.IO.ByteBuffer.html#BBRef"><span class="hs-identifier hs-var">BBRef</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-272"></a><span>            </span><span class="hs-identifier">size</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">size</span><span> </span><a href="#local-6989586621679523061"><span class="hs-identifier hs-var">bbref''</span></a><span>
</span><a name="line-273"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">contained</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">contained</span><span> </span><a href="#local-6989586621679523061"><span class="hs-identifier hs-var">bbref''</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679523058"><span class="hs-identifier hs-var">bsSize</span></a><span>
</span><a name="line-274"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">consumed</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">consumed</span><span> </span><a href="#local-6989586621679523061"><span class="hs-identifier hs-var">bbref''</span></a><span>
</span><a name="line-275"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ptr</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ptr</span><span> </span><a href="#local-6989586621679523061"><span class="hs-identifier hs-var">bbref''</span></a><span class="hs-special">}</span><span>
</span><a name="line-276"></a><span>
</span><a name="line-277"></a><span class="hs-cpp">#ifndef mingw32_HOST_OS
</span><span>
</span><a name="line-279"></a><span class="hs-comment">-- | Will read at most n bytes from the given 'Fd', in a non-blocking</span><span>
</span><a name="line-280"></a><span class="hs-comment">-- fashion. This function is intended to be used with non-blocking 'Socket's,</span><span>
</span><a name="line-281"></a><span class="hs-comment">-- such the ones created by the @network@ package.</span><span>
</span><a name="line-282"></a><span class="hs-comment">--</span><span>
</span><a name="line-283"></a><span class="hs-comment">-- Returns how many bytes could be read non-blockingly.</span><span>
</span><a name="line-284"></a><span class="hs-identifier">fillFromFd</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679523012"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Fail.MonadFail</span><span> </span><a href="#local-6989586621679523012"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="System.IO.ByteBuffer.html#ByteBuffer"><span class="hs-identifier hs-type">ByteBuffer</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Fd</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679523012"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-285"></a><a name="fillFromFd"><a href="System.IO.ByteBuffer.html#fillFromFd"><span class="hs-identifier">fillFromFd</span></a></a><span> </span><a name="local-6989586621679523094"><a href="#local-6989586621679523094"><span class="hs-identifier">bb</span></a></a><span> </span><a name="local-6989586621679523095"><a href="#local-6989586621679523095"><span class="hs-identifier">sock</span></a></a><span> </span><a name="local-6989586621679523096"><a href="#local-6989586621679523096"><span class="hs-identifier">maxBytes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679523096"><span class="hs-identifier hs-var">maxBytes</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-286"></a><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;fillFromFd: negative argument (&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679523096"><span class="hs-identifier hs-var">maxBytes</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;)&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-287"></a><span>    </span><span class="hs-keyword">else</span><span> </span><a href="System.IO.ByteBuffer.html#bbHandler"><span class="hs-identifier hs-var">bbHandler</span></a><span> </span><span class="hs-string">&quot;fillFromFd&quot;</span><span> </span><a href="#local-6989586621679523094"><span class="hs-identifier hs-var">bb</span></a><span> </span><a href="#local-6989586621679523097"><span class="hs-identifier hs-var">go</span></a><span>
</span><a name="line-288"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-289"></a><span>    </span><a name="local-6989586621679523097"><a href="#local-6989586621679523097"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679523098"><a href="#local-6989586621679523098"><span class="hs-identifier">bbref</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-290"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621679523099"><a href="#local-6989586621679523099"><span class="hs-identifier">bbref'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679523100"><a href="#local-6989586621679523100"><span class="hs-identifier">readBytes</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="System.IO.ByteBuffer.html#fillBBRefFromFd"><span class="hs-identifier hs-var">fillBBRefFromFd</span></a><span> </span><a href="#local-6989586621679523095"><span class="hs-identifier hs-var">sock</span></a><span> </span><a href="#local-6989586621679523098"><span class="hs-identifier hs-var">bbref</span></a><span> </span><a href="#local-6989586621679523096"><span class="hs-identifier hs-var">maxBytes</span></a><span>
</span><a name="line-291"></a><span>        </span><span class="hs-identifier hs-var">writeIORef</span><span> </span><a href="#local-6989586621679523094"><span class="hs-identifier hs-var">bb</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679523099"><span class="hs-identifier hs-var">bbref'</span></a><span>
</span><a name="line-292"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679523100"><span class="hs-identifier hs-var">readBytes</span></a><span>
</span><a name="line-293"></a><span>
</span><a name="line-294"></a><span class="hs-comment">{-
Note: I'd like to use these two definitions:

{-@ measure _available @-}
_available :: BBRef -&gt; Int
_available BBRef{..} = contained - consumed

{-@ measure _free @-}
_free :: BBRef -&gt; Int
_free BBRef{..} = size - contained

but for some reason when I try to do so it does not work.
-}</span><span>
</span><a name="line-307"></a><span>
</span><a name="line-308"></a><span class="hs-comment">{-@ fillBBRefFromFd ::
       Fd -&gt; b0: BBRef
    -&gt; maxBytes: Nat -&gt; IO {v: (BBRef, Nat) | maxBytes &gt;= snd v &amp;&amp; contained (fst v) - consumed (fst v) == contained b0 - consumed b0 + snd v}
  @-}</span><span>
</span><a name="line-312"></a><span class="hs-identifier">fillBBRefFromFd</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Fd</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="System.IO.ByteBuffer.html#BBRef"><span class="hs-identifier hs-type">BBRef</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="System.IO.ByteBuffer.html#BBRef"><span class="hs-identifier hs-type">BBRef</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-313"></a><a name="fillBBRefFromFd"><a href="System.IO.ByteBuffer.html#fillBBRefFromFd"><span class="hs-identifier">fillBBRefFromFd</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Fd</span><span> </span><a name="local-6989586621679523101"><a href="#local-6989586621679523101"><span class="hs-identifier">sock</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679523102"><a href="#local-6989586621679523102"><span class="hs-identifier">bbref0</span></a></a><span> </span><a name="local-6989586621679523103"><a href="#local-6989586621679523103"><span class="hs-identifier">maxBytes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-314"></a><span>  </span><a name="local-6989586621679523117"><a href="#local-6989586621679523117"><span class="hs-identifier">bbref1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679523104"><span class="hs-identifier hs-var">prepareSpace</span></a><span> </span><a href="#local-6989586621679523102"><span class="hs-identifier hs-var">bbref0</span></a><span>
</span><a name="line-315"></a><span>  </span><a href="#local-6989586621679523105"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621679523117"><span class="hs-identifier hs-var">bbref1</span></a><span>
</span><a name="line-316"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-317"></a><span>    </span><span class="hs-comment">-- We enlarge the buffer directly to be able to contain the maximum number</span><span>
</span><a name="line-318"></a><span>    </span><span class="hs-comment">-- of bytes since the common pattern for this function is to know how many</span><span>
</span><a name="line-319"></a><span>    </span><span class="hs-comment">-- bytes we need to read -- so we'll eventually fill the enlarged buffer.</span><span>
</span><a name="line-320"></a><span>    </span><span class="hs-comment">{-@ prepareSpace :: b: BBRef -&gt; IO {v: BBRef | size v - contained v &gt;= maxBytes &amp;&amp; contained b - consumed b == contained v - consumed v} @-}</span><span>
</span><a name="line-321"></a><span>    </span><span class="hs-identifier">prepareSpace</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="System.IO.ByteBuffer.html#BBRef"><span class="hs-identifier hs-type">BBRef</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="System.IO.ByteBuffer.html#BBRef"><span class="hs-identifier hs-type">BBRef</span></a><span>
</span><a name="line-322"></a><span>    </span><a name="local-6989586621679523104"><a href="#local-6989586621679523104"><span class="hs-identifier">prepareSpace</span></a></a><span> </span><a name="local-6989586621679523106"><a href="#local-6989586621679523106"><span class="hs-identifier">bbref</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-323"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679523107"><a href="#local-6989586621679523107"><span class="hs-identifier">space</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">size</span><span> </span><a href="#local-6989586621679523106"><span class="hs-identifier hs-var">bbref</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier">contained</span><span> </span><a href="#local-6989586621679523106"><span class="hs-identifier hs-var">bbref</span></a><span>
</span><a name="line-324"></a><span>      </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679523107"><span class="hs-identifier hs-var">space</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679523103"><span class="hs-identifier hs-var">maxBytes</span></a><span>
</span><a name="line-325"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">consumed</span><span> </span><a href="#local-6989586621679523106"><span class="hs-identifier hs-var">bbref</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-326"></a><span>          </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679523104"><span class="hs-identifier hs-var">prepareSpace</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="System.IO.ByteBuffer.html#resetBBRef"><span class="hs-identifier hs-var">resetBBRef</span></a><span> </span><a href="#local-6989586621679523106"><span class="hs-identifier hs-var">bbref</span></a><span>
</span><a name="line-327"></a><span>          </span><span class="hs-keyword">else</span><span> </span><a href="System.IO.ByteBuffer.html#enlargeBBRef"><span class="hs-identifier hs-var">enlargeBBRef</span></a><span> </span><a href="#local-6989586621679523106"><span class="hs-identifier hs-var">bbref</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">contained</span><span> </span><a href="#local-6989586621679523106"><span class="hs-identifier hs-var">bbref</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679523103"><span class="hs-identifier hs-var">maxBytes</span></a><span class="hs-special">)</span><span>
</span><a name="line-328"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679523106"><span class="hs-identifier hs-var">bbref</span></a><span>
</span><a name="line-329"></a><span>
</span><a name="line-330"></a><span>    </span><span class="hs-comment">{-@ go ::
           readBytes: {v: Nat | v &lt;= maxBytes}
        -&gt; b: {b: BBRef | size b - contained b &gt;= maxBytes - readBytes}
        -&gt; IO {v: (BBRef, Nat) | maxBytes &gt;= snd v &amp;&amp; snd v &gt;= readBytes &amp;&amp; size (fst v) - contained (fst v) &gt;= maxBytes - snd v &amp;&amp; contained (fst v) - consumed (fst v) == (contained b - consumed b) + (snd v - readBytes)}
      @-}</span><span>
</span><a name="line-335"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="System.IO.ByteBuffer.html#BBRef"><span class="hs-identifier hs-type">BBRef</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="System.IO.ByteBuffer.html#BBRef"><span class="hs-identifier hs-type">BBRef</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-336"></a><span>    </span><a name="local-6989586621679523105"><a href="#local-6989586621679523105"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679523108"><a href="#local-6989586621679523108"><span class="hs-identifier">readBytes</span></a></a><span> </span><a name="local-6989586621679523109"><a href="#local-6989586621679523109"><span class="hs-identifier">bbref</span></a></a><span class="hs-glyph">@</span><a href="System.IO.ByteBuffer.html#BBRef"><span class="hs-identifier hs-var">BBRef</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679523108"><span class="hs-identifier hs-var">readBytes</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621679523103"><span class="hs-identifier hs-var">maxBytes</span></a><span>
</span><a name="line-337"></a><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679523109"><span class="hs-identifier hs-var">bbref</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679523108"><span class="hs-identifier hs-var">readBytes</span></a><span class="hs-special">)</span><span>
</span><a name="line-338"></a><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-339"></a><span>        </span><a name="local-6989586621679523114"><a href="#local-6989586621679523114"><span class="hs-identifier">bytes</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="System.IO.ByteBuffer.html#c_recv"><span class="hs-identifier hs-var">c_recv</span></a><span> </span><a href="#local-6989586621679523101"><span class="hs-identifier hs-var">sock</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">castPtr</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679523113"><span class="hs-identifier hs-var">ptr</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusPtr</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679523111"><span class="hs-identifier hs-var">contained</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679523103"><span class="hs-identifier hs-var">maxBytes</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679523108"><span class="hs-identifier hs-var">readBytes</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-340"></a><span>        </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679523114"><span class="hs-identifier hs-var">bytes</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-glyph">-</span><span class="hs-number">1</span><span>
</span><a name="line-341"></a><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-342"></a><span>            </span><a name="local-6989586621679523115"><a href="#local-6989586621679523115"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">CE.getErrno</span><span>
</span><a name="line-343"></a><span>            </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679523115"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">CE.eAGAIN</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621679523115"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">CE.eWOULDBLOCK</span><span>
</span><a name="line-344"></a><span>              </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679523109"><span class="hs-identifier hs-var">bbref</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679523108"><span class="hs-identifier hs-var">readBytes</span></a><span class="hs-special">)</span><span>
</span><a name="line-345"></a><span>              </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">CE.errnoToIOError</span><span> </span><span class="hs-string">&quot;ByteBuffer.fillBBRefFromFd: &quot;</span><span> </span><a href="#local-6989586621679523115"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-346"></a><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-347"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679523116"><a href="#local-6989586621679523116"><span class="hs-identifier">bbref'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679523109"><span class="hs-identifier hs-var">bbref</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">contained</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679523111"><span class="hs-identifier hs-var">contained</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679523114"><span class="hs-identifier hs-var">bytes</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-348"></a><span>            </span><a href="#local-6989586621679523105"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679523108"><span class="hs-identifier hs-var">readBytes</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679523114"><span class="hs-identifier hs-var">bytes</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679523116"><span class="hs-identifier hs-var">bbref'</span></a><span>
</span><a name="line-349"></a><span>
</span><a name="line-350"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;recv&quot;</span><span>
</span><a name="line-351"></a><span>  </span><span class="hs-comment">-- c_recv returns -1 in the case of errors.</span><span>
</span><a name="line-352"></a><span>  </span><span class="hs-comment">{-@ assume c_recv :: CInt -&gt; Ptr CChar -&gt; size: {v: CSize | v &gt;= 0} -&gt; flags: CInt -&gt; IO {read: CInt | read &gt;= -1 &amp;&amp; size &gt;= read} @-}</span><span>
</span><a name="line-353"></a><span>  </span><span class="hs-identifier">c_recv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CInt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><span class="hs-identifier hs-type">CChar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CSize</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CInt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">CInt</span><span>
</span><a name="line-354"></a><span>
</span><a name="line-355"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-357"></a><span class="hs-comment">-- | Try to get a pointer to @n@ bytes from the 'ByteBuffer'.</span><span>
</span><a name="line-358"></a><span class="hs-comment">--</span><span>
</span><a name="line-359"></a><span class="hs-comment">-- Note that the pointer should be used before any other actions are</span><span>
</span><a name="line-360"></a><span class="hs-comment">-- performed on the 'ByteBuffer'. It points to some address within the</span><span>
</span><a name="line-361"></a><span class="hs-comment">-- buffer, so operations such as enlarging the buffer or feeding it</span><span>
</span><a name="line-362"></a><span class="hs-comment">-- new data will change the data the pointer points to.  This is why</span><span>
</span><a name="line-363"></a><span class="hs-comment">-- this function is called unsafe.</span><span>
</span><a name="line-364"></a><span class="hs-comment">{-@ unsafeConsume :: MonadIO m =&gt; ByteBuffer -&gt; n:Nat -&gt; m (Either Int ({v:Ptr Word8 | plen v &gt;= n})) @-}</span><span>
</span><a name="line-365"></a><span class="hs-identifier">unsafeConsume</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679523011"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-366"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><a href="System.IO.ByteBuffer.html#ByteBuffer"><span class="hs-identifier hs-type">ByteBuffer</span></a><span>
</span><a name="line-367"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-368"></a><span>        </span><span class="hs-comment">-- ^ n</span><span>
</span><a name="line-369"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679523011"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Ptr</span><span> </span><span class="hs-identifier hs-type">Word8</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-370"></a><span>        </span><span class="hs-comment">-- ^ Will be @Left missing@ when there are only @n-missing@</span><span>
</span><a name="line-371"></a><span>        </span><span class="hs-comment">-- bytes left in the 'ByteBuffer'.</span><span>
</span><a name="line-372"></a><a name="unsafeConsume"><a href="System.IO.ByteBuffer.html#unsafeConsume"><span class="hs-identifier">unsafeConsume</span></a></a><span> </span><a name="local-6989586621679523118"><a href="#local-6989586621679523118"><span class="hs-identifier">bb</span></a></a><span> </span><a name="local-6989586621679523119"><a href="#local-6989586621679523119"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-373"></a><span>    </span><a href="System.IO.ByteBuffer.html#bbHandler"><span class="hs-identifier hs-var">bbHandler</span></a><span> </span><span class="hs-string">&quot;unsafeConsume&quot;</span><span> </span><a href="#local-6989586621679523118"><span class="hs-identifier hs-var">bb</span></a><span> </span><a href="#local-6989586621679523120"><span class="hs-identifier hs-var">go</span></a><span>
</span><a name="line-374"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-375"></a><span>    </span><a name="local-6989586621679523120"><a href="#local-6989586621679523120"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679523121"><a href="#local-6989586621679523121"><span class="hs-identifier">bbref</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-376"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679523122"><a href="#local-6989586621679523122"><span class="hs-identifier">available</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">contained</span><span> </span><a href="#local-6989586621679523121"><span class="hs-identifier hs-var">bbref</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier">consumed</span><span> </span><a href="#local-6989586621679523121"><span class="hs-identifier hs-var">bbref</span></a><span>
</span><a name="line-377"></a><span>        </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679523122"><span class="hs-identifier hs-var">available</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679523119"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-378"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679523119"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621679523122"><span class="hs-identifier hs-var">available</span></a><span class="hs-special">)</span><span>
</span><a name="line-379"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-380"></a><span>                </span><span class="hs-identifier hs-var">writeIORef</span><span> </span><a href="#local-6989586621679523118"><span class="hs-identifier hs-var">bb</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679523121"><span class="hs-identifier hs-var">bbref</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">consumed</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">consumed</span><span> </span><a href="#local-6989586621679523121"><span class="hs-identifier hs-var">bbref</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621679523119"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-381"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ptr</span><span> </span><a href="#local-6989586621679523121"><span class="hs-identifier hs-var">bbref</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusPtr</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">consumed</span><span> </span><a href="#local-6989586621679523121"><span class="hs-identifier hs-var">bbref</span></a><span class="hs-special">)</span><span>
</span><a name="line-382"></a><span>
</span><a name="line-383"></a><span class="hs-comment">-- | As `unsafeConsume`, but instead of returning a `Ptr` into the</span><span>
</span><a name="line-384"></a><span class="hs-comment">-- contents of the `ByteBuffer`, it returns a `ByteString` containing</span><span>
</span><a name="line-385"></a><span class="hs-comment">-- the next @n@ bytes in the buffer.  This involves allocating a new</span><span>
</span><a name="line-386"></a><span class="hs-comment">-- 'ByteString' and copying the @n@ bytes to it.</span><span>
</span><a name="line-387"></a><span class="hs-comment">{-@ consume :: MonadIO m =&gt; ByteBuffer -&gt; Nat -&gt; m (Either Int ByteString) @-}</span><span>
</span><a name="line-388"></a><span class="hs-identifier">consume</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679523010"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-389"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><a href="System.IO.ByteBuffer.html#ByteBuffer"><span class="hs-identifier hs-type">ByteBuffer</span></a><span>
</span><a name="line-390"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-391"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679523010"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">)</span><span>
</span><a name="line-392"></a><a name="consume"><a href="System.IO.ByteBuffer.html#consume"><span class="hs-identifier">consume</span></a></a><span> </span><a name="local-6989586621679523123"><a href="#local-6989586621679523123"><span class="hs-identifier">bb</span></a></a><span> </span><a name="local-6989586621679523124"><a href="#local-6989586621679523124"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-393"></a><span>    </span><a name="local-6989586621679523125"><a href="#local-6989586621679523125"><span class="hs-identifier">mPtr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="System.IO.ByteBuffer.html#unsafeConsume"><span class="hs-identifier hs-var">unsafeConsume</span></a><span> </span><a href="#local-6989586621679523123"><span class="hs-identifier hs-var">bb</span></a><span> </span><a href="#local-6989586621679523124"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-394"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679523125"><span class="hs-identifier hs-var">mPtr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-395"></a><span>        </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679523126"><a href="#local-6989586621679523126"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-396"></a><span>            </span><a name="local-6989586621679523127"><a href="#local-6989586621679523127"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="System.IO.ByteBuffer.html#createBS"><span class="hs-identifier hs-var">createBS</span></a><span> </span><a href="#local-6989586621679523126"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621679523124"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-397"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679523127"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span>
</span><a name="line-398"></a><span>        </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679523128"><a href="#local-6989586621679523128"><span class="hs-identifier">missing</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621679523128"><span class="hs-identifier hs-var">missing</span></a><span class="hs-special">)</span><span>
</span><a name="line-399"></a><span>
</span><a name="line-400"></a><span class="hs-comment">{-@ createBS :: p:(Ptr Word8) -&gt; {v:Nat | v &lt;= plen p} -&gt; IO ByteString @-}</span><span>
</span><a name="line-401"></a><span class="hs-identifier">createBS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><span class="hs-identifier hs-type">Word8</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span>
</span><a name="line-402"></a><a name="createBS"><a href="System.IO.ByteBuffer.html#createBS"><span class="hs-identifier">createBS</span></a></a><span> </span><a name="local-6989586621679523129"><a href="#local-6989586621679523129"><span class="hs-identifier">ptr</span></a></a><span> </span><a name="local-6989586621679523130"><a href="#local-6989586621679523130"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-403"></a><span>  </span><a name="local-6989586621679523131"><a href="#local-6989586621679523131"><span class="hs-identifier">fp</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mallocForeignPtrBytes</span><span> </span><a href="#local-6989586621679523130"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-404"></a><span>  </span><span class="hs-identifier hs-var">withForeignPtr</span><span> </span><a href="#local-6989586621679523131"><span class="hs-identifier hs-var">fp</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679523132"><a href="#local-6989586621679523132"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">copyBytes</span><span> </span><a href="#local-6989586621679523132"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621679523129"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621679523130"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-405"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BS.PS</span><span> </span><a href="#local-6989586621679523131"><span class="hs-identifier hs-var">fp</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621679523130"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-406"></a><span>
</span><a name="line-407"></a><span class="hs-comment">-- below are liquid haskell qualifiers, and specifications for external functions.</span><span>
</span><a name="line-408"></a><span>
</span><a name="line-409"></a><span class="hs-comment">{-@ qualif FPLenPLen(v:Ptr a, fp:ForeignPtr a): fplen fp = plen v @-}</span><span>
</span><a name="line-410"></a><span>
</span><a name="line-411"></a><span class="hs-comment">{-@ Foreign.Marshal.Alloc.mallocBytes :: l:Nat -&gt; IO (PtrN a l) @-}</span><span>
</span><a name="line-412"></a><span class="hs-comment">{-@ Foreign.Marshal.Alloc.reallocBytes :: Ptr a -&gt; l:Nat -&gt; IO (PtrN a l) @-}</span><span>
</span><a name="line-413"></a><span class="hs-comment">{-@ assume mallocForeignPtrBytes :: n:Nat -&gt; IO (ForeignPtrN a n) @-}</span><span>
</span><a name="line-414"></a><span class="hs-comment">{-@ type ForeignPtrN a N = {v:ForeignPtr a | fplen v = N} @-}</span><span>
</span><a name="line-415"></a><span class="hs-comment">{-@ Foreign.Marshal.Utils.copyBytes :: p:Ptr a -&gt; q:Ptr a -&gt; {v:Nat | v &lt;= plen p &amp;&amp; v &lt;= plen q} -&gt; IO ()@-}</span><span>
</span><a name="line-416"></a><span class="hs-comment">{-@ Foreign.Marshal.Utils.moveBytes :: p:Ptr a -&gt; q:Ptr a -&gt; {v:Nat | v &lt;= plen p &amp;&amp; v &lt;= plen q} -&gt; IO ()@-}</span><span>
</span><a name="line-417"></a><span class="hs-comment">{-@ Foreign.Ptr.plusPtr :: p:Ptr a -&gt; n:Nat -&gt; {v:Ptr b | plen v == (plen p) - n} @-}</span><span>
</span><a name="line-418"></a><span>
</span><a name="line-419"></a><span class="hs-comment">-- writing down the specification for ByteString is not as straightforward as it seems at first: the constructor</span><span>
</span><a name="line-420"></a><span class="hs-comment">--</span><span>
</span><a name="line-421"></a><span class="hs-comment">-- PS (ForeignPtr Word8) Int Int</span><span>
</span><a name="line-422"></a><span class="hs-comment">--</span><span>
</span><a name="line-423"></a><span class="hs-comment">-- has actually four arguments after unboxing (the ForeignPtr is an</span><span>
</span><a name="line-424"></a><span class="hs-comment">-- Addr# and ForeignPtrContents), so restriciting the length of the</span><span>
</span><a name="line-425"></a><span class="hs-comment">-- ForeignPtr directly in the specification of the datatype does not</span><span>
</span><a name="line-426"></a><span class="hs-comment">-- work.  Instead, I chose to write a specification for toForeignPtr.</span><span>
</span><a name="line-427"></a><span class="hs-comment">-- It seems that the liquidhaskell parser has problems with variables</span><span>
</span><a name="line-428"></a><span class="hs-comment">-- declared in a tuple, so I have to define the following measures to</span><span>
</span><a name="line-429"></a><span class="hs-comment">-- get at the ForeignPtr, offset, and length.</span><span>
</span><a name="line-430"></a><span class="hs-comment">--</span><span>
</span><a name="line-431"></a><span class="hs-comment">-- This is a bit awkward, maybe there is an easier way.</span><span>
</span><a name="line-432"></a><span>
</span><a name="line-433"></a><span class="hs-identifier">_get1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679523007"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><a href="#local-6989586621679523008"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><a href="#local-6989586621679523009"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679523007"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-434"></a><a name="_get1"><a href="System.IO.ByteBuffer.html#_get1"><span class="hs-identifier">_get1</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679523133"><a href="#local-6989586621679523133"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679523133"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-435"></a><span class="hs-comment">{-@ measure _get1 @-}</span><span>
</span><a name="line-436"></a><span class="hs-identifier">_get2</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679523004"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><a href="#local-6989586621679523005"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><a href="#local-6989586621679523006"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679523005"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-437"></a><a name="_get2"><a href="System.IO.ByteBuffer.html#_get2"><span class="hs-identifier">_get2</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621679523134"><a href="#local-6989586621679523134"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679523134"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-438"></a><span class="hs-comment">{-@ measure _get2 @-}</span><span>
</span><a name="line-439"></a><span class="hs-identifier">_get3</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679523001"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><a href="#local-6989586621679523002"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><a href="#local-6989586621679523003"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679523003"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-440"></a><a name="_get3"><a href="System.IO.ByteBuffer.html#_get3"><span class="hs-identifier">_get3</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621679523135"><a href="#local-6989586621679523135"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679523135"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-441"></a><span class="hs-comment">{-@ measure _get3 @-}</span><span>
</span><a name="line-442"></a><span>
</span><a name="line-443"></a><span class="hs-comment">{-@ Data.ByteString.Internal.toForeignPtr :: ByteString -&gt;
  {v:(ForeignPtr Word8, Int, Int) | _get2 v &gt;= 0
                                 &amp;&amp; _get2 v &lt;= (fplen (_get1 v))
                                 &amp;&amp; _get3 v &gt;= 0
                                 &amp;&amp; ((_get3 v) + (_get2 v)) &lt;= (fplen (_get1 v))} @-}</span><span>
</span><a name="line-448"></a></pre></body></html>