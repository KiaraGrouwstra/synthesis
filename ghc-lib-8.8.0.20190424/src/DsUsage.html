<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE TupleSections #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE ViewPatterns #-}</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">DsUsage</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-6"></a><span>    </span><span class="hs-comment">-- * Dependency/fingerprinting code (used by MkIface)</span><span>
</span><a name="line-7"></a><span>    </span><a href="DsUsage.html#mkUsageInfo"><span class="hs-identifier hs-var">mkUsageInfo</span></a><span class="hs-special">,</span><span> </span><a href="DsUsage.html#mkUsedNames"><span class="hs-identifier hs-var">mkUsedNames</span></a><span class="hs-special">,</span><span> </span><a href="DsUsage.html#mkDependencies"><span class="hs-identifier hs-var">mkDependencies</span></a><span>
</span><a name="line-8"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcRnTypes</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameSet</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSet</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqFM</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Fingerprint</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Packages</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="Finder.html"><span class="hs-identifier">Finder</span></a><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filterM</span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.IORef</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Set</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Directory</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.FilePath</span><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span class="hs-comment">{- Note [Module self-dependency]
   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

RnNames.calculateAvails asserts the invariant that a module must not occur in
its own dep_orphs or dep_finsts. However, if we aren't careful this can occur
in the presence of hs-boot files: Consider that we have two modules, A and B,
both with hs-boot files,

    A.hs contains a SOURCE import of B B.hs-boot contains a SOURCE import of A
    A.hs-boot declares an orphan instance A.hs defines the orphan instance

In this case, B's dep_orphs will contain A due to its SOURCE import of A.
Consequently, A will contain itself in its imp_orphs due to its import of B.
This fact would end up being recorded in A's interface file. This would then
break the invariant asserted by calculateAvails that a module does not itself in
its dep_orphs. This was the cause of Trac #14128.

-}</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span class="hs-comment">-- | Extract information from the rename and typecheck phases to produce</span><span>
</span><a name="line-58"></a><span class="hs-comment">-- a dependencies information for the module being compiled.</span><span>
</span><a name="line-59"></a><span class="hs-comment">--</span><span>
</span><a name="line-60"></a><span class="hs-comment">-- The first argument is additional dependencies from plugins</span><span>
</span><a name="line-61"></a><span class="hs-identifier">mkDependencies</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">InstalledUnitId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Module</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Dependencies</span><span>
</span><a name="line-62"></a><a name="mkDependencies"><a href="DsUsage.html#mkDependencies"><span class="hs-identifier">mkDependencies</span></a></a><span> </span><a name="local-6989586621679505096"><a href="#local-6989586621679505096"><span class="hs-identifier">iuid</span></a></a><span> </span><a name="local-6989586621679505097"><a href="#local-6989586621679505097"><span class="hs-identifier">pluginModules</span></a></a><span>
</span><a name="line-63"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TcGblEnv</span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_mod</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679505098"><a href="#local-6989586621679505098"><span class="hs-identifier">mod</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-64"></a><span>                    </span><span class="hs-identifier">tcg_imports</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679505099"><a href="#local-6989586621679505099"><span class="hs-identifier">imports</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-65"></a><span>                    </span><span class="hs-identifier">tcg_th_used</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679505100"><a href="#local-6989586621679505100"><span class="hs-identifier">th_var</span></a></a><span>
</span><a name="line-66"></a><span>                  </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-68"></a><span>      </span><span class="hs-comment">-- Template Haskell used?</span><span>
</span><a name="line-69"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679505101"><a href="#local-6989586621679505101"><span class="hs-identifier">dep_plgins</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679505102"><a href="#local-6989586621679505102"><span class="hs-identifier">ms</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621679505104"><span class="hs-identifier hs-var">mn</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679505104"><span class="hs-identifier hs-var">mn</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621679505104"><a href="#local-6989586621679505104"><span class="hs-identifier">mn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679505097"><span class="hs-identifier hs-var">pluginModules</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-70"></a><span>          </span><a name="local-6989586621679505103"><a href="#local-6989586621679505103"><span class="hs-identifier">plugin_dep_pkgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621679505096"><span class="hs-identifier hs-var">iuid</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toInstalledUnitId</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">moduleUnitId</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679505102"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span>      </span><a name="local-6989586621679505105"><a href="#local-6989586621679505105"><span class="hs-identifier">th_used</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="#local-6989586621679505100"><span class="hs-identifier hs-var">th_var</span></a><span>
</span><a name="line-72"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679505106"><a href="#local-6989586621679505106"><span class="hs-identifier">dep_mods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modDepsElts</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">delFromUFM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">imp_dep_mods</span><span> </span><a href="#local-6989586621679505099"><span class="hs-identifier hs-var">imports</span></a><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span>                                             </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621679505098"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span>                </span><span class="hs-comment">-- M.hi-boot can be in the imp_dep_mods, but we must remove</span><span>
</span><a name="line-75"></a><span>                </span><span class="hs-comment">-- it before recording the modules on which this one depends!</span><span>
</span><a name="line-76"></a><span>                </span><span class="hs-comment">-- (We want to retain M.hi-boot in imp_dep_mods so that</span><span>
</span><a name="line-77"></a><span>                </span><span class="hs-comment">--  loadHiBootInterface can see if M's direct imports depend</span><span>
</span><a name="line-78"></a><span>                </span><span class="hs-comment">--  on M.hi-boot, and hence that we should do the hi-boot consistency</span><span>
</span><a name="line-79"></a><span>                </span><span class="hs-comment">--  check.)</span><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span>          </span><a name="local-6989586621679505107"><a href="#local-6989586621679505107"><span class="hs-identifier">dep_orphs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621679505098"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">imp_orphs</span><span> </span><a href="#local-6989586621679505099"><span class="hs-identifier hs-var">imports</span></a><span class="hs-special">)</span><span>
</span><a name="line-82"></a><span>                </span><span class="hs-comment">-- We must also remove self-references from imp_orphs. See</span><span>
</span><a name="line-83"></a><span>                </span><span class="hs-comment">-- Note [Module self-dependency]</span><span>
</span><a name="line-84"></a><span>
</span><a name="line-85"></a><span>          </span><a name="local-6989586621679505108"><a href="#local-6989586621679505108"><span class="hs-identifier">raw_pkgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-identifier hs-var">Set.insert</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">imp_dep_pkgs</span><span> </span><a href="#local-6989586621679505099"><span class="hs-identifier hs-var">imports</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679505103"><span class="hs-identifier hs-var">plugin_dep_pkgs</span></a><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span>          </span><a name="local-6989586621679505109"><a href="#local-6989586621679505109"><span class="hs-identifier">pkgs</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679505105"><span class="hs-identifier hs-var">th_used</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.insert</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toInstalledUnitId</span><span> </span><span class="hs-identifier hs-var">thUnitId</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679505108"><span class="hs-identifier hs-var">raw_pkgs</span></a><span>
</span><a name="line-88"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679505108"><span class="hs-identifier hs-var">raw_pkgs</span></a><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span>          </span><span class="hs-comment">-- Set the packages required to be Safe according to Safe Haskell.</span><span>
</span><a name="line-91"></a><span>          </span><span class="hs-comment">-- See Note [RnNames . Tracking Trust Transitively]</span><span>
</span><a name="line-92"></a><span>          </span><a name="local-6989586621679505110"><a href="#local-6989586621679505110"><span class="hs-identifier">sorted_pkgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sort</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.toList</span><span> </span><a href="#local-6989586621679505109"><span class="hs-identifier hs-var">pkgs</span></a><span class="hs-special">)</span><span>
</span><a name="line-93"></a><span>          </span><a name="local-6989586621679505111"><a href="#local-6989586621679505111"><span class="hs-identifier">trust_pkgs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">imp_trust_pkgs</span><span> </span><a href="#local-6989586621679505099"><span class="hs-identifier hs-var">imports</span></a><span>
</span><a name="line-94"></a><span>          </span><a name="local-6989586621679505112"><a href="#local-6989586621679505112"><span class="hs-identifier">dep_pkgs'</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679505113"><a href="#local-6989586621679505113"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679505113"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679505113"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Set.member</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679505111"><span class="hs-identifier hs-var">trust_pkgs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679505110"><span class="hs-identifier hs-var">sorted_pkgs</span></a><span>
</span><a name="line-95"></a><span>
</span><a name="line-96"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Deps</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dep_mods</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679505106"><span class="hs-identifier hs-var">dep_mods</span></a><span class="hs-special">,</span><span>
</span><a name="line-97"></a><span>                    </span><span class="hs-identifier">dep_pkgs</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679505112"><span class="hs-identifier hs-var">dep_pkgs'</span></a><span class="hs-special">,</span><span>
</span><a name="line-98"></a><span>                    </span><span class="hs-identifier">dep_orphs</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679505107"><span class="hs-identifier hs-var">dep_orphs</span></a><span class="hs-special">,</span><span>
</span><a name="line-99"></a><span>                    </span><span class="hs-identifier">dep_plgins</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679505101"><span class="hs-identifier hs-var">dep_plgins</span></a><span class="hs-special">,</span><span>
</span><a name="line-100"></a><span>                    </span><span class="hs-identifier">dep_finsts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-identifier hs-var">stableModuleCmp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">imp_finsts</span><span> </span><a href="#local-6989586621679505099"><span class="hs-identifier hs-var">imports</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-101"></a><span>                    </span><span class="hs-comment">-- sort to get into canonical order</span><span>
</span><a name="line-102"></a><span>                    </span><span class="hs-comment">-- NB. remember to use lexicographic ordering</span><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span class="hs-identifier">mkUsedNames</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span>
</span><a name="line-105"></a><a name="mkUsedNames"><a href="DsUsage.html#mkUsedNames"><span class="hs-identifier">mkUsedNames</span></a></a><span> </span><span class="hs-identifier hs-var">TcGblEnv</span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_dus</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621679505114"><a href="#local-6989586621679505114"><span class="hs-identifier">dus</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">allUses</span><span> </span><a href="#local-6989586621679505114"><span class="hs-identifier hs-var">dus</span></a><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span class="hs-identifier">mkUsageInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ImportedMods</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">]</span><span>
</span><a name="line-108"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Module</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Fingerprint</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ModIface</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Usage</span><span class="hs-special">]</span><span>
</span><a name="line-109"></a><a name="mkUsageInfo"><a href="DsUsage.html#mkUsageInfo"><span class="hs-identifier">mkUsageInfo</span></a></a><span> </span><a name="local-6989586621679505115"><a href="#local-6989586621679505115"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679505116"><a href="#local-6989586621679505116"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621679505117"><a href="#local-6989586621679505117"><span class="hs-identifier">dir_imp_mods</span></a></a><span> </span><a name="local-6989586621679505118"><a href="#local-6989586621679505118"><span class="hs-identifier">used_names</span></a></a><span> </span><a name="local-6989586621679505119"><a href="#local-6989586621679505119"><span class="hs-identifier">dependent_files</span></a></a><span> </span><a name="local-6989586621679505120"><a href="#local-6989586621679505120"><span class="hs-identifier">merged</span></a></a><span>
</span><a name="line-110"></a><span>  </span><a name="local-6989586621679505121"><a href="#local-6989586621679505121"><span class="hs-identifier">pluginModules</span></a></a><span>
</span><a name="line-111"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-112"></a><span>    </span><a name="local-6989586621679505122"><a href="#local-6989586621679505122"><span class="hs-identifier">eps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">hscEPS</span><span> </span><a href="#local-6989586621679505115"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-113"></a><span>    </span><a name="local-6989586621679505167"><a href="#local-6989586621679505167"><span class="hs-identifier">hashes</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-identifier hs-var">getFileHash</span><span> </span><a href="#local-6989586621679505119"><span class="hs-identifier hs-var">dependent_files</span></a><span>
</span><a name="line-114"></a><span>    </span><a name="local-6989586621679505168"><a href="#local-6989586621679505168"><span class="hs-identifier">plugin_usages</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="DsUsage.html#mkPluginUsage"><span class="hs-identifier hs-var">mkPluginUsage</span></a><span> </span><a href="#local-6989586621679505115"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679505121"><span class="hs-identifier hs-var">pluginModules</span></a><span>
</span><a name="line-115"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679505169"><a href="#local-6989586621679505169"><span class="hs-identifier">mod_usages</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsUsage.html#mk_mod_usage_info"><span class="hs-identifier hs-var">mk_mod_usage_info</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_PIT</span><span> </span><a href="#local-6989586621679505122"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679505115"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621679505116"><span class="hs-identifier hs-var">this_mod</span></a><span>
</span><a name="line-116"></a><span>                                       </span><a href="#local-6989586621679505117"><span class="hs-identifier hs-var">dir_imp_mods</span></a><span> </span><a href="#local-6989586621679505118"><span class="hs-identifier hs-var">used_names</span></a><span>
</span><a name="line-117"></a><span>        </span><a name="local-6989586621679505170"><a href="#local-6989586621679505170"><span class="hs-identifier">usages</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679505169"><span class="hs-identifier hs-var">mod_usages</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">UsageFile</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">usg_file_path</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679505171"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-118"></a><span>                                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">usg_file_hash</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679505172"><span class="hs-identifier hs-var">hash</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-119"></a><span>                               </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679505171"><a href="#local-6989586621679505171"><span class="hs-identifier">f</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679505172"><a href="#local-6989586621679505172"><span class="hs-identifier">hash</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679505119"><span class="hs-identifier hs-var">dependent_files</span></a><span> </span><a href="#local-6989586621679505167"><span class="hs-identifier hs-var">hashes</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-120"></a><span>                            </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">UsageMergedRequirement</span><span>
</span><a name="line-121"></a><span>                                    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">usg_mod</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679505173"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">,</span><span>
</span><a name="line-122"></a><span>                                      </span><span class="hs-identifier">usg_mod_hash</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679505174"><span class="hs-identifier hs-var">hash</span></a><span>
</span><a name="line-123"></a><span>                                    </span><span class="hs-special">}</span><span>
</span><a name="line-124"></a><span>                               </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679505173"><a href="#local-6989586621679505173"><span class="hs-identifier">mod</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679505174"><a href="#local-6989586621679505174"><span class="hs-identifier">hash</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679505120"><span class="hs-identifier hs-var">merged</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-125"></a><span>                            </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-6989586621679505168"><span class="hs-identifier hs-var">plugin_usages</span></a><span>
</span><a name="line-126"></a><span>    </span><a href="#local-6989586621679505170"><span class="hs-identifier hs-var">usages</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seqList</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679505170"><span class="hs-identifier hs-var">usages</span></a><span>
</span><a name="line-127"></a><span>    </span><span class="hs-comment">-- seq the list of Usages returned: occasionally these</span><span>
</span><a name="line-128"></a><span>    </span><span class="hs-comment">-- don't get evaluated for a while and we can end up hanging on to</span><span>
</span><a name="line-129"></a><span>    </span><span class="hs-comment">-- the entire collection of Ifaces.</span><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><span class="hs-comment">{- Note [Plugin dependencies]
Modules for which plugins were used in the compilation process, should be
recompiled whenever one of those plugins changes. But how do we know if a
plugin changed from the previous time a module was compiled?

We could try storing the fingerprints of the interface files of plugins in
the interface file of the module. And see if there are changes between
compilation runs. However, this is pretty much a non-option because interface
fingerprints of plugin modules are fairly stable, unless you compile plugins
with optimisations turned on, and give basically all binders an INLINE pragma.

So instead:

  * For plugins that were built locally: we store the filepath and hash of the
    object files of the module with the `plugin` binder, and the object files of
    modules that are dependencies of the plugin module and belong to the same
    `UnitId` as the plugin
  * For plugins in an external package: we store the filepath and hash of
    the dynamic library containing the plugin module.

During recompilation we then compare the hashes of those files again to see
if anything has changed.

One issue with this approach is that object files are currently (GHC 8.6.1)
not created fully deterministicly, which could sometimes induce accidental
recompilation of a module for which plugins were used in the compile process.

One way to improve this is to either:

  * Have deterministic object file creation
  * Create and store implementation hashes, which would be based on the Core
    of the module and the implementation hashes of its dependencies, and then
    compare implementation hashes for recompilation. Creation of implementation
    hashes is however potentially expensive.
-}</span><span>
</span><a name="line-166"></a><span class="hs-identifier">mkPluginUsage</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Usage</span><span class="hs-special">]</span><span>
</span><a name="line-167"></a><a name="mkPluginUsage"><a href="DsUsage.html#mkPluginUsage"><span class="hs-identifier">mkPluginUsage</span></a></a><span> </span><a name="local-6989586621679505175"><a href="#local-6989586621679505175"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679505176"><a href="#local-6989586621679505176"><span class="hs-identifier">pluginModule</span></a></a><span>
</span><a name="line-168"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupPluginModuleWithSuggestions</span><span> </span><a href="#local-6989586621679505177"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621679505179"><span class="hs-identifier hs-var">pNm</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-169"></a><span>    </span><span class="hs-identifier hs-var">LookupFound</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679505191"><a href="#local-6989586621679505191"><span class="hs-identifier">pkg</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-170"></a><span>    </span><span class="hs-comment">-- The plugin is from an external package:</span><span>
</span><a name="line-171"></a><span>    </span><span class="hs-comment">-- search for the library files containing the plugin.</span><span>
</span><a name="line-172"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679505192"><a href="#local-6989586621679505192"><span class="hs-identifier">searchPaths</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">collectLibraryPaths</span><span> </span><a href="#local-6989586621679505177"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679505191"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">]</span><span>
</span><a name="line-173"></a><span>          </span><a name="local-6989586621679505193"><a href="#local-6989586621679505193"><span class="hs-identifier">useDyn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">WayDyn</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">ways</span><span> </span><a href="#local-6989586621679505177"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-174"></a><span>          </span><a name="local-6989586621679505194"><a href="#local-6989586621679505194"><span class="hs-identifier">suffix</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679505193"><span class="hs-identifier hs-var">useDyn</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">soExt</span><span> </span><a href="#local-6989586621679505178"><span class="hs-identifier hs-var">platform</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-string">&quot;a&quot;</span><span>
</span><a name="line-175"></a><span>          </span><a name="local-6989586621679505195"><a href="#local-6989586621679505195"><span class="hs-identifier">libLocs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621679505197"><span class="hs-identifier hs-var">searchPath</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><span class="hs-string">&quot;lib&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679505198"><span class="hs-identifier hs-var">libLoc</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><a href="#local-6989586621679505194"><span class="hs-identifier hs-var">suffix</span></a><span>
</span><a name="line-176"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621679505197"><a href="#local-6989586621679505197"><span class="hs-identifier">searchPath</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679505192"><span class="hs-identifier hs-var">searchPaths</span></a><span>
</span><a name="line-177"></a><span>                    </span><span class="hs-special">,</span><span> </span><a name="local-6989586621679505198"><a href="#local-6989586621679505198"><span class="hs-identifier">libLoc</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">packageHsLibs</span><span> </span><a href="#local-6989586621679505177"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621679505191"><span class="hs-identifier hs-var">pkg</span></a><span>
</span><a name="line-178"></a><span>                    </span><span class="hs-special">]</span><span>
</span><a name="line-179"></a><span>          </span><span class="hs-comment">-- we also try to find plugin library files by adding WayDyn way,</span><span>
</span><a name="line-180"></a><span>          </span><span class="hs-comment">-- if it isn't already present (see trac #15492)</span><span>
</span><a name="line-181"></a><span>          </span><a name="local-6989586621679505196"><a href="#local-6989586621679505196"><span class="hs-identifier">paths</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-182"></a><span>            </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679505193"><span class="hs-identifier hs-var">useDyn</span></a><span>
</span><a name="line-183"></a><span>              </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679505195"><span class="hs-identifier hs-var">libLocs</span></a><span>
</span><a name="line-184"></a><span>              </span><span class="hs-keyword">else</span><span>
</span><a name="line-185"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679505199"><a href="#local-6989586621679505199"><span class="hs-identifier">dflags'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">updateWays</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">addWay'</span><span> </span><span class="hs-identifier hs-var">WayDyn</span><span> </span><a href="#local-6989586621679505177"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-186"></a><span>                    </span><a name="local-6989586621679505200"><a href="#local-6989586621679505200"><span class="hs-identifier">dlibLocs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621679505201"><span class="hs-identifier hs-var">searchPath</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><span class="hs-identifier hs-var">mkHsSOName</span><span> </span><a href="#local-6989586621679505178"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621679505202"><span class="hs-identifier hs-var">dlibLoc</span></a><span>
</span><a name="line-187"></a><span>                               </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621679505201"><a href="#local-6989586621679505201"><span class="hs-identifier">searchPath</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679505192"><span class="hs-identifier hs-var">searchPaths</span></a><span>
</span><a name="line-188"></a><span>                               </span><span class="hs-special">,</span><span> </span><a name="local-6989586621679505202"><a href="#local-6989586621679505202"><span class="hs-identifier">dlibLoc</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">packageHsLibs</span><span> </span><a href="#local-6989586621679505199"><span class="hs-identifier hs-var">dflags'</span></a><span> </span><a href="#local-6989586621679505191"><span class="hs-identifier hs-var">pkg</span></a><span>
</span><a name="line-189"></a><span>                               </span><span class="hs-special">]</span><span>
</span><a name="line-190"></a><span>                </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621679505195"><span class="hs-identifier hs-var">libLocs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679505200"><span class="hs-identifier hs-var">dlibLocs</span></a><span>
</span><a name="line-191"></a><span>      </span><a name="local-6989586621679505203"><a href="#local-6989586621679505203"><span class="hs-identifier">files</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">filterM</span><span> </span><span class="hs-identifier hs-var">doesFileExist</span><span> </span><a href="#local-6989586621679505196"><span class="hs-identifier hs-var">paths</span></a><span>
</span><a name="line-192"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679505203"><span class="hs-identifier hs-var">files</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-193"></a><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-194"></a><span>          </span><span class="hs-identifier hs-var">pprPanic</span><span>
</span><a name="line-195"></a><span>             </span><span class="hs-special">(</span><span> </span><span class="hs-string">&quot;mkPluginUsage: missing plugin library, tried:\n&quot;</span><span>
</span><a name="line-196"></a><span>              </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">unlines</span><span> </span><a href="#local-6989586621679505196"><span class="hs-identifier hs-var">paths</span></a><span>
</span><a name="line-197"></a><span>             </span><span class="hs-special">)</span><span>
</span><a name="line-198"></a><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621679505179"><span class="hs-identifier hs-var">pNm</span></a><span class="hs-special">)</span><span>
</span><a name="line-199"></a><span>        </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621679505183"><span class="hs-identifier hs-var">hashFile</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nub</span><span> </span><a href="#local-6989586621679505203"><span class="hs-identifier hs-var">files</span></a><span class="hs-special">)</span><span>
</span><a name="line-200"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-201"></a><span>      </span><a name="local-6989586621679505204"><a href="#local-6989586621679505204"><span class="hs-identifier">foundM</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Finder.html#findPluginModule"><span class="hs-identifier hs-var">findPluginModule</span></a><span> </span><a href="#local-6989586621679505175"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621679505179"><span class="hs-identifier hs-var">pNm</span></a><span>
</span><a name="line-202"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679505204"><span class="hs-identifier hs-var">foundM</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-203"></a><span>      </span><span class="hs-comment">-- The plugin was built locally: look up the object file containing</span><span>
</span><a name="line-204"></a><span>      </span><span class="hs-comment">-- the `plugin` binder, and all object files belong to modules that are</span><span>
</span><a name="line-205"></a><span>      </span><span class="hs-comment">-- transitive dependencies of the plugin that belong to the same package.</span><span>
</span><a name="line-206"></a><span>        </span><span class="hs-identifier hs-var">Found</span><span> </span><a name="local-6989586621679505205"><a href="#local-6989586621679505205"><span class="hs-identifier">ml</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-207"></a><span>          </span><a name="local-6989586621679505206"><a href="#local-6989586621679505206"><span class="hs-identifier">pluginObject</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679505183"><span class="hs-identifier hs-var">hashFile</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ml_obj_file</span><span> </span><a href="#local-6989586621679505205"><span class="hs-identifier hs-var">ml</span></a><span class="hs-special">)</span><span>
</span><a name="line-208"></a><span>          </span><a name="local-6989586621679505207"><a href="#local-6989586621679505207"><span class="hs-identifier">depObjects</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621679505182"><span class="hs-identifier hs-var">lookupObjectFile</span></a><span> </span><a href="#local-6989586621679505181"><span class="hs-identifier hs-var">deps</span></a><span>
</span><a name="line-209"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nub</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679505206"><span class="hs-identifier hs-var">pluginObject</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679505207"><span class="hs-identifier hs-var">depObjects</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-210"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;mkPluginUsage: no object file found&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621679505179"><span class="hs-identifier hs-var">pNm</span></a><span class="hs-special">)</span><span>
</span><a name="line-211"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-212"></a><span>    </span><a name="local-6989586621679505177"><a href="#local-6989586621679505177"><span class="hs-identifier">dflags</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621679505175"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-213"></a><span>    </span><a name="local-6989586621679505178"><a href="#local-6989586621679505178"><span class="hs-identifier">platform</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621679505177"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-214"></a><span>    </span><a name="local-6989586621679505179"><a href="#local-6989586621679505179"><span class="hs-identifier">pNm</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">moduleName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_module</span><span> </span><a href="#local-6989586621679505176"><span class="hs-identifier hs-var">pluginModule</span></a><span class="hs-special">)</span><span>
</span><a name="line-215"></a><span>    </span><a name="local-6989586621679505180"><a href="#local-6989586621679505180"><span class="hs-identifier">pPkg</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">moduleUnitId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_module</span><span> </span><a href="#local-6989586621679505176"><span class="hs-identifier hs-var">pluginModule</span></a><span class="hs-special">)</span><span>
</span><a name="line-216"></a><span>    </span><a name="local-6989586621679505181"><a href="#local-6989586621679505181"><span class="hs-identifier">deps</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dep_mods</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_deps</span><span> </span><a href="#local-6989586621679505176"><span class="hs-identifier hs-var">pluginModule</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-217"></a><span>
</span><a name="line-218"></a><span>    </span><span class="hs-comment">-- Lookup object file for a plugin dependency,</span><span>
</span><a name="line-219"></a><span>    </span><span class="hs-comment">-- from the same package as the plugin.</span><span>
</span><a name="line-220"></a><span>    </span><a name="local-6989586621679505182"><a href="#local-6989586621679505182"><span class="hs-identifier">lookupObjectFile</span></a></a><span> </span><a name="local-6989586621679505184"><a href="#local-6989586621679505184"><span class="hs-identifier">nm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-221"></a><span>      </span><a name="local-6989586621679505185"><a href="#local-6989586621679505185"><span class="hs-identifier">foundM</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Finder.html#findImportedModule"><span class="hs-identifier hs-var">findImportedModule</span></a><span> </span><a href="#local-6989586621679505175"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621679505184"><span class="hs-identifier hs-var">nm</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-222"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679505185"><span class="hs-identifier hs-var">foundM</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-223"></a><span>        </span><span class="hs-identifier hs-var">Found</span><span> </span><a name="local-6989586621679505186"><a href="#local-6989586621679505186"><span class="hs-identifier">ml</span></a></a><span> </span><a name="local-6989586621679505187"><a href="#local-6989586621679505187"><span class="hs-identifier">m</span></a></a><span>
</span><a name="line-224"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621679505187"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679505180"><span class="hs-identifier hs-var">pPkg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679505183"><span class="hs-identifier hs-var">hashFile</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ml_obj_file</span><span> </span><a href="#local-6989586621679505186"><span class="hs-identifier hs-var">ml</span></a><span class="hs-special">)</span><span>
</span><a name="line-225"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-226"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;mkPluginUsage: no object for dependency&quot;</span><span>
</span><a name="line-227"></a><span>                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621679505179"><span class="hs-identifier hs-var">pNm</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621679505184"><span class="hs-identifier hs-var">nm</span></a><span class="hs-special">)</span><span>
</span><a name="line-228"></a><span>
</span><a name="line-229"></a><span>    </span><a name="local-6989586621679505183"><a href="#local-6989586621679505183"><span class="hs-identifier">hashFile</span></a></a><span> </span><a name="local-6989586621679505188"><a href="#local-6989586621679505188"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-230"></a><span>      </span><a name="local-6989586621679505189"><a href="#local-6989586621679505189"><span class="hs-identifier">fExist</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">doesFileExist</span><span> </span><a href="#local-6989586621679505188"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-231"></a><span>      </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679505189"><span class="hs-identifier hs-var">fExist</span></a><span>
</span><a name="line-232"></a><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-233"></a><span>            </span><a name="local-6989586621679505190"><a href="#local-6989586621679505190"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getFileHash</span><span> </span><a href="#local-6989586621679505188"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-234"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">UsageFile</span><span> </span><a href="#local-6989586621679505188"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679505190"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">)</span><span>
</span><a name="line-235"></a><span>         </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;mkPluginUsage: file not found&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621679505179"><span class="hs-identifier hs-var">pNm</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621679505188"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-236"></a><span>
</span><a name="line-237"></a><span class="hs-identifier">mk_mod_usage_info</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PackageIfaceTable</span><span>
</span><a name="line-238"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-239"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span>
</span><a name="line-240"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ImportedMods</span><span>
</span><a name="line-241"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span>
</span><a name="line-242"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Usage</span><span class="hs-special">]</span><span>
</span><a name="line-243"></a><a name="mk_mod_usage_info"><a href="DsUsage.html#mk_mod_usage_info"><span class="hs-identifier">mk_mod_usage_info</span></a></a><span> </span><a name="local-6989586621679505208"><a href="#local-6989586621679505208"><span class="hs-identifier">pit</span></a></a><span> </span><a name="local-6989586621679505209"><a href="#local-6989586621679505209"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621679505210"><a href="#local-6989586621679505210"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621679505211"><a href="#local-6989586621679505211"><span class="hs-identifier">direct_imports</span></a></a><span> </span><a name="local-6989586621679505212"><a href="#local-6989586621679505212"><span class="hs-identifier">used_names</span></a></a><span>
</span><a name="line-244"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><a href="#local-6989586621679505221"><span class="hs-identifier hs-var">mkUsage</span></a><span> </span><a href="#local-6989586621679505219"><span class="hs-identifier hs-var">usage_mods</span></a><span>
</span><a name="line-245"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-246"></a><span>    </span><a name="local-6989586621679505213"><a href="#local-6989586621679505213"><span class="hs-identifier">hpt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_HPT</span><span> </span><a href="#local-6989586621679505209"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-247"></a><span>    </span><a name="local-6989586621679505214"><a href="#local-6989586621679505214"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621679505209"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-248"></a><span>    </span><a name="local-6989586621679505215"><a href="#local-6989586621679505215"><span class="hs-identifier">this_pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">thisPackage</span><span> </span><a href="#local-6989586621679505214"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-249"></a><span>
</span><a name="line-250"></a><span>    </span><a name="local-6989586621679505216"><a href="#local-6989586621679505216"><span class="hs-identifier">used_mods</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">moduleEnvKeys</span><span> </span><a href="#local-6989586621679505220"><span class="hs-identifier hs-var">ent_map</span></a><span>
</span><a name="line-251"></a><span>    </span><a name="local-6989586621679505217"><a href="#local-6989586621679505217"><span class="hs-identifier">dir_imp_mods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">moduleEnvKeys</span><span> </span><a href="#local-6989586621679505211"><span class="hs-identifier hs-var">direct_imports</span></a><span>
</span><a name="line-252"></a><span>    </span><a name="local-6989586621679505218"><a href="#local-6989586621679505218"><span class="hs-identifier">all_mods</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679505216"><span class="hs-identifier hs-var">used_mods</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">notElem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679505216"><span class="hs-identifier hs-var">used_mods</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679505217"><span class="hs-identifier hs-var">dir_imp_mods</span></a><span>
</span><a name="line-253"></a><span>    </span><a name="local-6989586621679505219"><a href="#local-6989586621679505219"><span class="hs-identifier">usage_mods</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-identifier hs-var">stableModuleCmp</span><span> </span><a href="#local-6989586621679505218"><span class="hs-identifier hs-var">all_mods</span></a><span>
</span><a name="line-254"></a><span>                        </span><span class="hs-comment">-- canonical order is imported, to avoid interface-file</span><span>
</span><a name="line-255"></a><span>                        </span><span class="hs-comment">-- wobblage.</span><span>
</span><a name="line-256"></a><span>
</span><a name="line-257"></a><span>    </span><span class="hs-comment">-- ent_map groups together all the things imported and used</span><span>
</span><a name="line-258"></a><span>    </span><span class="hs-comment">-- from a particular module</span><span>
</span><a name="line-259"></a><span>    </span><span class="hs-identifier">ent_map</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModuleEnv</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">OccName</span><span class="hs-special">]</span><span>
</span><a name="line-260"></a><span>    </span><a name="local-6989586621679505220"><a href="#local-6989586621679505220"><span class="hs-identifier">ent_map</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nonDetFoldUniqSet</span><span> </span><a href="#local-6989586621679505222"><span class="hs-identifier hs-var">add_mv</span></a><span> </span><span class="hs-identifier hs-var">emptyModuleEnv</span><span> </span><a href="#local-6989586621679505212"><span class="hs-identifier hs-var">used_names</span></a><span>
</span><a name="line-261"></a><span>     </span><span class="hs-comment">-- nonDetFoldUFM is OK here. If you follow the logic, we sort by OccName</span><span>
</span><a name="line-262"></a><span>     </span><span class="hs-comment">-- in ent_hashs</span><span>
</span><a name="line-263"></a><span>     </span><span class="hs-keyword">where</span><span>
</span><a name="line-264"></a><span>      </span><a name="local-6989586621679505222"><a href="#local-6989586621679505222"><span class="hs-identifier">add_mv</span></a></a><span> </span><a name="local-6989586621679505223"><a href="#local-6989586621679505223"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679505224"><a href="#local-6989586621679505224"><span class="hs-identifier">mv_map</span></a></a><span>
</span><a name="line-265"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isWiredInName</span><span> </span><a href="#local-6989586621679505223"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679505224"><span class="hs-identifier hs-var">mv_map</span></a><span>  </span><span class="hs-comment">-- ignore wired-in names</span><span>
</span><a name="line-266"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-267"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">nameModule_maybe</span><span> </span><a href="#local-6989586621679505223"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-268"></a><span>             </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isSystemName</span><span> </span><span class="hs-identifier hs-var">name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-identifier">name</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">mv_map</span><span>
</span><a name="line-269"></a><span>                </span><span class="hs-comment">-- See Note [Internal used_names]</span><span>
</span><a name="line-270"></a><span>
</span><a name="line-271"></a><span>             </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679505226"><a href="#local-6989586621679505226"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-272"></a><span>                </span><span class="hs-comment">-- See Note [Identity versus semantic module]</span><span>
</span><a name="line-273"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679505227"><a href="#local-6989586621679505227"><span class="hs-identifier">mod'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isHoleModule</span><span> </span><a href="#local-6989586621679505226"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-274"></a><span>                            </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">mkModule</span><span> </span><a href="#local-6989586621679505215"><span class="hs-identifier hs-var">this_pkg</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621679505226"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-275"></a><span>                            </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679505226"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-276"></a><span>                </span><span class="hs-comment">-- This lambda function is really just a</span><span>
</span><a name="line-277"></a><span>                </span><span class="hs-comment">-- specialised (++); originally came about to</span><span>
</span><a name="line-278"></a><span>                </span><span class="hs-comment">-- avoid quadratic behaviour (trac #2680)</span><span>
</span><a name="line-279"></a><span>                </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">extendModuleEnvWith</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679505228"><a href="#local-6989586621679505228"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679505225"><span class="hs-identifier hs-var">occ</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679505228"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679505224"><span class="hs-identifier hs-var">mv_map</span></a><span> </span><a href="#local-6989586621679505227"><span class="hs-identifier hs-var">mod'</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679505225"><span class="hs-identifier hs-var">occ</span></a><span class="hs-special">]</span><span>
</span><a name="line-280"></a><span>            </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679505225"><a href="#local-6989586621679505225"><span class="hs-identifier">occ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621679505223"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-281"></a><span>
</span><a name="line-282"></a><span>    </span><span class="hs-comment">-- We want to create a Usage for a home module if</span><span>
</span><a name="line-283"></a><span>    </span><span class="hs-comment">--  a) we used something from it; has something in used_names</span><span>
</span><a name="line-284"></a><span>    </span><span class="hs-comment">--  b) we imported it, even if we used nothing from it</span><span>
</span><a name="line-285"></a><span>    </span><span class="hs-comment">--     (need to recompile if its export list changes: export_fprint)</span><span>
</span><a name="line-286"></a><span>    </span><span class="hs-identifier">mkUsage</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Usage</span><span>
</span><a name="line-287"></a><span>    </span><a name="local-6989586621679505221"><a href="#local-6989586621679505221"><span class="hs-identifier">mkUsage</span></a></a><span> </span><a name="local-6989586621679505229"><a href="#local-6989586621679505229"><span class="hs-identifier">mod</span></a></a><span>
</span><a name="line-288"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isNothing</span><span> </span><a href="#local-6989586621679505230"><span class="hs-identifier hs-var">maybe_iface</span></a><span>           </span><span class="hs-comment">-- We can't depend on it if we didn't</span><span>
</span><a name="line-289"></a><span>                                        </span><span class="hs-comment">-- load its interface.</span><span>
</span><a name="line-290"></a><span>      </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621679505229"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679505210"><span class="hs-identifier hs-var">this_mod</span></a><span>                </span><span class="hs-comment">-- We don't care about usages of</span><span>
</span><a name="line-291"></a><span>                                        </span><span class="hs-comment">-- things in *this* module</span><span>
</span><a name="line-292"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-293"></a><span>
</span><a name="line-294"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621679505229"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621679505215"><span class="hs-identifier hs-var">this_pkg</span></a><span>
</span><a name="line-295"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">UsagePackageModule</span><span class="hs-special">{</span><span> </span><span class="hs-identifier">usg_mod</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679505229"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">,</span><span>
</span><a name="line-296"></a><span>                                 </span><span class="hs-identifier">usg_mod_hash</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679505234"><span class="hs-identifier hs-var">mod_hash</span></a><span class="hs-special">,</span><span>
</span><a name="line-297"></a><span>                                 </span><span class="hs-identifier">usg_safe</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679505238"><span class="hs-identifier hs-var">imp_safe</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-298"></a><span>        </span><span class="hs-comment">-- for package modules, we record the module hash only</span><span>
</span><a name="line-299"></a><span>
</span><a name="line-300"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679505239"><span class="hs-identifier hs-var">used_occs</span></a><span>
</span><a name="line-301"></a><span>          </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isNothing</span><span> </span><a href="#local-6989586621679505235"><span class="hs-identifier hs-var">export_hash</span></a><span>
</span><a name="line-302"></a><span>          </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621679505237"><span class="hs-identifier hs-var">is_direct_import</span></a><span>
</span><a name="line-303"></a><span>          </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621679505232"><span class="hs-identifier hs-var">finsts_mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-304"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>                 </span><span class="hs-comment">-- Record no usage info</span><span>
</span><a name="line-305"></a><span>        </span><span class="hs-comment">-- for directly-imported modules, we always want to record a usage</span><span>
</span><a name="line-306"></a><span>        </span><span class="hs-comment">-- on the orphan hash.  This is what triggers a recompilation if</span><span>
</span><a name="line-307"></a><span>        </span><span class="hs-comment">-- an orphan is added or removed somewhere below us in the future.</span><span>
</span><a name="line-308"></a><span>
</span><a name="line-309"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-310"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">UsageHomeModule</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-311"></a><span>                      </span><span class="hs-identifier">usg_mod_name</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621679505229"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">,</span><span>
</span><a name="line-312"></a><span>                      </span><span class="hs-identifier">usg_mod_hash</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679505234"><span class="hs-identifier hs-var">mod_hash</span></a><span class="hs-special">,</span><span>
</span><a name="line-313"></a><span>                      </span><span class="hs-identifier">usg_exports</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679505235"><span class="hs-identifier hs-var">export_hash</span></a><span class="hs-special">,</span><span>
</span><a name="line-314"></a><span>                      </span><span class="hs-identifier">usg_entities</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.toList</span><span> </span><a href="#local-6989586621679505240"><span class="hs-identifier hs-var">ent_hashs</span></a><span class="hs-special">,</span><span>
</span><a name="line-315"></a><span>                      </span><span class="hs-identifier">usg_safe</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679505238"><span class="hs-identifier hs-var">imp_safe</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-316"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-317"></a><span>        </span><a name="local-6989586621679505230"><a href="#local-6989586621679505230"><span class="hs-identifier">maybe_iface</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupIfaceByModule</span><span> </span><a href="#local-6989586621679505214"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621679505213"><span class="hs-identifier hs-var">hpt</span></a><span> </span><a href="#local-6989586621679505208"><span class="hs-identifier hs-var">pit</span></a><span> </span><a href="#local-6989586621679505229"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-318"></a><span>                </span><span class="hs-comment">-- In one-shot mode, the interfaces for home-package</span><span>
</span><a name="line-319"></a><span>                </span><span class="hs-comment">-- modules accumulate in the PIT not HPT.  Sigh.</span><span>
</span><a name="line-320"></a><span>
</span><a name="line-321"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679505231"><a href="#local-6989586621679505231"><span class="hs-identifier">iface</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679505230"><span class="hs-identifier hs-var">maybe_iface</span></a><span>
</span><a name="line-322"></a><span>        </span><a name="local-6989586621679505232"><a href="#local-6989586621679505232"><span class="hs-identifier">finsts_mod</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_finsts</span><span>    </span><a href="#local-6989586621679505231"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-323"></a><span>        </span><a name="local-6989586621679505233"><a href="#local-6989586621679505233"><span class="hs-identifier">hash_env</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_hash_fn</span><span>   </span><a href="#local-6989586621679505231"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-324"></a><span>        </span><a name="local-6989586621679505234"><a href="#local-6989586621679505234"><span class="hs-identifier">mod_hash</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_mod_hash</span><span>  </span><a href="#local-6989586621679505231"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-325"></a><span>        </span><a name="local-6989586621679505235"><a href="#local-6989586621679505235"><span class="hs-identifier">export_hash</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679505242"><span class="hs-identifier hs-var">depend_on_exports</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_exp_hash</span><span> </span><a href="#local-6989586621679505231"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-326"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-327"></a><span>
</span><a name="line-328"></a><span>        </span><a name="local-6989586621679505236"><a href="#local-6989586621679505236"><span class="hs-identifier">by_is_safe</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ImportedByUser</span><span> </span><a name="local-6989586621679505243"><a href="#local-6989586621679505243"><span class="hs-identifier">imv</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">imv_is_safe</span><span> </span><a href="#local-6989586621679505243"><span class="hs-identifier hs-var">imv</span></a><span>
</span><a name="line-329"></a><span>        </span><span class="hs-identifier">by_is_safe</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-330"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621679505237"><a href="#local-6989586621679505237"><span class="hs-identifier">is_direct_import</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679505238"><a href="#local-6989586621679505238"><span class="hs-identifier">imp_safe</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-331"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupModuleEnv</span><span> </span><a href="#local-6989586621679505211"><span class="hs-identifier hs-var">direct_imports</span></a><span> </span><a href="#local-6989586621679505229"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-332"></a><span>                </span><span class="hs-comment">-- ezyang: I'm not sure if any is the correct</span><span>
</span><a name="line-333"></a><span>                </span><span class="hs-comment">-- metric here. If safety was guaranteed to be uniform</span><span>
</span><a name="line-334"></a><span>                </span><span class="hs-comment">-- across all imports, why did the old code only look</span><span>
</span><a name="line-335"></a><span>                </span><span class="hs-comment">-- at the first import?</span><span>
</span><a name="line-336"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679505244"><a href="#local-6989586621679505244"><span class="hs-identifier">bys</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><a href="#local-6989586621679505236"><span class="hs-identifier hs-var">by_is_safe</span></a><span> </span><a href="#local-6989586621679505244"><span class="hs-identifier hs-var">bys</span></a><span class="hs-special">)</span><span>
</span><a name="line-337"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">safeImplicitImpsReq</span><span> </span><a href="#local-6989586621679505214"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-338"></a><span>                </span><span class="hs-comment">-- Nothing case is for references to entities which were</span><span>
</span><a name="line-339"></a><span>                </span><span class="hs-comment">-- not directly imported (NB: the &quot;implicit&quot; Prelude import</span><span>
</span><a name="line-340"></a><span>                </span><span class="hs-comment">-- counts as directly imported!  An entity is not directly</span><span>
</span><a name="line-341"></a><span>                </span><span class="hs-comment">-- imported if, e.g., we got a reference to it from a</span><span>
</span><a name="line-342"></a><span>                </span><span class="hs-comment">-- reexport of another module.)</span><span>
</span><a name="line-343"></a><span>
</span><a name="line-344"></a><span>        </span><a name="local-6989586621679505239"><a href="#local-6989586621679505239"><span class="hs-identifier">used_occs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupModuleEnv</span><span> </span><a href="#local-6989586621679505220"><span class="hs-identifier hs-var">ent_map</span></a><span> </span><a href="#local-6989586621679505229"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">orElse</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-345"></a><span>
</span><a name="line-346"></a><span>        </span><span class="hs-comment">-- Making a Map here ensures that (a) we remove duplicates</span><span>
</span><a name="line-347"></a><span>        </span><span class="hs-comment">-- when we have usages on several subordinates of a single parent,</span><span>
</span><a name="line-348"></a><span>        </span><span class="hs-comment">-- and (b) that the usages emerge in a canonical order, which</span><span>
</span><a name="line-349"></a><span>        </span><span class="hs-comment">-- is why we use Map rather than OccEnv: Map works</span><span>
</span><a name="line-350"></a><span>        </span><span class="hs-comment">-- using Ord on the OccNames, which is a lexicographic ordering.</span><span>
</span><a name="line-351"></a><span>        </span><span class="hs-identifier">ent_hashs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">OccName</span><span> </span><span class="hs-identifier hs-type">Fingerprint</span><span>
</span><a name="line-352"></a><span>        </span><a name="local-6989586621679505240"><a href="#local-6989586621679505240"><span class="hs-identifier">ent_hashs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679505241"><span class="hs-identifier hs-var">lookup_occ</span></a><span> </span><a href="#local-6989586621679505239"><span class="hs-identifier hs-var">used_occs</span></a><span class="hs-special">)</span><span>
</span><a name="line-353"></a><span>
</span><a name="line-354"></a><span>        </span><a name="local-6989586621679505241"><a href="#local-6989586621679505241"><span class="hs-identifier">lookup_occ</span></a></a><span> </span><a name="local-6989586621679505245"><a href="#local-6989586621679505245"><span class="hs-identifier">occ</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-355"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679505233"><span class="hs-identifier hs-var">hash_env</span></a><span> </span><a href="#local-6989586621679505245"><span class="hs-identifier hs-var">occ</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-356"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;mkUsage&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621679505229"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621679505245"><span class="hs-identifier hs-var">occ</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621679505212"><span class="hs-identifier hs-var">used_names</span></a><span class="hs-special">)</span><span>
</span><a name="line-357"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679505246"><a href="#local-6989586621679505246"><span class="hs-identifier">r</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679505246"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-358"></a><span>
</span><a name="line-359"></a><span>        </span><a name="local-6989586621679505242"><a href="#local-6989586621679505242"><span class="hs-identifier">depend_on_exports</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679505237"><span class="hs-identifier hs-var">is_direct_import</span></a><span>
</span><a name="line-360"></a><span>        </span><span class="hs-comment">{- True
              Even if we used 'import M ()', we have to register a
              usage on the export list because we are sensitive to
              changes in orphan instances/rules.
           False
              In GHC 6.8.x we always returned true, and in
              fact it recorded a dependency on *all* the
              modules underneath in the dependency tree.  This
              happens to make orphans work right, but is too
              expensive: it'll read too many interface files.
              The 'isNothing maybe_iface' check above saved us
              from generating many of these usages (at least in
              one-shot mode), but that's even more bogus!
        -}</span><span>
</span><a name="line-374"></a></pre></body></html>