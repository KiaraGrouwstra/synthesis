<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE ExplicitForAll #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE GADTs #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-comment">-- CmmNode type for representation using Hoopl graphs.</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">CmmNode</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-16"></a><span>     </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="CmmNode.html#CmmFormal"><span class="hs-identifier hs-type">CmmFormal</span></a><span class="hs-special">,</span><span> </span><a href="CmmNode.html#CmmActual"><span class="hs-identifier hs-type">CmmActual</span></a><span class="hs-special">,</span><span> </span><a href="CmmNode.html#CmmTickish"><span class="hs-identifier hs-type">CmmTickish</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>     </span><a href="CmmNode.html#UpdFrameOffset"><span class="hs-identifier hs-type">UpdFrameOffset</span></a><span class="hs-special">,</span><span> </span><a href="CmmNode.html#Convention"><span class="hs-identifier hs-type">Convention</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>     </span><a href="CmmNode.html#ForeignConvention"><span class="hs-identifier hs-type">ForeignConvention</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-type">ForeignTarget</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="CmmNode.html#foreignTargetHints"><span class="hs-identifier hs-var">foreignTargetHints</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>     </span><a href="CmmNode.html#CmmReturnInfo"><span class="hs-identifier hs-type">CmmReturnInfo</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>     </span><a href="CmmNode.html#mapExp"><span class="hs-identifier hs-var">mapExp</span></a><span class="hs-special">,</span><span> </span><a href="CmmNode.html#mapExpDeep"><span class="hs-identifier hs-var">mapExpDeep</span></a><span class="hs-special">,</span><span> </span><a href="CmmNode.html#wrapRecExp"><span class="hs-identifier hs-var">wrapRecExp</span></a><span class="hs-special">,</span><span> </span><a href="CmmNode.html#foldExp"><span class="hs-identifier hs-var">foldExp</span></a><span class="hs-special">,</span><span> </span><a href="CmmNode.html#foldExpDeep"><span class="hs-identifier hs-var">foldExpDeep</span></a><span class="hs-special">,</span><span> </span><a href="CmmNode.html#wrapRecExpf"><span class="hs-identifier hs-var">wrapRecExpf</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>     </span><a href="CmmNode.html#mapExpM"><span class="hs-identifier hs-var">mapExpM</span></a><span class="hs-special">,</span><span> </span><a href="CmmNode.html#mapExpDeepM"><span class="hs-identifier hs-var">mapExpDeepM</span></a><span class="hs-special">,</span><span> </span><a href="CmmNode.html#wrapRecExpM"><span class="hs-identifier hs-var">wrapRecExpM</span></a><span class="hs-special">,</span><span> </span><a href="CmmNode.html#mapSuccessors"><span class="hs-identifier hs-var">mapSuccessors</span></a><span class="hs-special">,</span><span> </span><a href="CmmNode.html#mapCollectSuccessors"><span class="hs-identifier hs-var">mapCollectSuccessors</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span>     </span><span class="hs-comment">-- * Tick scopes</span><span>
</span><a name="line-24"></a><span>     </span><a href="CmmNode.html#CmmTickScope"><span class="hs-identifier hs-type">CmmTickScope</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="CmmNode.html#isTickSubScope"><span class="hs-identifier hs-var">isTickSubScope</span></a><span class="hs-special">,</span><span> </span><a href="CmmNode.html#combineTickScopes"><span class="hs-identifier hs-var">combineTickScopes</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">succ</span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="CodeGen.Platform.html"><span class="hs-identifier">CodeGen.Platform</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="CmmExpr.html"><span class="hs-identifier">CmmExpr</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="CmmSwitch.html"><span class="hs-identifier">CmmSwitch</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ForeignCall</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="SMRep.html"><span class="hs-identifier">SMRep</span></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreSyn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Tickish</span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Unique</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">U</span><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Block.html"><span class="hs-identifier">Hoopl.Block</span></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Graph.html"><span class="hs-identifier">Hoopl.Graph</span></a><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Collections.html"><span class="hs-identifier">Hoopl.Collections</span></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Label.html"><span class="hs-identifier">Hoopl.Label</span></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tails</span><span class="hs-special">,</span><span class="hs-identifier hs-var">sortBy</span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Unique</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nonDetCmpUnique</span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span class="hs-comment">------------------------</span><span>
</span><a name="line-51"></a><span class="hs-comment">-- CmmNode</span><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span class="hs-cpp">#define ULabel {-# UNPACK #-} !Label
</span><span>
</span><a name="line-55"></a><span class="hs-keyword">data</span><span> </span><a name="CmmNode"><a href="CmmNode.html#CmmNode"><span class="hs-identifier">CmmNode</span></a></a><span> </span><a name="local-6989586621680027616"><a href="#local-6989586621680027616"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621680027617"><a href="#local-6989586621680027617"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-56"></a><span>  </span><a name="CmmEntry"><a href="CmmNode.html#CmmEntry"><span class="hs-identifier">CmmEntry</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ULabel</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CmmTickScope</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmTickScope"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="CmmNode.html#CmmTickScope"><span class="hs-identifier hs-type">C</span></a><span> </span><a href="CmmNode.html#CmmTickScope"><span class="hs-identifier hs-type">O</span></a><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span>  </span><a name="CmmComment"><a href="CmmNode.html#CmmComment"><span class="hs-identifier">CmmComment</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span>    </span><span class="hs-comment">-- Tick annotation, covering Cmm code in our tick scope. We only</span><span>
</span><a name="line-61"></a><span>    </span><span class="hs-comment">-- expect non-code @Tickish@ at this point (e.g. @SourceNote@).</span><span>
</span><a name="line-62"></a><span>    </span><span class="hs-comment">-- See Note [CmmTick scoping details]</span><span>
</span><a name="line-63"></a><span>  </span><a name="CmmTick"><a href="CmmNode.html#CmmTick"><span class="hs-identifier">CmmTick</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="CmmNode.html#CmmTickish"><span class="hs-identifier hs-type">CmmTickish</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span>    </span><span class="hs-comment">-- Unwind pseudo-instruction, encoding stack unwinding</span><span>
</span><a name="line-66"></a><span>    </span><span class="hs-comment">-- instructions for a debugger. This describes how to reconstruct</span><span>
</span><a name="line-67"></a><span>    </span><span class="hs-comment">-- the &quot;old&quot; value of a register if we want to navigate the stack</span><span>
</span><a name="line-68"></a><span>    </span><span class="hs-comment">-- up one frame. Having unwind information for @Sp@ will allow the</span><span>
</span><a name="line-69"></a><span>    </span><span class="hs-comment">-- debugger to &quot;walk&quot; the stack.</span><span>
</span><a name="line-70"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-71"></a><span>    </span><span class="hs-comment">-- See Note [What is this unwinding business?] in Debug</span><span>
</span><a name="line-72"></a><span>  </span><a name="CmmUnwind"><a href="CmmNode.html#CmmUnwind"><span class="hs-identifier">CmmUnwind</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CmmExpr.html#GlobalReg"><span class="hs-identifier hs-type">GlobalReg</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span>
</span><a name="line-73"></a><span>
</span><a name="line-74"></a><span>  </span><a name="CmmAssign"><a href="CmmNode.html#CmmAssign"><span class="hs-identifier">CmmAssign</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-type">CmmReg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">!</span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span>
</span><a name="line-75"></a><span>    </span><span class="hs-comment">-- Assign to register</span><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span>  </span><a name="CmmStore"><a href="CmmNode.html#CmmStore"><span class="hs-identifier">CmmStore</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">!</span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span>
</span><a name="line-78"></a><span>    </span><span class="hs-comment">-- Assign to memory location.  Size is</span><span>
</span><a name="line-79"></a><span>    </span><span class="hs-comment">-- given by cmmExprType of the rhs.</span><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span>  </span><a name="CmmUnsafeForeignCall"><a href="CmmNode.html#CmmUnsafeForeignCall"><span class="hs-identifier">CmmUnsafeForeignCall</span></a></a><span> </span><span class="hs-glyph">::</span><span>       </span><span class="hs-comment">-- An unsafe foreign call;</span><span>
</span><a name="line-82"></a><span>                                </span><span class="hs-comment">-- see Note [Foreign calls]</span><span>
</span><a name="line-83"></a><span>                                </span><span class="hs-comment">-- Like a &quot;fat machine instruction&quot;; can occur</span><span>
</span><a name="line-84"></a><span>                                </span><span class="hs-comment">-- in the middle of a block</span><span>
</span><a name="line-85"></a><span>      </span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-type">ForeignTarget</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>          </span><span class="hs-comment">-- call target</span><span>
</span><a name="line-86"></a><span>      </span><span class="hs-special">[</span><a href="CmmNode.html#CmmFormal"><span class="hs-identifier hs-type">CmmFormal</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>            </span><span class="hs-comment">-- zero or more results</span><span>
</span><a name="line-87"></a><span>      </span><span class="hs-special">[</span><a href="CmmNode.html#CmmActual"><span class="hs-identifier hs-type">CmmActual</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>            </span><span class="hs-comment">-- zero or more arguments</span><span>
</span><a name="line-88"></a><span>      </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span>
</span><a name="line-89"></a><span>      </span><span class="hs-comment">-- Semantics: clobbers any GlobalRegs for which callerSaves r == True</span><span>
</span><a name="line-90"></a><span>      </span><span class="hs-comment">-- See Note [Unsafe foreign calls clobber caller-save registers]</span><span>
</span><a name="line-91"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-92"></a><span>      </span><span class="hs-comment">-- Invariant: the arguments and the ForeignTarget must not</span><span>
</span><a name="line-93"></a><span>      </span><span class="hs-comment">-- mention any registers for which CodeGen.Platform.callerSaves</span><span>
</span><a name="line-94"></a><span>      </span><span class="hs-comment">-- is True.  See Note [Register Parameter Passing].</span><span>
</span><a name="line-95"></a><span>
</span><a name="line-96"></a><span>  </span><a name="CmmBranch"><a href="CmmNode.html#CmmBranch"><span class="hs-identifier">CmmBranch</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ULabel</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CmmNode</span><span> </span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">C</span></a><span>
</span><a name="line-97"></a><span>                                   </span><span class="hs-comment">-- Goto another block in the same procedure</span><span>
</span><a name="line-98"></a><span>
</span><a name="line-99"></a><span>  </span><a name="CmmCondBranch"><a href="CmmNode.html#CmmCondBranch"><span class="hs-identifier">CmmCondBranch</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">{</span><span>                 </span><span class="hs-comment">-- conditional branch</span><span>
</span><a name="line-100"></a><span>      </span><a name="cml_pred"><a href="CmmNode.html#cml_pred"><span class="hs-identifier">cml_pred</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span class="hs-special">,</span><span>
</span><a name="line-101"></a><span>      </span><a name="cml_true"><a href="CmmNode.html#cml_true"><span class="hs-identifier">cml_true</span></a></a><span class="hs-special">,</span><span> </span><a name="cml_false"><a href="CmmNode.html#cml_false"><span class="hs-identifier">cml_false</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ULabel</span><span class="hs-special">,</span><span>
</span><a name="line-102"></a><span>      </span><a name="cml_likely"><a href="CmmNode.html#cml_likely"><span class="hs-identifier">cml_likely</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>       </span><span class="hs-comment">-- likely result of the conditional,</span><span>
</span><a name="line-103"></a><span>                                     </span><span class="hs-comment">-- if known</span><span>
</span><a name="line-104"></a><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#C"><span class="hs-identifier hs-type">C</span></a><span>
</span><a name="line-105"></a><span>
</span><a name="line-106"></a><span>  </span><a name="CmmSwitch"><a href="CmmNode.html#CmmSwitch"><span class="hs-identifier">CmmSwitch</span></a></a><span>
</span><a name="line-107"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>       </span><span class="hs-comment">-- Scrutinee, of some integral type</span><span>
</span><a name="line-108"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmSwitch.html#SwitchTargets"><span class="hs-identifier hs-type">SwitchTargets</span></a><span> </span><span class="hs-comment">-- Cases. See [Note SwitchTargets]</span><span>
</span><a name="line-109"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#C"><span class="hs-identifier hs-type">C</span></a><span>
</span><a name="line-110"></a><span>
</span><a name="line-111"></a><span>  </span><a name="CmmCall"><a href="CmmNode.html#CmmCall"><span class="hs-identifier">CmmCall</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">{</span><span>                </span><span class="hs-comment">-- A native call or tail call</span><span>
</span><a name="line-112"></a><span>      </span><a name="cml_target"><a href="CmmNode.html#cml_target"><span class="hs-identifier">cml_target</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- never a CmmPrim to a CallishMachOp!</span><span>
</span><a name="line-113"></a><span>
</span><a name="line-114"></a><span>      </span><a name="cml_cont"><a href="CmmNode.html#cml_cont"><span class="hs-identifier">cml_cont</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span class="hs-special">,</span><span>
</span><a name="line-115"></a><span>          </span><span class="hs-comment">-- Label of continuation (Nothing for return or tail call)</span><span>
</span><a name="line-116"></a><span>          </span><span class="hs-comment">--</span><span>
</span><a name="line-117"></a><span>          </span><span class="hs-comment">-- Note [Continuation BlockId]: these BlockIds are called</span><span>
</span><a name="line-118"></a><span>          </span><span class="hs-comment">-- Continuation BlockIds, and are the only BlockIds that can</span><span>
</span><a name="line-119"></a><span>          </span><span class="hs-comment">-- occur in CmmExprs, namely as (CmmLit (CmmBlock b)) or</span><span>
</span><a name="line-120"></a><span>          </span><span class="hs-comment">-- (CmmStackSlot (Young b) _).</span><span>
</span><a name="line-121"></a><span>
</span><a name="line-122"></a><span>      </span><a name="cml_args_regs"><a href="CmmNode.html#cml_args_regs"><span class="hs-identifier">cml_args_regs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#GlobalReg"><span class="hs-identifier hs-type">GlobalReg</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-123"></a><span>          </span><span class="hs-comment">-- The argument GlobalRegs (Rx, Fx, Dx, Lx) that are passed</span><span>
</span><a name="line-124"></a><span>          </span><span class="hs-comment">-- to the call.  This is essential information for the</span><span>
</span><a name="line-125"></a><span>          </span><span class="hs-comment">-- native code generator's register allocator; without</span><span>
</span><a name="line-126"></a><span>          </span><span class="hs-comment">-- knowing which GlobalRegs are live it has to assume that</span><span>
</span><a name="line-127"></a><span>          </span><span class="hs-comment">-- they are all live.  This list should only include</span><span>
</span><a name="line-128"></a><span>          </span><span class="hs-comment">-- GlobalRegs that are mapped to real machine registers on</span><span>
</span><a name="line-129"></a><span>          </span><span class="hs-comment">-- the target platform.</span><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><span>      </span><a name="cml_args"><a href="CmmNode.html#cml_args"><span class="hs-identifier">cml_args</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span class="hs-special">,</span><span>
</span><a name="line-132"></a><span>          </span><span class="hs-comment">-- Byte offset, from the *old* end of the Area associated with</span><span>
</span><a name="line-133"></a><span>          </span><span class="hs-comment">-- the Label (if cml_cont = Nothing, then Old area), of</span><span>
</span><a name="line-134"></a><span>          </span><span class="hs-comment">-- youngest outgoing arg.  Set the stack pointer to this before</span><span>
</span><a name="line-135"></a><span>          </span><span class="hs-comment">-- transferring control.</span><span>
</span><a name="line-136"></a><span>          </span><span class="hs-comment">-- (NB: an update frame might also have been stored in the Old</span><span>
</span><a name="line-137"></a><span>          </span><span class="hs-comment">--      area, but it'll be in an older part than the args.)</span><span>
</span><a name="line-138"></a><span>
</span><a name="line-139"></a><span>      </span><a name="cml_ret_args"><a href="CmmNode.html#cml_ret_args"><span class="hs-identifier">cml_ret_args</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span class="hs-special">,</span><span>
</span><a name="line-140"></a><span>          </span><span class="hs-comment">-- For calls *only*, the byte offset for youngest returned value</span><span>
</span><a name="line-141"></a><span>          </span><span class="hs-comment">-- This is really needed at the *return* point rather than here</span><span>
</span><a name="line-142"></a><span>          </span><span class="hs-comment">-- at the call, but in practice it's convenient to record it here.</span><span>
</span><a name="line-143"></a><span>
</span><a name="line-144"></a><span>      </span><a name="cml_ret_off"><a href="CmmNode.html#cml_ret_off"><span class="hs-identifier">cml_ret_off</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>
</span><a name="line-145"></a><span>        </span><span class="hs-comment">-- For calls *only*, the byte offset of the base of the frame that</span><span>
</span><a name="line-146"></a><span>        </span><span class="hs-comment">-- must be described by the info table for the return point.</span><span>
</span><a name="line-147"></a><span>        </span><span class="hs-comment">-- The older words are an update frames, which have their own</span><span>
</span><a name="line-148"></a><span>        </span><span class="hs-comment">-- info-table and layout information</span><span>
</span><a name="line-149"></a><span>
</span><a name="line-150"></a><span>        </span><span class="hs-comment">-- From a liveness point of view, the stack words older than</span><span>
</span><a name="line-151"></a><span>        </span><span class="hs-comment">-- cml_ret_off are treated as live, even if the sequel of</span><span>
</span><a name="line-152"></a><span>        </span><span class="hs-comment">-- the call goes into a loop.</span><span>
</span><a name="line-153"></a><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#C"><span class="hs-identifier hs-type">C</span></a><span>
</span><a name="line-154"></a><span>
</span><a name="line-155"></a><span>  </span><a name="CmmForeignCall"><a href="CmmNode.html#CmmForeignCall"><span class="hs-identifier">CmmForeignCall</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">{</span><span>           </span><span class="hs-comment">-- A safe foreign call; see Note [Foreign calls]</span><span>
</span><a name="line-156"></a><span>                                </span><span class="hs-comment">-- Always the last node of a block</span><span>
</span><a name="line-157"></a><span>      </span><a name="tgt"><a href="CmmNode.html#tgt"><span class="hs-identifier">tgt</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-type">ForeignTarget</span></a><span class="hs-special">,</span><span>   </span><span class="hs-comment">-- call target and convention</span><span>
</span><a name="line-158"></a><span>      </span><a name="res"><a href="CmmNode.html#res"><span class="hs-identifier">res</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CmmNode.html#CmmFormal"><span class="hs-identifier hs-type">CmmFormal</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>     </span><span class="hs-comment">-- zero or more results</span><span>
</span><a name="line-159"></a><span>      </span><a name="args"><a href="CmmNode.html#args"><span class="hs-identifier">args</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CmmNode.html#CmmActual"><span class="hs-identifier hs-type">CmmActual</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>     </span><span class="hs-comment">-- zero or more arguments; see Note [Register parameter passing]</span><span>
</span><a name="line-160"></a><span>      </span><a name="succ"><a href="CmmNode.html#succ"><span class="hs-identifier">succ</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ULabel</span><span class="hs-special">,</span><span>          </span><span class="hs-comment">-- Label of continuation</span><span>
</span><a name="line-161"></a><span>      </span><a name="ret_args"><a href="CmmNode.html#ret_args"><span class="hs-identifier">ret_args</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span class="hs-special">,</span><span>      </span><span class="hs-comment">-- same as cml_ret_args</span><span>
</span><a name="line-162"></a><span>      </span><a name="ret_off"><a href="CmmNode.html#ret_off"><span class="hs-identifier">ret_off</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span class="hs-special">,</span><span>       </span><span class="hs-comment">-- same as cml_ret_off</span><span>
</span><a name="line-163"></a><span>      </span><a name="intrbl"><a href="CmmNode.html#intrbl"><span class="hs-identifier">intrbl</span></a></a><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>             </span><span class="hs-comment">-- whether or not the call is interruptible</span><span>
</span><a name="line-164"></a><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#C"><span class="hs-identifier hs-type">C</span></a><span>
</span><a name="line-165"></a><span>
</span><a name="line-166"></a><span class="hs-comment">{- Note [Foreign calls]
~~~~~~~~~~~~~~~~~~~~~~~
A CmmUnsafeForeignCall is used for *unsafe* foreign calls;
a CmmForeignCall call is used for *safe* foreign calls.

Unsafe ones are mostly easy: think of them as a &quot;fat machine
instruction&quot;.  In particular, they do *not* kill all live registers,
just the registers they return to (there was a bit of code in GHC that
conservatively assumed otherwise.)  However, see [Register parameter passing].

Safe ones are trickier.  A safe foreign call
     r = f(x)
ultimately expands to
     push &quot;return address&quot;      -- Never used to return to;
                                -- just points an info table
     save registers into TSO
     call suspendThread
     r = f(x)                   -- Make the call
     call resumeThread
     restore registers
     pop &quot;return address&quot;
We cannot &quot;lower&quot; a safe foreign call to this sequence of Cmms, because
after we've saved Sp all the Cmm optimiser's assumptions are broken.

Note that a safe foreign call needs an info table.

So Safe Foreign Calls must remain as last nodes until the stack is
made manifest in CmmLayoutStack, where they are lowered into the above
sequence.
-}</span><span>
</span><a name="line-196"></a><span>
</span><a name="line-197"></a><span class="hs-comment">{- Note [Unsafe foreign calls clobber caller-save registers]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

A foreign call is defined to clobber any GlobalRegs that are mapped to
caller-saves machine registers (according to the prevailing C ABI).
StgCmmUtils.callerSaves tells you which GlobalRegs are caller-saves.

This is a design choice that makes it easier to generate code later.
We could instead choose to say that foreign calls do *not* clobber
caller-saves regs, but then we would have to figure out which regs
were live across the call later and insert some saves/restores.

Furthermore when we generate code we never have any GlobalRegs live
across a call, because they are always copied-in to LocalRegs and
copied-out again before making a call/jump.  So all we have to do is
avoid any code motion that would make a caller-saves GlobalReg live
across a foreign call during subsequent optimisations.
-}</span><span>
</span><a name="line-215"></a><span>
</span><a name="line-216"></a><span class="hs-comment">{- Note [Register parameter passing]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
On certain architectures, some registers are utilized for parameter
passing in the C calling convention.  For example, in x86-64 Linux
convention, rdi, rsi, rdx and rcx (as well as r8 and r9) may be used for
argument passing.  These are registers R3-R6, which our generated
code may also be using; as a result, it's necessary to save these
values before doing a foreign call.  This is done during initial
code generation in callerSaveVolatileRegs in StgCmmUtils.hs.  However,
one result of doing this is that the contents of these registers
may mysteriously change if referenced inside the arguments.  This
is dangerous, so you'll need to disable inlining much in the same
way is done in cmm/CmmOpt.hs currently.  We should fix this!
-}</span><span>
</span><a name="line-230"></a><span>
</span><a name="line-231"></a><span class="hs-comment">---------------------------------------------</span><span>
</span><a name="line-232"></a><span class="hs-comment">-- Eq instance of CmmNode</span><span>
</span><a name="line-233"></a><span>
</span><a name="line-234"></a><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="#local-6989586621680027971"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621680027972"><span class="hs-identifier hs-type">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-235"></a><span>
</span><a name="line-236"></a><span class="hs-comment">----------------------------------------------</span><span>
</span><a name="line-237"></a><span class="hs-comment">-- Hoopl instances of CmmNode</span><span>
</span><a name="line-238"></a><span>
</span><a name="line-239"></a><span class="hs-keyword">instance</span><span> </span><a href="Hoopl.Graph.html#NonLocal"><span class="hs-identifier hs-type">NonLocal</span></a><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-240"></a><span>  </span><a name="local-8214565720324533399"><a href="Hoopl.Graph.html#entryLabel"><span class="hs-identifier">entryLabel</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmEntry"><span class="hs-identifier hs-var">CmmEntry</span></a><span> </span><a name="local-6989586621680027714"><a href="#local-6989586621680027714"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027714"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-241"></a><span>
</span><a name="line-242"></a><span>  </span><a name="local-8214565720324533400"><a href="Hoopl.Graph.html#successors"><span class="hs-identifier">successors</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmBranch"><span class="hs-identifier hs-var">CmmBranch</span></a><span> </span><a name="local-6989586621680027715"><a href="#local-6989586621680027715"><span class="hs-identifier">l</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680027715"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">]</span><span>
</span><a name="line-243"></a><span>  </span><span class="hs-identifier">successors</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmCondBranch"><span class="hs-identifier hs-var">CmmCondBranch</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">cml_true</span><span class="hs-glyph">=</span><a name="local-6989586621680027716"><a href="#local-6989586621680027716"><span class="hs-identifier">t</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cml_false</span><span class="hs-glyph">=</span><a name="local-6989586621680027717"><a href="#local-6989586621680027717"><span class="hs-identifier">f</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680027717"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680027716"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- meets layout constraint</span><span>
</span><a name="line-244"></a><span>  </span><span class="hs-identifier">successors</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmSwitch"><span class="hs-identifier hs-var">CmmSwitch</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680027718"><a href="#local-6989586621680027718"><span class="hs-identifier">ids</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmSwitch.html#switchTargetsToList"><span class="hs-identifier hs-var">switchTargetsToList</span></a><span> </span><a href="#local-6989586621680027718"><span class="hs-identifier hs-var">ids</span></a><span>
</span><a name="line-245"></a><span>  </span><span class="hs-identifier">successors</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmCall"><span class="hs-identifier hs-var">CmmCall</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">cml_cont</span><span class="hs-glyph">=</span><a name="local-6989586621680027719"><a href="#local-6989586621680027719"><span class="hs-identifier">l</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybeToList</span><span> </span><a href="#local-6989586621680027719"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-246"></a><span>  </span><span class="hs-identifier">successors</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmForeignCall"><span class="hs-identifier hs-var">CmmForeignCall</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">succ</span><span class="hs-glyph">=</span><a name="local-6989586621680027720"><a href="#local-6989586621680027720"><span class="hs-identifier">l</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680027720"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">]</span><span>
</span><a name="line-247"></a><span>
</span><a name="line-248"></a><span>
</span><a name="line-249"></a><span class="hs-comment">--------------------------------------------------</span><span>
</span><a name="line-250"></a><span class="hs-comment">-- Various helper types</span><span>
</span><a name="line-251"></a><span>
</span><a name="line-252"></a><span class="hs-keyword">type</span><span> </span><a name="CmmActual"><a href="CmmNode.html#CmmActual"><span class="hs-identifier">CmmActual</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>
</span><a name="line-253"></a><span class="hs-keyword">type</span><span> </span><a name="CmmFormal"><a href="CmmNode.html#CmmFormal"><span class="hs-identifier">CmmFormal</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span>
</span><a name="line-254"></a><span>
</span><a name="line-255"></a><span class="hs-keyword">type</span><span> </span><a name="UpdFrameOffset"><a href="CmmNode.html#UpdFrameOffset"><span class="hs-identifier">UpdFrameOffset</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>
</span><a name="line-256"></a><span>
</span><a name="line-257"></a><span class="hs-comment">-- | A convention maps a list of values (function arguments or return</span><span>
</span><a name="line-258"></a><span class="hs-comment">-- values) to registers or stack locations.</span><span>
</span><a name="line-259"></a><span class="hs-keyword">data</span><span> </span><a name="Convention"><a href="CmmNode.html#Convention"><span class="hs-identifier">Convention</span></a></a><span>
</span><a name="line-260"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="NativeDirectCall"><a href="CmmNode.html#NativeDirectCall"><span class="hs-identifier">NativeDirectCall</span></a></a><span>
</span><a name="line-261"></a><span>       </span><span class="hs-comment">-- ^ top-level Haskell functions use @NativeDirectCall@, which</span><span>
</span><a name="line-262"></a><span>       </span><span class="hs-comment">-- maps arguments to registers starting with R2, according to</span><span>
</span><a name="line-263"></a><span>       </span><span class="hs-comment">-- how many registers are available on the platform.  This</span><span>
</span><a name="line-264"></a><span>       </span><span class="hs-comment">-- convention ignores R1, because for a top-level function call</span><span>
</span><a name="line-265"></a><span>       </span><span class="hs-comment">-- the function closure is implicit, and doesn't need to be passed.</span><span>
</span><a name="line-266"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="NativeNodeCall"><a href="CmmNode.html#NativeNodeCall"><span class="hs-identifier">NativeNodeCall</span></a></a><span>
</span><a name="line-267"></a><span>       </span><span class="hs-comment">-- ^ non-top-level Haskell functions, which pass the address of</span><span>
</span><a name="line-268"></a><span>       </span><span class="hs-comment">-- the function closure in R1 (regardless of whether R1 is a</span><span>
</span><a name="line-269"></a><span>       </span><span class="hs-comment">-- real register or not), and the rest of the arguments in</span><span>
</span><a name="line-270"></a><span>       </span><span class="hs-comment">-- registers or on the stack.</span><span>
</span><a name="line-271"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="NativeReturn"><a href="CmmNode.html#NativeReturn"><span class="hs-identifier">NativeReturn</span></a></a><span>
</span><a name="line-272"></a><span>       </span><span class="hs-comment">-- ^ a native return.  The convention for returns depends on</span><span>
</span><a name="line-273"></a><span>       </span><span class="hs-comment">-- how many values are returned: for just one value returned,</span><span>
</span><a name="line-274"></a><span>       </span><span class="hs-comment">-- the appropriate register is used (R1, F1, etc.). regardless</span><span>
</span><a name="line-275"></a><span>       </span><span class="hs-comment">-- of whether it is a real register or not.  For multiple</span><span>
</span><a name="line-276"></a><span>       </span><span class="hs-comment">-- values returned, they are mapped to registers or the stack.</span><span>
</span><a name="line-277"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Slow"><a href="CmmNode.html#Slow"><span class="hs-identifier">Slow</span></a></a><span>
</span><a name="line-278"></a><span>       </span><span class="hs-comment">-- ^ Slow entry points: all args pushed on the stack</span><span>
</span><a name="line-279"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="GC"><a href="CmmNode.html#GC"><span class="hs-identifier">GC</span></a></a><span>
</span><a name="line-280"></a><span>       </span><span class="hs-comment">-- ^ Entry to the garbage collector: uses the node reg!</span><span>
</span><a name="line-281"></a><span>       </span><span class="hs-comment">-- (TODO: I don't think we need this --SDM)</span><span>
</span><a name="line-282"></a><span>  </span><span class="hs-keyword">deriving</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-283"></a><span>
</span><a name="line-284"></a><span class="hs-keyword">data</span><span> </span><a name="ForeignConvention"><a href="CmmNode.html#ForeignConvention"><span class="hs-identifier">ForeignConvention</span></a></a><span>
</span><a name="line-285"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="ForeignConvention"><a href="CmmNode.html#ForeignConvention"><span class="hs-identifier">ForeignConvention</span></a></a><span>
</span><a name="line-286"></a><span>        </span><span class="hs-identifier hs-type">CCallConv</span><span>               </span><span class="hs-comment">-- Which foreign-call convention</span><span>
</span><a name="line-287"></a><span>        </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ForeignHint</span><span class="hs-special">]</span><span>           </span><span class="hs-comment">-- Extra info about the args</span><span>
</span><a name="line-288"></a><span>        </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ForeignHint</span><span class="hs-special">]</span><span>           </span><span class="hs-comment">-- Extra info about the result</span><span>
</span><a name="line-289"></a><span>        </span><a href="CmmNode.html#CmmReturnInfo"><span class="hs-identifier hs-type">CmmReturnInfo</span></a><span>
</span><a name="line-290"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier hs-type">Eq</span><span>
</span><a name="line-291"></a><span>
</span><a name="line-292"></a><span class="hs-keyword">data</span><span> </span><a name="CmmReturnInfo"><a href="CmmNode.html#CmmReturnInfo"><span class="hs-identifier">CmmReturnInfo</span></a></a><span>
</span><a name="line-293"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="CmmMayReturn"><a href="CmmNode.html#CmmMayReturn"><span class="hs-identifier">CmmMayReturn</span></a></a><span>
</span><a name="line-294"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="CmmNeverReturns"><a href="CmmNode.html#CmmNeverReturns"><span class="hs-identifier">CmmNeverReturns</span></a></a><span>
</span><a name="line-295"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-296"></a><span>
</span><a name="line-297"></a><span class="hs-keyword">data</span><span> </span><a name="ForeignTarget"><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier">ForeignTarget</span></a></a><span>        </span><span class="hs-comment">-- The target of a foreign call</span><span>
</span><a name="line-298"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="ForeignTarget"><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier">ForeignTarget</span></a></a><span>                </span><span class="hs-comment">-- A foreign procedure</span><span>
</span><a name="line-299"></a><span>        </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>                  </span><span class="hs-comment">-- Its address</span><span>
</span><a name="line-300"></a><span>        </span><a href="CmmNode.html#ForeignConvention"><span class="hs-identifier hs-type">ForeignConvention</span></a><span>        </span><span class="hs-comment">-- Its calling convention</span><span>
</span><a name="line-301"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="PrimTarget"><a href="CmmNode.html#PrimTarget"><span class="hs-identifier">PrimTarget</span></a></a><span>            </span><span class="hs-comment">-- A possibly-side-effecting machine operation</span><span>
</span><a name="line-302"></a><span>        </span><a href="CmmMachOp.html#CallishMachOp"><span class="hs-identifier hs-type">CallishMachOp</span></a><span>            </span><span class="hs-comment">-- Which one</span><span>
</span><a name="line-303"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier hs-type">Eq</span><span>
</span><a name="line-304"></a><span>
</span><a name="line-305"></a><span class="hs-identifier">foreignTargetHints</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-type">ForeignTarget</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">ForeignHint</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ForeignHint</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-306"></a><a name="foreignTargetHints"><a href="CmmNode.html#foreignTargetHints"><span class="hs-identifier">foreignTargetHints</span></a></a><span> </span><a name="local-6989586621680027741"><a href="#local-6989586621680027741"><span class="hs-identifier">target</span></a></a><span>
</span><a name="line-307"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621680027742"><span class="hs-identifier hs-var">res_hints</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">repeat</span><span> </span><span class="hs-identifier hs-var">NoHint</span><span>
</span><a name="line-308"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680027743"><span class="hs-identifier hs-var">arg_hints</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">repeat</span><span> </span><span class="hs-identifier hs-var">NoHint</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-309"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-310"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680027742"><a href="#local-6989586621680027742"><span class="hs-identifier">res_hints</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680027743"><a href="#local-6989586621680027743"><span class="hs-identifier">arg_hints</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-311"></a><span>       </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680027741"><span class="hs-identifier hs-var">target</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-312"></a><span>          </span><a href="CmmNode.html#PrimTarget"><span class="hs-identifier hs-var">PrimTarget</span></a><span> </span><a name="local-6989586621680027744"><a href="#local-6989586621680027744"><span class="hs-identifier">op</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmMachOp.html#callishMachOpHints"><span class="hs-identifier hs-var">callishMachOpHints</span></a><span> </span><a href="#local-6989586621680027744"><span class="hs-identifier hs-var">op</span></a><span>
</span><a name="line-313"></a><span>          </span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-var">ForeignTarget</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#ForeignConvention"><span class="hs-identifier hs-var">ForeignConvention</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680027745"><a href="#local-6989586621680027745"><span class="hs-identifier">arg_hints</span></a></a><span> </span><a name="local-6989586621680027746"><a href="#local-6989586621680027746"><span class="hs-identifier">res_hints</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-314"></a><span>             </span><span class="hs-special">(</span><a href="#local-6989586621680027746"><span class="hs-identifier hs-var">res_hints</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680027745"><span class="hs-identifier hs-var">arg_hints</span></a><span class="hs-special">)</span><span>
</span><a name="line-315"></a><span>
</span><a name="line-316"></a><span class="hs-comment">--------------------------------------------------</span><span>
</span><a name="line-317"></a><span class="hs-comment">-- Instances of register and slot users / definers</span><span>
</span><a name="line-318"></a><span>
</span><a name="line-319"></a><span class="hs-keyword">instance</span><span> </span><a href="CmmExpr.html#UserOfRegs"><span class="hs-identifier hs-type">UserOfRegs</span></a><span> </span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="#local-6989586621680027692"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621680027693"><span class="hs-identifier hs-type">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-320"></a><span>  </span><a name="local-8214565720324648502"><a href="CmmExpr.html#foldRegsUsed"><span class="hs-identifier">foldRegsUsed</span></a></a><span> </span><a name="local-6989586621680027694"><a href="#local-6989586621680027694"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680027695"><a href="#local-6989586621680027695"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621680027696"><a href="#local-6989586621680027696"><span class="hs-identifier">z</span></a></a><span> </span><a name="local-6989586621680027697"><a href="#local-6989586621680027697"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680027697"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-321"></a><span>    </span><a href="CmmNode.html#CmmAssign"><span class="hs-identifier hs-var">CmmAssign</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680027704"><a href="#local-6989586621680027704"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027698"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="#local-6989586621680027695"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027696"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621680027704"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-322"></a><span>    </span><a href="CmmNode.html#CmmStore"><span class="hs-identifier hs-var">CmmStore</span></a><span> </span><a name="local-6989586621680027705"><a href="#local-6989586621680027705"><span class="hs-identifier">addr</span></a></a><span> </span><a name="local-6989586621680027706"><a href="#local-6989586621680027706"><span class="hs-identifier">rval</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027698"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="#local-6989586621680027695"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027698"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="#local-6989586621680027695"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027696"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621680027705"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680027706"><span class="hs-identifier hs-var">rval</span></a><span>
</span><a name="line-323"></a><span>    </span><a href="CmmNode.html#CmmUnsafeForeignCall"><span class="hs-identifier hs-var">CmmUnsafeForeignCall</span></a><span> </span><a name="local-6989586621680027707"><a href="#local-6989586621680027707"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680027708"><a href="#local-6989586621680027708"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027698"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="#local-6989586621680027695"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027698"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="#local-6989586621680027695"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027696"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621680027707"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680027708"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-324"></a><span>    </span><a href="CmmNode.html#CmmCondBranch"><span class="hs-identifier hs-var">CmmCondBranch</span></a><span> </span><a name="local-6989586621680027709"><a href="#local-6989586621680027709"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027698"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="#local-6989586621680027695"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027696"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621680027709"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-325"></a><span>    </span><a href="CmmNode.html#CmmSwitch"><span class="hs-identifier hs-var">CmmSwitch</span></a><span> </span><a name="local-6989586621680027710"><a href="#local-6989586621680027710"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027698"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="#local-6989586621680027695"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027696"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621680027710"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-326"></a><span>    </span><a href="CmmNode.html#CmmCall"><span class="hs-identifier hs-var">CmmCall</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">cml_target</span><span class="hs-glyph">=</span><a name="local-6989586621680027711"><a href="#local-6989586621680027711"><span class="hs-identifier">tgt</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027698"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="#local-6989586621680027695"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027696"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621680027711"><span class="hs-identifier hs-var">tgt</span></a><span>
</span><a name="line-327"></a><span>    </span><a href="CmmNode.html#CmmForeignCall"><span class="hs-identifier hs-var">CmmForeignCall</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">tgt</span><span class="hs-glyph">=</span><a name="local-6989586621680027712"><a href="#local-6989586621680027712"><span class="hs-identifier">tgt</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">args</span><span class="hs-glyph">=</span><a name="local-6989586621680027713"><a href="#local-6989586621680027713"><span class="hs-identifier">args</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027698"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="#local-6989586621680027695"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027698"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="#local-6989586621680027695"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027696"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621680027712"><span class="hs-identifier hs-var">tgt</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680027713"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-328"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027696"><span class="hs-identifier hs-var">z</span></a><span>
</span><a name="line-329"></a><span>    </span><span class="hs-keyword">where</span><span> </span><span class="hs-identifier">fold</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621680027699"><a href="#local-6989586621680027699"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621680027700"><a href="#local-6989586621680027700"><span class="hs-identifier">b</span></a></a><span class="hs-operator">.</span><span> </span><a href="CmmExpr.html#UserOfRegs"><span class="hs-identifier hs-type">UserOfRegs</span></a><span> </span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span> </span><a href="#local-6989586621680027699"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-330"></a><span>               </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027700"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027700"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027700"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027699"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027700"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-331"></a><span>          </span><a name="local-6989586621680027698"><a href="#local-6989586621680027698"><span class="hs-identifier">fold</span></a></a><span> </span><a name="local-6989586621680027701"><a href="#local-6989586621680027701"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680027702"><a href="#local-6989586621680027702"><span class="hs-identifier">z</span></a></a><span> </span><a name="local-6989586621680027703"><a href="#local-6989586621680027703"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#foldRegsUsed"><span class="hs-identifier hs-var">foldRegsUsed</span></a><span> </span><a href="#local-6989586621680027694"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680027701"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027702"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621680027703"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-332"></a><span>
</span><a name="line-333"></a><span class="hs-keyword">instance</span><span> </span><a href="CmmExpr.html#UserOfRegs"><span class="hs-identifier hs-type">UserOfRegs</span></a><span> </span><a href="CmmExpr.html#GlobalReg"><span class="hs-identifier hs-type">GlobalReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="#local-6989586621680027669"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621680027670"><span class="hs-identifier hs-type">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-334"></a><span>  </span><a name="local-8214565720324648502"><a href="CmmExpr.html#foldRegsUsed"><span class="hs-identifier">foldRegsUsed</span></a></a><span> </span><a name="local-6989586621680027671"><a href="#local-6989586621680027671"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680027672"><a href="#local-6989586621680027672"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621680027673"><a href="#local-6989586621680027673"><span class="hs-identifier">z</span></a></a><span> </span><a name="local-6989586621680027674"><a href="#local-6989586621680027674"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680027674"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-335"></a><span>    </span><a href="CmmNode.html#CmmAssign"><span class="hs-identifier hs-var">CmmAssign</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680027681"><a href="#local-6989586621680027681"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027675"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="#local-6989586621680027672"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027673"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621680027681"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-336"></a><span>    </span><a href="CmmNode.html#CmmStore"><span class="hs-identifier hs-var">CmmStore</span></a><span> </span><a name="local-6989586621680027682"><a href="#local-6989586621680027682"><span class="hs-identifier">addr</span></a></a><span> </span><a name="local-6989586621680027683"><a href="#local-6989586621680027683"><span class="hs-identifier">rval</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027675"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="#local-6989586621680027672"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027675"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="#local-6989586621680027672"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027673"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621680027682"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680027683"><span class="hs-identifier hs-var">rval</span></a><span>
</span><a name="line-337"></a><span>    </span><a href="CmmNode.html#CmmUnsafeForeignCall"><span class="hs-identifier hs-var">CmmUnsafeForeignCall</span></a><span> </span><a name="local-6989586621680027684"><a href="#local-6989586621680027684"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680027685"><a href="#local-6989586621680027685"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027675"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="#local-6989586621680027672"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027675"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="#local-6989586621680027672"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027673"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621680027684"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680027685"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-338"></a><span>    </span><a href="CmmNode.html#CmmCondBranch"><span class="hs-identifier hs-var">CmmCondBranch</span></a><span> </span><a name="local-6989586621680027686"><a href="#local-6989586621680027686"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027675"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="#local-6989586621680027672"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027673"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621680027686"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-339"></a><span>    </span><a href="CmmNode.html#CmmSwitch"><span class="hs-identifier hs-var">CmmSwitch</span></a><span> </span><a name="local-6989586621680027687"><a href="#local-6989586621680027687"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027675"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="#local-6989586621680027672"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027673"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621680027687"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-340"></a><span>    </span><a href="CmmNode.html#CmmCall"><span class="hs-identifier hs-var">CmmCall</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">cml_target</span><span class="hs-glyph">=</span><a name="local-6989586621680027688"><a href="#local-6989586621680027688"><span class="hs-identifier">tgt</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cml_args_regs</span><span class="hs-glyph">=</span><a name="local-6989586621680027689"><a href="#local-6989586621680027689"><span class="hs-identifier">args</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027675"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="#local-6989586621680027672"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027675"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="#local-6989586621680027672"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027673"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621680027689"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680027688"><span class="hs-identifier hs-var">tgt</span></a><span>
</span><a name="line-341"></a><span>    </span><a href="CmmNode.html#CmmForeignCall"><span class="hs-identifier hs-var">CmmForeignCall</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">tgt</span><span class="hs-glyph">=</span><a name="local-6989586621680027690"><a href="#local-6989586621680027690"><span class="hs-identifier">tgt</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">args</span><span class="hs-glyph">=</span><a name="local-6989586621680027691"><a href="#local-6989586621680027691"><span class="hs-identifier">args</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027675"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="#local-6989586621680027672"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027675"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="#local-6989586621680027672"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027673"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621680027690"><span class="hs-identifier hs-var">tgt</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680027691"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-342"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027673"><span class="hs-identifier hs-var">z</span></a><span>
</span><a name="line-343"></a><span>    </span><span class="hs-keyword">where</span><span> </span><span class="hs-identifier">fold</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621680027676"><a href="#local-6989586621680027676"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621680027677"><a href="#local-6989586621680027677"><span class="hs-identifier">b</span></a></a><span class="hs-operator">.</span><span>  </span><a href="CmmExpr.html#UserOfRegs"><span class="hs-identifier hs-type">UserOfRegs</span></a><span> </span><a href="CmmExpr.html#GlobalReg"><span class="hs-identifier hs-type">GlobalReg</span></a><span> </span><a href="#local-6989586621680027676"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-344"></a><span>               </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027677"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#GlobalReg"><span class="hs-identifier hs-type">GlobalReg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027677"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027677"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027676"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027677"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-345"></a><span>          </span><a name="local-6989586621680027675"><a href="#local-6989586621680027675"><span class="hs-identifier">fold</span></a></a><span> </span><a name="local-6989586621680027678"><a href="#local-6989586621680027678"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680027679"><a href="#local-6989586621680027679"><span class="hs-identifier">z</span></a></a><span> </span><a name="local-6989586621680027680"><a href="#local-6989586621680027680"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#foldRegsUsed"><span class="hs-identifier hs-var">foldRegsUsed</span></a><span> </span><a href="#local-6989586621680027671"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680027678"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027679"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621680027680"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-346"></a><span>
</span><a name="line-347"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621680027663"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">,</span><span> </span><a href="CmmExpr.html#UserOfRegs"><span class="hs-identifier hs-type">UserOfRegs</span></a><span> </span><a href="#local-6989586621680027663"><span class="hs-identifier hs-type">r</span></a><span> </span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-type">CmmReg</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="CmmExpr.html#UserOfRegs"><span class="hs-identifier hs-type">UserOfRegs</span></a><span> </span><a href="#local-6989586621680027663"><span class="hs-identifier hs-type">r</span></a><span> </span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-type">ForeignTarget</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-348"></a><span>  </span><span class="hs-comment">-- The (Ord r) in the context is necessary here</span><span>
</span><a name="line-349"></a><span>  </span><span class="hs-comment">-- See Note [Recursive superclasses] in TcInstDcls</span><span>
</span><a name="line-350"></a><span>  </span><a name="local-8214565720324648502"><a href="CmmExpr.html#foldRegsUsed"><span class="hs-identifier">foldRegsUsed</span></a></a><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621680027664"><a href="#local-6989586621680027664"><span class="hs-identifier">z</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#PrimTarget"><span class="hs-identifier hs-var">PrimTarget</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027664"><span class="hs-identifier hs-var">z</span></a><span>
</span><a name="line-351"></a><span>  </span><span class="hs-identifier">foldRegsUsed</span><span> </span><a name="local-6989586621680027665"><a href="#local-6989586621680027665"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680027666"><a href="#local-6989586621680027666"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621680027667"><a href="#local-6989586621680027667"><span class="hs-identifier">z</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-var">ForeignTarget</span></a><span> </span><a name="local-6989586621680027668"><a href="#local-6989586621680027668"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#foldRegsUsed"><span class="hs-identifier hs-var">foldRegsUsed</span></a><span> </span><a href="#local-6989586621680027665"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680027666"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027667"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621680027668"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-352"></a><span>
</span><a name="line-353"></a><span class="hs-keyword">instance</span><span> </span><a href="CmmExpr.html#DefinerOfRegs"><span class="hs-identifier hs-type">DefinerOfRegs</span></a><span> </span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="#local-6989586621680027648"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621680027649"><span class="hs-identifier hs-type">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-354"></a><span>  </span><a name="local-8214565720324648500"><a href="CmmExpr.html#foldRegsDefd"><span class="hs-identifier">foldRegsDefd</span></a></a><span> </span><a name="local-6989586621680027650"><a href="#local-6989586621680027650"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680027651"><a href="#local-6989586621680027651"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621680027652"><a href="#local-6989586621680027652"><span class="hs-identifier">z</span></a></a><span> </span><a name="local-6989586621680027653"><a href="#local-6989586621680027653"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680027653"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-355"></a><span>    </span><a href="CmmNode.html#CmmAssign"><span class="hs-identifier hs-var">CmmAssign</span></a><span> </span><a name="local-6989586621680027660"><a href="#local-6989586621680027660"><span class="hs-identifier">lhs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027654"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="#local-6989586621680027651"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027652"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621680027660"><span class="hs-identifier hs-var">lhs</span></a><span>
</span><a name="line-356"></a><span>    </span><a href="CmmNode.html#CmmUnsafeForeignCall"><span class="hs-identifier hs-var">CmmUnsafeForeignCall</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680027661"><a href="#local-6989586621680027661"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027654"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="#local-6989586621680027651"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027652"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621680027661"><span class="hs-identifier hs-var">fs</span></a><span>
</span><a name="line-357"></a><span>    </span><a href="CmmNode.html#CmmForeignCall"><span class="hs-identifier hs-var">CmmForeignCall</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">res</span><span class="hs-glyph">=</span><a name="local-6989586621680027662"><a href="#local-6989586621680027662"><span class="hs-identifier">res</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027654"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="#local-6989586621680027651"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027652"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621680027662"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-358"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027652"><span class="hs-identifier hs-var">z</span></a><span>
</span><a name="line-359"></a><span>    </span><span class="hs-keyword">where</span><span> </span><span class="hs-identifier">fold</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621680027655"><a href="#local-6989586621680027655"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621680027656"><a href="#local-6989586621680027656"><span class="hs-identifier">b</span></a></a><span class="hs-operator">.</span><span> </span><a href="CmmExpr.html#DefinerOfRegs"><span class="hs-identifier hs-type">DefinerOfRegs</span></a><span> </span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span> </span><a href="#local-6989586621680027655"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-360"></a><span>               </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027656"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027656"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027656"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027655"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027656"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-361"></a><span>          </span><a name="local-6989586621680027654"><a href="#local-6989586621680027654"><span class="hs-identifier">fold</span></a></a><span> </span><a name="local-6989586621680027657"><a href="#local-6989586621680027657"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680027658"><a href="#local-6989586621680027658"><span class="hs-identifier">z</span></a></a><span> </span><a name="local-6989586621680027659"><a href="#local-6989586621680027659"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#foldRegsDefd"><span class="hs-identifier hs-var">foldRegsDefd</span></a><span> </span><a href="#local-6989586621680027650"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680027657"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027658"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621680027659"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-362"></a><span>
</span><a name="line-363"></a><span class="hs-keyword">instance</span><span> </span><a href="CmmExpr.html#DefinerOfRegs"><span class="hs-identifier hs-type">DefinerOfRegs</span></a><span> </span><a href="CmmExpr.html#GlobalReg"><span class="hs-identifier hs-type">GlobalReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="#local-6989586621680027630"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621680027631"><span class="hs-identifier hs-type">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-364"></a><span>  </span><a name="local-8214565720324648500"><a href="CmmExpr.html#foldRegsDefd"><span class="hs-identifier">foldRegsDefd</span></a></a><span> </span><a name="local-6989586621680027632"><a href="#local-6989586621680027632"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680027633"><a href="#local-6989586621680027633"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621680027634"><a href="#local-6989586621680027634"><span class="hs-identifier">z</span></a></a><span> </span><a name="local-6989586621680027635"><a href="#local-6989586621680027635"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680027635"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-365"></a><span>    </span><a href="CmmNode.html#CmmAssign"><span class="hs-identifier hs-var">CmmAssign</span></a><span> </span><a name="local-6989586621680027646"><a href="#local-6989586621680027646"><span class="hs-identifier">lhs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027636"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="#local-6989586621680027633"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027634"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621680027646"><span class="hs-identifier hs-var">lhs</span></a><span>
</span><a name="line-366"></a><span>    </span><a href="CmmNode.html#CmmUnsafeForeignCall"><span class="hs-identifier hs-var">CmmUnsafeForeignCall</span></a><span> </span><a name="local-6989586621680027647"><a href="#local-6989586621680027647"><span class="hs-identifier">tgt</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027636"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="#local-6989586621680027633"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027634"><span class="hs-identifier hs-var">z</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027640"><span class="hs-identifier hs-var">foreignTargetRegs</span></a><span> </span><a href="#local-6989586621680027647"><span class="hs-identifier hs-var">tgt</span></a><span class="hs-special">)</span><span>
</span><a name="line-367"></a><span>    </span><a href="CmmNode.html#CmmCall"><span class="hs-identifier hs-var">CmmCall</span></a><span>        </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027636"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="#local-6989586621680027633"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027634"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621680027638"><span class="hs-identifier hs-var">activeRegs</span></a><span>
</span><a name="line-368"></a><span>    </span><a href="CmmNode.html#CmmForeignCall"><span class="hs-identifier hs-var">CmmForeignCall</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027636"><span class="hs-identifier hs-var">fold</span></a><span> </span><a href="#local-6989586621680027633"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027634"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621680027638"><span class="hs-identifier hs-var">activeRegs</span></a><span>
</span><a name="line-369"></a><span>                      </span><span class="hs-comment">-- See Note [Safe foreign calls clobber STG registers]</span><span>
</span><a name="line-370"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027634"><span class="hs-identifier hs-var">z</span></a><span>
</span><a name="line-371"></a><span>    </span><span class="hs-keyword">where</span><span> </span><span class="hs-identifier">fold</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621680027641"><a href="#local-6989586621680027641"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621680027642"><a href="#local-6989586621680027642"><span class="hs-identifier">b</span></a></a><span class="hs-operator">.</span><span> </span><a href="CmmExpr.html#DefinerOfRegs"><span class="hs-identifier hs-type">DefinerOfRegs</span></a><span> </span><a href="CmmExpr.html#GlobalReg"><span class="hs-identifier hs-type">GlobalReg</span></a><span> </span><a href="#local-6989586621680027641"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-372"></a><span>               </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027642"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#GlobalReg"><span class="hs-identifier hs-type">GlobalReg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027642"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027642"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027641"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027642"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-373"></a><span>          </span><a name="local-6989586621680027636"><a href="#local-6989586621680027636"><span class="hs-identifier">fold</span></a></a><span> </span><a name="local-6989586621680027643"><a href="#local-6989586621680027643"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680027644"><a href="#local-6989586621680027644"><span class="hs-identifier">z</span></a></a><span> </span><a name="local-6989586621680027645"><a href="#local-6989586621680027645"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#foldRegsDefd"><span class="hs-identifier hs-var">foldRegsDefd</span></a><span> </span><a href="#local-6989586621680027632"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680027643"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027644"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621680027645"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-374"></a><span>
</span><a name="line-375"></a><span>          </span><a name="local-6989586621680027637"><a href="#local-6989586621680027637"><span class="hs-identifier">platform</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621680027632"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-376"></a><span>          </span><a name="local-6989586621680027638"><a href="#local-6989586621680027638"><span class="hs-identifier">activeRegs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CodeGen.Platform.html#activeStgRegs"><span class="hs-identifier hs-var">activeStgRegs</span></a><span> </span><a href="#local-6989586621680027637"><span class="hs-identifier hs-var">platform</span></a><span>
</span><a name="line-377"></a><span>          </span><a name="local-6989586621680027639"><a href="#local-6989586621680027639"><span class="hs-identifier">activeCallerSavesRegs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><a href="CodeGen.Platform.html#callerSaves"><span class="hs-identifier hs-var">callerSaves</span></a><span> </span><a href="#local-6989586621680027637"><span class="hs-identifier hs-var">platform</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680027638"><span class="hs-identifier hs-var">activeRegs</span></a><span>
</span><a name="line-378"></a><span>
</span><a name="line-379"></a><span>          </span><a name="local-6989586621680027640"><a href="#local-6989586621680027640"><span class="hs-identifier">foreignTargetRegs</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-var">ForeignTarget</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#ForeignConvention"><span class="hs-identifier hs-var">ForeignConvention</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a href="CmmNode.html#CmmNeverReturns"><span class="hs-identifier hs-var">CmmNeverReturns</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-380"></a><span>          </span><span class="hs-identifier">foreignTargetRegs</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027639"><span class="hs-identifier hs-var">activeCallerSavesRegs</span></a><span>
</span><a name="line-381"></a><span>
</span><a name="line-382"></a><span class="hs-comment">-- Note [Safe foreign calls clobber STG registers]</span><span>
</span><a name="line-383"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-384"></a><span class="hs-comment">--</span><span>
</span><a name="line-385"></a><span class="hs-comment">-- During stack layout phase every safe foreign call is expanded into a block</span><span>
</span><a name="line-386"></a><span class="hs-comment">-- that contains unsafe foreign call (instead of safe foreign call) and ends</span><span>
</span><a name="line-387"></a><span class="hs-comment">-- with a normal call (See Note [Foreign calls]). This means that we must</span><span>
</span><a name="line-388"></a><span class="hs-comment">-- treat safe foreign call as if it was a normal call (because eventually it</span><span>
</span><a name="line-389"></a><span class="hs-comment">-- will be). This is important if we try to run sinking pass before stack</span><span>
</span><a name="line-390"></a><span class="hs-comment">-- layout phase. Consider this example of what might go wrong (this is cmm</span><span>
</span><a name="line-391"></a><span class="hs-comment">-- code from stablename001 test). Here is code after common block elimination</span><span>
</span><a name="line-392"></a><span class="hs-comment">-- (before stack layout):</span><span>
</span><a name="line-393"></a><span class="hs-comment">--</span><span>
</span><a name="line-394"></a><span class="hs-comment">--  c1q6:</span><span>
</span><a name="line-395"></a><span class="hs-comment">--      _s1pf::P64 = R1;</span><span>
</span><a name="line-396"></a><span class="hs-comment">--      _c1q8::I64 = performMajorGC;</span><span>
</span><a name="line-397"></a><span class="hs-comment">--      I64[(young&lt;c1q9&gt; + 8)] = c1q9;</span><span>
</span><a name="line-398"></a><span class="hs-comment">--      foreign call &quot;ccall&quot; arg hints:  []  result hints:  [] (_c1q8::I64)(...)</span><span>
</span><a name="line-399"></a><span class="hs-comment">--                   returns to c1q9 args: ([]) ress: ([])ret_args: 8ret_off: 8;</span><span>
</span><a name="line-400"></a><span class="hs-comment">--  c1q9:</span><span>
</span><a name="line-401"></a><span class="hs-comment">--      I64[(young&lt;c1qb&gt; + 8)] = c1qb;</span><span>
</span><a name="line-402"></a><span class="hs-comment">--      R1 = _s1pc::P64;</span><span>
</span><a name="line-403"></a><span class="hs-comment">--      call stg_makeStableName#(R1) returns to c1qb, args: 8, res: 8, upd: 8;</span><span>
</span><a name="line-404"></a><span class="hs-comment">--</span><span>
</span><a name="line-405"></a><span class="hs-comment">-- If we run sinking pass now (still before stack layout) we will get this:</span><span>
</span><a name="line-406"></a><span class="hs-comment">--</span><span>
</span><a name="line-407"></a><span class="hs-comment">--  c1q6:</span><span>
</span><a name="line-408"></a><span class="hs-comment">--      I64[(young&lt;c1q9&gt; + 8)] = c1q9;</span><span>
</span><a name="line-409"></a><span class="hs-comment">--      foreign call &quot;ccall&quot; arg hints:  []  result hints:  [] performMajorGC(...)</span><span>
</span><a name="line-410"></a><span class="hs-comment">--                   returns to c1q9 args: ([]) ress: ([])ret_args: 8ret_off: 8;</span><span>
</span><a name="line-411"></a><span class="hs-comment">--  c1q9:</span><span>
</span><a name="line-412"></a><span class="hs-comment">--      I64[(young&lt;c1qb&gt; + 8)] = c1qb;</span><span>
</span><a name="line-413"></a><span class="hs-comment">--      _s1pf::P64 = R1;         &lt;------ _s1pf sunk past safe foreign call</span><span>
</span><a name="line-414"></a><span class="hs-comment">--      R1 = _s1pc::P64;</span><span>
</span><a name="line-415"></a><span class="hs-comment">--      call stg_makeStableName#(R1) returns to c1qb, args: 8, res: 8, upd: 8;</span><span>
</span><a name="line-416"></a><span class="hs-comment">--</span><span>
</span><a name="line-417"></a><span class="hs-comment">-- Notice that _s1pf was sunk past a foreign call. When we run stack layout</span><span>
</span><a name="line-418"></a><span class="hs-comment">-- safe call to performMajorGC will be turned into:</span><span>
</span><a name="line-419"></a><span class="hs-comment">--</span><span>
</span><a name="line-420"></a><span class="hs-comment">--  c1q6:</span><span>
</span><a name="line-421"></a><span class="hs-comment">--      _s1pc::P64 = P64[Sp + 8];</span><span>
</span><a name="line-422"></a><span class="hs-comment">--      I64[Sp - 8] = c1q9;</span><span>
</span><a name="line-423"></a><span class="hs-comment">--      Sp = Sp - 8;</span><span>
</span><a name="line-424"></a><span class="hs-comment">--      I64[I64[CurrentTSO + 24] + 16] = Sp;</span><span>
</span><a name="line-425"></a><span class="hs-comment">--      P64[CurrentNursery + 8] = Hp + 8;</span><span>
</span><a name="line-426"></a><span class="hs-comment">--      (_u1qI::I64) = call &quot;ccall&quot; arg hints:  [PtrHint,]</span><span>
</span><a name="line-427"></a><span class="hs-comment">--                           result hints:  [PtrHint] suspendThread(BaseReg, 0);</span><span>
</span><a name="line-428"></a><span class="hs-comment">--      call &quot;ccall&quot; arg hints:  []  result hints:  [] performMajorGC();</span><span>
</span><a name="line-429"></a><span class="hs-comment">--      (_u1qJ::I64) = call &quot;ccall&quot; arg hints:  [PtrHint]</span><span>
</span><a name="line-430"></a><span class="hs-comment">--                           result hints:  [PtrHint] resumeThread(_u1qI::I64);</span><span>
</span><a name="line-431"></a><span class="hs-comment">--      BaseReg = _u1qJ::I64;</span><span>
</span><a name="line-432"></a><span class="hs-comment">--      _u1qK::P64 = CurrentTSO;</span><span>
</span><a name="line-433"></a><span class="hs-comment">--      _u1qL::P64 = I64[_u1qK::P64 + 24];</span><span>
</span><a name="line-434"></a><span class="hs-comment">--      Sp = I64[_u1qL::P64 + 16];</span><span>
</span><a name="line-435"></a><span class="hs-comment">--      SpLim = _u1qL::P64 + 192;</span><span>
</span><a name="line-436"></a><span class="hs-comment">--      HpAlloc = 0;</span><span>
</span><a name="line-437"></a><span class="hs-comment">--      Hp = I64[CurrentNursery + 8] - 8;</span><span>
</span><a name="line-438"></a><span class="hs-comment">--      HpLim = I64[CurrentNursery] + (%MO_SS_Conv_W32_W64(I32[CurrentNursery + 48]) * 4096 - 1);</span><span>
</span><a name="line-439"></a><span class="hs-comment">--      call (I64[Sp])() returns to c1q9, args: 8, res: 8, upd: 8;</span><span>
</span><a name="line-440"></a><span class="hs-comment">--  c1q9:</span><span>
</span><a name="line-441"></a><span class="hs-comment">--      I64[(young&lt;c1qb&gt; + 8)] = c1qb;</span><span>
</span><a name="line-442"></a><span class="hs-comment">--      _s1pf::P64 = R1;         &lt;------ INCORRECT!</span><span>
</span><a name="line-443"></a><span class="hs-comment">--      R1 = _s1pc::P64;</span><span>
</span><a name="line-444"></a><span class="hs-comment">--      call stg_makeStableName#(R1) returns to c1qb, args: 8, res: 8, upd: 8;</span><span>
</span><a name="line-445"></a><span class="hs-comment">--</span><span>
</span><a name="line-446"></a><span class="hs-comment">-- Notice that c1q6 now ends with a call. Sinking _s1pf::P64 = R1 past that</span><span>
</span><a name="line-447"></a><span class="hs-comment">-- call is clearly incorrect. This is what would happen if we assumed that</span><span>
</span><a name="line-448"></a><span class="hs-comment">-- safe foreign call has the same semantics as unsafe foreign call. To prevent</span><span>
</span><a name="line-449"></a><span class="hs-comment">-- this we need to treat safe foreign call as if was normal call.</span><span>
</span><a name="line-450"></a><span>
</span><a name="line-451"></a><span class="hs-comment">-----------------------------------</span><span>
</span><a name="line-452"></a><span class="hs-comment">-- mapping Expr in CmmNode</span><span>
</span><a name="line-453"></a><span>
</span><a name="line-454"></a><span class="hs-identifier">mapForeignTarget</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-type">ForeignTarget</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-type">ForeignTarget</span></a><span>
</span><a name="line-455"></a><a name="mapForeignTarget"><a href="CmmNode.html#mapForeignTarget"><span class="hs-identifier">mapForeignTarget</span></a></a><span> </span><a name="local-6989586621680027747"><a href="#local-6989586621680027747"><span class="hs-identifier">exp</span></a></a><span>   </span><span class="hs-special">(</span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-var">ForeignTarget</span></a><span> </span><a name="local-6989586621680027748"><a href="#local-6989586621680027748"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621680027749"><a href="#local-6989586621680027749"><span class="hs-identifier">c</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-var">ForeignTarget</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027747"><span class="hs-identifier hs-var">exp</span></a><span> </span><a href="#local-6989586621680027748"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680027749"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-456"></a><span class="hs-identifier">mapForeignTarget</span><span> </span><span class="hs-identifier">_</span><span>   </span><a name="local-6989586621680027750"><a href="#local-6989586621680027750"><span class="hs-identifier">m</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CmmNode.html#PrimTarget"><span class="hs-identifier hs-var">PrimTarget</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027750"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-457"></a><span>
</span><a name="line-458"></a><span class="hs-identifier">wrapRecExp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>
</span><a name="line-459"></a><span class="hs-comment">-- Take a transformer on expressions and apply it recursively.</span><span>
</span><a name="line-460"></a><span class="hs-comment">-- (wrapRecExp f e) first recursively applies itself to sub-expressions of e</span><span>
</span><a name="line-461"></a><span class="hs-comment">--                  then  uses f to rewrite the resulting expression</span><span>
</span><a name="line-462"></a><a name="wrapRecExp"><a href="CmmNode.html#wrapRecExp"><span class="hs-identifier">wrapRecExp</span></a></a><span> </span><a name="local-6989586621680027751"><a href="#local-6989586621680027751"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmMachOp"><span class="hs-identifier hs-var">CmmMachOp</span></a><span> </span><a name="local-6989586621680027752"><a href="#local-6989586621680027752"><span class="hs-identifier">op</span></a></a><span> </span><a name="local-6989586621680027753"><a href="#local-6989586621680027753"><span class="hs-identifier">es</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027751"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmMachOp"><span class="hs-identifier hs-var">CmmMachOp</span></a><span> </span><a href="#local-6989586621680027752"><span class="hs-identifier hs-var">op</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#wrapRecExp"><span class="hs-identifier hs-var">wrapRecExp</span></a><span> </span><a href="#local-6989586621680027751"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680027753"><span class="hs-identifier hs-var">es</span></a><span class="hs-special">)</span><span>
</span><a name="line-463"></a><span class="hs-identifier">wrapRecExp</span><span> </span><a name="local-6989586621680027754"><a href="#local-6989586621680027754"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLoad"><span class="hs-identifier hs-var">CmmLoad</span></a><span> </span><a name="local-6989586621680027755"><a href="#local-6989586621680027755"><span class="hs-identifier">addr</span></a></a><span> </span><a name="local-6989586621680027756"><a href="#local-6989586621680027756"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027754"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLoad"><span class="hs-identifier hs-var">CmmLoad</span></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#wrapRecExp"><span class="hs-identifier hs-var">wrapRecExp</span></a><span> </span><a href="#local-6989586621680027754"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027755"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680027756"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-464"></a><span class="hs-identifier">wrapRecExp</span><span> </span><a name="local-6989586621680027757"><a href="#local-6989586621680027757"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680027758"><a href="#local-6989586621680027758"><span class="hs-identifier">e</span></a></a><span>                    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027757"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027758"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-465"></a><span>
</span><a name="line-466"></a><span class="hs-identifier">mapExp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="#local-6989586621680027739"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621680027740"><span class="hs-identifier hs-type">x</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="#local-6989586621680027739"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621680027740"><span class="hs-identifier hs-type">x</span></a><span>
</span><a name="line-467"></a><a name="mapExp"><a href="CmmNode.html#mapExp"><span class="hs-identifier">mapExp</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680027759"><a href="#local-6989586621680027759"><span class="hs-identifier">f</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CmmNode.html#CmmEntry"><span class="hs-identifier hs-var">CmmEntry</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>                          </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027759"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-468"></a><span class="hs-identifier">mapExp</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680027760"><a href="#local-6989586621680027760"><span class="hs-identifier">m</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CmmNode.html#CmmComment"><span class="hs-identifier hs-var">CmmComment</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>                        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027760"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-469"></a><span class="hs-identifier">mapExp</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680027761"><a href="#local-6989586621680027761"><span class="hs-identifier">m</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CmmNode.html#CmmTick"><span class="hs-identifier hs-var">CmmTick</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>                           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027761"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-470"></a><span class="hs-identifier">mapExp</span><span> </span><a name="local-6989586621680027762"><a href="#local-6989586621680027762"><span class="hs-identifier">f</span></a></a><span>   </span><span class="hs-special">(</span><a href="CmmNode.html#CmmUnwind"><span class="hs-identifier hs-var">CmmUnwind</span></a><span> </span><a name="local-6989586621680027763"><a href="#local-6989586621680027763"><span class="hs-identifier">regs</span></a></a><span class="hs-special">)</span><span>                      </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#CmmUnwind"><span class="hs-identifier hs-var">CmmUnwind</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621680027762"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680027763"><span class="hs-identifier hs-var">regs</span></a><span class="hs-special">)</span><span>
</span><a name="line-471"></a><span class="hs-identifier">mapExp</span><span> </span><a name="local-6989586621680027764"><a href="#local-6989586621680027764"><span class="hs-identifier">f</span></a></a><span>   </span><span class="hs-special">(</span><a href="CmmNode.html#CmmAssign"><span class="hs-identifier hs-var">CmmAssign</span></a><span> </span><a name="local-6989586621680027765"><a href="#local-6989586621680027765"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621680027766"><a href="#local-6989586621680027766"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>                       </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#CmmAssign"><span class="hs-identifier hs-var">CmmAssign</span></a><span> </span><a href="#local-6989586621680027765"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027764"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027766"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-472"></a><span class="hs-identifier">mapExp</span><span> </span><a name="local-6989586621680027767"><a href="#local-6989586621680027767"><span class="hs-identifier">f</span></a></a><span>   </span><span class="hs-special">(</span><a href="CmmNode.html#CmmStore"><span class="hs-identifier hs-var">CmmStore</span></a><span> </span><a name="local-6989586621680027768"><a href="#local-6989586621680027768"><span class="hs-identifier">addr</span></a></a><span> </span><a name="local-6989586621680027769"><a href="#local-6989586621680027769"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>                     </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#CmmStore"><span class="hs-identifier hs-var">CmmStore</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027767"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027768"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027767"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027769"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-473"></a><span class="hs-identifier">mapExp</span><span> </span><a name="local-6989586621680027770"><a href="#local-6989586621680027770"><span class="hs-identifier">f</span></a></a><span>   </span><span class="hs-special">(</span><a href="CmmNode.html#CmmUnsafeForeignCall"><span class="hs-identifier hs-var">CmmUnsafeForeignCall</span></a><span> </span><a name="local-6989586621680027771"><a href="#local-6989586621680027771"><span class="hs-identifier">tgt</span></a></a><span> </span><a name="local-6989586621680027772"><a href="#local-6989586621680027772"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#CmmUnsafeForeignCall"><span class="hs-identifier hs-var">CmmUnsafeForeignCall</span></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#mapForeignTarget"><span class="hs-identifier hs-var">mapForeignTarget</span></a><span> </span><a href="#local-6989586621680027770"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027771"><span class="hs-identifier hs-var">tgt</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680027772"><span class="hs-identifier hs-var">fs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621680027770"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-474"></a><span class="hs-identifier">mapExp</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680027774"><a href="#local-6989586621680027774"><span class="hs-identifier">l</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CmmNode.html#CmmBranch"><span class="hs-identifier hs-var">CmmBranch</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>                         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027774"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-475"></a><span class="hs-identifier">mapExp</span><span> </span><a name="local-6989586621680027775"><a href="#local-6989586621680027775"><span class="hs-identifier">f</span></a></a><span>   </span><span class="hs-special">(</span><a href="CmmNode.html#CmmCondBranch"><span class="hs-identifier hs-var">CmmCondBranch</span></a><span> </span><a name="local-6989586621680027776"><a href="#local-6989586621680027776"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621680027777"><a href="#local-6989586621680027777"><span class="hs-identifier">ti</span></a></a><span> </span><a name="local-6989586621680027778"><a href="#local-6989586621680027778"><span class="hs-identifier">fi</span></a></a><span> </span><a name="local-6989586621680027779"><a href="#local-6989586621680027779"><span class="hs-identifier">l</span></a></a><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#CmmCondBranch"><span class="hs-identifier hs-var">CmmCondBranch</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027775"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027776"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680027777"><span class="hs-identifier hs-var">ti</span></a><span> </span><a href="#local-6989586621680027778"><span class="hs-identifier hs-var">fi</span></a><span> </span><a href="#local-6989586621680027779"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-476"></a><span class="hs-identifier">mapExp</span><span> </span><a name="local-6989586621680027780"><a href="#local-6989586621680027780"><span class="hs-identifier">f</span></a></a><span>   </span><span class="hs-special">(</span><a href="CmmNode.html#CmmSwitch"><span class="hs-identifier hs-var">CmmSwitch</span></a><span> </span><a name="local-6989586621680027781"><a href="#local-6989586621680027781"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621680027782"><a href="#local-6989586621680027782"><span class="hs-identifier">ids</span></a></a><span class="hs-special">)</span><span>                     </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#CmmSwitch"><span class="hs-identifier hs-var">CmmSwitch</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027780"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027781"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680027782"><span class="hs-identifier hs-var">ids</span></a><span>
</span><a name="line-477"></a><span class="hs-identifier">mapExp</span><span> </span><a name="local-6989586621680027783"><a href="#local-6989586621680027783"><span class="hs-identifier">f</span></a></a><span>   </span><a name="local-6989586621680027784"><a href="#local-6989586621680027784"><span class="hs-identifier">n</span></a></a><span class="hs-glyph">@</span><a href="CmmNode.html#CmmCall"><span class="hs-identifier hs-var">CmmCall</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">cml_target</span><span class="hs-glyph">=</span><a name="local-6989586621680027785"><a href="#local-6989586621680027785"><span class="hs-identifier">tgt</span></a></a><span class="hs-special">}</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027784"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">{</span><span class="hs-identifier">cml_target</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027783"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027785"><span class="hs-identifier hs-var">tgt</span></a><span class="hs-special">}</span><span>
</span><a name="line-478"></a><span class="hs-identifier">mapExp</span><span> </span><a name="local-6989586621680027786"><a href="#local-6989586621680027786"><span class="hs-identifier">f</span></a></a><span>   </span><span class="hs-special">(</span><a href="CmmNode.html#CmmForeignCall"><span class="hs-identifier hs-var">CmmForeignCall</span></a><span> </span><a name="local-6989586621680027787"><a href="#local-6989586621680027787"><span class="hs-identifier">tgt</span></a></a><span> </span><a name="local-6989586621680027788"><a href="#local-6989586621680027788"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-keyword">as</span><span> </span><a name="local-6989586621680027790"><a href="#local-6989586621680027790"><span class="hs-identifier">succ</span></a></a><span> </span><a name="local-6989586621680027791"><a href="#local-6989586621680027791"><span class="hs-identifier">ret_args</span></a></a><span> </span><a name="local-6989586621680027792"><a href="#local-6989586621680027792"><span class="hs-identifier">updfr</span></a></a><span> </span><a name="local-6989586621680027793"><a href="#local-6989586621680027793"><span class="hs-identifier">intrbl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#CmmForeignCall"><span class="hs-identifier hs-var">CmmForeignCall</span></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#mapForeignTarget"><span class="hs-identifier hs-var">mapForeignTarget</span></a><span> </span><a href="#local-6989586621680027786"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027787"><span class="hs-identifier hs-var">tgt</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680027788"><span class="hs-identifier hs-var">fs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621680027786"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680027790"><span class="hs-identifier hs-var">succ</span></a><span> </span><a href="#local-6989586621680027791"><span class="hs-identifier hs-var">ret_args</span></a><span> </span><a href="#local-6989586621680027792"><span class="hs-identifier hs-var">updfr</span></a><span> </span><a href="#local-6989586621680027793"><span class="hs-identifier hs-var">intrbl</span></a><span>
</span><a name="line-479"></a><span>
</span><a name="line-480"></a><span class="hs-identifier">mapExpDeep</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="#local-6989586621680027737"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621680027738"><span class="hs-identifier hs-type">x</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="#local-6989586621680027737"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621680027738"><span class="hs-identifier hs-type">x</span></a><span>
</span><a name="line-481"></a><a name="mapExpDeep"><a href="CmmNode.html#mapExpDeep"><span class="hs-identifier">mapExpDeep</span></a></a><span> </span><a name="local-6989586621680027794"><a href="#local-6989586621680027794"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#mapExp"><span class="hs-identifier hs-var">mapExp</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmNode.html#wrapRecExp"><span class="hs-identifier hs-var">wrapRecExp</span></a><span> </span><a href="#local-6989586621680027794"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-482"></a><span>
</span><a name="line-483"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-484"></a><span class="hs-comment">-- mapping Expr in CmmNode, but not performing allocation if no changes</span><span>
</span><a name="line-485"></a><span>
</span><a name="line-486"></a><span class="hs-identifier">mapForeignTargetM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-type">ForeignTarget</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-type">ForeignTarget</span></a><span>
</span><a name="line-487"></a><a name="mapForeignTargetM"><a href="CmmNode.html#mapForeignTargetM"><span class="hs-identifier">mapForeignTargetM</span></a></a><span> </span><a name="local-6989586621680027795"><a href="#local-6989586621680027795"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-var">ForeignTarget</span></a><span> </span><a name="local-6989586621680027796"><a href="#local-6989586621680027796"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621680027797"><a href="#local-6989586621680027797"><span class="hs-identifier">c</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680027798"><a href="#local-6989586621680027798"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-var">ForeignTarget</span></a><span> </span><a href="#local-6989586621680027798"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621680027797"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680027795"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027796"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-488"></a><span class="hs-identifier">mapForeignTargetM</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#PrimTarget"><span class="hs-identifier hs-var">PrimTarget</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-489"></a><span>
</span><a name="line-490"></a><span class="hs-identifier">wrapRecExpM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-491"></a><span class="hs-comment">-- (wrapRecExpM f e) first recursively applies itself to sub-expressions of e</span><span>
</span><a name="line-492"></a><span class="hs-comment">--                   then  gives f a chance to rewrite the resulting expression</span><span>
</span><a name="line-493"></a><a name="wrapRecExpM"><a href="CmmNode.html#wrapRecExpM"><span class="hs-identifier">wrapRecExpM</span></a></a><span> </span><a name="local-6989586621680027799"><a href="#local-6989586621680027799"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680027800"><a href="#local-6989586621680027800"><span class="hs-identifier">n</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CmmExpr.html#CmmMachOp"><span class="hs-identifier hs-var">CmmMachOp</span></a><span> </span><a name="local-6989586621680027801"><a href="#local-6989586621680027801"><span class="hs-identifier">op</span></a></a><span> </span><a name="local-6989586621680027802"><a href="#local-6989586621680027802"><span class="hs-identifier">es</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027799"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027800"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027799"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="CmmExpr.html#CmmMachOp"><span class="hs-identifier hs-var">CmmMachOp</span></a><span> </span><a href="#local-6989586621680027801"><span class="hs-identifier hs-var">op</span></a><span class="hs-special">)</span><span>    </span><span class="hs-special">(</span><a href="CmmNode.html#mapListM"><span class="hs-identifier hs-var">mapListM</span></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#wrapRecExpM"><span class="hs-identifier hs-var">wrapRecExpM</span></a><span> </span><a href="#local-6989586621680027799"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680027802"><span class="hs-identifier hs-var">es</span></a><span class="hs-special">)</span><span>
</span><a name="line-494"></a><span class="hs-identifier">wrapRecExpM</span><span> </span><a name="local-6989586621680027803"><a href="#local-6989586621680027803"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680027804"><a href="#local-6989586621680027804"><span class="hs-identifier">n</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLoad"><span class="hs-identifier hs-var">CmmLoad</span></a><span> </span><a name="local-6989586621680027805"><a href="#local-6989586621680027805"><span class="hs-identifier">addr</span></a></a><span> </span><a name="local-6989586621680027806"><a href="#local-6989586621680027806"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027803"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027804"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027803"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><a href="CmmExpr.html#CmmLoad"><span class="hs-identifier hs-var">CmmLoad</span></a><span> </span><a href="#local-6989586621680027806"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#wrapRecExpM"><span class="hs-identifier hs-var">wrapRecExpM</span></a><span> </span><a href="#local-6989586621680027803"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027805"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">)</span><span>
</span><a name="line-495"></a><span class="hs-identifier">wrapRecExpM</span><span> </span><a name="local-6989586621680027807"><a href="#local-6989586621680027807"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680027808"><a href="#local-6989586621680027808"><span class="hs-identifier">e</span></a></a><span>                    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027807"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027808"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-496"></a><span>
</span><a name="line-497"></a><span class="hs-identifier">mapExpM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="#local-6989586621680027735"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621680027736"><span class="hs-identifier hs-type">x</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="#local-6989586621680027735"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621680027736"><span class="hs-identifier hs-type">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-498"></a><a name="mapExpM"><a href="CmmNode.html#mapExpM"><span class="hs-identifier">mapExpM</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmEntry"><span class="hs-identifier hs-var">CmmEntry</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-499"></a><span class="hs-identifier">mapExpM</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmComment"><span class="hs-identifier hs-var">CmmComment</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-500"></a><span class="hs-identifier">mapExpM</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmTick"><span class="hs-identifier hs-var">CmmTick</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-501"></a><span class="hs-identifier">mapExpM</span><span> </span><a name="local-6989586621680027809"><a href="#local-6989586621680027809"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmUnwind"><span class="hs-identifier hs-var">CmmUnwind</span></a><span> </span><a name="local-6989586621680027810"><a href="#local-6989586621680027810"><span class="hs-identifier">regs</span></a></a><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#CmmUnwind"><span class="hs-identifier hs-var">CmmUnwind</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621680027811"><a href="#local-6989586621680027811"><span class="hs-identifier">r</span></a></a><span class="hs-special">,</span><a name="local-6989586621680027812"><a href="#local-6989586621680027812"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621680027809"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027812"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680027813"><a href="#local-6989586621680027813"><span class="hs-identifier">e'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027811"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">,</span><a href="#local-6989586621680027813"><span class="hs-identifier hs-var">e'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680027810"><span class="hs-identifier hs-var">regs</span></a><span>
</span><a name="line-502"></a><span class="hs-identifier">mapExpM</span><span> </span><a name="local-6989586621680027814"><a href="#local-6989586621680027814"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmAssign"><span class="hs-identifier hs-var">CmmAssign</span></a><span> </span><a name="local-6989586621680027815"><a href="#local-6989586621680027815"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621680027816"><a href="#local-6989586621680027816"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#CmmAssign"><span class="hs-identifier hs-var">CmmAssign</span></a><span> </span><a href="#local-6989586621680027815"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680027814"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027816"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-503"></a><span class="hs-identifier">mapExpM</span><span> </span><a name="local-6989586621680027817"><a href="#local-6989586621680027817"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmStore"><span class="hs-identifier hs-var">CmmStore</span></a><span> </span><a name="local-6989586621680027818"><a href="#local-6989586621680027818"><span class="hs-identifier">addr</span></a></a><span> </span><a name="local-6989586621680027819"><a href="#local-6989586621680027819"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">[</span><a name="local-6989586621680027820"><a href="#local-6989586621680027820"><span class="hs-identifier">addr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680027821"><a href="#local-6989586621680027821"><span class="hs-identifier">e'</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmStore"><span class="hs-identifier hs-var">CmmStore</span></a><span> </span><a href="#local-6989586621680027820"><span class="hs-identifier hs-var">addr'</span></a><span> </span><a href="#local-6989586621680027821"><span class="hs-identifier hs-var">e'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><a href="CmmNode.html#mapListM"><span class="hs-identifier hs-var">mapListM</span></a><span> </span><a href="#local-6989586621680027817"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621680027818"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680027819"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">]</span><span>
</span><a name="line-504"></a><span class="hs-identifier">mapExpM</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmBranch"><span class="hs-identifier hs-var">CmmBranch</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-505"></a><span class="hs-identifier">mapExpM</span><span> </span><a name="local-6989586621680027822"><a href="#local-6989586621680027822"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmCondBranch"><span class="hs-identifier hs-var">CmmCondBranch</span></a><span> </span><a name="local-6989586621680027823"><a href="#local-6989586621680027823"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621680027824"><a href="#local-6989586621680027824"><span class="hs-identifier">ti</span></a></a><span> </span><a name="local-6989586621680027825"><a href="#local-6989586621680027825"><span class="hs-identifier">fi</span></a></a><span> </span><a name="local-6989586621680027826"><a href="#local-6989586621680027826"><span class="hs-identifier">l</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680027827"><a href="#local-6989586621680027827"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmCondBranch"><span class="hs-identifier hs-var">CmmCondBranch</span></a><span> </span><a href="#local-6989586621680027827"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621680027824"><span class="hs-identifier hs-var">ti</span></a><span> </span><a href="#local-6989586621680027825"><span class="hs-identifier hs-var">fi</span></a><span> </span><a href="#local-6989586621680027826"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680027822"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027823"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-506"></a><span class="hs-identifier">mapExpM</span><span> </span><a name="local-6989586621680027828"><a href="#local-6989586621680027828"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmSwitch"><span class="hs-identifier hs-var">CmmSwitch</span></a><span> </span><a name="local-6989586621680027829"><a href="#local-6989586621680027829"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621680027830"><a href="#local-6989586621680027830"><span class="hs-identifier">tbl</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680027831"><a href="#local-6989586621680027831"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmSwitch"><span class="hs-identifier hs-var">CmmSwitch</span></a><span> </span><a href="#local-6989586621680027831"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621680027830"><span class="hs-identifier hs-var">tbl</span></a><span class="hs-special">)</span><span>       </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680027828"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027829"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-507"></a><span class="hs-identifier">mapExpM</span><span> </span><a name="local-6989586621680027832"><a href="#local-6989586621680027832"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmCall"><span class="hs-identifier hs-var">CmmCall</span></a><span> </span><a name="local-6989586621680027833"><a href="#local-6989586621680027833"><span class="hs-identifier">tgt</span></a></a><span> </span><a name="local-6989586621680027834"><a href="#local-6989586621680027834"><span class="hs-identifier">mb_id</span></a></a><span> </span><a name="local-6989586621680027835"><a href="#local-6989586621680027835"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621680027836"><a href="#local-6989586621680027836"><span class="hs-identifier">o</span></a></a><span> </span><a name="local-6989586621680027837"><a href="#local-6989586621680027837"><span class="hs-identifier">i</span></a></a><span> </span><a name="local-6989586621680027838"><a href="#local-6989586621680027838"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680027839"><a href="#local-6989586621680027839"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmCall"><span class="hs-identifier hs-var">CmmCall</span></a><span> </span><a href="#local-6989586621680027839"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621680027834"><span class="hs-identifier hs-var">mb_id</span></a><span> </span><a href="#local-6989586621680027835"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621680027836"><span class="hs-identifier hs-var">o</span></a><span> </span><a href="#local-6989586621680027837"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621680027838"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680027832"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027833"><span class="hs-identifier hs-var">tgt</span></a><span>
</span><a name="line-508"></a><span class="hs-identifier">mapExpM</span><span> </span><a name="local-6989586621680027840"><a href="#local-6989586621680027840"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmUnsafeForeignCall"><span class="hs-identifier hs-var">CmmUnsafeForeignCall</span></a><span> </span><a name="local-6989586621680027841"><a href="#local-6989586621680027841"><span class="hs-identifier">tgt</span></a></a><span> </span><a name="local-6989586621680027842"><a href="#local-6989586621680027842"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-509"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="CmmNode.html#mapForeignTargetM"><span class="hs-identifier hs-var">mapForeignTargetM</span></a><span> </span><a href="#local-6989586621680027840"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027841"><span class="hs-identifier hs-var">tgt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-510"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680027844"><a href="#local-6989586621680027844"><span class="hs-identifier">tgt'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmUnsafeForeignCall"><span class="hs-identifier hs-var">CmmUnsafeForeignCall</span></a><span> </span><a href="#local-6989586621680027844"><span class="hs-identifier hs-var">tgt'</span></a><span> </span><a href="#local-6989586621680027842"><span class="hs-identifier hs-var">fs</span></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#mapListJ"><span class="hs-identifier hs-var">mapListJ</span></a><span> </span><a href="#local-6989586621680027840"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-511"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680027845"><a href="#local-6989586621680027845"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmUnsafeForeignCall"><span class="hs-identifier hs-var">CmmUnsafeForeignCall</span></a><span> </span><a href="#local-6989586621680027841"><span class="hs-identifier hs-var">tgt</span></a><span> </span><a href="#local-6989586621680027842"><span class="hs-identifier hs-var">fs</span></a><span> </span><a href="#local-6989586621680027845"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><a href="CmmNode.html#mapListM"><span class="hs-identifier hs-var">mapListM</span></a><span> </span><a href="#local-6989586621680027840"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-512"></a><span class="hs-identifier">mapExpM</span><span> </span><a name="local-6989586621680027846"><a href="#local-6989586621680027846"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmForeignCall"><span class="hs-identifier hs-var">CmmForeignCall</span></a><span> </span><a name="local-6989586621680027847"><a href="#local-6989586621680027847"><span class="hs-identifier">tgt</span></a></a><span> </span><a name="local-6989586621680027848"><a href="#local-6989586621680027848"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-keyword">as</span><span> </span><a name="local-6989586621680027850"><a href="#local-6989586621680027850"><span class="hs-identifier">succ</span></a></a><span> </span><a name="local-6989586621680027851"><a href="#local-6989586621680027851"><span class="hs-identifier">ret_args</span></a></a><span> </span><a name="local-6989586621680027852"><a href="#local-6989586621680027852"><span class="hs-identifier">updfr</span></a></a><span> </span><a name="local-6989586621680027853"><a href="#local-6989586621680027853"><span class="hs-identifier">intrbl</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-513"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="CmmNode.html#mapForeignTargetM"><span class="hs-identifier hs-var">mapForeignTargetM</span></a><span> </span><a href="#local-6989586621680027846"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027847"><span class="hs-identifier hs-var">tgt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-514"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680027854"><a href="#local-6989586621680027854"><span class="hs-identifier">tgt'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmForeignCall"><span class="hs-identifier hs-var">CmmForeignCall</span></a><span> </span><a href="#local-6989586621680027854"><span class="hs-identifier hs-var">tgt'</span></a><span> </span><a href="#local-6989586621680027848"><span class="hs-identifier hs-var">fs</span></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#mapListJ"><span class="hs-identifier hs-var">mapListJ</span></a><span> </span><a href="#local-6989586621680027846"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680027850"><span class="hs-identifier hs-var">succ</span></a><span> </span><a href="#local-6989586621680027851"><span class="hs-identifier hs-var">ret_args</span></a><span> </span><a href="#local-6989586621680027852"><span class="hs-identifier hs-var">updfr</span></a><span> </span><a href="#local-6989586621680027853"><span class="hs-identifier hs-var">intrbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-515"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680027855"><a href="#local-6989586621680027855"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmForeignCall"><span class="hs-identifier hs-var">CmmForeignCall</span></a><span> </span><a href="#local-6989586621680027847"><span class="hs-identifier hs-var">tgt</span></a><span> </span><a href="#local-6989586621680027848"><span class="hs-identifier hs-var">fs</span></a><span> </span><a href="#local-6989586621680027855"><span class="hs-identifier hs-var">xs</span></a><span> </span><a href="#local-6989586621680027850"><span class="hs-identifier hs-var">succ</span></a><span> </span><a href="#local-6989586621680027851"><span class="hs-identifier hs-var">ret_args</span></a><span> </span><a href="#local-6989586621680027852"><span class="hs-identifier hs-var">updfr</span></a><span> </span><a href="#local-6989586621680027853"><span class="hs-identifier hs-var">intrbl</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><a href="CmmNode.html#mapListM"><span class="hs-identifier hs-var">mapListM</span></a><span> </span><a href="#local-6989586621680027846"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-516"></a><span>
</span><a name="line-517"></a><span class="hs-comment">-- share as much as possible</span><span>
</span><a name="line-518"></a><span class="hs-identifier">mapListM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027734"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621680027734"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680027734"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680027734"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-519"></a><a name="mapListM"><a href="CmmNode.html#mapListM"><span class="hs-identifier">mapListM</span></a></a><span> </span><a name="local-6989586621680027856"><a href="#local-6989586621680027856"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680027857"><a href="#local-6989586621680027857"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680027858"><a href="#local-6989586621680027858"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680027859"><a href="#local-6989586621680027859"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#mapListT"><span class="hs-identifier hs-var">mapListT</span></a><span> </span><a href="#local-6989586621680027856"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027857"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-520"></a><span>                </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621680027858"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680027859"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-521"></a><span>
</span><a name="line-522"></a><span class="hs-identifier">mapListJ</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027733"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621680027733"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680027733"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680027733"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-523"></a><a name="mapListJ"><a href="CmmNode.html#mapListJ"><span class="hs-identifier">mapListJ</span></a></a><span> </span><a name="local-6989586621680027860"><a href="#local-6989586621680027860"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680027861"><a href="#local-6989586621680027861"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#mapListT"><span class="hs-identifier hs-var">mapListT</span></a><span> </span><a href="#local-6989586621680027860"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027861"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-524"></a><span>
</span><a name="line-525"></a><span class="hs-identifier">mapListT</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027732"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621680027732"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680027732"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680027732"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-526"></a><a name="mapListT"><a href="CmmNode.html#mapListT"><span class="hs-identifier">mapListT</span></a></a><span> </span><a name="local-6989586621680027862"><a href="#local-6989586621680027862"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680027863"><a href="#local-6989586621680027863"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621680027864"><span class="hs-identifier hs-var">g</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip3</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tails</span><span> </span><a href="#local-6989586621680027863"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680027863"><span class="hs-identifier hs-var">xs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621680027862"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027863"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-527"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621680027864"><a href="#local-6989586621680027864"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span>   </span><a name="local-6989586621680027865"><a href="#local-6989586621680027865"><span class="hs-identifier">y</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680027866"><a href="#local-6989586621680027866"><span class="hs-identifier">ys</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span>  </span><a href="#local-6989586621680027865"><span class="hs-identifier hs-var">y</span></a><span class="hs-glyph">:</span><a href="#local-6989586621680027866"><span class="hs-identifier hs-var">ys</span></a><span class="hs-special">)</span><span>
</span><a name="line-528"></a><span>          </span><span class="hs-identifier">g</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span>   </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680027867"><a href="#local-6989586621680027867"><span class="hs-identifier">y</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680027868"><a href="#local-6989586621680027868"><span class="hs-identifier">ys</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span>  </span><a href="#local-6989586621680027867"><span class="hs-identifier hs-var">y</span></a><span class="hs-glyph">:</span><a href="#local-6989586621680027868"><span class="hs-identifier hs-var">ys</span></a><span class="hs-special">)</span><span>
</span><a name="line-529"></a><span>          </span><span class="hs-identifier">g</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680027869"><a href="#local-6989586621680027869"><span class="hs-identifier">ys'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680027869"><span class="hs-identifier hs-var">ys'</span></a><span class="hs-special">)</span><span>
</span><a name="line-530"></a><span>          </span><span class="hs-identifier">g</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span>   </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680027870"><a href="#local-6989586621680027870"><span class="hs-identifier">y</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680027871"><a href="#local-6989586621680027871"><span class="hs-identifier">ys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span>  </span><a href="#local-6989586621680027870"><span class="hs-identifier hs-var">y</span></a><span class="hs-glyph">:</span><a href="#local-6989586621680027871"><span class="hs-identifier hs-var">ys</span></a><span class="hs-special">)</span><span>
</span><a name="line-531"></a><span>
</span><a name="line-532"></a><span class="hs-identifier">mapExpDeepM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="#local-6989586621680027730"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621680027731"><span class="hs-identifier hs-type">x</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="#local-6989586621680027730"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621680027731"><span class="hs-identifier hs-type">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-533"></a><a name="mapExpDeepM"><a href="CmmNode.html#mapExpDeepM"><span class="hs-identifier">mapExpDeepM</span></a></a><span> </span><a name="local-6989586621680027872"><a href="#local-6989586621680027872"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#mapExpM"><span class="hs-identifier hs-var">mapExpM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmNode.html#wrapRecExpM"><span class="hs-identifier hs-var">wrapRecExpM</span></a><span> </span><a href="#local-6989586621680027872"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-534"></a><span>
</span><a name="line-535"></a><span class="hs-comment">-----------------------------------</span><span>
</span><a name="line-536"></a><span class="hs-comment">-- folding Expr in CmmNode</span><span>
</span><a name="line-537"></a><span>
</span><a name="line-538"></a><span class="hs-identifier">foldExpForeignTarget</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027729"><span class="hs-identifier hs-type">z</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027729"><span class="hs-identifier hs-type">z</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-type">ForeignTarget</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027729"><span class="hs-identifier hs-type">z</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027729"><span class="hs-identifier hs-type">z</span></a><span>
</span><a name="line-539"></a><a name="foldExpForeignTarget"><a href="CmmNode.html#foldExpForeignTarget"><span class="hs-identifier">foldExpForeignTarget</span></a></a><span> </span><a name="local-6989586621680027873"><a href="#local-6989586621680027873"><span class="hs-identifier">exp</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-var">ForeignTarget</span></a><span> </span><a name="local-6989586621680027874"><a href="#local-6989586621680027874"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680027875"><a href="#local-6989586621680027875"><span class="hs-identifier">z</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027873"><span class="hs-identifier hs-var">exp</span></a><span> </span><a href="#local-6989586621680027874"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621680027875"><span class="hs-identifier hs-var">z</span></a><span>
</span><a name="line-540"></a><span class="hs-identifier">foldExpForeignTarget</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-special">(</span><a href="CmmNode.html#PrimTarget"><span class="hs-identifier hs-var">PrimTarget</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>      </span><a name="local-6989586621680027876"><a href="#local-6989586621680027876"><span class="hs-identifier">z</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027876"><span class="hs-identifier hs-var">z</span></a><span>
</span><a name="line-541"></a><span>
</span><a name="line-542"></a><span class="hs-comment">-- Take a folder on expressions and apply it recursively.</span><span>
</span><a name="line-543"></a><span class="hs-comment">-- Specifically (wrapRecExpf f e z) deals with CmmMachOp and CmmLoad</span><span>
</span><a name="line-544"></a><span class="hs-comment">-- itself, delegating all the other CmmExpr forms to 'f'.</span><span>
</span><a name="line-545"></a><span class="hs-identifier">wrapRecExpf</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027728"><span class="hs-identifier hs-type">z</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027728"><span class="hs-identifier hs-type">z</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027728"><span class="hs-identifier hs-type">z</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027728"><span class="hs-identifier hs-type">z</span></a><span>
</span><a name="line-546"></a><a name="wrapRecExpf"><a href="CmmNode.html#wrapRecExpf"><span class="hs-identifier">wrapRecExpf</span></a></a><span> </span><a name="local-6989586621680027877"><a href="#local-6989586621680027877"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680027878"><a href="#local-6989586621680027878"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CmmExpr.html#CmmMachOp"><span class="hs-identifier hs-var">CmmMachOp</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680027879"><a href="#local-6989586621680027879"><span class="hs-identifier">es</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680027880"><a href="#local-6989586621680027880"><span class="hs-identifier">z</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#wrapRecExpf"><span class="hs-identifier hs-var">wrapRecExpf</span></a><span> </span><a href="#local-6989586621680027877"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027877"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027878"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621680027880"><span class="hs-identifier hs-var">z</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680027879"><span class="hs-identifier hs-var">es</span></a><span>
</span><a name="line-547"></a><span class="hs-identifier">wrapRecExpf</span><span> </span><a name="local-6989586621680027881"><a href="#local-6989586621680027881"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680027882"><a href="#local-6989586621680027882"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLoad"><span class="hs-identifier hs-var">CmmLoad</span></a><span> </span><a name="local-6989586621680027883"><a href="#local-6989586621680027883"><span class="hs-identifier">addr</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680027884"><a href="#local-6989586621680027884"><span class="hs-identifier">z</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#wrapRecExpf"><span class="hs-identifier hs-var">wrapRecExpf</span></a><span> </span><a href="#local-6989586621680027881"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027883"><span class="hs-identifier hs-var">addr</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027881"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027882"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621680027884"><span class="hs-identifier hs-var">z</span></a><span class="hs-special">)</span><span>
</span><a name="line-548"></a><span class="hs-identifier">wrapRecExpf</span><span> </span><a name="local-6989586621680027885"><a href="#local-6989586621680027885"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680027886"><a href="#local-6989586621680027886"><span class="hs-identifier">e</span></a></a><span>                  </span><a name="local-6989586621680027887"><a href="#local-6989586621680027887"><span class="hs-identifier">z</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027885"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027886"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621680027887"><span class="hs-identifier hs-var">z</span></a><span>
</span><a name="line-549"></a><span>
</span><a name="line-550"></a><span class="hs-identifier">foldExp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027725"><span class="hs-identifier hs-type">z</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027725"><span class="hs-identifier hs-type">z</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="#local-6989586621680027726"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621680027727"><span class="hs-identifier hs-type">x</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027725"><span class="hs-identifier hs-type">z</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027725"><span class="hs-identifier hs-type">z</span></a><span>
</span><a name="line-551"></a><a name="foldExp"><a href="CmmNode.html#foldExp"><span class="hs-identifier">foldExp</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmEntry"><span class="hs-identifier hs-var">CmmEntry</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680027888"><a href="#local-6989586621680027888"><span class="hs-identifier">z</span></a></a><span>                         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027888"><span class="hs-identifier hs-var">z</span></a><span>
</span><a name="line-552"></a><span class="hs-identifier">foldExp</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmComment"><span class="hs-identifier hs-var">CmmComment</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680027889"><a href="#local-6989586621680027889"><span class="hs-identifier">z</span></a></a><span>                       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027889"><span class="hs-identifier hs-var">z</span></a><span>
</span><a name="line-553"></a><span class="hs-identifier">foldExp</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmTick"><span class="hs-identifier hs-var">CmmTick</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680027890"><a href="#local-6989586621680027890"><span class="hs-identifier">z</span></a></a><span>                          </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027890"><span class="hs-identifier hs-var">z</span></a><span>
</span><a name="line-554"></a><span class="hs-identifier">foldExp</span><span> </span><a name="local-6989586621680027891"><a href="#local-6989586621680027891"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmUnwind"><span class="hs-identifier hs-var">CmmUnwind</span></a><span> </span><a name="local-6989586621680027892"><a href="#local-6989586621680027892"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680027893"><a href="#local-6989586621680027893"><span class="hs-identifier">z</span></a></a><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><a href="#local-6989586621680027891"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680027893"><span class="hs-identifier hs-var">z</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621680027892"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-555"></a><span class="hs-identifier">foldExp</span><span> </span><a name="local-6989586621680027894"><a href="#local-6989586621680027894"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmAssign"><span class="hs-identifier hs-var">CmmAssign</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680027895"><a href="#local-6989586621680027895"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680027896"><a href="#local-6989586621680027896"><span class="hs-identifier">z</span></a></a><span>                       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027894"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027895"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621680027896"><span class="hs-identifier hs-var">z</span></a><span>
</span><a name="line-556"></a><span class="hs-identifier">foldExp</span><span> </span><a name="local-6989586621680027897"><a href="#local-6989586621680027897"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmStore"><span class="hs-identifier hs-var">CmmStore</span></a><span> </span><a name="local-6989586621680027898"><a href="#local-6989586621680027898"><span class="hs-identifier">addr</span></a></a><span> </span><a name="local-6989586621680027899"><a href="#local-6989586621680027899"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680027900"><a href="#local-6989586621680027900"><span class="hs-identifier">z</span></a></a><span>                     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027897"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027898"><span class="hs-identifier hs-var">addr</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621680027897"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027899"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621680027900"><span class="hs-identifier hs-var">z</span></a><span>
</span><a name="line-557"></a><span class="hs-identifier">foldExp</span><span> </span><a name="local-6989586621680027901"><a href="#local-6989586621680027901"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmUnsafeForeignCall"><span class="hs-identifier hs-var">CmmUnsafeForeignCall</span></a><span> </span><a name="local-6989586621680027902"><a href="#local-6989586621680027902"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680027904"><a href="#local-6989586621680027904"><span class="hs-identifier">z</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621680027901"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#foldExpForeignTarget"><span class="hs-identifier hs-var">foldExpForeignTarget</span></a><span> </span><a href="#local-6989586621680027901"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027902"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621680027904"><span class="hs-identifier hs-var">z</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-558"></a><span class="hs-identifier">foldExp</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmBranch"><span class="hs-identifier hs-var">CmmBranch</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680027905"><a href="#local-6989586621680027905"><span class="hs-identifier">z</span></a></a><span>                         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027905"><span class="hs-identifier hs-var">z</span></a><span>
</span><a name="line-559"></a><span class="hs-identifier">foldExp</span><span> </span><a name="local-6989586621680027906"><a href="#local-6989586621680027906"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmCondBranch"><span class="hs-identifier hs-var">CmmCondBranch</span></a><span> </span><a name="local-6989586621680027907"><a href="#local-6989586621680027907"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680027908"><a href="#local-6989586621680027908"><span class="hs-identifier">z</span></a></a><span>               </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027906"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027907"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621680027908"><span class="hs-identifier hs-var">z</span></a><span>
</span><a name="line-560"></a><span class="hs-identifier">foldExp</span><span> </span><a name="local-6989586621680027909"><a href="#local-6989586621680027909"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmSwitch"><span class="hs-identifier hs-var">CmmSwitch</span></a><span> </span><a name="local-6989586621680027910"><a href="#local-6989586621680027910"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680027911"><a href="#local-6989586621680027911"><span class="hs-identifier">z</span></a></a><span>                       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027909"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027910"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621680027911"><span class="hs-identifier hs-var">z</span></a><span>
</span><a name="line-561"></a><span class="hs-identifier">foldExp</span><span> </span><a name="local-6989586621680027912"><a href="#local-6989586621680027912"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmCall"><span class="hs-identifier hs-var">CmmCall</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">cml_target</span><span class="hs-glyph">=</span><a name="local-6989586621680027913"><a href="#local-6989586621680027913"><span class="hs-identifier">tgt</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680027914"><a href="#local-6989586621680027914"><span class="hs-identifier">z</span></a></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027912"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027913"><span class="hs-identifier hs-var">tgt</span></a><span> </span><a href="#local-6989586621680027914"><span class="hs-identifier hs-var">z</span></a><span>
</span><a name="line-562"></a><span class="hs-identifier">foldExp</span><span> </span><a name="local-6989586621680027915"><a href="#local-6989586621680027915"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmForeignCall"><span class="hs-identifier hs-var">CmmForeignCall</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">tgt</span><span class="hs-glyph">=</span><a name="local-6989586621680027916"><a href="#local-6989586621680027916"><span class="hs-identifier">tgt</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">args</span><span class="hs-glyph">=</span><a name="local-6989586621680027917"><a href="#local-6989586621680027917"><span class="hs-identifier">args</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680027918"><a href="#local-6989586621680027918"><span class="hs-identifier">z</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621680027915"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#foldExpForeignTarget"><span class="hs-identifier hs-var">foldExpForeignTarget</span></a><span> </span><a href="#local-6989586621680027915"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027916"><span class="hs-identifier hs-var">tgt</span></a><span> </span><a href="#local-6989586621680027918"><span class="hs-identifier hs-var">z</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680027917"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-563"></a><span>
</span><a name="line-564"></a><span class="hs-identifier">foldExpDeep</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027722"><span class="hs-identifier hs-type">z</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027722"><span class="hs-identifier hs-type">z</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="#local-6989586621680027723"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621680027724"><span class="hs-identifier hs-type">x</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027722"><span class="hs-identifier hs-type">z</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680027722"><span class="hs-identifier hs-type">z</span></a><span>
</span><a name="line-565"></a><a name="foldExpDeep"><a href="CmmNode.html#foldExpDeep"><span class="hs-identifier">foldExpDeep</span></a></a><span> </span><a name="local-6989586621680027919"><a href="#local-6989586621680027919"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#foldExp"><span class="hs-identifier hs-var">foldExp</span></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#wrapRecExpf"><span class="hs-identifier hs-var">wrapRecExpf</span></a><span> </span><a href="#local-6989586621680027919"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-566"></a><span>
</span><a name="line-567"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-568"></a><span>
</span><a name="line-569"></a><span class="hs-identifier">mapSuccessors</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#C"><span class="hs-identifier hs-type">C</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#C"><span class="hs-identifier hs-type">C</span></a><span>
</span><a name="line-570"></a><a name="mapSuccessors"><a href="CmmNode.html#mapSuccessors"><span class="hs-identifier">mapSuccessors</span></a></a><span> </span><a name="local-6989586621680027920"><a href="#local-6989586621680027920"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmBranch"><span class="hs-identifier hs-var">CmmBranch</span></a><span> </span><a name="local-6989586621680027921"><a href="#local-6989586621680027921"><span class="hs-identifier">bid</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#CmmBranch"><span class="hs-identifier hs-var">CmmBranch</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027920"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027921"><span class="hs-identifier hs-var">bid</span></a><span class="hs-special">)</span><span>
</span><a name="line-571"></a><span class="hs-identifier">mapSuccessors</span><span> </span><a name="local-6989586621680027922"><a href="#local-6989586621680027922"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmCondBranch"><span class="hs-identifier hs-var">CmmCondBranch</span></a><span> </span><a name="local-6989586621680027923"><a href="#local-6989586621680027923"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621680027924"><a href="#local-6989586621680027924"><span class="hs-identifier">y</span></a></a><span> </span><a name="local-6989586621680027925"><a href="#local-6989586621680027925"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621680027926"><a href="#local-6989586621680027926"><span class="hs-identifier">l</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#CmmCondBranch"><span class="hs-identifier hs-var">CmmCondBranch</span></a><span> </span><a href="#local-6989586621680027923"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027922"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027924"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027922"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027925"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680027926"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-572"></a><span class="hs-identifier">mapSuccessors</span><span> </span><a name="local-6989586621680027927"><a href="#local-6989586621680027927"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmSwitch"><span class="hs-identifier hs-var">CmmSwitch</span></a><span> </span><a name="local-6989586621680027928"><a href="#local-6989586621680027928"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621680027929"><a href="#local-6989586621680027929"><span class="hs-identifier">ids</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#CmmSwitch"><span class="hs-identifier hs-var">CmmSwitch</span></a><span> </span><a href="#local-6989586621680027928"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">(</span><a href="CmmSwitch.html#mapSwitchTargets"><span class="hs-identifier hs-var">mapSwitchTargets</span></a><span> </span><a href="#local-6989586621680027927"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027929"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">)</span><span>
</span><a name="line-573"></a><span class="hs-identifier">mapSuccessors</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680027930"><a href="#local-6989586621680027930"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027930"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-574"></a><span>
</span><a name="line-575"></a><span class="hs-identifier">mapCollectSuccessors</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621680027721"><a href="#local-6989586621680027721"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span class="hs-special">,</span><a href="#local-6989586621680027721"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#C"><span class="hs-identifier hs-type">C</span></a><span>
</span><a name="line-576"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#C"><span class="hs-identifier hs-type">C</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680027721"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-577"></a><a name="mapCollectSuccessors"><a href="CmmNode.html#mapCollectSuccessors"><span class="hs-identifier">mapCollectSuccessors</span></a></a><span> </span><a name="local-6989586621680027931"><a href="#local-6989586621680027931"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmBranch"><span class="hs-identifier hs-var">CmmBranch</span></a><span> </span><a name="local-6989586621680027932"><a href="#local-6989586621680027932"><span class="hs-identifier">bid</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-578"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680027933"><a href="#local-6989586621680027933"><span class="hs-identifier">bid'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680027934"><a href="#local-6989586621680027934"><span class="hs-identifier">acc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027931"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027932"><span class="hs-identifier hs-var">bid</span></a><span> </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmBranch"><span class="hs-identifier hs-var">CmmBranch</span></a><span> </span><a href="#local-6989586621680027933"><span class="hs-identifier hs-var">bid'</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680027934"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-579"></a><span class="hs-identifier">mapCollectSuccessors</span><span> </span><a name="local-6989586621680027935"><a href="#local-6989586621680027935"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmCondBranch"><span class="hs-identifier hs-var">CmmCondBranch</span></a><span> </span><a name="local-6989586621680027936"><a href="#local-6989586621680027936"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621680027937"><a href="#local-6989586621680027937"><span class="hs-identifier">y</span></a></a><span> </span><a name="local-6989586621680027938"><a href="#local-6989586621680027938"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621680027939"><a href="#local-6989586621680027939"><span class="hs-identifier">l</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-580"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680027940"><a href="#local-6989586621680027940"><span class="hs-identifier">bidt</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680027941"><a href="#local-6989586621680027941"><span class="hs-identifier">acct</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027935"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027937"><span class="hs-identifier hs-var">y</span></a><span>
</span><a name="line-581"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621680027942"><a href="#local-6989586621680027942"><span class="hs-identifier">bidf</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680027943"><a href="#local-6989586621680027943"><span class="hs-identifier">accf</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027935"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027938"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-582"></a><span>    </span><span class="hs-keyword">in</span><span>  </span><span class="hs-special">(</span><a href="CmmNode.html#CmmCondBranch"><span class="hs-identifier hs-var">CmmCondBranch</span></a><span> </span><a href="#local-6989586621680027936"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621680027940"><span class="hs-identifier hs-var">bidt</span></a><span> </span><a href="#local-6989586621680027942"><span class="hs-identifier hs-var">bidf</span></a><span> </span><a href="#local-6989586621680027939"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680027943"><span class="hs-identifier hs-var">accf</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680027941"><span class="hs-identifier hs-var">acct</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-583"></a><span class="hs-identifier">mapCollectSuccessors</span><span> </span><a name="local-6989586621680027944"><a href="#local-6989586621680027944"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmSwitch"><span class="hs-identifier hs-var">CmmSwitch</span></a><span> </span><a name="local-6989586621680027945"><a href="#local-6989586621680027945"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621680027946"><a href="#local-6989586621680027946"><span class="hs-identifier">ids</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-584"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680027947"><a href="#local-6989586621680027947"><span class="hs-identifier">lbls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmSwitch.html#switchTargetsToList"><span class="hs-identifier hs-var">switchTargetsToList</span></a><span> </span><a href="#local-6989586621680027946"><span class="hs-identifier hs-var">ids</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span class="hs-special">]</span><span>
</span><a name="line-585"></a><span>        </span><a name="local-6989586621680027948"><a href="#local-6989586621680027948"><span class="hs-identifier">lblMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapFromList"><span class="hs-identifier hs-var">mapFromList</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621680027947"><span class="hs-identifier hs-var">lbls</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621680027944"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680027947"><span class="hs-identifier hs-var">lbls</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><span class="hs-special">(</span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680027721"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-586"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span> </span><a href="CmmNode.html#CmmSwitch"><span class="hs-identifier hs-var">CmmSwitch</span></a><span> </span><a href="#local-6989586621680027945"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-587"></a><span>          </span><span class="hs-special">(</span><a href="CmmSwitch.html#mapSwitchTargets"><span class="hs-identifier hs-var">mapSwitchTargets</span></a><span>
</span><a name="line-588"></a><span>            </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680027949"><a href="#local-6989586621680027949"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Hoopl.Collections.html#mapFindWithDefault"><span class="hs-identifier hs-var">mapFindWithDefault</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;impossible&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680027949"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621680027948"><span class="hs-identifier hs-var">lblMap</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680027946"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">)</span><span>
</span><a name="line-589"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#mapElems"><span class="hs-identifier hs-var">mapElems</span></a><span> </span><a href="#local-6989586621680027948"><span class="hs-identifier hs-var">lblMap</span></a><span class="hs-special">)</span><span>
</span><a name="line-590"></a><span>        </span><span class="hs-special">)</span><span>
</span><a name="line-591"></a><span class="hs-identifier">mapCollectSuccessors</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680027950"><a href="#local-6989586621680027950"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027950"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-592"></a><span>
</span><a name="line-593"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-594"></a><span>
</span><a name="line-595"></a><span class="hs-comment">-- | Tickish in Cmm context (annotations only)</span><span>
</span><a name="line-596"></a><span class="hs-keyword">type</span><span> </span><a name="CmmTickish"><a href="CmmNode.html#CmmTickish"><span class="hs-identifier">CmmTickish</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Tickish</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-597"></a><span>
</span><a name="line-598"></a><span class="hs-comment">-- | Tick scope identifier, allowing us to reason about what</span><span>
</span><a name="line-599"></a><span class="hs-comment">-- annotations in a Cmm block should scope over. We especially take</span><span>
</span><a name="line-600"></a><span class="hs-comment">-- care to allow optimisations to reorganise blocks without losing</span><span>
</span><a name="line-601"></a><span class="hs-comment">-- tick association in the process.</span><span>
</span><a name="line-602"></a><span class="hs-keyword">data</span><span> </span><a name="CmmTickScope"><a href="CmmNode.html#CmmTickScope"><span class="hs-identifier">CmmTickScope</span></a></a><span>
</span><a name="line-603"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="GlobalScope"><a href="CmmNode.html#GlobalScope"><span class="hs-identifier">GlobalScope</span></a></a><span>
</span><a name="line-604"></a><span>    </span><span class="hs-comment">-- ^ The global scope is the &quot;root&quot; of the scope graph. Every</span><span>
</span><a name="line-605"></a><span>    </span><span class="hs-comment">-- scope is a sub-scope of the global scope. It doesn't make sense</span><span>
</span><a name="line-606"></a><span>    </span><span class="hs-comment">-- to add ticks to this scope. On the other hand, this means that</span><span>
</span><a name="line-607"></a><span>    </span><span class="hs-comment">-- setting this scope on a block means no ticks apply to it.</span><span>
</span><a name="line-608"></a><span>
</span><a name="line-609"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="SubScope"><a href="CmmNode.html#SubScope"><span class="hs-identifier">SubScope</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">U.Unique</span><span> </span><a href="CmmNode.html#CmmTickScope"><span class="hs-identifier hs-type">CmmTickScope</span></a><span>
</span><a name="line-610"></a><span>    </span><span class="hs-comment">-- ^ Constructs a new sub-scope to an existing scope. This allows</span><span>
</span><a name="line-611"></a><span>    </span><span class="hs-comment">-- us to translate Core-style scoping rules (see @tickishScoped@)</span><span>
</span><a name="line-612"></a><span>    </span><span class="hs-comment">-- into the Cmm world. Suppose the following code:</span><span>
</span><a name="line-613"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-614"></a><span>    </span><span class="hs-comment">--   tick&lt;1&gt; case ... of</span><span>
</span><a name="line-615"></a><span>    </span><span class="hs-comment">--             A -&gt; tick&lt;2&gt; ...</span><span>
</span><a name="line-616"></a><span>    </span><span class="hs-comment">--             B -&gt; tick&lt;3&gt; ...</span><span>
</span><a name="line-617"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-618"></a><span>    </span><span class="hs-comment">-- We want the top-level tick annotation to apply to blocks</span><span>
</span><a name="line-619"></a><span>    </span><span class="hs-comment">-- generated for the A and B alternatives. We can achieve that by</span><span>
</span><a name="line-620"></a><span>    </span><span class="hs-comment">-- generating tick&lt;1&gt; into a block with scope a, while the code</span><span>
</span><a name="line-621"></a><span>    </span><span class="hs-comment">-- for alternatives A and B gets generated into sub-scopes a/b and</span><span>
</span><a name="line-622"></a><span>    </span><span class="hs-comment">-- a/c respectively.</span><span>
</span><a name="line-623"></a><span>
</span><a name="line-624"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="CombinedScope"><a href="CmmNode.html#CombinedScope"><span class="hs-identifier">CombinedScope</span></a></a><span> </span><a href="CmmNode.html#CmmTickScope"><span class="hs-identifier hs-type">CmmTickScope</span></a><span> </span><a href="CmmNode.html#CmmTickScope"><span class="hs-identifier hs-type">CmmTickScope</span></a><span>
</span><a name="line-625"></a><span>    </span><span class="hs-comment">-- ^ A combined scope scopes over everything that the two given</span><span>
</span><a name="line-626"></a><span>    </span><span class="hs-comment">-- scopes cover. It is therefore a sub-scope of either scope. This</span><span>
</span><a name="line-627"></a><span>    </span><span class="hs-comment">-- is required for optimisations. Consider common block elimination:</span><span>
</span><a name="line-628"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-629"></a><span>    </span><span class="hs-comment">--   A -&gt; tick&lt;2&gt; case ... of</span><span>
</span><a name="line-630"></a><span>    </span><span class="hs-comment">--     C -&gt; [common]</span><span>
</span><a name="line-631"></a><span>    </span><span class="hs-comment">--   B -&gt; tick&lt;3&gt; case ... of</span><span>
</span><a name="line-632"></a><span>    </span><span class="hs-comment">--     D -&gt; [common]</span><span>
</span><a name="line-633"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-634"></a><span>    </span><span class="hs-comment">-- We will generate code for the C and D alternatives, and figure</span><span>
</span><a name="line-635"></a><span>    </span><span class="hs-comment">-- out afterwards that it's actually common code. Scoping rules</span><span>
</span><a name="line-636"></a><span>    </span><span class="hs-comment">-- dictate that the resulting common block needs to be covered by</span><span>
</span><a name="line-637"></a><span>    </span><span class="hs-comment">-- both tick&lt;2&gt; and tick&lt;3&gt;, therefore we need to construct a</span><span>
</span><a name="line-638"></a><span>    </span><span class="hs-comment">-- scope that is a child to *both* scope. Now we can do that - if</span><span>
</span><a name="line-639"></a><span>    </span><span class="hs-comment">-- we assign the scopes a/c and b/d to the common-ed up blocks,</span><span>
</span><a name="line-640"></a><span>    </span><span class="hs-comment">-- the new block could have a combined tick scope a/c+b/d, which</span><span>
</span><a name="line-641"></a><span>    </span><span class="hs-comment">-- both tick&lt;2&gt; and tick&lt;3&gt; apply to.</span><span>
</span><a name="line-642"></a><span>
</span><a name="line-643"></a><span class="hs-comment">-- Note [CmmTick scoping details]:</span><span>
</span><a name="line-644"></a><span class="hs-comment">--</span><span>
</span><a name="line-645"></a><span class="hs-comment">-- The scope of a @CmmTick@ is given by the @CmmEntry@ node of the</span><span>
</span><a name="line-646"></a><span class="hs-comment">-- same block. Note that as a result of this, optimisations making</span><span>
</span><a name="line-647"></a><span class="hs-comment">-- tick scopes more specific can *reduce* the amount of code a tick</span><span>
</span><a name="line-648"></a><span class="hs-comment">-- scopes over. Fixing this would require a separate @CmmTickScope@</span><span>
</span><a name="line-649"></a><span class="hs-comment">-- field for @CmmTick@. Right now we do not do this simply because I</span><span>
</span><a name="line-650"></a><span class="hs-comment">-- couldn't find an example where it actually mattered -- multiple</span><span>
</span><a name="line-651"></a><span class="hs-comment">-- blocks within the same scope generally jump to each other, which</span><span>
</span><a name="line-652"></a><span class="hs-comment">-- prevents common block elimination from happening in the first</span><span>
</span><a name="line-653"></a><span class="hs-comment">-- place. But this is no strong reason, so if Cmm optimisations become</span><span>
</span><a name="line-654"></a><span class="hs-comment">-- more involved in future this might have to be revisited.</span><span>
</span><a name="line-655"></a><span>
</span><a name="line-656"></a><span class="hs-comment">-- | Output all scope paths.</span><span>
</span><a name="line-657"></a><span class="hs-identifier">scopeToPaths</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmNode.html#CmmTickScope"><span class="hs-identifier hs-type">CmmTickScope</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-identifier hs-type">U.Unique</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-658"></a><a name="scopeToPaths"><a href="CmmNode.html#scopeToPaths"><span class="hs-identifier">scopeToPaths</span></a></a><span> </span><a href="CmmNode.html#GlobalScope"><span class="hs-identifier hs-var">GlobalScope</span></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-659"></a><span class="hs-identifier">scopeToPaths</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#SubScope"><span class="hs-identifier hs-var">SubScope</span></a><span> </span><a name="local-6989586621680027951"><a href="#local-6989586621680027951"><span class="hs-identifier">u</span></a></a><span> </span><a name="local-6989586621680027952"><a href="#local-6989586621680027952"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680027951"><span class="hs-identifier hs-var">u</span></a><span class="hs-glyph">:</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#scopeToPaths"><span class="hs-identifier hs-var">scopeToPaths</span></a><span> </span><a href="#local-6989586621680027952"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-660"></a><span class="hs-identifier">scopeToPaths</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CombinedScope"><span class="hs-identifier hs-var">CombinedScope</span></a><span> </span><a name="local-6989586621680027953"><a href="#local-6989586621680027953"><span class="hs-identifier">s1</span></a></a><span> </span><a name="local-6989586621680027954"><a href="#local-6989586621680027954"><span class="hs-identifier">s2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#scopeToPaths"><span class="hs-identifier hs-var">scopeToPaths</span></a><span> </span><a href="#local-6989586621680027953"><span class="hs-identifier hs-var">s1</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="CmmNode.html#scopeToPaths"><span class="hs-identifier hs-var">scopeToPaths</span></a><span> </span><a href="#local-6989586621680027954"><span class="hs-identifier hs-var">s2</span></a><span>
</span><a name="line-661"></a><span>
</span><a name="line-662"></a><span class="hs-comment">-- | Returns the head uniques of the scopes. This is based on the</span><span>
</span><a name="line-663"></a><span class="hs-comment">-- assumption that the @Unique@ of @SubScope@ identifies the</span><span>
</span><a name="line-664"></a><span class="hs-comment">-- underlying super-scope. Used for efficient equality and comparison,</span><span>
</span><a name="line-665"></a><span class="hs-comment">-- see below.</span><span>
</span><a name="line-666"></a><span class="hs-identifier">scopeUniques</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmNode.html#CmmTickScope"><span class="hs-identifier hs-type">CmmTickScope</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">U.Unique</span><span class="hs-special">]</span><span>
</span><a name="line-667"></a><a name="scopeUniques"><a href="CmmNode.html#scopeUniques"><span class="hs-identifier">scopeUniques</span></a></a><span> </span><a href="CmmNode.html#GlobalScope"><span class="hs-identifier hs-var">GlobalScope</span></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-668"></a><span class="hs-identifier">scopeUniques</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#SubScope"><span class="hs-identifier hs-var">SubScope</span></a><span> </span><a name="local-6989586621680027955"><a href="#local-6989586621680027955"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680027955"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">]</span><span>
</span><a name="line-669"></a><span class="hs-identifier">scopeUniques</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CombinedScope"><span class="hs-identifier hs-var">CombinedScope</span></a><span> </span><a name="local-6989586621680027956"><a href="#local-6989586621680027956"><span class="hs-identifier">s1</span></a></a><span> </span><a name="local-6989586621680027957"><a href="#local-6989586621680027957"><span class="hs-identifier">s2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#scopeUniques"><span class="hs-identifier hs-var">scopeUniques</span></a><span> </span><a href="#local-6989586621680027956"><span class="hs-identifier hs-var">s1</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="CmmNode.html#scopeUniques"><span class="hs-identifier hs-var">scopeUniques</span></a><span> </span><a href="#local-6989586621680027957"><span class="hs-identifier hs-var">s2</span></a><span>
</span><a name="line-670"></a><span>
</span><a name="line-671"></a><span class="hs-comment">-- Equality and order is based on the head uniques defined above. We</span><span>
</span><a name="line-672"></a><span class="hs-comment">-- take care to short-cut the (extremly) common cases.</span><span>
</span><a name="line-673"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><a href="CmmNode.html#CmmTickScope"><span class="hs-identifier hs-type">CmmTickScope</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-674"></a><span>  </span><a href="CmmNode.html#GlobalScope"><span class="hs-identifier hs-var">GlobalScope</span></a><span>    </span><a name="local-3458764513820541095"><span class="hs-operator">==</span></a><span> </span><a href="CmmNode.html#GlobalScope"><span class="hs-identifier hs-var">GlobalScope</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-675"></a><span>  </span><a href="CmmNode.html#GlobalScope"><span class="hs-identifier hs-var">GlobalScope</span></a><span>    </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">_</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-676"></a><span>  </span><span class="hs-identifier">_</span><span>              </span><span class="hs-operator">==</span><span> </span><a href="CmmNode.html#GlobalScope"><span class="hs-identifier hs-var">GlobalScope</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-677"></a><span>  </span><span class="hs-special">(</span><a href="CmmNode.html#SubScope"><span class="hs-identifier hs-var">SubScope</span></a><span> </span><a name="local-6989586621680027626"><a href="#local-6989586621680027626"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#SubScope"><span class="hs-identifier hs-var">SubScope</span></a><span> </span><a name="local-6989586621680027627"><a href="#local-6989586621680027627"><span class="hs-identifier">u'</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027626"><span class="hs-identifier hs-var">u</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680027627"><span class="hs-identifier hs-var">u'</span></a><span>
</span><a name="line-678"></a><span>  </span><span class="hs-special">(</span><a href="CmmNode.html#SubScope"><span class="hs-identifier hs-var">SubScope</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">_</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-679"></a><span>  </span><span class="hs-identifier">_</span><span>              </span><span class="hs-operator">==</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#SubScope"><span class="hs-identifier hs-var">SubScope</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-680"></a><span>  </span><a name="local-6989586621680027628"><a href="#local-6989586621680027628"><span class="hs-identifier">scope</span></a></a><span>          </span><span class="hs-operator">==</span><span> </span><a name="local-6989586621680027629"><a href="#local-6989586621680027629"><span class="hs-identifier">scope'</span></a></a><span>          </span><span class="hs-glyph">=</span><span>
</span><a name="line-681"></a><span>    </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-identifier hs-var">nonDetCmpUnique</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#scopeUniques"><span class="hs-identifier hs-var">scopeUniques</span></a><span> </span><a href="#local-6989586621680027628"><span class="hs-identifier hs-var">scope</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span>
</span><a name="line-682"></a><span>    </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-identifier hs-var">nonDetCmpUnique</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#scopeUniques"><span class="hs-identifier hs-var">scopeUniques</span></a><span> </span><a href="#local-6989586621680027629"><span class="hs-identifier hs-var">scope'</span></a><span class="hs-special">)</span><span>
</span><a name="line-683"></a><span>    </span><span class="hs-comment">-- This is still deterministic because</span><span>
</span><a name="line-684"></a><span>    </span><span class="hs-comment">-- the order is the same for equal lists</span><span>
</span><a name="line-685"></a><span>
</span><a name="line-686"></a><span class="hs-comment">-- This is non-deterministic but we do not currently support deterministic</span><span>
</span><a name="line-687"></a><span class="hs-comment">-- code-generation. See Note [Unique Determinism and code generation]</span><span>
</span><a name="line-688"></a><span class="hs-comment">-- See Note [No Ord for Unique]</span><span>
</span><a name="line-689"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="CmmNode.html#CmmTickScope"><span class="hs-identifier hs-type">CmmTickScope</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-690"></a><span>  </span><a name="local-8214565720323790496"><span class="hs-identifier">compare</span></a><span> </span><a href="CmmNode.html#GlobalScope"><span class="hs-identifier hs-var">GlobalScope</span></a><span>    </span><a href="CmmNode.html#GlobalScope"><span class="hs-identifier hs-var">GlobalScope</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">EQ</span><span>
</span><a name="line-691"></a><span>  </span><span class="hs-identifier">compare</span><span> </span><a href="CmmNode.html#GlobalScope"><span class="hs-identifier hs-var">GlobalScope</span></a><span>    </span><span class="hs-identifier">_</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">LT</span><span>
</span><a name="line-692"></a><span>  </span><span class="hs-identifier">compare</span><span> </span><span class="hs-identifier">_</span><span>              </span><a href="CmmNode.html#GlobalScope"><span class="hs-identifier hs-var">GlobalScope</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">GT</span><span>
</span><a name="line-693"></a><span>  </span><span class="hs-identifier">compare</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#SubScope"><span class="hs-identifier hs-var">SubScope</span></a><span> </span><a name="local-6989586621680027622"><a href="#local-6989586621680027622"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#SubScope"><span class="hs-identifier hs-var">SubScope</span></a><span> </span><a name="local-6989586621680027623"><a href="#local-6989586621680027623"><span class="hs-identifier">u'</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nonDetCmpUnique</span><span> </span><a href="#local-6989586621680027622"><span class="hs-identifier hs-var">u</span></a><span> </span><a href="#local-6989586621680027623"><span class="hs-identifier hs-var">u'</span></a><span>
</span><a name="line-694"></a><span>  </span><span class="hs-identifier">compare</span><span> </span><a name="local-6989586621680027624"><a href="#local-6989586621680027624"><span class="hs-identifier">scope</span></a></a><span> </span><a name="local-6989586621680027625"><a href="#local-6989586621680027625"><span class="hs-identifier">scope'</span></a></a><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cmpList</span><span> </span><span class="hs-identifier hs-var">nonDetCmpUnique</span><span>
</span><a name="line-695"></a><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-identifier hs-var">nonDetCmpUnique</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmNode.html#scopeUniques"><span class="hs-identifier hs-var">scopeUniques</span></a><span> </span><a href="#local-6989586621680027624"><span class="hs-identifier hs-var">scope</span></a><span class="hs-special">)</span><span>
</span><a name="line-696"></a><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-identifier hs-var">nonDetCmpUnique</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmNode.html#scopeUniques"><span class="hs-identifier hs-var">scopeUniques</span></a><span> </span><a href="#local-6989586621680027625"><span class="hs-identifier hs-var">scope'</span></a><span class="hs-special">)</span><span>
</span><a name="line-697"></a><span>
</span><a name="line-698"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="CmmNode.html#CmmTickScope"><span class="hs-identifier hs-type">CmmTickScope</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-699"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><a href="CmmNode.html#GlobalScope"><span class="hs-identifier hs-var">GlobalScope</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;global&quot;</span><span>
</span><a name="line-700"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#SubScope"><span class="hs-identifier hs-var">SubScope</span></a><span> </span><a name="local-6989586621680027618"><a href="#local-6989586621680027618"><span class="hs-identifier">us</span></a></a><span> </span><a href="CmmNode.html#GlobalScope"><span class="hs-identifier hs-var">GlobalScope</span></a><span class="hs-special">)</span><span>
</span><a name="line-701"></a><span>                      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680027618"><span class="hs-identifier hs-var">us</span></a><span>
</span><a name="line-702"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#SubScope"><span class="hs-identifier hs-var">SubScope</span></a><span> </span><a name="local-6989586621680027619"><a href="#local-6989586621680027619"><span class="hs-identifier">us</span></a></a><span> </span><a name="local-6989586621680027620"><a href="#local-6989586621680027620"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680027620"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">'/'</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680027619"><span class="hs-identifier hs-var">us</span></a><span>
</span><a name="line-703"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><a name="local-6989586621680027621"><a href="#local-6989586621680027621"><span class="hs-identifier">combined</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">hcat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">punctuate</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">'+'</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-704"></a><span>                        </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hcat</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">punctuate</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">'/'</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">reverse</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-705"></a><span>                        </span><a href="CmmNode.html#scopeToPaths"><span class="hs-identifier hs-var">scopeToPaths</span></a><span> </span><a href="#local-6989586621680027621"><span class="hs-identifier hs-var">combined</span></a><span>
</span><a name="line-706"></a><span>
</span><a name="line-707"></a><span class="hs-comment">-- | Checks whether two tick scopes are sub-scopes of each other. True</span><span>
</span><a name="line-708"></a><span class="hs-comment">-- if the two scopes are equal.</span><span>
</span><a name="line-709"></a><span class="hs-identifier">isTickSubScope</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmNode.html#CmmTickScope"><span class="hs-identifier hs-type">CmmTickScope</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmTickScope"><span class="hs-identifier hs-type">CmmTickScope</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-710"></a><a name="isTickSubScope"><a href="CmmNode.html#isTickSubScope"><span class="hs-identifier">isTickSubScope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027958"><span class="hs-identifier hs-var">cmp</span></a><span>
</span><a name="line-711"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621680027958"><a href="#local-6989586621680027958"><span class="hs-identifier">cmp</span></a></a><span> </span><span class="hs-identifier">_</span><span>              </span><a href="CmmNode.html#GlobalScope"><span class="hs-identifier hs-var">GlobalScope</span></a><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-712"></a><span>        </span><span class="hs-identifier">cmp</span><span> </span><a href="CmmNode.html#GlobalScope"><span class="hs-identifier hs-var">GlobalScope</span></a><span>    </span><span class="hs-identifier">_</span><span>                       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-713"></a><span>        </span><span class="hs-identifier">cmp</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CombinedScope"><span class="hs-identifier hs-var">CombinedScope</span></a><span> </span><a name="local-6989586621680027959"><a href="#local-6989586621680027959"><span class="hs-identifier">s1</span></a></a><span> </span><a name="local-6989586621680027960"><a href="#local-6989586621680027960"><span class="hs-identifier">s2</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680027961"><a href="#local-6989586621680027961"><span class="hs-identifier">s'</span></a></a><span>               </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027958"><span class="hs-identifier hs-var">cmp</span></a><span> </span><a href="#local-6989586621680027959"><span class="hs-identifier hs-var">s1</span></a><span> </span><a href="#local-6989586621680027961"><span class="hs-identifier hs-var">s'</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621680027958"><span class="hs-identifier hs-var">cmp</span></a><span> </span><a href="#local-6989586621680027960"><span class="hs-identifier hs-var">s2</span></a><span> </span><a href="#local-6989586621680027961"><span class="hs-identifier hs-var">s'</span></a><span>
</span><a name="line-714"></a><span>        </span><span class="hs-identifier">cmp</span><span> </span><a name="local-6989586621680027962"><a href="#local-6989586621680027962"><span class="hs-identifier">s</span></a></a><span>              </span><span class="hs-special">(</span><a href="CmmNode.html#CombinedScope"><span class="hs-identifier hs-var">CombinedScope</span></a><span> </span><a name="local-6989586621680027963"><a href="#local-6989586621680027963"><span class="hs-identifier">s1'</span></a></a><span> </span><a name="local-6989586621680027964"><a href="#local-6989586621680027964"><span class="hs-identifier">s2'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027958"><span class="hs-identifier hs-var">cmp</span></a><span> </span><a href="#local-6989586621680027962"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621680027963"><span class="hs-identifier hs-var">s1'</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621680027958"><span class="hs-identifier hs-var">cmp</span></a><span> </span><a href="#local-6989586621680027962"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621680027964"><span class="hs-identifier hs-var">s2'</span></a><span>
</span><a name="line-715"></a><span>        </span><span class="hs-identifier">cmp</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#SubScope"><span class="hs-identifier hs-var">SubScope</span></a><span> </span><a name="local-6989586621680027965"><a href="#local-6989586621680027965"><span class="hs-identifier">u</span></a></a><span> </span><a name="local-6989586621680027966"><a href="#local-6989586621680027966"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680027967"><a href="#local-6989586621680027967"><span class="hs-identifier">s'</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CmmNode.html#SubScope"><span class="hs-identifier hs-var">SubScope</span></a><span> </span><a name="local-6989586621680027968"><a href="#local-6989586621680027968"><span class="hs-identifier">u'</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027965"><span class="hs-identifier hs-var">u</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680027968"><span class="hs-identifier hs-var">u'</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621680027958"><span class="hs-identifier hs-var">cmp</span></a><span> </span><a href="#local-6989586621680027966"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621680027967"><span class="hs-identifier hs-var">s'</span></a><span>
</span><a name="line-716"></a><span>
</span><a name="line-717"></a><span class="hs-comment">-- | Combine two tick scopes. The new scope should be sub-scope of</span><span>
</span><a name="line-718"></a><span class="hs-comment">-- both parameters. We simplfy automatically if one tick scope is a</span><span>
</span><a name="line-719"></a><span class="hs-comment">-- sub-scope of the other already.</span><span>
</span><a name="line-720"></a><span class="hs-identifier">combineTickScopes</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmNode.html#CmmTickScope"><span class="hs-identifier hs-type">CmmTickScope</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmTickScope"><span class="hs-identifier hs-type">CmmTickScope</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmTickScope"><span class="hs-identifier hs-type">CmmTickScope</span></a><span>
</span><a name="line-721"></a><a name="combineTickScopes"><a href="CmmNode.html#combineTickScopes"><span class="hs-identifier">combineTickScopes</span></a></a><span> </span><a name="local-6989586621680027969"><a href="#local-6989586621680027969"><span class="hs-identifier">s1</span></a></a><span> </span><a name="local-6989586621680027970"><a href="#local-6989586621680027970"><span class="hs-identifier">s2</span></a></a><span>
</span><a name="line-722"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680027969"><span class="hs-identifier hs-var">s1</span></a><span> </span><span class="hs-special">`</span><a href="CmmNode.html#isTickSubScope"><span class="hs-identifier hs-var">isTickSubScope</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680027970"><span class="hs-identifier hs-var">s2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027969"><span class="hs-identifier hs-var">s1</span></a><span>
</span><a name="line-723"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680027970"><span class="hs-identifier hs-var">s2</span></a><span> </span><span class="hs-special">`</span><a href="CmmNode.html#isTickSubScope"><span class="hs-identifier hs-var">isTickSubScope</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680027969"><span class="hs-identifier hs-var">s1</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680027970"><span class="hs-identifier hs-var">s2</span></a><span>
</span><a name="line-724"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#CombinedScope"><span class="hs-identifier hs-var">CombinedScope</span></a><span> </span><a href="#local-6989586621680027969"><span class="hs-identifier hs-var">s1</span></a><span> </span><a href="#local-6989586621680027970"><span class="hs-identifier hs-var">s2</span></a><span>
</span><a name="line-725"></a></pre></body></html>