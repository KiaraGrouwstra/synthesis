<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998

\section[SimplCore]{Driver for simplifying @Core@ programs}
-}</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">SimplCore</span><span> </span><span class="hs-special">(</span><span> </span><a href="SimplCore.html#core2core"><span class="hs-identifier hs-var">core2core</span></a><span class="hs-special">,</span><span> </span><a href="SimplCore.html#simplifyExpr"><span class="hs-identifier hs-var">simplifyExpr</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreSyn</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><a href="CSE.html"><span class="hs-identifier">CSE</span></a><span>              </span><span class="hs-special">(</span><span> </span><a href="CSE.html#cseProgram"><span class="hs-identifier hs-var">cseProgram</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Rules</span><span>            </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkRuleBase</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unionRuleBase</span><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>                          </span><span class="hs-identifier hs-var">extendRuleBaseList</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ruleCheckProgram</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">addRuleInfo</span><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>                          </span><span class="hs-identifier hs-var">getRules</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PprCore</span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">pprCoreBindings</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">pprCoreExpr</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">OccurAnal</span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">occurAnalysePgm</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">occurAnalyseExpr</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">IdInfo</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreStats</span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">coreBindsSize</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">coreBindsStats</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">exprSize</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreUtils</span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkTicks</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">stripTicksTop</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="CoreLint.html"><span class="hs-identifier">CoreLint</span></a><span>         </span><span class="hs-special">(</span><span> </span><a href="CoreLint.html#endPass"><span class="hs-identifier hs-var">endPass</span></a><span class="hs-special">,</span><span> </span><a href="CoreLint.html#lintPassResult"><span class="hs-identifier hs-var">lintPassResult</span></a><span class="hs-special">,</span><span> </span><a href="CoreLint.html#dumpPassResult"><span class="hs-identifier hs-var">dumpPassResult</span></a><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>                          </span><a href="CoreLint.html#lintAnnots"><span class="hs-identifier hs-var">lintAnnots</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="Simplify.html"><span class="hs-identifier">Simplify</span></a><span>         </span><span class="hs-special">(</span><span> </span><a href="Simplify.html#simplTopBinds"><span class="hs-identifier hs-var">simplTopBinds</span></a><span class="hs-special">,</span><span> </span><a href="Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a><span class="hs-special">,</span><span> </span><a href="Simplify.html#simplRules"><span class="hs-identifier hs-var">simplRules</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="SimplUtils.html"><span class="hs-identifier">SimplUtils</span></a><span>       </span><span class="hs-special">(</span><span> </span><a href="SimplUtils.html#simplEnvForGHCi"><span class="hs-identifier hs-var">simplEnvForGHCi</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#activeRule"><span class="hs-identifier hs-var">activeRule</span></a><span class="hs-special">,</span><span> </span><a href="SimplUtils.html#activeUnfolding"><span class="hs-identifier hs-var">activeUnfolding</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="SimplEnv.html"><span class="hs-identifier">SimplEnv</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="SimplMonad.html"><span class="hs-identifier">SimplMonad</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreMonad</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">ErrUtils</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Err</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="FloatIn.html"><span class="hs-identifier">FloatIn</span></a><span>          </span><span class="hs-special">(</span><span> </span><a href="FloatIn.html#floatInwards"><span class="hs-identifier hs-var">floatInwards</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="FloatOut.html"><span class="hs-identifier">FloatOut</span></a><span>         </span><span class="hs-special">(</span><span> </span><a href="FloatOut.html#floatOutwards"><span class="hs-identifier hs-var">floatOutwards</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FamInstEnv</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span>         </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">withTiming</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">CompilerPhase</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isDefaultInlinePragma</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">defaultInlinePragma</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarSet</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarEnv</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="LiberateCase.html"><span class="hs-identifier">LiberateCase</span></a><span>     </span><span class="hs-special">(</span><span> </span><a href="LiberateCase.html#liberateCase"><span class="hs-identifier hs-var">liberateCase</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="SAT.html"><span class="hs-identifier">SAT</span></a><span>              </span><span class="hs-special">(</span><span> </span><a href="SAT.html#doStaticArgs"><span class="hs-identifier hs-var">doStaticArgs</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><a href="Specialise.html"><span class="hs-identifier">Specialise</span></a><span>       </span><span class="hs-special">(</span><span> </span><a href="Specialise.html#specProgram"><span class="hs-identifier hs-var">specProgram</span></a><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="SpecConstr.html"><span class="hs-identifier">SpecConstr</span></a><span>       </span><span class="hs-special">(</span><span> </span><a href="SpecConstr.html#specConstrProgram"><span class="hs-identifier hs-var">specConstrProgram</span></a><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><a href="DmdAnal.html"><span class="hs-identifier">DmdAnal</span></a><span>          </span><span class="hs-special">(</span><span> </span><a href="DmdAnal.html#dmdAnalProgram"><span class="hs-identifier hs-var">dmdAnalProgram</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><a href="CallArity.html"><span class="hs-identifier">CallArity</span></a><span>        </span><span class="hs-special">(</span><span> </span><a href="CallArity.html#callArityAnalProgram"><span class="hs-identifier hs-var">callArityAnalProgram</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><a href="Exitify.html"><span class="hs-identifier">Exitify</span></a><span>          </span><span class="hs-special">(</span><span> </span><a href="Exitify.html#exitifyProgram"><span class="hs-identifier hs-var">exitifyProgram</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><a href="WorkWrap.html"><span class="hs-identifier">WorkWrap</span></a><span>         </span><span class="hs-special">(</span><span> </span><a href="WorkWrap.html#wwTopBinds"><span class="hs-identifier hs-var">wwTopBinds</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Plugins</span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">withPlugins</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">installCoreToDos</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><a href="DynamicLoading.html"><span class="hs-identifier">DynamicLoading</span></a><span>  </span><span class="hs-comment">-- ( initializePlugins )</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSupply</span><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkSplitUniqSupply</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">splitUniqSupply</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqFM</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC.LanguageExtensions</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LangExt</span><span>
</span><a name="line-62"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{The driver for the simplifier}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-69"></a><span>
</span><a name="line-70"></a><span class="hs-identifier">core2core</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span>
</span><a name="line-71"></a><a name="core2core"><a href="SimplCore.html#core2core"><span class="hs-identifier">core2core</span></a></a><span> </span><a name="local-6989586621684380501"><a href="#local-6989586621684380501"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684380502"><a href="#local-6989586621684380502"><span class="hs-identifier">guts</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">ModGuts</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mg_module</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684380503"><a href="#local-6989586621684380503"><span class="hs-identifier">mod</span></a></a><span>
</span><a name="line-72"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_loc</span><span>     </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684380504"><a href="#local-6989586621684380504"><span class="hs-identifier">loc</span></a></a><span>
</span><a name="line-73"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_deps</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684380505"><a href="#local-6989586621684380505"><span class="hs-identifier">deps</span></a></a><span>
</span><a name="line-74"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_rdr_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684380506"><a href="#local-6989586621684380506"><span class="hs-identifier">rdr_env</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-75"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684380511"><a href="#local-6989586621684380511"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mkSplitUniqSupply</span><span> </span><span class="hs-char">'s'</span><span>
</span><a name="line-76"></a><span>       </span><span class="hs-comment">-- make sure all plugins are loaded</span><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684380512"><a href="#local-6989586621684380512"><span class="hs-identifier">builtin_passes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplCore.html#getCoreToDo"><span class="hs-identifier hs-var">getCoreToDo</span></a><span> </span><a href="#local-6989586621684380507"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-79"></a><span>             </span><a name="local-6989586621684380513"><a href="#local-6989586621684380513"><span class="hs-identifier">orph_mods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkModuleSet</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684380503"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">dep_orphs</span><span> </span><a href="#local-6989586621684380505"><span class="hs-identifier hs-var">deps</span></a><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span>       </span><span class="hs-special">;</span><span>
</span><a name="line-81"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684380517"><a href="#local-6989586621684380517"><span class="hs-identifier">guts2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684380518"><a href="#local-6989586621684380518"><span class="hs-identifier">stats</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">runCoreM</span><span> </span><a href="#local-6989586621684380501"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684380509"><span class="hs-identifier hs-var">hpt_rule_base</span></a><span> </span><a href="#local-6989586621684380511"><span class="hs-identifier hs-var">us</span></a><span> </span><a href="#local-6989586621684380503"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-82"></a><span>                                    </span><a href="#local-6989586621684380513"><span class="hs-identifier hs-var">orph_mods</span></a><span> </span><a href="#local-6989586621684380510"><span class="hs-identifier hs-var">print_unqual</span></a><span> </span><a href="#local-6989586621684380504"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-83"></a><span>                           </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684380514"><a href="#local-6989586621684380514"><span class="hs-identifier">hsc_env'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getHscEnv</span><span>
</span><a name="line-84"></a><span>                              </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684380515"><a href="#local-6989586621684380515"><span class="hs-identifier">dflags'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="DynamicLoading.html#initializePlugins"><span class="hs-identifier hs-var">initializePlugins</span></a><span> </span><a href="#local-6989586621684380514"><span class="hs-identifier hs-var">hsc_env'</span></a><span>
</span><a name="line-85"></a><span>                                                      </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621684380514"><span class="hs-identifier hs-var">hsc_env'</span></a><span class="hs-special">)</span><span>
</span><a name="line-86"></a><span>                              </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684380516"><a href="#local-6989586621684380516"><span class="hs-identifier">all_passes</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">withPlugins</span><span> </span><a href="#local-6989586621684380515"><span class="hs-identifier hs-var">dflags'</span></a><span>
</span><a name="line-87"></a><span>                                                </span><span class="hs-identifier">installCoreToDos</span><span>
</span><a name="line-88"></a><span>                                                </span><a href="#local-6989586621684380512"><span class="hs-identifier hs-var">builtin_passes</span></a><span>
</span><a name="line-89"></a><span>                              </span><span class="hs-special">;</span><span> </span><a href="SimplCore.html#runCorePasses"><span class="hs-identifier hs-var">runCorePasses</span></a><span> </span><a href="#local-6989586621684380516"><span class="hs-identifier hs-var">all_passes</span></a><span> </span><a href="#local-6989586621684380502"><span class="hs-identifier hs-var">guts</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-90"></a><span>
</span><a name="line-91"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">Err.dumpIfSet_dyn</span><span> </span><a href="#local-6989586621684380507"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_simpl_stats</span><span>
</span><a name="line-92"></a><span>             </span><span class="hs-string">&quot;Grand total simplifier statistics&quot;</span><span>
</span><a name="line-93"></a><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprSimplCount</span><span> </span><a href="#local-6989586621684380518"><span class="hs-identifier hs-var">stats</span></a><span class="hs-special">)</span><span>
</span><a name="line-94"></a><span>
</span><a name="line-95"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684380517"><span class="hs-identifier hs-var">guts2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-96"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-97"></a><span>    </span><a name="local-6989586621684380507"><a href="#local-6989586621684380507"><span class="hs-identifier">dflags</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621684380501"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-98"></a><span>    </span><a name="local-6989586621684380508"><a href="#local-6989586621684380508"><span class="hs-identifier">home_pkg_rules</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hptRules</span><span> </span><a href="#local-6989586621684380501"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">dep_mods</span><span> </span><a href="#local-6989586621684380505"><span class="hs-identifier hs-var">deps</span></a><span class="hs-special">)</span><span>
</span><a name="line-99"></a><span>    </span><a name="local-6989586621684380509"><a href="#local-6989586621684380509"><span class="hs-identifier">hpt_rule_base</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkRuleBase</span><span> </span><a href="#local-6989586621684380508"><span class="hs-identifier hs-var">home_pkg_rules</span></a><span>
</span><a name="line-100"></a><span>    </span><a name="local-6989586621684380510"><a href="#local-6989586621684380510"><span class="hs-identifier">print_unqual</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkPrintUnqualified</span><span> </span><a href="#local-6989586621684380507"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684380506"><span class="hs-identifier hs-var">rdr_env</span></a><span>
</span><a name="line-101"></a><span>    </span><span class="hs-comment">-- mod: get the module out of the current HscEnv so we can retrieve it from the monad.</span><span>
</span><a name="line-102"></a><span>    </span><span class="hs-comment">-- This is very convienent for the users of the monad (e.g. plugins do not have to</span><span>
</span><a name="line-103"></a><span>    </span><span class="hs-comment">-- consume the ModGuts to find the module) but somewhat ugly because mg_module may</span><span>
</span><a name="line-104"></a><span>    </span><span class="hs-comment">-- _theoretically_ be changed during the Core pipeline (it's part of ModGuts), which</span><span>
</span><a name="line-105"></a><span>    </span><span class="hs-comment">-- would mean our cached value would go out of date.</span><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
           Generating the main optimisation pipeline
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-114"></a><span>
</span><a name="line-115"></a><span class="hs-identifier">getCoreToDo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreToDo</span><span class="hs-special">]</span><span>
</span><a name="line-116"></a><a name="getCoreToDo"><a href="SimplCore.html#getCoreToDo"><span class="hs-identifier">getCoreToDo</span></a></a><span> </span><a name="local-6989586621684380519"><a href="#local-6989586621684380519"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-117"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684380550"><span class="hs-identifier hs-var">flatten_todos</span></a><span> </span><a href="#local-6989586621684380549"><span class="hs-identifier hs-var">core_todo</span></a><span>
</span><a name="line-118"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-119"></a><span>    </span><a name="local-6989586621684380520"><a href="#local-6989586621684380520"><span class="hs-identifier">opt_level</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">optLevel</span><span>           </span><a href="#local-6989586621684380519"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-120"></a><span>    </span><a name="local-6989586621684380521"><a href="#local-6989586621684380521"><span class="hs-identifier">phases</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">simplPhases</span><span>        </span><a href="#local-6989586621684380519"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-121"></a><span>    </span><a name="local-6989586621684380522"><a href="#local-6989586621684380522"><span class="hs-identifier">max_iter</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">maxSimplIterations</span><span> </span><a href="#local-6989586621684380519"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-122"></a><span>    </span><a name="local-6989586621684380523"><a href="#local-6989586621684380523"><span class="hs-identifier">rule_check</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ruleCheck</span><span>          </span><a href="#local-6989586621684380519"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-123"></a><span>    </span><a name="local-6989586621684380524"><a href="#local-6989586621684380524"><span class="hs-identifier">call_arity</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_CallArity</span><span>                    </span><a href="#local-6989586621684380519"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-124"></a><span>    </span><a name="local-6989586621684380525"><a href="#local-6989586621684380525"><span class="hs-identifier">exitification</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_Exitification</span><span>                </span><a href="#local-6989586621684380519"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-125"></a><span>    </span><a name="local-6989586621684380526"><a href="#local-6989586621684380526"><span class="hs-identifier">strictness</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_Strictness</span><span>                   </span><a href="#local-6989586621684380519"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-126"></a><span>    </span><a name="local-6989586621684380527"><a href="#local-6989586621684380527"><span class="hs-identifier">full_laziness</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_FullLaziness</span><span>                 </span><a href="#local-6989586621684380519"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-127"></a><span>    </span><a name="local-6989586621684380528"><a href="#local-6989586621684380528"><span class="hs-identifier">do_specialise</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_Specialise</span><span>                   </span><a href="#local-6989586621684380519"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-128"></a><span>    </span><a name="local-6989586621684380529"><a href="#local-6989586621684380529"><span class="hs-identifier">do_float_in</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_FloatIn</span><span>                      </span><a href="#local-6989586621684380519"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-129"></a><span>    </span><a name="local-6989586621684380530"><a href="#local-6989586621684380530"><span class="hs-identifier">cse</span></a></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_CSE</span><span>                          </span><a href="#local-6989586621684380519"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-130"></a><span>    </span><a name="local-6989586621684380531"><a href="#local-6989586621684380531"><span class="hs-identifier">spec_constr</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_SpecConstr</span><span>                   </span><a href="#local-6989586621684380519"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-131"></a><span>    </span><a name="local-6989586621684380532"><a href="#local-6989586621684380532"><span class="hs-identifier">liberate_case</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_LiberateCase</span><span>                 </span><a href="#local-6989586621684380519"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-132"></a><span>    </span><a name="local-6989586621684380533"><a href="#local-6989586621684380533"><span class="hs-identifier">late_dmd_anal</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_LateDmdAnal</span><span>                  </span><a href="#local-6989586621684380519"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-133"></a><span>    </span><a name="local-6989586621684380534"><a href="#local-6989586621684380534"><span class="hs-identifier">late_specialise</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_LateSpecialise</span><span>             </span><a href="#local-6989586621684380519"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-134"></a><span>    </span><a name="local-6989586621684380535"><a href="#local-6989586621684380535"><span class="hs-identifier">static_args</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_StaticArgumentTransformation</span><span> </span><a href="#local-6989586621684380519"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-135"></a><span>    </span><a name="local-6989586621684380536"><a href="#local-6989586621684380536"><span class="hs-identifier">rules_on</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_EnableRewriteRules</span><span>           </span><a href="#local-6989586621684380519"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-136"></a><span>    </span><a name="local-6989586621684380537"><a href="#local-6989586621684380537"><span class="hs-identifier">eta_expand_on</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_DoLambdaEtaExpansion</span><span>         </span><a href="#local-6989586621684380519"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-137"></a><span>    </span><a name="local-6989586621684380538"><a href="#local-6989586621684380538"><span class="hs-identifier">ww_on</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_WorkerWrapper</span><span>                </span><a href="#local-6989586621684380519"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-138"></a><span>    </span><a name="local-6989586621684380539"><a href="#local-6989586621684380539"><span class="hs-identifier">static_ptrs</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">xopt</span><span> </span><span class="hs-identifier hs-var">LangExt.StaticPointers</span><span>           </span><a href="#local-6989586621684380519"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-139"></a><span>
</span><a name="line-140"></a><span>    </span><a name="local-6989586621684380540"><a href="#local-6989586621684380540"><span class="hs-identifier">maybe_rule_check</span></a></a><span> </span><a name="local-6989586621684380551"><a href="#local-6989586621684380551"><span class="hs-identifier">phase</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runMaybe</span><span> </span><a href="#local-6989586621684380523"><span class="hs-identifier hs-var">rule_check</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoreDoRuleCheck</span><span> </span><a href="#local-6989586621684380551"><span class="hs-identifier hs-var">phase</span></a><span class="hs-special">)</span><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span>    </span><a name="local-6989586621684380541"><a href="#local-6989586621684380541"><span class="hs-identifier">maybe_strictness_before</span></a></a><span> </span><a name="local-6989586621684380552"><a href="#local-6989586621684380552"><span class="hs-identifier">phase</span></a></a><span>
</span><a name="line-143"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runWhen</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684380552"><span class="hs-identifier hs-var">phase</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">strictnessBefore</span><span> </span><a href="#local-6989586621684380519"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">CoreDoStrictness</span><span>
</span><a name="line-144"></a><span>
</span><a name="line-145"></a><span>    </span><a name="local-6989586621684380542"><a href="#local-6989586621684380542"><span class="hs-identifier">base_mode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">SimplMode</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sm_phase</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;base_mode&quot;</span><span>
</span><a name="line-146"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_names</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-147"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_dflags</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684380519"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-148"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_rules</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684380536"><span class="hs-identifier hs-var">rules_on</span></a><span>
</span><a name="line-149"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_eta_expand</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684380537"><span class="hs-identifier hs-var">eta_expand_on</span></a><span>
</span><a name="line-150"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_inline</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-151"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_case_case</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span>    </span><a name="local-6989586621684380543"><a href="#local-6989586621684380543"><span class="hs-identifier">simpl_phase</span></a></a><span> </span><a name="local-6989586621684380553"><a href="#local-6989586621684380553"><span class="hs-identifier">phase</span></a></a><span> </span><a name="local-6989586621684380554"><a href="#local-6989586621684380554"><span class="hs-identifier">names</span></a></a><span> </span><a name="local-6989586621684380555"><a href="#local-6989586621684380555"><span class="hs-identifier">iter</span></a></a><span>
</span><a name="line-154"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CoreDoPasses</span><span>
</span><a name="line-155"></a><span>      </span><span class="hs-operator hs-var">$</span><span>   </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621684380541"><span class="hs-identifier hs-var">maybe_strictness_before</span></a><span> </span><a href="#local-6989586621684380553"><span class="hs-identifier hs-var">phase</span></a><span>
</span><a name="line-156"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">CoreDoSimplify</span><span> </span><a href="#local-6989586621684380555"><span class="hs-identifier hs-var">iter</span></a><span>
</span><a name="line-157"></a><span>                </span><span class="hs-special">(</span><a href="#local-6989586621684380542"><span class="hs-identifier hs-var">base_mode</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sm_phase</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Phase</span><span> </span><a href="#local-6989586621684380553"><span class="hs-identifier hs-var">phase</span></a><span>
</span><a name="line-158"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_names</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684380554"><span class="hs-identifier hs-var">names</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-159"></a><span>
</span><a name="line-160"></a><span>          </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684380540"><span class="hs-identifier hs-var">maybe_rule_check</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Phase</span><span> </span><a href="#local-6989586621684380553"><span class="hs-identifier hs-var">phase</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span>    </span><a name="local-6989586621684380544"><a href="#local-6989586621684380544"><span class="hs-identifier">simpl_phases</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CoreDoPasses</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621684380543"><span class="hs-identifier hs-var">simpl_phase</span></a><span> </span><a href="#local-6989586621684380556"><span class="hs-identifier hs-var">phase</span></a><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;main&quot;</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621684380522"><span class="hs-identifier hs-var">max_iter</span></a><span>
</span><a name="line-163"></a><span>                                </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621684380556"><a href="#local-6989586621684380556"><span class="hs-identifier">phase</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684380521"><span class="hs-identifier hs-var">phases</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684380521"><span class="hs-identifier hs-var">phases</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">..</span><span> </span><span class="hs-number">1</span><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-164"></a><span>
</span><a name="line-165"></a><span>
</span><a name="line-166"></a><span>        </span><span class="hs-comment">-- initial simplify: mk specialiser happy: minimum effort please</span><span>
</span><a name="line-167"></a><span>    </span><a name="local-6989586621684380545"><a href="#local-6989586621684380545"><span class="hs-identifier">simpl_gently</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CoreDoSimplify</span><span> </span><a href="#local-6989586621684380522"><span class="hs-identifier hs-var">max_iter</span></a><span>
</span><a name="line-168"></a><span>                       </span><span class="hs-special">(</span><a href="#local-6989586621684380542"><span class="hs-identifier hs-var">base_mode</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sm_phase</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">InitialPhase</span><span>
</span><a name="line-169"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_names</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;Gentle&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-170"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_rules</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684380536"><span class="hs-identifier hs-var">rules_on</span></a><span>   </span><span class="hs-comment">-- Note [RULEs enabled in SimplGently]</span><span>
</span><a name="line-171"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_inline</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-172"></a><span>                                              </span><span class="hs-comment">-- See Note [Inline in InitialPhase]</span><span>
</span><a name="line-173"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_case_case</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-174"></a><span>                          </span><span class="hs-comment">-- Don't do case-of-case transformations.</span><span>
</span><a name="line-175"></a><span>                          </span><span class="hs-comment">-- This makes full laziness work better</span><span>
</span><a name="line-176"></a><span>
</span><a name="line-177"></a><span>    </span><a name="local-6989586621684380546"><a href="#local-6989586621684380546"><span class="hs-identifier">strictness_pass</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621684380538"><span class="hs-identifier hs-var">ww_on</span></a><span>
</span><a name="line-178"></a><span>                       </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">CoreDoStrictness</span><span class="hs-special">,</span><span class="hs-identifier hs-var">CoreDoWorkerWrapper</span><span class="hs-special">]</span><span>
</span><a name="line-179"></a><span>                       </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">CoreDoStrictness</span><span class="hs-special">]</span><span>
</span><a name="line-180"></a><span>
</span><a name="line-181"></a><span>
</span><a name="line-182"></a><span>    </span><span class="hs-comment">-- New demand analyser</span><span>
</span><a name="line-183"></a><span>    </span><a name="local-6989586621684380547"><a href="#local-6989586621684380547"><span class="hs-identifier">demand_analyser</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoreDoPasses</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-184"></a><span>                           </span><a href="#local-6989586621684380546"><span class="hs-identifier hs-var">strictness_pass</span></a><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-185"></a><span>                           </span><span class="hs-special">[</span><a href="#local-6989586621684380543"><span class="hs-identifier hs-var">simpl_phase</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;post-worker-wrapper&quot;</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621684380522"><span class="hs-identifier hs-var">max_iter</span></a><span class="hs-special">]</span><span>
</span><a name="line-186"></a><span>                           </span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span>    </span><span class="hs-comment">-- Static forms are moved to the top level with the FloatOut pass.</span><span>
</span><a name="line-189"></a><span>    </span><span class="hs-comment">-- See Note [Grand plan for static forms] in StaticPtrTable.</span><span>
</span><a name="line-190"></a><span>    </span><a name="local-6989586621684380548"><a href="#local-6989586621684380548"><span class="hs-identifier">static_ptrs_float_outwards</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-191"></a><span>      </span><span class="hs-identifier hs-var">runWhen</span><span> </span><a href="#local-6989586621684380539"><span class="hs-identifier hs-var">static_ptrs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">CoreDoPasses</span><span>
</span><a name="line-192"></a><span>        </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621684380545"><span class="hs-identifier hs-var">simpl_gently</span></a><span> </span><span class="hs-comment">-- Float Out can't handle type lets (sometimes created</span><span>
</span><a name="line-193"></a><span>                       </span><span class="hs-comment">-- by simpleOptPgm via mkParallelBindings)</span><span>
</span><a name="line-194"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">CoreDoFloatOutwards</span><span> </span><span class="hs-identifier hs-var">FloatOutSwitches</span><span>
</span><a name="line-195"></a><span>          </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">floatOutLambdas</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-196"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">floatOutConstants</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-197"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">floatOutOverSatApps</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-198"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">floatToTopLevelOnly</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-199"></a><span>          </span><span class="hs-special">}</span><span>
</span><a name="line-200"></a><span>        </span><span class="hs-special">]</span><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span>    </span><a name="local-6989586621684380549"><a href="#local-6989586621684380549"><span class="hs-identifier">core_todo</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-203"></a><span>     </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621684380520"><span class="hs-identifier hs-var">opt_level</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-204"></a><span>       </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621684380548"><span class="hs-identifier hs-var">static_ptrs_float_outwards</span></a><span class="hs-special">,</span><span>
</span><a name="line-205"></a><span>         </span><span class="hs-identifier hs-var">CoreDoSimplify</span><span> </span><a href="#local-6989586621684380522"><span class="hs-identifier hs-var">max_iter</span></a><span>
</span><a name="line-206"></a><span>             </span><span class="hs-special">(</span><a href="#local-6989586621684380542"><span class="hs-identifier hs-var">base_mode</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sm_phase</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Phase</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-207"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sm_names</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;Non-opt simplification&quot;</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-208"></a><span>       </span><span class="hs-special">]</span><span>
</span><a name="line-209"></a><span>
</span><a name="line-210"></a><span>     </span><span class="hs-keyword">else</span><span> </span><span class="hs-comment">{- opt_level &gt;= 1 -}</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-211"></a><span>
</span><a name="line-212"></a><span>    </span><span class="hs-comment">-- We want to do the static argument transform before full laziness as it</span><span>
</span><a name="line-213"></a><span>    </span><span class="hs-comment">-- may expose extra opportunities to float things outwards. However, to fix</span><span>
</span><a name="line-214"></a><span>    </span><span class="hs-comment">-- up the output of the transformation we need at do at least one simplify</span><span>
</span><a name="line-215"></a><span>    </span><span class="hs-comment">-- after this before anything else</span><span>
</span><a name="line-216"></a><span>        </span><span class="hs-identifier hs-var">runWhen</span><span> </span><a href="#local-6989586621684380535"><span class="hs-identifier hs-var">static_args</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoreDoPasses</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621684380545"><span class="hs-identifier hs-var">simpl_gently</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">CoreDoStaticArgs</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-217"></a><span>
</span><a name="line-218"></a><span>        </span><span class="hs-comment">-- initial simplify: mk specialiser happy: minimum effort please</span><span>
</span><a name="line-219"></a><span>        </span><a href="#local-6989586621684380545"><span class="hs-identifier hs-var">simpl_gently</span></a><span class="hs-special">,</span><span>
</span><a name="line-220"></a><span>
</span><a name="line-221"></a><span>        </span><span class="hs-comment">-- Specialisation is best done before full laziness</span><span>
</span><a name="line-222"></a><span>        </span><span class="hs-comment">-- so that overloaded functions have all their dictionary lambdas manifest</span><span>
</span><a name="line-223"></a><span>        </span><span class="hs-identifier hs-var">runWhen</span><span> </span><a href="#local-6989586621684380528"><span class="hs-identifier hs-var">do_specialise</span></a><span> </span><span class="hs-identifier hs-var">CoreDoSpecialising</span><span class="hs-special">,</span><span>
</span><a name="line-224"></a><span>
</span><a name="line-225"></a><span>        </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621684380527"><span class="hs-identifier hs-var">full_laziness</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-226"></a><span>           </span><span class="hs-identifier hs-var">CoreDoFloatOutwards</span><span> </span><span class="hs-identifier hs-var">FloatOutSwitches</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-227"></a><span>                                 </span><span class="hs-identifier">floatOutLambdas</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span>
</span><a name="line-228"></a><span>                                 </span><span class="hs-identifier">floatOutConstants</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span>
</span><a name="line-229"></a><span>                                 </span><span class="hs-identifier">floatOutOverSatApps</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span>
</span><a name="line-230"></a><span>                                 </span><span class="hs-identifier">floatToTopLevelOnly</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-231"></a><span>                </span><span class="hs-comment">-- Was: gentleFloatOutSwitches</span><span>
</span><a name="line-232"></a><span>                </span><span class="hs-comment">--</span><span>
</span><a name="line-233"></a><span>                </span><span class="hs-comment">-- I have no idea why, but not floating constants to</span><span>
</span><a name="line-234"></a><span>                </span><span class="hs-comment">-- top level is very bad in some cases.</span><span>
</span><a name="line-235"></a><span>                </span><span class="hs-comment">--</span><span>
</span><a name="line-236"></a><span>                </span><span class="hs-comment">-- Notably: p_ident in spectral/rewrite</span><span>
</span><a name="line-237"></a><span>                </span><span class="hs-comment">--          Changing from &quot;gentle&quot; to &quot;constantsOnly&quot;</span><span>
</span><a name="line-238"></a><span>                </span><span class="hs-comment">--          improved rewrite's allocation by 19%, and</span><span>
</span><a name="line-239"></a><span>                </span><span class="hs-comment">--          made 0.0% difference to any other nofib</span><span>
</span><a name="line-240"></a><span>                </span><span class="hs-comment">--          benchmark</span><span>
</span><a name="line-241"></a><span>                </span><span class="hs-comment">--</span><span>
</span><a name="line-242"></a><span>                </span><span class="hs-comment">-- Not doing floatOutOverSatApps yet, we'll do</span><span>
</span><a name="line-243"></a><span>                </span><span class="hs-comment">-- that later on when we've had a chance to get more</span><span>
</span><a name="line-244"></a><span>                </span><span class="hs-comment">-- accurate arity information.  In fact it makes no</span><span>
</span><a name="line-245"></a><span>                </span><span class="hs-comment">-- difference at all to performance if we do it here,</span><span>
</span><a name="line-246"></a><span>                </span><span class="hs-comment">-- but maybe we save some unnecessary to-and-fro in</span><span>
</span><a name="line-247"></a><span>                </span><span class="hs-comment">-- the simplifier.</span><span>
</span><a name="line-248"></a><span>        </span><span class="hs-keyword">else</span><span>
</span><a name="line-249"></a><span>           </span><span class="hs-comment">-- Even with full laziness turned off, we still need to float static</span><span>
</span><a name="line-250"></a><span>           </span><span class="hs-comment">-- forms to the top level. See Note [Grand plan for static forms] in</span><span>
</span><a name="line-251"></a><span>           </span><span class="hs-comment">-- StaticPtrTable.</span><span>
</span><a name="line-252"></a><span>           </span><a href="#local-6989586621684380548"><span class="hs-identifier hs-var">static_ptrs_float_outwards</span></a><span class="hs-special">,</span><span>
</span><a name="line-253"></a><span>
</span><a name="line-254"></a><span>        </span><a href="#local-6989586621684380544"><span class="hs-identifier hs-var">simpl_phases</span></a><span class="hs-special">,</span><span>
</span><a name="line-255"></a><span>
</span><a name="line-256"></a><span>                </span><span class="hs-comment">-- Phase 0: allow all Ids to be inlined now</span><span>
</span><a name="line-257"></a><span>                </span><span class="hs-comment">-- This gets foldr inlined before strictness analysis</span><span>
</span><a name="line-258"></a><span>
</span><a name="line-259"></a><span>                </span><span class="hs-comment">-- At least 3 iterations because otherwise we land up with</span><span>
</span><a name="line-260"></a><span>                </span><span class="hs-comment">-- huge dead expressions because of an infelicity in the</span><span>
</span><a name="line-261"></a><span>                </span><span class="hs-comment">-- simplifier.</span><span>
</span><a name="line-262"></a><span>                </span><span class="hs-comment">--      let k = BIG in foldr k z xs</span><span>
</span><a name="line-263"></a><span>                </span><span class="hs-comment">-- ==&gt;  let k = BIG in letrec go = \xs -&gt; ...(k x).... in go xs</span><span>
</span><a name="line-264"></a><span>                </span><span class="hs-comment">-- ==&gt;  let k = BIG in letrec go = \xs -&gt; ...(BIG x).... in go xs</span><span>
</span><a name="line-265"></a><span>                </span><span class="hs-comment">-- Don't stop now!</span><span>
</span><a name="line-266"></a><span>        </span><a href="#local-6989586621684380543"><span class="hs-identifier hs-var">simpl_phase</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;main&quot;</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">max</span><span> </span><a href="#local-6989586621684380522"><span class="hs-identifier hs-var">max_iter</span></a><span> </span><span class="hs-number">3</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-267"></a><span>
</span><a name="line-268"></a><span>        </span><span class="hs-identifier hs-var">runWhen</span><span> </span><a href="#local-6989586621684380529"><span class="hs-identifier hs-var">do_float_in</span></a><span> </span><span class="hs-identifier hs-var">CoreDoFloatInwards</span><span class="hs-special">,</span><span>
</span><a name="line-269"></a><span>            </span><span class="hs-comment">-- Run float-inwards immediately before the strictness analyser</span><span>
</span><a name="line-270"></a><span>            </span><span class="hs-comment">-- Doing so pushes bindings nearer their use site and hence makes</span><span>
</span><a name="line-271"></a><span>            </span><span class="hs-comment">-- them more likely to be strict. These bindings might only show</span><span>
</span><a name="line-272"></a><span>            </span><span class="hs-comment">-- up after the inlining from simplification.  Example in fulsom,</span><span>
</span><a name="line-273"></a><span>            </span><span class="hs-comment">-- Csg.calc, where an arg of timesDouble thereby becomes strict.</span><span>
</span><a name="line-274"></a><span>
</span><a name="line-275"></a><span>        </span><span class="hs-identifier hs-var">runWhen</span><span> </span><a href="#local-6989586621684380524"><span class="hs-identifier hs-var">call_arity</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">CoreDoPasses</span><span>
</span><a name="line-276"></a><span>            </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">CoreDoCallArity</span><span>
</span><a name="line-277"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684380543"><span class="hs-identifier hs-var">simpl_phase</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;post-call-arity&quot;</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621684380522"><span class="hs-identifier hs-var">max_iter</span></a><span>
</span><a name="line-278"></a><span>            </span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-279"></a><span>
</span><a name="line-280"></a><span>        </span><span class="hs-identifier hs-var">runWhen</span><span> </span><a href="#local-6989586621684380526"><span class="hs-identifier hs-var">strictness</span></a><span> </span><a href="#local-6989586621684380547"><span class="hs-identifier hs-var">demand_analyser</span></a><span class="hs-special">,</span><span>
</span><a name="line-281"></a><span>
</span><a name="line-282"></a><span>        </span><span class="hs-identifier hs-var">runWhen</span><span> </span><a href="#local-6989586621684380525"><span class="hs-identifier hs-var">exitification</span></a><span> </span><span class="hs-identifier hs-var">CoreDoExitify</span><span class="hs-special">,</span><span>
</span><a name="line-283"></a><span>            </span><span class="hs-comment">-- See note [Placement of the exitification pass]</span><span>
</span><a name="line-284"></a><span>
</span><a name="line-285"></a><span>        </span><span class="hs-identifier hs-var">runWhen</span><span> </span><a href="#local-6989586621684380527"><span class="hs-identifier hs-var">full_laziness</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-286"></a><span>           </span><span class="hs-identifier hs-var">CoreDoFloatOutwards</span><span> </span><span class="hs-identifier hs-var">FloatOutSwitches</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-287"></a><span>                                 </span><span class="hs-identifier">floatOutLambdas</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">floatLamArgs</span><span> </span><a href="#local-6989586621684380519"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">,</span><span>
</span><a name="line-288"></a><span>                                 </span><span class="hs-identifier">floatOutConstants</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span>
</span><a name="line-289"></a><span>                                 </span><span class="hs-identifier">floatOutOverSatApps</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span>
</span><a name="line-290"></a><span>                                 </span><span class="hs-identifier">floatToTopLevelOnly</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-291"></a><span>                </span><span class="hs-comment">-- nofib/spectral/hartel/wang doubles in speed if you</span><span>
</span><a name="line-292"></a><span>                </span><span class="hs-comment">-- do full laziness late in the day.  It only happens</span><span>
</span><a name="line-293"></a><span>                </span><span class="hs-comment">-- after fusion and other stuff, so the early pass doesn't</span><span>
</span><a name="line-294"></a><span>                </span><span class="hs-comment">-- catch it.  For the record, the redex is</span><span>
</span><a name="line-295"></a><span>                </span><span class="hs-comment">--        f_el22 (f_el21 r_midblock)</span><span>
</span><a name="line-296"></a><span>
</span><a name="line-297"></a><span>
</span><a name="line-298"></a><span>        </span><span class="hs-identifier hs-var">runWhen</span><span> </span><a href="#local-6989586621684380530"><span class="hs-identifier hs-var">cse</span></a><span> </span><span class="hs-identifier hs-var">CoreCSE</span><span class="hs-special">,</span><span>
</span><a name="line-299"></a><span>                </span><span class="hs-comment">-- We want CSE to follow the final full-laziness pass, because it may</span><span>
</span><a name="line-300"></a><span>                </span><span class="hs-comment">-- succeed in commoning up things floated out by full laziness.</span><span>
</span><a name="line-301"></a><span>                </span><span class="hs-comment">-- CSE used to rely on the no-shadowing invariant, but it doesn't any more</span><span>
</span><a name="line-302"></a><span>
</span><a name="line-303"></a><span>        </span><span class="hs-identifier hs-var">runWhen</span><span> </span><a href="#local-6989586621684380529"><span class="hs-identifier hs-var">do_float_in</span></a><span> </span><span class="hs-identifier hs-var">CoreDoFloatInwards</span><span class="hs-special">,</span><span>
</span><a name="line-304"></a><span>
</span><a name="line-305"></a><span>        </span><a href="#local-6989586621684380540"><span class="hs-identifier hs-var">maybe_rule_check</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Phase</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-306"></a><span>
</span><a name="line-307"></a><span>                </span><span class="hs-comment">-- Case-liberation for -O2.  This should be after</span><span>
</span><a name="line-308"></a><span>                </span><span class="hs-comment">-- strictness analysis and the simplification which follows it.</span><span>
</span><a name="line-309"></a><span>        </span><span class="hs-identifier hs-var">runWhen</span><span> </span><a href="#local-6989586621684380532"><span class="hs-identifier hs-var">liberate_case</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoreDoPasses</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-310"></a><span>            </span><span class="hs-identifier hs-var">CoreLiberateCase</span><span class="hs-special">,</span><span>
</span><a name="line-311"></a><span>            </span><a href="#local-6989586621684380543"><span class="hs-identifier hs-var">simpl_phase</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;post-liberate-case&quot;</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621684380522"><span class="hs-identifier hs-var">max_iter</span></a><span>
</span><a name="line-312"></a><span>            </span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">,</span><span>         </span><span class="hs-comment">-- Run the simplifier after LiberateCase to vastly</span><span>
</span><a name="line-313"></a><span>                        </span><span class="hs-comment">-- reduce the possibility of shadowing</span><span>
</span><a name="line-314"></a><span>                        </span><span class="hs-comment">-- Reason: see Note [Shadowing] in SpecConstr.hs</span><span>
</span><a name="line-315"></a><span>
</span><a name="line-316"></a><span>        </span><span class="hs-identifier hs-var">runWhen</span><span> </span><a href="#local-6989586621684380531"><span class="hs-identifier hs-var">spec_constr</span></a><span> </span><span class="hs-identifier hs-var">CoreDoSpecConstr</span><span class="hs-special">,</span><span>
</span><a name="line-317"></a><span>
</span><a name="line-318"></a><span>        </span><a href="#local-6989586621684380540"><span class="hs-identifier hs-var">maybe_rule_check</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Phase</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-319"></a><span>
</span><a name="line-320"></a><span>        </span><span class="hs-identifier hs-var">runWhen</span><span> </span><a href="#local-6989586621684380534"><span class="hs-identifier hs-var">late_specialise</span></a><span>
</span><a name="line-321"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoreDoPasses</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">CoreDoSpecialising</span><span>
</span><a name="line-322"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684380543"><span class="hs-identifier hs-var">simpl_phase</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;post-late-spec&quot;</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621684380522"><span class="hs-identifier hs-var">max_iter</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-323"></a><span>
</span><a name="line-324"></a><span>        </span><span class="hs-comment">-- LiberateCase can yield new CSE opportunities because it peels</span><span>
</span><a name="line-325"></a><span>        </span><span class="hs-comment">-- off one layer of a recursive function (concretely, I saw this</span><span>
</span><a name="line-326"></a><span>        </span><span class="hs-comment">-- in wheel-sieve1), and I'm guessing that SpecConstr can too</span><span>
</span><a name="line-327"></a><span>        </span><span class="hs-comment">-- And CSE is a very cheap pass. So it seems worth doing here.</span><span>
</span><a name="line-328"></a><span>        </span><span class="hs-identifier hs-var">runWhen</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621684380532"><span class="hs-identifier hs-var">liberate_case</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621684380531"><span class="hs-identifier hs-var">spec_constr</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684380530"><span class="hs-identifier hs-var">cse</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">CoreCSE</span><span class="hs-special">,</span><span>
</span><a name="line-329"></a><span>
</span><a name="line-330"></a><span>        </span><span class="hs-comment">-- Final clean-up simplification:</span><span>
</span><a name="line-331"></a><span>        </span><a href="#local-6989586621684380543"><span class="hs-identifier hs-var">simpl_phase</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;final&quot;</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621684380522"><span class="hs-identifier hs-var">max_iter</span></a><span class="hs-special">,</span><span>
</span><a name="line-332"></a><span>
</span><a name="line-333"></a><span>        </span><span class="hs-identifier hs-var">runWhen</span><span> </span><a href="#local-6989586621684380533"><span class="hs-identifier hs-var">late_dmd_anal</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">CoreDoPasses</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-334"></a><span>            </span><a href="#local-6989586621684380546"><span class="hs-identifier hs-var">strictness_pass</span></a><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-335"></a><span>            </span><span class="hs-special">[</span><a href="#local-6989586621684380543"><span class="hs-identifier hs-var">simpl_phase</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;post-late-ww&quot;</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621684380522"><span class="hs-identifier hs-var">max_iter</span></a><span class="hs-special">]</span><span>
</span><a name="line-336"></a><span>          </span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-337"></a><span>
</span><a name="line-338"></a><span>        </span><span class="hs-comment">-- Final run of the demand_analyser, ensures that one-shot thunks are</span><span>
</span><a name="line-339"></a><span>        </span><span class="hs-comment">-- really really one-shot thunks. Only needed if the demand analyser</span><span>
</span><a name="line-340"></a><span>        </span><span class="hs-comment">-- has run at all. See Note [Final Demand Analyser run] in DmdAnal</span><span>
</span><a name="line-341"></a><span>        </span><span class="hs-comment">-- It is EXTREMELY IMPORTANT to run this pass, otherwise execution</span><span>
</span><a name="line-342"></a><span>        </span><span class="hs-comment">-- can become /exponentially/ more expensive. See Trac #11731, #12996.</span><span>
</span><a name="line-343"></a><span>        </span><span class="hs-identifier hs-var">runWhen</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684380526"><span class="hs-identifier hs-var">strictness</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621684380533"><span class="hs-identifier hs-var">late_dmd_anal</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">CoreDoStrictness</span><span class="hs-special">,</span><span>
</span><a name="line-344"></a><span>
</span><a name="line-345"></a><span>        </span><a href="#local-6989586621684380540"><span class="hs-identifier hs-var">maybe_rule_check</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Phase</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-346"></a><span>     </span><span class="hs-special">]</span><span>
</span><a name="line-347"></a><span>
</span><a name="line-348"></a><span>    </span><span class="hs-comment">-- Remove 'CoreDoNothing' and flatten 'CoreDoPasses' for clarity.</span><span>
</span><a name="line-349"></a><span>    </span><a name="local-6989586621684380550"><a href="#local-6989586621684380550"><span class="hs-identifier">flatten_todos</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-350"></a><span>    </span><span class="hs-identifier">flatten_todos</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoreDoNothing</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684380557"><a href="#local-6989586621684380557"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684380550"><span class="hs-identifier hs-var">flatten_todos</span></a><span> </span><a href="#local-6989586621684380557"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-351"></a><span>    </span><span class="hs-identifier">flatten_todos</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoreDoPasses</span><span> </span><a name="local-6989586621684380558"><a href="#local-6989586621684380558"><span class="hs-identifier">passes</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684380559"><a href="#local-6989586621684380559"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-352"></a><span>      </span><a href="#local-6989586621684380550"><span class="hs-identifier hs-var">flatten_todos</span></a><span> </span><a href="#local-6989586621684380558"><span class="hs-identifier hs-var">passes</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684380550"><span class="hs-identifier hs-var">flatten_todos</span></a><span> </span><a href="#local-6989586621684380559"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-353"></a><span>    </span><span class="hs-identifier">flatten_todos</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684380560"><a href="#local-6989586621684380560"><span class="hs-identifier">todo</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684380561"><a href="#local-6989586621684380561"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684380560"><span class="hs-identifier hs-var">todo</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684380550"><span class="hs-identifier hs-var">flatten_todos</span></a><span> </span><a href="#local-6989586621684380561"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-354"></a><span>
</span><a name="line-355"></a><span class="hs-comment">{- Note [Inline in InitialPhase]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In GHC 8 and earlier we did not inline anything in the InitialPhase. But that is
confusing for users because when they say INLINE they expect the function to inline
right away.

So now we do inlining immediately, even in the InitialPhase, assuming that the
Id's Activation allows it.

This is a surprisingly big deal. Compiler performance improved a lot
when I made this change:

   perf/compiler/T5837.run            T5837 [stat too good] (normal)
   perf/compiler/parsing001.run       parsing001 [stat too good] (normal)
   perf/compiler/T12234.run           T12234 [stat too good] (optasm)
   perf/compiler/T9020.run            T9020 [stat too good] (optasm)
   perf/compiler/T3064.run            T3064 [stat too good] (normal)
   perf/compiler/T9961.run            T9961 [stat too good] (normal)
   perf/compiler/T13056.run           T13056 [stat too good] (optasm)
   perf/compiler/T9872d.run           T9872d [stat too good] (normal)
   perf/compiler/T783.run             T783 [stat too good] (normal)
   perf/compiler/T12227.run           T12227 [stat too good] (normal)
   perf/should_run/lazy-bs-alloc.run  lazy-bs-alloc [stat too good] (normal)
   perf/compiler/T1969.run            T1969 [stat too good] (normal)
   perf/compiler/T9872a.run           T9872a [stat too good] (normal)
   perf/compiler/T9872c.run           T9872c [stat too good] (normal)
   perf/compiler/T9872b.run           T9872b [stat too good] (normal)
   perf/compiler/T9872d.run           T9872d [stat too good] (normal)

Note [RULEs enabled in SimplGently]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
RULES are enabled when doing &quot;gentle&quot; simplification.  Two reasons:

  * We really want the class-op cancellation to happen:
        op (df d1 d2) --&gt; $cop3 d1 d2
    because this breaks the mutual recursion between 'op' and 'df'

  * I wanted the RULE
        lift String ===&gt; ...
    to work in Template Haskell when simplifying
    splices, so we get simpler code for literal strings

But watch out: list fusion can prevent floating.  So use phase control
to switch off those rules until after floating.

************************************************************************
*                                                                      *
                  The CoreToDo interpreter
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-406"></a><span>
</span><a name="line-407"></a><span class="hs-identifier">runCorePasses</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreToDo</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreM</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span>
</span><a name="line-408"></a><a name="runCorePasses"><a href="SimplCore.html#runCorePasses"><span class="hs-identifier">runCorePasses</span></a></a><span> </span><a name="local-6989586621684380562"><a href="#local-6989586621684380562"><span class="hs-identifier">passes</span></a></a><span> </span><a name="local-6989586621684380563"><a href="#local-6989586621684380563"><span class="hs-identifier">guts</span></a></a><span>
</span><a name="line-409"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldM</span><span> </span><a href="#local-6989586621684380564"><span class="hs-identifier hs-var">do_pass</span></a><span> </span><a href="#local-6989586621684380563"><span class="hs-identifier hs-var">guts</span></a><span> </span><a href="#local-6989586621684380562"><span class="hs-identifier hs-var">passes</span></a><span>
</span><a name="line-410"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-411"></a><span>    </span><a name="local-6989586621684380564"><a href="#local-6989586621684380564"><span class="hs-identifier">do_pass</span></a></a><span> </span><a name="local-6989586621684380566"><a href="#local-6989586621684380566"><span class="hs-identifier">guts</span></a></a><span> </span><span class="hs-identifier hs-var">CoreDoNothing</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684380566"><span class="hs-identifier hs-var">guts</span></a><span>
</span><a name="line-412"></a><span>    </span><span class="hs-identifier">do_pass</span><span> </span><a name="local-6989586621684380567"><a href="#local-6989586621684380567"><span class="hs-identifier">guts</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoreDoPasses</span><span> </span><a name="local-6989586621684380568"><a href="#local-6989586621684380568"><span class="hs-identifier">ps</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplCore.html#runCorePasses"><span class="hs-identifier hs-var">runCorePasses</span></a><span> </span><a href="#local-6989586621684380568"><span class="hs-identifier hs-var">ps</span></a><span> </span><a href="#local-6989586621684380567"><span class="hs-identifier hs-var">guts</span></a><span>
</span><a name="line-413"></a><span>    </span><span class="hs-identifier">do_pass</span><span> </span><a name="local-6989586621684380569"><a href="#local-6989586621684380569"><span class="hs-identifier">guts</span></a></a><span> </span><a name="local-6989586621684380570"><a href="#local-6989586621684380570"><span class="hs-identifier">pass</span></a></a><span>
</span><a name="line-414"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withTiming</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-415"></a><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684380570"><span class="hs-identifier hs-var">pass</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">brackets</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684380565"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-416"></a><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-417"></a><span>            </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684380571"><a href="#local-6989586621684380571"><span class="hs-identifier">guts'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreLint.html#lintAnnots"><span class="hs-identifier hs-var">lintAnnots</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684380570"><span class="hs-identifier hs-var">pass</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="SimplCore.html#doCorePass"><span class="hs-identifier hs-var">doCorePass</span></a><span> </span><a href="#local-6989586621684380570"><span class="hs-identifier hs-var">pass</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684380569"><span class="hs-identifier hs-var">guts</span></a><span>
</span><a name="line-418"></a><span>            </span><span class="hs-special">;</span><span> </span><a href="CoreLint.html#endPass"><span class="hs-identifier hs-var">endPass</span></a><span> </span><a href="#local-6989586621684380570"><span class="hs-identifier hs-var">pass</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mg_binds</span><span> </span><a href="#local-6989586621684380571"><span class="hs-identifier hs-var">guts'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mg_rules</span><span> </span><a href="#local-6989586621684380571"><span class="hs-identifier hs-var">guts'</span></a><span class="hs-special">)</span><span>
</span><a name="line-419"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684380571"><span class="hs-identifier hs-var">guts'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-420"></a><span>
</span><a name="line-421"></a><span>    </span><a name="local-6989586621684380565"><a href="#local-6989586621684380565"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mg_module</span><span> </span><a href="#local-6989586621684380563"><span class="hs-identifier hs-var">guts</span></a><span>
</span><a name="line-422"></a><span>
</span><a name="line-423"></a><span class="hs-identifier">doCorePass</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreToDo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreM</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span>
</span><a name="line-424"></a><a name="doCorePass"><a href="SimplCore.html#doCorePass"><span class="hs-identifier">doCorePass</span></a></a><span> </span><a name="local-6989586621684380572"><a href="#local-6989586621684380572"><span class="hs-identifier">pass</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoreDoSimplify</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;Simplify&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-425"></a><span>                                       </span><a href="SimplCore.html#simplifyPgm"><span class="hs-identifier hs-var">simplifyPgm</span></a><span> </span><a href="#local-6989586621684380572"><span class="hs-identifier hs-var">pass</span></a><span>
</span><a name="line-426"></a><span>
</span><a name="line-427"></a><span class="hs-identifier">doCorePass</span><span> </span><span class="hs-identifier hs-var">CoreCSE</span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;CommonSubExpr&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-428"></a><span>                                       </span><a href="SimplCore.html#doPass"><span class="hs-identifier hs-var">doPass</span></a><span> </span><a href="CSE.html#cseProgram"><span class="hs-identifier hs-var">cseProgram</span></a><span>
</span><a name="line-429"></a><span>
</span><a name="line-430"></a><span class="hs-identifier">doCorePass</span><span> </span><span class="hs-identifier hs-var">CoreLiberateCase</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;LiberateCase&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-431"></a><span>                                       </span><a href="SimplCore.html#doPassD"><span class="hs-identifier hs-var">doPassD</span></a><span> </span><a href="LiberateCase.html#liberateCase"><span class="hs-identifier hs-var">liberateCase</span></a><span>
</span><a name="line-432"></a><span>
</span><a name="line-433"></a><span class="hs-identifier">doCorePass</span><span> </span><span class="hs-identifier hs-var">CoreDoFloatInwards</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;FloatInwards&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-434"></a><span>                                       </span><a href="FloatIn.html#floatInwards"><span class="hs-identifier hs-var">floatInwards</span></a><span>
</span><a name="line-435"></a><span>
</span><a name="line-436"></a><span class="hs-identifier">doCorePass</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoreDoFloatOutwards</span><span> </span><a name="local-6989586621684380573"><a href="#local-6989586621684380573"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;FloatOutwards&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-437"></a><span>                                       </span><a href="SimplCore.html#doPassDUM"><span class="hs-identifier hs-var">doPassDUM</span></a><span> </span><span class="hs-special">(</span><a href="FloatOut.html#floatOutwards"><span class="hs-identifier hs-var">floatOutwards</span></a><span> </span><a href="#local-6989586621684380573"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-438"></a><span>
</span><a name="line-439"></a><span class="hs-identifier">doCorePass</span><span> </span><span class="hs-identifier hs-var">CoreDoStaticArgs</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;StaticArgs&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-440"></a><span>                                       </span><a href="SimplCore.html#doPassU"><span class="hs-identifier hs-var">doPassU</span></a><span> </span><a href="SAT.html#doStaticArgs"><span class="hs-identifier hs-var">doStaticArgs</span></a><span>
</span><a name="line-441"></a><span>
</span><a name="line-442"></a><span class="hs-identifier">doCorePass</span><span> </span><span class="hs-identifier hs-var">CoreDoCallArity</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;CallArity&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-443"></a><span>                                       </span><a href="SimplCore.html#doPassD"><span class="hs-identifier hs-var">doPassD</span></a><span> </span><a href="CallArity.html#callArityAnalProgram"><span class="hs-identifier hs-var">callArityAnalProgram</span></a><span>
</span><a name="line-444"></a><span>
</span><a name="line-445"></a><span class="hs-identifier">doCorePass</span><span> </span><span class="hs-identifier hs-var">CoreDoExitify</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;Exitify&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-446"></a><span>                                       </span><a href="SimplCore.html#doPass"><span class="hs-identifier hs-var">doPass</span></a><span> </span><a href="Exitify.html#exitifyProgram"><span class="hs-identifier hs-var">exitifyProgram</span></a><span>
</span><a name="line-447"></a><span>
</span><a name="line-448"></a><span class="hs-identifier">doCorePass</span><span> </span><span class="hs-identifier hs-var">CoreDoStrictness</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;NewStranal&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-449"></a><span>                                       </span><a href="SimplCore.html#doPassDFM"><span class="hs-identifier hs-var">doPassDFM</span></a><span> </span><a href="DmdAnal.html#dmdAnalProgram"><span class="hs-identifier hs-var">dmdAnalProgram</span></a><span>
</span><a name="line-450"></a><span>
</span><a name="line-451"></a><span class="hs-identifier">doCorePass</span><span> </span><span class="hs-identifier hs-var">CoreDoWorkerWrapper</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;WorkWrap&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-452"></a><span>                                       </span><a href="SimplCore.html#doPassDFU"><span class="hs-identifier hs-var">doPassDFU</span></a><span> </span><a href="WorkWrap.html#wwTopBinds"><span class="hs-identifier hs-var">wwTopBinds</span></a><span>
</span><a name="line-453"></a><span>
</span><a name="line-454"></a><span class="hs-identifier">doCorePass</span><span> </span><span class="hs-identifier hs-var">CoreDoSpecialising</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;Specialise&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-455"></a><span>                                       </span><a href="Specialise.html#specProgram"><span class="hs-identifier hs-var">specProgram</span></a><span>
</span><a name="line-456"></a><span>
</span><a name="line-457"></a><span class="hs-identifier">doCorePass</span><span> </span><span class="hs-identifier hs-var">CoreDoSpecConstr</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;SpecConstr&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-458"></a><span>                                       </span><a href="SpecConstr.html#specConstrProgram"><span class="hs-identifier hs-var">specConstrProgram</span></a><span>
</span><a name="line-459"></a><span>
</span><a name="line-460"></a><span class="hs-identifier">doCorePass</span><span> </span><span class="hs-identifier hs-var">CoreDoPrintCore</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="SimplCore.html#observe"><span class="hs-identifier hs-var">observe</span></a><span>   </span><a href="SimplCore.html#printCore"><span class="hs-identifier hs-var">printCore</span></a><span>
</span><a name="line-461"></a><span class="hs-identifier">doCorePass</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoreDoRuleCheck</span><span> </span><a name="local-6989586621684380574"><a href="#local-6989586621684380574"><span class="hs-identifier">phase</span></a></a><span> </span><a name="local-6989586621684380575"><a href="#local-6989586621684380575"><span class="hs-identifier">pat</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SimplCore.html#ruleCheckPass"><span class="hs-identifier hs-var">ruleCheckPass</span></a><span> </span><a href="#local-6989586621684380574"><span class="hs-identifier hs-var">phase</span></a><span> </span><a href="#local-6989586621684380575"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-462"></a><span class="hs-identifier">doCorePass</span><span> </span><span class="hs-identifier hs-var">CoreDoNothing</span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span>
</span><a name="line-463"></a><span class="hs-identifier">doCorePass</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoreDoPasses</span><span> </span><a name="local-6989586621684380576"><a href="#local-6989586621684380576"><span class="hs-identifier">passes</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="SimplCore.html#runCorePasses"><span class="hs-identifier hs-var">runCorePasses</span></a><span> </span><a href="#local-6989586621684380576"><span class="hs-identifier hs-var">passes</span></a><span>
</span><a name="line-464"></a><span>
</span><a name="line-465"></a><span class="hs-cpp">#if defined(GHCI)
</span><span class="hs-identifier">doCorePass</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoreDoPluginPass</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684380577"><a href="#local-6989586621684380577"><span class="hs-identifier">pass</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;Plugin&quot;</span><span> </span><span class="hs-pragma">#-}</span><span> </span><a href="#local-6989586621684380577"><span class="hs-identifier hs-var">pass</span></a><span>
</span><a name="line-467"></a><span class="hs-cpp">#else
</span><span class="hs-identifier">doCorePass</span><span> </span><span class="hs-identifier">pass</span><span class="hs-glyph">@</span><span class="hs-identifier">CoreDoPluginPass</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">pprPanic</span><span> </span><span class="hs-string">&quot;doCorePass&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">pass</span><span class="hs-special">)</span><span>
</span><a name="line-469"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-471"></a><span class="hs-identifier">doCorePass</span><span> </span><a name="local-6989586621684380578"><a href="#local-6989586621684380578"><span class="hs-identifier">pass</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">CoreDesugar</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;doCorePass&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684380578"><span class="hs-identifier hs-var">pass</span></a><span class="hs-special">)</span><span>
</span><a name="line-472"></a><span class="hs-identifier">doCorePass</span><span> </span><a name="local-6989586621684380579"><a href="#local-6989586621684380579"><span class="hs-identifier">pass</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">CoreDesugarOpt</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;doCorePass&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684380579"><span class="hs-identifier hs-var">pass</span></a><span class="hs-special">)</span><span>
</span><a name="line-473"></a><span class="hs-identifier">doCorePass</span><span> </span><a name="local-6989586621684380580"><a href="#local-6989586621684380580"><span class="hs-identifier">pass</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">CoreTidy</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;doCorePass&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684380580"><span class="hs-identifier hs-var">pass</span></a><span class="hs-special">)</span><span>
</span><a name="line-474"></a><span class="hs-identifier">doCorePass</span><span> </span><a name="local-6989586621684380581"><a href="#local-6989586621684380581"><span class="hs-identifier">pass</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">CorePrep</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;doCorePass&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684380581"><span class="hs-identifier hs-var">pass</span></a><span class="hs-special">)</span><span>
</span><a name="line-475"></a><span class="hs-identifier">doCorePass</span><span> </span><a name="local-6989586621684380582"><a href="#local-6989586621684380582"><span class="hs-identifier">pass</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">CoreOccurAnal</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;doCorePass&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684380582"><span class="hs-identifier hs-var">pass</span></a><span class="hs-special">)</span><span>
</span><a name="line-476"></a><span>
</span><a name="line-477"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Core pass combinators}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-484"></a><span>
</span><a name="line-485"></a><span class="hs-identifier">printCore</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-486"></a><a name="printCore"><a href="SimplCore.html#printCore"><span class="hs-identifier">printCore</span></a></a><span> </span><a name="local-6989586621684380583"><a href="#local-6989586621684380583"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684380584"><a href="#local-6989586621684380584"><span class="hs-identifier">binds</span></a></a><span>
</span><a name="line-487"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Err.dumpIfSet</span><span> </span><a href="#local-6989586621684380583"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-string">&quot;Print Core&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprCoreBindings</span><span> </span><a href="#local-6989586621684380584"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-488"></a><span>
</span><a name="line-489"></a><span class="hs-identifier">ruleCheckPass</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CompilerPhase</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreM</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span>
</span><a name="line-490"></a><a name="ruleCheckPass"><a href="SimplCore.html#ruleCheckPass"><span class="hs-identifier">ruleCheckPass</span></a></a><span> </span><a name="local-6989586621684380585"><a href="#local-6989586621684380585"><span class="hs-identifier">current_phase</span></a></a><span> </span><a name="local-6989586621684380586"><a href="#local-6989586621684380586"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621684380587"><a href="#local-6989586621684380587"><span class="hs-identifier">guts</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-491"></a><span>    </span><span class="hs-identifier hs-var">withTiming</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-492"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;RuleCheck&quot;</span><span class="hs-operator hs-var">&lt;+&gt;</span><span class="hs-identifier hs-var">brackets</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">mg_module</span><span> </span><a href="#local-6989586621684380587"><span class="hs-identifier hs-var">guts</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-493"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-494"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684380588"><a href="#local-6989586621684380588"><span class="hs-identifier">rb</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getRuleBase</span><span>
</span><a name="line-495"></a><span>    </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684380589"><a href="#local-6989586621684380589"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-496"></a><span>    </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684380590"><a href="#local-6989586621684380590"><span class="hs-identifier">vis_orphs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getVisibleOrphanMods</span><span>
</span><a name="line-497"></a><span>    </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684380591"><a href="#local-6989586621684380591"><span class="hs-identifier">rule_fn</span></a></a><span> </span><a name="local-6989586621684380592"><a href="#local-6989586621684380592"><span class="hs-identifier">fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getRules</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RuleEnv</span><span> </span><a href="#local-6989586621684380588"><span class="hs-identifier hs-var">rb</span></a><span> </span><a href="#local-6989586621684380590"><span class="hs-identifier hs-var">vis_orphs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684380592"><span class="hs-identifier hs-var">fn</span></a><span>
</span><a name="line-498"></a><span>                        </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mg_rules</span><span> </span><a href="#local-6989586621684380587"><span class="hs-identifier hs-var">guts</span></a><span class="hs-special">)</span><span>
</span><a name="line-499"></a><span>    </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">putLogMsg</span><span> </span><a href="#local-6989586621684380589"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">NoReason</span><span> </span><span class="hs-identifier hs-var">Err.SevDump</span><span> </span><span class="hs-identifier hs-var">noSrcSpan</span><span>
</span><a name="line-500"></a><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">defaultDumpStyle</span><span> </span><a href="#local-6989586621684380589"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-501"></a><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ruleCheckProgram</span><span> </span><a href="#local-6989586621684380585"><span class="hs-identifier hs-var">current_phase</span></a><span> </span><a href="#local-6989586621684380586"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-502"></a><span>                      </span><a href="#local-6989586621684380591"><span class="hs-identifier hs-var">rule_fn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mg_binds</span><span> </span><a href="#local-6989586621684380587"><span class="hs-identifier hs-var">guts</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-503"></a><span>    </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684380587"><span class="hs-identifier hs-var">guts</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-504"></a><span>
</span><a name="line-505"></a><span class="hs-identifier">doPassDUM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreM</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span>
</span><a name="line-506"></a><a name="doPassDUM"><a href="SimplCore.html#doPassDUM"><span class="hs-identifier">doPassDUM</span></a></a><span> </span><a name="local-6989586621684380593"><a href="#local-6989586621684380593"><span class="hs-identifier">do_pass</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplCore.html#doPassM"><span class="hs-identifier hs-var">doPassM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621684380594"><a href="#local-6989586621684380594"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-507"></a><span>    </span><a name="local-6989586621684380595"><a href="#local-6989586621684380595"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-508"></a><span>    </span><a name="local-6989586621684380596"><a href="#local-6989586621684380596"><span class="hs-identifier">us</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getUniqueSupplyM</span><span>
</span><a name="line-509"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684380593"><span class="hs-identifier hs-var">do_pass</span></a><span> </span><a href="#local-6989586621684380595"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684380596"><span class="hs-identifier hs-var">us</span></a><span> </span><a href="#local-6989586621684380594"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-510"></a><span>
</span><a name="line-511"></a><span class="hs-identifier">doPassDM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreM</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span>
</span><a name="line-512"></a><a name="doPassDM"><a href="SimplCore.html#doPassDM"><span class="hs-identifier">doPassDM</span></a></a><span> </span><a name="local-6989586621684380597"><a href="#local-6989586621684380597"><span class="hs-identifier">do_pass</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplCore.html#doPassDUM"><span class="hs-identifier hs-var">doPassDUM</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684380598"><a href="#local-6989586621684380598"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684380597"><span class="hs-identifier hs-var">do_pass</span></a><span> </span><a href="#local-6989586621684380598"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-513"></a><span>
</span><a name="line-514"></a><span class="hs-identifier">doPassD</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreM</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span>
</span><a name="line-515"></a><a name="doPassD"><a href="SimplCore.html#doPassD"><span class="hs-identifier">doPassD</span></a></a><span> </span><a name="local-6989586621684380599"><a href="#local-6989586621684380599"><span class="hs-identifier">do_pass</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplCore.html#doPassDM"><span class="hs-identifier hs-var">doPassDM</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684380600"><a href="#local-6989586621684380600"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621684380599"><span class="hs-identifier hs-var">do_pass</span></a><span> </span><a href="#local-6989586621684380600"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-516"></a><span>
</span><a name="line-517"></a><span class="hs-identifier">doPassDU</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreM</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span>
</span><a name="line-518"></a><a name="doPassDU"><a href="SimplCore.html#doPassDU"><span class="hs-identifier">doPassDU</span></a></a><span> </span><a name="local-6989586621684380601"><a href="#local-6989586621684380601"><span class="hs-identifier">do_pass</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplCore.html#doPassDUM"><span class="hs-identifier hs-var">doPassDUM</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684380602"><a href="#local-6989586621684380602"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684380603"><a href="#local-6989586621684380603"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621684380601"><span class="hs-identifier hs-var">do_pass</span></a><span> </span><a href="#local-6989586621684380602"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684380603"><span class="hs-identifier hs-var">us</span></a><span class="hs-special">)</span><span>
</span><a name="line-519"></a><span>
</span><a name="line-520"></a><span class="hs-identifier">doPassU</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">UniqSupply</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreM</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span>
</span><a name="line-521"></a><a name="doPassU"><a href="SimplCore.html#doPassU"><span class="hs-identifier">doPassU</span></a></a><span> </span><a name="local-6989586621684380604"><a href="#local-6989586621684380604"><span class="hs-identifier">do_pass</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplCore.html#doPassDU"><span class="hs-identifier hs-var">doPassDU</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><a href="#local-6989586621684380604"><span class="hs-identifier hs-var">do_pass</span></a><span class="hs-special">)</span><span>
</span><a name="line-522"></a><span>
</span><a name="line-523"></a><span class="hs-identifier">doPassDFM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FamInstEnvs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreM</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span>
</span><a name="line-524"></a><a name="doPassDFM"><a href="SimplCore.html#doPassDFM"><span class="hs-identifier">doPassDFM</span></a></a><span> </span><a name="local-6989586621684380605"><a href="#local-6989586621684380605"><span class="hs-identifier">do_pass</span></a></a><span> </span><a name="local-6989586621684380606"><a href="#local-6989586621684380606"><span class="hs-identifier">guts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-525"></a><span>    </span><a name="local-6989586621684380607"><a href="#local-6989586621684380607"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-526"></a><span>    </span><a name="local-6989586621684380608"><a href="#local-6989586621684380608"><span class="hs-identifier">p_fam_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getPackageFamInstEnv</span><span>
</span><a name="line-527"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684380609"><a href="#local-6989586621684380609"><span class="hs-identifier">fam_envs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684380608"><span class="hs-identifier hs-var">p_fam_env</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_fam_inst_env</span><span> </span><a href="#local-6989586621684380606"><span class="hs-identifier hs-var">guts</span></a><span class="hs-special">)</span><span>
</span><a name="line-528"></a><span>    </span><a href="SimplCore.html#doPassM"><span class="hs-identifier hs-var">doPassM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621684380605"><span class="hs-identifier hs-var">do_pass</span></a><span> </span><a href="#local-6989586621684380607"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684380609"><span class="hs-identifier hs-var">fam_envs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684380606"><span class="hs-identifier hs-var">guts</span></a><span>
</span><a name="line-529"></a><span>
</span><a name="line-530"></a><span class="hs-identifier">doPassDFU</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FamInstEnvs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreM</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span>
</span><a name="line-531"></a><a name="doPassDFU"><a href="SimplCore.html#doPassDFU"><span class="hs-identifier">doPassDFU</span></a></a><span> </span><a name="local-6989586621684380610"><a href="#local-6989586621684380610"><span class="hs-identifier">do_pass</span></a></a><span> </span><a name="local-6989586621684380611"><a href="#local-6989586621684380611"><span class="hs-identifier">guts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-532"></a><span>    </span><a name="local-6989586621684380612"><a href="#local-6989586621684380612"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-533"></a><span>    </span><a name="local-6989586621684380613"><a href="#local-6989586621684380613"><span class="hs-identifier">us</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getUniqueSupplyM</span><span>
</span><a name="line-534"></a><span>    </span><a name="local-6989586621684380614"><a href="#local-6989586621684380614"><span class="hs-identifier">p_fam_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getPackageFamInstEnv</span><span>
</span><a name="line-535"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684380615"><a href="#local-6989586621684380615"><span class="hs-identifier">fam_envs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684380614"><span class="hs-identifier hs-var">p_fam_env</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_fam_inst_env</span><span> </span><a href="#local-6989586621684380611"><span class="hs-identifier hs-var">guts</span></a><span class="hs-special">)</span><span>
</span><a name="line-536"></a><span>    </span><a href="SimplCore.html#doPass"><span class="hs-identifier hs-var">doPass</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684380610"><span class="hs-identifier hs-var">do_pass</span></a><span> </span><a href="#local-6989586621684380612"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684380615"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><a href="#local-6989586621684380613"><span class="hs-identifier hs-var">us</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684380611"><span class="hs-identifier hs-var">guts</span></a><span>
</span><a name="line-537"></a><span>
</span><a name="line-538"></a><span class="hs-comment">-- Most passes return no stats and don't change rules: these combinators</span><span>
</span><a name="line-539"></a><span class="hs-comment">-- let us lift them to the full blown ModGuts+CoreM world</span><span>
</span><a name="line-540"></a><span class="hs-identifier">doPassM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621684380500"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CoreProgram</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684380500"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684380500"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">ModGuts</span><span>
</span><a name="line-541"></a><a name="doPassM"><a href="SimplCore.html#doPassM"><span class="hs-identifier">doPassM</span></a></a><span> </span><a name="local-6989586621684380616"><a href="#local-6989586621684380616"><span class="hs-identifier">bind_f</span></a></a><span> </span><a name="local-6989586621684380617"><a href="#local-6989586621684380617"><span class="hs-identifier">guts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-542"></a><span>    </span><a name="local-6989586621684380618"><a href="#local-6989586621684380618"><span class="hs-identifier">binds'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684380616"><span class="hs-identifier hs-var">bind_f</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mg_binds</span><span> </span><a href="#local-6989586621684380617"><span class="hs-identifier hs-var">guts</span></a><span class="hs-special">)</span><span>
</span><a name="line-543"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684380617"><span class="hs-identifier hs-var">guts</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mg_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684380618"><span class="hs-identifier hs-var">binds'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-544"></a><span>
</span><a name="line-545"></a><span class="hs-identifier">doPass</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CoreProgram</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreM</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span>
</span><a name="line-546"></a><a name="doPass"><a href="SimplCore.html#doPass"><span class="hs-identifier">doPass</span></a></a><span> </span><a name="local-6989586621684380619"><a href="#local-6989586621684380619"><span class="hs-identifier">bind_f</span></a></a><span> </span><a name="local-6989586621684380620"><a href="#local-6989586621684380620"><span class="hs-identifier">guts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684380620"><span class="hs-identifier hs-var">guts</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mg_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684380619"><span class="hs-identifier hs-var">bind_f</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mg_binds</span><span> </span><a href="#local-6989586621684380620"><span class="hs-identifier hs-var">guts</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-547"></a><span>
</span><a name="line-548"></a><span class="hs-comment">-- Observer passes just peek; don't modify the bindings at all</span><span>
</span><a name="line-549"></a><span class="hs-identifier">observe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621684380499"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreM</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span>
</span><a name="line-550"></a><a name="observe"><a href="SimplCore.html#observe"><span class="hs-identifier">observe</span></a></a><span> </span><a name="local-6989586621684380621"><a href="#local-6989586621684380621"><span class="hs-identifier">do_pass</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplCore.html#doPassM"><span class="hs-identifier hs-var">doPassM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621684380622"><a href="#local-6989586621684380622"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-551"></a><span>    </span><a name="local-6989586621684380623"><a href="#local-6989586621684380623"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-552"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684380621"><span class="hs-identifier hs-var">do_pass</span></a><span> </span><a href="#local-6989586621684380623"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684380622"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-553"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684380622"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-554"></a><span>
</span><a name="line-555"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Gentle simplification
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-562"></a><span>
</span><a name="line-563"></a><span class="hs-identifier">simplifyExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-comment">-- includes spec of what core-to-core passes to do</span><span>
</span><a name="line-564"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-565"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-566"></a><span class="hs-comment">-- simplifyExpr is called by the driver to simplify an</span><span>
</span><a name="line-567"></a><span class="hs-comment">-- expression typed in at the interactive prompt</span><span>
</span><a name="line-568"></a><span class="hs-comment">--</span><span>
</span><a name="line-569"></a><span class="hs-comment">-- Also used by Template Haskell</span><span>
</span><a name="line-570"></a><a name="simplifyExpr"><a href="SimplCore.html#simplifyExpr"><span class="hs-identifier">simplifyExpr</span></a></a><span> </span><a name="local-6989586621684380624"><a href="#local-6989586621684380624"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684380625"><a href="#local-6989586621684380625"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-571"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withTiming</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621684380624"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Simplify [expr]&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-572"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span>
</span><a name="line-573"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684380626"><a href="#local-6989586621684380626"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>  </span><span class="hs-identifier hs-var">mkSplitUniqSupply</span><span> </span><span class="hs-char">'s'</span><span>
</span><a name="line-574"></a><span>
</span><a name="line-575"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684380627"><a href="#local-6989586621684380627"><span class="hs-identifier">sz</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">exprSize</span><span> </span><a href="#local-6989586621684380625"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-576"></a><span>
</span><a name="line-577"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684380628"><a href="#local-6989586621684380628"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684380629"><a href="#local-6989586621684380629"><span class="hs-identifier">counts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SimplMonad.html#initSmpl"><span class="hs-identifier hs-var">initSmpl</span></a><span> </span><a href="#local-6989586621684380624"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">emptyRuleEnv</span><span>
</span><a name="line-578"></a><span>                               </span><span class="hs-identifier hs-var">emptyFamInstEnvs</span><span> </span><a href="#local-6989586621684380626"><span class="hs-identifier hs-var">us</span></a><span> </span><a href="#local-6989586621684380627"><span class="hs-identifier hs-var">sz</span></a><span>
</span><a name="line-579"></a><span>                               </span><span class="hs-special">(</span><a href="SimplCore.html#simplExprGently"><span class="hs-identifier hs-var">simplExprGently</span></a><span> </span><span class="hs-special">(</span><a href="SimplUtils.html#simplEnvForGHCi"><span class="hs-identifier hs-var">simplEnvForGHCi</span></a><span> </span><a href="#local-6989586621684380624"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684380625"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-580"></a><span>
</span><a name="line-581"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">Err.dumpIfSet</span><span> </span><a href="#local-6989586621684380624"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dopt</span><span> </span><span class="hs-identifier hs-var">Opt_D_dump_simpl_stats</span><span> </span><a href="#local-6989586621684380624"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-582"></a><span>                  </span><span class="hs-string">&quot;Simplifier statistics&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprSimplCount</span><span> </span><a href="#local-6989586621684380629"><span class="hs-identifier hs-var">counts</span></a><span class="hs-special">)</span><span>
</span><a name="line-583"></a><span>
</span><a name="line-584"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">Err.dumpIfSet_dyn</span><span> </span><a href="#local-6989586621684380624"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_simpl</span><span> </span><span class="hs-string">&quot;Simplified expression&quot;</span><span>
</span><a name="line-585"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprCoreExpr</span><span> </span><a href="#local-6989586621684380628"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">)</span><span>
</span><a name="line-586"></a><span>
</span><a name="line-587"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684380628"><span class="hs-identifier hs-var">expr'</span></a><span>
</span><a name="line-588"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-589"></a><span>
</span><a name="line-590"></a><span class="hs-identifier">simplExprGently</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-591"></a><span class="hs-comment">-- Simplifies an expression</span><span>
</span><a name="line-592"></a><span class="hs-comment">--      does occurrence analysis, then simplification</span><span>
</span><a name="line-593"></a><span class="hs-comment">--      and repeats (twice currently) because one pass</span><span>
</span><a name="line-594"></a><span class="hs-comment">--      alone leaves tons of crud.</span><span>
</span><a name="line-595"></a><span class="hs-comment">-- Used (a) for user expressions typed in at the interactive prompt</span><span>
</span><a name="line-596"></a><span class="hs-comment">--      (b) the LHS and RHS of a RULE</span><span>
</span><a name="line-597"></a><span class="hs-comment">--      (c) Template Haskell splices</span><span>
</span><a name="line-598"></a><span class="hs-comment">--</span><span>
</span><a name="line-599"></a><span class="hs-comment">-- The name 'Gently' suggests that the SimplMode is SimplGently,</span><span>
</span><a name="line-600"></a><span class="hs-comment">-- and in fact that is so.... but the 'Gently' in simplExprGently doesn't</span><span>
</span><a name="line-601"></a><span class="hs-comment">-- enforce that; it just simplifies the expression twice</span><span>
</span><a name="line-602"></a><span>
</span><a name="line-603"></a><span class="hs-comment">-- It's important that simplExprGently does eta reduction; see</span><span>
</span><a name="line-604"></a><span class="hs-comment">-- Note [Simplifying the left-hand side of a RULE] above.  The</span><span>
</span><a name="line-605"></a><span class="hs-comment">-- simplifier does indeed do eta reduction (it's in Simplify.completeLam)</span><span>
</span><a name="line-606"></a><span class="hs-comment">-- but only if -O is on.</span><span>
</span><a name="line-607"></a><span>
</span><a name="line-608"></a><a name="simplExprGently"><a href="SimplCore.html#simplExprGently"><span class="hs-identifier">simplExprGently</span></a></a><span> </span><a name="local-6989586621684380630"><a href="#local-6989586621684380630"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684380631"><a href="#local-6989586621684380631"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-609"></a><span>    </span><a name="local-6989586621684380632"><a href="#local-6989586621684380632"><span class="hs-identifier">expr1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a><span> </span><a href="#local-6989586621684380630"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">occurAnalyseExpr</span><span> </span><a href="#local-6989586621684380631"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-610"></a><span>    </span><a href="Simplify.html#simplExpr"><span class="hs-identifier hs-var">simplExpr</span></a><span> </span><a href="#local-6989586621684380630"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">occurAnalyseExpr</span><span> </span><a href="#local-6989586621684380632"><span class="hs-identifier hs-var">expr1</span></a><span class="hs-special">)</span><span>
</span><a name="line-611"></a><span>
</span><a name="line-612"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{The driver for the simplifier}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-619"></a><span>
</span><a name="line-620"></a><span class="hs-identifier">simplifyPgm</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreToDo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreM</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span>
</span><a name="line-621"></a><a name="simplifyPgm"><a href="SimplCore.html#simplifyPgm"><span class="hs-identifier">simplifyPgm</span></a></a><span> </span><a name="local-6989586621684380633"><a href="#local-6989586621684380633"><span class="hs-identifier">pass</span></a></a><span> </span><a name="local-6989586621684380634"><a href="#local-6989586621684380634"><span class="hs-identifier">guts</span></a></a><span>
</span><a name="line-622"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684380635"><a href="#local-6989586621684380635"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getHscEnv</span><span>
</span><a name="line-623"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684380636"><a href="#local-6989586621684380636"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getUniqueSupplyM</span><span>
</span><a name="line-624"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684380637"><a href="#local-6989586621684380637"><span class="hs-identifier">rb</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getRuleBase</span><span>
</span><a name="line-625"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">liftIOWithCount</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-626"></a><span>         </span><a href="SimplCore.html#simplifyPgmIO"><span class="hs-identifier hs-var">simplifyPgmIO</span></a><span> </span><a href="#local-6989586621684380633"><span class="hs-identifier hs-var">pass</span></a><span> </span><a href="#local-6989586621684380635"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684380636"><span class="hs-identifier hs-var">us</span></a><span> </span><a href="#local-6989586621684380637"><span class="hs-identifier hs-var">rb</span></a><span> </span><a href="#local-6989586621684380634"><span class="hs-identifier hs-var">guts</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-627"></a><span>
</span><a name="line-628"></a><span class="hs-identifier">simplifyPgmIO</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreToDo</span><span>
</span><a name="line-629"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-630"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span>
</span><a name="line-631"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RuleBase</span><span>
</span><a name="line-632"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span>
</span><a name="line-633"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SimplCount</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- New bindings</span><span>
</span><a name="line-634"></a><span>
</span><a name="line-635"></a><a name="simplifyPgmIO"><a href="SimplCore.html#simplifyPgmIO"><span class="hs-identifier">simplifyPgmIO</span></a></a><span> </span><a name="local-6989586621684380638"><a href="#local-6989586621684380638"><span class="hs-identifier">pass</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoreDoSimplify</span><span> </span><a name="local-6989586621684380639"><a href="#local-6989586621684380639"><span class="hs-identifier">max_iterations</span></a></a><span> </span><a name="local-6989586621684380640"><a href="#local-6989586621684380640"><span class="hs-identifier">mode</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-636"></a><span>              </span><a name="local-6989586621684380641"><a href="#local-6989586621684380641"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684380642"><a href="#local-6989586621684380642"><span class="hs-identifier">us</span></a></a><span> </span><a name="local-6989586621684380643"><a href="#local-6989586621684380643"><span class="hs-identifier">hpt_rule_base</span></a></a><span>
</span><a name="line-637"></a><span>              </span><a name="local-6989586621684380644"><a href="#local-6989586621684380644"><span class="hs-identifier">guts</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">ModGuts</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mg_module</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684380645"><a href="#local-6989586621684380645"><span class="hs-identifier">this_mod</span></a></a><span>
</span><a name="line-638"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_rdr_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684380646"><a href="#local-6989586621684380646"><span class="hs-identifier">rdr_env</span></a></a><span>
</span><a name="line-639"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_deps</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684380647"><a href="#local-6989586621684380647"><span class="hs-identifier">deps</span></a></a><span>
</span><a name="line-640"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684380648"><a href="#local-6989586621684380648"><span class="hs-identifier">binds</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_rules</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684380649"><a href="#local-6989586621684380649"><span class="hs-identifier">rules</span></a></a><span>
</span><a name="line-641"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_fam_inst_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684380650"><a href="#local-6989586621684380650"><span class="hs-identifier">fam_inst_env</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-642"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684380681"><a href="#local-6989586621684380681"><span class="hs-identifier">termination_msg</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684380682"><a href="#local-6989586621684380682"><span class="hs-identifier">it_count</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684380683"><a href="#local-6989586621684380683"><span class="hs-identifier">counts_out</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684380684"><a href="#local-6989586621684380684"><span class="hs-identifier">guts'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-643"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684380656"><span class="hs-identifier hs-var">do_iteration</span></a><span> </span><a href="#local-6989586621684380642"><span class="hs-identifier hs-var">us</span></a><span> </span><span class="hs-number">1</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621684380648"><span class="hs-identifier hs-var">binds</span></a><span> </span><a href="#local-6989586621684380649"><span class="hs-identifier hs-var">rules</span></a><span>
</span><a name="line-644"></a><span>
</span><a name="line-645"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">Err.dumpIfSet</span><span> </span><a href="#local-6989586621684380651"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dopt</span><span> </span><span class="hs-identifier hs-var">Opt_D_verbose_core2core</span><span> </span><a href="#local-6989586621684380651"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-646"></a><span>                                </span><span class="hs-identifier hs-var">dopt</span><span> </span><span class="hs-identifier hs-var">Opt_D_dump_simpl_stats</span><span>  </span><a href="#local-6989586621684380651"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-647"></a><span>                  </span><span class="hs-string">&quot;Simplifier statistics for following pass&quot;</span><span>
</span><a name="line-648"></a><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621684380681"><span class="hs-identifier hs-var">termination_msg</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;after&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684380682"><span class="hs-identifier hs-var">it_count</span></a><span>
</span><a name="line-649"></a><span>                                              </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;iterations&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-650"></a><span>                         </span><span class="hs-identifier hs-var">blankLine</span><span class="hs-special">,</span><span>
</span><a name="line-651"></a><span>                         </span><span class="hs-identifier hs-var">pprSimplCount</span><span> </span><a href="#local-6989586621684380683"><span class="hs-identifier hs-var">counts_out</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-652"></a><span>
</span><a name="line-653"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684380683"><span class="hs-identifier hs-var">counts_out</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684380684"><span class="hs-identifier hs-var">guts'</span></a><span class="hs-special">)</span><span>
</span><a name="line-654"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-655"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-656"></a><span>    </span><a name="local-6989586621684380651"><a href="#local-6989586621684380651"><span class="hs-identifier">dflags</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621684380641"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-657"></a><span>    </span><a name="local-6989586621684380652"><a href="#local-6989586621684380652"><span class="hs-identifier">print_unqual</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkPrintUnqualified</span><span> </span><a href="#local-6989586621684380651"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684380646"><span class="hs-identifier hs-var">rdr_env</span></a><span>
</span><a name="line-658"></a><span>    </span><a name="local-6989586621684380653"><a href="#local-6989586621684380653"><span class="hs-identifier">simpl_env</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#mkSimplEnv"><span class="hs-identifier hs-var">mkSimplEnv</span></a><span> </span><a href="#local-6989586621684380640"><span class="hs-identifier hs-var">mode</span></a><span>
</span><a name="line-659"></a><span>    </span><a name="local-6989586621684380654"><a href="#local-6989586621684380654"><span class="hs-identifier">active_rule</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#activeRule"><span class="hs-identifier hs-var">activeRule</span></a><span> </span><a href="#local-6989586621684380640"><span class="hs-identifier hs-var">mode</span></a><span>
</span><a name="line-660"></a><span>    </span><a name="local-6989586621684380655"><a href="#local-6989586621684380655"><span class="hs-identifier">active_unf</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="SimplUtils.html#activeUnfolding"><span class="hs-identifier hs-var">activeUnfolding</span></a><span> </span><a href="#local-6989586621684380640"><span class="hs-identifier hs-var">mode</span></a><span>
</span><a name="line-661"></a><span>
</span><a name="line-662"></a><span>    </span><span class="hs-identifier">do_iteration</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span>
</span><a name="line-663"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>          </span><span class="hs-comment">-- Counts iterations</span><span>
</span><a name="line-664"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SimplCount</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- Counts from earlier iterations, reversed</span><span>
</span><a name="line-665"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span>  </span><span class="hs-comment">-- Bindings in</span><span>
</span><a name="line-666"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreRule</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- and orphan rules</span><span>
</span><a name="line-667"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SimplCount</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span class="hs-special">)</span><span>
</span><a name="line-668"></a><span>
</span><a name="line-669"></a><span>    </span><a name="local-6989586621684380656"><a href="#local-6989586621684380656"><span class="hs-identifier">do_iteration</span></a></a><span> </span><a name="local-6989586621684380657"><a href="#local-6989586621684380657"><span class="hs-identifier">us</span></a></a><span> </span><a name="local-6989586621684380658"><a href="#local-6989586621684380658"><span class="hs-identifier">iteration_no</span></a></a><span> </span><a name="local-6989586621684380659"><a href="#local-6989586621684380659"><span class="hs-identifier">counts_so_far</span></a></a><span> </span><a name="local-6989586621684380660"><a href="#local-6989586621684380660"><span class="hs-identifier">binds</span></a></a><span> </span><a name="local-6989586621684380661"><a href="#local-6989586621684380661"><span class="hs-identifier">rules</span></a></a><span>
</span><a name="line-670"></a><span>        </span><span class="hs-comment">-- iteration_no is the number of the iteration we are</span><span>
</span><a name="line-671"></a><span>        </span><span class="hs-comment">-- about to begin, with '1' for the first</span><span>
</span><a name="line-672"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684380658"><span class="hs-identifier hs-var">iteration_no</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621684380639"><span class="hs-identifier hs-var">max_iterations</span></a><span>   </span><span class="hs-comment">-- Stop if we've run out of iterations</span><span>
</span><a name="line-673"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">WARN</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">debugIsOn</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">max_iterations</span><span> </span><a href="#local-6989586621684380639"><span class="hs-operator hs-var">&gt;</span></a><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span>
</span><a name="line-674"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;Simplifier bailing out after&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">int</span><span> </span><span class="hs-identifier">max_iterations</span><span>
</span><a name="line-675"></a><span>                    </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;iterations&quot;</span><span>
</span><a name="line-676"></a><span>                    </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">brackets</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">hsep</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">punctuate</span><span> </span><span class="hs-identifier">comma</span><span> </span><span class="hs-operator">$</span><span>
</span><a name="line-677"></a><span>                         </span><span class="hs-identifier">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">int</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">simplCountN</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">reverse</span><span> </span><span class="hs-identifier">counts_so_far</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-678"></a><span>                 </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;Size =&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">coreBindsStats</span><span> </span><span class="hs-identifier">binds</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-679"></a><span>
</span><a name="line-680"></a><span>                </span><span class="hs-comment">-- Subtract 1 from iteration_no to get the</span><span>
</span><a name="line-681"></a><span>                </span><span class="hs-comment">-- number of iterations we actually completed</span><span>
</span><a name="line-682"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-string">&quot;Simplifier baled out&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684380658"><span class="hs-identifier hs-var">iteration_no</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-683"></a><span>               </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684380664"><span class="hs-identifier hs-var">totalise</span></a><span> </span><a href="#local-6989586621684380659"><span class="hs-identifier hs-var">counts_so_far</span></a><span>
</span><a name="line-684"></a><span>               </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684380644"><span class="hs-identifier hs-var">guts</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mg_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684380660"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_rules</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684380661"><span class="hs-identifier hs-var">rules</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-685"></a><span>
</span><a name="line-686"></a><span>      </span><span class="hs-comment">-- Try and force thunks off the binds; significantly reduces</span><span>
</span><a name="line-687"></a><span>      </span><span class="hs-comment">-- space usage, especially with -O.  JRS, 000620.</span><span>
</span><a name="line-688"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684380667"><a href="#local-6989586621684380667"><span class="hs-identifier">sz</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">coreBindsSize</span><span> </span><a href="#local-6989586621684380660"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-689"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684380667"><span class="hs-identifier hs-var">sz</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- Force it</span><span>
</span><a name="line-690"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-691"></a><span>                </span><span class="hs-comment">-- Occurrence analysis</span><span>
</span><a name="line-692"></a><span>           </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684380668"><a href="#local-6989586621684380668"><span class="hs-identifier">tagged_binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;OccAnal&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-693"></a><span>                     </span><span class="hs-identifier hs-var">occurAnalysePgm</span><span> </span><a href="#local-6989586621684380645"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684380655"><span class="hs-identifier hs-var">active_unf</span></a><span> </span><a href="#local-6989586621684380654"><span class="hs-identifier hs-var">active_rule</span></a><span> </span><a href="#local-6989586621684380661"><span class="hs-identifier hs-var">rules</span></a><span>
</span><a name="line-694"></a><span>                                     </span><a href="#local-6989586621684380660"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-695"></a><span>               </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-696"></a><span>           </span><span class="hs-identifier hs-var">Err.dumpIfSet_dyn</span><span> </span><a href="#local-6989586621684380651"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_occur_anal</span><span> </span><span class="hs-string">&quot;Occurrence analysis&quot;</span><span>
</span><a name="line-697"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprCoreBindings</span><span> </span><a href="#local-6989586621684380668"><span class="hs-identifier hs-var">tagged_binds</span></a><span class="hs-special">)</span><span class="hs-special">;</span><span>
</span><a name="line-698"></a><span>
</span><a name="line-699"></a><span>                </span><span class="hs-comment">-- Get any new rules, and extend the rule base</span><span>
</span><a name="line-700"></a><span>                </span><span class="hs-comment">-- See Note [Overall plumbing for rules] in Rules.hs</span><span>
</span><a name="line-701"></a><span>                </span><span class="hs-comment">-- We need to do this regularly, because simplification can</span><span>
</span><a name="line-702"></a><span>                </span><span class="hs-comment">-- poke on IdInfo thunks, which in turn brings in new rules</span><span>
</span><a name="line-703"></a><span>                </span><span class="hs-comment">-- behind the scenes.  Otherwise there's a danger we'll simply</span><span>
</span><a name="line-704"></a><span>                </span><span class="hs-comment">-- miss the rules for Ids hidden inside imported inlinings</span><span>
</span><a name="line-705"></a><span>           </span><a name="local-6989586621684380669"><a href="#local-6989586621684380669"><span class="hs-identifier">eps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">hscEPS</span><span> </span><a href="#local-6989586621684380641"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-706"></a><span>           </span><span class="hs-keyword">let</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684380670"><a href="#local-6989586621684380670"><span class="hs-identifier">rule_base1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unionRuleBase</span><span> </span><a href="#local-6989586621684380643"><span class="hs-identifier hs-var">hpt_rule_base</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_rule_base</span><span> </span><a href="#local-6989586621684380669"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span>
</span><a name="line-707"></a><span>                </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684380671"><a href="#local-6989586621684380671"><span class="hs-identifier">rule_base2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendRuleBaseList</span><span> </span><a href="#local-6989586621684380670"><span class="hs-identifier hs-var">rule_base1</span></a><span> </span><a href="#local-6989586621684380661"><span class="hs-identifier hs-var">rules</span></a><span>
</span><a name="line-708"></a><span>                </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684380672"><a href="#local-6989586621684380672"><span class="hs-identifier">fam_envs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_fam_inst_env</span><span> </span><a href="#local-6989586621684380669"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684380650"><span class="hs-identifier hs-var">fam_inst_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-709"></a><span>                </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684380673"><a href="#local-6989586621684380673"><span class="hs-identifier">vis_orphs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684380645"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">dep_orphs</span><span> </span><a href="#local-6989586621684380647"><span class="hs-identifier hs-var">deps</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-710"></a><span>
</span><a name="line-711"></a><span>                </span><span class="hs-comment">-- Simplify the program</span><span>
</span><a name="line-712"></a><span>           </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621684380677"><a href="#local-6989586621684380677"><span class="hs-identifier">binds1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684380678"><a href="#local-6989586621684380678"><span class="hs-identifier">rules1</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684380679"><a href="#local-6989586621684380679"><span class="hs-identifier">counts1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-713"></a><span>             </span><a href="SimplMonad.html#initSmpl"><span class="hs-identifier hs-var">initSmpl</span></a><span> </span><a href="#local-6989586621684380651"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkRuleEnv</span><span> </span><a href="#local-6989586621684380671"><span class="hs-identifier hs-var">rule_base2</span></a><span> </span><a href="#local-6989586621684380673"><span class="hs-identifier hs-var">vis_orphs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684380672"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><a href="#local-6989586621684380662"><span class="hs-identifier hs-var">us1</span></a><span> </span><a href="#local-6989586621684380667"><span class="hs-identifier hs-var">sz</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-714"></a><span>               </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684380674"><a href="#local-6989586621684380674"><span class="hs-identifier">floats</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684380675"><a href="#local-6989586621684380675"><span class="hs-identifier">env1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;SimplTopBinds&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-715"></a><span>                                      </span><a href="Simplify.html#simplTopBinds"><span class="hs-identifier hs-var">simplTopBinds</span></a><span> </span><a href="#local-6989586621684380653"><span class="hs-identifier hs-var">simpl_env</span></a><span> </span><a href="#local-6989586621684380668"><span class="hs-identifier hs-var">tagged_binds</span></a><span>
</span><a name="line-716"></a><span>
</span><a name="line-717"></a><span>                      </span><span class="hs-comment">-- Apply the substitution to rules defined in this module</span><span>
</span><a name="line-718"></a><span>                      </span><span class="hs-comment">-- for imported Ids.  Eg  RULE map my_f = blah</span><span>
</span><a name="line-719"></a><span>                      </span><span class="hs-comment">-- If we have a substitution my_f :-&gt; other_f, we'd better</span><span>
</span><a name="line-720"></a><span>                      </span><span class="hs-comment">-- apply it to the rule to, or it'll never match</span><span>
</span><a name="line-721"></a><span>                  </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684380676"><a href="#local-6989586621684380676"><span class="hs-identifier">rules1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Simplify.html#simplRules"><span class="hs-identifier hs-var">simplRules</span></a><span> </span><a href="#local-6989586621684380675"><span class="hs-identifier hs-var">env1</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621684380661"><span class="hs-identifier hs-var">rules</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-722"></a><span>
</span><a name="line-723"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#getTopFloatBinds"><span class="hs-identifier hs-var">getTopFloatBinds</span></a><span> </span><a href="#local-6989586621684380674"><span class="hs-identifier hs-var">floats</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684380676"><span class="hs-identifier hs-var">rules1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-724"></a><span>
</span><a name="line-725"></a><span>                </span><span class="hs-comment">-- Stop if nothing happened; don't dump output</span><span>
</span><a name="line-726"></a><span>                </span><span class="hs-comment">-- See Note [Which transformations are innocuous] in CoreMonad</span><span>
</span><a name="line-727"></a><span>           </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isZeroSimplCount</span><span> </span><a href="#local-6989586621684380679"><span class="hs-identifier hs-var">counts1</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-728"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-string">&quot;Simplifier reached fixed point&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684380658"><span class="hs-identifier hs-var">iteration_no</span></a><span>
</span><a name="line-729"></a><span>                       </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684380664"><span class="hs-identifier hs-var">totalise</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684380679"><span class="hs-identifier hs-var">counts1</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684380659"><span class="hs-identifier hs-var">counts_so_far</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Include &quot;free&quot; ticks</span><span>
</span><a name="line-730"></a><span>                       </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684380644"><span class="hs-identifier hs-var">guts</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mg_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684380677"><span class="hs-identifier hs-var">binds1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_rules</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684380678"><span class="hs-identifier hs-var">rules1</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-731"></a><span>           </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-732"></a><span>                </span><span class="hs-comment">-- Short out indirections</span><span>
</span><a name="line-733"></a><span>                </span><span class="hs-comment">-- We do this *after* at least one run of the simplifier</span><span>
</span><a name="line-734"></a><span>                </span><span class="hs-comment">-- because indirection-shorting uses the export flag on *occurrences*</span><span>
</span><a name="line-735"></a><span>                </span><span class="hs-comment">-- and that isn't guaranteed to be ok until after the first run propagates</span><span>
</span><a name="line-736"></a><span>                </span><span class="hs-comment">-- stuff from the binding site to its occurrences</span><span>
</span><a name="line-737"></a><span>                </span><span class="hs-comment">--</span><span>
</span><a name="line-738"></a><span>                </span><span class="hs-comment">-- ToDo: alas, this means that indirection-shorting does not happen at all</span><span>
</span><a name="line-739"></a><span>                </span><span class="hs-comment">--       if the simplifier does nothing (not common, I know, but unsavoury)</span><span>
</span><a name="line-740"></a><span>           </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684380680"><a href="#local-6989586621684380680"><span class="hs-identifier">binds2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;ZapInd&quot;</span><span> </span><span class="hs-pragma">#-}</span><span> </span><a href="SimplCore.html#shortOutIndirections"><span class="hs-identifier hs-var">shortOutIndirections</span></a><span> </span><a href="#local-6989586621684380677"><span class="hs-identifier hs-var">binds1</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-741"></a><span>
</span><a name="line-742"></a><span>                </span><span class="hs-comment">-- Dump the result of this iteration</span><span>
</span><a name="line-743"></a><span>           </span><a href="SimplCore.html#dump_end_iteration"><span class="hs-identifier hs-var">dump_end_iteration</span></a><span> </span><a href="#local-6989586621684380651"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684380652"><span class="hs-identifier hs-var">print_unqual</span></a><span> </span><a href="#local-6989586621684380658"><span class="hs-identifier hs-var">iteration_no</span></a><span> </span><a href="#local-6989586621684380679"><span class="hs-identifier hs-var">counts1</span></a><span> </span><a href="#local-6989586621684380680"><span class="hs-identifier hs-var">binds2</span></a><span> </span><a href="#local-6989586621684380678"><span class="hs-identifier hs-var">rules1</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-744"></a><span>           </span><a href="CoreLint.html#lintPassResult"><span class="hs-identifier hs-var">lintPassResult</span></a><span> </span><a href="#local-6989586621684380641"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684380638"><span class="hs-identifier hs-var">pass</span></a><span> </span><a href="#local-6989586621684380680"><span class="hs-identifier hs-var">binds2</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-745"></a><span>
</span><a name="line-746"></a><span>                </span><span class="hs-comment">-- Loop</span><span>
</span><a name="line-747"></a><span>           </span><a href="#local-6989586621684380656"><span class="hs-identifier hs-var">do_iteration</span></a><span> </span><a href="#local-6989586621684380663"><span class="hs-identifier hs-var">us2</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684380658"><span class="hs-identifier hs-var">iteration_no</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684380679"><span class="hs-identifier hs-var">counts1</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684380659"><span class="hs-identifier hs-var">counts_so_far</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684380680"><span class="hs-identifier hs-var">binds2</span></a><span> </span><a href="#local-6989586621684380678"><span class="hs-identifier hs-var">rules1</span></a><span>
</span><a name="line-748"></a><span>           </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-749"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;do_iteration&quot;</span><span>
</span><a name="line-750"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-751"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684380662"><a href="#local-6989586621684380662"><span class="hs-identifier">us1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684380663"><a href="#local-6989586621684380663"><span class="hs-identifier">us2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitUniqSupply</span><span> </span><a href="#local-6989586621684380657"><span class="hs-identifier hs-var">us</span></a><span>
</span><a name="line-752"></a><span>
</span><a name="line-753"></a><span>        </span><span class="hs-comment">-- Remember the counts_so_far are reversed</span><span>
</span><a name="line-754"></a><span>        </span><span class="hs-identifier">totalise</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SimplCount</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SimplCount</span><span>
</span><a name="line-755"></a><span>        </span><a name="local-6989586621684380664"><a href="#local-6989586621684380664"><span class="hs-identifier">totalise</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684380665"><a href="#local-6989586621684380665"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-6989586621684380666"><a href="#local-6989586621684380666"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684380666"><span class="hs-identifier hs-var">acc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusSimplCount</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684380665"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span>
</span><a name="line-756"></a><span>                         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zeroSimplCount</span><span> </span><a href="#local-6989586621684380651"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-757"></a><span>
</span><a name="line-758"></a><span class="hs-identifier">simplifyPgmIO</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;simplifyPgmIO&quot;</span><span>
</span><a name="line-759"></a><span>
</span><a name="line-760"></a><span class="hs-comment">-------------------</span><span>
</span><a name="line-761"></a><span class="hs-identifier">dump_end_iteration</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PrintUnqualified</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-762"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SimplCount</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreRule</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-763"></a><a name="dump_end_iteration"><a href="SimplCore.html#dump_end_iteration"><span class="hs-identifier">dump_end_iteration</span></a></a><span> </span><a name="local-6989586621684380685"><a href="#local-6989586621684380685"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684380686"><a href="#local-6989586621684380686"><span class="hs-identifier">print_unqual</span></a></a><span> </span><a name="local-6989586621684380687"><a href="#local-6989586621684380687"><span class="hs-identifier">iteration_no</span></a></a><span> </span><a name="local-6989586621684380688"><a href="#local-6989586621684380688"><span class="hs-identifier">counts</span></a></a><span> </span><a name="local-6989586621684380689"><a href="#local-6989586621684380689"><span class="hs-identifier">binds</span></a></a><span> </span><a name="local-6989586621684380690"><a href="#local-6989586621684380690"><span class="hs-identifier">rules</span></a></a><span>
</span><a name="line-764"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreLint.html#dumpPassResult"><span class="hs-identifier hs-var">dumpPassResult</span></a><span> </span><a href="#local-6989586621684380685"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684380686"><span class="hs-identifier hs-var">print_unqual</span></a><span> </span><a href="#local-6989586621684380691"><span class="hs-identifier hs-var">mb_flag</span></a><span> </span><a href="#local-6989586621684380692"><span class="hs-identifier hs-var">hdr</span></a><span> </span><a href="#local-6989586621684380693"><span class="hs-identifier hs-var">pp_counts</span></a><span> </span><a href="#local-6989586621684380689"><span class="hs-identifier hs-var">binds</span></a><span> </span><a href="#local-6989586621684380690"><span class="hs-identifier hs-var">rules</span></a><span>
</span><a name="line-765"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-766"></a><span>    </span><a name="local-6989586621684380691"><a href="#local-6989586621684380691"><span class="hs-identifier">mb_flag</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">dopt</span><span> </span><span class="hs-identifier hs-var">Opt_D_dump_simpl_iterations</span><span> </span><a href="#local-6989586621684380685"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">Opt_D_dump_simpl_iterations</span><span>
</span><a name="line-767"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-768"></a><span>            </span><span class="hs-comment">-- Show details if Opt_D_dump_simpl_iterations is on</span><span>
</span><a name="line-769"></a><span>
</span><a name="line-770"></a><span>    </span><a name="local-6989586621684380692"><a href="#local-6989586621684380692"><span class="hs-identifier">hdr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Simplifier iteration=&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">int</span><span> </span><a href="#local-6989586621684380687"><span class="hs-identifier hs-var">iteration_no</span></a><span>
</span><a name="line-771"></a><span>    </span><a name="local-6989586621684380693"><a href="#local-6989586621684380693"><span class="hs-identifier">pp_counts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;---- Simplifier counts for&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621684380692"><span class="hs-identifier hs-var">hdr</span></a><span>
</span><a name="line-772"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">pprSimplCount</span><span> </span><a href="#local-6989586621684380688"><span class="hs-identifier hs-var">counts</span></a><span>
</span><a name="line-773"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;---- End of simplifier counts for&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621684380692"><span class="hs-identifier hs-var">hdr</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-774"></a><span>
</span><a name="line-775"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Shorting out indirections
*                                                                      *
************************************************************************

If we have this:

        x_local = &lt;expression&gt;
        ...bindings...
        x_exported = x_local

where x_exported is exported, and x_local is not, then we replace it with this:

        x_exported = &lt;expression&gt;
        x_local = x_exported
        ...bindings...

Without this we never get rid of the x_exported = x_local thing.  This
save a gratuitous jump (from \tr{x_exported} to \tr{x_local}), and
makes strictness information propagate better.  This used to happen in
the final phase, but it's tidier to do it here.

Note [Messing up the exported Id's RULES]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We must be careful about discarding (obviously) or even merging the
RULES on the exported Id. The example that went bad on me at one stage
was this one:

    iterate :: (a -&gt; a) -&gt; a -&gt; [a]
        [Exported]
    iterate = iterateList

    iterateFB c f x = x `c` iterateFB c f (f x)
    iterateList f x =  x : iterateList f (f x)
        [Not exported]

    {-# RULES
    &quot;iterate&quot;   forall f x.     iterate f x = build (\c _n -&gt; iterateFB c f x)
    &quot;iterateFB&quot;                 iterateFB (:) = iterateList
     #-}

This got shorted out to:

    iterateList :: (a -&gt; a) -&gt; a -&gt; [a]
    iterateList = iterate

    iterateFB c f x = x `c` iterateFB c f (f x)
    iterate f x =  x : iterate f (f x)

    {-# RULES
    &quot;iterate&quot;   forall f x.     iterate f x = build (\c _n -&gt; iterateFB c f x)
    &quot;iterateFB&quot;                 iterateFB (:) = iterate
     #-}

And now we get an infinite loop in the rule system
        iterate f x -&gt; build (\cn -&gt; iterateFB c f x)
                    -&gt; iterateFB (:) f x
                    -&gt; iterate f x

Old &quot;solution&quot;:
        use rule switching-off pragmas to get rid
        of iterateList in the first place

But in principle the user *might* want rules that only apply to the Id
he says.  And inline pragmas are similar
   {-# NOINLINE f #-}
   f = local
   local = &lt;stuff&gt;
Then we do not want to get rid of the NOINLINE.

Hence hasShortableIdinfo.


Note [Rules and indirection-zapping]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Problem: what if x_exported has a RULE that mentions something in ...bindings...?
Then the things mentioned can be out of scope!  Solution
 a) Make sure that in this pass the usage-info from x_exported is
        available for ...bindings...
 b) If there are any such RULES, rec-ify the entire top-level.
    It'll get sorted out next time round

Other remarks
~~~~~~~~~~~~~
If more than one exported thing is equal to a local thing (i.e., the
local thing really is shared), then we do one only:
\begin{verbatim}
        x_local = ....
        x_exported1 = x_local
        x_exported2 = x_local
==&gt;
        x_exported1 = ....

        x_exported2 = x_exported1
\end{verbatim}

We rely on prior eta reduction to simplify things like
\begin{verbatim}
        x_exported = /\ tyvars -&gt; x_local tyvars
==&gt;
        x_exported = x_local
\end{verbatim}
Hence,there's a possibility of leaving unchanged something like this:
\begin{verbatim}
        x_local = ....
        x_exported1 = x_local Int
\end{verbatim}
By the time we've thrown away the types in STG land this
could be eliminated.  But I don't think it's very common
and it's dangerous to do this fiddling in STG land
because we might elminate a binding that's mentioned in the
unfolding for something.

Note [Indirection zapping and ticks]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Unfortunately this is another place where we need a special case for
ticks. The following happens quite regularly:

        x_local = &lt;expression&gt;
        x_exported = tick&lt;x&gt; x_local

Which we want to become:

        x_exported =  tick&lt;x&gt; &lt;expression&gt;

As it makes no sense to keep the tick and the expression on separate
bindings. Note however that that this might increase the ticks scoping
over the execution of x_local, so we can only do this for floatable
ticks. More often than not, other references will be unfoldings of
x_exported, and therefore carry the tick anyway.
-}</span><span>
</span><a name="line-908"></a><span>
</span><a name="line-909"></a><span class="hs-keyword">type</span><span> </span><a name="IndEnv"><a href="SimplCore.html#IndEnv"><span class="hs-identifier">IndEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">IdEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Tickish</span><span> </span><span class="hs-identifier hs-type">Var</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Maps local_id -&gt; exported_id, ticks</span><span>
</span><a name="line-910"></a><span>
</span><a name="line-911"></a><span class="hs-identifier">shortOutIndirections</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span>
</span><a name="line-912"></a><a name="shortOutIndirections"><a href="SimplCore.html#shortOutIndirections"><span class="hs-identifier">shortOutIndirections</span></a></a><span> </span><a name="local-6989586621684380694"><a href="#local-6989586621684380694"><span class="hs-identifier">binds</span></a></a><span>
</span><a name="line-913"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isEmptyVarEnv</span><span> </span><a href="#local-6989586621684380695"><span class="hs-identifier hs-var">ind_env</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684380694"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-914"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684380698"><span class="hs-identifier hs-var">no_need_to_flatten</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684380699"><span class="hs-identifier hs-var">binds'</span></a><span>                      </span><span class="hs-comment">-- See Note [Rules and indirect-zapping]</span><span>
</span><a name="line-915"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Rec</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flattenBinds</span><span> </span><a href="#local-6989586621684380699"><span class="hs-identifier hs-var">binds'</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- for this no_need_to_flatten stuff</span><span>
</span><a name="line-916"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-917"></a><span>    </span><a name="local-6989586621684380695"><a href="#local-6989586621684380695"><span class="hs-identifier">ind_env</span></a></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="SimplCore.html#makeIndEnv"><span class="hs-identifier hs-var">makeIndEnv</span></a><span> </span><a href="#local-6989586621684380694"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-918"></a><span>    </span><span class="hs-comment">-- These exported Ids are the subjects  of the indirection-elimination</span><span>
</span><a name="line-919"></a><span>    </span><a name="local-6989586621684380696"><a href="#local-6989586621684380696"><span class="hs-identifier">exp_ids</span></a></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">nonDetEltsUFM</span><span> </span><a href="#local-6989586621684380695"><span class="hs-identifier hs-var">ind_env</span></a><span>
</span><a name="line-920"></a><span>      </span><span class="hs-comment">-- It's OK to use nonDetEltsUFM here because we forget the ordering</span><span>
</span><a name="line-921"></a><span>      </span><span class="hs-comment">-- by immediately converting to a set or check if all the elements</span><span>
</span><a name="line-922"></a><span>      </span><span class="hs-comment">-- satisfy a predicate.</span><span>
</span><a name="line-923"></a><span>    </span><a name="local-6989586621684380697"><a href="#local-6989586621684380697"><span class="hs-identifier">exp_id_set</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkVarSet</span><span> </span><a href="#local-6989586621684380696"><span class="hs-identifier hs-var">exp_ids</span></a><span>
</span><a name="line-924"></a><span>    </span><a name="local-6989586621684380698"><a href="#local-6989586621684380698"><span class="hs-identifier">no_need_to_flatten</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">ruleInfoRules</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">idSpecialisation</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684380696"><span class="hs-identifier hs-var">exp_ids</span></a><span>
</span><a name="line-925"></a><span>    </span><a name="local-6989586621684380699"><a href="#local-6989586621684380699"><span class="hs-identifier">binds'</span></a></a><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="#local-6989586621684380700"><span class="hs-identifier hs-var">zap</span></a><span> </span><a href="#local-6989586621684380694"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-926"></a><span>
</span><a name="line-927"></a><span>    </span><a name="local-6989586621684380700"><a href="#local-6989586621684380700"><span class="hs-identifier">zap</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a name="local-6989586621684380702"><a href="#local-6989586621684380702"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621684380703"><a href="#local-6989586621684380703"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621684380704"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621684380705"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684380704"><a href="#local-6989586621684380704"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><a name="local-6989586621684380705"><a href="#local-6989586621684380705"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684380701"><span class="hs-identifier hs-var">zapPair</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684380702"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">,</span><a href="#local-6989586621684380703"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-928"></a><span>    </span><span class="hs-identifier">zap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><a name="local-6989586621684380706"><a href="#local-6989586621684380706"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Rec</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="#local-6989586621684380701"><span class="hs-identifier hs-var">zapPair</span></a><span> </span><a href="#local-6989586621684380706"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-929"></a><span>
</span><a name="line-930"></a><span>    </span><a name="local-6989586621684380701"><a href="#local-6989586621684380701"><span class="hs-identifier">zapPair</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684380707"><a href="#local-6989586621684380707"><span class="hs-identifier">bndr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684380708"><a href="#local-6989586621684380708"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-931"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684380707"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684380697"><span class="hs-identifier hs-var">exp_id_set</span></a><span>
</span><a name="line-932"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- Kill the exported-id binding</span><span>
</span><a name="line-933"></a><span>
</span><a name="line-934"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684380709"><a href="#local-6989586621684380709"><span class="hs-identifier">exp_id</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684380710"><a href="#local-6989586621684380710"><span class="hs-identifier">ticks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupVarEnv</span><span> </span><a href="#local-6989586621684380695"><span class="hs-identifier hs-var">ind_env</span></a><span> </span><a href="#local-6989586621684380707"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-935"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684380711"><a href="#local-6989586621684380711"><span class="hs-identifier">exp_id'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684380712"><a href="#local-6989586621684380712"><span class="hs-identifier">lcl_id'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SimplCore.html#transferIdInfo"><span class="hs-identifier hs-var">transferIdInfo</span></a><span> </span><a href="#local-6989586621684380709"><span class="hs-identifier hs-var">exp_id</span></a><span> </span><a href="#local-6989586621684380707"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-936"></a><span>        </span><span class="hs-glyph">=</span><span>      </span><span class="hs-comment">-- Turn a local-id binding into two bindings</span><span>
</span><a name="line-937"></a><span>               </span><span class="hs-comment">--    exp_id = rhs; lcl_id = exp_id</span><span>
</span><a name="line-938"></a><span>          </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684380711"><span class="hs-identifier hs-var">exp_id'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkTicks</span><span> </span><a href="#local-6989586621684380710"><span class="hs-identifier hs-var">ticks</span></a><span> </span><a href="#local-6989586621684380708"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-939"></a><span>            </span><span class="hs-special">(</span><a href="#local-6989586621684380712"><span class="hs-identifier hs-var">lcl_id'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684380711"><span class="hs-identifier hs-var">exp_id'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-940"></a><span>
</span><a name="line-941"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-942"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621684380707"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">,</span><a href="#local-6989586621684380708"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-943"></a><span>
</span><a name="line-944"></a><span class="hs-identifier">makeIndEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreBind</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplCore.html#IndEnv"><span class="hs-identifier hs-type">IndEnv</span></a><span>
</span><a name="line-945"></a><a name="makeIndEnv"><a href="SimplCore.html#makeIndEnv"><span class="hs-identifier">makeIndEnv</span></a></a><span> </span><a name="local-6989586621684380713"><a href="#local-6989586621684380713"><span class="hs-identifier">binds</span></a></a><span>
</span><a name="line-946"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="#local-6989586621684380714"><span class="hs-identifier hs-var">add_bind</span></a><span> </span><span class="hs-identifier hs-var">emptyVarEnv</span><span> </span><a href="#local-6989586621684380713"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-947"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-948"></a><span>    </span><span class="hs-identifier">add_bind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplCore.html#IndEnv"><span class="hs-identifier hs-type">IndEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreBind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplCore.html#IndEnv"><span class="hs-identifier hs-type">IndEnv</span></a><span>
</span><a name="line-949"></a><span>    </span><a name="local-6989586621684380714"><a href="#local-6989586621684380714"><span class="hs-identifier">add_bind</span></a></a><span> </span><a name="local-6989586621684380716"><a href="#local-6989586621684380716"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a name="local-6989586621684380717"><a href="#local-6989586621684380717"><span class="hs-identifier">exported_id</span></a></a><span> </span><a name="local-6989586621684380718"><a href="#local-6989586621684380718"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684380715"><span class="hs-identifier hs-var">add_pair</span></a><span> </span><a href="#local-6989586621684380716"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684380717"><span class="hs-identifier hs-var">exported_id</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684380718"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-950"></a><span>    </span><span class="hs-identifier">add_bind</span><span> </span><a name="local-6989586621684380719"><a href="#local-6989586621684380719"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><a name="local-6989586621684380720"><a href="#local-6989586621684380720"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="#local-6989586621684380715"><span class="hs-identifier hs-var">add_pair</span></a><span> </span><a href="#local-6989586621684380719"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684380720"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-951"></a><span>
</span><a name="line-952"></a><span>    </span><span class="hs-identifier">add_pair</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplCore.html#IndEnv"><span class="hs-identifier hs-type">IndEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplCore.html#IndEnv"><span class="hs-identifier hs-type">IndEnv</span></a><span>
</span><a name="line-953"></a><span>    </span><a name="local-6989586621684380715"><a href="#local-6989586621684380715"><span class="hs-identifier">add_pair</span></a></a><span> </span><a name="local-6989586621684380721"><a href="#local-6989586621684380721"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684380722"><a href="#local-6989586621684380722"><span class="hs-identifier">exported_id</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684380723"><a href="#local-6989586621684380723"><span class="hs-identifier">exported</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-954"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684380724"><a href="#local-6989586621684380724"><span class="hs-identifier">ticks</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Var</span><span> </span><a name="local-6989586621684380725"><a href="#local-6989586621684380725"><span class="hs-identifier">local_id</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">stripTicksTop</span><span> </span><span class="hs-identifier hs-var">tickishFloatable</span><span> </span><a href="#local-6989586621684380723"><span class="hs-identifier hs-var">exported</span></a><span>
</span><a name="line-955"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="SimplCore.html#shortMeOut"><span class="hs-identifier hs-var">shortMeOut</span></a><span> </span><a href="#local-6989586621684380721"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684380722"><span class="hs-identifier hs-var">exported_id</span></a><span> </span><a href="#local-6989586621684380725"><span class="hs-identifier hs-var">local_id</span></a><span>
</span><a name="line-956"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendVarEnv</span><span> </span><a href="#local-6989586621684380721"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684380725"><span class="hs-identifier hs-var">local_id</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684380722"><span class="hs-identifier hs-var">exported_id</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684380724"><span class="hs-identifier hs-var">ticks</span></a><span class="hs-special">)</span><span>
</span><a name="line-957"></a><span>    </span><span class="hs-identifier">add_pair</span><span> </span><a name="local-6989586621684380726"><a href="#local-6989586621684380726"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684380726"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-958"></a><span>
</span><a name="line-959"></a><span class="hs-comment">-----------------</span><span>
</span><a name="line-960"></a><span class="hs-identifier">shortMeOut</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplCore.html#IndEnv"><span class="hs-identifier hs-type">IndEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-961"></a><a name="shortMeOut"><a href="SimplCore.html#shortMeOut"><span class="hs-identifier">shortMeOut</span></a></a><span> </span><a name="local-6989586621684380727"><a href="#local-6989586621684380727"><span class="hs-identifier">ind_env</span></a></a><span> </span><a name="local-6989586621684380728"><a href="#local-6989586621684380728"><span class="hs-identifier">exported_id</span></a></a><span> </span><a name="local-6989586621684380729"><a href="#local-6989586621684380729"><span class="hs-identifier">local_id</span></a></a><span>
</span><a name="line-962"></a><span class="hs-comment">-- The if-then-else stuff is just so I can get a pprTrace to see</span><span>
</span><a name="line-963"></a><span class="hs-comment">-- how often I don't get shorting out because of IdInfo stuff</span><span>
</span><a name="line-964"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isExportedId</span><span> </span><a href="#local-6989586621684380728"><span class="hs-identifier hs-var">exported_id</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>              </span><span class="hs-comment">-- Only if this is exported</span><span>
</span><a name="line-965"></a><span>
</span><a name="line-966"></a><span>       </span><span class="hs-identifier hs-var">isLocalId</span><span> </span><a href="#local-6989586621684380729"><span class="hs-identifier hs-var">local_id</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>                    </span><span class="hs-comment">-- Only if this one is defined in this</span><span>
</span><a name="line-967"></a><span>                                                </span><span class="hs-comment">--      module, so that we *can* change its</span><span>
</span><a name="line-968"></a><span>                                                </span><span class="hs-comment">--      binding to be the exported thing!</span><span>
</span><a name="line-969"></a><span>
</span><a name="line-970"></a><span>       </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isExportedId</span><span> </span><a href="#local-6989586621684380729"><span class="hs-identifier hs-var">local_id</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>           </span><span class="hs-comment">-- Only if this one is not itself exported,</span><span>
</span><a name="line-971"></a><span>                                                </span><span class="hs-comment">--      since the transformation will nuke it</span><span>
</span><a name="line-972"></a><span>
</span><a name="line-973"></a><span>       </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684380729"><span class="hs-identifier hs-var">local_id</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarEnv</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684380727"><span class="hs-identifier hs-var">ind_env</span></a><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- Only if not already substituted for</span><span>
</span><a name="line-974"></a><span>    </span><span class="hs-keyword">then</span><span>
</span><a name="line-975"></a><span>        </span><span class="hs-keyword">if</span><span> </span><a href="SimplCore.html#hasShortableIdInfo"><span class="hs-identifier hs-var">hasShortableIdInfo</span></a><span> </span><a href="#local-6989586621684380728"><span class="hs-identifier hs-var">exported_id</span></a><span>
</span><a name="line-976"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">True</span><span>       </span><span class="hs-comment">-- See Note [Messing up the exported Id's IdInfo]</span><span>
</span><a name="line-977"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier">WARN</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;Not shorting out:&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">exported_id</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-978"></a><span>             </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-979"></a><span>    </span><span class="hs-keyword">else</span><span>
</span><a name="line-980"></a><span>        </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-981"></a><span>
</span><a name="line-982"></a><span class="hs-comment">-----------------</span><span>
</span><a name="line-983"></a><span class="hs-identifier">hasShortableIdInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-984"></a><span class="hs-comment">-- True if there is no user-attached IdInfo on exported_id,</span><span>
</span><a name="line-985"></a><span class="hs-comment">-- so we can safely discard it</span><span>
</span><a name="line-986"></a><span class="hs-comment">-- See Note [Messing up the exported Id's IdInfo]</span><span>
</span><a name="line-987"></a><a name="hasShortableIdInfo"><a href="SimplCore.html#hasShortableIdInfo"><span class="hs-identifier">hasShortableIdInfo</span></a></a><span> </span><a name="local-6989586621684380730"><a href="#local-6989586621684380730"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-988"></a><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">isEmptyRuleInfo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ruleInfo</span><span> </span><a href="#local-6989586621684380731"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span>
</span><a name="line-989"></a><span>  </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isDefaultInlinePragma</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">inlinePragInfo</span><span> </span><a href="#local-6989586621684380731"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span>
</span><a name="line-990"></a><span>  </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isStableUnfolding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">unfoldingInfo</span><span> </span><a href="#local-6989586621684380731"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-991"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-992"></a><span>     </span><a name="local-6989586621684380731"><a href="#local-6989586621684380731"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idInfo</span><span> </span><a href="#local-6989586621684380730"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-993"></a><span>
</span><a name="line-994"></a><span class="hs-comment">-----------------</span><span>
</span><a name="line-995"></a><span class="hs-comment">{- Note [Transferring IdInfo]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we have
     lcl_id = e; exp_id = lcl_id

and lcl_id has useful IdInfo, we don't want to discard it by going
     gbl_id = e; lcl_id = gbl_id

Instead, transfer IdInfo from lcl_id to exp_id, specifically
* (Stable) unfolding
* Strictness
* Rules
* Inline pragma

Overwriting, rather than merging, seems to work ok.

We also zap the InlinePragma on the lcl_id. It might originally
have had a NOINLINE, which we have now transferred; and we really
want the lcl_id to inline now that its RHS is trivial!
-}</span><span>
</span><a name="line-1015"></a><span>
</span><a name="line-1016"></a><span class="hs-identifier">transferIdInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">)</span><span>
</span><a name="line-1017"></a><span class="hs-comment">-- See Note [Transferring IdInfo]</span><span>
</span><a name="line-1018"></a><a name="transferIdInfo"><a href="SimplCore.html#transferIdInfo"><span class="hs-identifier">transferIdInfo</span></a></a><span> </span><a name="local-6989586621684380732"><a href="#local-6989586621684380732"><span class="hs-identifier">exported_id</span></a></a><span> </span><a name="local-6989586621684380733"><a href="#local-6989586621684380733"><span class="hs-identifier">local_id</span></a></a><span>
</span><a name="line-1019"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">modifyIdInfo</span><span> </span><a href="#local-6989586621684380735"><span class="hs-identifier hs-var">transfer</span></a><span> </span><a href="#local-6989586621684380732"><span class="hs-identifier hs-var">exported_id</span></a><span>
</span><a name="line-1020"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684380733"><span class="hs-identifier hs-var">local_id</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setInlinePragma</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">defaultInlinePragma</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1021"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1022"></a><span>    </span><a name="local-6989586621684380734"><a href="#local-6989586621684380734"><span class="hs-identifier">local_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idInfo</span><span> </span><a href="#local-6989586621684380733"><span class="hs-identifier hs-var">local_id</span></a><span>
</span><a name="line-1023"></a><span>    </span><a name="local-6989586621684380735"><a href="#local-6989586621684380735"><span class="hs-identifier">transfer</span></a></a><span> </span><a name="local-6989586621684380737"><a href="#local-6989586621684380737"><span class="hs-identifier">exp_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684380737"><span class="hs-identifier hs-var">exp_info</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setStrictnessInfo</span><span class="hs-special">`</span><span>    </span><span class="hs-identifier">strictnessInfo</span><span> </span><a href="#local-6989586621684380734"><span class="hs-identifier hs-var">local_info</span></a><span>
</span><a name="line-1024"></a><span>                                 </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setUnfoldingInfo</span><span class="hs-special">`</span><span>     </span><span class="hs-identifier">unfoldingInfo</span><span> </span><a href="#local-6989586621684380734"><span class="hs-identifier hs-var">local_info</span></a><span>
</span><a name="line-1025"></a><span>                                 </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setInlinePragInfo</span><span class="hs-special">`</span><span>    </span><span class="hs-identifier">inlinePragInfo</span><span> </span><a href="#local-6989586621684380734"><span class="hs-identifier hs-var">local_info</span></a><span>
</span><a name="line-1026"></a><span>                                 </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setRuleInfo</span><span class="hs-special">`</span><span>          </span><span class="hs-identifier hs-var">addRuleInfo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ruleInfo</span><span> </span><a href="#local-6989586621684380737"><span class="hs-identifier hs-var">exp_info</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684380736"><span class="hs-identifier hs-var">new_info</span></a><span>
</span><a name="line-1027"></a><span>    </span><a name="local-6989586621684380736"><a href="#local-6989586621684380736"><span class="hs-identifier">new_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">setRuleInfoHead</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621684380732"><span class="hs-identifier hs-var">exported_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-1028"></a><span>                               </span><span class="hs-special">(</span><span class="hs-identifier">ruleInfo</span><span> </span><a href="#local-6989586621684380734"><span class="hs-identifier hs-var">local_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-1029"></a><span>        </span><span class="hs-comment">-- Remember to set the function-name field of the</span><span>
</span><a name="line-1030"></a><span>        </span><span class="hs-comment">-- rules as we transfer them from one function to another</span><span>
</span><a name="line-1031"></a></pre></body></html>