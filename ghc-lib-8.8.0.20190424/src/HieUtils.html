<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE TupleSections #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><a name="line-5"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">HieUtils</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreMap</span><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>                   </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>                 </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">FastString</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkFastString</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">IfaceType</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varName</span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>                 </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">renderWithStyle</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">defaultUserStyle</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ToIface</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCoRep</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Var</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarEnv</span><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="HieTypes.html"><span class="hs-identifier">HieTypes</span></a><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">M</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">S</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.IntMap.Strict</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">IM</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Array</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">A</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Data</span><span>                  </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">typeOf</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">typeRepTyCon</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Data</span><span class="hs-special">(</span><span class="hs-identifier hs-var">toConstr</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span>                 </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">maybeToList</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Monoid</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Traversable</span><span>           </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">for</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Trans.State.Strict</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">get</span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span class="hs-identifier">generateReferencesMap</span><span>
</span><a name="line-37"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Foldable</span><span> </span><a href="#local-6989586621679709451"><span class="hs-identifier hs-type">f</span></a><span>
</span><a name="line-38"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679709451"><span class="hs-identifier hs-type">f</span></a><span> </span><span class="hs-special">(</span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><a href="#local-6989586621679709452"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">M.Map</span><span> </span><a href="HieTypes.html#Identifier"><span class="hs-identifier hs-type">Identifier</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="HieTypes.html#Span"><span class="hs-identifier hs-type">Span</span></a><span class="hs-special">,</span><span> </span><a href="HieTypes.html#IdentifierDetails"><span class="hs-identifier hs-type">IdentifierDetails</span></a><span> </span><a href="#local-6989586621679709452"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-40"></a><a name="generateReferencesMap"><a href="HieUtils.html#generateReferencesMap"><span class="hs-identifier">generateReferencesMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679709456"><a href="#local-6989586621679709456"><span class="hs-identifier">ast</span></a></a><span> </span><a name="local-6989586621679709457"><a href="#local-6989586621679709457"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">M.unionWith</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679709453"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679709456"><span class="hs-identifier hs-var">ast</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679709457"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">M.empty</span><span>
</span><a name="line-41"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-42"></a><span>    </span><a name="local-6989586621679709453"><a href="#local-6989586621679709453"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679709454"><a href="#local-6989586621679709454"><span class="hs-identifier">ast</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">M.unionsWith</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679709455"><span class="hs-identifier hs-var">this</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679709453"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">nodeChildren</span><span> </span><a href="#local-6989586621679709454"><span class="hs-identifier hs-var">ast</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-44"></a><span>        </span><a name="local-6989586621679709455"><a href="#local-6989586621679709455"><span class="hs-identifier">this</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">nodeSpan</span><span> </span><a href="#local-6989586621679709454"><span class="hs-identifier hs-var">ast</span></a><span class="hs-special">,</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">nodeIdentifiers</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">nodeInfo</span><span> </span><a href="#local-6989586621679709454"><span class="hs-identifier hs-var">ast</span></a><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span class="hs-identifier">renderHieType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HieTypes.html#HieTypeFix"><span class="hs-identifier hs-type">HieTypeFix</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-47"></a><a name="renderHieType"><a href="HieUtils.html#renderHieType"><span class="hs-identifier">renderHieType</span></a></a><span> </span><a name="local-6989586621679709458"><a href="#local-6989586621679709458"><span class="hs-identifier">df</span></a></a><span> </span><a name="local-6989586621679709459"><a href="#local-6989586621679709459"><span class="hs-identifier">ht</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">renderWithStyle</span><span> </span><a href="#local-6989586621679709458"><span class="hs-identifier hs-var">df</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HieUtils.html#hieTypeToIface"><span class="hs-identifier hs-var">hieTypeToIface</span></a><span> </span><a href="#local-6989586621679709459"><span class="hs-identifier hs-var">ht</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679709460"><span class="hs-identifier hs-var">sty</span></a><span>
</span><a name="line-48"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679709460"><a href="#local-6989586621679709460"><span class="hs-identifier">sty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">defaultUserStyle</span><span> </span><a href="#local-6989586621679709458"><span class="hs-identifier hs-var">df</span></a><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span class="hs-identifier">resolveVisibility</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-51"></a><a name="resolveVisibility"><a href="HieUtils.html#resolveVisibility"><span class="hs-identifier">resolveVisibility</span></a></a><span> </span><a name="local-6989586621679709461"><a href="#local-6989586621679709461"><span class="hs-identifier">kind</span></a></a><span> </span><a name="local-6989586621679709462"><a href="#local-6989586621679709462"><span class="hs-identifier">ty_args</span></a></a><span>
</span><a name="line-52"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709464"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkEmptyTCvSubst</span><span> </span><a href="#local-6989586621679709463"><span class="hs-identifier hs-var">in_scope</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679709461"><span class="hs-identifier hs-var">kind</span></a><span> </span><a href="#local-6989586621679709462"><span class="hs-identifier hs-var">ty_args</span></a><span>
</span><a name="line-53"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-54"></a><span>    </span><a name="local-6989586621679709463"><a href="#local-6989586621679709463"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkInScopeSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyCoVarsOfTypes</span><span> </span><a href="#local-6989586621679709462"><span class="hs-identifier hs-var">ty_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span>
</span><a name="line-56"></a><span>    </span><a name="local-6989586621679709464"><a href="#local-6989586621679709464"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-identifier">_</span><span>                   </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-57"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679709465"><a href="#local-6989586621679709465"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679709466"><a href="#local-6989586621679709466"><span class="hs-identifier">ty</span></a></a><span>                  </span><a name="local-6989586621679709467"><a href="#local-6989586621679709467"><span class="hs-identifier">ts</span></a></a><span>
</span><a name="line-58"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679709468"><a href="#local-6989586621679709468"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">coreView</span><span> </span><a href="#local-6989586621679709466"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-59"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709464"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679709465"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679709468"><span class="hs-identifier hs-var">ty'</span></a><span> </span><a href="#local-6989586621679709467"><span class="hs-identifier hs-var">ts</span></a><span>
</span><a name="line-60"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679709469"><a href="#local-6989586621679709469"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ForAllTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Bndr</span><span> </span><a name="local-6989586621679709470"><a href="#local-6989586621679709470"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-6989586621679709471"><a href="#local-6989586621679709471"><span class="hs-identifier">vis</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679709472"><a href="#local-6989586621679709472"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679709473"><a href="#local-6989586621679709473"><span class="hs-identifier">t</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679709474"><a href="#local-6989586621679709474"><span class="hs-identifier">ts</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-61"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isVisibleArgFlag</span><span> </span><a href="#local-6989586621679709471"><span class="hs-identifier hs-var">vis</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679709473"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679709475"><span class="hs-identifier hs-var">ts'</span></a><span>
</span><a name="line-62"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679709473"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679709475"><span class="hs-identifier hs-var">ts'</span></a><span>
</span><a name="line-63"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-64"></a><span>        </span><a name="local-6989586621679709475"><a href="#local-6989586621679709475"><span class="hs-identifier">ts'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709464"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">extendTvSubst</span><span> </span><a href="#local-6989586621679709469"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679709470"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-6989586621679709473"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679709472"><span class="hs-identifier hs-var">res</span></a><span> </span><a href="#local-6989586621679709474"><span class="hs-identifier hs-var">ts</span></a><span>
</span><a name="line-65"></a><span>
</span><a name="line-66"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679709476"><a href="#local-6989586621679709476"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunTy</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679709477"><a href="#local-6989586621679709477"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679709478"><a href="#local-6989586621679709478"><span class="hs-identifier">t</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679709479"><a href="#local-6989586621679709479"><span class="hs-identifier">ts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- No type-class args in tycon apps</span><span>
</span><a name="line-67"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><a href="#local-6989586621679709478"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679709464"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679709476"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679709477"><span class="hs-identifier hs-var">res</span></a><span> </span><a href="#local-6989586621679709479"><span class="hs-identifier hs-var">ts</span></a><span class="hs-special">)</span><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679709480"><a href="#local-6989586621679709480"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyVarTy</span><span> </span><a name="local-6989586621679709481"><a href="#local-6989586621679709481"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679709482"><a href="#local-6989586621679709482"><span class="hs-identifier">ts</span></a></a><span>
</span><a name="line-70"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679709483"><a href="#local-6989586621679709483"><span class="hs-identifier">ki</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupTyVar</span><span> </span><a href="#local-6989586621679709480"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679709481"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709464"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679709480"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679709483"><span class="hs-identifier hs-var">ki</span></a><span> </span><a href="#local-6989586621679709482"><span class="hs-identifier hs-var">ts</span></a><span>
</span><a name="line-71"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679709484"><a href="#local-6989586621679709484"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621679709485"><a href="#local-6989586621679709485"><span class="hs-identifier">kind</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679709486"><a href="#local-6989586621679709486"><span class="hs-identifier">t</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679709487"><a href="#local-6989586621679709487"><span class="hs-identifier">ts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679709486"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679709464"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679709484"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621679709485"><span class="hs-identifier hs-var">kind</span></a><span> </span><a href="#local-6989586621679709487"><span class="hs-identifier hs-var">ts</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Ill-kinded</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-identifier">foldType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#HieType"><span class="hs-identifier hs-type">HieType</span></a><span> </span><a href="#local-6989586621679709450"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679709450"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HieTypes.html#HieTypeFix"><span class="hs-identifier hs-type">HieTypeFix</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679709450"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-74"></a><a name="foldType"><a href="HieUtils.html#foldType"><span class="hs-identifier">foldType</span></a></a><span> </span><a name="local-6989586621679709488"><a href="#local-6989586621679709488"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="HieTypes.html#Roll"><span class="hs-identifier hs-var">Roll</span></a><span> </span><a name="local-6989586621679709489"><a href="#local-6989586621679709489"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709488"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><a href="HieUtils.html#foldType"><span class="hs-identifier hs-var">foldType</span></a><span> </span><a href="#local-6989586621679709488"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679709489"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-75"></a><span>
</span><a name="line-76"></a><span class="hs-identifier">hieTypeToIface</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HieTypes.html#HieTypeFix"><span class="hs-identifier hs-type">HieTypeFix</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfaceType</span><span>
</span><a name="line-77"></a><a name="hieTypeToIface"><a href="HieUtils.html#hieTypeToIface"><span class="hs-identifier">hieTypeToIface</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HieUtils.html#foldType"><span class="hs-identifier hs-var">foldType</span></a><span> </span><a href="#local-6989586621679709490"><span class="hs-identifier hs-var">go</span></a><span>
</span><a name="line-78"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-79"></a><span>    </span><a name="local-6989586621679709490"><a href="#local-6989586621679709490"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="HieTypes.html#HTyVarTy"><span class="hs-identifier hs-var">HTyVarTy</span></a><span> </span><a name="local-6989586621679709492"><a href="#local-6989586621679709492"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfaceTyVar</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">occNameFS</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">getOccName</span><span> </span><a href="#local-6989586621679709492"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-80"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#HAppTy"><span class="hs-identifier hs-var">HAppTy</span></a><span> </span><a name="local-6989586621679709493"><a href="#local-6989586621679709493"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679709494"><a href="#local-6989586621679709494"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfaceAppTy</span><span> </span><a href="#local-6989586621679709493"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679709491"><span class="hs-identifier hs-var">hieToIfaceArgs</span></a><span> </span><a href="#local-6989586621679709494"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-81"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#HLitTy"><span class="hs-identifier hs-var">HLitTy</span></a><span> </span><a name="local-6989586621679709495"><a href="#local-6989586621679709495"><span class="hs-identifier">l</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfaceLitTy</span><span> </span><a href="#local-6989586621679709495"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-82"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#HForAllTy"><span class="hs-identifier hs-var">HForAllTy</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621679709496"><a href="#local-6989586621679709496"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><a name="local-6989586621679709497"><a href="#local-6989586621679709497"><span class="hs-identifier">k</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><a name="local-6989586621679709498"><a href="#local-6989586621679709498"><span class="hs-identifier">af</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679709499"><a href="#local-6989586621679709499"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679709500"><a href="#local-6989586621679709500"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">occNameFS</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">getOccName</span><span> </span><a href="#local-6989586621679709496"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679709497"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span>
</span><a name="line-83"></a><span>                                  </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">IfaceForAllTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Bndr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IfaceTvBndr</span><span> </span><a href="#local-6989586621679709500"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679709498"><span class="hs-identifier hs-var">af</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679709499"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-84"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#HFunTy"><span class="hs-identifier hs-var">HFunTy</span></a><span> </span><a name="local-6989586621679709501"><a href="#local-6989586621679709501"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679709502"><a href="#local-6989586621679709502"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfaceFunTy</span><span> </span><a href="#local-6989586621679709501"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679709502"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-85"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#HQualTy"><span class="hs-identifier hs-var">HQualTy</span></a><span> </span><a name="local-6989586621679709503"><a href="#local-6989586621679709503"><span class="hs-identifier">pred</span></a></a><span> </span><a name="local-6989586621679709504"><a href="#local-6989586621679709504"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfaceDFunTy</span><span> </span><a href="#local-6989586621679709503"><span class="hs-identifier hs-var">pred</span></a><span> </span><a href="#local-6989586621679709504"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-86"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#HCastTy"><span class="hs-identifier hs-var">HCastTy</span></a><span> </span><a name="local-6989586621679709505"><a href="#local-6989586621679709505"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709505"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-87"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a href="HieTypes.html#HCoercionTy"><span class="hs-identifier hs-var">HCoercionTy</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfaceTyVar</span><span> </span><span class="hs-string">&quot;&lt;coercion type&gt;&quot;</span><span>
</span><a name="line-88"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#HTyConApp"><span class="hs-identifier hs-var">HTyConApp</span></a><span> </span><a name="local-6989586621679709506"><a href="#local-6989586621679709506"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679709507"><a href="#local-6989586621679709507"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfaceTyConApp</span><span> </span><a href="#local-6989586621679709506"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679709491"><span class="hs-identifier hs-var">hieToIfaceArgs</span></a><span> </span><a href="#local-6989586621679709507"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span>    </span><span class="hs-comment">-- This isn't fully faithful - we can't produce the 'Inferred' case</span><span>
</span><a name="line-91"></a><span>    </span><span class="hs-identifier">hieToIfaceArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HieTypes.html#HieArgs"><span class="hs-identifier hs-type">HieArgs</span></a><span> </span><span class="hs-identifier hs-type">IfaceType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfaceAppArgs</span><span>
</span><a name="line-92"></a><span>    </span><a name="local-6989586621679709491"><a href="#local-6989586621679709491"><span class="hs-identifier">hieToIfaceArgs</span></a></a><span> </span><span class="hs-special">(</span><a href="HieTypes.html#HieArgs"><span class="hs-identifier hs-var">HieArgs</span></a><span> </span><a name="local-6989586621679709508"><a href="#local-6989586621679709508"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709509"><span class="hs-identifier hs-var">go'</span></a><span> </span><a href="#local-6989586621679709508"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-93"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-94"></a><span>        </span><a name="local-6989586621679709509"><a href="#local-6989586621679709509"><span class="hs-identifier">go'</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IA_Nil</span><span>
</span><a name="line-95"></a><span>        </span><span class="hs-identifier">go'</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">,</span><a name="local-6989586621679709510"><a href="#local-6989586621679709510"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621679709511"><a href="#local-6989586621679709511"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IA_Arg</span><span> </span><a href="#local-6989586621679709510"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-identifier hs-var">Required</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679709509"><span class="hs-identifier hs-var">go'</span></a><span> </span><a href="#local-6989586621679709511"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-96"></a><span>        </span><span class="hs-identifier">go'</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><a name="local-6989586621679709512"><a href="#local-6989586621679709512"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621679709513"><a href="#local-6989586621679709513"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IA_Arg</span><span> </span><a href="#local-6989586621679709512"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-identifier hs-var">Specified</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679709509"><span class="hs-identifier hs-var">go'</span></a><span> </span><a href="#local-6989586621679709513"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span class="hs-keyword">data</span><span> </span><a name="HieTypeState"><a href="HieUtils.html#HieTypeState"><span class="hs-identifier">HieTypeState</span></a></a><span>
</span><a name="line-99"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="HTS"><a href="HieUtils.html#HTS"><span class="hs-identifier">HTS</span></a></a><span>
</span><a name="line-100"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="tyMap"><a href="HieUtils.html#tyMap"><span class="hs-identifier">tyMap</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">TypeMap</span><span> </span><a href="HieTypes.html#TypeIndex"><span class="hs-identifier hs-type">TypeIndex</span></a><span class="hs-special">)</span><span>
</span><a name="line-101"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="htyTable"><a href="HieUtils.html#htyTable"><span class="hs-identifier">htyTable</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">IM.IntMap</span><span> </span><a href="HieTypes.html#HieTypeFlat"><span class="hs-identifier hs-type">HieTypeFlat</span></a><span class="hs-special">)</span><span>
</span><a name="line-102"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="freshIndex"><a href="HieUtils.html#freshIndex"><span class="hs-identifier">freshIndex</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="HieTypes.html#TypeIndex"><span class="hs-identifier hs-type">TypeIndex</span></a><span>
</span><a name="line-103"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-104"></a><span>
</span><a name="line-105"></a><span class="hs-identifier">initialHTS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HieUtils.html#HieTypeState"><span class="hs-identifier hs-type">HieTypeState</span></a><span>
</span><a name="line-106"></a><a name="initialHTS"><a href="HieUtils.html#initialHTS"><span class="hs-identifier">initialHTS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HieUtils.html#HTS"><span class="hs-identifier hs-var">HTS</span></a><span> </span><span class="hs-identifier hs-var">emptyTypeMap</span><span> </span><span class="hs-identifier hs-var">IM.empty</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-107"></a><span>
</span><a name="line-108"></a><span class="hs-identifier">freshTypeIndex</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">State</span><span> </span><a href="HieUtils.html#HieTypeState"><span class="hs-identifier hs-type">HieTypeState</span></a><span> </span><a href="HieTypes.html#TypeIndex"><span class="hs-identifier hs-type">TypeIndex</span></a><span>
</span><a name="line-109"></a><a name="freshTypeIndex"><a href="HieUtils.html#freshTypeIndex"><span class="hs-identifier">freshTypeIndex</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-110"></a><span>  </span><a name="local-6989586621679709514"><a href="#local-6989586621679709514"><span class="hs-identifier">index</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><span class="hs-identifier">freshIndex</span><span>
</span><a name="line-111"></a><span>  </span><span class="hs-identifier hs-var">modify'</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679709515"><a href="#local-6989586621679709515"><span class="hs-identifier">hts</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679709515"><span class="hs-identifier hs-var">hts</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">freshIndex</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709514"><span class="hs-identifier hs-var">index</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-112"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679709514"><span class="hs-identifier hs-var">index</span></a><span>
</span><a name="line-113"></a><span>
</span><a name="line-114"></a><span class="hs-identifier">compressTypes</span><span>
</span><a name="line-115"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="HieTypes.html#HieASTs"><span class="hs-identifier hs-type">HieASTs</span></a><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-116"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#HieASTs"><span class="hs-identifier hs-type">HieASTs</span></a><span> </span><a href="HieTypes.html#TypeIndex"><span class="hs-identifier hs-type">TypeIndex</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">A.Array</span><span> </span><a href="HieTypes.html#TypeIndex"><span class="hs-identifier hs-type">TypeIndex</span></a><span> </span><a href="HieTypes.html#HieTypeFlat"><span class="hs-identifier hs-type">HieTypeFlat</span></a><span class="hs-special">)</span><span>
</span><a name="line-117"></a><a name="compressTypes"><a href="HieUtils.html#compressTypes"><span class="hs-identifier">compressTypes</span></a></a><span> </span><a name="local-6989586621679709516"><a href="#local-6989586621679709516"><span class="hs-identifier">asts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679709517"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679709520"><span class="hs-identifier hs-var">arr</span></a><span class="hs-special">)</span><span>
</span><a name="line-118"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-119"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679709517"><a href="#local-6989586621679709517"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="HieUtils.html#HTS"><span class="hs-identifier hs-var">HTS</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679709518"><a href="#local-6989586621679709518"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679709519"><a href="#local-6989586621679709519"><span class="hs-identifier">i</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier hs-var">runState</span><span> </span><a href="HieUtils.html#initialHTS"><span class="hs-identifier hs-var">initialHTS</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-120"></a><span>      </span><span class="hs-identifier hs-var">for</span><span> </span><a href="#local-6989586621679709516"><span class="hs-identifier hs-var">asts</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679709521"><a href="#local-6989586621679709521"><span class="hs-identifier">typ</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-121"></a><span>        </span><a name="local-6989586621679709522"><a href="#local-6989586621679709522"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HieUtils.html#getTypeIndex"><span class="hs-identifier hs-var">getTypeIndex</span></a><span> </span><a href="#local-6989586621679709521"><span class="hs-identifier hs-var">typ</span></a><span>
</span><a name="line-122"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679709522"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-123"></a><span>    </span><a name="local-6989586621679709520"><a href="#local-6989586621679709520"><span class="hs-identifier">arr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">A.array</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><a href="#local-6989586621679709519"><span class="hs-identifier hs-var">i</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IM.toList</span><span> </span><a href="#local-6989586621679709518"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a><span class="hs-identifier">recoverFullType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HieTypes.html#TypeIndex"><span class="hs-identifier hs-type">TypeIndex</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">A.Array</span><span> </span><a href="HieTypes.html#TypeIndex"><span class="hs-identifier hs-type">TypeIndex</span></a><span> </span><a href="HieTypes.html#HieTypeFlat"><span class="hs-identifier hs-type">HieTypeFlat</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HieTypes.html#HieTypeFix"><span class="hs-identifier hs-type">HieTypeFix</span></a><span>
</span><a name="line-126"></a><a name="recoverFullType"><a href="HieUtils.html#recoverFullType"><span class="hs-identifier">recoverFullType</span></a></a><span> </span><a name="local-6989586621679709523"><a href="#local-6989586621679709523"><span class="hs-identifier">i</span></a></a><span> </span><a name="local-6989586621679709524"><a href="#local-6989586621679709524"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709525"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679709523"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-127"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-128"></a><span>    </span><a name="local-6989586621679709525"><a href="#local-6989586621679709525"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679709526"><a href="#local-6989586621679709526"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HieTypes.html#Roll"><span class="hs-identifier hs-var">Roll</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621679709525"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679709524"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-operator hs-var">A.!</span><span> </span><a href="#local-6989586621679709526"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span>
</span><a name="line-129"></a><span>
</span><a name="line-130"></a><span class="hs-identifier">getTypeIndex</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">State</span><span> </span><a href="HieUtils.html#HieTypeState"><span class="hs-identifier hs-type">HieTypeState</span></a><span> </span><a href="HieTypes.html#TypeIndex"><span class="hs-identifier hs-type">TypeIndex</span></a><span>
</span><a name="line-131"></a><a name="getTypeIndex"><a href="HieUtils.html#getTypeIndex"><span class="hs-identifier">getTypeIndex</span></a></a><span> </span><a name="local-6989586621679709527"><a href="#local-6989586621679709527"><span class="hs-identifier">t</span></a></a><span>
</span><a name="line-132"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-133"></a><span>      </span><a name="local-6989586621679709559"><a href="#local-6989586621679709559"><span class="hs-identifier">tm</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><span class="hs-identifier">tyMap</span><span>
</span><a name="line-134"></a><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupTypeMap</span><span> </span><a href="#local-6989586621679709559"><span class="hs-identifier hs-var">tm</span></a><span> </span><a href="#local-6989586621679709527"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-135"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679709560"><a href="#local-6989586621679709560"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679709560"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-136"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-137"></a><span>          </span><a name="local-6989586621679709561"><a href="#local-6989586621679709561"><span class="hs-identifier">ht</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679709529"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679709527"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-138"></a><span>          </span><a href="#local-6989586621679709528"><span class="hs-identifier hs-var">extendHTS</span></a><span> </span><a href="#local-6989586621679709527"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621679709561"><span class="hs-identifier hs-var">ht</span></a><span>
</span><a name="line-139"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-140"></a><span>    </span><a name="local-6989586621679709528"><a href="#local-6989586621679709528"><span class="hs-identifier">extendHTS</span></a></a><span> </span><a name="local-6989586621679709530"><a href="#local-6989586621679709530"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621679709531"><a href="#local-6989586621679709531"><span class="hs-identifier">ht</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-141"></a><span>      </span><a name="local-6989586621679709532"><a href="#local-6989586621679709532"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HieUtils.html#freshTypeIndex"><span class="hs-identifier hs-var">freshTypeIndex</span></a><span>
</span><a name="line-142"></a><span>      </span><span class="hs-identifier hs-var">modify'</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a href="HieUtils.html#HTS"><span class="hs-identifier hs-var">HTS</span></a><span> </span><a name="local-6989586621679709533"><a href="#local-6989586621679709533"><span class="hs-identifier">tm</span></a></a><span> </span><a name="local-6989586621679709534"><a href="#local-6989586621679709534"><span class="hs-identifier">tt</span></a></a><span> </span><a name="local-6989586621679709535"><a href="#local-6989586621679709535"><span class="hs-identifier">fi</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-143"></a><span>        </span><a href="HieUtils.html#HTS"><span class="hs-identifier hs-var">HTS</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">extendTypeMap</span><span> </span><a href="#local-6989586621679709533"><span class="hs-identifier hs-var">tm</span></a><span> </span><a href="#local-6989586621679709530"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621679709532"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IM.insert</span><span> </span><a href="#local-6989586621679709532"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621679709531"><span class="hs-identifier hs-var">ht</span></a><span> </span><a href="#local-6989586621679709534"><span class="hs-identifier hs-var">tt</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679709535"><span class="hs-identifier hs-var">fi</span></a><span>
</span><a name="line-144"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679709532"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-145"></a><span>
</span><a name="line-146"></a><span>    </span><a name="local-6989586621679709529"><a href="#local-6989586621679709529"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyVarTy</span><span> </span><a name="local-6989586621679709536"><a href="#local-6989586621679709536"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HieTypes.html#HTyVarTy"><span class="hs-identifier hs-var">HTyVarTy</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">varName</span><span> </span><a href="#local-6989586621679709536"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-147"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679709537"><a href="#local-6989586621679709537"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">AppTy</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-148"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679709538"><a href="#local-6989586621679709538"><span class="hs-identifier">head</span></a></a><span class="hs-special">,</span><a name="local-6989586621679709539"><a href="#local-6989586621679709539"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitAppTys</span><span> </span><a href="#local-6989586621679709537"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-149"></a><span>          </span><a name="local-6989586621679709540"><a href="#local-6989586621679709540"><span class="hs-identifier">visArgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HieTypes.html#HieArgs"><span class="hs-identifier hs-var">HieArgs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HieUtils.html#resolveVisibility"><span class="hs-identifier hs-var">resolveVisibility</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">typeKind</span><span> </span><a href="#local-6989586621679709538"><span class="hs-identifier hs-var">head</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679709539"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-150"></a><span>      </span><a name="local-6989586621679709541"><a href="#local-6989586621679709541"><span class="hs-identifier">ai</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HieUtils.html#getTypeIndex"><span class="hs-identifier hs-var">getTypeIndex</span></a><span> </span><a href="#local-6989586621679709538"><span class="hs-identifier hs-var">head</span></a><span>
</span><a name="line-151"></a><span>      </span><a name="local-6989586621679709542"><a href="#local-6989586621679709542"><span class="hs-identifier">argsi</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="HieUtils.html#getTypeIndex"><span class="hs-identifier hs-var">getTypeIndex</span></a><span> </span><a href="#local-6989586621679709540"><span class="hs-identifier hs-var">visArgs</span></a><span>
</span><a name="line-152"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HieTypes.html#HAppTy"><span class="hs-identifier hs-var">HAppTy</span></a><span> </span><a href="#local-6989586621679709541"><span class="hs-identifier hs-var">ai</span></a><span> </span><a href="#local-6989586621679709542"><span class="hs-identifier hs-var">argsi</span></a><span>
</span><a name="line-153"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyConApp</span><span> </span><a name="local-6989586621679709543"><a href="#local-6989586621679709543"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679709544"><a href="#local-6989586621679709544"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-154"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679709545"><a href="#local-6989586621679709545"><span class="hs-identifier">visArgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HieTypes.html#HieArgs"><span class="hs-identifier hs-var">HieArgs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HieUtils.html#resolveVisibility"><span class="hs-identifier hs-var">resolveVisibility</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConKind</span><span> </span><a href="#local-6989586621679709543"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679709544"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-155"></a><span>      </span><a name="local-6989586621679709546"><a href="#local-6989586621679709546"><span class="hs-identifier">is</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="HieUtils.html#getTypeIndex"><span class="hs-identifier hs-var">getTypeIndex</span></a><span> </span><a href="#local-6989586621679709545"><span class="hs-identifier hs-var">visArgs</span></a><span>
</span><a name="line-156"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HieTypes.html#HTyConApp"><span class="hs-identifier hs-var">HTyConApp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toIfaceTyCon</span><span> </span><a href="#local-6989586621679709543"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679709546"><span class="hs-identifier hs-var">is</span></a><span>
</span><a name="line-157"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ForAllTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Bndr</span><span> </span><a name="local-6989586621679709547"><a href="#local-6989586621679709547"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621679709548"><a href="#local-6989586621679709548"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679709549"><a href="#local-6989586621679709549"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-158"></a><span>      </span><a name="local-6989586621679709550"><a href="#local-6989586621679709550"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HieUtils.html#getTypeIndex"><span class="hs-identifier hs-var">getTypeIndex</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">varType</span><span> </span><a href="#local-6989586621679709547"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-159"></a><span>      </span><a name="local-6989586621679709551"><a href="#local-6989586621679709551"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HieUtils.html#getTypeIndex"><span class="hs-identifier hs-var">getTypeIndex</span></a><span> </span><a href="#local-6989586621679709549"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-160"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HieTypes.html#HForAllTy"><span class="hs-identifier hs-var">HForAllTy</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">varName</span><span> </span><a href="#local-6989586621679709547"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">,</span><a href="#local-6989586621679709550"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span class="hs-special">,</span><a href="#local-6989586621679709548"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679709551"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-161"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunTy</span><span> </span><a name="local-6989586621679709552"><a href="#local-6989586621679709552"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679709553"><a href="#local-6989586621679709553"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-162"></a><span>      </span><a name="local-6989586621679709554"><a href="#local-6989586621679709554"><span class="hs-identifier">ai</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HieUtils.html#getTypeIndex"><span class="hs-identifier hs-var">getTypeIndex</span></a><span> </span><a href="#local-6989586621679709552"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-163"></a><span>      </span><a name="local-6989586621679709555"><a href="#local-6989586621679709555"><span class="hs-identifier">bi</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HieUtils.html#getTypeIndex"><span class="hs-identifier hs-var">getTypeIndex</span></a><span> </span><a href="#local-6989586621679709553"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-164"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isPredTy</span><span> </span><a href="#local-6989586621679709552"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-165"></a><span>                  </span><span class="hs-keyword">then</span><span> </span><a href="HieTypes.html#HQualTy"><span class="hs-identifier hs-var">HQualTy</span></a><span> </span><a href="#local-6989586621679709554"><span class="hs-identifier hs-var">ai</span></a><span> </span><a href="#local-6989586621679709555"><span class="hs-identifier hs-var">bi</span></a><span>
</span><a name="line-166"></a><span>                  </span><span class="hs-keyword">else</span><span> </span><a href="HieTypes.html#HFunTy"><span class="hs-identifier hs-var">HFunTy</span></a><span> </span><a href="#local-6989586621679709554"><span class="hs-identifier hs-var">ai</span></a><span> </span><a href="#local-6989586621679709555"><span class="hs-identifier hs-var">bi</span></a><span>
</span><a name="line-167"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitTy</span><span> </span><a name="local-6989586621679709556"><a href="#local-6989586621679709556"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HieTypes.html#HLitTy"><span class="hs-identifier hs-var">HLitTy</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">toIfaceTyLit</span><span> </span><a href="#local-6989586621679709556"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-168"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CastTy</span><span> </span><a name="local-6989586621679709557"><a href="#local-6989586621679709557"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-169"></a><span>      </span><a name="local-6989586621679709558"><a href="#local-6989586621679709558"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HieUtils.html#getTypeIndex"><span class="hs-identifier hs-var">getTypeIndex</span></a><span> </span><a href="#local-6989586621679709557"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-170"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HieTypes.html#HCastTy"><span class="hs-identifier hs-var">HCastTy</span></a><span> </span><a href="#local-6989586621679709558"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-171"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoercionTy</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="HieTypes.html#HCoercionTy"><span class="hs-identifier hs-var">HCoercionTy</span></a><span>
</span><a name="line-172"></a><span>
</span><a name="line-173"></a><span class="hs-identifier">resolveTyVarScopes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">M.Map</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><a href="#local-6989586621679709449"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">M.Map</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><a href="#local-6989586621679709449"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-174"></a><a name="resolveTyVarScopes"><a href="HieUtils.html#resolveTyVarScopes"><span class="hs-identifier">resolveTyVarScopes</span></a></a><span> </span><a name="local-6989586621679709562"><a href="#local-6989586621679709562"><span class="hs-identifier">asts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">M.map</span><span> </span><a href="#local-6989586621679709563"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679709562"><span class="hs-identifier hs-var">asts</span></a><span>
</span><a name="line-175"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-176"></a><span>    </span><a name="local-6989586621679709563"><a href="#local-6989586621679709563"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679709564"><a href="#local-6989586621679709564"><span class="hs-identifier">ast</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HieUtils.html#resolveTyVarScopeLocal"><span class="hs-identifier hs-var">resolveTyVarScopeLocal</span></a><span> </span><a href="#local-6989586621679709564"><span class="hs-identifier hs-var">ast</span></a><span> </span><a href="#local-6989586621679709562"><span class="hs-identifier hs-var">asts</span></a><span>
</span><a name="line-177"></a><span>
</span><a name="line-178"></a><span class="hs-identifier">resolveTyVarScopeLocal</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><a href="#local-6989586621679709448"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">M.Map</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><a href="#local-6989586621679709448"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><a href="#local-6989586621679709448"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-179"></a><a name="resolveTyVarScopeLocal"><a href="HieUtils.html#resolveTyVarScopeLocal"><span class="hs-identifier">resolveTyVarScopeLocal</span></a></a><span> </span><a name="local-6989586621679709565"><a href="#local-6989586621679709565"><span class="hs-identifier">ast</span></a></a><span> </span><a name="local-6989586621679709566"><a href="#local-6989586621679709566"><span class="hs-identifier">asts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709569"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679709565"><span class="hs-identifier hs-var">ast</span></a><span>
</span><a name="line-180"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-181"></a><span>    </span><a name="local-6989586621679709567"><a href="#local-6989586621679709567"><span class="hs-identifier">resolveNameScope</span></a></a><span> </span><a name="local-6989586621679709570"><a href="#local-6989586621679709570"><span class="hs-identifier">dets</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709570"><span class="hs-identifier hs-var">dets</span></a><span class="hs-special">{</span><span class="hs-identifier">identInfo</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-182"></a><span>      </span><span class="hs-identifier hs-var">S.map</span><span> </span><a href="#local-6989586621679709568"><span class="hs-identifier hs-var">resolveScope</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">identInfo</span><span> </span><a href="#local-6989586621679709570"><span class="hs-identifier hs-var">dets</span></a><span class="hs-special">)</span><span class="hs-special">}</span><span>
</span><a name="line-183"></a><span>    </span><a name="local-6989586621679709568"><a href="#local-6989586621679709568"><span class="hs-identifier">resolveScope</span></a></a><span> </span><span class="hs-special">(</span><a href="HieTypes.html#TyVarBind"><span class="hs-identifier hs-var">TyVarBind</span></a><span> </span><a name="local-6989586621679709571"><a href="#local-6989586621679709571"><span class="hs-identifier">sc</span></a></a><span> </span><span class="hs-special">(</span><a href="HieTypes.html#UnresolvedScope"><span class="hs-identifier hs-var">UnresolvedScope</span></a><span> </span><a name="local-6989586621679709572"><a href="#local-6989586621679709572"><span class="hs-identifier">names</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-184"></a><span>      </span><a href="HieTypes.html#TyVarBind"><span class="hs-identifier hs-var">TyVarBind</span></a><span> </span><a href="#local-6989586621679709571"><span class="hs-identifier hs-var">sc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HieTypes.html#ResolvedScopes"><span class="hs-identifier hs-var">ResolvedScopes</span></a><span>
</span><a name="line-185"></a><span>        </span><span class="hs-special">[</span><span> </span><a href="HieTypes.html#LocalScope"><span class="hs-identifier hs-var">LocalScope</span></a><span> </span><a href="#local-6989586621679709574"><span class="hs-identifier hs-var">binding</span></a><span>
</span><a name="line-186"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621679709573"><a href="#local-6989586621679709573"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679709572"><span class="hs-identifier hs-var">names</span></a><span>
</span><a name="line-187"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679709574"><a href="#local-6989586621679709574"><span class="hs-identifier">binding</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><a href="HieUtils.html#getNameBinding"><span class="hs-identifier hs-var">getNameBinding</span></a><span> </span><a href="#local-6989586621679709573"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679709566"><span class="hs-identifier hs-var">asts</span></a><span class="hs-special">]</span><span>
</span><a name="line-188"></a><span>        </span><span class="hs-special">]</span><span>
</span><a name="line-189"></a><span>    </span><span class="hs-identifier">resolveScope</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#TyVarBind"><span class="hs-identifier hs-var">TyVarBind</span></a><span> </span><a name="local-6989586621679709575"><a href="#local-6989586621679709575"><span class="hs-identifier">sc</span></a></a><span> </span><span class="hs-special">(</span><a href="HieTypes.html#UnresolvedScope"><span class="hs-identifier hs-var">UnresolvedScope</span></a><span> </span><a name="local-6989586621679709576"><a href="#local-6989586621679709576"><span class="hs-identifier">names</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679709577"><a href="#local-6989586621679709577"><span class="hs-identifier">sp</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-190"></a><span>      </span><a href="HieTypes.html#TyVarBind"><span class="hs-identifier hs-var">TyVarBind</span></a><span> </span><a href="#local-6989586621679709575"><span class="hs-identifier hs-var">sc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HieTypes.html#ResolvedScopes"><span class="hs-identifier hs-var">ResolvedScopes</span></a><span>
</span><a name="line-191"></a><span>        </span><span class="hs-special">[</span><span> </span><a href="HieTypes.html#LocalScope"><span class="hs-identifier hs-var">LocalScope</span></a><span> </span><a href="#local-6989586621679709579"><span class="hs-identifier hs-var">binding</span></a><span>
</span><a name="line-192"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621679709578"><a href="#local-6989586621679709578"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679709576"><span class="hs-identifier hs-var">names</span></a><span>
</span><a name="line-193"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679709579"><a href="#local-6989586621679709579"><span class="hs-identifier">binding</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><a href="HieUtils.html#getNameBindingInClass"><span class="hs-identifier hs-var">getNameBindingInClass</span></a><span> </span><a href="#local-6989586621679709578"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679709577"><span class="hs-identifier hs-var">sp</span></a><span> </span><a href="#local-6989586621679709566"><span class="hs-identifier hs-var">asts</span></a><span class="hs-special">]</span><span>
</span><a name="line-194"></a><span>        </span><span class="hs-special">]</span><span>
</span><a name="line-195"></a><span>    </span><span class="hs-identifier">resolveScope</span><span> </span><a name="local-6989586621679709580"><a href="#local-6989586621679709580"><span class="hs-identifier">scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709580"><span class="hs-identifier hs-var">scope</span></a><span>
</span><a name="line-196"></a><span>    </span><a name="local-6989586621679709569"><a href="#local-6989586621679709569"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="HieTypes.html#Node"><span class="hs-identifier hs-var">Node</span></a><span> </span><a name="local-6989586621679709581"><a href="#local-6989586621679709581"><span class="hs-identifier">info</span></a></a><span> </span><a name="local-6989586621679709582"><a href="#local-6989586621679709582"><span class="hs-identifier">span</span></a></a><span> </span><a name="local-6989586621679709583"><a href="#local-6989586621679709583"><span class="hs-identifier">children</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="HieTypes.html#Node"><span class="hs-identifier hs-var">Node</span></a><span> </span><a href="#local-6989586621679709584"><span class="hs-identifier hs-var">info'</span></a><span> </span><a href="#local-6989586621679709582"><span class="hs-identifier hs-var">span</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679709569"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679709583"><span class="hs-identifier hs-var">children</span></a><span>
</span><a name="line-197"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-198"></a><span>        </span><a name="local-6989586621679709584"><a href="#local-6989586621679709584"><span class="hs-identifier">info'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709581"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">nodeIdentifiers</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709585"><span class="hs-identifier hs-var">idents</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-199"></a><span>        </span><a name="local-6989586621679709585"><a href="#local-6989586621679709585"><span class="hs-identifier">idents</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">M.map</span><span> </span><a href="#local-6989586621679709567"><span class="hs-identifier hs-var">resolveNameScope</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">nodeIdentifiers</span><span> </span><a href="#local-6989586621679709581"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-200"></a><span>
</span><a name="line-201"></a><span class="hs-identifier">getNameBinding</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">M.Map</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><a href="#local-6989586621679709447"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="HieTypes.html#Span"><span class="hs-identifier hs-type">Span</span></a><span>
</span><a name="line-202"></a><a name="getNameBinding"><a href="HieUtils.html#getNameBinding"><span class="hs-identifier">getNameBinding</span></a></a><span> </span><a name="local-6989586621679709586"><a href="#local-6989586621679709586"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679709587"><a href="#local-6989586621679709587"><span class="hs-identifier">asts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-203"></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621679709588"><a href="#local-6989586621679709588"><span class="hs-identifier">msp</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HieUtils.html#getNameScopeAndBinding"><span class="hs-identifier hs-var">getNameScopeAndBinding</span></a><span> </span><a href="#local-6989586621679709586"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679709587"><span class="hs-identifier hs-var">asts</span></a><span>
</span><a name="line-204"></a><span>  </span><a href="#local-6989586621679709588"><span class="hs-identifier hs-var">msp</span></a><span>
</span><a name="line-205"></a><span>
</span><a name="line-206"></a><span class="hs-identifier">getNameScope</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">M.Map</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><a href="#local-6989586621679709446"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><a href="HieTypes.html#Scope"><span class="hs-identifier hs-type">Scope</span></a><span class="hs-special">]</span><span>
</span><a name="line-207"></a><a name="getNameScope"><a href="HieUtils.html#getNameScope"><span class="hs-identifier">getNameScope</span></a></a><span> </span><a name="local-6989586621679709589"><a href="#local-6989586621679709589"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679709590"><a href="#local-6989586621679709590"><span class="hs-identifier">asts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-208"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679709591"><a href="#local-6989586621679709591"><span class="hs-identifier">scopes</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HieUtils.html#getNameScopeAndBinding"><span class="hs-identifier hs-var">getNameScopeAndBinding</span></a><span> </span><a href="#local-6989586621679709589"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679709590"><span class="hs-identifier hs-var">asts</span></a><span>
</span><a name="line-209"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679709591"><span class="hs-identifier hs-var">scopes</span></a><span>
</span><a name="line-210"></a><span>
</span><a name="line-211"></a><span class="hs-identifier">getNameBindingInClass</span><span>
</span><a name="line-212"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-213"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HieTypes.html#Span"><span class="hs-identifier hs-type">Span</span></a><span>
</span><a name="line-214"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">M.Map</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><a href="#local-6989586621679709445"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-215"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="HieTypes.html#Span"><span class="hs-identifier hs-type">Span</span></a><span>
</span><a name="line-216"></a><a name="getNameBindingInClass"><a href="HieUtils.html#getNameBindingInClass"><span class="hs-identifier">getNameBindingInClass</span></a></a><span> </span><a name="local-6989586621679709592"><a href="#local-6989586621679709592"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679709593"><a href="#local-6989586621679709593"><span class="hs-identifier">sp</span></a></a><span> </span><a name="local-6989586621679709594"><a href="#local-6989586621679709594"><span class="hs-identifier">asts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-217"></a><span>  </span><a name="local-6989586621679709595"><a href="#local-6989586621679709595"><span class="hs-identifier">ast</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">M.lookup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">srcSpanFile</span><span> </span><a href="#local-6989586621679709593"><span class="hs-identifier hs-var">sp</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679709594"><span class="hs-identifier hs-var">asts</span></a><span>
</span><a name="line-218"></a><span>  </span><span class="hs-identifier">getFirst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">foldMap</span><span> </span><span class="hs-identifier hs-var">First</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-219"></a><span>    </span><a name="local-6989586621679709596"><a href="#local-6989586621679709596"><span class="hs-identifier">child</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HieUtils.html#flattenAst"><span class="hs-identifier hs-var">flattenAst</span></a><span> </span><a href="#local-6989586621679709595"><span class="hs-identifier hs-var">ast</span></a><span>
</span><a name="line-220"></a><span>    </span><a name="local-6989586621679709597"><a href="#local-6989586621679709597"><span class="hs-identifier">dets</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">maybeToList</span><span>
</span><a name="line-221"></a><span>      </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">M.lookup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679709592"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">nodeIdentifiers</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">nodeInfo</span><span> </span><a href="#local-6989586621679709596"><span class="hs-identifier hs-var">child</span></a><span>
</span><a name="line-222"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679709598"><a href="#local-6989586621679709598"><span class="hs-identifier">binding</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">First</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="HieUtils.html#getBindSiteFromContext"><span class="hs-identifier hs-var">getBindSiteFromContext</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">identInfo</span><span> </span><a href="#local-6989586621679709597"><span class="hs-identifier hs-var">dets</span></a><span class="hs-special">)</span><span>
</span><a name="line-223"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">getFirst</span><span> </span><a href="#local-6989586621679709598"><span class="hs-identifier hs-var">binding</span></a><span class="hs-special">)</span><span>
</span><a name="line-224"></a><span>
</span><a name="line-225"></a><span class="hs-identifier">getNameScopeAndBinding</span><span>
</span><a name="line-226"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-227"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">M.Map</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><a href="#local-6989586621679709444"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-228"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="HieTypes.html#Scope"><span class="hs-identifier hs-type">Scope</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="HieTypes.html#Span"><span class="hs-identifier hs-type">Span</span></a><span class="hs-special">)</span><span>
</span><a name="line-229"></a><a name="getNameScopeAndBinding"><a href="HieUtils.html#getNameScopeAndBinding"><span class="hs-identifier">getNameScopeAndBinding</span></a></a><span> </span><a name="local-6989586621679709599"><a href="#local-6989586621679709599"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679709600"><a href="#local-6989586621679709600"><span class="hs-identifier">asts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">nameSrcSpan</span><span> </span><a href="#local-6989586621679709599"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-230"></a><span>  </span><span class="hs-identifier hs-var">RealSrcSpan</span><span> </span><a name="local-6989586621679709601"><a href="#local-6989586621679709601"><span class="hs-identifier">sp</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- @Maybe</span><span>
</span><a name="line-231"></a><span>    </span><a name="local-6989586621679709602"><a href="#local-6989586621679709602"><span class="hs-identifier">ast</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">M.lookup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">srcSpanFile</span><span> </span><a href="#local-6989586621679709601"><span class="hs-identifier hs-var">sp</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679709600"><span class="hs-identifier hs-var">asts</span></a><span>
</span><a name="line-232"></a><span>    </span><a name="local-6989586621679709603"><a href="#local-6989586621679709603"><span class="hs-identifier">defNode</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HieUtils.html#selectLargestContainedBy"><span class="hs-identifier hs-var">selectLargestContainedBy</span></a><span> </span><a href="#local-6989586621679709601"><span class="hs-identifier hs-var">sp</span></a><span> </span><a href="#local-6989586621679709602"><span class="hs-identifier hs-var">ast</span></a><span>
</span><a name="line-233"></a><span>    </span><span class="hs-identifier">getFirst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">foldMap</span><span> </span><span class="hs-identifier hs-var">First</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- @[]</span><span>
</span><a name="line-234"></a><span>      </span><a name="local-6989586621679709604"><a href="#local-6989586621679709604"><span class="hs-identifier">node</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HieUtils.html#flattenAst"><span class="hs-identifier hs-var">flattenAst</span></a><span> </span><a href="#local-6989586621679709603"><span class="hs-identifier hs-var">defNode</span></a><span>
</span><a name="line-235"></a><span>      </span><a name="local-6989586621679709605"><a href="#local-6989586621679709605"><span class="hs-identifier">dets</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">maybeToList</span><span>
</span><a name="line-236"></a><span>        </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">M.lookup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621679709599"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">nodeIdentifiers</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">nodeInfo</span><span> </span><a href="#local-6989586621679709604"><span class="hs-identifier hs-var">node</span></a><span>
</span><a name="line-237"></a><span>      </span><a name="local-6989586621679709606"><a href="#local-6989586621679709606"><span class="hs-identifier">scopes</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">maybeToList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">foldMap</span><span> </span><a href="HieUtils.html#getScopeFromContext"><span class="hs-identifier hs-var">getScopeFromContext</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">identInfo</span><span> </span><a href="#local-6989586621679709605"><span class="hs-identifier hs-var">dets</span></a><span class="hs-special">)</span><span>
</span><a name="line-238"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679709607"><a href="#local-6989586621679709607"><span class="hs-identifier">binding</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">First</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="HieUtils.html#getBindSiteFromContext"><span class="hs-identifier hs-var">getBindSiteFromContext</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">identInfo</span><span> </span><a href="#local-6989586621679709605"><span class="hs-identifier hs-var">dets</span></a><span class="hs-special">)</span><span>
</span><a name="line-239"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679709606"><span class="hs-identifier hs-var">scopes</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">getFirst</span><span> </span><a href="#local-6989586621679709607"><span class="hs-identifier hs-var">binding</span></a><span class="hs-special">)</span><span>
</span><a name="line-240"></a><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-241"></a><span>
</span><a name="line-242"></a><span class="hs-identifier">getScopeFromContext</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HieTypes.html#ContextInfo"><span class="hs-identifier hs-type">ContextInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><a href="HieTypes.html#Scope"><span class="hs-identifier hs-type">Scope</span></a><span class="hs-special">]</span><span>
</span><a name="line-243"></a><a name="getScopeFromContext"><a href="HieUtils.html#getScopeFromContext"><span class="hs-identifier">getScopeFromContext</span></a></a><span> </span><span class="hs-special">(</span><a href="HieTypes.html#ValBind"><span class="hs-identifier hs-var">ValBind</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679709608"><a href="#local-6989586621679709608"><span class="hs-identifier">sc</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679709608"><span class="hs-identifier hs-var">sc</span></a><span class="hs-special">]</span><span>
</span><a name="line-244"></a><span class="hs-identifier">getScopeFromContext</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#PatternBind"><span class="hs-identifier hs-var">PatternBind</span></a><span> </span><a name="local-6989586621679709609"><a href="#local-6989586621679709609"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679709610"><a href="#local-6989586621679709610"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679709609"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679709610"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">]</span><span>
</span><a name="line-245"></a><span class="hs-identifier">getScopeFromContext</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#ClassTyDecl"><span class="hs-identifier hs-var">ClassTyDecl</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">[</span><a href="HieTypes.html#ModuleScope"><span class="hs-identifier hs-var">ModuleScope</span></a><span class="hs-special">]</span><span>
</span><a name="line-246"></a><span class="hs-identifier">getScopeFromContext</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#Decl"><span class="hs-identifier hs-var">Decl</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">[</span><a href="HieTypes.html#ModuleScope"><span class="hs-identifier hs-var">ModuleScope</span></a><span class="hs-special">]</span><span>
</span><a name="line-247"></a><span class="hs-identifier">getScopeFromContext</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#TyVarBind"><span class="hs-identifier hs-var">TyVarBind</span></a><span> </span><a name="local-6989586621679709611"><a href="#local-6989586621679709611"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-special">(</span><a href="HieTypes.html#ResolvedScopes"><span class="hs-identifier hs-var">ResolvedScopes</span></a><span> </span><a name="local-6989586621679709612"><a href="#local-6989586621679709612"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679709611"><span class="hs-identifier hs-var">a</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679709612"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-248"></a><span class="hs-identifier">getScopeFromContext</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#TyVarBind"><span class="hs-identifier hs-var">TyVarBind</span></a><span> </span><a name="local-6989586621679709613"><a href="#local-6989586621679709613"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679709613"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-249"></a><span class="hs-identifier">getScopeFromContext</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-250"></a><span>
</span><a name="line-251"></a><span class="hs-identifier">getBindSiteFromContext</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HieTypes.html#ContextInfo"><span class="hs-identifier hs-type">ContextInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="HieTypes.html#Span"><span class="hs-identifier hs-type">Span</span></a><span>
</span><a name="line-252"></a><a name="getBindSiteFromContext"><a href="HieUtils.html#getBindSiteFromContext"><span class="hs-identifier">getBindSiteFromContext</span></a></a><span> </span><span class="hs-special">(</span><a href="HieTypes.html#ValBind"><span class="hs-identifier hs-var">ValBind</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679709614"><a href="#local-6989586621679709614"><span class="hs-identifier">sp</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709614"><span class="hs-identifier hs-var">sp</span></a><span>
</span><a name="line-253"></a><span class="hs-identifier">getBindSiteFromContext</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#PatternBind"><span class="hs-identifier hs-var">PatternBind</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679709615"><a href="#local-6989586621679709615"><span class="hs-identifier">sp</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709615"><span class="hs-identifier hs-var">sp</span></a><span>
</span><a name="line-254"></a><span class="hs-identifier">getBindSiteFromContext</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-255"></a><span>
</span><a name="line-256"></a><span class="hs-identifier">flattenAst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><a href="#local-6989586621679709443"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><a href="#local-6989586621679709443"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-257"></a><a name="flattenAst"><a href="HieUtils.html#flattenAst"><span class="hs-identifier">flattenAst</span></a></a><span> </span><a name="local-6989586621679709616"><a href="#local-6989586621679709616"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-258"></a><span>  </span><a href="#local-6989586621679709616"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="HieUtils.html#flattenAst"><span class="hs-identifier hs-var">flattenAst</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">nodeChildren</span><span> </span><a href="#local-6989586621679709616"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-259"></a><span>
</span><a name="line-260"></a><span class="hs-identifier">smallestContainingSatisfying</span><span>
</span><a name="line-261"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="HieTypes.html#Span"><span class="hs-identifier hs-type">Span</span></a><span>
</span><a name="line-262"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><a href="#local-6989586621679709442"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>
</span><a name="line-263"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><a href="#local-6989586621679709442"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-264"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><a href="#local-6989586621679709442"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-265"></a><a name="smallestContainingSatisfying"><a href="HieUtils.html#smallestContainingSatisfying"><span class="hs-identifier">smallestContainingSatisfying</span></a></a><span> </span><a name="local-6989586621679709617"><a href="#local-6989586621679709617"><span class="hs-identifier">sp</span></a></a><span> </span><a name="local-6989586621679709618"><a href="#local-6989586621679709618"><span class="hs-identifier">cond</span></a></a><span> </span><a name="local-6989586621679709619"><a href="#local-6989586621679709619"><span class="hs-identifier">node</span></a></a><span>
</span><a name="line-266"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">nodeSpan</span><span> </span><a href="#local-6989586621679709619"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">containsSpan</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679709617"><span class="hs-identifier hs-var">sp</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">getFirst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mconcat</span><span>
</span><a name="line-267"></a><span>      </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">foldMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">First</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="HieUtils.html#smallestContainingSatisfying"><span class="hs-identifier hs-var">smallestContainingSatisfying</span></a><span> </span><a href="#local-6989586621679709617"><span class="hs-identifier hs-var">sp</span></a><span> </span><a href="#local-6989586621679709618"><span class="hs-identifier hs-var">cond</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-268"></a><span>          </span><span class="hs-identifier">nodeChildren</span><span> </span><a href="#local-6989586621679709619"><span class="hs-identifier hs-var">node</span></a><span>
</span><a name="line-269"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">First</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679709618"><span class="hs-identifier hs-var">cond</span></a><span> </span><a href="#local-6989586621679709619"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679709619"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-270"></a><span>      </span><span class="hs-special">]</span><span>
</span><a name="line-271"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679709617"><span class="hs-identifier hs-var">sp</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">containsSpan</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">nodeSpan</span><span> </span><a href="#local-6989586621679709619"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-272"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-273"></a><span>
</span><a name="line-274"></a><span class="hs-identifier">selectLargestContainedBy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HieTypes.html#Span"><span class="hs-identifier hs-type">Span</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><a href="#local-6989586621679709441"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><a href="#local-6989586621679709441"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-275"></a><a name="selectLargestContainedBy"><a href="HieUtils.html#selectLargestContainedBy"><span class="hs-identifier">selectLargestContainedBy</span></a></a><span> </span><a name="local-6989586621679709620"><a href="#local-6989586621679709620"><span class="hs-identifier">sp</span></a></a><span> </span><a name="local-6989586621679709621"><a href="#local-6989586621679709621"><span class="hs-identifier">node</span></a></a><span>
</span><a name="line-276"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679709620"><span class="hs-identifier hs-var">sp</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">containsSpan</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">nodeSpan</span><span> </span><a href="#local-6989586621679709621"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679709621"><span class="hs-identifier hs-var">node</span></a><span>
</span><a name="line-277"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">nodeSpan</span><span> </span><a href="#local-6989586621679709621"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">containsSpan</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679709620"><span class="hs-identifier hs-var">sp</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-278"></a><span>      </span><span class="hs-identifier">getFirst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">foldMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">First</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="HieUtils.html#selectLargestContainedBy"><span class="hs-identifier hs-var">selectLargestContainedBy</span></a><span> </span><a href="#local-6989586621679709620"><span class="hs-identifier hs-var">sp</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-279"></a><span>        </span><span class="hs-identifier">nodeChildren</span><span> </span><a href="#local-6989586621679709621"><span class="hs-identifier hs-var">node</span></a><span>
</span><a name="line-280"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-281"></a><span>
</span><a name="line-282"></a><span class="hs-identifier">selectSmallestContaining</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HieTypes.html#Span"><span class="hs-identifier hs-type">Span</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><a href="#local-6989586621679709440"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><a href="#local-6989586621679709440"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-283"></a><a name="selectSmallestContaining"><a href="HieUtils.html#selectSmallestContaining"><span class="hs-identifier">selectSmallestContaining</span></a></a><span> </span><a name="local-6989586621679709622"><a href="#local-6989586621679709622"><span class="hs-identifier">sp</span></a></a><span> </span><a name="local-6989586621679709623"><a href="#local-6989586621679709623"><span class="hs-identifier">node</span></a></a><span>
</span><a name="line-284"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">nodeSpan</span><span> </span><a href="#local-6989586621679709623"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">containsSpan</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679709622"><span class="hs-identifier hs-var">sp</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">getFirst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mconcat</span><span>
</span><a name="line-285"></a><span>      </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">foldMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">First</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="HieUtils.html#selectSmallestContaining"><span class="hs-identifier hs-var">selectSmallestContaining</span></a><span> </span><a href="#local-6989586621679709622"><span class="hs-identifier hs-var">sp</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">nodeChildren</span><span> </span><a href="#local-6989586621679709623"><span class="hs-identifier hs-var">node</span></a><span>
</span><a name="line-286"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">First</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679709623"><span class="hs-identifier hs-var">node</span></a><span class="hs-special">)</span><span>
</span><a name="line-287"></a><span>      </span><span class="hs-special">]</span><span>
</span><a name="line-288"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679709622"><span class="hs-identifier hs-var">sp</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">containsSpan</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">nodeSpan</span><span> </span><a href="#local-6989586621679709623"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-289"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-290"></a><span>
</span><a name="line-291"></a><span class="hs-identifier">definedInAsts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">M.Map</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><a href="#local-6989586621679709439"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-292"></a><a name="definedInAsts"><a href="HieUtils.html#definedInAsts"><span class="hs-identifier">definedInAsts</span></a></a><span> </span><a name="local-6989586621679709624"><a href="#local-6989586621679709624"><span class="hs-identifier">asts</span></a></a><span> </span><a name="local-6989586621679709625"><a href="#local-6989586621679709625"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">nameSrcSpan</span><span> </span><a href="#local-6989586621679709625"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-293"></a><span>  </span><span class="hs-identifier hs-var">RealSrcSpan</span><span> </span><a name="local-6989586621679709626"><a href="#local-6989586621679709626"><span class="hs-identifier">sp</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">srcSpanFile</span><span> </span><a href="#local-6989586621679709626"><span class="hs-identifier hs-var">sp</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">M.keys</span><span> </span><a href="#local-6989586621679709624"><span class="hs-identifier hs-var">asts</span></a><span>
</span><a name="line-294"></a><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-295"></a><span>
</span><a name="line-296"></a><span class="hs-identifier">isOccurrence</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HieTypes.html#ContextInfo"><span class="hs-identifier hs-type">ContextInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-297"></a><a name="isOccurrence"><a href="HieUtils.html#isOccurrence"><span class="hs-identifier">isOccurrence</span></a></a><span> </span><a href="HieTypes.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-298"></a><span class="hs-identifier">isOccurrence</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-299"></a><span>
</span><a name="line-300"></a><span class="hs-identifier">scopeContainsSpan</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HieTypes.html#Scope"><span class="hs-identifier hs-type">Scope</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HieTypes.html#Span"><span class="hs-identifier hs-type">Span</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-301"></a><a name="scopeContainsSpan"><a href="HieUtils.html#scopeContainsSpan"><span class="hs-identifier">scopeContainsSpan</span></a></a><span> </span><a href="HieTypes.html#NoScope"><span class="hs-identifier hs-var">NoScope</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-302"></a><span class="hs-identifier">scopeContainsSpan</span><span> </span><a href="HieTypes.html#ModuleScope"><span class="hs-identifier hs-var">ModuleScope</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-303"></a><span class="hs-identifier">scopeContainsSpan</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#LocalScope"><span class="hs-identifier hs-var">LocalScope</span></a><span> </span><a name="local-6989586621679709627"><a href="#local-6989586621679709627"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679709628"><a href="#local-6989586621679709628"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709627"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">containsSpan</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679709628"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-304"></a><span>
</span><a name="line-305"></a><span class="hs-comment">-- | One must contain the other. Leaf nodes cannot contain anything</span><span>
</span><a name="line-306"></a><span class="hs-identifier">combineAst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-307"></a><a name="combineAst"><a href="HieUtils.html#combineAst"><span class="hs-identifier">combineAst</span></a></a><span> </span><a name="local-6989586621679709629"><a href="#local-6989586621679709629"><span class="hs-identifier">a</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="HieTypes.html#Node"><span class="hs-identifier hs-var">Node</span></a><span> </span><a name="local-6989586621679709630"><a href="#local-6989586621679709630"><span class="hs-identifier">aInf</span></a></a><span> </span><a name="local-6989586621679709631"><a href="#local-6989586621679709631"><span class="hs-identifier">aSpn</span></a></a><span> </span><a name="local-6989586621679709632"><a href="#local-6989586621679709632"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679709633"><a href="#local-6989586621679709633"><span class="hs-identifier">b</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="HieTypes.html#Node"><span class="hs-identifier hs-var">Node</span></a><span> </span><a name="local-6989586621679709634"><a href="#local-6989586621679709634"><span class="hs-identifier">bInf</span></a></a><span> </span><a name="local-6989586621679709635"><a href="#local-6989586621679709635"><span class="hs-identifier">bSpn</span></a></a><span> </span><a name="local-6989586621679709636"><a href="#local-6989586621679709636"><span class="hs-identifier">ys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-308"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679709631"><span class="hs-identifier hs-var">aSpn</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679709635"><span class="hs-identifier hs-var">bSpn</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HieTypes.html#Node"><span class="hs-identifier hs-var">Node</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679709630"><span class="hs-identifier hs-var">aInf</span></a><span> </span><span class="hs-special">`</span><a href="HieUtils.html#combineNodeInfo"><span class="hs-identifier hs-var">combineNodeInfo</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679709634"><span class="hs-identifier hs-var">bInf</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679709631"><span class="hs-identifier hs-var">aSpn</span></a><span> </span><span class="hs-special">(</span><a href="HieUtils.html#mergeAsts"><span class="hs-identifier hs-var">mergeAsts</span></a><span> </span><a href="#local-6989586621679709632"><span class="hs-identifier hs-var">xs</span></a><span> </span><a href="#local-6989586621679709636"><span class="hs-identifier hs-var">ys</span></a><span class="hs-special">)</span><span>
</span><a name="line-309"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679709631"><span class="hs-identifier hs-var">aSpn</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">containsSpan</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679709635"><span class="hs-identifier hs-var">bSpn</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HieUtils.html#combineAst"><span class="hs-identifier hs-var">combineAst</span></a><span> </span><a href="#local-6989586621679709633"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621679709629"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-310"></a><span class="hs-identifier">combineAst</span><span> </span><a name="local-6989586621679709637"><a href="#local-6989586621679709637"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-special">(</span><a href="HieTypes.html#Node"><span class="hs-identifier hs-var">Node</span></a><span> </span><a name="local-6989586621679709638"><a href="#local-6989586621679709638"><span class="hs-identifier">xs</span></a></a><span> </span><a name="local-6989586621679709639"><a href="#local-6989586621679709639"><span class="hs-identifier">span</span></a></a><span> </span><a name="local-6989586621679709640"><a href="#local-6989586621679709640"><span class="hs-identifier">children</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="HieTypes.html#Node"><span class="hs-identifier hs-var">Node</span></a><span> </span><a href="#local-6989586621679709638"><span class="hs-identifier hs-var">xs</span></a><span> </span><a href="#local-6989586621679709639"><span class="hs-identifier hs-var">span</span></a><span> </span><span class="hs-special">(</span><a href="HieUtils.html#insertAst"><span class="hs-identifier hs-var">insertAst</span></a><span> </span><a href="#local-6989586621679709637"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679709640"><span class="hs-identifier hs-var">children</span></a><span class="hs-special">)</span><span>
</span><a name="line-311"></a><span>
</span><a name="line-312"></a><span class="hs-comment">-- | Insert an AST in a sorted list of disjoint Asts</span><span>
</span><a name="line-313"></a><span class="hs-identifier">insertAst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-314"></a><a name="insertAst"><a href="HieUtils.html#insertAst"><span class="hs-identifier">insertAst</span></a></a><span> </span><a name="local-6989586621679709641"><a href="#local-6989586621679709641"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HieUtils.html#mergeAsts"><span class="hs-identifier hs-var">mergeAsts</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679709641"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">]</span><span>
</span><a name="line-315"></a><span>
</span><a name="line-316"></a><span class="hs-comment">-- | Merge two nodes together.</span><span>
</span><a name="line-317"></a><span class="hs-comment">--</span><span>
</span><a name="line-318"></a><span class="hs-comment">-- Precondition and postcondition: elements in 'nodeType' are ordered.</span><span>
</span><a name="line-319"></a><span class="hs-identifier">combineNodeInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HieTypes.html#NodeInfo"><span class="hs-identifier hs-type">NodeInfo</span></a><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HieTypes.html#NodeInfo"><span class="hs-identifier hs-type">NodeInfo</span></a><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HieTypes.html#NodeInfo"><span class="hs-identifier hs-type">NodeInfo</span></a><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-320"></a><span class="hs-special">(</span><a href="HieTypes.html#NodeInfo"><span class="hs-identifier hs-var">NodeInfo</span></a><span> </span><span class="hs-keyword">as</span><span> </span><a name="local-6989586621679709643"><a href="#local-6989586621679709643"><span class="hs-identifier">ai</span></a></a><span> </span><a name="local-6989586621679709644"><a href="#local-6989586621679709644"><span class="hs-identifier">ad</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a name="combineNodeInfo"><a href="HieUtils.html#combineNodeInfo"><span class="hs-identifier">combineNodeInfo</span></a></a><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#NodeInfo"><span class="hs-identifier hs-var">NodeInfo</span></a><span> </span><a name="local-6989586621679709645"><a href="#local-6989586621679709645"><span class="hs-identifier">bs</span></a></a><span> </span><a name="local-6989586621679709646"><a href="#local-6989586621679709646"><span class="hs-identifier">bi</span></a></a><span> </span><a name="local-6989586621679709647"><a href="#local-6989586621679709647"><span class="hs-identifier">bd</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-321"></a><span>  </span><a href="HieTypes.html#NodeInfo"><span class="hs-identifier hs-var">NodeInfo</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">S.union</span><span> </span><span class="hs-keyword">as</span><span> </span><a href="#local-6989586621679709645"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679709648"><span class="hs-identifier hs-var">mergeSorted</span></a><span> </span><a href="#local-6989586621679709643"><span class="hs-identifier hs-var">ai</span></a><span> </span><a href="#local-6989586621679709646"><span class="hs-identifier hs-var">bi</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">M.unionWith</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679709644"><span class="hs-identifier hs-var">ad</span></a><span> </span><a href="#local-6989586621679709647"><span class="hs-identifier hs-var">bd</span></a><span class="hs-special">)</span><span>
</span><a name="line-322"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-323"></a><span>    </span><span class="hs-identifier">mergeSorted</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-324"></a><span>    </span><a name="local-6989586621679709648"><a href="#local-6989586621679709648"><span class="hs-identifier">mergeSorted</span></a></a><span> </span><a name="local-6989586621679709649"><a href="#local-6989586621679709649"><span class="hs-identifier">la</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621679709650"><a href="#local-6989586621679709650"><span class="hs-identifier">a</span></a></a><span class="hs-glyph">:</span><span class="hs-keyword">as</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679709652"><a href="#local-6989586621679709652"><span class="hs-identifier">lb</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621679709653"><a href="#local-6989586621679709653"><span class="hs-identifier">b</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679709654"><a href="#local-6989586621679709654"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">nonDetCmpType</span><span> </span><a href="#local-6989586621679709650"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679709653"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-325"></a><span>                                        </span><span class="hs-identifier hs-var">LT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679709650"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679709648"><span class="hs-identifier hs-var">mergeSorted</span></a><span> </span><span class="hs-keyword">as</span><span> </span><a href="#local-6989586621679709652"><span class="hs-identifier hs-var">lb</span></a><span>
</span><a name="line-326"></a><span>                                        </span><span class="hs-identifier hs-var">EQ</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679709650"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679709648"><span class="hs-identifier hs-var">mergeSorted</span></a><span> </span><span class="hs-keyword">as</span><span> </span><a href="#local-6989586621679709654"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-327"></a><span>                                        </span><span class="hs-identifier hs-var">GT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679709653"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679709648"><span class="hs-identifier hs-var">mergeSorted</span></a><span> </span><a href="#local-6989586621679709649"><span class="hs-identifier hs-var">la</span></a><span> </span><a href="#local-6989586621679709654"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-328"></a><span>    </span><span class="hs-identifier">mergeSorted</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-329"></a><span>    </span><span class="hs-identifier">mergeSorted</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621679709656"><a href="#local-6989586621679709656"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709656"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-330"></a><span>
</span><a name="line-331"></a><span>
</span><a name="line-332"></a><span class="hs-comment">{- | Merge two sorted, disjoint lists of ASTs, combining when necessary.

In the absence of position-altering pragmas (ex: @# line &quot;file.hs&quot; 3@),
different nodes in an AST tree should either have disjoint spans (in
which case you can say for sure which one comes first) or one span
should be completely contained in the other (in which case the contained
span corresponds to some child node).

However, since Haskell does have position-altering pragmas it /is/
possible for spans to be overlapping. Here is an example of a source file
in which @foozball@ and @quuuuuux@ have overlapping spans:

@
module Baz where

# line 3 &quot;Baz.hs&quot;
foozball :: Int
foozball = 0

# line 3 &quot;Baz.hs&quot;
bar, quuuuuux :: Int
bar = 1
quuuuuux = 2
@

In these cases, we just do our best to produce sensible `HieAST`'s. The blame
should be laid at the feet of whoever wrote the line pragmas in the first place
(usually the C preprocessor...).
-}</span><span>
</span><a name="line-361"></a><span class="hs-identifier">mergeAsts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-362"></a><a name="mergeAsts"><a href="HieUtils.html#mergeAsts"><span class="hs-identifier">mergeAsts</span></a></a><span> </span><a name="local-6989586621679709657"><a href="#local-6989586621679709657"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709657"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-363"></a><span class="hs-identifier">mergeAsts</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621679709658"><a href="#local-6989586621679709658"><span class="hs-identifier">ys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709658"><span class="hs-identifier hs-var">ys</span></a><span>
</span><a name="line-364"></a><span class="hs-identifier">mergeAsts</span><span> </span><a name="local-6989586621679709659"><a href="#local-6989586621679709659"><span class="hs-identifier">xs</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621679709660"><a href="#local-6989586621679709660"><span class="hs-identifier">a</span></a></a><span class="hs-glyph">:</span><span class="hs-keyword">as</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679709662"><a href="#local-6989586621679709662"><span class="hs-identifier">ys</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621679709663"><a href="#local-6989586621679709663"><span class="hs-identifier">b</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679709664"><a href="#local-6989586621679709664"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-365"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679709665"><span class="hs-identifier hs-var">span_a</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">containsSpan</span><span class="hs-special">`</span><span>   </span><a href="#local-6989586621679709666"><span class="hs-identifier hs-var">span_b</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HieUtils.html#mergeAsts"><span class="hs-identifier hs-var">mergeAsts</span></a><span> </span><span class="hs-special">(</span><a href="HieUtils.html#combineAst"><span class="hs-identifier hs-var">combineAst</span></a><span> </span><a href="#local-6989586621679709660"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679709663"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679709664"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-366"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679709666"><span class="hs-identifier hs-var">span_b</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">containsSpan</span><span class="hs-special">`</span><span>   </span><a href="#local-6989586621679709665"><span class="hs-identifier hs-var">span_a</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HieUtils.html#mergeAsts"><span class="hs-identifier hs-var">mergeAsts</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-special">(</span><a href="HieUtils.html#combineAst"><span class="hs-identifier hs-var">combineAst</span></a><span> </span><a href="#local-6989586621679709660"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679709663"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679709664"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span>
</span><a name="line-367"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679709665"><span class="hs-identifier hs-var">span_a</span></a><span> </span><span class="hs-special">`</span><a href="HieUtils.html#rightOf"><span class="hs-identifier hs-var">rightOf</span></a><span class="hs-special">`</span><span>        </span><a href="#local-6989586621679709666"><span class="hs-identifier hs-var">span_b</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709663"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="HieUtils.html#mergeAsts"><span class="hs-identifier hs-var">mergeAsts</span></a><span> </span><a href="#local-6989586621679709659"><span class="hs-identifier hs-var">xs</span></a><span> </span><a href="#local-6989586621679709664"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-368"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679709665"><span class="hs-identifier hs-var">span_a</span></a><span> </span><span class="hs-special">`</span><a href="HieUtils.html#leftOf"><span class="hs-identifier hs-var">leftOf</span></a><span class="hs-special">`</span><span>         </span><a href="#local-6989586621679709666"><span class="hs-identifier hs-var">span_b</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709660"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="HieUtils.html#mergeAsts"><span class="hs-identifier hs-var">mergeAsts</span></a><span> </span><span class="hs-keyword">as</span><span> </span><a href="#local-6989586621679709662"><span class="hs-identifier hs-var">ys</span></a><span>
</span><a name="line-369"></a><span>
</span><a name="line-370"></a><span>  </span><span class="hs-comment">-- These cases are to work around ASTs that are not fully disjoint</span><span>
</span><a name="line-371"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679709665"><span class="hs-identifier hs-var">span_a</span></a><span> </span><span class="hs-special">`</span><a href="HieUtils.html#startsRightOf"><span class="hs-identifier hs-var">startsRightOf</span></a><span class="hs-special">`</span><span>  </span><a href="#local-6989586621679709666"><span class="hs-identifier hs-var">span_b</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709663"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="HieUtils.html#mergeAsts"><span class="hs-identifier hs-var">mergeAsts</span></a><span> </span><span class="hs-keyword">as</span><span> </span><a href="#local-6989586621679709662"><span class="hs-identifier hs-var">ys</span></a><span>
</span><a name="line-372"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709660"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="HieUtils.html#mergeAsts"><span class="hs-identifier hs-var">mergeAsts</span></a><span> </span><span class="hs-keyword">as</span><span> </span><a href="#local-6989586621679709662"><span class="hs-identifier hs-var">ys</span></a><span>
</span><a name="line-373"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-374"></a><span>    </span><a name="local-6989586621679709665"><a href="#local-6989586621679709665"><span class="hs-identifier">span_a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">nodeSpan</span><span> </span><a href="#local-6989586621679709660"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-375"></a><span>    </span><a name="local-6989586621679709666"><a href="#local-6989586621679709666"><span class="hs-identifier">span_b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">nodeSpan</span><span> </span><a href="#local-6989586621679709663"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-376"></a><span>
</span><a name="line-377"></a><span class="hs-identifier">rightOf</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HieTypes.html#Span"><span class="hs-identifier hs-type">Span</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HieTypes.html#Span"><span class="hs-identifier hs-type">Span</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-378"></a><a name="rightOf"><a href="HieUtils.html#rightOf"><span class="hs-identifier">rightOf</span></a></a><span> </span><a name="local-6989586621679709667"><a href="#local-6989586621679709667"><span class="hs-identifier">s1</span></a></a><span> </span><a name="local-6989586621679709668"><a href="#local-6989586621679709668"><span class="hs-identifier">s2</span></a></a><span>
</span><a name="line-379"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">srcSpanStartLine</span><span> </span><a href="#local-6989586621679709667"><span class="hs-identifier hs-var">s1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">srcSpanStartCol</span><span> </span><a href="#local-6989586621679709667"><span class="hs-identifier hs-var">s1</span></a><span class="hs-special">)</span><span>
</span><a name="line-380"></a><span>       </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">srcSpanEndLine</span><span> </span><a href="#local-6989586621679709668"><span class="hs-identifier hs-var">s2</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">srcSpanEndCol</span><span> </span><a href="#local-6989586621679709668"><span class="hs-identifier hs-var">s2</span></a><span class="hs-special">)</span><span>
</span><a name="line-381"></a><span>    </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">srcSpanFile</span><span> </span><a href="#local-6989586621679709667"><span class="hs-identifier hs-var">s1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">srcSpanFile</span><span> </span><a href="#local-6989586621679709668"><span class="hs-identifier hs-var">s2</span></a><span class="hs-special">)</span><span>
</span><a name="line-382"></a><span>
</span><a name="line-383"></a><span class="hs-identifier">leftOf</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HieTypes.html#Span"><span class="hs-identifier hs-type">Span</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HieTypes.html#Span"><span class="hs-identifier hs-type">Span</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-384"></a><a name="leftOf"><a href="HieUtils.html#leftOf"><span class="hs-identifier">leftOf</span></a></a><span> </span><a name="local-6989586621679709669"><a href="#local-6989586621679709669"><span class="hs-identifier">s1</span></a></a><span> </span><a name="local-6989586621679709670"><a href="#local-6989586621679709670"><span class="hs-identifier">s2</span></a></a><span>
</span><a name="line-385"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">srcSpanEndLine</span><span> </span><a href="#local-6989586621679709669"><span class="hs-identifier hs-var">s1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">srcSpanEndCol</span><span> </span><a href="#local-6989586621679709669"><span class="hs-identifier hs-var">s1</span></a><span class="hs-special">)</span><span>
</span><a name="line-386"></a><span>       </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">srcSpanStartLine</span><span> </span><a href="#local-6989586621679709670"><span class="hs-identifier hs-var">s2</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">srcSpanStartCol</span><span> </span><a href="#local-6989586621679709670"><span class="hs-identifier hs-var">s2</span></a><span class="hs-special">)</span><span>
</span><a name="line-387"></a><span>    </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">srcSpanFile</span><span> </span><a href="#local-6989586621679709669"><span class="hs-identifier hs-var">s1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">srcSpanFile</span><span> </span><a href="#local-6989586621679709670"><span class="hs-identifier hs-var">s2</span></a><span class="hs-special">)</span><span>
</span><a name="line-388"></a><span>
</span><a name="line-389"></a><span class="hs-identifier">startsRightOf</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HieTypes.html#Span"><span class="hs-identifier hs-type">Span</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HieTypes.html#Span"><span class="hs-identifier hs-type">Span</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-390"></a><a name="startsRightOf"><a href="HieUtils.html#startsRightOf"><span class="hs-identifier">startsRightOf</span></a></a><span> </span><a name="local-6989586621679709671"><a href="#local-6989586621679709671"><span class="hs-identifier">s1</span></a></a><span> </span><a name="local-6989586621679709672"><a href="#local-6989586621679709672"><span class="hs-identifier">s2</span></a></a><span>
</span><a name="line-391"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">srcSpanStartLine</span><span> </span><a href="#local-6989586621679709671"><span class="hs-identifier hs-var">s1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">srcSpanStartCol</span><span> </span><a href="#local-6989586621679709671"><span class="hs-identifier hs-var">s1</span></a><span class="hs-special">)</span><span>
</span><a name="line-392"></a><span>       </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">srcSpanStartLine</span><span> </span><a href="#local-6989586621679709672"><span class="hs-identifier hs-var">s2</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">srcSpanStartCol</span><span> </span><a href="#local-6989586621679709672"><span class="hs-identifier hs-var">s2</span></a><span class="hs-special">)</span><span>
</span><a name="line-393"></a><span>
</span><a name="line-394"></a><span class="hs-comment">-- | combines and sorts ASTs using a merge sort</span><span>
</span><a name="line-395"></a><span class="hs-identifier">mergeSortAsts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-396"></a><a name="mergeSortAsts"><a href="HieUtils.html#mergeSortAsts"><span class="hs-identifier">mergeSortAsts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709673"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">pure</span><span>
</span><a name="line-397"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-398"></a><span>    </span><a name="local-6989586621679709673"><a href="#local-6989586621679709673"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-399"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">[</span><a name="local-6989586621679709675"><a href="#local-6989586621679709675"><span class="hs-identifier">xs</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709675"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-400"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679709676"><a href="#local-6989586621679709676"><span class="hs-identifier">xss</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709673"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679709674"><span class="hs-identifier hs-var">mergePairs</span></a><span> </span><a href="#local-6989586621679709676"><span class="hs-identifier hs-var">xss</span></a><span class="hs-special">)</span><span>
</span><a name="line-401"></a><span>    </span><a name="local-6989586621679709674"><a href="#local-6989586621679709674"><span class="hs-identifier">mergePairs</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-402"></a><span>    </span><span class="hs-identifier">mergePairs</span><span> </span><span class="hs-special">[</span><a name="local-6989586621679709677"><a href="#local-6989586621679709677"><span class="hs-identifier">xs</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679709677"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">]</span><span>
</span><a name="line-403"></a><span>    </span><span class="hs-identifier">mergePairs</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679709678"><a href="#local-6989586621679709678"><span class="hs-identifier">xs</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679709679"><a href="#local-6989586621679709679"><span class="hs-identifier">ys</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679709680"><a href="#local-6989586621679709680"><span class="hs-identifier">xss</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="HieUtils.html#mergeAsts"><span class="hs-identifier hs-var">mergeAsts</span></a><span> </span><a href="#local-6989586621679709678"><span class="hs-identifier hs-var">xs</span></a><span> </span><a href="#local-6989586621679709679"><span class="hs-identifier hs-var">ys</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679709674"><span class="hs-identifier hs-var">mergePairs</span></a><span> </span><a href="#local-6989586621679709680"><span class="hs-identifier hs-var">xss</span></a><span>
</span><a name="line-404"></a><span>
</span><a name="line-405"></a><span class="hs-identifier">simpleNodeInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HieTypes.html#NodeInfo"><span class="hs-identifier hs-type">NodeInfo</span></a><span> </span><a href="#local-6989586621679709438"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-406"></a><a name="simpleNodeInfo"><a href="HieUtils.html#simpleNodeInfo"><span class="hs-identifier">simpleNodeInfo</span></a></a><span> </span><a name="local-6989586621679709681"><a href="#local-6989586621679709681"><span class="hs-identifier">cons</span></a></a><span> </span><a name="local-6989586621679709682"><a href="#local-6989586621679709682"><span class="hs-identifier">typ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HieTypes.html#NodeInfo"><span class="hs-identifier hs-var">NodeInfo</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">S.singleton</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679709681"><span class="hs-identifier hs-var">cons</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679709682"><span class="hs-identifier hs-var">typ</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">M.empty</span><span>
</span><a name="line-407"></a><span>
</span><a name="line-408"></a><span class="hs-identifier">locOnly</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><a href="#local-6989586621679709437"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-409"></a><a name="locOnly"><a href="HieUtils.html#locOnly"><span class="hs-identifier">locOnly</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealSrcSpan</span><span> </span><a name="local-6989586621679709683"><a href="#local-6989586621679709683"><span class="hs-identifier">span</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-410"></a><span>  </span><span class="hs-special">[</span><a href="HieTypes.html#Node"><span class="hs-identifier hs-var">Node</span></a><span> </span><a href="#local-6989586621679709684"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621679709683"><span class="hs-identifier hs-var">span</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-411"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679709684"><a href="#local-6989586621679709684"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HieTypes.html#NodeInfo"><span class="hs-identifier hs-var">NodeInfo</span></a><span> </span><span class="hs-identifier hs-var">S.empty</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">M.empty</span><span>
</span><a name="line-412"></a><span class="hs-identifier">locOnly</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-413"></a><span>
</span><a name="line-414"></a><span class="hs-identifier">mkScope</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HieTypes.html#Scope"><span class="hs-identifier hs-type">Scope</span></a><span>
</span><a name="line-415"></a><a name="mkScope"><a href="HieUtils.html#mkScope"><span class="hs-identifier">mkScope</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealSrcSpan</span><span> </span><a name="local-6989586621679709685"><a href="#local-6989586621679709685"><span class="hs-identifier">sp</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="HieTypes.html#LocalScope"><span class="hs-identifier hs-var">LocalScope</span></a><span> </span><a href="#local-6989586621679709685"><span class="hs-identifier hs-var">sp</span></a><span>
</span><a name="line-416"></a><span class="hs-identifier">mkScope</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="HieTypes.html#NoScope"><span class="hs-identifier hs-var">NoScope</span></a><span>
</span><a name="line-417"></a><span>
</span><a name="line-418"></a><span class="hs-identifier">mkLScope</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><a href="#local-6989586621679709436"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HieTypes.html#Scope"><span class="hs-identifier hs-type">Scope</span></a><span>
</span><a name="line-419"></a><a name="mkLScope"><a href="HieUtils.html#mkLScope"><span class="hs-identifier">mkLScope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HieUtils.html#mkScope"><span class="hs-identifier hs-var">mkScope</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">getLoc</span><span>
</span><a name="line-420"></a><span>
</span><a name="line-421"></a><span class="hs-identifier">combineScopes</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HieTypes.html#Scope"><span class="hs-identifier hs-type">Scope</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HieTypes.html#Scope"><span class="hs-identifier hs-type">Scope</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HieTypes.html#Scope"><span class="hs-identifier hs-type">Scope</span></a><span>
</span><a name="line-422"></a><a name="combineScopes"><a href="HieUtils.html#combineScopes"><span class="hs-identifier">combineScopes</span></a></a><span> </span><a href="HieTypes.html#ModuleScope"><span class="hs-identifier hs-var">ModuleScope</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="HieTypes.html#ModuleScope"><span class="hs-identifier hs-var">ModuleScope</span></a><span>
</span><a name="line-423"></a><span class="hs-identifier">combineScopes</span><span> </span><span class="hs-identifier">_</span><span> </span><a href="HieTypes.html#ModuleScope"><span class="hs-identifier hs-var">ModuleScope</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HieTypes.html#ModuleScope"><span class="hs-identifier hs-var">ModuleScope</span></a><span>
</span><a name="line-424"></a><span class="hs-identifier">combineScopes</span><span> </span><a href="HieTypes.html#NoScope"><span class="hs-identifier hs-var">NoScope</span></a><span> </span><a name="local-6989586621679709686"><a href="#local-6989586621679709686"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709686"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-425"></a><span class="hs-identifier">combineScopes</span><span> </span><a name="local-6989586621679709687"><a href="#local-6989586621679709687"><span class="hs-identifier">x</span></a></a><span> </span><a href="HieTypes.html#NoScope"><span class="hs-identifier hs-var">NoScope</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679709687"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-426"></a><span class="hs-identifier">combineScopes</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#LocalScope"><span class="hs-identifier hs-var">LocalScope</span></a><span> </span><a name="local-6989586621679709688"><a href="#local-6989586621679709688"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="HieTypes.html#LocalScope"><span class="hs-identifier hs-var">LocalScope</span></a><span> </span><a name="local-6989586621679709689"><a href="#local-6989586621679709689"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-427"></a><span>  </span><a href="HieUtils.html#mkScope"><span class="hs-identifier hs-var">mkScope</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">combineSrcSpans</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealSrcSpan</span><span> </span><a href="#local-6989586621679709688"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealSrcSpan</span><span> </span><a href="#local-6989586621679709689"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-428"></a><span>
</span><a name="line-429"></a><span class="hs-pragma">{-# INLINEABLE</span><span> </span><span class="hs-pragma">makeNode</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-430"></a><span class="hs-identifier">makeNode</span><span>
</span><a name="line-431"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Applicative</span><span> </span><a href="#local-6989586621679709433"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Data</span><span> </span><a href="#local-6989586621679709434"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-432"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679709434"><span class="hs-identifier hs-type">a</span></a><span>                       </span><span class="hs-comment">-- ^ helps fill in 'nodeAnnotations' (with 'Data')</span><span>
</span><a name="line-433"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span>                 </span><span class="hs-comment">-- ^ return an empty list if this is unhelpful</span><span>
</span><a name="line-434"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679709433"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><a href="#local-6989586621679709435"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span>
</span><a name="line-435"></a><a name="makeNode"><a href="HieUtils.html#makeNode"><span class="hs-identifier">makeNode</span></a></a><span> </span><a name="local-6989586621679709690"><a href="#local-6989586621679709690"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679709691"><a href="#local-6989586621679709691"><span class="hs-identifier">spn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679709691"><span class="hs-identifier hs-var">spn</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-436"></a><span>  </span><span class="hs-identifier hs-var">RealSrcSpan</span><span> </span><a name="local-6989586621679709694"><a href="#local-6989586621679709694"><span class="hs-identifier">span</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="HieTypes.html#Node"><span class="hs-identifier hs-var">Node</span></a><span> </span><span class="hs-special">(</span><a href="HieUtils.html#simpleNodeInfo"><span class="hs-identifier hs-var">simpleNodeInfo</span></a><span> </span><a href="#local-6989586621679709692"><span class="hs-identifier hs-var">cons</span></a><span> </span><a href="#local-6989586621679709693"><span class="hs-identifier hs-var">typ</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679709694"><span class="hs-identifier hs-var">span</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-437"></a><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-438"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-439"></a><span>    </span><a name="local-6989586621679709692"><a href="#local-6989586621679709692"><span class="hs-identifier">cons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkFastString</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">toConstr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679709690"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-440"></a><span>    </span><a name="local-6989586621679709693"><a href="#local-6989586621679709693"><span class="hs-identifier">typ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkFastString</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">typeRepTyCon</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">typeOf</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679709690"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-441"></a><span>
</span><a name="line-442"></a><span class="hs-pragma">{-# INLINEABLE</span><span> </span><span class="hs-pragma">makeTypeNode</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-443"></a><span class="hs-identifier">makeTypeNode</span><span>
</span><a name="line-444"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Applicative</span><span> </span><a href="#local-6989586621679709431"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Data</span><span> </span><a href="#local-6989586621679709432"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-445"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679709432"><span class="hs-identifier hs-type">a</span></a><span>                       </span><span class="hs-comment">-- ^ helps fill in 'nodeAnnotations' (with 'Data')</span><span>
</span><a name="line-446"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span>                 </span><span class="hs-comment">-- ^ return an empty list if this is unhelpful</span><span>
</span><a name="line-447"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>                    </span><span class="hs-comment">-- ^ type to associate with the node</span><span>
</span><a name="line-448"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679709431"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><a href="HieTypes.html#HieAST"><span class="hs-identifier hs-type">HieAST</span></a><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-449"></a><a name="makeTypeNode"><a href="HieUtils.html#makeTypeNode"><span class="hs-identifier">makeTypeNode</span></a></a><span> </span><a name="local-6989586621679709695"><a href="#local-6989586621679709695"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679709696"><a href="#local-6989586621679709696"><span class="hs-identifier">spn</span></a></a><span> </span><a name="local-6989586621679709697"><a href="#local-6989586621679709697"><span class="hs-identifier">etyp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679709696"><span class="hs-identifier hs-var">spn</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-450"></a><span>  </span><span class="hs-identifier hs-var">RealSrcSpan</span><span> </span><a name="local-6989586621679709700"><a href="#local-6989586621679709700"><span class="hs-identifier">span</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-451"></a><span>    </span><span class="hs-special">[</span><a href="HieTypes.html#Node"><span class="hs-identifier hs-var">Node</span></a><span> </span><span class="hs-special">(</span><a href="HieTypes.html#NodeInfo"><span class="hs-identifier hs-var">NodeInfo</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">S.singleton</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679709698"><span class="hs-identifier hs-var">cons</span></a><span class="hs-special">,</span><a href="#local-6989586621679709699"><span class="hs-identifier hs-var">typ</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679709697"><span class="hs-identifier hs-var">etyp</span></a><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">M.empty</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679709700"><span class="hs-identifier hs-var">span</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-452"></a><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-453"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-454"></a><span>    </span><a name="local-6989586621679709698"><a href="#local-6989586621679709698"><span class="hs-identifier">cons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkFastString</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">toConstr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679709695"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-455"></a><span>    </span><a name="local-6989586621679709699"><a href="#local-6989586621679709699"><span class="hs-identifier">typ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkFastString</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">typeRepTyCon</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">typeOf</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679709695"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-456"></a></pre></body></html>