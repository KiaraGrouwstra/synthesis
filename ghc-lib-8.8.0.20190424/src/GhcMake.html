<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns, CPP, NondecreasingIndentation, ScopedTypeVariables #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><a name="line-3"></a><span>
</span><a name="line-4"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-5"></a><span class="hs-comment">--</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- (c) The University of Glasgow, 2011</span><span>
</span><a name="line-7"></a><span class="hs-comment">--</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- This module implements multi-module compilation, and is used</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- by --make and GHCi.</span><span>
</span><a name="line-10"></a><span class="hs-comment">--</span><span>
</span><a name="line-11"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-12"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GhcMake</span><span class="hs-special">(</span><span>
</span><a name="line-13"></a><span>        </span><a href="GhcMake.html#depanal"><span class="hs-identifier hs-var">depanal</span></a><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>        </span><a href="GhcMake.html#load"><span class="hs-identifier hs-var">load</span></a><span class="hs-special">,</span><span> </span><a href="GhcMake.html#load%27"><span class="hs-identifier hs-var">load'</span></a><span class="hs-special">,</span><span> </span><a href="GhcMake.html#LoadHowMuch"><span class="hs-identifier hs-type">LoadHowMuch</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span>        </span><a href="GhcMake.html#topSortModuleGraph"><span class="hs-identifier hs-var">topSortModuleGraph</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span>        </span><a href="GhcMake.html#ms_home_srcimps"><span class="hs-identifier hs-var">ms_home_srcimps</span></a><span class="hs-special">,</span><span> </span><a href="GhcMake.html#ms_home_imps"><span class="hs-identifier hs-var">ms_home_imps</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span>        </span><a href="GhcMake.html#IsBoot"><span class="hs-identifier hs-type">IsBoot</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>        </span><a href="GhcMake.html#summariseModule"><span class="hs-identifier hs-var">summariseModule</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>        </span><a href="GhcMake.html#hscSourceToIsBoot"><span class="hs-identifier hs-var">hscSourceToIsBoot</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>        </span><a href="TcBackpack.html#findExtraSigImports"><span class="hs-identifier hs-var">findExtraSigImports</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>        </span><a href="TcBackpack.html#implicitRequirements"><span class="hs-identifier hs-var">implicitRequirements</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span>        </span><a href="GhcMake.html#noModError"><span class="hs-identifier hs-var">noModError</span></a><span class="hs-special">,</span><span> </span><a href="GhcMake.html#cyclicModuleErr"><span class="hs-identifier hs-var">cyclicModuleErr</span></a><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>        </span><a href="GhcMake.html#moduleGraphNodes"><span class="hs-identifier hs-var">moduleGraphNodes</span></a><span class="hs-special">,</span><span> </span><a href="GhcMake.html#SummaryNode"><span class="hs-identifier hs-type">SummaryNode</span></a><span>
</span><a name="line-28"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Linker.html"><span class="hs-identifier">Linker</span></a><span>         </span><span class="hs-special">(</span><span> </span><a href="Linker.html#unload"><span class="hs-identifier hs-var">unload</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DriverPhases</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="DriverPipeline.html"><span class="hs-identifier">DriverPipeline</span></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="Finder.html"><span class="hs-identifier">Finder</span></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcMonad</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HeaderInfo</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><a href="TcIface.html"><span class="hs-identifier">TcIface</span></a><span>          </span><span class="hs-special">(</span><span> </span><a href="TcIface.html#typecheckIface"><span class="hs-identifier hs-var">typecheckIface</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>        </span><span class="hs-special">(</span><span> </span><a href="TcRnMonad.html#initIfaceCheck"><span class="hs-identifier hs-var">initIfaceCheck</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><a href="HscMain.html"><span class="hs-identifier">HscMain</span></a><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Bag</span><span>              </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">listToBag</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Digraph</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Exception</span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">tryIO</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">gbracket</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">gfinally</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>           </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">expectJust</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MonadUtils</span><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">allM</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Panic</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">StringBuffer</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqFM</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqDSet</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><a href="TcBackpack.html"><span class="hs-identifier">TcBackpack</span></a><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Packages</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSet</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC.LanguageExtensions</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LangExt</span><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameEnv</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FileCleanup</span><span>
</span><a name="line-70"></a><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Either</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">rights</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">partitionEithers</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Set</span><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">FiniteMap</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">insertListWith</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Concurrent</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">forkIOWithUnmask</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">killThread</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC.Conc</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">CC</span><span>
</span><a name="line-79"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Concurrent.MVar</span><span>
</span><a name="line-80"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Concurrent.QSem</span><span>
</span><a name="line-81"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Exception</span><span>
</span><a name="line-82"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-83"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.IORef</span><span>
</span><a name="line-84"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-85"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.List</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">List</span><span>
</span><a name="line-86"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Foldable</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toList</span><span class="hs-special">)</span><span>
</span><a name="line-87"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span>
</span><a name="line-88"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Ord</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">comparing</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-89"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Time</span><span>
</span><a name="line-90"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Directory</span><span>
</span><a name="line-91"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.FilePath</span><span>
</span><a name="line-92"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.IO</span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">fixIO</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-93"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.IO.Error</span><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">isDoesNotExistError</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-94"></a><span>
</span><a name="line-95"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.Conc</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">getNumProcessors</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">getNumCapabilities</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">setNumCapabilities</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-96"></a><span>
</span><a name="line-97"></a><span class="hs-identifier">label_self</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-98"></a><a name="label_self"><a href="GhcMake.html#label_self"><span class="hs-identifier">label_self</span></a></a><span> </span><a name="local-6989586621685212979"><a href="#local-6989586621685212979"><span class="hs-identifier">thread_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-99"></a><span>    </span><a name="local-6989586621685212980"><a href="#local-6989586621685212980"><span class="hs-identifier">self_tid</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">CC.myThreadId</span><span>
</span><a name="line-100"></a><span>    </span><span class="hs-identifier hs-var">CC.labelThread</span><span> </span><a href="#local-6989586621685212980"><span class="hs-identifier hs-var">self_tid</span></a><span> </span><a href="#local-6989586621685212979"><span class="hs-identifier hs-var">thread_name</span></a><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-103"></a><span class="hs-comment">-- Loading the program</span><span>
</span><a name="line-104"></a><span>
</span><a name="line-105"></a><span class="hs-comment">-- | Perform a dependency analysis starting from the current targets</span><span>
</span><a name="line-106"></a><span class="hs-comment">-- and update the session with the new module graph.</span><span>
</span><a name="line-107"></a><span class="hs-comment">--</span><span>
</span><a name="line-108"></a><span class="hs-comment">-- Dependency analysis entails parsing the @import@ directives and may</span><span>
</span><a name="line-109"></a><span class="hs-comment">-- therefore require running certain preprocessors.</span><span>
</span><a name="line-110"></a><span class="hs-comment">--</span><span>
</span><a name="line-111"></a><span class="hs-comment">-- Note that each 'ModSummary' in the module graph caches its 'DynFlags'.</span><span>
</span><a name="line-112"></a><span class="hs-comment">-- These 'DynFlags' are determined by the /current/ session 'DynFlags' and the</span><span>
</span><a name="line-113"></a><span class="hs-comment">-- @OPTIONS@ and @LANGUAGE@ pragmas of the parsed module.  Thus if you want</span><span>
</span><a name="line-114"></a><span class="hs-comment">-- changes to the 'DynFlags' to take effect you need to call this function</span><span>
</span><a name="line-115"></a><span class="hs-comment">-- again.</span><span>
</span><a name="line-116"></a><span class="hs-comment">--</span><span>
</span><a name="line-117"></a><span class="hs-identifier">depanal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685212978"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-118"></a><span>           </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ModuleName</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- ^ excluded modules</span><span>
</span><a name="line-119"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>          </span><span class="hs-comment">-- ^ allow duplicate roots</span><span>
</span><a name="line-120"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685212978"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">ModuleGraph</span><span>
</span><a name="line-121"></a><a name="depanal"><a href="GhcMake.html#depanal"><span class="hs-identifier">depanal</span></a></a><span> </span><a name="local-6989586621685212981"><a href="#local-6989586621685212981"><span class="hs-identifier">excluded_mods</span></a></a><span> </span><a name="local-6989586621685212982"><a href="#local-6989586621685212982"><span class="hs-identifier">allow_dup_roots</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-122"></a><span>  </span><a name="local-6989586621685212983"><a href="#local-6989586621685212983"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getSession</span><span>
</span><a name="line-123"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-124"></a><span>         </span><a name="local-6989586621685212984"><a href="#local-6989586621685212984"><span class="hs-identifier">dflags</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685212983"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-125"></a><span>         </span><a name="local-6989586621685212985"><a href="#local-6989586621685212985"><span class="hs-identifier">targets</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_targets</span><span> </span><a href="#local-6989586621685212983"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-126"></a><span>         </span><a name="local-6989586621685212986"><a href="#local-6989586621685212986"><span class="hs-identifier">old_graph</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_mod_graph</span><span> </span><a href="#local-6989586621685212983"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-127"></a><span>
</span><a name="line-128"></a><span>  </span><span class="hs-identifier hs-var">withTiming</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621685212984"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Chasing dependencies&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-129"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><a href="#local-6989586621685212984"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hcat</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-130"></a><span>              </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Chasing modules from: &quot;</span><span class="hs-special">,</span><span>
</span><a name="line-131"></a><span>              </span><span class="hs-identifier hs-var">hcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">punctuate</span><span> </span><span class="hs-identifier hs-var">comma</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">pprTarget</span><span> </span><a href="#local-6989586621685212985"><span class="hs-identifier hs-var">targets</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-132"></a><span>
</span><a name="line-133"></a><span>    </span><span class="hs-comment">-- Home package modules may have been moved or deleted, and new</span><span>
</span><a name="line-134"></a><span>    </span><span class="hs-comment">-- source files may have appeared in the home package that shadow</span><span>
</span><a name="line-135"></a><span>    </span><span class="hs-comment">-- external package modules, so we have to discard the existing</span><span>
</span><a name="line-136"></a><span>    </span><span class="hs-comment">-- cached finder data.</span><span>
</span><a name="line-137"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Finder.html#flushFinderCaches"><span class="hs-identifier hs-var">flushFinderCaches</span></a><span> </span><a href="#local-6989586621685212983"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-138"></a><span>
</span><a name="line-139"></a><span>    </span><a name="local-6989586621685212987"><a href="#local-6989586621685212987"><span class="hs-identifier">mod_summariesE</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GhcMake.html#downsweep"><span class="hs-identifier hs-var">downsweep</span></a><span> </span><a href="#local-6989586621685212983"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mgModSummaries</span><span> </span><a href="#local-6989586621685212986"><span class="hs-identifier hs-var">old_graph</span></a><span class="hs-special">)</span><span>
</span><a name="line-140"></a><span>                                     </span><a href="#local-6989586621685212981"><span class="hs-identifier hs-var">excluded_mods</span></a><span> </span><a href="#local-6989586621685212982"><span class="hs-identifier hs-var">allow_dup_roots</span></a><span>
</span><a name="line-141"></a><span>    </span><a name="local-6989586621685212988"><a href="#local-6989586621685212988"><span class="hs-identifier">mod_summaries</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GhcMake.html#reportImportErrors"><span class="hs-identifier hs-var">reportImportErrors</span></a><span> </span><a href="#local-6989586621685212987"><span class="hs-identifier hs-var">mod_summariesE</span></a><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685212989"><a href="#local-6989586621685212989"><span class="hs-identifier">mod_graph</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkModuleGraph</span><span> </span><a href="#local-6989586621685212988"><span class="hs-identifier hs-var">mod_summaries</span></a><span>
</span><a name="line-144"></a><span>
</span><a name="line-145"></a><span>    </span><a href="GhcMake.html#warnMissingHomeModules"><span class="hs-identifier hs-var">warnMissingHomeModules</span></a><span> </span><a href="#local-6989586621685212983"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685212989"><span class="hs-identifier hs-var">mod_graph</span></a><span>
</span><a name="line-146"></a><span>
</span><a name="line-147"></a><span>    </span><span class="hs-identifier hs-var">setSession</span><span> </span><a href="#local-6989586621685212983"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_mod_graph</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685212989"><span class="hs-identifier hs-var">mod_graph</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-148"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685212989"><span class="hs-identifier hs-var">mod_graph</span></a><span>
</span><a name="line-149"></a><span>
</span><a name="line-150"></a><span class="hs-comment">-- Note [Missing home modules]</span><span>
</span><a name="line-151"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-152"></a><span class="hs-comment">-- Sometimes user doesn't want GHC to pick up modules, not explicitly listed</span><span>
</span><a name="line-153"></a><span class="hs-comment">-- in a command line. For example, cabal may want to enable this warning</span><span>
</span><a name="line-154"></a><span class="hs-comment">-- when building a library, so that GHC warns user about modules, not listed</span><span>
</span><a name="line-155"></a><span class="hs-comment">-- neither in `exposed-modules`, nor in `other-modules`.</span><span>
</span><a name="line-156"></a><span class="hs-comment">--</span><span>
</span><a name="line-157"></a><span class="hs-comment">-- Here &quot;home module&quot; means a module, that doesn't come from an other package.</span><span>
</span><a name="line-158"></a><span class="hs-comment">--</span><span>
</span><a name="line-159"></a><span class="hs-comment">-- For example, if GHC is invoked with modules &quot;A&quot; and &quot;B&quot; as targets,</span><span>
</span><a name="line-160"></a><span class="hs-comment">-- but &quot;A&quot; imports some other module &quot;C&quot;, then GHC will issue a warning</span><span>
</span><a name="line-161"></a><span class="hs-comment">-- about module &quot;C&quot; not being listed in a command line.</span><span>
</span><a name="line-162"></a><span class="hs-comment">--</span><span>
</span><a name="line-163"></a><span class="hs-comment">-- The warning in enabled by `-Wmissing-home-modules`. See Trac #13129</span><span>
</span><a name="line-164"></a><span class="hs-identifier">warnMissingHomeModules</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685212977"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModuleGraph</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685212977"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-165"></a><a name="warnMissingHomeModules"><a href="GhcMake.html#warnMissingHomeModules"><span class="hs-identifier">warnMissingHomeModules</span></a></a><span> </span><a name="local-6989586621685212990"><a href="#local-6989586621685212990"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621685212991"><a href="#local-6989586621685212991"><span class="hs-identifier">mod_graph</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-166"></a><span>    </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wopt</span><span> </span><span class="hs-identifier hs-var">Opt_WarnMissingHomeModules</span><span> </span><a href="#local-6989586621685212992"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621685212996"><span class="hs-identifier hs-var">missing</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-167"></a><span>        </span><span class="hs-identifier hs-var">logWarnings</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">listToBag</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621685212998"><span class="hs-identifier hs-var">warn</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-168"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-169"></a><span>    </span><a name="local-6989586621685212992"><a href="#local-6989586621685212992"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685212990"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-170"></a><span>    </span><a name="local-6989586621685212993"><a href="#local-6989586621685212993"><span class="hs-identifier">targets</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">targetId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_targets</span><span> </span><a href="#local-6989586621685212990"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-171"></a><span>
</span><a name="line-172"></a><span>    </span><a name="local-6989586621685212994"><a href="#local-6989586621685212994"><span class="hs-identifier">is_known_module</span></a></a><span> </span><a name="local-6989586621685212999"><a href="#local-6989586621685212999"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685212995"><span class="hs-identifier hs-var">is_my_target</span></a><span> </span><a href="#local-6989586621685212999"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685212993"><span class="hs-identifier hs-var">targets</span></a><span>
</span><a name="line-173"></a><span>
</span><a name="line-174"></a><span>    </span><span class="hs-comment">-- We need to be careful to handle the case where (possibly</span><span>
</span><a name="line-175"></a><span>    </span><span class="hs-comment">-- path-qualified) filenames (aka 'TargetFile') rather than module</span><span>
</span><a name="line-176"></a><span>    </span><span class="hs-comment">-- names are being passed on the GHC command-line.</span><span>
</span><a name="line-177"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-178"></a><span>    </span><span class="hs-comment">-- For instance, `ghc --make src-exe/Main.hs` and</span><span>
</span><a name="line-179"></a><span>    </span><span class="hs-comment">-- `ghc --make -isrc-exe Main` are supposed to be equivalent.</span><span>
</span><a name="line-180"></a><span>    </span><span class="hs-comment">-- Note also that we can't always infer the associated module name</span><span>
</span><a name="line-181"></a><span>    </span><span class="hs-comment">-- directly from the filename argument.  See Trac #13727.</span><span>
</span><a name="line-182"></a><span>    </span><a name="local-6989586621685212995"><a href="#local-6989586621685212995"><span class="hs-identifier">is_my_target</span></a></a><span> </span><a name="local-6989586621685213000"><a href="#local-6989586621685213000"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TargetModule</span><span> </span><a name="local-6989586621685213001"><a href="#local-6989586621685213001"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-183"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">moduleName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ms_mod</span><span> </span><a href="#local-6989586621685213000"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621685213001"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-184"></a><span>    </span><span class="hs-identifier">is_my_target</span><span> </span><a name="local-6989586621685213002"><a href="#local-6989586621685213002"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TargetFile</span><span> </span><a name="local-6989586621685213003"><a href="#local-6989586621685213003"><span class="hs-identifier">target_file</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-185"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213004"><a href="#local-6989586621685213004"><span class="hs-identifier">mod_file</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">ml_hs_file</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ms_location</span><span> </span><a href="#local-6989586621685213002"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-186"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213003"><span class="hs-identifier hs-var">target_file</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621685213004"><span class="hs-identifier hs-var">mod_file</span></a><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-187"></a><span>           </span><span class="hs-comment">--  We can get a file target even if a module name was</span><span>
</span><a name="line-188"></a><span>           </span><span class="hs-comment">--  originally specified in a command line because it can</span><span>
</span><a name="line-189"></a><span>           </span><span class="hs-comment">--  be converted in guessTarget (by appending .hs/.lhs).</span><span>
</span><a name="line-190"></a><span>           </span><span class="hs-comment">--  So let's convert it back and compare with module name</span><span>
</span><a name="line-191"></a><span>           </span><span class="hs-identifier hs-var">mkModuleName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">splitExtension</span><span> </span><a href="#local-6989586621685213003"><span class="hs-identifier hs-var">target_file</span></a><span class="hs-special">)</span><span>
</span><a name="line-192"></a><span>            </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">moduleName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ms_mod</span><span> </span><a href="#local-6989586621685213002"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-193"></a><span>    </span><span class="hs-identifier">is_my_target</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-194"></a><span>
</span><a name="line-195"></a><span>    </span><a name="local-6989586621685212996"><a href="#local-6989586621685212996"><span class="hs-identifier">missing</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">ms_mod</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-196"></a><span>      </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621685212994"><span class="hs-identifier hs-var">is_known_module</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mgModSummaries</span><span> </span><a href="#local-6989586621685212991"><span class="hs-identifier hs-var">mod_graph</span></a><span class="hs-special">)</span><span>
</span><a name="line-197"></a><span>
</span><a name="line-198"></a><span>    </span><a name="local-6989586621685212997"><a href="#local-6989586621685212997"><span class="hs-identifier">msg</span></a></a><span>
</span><a name="line-199"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_BuildingCabalPackage</span><span> </span><a href="#local-6989586621685212992"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-200"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span>
</span><a name="line-201"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;These modules are needed for compilation but not listed in your .cabal file's other-modules: &quot;</span><span class="hs-special">)</span><span>
</span><a name="line-202"></a><span>          </span><span class="hs-number">4</span><span>
</span><a name="line-203"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685212996"><span class="hs-identifier hs-var">missing</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-204"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-205"></a><span>      </span><span class="hs-glyph">=</span><span>
</span><a name="line-206"></a><span>        </span><span class="hs-identifier hs-var">hang</span><span>
</span><a name="line-207"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Modules are not listed in command line but needed for compilation: &quot;</span><span class="hs-special">)</span><span>
</span><a name="line-208"></a><span>          </span><span class="hs-number">4</span><span>
</span><a name="line-209"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685212996"><span class="hs-identifier hs-var">missing</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-210"></a><span>    </span><a name="local-6989586621685212998"><a href="#local-6989586621685212998"><span class="hs-identifier">warn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">makeIntoWarning</span><span>
</span><a name="line-211"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><span class="hs-identifier hs-var">Opt_WarnMissingHomeModules</span><span class="hs-special">)</span><span>
</span><a name="line-212"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkPlainErrMsg</span><span> </span><a href="#local-6989586621685212992"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">noSrcSpan</span><span> </span><a href="#local-6989586621685212997"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-213"></a><span>
</span><a name="line-214"></a><span class="hs-comment">-- | Describes which modules of the module graph need to be loaded.</span><span>
</span><a name="line-215"></a><span class="hs-keyword">data</span><span> </span><a name="LoadHowMuch"><a href="GhcMake.html#LoadHowMuch"><span class="hs-identifier">LoadHowMuch</span></a></a><span>
</span><a name="line-216"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a name="LoadAllTargets"><a href="GhcMake.html#LoadAllTargets"><span class="hs-identifier">LoadAllTargets</span></a></a><span>
</span><a name="line-217"></a><span>     </span><span class="hs-comment">-- ^ Load all targets and its dependencies.</span><span>
</span><a name="line-218"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="LoadUpTo"><a href="GhcMake.html#LoadUpTo"><span class="hs-identifier">LoadUpTo</span></a></a><span> </span><span class="hs-identifier hs-type">ModuleName</span><span>
</span><a name="line-219"></a><span>     </span><span class="hs-comment">-- ^ Load only the given module and its dependencies.</span><span>
</span><a name="line-220"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="LoadDependenciesOf"><a href="GhcMake.html#LoadDependenciesOf"><span class="hs-identifier">LoadDependenciesOf</span></a></a><span> </span><span class="hs-identifier hs-type">ModuleName</span><span>
</span><a name="line-221"></a><span>     </span><span class="hs-comment">-- ^ Load only the dependencies of the given module, but not the module</span><span>
</span><a name="line-222"></a><span>     </span><span class="hs-comment">-- itself.</span><span>
</span><a name="line-223"></a><span>
</span><a name="line-224"></a><span class="hs-comment">-- | Try to load the program.  See 'LoadHowMuch' for the different modes.</span><span>
</span><a name="line-225"></a><span class="hs-comment">--</span><span>
</span><a name="line-226"></a><span class="hs-comment">-- This function implements the core of GHC's @--make@ mode.  It preprocesses,</span><span>
</span><a name="line-227"></a><span class="hs-comment">-- compiles and loads the specified modules, avoiding re-compilation wherever</span><span>
</span><a name="line-228"></a><span class="hs-comment">-- possible.  Depending on the target (see 'DynFlags.hscTarget') compiling</span><span>
</span><a name="line-229"></a><span class="hs-comment">-- and loading may result in files being created on disk.</span><span>
</span><a name="line-230"></a><span class="hs-comment">--</span><span>
</span><a name="line-231"></a><span class="hs-comment">-- Calls the 'defaultWarnErrLogger' after each compiling each module, whether</span><span>
</span><a name="line-232"></a><span class="hs-comment">-- successful or not.</span><span>
</span><a name="line-233"></a><span class="hs-comment">--</span><span>
</span><a name="line-234"></a><span class="hs-comment">-- Throw a 'SourceError' if errors are encountered before the actual</span><span>
</span><a name="line-235"></a><span class="hs-comment">-- compilation starts (e.g., during dependency analysis).  All other errors</span><span>
</span><a name="line-236"></a><span class="hs-comment">-- are reported using the 'defaultWarnErrLogger'.</span><span>
</span><a name="line-237"></a><span class="hs-comment">--</span><span>
</span><a name="line-238"></a><span class="hs-identifier">load</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685212976"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="GhcMake.html#LoadHowMuch"><span class="hs-identifier hs-type">LoadHowMuch</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685212976"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">SuccessFlag</span><span>
</span><a name="line-239"></a><a name="load"><a href="GhcMake.html#load"><span class="hs-identifier">load</span></a></a><span> </span><a name="local-6989586621685213005"><a href="#local-6989586621685213005"><span class="hs-identifier">how_much</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-240"></a><span>    </span><a name="local-6989586621685213006"><a href="#local-6989586621685213006"><span class="hs-identifier">mod_graph</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GhcMake.html#depanal"><span class="hs-identifier hs-var">depanal</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-241"></a><span>    </span><a href="GhcMake.html#load%27"><span class="hs-identifier hs-var">load'</span></a><span> </span><a href="#local-6989586621685213005"><span class="hs-identifier hs-var">how_much</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="HscMain.html#batchMsg"><span class="hs-identifier hs-var">batchMsg</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213006"><span class="hs-identifier hs-var">mod_graph</span></a><span>
</span><a name="line-242"></a><span>
</span><a name="line-243"></a><span class="hs-comment">-- | Generalized version of 'load' which also supports a custom</span><span>
</span><a name="line-244"></a><span class="hs-comment">-- 'Messager' (for reporting progress) and 'ModuleGraph' (generally</span><span>
</span><a name="line-245"></a><span class="hs-comment">-- produced by calling 'depanal'.</span><span>
</span><a name="line-246"></a><span class="hs-identifier">load'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685212975"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="GhcMake.html#LoadHowMuch"><span class="hs-identifier hs-type">LoadHowMuch</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="HscMain.html#Messager"><span class="hs-identifier hs-type">Messager</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModuleGraph</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685212975"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">SuccessFlag</span><span>
</span><a name="line-247"></a><a name="load%27"><a href="GhcMake.html#load%27"><span class="hs-identifier">load'</span></a></a><span> </span><a name="local-6989586621685213007"><a href="#local-6989586621685213007"><span class="hs-identifier">how_much</span></a></a><span> </span><a name="local-6989586621685213008"><a href="#local-6989586621685213008"><span class="hs-identifier">mHscMessage</span></a></a><span> </span><a name="local-6989586621685213009"><a href="#local-6989586621685213009"><span class="hs-identifier">mod_graph</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-248"></a><span>    </span><span class="hs-identifier hs-var">modifySession</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685213010"><a href="#local-6989586621685213010"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685213010"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_mod_graph</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213009"><span class="hs-identifier hs-var">mod_graph</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-249"></a><span>    </span><a href="GhcMake.html#guessOutputFile"><span class="hs-identifier hs-var">guessOutputFile</span></a><span>
</span><a name="line-250"></a><span>    </span><a name="local-6989586621685213011"><a href="#local-6989586621685213011"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getSession</span><span>
</span><a name="line-251"></a><span>
</span><a name="line-252"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213012"><a href="#local-6989586621685213012"><span class="hs-identifier">hpt1</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_HPT</span><span> </span><a href="#local-6989586621685213011"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-253"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213013"><a href="#local-6989586621685213013"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685213011"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-254"></a><span>
</span><a name="line-255"></a><span>    </span><span class="hs-comment">-- The &quot;bad&quot; boot modules are the ones for which we have</span><span>
</span><a name="line-256"></a><span>    </span><span class="hs-comment">-- B.hs-boot in the module graph, but no B.hs</span><span>
</span><a name="line-257"></a><span>    </span><span class="hs-comment">-- The downsweep should have ensured this does not happen</span><span>
</span><a name="line-258"></a><span>    </span><span class="hs-comment">-- (see msDeps)</span><span>
</span><a name="line-259"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213014"><a href="#local-6989586621685213014"><span class="hs-identifier">all_home_mods</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-260"></a><span>          </span><span class="hs-identifier hs-var">mkUniqSet</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ms_mod_name</span><span> </span><a href="#local-6989586621685213015"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-261"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621685213015"><a href="#local-6989586621685213015"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mgModSummaries</span><span> </span><a href="#local-6989586621685213009"><span class="hs-identifier hs-var">mod_graph</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isBootSummary</span><span> </span><a href="#local-6989586621685213015"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-262"></a><span>    </span><span class="hs-comment">-- TODO: Figure out what the correct form of this assert is. It's violated</span><span>
</span><a name="line-263"></a><span>    </span><span class="hs-comment">-- when you have HsBootMerge nodes in the graph: then you'll have hs-boot</span><span>
</span><a name="line-264"></a><span>    </span><span class="hs-comment">-- files without corresponding hs files.</span><span>
</span><a name="line-265"></a><span>    </span><span class="hs-comment">--  bad_boot_mods = [s        | s &lt;- mod_graph, isBootSummary s,</span><span>
</span><a name="line-266"></a><span>    </span><span class="hs-comment">--                              not (ms_mod_name s `elem` all_home_mods)]</span><span>
</span><a name="line-267"></a><span>    </span><span class="hs-comment">-- ASSERT( null bad_boot_mods ) return ()</span><span>
</span><a name="line-268"></a><span>
</span><a name="line-269"></a><span>    </span><span class="hs-comment">-- check that the module given in HowMuch actually exists, otherwise</span><span>
</span><a name="line-270"></a><span>    </span><span class="hs-comment">-- topSortModuleGraph will bomb later.</span><span>
</span><a name="line-271"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213016"><a href="#local-6989586621685213016"><span class="hs-identifier">checkHowMuch</span></a></a><span> </span><span class="hs-special">(</span><a href="GhcMake.html#LoadUpTo"><span class="hs-identifier hs-var">LoadUpTo</span></a><span> </span><a name="local-6989586621685213018"><a href="#local-6989586621685213018"><span class="hs-identifier">m</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213017"><span class="hs-identifier hs-var">checkMod</span></a><span> </span><a href="#local-6989586621685213018"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-272"></a><span>        </span><span class="hs-identifier">checkHowMuch</span><span> </span><span class="hs-special">(</span><a href="GhcMake.html#LoadDependenciesOf"><span class="hs-identifier hs-var">LoadDependenciesOf</span></a><span> </span><a name="local-6989586621685213019"><a href="#local-6989586621685213019"><span class="hs-identifier">m</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213017"><span class="hs-identifier hs-var">checkMod</span></a><span> </span><a href="#local-6989586621685213019"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-273"></a><span>        </span><span class="hs-identifier">checkHowMuch</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-274"></a><span>
</span><a name="line-275"></a><span>        </span><a name="local-6989586621685213017"><a href="#local-6989586621685213017"><span class="hs-identifier">checkMod</span></a></a><span> </span><a name="local-6989586621685213020"><a href="#local-6989586621685213020"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621685213021"><a href="#local-6989586621685213021"><span class="hs-identifier">and_then</span></a></a><span>
</span><a name="line-276"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685213020"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elementOfUniqSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685213014"><span class="hs-identifier hs-var">all_home_mods</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213021"><span class="hs-identifier hs-var">and_then</span></a><span>
</span><a name="line-277"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-278"></a><span>                    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">errorMsg</span><span> </span><a href="#local-6989586621685213013"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;no such module:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-279"></a><span>                                     </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685213020"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-280"></a><span>                    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Failed</span><span>
</span><a name="line-281"></a><span>
</span><a name="line-282"></a><span>    </span><a href="#local-6989586621685213016"><span class="hs-identifier hs-var">checkHowMuch</span></a><span> </span><a href="#local-6989586621685213007"><span class="hs-identifier hs-var">how_much</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-283"></a><span>
</span><a name="line-284"></a><span>    </span><span class="hs-comment">-- mg2_with_srcimps drops the hi-boot nodes, returning a</span><span>
</span><a name="line-285"></a><span>    </span><span class="hs-comment">-- graph with cycles.  Among other things, it is used for</span><span>
</span><a name="line-286"></a><span>    </span><span class="hs-comment">-- backing out partially complete cycles following a failed</span><span>
</span><a name="line-287"></a><span>    </span><span class="hs-comment">-- upsweep, and for removing from hpt all the modules</span><span>
</span><a name="line-288"></a><span>    </span><span class="hs-comment">-- not in strict downwards closure, during calls to compile.</span><span>
</span><a name="line-289"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">mg2_with_srcimps</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SCC</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span>
</span><a name="line-290"></a><span>        </span><a name="local-6989586621685213022"><a href="#local-6989586621685213022"><span class="hs-identifier">mg2_with_srcimps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GhcMake.html#topSortModuleGraph"><span class="hs-identifier hs-var">topSortModuleGraph</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621685213009"><span class="hs-identifier hs-var">mod_graph</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-291"></a><span>
</span><a name="line-292"></a><span>    </span><span class="hs-comment">-- If we can determine that any of the {-# SOURCE #-} imports</span><span>
</span><a name="line-293"></a><span>    </span><span class="hs-comment">-- are definitely unnecessary, then emit a warning.</span><span>
</span><a name="line-294"></a><span>    </span><a href="GhcMake.html#warnUnnecessarySourceImports"><span class="hs-identifier hs-var">warnUnnecessarySourceImports</span></a><span> </span><a href="#local-6989586621685213022"><span class="hs-identifier hs-var">mg2_with_srcimps</span></a><span>
</span><a name="line-295"></a><span>
</span><a name="line-296"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-297"></a><span>        </span><span class="hs-comment">-- check the stability property for each module.</span><span>
</span><a name="line-298"></a><span>        </span><a name="local-6989586621685213023"><a href="#local-6989586621685213023"><span class="hs-identifier">stable_mods</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621685213024"><a href="#local-6989586621685213024"><span class="hs-identifier">stable_obj</span></a></a><span class="hs-special">,</span><a name="local-6989586621685213025"><a href="#local-6989586621685213025"><span class="hs-identifier">stable_bco</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-299"></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="GhcMake.html#checkStability"><span class="hs-identifier hs-var">checkStability</span></a><span> </span><a href="#local-6989586621685213012"><span class="hs-identifier hs-var">hpt1</span></a><span> </span><a href="#local-6989586621685213022"><span class="hs-identifier hs-var">mg2_with_srcimps</span></a><span> </span><a href="#local-6989586621685213014"><span class="hs-identifier hs-var">all_home_mods</span></a><span>
</span><a name="line-300"></a><span>
</span><a name="line-301"></a><span>        </span><span class="hs-comment">-- prune bits of the HPT which are definitely redundant now,</span><span>
</span><a name="line-302"></a><span>        </span><span class="hs-comment">-- to save space.</span><span>
</span><a name="line-303"></a><span>        </span><a name="local-6989586621685213026"><a href="#local-6989586621685213026"><span class="hs-identifier">pruned_hpt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GhcMake.html#pruneHomePackageTable"><span class="hs-identifier hs-var">pruneHomePackageTable</span></a><span> </span><a href="#local-6989586621685213012"><span class="hs-identifier hs-var">hpt1</span></a><span>
</span><a name="line-304"></a><span>                            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flattenSCCs</span><span> </span><a href="#local-6989586621685213022"><span class="hs-identifier hs-var">mg2_with_srcimps</span></a><span class="hs-special">)</span><span>
</span><a name="line-305"></a><span>                            </span><a href="#local-6989586621685213023"><span class="hs-identifier hs-var">stable_mods</span></a><span>
</span><a name="line-306"></a><span>
</span><a name="line-307"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">evaluate</span><span> </span><a href="#local-6989586621685213026"><span class="hs-identifier hs-var">pruned_hpt</span></a><span>
</span><a name="line-308"></a><span>
</span><a name="line-309"></a><span>    </span><span class="hs-comment">-- before we unload anything, make sure we don't leave an old</span><span>
</span><a name="line-310"></a><span>    </span><span class="hs-comment">-- interactive context around pointing to dead bindings.  Also,</span><span>
</span><a name="line-311"></a><span>    </span><span class="hs-comment">-- write the pruned HPT to allow the old HPT to be GC'd.</span><span>
</span><a name="line-312"></a><span>    </span><span class="hs-identifier hs-var">setSession</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GhcMake.html#discardIC"><span class="hs-identifier hs-var">discardIC</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621685213011"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_HPT</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213026"><span class="hs-identifier hs-var">pruned_hpt</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-313"></a><span>
</span><a name="line-314"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><a href="#local-6989586621685213013"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Stable obj:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685213024"><span class="hs-identifier hs-var">stable_obj</span></a><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-315"></a><span>                            </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Stable BCO:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685213025"><span class="hs-identifier hs-var">stable_bco</span></a><span class="hs-special">)</span><span>
</span><a name="line-316"></a><span>
</span><a name="line-317"></a><span>    </span><span class="hs-comment">-- Unload any modules which are going to be re-linked this time around.</span><span>
</span><a name="line-318"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213027"><a href="#local-6989586621685213027"><span class="hs-identifier">stable_linkables</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621685213030"><span class="hs-identifier hs-var">linkable</span></a><span>
</span><a name="line-319"></a><span>                           </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621685213028"><a href="#local-6989586621685213028"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">nonDetEltsUniqSet</span><span> </span><a href="#local-6989586621685213024"><span class="hs-identifier hs-var">stable_obj</span></a><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-320"></a><span>                                  </span><span class="hs-identifier hs-var">nonDetEltsUniqSet</span><span> </span><a href="#local-6989586621685213025"><span class="hs-identifier hs-var">stable_bco</span></a><span class="hs-special">,</span><span>
</span><a name="line-321"></a><span>                             </span><span class="hs-comment">-- It's OK to use nonDetEltsUniqSet here</span><span>
</span><a name="line-322"></a><span>                             </span><span class="hs-comment">-- because it only affects linking. Besides</span><span>
</span><a name="line-323"></a><span>                             </span><span class="hs-comment">-- this list only serves as a poor man's set.</span><span>
</span><a name="line-324"></a><span>                             </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213029"><a href="#local-6989586621685213029"><span class="hs-identifier">hmi</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">lookupHpt</span><span> </span><a href="#local-6989586621685213026"><span class="hs-identifier hs-var">pruned_hpt</span></a><span> </span><a href="#local-6989586621685213028"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-325"></a><span>                             </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213030"><a href="#local-6989586621685213030"><span class="hs-identifier">linkable</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">hm_linkable</span><span> </span><a href="#local-6989586621685213029"><span class="hs-identifier hs-var">hmi</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-326"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GhcMake.html#unload"><span class="hs-identifier hs-var">unload</span></a><span> </span><a href="#local-6989586621685213011"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685213027"><span class="hs-identifier hs-var">stable_linkables</span></a><span>
</span><a name="line-327"></a><span>
</span><a name="line-328"></a><span>    </span><span class="hs-comment">-- We could at this point detect cycles which aren't broken by</span><span>
</span><a name="line-329"></a><span>    </span><span class="hs-comment">-- a source-import, and complain immediately, but it seems better</span><span>
</span><a name="line-330"></a><span>    </span><span class="hs-comment">-- to let upsweep_mods do this, so at least some useful work gets</span><span>
</span><a name="line-331"></a><span>    </span><span class="hs-comment">-- done before the upsweep is abandoned.</span><span>
</span><a name="line-332"></a><span>    </span><span class="hs-comment">--hPutStrLn stderr &quot;after tsort:\n&quot;</span><span>
</span><a name="line-333"></a><span>    </span><span class="hs-comment">--hPutStrLn stderr (showSDoc (vcat (map ppr mg2)))</span><span>
</span><a name="line-334"></a><span>
</span><a name="line-335"></a><span>    </span><span class="hs-comment">-- Now do the upsweep, calling compile for each module in</span><span>
</span><a name="line-336"></a><span>    </span><span class="hs-comment">-- turn.  Final result is version 3 of everything.</span><span>
</span><a name="line-337"></a><span>
</span><a name="line-338"></a><span>    </span><span class="hs-comment">-- Topologically sort the module graph, this time including hi-boot</span><span>
</span><a name="line-339"></a><span>    </span><span class="hs-comment">-- nodes, and possibly just including the portion of the graph</span><span>
</span><a name="line-340"></a><span>    </span><span class="hs-comment">-- reachable from the module specified in the 2nd argument to load.</span><span>
</span><a name="line-341"></a><span>    </span><span class="hs-comment">-- This graph should be cycle-free.</span><span>
</span><a name="line-342"></a><span>    </span><span class="hs-comment">-- If we're restricting the upsweep to a portion of the graph, we</span><span>
</span><a name="line-343"></a><span>    </span><span class="hs-comment">-- also want to retain everything that is still stable.</span><span>
</span><a name="line-344"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">full_mg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SCC</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span>
</span><a name="line-345"></a><span>        </span><a name="local-6989586621685213031"><a href="#local-6989586621685213031"><span class="hs-identifier">full_mg</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="GhcMake.html#topSortModuleGraph"><span class="hs-identifier hs-var">topSortModuleGraph</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621685213009"><span class="hs-identifier hs-var">mod_graph</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-346"></a><span>
</span><a name="line-347"></a><span>        </span><a name="local-6989586621685213032"><a href="#local-6989586621685213032"><span class="hs-identifier">maybe_top_mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685213007"><span class="hs-identifier hs-var">how_much</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-348"></a><span>                            </span><a href="GhcMake.html#LoadUpTo"><span class="hs-identifier hs-var">LoadUpTo</span></a><span> </span><a name="local-6989586621685213039"><a href="#local-6989586621685213039"><span class="hs-identifier">m</span></a></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685213039"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-349"></a><span>                            </span><a href="GhcMake.html#LoadDependenciesOf"><span class="hs-identifier hs-var">LoadDependenciesOf</span></a><span> </span><a name="local-6989586621685213040"><a href="#local-6989586621685213040"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685213040"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-350"></a><span>                            </span><span class="hs-identifier">_</span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-351"></a><span>
</span><a name="line-352"></a><span>        </span><span class="hs-identifier">partial_mg0</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SCC</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span>
</span><a name="line-353"></a><span>        </span><a name="local-6989586621685213033"><a href="#local-6989586621685213033"><span class="hs-identifier">partial_mg0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GhcMake.html#topSortModuleGraph"><span class="hs-identifier hs-var">topSortModuleGraph</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621685213009"><span class="hs-identifier hs-var">mod_graph</span></a><span> </span><a href="#local-6989586621685213032"><span class="hs-identifier hs-var">maybe_top_mod</span></a><span>
</span><a name="line-354"></a><span>
</span><a name="line-355"></a><span>        </span><span class="hs-comment">-- LoadDependenciesOf m: we want the upsweep to stop just</span><span>
</span><a name="line-356"></a><span>        </span><span class="hs-comment">-- short of the specified module (unless the specified module</span><span>
</span><a name="line-357"></a><span>        </span><span class="hs-comment">-- is stable).</span><span>
</span><a name="line-358"></a><span>        </span><a name="local-6989586621685213034"><a href="#local-6989586621685213034"><span class="hs-identifier">partial_mg</span></a></a><span>
</span><a name="line-359"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="GhcMake.html#LoadDependenciesOf"><span class="hs-identifier hs-var">LoadDependenciesOf</span></a><span> </span><a name="local-6989586621685213041"><a href="#local-6989586621685213041"><span class="hs-identifier">_mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213007"><span class="hs-identifier hs-var">how_much</span></a><span>
</span><a name="line-360"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">last</span><span> </span><span class="hs-identifier">partial_mg0</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-361"></a><span>                        </span><span class="hs-identifier">AcyclicSCC</span><span> </span><span class="hs-identifier">ms</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ms_mod_name</span><span> </span><span class="hs-identifier">ms</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">_mod</span><span class="hs-special">;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">False</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-362"></a><span>              </span><span class="hs-identifier hs-var">List.init</span><span> </span><a href="#local-6989586621685213033"><span class="hs-identifier hs-var">partial_mg0</span></a><span>
</span><a name="line-363"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-364"></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213033"><span class="hs-identifier hs-var">partial_mg0</span></a><span>
</span><a name="line-365"></a><span>
</span><a name="line-366"></a><span>        </span><a name="local-6989586621685213035"><a href="#local-6989586621685213035"><span class="hs-identifier">stable_mg</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-367"></a><span>            </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">AcyclicSCC</span><span> </span><a href="#local-6989586621685213043"><span class="hs-identifier hs-var">ms</span></a><span>
</span><a name="line-368"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">AcyclicSCC</span><span> </span><a name="local-6989586621685213043"><a href="#local-6989586621685213043"><span class="hs-identifier">ms</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213031"><span class="hs-identifier hs-var">full_mg</span></a><span class="hs-special">,</span><span>
</span><a name="line-369"></a><span>              </span><a href="#local-6989586621685213036"><span class="hs-identifier hs-var">stable_mod_summary</span></a><span> </span><a href="#local-6989586621685213043"><span class="hs-identifier hs-var">ms</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-370"></a><span>
</span><a name="line-371"></a><span>        </span><a name="local-6989586621685213036"><a href="#local-6989586621685213036"><span class="hs-identifier">stable_mod_summary</span></a></a><span> </span><a name="local-6989586621685213044"><a href="#local-6989586621685213044"><span class="hs-identifier">ms</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-372"></a><span>          </span><span class="hs-identifier hs-var">ms_mod_name</span><span> </span><a href="#local-6989586621685213044"><span class="hs-identifier hs-var">ms</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elementOfUniqSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685213024"><span class="hs-identifier hs-var">stable_obj</span></a><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-373"></a><span>          </span><span class="hs-identifier hs-var">ms_mod_name</span><span> </span><a href="#local-6989586621685213044"><span class="hs-identifier hs-var">ms</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elementOfUniqSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685213025"><span class="hs-identifier hs-var">stable_bco</span></a><span>
</span><a name="line-374"></a><span>
</span><a name="line-375"></a><span>        </span><span class="hs-comment">-- the modules from partial_mg that are not also stable</span><span>
</span><a name="line-376"></a><span>        </span><span class="hs-comment">-- NB. also keep cycles, we need to emit an error message later</span><span>
</span><a name="line-377"></a><span>        </span><a name="local-6989586621685213037"><a href="#local-6989586621685213037"><span class="hs-identifier">unstable_mg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621685213045"><span class="hs-identifier hs-var">not_stable</span></a><span> </span><a href="#local-6989586621685213034"><span class="hs-identifier hs-var">partial_mg</span></a><span>
</span><a name="line-378"></a><span>          </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621685213045"><a href="#local-6989586621685213045"><span class="hs-identifier">not_stable</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CyclicSCC</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-379"></a><span>                </span><span class="hs-identifier">not_stable</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AcyclicSCC</span><span> </span><a name="local-6989586621685213046"><a href="#local-6989586621685213046"><span class="hs-identifier">ms</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-380"></a><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621685213036"><span class="hs-identifier hs-var">stable_mod_summary</span></a><span> </span><a href="#local-6989586621685213046"><span class="hs-identifier hs-var">ms</span></a><span>
</span><a name="line-381"></a><span>
</span><a name="line-382"></a><span>        </span><span class="hs-comment">-- Load all the stable modules first, before attempting to load</span><span>
</span><a name="line-383"></a><span>        </span><span class="hs-comment">-- an unstable module (#7231).</span><span>
</span><a name="line-384"></a><span>        </span><a name="local-6989586621685213038"><a href="#local-6989586621685213038"><span class="hs-identifier">mg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213035"><span class="hs-identifier hs-var">stable_mg</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685213037"><span class="hs-identifier hs-var">unstable_mg</span></a><span>
</span><a name="line-385"></a><span>
</span><a name="line-386"></a><span>    </span><span class="hs-comment">-- clean up between compilations</span><span>
</span><a name="line-387"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213047"><a href="#local-6989586621685213047"><span class="hs-identifier">cleanup</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cleanCurrentModuleTempFiles</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">hsc_dflags</span><span>
</span><a name="line-388"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><a href="#local-6989586621685213013"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Ready for upsweep&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-389"></a><span>                               </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685213038"><span class="hs-identifier hs-var">mg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-390"></a><span>
</span><a name="line-391"></a><span>    </span><a name="local-6989586621685213049"><a href="#local-6989586621685213049"><span class="hs-identifier">n_jobs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">parMakeCount</span><span> </span><a href="#local-6989586621685213013"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-392"></a><span>                    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-identifier hs-var">getNumProcessors</span><span>
</span><a name="line-393"></a><span>                    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213048"><a href="#local-6989586621685213048"><span class="hs-identifier">n</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685213048"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-394"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213050"><a href="#local-6989586621685213050"><span class="hs-identifier">upsweep_fn</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685213049"><span class="hs-identifier hs-var">n_jobs</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="GhcMake.html#parUpsweep"><span class="hs-identifier hs-var">parUpsweep</span></a><span> </span><a href="#local-6989586621685213049"><span class="hs-identifier hs-var">n_jobs</span></a><span>
</span><a name="line-395"></a><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="GhcMake.html#upsweep"><span class="hs-identifier hs-var">upsweep</span></a><span>
</span><a name="line-396"></a><span>
</span><a name="line-397"></a><span>    </span><span class="hs-identifier hs-var">setSession</span><span> </span><a href="#local-6989586621685213011"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_HPT</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyHomePackageTable</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-398"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621685213051"><a href="#local-6989586621685213051"><span class="hs-identifier">upsweep_ok</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685213052"><a href="#local-6989586621685213052"><span class="hs-identifier">modsUpswept</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-399"></a><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213050"><span class="hs-identifier hs-var">upsweep_fn</span></a><span> </span><a href="#local-6989586621685213008"><span class="hs-identifier hs-var">mHscMessage</span></a><span> </span><a href="#local-6989586621685213026"><span class="hs-identifier hs-var">pruned_hpt</span></a><span> </span><a href="#local-6989586621685213023"><span class="hs-identifier hs-var">stable_mods</span></a><span> </span><a href="#local-6989586621685213047"><span class="hs-identifier hs-var">cleanup</span></a><span> </span><a href="#local-6989586621685213038"><span class="hs-identifier hs-var">mg</span></a><span>
</span><a name="line-400"></a><span>
</span><a name="line-401"></a><span>    </span><span class="hs-comment">-- Make modsDone be the summaries for each home module now</span><span>
</span><a name="line-402"></a><span>    </span><span class="hs-comment">-- available; this should equal the domain of hpt3.</span><span>
</span><a name="line-403"></a><span>    </span><span class="hs-comment">-- Get in in a roughly top .. bottom order (hence reverse).</span><span>
</span><a name="line-404"></a><span>
</span><a name="line-405"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213053"><a href="#local-6989586621685213053"><span class="hs-identifier">modsDone</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621685213052"><span class="hs-identifier hs-var">modsUpswept</span></a><span>
</span><a name="line-406"></a><span>
</span><a name="line-407"></a><span>    </span><span class="hs-comment">-- Try and do linking in some form, depending on whether the</span><span>
</span><a name="line-408"></a><span>    </span><span class="hs-comment">-- upsweep was completely or only partially successful.</span><span>
</span><a name="line-409"></a><span>
</span><a name="line-410"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">succeeded</span><span> </span><a href="#local-6989586621685213051"><span class="hs-identifier hs-var">upsweep_ok</span></a><span>
</span><a name="line-411"></a><span>
</span><a name="line-412"></a><span>     </span><span class="hs-keyword">then</span><span>
</span><a name="line-413"></a><span>       </span><span class="hs-comment">-- Easy; just relink it all.</span><span>
</span><a name="line-414"></a><span>       </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><a href="#local-6989586621685213013"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Upsweep completely successful.&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-415"></a><span>
</span><a name="line-416"></a><span>          </span><span class="hs-comment">-- Clean up after ourselves</span><span>
</span><a name="line-417"></a><span>          </span><a name="local-6989586621685213054"><a href="#local-6989586621685213054"><span class="hs-identifier">hsc_env1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getSession</span><span>
</span><a name="line-418"></a><span>          </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">cleanCurrentModuleTempFiles</span><span> </span><a href="#local-6989586621685213013"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-419"></a><span>
</span><a name="line-420"></a><span>          </span><span class="hs-comment">-- Issue a warning for the confusing case where the user</span><span>
</span><a name="line-421"></a><span>          </span><span class="hs-comment">-- said '-o foo' but we're not going to do any linking.</span><span>
</span><a name="line-422"></a><span>          </span><span class="hs-comment">-- We attempt linking if either (a) one of the modules is</span><span>
</span><a name="line-423"></a><span>          </span><span class="hs-comment">-- called Main, or (b) the user said -no-hs-main, indicating</span><span>
</span><a name="line-424"></a><span>          </span><span class="hs-comment">-- that main() is going to come from somewhere else.</span><span>
</span><a name="line-425"></a><span>          </span><span class="hs-comment">--</span><span>
</span><a name="line-426"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213055"><a href="#local-6989586621685213055"><span class="hs-identifier">ofile</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">outputFile</span><span> </span><a href="#local-6989586621685213013"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-427"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213056"><a href="#local-6989586621685213056"><span class="hs-identifier">no_hs_main</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_NoHsMain</span><span> </span><a href="#local-6989586621685213013"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-428"></a><span>          </span><span class="hs-keyword">let</span><span>
</span><a name="line-429"></a><span>            </span><a name="local-6989586621685213057"><a href="#local-6989586621685213057"><span class="hs-identifier">main_mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mainModIs</span><span> </span><a href="#local-6989586621685213013"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-430"></a><span>            </span><a name="local-6989586621685213058"><a href="#local-6989586621685213058"><span class="hs-identifier">a_root_is_Main</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mgElemModule</span><span> </span><a href="#local-6989586621685213009"><span class="hs-identifier hs-var">mod_graph</span></a><span> </span><a href="#local-6989586621685213057"><span class="hs-identifier hs-var">main_mod</span></a><span>
</span><a name="line-431"></a><span>            </span><a name="local-6989586621685213059"><a href="#local-6989586621685213059"><span class="hs-identifier">do_linking</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213058"><span class="hs-identifier hs-var">a_root_is_Main</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621685213056"><span class="hs-identifier hs-var">no_hs_main</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier">ghcLink</span><span> </span><a href="#local-6989586621685213013"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">LinkDynLib</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier">ghcLink</span><span> </span><a href="#local-6989586621685213013"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">LinkStaticLib</span><span>
</span><a name="line-432"></a><span>
</span><a name="line-433"></a><span>          </span><span class="hs-comment">-- link everything together</span><span>
</span><a name="line-434"></a><span>          </span><a name="local-6989586621685213060"><a href="#local-6989586621685213060"><span class="hs-identifier">linkresult</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="DriverPipeline.html#link"><span class="hs-identifier hs-var">link</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ghcLink</span><span> </span><a href="#local-6989586621685213013"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213013"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685213059"><span class="hs-identifier hs-var">do_linking</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_HPT</span><span> </span><a href="#local-6989586621685213054"><span class="hs-identifier hs-var">hsc_env1</span></a><span class="hs-special">)</span><span>
</span><a name="line-435"></a><span>
</span><a name="line-436"></a><span>          </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">ghcLink</span><span> </span><a href="#local-6989586621685213013"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">LinkBinary</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><a href="#local-6989586621685213055"><span class="hs-identifier hs-var">ofile</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621685213059"><span class="hs-identifier hs-var">do_linking</span></a><span>
</span><a name="line-437"></a><span>             </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-438"></a><span>                </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">errorMsg</span><span> </span><a href="#local-6989586621685213013"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">text</span><span>
</span><a name="line-439"></a><span>                   </span><span class="hs-special">(</span><span class="hs-string">&quot;output was redirected with -o, &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-440"></a><span>                    </span><span class="hs-string">&quot;but no output will be generated\n&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-441"></a><span>                    </span><span class="hs-string">&quot;because there is no &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-442"></a><span>                    </span><span class="hs-identifier hs-var">moduleNameString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621685213057"><span class="hs-identifier hs-var">main_mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; module.&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-443"></a><span>                </span><span class="hs-comment">-- This should be an error, not a warning (#10895).</span><span>
</span><a name="line-444"></a><span>                </span><a href="GhcMake.html#loadFinish"><span class="hs-identifier hs-var">loadFinish</span></a><span> </span><span class="hs-identifier hs-var">Failed</span><span> </span><a href="#local-6989586621685213060"><span class="hs-identifier hs-var">linkresult</span></a><span>
</span><a name="line-445"></a><span>             </span><span class="hs-keyword">else</span><span>
</span><a name="line-446"></a><span>                </span><a href="GhcMake.html#loadFinish"><span class="hs-identifier hs-var">loadFinish</span></a><span> </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><a href="#local-6989586621685213060"><span class="hs-identifier hs-var">linkresult</span></a><span>
</span><a name="line-447"></a><span>
</span><a name="line-448"></a><span>     </span><span class="hs-keyword">else</span><span>
</span><a name="line-449"></a><span>       </span><span class="hs-comment">-- Tricky.  We need to back out the effects of compiling any</span><span>
</span><a name="line-450"></a><span>       </span><span class="hs-comment">-- half-done cycles, both so as to clean up the top level envs</span><span>
</span><a name="line-451"></a><span>       </span><span class="hs-comment">-- and to avoid telling the interactive linker to link them.</span><span>
</span><a name="line-452"></a><span>       </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><a href="#local-6989586621685213013"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Upsweep partially successful.&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-453"></a><span>
</span><a name="line-454"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213061"><a href="#local-6989586621685213061"><span class="hs-identifier">modsDone_names</span></a></a><span>
</span><a name="line-455"></a><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">ms_mod</span><span> </span><a href="#local-6989586621685213053"><span class="hs-identifier hs-var">modsDone</span></a><span>
</span><a name="line-456"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213062"><a href="#local-6989586621685213062"><span class="hs-identifier">mods_to_zap_names</span></a></a><span>
</span><a name="line-457"></a><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="GhcMake.html#findPartiallyCompletedCycles"><span class="hs-identifier hs-var">findPartiallyCompletedCycles</span></a><span> </span><a href="#local-6989586621685213061"><span class="hs-identifier hs-var">modsDone_names</span></a><span>
</span><a name="line-458"></a><span>                      </span><a href="#local-6989586621685213022"><span class="hs-identifier hs-var">mg2_with_srcimps</span></a><span>
</span><a name="line-459"></a><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685213063"><a href="#local-6989586621685213063"><span class="hs-identifier">mods_to_clean</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685213064"><a href="#local-6989586621685213064"><span class="hs-identifier">mods_to_keep</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-460"></a><span>                </span><span class="hs-identifier hs-var">partition</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">Set.member</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685213062"><span class="hs-identifier hs-var">mods_to_zap_names</span></a><span class="hs-special">)</span><span class="hs-operator hs-var">.</span><span class="hs-identifier">ms_mod</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213053"><span class="hs-identifier hs-var">modsDone</span></a><span>
</span><a name="line-461"></a><span>          </span><a name="local-6989586621685213065"><a href="#local-6989586621685213065"><span class="hs-identifier">hsc_env1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getSession</span><span>
</span><a name="line-462"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213066"><a href="#local-6989586621685213066"><span class="hs-identifier">hpt4</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_HPT</span><span> </span><a href="#local-6989586621685213065"><span class="hs-identifier hs-var">hsc_env1</span></a><span>
</span><a name="line-463"></a><span>              </span><span class="hs-comment">-- We must change the lifetime to TFL_CurrentModule for any temp</span><span>
</span><a name="line-464"></a><span>              </span><span class="hs-comment">-- file created for an element of mod_to_clean during the upsweep.</span><span>
</span><a name="line-465"></a><span>              </span><span class="hs-comment">-- These include preprocessed files and object files for loaded</span><span>
</span><a name="line-466"></a><span>              </span><span class="hs-comment">-- modules.</span><span>
</span><a name="line-467"></a><span>              </span><a name="local-6989586621685213067"><a href="#local-6989586621685213067"><span class="hs-identifier">unneeded_temps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concat</span><span>
</span><a name="line-468"></a><span>                </span><span class="hs-special">[</span><a href="#local-6989586621685213069"><span class="hs-identifier hs-var">ms_hspp_file</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621685213070"><span class="hs-identifier hs-var">object_files</span></a><span>
</span><a name="line-469"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">ModSummary</span><span class="hs-special">{</span><a name="local-6989586621685213068"><a href="#local-6989586621685213068"><span class="hs-identifier">ms_mod</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685213069"><a href="#local-6989586621685213069"><span class="hs-identifier">ms_hspp_file</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213063"><span class="hs-identifier hs-var">mods_to_clean</span></a><span>
</span><a name="line-470"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213070"><a href="#local-6989586621685213070"><span class="hs-identifier">object_files</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">linkableObjs</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-471"></a><span>                        </span><span class="hs-identifier hs-var">lookupHpt</span><span> </span><a href="#local-6989586621685213066"><span class="hs-identifier hs-var">hpt4</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621685213068"><span class="hs-identifier hs-var">ms_mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-472"></a><span>                        </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier">hm_linkable</span><span>
</span><a name="line-473"></a><span>                </span><span class="hs-special">]</span><span>
</span><a name="line-474"></a><span>          </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-475"></a><span>            </span><span class="hs-identifier hs-var">changeTempFilesLifetime</span><span> </span><a href="#local-6989586621685213013"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">TFL_CurrentModule</span><span> </span><a href="#local-6989586621685213067"><span class="hs-identifier hs-var">unneeded_temps</span></a><span>
</span><a name="line-476"></a><span>          </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">cleanCurrentModuleTempFiles</span><span> </span><a href="#local-6989586621685213013"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-477"></a><span>
</span><a name="line-478"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213071"><a href="#local-6989586621685213071"><span class="hs-identifier">hpt5</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GhcMake.html#retainInTopLevelEnvs"><span class="hs-identifier hs-var">retainInTopLevelEnvs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ms_mod_name</span><span> </span><a href="#local-6989586621685213064"><span class="hs-identifier hs-var">mods_to_keep</span></a><span class="hs-special">)</span><span>
</span><a name="line-479"></a><span>                                          </span><a href="#local-6989586621685213066"><span class="hs-identifier hs-var">hpt4</span></a><span>
</span><a name="line-480"></a><span>
</span><a name="line-481"></a><span>          </span><span class="hs-comment">-- Clean up after ourselves</span><span>
</span><a name="line-482"></a><span>
</span><a name="line-483"></a><span>          </span><span class="hs-comment">-- there should be no Nothings where linkables should be, now</span><span>
</span><a name="line-484"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213072"><a href="#local-6989586621685213072"><span class="hs-identifier">just_linkables</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-485"></a><span>                    </span><span class="hs-identifier hs-var">isNoLink</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ghcLink</span><span> </span><a href="#local-6989586621685213013"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-486"></a><span>                 </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">allHpt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isJust</span><span class="hs-operator hs-var">.</span><span class="hs-identifier">hm_linkable</span><span class="hs-special">)</span><span>
</span><a name="line-487"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filterHpt</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">HsSrcFile</span><span class="hs-special">)</span><span class="hs-operator hs-var">.</span><span class="hs-identifier">mi_hsc_src</span><span class="hs-operator hs-var">.</span><span class="hs-identifier">hm_iface</span><span class="hs-special">)</span><span>
</span><a name="line-488"></a><span>                                </span><a href="#local-6989586621685213071"><span class="hs-identifier hs-var">hpt5</span></a><span class="hs-special">)</span><span>
</span><a name="line-489"></a><span>          </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">just_linkables</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-490"></a><span>
</span><a name="line-491"></a><span>          </span><span class="hs-comment">-- Link everything together</span><span>
</span><a name="line-492"></a><span>          </span><a name="local-6989586621685213073"><a href="#local-6989586621685213073"><span class="hs-identifier">linkresult</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="DriverPipeline.html#link"><span class="hs-identifier hs-var">link</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ghcLink</span><span> </span><a href="#local-6989586621685213013"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213013"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621685213071"><span class="hs-identifier hs-var">hpt5</span></a><span>
</span><a name="line-493"></a><span>
</span><a name="line-494"></a><span>          </span><span class="hs-identifier hs-var">modifySession</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685213074"><a href="#local-6989586621685213074"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685213074"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_HPT</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213071"><span class="hs-identifier hs-var">hpt5</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-495"></a><span>          </span><a href="GhcMake.html#loadFinish"><span class="hs-identifier hs-var">loadFinish</span></a><span> </span><span class="hs-identifier hs-var">Failed</span><span> </span><a href="#local-6989586621685213073"><span class="hs-identifier hs-var">linkresult</span></a><span>
</span><a name="line-496"></a><span>
</span><a name="line-497"></a><span>
</span><a name="line-498"></a><span class="hs-comment">-- | Finish up after a load.</span><span>
</span><a name="line-499"></a><span class="hs-identifier">loadFinish</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685212974"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">SuccessFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SuccessFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685212974"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">SuccessFlag</span><span>
</span><a name="line-500"></a><span>
</span><a name="line-501"></a><span class="hs-comment">-- If the link failed, unload everything and return.</span><span>
</span><a name="line-502"></a><a name="loadFinish"><a href="GhcMake.html#loadFinish"><span class="hs-identifier">loadFinish</span></a></a><span> </span><a name="local-6989586621685213075"><a href="#local-6989586621685213075"><span class="hs-identifier">_all_ok</span></a></a><span> </span><span class="hs-identifier hs-var">Failed</span><span>
</span><a name="line-503"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621685213076"><a href="#local-6989586621685213076"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getSession</span><span>
</span><a name="line-504"></a><span>       </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GhcMake.html#unload"><span class="hs-identifier hs-var">unload</span></a><span> </span><a href="#local-6989586621685213076"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-505"></a><span>       </span><span class="hs-identifier hs-var">modifySession</span><span> </span><a href="GhcMake.html#discardProg"><span class="hs-identifier hs-var">discardProg</span></a><span>
</span><a name="line-506"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Failed</span><span>
</span><a name="line-507"></a><span>
</span><a name="line-508"></a><span class="hs-comment">-- Empty the interactive context and set the module context to the topmost</span><span>
</span><a name="line-509"></a><span class="hs-comment">-- newly loaded module, or the Prelude if none were loaded.</span><span>
</span><a name="line-510"></a><span class="hs-identifier">loadFinish</span><span> </span><a name="local-6989586621685213077"><a href="#local-6989586621685213077"><span class="hs-identifier">all_ok</span></a></a><span> </span><span class="hs-identifier hs-var">Succeeded</span><span>
</span><a name="line-511"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier hs-var">modifySession</span><span> </span><a href="GhcMake.html#discardIC"><span class="hs-identifier hs-var">discardIC</span></a><span>
</span><a name="line-512"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685213077"><span class="hs-identifier hs-var">all_ok</span></a><span>
</span><a name="line-513"></a><span>
</span><a name="line-514"></a><span>
</span><a name="line-515"></a><span class="hs-comment">-- | Forget the current program, but retain the persistent info in HscEnv</span><span>
</span><a name="line-516"></a><span class="hs-identifier">discardProg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-517"></a><a name="discardProg"><a href="GhcMake.html#discardProg"><span class="hs-identifier">discardProg</span></a></a><span> </span><a name="local-6989586621685213078"><a href="#local-6989586621685213078"><span class="hs-identifier">hsc_env</span></a></a><span>
</span><a name="line-518"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="GhcMake.html#discardIC"><span class="hs-identifier hs-var">discardIC</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621685213078"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_mod_graph</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyMG</span><span>
</span><a name="line-519"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsc_HPT</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyHomePackageTable</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-520"></a><span>
</span><a name="line-521"></a><span class="hs-comment">-- | Discard the contents of the InteractiveContext, but keep the DynFlags.</span><span>
</span><a name="line-522"></a><span class="hs-comment">-- It will also keep ic_int_print and ic_monad if their names are from</span><span>
</span><a name="line-523"></a><span class="hs-comment">-- external packages.</span><span>
</span><a name="line-524"></a><span class="hs-identifier">discardIC</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-525"></a><a name="discardIC"><a href="GhcMake.html#discardIC"><span class="hs-identifier">discardIC</span></a></a><span> </span><a name="local-6989586621685213079"><a href="#local-6989586621685213079"><span class="hs-identifier">hsc_env</span></a></a><span>
</span><a name="line-526"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213079"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213084"><span class="hs-identifier hs-var">empty_ic</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ic_int_print</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213080"><span class="hs-identifier hs-var">new_ic_int_print</span></a><span>
</span><a name="line-527"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_monad</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213081"><span class="hs-identifier hs-var">new_ic_monad</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-528"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-529"></a><span>  </span><span class="hs-comment">-- Force the new values for ic_int_print and ic_monad to avoid leaking old_ic</span><span>
</span><a name="line-530"></a><span>  </span><span class="hs-glyph">!</span><a name="local-6989586621685213080"><a href="#local-6989586621685213080"><span class="hs-identifier">new_ic_int_print</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213085"><span class="hs-identifier hs-var">keep_external_name</span></a><span> </span><span class="hs-identifier">ic_int_print</span><span>
</span><a name="line-531"></a><span>  </span><span class="hs-glyph">!</span><a name="local-6989586621685213081"><a href="#local-6989586621685213081"><span class="hs-identifier">new_ic_monad</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213085"><span class="hs-identifier hs-var">keep_external_name</span></a><span> </span><span class="hs-identifier">ic_monad</span><span>
</span><a name="line-532"></a><span>  </span><a name="local-6989586621685213082"><a href="#local-6989586621685213082"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ic_dflags</span><span> </span><a href="#local-6989586621685213083"><span class="hs-identifier hs-var">old_ic</span></a><span>
</span><a name="line-533"></a><span>  </span><a name="local-6989586621685213083"><a href="#local-6989586621685213083"><span class="hs-identifier">old_ic</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><a href="#local-6989586621685213079"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-534"></a><span>  </span><a name="local-6989586621685213084"><a href="#local-6989586621685213084"><span class="hs-identifier">empty_ic</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyInteractiveContext</span><span> </span><a href="#local-6989586621685213082"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-535"></a><span>  </span><a name="local-6989586621685213085"><a href="#local-6989586621685213085"><span class="hs-identifier">keep_external_name</span></a></a><span> </span><a name="local-6989586621685213086"><a href="#local-6989586621685213086"><span class="hs-identifier">ic_name</span></a></a><span>
</span><a name="line-536"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">nameIsFromExternalPackage</span><span> </span><a href="#local-6989586621685213087"><span class="hs-identifier hs-var">this_pkg</span></a><span> </span><a href="#local-6989586621685213088"><span class="hs-identifier hs-var">old_name</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213088"><span class="hs-identifier hs-var">old_name</span></a><span>
</span><a name="line-537"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213086"><span class="hs-identifier hs-var">ic_name</span></a><span> </span><a href="#local-6989586621685213084"><span class="hs-identifier hs-var">empty_ic</span></a><span>
</span><a name="line-538"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-539"></a><span>    </span><a name="local-6989586621685213087"><a href="#local-6989586621685213087"><span class="hs-identifier">this_pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">thisPackage</span><span> </span><a href="#local-6989586621685213082"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-540"></a><span>    </span><a name="local-6989586621685213088"><a href="#local-6989586621685213088"><span class="hs-identifier">old_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213086"><span class="hs-identifier hs-var">ic_name</span></a><span> </span><a href="#local-6989586621685213083"><span class="hs-identifier hs-var">old_ic</span></a><span>
</span><a name="line-541"></a><span>
</span><a name="line-542"></a><span class="hs-comment">-- | If there is no -o option, guess the name of target executable</span><span>
</span><a name="line-543"></a><span class="hs-comment">-- by using top-level source file name as a base.</span><span>
</span><a name="line-544"></a><span class="hs-identifier">guessOutputFile</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685212973"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621685212973"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-545"></a><a name="guessOutputFile"><a href="GhcMake.html#guessOutputFile"><span class="hs-identifier">guessOutputFile</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modifySession</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685213089"><a href="#local-6989586621685213089"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-546"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213090"><a href="#local-6989586621685213090"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685213089"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-547"></a><span>        </span><span class="hs-comment">-- Force mod_graph to avoid leaking env</span><span>
</span><a name="line-548"></a><span>        </span><span class="hs-glyph">!</span><a name="local-6989586621685213091"><a href="#local-6989586621685213091"><span class="hs-identifier">mod_graph</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_mod_graph</span><span> </span><a href="#local-6989586621685213089"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-549"></a><span>        </span><span class="hs-identifier">mainModuleSrcPath</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-550"></a><span>        </span><a name="local-6989586621685213092"><a href="#local-6989586621685213092"><span class="hs-identifier">mainModuleSrcPath</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-551"></a><span>            </span><a name="local-6989586621685213095"><a href="#local-6989586621685213095"><span class="hs-identifier">ms</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mgLookupModule</span><span> </span><a href="#local-6989586621685213091"><span class="hs-identifier hs-var">mod_graph</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mainModIs</span><span> </span><a href="#local-6989586621685213090"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-552"></a><span>            </span><span class="hs-identifier">ml_hs_file</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ms_location</span><span> </span><a href="#local-6989586621685213095"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">)</span><span>
</span><a name="line-553"></a><span>        </span><a name="local-6989586621685213093"><a href="#local-6989586621685213093"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">dropExtension</span><span> </span><a href="#local-6989586621685213092"><span class="hs-identifier hs-var">mainModuleSrcPath</span></a><span>
</span><a name="line-554"></a><span>
</span><a name="line-555"></a><span>        </span><a name="local-6989586621685213094"><a href="#local-6989586621685213094"><span class="hs-identifier">name_exe</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-556"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span>          </span><span class="hs-comment">-- we must add the .exe extension unconditionally here, otherwise</span><span>
</span><a name="line-558"></a><span>          </span><span class="hs-comment">-- when name has an extension of its own, the .exe extension will</span><span>
</span><a name="line-559"></a><span>          </span><span class="hs-comment">-- not be added by DriverPipeline.exeFileName.  See #2248</span><span>
</span><a name="line-560"></a><span>          </span><span class="hs-identifier">name'</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-operator">&lt;.&gt;</span><span> </span><span class="hs-string">&quot;exe&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">name</span><span>
</span><a name="line-561"></a><span class="hs-cpp">#else
</span><span>          </span><a name="local-6989586621685213096"><a href="#local-6989586621685213096"><span class="hs-identifier">name'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213093"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-563"></a><span class="hs-cpp">#endif
</span><span>          </span><a name="local-6989586621685213097"><a href="#local-6989586621685213097"><span class="hs-identifier">mainModuleSrcPath'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213092"><span class="hs-identifier hs-var">mainModuleSrcPath</span></a><span>
</span><a name="line-565"></a><span>          </span><span class="hs-comment">-- #9930: don't clobber input files (unless they ask for it)</span><span>
</span><a name="line-566"></a><span>          </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621685213096"><span class="hs-identifier hs-var">name'</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621685213097"><span class="hs-identifier hs-var">mainModuleSrcPath'</span></a><span>
</span><a name="line-567"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">throwGhcException</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">UsageError</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-568"></a><span>                 </span><span class="hs-string">&quot;default output name would overwrite the input file; &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-569"></a><span>                 </span><span class="hs-string">&quot;must specify -o explicitly&quot;</span><span>
</span><a name="line-570"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685213096"><span class="hs-identifier hs-var">name'</span></a><span>
</span><a name="line-571"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-572"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">outputFile</span><span> </span><a href="#local-6989586621685213090"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-573"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685213089"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-574"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685213089"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213090"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">outputFile</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213094"><span class="hs-identifier hs-var">name_exe</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-575"></a><span>
</span><a name="line-576"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-577"></a><span class="hs-comment">--</span><span>
</span><a name="line-578"></a><span class="hs-comment">-- | Prune the HomePackageTable</span><span>
</span><a name="line-579"></a><span class="hs-comment">--</span><span>
</span><a name="line-580"></a><span class="hs-comment">-- Before doing an upsweep, we can throw away:</span><span>
</span><a name="line-581"></a><span class="hs-comment">--</span><span>
</span><a name="line-582"></a><span class="hs-comment">--   - For non-stable modules:</span><span>
</span><a name="line-583"></a><span class="hs-comment">--      - all ModDetails, all linked code</span><span>
</span><a name="line-584"></a><span class="hs-comment">--   - all unlinked code that is out of date with respect to</span><span>
</span><a name="line-585"></a><span class="hs-comment">--     the source file</span><span>
</span><a name="line-586"></a><span class="hs-comment">--</span><span>
</span><a name="line-587"></a><span class="hs-comment">-- This is VERY IMPORTANT otherwise we'll end up requiring 2x the</span><span>
</span><a name="line-588"></a><span class="hs-comment">-- space at the end of the upsweep, because the topmost ModDetails of the</span><span>
</span><a name="line-589"></a><span class="hs-comment">-- old HPT holds on to the entire type environment from the previous</span><span>
</span><a name="line-590"></a><span class="hs-comment">-- compilation.</span><span>
</span><a name="line-591"></a><span class="hs-identifier">pruneHomePackageTable</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HomePackageTable</span><span>
</span><a name="line-592"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span>
</span><a name="line-593"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GhcMake.html#StableModules"><span class="hs-identifier hs-type">StableModules</span></a><span>
</span><a name="line-594"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HomePackageTable</span><span>
</span><a name="line-595"></a><a name="pruneHomePackageTable"><a href="GhcMake.html#pruneHomePackageTable"><span class="hs-identifier">pruneHomePackageTable</span></a></a><span> </span><a name="local-6989586621685213098"><a href="#local-6989586621685213098"><span class="hs-identifier">hpt</span></a></a><span> </span><a name="local-6989586621685213099"><a href="#local-6989586621685213099"><span class="hs-identifier">summ</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621685213100"><a href="#local-6989586621685213100"><span class="hs-identifier">stable_obj</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685213101"><a href="#local-6989586621685213101"><span class="hs-identifier">stable_bco</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-596"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapHpt</span><span> </span><a href="#local-6989586621685213102"><span class="hs-identifier hs-var">prune</span></a><span> </span><a href="#local-6989586621685213098"><span class="hs-identifier hs-var">hpt</span></a><span>
</span><a name="line-597"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621685213102"><a href="#local-6989586621685213102"><span class="hs-identifier">prune</span></a></a><span> </span><a name="local-6989586621685213105"><a href="#local-6989586621685213105"><span class="hs-identifier">hmi</span></a></a><span>
</span><a name="line-598"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685213104"><span class="hs-identifier hs-var">is_stable</span></a><span> </span><a href="#local-6989586621685213106"><span class="hs-identifier hs-var">modl</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213107"><span class="hs-identifier hs-var">hmi'</span></a><span>
</span><a name="line-599"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213107"><span class="hs-identifier hs-var">hmi'</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">hm_details</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyModDetails</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-600"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-601"></a><span>           </span><a name="local-6989586621685213106"><a href="#local-6989586621685213106"><span class="hs-identifier">modl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">moduleName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_module</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hm_iface</span><span> </span><a href="#local-6989586621685213105"><span class="hs-identifier hs-var">hmi</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-602"></a><span>           </span><a name="local-6989586621685213107"><a href="#local-6989586621685213107"><span class="hs-identifier">hmi'</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213109"><a href="#local-6989586621685213109"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">hm_linkable</span><span> </span><a href="#local-6989586621685213105"><span class="hs-identifier hs-var">hmi</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">linkableTime</span><span> </span><a href="#local-6989586621685213109"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-identifier">ms_hs_date</span><span> </span><a href="#local-6989586621685213108"><span class="hs-identifier hs-var">ms</span></a><span>
</span><a name="line-603"></a><span>                </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213105"><span class="hs-identifier hs-var">hmi</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">hm_linkable</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-604"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-605"></a><span>                </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213105"><span class="hs-identifier hs-var">hmi</span></a><span>
</span><a name="line-606"></a><span>                </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621685213108"><a href="#local-6989586621685213108"><span class="hs-identifier">ms</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">expectJust</span><span> </span><span class="hs-string">&quot;prune&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lookupUFM</span><span> </span><a href="#local-6989586621685213103"><span class="hs-identifier hs-var">ms_map</span></a><span> </span><a href="#local-6989586621685213106"><span class="hs-identifier hs-var">modl</span></a><span class="hs-special">)</span><span>
</span><a name="line-607"></a><span>
</span><a name="line-608"></a><span>        </span><a name="local-6989586621685213103"><a href="#local-6989586621685213103"><span class="hs-identifier">ms_map</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">listToUFM</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">ms_mod_name</span><span> </span><a href="#local-6989586621685213110"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685213110"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621685213110"><a href="#local-6989586621685213110"><span class="hs-identifier">ms</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213099"><span class="hs-identifier hs-var">summ</span></a><span class="hs-special">]</span><span>
</span><a name="line-609"></a><span>
</span><a name="line-610"></a><span>        </span><a name="local-6989586621685213104"><a href="#local-6989586621685213104"><span class="hs-identifier">is_stable</span></a></a><span> </span><a name="local-6989586621685213111"><a href="#local-6989586621685213111"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-611"></a><span>          </span><a href="#local-6989586621685213111"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elementOfUniqSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685213100"><span class="hs-identifier hs-var">stable_obj</span></a><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-612"></a><span>          </span><a href="#local-6989586621685213111"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elementOfUniqSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685213101"><span class="hs-identifier hs-var">stable_bco</span></a><span>
</span><a name="line-613"></a><span>
</span><a name="line-614"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-615"></a><span class="hs-comment">--</span><span>
</span><a name="line-616"></a><span class="hs-comment">-- | Return (names of) all those in modsDone who are part of a cycle as defined</span><span>
</span><a name="line-617"></a><span class="hs-comment">-- by theGraph.</span><span>
</span><a name="line-618"></a><span class="hs-identifier">findPartiallyCompletedCycles</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Module</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SCC</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Set.Set</span><span> </span><span class="hs-identifier hs-type">Module</span><span>
</span><a name="line-619"></a><a name="findPartiallyCompletedCycles"><a href="GhcMake.html#findPartiallyCompletedCycles"><span class="hs-identifier">findPartiallyCompletedCycles</span></a></a><span> </span><a name="local-6989586621685213112"><a href="#local-6989586621685213112"><span class="hs-identifier">modsDone</span></a></a><span> </span><a name="local-6989586621685213113"><a href="#local-6989586621685213113"><span class="hs-identifier">theGraph</span></a></a><span>
</span><a name="line-620"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.unions</span><span>
</span><a name="line-621"></a><span>       </span><span class="hs-special">[</span><a href="#local-6989586621685213116"><span class="hs-identifier hs-var">mods_in_this_cycle</span></a><span>
</span><a name="line-622"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">CyclicSCC</span><span> </span><a name="local-6989586621685213114"><a href="#local-6989586621685213114"><span class="hs-identifier">vs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213113"><span class="hs-identifier hs-var">theGraph</span></a><span>  </span><span class="hs-comment">-- Acyclic? Not interesting.</span><span>
</span><a name="line-623"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213115"><a href="#local-6989586621685213115"><span class="hs-identifier">names_in_this_cycle</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.fromList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">ms_mod</span><span> </span><a href="#local-6989586621685213114"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">)</span><span>
</span><a name="line-624"></a><span>             </span><a name="local-6989586621685213116"><a href="#local-6989586621685213116"><span class="hs-identifier">mods_in_this_cycle</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-625"></a><span>                    </span><span class="hs-identifier hs-var">Set.intersection</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.fromList</span><span> </span><a href="#local-6989586621685213112"><span class="hs-identifier hs-var">modsDone</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213115"><span class="hs-identifier hs-var">names_in_this_cycle</span></a><span>
</span><a name="line-626"></a><span>         </span><span class="hs-comment">-- If size mods_in_this_cycle == size names_in_this_cycle,</span><span>
</span><a name="line-627"></a><span>         </span><span class="hs-comment">-- then this cycle has already been completed and we're not</span><span>
</span><a name="line-628"></a><span>         </span><span class="hs-comment">-- interested.</span><span>
</span><a name="line-629"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Set.size</span><span> </span><a href="#local-6989586621685213116"><span class="hs-identifier hs-var">mods_in_this_cycle</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-identifier hs-var">Set.size</span><span> </span><a href="#local-6989586621685213115"><span class="hs-identifier hs-var">names_in_this_cycle</span></a><span class="hs-special">]</span><span>
</span><a name="line-630"></a><span>
</span><a name="line-631"></a><span>
</span><a name="line-632"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-633"></a><span class="hs-comment">--</span><span>
</span><a name="line-634"></a><span class="hs-comment">-- | Unloading</span><span>
</span><a name="line-635"></a><span class="hs-identifier">unload</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Linkable</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-636"></a><a name="unload"><a href="GhcMake.html#unload"><span class="hs-identifier">unload</span></a></a><span> </span><a name="local-6989586621685213117"><a href="#local-6989586621685213117"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621685213118"><a href="#local-6989586621685213118"><span class="hs-identifier">stable_linkables</span></a></a><span> </span><span class="hs-comment">-- Unload everthing *except* 'stable_linkables'</span><span>
</span><a name="line-637"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">ghcLink</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685213117"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-638"></a><span>        </span><span class="hs-identifier hs-var">LinkInMemory</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Linker.html#unload"><span class="hs-identifier hs-var">Linker.unload</span></a><span> </span><a href="#local-6989586621685213117"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685213118"><span class="hs-identifier hs-var">stable_linkables</span></a><span>
</span><a name="line-639"></a><span>        </span><a name="local-6989586621685213119"><a href="#local-6989586621685213119"><span class="hs-identifier">_other</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-640"></a><span>
</span><a name="line-641"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-642"></a><span class="hs-comment">{- |

  Stability tells us which modules definitely do not need to be recompiled.
  There are two main reasons for having stability:

   - avoid doing a complete upsweep of the module graph in GHCi when
     modules near the bottom of the tree have not changed.

   - to tell GHCi when it can load object code: we can only load object code
     for a module when we also load object code fo  all of the imports of the
     module.  So we need to know that we will definitely not be recompiling
     any of these modules, and we can use the object code.

  The stability check is as follows.  Both stableObject and
  stableBCO are used during the upsweep phase later.

@
  stable m = stableObject m || stableBCO m

  stableObject m =
        all stableObject (imports m)
        &amp;&amp; old linkable does not exist, or is == on-disk .o
        &amp;&amp; date(on-disk .o) &gt; date(.hs)

  stableBCO m =
        all stable (imports m)
        &amp;&amp; date(BCO) &gt; date(.hs)
@

  These properties embody the following ideas:

    - if a module is stable, then:

        - if it has been compiled in a previous pass (present in HPT)
          then it does not need to be compiled or re-linked.

        - if it has not been compiled in a previous pass,
          then we only need to read its .hi file from disk and
          link it to produce a 'ModDetails'.

    - if a modules is not stable, we will definitely be at least
      re-linking, and possibly re-compiling it during the 'upsweep'.
      All non-stable modules can (and should) therefore be unlinked
      before the 'upsweep'.

    - Note that objects are only considered stable if they only depend
      on other objects.  We can't link object code against byte code.

    - Note that even if an object is stable, we may end up recompiling
      if the interface is out of date because an *external* interface
      has changed.  The current code in GhcMake handles this case
      fairly poorly, so be careful.
-}</span><span>
</span><a name="line-695"></a><span>
</span><a name="line-696"></a><span class="hs-keyword">type</span><span> </span><a name="StableModules"><a href="GhcMake.html#StableModules"><span class="hs-identifier">StableModules</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-697"></a><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">UniqSet</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span>  </span><span class="hs-comment">-- stableObject</span><span>
</span><a name="line-698"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">UniqSet</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span>  </span><span class="hs-comment">-- stableBCO</span><span>
</span><a name="line-699"></a><span>  </span><span class="hs-special">)</span><span>
</span><a name="line-700"></a><span>
</span><a name="line-701"></a><span>
</span><a name="line-702"></a><span class="hs-identifier">checkStability</span><span>
</span><a name="line-703"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HomePackageTable</span><span>   </span><span class="hs-comment">-- HPT from last compilation</span><span>
</span><a name="line-704"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SCC</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- current module graph (cyclic)</span><span>
</span><a name="line-705"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSet</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span> </span><span class="hs-comment">-- all home modules</span><span>
</span><a name="line-706"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GhcMake.html#StableModules"><span class="hs-identifier hs-type">StableModules</span></a><span>
</span><a name="line-707"></a><span>
</span><a name="line-708"></a><a name="checkStability"><a href="GhcMake.html#checkStability"><span class="hs-identifier">checkStability</span></a></a><span> </span><a name="local-6989586621685213120"><a href="#local-6989586621685213120"><span class="hs-identifier">hpt</span></a></a><span> </span><a name="local-6989586621685213121"><a href="#local-6989586621685213121"><span class="hs-identifier">sccs</span></a></a><span> </span><a name="local-6989586621685213122"><a href="#local-6989586621685213122"><span class="hs-identifier">all_home_mods</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-709"></a><span>  </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="#local-6989586621685213123"><span class="hs-identifier hs-var">checkSCC</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">emptyUniqSet</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyUniqSet</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213121"><span class="hs-identifier hs-var">sccs</span></a><span>
</span><a name="line-710"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-711"></a><span>   </span><span class="hs-identifier">checkSCC</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GhcMake.html#StableModules"><span class="hs-identifier hs-type">StableModules</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SCC</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GhcMake.html#StableModules"><span class="hs-identifier hs-type">StableModules</span></a><span>
</span><a name="line-712"></a><span>   </span><a name="local-6989586621685213123"><a href="#local-6989586621685213123"><span class="hs-identifier">checkSCC</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621685213124"><a href="#local-6989586621685213124"><span class="hs-identifier">stable_obj</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685213125"><a href="#local-6989586621685213125"><span class="hs-identifier">stable_bco</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621685213126"><a href="#local-6989586621685213126"><span class="hs-identifier">scc0</span></a></a><span>
</span><a name="line-713"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685213133"><span class="hs-identifier hs-var">stableObjects</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">addListToUniqSet</span><span> </span><a href="#local-6989586621685213124"><span class="hs-identifier hs-var">stable_obj</span></a><span> </span><a href="#local-6989586621685213128"><span class="hs-identifier hs-var">scc_mods</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685213125"><span class="hs-identifier hs-var">stable_bco</span></a><span class="hs-special">)</span><span>
</span><a name="line-714"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685213134"><span class="hs-identifier hs-var">stableBCOs</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213124"><span class="hs-identifier hs-var">stable_obj</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">addListToUniqSet</span><span> </span><a href="#local-6989586621685213125"><span class="hs-identifier hs-var">stable_bco</span></a><span> </span><a href="#local-6989586621685213128"><span class="hs-identifier hs-var">scc_mods</span></a><span class="hs-special">)</span><span>
</span><a name="line-715"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213124"><span class="hs-identifier hs-var">stable_obj</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685213125"><span class="hs-identifier hs-var">stable_bco</span></a><span class="hs-special">)</span><span>
</span><a name="line-716"></a><span>     </span><span class="hs-keyword">where</span><span>
</span><a name="line-717"></a><span>        </span><a name="local-6989586621685213127"><a href="#local-6989586621685213127"><span class="hs-identifier">scc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">flattenSCC</span><span> </span><a href="#local-6989586621685213126"><span class="hs-identifier hs-var">scc0</span></a><span>
</span><a name="line-718"></a><span>        </span><a name="local-6989586621685213128"><a href="#local-6989586621685213128"><span class="hs-identifier">scc_mods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ms_mod_name</span><span> </span><a href="#local-6989586621685213127"><span class="hs-identifier hs-var">scc</span></a><span>
</span><a name="line-719"></a><span>        </span><a name="local-6989586621685213129"><a href="#local-6989586621685213129"><span class="hs-identifier">home_module</span></a></a><span> </span><a name="local-6989586621685213137"><a href="#local-6989586621685213137"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-720"></a><span>          </span><a href="#local-6989586621685213137"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elementOfUniqSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685213122"><span class="hs-identifier hs-var">all_home_mods</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621685213137"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">notElem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685213128"><span class="hs-identifier hs-var">scc_mods</span></a><span>
</span><a name="line-721"></a><span>
</span><a name="line-722"></a><span>        </span><a name="local-6989586621685213130"><a href="#local-6989586621685213130"><span class="hs-identifier">scc_allimps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nub</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621685213129"><span class="hs-identifier hs-var">home_module</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="GhcMake.html#ms_home_allimps"><span class="hs-identifier hs-var">ms_home_allimps</span></a><span> </span><a href="#local-6989586621685213127"><span class="hs-identifier hs-var">scc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-723"></a><span>            </span><span class="hs-comment">-- all imports outside the current SCC, but in the home pkg</span><span>
</span><a name="line-724"></a><span>
</span><a name="line-725"></a><span>        </span><a name="local-6989586621685213131"><a href="#local-6989586621685213131"><span class="hs-identifier">stable_obj_imps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elementOfUniqSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685213124"><span class="hs-identifier hs-var">stable_obj</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213130"><span class="hs-identifier hs-var">scc_allimps</span></a><span>
</span><a name="line-726"></a><span>        </span><a name="local-6989586621685213132"><a href="#local-6989586621685213132"><span class="hs-identifier">stable_bco_imps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elementOfUniqSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685213125"><span class="hs-identifier hs-var">stable_bco</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213130"><span class="hs-identifier hs-var">scc_allimps</span></a><span>
</span><a name="line-727"></a><span>
</span><a name="line-728"></a><span>        </span><a name="local-6989586621685213133"><a href="#local-6989586621685213133"><span class="hs-identifier">stableObjects</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-729"></a><span>           </span><span class="hs-identifier hs-var">and</span><span> </span><a href="#local-6989586621685213131"><span class="hs-identifier hs-var">stable_obj_imps</span></a><span>
</span><a name="line-730"></a><span>           </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><a href="#local-6989586621685213135"><span class="hs-identifier hs-var">object_ok</span></a><span> </span><a href="#local-6989586621685213127"><span class="hs-identifier hs-var">scc</span></a><span>
</span><a name="line-731"></a><span>
</span><a name="line-732"></a><span>        </span><a name="local-6989586621685213134"><a href="#local-6989586621685213134"><span class="hs-identifier">stableBCOs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-733"></a><span>           </span><span class="hs-identifier hs-var">and</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">||</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213131"><span class="hs-identifier hs-var">stable_obj_imps</span></a><span> </span><a href="#local-6989586621685213132"><span class="hs-identifier hs-var">stable_bco_imps</span></a><span class="hs-special">)</span><span>
</span><a name="line-734"></a><span>           </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><a href="#local-6989586621685213136"><span class="hs-identifier hs-var">bco_ok</span></a><span> </span><a href="#local-6989586621685213127"><span class="hs-identifier hs-var">scc</span></a><span>
</span><a name="line-735"></a><span>
</span><a name="line-736"></a><span>        </span><a name="local-6989586621685213135"><a href="#local-6989586621685213135"><span class="hs-identifier">object_ok</span></a></a><span> </span><a name="local-6989586621685213138"><a href="#local-6989586621685213138"><span class="hs-identifier">ms</span></a></a><span>
</span><a name="line-737"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_ForceRecomp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ms_hspp_opts</span><span> </span><a href="#local-6989586621685213138"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-738"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213144"><a href="#local-6989586621685213144"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">ms_obj_date</span><span> </span><a href="#local-6989586621685213138"><span class="hs-identifier hs-var">ms</span></a><span>  </span><span class="hs-glyph">=</span><span>  </span><a href="#local-6989586621685213144"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-identifier">ms_hs_date</span><span> </span><a href="#local-6989586621685213138"><span class="hs-identifier hs-var">ms</span></a><span>
</span><a name="line-739"></a><span>                                         </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621685213139"><span class="hs-identifier hs-var">same_as_prev</span></a><span> </span><a href="#local-6989586621685213144"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-740"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-741"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-742"></a><span>             </span><a name="local-6989586621685213139"><a href="#local-6989586621685213139"><span class="hs-identifier">same_as_prev</span></a></a><span> </span><a name="local-6989586621685213140"><a href="#local-6989586621685213140"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupHpt</span><span> </span><a href="#local-6989586621685213120"><span class="hs-identifier hs-var">hpt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ms_mod_name</span><span> </span><a href="#local-6989586621685213138"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-743"></a><span>                                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213141"><a href="#local-6989586621685213141"><span class="hs-identifier">hmi</span></a></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213142"><a href="#local-6989586621685213142"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">hm_linkable</span><span> </span><a href="#local-6989586621685213141"><span class="hs-identifier hs-var">hmi</span></a><span>
</span><a name="line-744"></a><span>                                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">isObjectLinkable</span><span> </span><a href="#local-6989586621685213142"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621685213140"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">linkableTime</span><span> </span><a href="#local-6989586621685213142"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-745"></a><span>                                </span><a name="local-6989586621685213143"><a href="#local-6989586621685213143"><span class="hs-identifier">_other</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-746"></a><span>                </span><span class="hs-comment">-- why '&gt;=' rather than '&gt;' above?  If the filesystem stores</span><span>
</span><a name="line-747"></a><span>                </span><span class="hs-comment">-- times to the nearset second, we may occasionally find that</span><span>
</span><a name="line-748"></a><span>                </span><span class="hs-comment">-- the object &amp; source have the same modification time,</span><span>
</span><a name="line-749"></a><span>                </span><span class="hs-comment">-- especially if the source was automatically generated</span><span>
</span><a name="line-750"></a><span>                </span><span class="hs-comment">-- and compiled.  Using &gt;= is slightly unsafe, but it matches</span><span>
</span><a name="line-751"></a><span>                </span><span class="hs-comment">-- make's behaviour.</span><span>
</span><a name="line-752"></a><span>                </span><span class="hs-comment">--</span><span>
</span><a name="line-753"></a><span>                </span><span class="hs-comment">-- But see #5527, where someone ran into this and it caused</span><span>
</span><a name="line-754"></a><span>                </span><span class="hs-comment">-- a problem.</span><span>
</span><a name="line-755"></a><span>
</span><a name="line-756"></a><span>        </span><a name="local-6989586621685213136"><a href="#local-6989586621685213136"><span class="hs-identifier">bco_ok</span></a></a><span> </span><a name="local-6989586621685213145"><a href="#local-6989586621685213145"><span class="hs-identifier">ms</span></a></a><span>
</span><a name="line-757"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_ForceRecomp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ms_hspp_opts</span><span> </span><a href="#local-6989586621685213145"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-758"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupHpt</span><span> </span><a href="#local-6989586621685213120"><span class="hs-identifier hs-var">hpt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ms_mod_name</span><span> </span><a href="#local-6989586621685213145"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-759"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213146"><a href="#local-6989586621685213146"><span class="hs-identifier">hmi</span></a></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213147"><a href="#local-6989586621685213147"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">hm_linkable</span><span> </span><a href="#local-6989586621685213146"><span class="hs-identifier hs-var">hmi</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-760"></a><span>                        </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isObjectLinkable</span><span> </span><a href="#local-6989586621685213147"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-761"></a><span>                        </span><span class="hs-identifier">linkableTime</span><span> </span><a href="#local-6989586621685213147"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-identifier">ms_hs_date</span><span> </span><a href="#local-6989586621685213145"><span class="hs-identifier hs-var">ms</span></a><span>
</span><a name="line-762"></a><span>                </span><a name="local-6989586621685213148"><a href="#local-6989586621685213148"><span class="hs-identifier">_other</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-763"></a><span>
</span><a name="line-764"></a><span class="hs-comment">{- Parallel Upsweep
 -
 - The parallel upsweep attempts to concurrently compile the modules in the
 - compilation graph using multiple Haskell threads.
 -
 - The Algorithm
 -
 - A Haskell thread is spawned for each module in the module graph, waiting for
 - its direct dependencies to finish building before it itself begins to build.
 -
 - Each module is associated with an initially empty MVar that stores the
 - result of that particular module's compile. If the compile succeeded, then
 - the HscEnv (synchronized by an MVar) is updated with the fresh HMI of that
 - module, and the module's HMI is deleted from the old HPT (synchronized by an
 - IORef) to save space.
 -
 - Instead of immediately outputting messages to the standard handles, all
 - compilation output is deferred to a per-module TQueue. A QSem is used to
 - limit the number of workers that are compiling simultaneously.
 -
 - Meanwhile, the main thread sequentially loops over all the modules in the
 - module graph, outputting the messages stored in each module's TQueue.
-}</span><span>
</span><a name="line-787"></a><span>
</span><a name="line-788"></a><span class="hs-comment">-- | Each module is given a unique 'LogQueue' to redirect compilation messages</span><span>
</span><a name="line-789"></a><span class="hs-comment">-- to. A 'Nothing' value contains the result of compilation, and denotes the</span><span>
</span><a name="line-790"></a><span class="hs-comment">-- end of the message queue.</span><span>
</span><a name="line-791"></a><span class="hs-keyword">data</span><span> </span><a name="LogQueue"><a href="GhcMake.html#LogQueue"><span class="hs-identifier">LogQueue</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="LogQueue"><a href="GhcMake.html#LogQueue"><span class="hs-identifier">LogQueue</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">IORef</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">WarnReason</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Severity</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">PprStyle</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-792"></a><span>                         </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">MVar</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-793"></a><span>
</span><a name="line-794"></a><span class="hs-comment">-- | The graph of modules to compile and their corresponding result 'MVar' and</span><span>
</span><a name="line-795"></a><span class="hs-comment">-- 'LogQueue'.</span><span>
</span><a name="line-796"></a><span class="hs-keyword">type</span><span> </span><a name="CompilationGraph"><a href="GhcMake.html#CompilationGraph"><span class="hs-identifier">CompilationGraph</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MVar</span><span> </span><span class="hs-identifier hs-type">SuccessFlag</span><span class="hs-special">,</span><span> </span><a href="GhcMake.html#LogQueue"><span class="hs-identifier hs-type">LogQueue</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-797"></a><span>
</span><a name="line-798"></a><span class="hs-comment">-- | Build a 'CompilationGraph' out of a list of strongly-connected modules,</span><span>
</span><a name="line-799"></a><span class="hs-comment">-- also returning the first, if any, encountered module cycle.</span><span>
</span><a name="line-800"></a><span class="hs-identifier">buildCompGraph</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SCC</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="GhcMake.html#CompilationGraph"><span class="hs-identifier hs-type">CompilationGraph</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-801"></a><a name="buildCompGraph"><a href="GhcMake.html#buildCompGraph"><span class="hs-identifier">buildCompGraph</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-802"></a><span class="hs-identifier">buildCompGraph</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685213149"><a href="#local-6989586621685213149"><span class="hs-identifier">scc</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621685213150"><a href="#local-6989586621685213150"><span class="hs-identifier">sccs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685213149"><span class="hs-identifier hs-var">scc</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-803"></a><span>    </span><span class="hs-identifier hs-var">AcyclicSCC</span><span> </span><a name="local-6989586621685213151"><a href="#local-6989586621685213151"><span class="hs-identifier">ms</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-804"></a><span>        </span><a name="local-6989586621685213152"><a href="#local-6989586621685213152"><span class="hs-identifier">mvar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newEmptyMVar</span><span>
</span><a name="line-805"></a><span>        </span><a name="local-6989586621685213155"><a href="#local-6989586621685213155"><span class="hs-identifier">log_queue</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-806"></a><span>            </span><a name="local-6989586621685213153"><a href="#local-6989586621685213153"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-807"></a><span>            </span><a name="local-6989586621685213154"><a href="#local-6989586621685213154"><span class="hs-identifier">sem</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newEmptyMVar</span><span>
</span><a name="line-808"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="GhcMake.html#LogQueue"><span class="hs-identifier hs-var">LogQueue</span></a><span> </span><a href="#local-6989586621685213153"><span class="hs-identifier hs-var">ref</span></a><span> </span><a href="#local-6989586621685213154"><span class="hs-identifier hs-var">sem</span></a><span class="hs-special">)</span><span>
</span><a name="line-809"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621685213156"><a href="#local-6989586621685213156"><span class="hs-identifier">rest</span></a></a><span class="hs-special">,</span><a name="local-6989586621685213157"><a href="#local-6989586621685213157"><span class="hs-identifier">cycle</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GhcMake.html#buildCompGraph"><span class="hs-identifier hs-var">buildCompGraph</span></a><span> </span><a href="#local-6989586621685213150"><span class="hs-identifier hs-var">sccs</span></a><span>
</span><a name="line-810"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621685213151"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">,</span><a href="#local-6989586621685213152"><span class="hs-identifier hs-var">mvar</span></a><span class="hs-special">,</span><a href="#local-6989586621685213155"><span class="hs-identifier hs-var">log_queue</span></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a href="#local-6989586621685213156"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685213157"><span class="hs-identifier hs-var">cycle</span></a><span class="hs-special">)</span><span>
</span><a name="line-811"></a><span>    </span><span class="hs-identifier hs-var">CyclicSCC</span><span> </span><a name="local-6989586621685213158"><a href="#local-6989586621685213158"><span class="hs-identifier">mss</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685213158"><span class="hs-identifier hs-var">mss</span></a><span class="hs-special">)</span><span>
</span><a name="line-812"></a><span>
</span><a name="line-813"></a><span class="hs-comment">-- A Module and whether it is a boot module.</span><span>
</span><a name="line-814"></a><span class="hs-keyword">type</span><span> </span><a name="BuildModule"><a href="GhcMake.html#BuildModule"><span class="hs-identifier">BuildModule</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Module</span><span class="hs-special">,</span><span> </span><a href="GhcMake.html#IsBoot"><span class="hs-identifier hs-type">IsBoot</span></a><span class="hs-special">)</span><span>
</span><a name="line-815"></a><span>
</span><a name="line-816"></a><span class="hs-comment">-- | 'Bool' indicating if a module is a boot module or not.  We need to treat</span><span>
</span><a name="line-817"></a><span class="hs-comment">-- boot modules specially when building compilation graphs, since they break</span><span>
</span><a name="line-818"></a><span class="hs-comment">-- cycles.  Regular source files and signature files are treated equivalently.</span><span>
</span><a name="line-819"></a><span class="hs-keyword">data</span><span> </span><a name="IsBoot"><a href="GhcMake.html#IsBoot"><span class="hs-identifier">IsBoot</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="IsBoot"><a href="GhcMake.html#IsBoot"><span class="hs-identifier">IsBoot</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="NotBoot"><a href="GhcMake.html#NotBoot"><span class="hs-identifier">NotBoot</span></a></a><span>
</span><a name="line-820"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Read</span><span class="hs-special">)</span><span>
</span><a name="line-821"></a><span>
</span><a name="line-822"></a><span class="hs-comment">-- | Tests if an 'HscSource' is a boot file, primarily for constructing</span><span>
</span><a name="line-823"></a><span class="hs-comment">-- elements of 'BuildModule'.</span><span>
</span><a name="line-824"></a><span class="hs-identifier">hscSourceToIsBoot</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscSource</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GhcMake.html#IsBoot"><span class="hs-identifier hs-type">IsBoot</span></a><span>
</span><a name="line-825"></a><a name="hscSourceToIsBoot"><a href="GhcMake.html#hscSourceToIsBoot"><span class="hs-identifier">hscSourceToIsBoot</span></a></a><span> </span><span class="hs-identifier hs-var">HsBootFile</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="GhcMake.html#IsBoot"><span class="hs-identifier hs-var">IsBoot</span></a><span>
</span><a name="line-826"></a><span class="hs-identifier">hscSourceToIsBoot</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="GhcMake.html#NotBoot"><span class="hs-identifier hs-var">NotBoot</span></a><span>
</span><a name="line-827"></a><span>
</span><a name="line-828"></a><span class="hs-identifier">mkBuildModule</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GhcMake.html#BuildModule"><span class="hs-identifier hs-type">BuildModule</span></a><span>
</span><a name="line-829"></a><a name="mkBuildModule"><a href="GhcMake.html#mkBuildModule"><span class="hs-identifier">mkBuildModule</span></a></a><span> </span><a name="local-6989586621685213159"><a href="#local-6989586621685213159"><span class="hs-identifier">ms</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ms_mod</span><span> </span><a href="#local-6989586621685213159"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">,</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isBootSummary</span><span> </span><a href="#local-6989586621685213159"><span class="hs-identifier hs-var">ms</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="GhcMake.html#IsBoot"><span class="hs-identifier hs-var">IsBoot</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="GhcMake.html#NotBoot"><span class="hs-identifier hs-var">NotBoot</span></a><span class="hs-special">)</span><span>
</span><a name="line-830"></a><span>
</span><a name="line-831"></a><span class="hs-comment">-- | The entry point to the parallel upsweep.</span><span>
</span><a name="line-832"></a><span class="hs-comment">--</span><span>
</span><a name="line-833"></a><span class="hs-comment">-- See also the simpler, sequential 'upsweep'.</span><span>
</span><a name="line-834"></a><span class="hs-identifier">parUpsweep</span><span>
</span><a name="line-835"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685212972"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-836"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-837"></a><span>    </span><span class="hs-comment">-- ^ The number of workers we wish to run in parallel</span><span>
</span><a name="line-838"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="HscMain.html#Messager"><span class="hs-identifier hs-type">Messager</span></a><span>
</span><a name="line-839"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HomePackageTable</span><span>
</span><a name="line-840"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GhcMake.html#StableModules"><span class="hs-identifier hs-type">StableModules</span></a><span>
</span><a name="line-841"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-842"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SCC</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span>
</span><a name="line-843"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685212972"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SuccessFlag</span><span class="hs-special">,</span><span>
</span><a name="line-844"></a><span>          </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-845"></a><a name="parUpsweep"><a href="GhcMake.html#parUpsweep"><span class="hs-identifier">parUpsweep</span></a></a><span> </span><a name="local-6989586621685213160"><a href="#local-6989586621685213160"><span class="hs-identifier">n_jobs</span></a></a><span> </span><a name="local-6989586621685213161"><a href="#local-6989586621685213161"><span class="hs-identifier">mHscMessage</span></a></a><span> </span><a name="local-6989586621685213162"><a href="#local-6989586621685213162"><span class="hs-identifier">old_hpt</span></a></a><span> </span><a name="local-6989586621685213163"><a href="#local-6989586621685213163"><span class="hs-identifier">stable_mods</span></a></a><span> </span><a name="local-6989586621685213164"><a href="#local-6989586621685213164"><span class="hs-identifier">cleanup</span></a></a><span> </span><a name="local-6989586621685213165"><a href="#local-6989586621685213165"><span class="hs-identifier">sccs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-846"></a><span>    </span><a name="local-6989586621685213194"><a href="#local-6989586621685213194"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getSession</span><span>
</span><a name="line-847"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213195"><a href="#local-6989586621685213195"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685213194"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-848"></a><span>
</span><a name="line-849"></a><span>    </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-special">(</span><a href="GhcMake.html#unitIdsToCheck"><span class="hs-identifier hs-var">unitIdsToCheck</span></a><span> </span><a href="#local-6989586621685213195"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-850"></a><span>      </span><span class="hs-identifier hs-var">throwGhcException</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ProgramError</span><span> </span><span class="hs-string">&quot;Backpack typechecking not supported with -j&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-851"></a><span>
</span><a name="line-852"></a><span>    </span><span class="hs-comment">-- The bits of shared state we'll be using:</span><span>
</span><a name="line-853"></a><span>
</span><a name="line-854"></a><span>    </span><span class="hs-comment">-- The global HscEnv is updated with the module's HMI when a module</span><span>
</span><a name="line-855"></a><span>    </span><span class="hs-comment">-- successfully compiles.</span><span>
</span><a name="line-856"></a><span>    </span><a name="local-6989586621685213196"><a href="#local-6989586621685213196"><span class="hs-identifier">hsc_env_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">newMVar</span><span> </span><a href="#local-6989586621685213194"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-857"></a><span>
</span><a name="line-858"></a><span>    </span><span class="hs-comment">-- The old HPT is used for recompilation checking in upsweep_mod. When a</span><span>
</span><a name="line-859"></a><span>    </span><span class="hs-comment">-- module successfully gets compiled, its HMI is pruned from the old HPT.</span><span>
</span><a name="line-860"></a><span>    </span><a name="local-6989586621685213197"><a href="#local-6989586621685213197"><span class="hs-identifier">old_hpt_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><a href="#local-6989586621685213162"><span class="hs-identifier hs-var">old_hpt</span></a><span>
</span><a name="line-861"></a><span>
</span><a name="line-862"></a><span>    </span><span class="hs-comment">-- What we use to limit parallelism with.</span><span>
</span><a name="line-863"></a><span>    </span><a name="local-6989586621685213198"><a href="#local-6989586621685213198"><span class="hs-identifier">par_sem</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">newQSem</span><span> </span><a href="#local-6989586621685213160"><span class="hs-identifier hs-var">n_jobs</span></a><span>
</span><a name="line-864"></a><span>
</span><a name="line-865"></a><span>
</span><a name="line-866"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213199"><a href="#local-6989586621685213199"><span class="hs-identifier">updNumCapabilities</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-867"></a><span>            </span><a name="local-6989586621685213200"><a href="#local-6989586621685213200"><span class="hs-identifier">n_capabilities</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getNumCapabilities</span><span>
</span><a name="line-868"></a><span>            </span><a name="local-6989586621685213201"><a href="#local-6989586621685213201"><span class="hs-identifier">n_cpus</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getNumProcessors</span><span>
</span><a name="line-869"></a><span>            </span><span class="hs-comment">-- Setting number of capabilities more than</span><span>
</span><a name="line-870"></a><span>            </span><span class="hs-comment">-- CPU count usually leads to high userspace</span><span>
</span><a name="line-871"></a><span>            </span><span class="hs-comment">-- lock contention. Trac #9221</span><span>
</span><a name="line-872"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213202"><a href="#local-6989586621685213202"><span class="hs-identifier">n_caps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">min</span><span> </span><a href="#local-6989586621685213160"><span class="hs-identifier hs-var">n_jobs</span></a><span> </span><a href="#local-6989586621685213201"><span class="hs-identifier hs-var">n_cpus</span></a><span>
</span><a name="line-873"></a><span>            </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213200"><span class="hs-identifier hs-var">n_capabilities</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">setNumCapabilities</span><span> </span><a href="#local-6989586621685213202"><span class="hs-identifier hs-var">n_caps</span></a><span>
</span><a name="line-874"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685213200"><span class="hs-identifier hs-var">n_capabilities</span></a><span>
</span><a name="line-875"></a><span>    </span><span class="hs-comment">-- Reset the number of capabilities once the upsweep ends.</span><span>
</span><a name="line-876"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213203"><a href="#local-6989586621685213203"><span class="hs-identifier">resetNumCapabilities</span></a></a><span> </span><a name="local-6989586621685213204"><a href="#local-6989586621685213204"><span class="hs-identifier">orig_n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">setNumCapabilities</span><span> </span><a href="#local-6989586621685213204"><span class="hs-identifier hs-var">orig_n</span></a><span>
</span><a name="line-877"></a><span>
</span><a name="line-878"></a><span>    </span><span class="hs-identifier hs-var">gbracket</span><span> </span><a href="#local-6989586621685213199"><span class="hs-identifier hs-var">updNumCapabilities</span></a><span> </span><a href="#local-6989586621685213203"><span class="hs-identifier hs-var">resetNumCapabilities</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-879"></a><span>
</span><a name="line-880"></a><span>    </span><span class="hs-comment">-- Sync the global session with the latest HscEnv once the upsweep ends.</span><span>
</span><a name="line-881"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213205"><a href="#local-6989586621685213205"><span class="hs-identifier">finallySyncSession</span></a></a><span> </span><a name="local-6989586621685213206"><a href="#local-6989586621685213206"><span class="hs-identifier">io</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213206"><span class="hs-identifier hs-var">io</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">gfinally</span><span class="hs-special">`</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-882"></a><span>            </span><a name="local-6989586621685213207"><a href="#local-6989586621685213207"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">readMVar</span><span> </span><a href="#local-6989586621685213196"><span class="hs-identifier hs-var">hsc_env_var</span></a><span>
</span><a name="line-883"></a><span>            </span><span class="hs-identifier hs-var">setSession</span><span> </span><a href="#local-6989586621685213207"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-884"></a><span>
</span><a name="line-885"></a><span>    </span><a href="#local-6989586621685213205"><span class="hs-identifier hs-var">finallySyncSession</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-886"></a><span>
</span><a name="line-887"></a><span>    </span><span class="hs-comment">-- Build the compilation graph out of the list of SCCs. Module cycles are</span><span>
</span><a name="line-888"></a><span>    </span><span class="hs-comment">-- handled at the very end, after some useful work gets done. Note that</span><span>
</span><a name="line-889"></a><span>    </span><span class="hs-comment">-- this list is topologically sorted (by virtue of 'sccs' being sorted so).</span><span>
</span><a name="line-890"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621685213208"><a href="#local-6989586621685213208"><span class="hs-identifier">comp_graph</span></a></a><span class="hs-special">,</span><a name="local-6989586621685213209"><a href="#local-6989586621685213209"><span class="hs-identifier">cycle</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GhcMake.html#buildCompGraph"><span class="hs-identifier hs-var">buildCompGraph</span></a><span> </span><a href="#local-6989586621685213165"><span class="hs-identifier hs-var">sccs</span></a><span>
</span><a name="line-891"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213210"><a href="#local-6989586621685213210"><span class="hs-identifier">comp_graph_w_idx</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621685213208"><span class="hs-identifier hs-var">comp_graph</span></a><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><a name="line-892"></a><span>
</span><a name="line-893"></a><span>    </span><span class="hs-comment">-- The list of all loops in the compilation graph.</span><span>
</span><a name="line-894"></a><span>    </span><span class="hs-comment">-- NB: For convenience, the last module of each loop (aka the module that</span><span>
</span><a name="line-895"></a><span>    </span><span class="hs-comment">-- finishes the loop) is prepended to the beginning of the loop.</span><span>
</span><a name="line-896"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213211"><a href="#local-6989586621685213211"><span class="hs-identifier">graph</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fstOf3</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621685213208"><span class="hs-identifier hs-var">comp_graph</span></a><span class="hs-special">)</span><span>
</span><a name="line-897"></a><span>        </span><a name="local-6989586621685213212"><a href="#local-6989586621685213212"><span class="hs-identifier">boot_modules</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkModuleSet</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">ms_mod</span><span> </span><a href="#local-6989586621685213214"><span class="hs-identifier hs-var">ms</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621685213214"><a href="#local-6989586621685213214"><span class="hs-identifier">ms</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213211"><span class="hs-identifier hs-var">graph</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isBootSummary</span><span> </span><a href="#local-6989586621685213214"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">]</span><span>
</span><a name="line-898"></a><span>        </span><a name="local-6989586621685213213"><a href="#local-6989586621685213213"><span class="hs-identifier">comp_graph_loops</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213216"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621685213211"><span class="hs-identifier hs-var">graph</span></a><span> </span><a href="#local-6989586621685213212"><span class="hs-identifier hs-var">boot_modules</span></a><span>
</span><a name="line-899"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-900"></a><span>            </span><a name="local-6989586621685213215"><a href="#local-6989586621685213215"><span class="hs-identifier">remove</span></a></a><span> </span><a name="local-6989586621685213217"><a href="#local-6989586621685213217"><span class="hs-identifier">ms</span></a></a><span> </span><a name="local-6989586621685213218"><a href="#local-6989586621685213218"><span class="hs-identifier">bm</span></a></a><span>
</span><a name="line-901"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isBootSummary</span><span> </span><a href="#local-6989586621685213217"><span class="hs-identifier hs-var">ms</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">delModuleSet</span><span> </span><a href="#local-6989586621685213218"><span class="hs-identifier hs-var">bm</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ms_mod</span><span> </span><a href="#local-6989586621685213217"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">)</span><span>
</span><a name="line-902"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213218"><span class="hs-identifier hs-var">bm</span></a><span>
</span><a name="line-903"></a><span>            </span><a name="local-6989586621685213216"><a href="#local-6989586621685213216"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-904"></a><span>            </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621685213219"><a href="#local-6989586621685213219"><span class="hs-identifier">mg</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621685213220"><a href="#local-6989586621685213220"><span class="hs-identifier">ms</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621685213221"><a href="#local-6989586621685213221"><span class="hs-identifier">mss</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621685213222"><a href="#local-6989586621685213222"><span class="hs-identifier">boot_modules</span></a></a><span>
</span><a name="line-905"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213223"><a href="#local-6989586621685213223"><span class="hs-identifier">loop</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GhcMake.html#getModLoop"><span class="hs-identifier hs-var">getModLoop</span></a><span> </span><a href="#local-6989586621685213220"><span class="hs-identifier hs-var">ms</span></a><span> </span><a href="#local-6989586621685213219"><span class="hs-identifier hs-var">mg</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemModuleSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685213222"><span class="hs-identifier hs-var">boot_modules</span></a><span class="hs-special">)</span><span>
</span><a name="line-906"></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="GhcMake.html#mkBuildModule"><span class="hs-identifier hs-var">mkBuildModule</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213220"><span class="hs-identifier hs-var">ms</span></a><span class="hs-glyph">:</span><a href="#local-6989586621685213223"><span class="hs-identifier hs-var">loop</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621685213216"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621685213221"><span class="hs-identifier hs-var">mss</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213215"><span class="hs-identifier hs-var">remove</span></a><span> </span><a href="#local-6989586621685213220"><span class="hs-identifier hs-var">ms</span></a><span> </span><a href="#local-6989586621685213222"><span class="hs-identifier hs-var">boot_modules</span></a><span class="hs-special">)</span><span>
</span><a name="line-907"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-908"></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213216"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621685213221"><span class="hs-identifier hs-var">mss</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213215"><span class="hs-identifier hs-var">remove</span></a><span> </span><a href="#local-6989586621685213220"><span class="hs-identifier hs-var">ms</span></a><span> </span><a href="#local-6989586621685213222"><span class="hs-identifier hs-var">boot_modules</span></a><span class="hs-special">)</span><span>
</span><a name="line-909"></a><span>
</span><a name="line-910"></a><span>    </span><span class="hs-comment">-- Build a Map out of the compilation graph with which we can efficiently</span><span>
</span><a name="line-911"></a><span>    </span><span class="hs-comment">-- look up the result MVar associated with a particular home module.</span><span>
</span><a name="line-912"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">home_mod_map</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="GhcMake.html#BuildModule"><span class="hs-identifier hs-type">BuildModule</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MVar</span><span> </span><span class="hs-identifier hs-type">SuccessFlag</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-913"></a><span>        </span><a name="local-6989586621685213224"><a href="#local-6989586621685213224"><span class="hs-identifier">home_mod_map</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-914"></a><span>            </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="GhcMake.html#mkBuildModule"><span class="hs-identifier hs-var">mkBuildModule</span></a><span> </span><a href="#local-6989586621685213225"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213226"><span class="hs-identifier hs-var">mvar</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685213227"><span class="hs-identifier hs-var">idx</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-915"></a><span>                         </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621685213225"><a href="#local-6989586621685213225"><span class="hs-identifier">ms</span></a></a><span class="hs-special">,</span><a name="local-6989586621685213226"><a href="#local-6989586621685213226"><span class="hs-identifier">mvar</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">,</span><a name="local-6989586621685213227"><a href="#local-6989586621685213227"><span class="hs-identifier">idx</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213210"><span class="hs-identifier hs-var">comp_graph_w_idx</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-916"></a><span>
</span><a name="line-917"></a><span>
</span><a name="line-918"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GhcMake.html#label_self"><span class="hs-identifier hs-var">label_self</span></a><span> </span><span class="hs-string">&quot;main --make thread&quot;</span><span>
</span><a name="line-919"></a><span>    </span><span class="hs-comment">-- For each module in the module graph, spawn a worker thread that will</span><span>
</span><a name="line-920"></a><span>    </span><span class="hs-comment">-- compile this module.</span><span>
</span><a name="line-921"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685213228"><a href="#local-6989586621685213228"><span class="hs-identifier">spawnWorkers</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">forM</span><span> </span><a href="#local-6989586621685213210"><span class="hs-identifier hs-var">comp_graph_w_idx</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621685213230"><a href="#local-6989586621685213230"><span class="hs-identifier">mod</span></a></a><span class="hs-special">,</span><span class="hs-glyph">!</span><a name="local-6989586621685213231"><a href="#local-6989586621685213231"><span class="hs-identifier">mvar</span></a></a><span class="hs-special">,</span><span class="hs-glyph">!</span><a name="local-6989586621685213232"><a href="#local-6989586621685213232"><span class="hs-identifier">log_queue</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-glyph">!</span><a name="local-6989586621685213233"><a href="#local-6989586621685213233"><span class="hs-identifier">mod_idx</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-922"></a><span>            </span><span class="hs-identifier hs-var">forkIOWithUnmask</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685213234"><a href="#local-6989586621685213234"><span class="hs-identifier">unmask</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-923"></a><span>                </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GhcMake.html#label_self"><span class="hs-identifier hs-var">label_self</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unwords</span><span>
</span><a name="line-924"></a><span>                    </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;worker --make thread&quot;</span><span>
</span><a name="line-925"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;for module&quot;</span><span>
</span><a name="line-926"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">moduleNameString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ms_mod_name</span><span> </span><a href="#local-6989586621685213230"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-927"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;number&quot;</span><span>
</span><a name="line-928"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621685213233"><span class="hs-identifier hs-var">mod_idx</span></a><span>
</span><a name="line-929"></a><span>                    </span><span class="hs-special">]</span><span>
</span><a name="line-930"></a><span>                </span><span class="hs-comment">-- Replace the default log_action with one that writes each</span><span>
</span><a name="line-931"></a><span>                </span><span class="hs-comment">-- message to the module's log_queue. The main thread will</span><span>
</span><a name="line-932"></a><span>                </span><span class="hs-comment">-- deal with synchronously printing these messages.</span><span>
</span><a name="line-933"></a><span>                </span><span class="hs-comment">--</span><span>
</span><a name="line-934"></a><span>                </span><span class="hs-comment">-- Use a local filesToClean var so that we can clean up</span><span>
</span><a name="line-935"></a><span>                </span><span class="hs-comment">-- intermediate files in a timely fashion (as soon as</span><span>
</span><a name="line-936"></a><span>                </span><span class="hs-comment">-- compilation for that module is finished) without having to</span><span>
</span><a name="line-937"></a><span>                </span><span class="hs-comment">-- worry about accidentally deleting a simultaneous compile's</span><span>
</span><a name="line-938"></a><span>                </span><span class="hs-comment">-- important files.</span><span>
</span><a name="line-939"></a><span>                </span><a name="local-6989586621685213235"><a href="#local-6989586621685213235"><span class="hs-identifier">lcl_files_to_clean</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">emptyFilesToClean</span><span>
</span><a name="line-940"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213236"><a href="#local-6989586621685213236"><span class="hs-identifier">lcl_dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213195"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">log_action</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213167"><span class="hs-identifier hs-var">parLogAction</span></a><span> </span><a href="#local-6989586621685213232"><span class="hs-identifier hs-var">log_queue</span></a><span>
</span><a name="line-941"></a><span>                                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">filesToClean</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213235"><span class="hs-identifier hs-var">lcl_files_to_clean</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-942"></a><span>
</span><a name="line-943"></a><span>                </span><span class="hs-comment">-- Unmask asynchronous exceptions and perform the thread-local</span><span>
</span><a name="line-944"></a><span>                </span><span class="hs-comment">-- work to compile the module (see parUpsweep_one).</span><span>
</span><a name="line-945"></a><span>                </span><a name="local-6989586621685213237"><a href="#local-6989586621685213237"><span class="hs-identifier">m_res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">try</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621685213234"><span class="hs-identifier hs-var">unmask</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">prettyPrintGhcErrors</span><span> </span><a href="#local-6989586621685213236"><span class="hs-identifier hs-var">lcl_dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-946"></a><span>                        </span><a href="GhcMake.html#parUpsweep_one"><span class="hs-identifier hs-var">parUpsweep_one</span></a><span> </span><a href="#local-6989586621685213230"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621685213224"><span class="hs-identifier hs-var">home_mod_map</span></a><span> </span><a href="#local-6989586621685213213"><span class="hs-identifier hs-var">comp_graph_loops</span></a><span>
</span><a name="line-947"></a><span>                                       </span><a href="#local-6989586621685213236"><span class="hs-identifier hs-var">lcl_dflags</span></a><span> </span><a href="#local-6989586621685213161"><span class="hs-identifier hs-var">mHscMessage</span></a><span> </span><a href="#local-6989586621685213164"><span class="hs-identifier hs-var">cleanup</span></a><span>
</span><a name="line-948"></a><span>                                       </span><a href="#local-6989586621685213198"><span class="hs-identifier hs-var">par_sem</span></a><span> </span><a href="#local-6989586621685213196"><span class="hs-identifier hs-var">hsc_env_var</span></a><span> </span><a href="#local-6989586621685213197"><span class="hs-identifier hs-var">old_hpt_var</span></a><span>
</span><a name="line-949"></a><span>                                       </span><a href="#local-6989586621685213163"><span class="hs-identifier hs-var">stable_mods</span></a><span> </span><a href="#local-6989586621685213233"><span class="hs-identifier hs-var">mod_idx</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621685213165"><span class="hs-identifier hs-var">sccs</span></a><span class="hs-special">)</span><span>
</span><a name="line-950"></a><span>
</span><a name="line-951"></a><span>                </span><a name="local-6989586621685213240"><a href="#local-6989586621685213240"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685213237"><span class="hs-identifier hs-var">m_res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-952"></a><span>                    </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621685213238"><a href="#local-6989586621685213238"><span class="hs-identifier">flag</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685213238"><span class="hs-identifier hs-var">flag</span></a><span>
</span><a name="line-953"></a><span>                    </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621685213239"><a href="#local-6989586621685213239"><span class="hs-identifier">exc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-954"></a><span>                        </span><span class="hs-comment">-- Don't print ThreadKilled exceptions: they are used</span><span>
</span><a name="line-955"></a><span>                        </span><span class="hs-comment">-- to kill the worker thread in the event of a user</span><span>
</span><a name="line-956"></a><span>                        </span><span class="hs-comment">-- interrupt, and the user doesn't have to be informed</span><span>
</span><a name="line-957"></a><span>                        </span><span class="hs-comment">-- about that.</span><span>
</span><a name="line-958"></a><span>                        </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromException</span><span> </span><a href="#local-6989586621685213239"><span class="hs-identifier hs-var">exc</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">ThreadKilled</span><span class="hs-special">)</span><span>
</span><a name="line-959"></a><span>                             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">errorMsg</span><span> </span><a href="#local-6989586621685213236"><span class="hs-identifier hs-var">lcl_dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621685213239"><span class="hs-identifier hs-var">exc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-960"></a><span>                        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Failed</span><span>
</span><a name="line-961"></a><span>
</span><a name="line-962"></a><span>                </span><span class="hs-comment">-- Populate the result MVar.</span><span>
</span><a name="line-963"></a><span>                </span><span class="hs-identifier hs-var">putMVar</span><span> </span><a href="#local-6989586621685213231"><span class="hs-identifier hs-var">mvar</span></a><span> </span><a href="#local-6989586621685213240"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-964"></a><span>
</span><a name="line-965"></a><span>                </span><span class="hs-comment">-- Write the end marker to the message queue, telling the main</span><span>
</span><a name="line-966"></a><span>                </span><span class="hs-comment">-- thread that it can stop waiting for messages from this</span><span>
</span><a name="line-967"></a><span>                </span><span class="hs-comment">-- particular compile.</span><span>
</span><a name="line-968"></a><span>                </span><a href="#local-6989586621685213166"><span class="hs-identifier hs-var">writeLogQueue</span></a><span> </span><a href="#local-6989586621685213232"><span class="hs-identifier hs-var">log_queue</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-969"></a><span>
</span><a name="line-970"></a><span>                </span><span class="hs-comment">-- Add the remaining files that weren't cleaned up to the</span><span>
</span><a name="line-971"></a><span>                </span><span class="hs-comment">-- global filesToClean ref, for cleanup later.</span><span>
</span><a name="line-972"></a><span>                </span><span class="hs-identifier hs-var">FilesToClean</span><span>
</span><a name="line-973"></a><span>                  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ftcCurrentModule</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685213241"><a href="#local-6989586621685213241"><span class="hs-identifier">cm_files</span></a></a><span>
</span><a name="line-974"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ftcGhcSession</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685213242"><a href="#local-6989586621685213242"><span class="hs-identifier">gs_files</span></a></a><span>
</span><a name="line-975"></a><span>                  </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">filesToClean</span><span> </span><a href="#local-6989586621685213236"><span class="hs-identifier hs-var">lcl_dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-976"></a><span>                </span><span class="hs-identifier hs-var">addFilesToClean</span><span> </span><a href="#local-6989586621685213195"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">TFL_CurrentModule</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Set.toList</span><span> </span><a href="#local-6989586621685213241"><span class="hs-identifier hs-var">cm_files</span></a><span>
</span><a name="line-977"></a><span>                </span><span class="hs-identifier hs-var">addFilesToClean</span><span> </span><a href="#local-6989586621685213195"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">TFL_GhcSession</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Set.toList</span><span> </span><a href="#local-6989586621685213242"><span class="hs-identifier hs-var">gs_files</span></a><span>
</span><a name="line-978"></a><span>
</span><a name="line-979"></a><span>        </span><span class="hs-comment">-- Kill all the workers, masking interrupts (since killThread is</span><span>
</span><a name="line-980"></a><span>        </span><span class="hs-comment">-- interruptible). XXX: This is not ideal.</span><span>
</span><a name="line-981"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685213229"><a href="#local-6989586621685213229"><span class="hs-identifier">killWorkers</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">uninterruptibleMask_</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-identifier hs-var">killThread</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-982"></a><span>
</span><a name="line-983"></a><span>
</span><a name="line-984"></a><span>    </span><span class="hs-comment">-- Spawn the workers, making sure to kill them later. Collect the results</span><span>
</span><a name="line-985"></a><span>    </span><span class="hs-comment">-- of each compile.</span><span>
</span><a name="line-986"></a><span>    </span><a name="local-6989586621685213247"><a href="#local-6989586621685213247"><span class="hs-identifier">results</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">bracket</span><span> </span><a href="#local-6989586621685213228"><span class="hs-identifier hs-var">spawnWorkers</span></a><span> </span><a href="#local-6989586621685213229"><span class="hs-identifier hs-var">killWorkers</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-987"></a><span>        </span><span class="hs-comment">-- Loop over each module in the compilation graph in order, printing</span><span>
</span><a name="line-988"></a><span>        </span><span class="hs-comment">-- each message from its log_queue.</span><span>
</span><a name="line-989"></a><span>        </span><span class="hs-identifier hs-var">forM</span><span> </span><a href="#local-6989586621685213208"><span class="hs-identifier hs-var">comp_graph</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621685213243"><a href="#local-6989586621685213243"><span class="hs-identifier">mod</span></a></a><span class="hs-special">,</span><a name="local-6989586621685213244"><a href="#local-6989586621685213244"><span class="hs-identifier">mvar</span></a></a><span class="hs-special">,</span><a name="local-6989586621685213245"><a href="#local-6989586621685213245"><span class="hs-identifier">log_queue</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-990"></a><span>            </span><a href="#local-6989586621685213168"><span class="hs-identifier hs-var">printLogs</span></a><span> </span><a href="#local-6989586621685213195"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685213245"><span class="hs-identifier hs-var">log_queue</span></a><span>
</span><a name="line-991"></a><span>            </span><a name="local-6989586621685213246"><a href="#local-6989586621685213246"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readMVar</span><span> </span><a href="#local-6989586621685213244"><span class="hs-identifier hs-var">mvar</span></a><span>
</span><a name="line-992"></a><span>            </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">succeeded</span><span> </span><a href="#local-6989586621685213246"><span class="hs-identifier hs-var">result</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685213243"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-993"></a><span>
</span><a name="line-994"></a><span>
</span><a name="line-995"></a><span>    </span><span class="hs-comment">-- Collect and return the ModSummaries of all the successful compiles.</span><span>
</span><a name="line-996"></a><span>    </span><span class="hs-comment">-- NB: Reverse this list to maintain output parity with the sequential upsweep.</span><span>
</span><a name="line-997"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213248"><a href="#local-6989586621685213248"><span class="hs-identifier">ok_results</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">catMaybes</span><span> </span><a href="#local-6989586621685213247"><span class="hs-identifier hs-var">results</span></a><span class="hs-special">)</span><span>
</span><a name="line-998"></a><span>
</span><a name="line-999"></a><span>    </span><span class="hs-comment">-- Handle any cycle in the original compilation graph and return the result</span><span>
</span><a name="line-1000"></a><span>    </span><span class="hs-comment">-- of the upsweep.</span><span>
</span><a name="line-1001"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685213209"><span class="hs-identifier hs-var">cycle</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1002"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213249"><a href="#local-6989586621685213249"><span class="hs-identifier">mss</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1003"></a><span>            </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fatalErrorMsg</span><span> </span><a href="#local-6989586621685213195"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="GhcMake.html#cyclicModuleErr"><span class="hs-identifier hs-var">cyclicModuleErr</span></a><span> </span><a href="#local-6989586621685213249"><span class="hs-identifier hs-var">mss</span></a><span class="hs-special">)</span><span>
</span><a name="line-1004"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Failed</span><span class="hs-special">,</span><a href="#local-6989586621685213248"><span class="hs-identifier hs-var">ok_results</span></a><span class="hs-special">)</span><span>
</span><a name="line-1005"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1006"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213250"><a href="#local-6989586621685213250"><span class="hs-identifier">success_flag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">successIf</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><a href="#local-6989586621685213247"><span class="hs-identifier hs-var">results</span></a><span class="hs-special">)</span><span>
</span><a name="line-1007"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213250"><span class="hs-identifier hs-var">success_flag</span></a><span class="hs-special">,</span><a href="#local-6989586621685213248"><span class="hs-identifier hs-var">ok_results</span></a><span class="hs-special">)</span><span>
</span><a name="line-1008"></a><span>
</span><a name="line-1009"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1010"></a><span>    </span><span class="hs-identifier">writeLogQueue</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GhcMake.html#LogQueue"><span class="hs-identifier hs-type">LogQueue</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">WarnReason</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Severity</span><span class="hs-special">,</span><span class="hs-identifier hs-type">SrcSpan</span><span class="hs-special">,</span><span class="hs-identifier hs-type">PprStyle</span><span class="hs-special">,</span><span class="hs-identifier hs-type">MsgDoc</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1011"></a><span>    </span><a name="local-6989586621685213166"><a href="#local-6989586621685213166"><span class="hs-identifier">writeLogQueue</span></a></a><span> </span><span class="hs-special">(</span><a href="GhcMake.html#LogQueue"><span class="hs-identifier hs-var">LogQueue</span></a><span> </span><a name="local-6989586621685213169"><a href="#local-6989586621685213169"><span class="hs-identifier">ref</span></a></a><span> </span><a name="local-6989586621685213170"><a href="#local-6989586621685213170"><span class="hs-identifier">sem</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621685213171"><a href="#local-6989586621685213171"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1012"></a><span>        </span><span class="hs-identifier hs-var">atomicModifyIORef'</span><span> </span><a href="#local-6989586621685213169"><span class="hs-identifier hs-var">ref</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685213172"><a href="#local-6989586621685213172"><span class="hs-identifier">msgs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213171"><span class="hs-identifier hs-var">msg</span></a><span class="hs-glyph">:</span><a href="#local-6989586621685213172"><span class="hs-identifier hs-var">msgs</span></a><span class="hs-special">,</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1013"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tryPutMVar</span><span> </span><a href="#local-6989586621685213170"><span class="hs-identifier hs-var">sem</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1014"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1015"></a><span>
</span><a name="line-1016"></a><span>    </span><span class="hs-comment">-- The log_action callback that is used to synchronize messages from a</span><span>
</span><a name="line-1017"></a><span>    </span><span class="hs-comment">-- worker thread.</span><span>
</span><a name="line-1018"></a><span>    </span><span class="hs-identifier">parLogAction</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GhcMake.html#LogQueue"><span class="hs-identifier hs-type">LogQueue</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LogAction</span><span>
</span><a name="line-1019"></a><span>    </span><a name="local-6989586621685213167"><a href="#local-6989586621685213167"><span class="hs-identifier">parLogAction</span></a></a><span> </span><a name="local-6989586621685213173"><a href="#local-6989586621685213173"><span class="hs-identifier">log_queue</span></a></a><span> </span><a name="local-6989586621685213174"><a href="#local-6989586621685213174"><span class="hs-identifier">_dflags</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621685213175"><a href="#local-6989586621685213175"><span class="hs-identifier">reason</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621685213176"><a href="#local-6989586621685213176"><span class="hs-identifier">severity</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621685213177"><a href="#local-6989586621685213177"><span class="hs-identifier">srcSpan</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621685213178"><a href="#local-6989586621685213178"><span class="hs-identifier">style</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621685213179"><a href="#local-6989586621685213179"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1020"></a><span>        </span><a href="#local-6989586621685213166"><span class="hs-identifier hs-var">writeLogQueue</span></a><span> </span><a href="#local-6989586621685213173"><span class="hs-identifier hs-var">log_queue</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213175"><span class="hs-identifier hs-var">reason</span></a><span class="hs-special">,</span><a href="#local-6989586621685213176"><span class="hs-identifier hs-var">severity</span></a><span class="hs-special">,</span><a href="#local-6989586621685213177"><span class="hs-identifier hs-var">srcSpan</span></a><span class="hs-special">,</span><a href="#local-6989586621685213178"><span class="hs-identifier hs-var">style</span></a><span class="hs-special">,</span><a href="#local-6989586621685213179"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1021"></a><span>
</span><a name="line-1022"></a><span>    </span><span class="hs-comment">-- Print each message from the log_queue using the log_action from the</span><span>
</span><a name="line-1023"></a><span>    </span><span class="hs-comment">-- session's DynFlags.</span><span>
</span><a name="line-1024"></a><span>    </span><span class="hs-identifier">printLogs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GhcMake.html#LogQueue"><span class="hs-identifier hs-type">LogQueue</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1025"></a><span>    </span><a name="local-6989586621685213168"><a href="#local-6989586621685213168"><span class="hs-identifier">printLogs</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621685213180"><a href="#local-6989586621685213180"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-special">(</span><a href="GhcMake.html#LogQueue"><span class="hs-identifier hs-var">LogQueue</span></a><span> </span><a name="local-6989586621685213181"><a href="#local-6989586621685213181"><span class="hs-identifier">ref</span></a></a><span> </span><a name="local-6989586621685213182"><a href="#local-6989586621685213182"><span class="hs-identifier">sem</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213183"><span class="hs-identifier hs-var">read_msgs</span></a><span>
</span><a name="line-1026"></a><span>      </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621685213183"><a href="#local-6989586621685213183"><span class="hs-identifier">read_msgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1027"></a><span>                </span><span class="hs-identifier hs-var">takeMVar</span><span> </span><a href="#local-6989586621685213182"><span class="hs-identifier hs-var">sem</span></a><span>
</span><a name="line-1028"></a><span>                </span><a name="local-6989586621685213186"><a href="#local-6989586621685213186"><span class="hs-identifier">msgs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">atomicModifyIORef'</span><span> </span><a href="#local-6989586621685213181"><span class="hs-identifier hs-var">ref</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685213185"><a href="#local-6989586621685213185"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621685213185"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1029"></a><span>                </span><a href="#local-6989586621685213184"><span class="hs-identifier hs-var">print_loop</span></a><span> </span><a href="#local-6989586621685213186"><span class="hs-identifier hs-var">msgs</span></a><span>
</span><a name="line-1030"></a><span>
</span><a name="line-1031"></a><span>            </span><a name="local-6989586621685213184"><a href="#local-6989586621685213184"><span class="hs-identifier">print_loop</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213183"><span class="hs-identifier hs-var">read_msgs</span></a><span>
</span><a name="line-1032"></a><span>            </span><span class="hs-identifier">print_loop</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685213187"><a href="#local-6989586621685213187"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621685213188"><a href="#local-6989586621685213188"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685213187"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1033"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685213189"><a href="#local-6989586621685213189"><span class="hs-identifier">reason</span></a></a><span class="hs-special">,</span><a name="local-6989586621685213190"><a href="#local-6989586621685213190"><span class="hs-identifier">severity</span></a></a><span class="hs-special">,</span><a name="local-6989586621685213191"><a href="#local-6989586621685213191"><span class="hs-identifier">srcSpan</span></a></a><span class="hs-special">,</span><a name="local-6989586621685213192"><a href="#local-6989586621685213192"><span class="hs-identifier">style</span></a></a><span class="hs-special">,</span><a name="local-6989586621685213193"><a href="#local-6989586621685213193"><span class="hs-identifier">msg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1034"></a><span>                    </span><span class="hs-identifier hs-var">putLogMsg</span><span> </span><a href="#local-6989586621685213180"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685213189"><span class="hs-identifier hs-var">reason</span></a><span> </span><a href="#local-6989586621685213190"><span class="hs-identifier hs-var">severity</span></a><span> </span><a href="#local-6989586621685213191"><span class="hs-identifier hs-var">srcSpan</span></a><span> </span><a href="#local-6989586621685213192"><span class="hs-identifier hs-var">style</span></a><span> </span><a href="#local-6989586621685213193"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-1035"></a><span>                    </span><a href="#local-6989586621685213184"><span class="hs-identifier hs-var">print_loop</span></a><span> </span><a href="#local-6989586621685213188"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-1036"></a><span>                </span><span class="hs-comment">-- Exit the loop once we encounter the end marker.</span><span>
</span><a name="line-1037"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1038"></a><span>
</span><a name="line-1039"></a><span class="hs-comment">-- The interruptible subset of the worker threads' work.</span><span>
</span><a name="line-1040"></a><span class="hs-identifier">parUpsweep_one</span><span>
</span><a name="line-1041"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span>
</span><a name="line-1042"></a><span>    </span><span class="hs-comment">-- ^ The module we wish to compile</span><span>
</span><a name="line-1043"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="GhcMake.html#BuildModule"><span class="hs-identifier hs-type">BuildModule</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MVar</span><span> </span><span class="hs-identifier hs-type">SuccessFlag</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-1044"></a><span>    </span><span class="hs-comment">-- ^ The map of home modules and their result MVar</span><span>
</span><a name="line-1045"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><a href="GhcMake.html#BuildModule"><span class="hs-identifier hs-type">BuildModule</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-1046"></a><span>    </span><span class="hs-comment">-- ^ The list of all module loops within the compilation graph.</span><span>
</span><a name="line-1047"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-1048"></a><span>    </span><span class="hs-comment">-- ^ The thread-local DynFlags</span><span>
</span><a name="line-1049"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="HscMain.html#Messager"><span class="hs-identifier hs-type">Messager</span></a><span>
</span><a name="line-1050"></a><span>    </span><span class="hs-comment">-- ^ The messager</span><span>
</span><a name="line-1051"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1052"></a><span>    </span><span class="hs-comment">-- ^ The callback for cleaning up intermediate files</span><span>
</span><a name="line-1053"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">QSem</span><span>
</span><a name="line-1054"></a><span>    </span><span class="hs-comment">-- ^ The semaphore for limiting the number of simultaneous compiles</span><span>
</span><a name="line-1055"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MVar</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-1056"></a><span>    </span><span class="hs-comment">-- ^ The MVar that synchronizes updates to the global HscEnv</span><span>
</span><a name="line-1057"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IORef</span><span> </span><span class="hs-identifier hs-type">HomePackageTable</span><span>
</span><a name="line-1058"></a><span>    </span><span class="hs-comment">-- ^ The old HPT</span><span>
</span><a name="line-1059"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GhcMake.html#StableModules"><span class="hs-identifier hs-type">StableModules</span></a><span>
</span><a name="line-1060"></a><span>    </span><span class="hs-comment">-- ^ Sets of stable objects and BCOs</span><span>
</span><a name="line-1061"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1062"></a><span>    </span><span class="hs-comment">-- ^ The index of this module</span><span>
</span><a name="line-1063"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1064"></a><span>    </span><span class="hs-comment">-- ^ The total number of modules</span><span>
</span><a name="line-1065"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">SuccessFlag</span><span>
</span><a name="line-1066"></a><span>    </span><span class="hs-comment">-- ^ The result of this compile</span><span>
</span><a name="line-1067"></a><a name="parUpsweep_one"><a href="GhcMake.html#parUpsweep_one"><span class="hs-identifier">parUpsweep_one</span></a></a><span> </span><a name="local-6989586621685213251"><a href="#local-6989586621685213251"><span class="hs-identifier">mod</span></a></a><span> </span><a name="local-6989586621685213252"><a href="#local-6989586621685213252"><span class="hs-identifier">home_mod_map</span></a></a><span> </span><a name="local-6989586621685213253"><a href="#local-6989586621685213253"><span class="hs-identifier">comp_graph_loops</span></a></a><span> </span><a name="local-6989586621685213254"><a href="#local-6989586621685213254"><span class="hs-identifier">lcl_dflags</span></a></a><span> </span><a name="local-6989586621685213255"><a href="#local-6989586621685213255"><span class="hs-identifier">mHscMessage</span></a></a><span> </span><a name="local-6989586621685213256"><a href="#local-6989586621685213256"><span class="hs-identifier">cleanup</span></a></a><span> </span><a name="local-6989586621685213257"><a href="#local-6989586621685213257"><span class="hs-identifier">par_sem</span></a></a><span>
</span><a name="line-1068"></a><span>               </span><a name="local-6989586621685213258"><a href="#local-6989586621685213258"><span class="hs-identifier">hsc_env_var</span></a></a><span> </span><a name="local-6989586621685213259"><a href="#local-6989586621685213259"><span class="hs-identifier">old_hpt_var</span></a></a><span> </span><a name="local-6989586621685213260"><a href="#local-6989586621685213260"><span class="hs-identifier">stable_mods</span></a></a><span> </span><a name="local-6989586621685213261"><a href="#local-6989586621685213261"><span class="hs-identifier">mod_index</span></a></a><span> </span><a name="local-6989586621685213262"><a href="#local-6989586621685213262"><span class="hs-identifier">num_mods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1069"></a><span>
</span><a name="line-1070"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213267"><a href="#local-6989586621685213267"><span class="hs-identifier">this_build_mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GhcMake.html#mkBuildModule"><span class="hs-identifier hs-var">mkBuildModule</span></a><span> </span><a href="#local-6989586621685213251"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-1071"></a><span>
</span><a name="line-1072"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213268"><a href="#local-6989586621685213268"><span class="hs-identifier">home_imps</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GhcMake.html#ms_home_imps"><span class="hs-identifier hs-var">ms_home_imps</span></a><span> </span><a href="#local-6989586621685213251"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-1073"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213269"><a href="#local-6989586621685213269"><span class="hs-identifier">home_src_imps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GhcMake.html#ms_home_srcimps"><span class="hs-identifier hs-var">ms_home_srcimps</span></a><span> </span><a href="#local-6989586621685213251"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-1074"></a><span>
</span><a name="line-1075"></a><span>    </span><span class="hs-comment">-- All the textual imports of this module.</span><span>
</span><a name="line-1076"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213270"><a href="#local-6989586621685213270"><span class="hs-identifier">textual_deps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.fromList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapFst</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkModule</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">thisPackage</span><span> </span><a href="#local-6989586621685213254"><span class="hs-identifier hs-var">lcl_dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1077"></a><span>                            </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621685213268"><span class="hs-identifier hs-var">home_imps</span></a><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">repeat</span><span> </span><a href="GhcMake.html#NotBoot"><span class="hs-identifier hs-var">NotBoot</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1078"></a><span>                            </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621685213269"><span class="hs-identifier hs-var">home_src_imps</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">repeat</span><span> </span><a href="GhcMake.html#IsBoot"><span class="hs-identifier hs-var">IsBoot</span></a><span class="hs-special">)</span><span>
</span><a name="line-1079"></a><span>
</span><a name="line-1080"></a><span>    </span><span class="hs-comment">-- Dealing with module loops</span><span>
</span><a name="line-1081"></a><span>    </span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-1082"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1083"></a><span>    </span><span class="hs-comment">-- Not only do we have to deal with explicit textual dependencies, we also</span><span>
</span><a name="line-1084"></a><span>    </span><span class="hs-comment">-- have to deal with implicit dependencies introduced by import cycles that</span><span>
</span><a name="line-1085"></a><span>    </span><span class="hs-comment">-- are broken by an hs-boot file. We have to ensure that:</span><span>
</span><a name="line-1086"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1087"></a><span>    </span><span class="hs-comment">-- 1. A module that breaks a loop must depend on all the modules in the</span><span>
</span><a name="line-1088"></a><span>    </span><span class="hs-comment">--    loop (transitively or otherwise). This is normally always fulfilled</span><span>
</span><a name="line-1089"></a><span>    </span><span class="hs-comment">--    by the module's textual dependencies except in degenerate loops,</span><span>
</span><a name="line-1090"></a><span>    </span><span class="hs-comment">--    e.g.:</span><span>
</span><a name="line-1091"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1092"></a><span>    </span><span class="hs-comment">--    A.hs imports B.hs-boot</span><span>
</span><a name="line-1093"></a><span>    </span><span class="hs-comment">--    B.hs doesn't import A.hs</span><span>
</span><a name="line-1094"></a><span>    </span><span class="hs-comment">--    C.hs imports A.hs, B.hs</span><span>
</span><a name="line-1095"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1096"></a><span>    </span><span class="hs-comment">--    In this scenario, getModLoop will detect the module loop [A,B] but</span><span>
</span><a name="line-1097"></a><span>    </span><span class="hs-comment">--    the loop finisher B doesn't depend on A. So we have to explicitly add</span><span>
</span><a name="line-1098"></a><span>    </span><span class="hs-comment">--    A in as a dependency of B when we are compiling B.</span><span>
</span><a name="line-1099"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1100"></a><span>    </span><span class="hs-comment">-- 2. A module that depends on a module in an external loop can't proceed</span><span>
</span><a name="line-1101"></a><span>    </span><span class="hs-comment">--    until the entire loop is re-typechecked.</span><span>
</span><a name="line-1102"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1103"></a><span>    </span><span class="hs-comment">-- These two invariants have to be maintained to correctly build a</span><span>
</span><a name="line-1104"></a><span>    </span><span class="hs-comment">-- compilation graph with one or more loops.</span><span>
</span><a name="line-1105"></a><span>
</span><a name="line-1106"></a><span>
</span><a name="line-1107"></a><span>    </span><span class="hs-comment">-- The loop that this module will finish. After this module successfully</span><span>
</span><a name="line-1108"></a><span>    </span><span class="hs-comment">-- compiles, this loop is going to get re-typechecked.</span><span>
</span><a name="line-1109"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213271"><a href="#local-6989586621685213271"><span class="hs-identifier">finish_loop</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">listToMaybe</span><span>
</span><a name="line-1110"></a><span>            </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">tail</span><span> </span><a href="#local-6989586621685213272"><span class="hs-identifier hs-var">loop</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621685213272"><a href="#local-6989586621685213272"><span class="hs-identifier">loop</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213253"><span class="hs-identifier hs-var">comp_graph_loops</span></a><span>
</span><a name="line-1111"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621685213272"><span class="hs-identifier hs-var">loop</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621685213267"><span class="hs-identifier hs-var">this_build_mod</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1112"></a><span>
</span><a name="line-1113"></a><span>    </span><span class="hs-comment">-- If this module finishes a loop then it must depend on all the other</span><span>
</span><a name="line-1114"></a><span>    </span><span class="hs-comment">-- modules in that loop because the entire module loop is going to be</span><span>
</span><a name="line-1115"></a><span>    </span><span class="hs-comment">-- re-typechecked once this module gets compiled. These extra dependencies</span><span>
</span><a name="line-1116"></a><span>    </span><span class="hs-comment">-- are this module's &quot;internal&quot; loop dependencies, because this module is</span><span>
</span><a name="line-1117"></a><span>    </span><span class="hs-comment">-- inside the loop in question.</span><span>
</span><a name="line-1118"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213273"><a href="#local-6989586621685213273"><span class="hs-identifier">int_loop_deps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.fromList</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1119"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685213271"><span class="hs-identifier hs-var">finish_loop</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1120"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1121"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213274"><a href="#local-6989586621685213274"><span class="hs-identifier">loop</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621685213267"><span class="hs-identifier hs-var">this_build_mod</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213274"><span class="hs-identifier hs-var">loop</span></a><span>
</span><a name="line-1122"></a><span>
</span><a name="line-1123"></a><span>    </span><span class="hs-comment">-- If this module depends on a module within a loop then it must wait for</span><span>
</span><a name="line-1124"></a><span>    </span><span class="hs-comment">-- that loop to get re-typechecked, i.e. it must wait on the module that</span><span>
</span><a name="line-1125"></a><span>    </span><span class="hs-comment">-- finishes that loop. These extra dependencies are this module's</span><span>
</span><a name="line-1126"></a><span>    </span><span class="hs-comment">-- &quot;external&quot; loop dependencies, because this module is outside of the</span><span>
</span><a name="line-1127"></a><span>    </span><span class="hs-comment">-- loop(s) in question.</span><span>
</span><a name="line-1128"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213275"><a href="#local-6989586621685213275"><span class="hs-identifier">ext_loop_deps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.fromList</span><span>
</span><a name="line-1129"></a><span>            </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621685213276"><span class="hs-identifier hs-var">loop</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621685213276"><a href="#local-6989586621685213276"><span class="hs-identifier">loop</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213253"><span class="hs-identifier hs-var">comp_graph_loops</span></a><span>
</span><a name="line-1130"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">Set.member</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685213270"><span class="hs-identifier hs-var">textual_deps</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213276"><span class="hs-identifier hs-var">loop</span></a><span>
</span><a name="line-1131"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685213267"><span class="hs-identifier hs-var">this_build_mod</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">notElem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685213276"><span class="hs-identifier hs-var">loop</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1132"></a><span>
</span><a name="line-1133"></a><span>
</span><a name="line-1134"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213277"><a href="#local-6989586621685213277"><span class="hs-identifier">all_deps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl1</span><span> </span><span class="hs-identifier hs-var">Set.union</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621685213270"><span class="hs-identifier hs-var">textual_deps</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685213273"><span class="hs-identifier hs-var">int_loop_deps</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685213275"><span class="hs-identifier hs-var">ext_loop_deps</span></a><span class="hs-special">]</span><span>
</span><a name="line-1135"></a><span>
</span><a name="line-1136"></a><span>    </span><span class="hs-comment">-- All of the module's home-module dependencies.</span><span>
</span><a name="line-1137"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213278"><a href="#local-6989586621685213278"><span class="hs-identifier">home_deps_with_idx</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1138"></a><span>            </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621685213280"><span class="hs-identifier hs-var">home_dep</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621685213279"><a href="#local-6989586621685213279"><span class="hs-identifier">dep</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Set.toList</span><span> </span><a href="#local-6989586621685213277"><span class="hs-identifier hs-var">all_deps</span></a><span>
</span><a name="line-1139"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213280"><a href="#local-6989586621685213280"><span class="hs-identifier">home_dep</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621685213279"><span class="hs-identifier hs-var">dep</span></a><span> </span><a href="#local-6989586621685213252"><span class="hs-identifier hs-var">home_mod_map</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1140"></a><span>
</span><a name="line-1141"></a><span>    </span><span class="hs-comment">-- Sort the list of dependencies in reverse-topological order. This way, by</span><span>
</span><a name="line-1142"></a><span>    </span><span class="hs-comment">-- the time we get woken up by the result of an earlier dependency,</span><span>
</span><a name="line-1143"></a><span>    </span><span class="hs-comment">-- subsequent dependencies are more likely to have finished. This step</span><span>
</span><a name="line-1144"></a><span>    </span><span class="hs-comment">-- effectively reduces the number of MVars that each thread blocks on.</span><span>
</span><a name="line-1145"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213281"><a href="#local-6989586621685213281"><span class="hs-identifier">home_deps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">comparing</span><span> </span><span class="hs-identifier hs-var">snd</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213278"><span class="hs-identifier hs-var">home_deps_with_idx</span></a><span>
</span><a name="line-1146"></a><span>
</span><a name="line-1147"></a><span>    </span><span class="hs-comment">-- Wait for the all the module's dependencies to finish building.</span><span>
</span><a name="line-1148"></a><span>    </span><a name="local-6989586621685213282"><a href="#local-6989586621685213282"><span class="hs-identifier">deps_ok</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">allM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">succeeded</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">readMVar</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213281"><span class="hs-identifier hs-var">home_deps</span></a><span>
</span><a name="line-1149"></a><span>
</span><a name="line-1150"></a><span>    </span><span class="hs-comment">-- We can't build this module if any of its dependencies failed to build.</span><span>
</span><a name="line-1151"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621685213282"><span class="hs-identifier hs-var">deps_ok</span></a><span>
</span><a name="line-1152"></a><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Failed</span><span>
</span><a name="line-1153"></a><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1154"></a><span>        </span><span class="hs-comment">-- Any hsc_env at this point is OK to use since we only really require</span><span>
</span><a name="line-1155"></a><span>        </span><span class="hs-comment">-- that the HPT contains the HMIs of our dependencies.</span><span>
</span><a name="line-1156"></a><span>        </span><a name="local-6989586621685213283"><a href="#local-6989586621685213283"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readMVar</span><span> </span><a href="#local-6989586621685213258"><span class="hs-identifier hs-var">hsc_env_var</span></a><span>
</span><a name="line-1157"></a><span>        </span><a name="local-6989586621685213284"><a href="#local-6989586621685213284"><span class="hs-identifier">old_hpt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="#local-6989586621685213259"><span class="hs-identifier hs-var">old_hpt_var</span></a><span>
</span><a name="line-1158"></a><span>
</span><a name="line-1159"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213285"><a href="#local-6989586621685213285"><span class="hs-identifier">logger</span></a></a><span> </span><a name="local-6989586621685213286"><a href="#local-6989586621685213286"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">printBagOfErrors</span><span> </span><a href="#local-6989586621685213254"><span class="hs-identifier hs-var">lcl_dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">srcErrorMessages</span><span> </span><a href="#local-6989586621685213286"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-1160"></a><span>
</span><a name="line-1161"></a><span>        </span><span class="hs-comment">-- Limit the number of parallel compiles.</span><span>
</span><a name="line-1162"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213287"><a href="#local-6989586621685213287"><span class="hs-identifier">withSem</span></a></a><span> </span><a name="local-6989586621685213288"><a href="#local-6989586621685213288"><span class="hs-identifier">sem</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bracket_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">waitQSem</span><span> </span><a href="#local-6989586621685213288"><span class="hs-identifier hs-var">sem</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">signalQSem</span><span> </span><a href="#local-6989586621685213288"><span class="hs-identifier hs-var">sem</span></a><span class="hs-special">)</span><span>
</span><a name="line-1163"></a><span>        </span><a name="local-6989586621685213297"><a href="#local-6989586621685213297"><span class="hs-identifier">mb_mod_info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213287"><span class="hs-identifier hs-var">withSem</span></a><span> </span><a href="#local-6989586621685213257"><span class="hs-identifier hs-var">par_sem</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1164"></a><span>            </span><span class="hs-identifier hs-var">handleSourceError</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621685213289"><a href="#local-6989586621685213289"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="#local-6989586621685213285"><span class="hs-identifier hs-var">logger</span></a><span> </span><a href="#local-6989586621685213289"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1165"></a><span>                </span><span class="hs-comment">-- Have the ModSummary and HscEnv point to our local log_action</span><span>
</span><a name="line-1166"></a><span>                </span><span class="hs-comment">-- and filesToClean var.</span><span>
</span><a name="line-1167"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213290"><a href="#local-6989586621685213290"><span class="hs-identifier">lcl_mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213263"><span class="hs-identifier hs-var">localize_mod</span></a><span> </span><a href="#local-6989586621685213251"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-1168"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213291"><a href="#local-6989586621685213291"><span class="hs-identifier">lcl_hsc_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213264"><span class="hs-identifier hs-var">localize_hsc_env</span></a><span> </span><a href="#local-6989586621685213283"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1169"></a><span>
</span><a name="line-1170"></a><span>                </span><span class="hs-comment">-- Re-typecheck the loop</span><span>
</span><a name="line-1171"></a><span>                </span><span class="hs-comment">-- This is necessary to make sure the knot is tied when</span><span>
</span><a name="line-1172"></a><span>                </span><span class="hs-comment">-- we close a recursive module loop, see bug #12035.</span><span>
</span><a name="line-1173"></a><span>                </span><a name="local-6989586621685213292"><a href="#local-6989586621685213292"><span class="hs-identifier">type_env_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">emptyNameEnv</span><span>
</span><a name="line-1174"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213293"><a href="#local-6989586621685213293"><span class="hs-identifier">lcl_hsc_env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213291"><span class="hs-identifier hs-var">lcl_hsc_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_type_env_var</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1175"></a><span>                                    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ms_mod</span><span> </span><a href="#local-6989586621685213290"><span class="hs-identifier hs-var">lcl_mod</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685213292"><span class="hs-identifier hs-var">type_env_var</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1176"></a><span>                </span><a name="local-6989586621685213295"><a href="#local-6989586621685213295"><span class="hs-identifier">lcl_hsc_env''</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685213271"><span class="hs-identifier hs-var">finish_loop</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1177"></a><span>                    </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685213293"><span class="hs-identifier hs-var">lcl_hsc_env'</span></a><span>
</span><a name="line-1178"></a><span>                    </span><span class="hs-comment">-- In the non-parallel case, the retypecheck prior to</span><span>
</span><a name="line-1179"></a><span>                    </span><span class="hs-comment">-- typechecking the loop closer includes all modules</span><span>
</span><a name="line-1180"></a><span>                    </span><span class="hs-comment">-- EXCEPT the loop closer.  However, our precomputed</span><span>
</span><a name="line-1181"></a><span>                    </span><span class="hs-comment">-- SCCs include the loop closer, so we have to filter</span><span>
</span><a name="line-1182"></a><span>                    </span><span class="hs-comment">-- it out.</span><span>
</span><a name="line-1183"></a><span>                    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213294"><a href="#local-6989586621685213294"><span class="hs-identifier">loop</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GhcMake.html#typecheckLoop"><span class="hs-identifier hs-var">typecheckLoop</span></a><span> </span><a href="#local-6989586621685213254"><span class="hs-identifier hs-var">lcl_dflags</span></a><span> </span><a href="#local-6989586621685213293"><span class="hs-identifier hs-var">lcl_hsc_env'</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1184"></a><span>                                 </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier">moduleName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621685213267"><span class="hs-identifier hs-var">this_build_mod</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1185"></a><span>                                 </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213294"><span class="hs-identifier hs-var">loop</span></a><span>
</span><a name="line-1186"></a><span>
</span><a name="line-1187"></a><span>                </span><span class="hs-comment">-- Compile the module.</span><span>
</span><a name="line-1188"></a><span>                </span><a name="local-6989586621685213296"><a href="#local-6989586621685213296"><span class="hs-identifier">mod_info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GhcMake.html#upsweep_mod"><span class="hs-identifier hs-var">upsweep_mod</span></a><span> </span><a href="#local-6989586621685213295"><span class="hs-identifier hs-var">lcl_hsc_env''</span></a><span> </span><a href="#local-6989586621685213255"><span class="hs-identifier hs-var">mHscMessage</span></a><span> </span><a href="#local-6989586621685213284"><span class="hs-identifier hs-var">old_hpt</span></a><span> </span><a href="#local-6989586621685213260"><span class="hs-identifier hs-var">stable_mods</span></a><span>
</span><a name="line-1189"></a><span>                                        </span><a href="#local-6989586621685213290"><span class="hs-identifier hs-var">lcl_mod</span></a><span> </span><a href="#local-6989586621685213261"><span class="hs-identifier hs-var">mod_index</span></a><span> </span><a href="#local-6989586621685213262"><span class="hs-identifier hs-var">num_mods</span></a><span>
</span><a name="line-1190"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685213296"><span class="hs-identifier hs-var">mod_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-1191"></a><span>
</span><a name="line-1192"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685213297"><span class="hs-identifier hs-var">mb_mod_info</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1193"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Failed</span><span>
</span><a name="line-1194"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213298"><a href="#local-6989586621685213298"><span class="hs-identifier">mod_info</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1195"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213299"><a href="#local-6989586621685213299"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ms_mod_name</span><span> </span><a href="#local-6989586621685213251"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-1196"></a><span>
</span><a name="line-1197"></a><span>                </span><span class="hs-comment">-- Prune the old HPT unless this is an hs-boot module.</span><span>
</span><a name="line-1198"></a><span>                </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isBootSummary</span><span> </span><a href="#local-6989586621685213251"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1199"></a><span>                    </span><span class="hs-identifier hs-var">atomicModifyIORef'</span><span> </span><a href="#local-6989586621685213259"><span class="hs-identifier hs-var">old_hpt_var</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685213300"><a href="#local-6989586621685213300"><span class="hs-identifier">old_hpt</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1200"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">delFromHpt</span><span> </span><a href="#local-6989586621685213300"><span class="hs-identifier hs-var">old_hpt</span></a><span> </span><a href="#local-6989586621685213299"><span class="hs-identifier hs-var">this_mod</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1201"></a><span>
</span><a name="line-1202"></a><span>                </span><span class="hs-comment">-- Update and fetch the global HscEnv.</span><span>
</span><a name="line-1203"></a><span>                </span><a name="local-6989586621685213305"><a href="#local-6989586621685213305"><span class="hs-identifier">lcl_hsc_env'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">modifyMVar</span><span> </span><a href="#local-6989586621685213258"><span class="hs-identifier hs-var">hsc_env_var</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685213301"><a href="#local-6989586621685213301"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1204"></a><span>                    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213302"><a href="#local-6989586621685213302"><span class="hs-identifier">hsc_env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213301"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1205"></a><span>                                     </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_HPT</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addToHpt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_HPT</span><span> </span><a href="#local-6989586621685213301"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1206"></a><span>                                                           </span><a href="#local-6989586621685213299"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621685213298"><span class="hs-identifier hs-var">mod_info</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1207"></a><span>                    </span><span class="hs-comment">-- We've finished typechecking the module, now we must</span><span>
</span><a name="line-1208"></a><span>                    </span><span class="hs-comment">-- retypecheck the loop AGAIN to ensure unfoldings are</span><span>
</span><a name="line-1209"></a><span>                    </span><span class="hs-comment">-- updated.  This time, however, we include the loop</span><span>
</span><a name="line-1210"></a><span>                    </span><span class="hs-comment">-- closer!</span><span>
</span><a name="line-1211"></a><span>                    </span><a name="local-6989586621685213304"><a href="#local-6989586621685213304"><span class="hs-identifier">hsc_env''</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685213271"><span class="hs-identifier hs-var">finish_loop</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1212"></a><span>                        </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685213302"><span class="hs-identifier hs-var">hsc_env'</span></a><span>
</span><a name="line-1213"></a><span>                        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213303"><a href="#local-6989586621685213303"><span class="hs-identifier">loop</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GhcMake.html#typecheckLoop"><span class="hs-identifier hs-var">typecheckLoop</span></a><span> </span><a href="#local-6989586621685213254"><span class="hs-identifier hs-var">lcl_dflags</span></a><span> </span><a href="#local-6989586621685213302"><span class="hs-identifier hs-var">hsc_env'</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1214"></a><span>                                     </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213303"><span class="hs-identifier hs-var">loop</span></a><span>
</span><a name="line-1215"></a><span>                    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213304"><span class="hs-identifier hs-var">hsc_env''</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685213264"><span class="hs-identifier hs-var">localize_hsc_env</span></a><span> </span><a href="#local-6989586621685213304"><span class="hs-identifier hs-var">hsc_env''</span></a><span class="hs-special">)</span><span>
</span><a name="line-1216"></a><span>
</span><a name="line-1217"></a><span>                </span><span class="hs-comment">-- Clean up any intermediate files.</span><span>
</span><a name="line-1218"></a><span>                </span><a href="#local-6989586621685213256"><span class="hs-identifier hs-var">cleanup</span></a><span> </span><a href="#local-6989586621685213305"><span class="hs-identifier hs-var">lcl_hsc_env'</span></a><span>
</span><a name="line-1219"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Succeeded</span><span>
</span><a name="line-1220"></a><span>
</span><a name="line-1221"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1222"></a><span>    </span><a name="local-6989586621685213263"><a href="#local-6989586621685213263"><span class="hs-identifier">localize_mod</span></a></a><span> </span><a name="local-6989586621685213265"><a href="#local-6989586621685213265"><span class="hs-identifier">mod</span></a></a><span>
</span><a name="line-1223"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213265"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ms_hspp_opts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ms_hspp_opts</span><span> </span><a href="#local-6989586621685213265"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-1224"></a><span>                 </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">log_action</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">log_action</span><span> </span><a href="#local-6989586621685213254"><span class="hs-identifier hs-var">lcl_dflags</span></a><span>
</span><a name="line-1225"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">filesToClean</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">filesToClean</span><span> </span><a href="#local-6989586621685213254"><span class="hs-identifier hs-var">lcl_dflags</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1226"></a><span>
</span><a name="line-1227"></a><span>    </span><a name="local-6989586621685213264"><a href="#local-6989586621685213264"><span class="hs-identifier">localize_hsc_env</span></a></a><span> </span><a name="local-6989586621685213266"><a href="#local-6989586621685213266"><span class="hs-identifier">hsc_env</span></a></a><span>
</span><a name="line-1228"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213266"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685213266"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1229"></a><span>                     </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">log_action</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">log_action</span><span> </span><a href="#local-6989586621685213254"><span class="hs-identifier hs-var">lcl_dflags</span></a><span>
</span><a name="line-1230"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">filesToClean</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">filesToClean</span><span> </span><a href="#local-6989586621685213254"><span class="hs-identifier hs-var">lcl_dflags</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1231"></a><span>
</span><a name="line-1232"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-1233"></a><span class="hs-comment">--</span><span>
</span><a name="line-1234"></a><span class="hs-comment">-- | The upsweep</span><span>
</span><a name="line-1235"></a><span class="hs-comment">--</span><span>
</span><a name="line-1236"></a><span class="hs-comment">-- This is where we compile each module in the module graph, in a pass</span><span>
</span><a name="line-1237"></a><span class="hs-comment">-- from the bottom to the top of the graph.</span><span>
</span><a name="line-1238"></a><span class="hs-comment">--</span><span>
</span><a name="line-1239"></a><span class="hs-comment">-- There better had not be any cyclic groups here -- we check for them.</span><span>
</span><a name="line-1240"></a><span class="hs-identifier">upsweep</span><span>
</span><a name="line-1241"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685212971"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1242"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="HscMain.html#Messager"><span class="hs-identifier hs-type">Messager</span></a><span>
</span><a name="line-1243"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HomePackageTable</span><span>            </span><span class="hs-comment">-- ^ HPT from last time round (pruned)</span><span>
</span><a name="line-1244"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GhcMake.html#StableModules"><span class="hs-identifier hs-type">StableModules</span></a><span>               </span><span class="hs-comment">-- ^ stable modules (see checkStability)</span><span>
</span><a name="line-1245"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>           </span><span class="hs-comment">-- ^ How to clean up unwanted tmp files</span><span>
</span><a name="line-1246"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SCC</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span>            </span><span class="hs-comment">-- ^ Mods to do (the worklist)</span><span>
</span><a name="line-1247"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685212971"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SuccessFlag</span><span class="hs-special">,</span><span>
</span><a name="line-1248"></a><span>          </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1249"></a><span>       </span><span class="hs-comment">-- ^ Returns:</span><span>
</span><a name="line-1250"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-1251"></a><span>       </span><span class="hs-comment">--  1. A flag whether the complete upsweep was successful.</span><span>
</span><a name="line-1252"></a><span>       </span><span class="hs-comment">--  2. The 'HscEnv' in the monad has an updated HPT</span><span>
</span><a name="line-1253"></a><span>       </span><span class="hs-comment">--  3. A list of modules which succeeded loading.</span><span>
</span><a name="line-1254"></a><span>
</span><a name="line-1255"></a><a name="upsweep"><a href="GhcMake.html#upsweep"><span class="hs-identifier">upsweep</span></a></a><span> </span><a name="local-6989586621685213306"><a href="#local-6989586621685213306"><span class="hs-identifier">mHscMessage</span></a></a><span> </span><a name="local-6989586621685213307"><a href="#local-6989586621685213307"><span class="hs-identifier">old_hpt</span></a></a><span> </span><a name="local-6989586621685213308"><a href="#local-6989586621685213308"><span class="hs-identifier">stable_mods</span></a></a><span> </span><a name="local-6989586621685213309"><a href="#local-6989586621685213309"><span class="hs-identifier">cleanup</span></a></a><span> </span><a name="local-6989586621685213310"><a href="#local-6989586621685213310"><span class="hs-identifier">sccs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1256"></a><span>   </span><a name="local-6989586621685213354"><a href="#local-6989586621685213354"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getSessionDynFlags</span><span>
</span><a name="line-1257"></a><span>   </span><span class="hs-special">(</span><a name="local-6989586621685213355"><a href="#local-6989586621685213355"><span class="hs-identifier">res</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685213356"><a href="#local-6989586621685213356"><span class="hs-identifier">done</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213312"><span class="hs-identifier hs-var">upsweep'</span></a><span> </span><a href="#local-6989586621685213307"><span class="hs-identifier hs-var">old_hpt</span></a><span> </span><span class="hs-identifier hs-var">emptyMG</span><span> </span><a href="#local-6989586621685213310"><span class="hs-identifier hs-var">sccs</span></a><span> </span><span class="hs-number">1</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621685213310"><span class="hs-identifier hs-var">sccs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1258"></a><span>                           </span><span class="hs-special">(</span><a href="GhcMake.html#unitIdsToCheck"><span class="hs-identifier hs-var">unitIdsToCheck</span></a><span> </span><a href="#local-6989586621685213354"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213311"><span class="hs-identifier hs-var">done_holes</span></a><span>
</span><a name="line-1259"></a><span>   </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213355"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mgModSummaries</span><span> </span><a href="#local-6989586621685213356"><span class="hs-identifier hs-var">done</span></a><span class="hs-special">)</span><span>
</span><a name="line-1260"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1261"></a><span>  </span><a name="local-6989586621685213311"><a href="#local-6989586621685213311"><span class="hs-identifier">done_holes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyUniqSet</span><span>
</span><a name="line-1262"></a><span>
</span><a name="line-1263"></a><span>  </span><span class="hs-identifier">upsweep'</span><span>
</span><a name="line-1264"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685213313"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-1265"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">HomePackageTable</span><span>
</span><a name="line-1266"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModuleGraph</span><span>
</span><a name="line-1267"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SCC</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span>
</span><a name="line-1268"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1269"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1270"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">UnitId</span><span class="hs-special">]</span><span>
</span><a name="line-1271"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSet</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span>
</span><a name="line-1272"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685213313"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SuccessFlag</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ModuleGraph</span><span class="hs-special">)</span><span>
</span><a name="line-1273"></a><span>  </span><a name="local-6989586621685213312"><a href="#local-6989586621685213312"><span class="hs-identifier">upsweep'</span></a></a><span> </span><a name="local-6989586621685213314"><a href="#local-6989586621685213314"><span class="hs-identifier">_old_hpt</span></a></a><span> </span><a name="local-6989586621685213315"><a href="#local-6989586621685213315"><span class="hs-identifier">done</span></a></a><span>
</span><a name="line-1274"></a><span>     </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621685213316"><a href="#local-6989586621685213316"><span class="hs-identifier">uids_to_check</span></a></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-1275"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621685213317"><a href="#local-6989586621685213317"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getSession</span><span>
</span><a name="line-1276"></a><span>        </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">runHsc</span><span> </span><a href="#local-6989586621685213317"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="HscMain.html#ioMsgMaybe"><span class="hs-identifier hs-var">ioMsgMaybe</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="TcBackpack.html#tcRnCheckUnitId"><span class="hs-identifier hs-var">tcRnCheckUnitId</span></a><span> </span><a href="#local-6989586621685213317"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213316"><span class="hs-identifier hs-var">uids_to_check</span></a><span>
</span><a name="line-1277"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Succeeded</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685213315"><span class="hs-identifier hs-var">done</span></a><span class="hs-special">)</span><span>
</span><a name="line-1278"></a><span>
</span><a name="line-1279"></a><span>  </span><span class="hs-identifier">upsweep'</span><span> </span><a name="local-6989586621685213318"><a href="#local-6989586621685213318"><span class="hs-identifier">_old_hpt</span></a></a><span> </span><a name="local-6989586621685213319"><a href="#local-6989586621685213319"><span class="hs-identifier">done</span></a></a><span>
</span><a name="line-1280"></a><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CyclicSCC</span><span> </span><a name="local-6989586621685213320"><a href="#local-6989586621685213320"><span class="hs-identifier">ms</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-1281"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621685213321"><a href="#local-6989586621685213321"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getSessionDynFlags</span><span>
</span><a name="line-1282"></a><span>        </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fatalErrorMsg</span><span> </span><a href="#local-6989586621685213321"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="GhcMake.html#cyclicModuleErr"><span class="hs-identifier hs-var">cyclicModuleErr</span></a><span> </span><a href="#local-6989586621685213320"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">)</span><span>
</span><a name="line-1283"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Failed</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685213319"><span class="hs-identifier hs-var">done</span></a><span class="hs-special">)</span><span>
</span><a name="line-1284"></a><span>
</span><a name="line-1285"></a><span>  </span><span class="hs-identifier">upsweep'</span><span> </span><a name="local-6989586621685213322"><a href="#local-6989586621685213322"><span class="hs-identifier">old_hpt</span></a></a><span> </span><a name="local-6989586621685213323"><a href="#local-6989586621685213323"><span class="hs-identifier">done</span></a></a><span>
</span><a name="line-1286"></a><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AcyclicSCC</span><span> </span><a name="local-6989586621685213324"><a href="#local-6989586621685213324"><span class="hs-identifier">mod</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621685213325"><a href="#local-6989586621685213325"><span class="hs-identifier">mods</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621685213326"><a href="#local-6989586621685213326"><span class="hs-identifier">mod_index</span></a></a><span> </span><a name="local-6989586621685213327"><a href="#local-6989586621685213327"><span class="hs-identifier">nmods</span></a></a><span> </span><a name="local-6989586621685213328"><a href="#local-6989586621685213328"><span class="hs-identifier">uids_to_check</span></a></a><span> </span><a name="local-6989586621685213329"><a href="#local-6989586621685213329"><span class="hs-identifier">done_holes</span></a></a><span>
</span><a name="line-1287"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- putStrLn (&quot;UPSWEEP_MOD: hpt = &quot; ++</span><span>
</span><a name="line-1288"></a><span>        </span><span class="hs-comment">--           show (map (moduleUserString.moduleName.mi_module.hm_iface)</span><span>
</span><a name="line-1289"></a><span>        </span><span class="hs-comment">--                     (moduleEnvElts (hsc_HPT hsc_env)))</span><span>
</span><a name="line-1290"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213330"><a href="#local-6989586621685213330"><span class="hs-identifier">logger</span></a></a><span> </span><a name="local-6989586621685213331"><a href="#local-6989586621685213331"><span class="hs-identifier">_mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">defaultWarnErrLogger</span><span>
</span><a name="line-1291"></a><span>
</span><a name="line-1292"></a><span>        </span><a name="local-6989586621685213332"><a href="#local-6989586621685213332"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getSession</span><span>
</span><a name="line-1293"></a><span>
</span><a name="line-1294"></a><span>        </span><span class="hs-comment">-- TODO: Cache this, so that we don't repeatedly re-check</span><span>
</span><a name="line-1295"></a><span>        </span><span class="hs-comment">-- our imports when you run --make.</span><span>
</span><a name="line-1296"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685213333"><a href="#local-6989586621685213333"><span class="hs-identifier">ready_uids</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685213334"><a href="#local-6989586621685213334"><span class="hs-identifier">uids_to_check'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1297"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partition</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621685213336"><a href="#local-6989586621685213336"><span class="hs-identifier">uid</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">isEmptyUniqDSet</span><span>
</span><a name="line-1298"></a><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitIdFreeHoles</span><span> </span><a href="#local-6989586621685213336"><span class="hs-identifier hs-var">uid</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">uniqDSetMinusUniqSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685213329"><span class="hs-identifier hs-var">done_holes</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1299"></a><span>                     </span><a href="#local-6989586621685213328"><span class="hs-identifier hs-var">uids_to_check</span></a><span>
</span><a name="line-1300"></a><span>            </span><a name="local-6989586621685213335"><a href="#local-6989586621685213335"><span class="hs-identifier">done_holes'</span></a></a><span>
</span><a name="line-1301"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">ms_hsc_src</span><span> </span><a href="#local-6989586621685213324"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">HsigFile</span><span>
</span><a name="line-1302"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addOneToUniqSet</span><span> </span><a href="#local-6989586621685213329"><span class="hs-identifier hs-var">done_holes</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ms_mod_name</span><span> </span><a href="#local-6989586621685213324"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-1303"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213329"><span class="hs-identifier hs-var">done_holes</span></a><span>
</span><a name="line-1304"></a><span>        </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">runHsc</span><span> </span><a href="#local-6989586621685213332"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="HscMain.html#ioMsgMaybe"><span class="hs-identifier hs-var">ioMsgMaybe</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="TcBackpack.html#tcRnCheckUnitId"><span class="hs-identifier hs-var">tcRnCheckUnitId</span></a><span> </span><a href="#local-6989586621685213332"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213333"><span class="hs-identifier hs-var">ready_uids</span></a><span>
</span><a name="line-1305"></a><span>
</span><a name="line-1306"></a><span>        </span><span class="hs-comment">-- Remove unwanted tmp files between compilations</span><span>
</span><a name="line-1307"></a><span>        </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213309"><span class="hs-identifier hs-var">cleanup</span></a><span> </span><a href="#local-6989586621685213332"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1308"></a><span>
</span><a name="line-1309"></a><span>        </span><span class="hs-comment">-- Get ready to tie the knot</span><span>
</span><a name="line-1310"></a><span>        </span><a name="local-6989586621685213337"><a href="#local-6989586621685213337"><span class="hs-identifier">type_env_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">emptyNameEnv</span><span>
</span><a name="line-1311"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213338"><a href="#local-6989586621685213338"><span class="hs-identifier">hsc_env1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213332"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_type_env_var</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1312"></a><span>                                    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ms_mod</span><span> </span><a href="#local-6989586621685213324"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685213337"><span class="hs-identifier hs-var">type_env_var</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1313"></a><span>        </span><span class="hs-identifier hs-var">setSession</span><span> </span><a href="#local-6989586621685213338"><span class="hs-identifier hs-var">hsc_env1</span></a><span>
</span><a name="line-1314"></a><span>
</span><a name="line-1315"></a><span>        </span><span class="hs-comment">-- Lazily reload the HPT modules participating in the loop.</span><span>
</span><a name="line-1316"></a><span>        </span><span class="hs-comment">-- See Note [Tying the knot]--if we don't throw out the old HPT</span><span>
</span><a name="line-1317"></a><span>        </span><span class="hs-comment">-- and reinitalize the knot-tying process, anything that was forced</span><span>
</span><a name="line-1318"></a><span>        </span><span class="hs-comment">-- while we were previously typechecking won't get updated, this</span><span>
</span><a name="line-1319"></a><span>        </span><span class="hs-comment">-- was bug #12035.</span><span>
</span><a name="line-1320"></a><span>        </span><a name="local-6989586621685213339"><a href="#local-6989586621685213339"><span class="hs-identifier">hsc_env2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GhcMake.html#reTypecheckLoop"><span class="hs-identifier hs-var">reTypecheckLoop</span></a><span> </span><a href="#local-6989586621685213338"><span class="hs-identifier hs-var">hsc_env1</span></a><span> </span><a href="#local-6989586621685213324"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621685213323"><span class="hs-identifier hs-var">done</span></a><span>
</span><a name="line-1321"></a><span>        </span><span class="hs-identifier hs-var">setSession</span><span> </span><a href="#local-6989586621685213339"><span class="hs-identifier hs-var">hsc_env2</span></a><span>
</span><a name="line-1322"></a><span>
</span><a name="line-1323"></a><span>        </span><a name="local-6989586621685213342"><a href="#local-6989586621685213342"><span class="hs-identifier">mb_mod_info</span></a></a><span>
</span><a name="line-1324"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">handleSourceError</span><span>
</span><a name="line-1325"></a><span>                   </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621685213340"><a href="#local-6989586621685213340"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="#local-6989586621685213330"><span class="hs-identifier hs-var">logger</span></a><span> </span><a href="#local-6989586621685213324"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685213340"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1326"></a><span>                 </span><a name="local-6989586621685213341"><a href="#local-6989586621685213341"><span class="hs-identifier">mod_info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GhcMake.html#upsweep_mod"><span class="hs-identifier hs-var">upsweep_mod</span></a><span> </span><a href="#local-6989586621685213339"><span class="hs-identifier hs-var">hsc_env2</span></a><span> </span><a href="#local-6989586621685213306"><span class="hs-identifier hs-var">mHscMessage</span></a><span> </span><a href="#local-6989586621685213322"><span class="hs-identifier hs-var">old_hpt</span></a><span> </span><a href="#local-6989586621685213308"><span class="hs-identifier hs-var">stable_mods</span></a><span>
</span><a name="line-1327"></a><span>                                                  </span><a href="#local-6989586621685213324"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621685213326"><span class="hs-identifier hs-var">mod_index</span></a><span> </span><a href="#local-6989586621685213327"><span class="hs-identifier hs-var">nmods</span></a><span>
</span><a name="line-1328"></a><span>                 </span><a href="#local-6989586621685213330"><span class="hs-identifier hs-var">logger</span></a><span> </span><a href="#local-6989586621685213324"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-comment">-- log warnings</span><span>
</span><a name="line-1329"></a><span>                 </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685213341"><span class="hs-identifier hs-var">mod_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-1330"></a><span>
</span><a name="line-1331"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685213342"><span class="hs-identifier hs-var">mb_mod_info</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1332"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Failed</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685213323"><span class="hs-identifier hs-var">done</span></a><span class="hs-special">)</span><span>
</span><a name="line-1333"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213343"><a href="#local-6989586621685213343"><span class="hs-identifier">mod_info</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1334"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213344"><a href="#local-6989586621685213344"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ms_mod_name</span><span> </span><a href="#local-6989586621685213324"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-1335"></a><span>
</span><a name="line-1336"></a><span>                        </span><span class="hs-comment">-- Add new info to hsc_env</span><span>
</span><a name="line-1337"></a><span>                    </span><a name="local-6989586621685213345"><a href="#local-6989586621685213345"><span class="hs-identifier">hpt1</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addToHpt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_HPT</span><span> </span><a href="#local-6989586621685213339"><span class="hs-identifier hs-var">hsc_env2</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213344"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621685213343"><span class="hs-identifier hs-var">mod_info</span></a><span>
</span><a name="line-1338"></a><span>                    </span><a name="local-6989586621685213346"><a href="#local-6989586621685213346"><span class="hs-identifier">hsc_env3</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213339"><span class="hs-identifier hs-var">hsc_env2</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_HPT</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213345"><span class="hs-identifier hs-var">hpt1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsc_type_env_var</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1339"></a><span>
</span><a name="line-1340"></a><span>                        </span><span class="hs-comment">-- Space-saving: delete the old HPT entry</span><span>
</span><a name="line-1341"></a><span>                        </span><span class="hs-comment">-- for mod BUT if mod is a hs-boot</span><span>
</span><a name="line-1342"></a><span>                        </span><span class="hs-comment">-- node, don't delete it.  For the</span><span>
</span><a name="line-1343"></a><span>                        </span><span class="hs-comment">-- interface, the HPT entry is probaby for the</span><span>
</span><a name="line-1344"></a><span>                        </span><span class="hs-comment">-- main Haskell source file.  Deleting it</span><span>
</span><a name="line-1345"></a><span>                        </span><span class="hs-comment">-- would force the real module to be recompiled</span><span>
</span><a name="line-1346"></a><span>                        </span><span class="hs-comment">-- every time.</span><span>
</span><a name="line-1347"></a><span>                    </span><a name="local-6989586621685213347"><a href="#local-6989586621685213347"><span class="hs-identifier">old_hpt1</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isBootSummary</span><span> </span><a href="#local-6989586621685213324"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213322"><span class="hs-identifier hs-var">old_hpt</span></a><span>
</span><a name="line-1348"></a><span>                             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">delFromHpt</span><span> </span><a href="#local-6989586621685213322"><span class="hs-identifier hs-var">old_hpt</span></a><span> </span><a href="#local-6989586621685213344"><span class="hs-identifier hs-var">this_mod</span></a><span>
</span><a name="line-1349"></a><span>
</span><a name="line-1350"></a><span>                    </span><a name="local-6989586621685213348"><a href="#local-6989586621685213348"><span class="hs-identifier">done'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendMG</span><span> </span><a href="#local-6989586621685213323"><span class="hs-identifier hs-var">done</span></a><span> </span><a href="#local-6989586621685213324"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-1351"></a><span>
</span><a name="line-1352"></a><span>                        </span><span class="hs-comment">-- fixup our HomePackageTable after we've finished compiling</span><span>
</span><a name="line-1353"></a><span>                        </span><span class="hs-comment">-- a mutually-recursive loop.  We have to do this again</span><span>
</span><a name="line-1354"></a><span>                        </span><span class="hs-comment">-- to make sure we have the final unfoldings, which may</span><span>
</span><a name="line-1355"></a><span>                        </span><span class="hs-comment">-- not have been computed accurately in the previous</span><span>
</span><a name="line-1356"></a><span>                        </span><span class="hs-comment">-- retypecheck.</span><span>
</span><a name="line-1357"></a><span>                </span><a name="local-6989586621685213349"><a href="#local-6989586621685213349"><span class="hs-identifier">hsc_env4</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GhcMake.html#reTypecheckLoop"><span class="hs-identifier hs-var">reTypecheckLoop</span></a><span> </span><a href="#local-6989586621685213346"><span class="hs-identifier hs-var">hsc_env3</span></a><span> </span><a href="#local-6989586621685213324"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621685213348"><span class="hs-identifier hs-var">done'</span></a><span>
</span><a name="line-1358"></a><span>                </span><span class="hs-identifier hs-var">setSession</span><span> </span><a href="#local-6989586621685213349"><span class="hs-identifier hs-var">hsc_env4</span></a><span>
</span><a name="line-1359"></a><span>
</span><a name="line-1360"></a><span>                        </span><span class="hs-comment">-- Add any necessary entries to the static pointer</span><span>
</span><a name="line-1361"></a><span>                        </span><span class="hs-comment">-- table. See Note [Grand plan for static forms] in</span><span>
</span><a name="line-1362"></a><span>                        </span><span class="hs-comment">-- StaticPtrTable.</span><span>
</span><a name="line-1363"></a><span>                </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hscTarget</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685213349"><span class="hs-identifier hs-var">hsc_env4</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">HscInterpreted</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1364"></a><span>                    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#hscAddSptEntries"><span class="hs-identifier hs-var">hscAddSptEntries</span></a><span> </span><a href="#local-6989586621685213349"><span class="hs-identifier hs-var">hsc_env4</span></a><span>
</span><a name="line-1365"></a><span>                                 </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621685213353"><span class="hs-identifier hs-var">spt</span></a><span>
</span><a name="line-1366"></a><span>                                 </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213350"><a href="#local-6989586621685213350"><span class="hs-identifier">linkable</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">hm_linkable</span><span> </span><a href="#local-6989586621685213343"><span class="hs-identifier hs-var">mod_info</span></a><span>
</span><a name="line-1367"></a><span>                                 </span><span class="hs-special">,</span><span> </span><a name="local-6989586621685213351"><a href="#local-6989586621685213351"><span class="hs-identifier">unlinked</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">linkableUnlinked</span><span> </span><a href="#local-6989586621685213350"><span class="hs-identifier hs-var">linkable</span></a><span>
</span><a name="line-1368"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">BCOs</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621685213352"><a href="#local-6989586621685213352"><span class="hs-identifier">spts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621685213351"><span class="hs-identifier hs-var">unlinked</span></a><span>
</span><a name="line-1369"></a><span>                                 </span><span class="hs-special">,</span><span> </span><a name="local-6989586621685213353"><a href="#local-6989586621685213353"><span class="hs-identifier">spt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213352"><span class="hs-identifier hs-var">spts</span></a><span>
</span><a name="line-1370"></a><span>                                 </span><span class="hs-special">]</span><span>
</span><a name="line-1371"></a><span>
</span><a name="line-1372"></a><span>                </span><a href="#local-6989586621685213312"><span class="hs-identifier hs-var">upsweep'</span></a><span> </span><a href="#local-6989586621685213347"><span class="hs-identifier hs-var">old_hpt1</span></a><span> </span><a href="#local-6989586621685213348"><span class="hs-identifier hs-var">done'</span></a><span> </span><a href="#local-6989586621685213325"><span class="hs-identifier hs-var">mods</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213326"><span class="hs-identifier hs-var">mod_index</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213327"><span class="hs-identifier hs-var">nmods</span></a><span> </span><a href="#local-6989586621685213334"><span class="hs-identifier hs-var">uids_to_check'</span></a><span> </span><a href="#local-6989586621685213335"><span class="hs-identifier hs-var">done_holes'</span></a><span>
</span><a name="line-1373"></a><span>
</span><a name="line-1374"></a><span class="hs-identifier">unitIdsToCheck</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">UnitId</span><span class="hs-special">]</span><span>
</span><a name="line-1375"></a><a name="unitIdsToCheck"><a href="GhcMake.html#unitIdsToCheck"><span class="hs-identifier">unitIdsToCheck</span></a></a><span> </span><a name="local-6989586621685213357"><a href="#local-6989586621685213357"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1376"></a><span>  </span><span class="hs-identifier hs-var">nubSort</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="#local-6989586621685213358"><span class="hs-identifier hs-var">goUnitId</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">explicitPackages</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pkgState</span><span> </span><a href="#local-6989586621685213357"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1377"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1378"></a><span>  </span><a name="local-6989586621685213358"><a href="#local-6989586621685213358"><span class="hs-identifier">goUnitId</span></a></a><span> </span><a name="local-6989586621685213359"><a href="#local-6989586621685213359"><span class="hs-identifier">uid</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1379"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">splitUnitIdInsts</span><span> </span><a href="#local-6989586621685213359"><span class="hs-identifier hs-var">uid</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1380"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213360"><a href="#local-6989586621685213360"><span class="hs-identifier">indef</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1381"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213361"><a href="#local-6989586621685213361"><span class="hs-identifier">insts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">indefUnitIdInsts</span><span> </span><a href="#local-6989586621685213360"><span class="hs-identifier hs-var">indef</span></a><span>
</span><a name="line-1382"></a><span>        </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621685213359"><span class="hs-identifier hs-var">uid</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213358"><span class="hs-identifier hs-var">goUnitId</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">moduleUnitId</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">snd</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213361"><span class="hs-identifier hs-var">insts</span></a><span>
</span><a name="line-1383"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1384"></a><span>
</span><a name="line-1385"></a><span class="hs-identifier">maybeGetIfaceDate</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModLocation</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">UTCTime</span><span class="hs-special">)</span><span>
</span><a name="line-1386"></a><a name="maybeGetIfaceDate"><a href="GhcMake.html#maybeGetIfaceDate"><span class="hs-identifier">maybeGetIfaceDate</span></a></a><span> </span><a name="local-6989586621685213362"><a href="#local-6989586621685213362"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685213363"><a href="#local-6989586621685213363"><span class="hs-identifier">location</span></a></a><span>
</span><a name="line-1387"></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="DriverPipeline.html#writeInterfaceOnlyMode"><span class="hs-identifier hs-var">writeInterfaceOnlyMode</span></a><span> </span><a href="#local-6989586621685213362"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1388"></a><span>    </span><span class="hs-comment">-- Minor optimization: it should be harmless to check the hi file location</span><span>
</span><a name="line-1389"></a><span>    </span><span class="hs-comment">-- always, but it's better to avoid hitting the filesystem if possible.</span><span>
</span><a name="line-1390"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modificationTimeIfExists</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ml_hi_file</span><span> </span><a href="#local-6989586621685213363"><span class="hs-identifier hs-var">location</span></a><span class="hs-special">)</span><span>
</span><a name="line-1391"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1392"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1393"></a><span>
</span><a name="line-1394"></a><span class="hs-comment">-- | Compile a single module.  Always produce a Linkable for it if</span><span>
</span><a name="line-1395"></a><span class="hs-comment">-- successful.  If no compilation happened, return the old Linkable.</span><span>
</span><a name="line-1396"></a><span class="hs-identifier">upsweep_mod</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-1397"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="HscMain.html#Messager"><span class="hs-identifier hs-type">Messager</span></a><span>
</span><a name="line-1398"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HomePackageTable</span><span>
</span><a name="line-1399"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GhcMake.html#StableModules"><span class="hs-identifier hs-type">StableModules</span></a><span>
</span><a name="line-1400"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span>
</span><a name="line-1401"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>  </span><span class="hs-comment">-- index of module</span><span>
</span><a name="line-1402"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>  </span><span class="hs-comment">-- total number of modules</span><span>
</span><a name="line-1403"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">HomeModInfo</span><span>
</span><a name="line-1404"></a><a name="upsweep_mod"><a href="GhcMake.html#upsweep_mod"><span class="hs-identifier">upsweep_mod</span></a></a><span> </span><a name="local-6989586621685213364"><a href="#local-6989586621685213364"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621685213365"><a href="#local-6989586621685213365"><span class="hs-identifier">mHscMessage</span></a></a><span> </span><a name="local-6989586621685213366"><a href="#local-6989586621685213366"><span class="hs-identifier">old_hpt</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621685213367"><a href="#local-6989586621685213367"><span class="hs-identifier">stable_obj</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685213368"><a href="#local-6989586621685213368"><span class="hs-identifier">stable_bco</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621685213369"><a href="#local-6989586621685213369"><span class="hs-identifier">summary</span></a></a><span> </span><a name="local-6989586621685213370"><a href="#local-6989586621685213370"><span class="hs-identifier">mod_index</span></a></a><span> </span><a name="local-6989586621685213371"><a href="#local-6989586621685213371"><span class="hs-identifier">nmods</span></a></a><span>
</span><a name="line-1405"></a><span>   </span><span class="hs-glyph">=</span><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-1406"></a><span>            </span><a name="local-6989586621685213372"><a href="#local-6989586621685213372"><span class="hs-identifier">this_mod_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ms_mod_name</span><span> </span><a href="#local-6989586621685213369"><span class="hs-identifier hs-var">summary</span></a><span>
</span><a name="line-1407"></a><span>            </span><a name="local-6989586621685213373"><a href="#local-6989586621685213373"><span class="hs-identifier">this_mod</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_mod</span><span> </span><a href="#local-6989586621685213369"><span class="hs-identifier hs-var">summary</span></a><span>
</span><a name="line-1408"></a><span>            </span><a name="local-6989586621685213374"><a href="#local-6989586621685213374"><span class="hs-identifier">mb_obj_date</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_obj_date</span><span> </span><a href="#local-6989586621685213369"><span class="hs-identifier hs-var">summary</span></a><span>
</span><a name="line-1409"></a><span>            </span><a name="local-6989586621685213375"><a href="#local-6989586621685213375"><span class="hs-identifier">mb_if_date</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_iface_date</span><span> </span><a href="#local-6989586621685213369"><span class="hs-identifier hs-var">summary</span></a><span>
</span><a name="line-1410"></a><span>            </span><a name="local-6989586621685213376"><a href="#local-6989586621685213376"><span class="hs-identifier">obj_fn</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ml_obj_file</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ms_location</span><span> </span><a href="#local-6989586621685213369"><span class="hs-identifier hs-var">summary</span></a><span class="hs-special">)</span><span>
</span><a name="line-1411"></a><span>            </span><a name="local-6989586621685213377"><a href="#local-6989586621685213377"><span class="hs-identifier">hs_date</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_hs_date</span><span> </span><a href="#local-6989586621685213369"><span class="hs-identifier hs-var">summary</span></a><span>
</span><a name="line-1412"></a><span>
</span><a name="line-1413"></a><span>            </span><a name="local-6989586621685213378"><a href="#local-6989586621685213378"><span class="hs-identifier">is_stable_obj</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213372"><span class="hs-identifier hs-var">this_mod_name</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elementOfUniqSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685213367"><span class="hs-identifier hs-var">stable_obj</span></a><span>
</span><a name="line-1414"></a><span>            </span><a name="local-6989586621685213379"><a href="#local-6989586621685213379"><span class="hs-identifier">is_stable_bco</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213372"><span class="hs-identifier hs-var">this_mod_name</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elementOfUniqSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685213368"><span class="hs-identifier hs-var">stable_bco</span></a><span>
</span><a name="line-1415"></a><span>
</span><a name="line-1416"></a><span>            </span><a name="local-6989586621685213380"><a href="#local-6989586621685213380"><span class="hs-identifier">old_hmi</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupHpt</span><span> </span><a href="#local-6989586621685213366"><span class="hs-identifier hs-var">old_hpt</span></a><span> </span><a href="#local-6989586621685213372"><span class="hs-identifier hs-var">this_mod_name</span></a><span>
</span><a name="line-1417"></a><span>
</span><a name="line-1418"></a><span>            </span><span class="hs-comment">-- We're using the dflags for this module now, obtained by</span><span>
</span><a name="line-1419"></a><span>            </span><span class="hs-comment">-- applying any options in its LANGUAGE &amp; OPTIONS_GHC pragmas.</span><span>
</span><a name="line-1420"></a><span>            </span><a name="local-6989586621685213381"><a href="#local-6989586621685213381"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_hspp_opts</span><span> </span><a href="#local-6989586621685213369"><span class="hs-identifier hs-var">summary</span></a><span>
</span><a name="line-1421"></a><span>            </span><a name="local-6989586621685213382"><a href="#local-6989586621685213382"><span class="hs-identifier">prevailing_target</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hscTarget</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685213364"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1422"></a><span>            </span><a name="local-6989586621685213383"><a href="#local-6989586621685213383"><span class="hs-identifier">local_target</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hscTarget</span><span> </span><a href="#local-6989586621685213381"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1423"></a><span>
</span><a name="line-1424"></a><span>            </span><span class="hs-comment">-- If OPTIONS_GHC contains -fasm or -fllvm, be careful that</span><span>
</span><a name="line-1425"></a><span>            </span><span class="hs-comment">-- we don't do anything dodgy: these should only work to change</span><span>
</span><a name="line-1426"></a><span>            </span><span class="hs-comment">-- from -fllvm to -fasm and vice-versa, or away from -fno-code,</span><span>
</span><a name="line-1427"></a><span>            </span><span class="hs-comment">-- otherwise we could end up trying to link object code to byte</span><span>
</span><a name="line-1428"></a><span>            </span><span class="hs-comment">-- code.</span><span>
</span><a name="line-1429"></a><span>            </span><a name="local-6989586621685213384"><a href="#local-6989586621685213384"><span class="hs-identifier">target</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621685213382"><span class="hs-identifier hs-var">prevailing_target</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621685213383"><span class="hs-identifier hs-var">local_target</span></a><span>
</span><a name="line-1430"></a><span>                        </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isObjectTarget</span><span> </span><a href="#local-6989586621685213382"><span class="hs-identifier hs-var">prevailing_target</span></a><span class="hs-special">)</span><span>
</span><a name="line-1431"></a><span>                            </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isObjectTarget</span><span> </span><a href="#local-6989586621685213383"><span class="hs-identifier hs-var">local_target</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1432"></a><span>                        </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213382"><span class="hs-identifier hs-var">prevailing_target</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">HscNothing</span><span class="hs-special">)</span><span>
</span><a name="line-1433"></a><span>                        </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621685213382"><span class="hs-identifier hs-var">prevailing_target</span></a><span>
</span><a name="line-1434"></a><span>                        </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621685213383"><span class="hs-identifier hs-var">local_target</span></a><span>
</span><a name="line-1435"></a><span>
</span><a name="line-1436"></a><span>            </span><span class="hs-comment">-- store the corrected hscTarget into the summary</span><span>
</span><a name="line-1437"></a><span>            </span><a name="local-6989586621685213385"><a href="#local-6989586621685213385"><span class="hs-identifier">summary'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213369"><span class="hs-identifier hs-var">summary</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">ms_hspp_opts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213381"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hscTarget</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213384"><span class="hs-identifier hs-var">target</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1438"></a><span>
</span><a name="line-1439"></a><span>            </span><span class="hs-comment">-- The old interface is ok if</span><span>
</span><a name="line-1440"></a><span>            </span><span class="hs-comment">--  a) we're compiling a source file, and the old HPT</span><span>
</span><a name="line-1441"></a><span>            </span><span class="hs-comment">--     entry is for a source file</span><span>
</span><a name="line-1442"></a><span>            </span><span class="hs-comment">--  b) we're compiling a hs-boot file</span><span>
</span><a name="line-1443"></a><span>            </span><span class="hs-comment">-- Case (b) allows an hs-boot file to get the interface of its</span><span>
</span><a name="line-1444"></a><span>            </span><span class="hs-comment">-- real source file on the second iteration of the compilation</span><span>
</span><a name="line-1445"></a><span>            </span><span class="hs-comment">-- manager, but that does no harm.  Otherwise the hs-boot file</span><span>
</span><a name="line-1446"></a><span>            </span><span class="hs-comment">-- will always be recompiled</span><span>
</span><a name="line-1447"></a><span>
</span><a name="line-1448"></a><span>            </span><a name="local-6989586621685213386"><a href="#local-6989586621685213386"><span class="hs-identifier">mb_old_iface</span></a></a><span>
</span><a name="line-1449"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685213380"><span class="hs-identifier hs-var">old_hmi</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1450"></a><span>                     </span><span class="hs-identifier hs-var">Nothing</span><span>                              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1451"></a><span>                     </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213391"><a href="#local-6989586621685213391"><span class="hs-identifier">hm_info</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isBootSummary</span><span> </span><a href="#local-6989586621685213369"><span class="hs-identifier hs-var">summary</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685213392"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-1452"></a><span>                                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mi_boot</span><span> </span><a href="#local-6989586621685213392"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685213392"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-1453"></a><span>                                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1454"></a><span>                                   </span><span class="hs-keyword">where</span><span>
</span><a name="line-1455"></a><span>                                     </span><a name="local-6989586621685213392"><a href="#local-6989586621685213392"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hm_iface</span><span> </span><a href="#local-6989586621685213391"><span class="hs-identifier hs-var">hm_info</span></a><span>
</span><a name="line-1456"></a><span>
</span><a name="line-1457"></a><span>            </span><span class="hs-identifier">compile_it</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Linkable</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SourceModified</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">HomeModInfo</span><span>
</span><a name="line-1458"></a><span>            </span><a name="local-6989586621685213387"><a href="#local-6989586621685213387"><span class="hs-identifier">compile_it</span></a></a><span>  </span><a name="local-6989586621685213393"><a href="#local-6989586621685213393"><span class="hs-identifier">mb_linkable</span></a></a><span> </span><a name="local-6989586621685213394"><a href="#local-6989586621685213394"><span class="hs-identifier">src_modified</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1459"></a><span>                  </span><a href="DriverPipeline.html#compileOne%27"><span class="hs-identifier hs-var">compileOne'</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621685213365"><span class="hs-identifier hs-var">mHscMessage</span></a><span> </span><a href="#local-6989586621685213364"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685213385"><span class="hs-identifier hs-var">summary'</span></a><span> </span><a href="#local-6989586621685213370"><span class="hs-identifier hs-var">mod_index</span></a><span> </span><a href="#local-6989586621685213371"><span class="hs-identifier hs-var">nmods</span></a><span>
</span><a name="line-1460"></a><span>                             </span><a href="#local-6989586621685213386"><span class="hs-identifier hs-var">mb_old_iface</span></a><span> </span><a href="#local-6989586621685213393"><span class="hs-identifier hs-var">mb_linkable</span></a><span> </span><a href="#local-6989586621685213394"><span class="hs-identifier hs-var">src_modified</span></a><span>
</span><a name="line-1461"></a><span>
</span><a name="line-1462"></a><span>            </span><span class="hs-identifier">compile_it_discard_iface</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Linkable</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SourceModified</span><span>
</span><a name="line-1463"></a><span>                                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">HomeModInfo</span><span>
</span><a name="line-1464"></a><span>            </span><a name="local-6989586621685213388"><a href="#local-6989586621685213388"><span class="hs-identifier">compile_it_discard_iface</span></a></a><span> </span><a name="local-6989586621685213395"><a href="#local-6989586621685213395"><span class="hs-identifier">mb_linkable</span></a></a><span>  </span><a name="local-6989586621685213396"><a href="#local-6989586621685213396"><span class="hs-identifier">src_modified</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1465"></a><span>                  </span><a href="DriverPipeline.html#compileOne%27"><span class="hs-identifier hs-var">compileOne'</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621685213365"><span class="hs-identifier hs-var">mHscMessage</span></a><span> </span><a href="#local-6989586621685213364"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685213385"><span class="hs-identifier hs-var">summary'</span></a><span> </span><a href="#local-6989586621685213370"><span class="hs-identifier hs-var">mod_index</span></a><span> </span><a href="#local-6989586621685213371"><span class="hs-identifier hs-var">nmods</span></a><span>
</span><a name="line-1466"></a><span>                             </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621685213395"><span class="hs-identifier hs-var">mb_linkable</span></a><span> </span><a href="#local-6989586621685213396"><span class="hs-identifier hs-var">src_modified</span></a><span>
</span><a name="line-1467"></a><span>
</span><a name="line-1468"></a><span>            </span><span class="hs-comment">-- With the HscNothing target we create empty linkables to avoid</span><span>
</span><a name="line-1469"></a><span>            </span><span class="hs-comment">-- recompilation.  We have to detect these to recompile anyway if</span><span>
</span><a name="line-1470"></a><span>            </span><span class="hs-comment">-- the target changed since the last compile.</span><span>
</span><a name="line-1471"></a><span>            </span><a name="local-6989586621685213389"><a href="#local-6989586621685213389"><span class="hs-identifier">is_fake_linkable</span></a></a><span>
</span><a name="line-1472"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213397"><a href="#local-6989586621685213397"><span class="hs-identifier">hmi</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213380"><span class="hs-identifier hs-var">old_hmi</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213398"><a href="#local-6989586621685213398"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">hm_linkable</span><span> </span><a href="#local-6989586621685213397"><span class="hs-identifier hs-var">hmi</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1473"></a><span>                  </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">linkableUnlinked</span><span> </span><a href="#local-6989586621685213398"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span>
</span><a name="line-1474"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1475"></a><span>                   </span><span class="hs-comment">-- we have no linkable, so it cannot be fake</span><span>
</span><a name="line-1476"></a><span>                   </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1477"></a><span>
</span><a name="line-1478"></a><span>            </span><a name="local-6989586621685213390"><a href="#local-6989586621685213390"><span class="hs-identifier">implies</span></a></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1479"></a><span>            </span><span class="hs-identifier">implies</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a name="local-6989586621685213399"><a href="#local-6989586621685213399"><span class="hs-identifier">x</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213399"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-1480"></a><span>
</span><a name="line-1481"></a><span>        </span><span class="hs-keyword">in</span><span>
</span><a name="line-1482"></a><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1483"></a><span>         </span><span class="hs-identifier">_</span><span>
</span><a name="line-1484"></a><span>                </span><span class="hs-comment">-- Regardless of whether we're generating object code or</span><span>
</span><a name="line-1485"></a><span>                </span><span class="hs-comment">-- byte code, we can always use an existing object file</span><span>
</span><a name="line-1486"></a><span>                </span><span class="hs-comment">-- if it is *stable* (see checkStability).</span><span>
</span><a name="line-1487"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685213378"><span class="hs-identifier hs-var">is_stable_obj</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213400"><a href="#local-6989586621685213400"><span class="hs-identifier">hmi</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213380"><span class="hs-identifier hs-var">old_hmi</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1488"></a><span>                </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685213364"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">5</span><span>
</span><a name="line-1489"></a><span>                           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;skipping stable obj mod:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685213372"><span class="hs-identifier hs-var">this_mod_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1490"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685213400"><span class="hs-identifier hs-var">hmi</span></a><span>
</span><a name="line-1491"></a><span>                </span><span class="hs-comment">-- object is stable, and we have an entry in the</span><span>
</span><a name="line-1492"></a><span>                </span><span class="hs-comment">-- old HPT: nothing to do</span><span>
</span><a name="line-1493"></a><span>
</span><a name="line-1494"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685213378"><span class="hs-identifier hs-var">is_stable_obj</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isNothing</span><span> </span><a href="#local-6989586621685213380"><span class="hs-identifier hs-var">old_hmi</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1495"></a><span>                </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685213364"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">5</span><span>
</span><a name="line-1496"></a><span>                           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;compiling stable on-disk mod:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685213372"><span class="hs-identifier hs-var">this_mod_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1497"></a><span>                </span><a name="local-6989586621685213401"><a href="#local-6989586621685213401"><span class="hs-identifier">linkable</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Finder.html#findObjectLinkable"><span class="hs-identifier hs-var">findObjectLinkable</span></a><span> </span><a href="#local-6989586621685213373"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621685213376"><span class="hs-identifier hs-var">obj_fn</span></a><span>
</span><a name="line-1498"></a><span>                              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">expectJust</span><span> </span><span class="hs-string">&quot;upsweep1&quot;</span><span> </span><a href="#local-6989586621685213374"><span class="hs-identifier hs-var">mb_obj_date</span></a><span class="hs-special">)</span><span>
</span><a name="line-1499"></a><span>                </span><a href="#local-6989586621685213387"><span class="hs-identifier hs-var">compile_it</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685213401"><span class="hs-identifier hs-var">linkable</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">SourceUnmodifiedAndStable</span><span>
</span><a name="line-1500"></a><span>                </span><span class="hs-comment">-- object is stable, but we need to load the interface</span><span>
</span><a name="line-1501"></a><span>                </span><span class="hs-comment">-- off disk to make a HMI.</span><span>
</span><a name="line-1502"></a><span>
</span><a name="line-1503"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isObjectTarget</span><span> </span><a href="#local-6989586621685213384"><span class="hs-identifier hs-var">target</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685213379"><span class="hs-identifier hs-var">is_stable_bco</span></a><span class="hs-special">,</span><span>
</span><a name="line-1504"></a><span>            </span><span class="hs-special">(</span><a href="#local-6989586621685213384"><span class="hs-identifier hs-var">target</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">HscNothing</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="#local-6989586621685213390"><span class="hs-identifier hs-var">implies</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621685213389"><span class="hs-identifier hs-var">is_fake_linkable</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1505"></a><span>                </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier">isJust</span><span> </span><span class="hs-identifier">old_hmi</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- must be in the old_hpt</span><span>
</span><a name="line-1506"></a><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213402"><a href="#local-6989586621685213402"><span class="hs-identifier">hmi</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213380"><span class="hs-identifier hs-var">old_hmi</span></a><span> </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1507"></a><span>                </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685213364"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">5</span><span>
</span><a name="line-1508"></a><span>                           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;skipping stable BCO mod:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685213372"><span class="hs-identifier hs-var">this_mod_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1509"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685213402"><span class="hs-identifier hs-var">hmi</span></a><span>
</span><a name="line-1510"></a><span>                </span><span class="hs-comment">-- BCO is stable: nothing to do</span><span>
</span><a name="line-1511"></a><span>
</span><a name="line-1512"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isObjectTarget</span><span> </span><a href="#local-6989586621685213384"><span class="hs-identifier hs-var">target</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1513"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213403"><a href="#local-6989586621685213403"><span class="hs-identifier">hmi</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213380"><span class="hs-identifier hs-var">old_hmi</span></a><span class="hs-special">,</span><span>
</span><a name="line-1514"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213404"><a href="#local-6989586621685213404"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">hm_linkable</span><span> </span><a href="#local-6989586621685213403"><span class="hs-identifier hs-var">hmi</span></a><span class="hs-special">,</span><span>
</span><a name="line-1515"></a><span>            </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isObjectLinkable</span><span> </span><a href="#local-6989586621685213404"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1516"></a><span>            </span><span class="hs-special">(</span><a href="#local-6989586621685213384"><span class="hs-identifier hs-var">target</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">HscNothing</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="#local-6989586621685213390"><span class="hs-identifier hs-var">implies</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621685213389"><span class="hs-identifier hs-var">is_fake_linkable</span></a><span class="hs-special">,</span><span>
</span><a name="line-1517"></a><span>            </span><span class="hs-identifier">linkableTime</span><span> </span><a href="#local-6989586621685213404"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-identifier">ms_hs_date</span><span> </span><a href="#local-6989586621685213369"><span class="hs-identifier hs-var">summary</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1518"></a><span>                </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685213364"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">5</span><span>
</span><a name="line-1519"></a><span>                           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;compiling non-stable BCO mod:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685213372"><span class="hs-identifier hs-var">this_mod_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1520"></a><span>                </span><a href="#local-6989586621685213387"><span class="hs-identifier hs-var">compile_it</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685213404"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">SourceUnmodified</span><span>
</span><a name="line-1521"></a><span>                </span><span class="hs-comment">-- we have an old BCO that is up to date with respect</span><span>
</span><a name="line-1522"></a><span>                </span><span class="hs-comment">-- to the source: do a recompilation check as normal.</span><span>
</span><a name="line-1523"></a><span>
</span><a name="line-1524"></a><span>          </span><span class="hs-comment">-- When generating object code, if there's an up-to-date</span><span>
</span><a name="line-1525"></a><span>          </span><span class="hs-comment">-- object file on the disk, then we can use it.</span><span>
</span><a name="line-1526"></a><span>          </span><span class="hs-comment">-- However, if the object file is new (compared to any</span><span>
</span><a name="line-1527"></a><span>          </span><span class="hs-comment">-- linkable we had from a previous compilation), then we</span><span>
</span><a name="line-1528"></a><span>          </span><span class="hs-comment">-- must discard any in-memory interface, because this</span><span>
</span><a name="line-1529"></a><span>          </span><span class="hs-comment">-- means the user has compiled the source file</span><span>
</span><a name="line-1530"></a><span>          </span><span class="hs-comment">-- separately and generated a new interface, that we must</span><span>
</span><a name="line-1531"></a><span>          </span><span class="hs-comment">-- read from the disk.</span><span>
</span><a name="line-1532"></a><span>          </span><span class="hs-comment">--</span><span>
</span><a name="line-1533"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isObjectTarget</span><span> </span><a href="#local-6989586621685213384"><span class="hs-identifier hs-var">target</span></a><span class="hs-special">,</span><span>
</span><a name="line-1534"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213405"><a href="#local-6989586621685213405"><span class="hs-identifier">obj_date</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213374"><span class="hs-identifier hs-var">mb_obj_date</span></a><span class="hs-special">,</span><span>
</span><a name="line-1535"></a><span>            </span><a href="#local-6989586621685213405"><span class="hs-identifier hs-var">obj_date</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621685213377"><span class="hs-identifier hs-var">hs_date</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1536"></a><span>                </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685213380"><span class="hs-identifier hs-var">old_hmi</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1537"></a><span>                  </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213406"><a href="#local-6989586621685213406"><span class="hs-identifier">hmi</span></a></a><span>
</span><a name="line-1538"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213407"><a href="#local-6989586621685213407"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">hm_linkable</span><span> </span><a href="#local-6989586621685213406"><span class="hs-identifier hs-var">hmi</span></a><span class="hs-special">,</span><span>
</span><a name="line-1539"></a><span>                      </span><span class="hs-identifier hs-var">isObjectLinkable</span><span> </span><a href="#local-6989586621685213407"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier">linkableTime</span><span> </span><a href="#local-6989586621685213407"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621685213405"><span class="hs-identifier hs-var">obj_date</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1540"></a><span>                          </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685213364"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">5</span><span>
</span><a name="line-1541"></a><span>                                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;compiling mod with new on-disk obj:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685213372"><span class="hs-identifier hs-var">this_mod_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1542"></a><span>                          </span><a href="#local-6989586621685213387"><span class="hs-identifier hs-var">compile_it</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685213407"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">SourceUnmodified</span><span>
</span><a name="line-1543"></a><span>                  </span><a name="local-6989586621685213408"><a href="#local-6989586621685213408"><span class="hs-identifier">_otherwise</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1544"></a><span>                          </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685213364"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">5</span><span>
</span><a name="line-1545"></a><span>                                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;compiling mod with new on-disk obj2:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685213372"><span class="hs-identifier hs-var">this_mod_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1546"></a><span>                          </span><a name="local-6989586621685213409"><a href="#local-6989586621685213409"><span class="hs-identifier">linkable</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Finder.html#findObjectLinkable"><span class="hs-identifier hs-var">findObjectLinkable</span></a><span> </span><a href="#local-6989586621685213373"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621685213376"><span class="hs-identifier hs-var">obj_fn</span></a><span> </span><a href="#local-6989586621685213405"><span class="hs-identifier hs-var">obj_date</span></a><span>
</span><a name="line-1547"></a><span>                          </span><a href="#local-6989586621685213388"><span class="hs-identifier hs-var">compile_it_discard_iface</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685213409"><span class="hs-identifier hs-var">linkable</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">SourceUnmodified</span><span>
</span><a name="line-1548"></a><span>
</span><a name="line-1549"></a><span>          </span><span class="hs-comment">-- See Note [Recompilation checking in -fno-code mode]</span><span>
</span><a name="line-1550"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="DriverPipeline.html#writeInterfaceOnlyMode"><span class="hs-identifier hs-var">writeInterfaceOnlyMode</span></a><span> </span><a href="#local-6989586621685213381"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">,</span><span>
</span><a name="line-1551"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213410"><a href="#local-6989586621685213410"><span class="hs-identifier">if_date</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213375"><span class="hs-identifier hs-var">mb_if_date</span></a><span class="hs-special">,</span><span>
</span><a name="line-1552"></a><span>            </span><a href="#local-6989586621685213410"><span class="hs-identifier hs-var">if_date</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621685213377"><span class="hs-identifier hs-var">hs_date</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1553"></a><span>                </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685213364"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">5</span><span>
</span><a name="line-1554"></a><span>                           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;skipping tc'd mod:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685213372"><span class="hs-identifier hs-var">this_mod_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1555"></a><span>                </span><a href="#local-6989586621685213387"><span class="hs-identifier hs-var">compile_it</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-identifier hs-var">SourceUnmodified</span><span>
</span><a name="line-1556"></a><span>
</span><a name="line-1557"></a><span>         </span><a name="local-6989586621685213411"><a href="#local-6989586621685213411"><span class="hs-identifier">_otherwise</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1558"></a><span>                </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685213364"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">5</span><span>
</span><a name="line-1559"></a><span>                           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;compiling mod:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685213372"><span class="hs-identifier hs-var">this_mod_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1560"></a><span>                </span><a href="#local-6989586621685213387"><span class="hs-identifier hs-var">compile_it</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-identifier hs-var">SourceModified</span><span>
</span><a name="line-1561"></a><span>
</span><a name="line-1562"></a><span>
</span><a name="line-1563"></a><span class="hs-comment">{- Note [-fno-code mode]
~~~~~~~~~~~~~~~~~~~~~~~~
GHC offers the flag -fno-code for the purpose of parsing and typechecking a
program without generating object files. This is intended to be used by tooling
and IDEs to provide quick feedback on any parser or type errors as cheaply as
possible.

When GHC is invoked with -fno-code no object files or linked output will be
generated. As many errors and warnings as possible will be generated, as if
-fno-code had not been passed. The session DynFlags will have
hscTarget == HscNothing.

-fwrite-interface
~~~~~~~~~~~~~~~~
Whether interface files are generated in -fno-code mode is controlled by the
-fwrite-interface flag. The -fwrite-interface flag is a no-op if -fno-code is
not also passed. Recompilation avoidance requires interface files, so passing
-fno-code without -fwrite-interface should be avoided. If -fno-code were
re-implemented today, -fwrite-interface would be discarded and it would be
considered always on; this behaviour is as it is for backwards compatibility.

================================================================
IN SUMMARY: ALWAYS PASS -fno-code AND -fwrite-interface TOGETHER
================================================================

Template Haskell
~~~~~~~~~~~~~~~~
A module using template haskell may invoke an imported function from inside a
splice. This will cause the type-checker to attempt to execute that code, which
would fail if no object files had been generated. See #8025. To rectify this,
during the downsweep we patch the DynFlags in the ModSummary of any home module
that is imported by a module that uses template haskell, to generate object
code.

The flavour of generated object code is chosen by defaultObjectTarget for the
target platform. It would likely be faster to generate bytecode, but this is not
supported on all platforms(?Please Confirm?), and does not support the entirety
of GHC haskell. See #1257.

The object files (and interface files if -fwrite-interface is disabled) produced
for template haskell are written to temporary files.

Note that since template haskell can run arbitrary IO actions, -fno-code mode
is no more secure than running without it.

Potential TODOS:
~~~~~
* Remove -fwrite-interface and have interface files always written in -fno-code
  mode
* Both .o and .dyn_o files are generated for template haskell, but we only need
  .dyn_o. Fix it.
* In make mode, a message like
  Compiling A (A.hs, /tmp/ghc_123.o)
  is shown if downsweep enabled object code generation for A. Perhaps we should
  show &quot;nothing&quot; or &quot;temporary object file&quot; instead. Note that one
  can currently use -keep-tmp-files and inspect the generated file with the
  current behaviour.
* Offer a -no-codedir command line option, and write what were temporary
  object files there. This would speed up recompilation.
* Use existing object files (if they are up to date) instead of always
  generating temporary ones.
-}</span><span>
</span><a name="line-1625"></a><span>
</span><a name="line-1626"></a><span class="hs-comment">-- Note [Recompilation checking in -fno-code mode]</span><span>
</span><a name="line-1627"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-1628"></a><span class="hs-comment">-- If we are compiling with -fno-code -fwrite-interface, there won't</span><span>
</span><a name="line-1629"></a><span class="hs-comment">-- be any object code that we can compare against, nor should there</span><span>
</span><a name="line-1630"></a><span class="hs-comment">-- be: we're *just* generating interface files.  In this case, we</span><span>
</span><a name="line-1631"></a><span class="hs-comment">-- want to check if the interface file is new, in lieu of the object</span><span>
</span><a name="line-1632"></a><span class="hs-comment">-- file.  See also Trac #9243.</span><span>
</span><a name="line-1633"></a><span>
</span><a name="line-1634"></a><span class="hs-comment">-- Filter modules in the HPT</span><span>
</span><a name="line-1635"></a><span class="hs-identifier">retainInTopLevelEnvs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ModuleName</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HomePackageTable</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HomePackageTable</span><span>
</span><a name="line-1636"></a><a name="retainInTopLevelEnvs"><a href="GhcMake.html#retainInTopLevelEnvs"><span class="hs-identifier">retainInTopLevelEnvs</span></a></a><span> </span><a name="local-6989586621685213412"><a href="#local-6989586621685213412"><span class="hs-identifier">keep_these</span></a></a><span> </span><a name="local-6989586621685213413"><a href="#local-6989586621685213413"><span class="hs-identifier">hpt</span></a></a><span>
</span><a name="line-1637"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">listToHpt</span><span>   </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213414"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">expectJust</span><span> </span><span class="hs-string">&quot;retain&quot;</span><span> </span><a href="#local-6989586621685213415"><span class="hs-identifier hs-var">mb_mod_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-1638"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621685213414"><a href="#local-6989586621685213414"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213412"><span class="hs-identifier hs-var">keep_these</span></a><span>
</span><a name="line-1639"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213415"><a href="#local-6989586621685213415"><span class="hs-identifier">mb_mod_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupHpt</span><span> </span><a href="#local-6989586621685213413"><span class="hs-identifier hs-var">hpt</span></a><span> </span><a href="#local-6989586621685213414"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-1640"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><a href="#local-6989586621685213415"><span class="hs-identifier hs-var">mb_mod_info</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1641"></a><span>
</span><a name="line-1642"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-1643"></a><span class="hs-comment">-- Typecheck module loops</span><span>
</span><a name="line-1644"></a><span class="hs-comment">{-
See bug #930.  This code fixes a long-standing bug in --make.  The
problem is that when compiling the modules *inside* a loop, a data
type that is only defined at the top of the loop looks opaque; but
after the loop is done, the structure of the data type becomes
apparent.

The difficulty is then that two different bits of code have
different notions of what the data type looks like.

The idea is that after we compile a module which also has an .hs-boot
file, we re-generate the ModDetails for each of the modules that
depends on the .hs-boot file, so that everyone points to the proper
TyCons, Ids etc. defined by the real module, not the boot module.
Fortunately re-generating a ModDetails from a ModIface is easy: the
function TcIface.typecheckIface does exactly that.

Picking the modules to re-typecheck is slightly tricky.  Starting from
the module graph consisting of the modules that have already been
compiled, we reverse the edges (so they point from the imported module
to the importing module), and depth-first-search from the .hs-boot
node.  This gives us all the modules that depend transitively on the
.hs-boot module, and those are exactly the modules that we need to
re-typecheck.

Following this fix, GHC can compile itself with --make -O2.
-}</span><span>
</span><a name="line-1671"></a><span>
</span><a name="line-1672"></a><span class="hs-identifier">reTypecheckLoop</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModuleGraph</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-1673"></a><a name="reTypecheckLoop"><a href="GhcMake.html#reTypecheckLoop"><span class="hs-identifier">reTypecheckLoop</span></a></a><span> </span><a name="local-6989586621685213416"><a href="#local-6989586621685213416"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621685213417"><a href="#local-6989586621685213417"><span class="hs-identifier">ms</span></a></a><span> </span><a name="local-6989586621685213418"><a href="#local-6989586621685213418"><span class="hs-identifier">graph</span></a></a><span>
</span><a name="line-1674"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213421"><a href="#local-6989586621685213421"><span class="hs-identifier">loop</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GhcMake.html#getModLoop"><span class="hs-identifier hs-var">getModLoop</span></a><span> </span><a href="#local-6989586621685213417"><span class="hs-identifier hs-var">ms</span></a><span> </span><a href="#local-6989586621685213419"><span class="hs-identifier hs-var">mss</span></a><span> </span><a href="#local-6989586621685213420"><span class="hs-identifier hs-var">appearsAsBoot</span></a><span>
</span><a name="line-1675"></a><span>  </span><span class="hs-comment">-- SOME hs-boot files should still</span><span>
</span><a name="line-1676"></a><span>  </span><span class="hs-comment">-- get used, just not the loop-closer.</span><span>
</span><a name="line-1677"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213422"><a href="#local-6989586621685213422"><span class="hs-identifier">non_boot</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621685213423"><a href="#local-6989586621685213423"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isBootSummary</span><span> </span><a href="#local-6989586621685213423"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-1678"></a><span>                                 </span><span class="hs-identifier">ms_mod</span><span> </span><a href="#local-6989586621685213423"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">ms_mod</span><span> </span><a href="#local-6989586621685213417"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213421"><span class="hs-identifier hs-var">loop</span></a><span>
</span><a name="line-1679"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="GhcMake.html#typecheckLoop"><span class="hs-identifier hs-var">typecheckLoop</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685213416"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213416"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ms_mod_name</span><span> </span><a href="#local-6989586621685213422"><span class="hs-identifier hs-var">non_boot</span></a><span class="hs-special">)</span><span>
</span><a name="line-1680"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1681"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685213416"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1682"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1683"></a><span>  </span><a name="local-6989586621685213419"><a href="#local-6989586621685213419"><span class="hs-identifier">mss</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mgModSummaries</span><span> </span><a href="#local-6989586621685213418"><span class="hs-identifier hs-var">graph</span></a><span>
</span><a name="line-1684"></a><span>  </span><a name="local-6989586621685213420"><a href="#local-6989586621685213420"><span class="hs-identifier">appearsAsBoot</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemModuleSet</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">mgBootModules</span><span> </span><a href="#local-6989586621685213418"><span class="hs-identifier hs-var">graph</span></a><span class="hs-special">)</span><span>
</span><a name="line-1685"></a><span>
</span><a name="line-1686"></a><span class="hs-comment">-- | Given a non-boot ModSummary @ms@ of a module, for which there exists a</span><span>
</span><a name="line-1687"></a><span class="hs-comment">-- corresponding boot file in @graph@, return the set of modules which</span><span>
</span><a name="line-1688"></a><span class="hs-comment">-- transitively depend on this boot file.  This function is slightly misnamed,</span><span>
</span><a name="line-1689"></a><span class="hs-comment">-- but its name &quot;getModLoop&quot; alludes to the fact that, when getModLoop is called</span><span>
</span><a name="line-1690"></a><span class="hs-comment">-- with a graph that does not contain @ms@ (non-parallel case) or is an</span><span>
</span><a name="line-1691"></a><span class="hs-comment">-- SCC with hs-boot nodes dropped (parallel-case), the modules which</span><span>
</span><a name="line-1692"></a><span class="hs-comment">-- depend on the hs-boot file are typically (but not always) the</span><span>
</span><a name="line-1693"></a><span class="hs-comment">-- modules participating in the recursive module loop.  The returned</span><span>
</span><a name="line-1694"></a><span class="hs-comment">-- list includes the hs-boot file.</span><span>
</span><a name="line-1695"></a><span class="hs-comment">--</span><span>
</span><a name="line-1696"></a><span class="hs-comment">-- Example:</span><span>
</span><a name="line-1697"></a><span class="hs-comment">--      let g represent the module graph:</span><span>
</span><a name="line-1698"></a><span class="hs-comment">--          C.hs</span><span>
</span><a name="line-1699"></a><span class="hs-comment">--          A.hs-boot imports C.hs</span><span>
</span><a name="line-1700"></a><span class="hs-comment">--          B.hs imports A.hs-boot</span><span>
</span><a name="line-1701"></a><span class="hs-comment">--          A.hs imports B.hs</span><span>
</span><a name="line-1702"></a><span class="hs-comment">--      genModLoop A.hs g == Just [A.hs-boot, B.hs, A.hs]</span><span>
</span><a name="line-1703"></a><span class="hs-comment">--</span><span>
</span><a name="line-1704"></a><span class="hs-comment">--      It would also be permissible to omit A.hs from the graph,</span><span>
</span><a name="line-1705"></a><span class="hs-comment">--      in which case the result is [A.hs-boot, B.hs]</span><span>
</span><a name="line-1706"></a><span class="hs-comment">--</span><span>
</span><a name="line-1707"></a><span class="hs-comment">-- Example:</span><span>
</span><a name="line-1708"></a><span class="hs-comment">--      A counter-example to the claim that modules returned</span><span>
</span><a name="line-1709"></a><span class="hs-comment">--      by this function participate in the loop occurs here:</span><span>
</span><a name="line-1710"></a><span class="hs-comment">--</span><span>
</span><a name="line-1711"></a><span class="hs-comment">--      let g represent the module graph:</span><span>
</span><a name="line-1712"></a><span class="hs-comment">--          C.hs</span><span>
</span><a name="line-1713"></a><span class="hs-comment">--          A.hs-boot imports C.hs</span><span>
</span><a name="line-1714"></a><span class="hs-comment">--          B.hs imports A.hs-boot</span><span>
</span><a name="line-1715"></a><span class="hs-comment">--          A.hs imports B.hs</span><span>
</span><a name="line-1716"></a><span class="hs-comment">--          D.hs imports A.hs-boot</span><span>
</span><a name="line-1717"></a><span class="hs-comment">--      genModLoop A.hs g == Just [A.hs-boot, B.hs, A.hs, D.hs]</span><span>
</span><a name="line-1718"></a><span class="hs-comment">--</span><span>
</span><a name="line-1719"></a><span class="hs-comment">--      Arguably, D.hs should import A.hs, not A.hs-boot, but</span><span>
</span><a name="line-1720"></a><span class="hs-comment">--      a dependency on the boot file is not illegal.</span><span>
</span><a name="line-1721"></a><span class="hs-comment">--</span><span>
</span><a name="line-1722"></a><span class="hs-identifier">getModLoop</span><span>
</span><a name="line-1723"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span>
</span><a name="line-1724"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span>
</span><a name="line-1725"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- check if a module appears as a boot module in 'graph'</span><span>
</span><a name="line-1726"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span>
</span><a name="line-1727"></a><a name="getModLoop"><a href="GhcMake.html#getModLoop"><span class="hs-identifier">getModLoop</span></a></a><span> </span><a name="local-6989586621685213424"><a href="#local-6989586621685213424"><span class="hs-identifier">ms</span></a></a><span> </span><a name="local-6989586621685213425"><a href="#local-6989586621685213425"><span class="hs-identifier">graph</span></a></a><span> </span><a name="local-6989586621685213426"><a href="#local-6989586621685213426"><span class="hs-identifier">appearsAsBoot</span></a></a><span>
</span><a name="line-1728"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isBootSummary</span><span> </span><a href="#local-6989586621685213424"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">)</span><span>
</span><a name="line-1729"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685213426"><span class="hs-identifier hs-var">appearsAsBoot</span></a><span> </span><a href="#local-6989586621685213427"><span class="hs-identifier hs-var">this_mod</span></a><span>
</span><a name="line-1730"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213428"><a href="#local-6989586621685213428"><span class="hs-identifier">mss</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GhcMake.html#reachableBackwards"><span class="hs-identifier hs-var">reachableBackwards</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ms_mod_name</span><span> </span><a href="#local-6989586621685213424"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213425"><span class="hs-identifier hs-var">graph</span></a><span>
</span><a name="line-1731"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685213428"><span class="hs-identifier hs-var">mss</span></a><span>
</span><a name="line-1732"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1733"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1734"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1735"></a><span>  </span><a name="local-6989586621685213427"><a href="#local-6989586621685213427"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_mod</span><span> </span><a href="#local-6989586621685213424"><span class="hs-identifier hs-var">ms</span></a><span>
</span><a name="line-1736"></a><span>
</span><a name="line-1737"></a><span class="hs-comment">-- NB: sometimes mods has duplicates; this is harmless because</span><span>
</span><a name="line-1738"></a><span class="hs-comment">-- any duplicates get clobbered in addListToHpt and never get forced.</span><span>
</span><a name="line-1739"></a><span class="hs-identifier">typecheckLoop</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ModuleName</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-1740"></a><a name="typecheckLoop"><a href="GhcMake.html#typecheckLoop"><span class="hs-identifier">typecheckLoop</span></a></a><span> </span><a name="local-6989586621685213429"><a href="#local-6989586621685213429"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685213430"><a href="#local-6989586621685213430"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621685213431"><a href="#local-6989586621685213431"><span class="hs-identifier">mods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1741"></a><span>  </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><a href="#local-6989586621685213429"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1742"></a><span>     </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Re-typechecking loop: &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685213431"><span class="hs-identifier hs-var">mods</span></a><span>
</span><a name="line-1743"></a><span>  </span><a name="local-6989586621685213440"><a href="#local-6989586621685213440"><span class="hs-identifier">new_hpt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-1744"></a><span>    </span><span class="hs-identifier hs-var">fixIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685213434"><a href="#local-6989586621685213434"><span class="hs-identifier">new_hpt</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1745"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213435"><a href="#local-6989586621685213435"><span class="hs-identifier">new_hsc_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213430"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_HPT</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213434"><span class="hs-identifier hs-var">new_hpt</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1746"></a><span>      </span><a name="local-6989586621685213436"><a href="#local-6989586621685213436"><span class="hs-identifier">mds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#initIfaceCheck"><span class="hs-identifier hs-var">initIfaceCheck</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;typecheckLoop&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213435"><span class="hs-identifier hs-var">new_hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1747"></a><span>                </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="TcIface.html#typecheckIface"><span class="hs-identifier hs-var">typecheckIface</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">hm_iface</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213433"><span class="hs-identifier hs-var">hmis</span></a><span>
</span><a name="line-1748"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213437"><a href="#local-6989586621685213437"><span class="hs-identifier">new_hpt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addListToHpt</span><span> </span><a href="#local-6989586621685213432"><span class="hs-identifier hs-var">old_hpt</span></a><span>
</span><a name="line-1749"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621685213431"><span class="hs-identifier hs-var">mods</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621685213438"><span class="hs-identifier hs-var">hmi</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">hm_details</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213439"><span class="hs-identifier hs-var">details</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1750"></a><span>                                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685213438"><a href="#local-6989586621685213438"><span class="hs-identifier">hmi</span></a></a><span class="hs-special">,</span><a name="local-6989586621685213439"><a href="#local-6989586621685213439"><span class="hs-identifier">details</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621685213433"><span class="hs-identifier hs-var">hmis</span></a><span> </span><a href="#local-6989586621685213436"><span class="hs-identifier hs-var">mds</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1751"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685213437"><span class="hs-identifier hs-var">new_hpt</span></a><span>
</span><a name="line-1752"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685213430"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_HPT</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213440"><span class="hs-identifier hs-var">new_hpt</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1753"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1754"></a><span>    </span><a name="local-6989586621685213432"><a href="#local-6989586621685213432"><span class="hs-identifier">old_hpt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_HPT</span><span> </span><a href="#local-6989586621685213430"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1755"></a><span>    </span><a name="local-6989586621685213433"><a href="#local-6989586621685213433"><span class="hs-identifier">hmis</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">expectJust</span><span> </span><span class="hs-string">&quot;typecheckLoop&quot;</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">lookupHpt</span><span> </span><a href="#local-6989586621685213432"><span class="hs-identifier hs-var">old_hpt</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213431"><span class="hs-identifier hs-var">mods</span></a><span>
</span><a name="line-1756"></a><span>
</span><a name="line-1757"></a><span class="hs-identifier">reachableBackwards</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span>
</span><a name="line-1758"></a><a name="reachableBackwards"><a href="GhcMake.html#reachableBackwards"><span class="hs-identifier">reachableBackwards</span></a></a><span> </span><a name="local-6989586621685213441"><a href="#local-6989586621685213441"><span class="hs-identifier">mod</span></a></a><span> </span><a name="local-6989586621685213442"><a href="#local-6989586621685213442"><span class="hs-identifier">summaries</span></a></a><span>
</span><a name="line-1759"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">node_payload</span><span> </span><a href="#local-6989586621685213446"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621685213446"><a href="#local-6989586621685213446"><span class="hs-identifier">node</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">reachableG</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">transposeG</span><span> </span><a href="#local-6989586621685213443"><span class="hs-identifier hs-var">graph</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213445"><span class="hs-identifier hs-var">root</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1760"></a><span>  </span><span class="hs-keyword">where</span><span> </span><span class="hs-comment">-- the rest just sets up the graph:</span><span>
</span><a name="line-1761"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621685213443"><a href="#local-6989586621685213443"><span class="hs-identifier">graph</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685213444"><a href="#local-6989586621685213444"><span class="hs-identifier">lookup_node</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="GhcMake.html#moduleGraphNodes"><span class="hs-identifier hs-var">moduleGraphNodes</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621685213442"><span class="hs-identifier hs-var">summaries</span></a><span>
</span><a name="line-1762"></a><span>        </span><a name="local-6989586621685213445"><a href="#local-6989586621685213445"><span class="hs-identifier">root</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">expectJust</span><span> </span><span class="hs-string">&quot;reachableBackwards&quot;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213444"><span class="hs-identifier hs-var">lookup_node</span></a><span> </span><span class="hs-identifier hs-var">HsBootFile</span><span> </span><a href="#local-6989586621685213441"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-1763"></a><span>
</span><a name="line-1764"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-1765"></a><span class="hs-comment">--</span><span>
</span><a name="line-1766"></a><span class="hs-comment">-- | Topological sort of the module graph</span><span>
</span><a name="line-1767"></a><span class="hs-identifier">topSortModuleGraph</span><span>
</span><a name="line-1768"></a><span>          </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1769"></a><span>          </span><span class="hs-comment">-- ^ Drop hi-boot nodes? (see below)</span><span>
</span><a name="line-1770"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModuleGraph</span><span>
</span><a name="line-1771"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span>
</span><a name="line-1772"></a><span>             </span><span class="hs-comment">-- ^ Root module name.  If @Nothing@, use the full graph.</span><span>
</span><a name="line-1773"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SCC</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span>
</span><a name="line-1774"></a><span class="hs-comment">-- ^ Calculate SCCs of the module graph, possibly dropping the hi-boot nodes</span><span>
</span><a name="line-1775"></a><span class="hs-comment">-- The resulting list of strongly-connected-components is in topologically</span><span>
</span><a name="line-1776"></a><span class="hs-comment">-- sorted order, starting with the module(s) at the bottom of the</span><span>
</span><a name="line-1777"></a><span class="hs-comment">-- dependency graph (ie compile them first) and ending with the ones at</span><span>
</span><a name="line-1778"></a><span class="hs-comment">-- the top.</span><span>
</span><a name="line-1779"></a><span class="hs-comment">--</span><span>
</span><a name="line-1780"></a><span class="hs-comment">-- Drop hi-boot nodes (first boolean arg)?</span><span>
</span><a name="line-1781"></a><span class="hs-comment">--</span><span>
</span><a name="line-1782"></a><span class="hs-comment">-- - @False@:   treat the hi-boot summaries as nodes of the graph,</span><span>
</span><a name="line-1783"></a><span class="hs-comment">--              so the graph must be acyclic</span><span>
</span><a name="line-1784"></a><span class="hs-comment">--</span><span>
</span><a name="line-1785"></a><span class="hs-comment">-- - @True@:    eliminate the hi-boot nodes, and instead pretend</span><span>
</span><a name="line-1786"></a><span class="hs-comment">--              the a source-import of Foo is an import of Foo</span><span>
</span><a name="line-1787"></a><span class="hs-comment">--              The resulting graph has no hi-boot nodes, but can be cyclic</span><span>
</span><a name="line-1788"></a><span>
</span><a name="line-1789"></a><a name="topSortModuleGraph"><a href="GhcMake.html#topSortModuleGraph"><span class="hs-identifier">topSortModuleGraph</span></a></a><span> </span><a name="local-6989586621685213447"><a href="#local-6989586621685213447"><span class="hs-identifier">drop_hs_boot_nodes</span></a></a><span> </span><a name="local-6989586621685213448"><a href="#local-6989586621685213448"><span class="hs-identifier">module_graph</span></a></a><span> </span><a name="local-6989586621685213449"><a href="#local-6989586621685213449"><span class="hs-identifier">mb_root_mod</span></a></a><span>
</span><a name="line-1790"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="GhcMake.html#summaryNodeSummary"><span class="hs-identifier hs-var">summaryNodeSummary</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">stronglyConnCompG</span><span> </span><a href="#local-6989586621685213453"><span class="hs-identifier hs-var">initial_graph</span></a><span>
</span><a name="line-1791"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1792"></a><span>    </span><a name="local-6989586621685213450"><a href="#local-6989586621685213450"><span class="hs-identifier">summaries</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mgModSummaries</span><span> </span><a href="#local-6989586621685213448"><span class="hs-identifier hs-var">module_graph</span></a><span>
</span><a name="line-1793"></a><span>    </span><span class="hs-comment">-- stronglyConnCompG flips the original order, so if we reverse</span><span>
</span><a name="line-1794"></a><span>    </span><span class="hs-comment">-- the summaries we get a stable topological sort.</span><span>
</span><a name="line-1795"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621685213451"><a href="#local-6989586621685213451"><span class="hs-identifier">graph</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685213452"><a href="#local-6989586621685213452"><span class="hs-identifier">lookup_node</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1796"></a><span>      </span><a href="GhcMake.html#moduleGraphNodes"><span class="hs-identifier hs-var">moduleGraphNodes</span></a><span> </span><a href="#local-6989586621685213447"><span class="hs-identifier hs-var">drop_hs_boot_nodes</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621685213450"><span class="hs-identifier hs-var">summaries</span></a><span class="hs-special">)</span><span>
</span><a name="line-1797"></a><span>
</span><a name="line-1798"></a><span>    </span><a name="local-6989586621685213453"><a href="#local-6989586621685213453"><span class="hs-identifier">initial_graph</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685213449"><span class="hs-identifier hs-var">mb_root_mod</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1799"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685213451"><span class="hs-identifier hs-var">graph</span></a><span>
</span><a name="line-1800"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213454"><a href="#local-6989586621685213454"><span class="hs-identifier">root_mod</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1801"></a><span>            </span><span class="hs-comment">-- restrict the graph to just those modules reachable from</span><span>
</span><a name="line-1802"></a><span>            </span><span class="hs-comment">-- the specified module.  We do this by building a graph with</span><span>
</span><a name="line-1803"></a><span>            </span><span class="hs-comment">-- the full set of nodes, and determining the reachable set from</span><span>
</span><a name="line-1804"></a><span>            </span><span class="hs-comment">-- the specified node.</span><span>
</span><a name="line-1805"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213455"><a href="#local-6989586621685213455"><span class="hs-identifier">root</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213456"><a href="#local-6989586621685213456"><span class="hs-identifier">node</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213452"><span class="hs-identifier hs-var">lookup_node</span></a><span> </span><span class="hs-identifier hs-var">HsSrcFile</span><span> </span><a href="#local-6989586621685213454"><span class="hs-identifier hs-var">root_mod</span></a><span>
</span><a name="line-1806"></a><span>                     </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685213451"><span class="hs-identifier hs-var">graph</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasVertexG</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685213456"><span class="hs-identifier hs-var">node</span></a><span>
</span><a name="line-1807"></a><span>                     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213456"><span class="hs-identifier hs-var">node</span></a><span>
</span><a name="line-1808"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1809"></a><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">throwGhcException</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ProgramError</span><span> </span><span class="hs-string">&quot;module does not exist&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1810"></a><span>            </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">graphFromEdgedVerticesUniq</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">seq</span><span> </span><a href="#local-6989586621685213455"><span class="hs-identifier hs-var">root</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reachableG</span><span> </span><a href="#local-6989586621685213451"><span class="hs-identifier hs-var">graph</span></a><span> </span><a href="#local-6989586621685213455"><span class="hs-identifier hs-var">root</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1811"></a><span>
</span><a name="line-1812"></a><span class="hs-keyword">type</span><span> </span><a name="SummaryNode"><a href="GhcMake.html#SummaryNode"><span class="hs-identifier">SummaryNode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Node</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span>
</span><a name="line-1813"></a><span>
</span><a name="line-1814"></a><span class="hs-identifier">summaryNodeKey</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GhcMake.html#SummaryNode"><span class="hs-identifier hs-type">SummaryNode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1815"></a><a name="summaryNodeKey"><a href="GhcMake.html#summaryNodeKey"><span class="hs-identifier">summaryNodeKey</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">node_key</span><span>
</span><a name="line-1816"></a><span>
</span><a name="line-1817"></a><span class="hs-identifier">summaryNodeSummary</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GhcMake.html#SummaryNode"><span class="hs-identifier hs-type">SummaryNode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span>
</span><a name="line-1818"></a><a name="summaryNodeSummary"><a href="GhcMake.html#summaryNodeSummary"><span class="hs-identifier">summaryNodeSummary</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">node_payload</span><span>
</span><a name="line-1819"></a><span>
</span><a name="line-1820"></a><span class="hs-identifier">moduleGraphNodes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span>
</span><a name="line-1821"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Graph</span><span> </span><a href="GhcMake.html#SummaryNode"><span class="hs-identifier hs-type">SummaryNode</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HscSource</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="GhcMake.html#SummaryNode"><span class="hs-identifier hs-type">SummaryNode</span></a><span class="hs-special">)</span><span>
</span><a name="line-1822"></a><a name="moduleGraphNodes"><a href="GhcMake.html#moduleGraphNodes"><span class="hs-identifier">moduleGraphNodes</span></a></a><span> </span><a name="local-6989586621685213457"><a href="#local-6989586621685213457"><span class="hs-identifier">drop_hs_boot_nodes</span></a></a><span> </span><a name="local-6989586621685213458"><a href="#local-6989586621685213458"><span class="hs-identifier">summaries</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1823"></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">graphFromEdgedVerticesUniq</span><span> </span><a href="#local-6989586621685213463"><span class="hs-identifier hs-var">nodes</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685213460"><span class="hs-identifier hs-var">lookup_node</span></a><span class="hs-special">)</span><span>
</span><a name="line-1824"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1825"></a><span>    </span><a name="local-6989586621685213459"><a href="#local-6989586621685213459"><span class="hs-identifier">numbered_summaries</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621685213458"><span class="hs-identifier hs-var">summaries</span></a><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><a name="line-1826"></a><span>
</span><a name="line-1827"></a><span>    </span><span class="hs-identifier">lookup_node</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscSource</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="GhcMake.html#SummaryNode"><span class="hs-identifier hs-type">SummaryNode</span></a><span>
</span><a name="line-1828"></a><span>    </span><a name="local-6989586621685213460"><a href="#local-6989586621685213460"><span class="hs-identifier">lookup_node</span></a></a><span> </span><a name="local-6989586621685213466"><a href="#local-6989586621685213466"><span class="hs-identifier">hs_src</span></a></a><span> </span><a name="local-6989586621685213467"><a href="#local-6989586621685213467"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213467"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">,</span><span> </span><a href="GhcMake.html#hscSourceToIsBoot"><span class="hs-identifier hs-var">hscSourceToIsBoot</span></a><span> </span><a href="#local-6989586621685213466"><span class="hs-identifier hs-var">hs_src</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213462"><span class="hs-identifier hs-var">node_map</span></a><span>
</span><a name="line-1829"></a><span>
</span><a name="line-1830"></a><span>    </span><span class="hs-identifier">lookup_key</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscSource</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1831"></a><span>    </span><a name="local-6989586621685213461"><a href="#local-6989586621685213461"><span class="hs-identifier">lookup_key</span></a></a><span> </span><a name="local-6989586621685213468"><a href="#local-6989586621685213468"><span class="hs-identifier">hs_src</span></a></a><span> </span><a name="local-6989586621685213469"><a href="#local-6989586621685213469"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="GhcMake.html#summaryNodeKey"><span class="hs-identifier hs-var">summaryNodeKey</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213460"><span class="hs-identifier hs-var">lookup_node</span></a><span> </span><a href="#local-6989586621685213468"><span class="hs-identifier hs-var">hs_src</span></a><span> </span><a href="#local-6989586621685213469"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-1832"></a><span>
</span><a name="line-1833"></a><span>    </span><span class="hs-identifier">node_map</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GhcMake.html#NodeMap"><span class="hs-identifier hs-type">NodeMap</span></a><span> </span><a href="GhcMake.html#SummaryNode"><span class="hs-identifier hs-type">SummaryNode</span></a><span>
</span><a name="line-1834"></a><span>    </span><a name="local-6989586621685213462"><a href="#local-6989586621685213462"><span class="hs-identifier">node_map</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ms_mod</span><span> </span><a href="#local-6989586621685213471"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1835"></a><span>                                </span><a href="GhcMake.html#hscSourceToIsBoot"><span class="hs-identifier hs-var">hscSourceToIsBoot</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ms_hsc_src</span><span> </span><a href="#local-6989586621685213471"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685213470"><span class="hs-identifier hs-var">node</span></a><span class="hs-special">)</span><span>
</span><a name="line-1836"></a><span>                            </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621685213470"><a href="#local-6989586621685213470"><span class="hs-identifier">node</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213463"><span class="hs-identifier hs-var">nodes</span></a><span>
</span><a name="line-1837"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213471"><a href="#local-6989586621685213471"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GhcMake.html#summaryNodeSummary"><span class="hs-identifier hs-var">summaryNodeSummary</span></a><span> </span><a href="#local-6989586621685213470"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1838"></a><span>
</span><a name="line-1839"></a><span>    </span><span class="hs-comment">-- We use integers as the keys for the SCC algorithm</span><span>
</span><a name="line-1840"></a><span>    </span><span class="hs-identifier">nodes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="GhcMake.html#SummaryNode"><span class="hs-identifier hs-type">SummaryNode</span></a><span class="hs-special">]</span><span>
</span><a name="line-1841"></a><span>    </span><a name="local-6989586621685213463"><a href="#local-6989586621685213463"><span class="hs-identifier">nodes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">DigraphNode</span><span> </span><a href="#local-6989586621685213472"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621685213473"><span class="hs-identifier hs-var">key</span></a><span> </span><a href="#local-6989586621685213474"><span class="hs-identifier hs-var">out_keys</span></a><span>
</span><a name="line-1842"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685213472"><a href="#local-6989586621685213472"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685213473"><a href="#local-6989586621685213473"><span class="hs-identifier">key</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213459"><span class="hs-identifier hs-var">numbered_summaries</span></a><span>
</span><a name="line-1843"></a><span>             </span><span class="hs-comment">-- Drop the hi-boot ones if told to do so</span><span>
</span><a name="line-1844"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isBootSummary</span><span> </span><a href="#local-6989586621685213472"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621685213457"><span class="hs-identifier hs-var">drop_hs_boot_nodes</span></a><span class="hs-special">)</span><span>
</span><a name="line-1845"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213474"><a href="#local-6989586621685213474"><span class="hs-identifier">out_keys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213465"><span class="hs-identifier hs-var">out_edge_keys</span></a><span> </span><a href="#local-6989586621685213464"><span class="hs-identifier hs-var">hs_boot_key</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-special">(</span><a href="GhcMake.html#ms_home_srcimps"><span class="hs-identifier hs-var">ms_home_srcimps</span></a><span> </span><a href="#local-6989586621685213472"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1846"></a><span>                             </span><a href="#local-6989586621685213465"><span class="hs-identifier hs-var">out_edge_keys</span></a><span> </span><span class="hs-identifier hs-var">HsSrcFile</span><span>   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-special">(</span><a href="GhcMake.html#ms_home_imps"><span class="hs-identifier hs-var">ms_home_imps</span></a><span> </span><a href="#local-6989586621685213472"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1847"></a><span>                             </span><span class="hs-special">(</span><span class="hs-comment">-- see [boot-edges] below</span><span>
</span><a name="line-1848"></a><span>                              </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621685213457"><span class="hs-identifier hs-var">drop_hs_boot_nodes</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier">ms_hsc_src</span><span> </span><a href="#local-6989586621685213472"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">HsBootFile</span><span>
</span><a name="line-1849"></a><span>                              </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1850"></a><span>                              </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685213461"><span class="hs-identifier hs-var">lookup_key</span></a><span> </span><span class="hs-identifier hs-var">HsBootFile</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ms_mod_name</span><span> </span><a href="#local-6989586621685213472"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1851"></a><span>                                    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1852"></a><span>                                    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213475"><a href="#local-6989586621685213475"><span class="hs-identifier">k</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621685213475"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1853"></a><span>
</span><a name="line-1854"></a><span>    </span><span class="hs-comment">-- [boot-edges] if this is a .hs and there is an equivalent</span><span>
</span><a name="line-1855"></a><span>    </span><span class="hs-comment">-- .hs-boot, add a link from the former to the latter.  This</span><span>
</span><a name="line-1856"></a><span>    </span><span class="hs-comment">-- has the effect of detecting bogus cases where the .hs-boot</span><span>
</span><a name="line-1857"></a><span>    </span><span class="hs-comment">-- depends on the .hs, by introducing a cycle.  Additionally,</span><span>
</span><a name="line-1858"></a><span>    </span><span class="hs-comment">-- it ensures that we will always process the .hs-boot before</span><span>
</span><a name="line-1859"></a><span>    </span><span class="hs-comment">-- the .hs, and so the HomePackageTable will always have the</span><span>
</span><a name="line-1860"></a><span>    </span><span class="hs-comment">-- most up to date information.</span><span>
</span><a name="line-1861"></a><span>
</span><a name="line-1862"></a><span>    </span><span class="hs-comment">-- Drop hs-boot nodes by using HsSrcFile as the key</span><span>
</span><a name="line-1863"></a><span>    </span><a name="local-6989586621685213464"><a href="#local-6989586621685213464"><span class="hs-identifier">hs_boot_key</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685213457"><span class="hs-identifier hs-var">drop_hs_boot_nodes</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HsSrcFile</span><span>
</span><a name="line-1864"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HsBootFile</span><span>
</span><a name="line-1865"></a><span>
</span><a name="line-1866"></a><span>    </span><span class="hs-identifier">out_edge_keys</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscSource</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ModuleName</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">]</span><span>
</span><a name="line-1867"></a><span>    </span><a name="local-6989586621685213465"><a href="#local-6989586621685213465"><span class="hs-identifier">out_edge_keys</span></a></a><span> </span><a name="local-6989586621685213476"><a href="#local-6989586621685213476"><span class="hs-identifier">hi_boot</span></a></a><span> </span><a name="local-6989586621685213477"><a href="#local-6989586621685213477"><span class="hs-identifier">ms</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213461"><span class="hs-identifier hs-var">lookup_key</span></a><span> </span><a href="#local-6989586621685213476"><span class="hs-identifier hs-var">hi_boot</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213477"><span class="hs-identifier hs-var">ms</span></a><span>
</span><a name="line-1868"></a><span>        </span><span class="hs-comment">-- If we want keep_hi_boot_nodes, then we do lookup_key with</span><span>
</span><a name="line-1869"></a><span>        </span><span class="hs-comment">-- IsBoot; else NotBoot</span><span>
</span><a name="line-1870"></a><span>
</span><a name="line-1871"></a><span class="hs-comment">-- The nodes of the graph are keyed by (mod, is boot?) pairs</span><span>
</span><a name="line-1872"></a><span class="hs-comment">-- NB: hsig files show up as *normal* nodes (not boot!), since they don't</span><span>
</span><a name="line-1873"></a><span class="hs-comment">-- participate in cycles (for now)</span><span>
</span><a name="line-1874"></a><span class="hs-keyword">type</span><span> </span><a name="NodeKey"><a href="GhcMake.html#NodeKey"><span class="hs-identifier">NodeKey</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ModuleName</span><span class="hs-special">,</span><span> </span><a href="GhcMake.html#IsBoot"><span class="hs-identifier hs-type">IsBoot</span></a><span class="hs-special">)</span><span>
</span><a name="line-1875"></a><span class="hs-keyword">type</span><span> </span><a name="NodeMap"><a href="GhcMake.html#NodeMap"><span class="hs-identifier">NodeMap</span></a></a><span> </span><a name="local-6989586621685212964"><a href="#local-6989586621685212964"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Map.Map</span><span> </span><a href="GhcMake.html#NodeKey"><span class="hs-identifier hs-type">NodeKey</span></a><span> </span><a href="#local-6989586621685212964"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1876"></a><span>
</span><a name="line-1877"></a><span class="hs-identifier">msKey</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GhcMake.html#NodeKey"><span class="hs-identifier hs-type">NodeKey</span></a><span>
</span><a name="line-1878"></a><a name="msKey"><a href="GhcMake.html#msKey"><span class="hs-identifier">msKey</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ModSummary</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ms_mod</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685213478"><a href="#local-6989586621685213478"><span class="hs-identifier">mod</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ms_hsc_src</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685213479"><a href="#local-6989586621685213479"><span class="hs-identifier">boot</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1879"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621685213478"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">,</span><span> </span><a href="GhcMake.html#hscSourceToIsBoot"><span class="hs-identifier hs-var">hscSourceToIsBoot</span></a><span> </span><a href="#local-6989586621685213479"><span class="hs-identifier hs-var">boot</span></a><span class="hs-special">)</span><span>
</span><a name="line-1880"></a><span>
</span><a name="line-1881"></a><span class="hs-identifier">mkNodeMap</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GhcMake.html#NodeMap"><span class="hs-identifier hs-type">NodeMap</span></a><span> </span><span class="hs-identifier hs-type">ModSummary</span><span>
</span><a name="line-1882"></a><a name="mkNodeMap"><a href="GhcMake.html#mkNodeMap"><span class="hs-identifier">mkNodeMap</span></a></a><span> </span><a name="local-6989586621685213480"><a href="#local-6989586621685213480"><span class="hs-identifier">summaries</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="GhcMake.html#msKey"><span class="hs-identifier hs-var">msKey</span></a><span> </span><a href="#local-6989586621685213481"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685213481"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621685213481"><a href="#local-6989586621685213481"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213480"><span class="hs-identifier hs-var">summaries</span></a><span class="hs-special">]</span><span>
</span><a name="line-1883"></a><span>
</span><a name="line-1884"></a><span class="hs-identifier">nodeMapElts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GhcMake.html#NodeMap"><span class="hs-identifier hs-type">NodeMap</span></a><span> </span><a href="#local-6989586621685212970"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621685212970"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-1885"></a><a name="nodeMapElts"><a href="GhcMake.html#nodeMapElts"><span class="hs-identifier">nodeMapElts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.elems</span><span>
</span><a name="line-1886"></a><span>
</span><a name="line-1887"></a><span class="hs-comment">-- | If there are {-# SOURCE #-} imports between strongly connected</span><span>
</span><a name="line-1888"></a><span class="hs-comment">-- components in the topological sort, then those imports can</span><span>
</span><a name="line-1889"></a><span class="hs-comment">-- definitely be replaced by ordinary non-SOURCE imports: if SOURCE</span><span>
</span><a name="line-1890"></a><span class="hs-comment">-- were necessary, then the edge would be part of a cycle.</span><span>
</span><a name="line-1891"></a><span class="hs-identifier">warnUnnecessarySourceImports</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcMonad</span><span> </span><a href="#local-6989586621685212969"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SCC</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685212969"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1892"></a><a name="warnUnnecessarySourceImports"><a href="GhcMake.html#warnUnnecessarySourceImports"><span class="hs-identifier">warnUnnecessarySourceImports</span></a></a><span> </span><a name="local-6989586621685213482"><a href="#local-6989586621685213482"><span class="hs-identifier">sccs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1893"></a><span>  </span><a name="local-6989586621685213493"><a href="#local-6989586621685213493"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1894"></a><span>  </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wopt</span><span> </span><span class="hs-identifier hs-var">Opt_WarnUnusedImports</span><span> </span><a href="#local-6989586621685213493"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1895"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">logWarnings</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">listToBag</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213483"><span class="hs-identifier hs-var">check</span></a><span> </span><a href="#local-6989586621685213493"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">flattenSCC</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213482"><span class="hs-identifier hs-var">sccs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1896"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621685213483"><a href="#local-6989586621685213483"><span class="hs-identifier">check</span></a></a><span> </span><a name="local-6989586621685213485"><a href="#local-6989586621685213485"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685213486"><a href="#local-6989586621685213486"><span class="hs-identifier">ms</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1897"></a><span>           </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213487"><a href="#local-6989586621685213487"><span class="hs-identifier">mods_in_this_cycle</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ms_mod_name</span><span> </span><a href="#local-6989586621685213486"><span class="hs-identifier hs-var">ms</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-1898"></a><span>           </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621685213484"><span class="hs-identifier hs-var">warn</span></a><span> </span><a href="#local-6989586621685213485"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685213489"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621685213488"><a href="#local-6989586621685213488"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213486"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685213489"><a href="#local-6989586621685213489"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GhcMake.html#ms_home_srcimps"><span class="hs-identifier hs-var">ms_home_srcimps</span></a><span> </span><a href="#local-6989586621685213488"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">,</span><span>
</span><a name="line-1899"></a><span>                             </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621685213489"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">notElem</span><span class="hs-special">`</span><span>  </span><a href="#local-6989586621685213487"><span class="hs-identifier hs-var">mods_in_this_cycle</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1900"></a><span>
</span><a name="line-1901"></a><span>        </span><span class="hs-identifier">warn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">WarnMsg</span><span>
</span><a name="line-1902"></a><span>        </span><a name="local-6989586621685213484"><a href="#local-6989586621685213484"><span class="hs-identifier">warn</span></a></a><span> </span><a name="local-6989586621685213490"><a href="#local-6989586621685213490"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621685213491"><a href="#local-6989586621685213491"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621685213492"><a href="#local-6989586621685213492"><span class="hs-identifier">mod</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1903"></a><span>           </span><span class="hs-identifier hs-var">mkPlainErrMsg</span><span> </span><a href="#local-6989586621685213490"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685213491"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-1904"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Warning: {-# SOURCE #-} unnecessary in import of &quot;</span><span>
</span><a name="line-1905"></a><span>                 </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685213492"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1906"></a><span>
</span><a name="line-1907"></a><span>
</span><a name="line-1908"></a><span class="hs-identifier">reportImportErrors</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621685212967"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">ErrMsg</span><span> </span><a href="#local-6989586621685212968"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685212967"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621685212968"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span>
</span><a name="line-1909"></a><a name="reportImportErrors"><a href="GhcMake.html#reportImportErrors"><span class="hs-identifier">reportImportErrors</span></a></a><span> </span><a name="local-6989586621685213494"><a href="#local-6989586621685213494"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621685213495"><span class="hs-identifier hs-var">errs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685213496"><span class="hs-identifier hs-var">oks</span></a><span>
</span><a name="line-1910"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="GhcMake.html#throwManyErrors"><span class="hs-identifier hs-var">throwManyErrors</span></a><span> </span><a href="#local-6989586621685213495"><span class="hs-identifier hs-var">errs</span></a><span>
</span><a name="line-1911"></a><span>  </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685213495"><a href="#local-6989586621685213495"><span class="hs-identifier">errs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685213496"><a href="#local-6989586621685213496"><span class="hs-identifier">oks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partitionEithers</span><span> </span><a href="#local-6989586621685213494"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-1912"></a><span>
</span><a name="line-1913"></a><span class="hs-identifier">throwManyErrors</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621685212965"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ErrMsg</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685212965"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621685212966"><span class="hs-identifier hs-type">ab</span></a><span>
</span><a name="line-1914"></a><a name="throwManyErrors"><a href="GhcMake.html#throwManyErrors"><span class="hs-identifier">throwManyErrors</span></a></a><span> </span><a name="local-6989586621685213497"><a href="#local-6989586621685213497"><span class="hs-identifier">errs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkSrcErr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">listToBag</span><span> </span><a href="#local-6989586621685213497"><span class="hs-identifier hs-var">errs</span></a><span>
</span><a name="line-1915"></a><span>
</span><a name="line-1916"></a><span>
</span><a name="line-1917"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-1918"></a><span class="hs-comment">--</span><span>
</span><a name="line-1919"></a><span class="hs-comment">-- | Downsweep (dependency analysis)</span><span>
</span><a name="line-1920"></a><span class="hs-comment">--</span><span>
</span><a name="line-1921"></a><span class="hs-comment">-- Chase downwards from the specified root set, returning summaries</span><span>
</span><a name="line-1922"></a><span class="hs-comment">-- for all home modules encountered.  Only follow source-import</span><span>
</span><a name="line-1923"></a><span class="hs-comment">-- links.</span><span>
</span><a name="line-1924"></a><span class="hs-comment">--</span><span>
</span><a name="line-1925"></a><span class="hs-comment">-- We pass in the previous collection of summaries, which is used as a</span><span>
</span><a name="line-1926"></a><span class="hs-comment">-- cache to avoid recalculating a module summary if the source is</span><span>
</span><a name="line-1927"></a><span class="hs-comment">-- unchanged.</span><span>
</span><a name="line-1928"></a><span class="hs-comment">--</span><span>
</span><a name="line-1929"></a><span class="hs-comment">-- The returned list of [ModSummary] nodes has one node for each home-package</span><span>
</span><a name="line-1930"></a><span class="hs-comment">-- module, plus one for any hs-boot files.  The imports of these nodes</span><span>
</span><a name="line-1931"></a><span class="hs-comment">-- are all there, including the imports of non-home-package modules.</span><span>
</span><a name="line-1932"></a><span class="hs-identifier">downsweep</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-1933"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- Old summaries</span><span>
</span><a name="line-1934"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ModuleName</span><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- Ignore dependencies on these; treat</span><span>
</span><a name="line-1935"></a><span>                                </span><span class="hs-comment">-- them as if they were package modules</span><span>
</span><a name="line-1936"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>               </span><span class="hs-comment">-- True &lt;=&gt; allow multiple targets to have</span><span>
</span><a name="line-1937"></a><span>                                </span><span class="hs-comment">--          the same module name; this is</span><span>
</span><a name="line-1938"></a><span>                                </span><span class="hs-comment">--          very useful for ghc -M</span><span>
</span><a name="line-1939"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">ErrMsg</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span>
</span><a name="line-1940"></a><span>                </span><span class="hs-comment">-- The elts of [ModSummary] all have distinct</span><span>
</span><a name="line-1941"></a><span>                </span><span class="hs-comment">-- (Modules, IsBoot) identifiers, unless the Bool is true</span><span>
</span><a name="line-1942"></a><span>                </span><span class="hs-comment">-- in which case there can be repeats</span><span>
</span><a name="line-1943"></a><a name="downsweep"><a href="GhcMake.html#downsweep"><span class="hs-identifier">downsweep</span></a></a><span> </span><a name="local-6989586621685213498"><a href="#local-6989586621685213498"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621685213499"><a href="#local-6989586621685213499"><span class="hs-identifier">old_summaries</span></a></a><span> </span><a name="local-6989586621685213500"><a href="#local-6989586621685213500"><span class="hs-identifier">excl_mods</span></a></a><span> </span><a name="local-6989586621685213501"><a href="#local-6989586621685213501"><span class="hs-identifier">allow_dup_roots</span></a></a><span>
</span><a name="line-1944"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1945"></a><span>       </span><a name="local-6989586621685213533"><a href="#local-6989586621685213533"><span class="hs-identifier">rootSummaries</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621685213506"><span class="hs-identifier hs-var">getRootSummary</span></a><span> </span><a href="#local-6989586621685213504"><span class="hs-identifier hs-var">roots</span></a><span>
</span><a name="line-1946"></a><span>       </span><a name="local-6989586621685213534"><a href="#local-6989586621685213534"><span class="hs-identifier">rootSummariesOk</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GhcMake.html#reportImportErrors"><span class="hs-identifier hs-var">reportImportErrors</span></a><span> </span><a href="#local-6989586621685213533"><span class="hs-identifier hs-var">rootSummaries</span></a><span>
</span><a name="line-1947"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213535"><a href="#local-6989586621685213535"><span class="hs-identifier">root_map</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GhcMake.html#mkRootMap"><span class="hs-identifier hs-var">mkRootMap</span></a><span> </span><a href="#local-6989586621685213534"><span class="hs-identifier hs-var">rootSummariesOk</span></a><span>
</span><a name="line-1948"></a><span>       </span><a href="#local-6989586621685213508"><span class="hs-identifier hs-var">checkDuplicates</span></a><span> </span><a href="#local-6989586621685213535"><span class="hs-identifier hs-var">root_map</span></a><span>
</span><a name="line-1949"></a><span>       </span><a name="local-6989586621685213536"><a href="#local-6989586621685213536"><span class="hs-identifier">map0</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213509"><span class="hs-identifier hs-var">loop</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="#local-6989586621685213502"><span class="hs-identifier hs-var">calcDeps</span></a><span> </span><a href="#local-6989586621685213534"><span class="hs-identifier hs-var">rootSummariesOk</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213535"><span class="hs-identifier hs-var">root_map</span></a><span>
</span><a name="line-1950"></a><span>       </span><span class="hs-comment">-- if we have been passed -fno-code, we enable code generation</span><span>
</span><a name="line-1951"></a><span>       </span><span class="hs-comment">-- for dependencies of modules that have -XTemplateHaskell,</span><span>
</span><a name="line-1952"></a><span>       </span><span class="hs-comment">-- otherwise those modules will fail to compile.</span><span>
</span><a name="line-1953"></a><span>       </span><span class="hs-comment">-- See Note [-fno-code mode] #8025</span><span>
</span><a name="line-1954"></a><span>       </span><a name="local-6989586621685213537"><a href="#local-6989586621685213537"><span class="hs-identifier">map1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">hscTarget</span><span> </span><a href="#local-6989586621685213503"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">HscNothing</span><span>
</span><a name="line-1955"></a><span>         </span><span class="hs-keyword">then</span><span> </span><a href="GhcMake.html#enableCodeGenForTH"><span class="hs-identifier hs-var">enableCodeGenForTH</span></a><span>
</span><a name="line-1956"></a><span>           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">defaultObjectTarget</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621685213503"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1957"></a><span>           </span><a href="#local-6989586621685213536"><span class="hs-identifier hs-var">map0</span></a><span>
</span><a name="line-1958"></a><span>         </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685213536"><span class="hs-identifier hs-var">map0</span></a><span>
</span><a name="line-1959"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GhcMake.html#nodeMapElts"><span class="hs-identifier hs-var">nodeMapElts</span></a><span> </span><a href="#local-6989586621685213537"><span class="hs-identifier hs-var">map1</span></a><span>
</span><a name="line-1960"></a><span>     </span><span class="hs-keyword">where</span><span>
</span><a name="line-1961"></a><span>        </span><a name="local-6989586621685213502"><a href="#local-6989586621685213502"><span class="hs-identifier">calcDeps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GhcMake.html#msDeps"><span class="hs-identifier hs-var">msDeps</span></a><span>
</span><a name="line-1962"></a><span>
</span><a name="line-1963"></a><span>        </span><a name="local-6989586621685213503"><a href="#local-6989586621685213503"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685213498"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1964"></a><span>        </span><a name="local-6989586621685213504"><a href="#local-6989586621685213504"><span class="hs-identifier">roots</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_targets</span><span> </span><a href="#local-6989586621685213498"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1965"></a><span>
</span><a name="line-1966"></a><span>        </span><span class="hs-identifier">old_summary_map</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GhcMake.html#NodeMap"><span class="hs-identifier hs-type">NodeMap</span></a><span> </span><span class="hs-identifier hs-type">ModSummary</span><span>
</span><a name="line-1967"></a><span>        </span><a name="local-6989586621685213505"><a href="#local-6989586621685213505"><span class="hs-identifier">old_summary_map</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GhcMake.html#mkNodeMap"><span class="hs-identifier hs-var">mkNodeMap</span></a><span> </span><a href="#local-6989586621685213499"><span class="hs-identifier hs-var">old_summaries</span></a><span>
</span><a name="line-1968"></a><span>
</span><a name="line-1969"></a><span>        </span><span class="hs-identifier">getRootSummary</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Target</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">ErrMsg</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">)</span><span>
</span><a name="line-1970"></a><span>        </span><a name="local-6989586621685213506"><a href="#local-6989586621685213506"><span class="hs-identifier">getRootSummary</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Target</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TargetFile</span><span> </span><a name="local-6989586621685213510"><a href="#local-6989586621685213510"><span class="hs-identifier">file</span></a></a><span> </span><a name="local-6989586621685213511"><a href="#local-6989586621685213511"><span class="hs-identifier">mb_phase</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621685213512"><a href="#local-6989586621685213512"><span class="hs-identifier">obj_allowed</span></a></a><span> </span><a name="local-6989586621685213513"><a href="#local-6989586621685213513"><span class="hs-identifier">maybe_buf</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1971"></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621685213514"><a href="#local-6989586621685213514"><span class="hs-identifier">exists</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">doesFileExist</span><span> </span><a href="#local-6989586621685213510"><span class="hs-identifier hs-var">file</span></a><span>
</span><a name="line-1972"></a><span>                </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621685213514"><span class="hs-identifier hs-var">exists</span></a><span>
</span><a name="line-1973"></a><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><a href="GhcMake.html#summariseFile"><span class="hs-identifier hs-var">summariseFile</span></a><span> </span><a href="#local-6989586621685213498"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685213499"><span class="hs-identifier hs-var">old_summaries</span></a><span> </span><a href="#local-6989586621685213510"><span class="hs-identifier hs-var">file</span></a><span> </span><a href="#local-6989586621685213511"><span class="hs-identifier hs-var">mb_phase</span></a><span>
</span><a name="line-1974"></a><span>                                       </span><a href="#local-6989586621685213512"><span class="hs-identifier hs-var">obj_allowed</span></a><span> </span><a href="#local-6989586621685213513"><span class="hs-identifier hs-var">maybe_buf</span></a><span>
</span><a name="line-1975"></a><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkPlainErrMsg</span><span> </span><a href="#local-6989586621685213503"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">noSrcSpan</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1976"></a><span>                           </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;can't find file:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621685213510"><span class="hs-identifier hs-var">file</span></a><span>
</span><a name="line-1977"></a><span>        </span><span class="hs-identifier">getRootSummary</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Target</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TargetModule</span><span> </span><a name="local-6989586621685213515"><a href="#local-6989586621685213515"><span class="hs-identifier">modl</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621685213516"><a href="#local-6989586621685213516"><span class="hs-identifier">obj_allowed</span></a></a><span> </span><a name="local-6989586621685213517"><a href="#local-6989586621685213517"><span class="hs-identifier">maybe_buf</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1978"></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621685213518"><a href="#local-6989586621685213518"><span class="hs-identifier">maybe_summary</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GhcMake.html#summariseModule"><span class="hs-identifier hs-var">summariseModule</span></a><span> </span><a href="#local-6989586621685213498"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685213505"><span class="hs-identifier hs-var">old_summary_map</span></a><span> </span><a href="GhcMake.html#NotBoot"><span class="hs-identifier hs-var">NotBoot</span></a><span>
</span><a name="line-1979"></a><span>                                           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621685213507"><span class="hs-identifier hs-var">rootLoc</span></a><span> </span><a href="#local-6989586621685213515"><span class="hs-identifier hs-var">modl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213516"><span class="hs-identifier hs-var">obj_allowed</span></a><span>
</span><a name="line-1980"></a><span>                                           </span><a href="#local-6989586621685213517"><span class="hs-identifier hs-var">maybe_buf</span></a><span> </span><a href="#local-6989586621685213500"><span class="hs-identifier hs-var">excl_mods</span></a><span>
</span><a name="line-1981"></a><span>                </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685213518"><span class="hs-identifier hs-var">maybe_summary</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1982"></a><span>                   </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GhcMake.html#moduleNotFoundErr"><span class="hs-identifier hs-var">moduleNotFoundErr</span></a><span> </span><a href="#local-6989586621685213503"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685213515"><span class="hs-identifier hs-var">modl</span></a><span>
</span><a name="line-1983"></a><span>                   </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213519"><a href="#local-6989586621685213519"><span class="hs-identifier">s</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685213519"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-1984"></a><span>
</span><a name="line-1985"></a><span>        </span><a name="local-6989586621685213507"><a href="#local-6989586621685213507"><span class="hs-identifier">rootLoc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkGeneralSrcSpan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;&lt;command line&gt;&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1986"></a><span>
</span><a name="line-1987"></a><span>        </span><span class="hs-comment">-- In a root module, the filename is allowed to diverge from the module</span><span>
</span><a name="line-1988"></a><span>        </span><span class="hs-comment">-- name, so we have to check that there aren't multiple root files</span><span>
</span><a name="line-1989"></a><span>        </span><span class="hs-comment">-- defining the same module (otherwise the duplicates will be silently</span><span>
</span><a name="line-1990"></a><span>        </span><span class="hs-comment">-- ignored, leading to confusing behaviour).</span><span>
</span><a name="line-1991"></a><span>        </span><span class="hs-identifier">checkDuplicates</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GhcMake.html#NodeMap"><span class="hs-identifier hs-type">NodeMap</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">ErrMsg</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1992"></a><span>        </span><a name="local-6989586621685213508"><a href="#local-6989586621685213508"><span class="hs-identifier">checkDuplicates</span></a></a><span> </span><a name="local-6989586621685213520"><a href="#local-6989586621685213520"><span class="hs-identifier">root_map</span></a></a><span>
</span><a name="line-1993"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685213501"><span class="hs-identifier hs-var">allow_dup_roots</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1994"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621685213521"><span class="hs-identifier hs-var">dup_roots</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1995"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GhcMake.html#multiRootsErr"><span class="hs-identifier hs-var">multiRootsErr</span></a><span> </span><a href="#local-6989586621685213503"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621685213521"><span class="hs-identifier hs-var">dup_roots</span></a><span class="hs-special">)</span><span>
</span><a name="line-1996"></a><span>           </span><span class="hs-keyword">where</span><span>
</span><a name="line-1997"></a><span>             </span><span class="hs-identifier">dup_roots</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- Each at least of length 2</span><span>
</span><a name="line-1998"></a><span>             </span><a name="local-6989586621685213521"><a href="#local-6989586621685213521"><span class="hs-identifier">dup_roots</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filterOut</span><span> </span><span class="hs-identifier hs-var">isSingleton</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">rights</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GhcMake.html#nodeMapElts"><span class="hs-identifier hs-var">nodeMapElts</span></a><span> </span><a href="#local-6989586621685213520"><span class="hs-identifier hs-var">root_map</span></a><span>
</span><a name="line-1999"></a><span>
</span><a name="line-2000"></a><span>        </span><span class="hs-identifier">loop</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span class="hs-special">,</span><a href="GhcMake.html#IsBoot"><span class="hs-identifier hs-type">IsBoot</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2001"></a><span>                        </span><span class="hs-comment">-- Work list: process these modules</span><span>
</span><a name="line-2002"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GhcMake.html#NodeMap"><span class="hs-identifier hs-type">NodeMap</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">ErrMsg</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span>
</span><a name="line-2003"></a><span>                        </span><span class="hs-comment">-- Visited set; the range is a list because</span><span>
</span><a name="line-2004"></a><span>                        </span><span class="hs-comment">-- the roots can have the same module names</span><span>
</span><a name="line-2005"></a><span>                        </span><span class="hs-comment">-- if allow_dup_roots is True</span><span>
</span><a name="line-2006"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="GhcMake.html#NodeMap"><span class="hs-identifier hs-type">NodeMap</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">ErrMsg</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2007"></a><span>                        </span><span class="hs-comment">-- The result is the completed NodeMap</span><span>
</span><a name="line-2008"></a><span>        </span><a name="local-6989586621685213509"><a href="#local-6989586621685213509"><span class="hs-identifier">loop</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621685213522"><a href="#local-6989586621685213522"><span class="hs-identifier">done</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685213522"><span class="hs-identifier hs-var">done</span></a><span>
</span><a name="line-2009"></a><span>        </span><span class="hs-identifier">loop</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621685213523"><a href="#local-6989586621685213523"><span class="hs-identifier">wanted_mod</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685213524"><a href="#local-6989586621685213524"><span class="hs-identifier">is_boot</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621685213525"><a href="#local-6989586621685213525"><span class="hs-identifier">ss</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621685213526"><a href="#local-6989586621685213526"><span class="hs-identifier">done</span></a></a><span>
</span><a name="line-2010"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213528"><a href="#local-6989586621685213528"><span class="hs-identifier">summs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621685213527"><span class="hs-identifier hs-var">key</span></a><span> </span><a href="#local-6989586621685213526"><span class="hs-identifier hs-var">done</span></a><span>
</span><a name="line-2011"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isSingleton</span><span> </span><a href="#local-6989586621685213528"><span class="hs-identifier hs-var">summs</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-2012"></a><span>                </span><a href="#local-6989586621685213509"><span class="hs-identifier hs-var">loop</span></a><span> </span><a href="#local-6989586621685213525"><span class="hs-identifier hs-var">ss</span></a><span> </span><a href="#local-6989586621685213526"><span class="hs-identifier hs-var">done</span></a><span>
</span><a name="line-2013"></a><span>            </span><span class="hs-keyword">else</span><span>
</span><a name="line-2014"></a><span>                </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="GhcMake.html#multiRootsErr"><span class="hs-identifier hs-var">multiRootsErr</span></a><span> </span><a href="#local-6989586621685213503"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">rights</span><span> </span><a href="#local-6989586621685213528"><span class="hs-identifier hs-var">summs</span></a><span class="hs-special">)</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2015"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2016"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621685213529"><a href="#local-6989586621685213529"><span class="hs-identifier">mb_s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GhcMake.html#summariseModule"><span class="hs-identifier hs-var">summariseModule</span></a><span> </span><a href="#local-6989586621685213498"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685213505"><span class="hs-identifier hs-var">old_summary_map</span></a><span>
</span><a name="line-2017"></a><span>                                       </span><a href="#local-6989586621685213524"><span class="hs-identifier hs-var">is_boot</span></a><span> </span><a href="#local-6989586621685213523"><span class="hs-identifier hs-var">wanted_mod</span></a><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2018"></a><span>                                       </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621685213500"><span class="hs-identifier hs-var">excl_mods</span></a><span>
</span><a name="line-2019"></a><span>               </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685213529"><span class="hs-identifier hs-var">mb_s</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2020"></a><span>                   </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685213509"><span class="hs-identifier hs-var">loop</span></a><span> </span><a href="#local-6989586621685213525"><span class="hs-identifier hs-var">ss</span></a><span> </span><a href="#local-6989586621685213526"><span class="hs-identifier hs-var">done</span></a><span>
</span><a name="line-2021"></a><span>                   </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621685213530"><a href="#local-6989586621685213530"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685213509"><span class="hs-identifier hs-var">loop</span></a><span> </span><a href="#local-6989586621685213525"><span class="hs-identifier hs-var">ss</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.insert</span><span> </span><a href="#local-6989586621685213527"><span class="hs-identifier hs-var">key</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621685213530"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621685213526"><span class="hs-identifier hs-var">done</span></a><span class="hs-special">)</span><span>
</span><a name="line-2022"></a><span>                   </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621685213531"><a href="#local-6989586621685213531"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2023"></a><span>                     </span><a name="local-6989586621685213532"><a href="#local-6989586621685213532"><span class="hs-identifier">new_map</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-2024"></a><span>                       </span><a href="#local-6989586621685213509"><span class="hs-identifier hs-var">loop</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213502"><span class="hs-identifier hs-var">calcDeps</span></a><span> </span><a href="#local-6989586621685213531"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.insert</span><span> </span><a href="#local-6989586621685213527"><span class="hs-identifier hs-var">key</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621685213531"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621685213526"><span class="hs-identifier hs-var">done</span></a><span class="hs-special">)</span><span>
</span><a name="line-2025"></a><span>                     </span><a href="#local-6989586621685213509"><span class="hs-identifier hs-var">loop</span></a><span> </span><a href="#local-6989586621685213525"><span class="hs-identifier hs-var">ss</span></a><span> </span><a href="#local-6989586621685213532"><span class="hs-identifier hs-var">new_map</span></a><span>
</span><a name="line-2026"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-2027"></a><span>            </span><a name="local-6989586621685213527"><a href="#local-6989586621685213527"><span class="hs-identifier">key</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621685213523"><span class="hs-identifier hs-var">wanted_mod</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685213524"><span class="hs-identifier hs-var">is_boot</span></a><span class="hs-special">)</span><span>
</span><a name="line-2028"></a><span>
</span><a name="line-2029"></a><span class="hs-comment">-- | Update the every ModSummary that is depended on</span><span>
</span><a name="line-2030"></a><span class="hs-comment">-- by a module that needs template haskell. We enable codegen to</span><span>
</span><a name="line-2031"></a><span class="hs-comment">-- the specified target, disable optimization and change the .hi</span><span>
</span><a name="line-2032"></a><span class="hs-comment">-- and .o file locations to be temporary files.</span><span>
</span><a name="line-2033"></a><span class="hs-comment">-- See Note [-fno-code mode]</span><span>
</span><a name="line-2034"></a><span class="hs-identifier">enableCodeGenForTH</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscTarget</span><span>
</span><a name="line-2035"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GhcMake.html#NodeMap"><span class="hs-identifier hs-type">NodeMap</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">ErrMsg</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span>
</span><a name="line-2036"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="GhcMake.html#NodeMap"><span class="hs-identifier hs-type">NodeMap</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">ErrMsg</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2037"></a><a name="enableCodeGenForTH"><a href="GhcMake.html#enableCodeGenForTH"><span class="hs-identifier">enableCodeGenForTH</span></a></a><span> </span><a name="local-6989586621685213538"><a href="#local-6989586621685213538"><span class="hs-identifier">target</span></a></a><span> </span><a name="local-6989586621685213539"><a href="#local-6989586621685213539"><span class="hs-identifier">nodemap</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2038"></a><span>  </span><span class="hs-identifier hs-var">traverse</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">traverse</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">traverse</span><span> </span><a href="#local-6989586621685213540"><span class="hs-identifier hs-var">enable_code_gen</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213539"><span class="hs-identifier hs-var">nodemap</span></a><span>
</span><a name="line-2039"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2040"></a><span>    </span><a name="local-6989586621685213540"><a href="#local-6989586621685213540"><span class="hs-identifier">enable_code_gen</span></a></a><span> </span><a name="local-6989586621685213543"><a href="#local-6989586621685213543"><span class="hs-identifier">ms</span></a></a><span>
</span><a name="line-2041"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">ModSummary</span><span>
</span><a name="line-2042"></a><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ms_mod</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685213544"><a href="#local-6989586621685213544"><span class="hs-identifier">ms_mod</span></a></a><span>
</span><a name="line-2043"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ms_location</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685213545"><a href="#local-6989586621685213545"><span class="hs-identifier">ms_location</span></a></a><span>
</span><a name="line-2044"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ms_hsc_src</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HsSrcFile</span><span>
</span><a name="line-2045"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ms_hspp_opts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685213546"><a href="#local-6989586621685213546"><span class="hs-identifier">dflags</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">DynFlags</span><span>
</span><a name="line-2046"></a><span>          </span><span class="hs-special">{</span><span class="hs-identifier">hscTarget</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HscNothing</span><span class="hs-special">}</span><span>
</span><a name="line-2047"></a><span>        </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213543"><span class="hs-identifier hs-var">ms</span></a><span>
</span><a name="line-2048"></a><span>      </span><span class="hs-comment">-- Don't enable codegen for TH on indefinite packages; we</span><span>
</span><a name="line-2049"></a><span>      </span><span class="hs-comment">-- can't compile anything anyway! See #16219.</span><span>
</span><a name="line-2050"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isIndefinite</span><span> </span><a href="#local-6989586621685213546"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-2051"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685213544"><span class="hs-identifier hs-var">ms_mod</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Set.member</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685213541"><span class="hs-identifier hs-var">needs_codegen_set</span></a><span>
</span><a name="line-2052"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2053"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213547"><a href="#local-6989586621685213547"><span class="hs-identifier">new_temp_file</span></a></a><span> </span><a name="local-6989586621685213548"><a href="#local-6989586621685213548"><span class="hs-identifier">suf</span></a></a><span> </span><a name="local-6989586621685213549"><a href="#local-6989586621685213549"><span class="hs-identifier">dynsuf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2054"></a><span>              </span><a name="local-6989586621685213550"><a href="#local-6989586621685213550"><span class="hs-identifier">tn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newTempName</span><span> </span><a href="#local-6989586621685213546"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">TFL_CurrentModule</span><span> </span><a href="#local-6989586621685213548"><span class="hs-identifier hs-var">suf</span></a><span>
</span><a name="line-2055"></a><span>              </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213551"><a href="#local-6989586621685213551"><span class="hs-identifier">dyn_tn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213550"><span class="hs-identifier hs-var">tn</span></a><span> </span><span class="hs-operator hs-var">-&lt;.&gt;</span><span> </span><a href="#local-6989586621685213549"><span class="hs-identifier hs-var">dynsuf</span></a><span>
</span><a name="line-2056"></a><span>              </span><span class="hs-identifier hs-var">addFilesToClean</span><span> </span><a href="#local-6989586621685213546"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">TFL_GhcSession</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621685213551"><span class="hs-identifier hs-var">dyn_tn</span></a><span class="hs-special">]</span><span>
</span><a name="line-2057"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685213550"><span class="hs-identifier hs-var">tn</span></a><span>
</span><a name="line-2058"></a><span>          </span><span class="hs-comment">-- We don't want to create .o or .hi files unless we have been asked</span><span>
</span><a name="line-2059"></a><span>          </span><span class="hs-comment">-- to by the user. But we need them, so we patch their locations in</span><span>
</span><a name="line-2060"></a><span>          </span><span class="hs-comment">-- the ModSummary with temporary files.</span><span>
</span><a name="line-2061"></a><span>          </span><span class="hs-comment">--</span><span>
</span><a name="line-2062"></a><span>        </span><a name="local-6989586621685213552"><a href="#local-6989586621685213552"><span class="hs-identifier">hi_file</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-2063"></a><span>          </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_WriteInterface</span><span> </span><a href="#local-6989586621685213546"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-2064"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">ml_hi_file</span><span> </span><a href="#local-6989586621685213545"><span class="hs-identifier hs-var">ms_location</span></a><span>
</span><a name="line-2065"></a><span>            </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621685213547"><span class="hs-identifier hs-var">new_temp_file</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">hiSuf</span><span> </span><a href="#local-6989586621685213546"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dynHiSuf</span><span> </span><a href="#local-6989586621685213546"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-2066"></a><span>        </span><a name="local-6989586621685213553"><a href="#local-6989586621685213553"><span class="hs-identifier">o_temp_file</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213547"><span class="hs-identifier hs-var">new_temp_file</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">objectSuf</span><span> </span><a href="#local-6989586621685213546"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dynObjectSuf</span><span> </span><a href="#local-6989586621685213546"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-2067"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2068"></a><span>          </span><a href="#local-6989586621685213543"><span class="hs-identifier hs-var">ms</span></a><span>
</span><a name="line-2069"></a><span>          </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ms_location</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2070"></a><span>              </span><a href="#local-6989586621685213545"><span class="hs-identifier hs-var">ms_location</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">ml_hi_file</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213552"><span class="hs-identifier hs-var">hi_file</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ml_obj_file</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213553"><span class="hs-identifier hs-var">o_temp_file</span></a><span class="hs-special">}</span><span>
</span><a name="line-2071"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ms_hspp_opts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">updOptLevel</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621685213546"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">hscTarget</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213538"><span class="hs-identifier hs-var">target</span></a><span class="hs-special">}</span><span>
</span><a name="line-2072"></a><span>          </span><span class="hs-special">}</span><span>
</span><a name="line-2073"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685213543"><span class="hs-identifier hs-var">ms</span></a><span>
</span><a name="line-2074"></a><span>
</span><a name="line-2075"></a><span>    </span><a name="local-6989586621685213541"><a href="#local-6989586621685213541"><span class="hs-identifier">needs_codegen_set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213542"><span class="hs-identifier hs-var">transitive_deps_set</span></a><span>
</span><a name="line-2076"></a><span>      </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621685213555"><span class="hs-identifier hs-var">ms</span></a><span>
</span><a name="line-2077"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621685213554"><a href="#local-6989586621685213554"><span class="hs-identifier">mss</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Map.elems</span><span> </span><a href="#local-6989586621685213539"><span class="hs-identifier hs-var">nodemap</span></a><span>
</span><a name="line-2078"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621685213555"><a href="#local-6989586621685213555"><span class="hs-identifier">ms</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213554"><span class="hs-identifier hs-var">mss</span></a><span>
</span><a name="line-2079"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isTemplateHaskellOrQQNonBoot</span><span> </span><a href="#local-6989586621685213555"><span class="hs-identifier hs-var">ms</span></a><span>
</span><a name="line-2080"></a><span>      </span><span class="hs-special">]</span><span>
</span><a name="line-2081"></a><span>
</span><a name="line-2082"></a><span>    </span><span class="hs-comment">-- find the set of all transitive dependencies of a list of modules.</span><span>
</span><a name="line-2083"></a><span>    </span><a name="local-6989586621685213542"><a href="#local-6989586621685213542"><span class="hs-identifier">transitive_deps_set</span></a></a><span> </span><a name="local-6989586621685213556"><a href="#local-6989586621685213556"><span class="hs-identifier">modSums</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="#local-6989586621685213557"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-identifier hs-var">Set.empty</span><span> </span><a href="#local-6989586621685213556"><span class="hs-identifier hs-var">modSums</span></a><span>
</span><a name="line-2084"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-2085"></a><span>        </span><a name="local-6989586621685213557"><a href="#local-6989586621685213557"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621685213558"><a href="#local-6989586621685213558"><span class="hs-identifier">marked_mods</span></a></a><span> </span><a name="local-6989586621685213559"><a href="#local-6989586621685213559"><span class="hs-identifier">ms</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">ModSummary</span><span class="hs-special">{</span><a name="local-6989586621685213560"><a href="#local-6989586621685213560"><span class="hs-identifier">ms_mod</span></a></a><span class="hs-special">}</span><span>
</span><a name="line-2086"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685213560"><span class="hs-identifier hs-var">ms_mod</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Set.member</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685213558"><span class="hs-identifier hs-var">marked_mods</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213558"><span class="hs-identifier hs-var">marked_mods</span></a><span>
</span><a name="line-2087"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2088"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213561"><a href="#local-6989586621685213561"><span class="hs-identifier">deps</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2089"></a><span>                  </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621685213564"><span class="hs-identifier hs-var">dep_ms</span></a><span>
</span><a name="line-2090"></a><span>                  </span><span class="hs-comment">-- If a module imports a boot module, msDeps helpfully adds a</span><span>
</span><a name="line-2091"></a><span>                  </span><span class="hs-comment">-- dependency to that non-boot module in it's result. This</span><span>
</span><a name="line-2092"></a><span>                  </span><span class="hs-comment">-- means we don't have to think about boot modules here.</span><span>
</span><a name="line-2093"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621685213563"><a href="#local-6989586621685213563"><span class="hs-identifier">mn</span></a></a><span class="hs-special">,</span><span> </span><a href="GhcMake.html#NotBoot"><span class="hs-identifier hs-var">NotBoot</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GhcMake.html#msDeps"><span class="hs-identifier hs-var">msDeps</span></a><span> </span><a href="#local-6989586621685213559"><span class="hs-identifier hs-var">ms</span></a><span>
</span><a name="line-2094"></a><span>                  </span><span class="hs-special">,</span><span> </span><a name="local-6989586621685213564"><a href="#local-6989586621685213564"><span class="hs-identifier">dep_ms</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-2095"></a><span>                      </span><span class="hs-identifier hs-var">toList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213563"><span class="hs-identifier hs-var">mn</span></a><span class="hs-special">,</span><span> </span><a href="GhcMake.html#NotBoot"><span class="hs-identifier hs-var">NotBoot</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213539"><span class="hs-identifier hs-var">nodemap</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">toList</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span>
</span><a name="line-2096"></a><span>                      </span><span class="hs-identifier hs-var">toList</span><span>
</span><a name="line-2097"></a><span>                  </span><span class="hs-special">]</span><span>
</span><a name="line-2098"></a><span>                </span><a name="local-6989586621685213562"><a href="#local-6989586621685213562"><span class="hs-identifier">new_marked_mods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.insert</span><span> </span><a href="#local-6989586621685213560"><span class="hs-identifier hs-var">ms_mod</span></a><span> </span><a href="#local-6989586621685213558"><span class="hs-identifier hs-var">marked_mods</span></a><span>
</span><a name="line-2099"></a><span>            </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="#local-6989586621685213557"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621685213562"><span class="hs-identifier hs-var">new_marked_mods</span></a><span> </span><a href="#local-6989586621685213561"><span class="hs-identifier hs-var">deps</span></a><span>
</span><a name="line-2100"></a><span>
</span><a name="line-2101"></a><span class="hs-identifier">mkRootMap</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GhcMake.html#NodeMap"><span class="hs-identifier hs-type">NodeMap</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">ErrMsg</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span>
</span><a name="line-2102"></a><a name="mkRootMap"><a href="GhcMake.html#mkRootMap"><span class="hs-identifier">mkRootMap</span></a></a><span> </span><a name="local-6989586621685213565"><a href="#local-6989586621685213565"><span class="hs-identifier">summaries</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.insertListWith</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2103"></a><span>                                         </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="GhcMake.html#msKey"><span class="hs-identifier hs-var">msKey</span></a><span> </span><a href="#local-6989586621685213566"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621685213566"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621685213566"><a href="#local-6989586621685213566"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213565"><span class="hs-identifier hs-var">summaries</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2104"></a><span>                                         </span><span class="hs-identifier hs-var">Map.empty</span><span>
</span><a name="line-2105"></a><span>
</span><a name="line-2106"></a><span class="hs-comment">-- | Returns the dependencies of the ModSummary s.</span><span>
</span><a name="line-2107"></a><span class="hs-comment">-- A wrinkle is that for a {-# SOURCE #-} import we return</span><span>
</span><a name="line-2108"></a><span class="hs-comment">--      *both* the hs-boot file</span><span>
</span><a name="line-2109"></a><span class="hs-comment">--      *and* the source file</span><span>
</span><a name="line-2110"></a><span class="hs-comment">-- as &quot;dependencies&quot;.  That ensures that the list of all relevant</span><span>
</span><a name="line-2111"></a><span class="hs-comment">-- modules always contains B.hs if it contains B.hs-boot.</span><span>
</span><a name="line-2112"></a><span class="hs-comment">-- Remember, this pass isn't doing the topological sort.  It's</span><span>
</span><a name="line-2113"></a><span class="hs-comment">-- just gathering the list of all relevant ModSummaries</span><span>
</span><a name="line-2114"></a><span class="hs-identifier">msDeps</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span class="hs-special">,</span><span> </span><a href="GhcMake.html#IsBoot"><span class="hs-identifier hs-type">IsBoot</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2115"></a><a name="msDeps"><a href="GhcMake.html#msDeps"><span class="hs-identifier">msDeps</span></a></a><span> </span><a name="local-6989586621685213567"><a href="#local-6989586621685213567"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2116"></a><span>    </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621685213568"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">,</span><a href="GhcMake.html#IsBoot"><span class="hs-identifier hs-var">IsBoot</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213568"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">,</span><a href="GhcMake.html#NotBoot"><span class="hs-identifier hs-var">NotBoot</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621685213568"><a href="#local-6989586621685213568"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GhcMake.html#ms_home_srcimps"><span class="hs-identifier hs-var">ms_home_srcimps</span></a><span> </span><a href="#local-6989586621685213567"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2117"></a><span>        </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213569"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">,</span><a href="GhcMake.html#NotBoot"><span class="hs-identifier hs-var">NotBoot</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621685213569"><a href="#local-6989586621685213569"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GhcMake.html#ms_home_imps"><span class="hs-identifier hs-var">ms_home_imps</span></a><span> </span><a href="#local-6989586621685213567"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2118"></a><span>
</span><a name="line-2119"></a><span class="hs-identifier">home_imps</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">FastString</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span class="hs-special">]</span><span>
</span><a name="line-2120"></a><a name="home_imps"><a href="GhcMake.html#home_imps"><span class="hs-identifier">home_imps</span></a></a><span> </span><a name="local-6989586621685213570"><a href="#local-6989586621685213570"><span class="hs-identifier">imps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621685213574"><span class="hs-identifier hs-var">lmodname</span></a><span> </span><span class="hs-glyph">|</span><span>  </span><span class="hs-special">(</span><a name="local-6989586621685213573"><a href="#local-6989586621685213573"><span class="hs-identifier">mb_pkg</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685213574"><a href="#local-6989586621685213574"><span class="hs-identifier">lmodname</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213570"><span class="hs-identifier hs-var">imps</span></a><span class="hs-special">,</span><span>
</span><a name="line-2121"></a><span>                                  </span><a href="#local-6989586621685213571"><span class="hs-identifier hs-var">isLocal</span></a><span> </span><a href="#local-6989586621685213573"><span class="hs-identifier hs-var">mb_pkg</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2122"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621685213571"><a href="#local-6989586621685213571"><span class="hs-identifier">isLocal</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2123"></a><span>        </span><span class="hs-identifier">isLocal</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213572"><a href="#local-6989586621685213572"><span class="hs-identifier">pkg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685213572"><span class="hs-identifier hs-var">pkg</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;this&quot;</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-comment">-- &quot;this&quot; is special</span><span>
</span><a name="line-2124"></a><span>        </span><span class="hs-identifier">isLocal</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2125"></a><span>
</span><a name="line-2126"></a><span class="hs-identifier">ms_home_allimps</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ModuleName</span><span class="hs-special">]</span><span>
</span><a name="line-2127"></a><a name="ms_home_allimps"><a href="GhcMake.html#ms_home_allimps"><span class="hs-identifier">ms_home_allimps</span></a></a><span> </span><a name="local-6989586621685213575"><a href="#local-6989586621685213575"><span class="hs-identifier">ms</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-special">(</span><a href="GhcMake.html#ms_home_srcimps"><span class="hs-identifier hs-var">ms_home_srcimps</span></a><span> </span><a href="#local-6989586621685213575"><span class="hs-identifier hs-var">ms</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="GhcMake.html#ms_home_imps"><span class="hs-identifier hs-var">ms_home_imps</span></a><span> </span><a href="#local-6989586621685213575"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">)</span><span>
</span><a name="line-2128"></a><span>
</span><a name="line-2129"></a><span class="hs-comment">-- | Like 'ms_home_imps', but for SOURCE imports.</span><span>
</span><a name="line-2130"></a><span class="hs-identifier">ms_home_srcimps</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span class="hs-special">]</span><span>
</span><a name="line-2131"></a><a name="ms_home_srcimps"><a href="GhcMake.html#ms_home_srcimps"><span class="hs-identifier">ms_home_srcimps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GhcMake.html#home_imps"><span class="hs-identifier hs-var">home_imps</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">ms_srcimps</span><span>
</span><a name="line-2132"></a><span>
</span><a name="line-2133"></a><span class="hs-comment">-- | All of the (possibly) home module imports from a</span><span>
</span><a name="line-2134"></a><span class="hs-comment">-- 'ModSummary'; that is to say, each of these module names</span><span>
</span><a name="line-2135"></a><span class="hs-comment">-- could be a home import if an appropriately named file</span><span>
</span><a name="line-2136"></a><span class="hs-comment">-- existed.  (This is in contrast to package qualified</span><span>
</span><a name="line-2137"></a><span class="hs-comment">-- imports, which are guaranteed not to be home imports.)</span><span>
</span><a name="line-2138"></a><span class="hs-identifier">ms_home_imps</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span class="hs-special">]</span><span>
</span><a name="line-2139"></a><a name="ms_home_imps"><a href="GhcMake.html#ms_home_imps"><span class="hs-identifier">ms_home_imps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GhcMake.html#home_imps"><span class="hs-identifier hs-var">home_imps</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">ms_imps</span><span>
</span><a name="line-2140"></a><span>
</span><a name="line-2141"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-2142"></a><span class="hs-comment">-- Summarising modules</span><span>
</span><a name="line-2143"></a><span>
</span><a name="line-2144"></a><span class="hs-comment">-- We have two types of summarisation:</span><span>
</span><a name="line-2145"></a><span class="hs-comment">--</span><span>
</span><a name="line-2146"></a><span class="hs-comment">--    * Summarise a file.  This is used for the root module(s) passed to</span><span>
</span><a name="line-2147"></a><span class="hs-comment">--      cmLoadModules.  The file is read, and used to determine the root</span><span>
</span><a name="line-2148"></a><span class="hs-comment">--      module name.  The module name may differ from the filename.</span><span>
</span><a name="line-2149"></a><span class="hs-comment">--</span><span>
</span><a name="line-2150"></a><span class="hs-comment">--    * Summarise a module.  We are given a module name, and must provide</span><span>
</span><a name="line-2151"></a><span class="hs-comment">--      a summary.  The finder is used to locate the file in which the module</span><span>
</span><a name="line-2152"></a><span class="hs-comment">--      resides.</span><span>
</span><a name="line-2153"></a><span>
</span><a name="line-2154"></a><span class="hs-identifier">summariseFile</span><span>
</span><a name="line-2155"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-2156"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span>                 </span><span class="hs-comment">-- old summaries</span><span>
</span><a name="line-2157"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>                     </span><span class="hs-comment">-- source file name</span><span>
</span><a name="line-2158"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Phase</span><span>                  </span><span class="hs-comment">-- start phase</span><span>
</span><a name="line-2159"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>                         </span><span class="hs-comment">-- object code allowed?</span><span>
</span><a name="line-2160"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">StringBuffer</span><span class="hs-special">,</span><span class="hs-identifier hs-type">UTCTime</span><span class="hs-special">)</span><span>
</span><a name="line-2161"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span>
</span><a name="line-2162"></a><span>
</span><a name="line-2163"></a><a name="summariseFile"><a href="GhcMake.html#summariseFile"><span class="hs-identifier">summariseFile</span></a></a><span> </span><a name="local-6989586621685213576"><a href="#local-6989586621685213576"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621685213577"><a href="#local-6989586621685213577"><span class="hs-identifier">old_summaries</span></a></a><span> </span><a name="local-6989586621685213578"><a href="#local-6989586621685213578"><span class="hs-identifier">file</span></a></a><span> </span><a name="local-6989586621685213579"><a href="#local-6989586621685213579"><span class="hs-identifier">mb_phase</span></a></a><span> </span><a name="local-6989586621685213580"><a href="#local-6989586621685213580"><span class="hs-identifier">obj_allowed</span></a></a><span> </span><a name="local-6989586621685213581"><a href="#local-6989586621685213581"><span class="hs-identifier">maybe_buf</span></a></a><span>
</span><a name="line-2164"></a><span>        </span><span class="hs-comment">-- we can use a cached summary if one is available and the</span><span>
</span><a name="line-2165"></a><span>        </span><span class="hs-comment">-- source file hasn't changed,  But we have to look up the summary</span><span>
</span><a name="line-2166"></a><span>        </span><span class="hs-comment">-- by source file, rather than module name as we do in summarise.</span><span>
</span><a name="line-2167"></a><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213601"><a href="#local-6989586621685213601"><span class="hs-identifier">old_summary</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GhcMake.html#findSummaryBySourceFile"><span class="hs-identifier hs-var">findSummaryBySourceFile</span></a><span> </span><a href="#local-6989586621685213577"><span class="hs-identifier hs-var">old_summaries</span></a><span> </span><a href="#local-6989586621685213578"><span class="hs-identifier hs-var">file</span></a><span>
</span><a name="line-2168"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2169"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213602"><a href="#local-6989586621685213602"><span class="hs-identifier">location</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_location</span><span> </span><a href="#local-6989586621685213601"><span class="hs-identifier hs-var">old_summary</span></a><span>
</span><a name="line-2170"></a><span>            </span><a name="local-6989586621685213603"><a href="#local-6989586621685213603"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685213576"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-2171"></a><span>
</span><a name="line-2172"></a><span>        </span><a name="local-6989586621685213604"><a href="#local-6989586621685213604"><span class="hs-identifier">src_timestamp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213582"><span class="hs-identifier hs-var">get_src_timestamp</span></a><span>
</span><a name="line-2173"></a><span>                </span><span class="hs-comment">-- The file exists; we checked in getRootSummary above.</span><span>
</span><a name="line-2174"></a><span>                </span><span class="hs-comment">-- If it gets removed subsequently, then this</span><span>
</span><a name="line-2175"></a><span>                </span><span class="hs-comment">-- getModificationUTCTime may fail, but that's the right</span><span>
</span><a name="line-2176"></a><span>                </span><span class="hs-comment">-- behaviour.</span><span>
</span><a name="line-2177"></a><span>
</span><a name="line-2178"></a><span>                </span><span class="hs-comment">-- return the cached summary if the source didn't change</span><span>
</span><a name="line-2179"></a><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">ms_hs_date</span><span> </span><a href="#local-6989586621685213601"><span class="hs-identifier hs-var">old_summary</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621685213604"><span class="hs-identifier hs-var">src_timestamp</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-2180"></a><span>           </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_ForceRecomp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685213576"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2181"></a><span>           </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- update the object-file timestamp</span><span>
</span><a name="line-2182"></a><span>                  </span><a name="local-6989586621685213605"><a href="#local-6989586621685213605"><span class="hs-identifier">obj_timestamp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-2183"></a><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isObjectTarget</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hscTarget</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685213576"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2184"></a><span>                        </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621685213580"><span class="hs-identifier hs-var">obj_allowed</span></a><span> </span><span class="hs-comment">-- bug #1205</span><span>
</span><a name="line-2185"></a><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GhcMake.html#getObjTimestamp"><span class="hs-identifier hs-var">getObjTimestamp</span></a><span> </span><a href="#local-6989586621685213602"><span class="hs-identifier hs-var">location</span></a><span> </span><a href="GhcMake.html#NotBoot"><span class="hs-identifier hs-var">NotBoot</span></a><span>
</span><a name="line-2186"></a><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-2187"></a><span>                  </span><a name="local-6989586621685213606"><a href="#local-6989586621685213606"><span class="hs-identifier">hi_timestamp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GhcMake.html#maybeGetIfaceDate"><span class="hs-identifier hs-var">maybeGetIfaceDate</span></a><span> </span><a href="#local-6989586621685213603"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685213602"><span class="hs-identifier hs-var">location</span></a><span>
</span><a name="line-2188"></a><span>                  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213607"><a href="#local-6989586621685213607"><span class="hs-identifier">hie_location</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ml_hie_file</span><span> </span><a href="#local-6989586621685213602"><span class="hs-identifier hs-var">location</span></a><span>
</span><a name="line-2189"></a><span>                  </span><a name="local-6989586621685213608"><a href="#local-6989586621685213608"><span class="hs-identifier">hie_timestamp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">modificationTimeIfExists</span><span> </span><a href="#local-6989586621685213607"><span class="hs-identifier hs-var">hie_location</span></a><span>
</span><a name="line-2190"></a><span>
</span><a name="line-2191"></a><span>                  </span><span class="hs-comment">-- We have to repopulate the Finder's cache because it</span><span>
</span><a name="line-2192"></a><span>                  </span><span class="hs-comment">-- was flushed before the downsweep.</span><span>
</span><a name="line-2193"></a><span>                  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Finder.html#addHomeModuleToFinder"><span class="hs-identifier hs-var">addHomeModuleToFinder</span></a><span> </span><a href="#local-6989586621685213576"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-2194"></a><span>                    </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ms_mod</span><span> </span><a href="#local-6989586621685213601"><span class="hs-identifier hs-var">old_summary</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ms_location</span><span> </span><a href="#local-6989586621685213601"><span class="hs-identifier hs-var">old_summary</span></a><span class="hs-special">)</span><span>
</span><a name="line-2195"></a><span>
</span><a name="line-2196"></a><span>                  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685213601"><span class="hs-identifier hs-var">old_summary</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">ms_obj_date</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213605"><span class="hs-identifier hs-var">obj_timestamp</span></a><span>
</span><a name="line-2197"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ms_iface_date</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213606"><span class="hs-identifier hs-var">hi_timestamp</span></a><span>
</span><a name="line-2198"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ms_hie_date</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213608"><span class="hs-identifier hs-var">hie_timestamp</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2199"></a><span>           </span><span class="hs-keyword">else</span><span>
</span><a name="line-2200"></a><span>                </span><a href="#local-6989586621685213583"><span class="hs-identifier hs-var">new_summary</span></a><span> </span><a href="#local-6989586621685213604"><span class="hs-identifier hs-var">src_timestamp</span></a><span>
</span><a name="line-2201"></a><span>
</span><a name="line-2202"></a><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2203"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621685213609"><a href="#local-6989586621685213609"><span class="hs-identifier">src_timestamp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213582"><span class="hs-identifier hs-var">get_src_timestamp</span></a><span>
</span><a name="line-2204"></a><span>        </span><a href="#local-6989586621685213583"><span class="hs-identifier hs-var">new_summary</span></a><span> </span><a href="#local-6989586621685213609"><span class="hs-identifier hs-var">src_timestamp</span></a><span>
</span><a name="line-2205"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2206"></a><span>    </span><a name="local-6989586621685213582"><a href="#local-6989586621685213582"><span class="hs-identifier">get_src_timestamp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685213581"><span class="hs-identifier hs-var">maybe_buf</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2207"></a><span>                           </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621685213584"><a href="#local-6989586621685213584"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685213584"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-2208"></a><span>                           </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">getModificationUTCTime</span><span> </span><a href="#local-6989586621685213578"><span class="hs-identifier hs-var">file</span></a><span>
</span><a name="line-2209"></a><span>                        </span><span class="hs-comment">-- getModificationUTCTime may fail</span><span>
</span><a name="line-2210"></a><span>
</span><a name="line-2211"></a><span>    </span><a name="local-6989586621685213583"><a href="#local-6989586621685213583"><span class="hs-identifier">new_summary</span></a></a><span> </span><a name="local-6989586621685213585"><a href="#local-6989586621685213585"><span class="hs-identifier">src_timestamp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2212"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213586"><a href="#local-6989586621685213586"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685213576"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-2213"></a><span>
</span><a name="line-2214"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213587"><a href="#local-6989586621685213587"><span class="hs-identifier">hsc_src</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isHaskellSigFilename</span><span> </span><a href="#local-6989586621685213578"><span class="hs-identifier hs-var">file</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">HsigFile</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">HsSrcFile</span><span>
</span><a name="line-2215"></a><span>
</span><a name="line-2216"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621685213588"><a href="#local-6989586621685213588"><span class="hs-identifier">dflags'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685213589"><a href="#local-6989586621685213589"><span class="hs-identifier">hspp_fn</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685213590"><a href="#local-6989586621685213590"><span class="hs-identifier">buf</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2217"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GhcMake.html#preprocessFile"><span class="hs-identifier hs-var">preprocessFile</span></a><span> </span><a href="#local-6989586621685213576"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685213578"><span class="hs-identifier hs-var">file</span></a><span> </span><a href="#local-6989586621685213579"><span class="hs-identifier hs-var">mb_phase</span></a><span> </span><a href="#local-6989586621685213581"><span class="hs-identifier hs-var">maybe_buf</span></a><span>
</span><a name="line-2218"></a><span>
</span><a name="line-2219"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621685213591"><a href="#local-6989586621685213591"><span class="hs-identifier">srcimps</span></a></a><span class="hs-special">,</span><a name="local-6989586621685213592"><a href="#local-6989586621685213592"><span class="hs-identifier">the_imps</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621685213593"><a href="#local-6989586621685213593"><span class="hs-identifier">mod_name</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getImports</span><span> </span><a href="#local-6989586621685213588"><span class="hs-identifier hs-var">dflags'</span></a><span> </span><a href="#local-6989586621685213590"><span class="hs-identifier hs-var">buf</span></a><span> </span><a href="#local-6989586621685213589"><span class="hs-identifier hs-var">hspp_fn</span></a><span> </span><a href="#local-6989586621685213578"><span class="hs-identifier hs-var">file</span></a><span>
</span><a name="line-2220"></a><span>
</span><a name="line-2221"></a><span>        </span><span class="hs-comment">-- Make a ModLocation for this file</span><span>
</span><a name="line-2222"></a><span>        </span><a name="local-6989586621685213594"><a href="#local-6989586621685213594"><span class="hs-identifier">location</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Finder.html#mkHomeModLocation"><span class="hs-identifier hs-var">mkHomeModLocation</span></a><span> </span><a href="#local-6989586621685213586"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685213593"><span class="hs-identifier hs-var">mod_name</span></a><span> </span><a href="#local-6989586621685213578"><span class="hs-identifier hs-var">file</span></a><span>
</span><a name="line-2223"></a><span>
</span><a name="line-2224"></a><span>        </span><span class="hs-comment">-- Tell the Finder cache where it is, so that subsequent calls</span><span>
</span><a name="line-2225"></a><span>        </span><span class="hs-comment">-- to findModule will find it, even if it's not on any search path</span><span>
</span><a name="line-2226"></a><span>        </span><a name="local-6989586621685213595"><a href="#local-6989586621685213595"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Finder.html#addHomeModuleToFinder"><span class="hs-identifier hs-var">addHomeModuleToFinder</span></a><span> </span><a href="#local-6989586621685213576"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685213593"><span class="hs-identifier hs-var">mod_name</span></a><span> </span><a href="#local-6989586621685213594"><span class="hs-identifier hs-var">location</span></a><span>
</span><a name="line-2227"></a><span>
</span><a name="line-2228"></a><span>        </span><span class="hs-comment">-- when the user asks to load a source file by name, we only</span><span>
</span><a name="line-2229"></a><span>        </span><span class="hs-comment">-- use an object file if -fobject-code is on.  See #1205.</span><span>
</span><a name="line-2230"></a><span>        </span><a name="local-6989586621685213596"><a href="#local-6989586621685213596"><span class="hs-identifier">obj_timestamp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-2231"></a><span>            </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isObjectTarget</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hscTarget</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685213576"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2232"></a><span>               </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621685213580"><span class="hs-identifier hs-var">obj_allowed</span></a><span> </span><span class="hs-comment">-- bug #1205</span><span>
</span><a name="line-2233"></a><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">modificationTimeIfExists</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ml_obj_file</span><span> </span><a href="#local-6989586621685213594"><span class="hs-identifier hs-var">location</span></a><span class="hs-special">)</span><span>
</span><a name="line-2234"></a><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-2235"></a><span>
</span><a name="line-2236"></a><span>        </span><a name="local-6989586621685213597"><a href="#local-6989586621685213597"><span class="hs-identifier">hi_timestamp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GhcMake.html#maybeGetIfaceDate"><span class="hs-identifier hs-var">maybeGetIfaceDate</span></a><span> </span><a href="#local-6989586621685213586"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685213594"><span class="hs-identifier hs-var">location</span></a><span>
</span><a name="line-2237"></a><span>        </span><a name="local-6989586621685213598"><a href="#local-6989586621685213598"><span class="hs-identifier">hie_timestamp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">modificationTimeIfExists</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ml_hie_file</span><span> </span><a href="#local-6989586621685213594"><span class="hs-identifier hs-var">location</span></a><span class="hs-special">)</span><span>
</span><a name="line-2238"></a><span>
</span><a name="line-2239"></a><span>        </span><a name="local-6989586621685213599"><a href="#local-6989586621685213599"><span class="hs-identifier">extra_sig_imports</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcBackpack.html#findExtraSigImports"><span class="hs-identifier hs-var">findExtraSigImports</span></a><span> </span><a href="#local-6989586621685213576"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685213587"><span class="hs-identifier hs-var">hsc_src</span></a><span> </span><a href="#local-6989586621685213593"><span class="hs-identifier hs-var">mod_name</span></a><span>
</span><a name="line-2240"></a><span>        </span><a name="local-6989586621685213600"><a href="#local-6989586621685213600"><span class="hs-identifier">required_by_imports</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcBackpack.html#implicitRequirements"><span class="hs-identifier hs-var">implicitRequirements</span></a><span> </span><a href="#local-6989586621685213576"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685213592"><span class="hs-identifier hs-var">the_imps</span></a><span>
</span><a name="line-2241"></a><span>
</span><a name="line-2242"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ModSummary</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ms_mod</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213595"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">,</span><span>
</span><a name="line-2243"></a><span>                             </span><span class="hs-identifier">ms_hsc_src</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213587"><span class="hs-identifier hs-var">hsc_src</span></a><span class="hs-special">,</span><span>
</span><a name="line-2244"></a><span>                             </span><span class="hs-identifier">ms_location</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213594"><span class="hs-identifier hs-var">location</span></a><span class="hs-special">,</span><span>
</span><a name="line-2245"></a><span>                             </span><span class="hs-identifier">ms_hspp_file</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213589"><span class="hs-identifier hs-var">hspp_fn</span></a><span class="hs-special">,</span><span>
</span><a name="line-2246"></a><span>                             </span><span class="hs-identifier">ms_hspp_opts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213588"><span class="hs-identifier hs-var">dflags'</span></a><span class="hs-special">,</span><span>
</span><a name="line-2247"></a><span>                             </span><span class="hs-identifier">ms_hspp_buf</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685213590"><span class="hs-identifier hs-var">buf</span></a><span class="hs-special">,</span><span>
</span><a name="line-2248"></a><span>                             </span><span class="hs-identifier">ms_parsed_mod</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span>
</span><a name="line-2249"></a><span>                             </span><span class="hs-identifier">ms_srcimps</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213591"><span class="hs-identifier hs-var">srcimps</span></a><span class="hs-special">,</span><span>
</span><a name="line-2250"></a><span>                             </span><span class="hs-identifier">ms_textual_imps</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213592"><span class="hs-identifier hs-var">the_imps</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685213599"><span class="hs-identifier hs-var">extra_sig_imports</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685213600"><span class="hs-identifier hs-var">required_by_imports</span></a><span class="hs-special">,</span><span>
</span><a name="line-2251"></a><span>                             </span><span class="hs-identifier">ms_hs_date</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213585"><span class="hs-identifier hs-var">src_timestamp</span></a><span class="hs-special">,</span><span>
</span><a name="line-2252"></a><span>                             </span><span class="hs-identifier">ms_iface_date</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213597"><span class="hs-identifier hs-var">hi_timestamp</span></a><span class="hs-special">,</span><span>
</span><a name="line-2253"></a><span>                             </span><span class="hs-identifier">ms_hie_date</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213598"><span class="hs-identifier hs-var">hie_timestamp</span></a><span class="hs-special">,</span><span>
</span><a name="line-2254"></a><span>                             </span><span class="hs-identifier">ms_obj_date</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213596"><span class="hs-identifier hs-var">obj_timestamp</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2255"></a><span>
</span><a name="line-2256"></a><span class="hs-identifier">findSummaryBySourceFile</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span>
</span><a name="line-2257"></a><a name="findSummaryBySourceFile"><a href="GhcMake.html#findSummaryBySourceFile"><span class="hs-identifier">findSummaryBySourceFile</span></a></a><span> </span><a name="local-6989586621685213610"><a href="#local-6989586621685213610"><span class="hs-identifier">summaries</span></a></a><span> </span><a name="local-6989586621685213611"><a href="#local-6989586621685213611"><span class="hs-identifier">file</span></a></a><span>
</span><a name="line-2258"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621685213612"><span class="hs-identifier hs-var">ms</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621685213612"><a href="#local-6989586621685213612"><span class="hs-identifier">ms</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213610"><span class="hs-identifier hs-var">summaries</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HsSrcFile</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">ms_hsc_src</span><span> </span><a href="#local-6989586621685213612"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-2259"></a><span>                                 </span><span class="hs-identifier hs-var">expectJust</span><span> </span><span class="hs-string">&quot;findSummaryBySourceFile&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ml_hs_file</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ms_location</span><span> </span><a href="#local-6989586621685213612"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621685213611"><span class="hs-identifier hs-var">file</span></a><span> </span><span class="hs-special">]</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2260"></a><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-2261"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621685213613"><a href="#local-6989586621685213613"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685213613"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-2262"></a><span>
</span><a name="line-2263"></a><span class="hs-comment">-- Summarise a module, and pick up source and timestamp.</span><span>
</span><a name="line-2264"></a><span class="hs-identifier">summariseModule</span><span>
</span><a name="line-2265"></a><span>          </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-2266"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GhcMake.html#NodeMap"><span class="hs-identifier hs-type">NodeMap</span></a><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-comment">-- Map of old summaries</span><span>
</span><a name="line-2267"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GhcMake.html#IsBoot"><span class="hs-identifier hs-type">IsBoot</span></a><span>             </span><span class="hs-comment">-- IsBoot &lt;=&gt; a {-# SOURCE #-} import</span><span>
</span><a name="line-2268"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span> </span><span class="hs-comment">-- Imported module to be summarised</span><span>
</span><a name="line-2269"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>               </span><span class="hs-comment">-- object code allowed?</span><span>
</span><a name="line-2270"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">StringBuffer</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">UTCTime</span><span class="hs-special">)</span><span>
</span><a name="line-2271"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ModuleName</span><span class="hs-special">]</span><span>               </span><span class="hs-comment">-- Modules to exclude</span><span>
</span><a name="line-2272"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">ErrMsg</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">)</span><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- Its new summary</span><span>
</span><a name="line-2273"></a><span>
</span><a name="line-2274"></a><a name="summariseModule"><a href="GhcMake.html#summariseModule"><span class="hs-identifier">summariseModule</span></a></a><span> </span><a name="local-6989586621685213614"><a href="#local-6989586621685213614"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621685213615"><a href="#local-6989586621685213615"><span class="hs-identifier">old_summary_map</span></a></a><span> </span><a name="local-6989586621685213616"><a href="#local-6989586621685213616"><span class="hs-identifier">is_boot</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621685213617"><a href="#local-6989586621685213617"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621685213618"><a href="#local-6989586621685213618"><span class="hs-identifier">wanted_mod</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2275"></a><span>                </span><a name="local-6989586621685213619"><a href="#local-6989586621685213619"><span class="hs-identifier">obj_allowed</span></a></a><span> </span><a name="local-6989586621685213620"><a href="#local-6989586621685213620"><span class="hs-identifier">maybe_buf</span></a></a><span> </span><a name="local-6989586621685213621"><a href="#local-6989586621685213621"><span class="hs-identifier">excl_mods</span></a></a><span>
</span><a name="line-2276"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685213618"><span class="hs-identifier hs-var">wanted_mod</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685213621"><span class="hs-identifier hs-var">excl_mods</span></a><span>
</span><a name="line-2277"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-2278"></a><span>
</span><a name="line-2279"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213663"><a href="#local-6989586621685213663"><span class="hs-identifier">old_summary</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213618"><span class="hs-identifier hs-var">wanted_mod</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685213616"><span class="hs-identifier hs-var">is_boot</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213615"><span class="hs-identifier hs-var">old_summary_map</span></a><span>
</span><a name="line-2280"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>          </span><span class="hs-comment">-- Find its new timestamp; all the</span><span>
</span><a name="line-2281"></a><span>                </span><span class="hs-comment">-- ModSummaries in the old map have valid ml_hs_files</span><span>
</span><a name="line-2282"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213664"><a href="#local-6989586621685213664"><span class="hs-identifier">location</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_location</span><span> </span><a href="#local-6989586621685213663"><span class="hs-identifier hs-var">old_summary</span></a><span>
</span><a name="line-2283"></a><span>            </span><a name="local-6989586621685213665"><a href="#local-6989586621685213665"><span class="hs-identifier">src_fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">expectJust</span><span> </span><span class="hs-string">&quot;summariseModule&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ml_hs_file</span><span> </span><a href="#local-6989586621685213664"><span class="hs-identifier hs-var">location</span></a><span class="hs-special">)</span><span>
</span><a name="line-2284"></a><span>
</span><a name="line-2285"></a><span>                </span><span class="hs-comment">-- check the modification time on the source file, and</span><span>
</span><a name="line-2286"></a><span>                </span><span class="hs-comment">-- return the cached summary if it hasn't changed.  If the</span><span>
</span><a name="line-2287"></a><span>                </span><span class="hs-comment">-- file has disappeared, we need to call the Finder again.</span><span>
</span><a name="line-2288"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685213620"><span class="hs-identifier hs-var">maybe_buf</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2289"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621685213666"><a href="#local-6989586621685213666"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685213623"><span class="hs-identifier hs-var">check_timestamp</span></a><span> </span><a href="#local-6989586621685213663"><span class="hs-identifier hs-var">old_summary</span></a><span> </span><a href="#local-6989586621685213664"><span class="hs-identifier hs-var">location</span></a><span> </span><a href="#local-6989586621685213665"><span class="hs-identifier hs-var">src_fn</span></a><span> </span><a href="#local-6989586621685213666"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-2290"></a><span>           </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2291"></a><span>                </span><a name="local-6989586621685213667"><a href="#local-6989586621685213667"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tryIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getModificationUTCTime</span><span> </span><a href="#local-6989586621685213665"><span class="hs-identifier hs-var">src_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-2292"></a><span>                </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685213667"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2293"></a><span>                   </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621685213668"><a href="#local-6989586621685213668"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685213623"><span class="hs-identifier hs-var">check_timestamp</span></a><span> </span><a href="#local-6989586621685213663"><span class="hs-identifier hs-var">old_summary</span></a><span> </span><a href="#local-6989586621685213664"><span class="hs-identifier hs-var">location</span></a><span> </span><a href="#local-6989586621685213665"><span class="hs-identifier hs-var">src_fn</span></a><span> </span><a href="#local-6989586621685213668"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-2294"></a><span>                   </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621685213669"><a href="#local-6989586621685213669"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isDoesNotExistError</span><span> </span><a href="#local-6989586621685213669"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685213624"><span class="hs-identifier hs-var">find_it</span></a><span>
</span><a name="line-2295"></a><span>                          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">ioError</span><span> </span><a href="#local-6989586621685213669"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-2296"></a><span>
</span><a name="line-2297"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213624"><span class="hs-identifier hs-var">find_it</span></a><span>
</span><a name="line-2298"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2299"></a><span>    </span><a name="local-6989586621685213622"><a href="#local-6989586621685213622"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685213614"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-2300"></a><span>
</span><a name="line-2301"></a><span>    </span><a name="local-6989586621685213623"><a href="#local-6989586621685213623"><span class="hs-identifier">check_timestamp</span></a></a><span> </span><a name="local-6989586621685213627"><a href="#local-6989586621685213627"><span class="hs-identifier">old_summary</span></a></a><span> </span><a name="local-6989586621685213628"><a href="#local-6989586621685213628"><span class="hs-identifier">location</span></a></a><span> </span><a name="local-6989586621685213629"><a href="#local-6989586621685213629"><span class="hs-identifier">src_fn</span></a></a><span> </span><a name="local-6989586621685213630"><a href="#local-6989586621685213630"><span class="hs-identifier">src_timestamp</span></a></a><span>
</span><a name="line-2302"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">ms_hs_date</span><span> </span><a href="#local-6989586621685213627"><span class="hs-identifier hs-var">old_summary</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621685213630"><span class="hs-identifier hs-var">src_timestamp</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-2303"></a><span>          </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_ForceRecomp</span><span> </span><a href="#local-6989586621685213622"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2304"></a><span>                </span><span class="hs-comment">-- update the object-file timestamp</span><span>
</span><a name="line-2305"></a><span>                </span><a name="local-6989586621685213631"><a href="#local-6989586621685213631"><span class="hs-identifier">obj_timestamp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-2306"></a><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isObjectTarget</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hscTarget</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685213614"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2307"></a><span>                       </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621685213619"><span class="hs-identifier hs-var">obj_allowed</span></a><span> </span><span class="hs-comment">-- bug #1205</span><span>
</span><a name="line-2308"></a><span>                       </span><span class="hs-keyword">then</span><span> </span><a href="GhcMake.html#getObjTimestamp"><span class="hs-identifier hs-var">getObjTimestamp</span></a><span> </span><a href="#local-6989586621685213628"><span class="hs-identifier hs-var">location</span></a><span> </span><a href="#local-6989586621685213616"><span class="hs-identifier hs-var">is_boot</span></a><span>
</span><a name="line-2309"></a><span>                       </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-2310"></a><span>                </span><a name="local-6989586621685213632"><a href="#local-6989586621685213632"><span class="hs-identifier">hi_timestamp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GhcMake.html#maybeGetIfaceDate"><span class="hs-identifier hs-var">maybeGetIfaceDate</span></a><span> </span><a href="#local-6989586621685213622"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685213628"><span class="hs-identifier hs-var">location</span></a><span>
</span><a name="line-2311"></a><span>                </span><a name="local-6989586621685213633"><a href="#local-6989586621685213633"><span class="hs-identifier">hie_timestamp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">modificationTimeIfExists</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ml_hie_file</span><span> </span><a href="#local-6989586621685213628"><span class="hs-identifier hs-var">location</span></a><span class="hs-special">)</span><span>
</span><a name="line-2312"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621685213627"><span class="hs-identifier hs-var">old_summary</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">ms_obj_date</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213631"><span class="hs-identifier hs-var">obj_timestamp</span></a><span>
</span><a name="line-2313"></a><span>                                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ms_iface_date</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213632"><span class="hs-identifier hs-var">hi_timestamp</span></a><span>
</span><a name="line-2314"></a><span>                                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ms_hie_date</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213633"><span class="hs-identifier hs-var">hie_timestamp</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2315"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2316"></a><span>                </span><span class="hs-comment">-- source changed: re-summarise.</span><span>
</span><a name="line-2317"></a><span>                </span><a href="#local-6989586621685213626"><span class="hs-identifier hs-var">new_summary</span></a><span> </span><a href="#local-6989586621685213628"><span class="hs-identifier hs-var">location</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ms_mod</span><span> </span><a href="#local-6989586621685213627"><span class="hs-identifier hs-var">old_summary</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213629"><span class="hs-identifier hs-var">src_fn</span></a><span> </span><a href="#local-6989586621685213630"><span class="hs-identifier hs-var">src_timestamp</span></a><span>
</span><a name="line-2318"></a><span>
</span><a name="line-2319"></a><span>    </span><a name="local-6989586621685213624"><a href="#local-6989586621685213624"><span class="hs-identifier">find_it</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2320"></a><span>        </span><a name="local-6989586621685213634"><a href="#local-6989586621685213634"><span class="hs-identifier">found</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Finder.html#findImportedModule"><span class="hs-identifier hs-var">findImportedModule</span></a><span> </span><a href="#local-6989586621685213614"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685213618"><span class="hs-identifier hs-var">wanted_mod</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-2321"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685213634"><span class="hs-identifier hs-var">found</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2322"></a><span>             </span><span class="hs-identifier hs-var">Found</span><span> </span><a name="local-6989586621685213635"><a href="#local-6989586621685213635"><span class="hs-identifier">location</span></a></a><span> </span><a name="local-6989586621685213636"><a href="#local-6989586621685213636"><span class="hs-identifier">mod</span></a></a><span>
</span><a name="line-2323"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ml_hs_file</span><span> </span><a href="#local-6989586621685213635"><span class="hs-identifier hs-var">location</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-2324"></a><span>                        </span><span class="hs-comment">-- Home package</span><span>
</span><a name="line-2325"></a><span>                         </span><a href="#local-6989586621685213625"><span class="hs-identifier hs-var">just_found</span></a><span> </span><a href="#local-6989586621685213635"><span class="hs-identifier hs-var">location</span></a><span> </span><a href="#local-6989586621685213636"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-2326"></a><span>
</span><a name="line-2327"></a><span>             </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-2328"></a><span>                        </span><span class="hs-comment">-- Not found</span><span>
</span><a name="line-2329"></a><span>                        </span><span class="hs-comment">-- (If it is TRULY not found at all, we'll</span><span>
</span><a name="line-2330"></a><span>                        </span><span class="hs-comment">-- error when we actually try to compile)</span><span>
</span><a name="line-2331"></a><span>
</span><a name="line-2332"></a><span>    </span><a name="local-6989586621685213625"><a href="#local-6989586621685213625"><span class="hs-identifier">just_found</span></a></a><span> </span><a name="local-6989586621685213637"><a href="#local-6989586621685213637"><span class="hs-identifier">location</span></a></a><span> </span><a name="local-6989586621685213638"><a href="#local-6989586621685213638"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2333"></a><span>                </span><span class="hs-comment">-- Adjust location to point to the hs-boot source file,</span><span>
</span><a name="line-2334"></a><span>                </span><span class="hs-comment">-- hi file, object file, when is_boot says so</span><span>
</span><a name="line-2335"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213639"><a href="#local-6989586621685213639"><span class="hs-identifier">location'</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="GhcMake.html#IsBoot"><span class="hs-identifier hs-var">IsBoot</span></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213616"><span class="hs-identifier hs-var">is_boot</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addBootSuffixLocn</span><span> </span><a href="#local-6989586621685213637"><span class="hs-identifier hs-var">location</span></a><span>
</span><a name="line-2336"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213637"><span class="hs-identifier hs-var">location</span></a><span>
</span><a name="line-2337"></a><span>            </span><a name="local-6989586621685213640"><a href="#local-6989586621685213640"><span class="hs-identifier">src_fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">expectJust</span><span> </span><span class="hs-string">&quot;summarise2&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ml_hs_file</span><span> </span><a href="#local-6989586621685213639"><span class="hs-identifier hs-var">location'</span></a><span class="hs-special">)</span><span>
</span><a name="line-2338"></a><span>
</span><a name="line-2339"></a><span>                </span><span class="hs-comment">-- Check that it exists</span><span>
</span><a name="line-2340"></a><span>                </span><span class="hs-comment">-- It might have been deleted since the Finder last found it</span><span>
</span><a name="line-2341"></a><span>        </span><a name="local-6989586621685213641"><a href="#local-6989586621685213641"><span class="hs-identifier">maybe_t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">modificationTimeIfExists</span><span> </span><a href="#local-6989586621685213640"><span class="hs-identifier hs-var">src_fn</span></a><span>
</span><a name="line-2342"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685213641"><span class="hs-identifier hs-var">maybe_t</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2343"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GhcMake.html#noHsFileErr"><span class="hs-identifier hs-var">noHsFileErr</span></a><span> </span><a href="#local-6989586621685213622"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685213617"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621685213640"><span class="hs-identifier hs-var">src_fn</span></a><span>
</span><a name="line-2344"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213642"><a href="#local-6989586621685213642"><span class="hs-identifier">t</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685213626"><span class="hs-identifier hs-var">new_summary</span></a><span> </span><a href="#local-6989586621685213639"><span class="hs-identifier hs-var">location'</span></a><span> </span><a href="#local-6989586621685213638"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621685213640"><span class="hs-identifier hs-var">src_fn</span></a><span> </span><a href="#local-6989586621685213642"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-2345"></a><span>
</span><a name="line-2346"></a><span>
</span><a name="line-2347"></a><span>    </span><a name="local-6989586621685213626"><a href="#local-6989586621685213626"><span class="hs-identifier">new_summary</span></a></a><span> </span><a name="local-6989586621685213643"><a href="#local-6989586621685213643"><span class="hs-identifier">location</span></a></a><span> </span><a name="local-6989586621685213644"><a href="#local-6989586621685213644"><span class="hs-identifier">mod</span></a></a><span> </span><a name="local-6989586621685213645"><a href="#local-6989586621685213645"><span class="hs-identifier">src_fn</span></a></a><span> </span><a name="local-6989586621685213646"><a href="#local-6989586621685213646"><span class="hs-identifier">src_timestamp</span></a></a><span>
</span><a name="line-2348"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2349"></a><span>        </span><span class="hs-comment">-- Preprocess the source file and get its imports</span><span>
</span><a name="line-2350"></a><span>        </span><span class="hs-comment">-- The dflags' contains the OPTIONS pragmas</span><span>
</span><a name="line-2351"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621685213647"><a href="#local-6989586621685213647"><span class="hs-identifier">dflags'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685213648"><a href="#local-6989586621685213648"><span class="hs-identifier">hspp_fn</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685213649"><a href="#local-6989586621685213649"><span class="hs-identifier">buf</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GhcMake.html#preprocessFile"><span class="hs-identifier hs-var">preprocessFile</span></a><span> </span><a href="#local-6989586621685213614"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685213645"><span class="hs-identifier hs-var">src_fn</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621685213620"><span class="hs-identifier hs-var">maybe_buf</span></a><span>
</span><a name="line-2352"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621685213650"><a href="#local-6989586621685213650"><span class="hs-identifier">srcimps</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685213651"><a href="#local-6989586621685213651"><span class="hs-identifier">the_imps</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621685213652"><a href="#local-6989586621685213652"><span class="hs-identifier">mod_loc</span></a></a><span> </span><a name="local-6989586621685213653"><a href="#local-6989586621685213653"><span class="hs-identifier">mod_name</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getImports</span><span> </span><a href="#local-6989586621685213647"><span class="hs-identifier hs-var">dflags'</span></a><span> </span><a href="#local-6989586621685213649"><span class="hs-identifier hs-var">buf</span></a><span> </span><a href="#local-6989586621685213648"><span class="hs-identifier hs-var">hspp_fn</span></a><span> </span><a href="#local-6989586621685213645"><span class="hs-identifier hs-var">src_fn</span></a><span>
</span><a name="line-2353"></a><span>
</span><a name="line-2354"></a><span>        </span><span class="hs-comment">-- NB: Despite the fact that is_boot is a top-level parameter, we</span><span>
</span><a name="line-2355"></a><span>        </span><span class="hs-comment">-- don't actually know coming into this function what the HscSource</span><span>
</span><a name="line-2356"></a><span>        </span><span class="hs-comment">-- of the module in question is.  This is because we may be processing</span><span>
</span><a name="line-2357"></a><span>        </span><span class="hs-comment">-- this module because another module in the graph imported it: in this</span><span>
</span><a name="line-2358"></a><span>        </span><span class="hs-comment">-- case, we know if it's a boot or not because of the {-# SOURCE #-}</span><span>
</span><a name="line-2359"></a><span>        </span><span class="hs-comment">-- annotation, but we don't know if it's a signature or a regular</span><span>
</span><a name="line-2360"></a><span>        </span><span class="hs-comment">-- module until we actually look it up on the filesystem.</span><span>
</span><a name="line-2361"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213654"><a href="#local-6989586621685213654"><span class="hs-identifier">hsc_src</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685213616"><span class="hs-identifier hs-var">is_boot</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2362"></a><span>                </span><a href="GhcMake.html#IsBoot"><span class="hs-identifier hs-var">IsBoot</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">HsBootFile</span><span>
</span><a name="line-2363"></a><span>                </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isHaskellSigFilename</span><span> </span><a href="#local-6989586621685213645"><span class="hs-identifier hs-var">src_fn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">HsigFile</span><span>
</span><a name="line-2364"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">HsSrcFile</span><span>
</span><a name="line-2365"></a><span>
</span><a name="line-2366"></a><span>        </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213653"><span class="hs-identifier hs-var">mod_name</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621685213618"><span class="hs-identifier hs-var">wanted_mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2367"></a><span>                </span><span class="hs-identifier hs-var">throwOneError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkPlainErrMsg</span><span> </span><a href="#local-6989586621685213647"><span class="hs-identifier hs-var">dflags'</span></a><span> </span><a href="#local-6989586621685213652"><span class="hs-identifier hs-var">mod_loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2368"></a><span>                              </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;File name does not match module name:&quot;</span><span>
</span><a name="line-2369"></a><span>                              </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Saw:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685213653"><span class="hs-identifier hs-var">mod_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-2370"></a><span>                              </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Expected:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685213618"><span class="hs-identifier hs-var">wanted_mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-2371"></a><span>
</span><a name="line-2372"></a><span>        </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213654"><span class="hs-identifier hs-var">hsc_src</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">HsigFile</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isNothing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621685213653"><span class="hs-identifier hs-var">mod_name</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">thisUnitIdInsts</span><span> </span><a href="#local-6989586621685213622"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2373"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213655"><a href="#local-6989586621685213655"><span class="hs-identifier">suggested_instantiated_with</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2374"></a><span>                    </span><span class="hs-identifier hs-var">hcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">punctuate</span><span> </span><span class="hs-identifier hs-var">comma</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2375"></a><span>                        </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685213656"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;=&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685213657"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-2376"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685213656"><a href="#local-6989586621685213656"><span class="hs-identifier">k</span></a></a><span class="hs-special">,</span><a name="local-6989586621685213657"><a href="#local-6989586621685213657"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621685213653"><span class="hs-identifier hs-var">mod_name</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkHoleModule</span><span> </span><a href="#local-6989586621685213653"><span class="hs-identifier hs-var">mod_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-2377"></a><span>                                </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">thisUnitIdInsts</span><span> </span><a href="#local-6989586621685213622"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-2378"></a><span>                        </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2379"></a><span>            </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">throwOneError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkPlainErrMsg</span><span> </span><a href="#local-6989586621685213647"><span class="hs-identifier hs-var">dflags'</span></a><span> </span><a href="#local-6989586621685213652"><span class="hs-identifier hs-var">mod_loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2380"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Unexpected signature:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685213653"><span class="hs-identifier hs-var">mod_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-2381"></a><span>                </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_BuildingCabalPackage</span><span> </span><a href="#local-6989586621685213622"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-2382"></a><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Try adding&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685213653"><span class="hs-identifier hs-var">mod_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-2383"></a><span>                            </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;to the&quot;</span><span>
</span><a name="line-2384"></a><span>                            </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;signatures&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-2385"></a><span>                            </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;field in your Cabal file.&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-2386"></a><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Try passing -instantiated-with=\&quot;&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-2387"></a><span>                                 </span><a href="#local-6989586621685213655"><span class="hs-identifier hs-var">suggested_instantiated_with</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\&quot;&quot;</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-2388"></a><span>                                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;replacing &lt;&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685213653"><span class="hs-identifier hs-var">mod_name</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;&gt; as necessary.&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-2389"></a><span>
</span><a name="line-2390"></a><span>                </span><span class="hs-comment">-- Find the object timestamp, and return the summary</span><span>
</span><a name="line-2391"></a><span>        </span><a name="local-6989586621685213658"><a href="#local-6989586621685213658"><span class="hs-identifier">obj_timestamp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-2392"></a><span>           </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isObjectTarget</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hscTarget</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685213614"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2393"></a><span>              </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621685213619"><span class="hs-identifier hs-var">obj_allowed</span></a><span> </span><span class="hs-comment">-- bug #1205</span><span>
</span><a name="line-2394"></a><span>              </span><span class="hs-keyword">then</span><span> </span><a href="GhcMake.html#getObjTimestamp"><span class="hs-identifier hs-var">getObjTimestamp</span></a><span> </span><a href="#local-6989586621685213643"><span class="hs-identifier hs-var">location</span></a><span> </span><a href="#local-6989586621685213616"><span class="hs-identifier hs-var">is_boot</span></a><span>
</span><a name="line-2395"></a><span>              </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-2396"></a><span>
</span><a name="line-2397"></a><span>        </span><a name="local-6989586621685213659"><a href="#local-6989586621685213659"><span class="hs-identifier">hi_timestamp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GhcMake.html#maybeGetIfaceDate"><span class="hs-identifier hs-var">maybeGetIfaceDate</span></a><span> </span><a href="#local-6989586621685213622"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685213643"><span class="hs-identifier hs-var">location</span></a><span>
</span><a name="line-2398"></a><span>        </span><a name="local-6989586621685213660"><a href="#local-6989586621685213660"><span class="hs-identifier">hie_timestamp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">modificationTimeIfExists</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ml_hie_file</span><span> </span><a href="#local-6989586621685213643"><span class="hs-identifier hs-var">location</span></a><span class="hs-special">)</span><span>
</span><a name="line-2399"></a><span>
</span><a name="line-2400"></a><span>        </span><a name="local-6989586621685213661"><a href="#local-6989586621685213661"><span class="hs-identifier">extra_sig_imports</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcBackpack.html#findExtraSigImports"><span class="hs-identifier hs-var">findExtraSigImports</span></a><span> </span><a href="#local-6989586621685213614"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685213654"><span class="hs-identifier hs-var">hsc_src</span></a><span> </span><a href="#local-6989586621685213653"><span class="hs-identifier hs-var">mod_name</span></a><span>
</span><a name="line-2401"></a><span>        </span><a name="local-6989586621685213662"><a href="#local-6989586621685213662"><span class="hs-identifier">required_by_imports</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcBackpack.html#implicitRequirements"><span class="hs-identifier hs-var">implicitRequirements</span></a><span> </span><a href="#local-6989586621685213614"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685213651"><span class="hs-identifier hs-var">the_imps</span></a><span>
</span><a name="line-2402"></a><span>
</span><a name="line-2403"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ModSummary</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ms_mod</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213644"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">,</span><span>
</span><a name="line-2404"></a><span>                              </span><span class="hs-identifier">ms_hsc_src</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213654"><span class="hs-identifier hs-var">hsc_src</span></a><span class="hs-special">,</span><span>
</span><a name="line-2405"></a><span>                              </span><span class="hs-identifier">ms_location</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213643"><span class="hs-identifier hs-var">location</span></a><span class="hs-special">,</span><span>
</span><a name="line-2406"></a><span>                              </span><span class="hs-identifier">ms_hspp_file</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213648"><span class="hs-identifier hs-var">hspp_fn</span></a><span class="hs-special">,</span><span>
</span><a name="line-2407"></a><span>                              </span><span class="hs-identifier">ms_hspp_opts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213647"><span class="hs-identifier hs-var">dflags'</span></a><span class="hs-special">,</span><span>
</span><a name="line-2408"></a><span>                              </span><span class="hs-identifier">ms_hspp_buf</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685213649"><span class="hs-identifier hs-var">buf</span></a><span class="hs-special">,</span><span>
</span><a name="line-2409"></a><span>                              </span><span class="hs-identifier">ms_parsed_mod</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span>
</span><a name="line-2410"></a><span>                              </span><span class="hs-identifier">ms_srcimps</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213650"><span class="hs-identifier hs-var">srcimps</span></a><span class="hs-special">,</span><span>
</span><a name="line-2411"></a><span>                              </span><span class="hs-identifier">ms_textual_imps</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213651"><span class="hs-identifier hs-var">the_imps</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685213661"><span class="hs-identifier hs-var">extra_sig_imports</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685213662"><span class="hs-identifier hs-var">required_by_imports</span></a><span class="hs-special">,</span><span>
</span><a name="line-2412"></a><span>                              </span><span class="hs-identifier">ms_hs_date</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213646"><span class="hs-identifier hs-var">src_timestamp</span></a><span class="hs-special">,</span><span>
</span><a name="line-2413"></a><span>                              </span><span class="hs-identifier">ms_iface_date</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213659"><span class="hs-identifier hs-var">hi_timestamp</span></a><span class="hs-special">,</span><span>
</span><a name="line-2414"></a><span>                              </span><span class="hs-identifier">ms_hie_date</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213660"><span class="hs-identifier hs-var">hie_timestamp</span></a><span class="hs-special">,</span><span>
</span><a name="line-2415"></a><span>                              </span><span class="hs-identifier">ms_obj_date</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685213658"><span class="hs-identifier hs-var">obj_timestamp</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2416"></a><span>
</span><a name="line-2417"></a><span>
</span><a name="line-2418"></a><span class="hs-identifier">getObjTimestamp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModLocation</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GhcMake.html#IsBoot"><span class="hs-identifier hs-type">IsBoot</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">UTCTime</span><span class="hs-special">)</span><span>
</span><a name="line-2419"></a><a name="getObjTimestamp"><a href="GhcMake.html#getObjTimestamp"><span class="hs-identifier">getObjTimestamp</span></a></a><span> </span><a name="local-6989586621685213670"><a href="#local-6989586621685213670"><span class="hs-identifier">location</span></a></a><span> </span><a name="local-6989586621685213671"><a href="#local-6989586621685213671"><span class="hs-identifier">is_boot</span></a></a><span>
</span><a name="line-2420"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621685213671"><span class="hs-identifier hs-var">is_boot</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="GhcMake.html#IsBoot"><span class="hs-identifier hs-var">IsBoot</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-2421"></a><span>                         </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">modificationTimeIfExists</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ml_obj_file</span><span> </span><a href="#local-6989586621685213670"><span class="hs-identifier hs-var">location</span></a><span class="hs-special">)</span><span>
</span><a name="line-2422"></a><span>
</span><a name="line-2423"></a><span>
</span><a name="line-2424"></a><span class="hs-identifier">preprocessFile</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-2425"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-2426"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Phase</span><span> </span><span class="hs-comment">-- ^ Starting phase</span><span>
</span><a name="line-2427"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">StringBuffer</span><span class="hs-special">,</span><span class="hs-identifier hs-type">UTCTime</span><span class="hs-special">)</span><span>
</span><a name="line-2428"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DynFlags</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">StringBuffer</span><span class="hs-special">)</span><span>
</span><a name="line-2429"></a><a name="preprocessFile"><a href="GhcMake.html#preprocessFile"><span class="hs-identifier">preprocessFile</span></a></a><span> </span><a name="local-6989586621685213672"><a href="#local-6989586621685213672"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621685213673"><a href="#local-6989586621685213673"><span class="hs-identifier">src_fn</span></a></a><span> </span><a name="local-6989586621685213674"><a href="#local-6989586621685213674"><span class="hs-identifier">mb_phase</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-2430"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2431"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621685213675"><a href="#local-6989586621685213675"><span class="hs-identifier">dflags'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685213676"><a href="#local-6989586621685213676"><span class="hs-identifier">hspp_fn</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#preprocess"><span class="hs-identifier hs-var">preprocess</span></a><span> </span><a href="#local-6989586621685213672"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213673"><span class="hs-identifier hs-var">src_fn</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685213674"><span class="hs-identifier hs-var">mb_phase</span></a><span class="hs-special">)</span><span>
</span><a name="line-2432"></a><span>        </span><a name="local-6989586621685213677"><a href="#local-6989586621685213677"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">hGetStringBuffer</span><span> </span><a href="#local-6989586621685213676"><span class="hs-identifier hs-var">hspp_fn</span></a><span>
</span><a name="line-2433"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213675"><span class="hs-identifier hs-var">dflags'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685213676"><span class="hs-identifier hs-var">hspp_fn</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685213677"><span class="hs-identifier hs-var">buf</span></a><span class="hs-special">)</span><span>
</span><a name="line-2434"></a><span>
</span><a name="line-2435"></a><span class="hs-identifier">preprocessFile</span><span> </span><a name="local-6989586621685213678"><a href="#local-6989586621685213678"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621685213679"><a href="#local-6989586621685213679"><span class="hs-identifier">src_fn</span></a></a><span> </span><a name="local-6989586621685213680"><a href="#local-6989586621685213680"><span class="hs-identifier">mb_phase</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685213681"><a href="#local-6989586621685213681"><span class="hs-identifier">buf</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685213682"><a href="#local-6989586621685213682"><span class="hs-identifier">_time</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2436"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2437"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213683"><a href="#local-6989586621685213683"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685213678"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-2438"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213684"><a href="#local-6989586621685213684"><span class="hs-identifier">local_opts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getOptions</span><span> </span><a href="#local-6989586621685213683"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685213681"><span class="hs-identifier hs-var">buf</span></a><span> </span><a href="#local-6989586621685213679"><span class="hs-identifier hs-var">src_fn</span></a><span>
</span><a name="line-2439"></a><span>
</span><a name="line-2440"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621685213685"><a href="#local-6989586621685213685"><span class="hs-identifier">dflags'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685213686"><a href="#local-6989586621685213686"><span class="hs-identifier">leftovers</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685213687"><a href="#local-6989586621685213687"><span class="hs-identifier">warns</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2441"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">parseDynamicFilePragma</span><span> </span><a href="#local-6989586621685213683"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685213684"><span class="hs-identifier hs-var">local_opts</span></a><span>
</span><a name="line-2442"></a><span>        </span><span class="hs-identifier hs-var">checkProcessArgsResult</span><span> </span><a href="#local-6989586621685213683"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685213686"><span class="hs-identifier hs-var">leftovers</span></a><span>
</span><a name="line-2443"></a><span>        </span><span class="hs-identifier hs-var">handleFlagWarnings</span><span> </span><a href="#local-6989586621685213685"><span class="hs-identifier hs-var">dflags'</span></a><span> </span><a href="#local-6989586621685213687"><span class="hs-identifier hs-var">warns</span></a><span>
</span><a name="line-2444"></a><span>
</span><a name="line-2445"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685213688"><a href="#local-6989586621685213688"><span class="hs-identifier">needs_preprocessing</span></a></a><span>
</span><a name="line-2446"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Unlit</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213680"><span class="hs-identifier hs-var">mb_phase</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2447"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213680"><span class="hs-identifier hs-var">mb_phase</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Unlit</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">startPhase</span><span> </span><a href="#local-6989586621685213679"><span class="hs-identifier hs-var">src_fn</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2448"></a><span>                  </span><span class="hs-comment">-- note: local_opts is only required if there's no Unlit phase</span><span>
</span><a name="line-2449"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">xopt</span><span> </span><span class="hs-identifier hs-var">LangExt.Cpp</span><span> </span><a href="#local-6989586621685213685"><span class="hs-identifier hs-var">dflags'</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2450"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_Pp</span><span>  </span><a href="#local-6989586621685213685"><span class="hs-identifier hs-var">dflags'</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2451"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2452"></a><span>
</span><a name="line-2453"></a><span>        </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621685213688"><span class="hs-identifier hs-var">needs_preprocessing</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2454"></a><span>           </span><span class="hs-identifier hs-var">throwGhcExceptionIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ProgramError</span><span> </span><span class="hs-string">&quot;buffer needs preprocesing; interactive check disabled&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-2455"></a><span>
</span><a name="line-2456"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213685"><span class="hs-identifier hs-var">dflags'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685213679"><span class="hs-identifier hs-var">src_fn</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685213681"><span class="hs-identifier hs-var">buf</span></a><span class="hs-special">)</span><span>
</span><a name="line-2457"></a><span>
</span><a name="line-2458"></a><span>
</span><a name="line-2459"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-2460"></a><span class="hs-comment">--                      Error messages</span><span>
</span><a name="line-2461"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-2462"></a><span>
</span><a name="line-2463"></a><span class="hs-identifier">noModError</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FindResult</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ErrMsg</span><span>
</span><a name="line-2464"></a><span class="hs-comment">-- ToDo: we don't have a proper line number for this error</span><span>
</span><a name="line-2465"></a><a name="noModError"><a href="GhcMake.html#noModError"><span class="hs-identifier">noModError</span></a></a><span> </span><a name="local-6989586621685213689"><a href="#local-6989586621685213689"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685213690"><a href="#local-6989586621685213690"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621685213691"><a href="#local-6989586621685213691"><span class="hs-identifier">wanted_mod</span></a></a><span> </span><a name="local-6989586621685213692"><a href="#local-6989586621685213692"><span class="hs-identifier">err</span></a></a><span>
</span><a name="line-2466"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkPlainErrMsg</span><span> </span><a href="#local-6989586621685213689"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685213690"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Finder.html#cannotFindModule"><span class="hs-identifier hs-var">cannotFindModule</span></a><span> </span><a href="#local-6989586621685213689"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685213691"><span class="hs-identifier hs-var">wanted_mod</span></a><span> </span><a href="#local-6989586621685213692"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-2467"></a><span>
</span><a name="line-2468"></a><span class="hs-identifier">noHsFileErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ErrMsg</span><span>
</span><a name="line-2469"></a><a name="noHsFileErr"><a href="GhcMake.html#noHsFileErr"><span class="hs-identifier">noHsFileErr</span></a></a><span> </span><a name="local-6989586621685213693"><a href="#local-6989586621685213693"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685213694"><a href="#local-6989586621685213694"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621685213695"><a href="#local-6989586621685213695"><span class="hs-identifier">path</span></a></a><span>
</span><a name="line-2470"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkPlainErrMsg</span><span> </span><a href="#local-6989586621685213693"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685213694"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Can't find&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621685213695"><span class="hs-identifier hs-var">path</span></a><span>
</span><a name="line-2471"></a><span>
</span><a name="line-2472"></a><span class="hs-identifier">moduleNotFoundErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ErrMsg</span><span>
</span><a name="line-2473"></a><a name="moduleNotFoundErr"><a href="GhcMake.html#moduleNotFoundErr"><span class="hs-identifier">moduleNotFoundErr</span></a></a><span> </span><a name="local-6989586621685213696"><a href="#local-6989586621685213696"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685213697"><a href="#local-6989586621685213697"><span class="hs-identifier">mod</span></a></a><span>
</span><a name="line-2474"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkPlainErrMsg</span><span> </span><a href="#local-6989586621685213696"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">noSrcSpan</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2475"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;module&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685213697"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;cannot be found locally&quot;</span><span>
</span><a name="line-2476"></a><span>
</span><a name="line-2477"></a><span class="hs-identifier">multiRootsErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2478"></a><a name="multiRootsErr"><a href="GhcMake.html#multiRootsErr"><span class="hs-identifier">multiRootsErr</span></a></a><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;multiRootsErr&quot;</span><span>
</span><a name="line-2479"></a><span class="hs-identifier">multiRootsErr</span><span> </span><a name="local-6989586621685213698"><a href="#local-6989586621685213698"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685213699"><a href="#local-6989586621685213699"><span class="hs-identifier">summs</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621685213700"><a href="#local-6989586621685213700"><span class="hs-identifier">summ1</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-2480"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">throwOneError</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkPlainErrMsg</span><span> </span><a href="#local-6989586621685213698"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">noSrcSpan</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2481"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;module&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685213701"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-2482"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is defined in multiple files:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-2483"></a><span>        </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621685213702"><span class="hs-identifier hs-var">files</span></a><span class="hs-special">)</span><span>
</span><a name="line-2484"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2485"></a><span>    </span><a name="local-6989586621685213701"><a href="#local-6989586621685213701"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_mod</span><span> </span><a href="#local-6989586621685213700"><span class="hs-identifier hs-var">summ1</span></a><span>
</span><a name="line-2486"></a><span>    </span><a name="local-6989586621685213702"><a href="#local-6989586621685213702"><span class="hs-identifier">files</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">expectJust</span><span> </span><span class="hs-string">&quot;checkDup&quot;</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">ml_hs_file</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">ms_location</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685213699"><span class="hs-identifier hs-var">summs</span></a><span>
</span><a name="line-2487"></a><span>
</span><a name="line-2488"></a><span class="hs-identifier">cyclicModuleErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2489"></a><span class="hs-comment">-- From a strongly connected component we find</span><span>
</span><a name="line-2490"></a><span class="hs-comment">-- a single cycle to report</span><span>
</span><a name="line-2491"></a><a name="cyclicModuleErr"><a href="GhcMake.html#cyclicModuleErr"><span class="hs-identifier">cyclicModuleErr</span></a></a><span> </span><a name="local-6989586621685213703"><a href="#local-6989586621685213703"><span class="hs-identifier">mss</span></a></a><span>
</span><a name="line-2492"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">null</span><span> </span><span class="hs-identifier">mss</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2493"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">findCycle</span><span> </span><a href="#local-6989586621685213704"><span class="hs-identifier hs-var">graph</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2494"></a><span>       </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Unexpected non-cycle&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685213703"><span class="hs-identifier hs-var">mss</span></a><span>
</span><a name="line-2495"></a><span>       </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685213720"><a href="#local-6989586621685213720"><span class="hs-identifier">path</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Module imports form a cycle:&quot;</span><span>
</span><a name="line-2496"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213706"><span class="hs-identifier hs-var">show_path</span></a><span> </span><a href="#local-6989586621685213720"><span class="hs-identifier hs-var">path</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2497"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2498"></a><span>    </span><span class="hs-identifier">graph</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Node</span><span> </span><a href="GhcMake.html#NodeKey"><span class="hs-identifier hs-type">NodeKey</span></a><span> </span><span class="hs-identifier hs-type">ModSummary</span><span class="hs-special">]</span><span>
</span><a name="line-2499"></a><span>    </span><a name="local-6989586621685213704"><a href="#local-6989586621685213704"><span class="hs-identifier">graph</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">DigraphNode</span><span> </span><a href="#local-6989586621685213708"><span class="hs-identifier hs-var">ms</span></a><span> </span><span class="hs-special">(</span><a href="GhcMake.html#msKey"><span class="hs-identifier hs-var">msKey</span></a><span> </span><a href="#local-6989586621685213708"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685213705"><span class="hs-identifier hs-var">get_deps</span></a><span> </span><a href="#local-6989586621685213708"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621685213708"><a href="#local-6989586621685213708"><span class="hs-identifier">ms</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685213703"><span class="hs-identifier hs-var">mss</span></a><span class="hs-special">]</span><span>
</span><a name="line-2500"></a><span>
</span><a name="line-2501"></a><span>    </span><span class="hs-identifier">get_deps</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="GhcMake.html#NodeKey"><span class="hs-identifier hs-type">NodeKey</span></a><span class="hs-special">]</span><span>
</span><a name="line-2502"></a><span>    </span><a name="local-6989586621685213705"><a href="#local-6989586621685213705"><span class="hs-identifier">get_deps</span></a></a><span> </span><a name="local-6989586621685213709"><a href="#local-6989586621685213709"><span class="hs-identifier">ms</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621685213710"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">,</span><span> </span><a href="GhcMake.html#IsBoot"><span class="hs-identifier hs-var">IsBoot</span></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621685213710"><a href="#local-6989586621685213710"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GhcMake.html#ms_home_srcimps"><span class="hs-identifier hs-var">ms_home_srcimps</span></a><span> </span><a href="#local-6989586621685213709"><span class="hs-identifier hs-var">ms</span></a><span> </span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-2503"></a><span>                   </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621685213711"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">,</span><span> </span><a href="GhcMake.html#NotBoot"><span class="hs-identifier hs-var">NotBoot</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621685213711"><a href="#local-6989586621685213711"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="GhcMake.html#ms_home_imps"><span class="hs-identifier hs-var">ms_home_imps</span></a><span>    </span><a href="#local-6989586621685213709"><span class="hs-identifier hs-var">ms</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2504"></a><span>
</span><a name="line-2505"></a><span>    </span><a name="local-6989586621685213706"><a href="#local-6989586621685213706"><span class="hs-identifier">show_path</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;show_path&quot;</span><span>
</span><a name="line-2506"></a><span>    </span><span class="hs-identifier">show_path</span><span> </span><span class="hs-special">[</span><a name="local-6989586621685213712"><a href="#local-6989586621685213712"><span class="hs-identifier">m</span></a></a><span class="hs-special">]</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;module&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621685213707"><span class="hs-identifier hs-var">ppr_ms</span></a><span> </span><a href="#local-6989586621685213712"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-2507"></a><span>                           </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;imports itself&quot;</span><span>
</span><a name="line-2508"></a><span>    </span><span class="hs-identifier">show_path</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685213713"><a href="#local-6989586621685213713"><span class="hs-identifier">m1</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621685213714"><a href="#local-6989586621685213714"><span class="hs-identifier">m2</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621685213715"><a href="#local-6989586621685213715"><span class="hs-identifier">ms</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">7</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;module&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621685213707"><span class="hs-identifier hs-var">ppr_ms</span></a><span> </span><a href="#local-6989586621685213713"><span class="hs-identifier hs-var">m1</span></a><span class="hs-special">)</span><span>
</span><a name="line-2509"></a><span>                                </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">6</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;imports&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621685213707"><span class="hs-identifier hs-var">ppr_ms</span></a><span> </span><a href="#local-6989586621685213714"><span class="hs-identifier hs-var">m2</span></a><span class="hs-special">)</span><span>
</span><a name="line-2510"></a><span>                                </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621685213716"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621685213715"><span class="hs-identifier hs-var">ms</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2511"></a><span>       </span><span class="hs-keyword">where</span><span>
</span><a name="line-2512"></a><span>         </span><a name="local-6989586621685213716"><a href="#local-6989586621685213716"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;which imports&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621685213707"><span class="hs-identifier hs-var">ppr_ms</span></a><span> </span><a href="#local-6989586621685213713"><span class="hs-identifier hs-var">m1</span></a><span class="hs-special">]</span><span>
</span><a name="line-2513"></a><span>         </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685213717"><a href="#local-6989586621685213717"><span class="hs-identifier">m</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621685213718"><a href="#local-6989586621685213718"><span class="hs-identifier">ms</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;which imports&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621685213707"><span class="hs-identifier hs-var">ppr_ms</span></a><span> </span><a href="#local-6989586621685213717"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621685213716"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621685213718"><span class="hs-identifier hs-var">ms</span></a><span>
</span><a name="line-2514"></a><span>
</span><a name="line-2515"></a><span>
</span><a name="line-2516"></a><span>    </span><span class="hs-identifier">ppr_ms</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2517"></a><span>    </span><a name="local-6989586621685213707"><a href="#local-6989586621685213707"><span class="hs-identifier">ppr_ms</span></a></a><span> </span><a name="local-6989586621685213719"><a href="#local-6989586621685213719"><span class="hs-identifier">ms</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ms_mod</span><span> </span><a href="#local-6989586621685213719"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-2518"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">msHsFilePath</span><span> </span><a href="#local-6989586621685213719"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2519"></a></pre></body></html>