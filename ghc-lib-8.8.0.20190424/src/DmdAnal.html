<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The GRASP/AQUA Project, Glasgow University, 1993-1998


                        -----------------
                        A demand analysis
                        -----------------
-}</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">DmdAnal</span><span> </span><span class="hs-special">(</span><span> </span><a href="DmdAnal.html#dmdAnalProgram"><span class="hs-identifier hs-var">dmdAnalProgram</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="WwLib.html"><span class="hs-identifier">WwLib</span></a><span>            </span><span class="hs-special">(</span><span> </span><a href="WwLib.html#findTypeShape"><span class="hs-identifier hs-var">findTypeShape</span></a><span class="hs-special">,</span><span> </span><a href="WwLib.html#deepSplitProductType_maybe"><span class="hs-identifier hs-var">deepSplitProductType_maybe</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Demand</span><span>   </span><span class="hs-comment">-- All of it</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreSyn</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreSeq</span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">seqBinds</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarEnv</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreUtils</span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">exprIsHNF</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">exprType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">exprIsTrivial</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">exprOkForSpeculation</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Coercion</span><span>         </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Coercion</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">coVarsOfCo</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FamInstEnv</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>           </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysWiredIn</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysPrim</span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">realWorldStatePrimTy</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span>         </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>             </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">getName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">stableNameCmp</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Function</span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">on</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSet</span><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Top level stuff}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-identifier">dmdAnalProgram</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FamInstEnvs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span>
</span><a name="line-52"></a><a name="dmdAnalProgram"><a href="DmdAnal.html#dmdAnalProgram"><span class="hs-identifier">dmdAnalProgram</span></a></a><span> </span><a name="local-6989586621684361905"><a href="#local-6989586621684361905"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684361906"><a href="#local-6989586621684361906"><span class="hs-identifier">fam_envs</span></a></a><span> </span><a name="local-6989586621684361907"><a href="#local-6989586621684361907"><span class="hs-identifier">binds</span></a></a><span>
</span><a name="line-53"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-54"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684361910"><a href="#local-6989586621684361910"><span class="hs-identifier">binds_plus_dmds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684361908"><span class="hs-identifier hs-var">do_prog</span></a><span> </span><a href="#local-6989586621684361907"><span class="hs-identifier hs-var">binds</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-55"></a><span>        </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621684361905"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_str_signatures</span><span>
</span><a name="line-56"></a><span>                      </span><span class="hs-string">&quot;Strictness signatures&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-57"></a><span>            </span><a href="DmdAnal.html#dumpStrSig"><span class="hs-identifier hs-var">dumpStrSig</span></a><span> </span><a href="#local-6989586621684361910"><span class="hs-identifier hs-var">binds_plus_dmds</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-58"></a><span>        </span><span class="hs-comment">-- See Note [Stamp out space leaks in demand analysis]</span><span>
</span><a name="line-59"></a><span>        </span><span class="hs-identifier hs-var">seqBinds</span><span> </span><a href="#local-6989586621684361910"><span class="hs-identifier hs-var">binds_plus_dmds</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684361910"><span class="hs-identifier hs-var">binds_plus_dmds</span></a><span>
</span><a name="line-60"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-61"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-62"></a><span>    </span><span class="hs-identifier">do_prog</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span>
</span><a name="line-63"></a><span>    </span><a name="local-6989586621684361908"><a href="#local-6989586621684361908"><span class="hs-identifier">do_prog</span></a></a><span> </span><a name="local-6989586621684361909"><a href="#local-6989586621684361909"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><a href="DmdAnal.html#dmdAnalTopBind"><span class="hs-identifier hs-var">dmdAnalTopBind</span></a><span> </span><span class="hs-special">(</span><a href="DmdAnal.html#emptyAnalEnv"><span class="hs-identifier hs-var">emptyAnalEnv</span></a><span> </span><a href="#local-6989586621684361905"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684361906"><span class="hs-identifier hs-var">fam_envs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684361909"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span class="hs-comment">-- Analyse a (group of) top-level binding(s)</span><span>
</span><a name="line-66"></a><span class="hs-identifier">dmdAnalTopBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span>
</span><a name="line-67"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreBind</span><span>
</span><a name="line-68"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CoreBind</span><span class="hs-special">)</span><span>
</span><a name="line-69"></a><a name="dmdAnalTopBind"><a href="DmdAnal.html#dmdAnalTopBind"><span class="hs-identifier">dmdAnalTopBind</span></a></a><span> </span><a name="local-6989586621684361911"><a href="#local-6989586621684361911"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a name="local-6989586621684361912"><a href="#local-6989586621684361912"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621684361913"><a href="#local-6989586621684361913"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="DmdAnal.html#extendAnalEnv"><span class="hs-identifier hs-var">extendAnalEnv</span></a><span> </span><span class="hs-identifier hs-var">TopLevel</span><span> </span><a href="#local-6989586621684361911"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684361915"><span class="hs-identifier hs-var">id2</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idStrictness</span><span> </span><a href="#local-6989586621684361915"><span class="hs-identifier hs-var">id2</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621684361915"><span class="hs-identifier hs-var">id2</span></a><span> </span><a href="#local-6989586621684361916"><span class="hs-identifier hs-var">rhs2</span></a><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-72"></a><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span>   </span><a name="local-6989586621684361914"><a href="#local-6989586621684361914"><span class="hs-identifier">rhs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#dmdAnalRhsLetDown"><span class="hs-identifier hs-var">dmdAnalRhsLetDown</span></a><span> </span><span class="hs-identifier hs-var">TopLevel</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621684361911"><span class="hs-identifier hs-var">env</span></a><span>             </span><span class="hs-identifier hs-var">cleanEvalDmd</span><span> </span><a href="#local-6989586621684361912"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684361913"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-73"></a><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684361915"><a href="#local-6989586621684361915"><span class="hs-identifier">id2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684361916"><a href="#local-6989586621684361916"><span class="hs-identifier">rhs2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#dmdAnalRhsLetDown"><span class="hs-identifier hs-var">dmdAnalRhsLetDown</span></a><span> </span><span class="hs-identifier hs-var">TopLevel</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">(</span><a href="DmdAnal.html#nonVirgin"><span class="hs-identifier hs-var">nonVirgin</span></a><span> </span><a href="#local-6989586621684361911"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">cleanEvalDmd</span><span> </span><a href="#local-6989586621684361912"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684361914"><span class="hs-identifier hs-var">rhs1</span></a><span>
</span><a name="line-74"></a><span>        </span><span class="hs-comment">-- Do two passes to improve CPR information</span><span>
</span><a name="line-75"></a><span>        </span><span class="hs-comment">-- See Note [CPR for thunks]</span><span>
</span><a name="line-76"></a><span>        </span><span class="hs-comment">-- See Note [Optimistic CPR in the &quot;virgin&quot; case]</span><span>
</span><a name="line-77"></a><span>        </span><span class="hs-comment">-- See Note [Initial CPR for strict binders]</span><span>
</span><a name="line-78"></a><span>
</span><a name="line-79"></a><span class="hs-identifier">dmdAnalTopBind</span><span> </span><a name="local-6989586621684361917"><a href="#local-6989586621684361917"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><a name="local-6989586621684361918"><a href="#local-6989586621684361918"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684361919"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Rec</span><span> </span><a href="#local-6989586621684361920"><span class="hs-identifier hs-var">pairs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-81"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-82"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684361919"><a href="#local-6989586621684361919"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684361920"><a href="#local-6989586621684361920"><span class="hs-identifier">pairs'</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#dmdFix"><span class="hs-identifier hs-var">dmdFix</span></a><span> </span><span class="hs-identifier hs-var">TopLevel</span><span> </span><a href="#local-6989586621684361917"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-identifier hs-var">cleanEvalDmd</span><span> </span><a href="#local-6989586621684361918"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-83"></a><span>                </span><span class="hs-comment">-- We get two iterations automatically</span><span>
</span><a name="line-84"></a><span>                </span><span class="hs-comment">-- c.f. the NonRec case above</span><span>
</span><a name="line-85"></a><span>
</span><a name="line-86"></a><span class="hs-comment">{- Note [Stamp out space leaks in demand analysis]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The demand analysis pass outputs a new copy of the Core program in
which binders have been annotated with demand and strictness
information. It's tiresome to ensure that this information is fully
evaluated everywhere that we produce it, so we just run a single
seqBinds over the output before returning it, to ensure that there are
no references holding on to the input Core program.

This makes a ~30% reduction in peak memory usage when compiling
DynFlags (cf Trac #9675 and #13426).

This is particularly important when we are doing late demand analysis,
since we don't do a seqBinds at any point thereafter. Hence code
generation would hold on to an extra copy of the Core program, via
unforced thunks in demand or strictness information; and it is the
most memory-intensive part of the compilation process, so this added
seqBinds makes a big difference in peak memory usage.
-}</span><span>
</span><a name="line-105"></a><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{The analyser itself}
*                                                                      *
************************************************************************

Note [Ensure demand is strict]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's important not to analyse e with a lazy demand because
a) When we encounter   case s of (a,b) -&gt;
        we demand s with U(d1d2)... but if the overall demand is lazy
        that is wrong, and we'd need to reduce the demand on s,
        which is inconvenient
b) More important, consider
        f (let x = R in x+x), where f is lazy
   We still want to mark x as demanded, because it will be when we
   enter the let.  If we analyse f's arg with a Lazy demand, we'll
   just mark x as Lazy
c) The application rule wouldn't be right either
   Evaluating (f x) in a L demand does *not* cause
   evaluation of f in a C(L) demand!
-}</span><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><span class="hs-comment">-- If e is complicated enough to become a thunk, its contents will be evaluated</span><span>
</span><a name="line-132"></a><span class="hs-comment">-- at most once, so oneify it.</span><span>
</span><a name="line-133"></a><span class="hs-identifier">dmdTransformThunkDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Demand</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Demand</span><span>
</span><a name="line-134"></a><a name="dmdTransformThunkDmd"><a href="DmdAnal.html#dmdTransformThunkDmd"><span class="hs-identifier">dmdTransformThunkDmd</span></a></a><span> </span><a name="local-6989586621684361921"><a href="#local-6989586621684361921"><span class="hs-identifier">e</span></a></a><span>
</span><a name="line-135"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">exprIsTrivial</span><span> </span><a href="#local-6989586621684361921"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-136"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">oneifyDmd</span><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span class="hs-comment">-- Do not process absent demands</span><span>
</span><a name="line-139"></a><span class="hs-comment">-- Otherwise act like in a normal demand analysis</span><span>
</span><a name="line-140"></a><span class="hs-comment">-- See &#8614;* relation in the Cardinality Analysis paper</span><span>
</span><a name="line-141"></a><span class="hs-identifier">dmdAnalStar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span>
</span><a name="line-142"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Demand</span><span>   </span><span class="hs-comment">-- This one takes a *Demand*</span><span>
</span><a name="line-143"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-comment">-- Should obey the let/app invariatn</span><span>
</span><a name="line-144"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">BothDmdArg</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span>
</span><a name="line-145"></a><a name="dmdAnalStar"><a href="DmdAnal.html#dmdAnalStar"><span class="hs-identifier">dmdAnalStar</span></a></a><span> </span><a name="local-6989586621684361922"><a href="#local-6989586621684361922"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684361923"><a href="#local-6989586621684361923"><span class="hs-identifier">dmd</span></a></a><span> </span><a name="local-6989586621684361924"><a href="#local-6989586621684361924"><span class="hs-identifier">e</span></a></a><span>
</span><a name="line-146"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684361925"><a href="#local-6989586621684361925"><span class="hs-identifier">dmd_shell</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684361926"><a href="#local-6989586621684361926"><span class="hs-identifier">cd</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">toCleanDmd</span><span> </span><a href="#local-6989586621684361923"><span class="hs-identifier hs-var">dmd</span></a><span>
</span><a name="line-147"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684361927"><a href="#local-6989586621684361927"><span class="hs-identifier">dmd_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684361928"><a href="#local-6989586621684361928"><span class="hs-identifier">e'</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a><span> </span><a href="#local-6989586621684361922"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684361926"><span class="hs-identifier hs-var">cd</span></a><span> </span><a href="#local-6989586621684361924"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-148"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isUnliftedType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprType</span><span> </span><span class="hs-identifier hs-var">e</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier">exprOkForSpeculation</span><span> </span><span class="hs-identifier hs-var">e</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-identifier hs-var">e</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-149"></a><span>    </span><span class="hs-comment">-- The argument 'e' should satisfy the let/app invariant</span><span>
</span><a name="line-150"></a><span>    </span><span class="hs-comment">-- See Note [Analysing with absent demand] in Demand.hs</span><span>
</span><a name="line-151"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">postProcessDmdType</span><span> </span><a href="#local-6989586621684361925"><span class="hs-identifier hs-var">dmd_shell</span></a><span> </span><a href="#local-6989586621684361927"><span class="hs-identifier hs-var">dmd_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684361928"><span class="hs-identifier hs-var">e'</span></a><span class="hs-special">)</span><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span class="hs-comment">-- Main Demand Analsysis machinery</span><span>
</span><a name="line-154"></a><span class="hs-identifier">dmdAnal</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dmdAnal'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span>
</span><a name="line-155"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CleanDemand</span><span>         </span><span class="hs-comment">-- The main one takes a *CleanDemand*</span><span>
</span><a name="line-156"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DmdType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span>
</span><a name="line-157"></a><span>
</span><a name="line-158"></a><span class="hs-comment">-- The CleanDemand is always strict and not absent</span><span>
</span><a name="line-159"></a><span class="hs-comment">--    See Note [Ensure demand is strict]</span><span>
</span><a name="line-160"></a><span>
</span><a name="line-161"></a><a name="dmdAnal"><a href="DmdAnal.html#dmdAnal"><span class="hs-identifier">dmdAnal</span></a></a><span> </span><a name="local-6989586621684361929"><a href="#local-6989586621684361929"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684361930"><a href="#local-6989586621684361930"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621684361931"><a href="#local-6989586621684361931"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;dmdAnal&quot; (ppr d &lt;+&gt; ppr e) $</span><span>
</span><a name="line-162"></a><span>                  </span><a href="DmdAnal.html#dmdAnal%27"><span class="hs-identifier hs-var">dmdAnal'</span></a><span> </span><a href="#local-6989586621684361929"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684361930"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621684361931"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-163"></a><span>
</span><a name="line-164"></a><a name="dmdAnal%27"><a href="DmdAnal.html#dmdAnal%27"><span class="hs-identifier">dmdAnal'</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Lit</span><span> </span><a name="local-6989586621684361932"><a href="#local-6989586621684361932"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nopDmdType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Lit</span><span> </span><a href="#local-6989586621684361932"><span class="hs-identifier hs-var">lit</span></a><span class="hs-special">)</span><span>
</span><a name="line-165"></a><span class="hs-identifier">dmdAnal'</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Type</span><span> </span><a name="local-6989586621684361933"><a href="#local-6989586621684361933"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nopDmdType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Type</span><span> </span><a href="#local-6989586621684361933"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- Doesn't happen, in fact</span><span>
</span><a name="line-166"></a><span class="hs-identifier">dmdAnal'</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Coercion</span><span> </span><a name="local-6989586621684361934"><a href="#local-6989586621684361934"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-167"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="DmdAnal.html#unitDmdType"><span class="hs-identifier hs-var">unitDmdType</span></a><span> </span><span class="hs-special">(</span><a href="DmdAnal.html#coercionDmdEnv"><span class="hs-identifier hs-var">coercionDmdEnv</span></a><span> </span><a href="#local-6989586621684361934"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Coercion</span><span> </span><a href="#local-6989586621684361934"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-168"></a><span>
</span><a name="line-169"></a><span class="hs-identifier">dmdAnal'</span><span> </span><a name="local-6989586621684361935"><a href="#local-6989586621684361935"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684361936"><a href="#local-6989586621684361936"><span class="hs-identifier">dmd</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a name="local-6989586621684361937"><a href="#local-6989586621684361937"><span class="hs-identifier">var</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-170"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="DmdAnal.html#dmdTransform"><span class="hs-identifier hs-var">dmdTransform</span></a><span> </span><a href="#local-6989586621684361935"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684361937"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621684361936"><span class="hs-identifier hs-var">dmd</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684361937"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span>
</span><a name="line-171"></a><span>
</span><a name="line-172"></a><span class="hs-identifier">dmdAnal'</span><span> </span><a name="local-6989586621684361938"><a href="#local-6989586621684361938"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684361939"><a href="#local-6989586621684361939"><span class="hs-identifier">dmd</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Cast</span><span> </span><a name="local-6989586621684361940"><a href="#local-6989586621684361940"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621684361941"><a href="#local-6989586621684361941"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-173"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684361942"><span class="hs-identifier hs-var">dmd_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">bothDmdType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">mkBothDmdArg</span><span> </span><span class="hs-special">(</span><a href="DmdAnal.html#coercionDmdEnv"><span class="hs-identifier hs-var">coercionDmdEnv</span></a><span> </span><a href="#local-6989586621684361941"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Cast</span><span> </span><a href="#local-6989586621684361943"><span class="hs-identifier hs-var">e'</span></a><span> </span><a href="#local-6989586621684361941"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-174"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-175"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684361942"><a href="#local-6989586621684361942"><span class="hs-identifier">dmd_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684361943"><a href="#local-6989586621684361943"><span class="hs-identifier">e'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a><span> </span><a href="#local-6989586621684361938"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684361939"><span class="hs-identifier hs-var">dmd</span></a><span> </span><a href="#local-6989586621684361940"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-176"></a><span>
</span><a name="line-177"></a><span class="hs-identifier">dmdAnal'</span><span> </span><a name="local-6989586621684361944"><a href="#local-6989586621684361944"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684361945"><a href="#local-6989586621684361945"><span class="hs-identifier">dmd</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Tick</span><span> </span><a name="local-6989586621684361946"><a href="#local-6989586621684361946"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621684361947"><a href="#local-6989586621684361947"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-178"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684361948"><span class="hs-identifier hs-var">dmd_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Tick</span><span> </span><a href="#local-6989586621684361946"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621684361949"><span class="hs-identifier hs-var">e'</span></a><span class="hs-special">)</span><span>
</span><a name="line-179"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-180"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684361948"><a href="#local-6989586621684361948"><span class="hs-identifier">dmd_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684361949"><a href="#local-6989586621684361949"><span class="hs-identifier">e'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a><span> </span><a href="#local-6989586621684361944"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684361945"><span class="hs-identifier hs-var">dmd</span></a><span> </span><a href="#local-6989586621684361947"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-181"></a><span>
</span><a name="line-182"></a><span class="hs-identifier">dmdAnal'</span><span> </span><a name="local-6989586621684361950"><a href="#local-6989586621684361950"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684361951"><a href="#local-6989586621684361951"><span class="hs-identifier">dmd</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">App</span><span> </span><a name="local-6989586621684361952"><a href="#local-6989586621684361952"><span class="hs-identifier">fun</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Type</span><span> </span><a name="local-6989586621684361953"><a href="#local-6989586621684361953"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-183"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684361954"><span class="hs-identifier hs-var">fun_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">App</span><span> </span><a href="#local-6989586621684361955"><span class="hs-identifier hs-var">fun'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Type</span><span> </span><a href="#local-6989586621684361953"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-184"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-185"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684361954"><a href="#local-6989586621684361954"><span class="hs-identifier">fun_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684361955"><a href="#local-6989586621684361955"><span class="hs-identifier">fun'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a><span> </span><a href="#local-6989586621684361950"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684361951"><span class="hs-identifier hs-var">dmd</span></a><span> </span><a href="#local-6989586621684361952"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-186"></a><span>
</span><a name="line-187"></a><span class="hs-comment">-- Lots of the other code is there to make this</span><span>
</span><a name="line-188"></a><span class="hs-comment">-- beautiful, compositional, application rule :-)</span><span>
</span><a name="line-189"></a><span class="hs-identifier">dmdAnal'</span><span> </span><a name="local-6989586621684361956"><a href="#local-6989586621684361956"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684361957"><a href="#local-6989586621684361957"><span class="hs-identifier">dmd</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">App</span><span> </span><a name="local-6989586621684361958"><a href="#local-6989586621684361958"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621684361959"><a href="#local-6989586621684361959"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-190"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- This case handles value arguments (type args handled above)</span><span>
</span><a name="line-191"></a><span>    </span><span class="hs-comment">-- Crucially, coercions /are/ handled here, because they are</span><span>
</span><a name="line-192"></a><span>    </span><span class="hs-comment">-- value arguments (Trac #10288)</span><span>
</span><a name="line-193"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-194"></a><span>        </span><a name="local-6989586621684361960"><a href="#local-6989586621684361960"><span class="hs-identifier">call_dmd</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkCallDmd</span><span> </span><a href="#local-6989586621684361957"><span class="hs-identifier hs-var">dmd</span></a><span>
</span><a name="line-195"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684361961"><a href="#local-6989586621684361961"><span class="hs-identifier">fun_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684361962"><a href="#local-6989586621684361962"><span class="hs-identifier">fun'</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a><span> </span><a href="#local-6989586621684361956"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684361960"><span class="hs-identifier hs-var">call_dmd</span></a><span> </span><a href="#local-6989586621684361958"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-196"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684361963"><a href="#local-6989586621684361963"><span class="hs-identifier">arg_dmd</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684361964"><a href="#local-6989586621684361964"><span class="hs-identifier">res_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitDmdTy</span><span> </span><a href="#local-6989586621684361961"><span class="hs-identifier hs-var">fun_ty</span></a><span>
</span><a name="line-197"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684361965"><a href="#local-6989586621684361965"><span class="hs-identifier">arg_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684361966"><a href="#local-6989586621684361966"><span class="hs-identifier">arg'</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#dmdAnalStar"><span class="hs-identifier hs-var">dmdAnalStar</span></a><span> </span><a href="#local-6989586621684361956"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="DmdAnal.html#dmdTransformThunkDmd"><span class="hs-identifier hs-var">dmdTransformThunkDmd</span></a><span> </span><a href="#local-6989586621684361959"><span class="hs-identifier hs-var">arg</span></a><span> </span><a href="#local-6989586621684361963"><span class="hs-identifier hs-var">arg_dmd</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684361959"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-198"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-199"></a><span class="hs-comment">--    pprTrace &quot;dmdAnal:app&quot; (vcat</span><span>
</span><a name="line-200"></a><span class="hs-comment">--         [ text &quot;dmd =&quot; &lt;+&gt; ppr dmd</span><span>
</span><a name="line-201"></a><span class="hs-comment">--         , text &quot;expr =&quot; &lt;+&gt; ppr (App fun arg)</span><span>
</span><a name="line-202"></a><span class="hs-comment">--         , text &quot;fun dmd_ty =&quot; &lt;+&gt; ppr fun_ty</span><span>
</span><a name="line-203"></a><span class="hs-comment">--         , text &quot;arg dmd =&quot; &lt;+&gt; ppr arg_dmd</span><span>
</span><a name="line-204"></a><span class="hs-comment">--         , text &quot;arg dmd_ty =&quot; &lt;+&gt; ppr arg_ty</span><span>
</span><a name="line-205"></a><span class="hs-comment">--         , text &quot;res dmd_ty =&quot; &lt;+&gt; ppr res_ty</span><span>
</span><a name="line-206"></a><span class="hs-comment">--         , text &quot;overall res dmd_ty =&quot; &lt;+&gt; ppr (res_ty `bothDmdType` arg_ty) ])</span><span>
</span><a name="line-207"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621684361964"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">bothDmdType</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684361965"><span class="hs-identifier hs-var">arg_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">App</span><span> </span><a href="#local-6989586621684361962"><span class="hs-identifier hs-var">fun'</span></a><span> </span><a href="#local-6989586621684361966"><span class="hs-identifier hs-var">arg'</span></a><span class="hs-special">)</span><span>
</span><a name="line-208"></a><span>
</span><a name="line-209"></a><span class="hs-comment">-- this is an anonymous lambda, since @dmdAnalRhsLetDown@ uses @collectBinders@</span><span>
</span><a name="line-210"></a><span class="hs-identifier">dmdAnal'</span><span> </span><a name="local-6989586621684361967"><a href="#local-6989586621684361967"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684361968"><a href="#local-6989586621684361968"><span class="hs-identifier">dmd</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Lam</span><span> </span><a name="local-6989586621684361969"><a href="#local-6989586621684361969"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621684361970"><a href="#local-6989586621684361970"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-211"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTyVar</span><span> </span><a href="#local-6989586621684361969"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-212"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-213"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684361971"><a href="#local-6989586621684361971"><span class="hs-identifier">body_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684361972"><a href="#local-6989586621684361972"><span class="hs-identifier">body'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a><span> </span><a href="#local-6989586621684361967"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684361968"><span class="hs-identifier hs-var">dmd</span></a><span> </span><a href="#local-6989586621684361970"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-214"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-215"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621684361971"><span class="hs-identifier hs-var">body_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Lam</span><span> </span><a href="#local-6989586621684361969"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621684361972"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">)</span><span>
</span><a name="line-216"></a><span>
</span><a name="line-217"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-218"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684361973"><a href="#local-6989586621684361973"><span class="hs-identifier">body_dmd</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684361974"><a href="#local-6989586621684361974"><span class="hs-identifier">defer_and_use</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">peelCallDmd</span><span> </span><a href="#local-6989586621684361968"><span class="hs-identifier hs-var">dmd</span></a><span>
</span><a name="line-219"></a><span>          </span><span class="hs-comment">-- body_dmd: a demand to analyze the body</span><span>
</span><a name="line-220"></a><span>
</span><a name="line-221"></a><span>        </span><a name="local-6989586621684361975"><a href="#local-6989586621684361975"><span class="hs-identifier">env'</span></a></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#extendSigsWithLam"><span class="hs-identifier hs-var">extendSigsWithLam</span></a><span> </span><a href="#local-6989586621684361967"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684361969"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-222"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684361976"><a href="#local-6989586621684361976"><span class="hs-identifier">body_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684361977"><a href="#local-6989586621684361977"><span class="hs-identifier">body'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a><span> </span><a href="#local-6989586621684361975"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621684361973"><span class="hs-identifier hs-var">body_dmd</span></a><span> </span><a href="#local-6989586621684361970"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-223"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684361978"><a href="#local-6989586621684361978"><span class="hs-identifier">lam_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684361979"><a href="#local-6989586621684361979"><span class="hs-identifier">var'</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#annotateLamIdBndr"><span class="hs-identifier hs-var">annotateLamIdBndr</span></a><span> </span><a href="#local-6989586621684361967"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="DmdAnal.html#notArgOfDfun"><span class="hs-identifier hs-var">notArgOfDfun</span></a><span> </span><a href="#local-6989586621684361976"><span class="hs-identifier hs-var">body_ty</span></a><span> </span><a href="#local-6989586621684361969"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-224"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-225"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">postProcessUnsat</span><span> </span><a href="#local-6989586621684361974"><span class="hs-identifier hs-var">defer_and_use</span></a><span> </span><a href="#local-6989586621684361978"><span class="hs-identifier hs-var">lam_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Lam</span><span> </span><a href="#local-6989586621684361979"><span class="hs-identifier hs-var">var'</span></a><span> </span><a href="#local-6989586621684361977"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">)</span><span>
</span><a name="line-226"></a><span>
</span><a name="line-227"></a><span class="hs-identifier">dmdAnal'</span><span> </span><a name="local-6989586621684361980"><a href="#local-6989586621684361980"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684361981"><a href="#local-6989586621684361981"><span class="hs-identifier">dmd</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Case</span><span> </span><a name="local-6989586621684361982"><a href="#local-6989586621684361982"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621684361983"><a href="#local-6989586621684361983"><span class="hs-identifier">case_bndr</span></a></a><span> </span><a name="local-6989586621684361984"><a href="#local-6989586621684361984"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataAlt</span><span> </span><a name="local-6989586621684361985"><a href="#local-6989586621684361985"><span class="hs-identifier">dc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684361986"><a href="#local-6989586621684361986"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684361987"><a href="#local-6989586621684361987"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-228"></a><span>  </span><span class="hs-comment">-- Only one alternative with a product constructor</span><span>
</span><a name="line-229"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684361988"><a href="#local-6989586621684361988"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConTyCon</span><span> </span><a href="#local-6989586621684361985"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-230"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isDataProductTyCon_maybe</span><span> </span><a href="#local-6989586621684361988"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span>
</span><a name="line-231"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684361989"><a href="#local-6989586621684361989"><span class="hs-identifier">rec_tc'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">checkRecTc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ae_rec_tc</span><span> </span><a href="#local-6989586621684361980"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684361988"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-232"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-233"></a><span>        </span><a name="local-6989586621684361990"><a href="#local-6989586621684361990"><span class="hs-identifier">env_w_tc</span></a></a><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684361980"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ae_rec_tc</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684361989"><span class="hs-identifier hs-var">rec_tc'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-234"></a><span>        </span><a name="local-6989586621684361991"><a href="#local-6989586621684361991"><span class="hs-identifier">env_alt</span></a></a><span>                  </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#extendEnvForProdAlt"><span class="hs-identifier hs-var">extendEnvForProdAlt</span></a><span> </span><a href="#local-6989586621684361990"><span class="hs-identifier hs-var">env_w_tc</span></a><span> </span><a href="#local-6989586621684361982"><span class="hs-identifier hs-var">scrut</span></a><span> </span><a href="#local-6989586621684361983"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><a href="#local-6989586621684361985"><span class="hs-identifier hs-var">dc</span></a><span> </span><a href="#local-6989586621684361986"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-235"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684361992"><a href="#local-6989586621684361992"><span class="hs-identifier">rhs_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684361993"><a href="#local-6989586621684361993"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a><span> </span><a href="#local-6989586621684361991"><span class="hs-identifier hs-var">env_alt</span></a><span> </span><a href="#local-6989586621684361981"><span class="hs-identifier hs-var">dmd</span></a><span> </span><a href="#local-6989586621684361987"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-236"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684361994"><a href="#local-6989586621684361994"><span class="hs-identifier">alt_ty1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684361995"><a href="#local-6989586621684361995"><span class="hs-identifier">dmds</span></a></a><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#findBndrsDmds"><span class="hs-identifier hs-var">findBndrsDmds</span></a><span> </span><a href="#local-6989586621684361980"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684361992"><span class="hs-identifier hs-var">rhs_ty</span></a><span> </span><a href="#local-6989586621684361986"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-237"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684361996"><a href="#local-6989586621684361996"><span class="hs-identifier">alt_ty2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684361997"><a href="#local-6989586621684361997"><span class="hs-identifier">case_bndr_dmd</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#findBndrDmd"><span class="hs-identifier hs-var">findBndrDmd</span></a><span> </span><a href="#local-6989586621684361980"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621684361994"><span class="hs-identifier hs-var">alt_ty1</span></a><span> </span><a href="#local-6989586621684361983"><span class="hs-identifier hs-var">case_bndr</span></a><span>
</span><a name="line-238"></a><span>        </span><a name="local-6989586621684361998"><a href="#local-6989586621684361998"><span class="hs-identifier">id_dmds</span></a></a><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addCaseBndrDmd</span><span> </span><a href="#local-6989586621684361997"><span class="hs-identifier hs-var">case_bndr_dmd</span></a><span> </span><a href="#local-6989586621684361995"><span class="hs-identifier hs-var">dmds</span></a><span>
</span><a name="line-239"></a><span>        </span><a name="local-6989586621684361999"><a href="#local-6989586621684361999"><span class="hs-identifier">alt_ty3</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="DmdAnal.html#io_hack_reqd"><span class="hs-identifier hs-var">io_hack_reqd</span></a><span> </span><a href="#local-6989586621684361982"><span class="hs-identifier hs-var">scrut</span></a><span> </span><a href="#local-6989586621684361985"><span class="hs-identifier hs-var">dc</span></a><span> </span><a href="#local-6989586621684361986"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">deferAfterIO</span><span> </span><a href="#local-6989586621684361996"><span class="hs-identifier hs-var">alt_ty2</span></a><span>
</span><a name="line-240"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684361996"><span class="hs-identifier hs-var">alt_ty2</span></a><span>
</span><a name="line-241"></a><span>
</span><a name="line-242"></a><span>        </span><span class="hs-comment">-- Compute demand on the scrutinee</span><span>
</span><a name="line-243"></a><span>        </span><span class="hs-comment">-- See Note [Demand on scrutinee of a product case]</span><span>
</span><a name="line-244"></a><span>        </span><a name="local-6989586621684362000"><a href="#local-6989586621684362000"><span class="hs-identifier">scrut_dmd</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkProdDmd</span><span> </span><a href="#local-6989586621684361998"><span class="hs-identifier hs-var">id_dmds</span></a><span>
</span><a name="line-245"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684362001"><a href="#local-6989586621684362001"><span class="hs-identifier">scrut_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362002"><a href="#local-6989586621684362002"><span class="hs-identifier">scrut'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a><span> </span><a href="#local-6989586621684361980"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684362000"><span class="hs-identifier hs-var">scrut_dmd</span></a><span> </span><a href="#local-6989586621684361982"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-246"></a><span>        </span><a name="local-6989586621684362003"><a href="#local-6989586621684362003"><span class="hs-identifier">res_ty</span></a></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684361999"><span class="hs-identifier hs-var">alt_ty3</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">bothDmdType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">toBothDmdArg</span><span> </span><a href="#local-6989586621684362001"><span class="hs-identifier hs-var">scrut_ty</span></a><span>
</span><a name="line-247"></a><span>        </span><a name="local-6989586621684362004"><a href="#local-6989586621684362004"><span class="hs-identifier">case_bndr'</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">setIdDemandInfo</span><span> </span><a href="#local-6989586621684361983"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><a href="#local-6989586621684361997"><span class="hs-identifier hs-var">case_bndr_dmd</span></a><span>
</span><a name="line-248"></a><span>        </span><a name="local-6989586621684362005"><a href="#local-6989586621684362005"><span class="hs-identifier">bndrs'</span></a></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#setBndrsDemandInfo"><span class="hs-identifier hs-var">setBndrsDemandInfo</span></a><span> </span><a href="#local-6989586621684361986"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621684361998"><span class="hs-identifier hs-var">id_dmds</span></a><span>
</span><a name="line-249"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-250"></a><span class="hs-comment">--    pprTrace &quot;dmdAnal:Case1&quot; (vcat [ text &quot;scrut&quot; &lt;+&gt; ppr scrut</span><span>
</span><a name="line-251"></a><span class="hs-comment">--                                   , text &quot;dmd&quot; &lt;+&gt; ppr dmd</span><span>
</span><a name="line-252"></a><span class="hs-comment">--                                   , text &quot;case_bndr_dmd&quot; &lt;+&gt; ppr (idDemandInfo case_bndr')</span><span>
</span><a name="line-253"></a><span class="hs-comment">--                                   , text &quot;id_dmds&quot; &lt;+&gt; ppr id_dmds</span><span>
</span><a name="line-254"></a><span class="hs-comment">--                                   , text &quot;scrut_dmd&quot; &lt;+&gt; ppr scrut_dmd</span><span>
</span><a name="line-255"></a><span class="hs-comment">--                                   , text &quot;scrut_ty&quot; &lt;+&gt; ppr scrut_ty</span><span>
</span><a name="line-256"></a><span class="hs-comment">--                                   , text &quot;alt_ty&quot; &lt;+&gt; ppr alt_ty2</span><span>
</span><a name="line-257"></a><span class="hs-comment">--                                   , text &quot;res_ty&quot; &lt;+&gt; ppr res_ty ]) $</span><span>
</span><a name="line-258"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621684362003"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Case</span><span> </span><a href="#local-6989586621684362002"><span class="hs-identifier hs-var">scrut'</span></a><span> </span><a href="#local-6989586621684362004"><span class="hs-identifier hs-var">case_bndr'</span></a><span> </span><a href="#local-6989586621684361984"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataAlt</span><span> </span><a href="#local-6989586621684361985"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684362005"><span class="hs-identifier hs-var">bndrs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684361993"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-259"></a><span>
</span><a name="line-260"></a><span class="hs-identifier">dmdAnal'</span><span> </span><a name="local-6989586621684362006"><a href="#local-6989586621684362006"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684362007"><a href="#local-6989586621684362007"><span class="hs-identifier">dmd</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Case</span><span> </span><a name="local-6989586621684362008"><a href="#local-6989586621684362008"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621684362009"><a href="#local-6989586621684362009"><span class="hs-identifier">case_bndr</span></a></a><span> </span><a name="local-6989586621684362010"><a href="#local-6989586621684362010"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621684362011"><a href="#local-6989586621684362011"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-261"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>      </span><span class="hs-comment">-- Case expression with multiple alternatives</span><span>
</span><a name="line-262"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684362012"><a href="#local-6989586621684362012"><span class="hs-identifier">alt_tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362013"><a href="#local-6989586621684362013"><span class="hs-identifier">alts'</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAndUnzip</span><span> </span><span class="hs-special">(</span><a href="DmdAnal.html#dmdAnalAlt"><span class="hs-identifier hs-var">dmdAnalAlt</span></a><span> </span><a href="#local-6989586621684362006"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684362007"><span class="hs-identifier hs-var">dmd</span></a><span> </span><a href="#local-6989586621684362009"><span class="hs-identifier hs-var">case_bndr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684362011"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-263"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684362014"><a href="#local-6989586621684362014"><span class="hs-identifier">scrut_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362015"><a href="#local-6989586621684362015"><span class="hs-identifier">scrut'</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a><span> </span><a href="#local-6989586621684362006"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-identifier hs-var">cleanEvalDmd</span><span> </span><a href="#local-6989586621684362008"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-264"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684362016"><a href="#local-6989586621684362016"><span class="hs-identifier">alt_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362017"><a href="#local-6989586621684362017"><span class="hs-identifier">case_bndr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#annotateBndr"><span class="hs-identifier hs-var">annotateBndr</span></a><span> </span><a href="#local-6989586621684362006"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-identifier hs-var">lubDmdType</span><span> </span><span class="hs-identifier hs-var">botDmdType</span><span> </span><a href="#local-6989586621684362012"><span class="hs-identifier hs-var">alt_tys</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684362009"><span class="hs-identifier hs-var">case_bndr</span></a><span>
</span><a name="line-265"></a><span>                               </span><span class="hs-comment">-- NB: Base case is botDmdType, for empty case alternatives</span><span>
</span><a name="line-266"></a><span>                               </span><span class="hs-comment">--     This is a unit for lubDmdType, and the right result</span><span>
</span><a name="line-267"></a><span>                               </span><span class="hs-comment">--     when there really are no alternatives</span><span>
</span><a name="line-268"></a><span>        </span><a name="local-6989586621684362018"><a href="#local-6989586621684362018"><span class="hs-identifier">res_ty</span></a></a><span>               </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362016"><span class="hs-identifier hs-var">alt_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">bothDmdType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">toBothDmdArg</span><span> </span><a href="#local-6989586621684362014"><span class="hs-identifier hs-var">scrut_ty</span></a><span>
</span><a name="line-269"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-270"></a><span class="hs-comment">--    pprTrace &quot;dmdAnal:Case2&quot; (vcat [ text &quot;scrut&quot; &lt;+&gt; ppr scrut</span><span>
</span><a name="line-271"></a><span class="hs-comment">--                                   , text &quot;scrut_ty&quot; &lt;+&gt; ppr scrut_ty</span><span>
</span><a name="line-272"></a><span class="hs-comment">--                                   , text &quot;alt_tys&quot; &lt;+&gt; ppr alt_tys</span><span>
</span><a name="line-273"></a><span class="hs-comment">--                                   , text &quot;alt_ty&quot; &lt;+&gt; ppr alt_ty</span><span>
</span><a name="line-274"></a><span class="hs-comment">--                                   , text &quot;res_ty&quot; &lt;+&gt; ppr res_ty ]) $</span><span>
</span><a name="line-275"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621684362018"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Case</span><span> </span><a href="#local-6989586621684362015"><span class="hs-identifier hs-var">scrut'</span></a><span> </span><a href="#local-6989586621684362017"><span class="hs-identifier hs-var">case_bndr'</span></a><span> </span><a href="#local-6989586621684362010"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621684362013"><span class="hs-identifier hs-var">alts'</span></a><span class="hs-special">)</span><span>
</span><a name="line-276"></a><span>
</span><a name="line-277"></a><span class="hs-comment">-- Let bindings can be processed in two ways:</span><span>
</span><a name="line-278"></a><span class="hs-comment">-- Down (RHS before body) or Up (body before RHS).</span><span>
</span><a name="line-279"></a><span class="hs-comment">-- The following case handle the up variant.</span><span>
</span><a name="line-280"></a><span class="hs-comment">--</span><span>
</span><a name="line-281"></a><span class="hs-comment">-- It is very simple. For  let x = rhs in body</span><span>
</span><a name="line-282"></a><span class="hs-comment">--   * Demand-analyse 'body' in the current environment</span><span>
</span><a name="line-283"></a><span class="hs-comment">--   * Find the demand, 'rhs_dmd' placed on 'x' by 'body'</span><span>
</span><a name="line-284"></a><span class="hs-comment">--   * Demand-analyse 'rhs' in 'rhs_dmd'</span><span>
</span><a name="line-285"></a><span class="hs-comment">--</span><span>
</span><a name="line-286"></a><span class="hs-comment">-- This is used for a non-recursive local let without manifest lambdas.</span><span>
</span><a name="line-287"></a><span class="hs-comment">-- This is the LetUp rule in the paper &#8220;Higher-Order Cardinality Analysis&#8221;.</span><span>
</span><a name="line-288"></a><span class="hs-identifier">dmdAnal'</span><span> </span><a name="local-6989586621684362019"><a href="#local-6989586621684362019"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684362020"><a href="#local-6989586621684362020"><span class="hs-identifier">dmd</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a name="local-6989586621684362021"><a href="#local-6989586621684362021"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621684362022"><a href="#local-6989586621684362022"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684362023"><a href="#local-6989586621684362023"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-289"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="DmdAnal.html#useLetUp"><span class="hs-identifier hs-var">useLetUp</span></a><span> </span><a href="#local-6989586621684362021"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684362022"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-290"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DmdAnal.html#unpackTrivial"><span class="hs-identifier hs-var">unpackTrivial</span></a><span> </span><a href="#local-6989586621684362022"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-291"></a><span>      </span><span class="hs-comment">-- dmdAnalRhsLetDown treats trivial right hand sides specially</span><span>
</span><a name="line-292"></a><span>      </span><span class="hs-comment">-- so if we have a trival right hand side, fall through to that.</span><span>
</span><a name="line-293"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684362031"><span class="hs-identifier hs-var">final_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621684362028"><span class="hs-identifier hs-var">id'</span></a><span> </span><a href="#local-6989586621684362030"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684362025"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">)</span><span>
</span><a name="line-294"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-295"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684362024"><a href="#local-6989586621684362024"><span class="hs-identifier">body_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362025"><a href="#local-6989586621684362025"><span class="hs-identifier">body'</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a><span> </span><a href="#local-6989586621684362019"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684362020"><span class="hs-identifier hs-var">dmd</span></a><span> </span><a href="#local-6989586621684362023"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-296"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684362026"><a href="#local-6989586621684362026"><span class="hs-identifier">body_ty'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362027"><a href="#local-6989586621684362027"><span class="hs-identifier">id_dmd</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#findBndrDmd"><span class="hs-identifier hs-var">findBndrDmd</span></a><span> </span><a href="#local-6989586621684362019"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="DmdAnal.html#notArgOfDfun"><span class="hs-identifier hs-var">notArgOfDfun</span></a><span> </span><a href="#local-6989586621684362024"><span class="hs-identifier hs-var">body_ty</span></a><span> </span><a href="#local-6989586621684362021"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-297"></a><span>    </span><a name="local-6989586621684362028"><a href="#local-6989586621684362028"><span class="hs-identifier">id'</span></a></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">setIdDemandInfo</span><span> </span><a href="#local-6989586621684362021"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684362027"><span class="hs-identifier hs-var">id_dmd</span></a><span>
</span><a name="line-298"></a><span>
</span><a name="line-299"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684362029"><a href="#local-6989586621684362029"><span class="hs-identifier">rhs_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362030"><a href="#local-6989586621684362030"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#dmdAnalStar"><span class="hs-identifier hs-var">dmdAnalStar</span></a><span> </span><a href="#local-6989586621684362019"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="DmdAnal.html#dmdTransformThunkDmd"><span class="hs-identifier hs-var">dmdTransformThunkDmd</span></a><span> </span><a href="#local-6989586621684362022"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621684362027"><span class="hs-identifier hs-var">id_dmd</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684362022"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-300"></a><span>    </span><a name="local-6989586621684362031"><a href="#local-6989586621684362031"><span class="hs-identifier">final_ty</span></a></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362026"><span class="hs-identifier hs-var">body_ty'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">bothDmdType</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684362029"><span class="hs-identifier hs-var">rhs_ty</span></a><span>
</span><a name="line-301"></a><span>
</span><a name="line-302"></a><span class="hs-identifier">dmdAnal'</span><span> </span><a name="local-6989586621684362032"><a href="#local-6989586621684362032"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684362033"><a href="#local-6989586621684362033"><span class="hs-identifier">dmd</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a name="local-6989586621684362034"><a href="#local-6989586621684362034"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621684362035"><a href="#local-6989586621684362035"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684362036"><a href="#local-6989586621684362036"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-303"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684362045"><span class="hs-identifier hs-var">body_ty2</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621684362044"><span class="hs-identifier hs-var">id2</span></a><span> </span><a href="#local-6989586621684362039"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684362042"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">)</span><span>
</span><a name="line-304"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-305"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684362037"><a href="#local-6989586621684362037"><span class="hs-identifier">lazy_fv</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362038"><a href="#local-6989586621684362038"><span class="hs-identifier">id1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362039"><a href="#local-6989586621684362039"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#dmdAnalRhsLetDown"><span class="hs-identifier hs-var">dmdAnalRhsLetDown</span></a><span> </span><span class="hs-identifier hs-var">NotTopLevel</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621684362032"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684362033"><span class="hs-identifier hs-var">dmd</span></a><span> </span><a href="#local-6989586621684362034"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684362035"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-306"></a><span>    </span><a name="local-6989586621684362040"><a href="#local-6989586621684362040"><span class="hs-identifier">env1</span></a></a><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#extendAnalEnv"><span class="hs-identifier hs-var">extendAnalEnv</span></a><span> </span><span class="hs-identifier hs-var">NotTopLevel</span><span> </span><a href="#local-6989586621684362032"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684362038"><span class="hs-identifier hs-var">id1</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idStrictness</span><span> </span><a href="#local-6989586621684362038"><span class="hs-identifier hs-var">id1</span></a><span class="hs-special">)</span><span>
</span><a name="line-307"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684362041"><a href="#local-6989586621684362041"><span class="hs-identifier">body_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362042"><a href="#local-6989586621684362042"><span class="hs-identifier">body'</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a><span> </span><a href="#local-6989586621684362040"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621684362033"><span class="hs-identifier hs-var">dmd</span></a><span> </span><a href="#local-6989586621684362036"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-308"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684362043"><a href="#local-6989586621684362043"><span class="hs-identifier">body_ty1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362044"><a href="#local-6989586621684362044"><span class="hs-identifier">id2</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#annotateBndr"><span class="hs-identifier hs-var">annotateBndr</span></a><span> </span><a href="#local-6989586621684362032"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684362041"><span class="hs-identifier hs-var">body_ty</span></a><span> </span><a href="#local-6989586621684362038"><span class="hs-identifier hs-var">id1</span></a><span>
</span><a name="line-309"></a><span>    </span><a name="local-6989586621684362045"><a href="#local-6989586621684362045"><span class="hs-identifier">body_ty2</span></a></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#addLazyFVs"><span class="hs-identifier hs-var">addLazyFVs</span></a><span> </span><a href="#local-6989586621684362043"><span class="hs-identifier hs-var">body_ty1</span></a><span> </span><a href="#local-6989586621684362037"><span class="hs-identifier hs-var">lazy_fv</span></a><span> </span><span class="hs-comment">-- see Note [Lazy and unleashable free variables]</span><span>
</span><a name="line-310"></a><span>
</span><a name="line-311"></a><span>        </span><span class="hs-comment">-- If the actual demand is better than the vanilla call</span><span>
</span><a name="line-312"></a><span>        </span><span class="hs-comment">-- demand, you might think that we might do better to re-analyse</span><span>
</span><a name="line-313"></a><span>        </span><span class="hs-comment">-- the RHS with the stronger demand.</span><span>
</span><a name="line-314"></a><span>        </span><span class="hs-comment">-- But (a) That seldom happens, because it means that *every* path in</span><span>
</span><a name="line-315"></a><span>        </span><span class="hs-comment">--         the body of the let has to use that stronger demand</span><span>
</span><a name="line-316"></a><span>        </span><span class="hs-comment">-- (b) It often happens temporarily in when fixpointing, because</span><span>
</span><a name="line-317"></a><span>        </span><span class="hs-comment">--     the recursive function at first seems to place a massive demand.</span><span>
</span><a name="line-318"></a><span>        </span><span class="hs-comment">--     But we don't want to go to extra work when the function will</span><span>
</span><a name="line-319"></a><span>        </span><span class="hs-comment">--     probably iterate to something less demanding.</span><span>
</span><a name="line-320"></a><span>        </span><span class="hs-comment">-- In practice, all the times the actual demand on id2 is more than</span><span>
</span><a name="line-321"></a><span>        </span><span class="hs-comment">-- the vanilla call demand seem to be due to (b).  So we don't</span><span>
</span><a name="line-322"></a><span>        </span><span class="hs-comment">-- bother to re-analyse the RHS.</span><span>
</span><a name="line-323"></a><span>
</span><a name="line-324"></a><span class="hs-identifier">dmdAnal'</span><span> </span><a name="local-6989586621684362046"><a href="#local-6989586621684362046"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684362047"><a href="#local-6989586621684362047"><span class="hs-identifier">dmd</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><a name="local-6989586621684362048"><a href="#local-6989586621684362048"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684362049"><a href="#local-6989586621684362049"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-325"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-326"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684362050"><a href="#local-6989586621684362050"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362051"><a href="#local-6989586621684362051"><span class="hs-identifier">lazy_fv</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362052"><a href="#local-6989586621684362052"><span class="hs-identifier">pairs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#dmdFix"><span class="hs-identifier hs-var">dmdFix</span></a><span> </span><span class="hs-identifier hs-var">NotTopLevel</span><span> </span><a href="#local-6989586621684362046"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684362047"><span class="hs-identifier hs-var">dmd</span></a><span> </span><a href="#local-6989586621684362048"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-327"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684362053"><a href="#local-6989586621684362053"><span class="hs-identifier">body_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362054"><a href="#local-6989586621684362054"><span class="hs-identifier">body'</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a><span> </span><a href="#local-6989586621684362050"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621684362047"><span class="hs-identifier hs-var">dmd</span></a><span> </span><a href="#local-6989586621684362049"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-328"></a><span>        </span><a name="local-6989586621684362055"><a href="#local-6989586621684362055"><span class="hs-identifier">body_ty1</span></a></a><span>                </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#deleteFVs"><span class="hs-identifier hs-var">deleteFVs</span></a><span> </span><a href="#local-6989586621684362053"><span class="hs-identifier hs-var">body_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621684362048"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">)</span><span>
</span><a name="line-329"></a><span>        </span><a name="local-6989586621684362056"><a href="#local-6989586621684362056"><span class="hs-identifier">body_ty2</span></a></a><span>                </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#addLazyFVs"><span class="hs-identifier hs-var">addLazyFVs</span></a><span> </span><a href="#local-6989586621684362055"><span class="hs-identifier hs-var">body_ty1</span></a><span> </span><a href="#local-6989586621684362051"><span class="hs-identifier hs-var">lazy_fv</span></a><span> </span><span class="hs-comment">-- see Note [Lazy and unleashable free variables]</span><span>
</span><a name="line-330"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-331"></a><span>    </span><a href="#local-6989586621684362056"><span class="hs-identifier hs-var">body_ty2</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span>
</span><a name="line-332"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621684362056"><span class="hs-identifier hs-var">body_ty2</span></a><span class="hs-special">,</span><span>  </span><span class="hs-identifier hs-var">Let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><a href="#local-6989586621684362052"><span class="hs-identifier hs-var">pairs'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684362054"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">)</span><span>
</span><a name="line-333"></a><span>
</span><a name="line-334"></a><span class="hs-identifier">io_hack_reqd</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Var</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-335"></a><span class="hs-comment">-- See Note [IO hack in the demand analyser]</span><span>
</span><a name="line-336"></a><a name="io_hack_reqd"><a href="DmdAnal.html#io_hack_reqd"><span class="hs-identifier">io_hack_reqd</span></a></a><span> </span><a name="local-6989586621684362057"><a href="#local-6989586621684362057"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621684362058"><a href="#local-6989586621684362058"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-6989586621684362059"><a href="#local-6989586621684362059"><span class="hs-identifier">bndrs</span></a></a><span>
</span><a name="line-337"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684362060"><a href="#local-6989586621684362060"><span class="hs-identifier">bndr</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684362059"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-338"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684362058"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">tupleDataCon</span><span> </span><span class="hs-identifier hs-var">Unboxed</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-339"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621684362060"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">realWorldStatePrimTy</span><span>
</span><a name="line-340"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684362061"><a href="#local-6989586621684362061"><span class="hs-identifier">fun</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">collectArgs</span><span> </span><a href="#local-6989586621684362057"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-341"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684362061"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-342"></a><span>      </span><span class="hs-identifier hs-var">Var</span><span> </span><a name="local-6989586621684362062"><a href="#local-6989586621684362062"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isPrimOpId</span><span> </span><a href="#local-6989586621684362062"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-343"></a><span>      </span><span class="hs-identifier">_</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-344"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-345"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-346"></a><span>
</span><a name="line-347"></a><span class="hs-identifier">dmdAnalAlt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CleanDemand</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Alt</span><span> </span><span class="hs-identifier hs-type">Var</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DmdType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Alt</span><span> </span><span class="hs-identifier hs-type">Var</span><span class="hs-special">)</span><span>
</span><a name="line-348"></a><a name="dmdAnalAlt"><a href="DmdAnal.html#dmdAnalAlt"><span class="hs-identifier">dmdAnalAlt</span></a></a><span> </span><a name="local-6989586621684362063"><a href="#local-6989586621684362063"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684362064"><a href="#local-6989586621684362064"><span class="hs-identifier">dmd</span></a></a><span> </span><a name="local-6989586621684362065"><a href="#local-6989586621684362065"><span class="hs-identifier">case_bndr</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684362066"><a href="#local-6989586621684362066"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><a name="local-6989586621684362067"><a href="#local-6989586621684362067"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><a name="local-6989586621684362068"><a href="#local-6989586621684362068"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-349"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621684362067"><span class="hs-identifier hs-var">bndrs</span></a><span>    </span><span class="hs-comment">-- Literals, DEFAULT, and nullary constructors</span><span>
</span><a name="line-350"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684362069"><a href="#local-6989586621684362069"><span class="hs-identifier">rhs_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362070"><a href="#local-6989586621684362070"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a><span> </span><a href="#local-6989586621684362063"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684362064"><span class="hs-identifier hs-var">dmd</span></a><span> </span><a href="#local-6989586621684362068"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-351"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684362069"><span class="hs-identifier hs-var">rhs_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684362066"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684362070"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-352"></a><span>
</span><a name="line-353"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>     </span><span class="hs-comment">-- Non-nullary data constructors</span><span>
</span><a name="line-354"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684362071"><a href="#local-6989586621684362071"><span class="hs-identifier">rhs_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362072"><a href="#local-6989586621684362072"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a><span> </span><a href="#local-6989586621684362063"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684362064"><span class="hs-identifier hs-var">dmd</span></a><span> </span><a href="#local-6989586621684362068"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-355"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684362073"><a href="#local-6989586621684362073"><span class="hs-identifier">alt_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362074"><a href="#local-6989586621684362074"><span class="hs-identifier">dmds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DmdAnal.html#findBndrsDmds"><span class="hs-identifier hs-var">findBndrsDmds</span></a><span> </span><a href="#local-6989586621684362063"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684362071"><span class="hs-identifier hs-var">rhs_ty</span></a><span> </span><a href="#local-6989586621684362067"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-356"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684362075"><a href="#local-6989586621684362075"><span class="hs-identifier">case_bndr_dmd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">findIdDemand</span><span> </span><a href="#local-6989586621684362073"><span class="hs-identifier hs-var">alt_ty</span></a><span> </span><a href="#local-6989586621684362065"><span class="hs-identifier hs-var">case_bndr</span></a><span>
</span><a name="line-357"></a><span>        </span><a name="local-6989586621684362076"><a href="#local-6989586621684362076"><span class="hs-identifier">id_dmds</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addCaseBndrDmd</span><span> </span><a href="#local-6989586621684362075"><span class="hs-identifier hs-var">case_bndr_dmd</span></a><span> </span><a href="#local-6989586621684362074"><span class="hs-identifier hs-var">dmds</span></a><span>
</span><a name="line-358"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684362073"><span class="hs-identifier hs-var">alt_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684362066"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="DmdAnal.html#setBndrsDemandInfo"><span class="hs-identifier hs-var">setBndrsDemandInfo</span></a><span> </span><a href="#local-6989586621684362067"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621684362076"><span class="hs-identifier hs-var">id_dmds</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684362072"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-359"></a><span>
</span><a name="line-360"></a><span>
</span><a name="line-361"></a><span class="hs-comment">{- Note [IO hack in the demand analyser]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
There's a hack here for I/O operations.  Consider

     case foo x s of { (# s', r #) -&gt; y }

Is this strict in 'y'? Often not! If foo x s performs some observable action
(including raising an exception with raiseIO#, modifying a mutable variable, or
even ending the program normally), then we must not force 'y' (which may fail
to terminate) until we have performed foo x s.

Hackish solution: spot the IO-like situation and add a virtual branch,
as if we had
     case foo x s of
        (# s, r #) -&gt; y
        other      -&gt; return ()
So the 'y' isn't necessarily going to be evaluated

A more complete example (Trac #148, #1592) where this shows up is:
     do { let len = &lt;expensive&gt; ;
        ; when (...) (exitWith ExitSuccess)
        ; print len }

However, consider
  f x s = case getMaskingState# s of
            (# s, r #) -&gt;
          case x of I# x2 -&gt; ...

Here it is terribly sad to make 'f' lazy in 's'.  After all,
getMaskingState# is not going to diverge or throw an exception!  This
situation actually arises in GHC.IO.Handle.Internals.wantReadableHandle
(on an MVar not an Int), and made a material difference.

So if the scrutinee is a primop call, we *don't* apply the
state hack:
  - If it is a simple, terminating one like getMaskingState,
    applying the hack is over-conservative.
  - If the primop is raise# then it returns bottom, so
    the case alternatives are already discarded.
  - If the primop can raise a non-IO exception, like
    divide by zero or seg-fault (eg writing an array
    out of bounds) then we don't mind evaluating 'x' first.

Note [Demand on the scrutinee of a product case]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When figuring out the demand on the scrutinee of a product case,
we use the demands of the case alternative, i.e. id_dmds.
But note that these include the demand on the case binder;
see Note [Demand on case-alternative binders] in Demand.hs.
This is crucial. Example:
   f x = case x of y { (a,b) -&gt; k y a }
If we just take scrut_demand = U(L,A), then we won't pass x to the
worker, so the worker will rebuild
     x = (a, absent-error)
and that'll crash.

Note [Aggregated demand for cardinality]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We use different strategies for strictness and usage/cardinality to
&quot;unleash&quot; demands captured on free variables by bindings. Let us
consider the example:

f1 y = let {-# NOINLINE h #-}
           h = y
       in  (h, h)

We are interested in obtaining cardinality demand U1 on |y|, as it is
used only in a thunk, and, therefore, is not going to be updated any
more. Therefore, the demand on |y|, captured and unleashed by usage of
|h| is U1. However, if we unleash this demand every time |h| is used,
and then sum up the effects, the ultimate demand on |y| will be U1 +
U1 = U. In order to avoid it, we *first* collect the aggregate demand
on |h| in the body of let-expression, and only then apply the demand
transformer:

transf[x](U) = {y |-&gt; U1}

so the resulting demand on |y| is U1.

The situation is, however, different for strictness, where this
aggregating approach exhibits worse results because of the nature of
|both| operation for strictness. Consider the example:

f y c =
  let h x = y |seq| x
   in case of
        True  -&gt; h True
        False -&gt; y

It is clear that |f| is strict in |y|, however, the suggested analysis
will infer from the body of |let| that |h| is used lazily (as it is
used in one branch only), therefore lazy demand will be put on its
free variable |y|. Conversely, if the demand on |h| is unleashed right
on the spot, we will get the desired result, namely, that |f| is
strict in |y|.


************************************************************************
*                                                                      *
                    Demand transformer
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-464"></a><span>
</span><a name="line-465"></a><span class="hs-identifier">dmdTransform</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span>         </span><span class="hs-comment">-- The strictness environment</span><span>
</span><a name="line-466"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span>              </span><span class="hs-comment">-- The function</span><span>
</span><a name="line-467"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CleanDemand</span><span>     </span><span class="hs-comment">-- The demand on the function</span><span>
</span><a name="line-468"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DmdType</span><span>         </span><span class="hs-comment">-- The demand type of the function in this context</span><span>
</span><a name="line-469"></a><span>        </span><span class="hs-comment">-- Returned DmdEnv includes the demand on</span><span>
</span><a name="line-470"></a><span>        </span><span class="hs-comment">-- this function plus demand on its free variables</span><span>
</span><a name="line-471"></a><span>
</span><a name="line-472"></a><a name="dmdTransform"><a href="DmdAnal.html#dmdTransform"><span class="hs-identifier">dmdTransform</span></a></a><span> </span><a name="local-6989586621684362077"><a href="#local-6989586621684362077"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684362078"><a href="#local-6989586621684362078"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621684362079"><a href="#local-6989586621684362079"><span class="hs-identifier">dmd</span></a></a><span>
</span><a name="line-473"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isDataConWorkId</span><span> </span><a href="#local-6989586621684362078"><span class="hs-identifier hs-var">var</span></a><span>                          </span><span class="hs-comment">-- Data constructor</span><span>
</span><a name="line-474"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dmdTransformDataConSig</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idArity</span><span> </span><a href="#local-6989586621684362078"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idStrictness</span><span> </span><a href="#local-6989586621684362078"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684362079"><span class="hs-identifier hs-var">dmd</span></a><span>
</span><a name="line-475"></a><span>
</span><a name="line-476"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_DmdTxDictSel</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ae_dflags</span><span> </span><a href="#local-6989586621684362077"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-477"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">isClassOpId_maybe</span><span> </span><a href="#local-6989586621684362078"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-comment">-- Dictionary component selector</span><span>
</span><a name="line-478"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dmdTransformDictSelSig</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idStrictness</span><span> </span><a href="#local-6989586621684362078"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684362079"><span class="hs-identifier hs-var">dmd</span></a><span>
</span><a name="line-479"></a><span>
</span><a name="line-480"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isGlobalId</span><span> </span><a href="#local-6989586621684362078"><span class="hs-identifier hs-var">var</span></a><span>                               </span><span class="hs-comment">-- Imported function</span><span>
</span><a name="line-481"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684362080"><a href="#local-6989586621684362080"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dmdTransformSig</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idStrictness</span><span> </span><a href="#local-6989586621684362078"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684362079"><span class="hs-identifier hs-var">dmd</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-482"></a><span class="hs-comment">--    pprTrace &quot;dmdTransform&quot; (vcat [ppr var, ppr (idStrictness var), ppr dmd, ppr res])</span><span>
</span><a name="line-483"></a><span>    </span><a href="#local-6989586621684362080"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-484"></a><span>
</span><a name="line-485"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684362081"><a href="#local-6989586621684362081"><span class="hs-identifier">sig</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362082"><a href="#local-6989586621684362082"><span class="hs-identifier">top_lvl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DmdAnal.html#lookupSigEnv"><span class="hs-identifier hs-var">lookupSigEnv</span></a><span> </span><a href="#local-6989586621684362077"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684362078"><span class="hs-identifier hs-var">var</span></a><span>  </span><span class="hs-comment">-- Local letrec bound thing</span><span>
</span><a name="line-486"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684362083"><a href="#local-6989586621684362083"><span class="hs-identifier">fn_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dmdTransformSig</span><span> </span><a href="#local-6989586621684362081"><span class="hs-identifier hs-var">sig</span></a><span> </span><a href="#local-6989586621684362079"><span class="hs-identifier hs-var">dmd</span></a><span>
</span><a name="line-487"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;dmdTransform&quot; (vcat [ppr var, ppr sig, ppr dmd, ppr fn_ty]) $</span><span>
</span><a name="line-488"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isTopLevel</span><span> </span><a href="#local-6989586621684362082"><span class="hs-identifier hs-var">top_lvl</span></a><span>
</span><a name="line-489"></a><span>    </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621684362083"><span class="hs-identifier hs-var">fn_ty</span></a><span>   </span><span class="hs-comment">-- Don't record top level things</span><span>
</span><a name="line-490"></a><span>    </span><span class="hs-keyword">else</span><span> </span><a href="DmdAnal.html#addVarDmd"><span class="hs-identifier hs-var">addVarDmd</span></a><span> </span><a href="#local-6989586621684362083"><span class="hs-identifier hs-var">fn_ty</span></a><span> </span><a href="#local-6989586621684362078"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkOnceUsedDmd</span><span> </span><a href="#local-6989586621684362079"><span class="hs-identifier hs-var">dmd</span></a><span class="hs-special">)</span><span>
</span><a name="line-491"></a><span>
</span><a name="line-492"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                                    </span><span class="hs-comment">-- Local non-letrec-bound thing</span><span>
</span><a name="line-493"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#unitDmdType"><span class="hs-identifier hs-var">unitDmdType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitVarEnv</span><span> </span><a href="#local-6989586621684362078"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkOnceUsedDmd</span><span> </span><a href="#local-6989586621684362079"><span class="hs-identifier hs-var">dmd</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-494"></a><span>
</span><a name="line-495"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Bindings}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-502"></a><span>
</span><a name="line-503"></a><span class="hs-comment">-- Recursive bindings</span><span>
</span><a name="line-504"></a><span class="hs-identifier">dmdFix</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span>
</span><a name="line-505"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span>                            </span><span class="hs-comment">-- Does not include bindings for this binding</span><span>
</span><a name="line-506"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CleanDemand</span><span>
</span><a name="line-507"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-508"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DmdEnv</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Binders annotated with stricness info</span><span>
</span><a name="line-509"></a><span>
</span><a name="line-510"></a><a name="dmdFix"><a href="DmdAnal.html#dmdFix"><span class="hs-identifier">dmdFix</span></a></a><span> </span><a name="local-6989586621684362084"><a href="#local-6989586621684362084"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621684362085"><a href="#local-6989586621684362085"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684362086"><a href="#local-6989586621684362086"><span class="hs-identifier">let_dmd</span></a></a><span> </span><a name="local-6989586621684362087"><a href="#local-6989586621684362087"><span class="hs-identifier">orig_pairs</span></a></a><span>
</span><a name="line-511"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362091"><span class="hs-identifier hs-var">loop</span></a><span> </span><span class="hs-number">1</span><span> </span><a href="#local-6989586621684362089"><span class="hs-identifier hs-var">initial_pairs</span></a><span>
</span><a name="line-512"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-513"></a><span>    </span><a name="local-6989586621684362088"><a href="#local-6989586621684362088"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621684362087"><span class="hs-identifier hs-var">orig_pairs</span></a><span>
</span><a name="line-514"></a><span>
</span><a name="line-515"></a><span>    </span><span class="hs-comment">-- See Note [Initialising strictness]</span><span>
</span><a name="line-516"></a><span>    </span><a name="local-6989586621684362089"><a href="#local-6989586621684362089"><span class="hs-identifier">initial_pairs</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">ae_virgin</span><span> </span><a href="#local-6989586621684362085"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">setIdStrictness</span><span> </span><a href="#local-6989586621684362094"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-identifier hs-var">botSig</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684362095"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684362094"><a href="#local-6989586621684362094"><span class="hs-identifier">id</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362095"><a href="#local-6989586621684362095"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684362087"><span class="hs-identifier hs-var">orig_pairs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-517"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362087"><span class="hs-identifier hs-var">orig_pairs</span></a><span>
</span><a name="line-518"></a><span>
</span><a name="line-519"></a><span>    </span><span class="hs-comment">-- If fixed-point iteration does not yield a result we use this instead</span><span>
</span><a name="line-520"></a><span>    </span><span class="hs-comment">-- See Note [Safe abortion in the fixed-point iteration]</span><span>
</span><a name="line-521"></a><span>    </span><span class="hs-identifier">abort</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DmdEnv</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-522"></a><span>    </span><a name="local-6989586621684362090"><a href="#local-6989586621684362090"><span class="hs-identifier">abort</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684362085"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684362099"><span class="hs-identifier hs-var">lazy_fv'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684362100"><span class="hs-identifier hs-var">zapped_pairs</span></a><span class="hs-special">)</span><span>
</span><a name="line-523"></a><span>      </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684362096"><a href="#local-6989586621684362096"><span class="hs-identifier">lazy_fv</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362097"><a href="#local-6989586621684362097"><span class="hs-identifier">pairs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362092"><span class="hs-identifier hs-var">step</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684362093"><span class="hs-identifier hs-var">zapIdStrictness</span></a><span> </span><a href="#local-6989586621684362087"><span class="hs-identifier hs-var">orig_pairs</span></a><span class="hs-special">)</span><span>
</span><a name="line-524"></a><span>            </span><span class="hs-comment">-- Note [Lazy and unleashable free variables]</span><span>
</span><a name="line-525"></a><span>            </span><a name="local-6989586621684362098"><a href="#local-6989586621684362098"><span class="hs-identifier">non_lazy_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">plusVarEnvList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">strictSigDmdEnv</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">idStrictness</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684362097"><span class="hs-identifier hs-var">pairs'</span></a><span>
</span><a name="line-526"></a><span>            </span><a name="local-6989586621684362099"><a href="#local-6989586621684362099"><span class="hs-identifier">lazy_fv'</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362096"><span class="hs-identifier hs-var">lazy_fv</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusVarEnv</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">mapVarEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-identifier hs-var">topDmd</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684362098"><span class="hs-identifier hs-var">non_lazy_fvs</span></a><span>
</span><a name="line-527"></a><span>            </span><a name="local-6989586621684362100"><a href="#local-6989586621684362100"><span class="hs-identifier">zapped_pairs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362093"><span class="hs-identifier hs-var">zapIdStrictness</span></a><span> </span><a href="#local-6989586621684362097"><span class="hs-identifier hs-var">pairs'</span></a><span>
</span><a name="line-528"></a><span>
</span><a name="line-529"></a><span>    </span><span class="hs-comment">-- The fixed-point varies the idStrictness field of the binders, and terminates if that</span><span>
</span><a name="line-530"></a><span>    </span><span class="hs-comment">-- annotation does not change any more.</span><span>
</span><a name="line-531"></a><span>    </span><span class="hs-identifier">loop</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DmdEnv</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-532"></a><span>    </span><a name="local-6989586621684362091"><a href="#local-6989586621684362091"><span class="hs-identifier">loop</span></a></a><span> </span><a name="local-6989586621684362101"><a href="#local-6989586621684362101"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621684362102"><a href="#local-6989586621684362102"><span class="hs-identifier">pairs</span></a></a><span>
</span><a name="line-533"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684362103"><span class="hs-identifier hs-var">found_fixpoint</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684362107"><span class="hs-identifier hs-var">final_anal_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684362105"><span class="hs-identifier hs-var">lazy_fv</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684362106"><span class="hs-identifier hs-var">pairs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-534"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684362101"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">10</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362090"><span class="hs-identifier hs-var">abort</span></a><span>
</span><a name="line-535"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362091"><span class="hs-identifier hs-var">loop</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684362101"><span class="hs-identifier hs-var">n</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684362106"><span class="hs-identifier hs-var">pairs'</span></a><span>
</span><a name="line-536"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-537"></a><span>        </span><a name="local-6989586621684362103"><a href="#local-6989586621684362103"><span class="hs-identifier">found_fixpoint</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idStrictness</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684362106"><span class="hs-identifier hs-var">pairs'</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idStrictness</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684362102"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-538"></a><span>        </span><a name="local-6989586621684362104"><a href="#local-6989586621684362104"><span class="hs-identifier">first_round</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362101"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-539"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684362105"><a href="#local-6989586621684362105"><span class="hs-identifier">lazy_fv</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362106"><a href="#local-6989586621684362106"><span class="hs-identifier">pairs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362092"><span class="hs-identifier hs-var">step</span></a><span> </span><a href="#local-6989586621684362104"><span class="hs-identifier hs-var">first_round</span></a><span> </span><a href="#local-6989586621684362102"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-540"></a><span>        </span><a name="local-6989586621684362107"><a href="#local-6989586621684362107"><span class="hs-identifier">final_anal_env</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#extendAnalEnvs"><span class="hs-identifier hs-var">extendAnalEnvs</span></a><span> </span><a href="#local-6989586621684362084"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621684362085"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621684362106"><span class="hs-identifier hs-var">pairs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-541"></a><span>
</span><a name="line-542"></a><span>    </span><span class="hs-identifier">step</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DmdEnv</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-543"></a><span>    </span><a name="local-6989586621684362092"><a href="#local-6989586621684362092"><span class="hs-identifier">step</span></a></a><span> </span><a name="local-6989586621684362108"><a href="#local-6989586621684362108"><span class="hs-identifier">first_round</span></a></a><span> </span><a name="local-6989586621684362109"><a href="#local-6989586621684362109"><span class="hs-identifier">pairs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684362112"><span class="hs-identifier hs-var">lazy_fv</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684362113"><span class="hs-identifier hs-var">pairs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-544"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-545"></a><span>        </span><span class="hs-comment">-- In all but the first iteration, delete the virgin flag</span><span>
</span><a name="line-546"></a><span>        </span><a name="local-6989586621684362110"><a href="#local-6989586621684362110"><span class="hs-identifier">start_env</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684362108"><span class="hs-identifier hs-var">first_round</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362085"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-547"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#nonVirgin"><span class="hs-identifier hs-var">nonVirgin</span></a><span> </span><a href="#local-6989586621684362085"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-548"></a><span>
</span><a name="line-549"></a><span>        </span><a name="local-6989586621684362111"><a href="#local-6989586621684362111"><span class="hs-identifier">start</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="DmdAnal.html#extendAnalEnvs"><span class="hs-identifier hs-var">extendAnalEnvs</span></a><span> </span><a href="#local-6989586621684362084"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621684362110"><span class="hs-identifier hs-var">start_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621684362109"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyDmdEnv</span><span class="hs-special">)</span><span>
</span><a name="line-550"></a><span>
</span><a name="line-551"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621684362112"><a href="#local-6989586621684362112"><span class="hs-identifier">lazy_fv</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684362113"><a href="#local-6989586621684362113"><span class="hs-identifier">pairs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><a href="#local-6989586621684362114"><span class="hs-identifier hs-var">my_downRhs</span></a><span> </span><a href="#local-6989586621684362111"><span class="hs-identifier hs-var">start</span></a><span> </span><a href="#local-6989586621684362109"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-552"></a><span>                </span><span class="hs-comment">-- mapAccumL: Use the new signature to do the next pair</span><span>
</span><a name="line-553"></a><span>                </span><span class="hs-comment">-- The occurrence analyser has arranged them in a good order</span><span>
</span><a name="line-554"></a><span>                </span><span class="hs-comment">-- so this can significantly reduce the number of iterations needed</span><span>
</span><a name="line-555"></a><span>
</span><a name="line-556"></a><span>        </span><a name="local-6989586621684362114"><a href="#local-6989586621684362114"><span class="hs-identifier">my_downRhs</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684362115"><a href="#local-6989586621684362115"><span class="hs-identifier">env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362116"><a href="#local-6989586621684362116"><span class="hs-identifier">lazy_fv</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684362117"><a href="#local-6989586621684362117"><span class="hs-identifier">id</span></a></a><span class="hs-special">,</span><a name="local-6989586621684362118"><a href="#local-6989586621684362118"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-557"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621684362123"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684362122"><span class="hs-identifier hs-var">lazy_fv'</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684362120"><span class="hs-identifier hs-var">id'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684362121"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-558"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-559"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621684362119"><a href="#local-6989586621684362119"><span class="hs-identifier">lazy_fv1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362120"><a href="#local-6989586621684362120"><span class="hs-identifier">id'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362121"><a href="#local-6989586621684362121"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#dmdAnalRhsLetDown"><span class="hs-identifier hs-var">dmdAnalRhsLetDown</span></a><span> </span><a href="#local-6989586621684362084"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621684362088"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684362115"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684362086"><span class="hs-identifier hs-var">let_dmd</span></a><span> </span><a href="#local-6989586621684362117"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684362118"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-560"></a><span>            </span><a name="local-6989586621684362122"><a href="#local-6989586621684362122"><span class="hs-identifier">lazy_fv'</span></a></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">plusVarEnv_C</span><span> </span><span class="hs-identifier hs-var">bothDmd</span><span> </span><a href="#local-6989586621684362116"><span class="hs-identifier hs-var">lazy_fv</span></a><span> </span><a href="#local-6989586621684362119"><span class="hs-identifier hs-var">lazy_fv1</span></a><span>
</span><a name="line-561"></a><span>            </span><a name="local-6989586621684362123"><a href="#local-6989586621684362123"><span class="hs-identifier">env'</span></a></a><span>                  </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#extendAnalEnv"><span class="hs-identifier hs-var">extendAnalEnv</span></a><span> </span><a href="#local-6989586621684362084"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621684362115"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684362117"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idStrictness</span><span> </span><a href="#local-6989586621684362120"><span class="hs-identifier hs-var">id'</span></a><span class="hs-special">)</span><span>
</span><a name="line-562"></a><span>
</span><a name="line-563"></a><span>
</span><a name="line-564"></a><span>    </span><span class="hs-identifier">zapIdStrictness</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-565"></a><span>    </span><a name="local-6989586621684362093"><a href="#local-6989586621684362093"><span class="hs-identifier">zapIdStrictness</span></a></a><span> </span><a name="local-6989586621684362124"><a href="#local-6989586621684362124"><span class="hs-identifier">pairs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">setIdStrictness</span><span> </span><a href="#local-6989586621684362125"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-identifier hs-var">nopSig</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684362126"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684362125"><a href="#local-6989586621684362125"><span class="hs-identifier">id</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362126"><a href="#local-6989586621684362126"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684362124"><span class="hs-identifier hs-var">pairs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-566"></a><span>
</span><a name="line-567"></a><span class="hs-comment">{-
Note [Safe abortion in the fixed-point iteration]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Fixed-point iteration may fail to terminate. But we cannot simply give up and
return the environment and code unchanged! We still need to do one additional
round, for two reasons:

 * To get information on used free variables (both lazy and strict!)
   (see Note [Lazy and unleashable free variables])
 * To ensure that all expressions have been traversed at least once, and any left-over
   strictness annotations have been updated.

This final iteration does not add the variables to the strictness signature
environment, which effectively assigns them 'nopSig' (see &quot;getStrictness&quot;)

-}</span><span>
</span><a name="line-584"></a><span>
</span><a name="line-585"></a><span class="hs-comment">-- Trivial RHS</span><span>
</span><a name="line-586"></a><span class="hs-comment">-- See Note [Demand analysis for trivial right-hand sides]</span><span>
</span><a name="line-587"></a><span class="hs-identifier">dmdAnalTrivialRhs</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-588"></a><span>    </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Var</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-589"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DmdEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span>
</span><a name="line-590"></a><a name="dmdAnalTrivialRhs"><a href="DmdAnal.html#dmdAnalTrivialRhs"><span class="hs-identifier">dmdAnalTrivialRhs</span></a></a><span> </span><a name="local-6989586621684362127"><a href="#local-6989586621684362127"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684362128"><a href="#local-6989586621684362128"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621684362129"><a href="#local-6989586621684362129"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621684362130"><a href="#local-6989586621684362130"><span class="hs-identifier">fn</span></a></a><span>
</span><a name="line-591"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684362132"><span class="hs-identifier hs-var">fn_fv</span></a><span class="hs-special">,</span><span> </span><a href="DmdAnal.html#set_idStrictness"><span class="hs-identifier hs-var">set_idStrictness</span></a><span> </span><a href="#local-6989586621684362127"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684362128"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684362131"><span class="hs-identifier hs-var">fn_str</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684362129"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-592"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-593"></a><span>    </span><a name="local-6989586621684362131"><a href="#local-6989586621684362131"><span class="hs-identifier">fn_str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#getStrictness"><span class="hs-identifier hs-var">getStrictness</span></a><span> </span><a href="#local-6989586621684362127"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684362130"><span class="hs-identifier hs-var">fn</span></a><span>
</span><a name="line-594"></a><span>    </span><a name="local-6989586621684362132"><a href="#local-6989586621684362132"><span class="hs-identifier">fn_fv</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isLocalId</span><span> </span><a href="#local-6989586621684362130"><span class="hs-identifier hs-var">fn</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unitVarEnv</span><span> </span><a href="#local-6989586621684362130"><span class="hs-identifier hs-var">fn</span></a><span> </span><span class="hs-identifier hs-var">topDmd</span><span>
</span><a name="line-595"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyDmdEnv</span><span>
</span><a name="line-596"></a><span>    </span><span class="hs-comment">-- Note [Remember to demand the function itself]</span><span>
</span><a name="line-597"></a><span>    </span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-598"></a><span>    </span><span class="hs-comment">-- fn_fv: don't forget to produce a demand for fn itself</span><span>
</span><a name="line-599"></a><span>    </span><span class="hs-comment">-- Lacking this caused Trac #9128</span><span>
</span><a name="line-600"></a><span>    </span><span class="hs-comment">-- The demand is very conservative (topDmd), but that doesn't</span><span>
</span><a name="line-601"></a><span>    </span><span class="hs-comment">-- matter; trivial bindings are usually inlined, so it only</span><span>
</span><a name="line-602"></a><span>    </span><span class="hs-comment">-- kicks in for top-level bindings and NOINLINE bindings</span><span>
</span><a name="line-603"></a><span>
</span><a name="line-604"></a><span class="hs-comment">-- Let bindings can be processed in two ways:</span><span>
</span><a name="line-605"></a><span class="hs-comment">-- Down (RHS before body) or Up (body before RHS).</span><span>
</span><a name="line-606"></a><span class="hs-comment">-- dmdAnalRhsLetDown implements the Down variant:</span><span>
</span><a name="line-607"></a><span class="hs-comment">--  * assuming a demand of &lt;L,U&gt;</span><span>
</span><a name="line-608"></a><span class="hs-comment">--  * looking at the definition</span><span>
</span><a name="line-609"></a><span class="hs-comment">--  * determining a strictness signature</span><span>
</span><a name="line-610"></a><span class="hs-comment">--</span><span>
</span><a name="line-611"></a><span class="hs-comment">-- It is used for toplevel definition, recursive definitions and local</span><span>
</span><a name="line-612"></a><span class="hs-comment">-- non-recursive definitions that have manifest lambdas.</span><span>
</span><a name="line-613"></a><span class="hs-comment">-- Local non-recursive definitions without a lambda are handled with LetUp.</span><span>
</span><a name="line-614"></a><span class="hs-comment">--</span><span>
</span><a name="line-615"></a><span class="hs-comment">-- This is the LetDown rule in the paper &#8220;Higher-Order Cardinality Analysis&#8221;.</span><span>
</span><a name="line-616"></a><span class="hs-identifier">dmdAnalRhsLetDown</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span>
</span><a name="line-617"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- Just bs &lt;=&gt; recursive, Nothing &lt;=&gt; non-recursive</span><span>
</span><a name="line-618"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CleanDemand</span><span>
</span><a name="line-619"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-620"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DmdEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span>
</span><a name="line-621"></a><span class="hs-comment">-- Process the RHS of the binding, add the strictness signature</span><span>
</span><a name="line-622"></a><span class="hs-comment">-- to the Id, and augment the environment with the signature as well.</span><span>
</span><a name="line-623"></a><a name="dmdAnalRhsLetDown"><a href="DmdAnal.html#dmdAnalRhsLetDown"><span class="hs-identifier">dmdAnalRhsLetDown</span></a></a><span> </span><a name="local-6989586621684362133"><a href="#local-6989586621684362133"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621684362134"><a href="#local-6989586621684362134"><span class="hs-identifier">rec_flag</span></a></a><span> </span><a name="local-6989586621684362135"><a href="#local-6989586621684362135"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684362136"><a href="#local-6989586621684362136"><span class="hs-identifier">let_dmd</span></a></a><span> </span><a name="local-6989586621684362137"><a href="#local-6989586621684362137"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621684362138"><a href="#local-6989586621684362138"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-624"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684362166"><a href="#local-6989586621684362166"><span class="hs-identifier">fn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DmdAnal.html#unpackTrivial"><span class="hs-identifier hs-var">unpackTrivial</span></a><span> </span><a href="#local-6989586621684362138"><span class="hs-identifier hs-var">rhs</span></a><span>   </span><span class="hs-comment">-- See Note [Demand analysis for trivial right-hand sides]</span><span>
</span><a name="line-625"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#dmdAnalTrivialRhs"><span class="hs-identifier hs-var">dmdAnalTrivialRhs</span></a><span> </span><a href="#local-6989586621684362135"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684362137"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684362138"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621684362166"><span class="hs-identifier hs-var">fn</span></a><span>
</span><a name="line-626"></a><span>
</span><a name="line-627"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-628"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684362153"><span class="hs-identifier hs-var">lazy_fv</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684362151"><span class="hs-identifier hs-var">id'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkLams</span><span> </span><a href="#local-6989586621684362149"><span class="hs-identifier hs-var">bndrs'</span></a><span> </span><a href="#local-6989586621684362144"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">)</span><span>
</span><a name="line-629"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-630"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684362139"><a href="#local-6989586621684362139"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362140"><a href="#local-6989586621684362140"><span class="hs-identifier">body</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362141"><a href="#local-6989586621684362141"><span class="hs-identifier">body_dmd</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-631"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">isJoinId_maybe</span><span> </span><a href="#local-6989586621684362137"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-632"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684362160"><a href="#local-6989586621684362160"><span class="hs-identifier">join_arity</span></a></a><span>  </span><span class="hs-comment">-- See Note [Demand analysis for join points]</span><span>
</span><a name="line-633"></a><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684362161"><a href="#local-6989586621684362161"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362162"><a href="#local-6989586621684362162"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">collectNBinders</span><span> </span><a href="#local-6989586621684362160"><span class="hs-identifier hs-var">join_arity</span></a><span> </span><a href="#local-6989586621684362138"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-634"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684362161"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684362162"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684362136"><span class="hs-identifier hs-var">let_dmd</span></a><span class="hs-special">)</span><span>
</span><a name="line-635"></a><span>
</span><a name="line-636"></a><span>           </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684362163"><a href="#local-6989586621684362163"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362164"><a href="#local-6989586621684362164"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">collectBinders</span><span> </span><a href="#local-6989586621684362138"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-637"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684362163"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684362164"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">,</span><span> </span><a href="DmdAnal.html#mkBodyDmd"><span class="hs-identifier hs-var">mkBodyDmd</span></a><span> </span><a href="#local-6989586621684362135"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684362164"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-638"></a><span>
</span><a name="line-639"></a><span>    </span><a name="local-6989586621684362142"><a href="#local-6989586621684362142"><span class="hs-identifier">env_body</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="DmdAnal.html#extendSigsWithLam"><span class="hs-identifier hs-var">extendSigsWithLam</span></a><span> </span><a href="#local-6989586621684362135"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684362139"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-640"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684362143"><a href="#local-6989586621684362143"><span class="hs-identifier">body_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362144"><a href="#local-6989586621684362144"><span class="hs-identifier">body'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#dmdAnal"><span class="hs-identifier hs-var">dmdAnal</span></a><span> </span><a href="#local-6989586621684362142"><span class="hs-identifier hs-var">env_body</span></a><span> </span><a href="#local-6989586621684362141"><span class="hs-identifier hs-var">body_dmd</span></a><span> </span><a href="#local-6989586621684362140"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-641"></a><span>    </span><a name="local-6989586621684362145"><a href="#local-6989586621684362145"><span class="hs-identifier">body_ty'</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">removeDmdTyArgs</span><span> </span><a href="#local-6989586621684362143"><span class="hs-identifier hs-var">body_ty</span></a><span> </span><span class="hs-comment">-- zap possible deep CPR info</span><span>
</span><a name="line-642"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DmdType</span><span> </span><a name="local-6989586621684362146"><a href="#local-6989586621684362146"><span class="hs-identifier">rhs_fv</span></a></a><span> </span><a name="local-6989586621684362147"><a href="#local-6989586621684362147"><span class="hs-identifier">rhs_dmds</span></a></a><span> </span><a name="local-6989586621684362148"><a href="#local-6989586621684362148"><span class="hs-identifier">rhs_res</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362149"><a href="#local-6989586621684362149"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-643"></a><span>                     </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#annotateLamBndrs"><span class="hs-identifier hs-var">annotateLamBndrs</span></a><span> </span><a href="#local-6989586621684362135"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isDFunId</span><span> </span><a href="#local-6989586621684362137"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684362145"><span class="hs-identifier hs-var">body_ty'</span></a><span> </span><a href="#local-6989586621684362139"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-644"></a><span>    </span><a name="local-6989586621684362150"><a href="#local-6989586621684362150"><span class="hs-identifier">sig_ty</span></a></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkStrictSig</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkDmdType</span><span> </span><a href="#local-6989586621684362154"><span class="hs-identifier hs-var">sig_fv</span></a><span> </span><a href="#local-6989586621684362147"><span class="hs-identifier hs-var">rhs_dmds</span></a><span> </span><a href="#local-6989586621684362155"><span class="hs-identifier hs-var">rhs_res'</span></a><span class="hs-special">)</span><span>
</span><a name="line-645"></a><span>    </span><a name="local-6989586621684362151"><a href="#local-6989586621684362151"><span class="hs-identifier">id'</span></a></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#set_idStrictness"><span class="hs-identifier hs-var">set_idStrictness</span></a><span> </span><a href="#local-6989586621684362135"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684362137"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684362150"><span class="hs-identifier hs-var">sig_ty</span></a><span>
</span><a name="line-646"></a><span>        </span><span class="hs-comment">-- See Note [NOINLINE and strictness]</span><span>
</span><a name="line-647"></a><span>
</span><a name="line-648"></a><span>
</span><a name="line-649"></a><span>    </span><span class="hs-comment">-- See Note [Aggregated demand for cardinality]</span><span>
</span><a name="line-650"></a><span>    </span><a name="local-6989586621684362152"><a href="#local-6989586621684362152"><span class="hs-identifier">rhs_fv1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684362134"><span class="hs-identifier hs-var">rec_flag</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-651"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684362165"><a href="#local-6989586621684362165"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">reuseEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">delVarEnvList</span><span> </span><a href="#local-6989586621684362146"><span class="hs-identifier hs-var">rhs_fv</span></a><span> </span><a href="#local-6989586621684362165"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span>
</span><a name="line-652"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684362146"><span class="hs-identifier hs-var">rhs_fv</span></a><span>
</span><a name="line-653"></a><span>
</span><a name="line-654"></a><span>    </span><span class="hs-comment">-- See Note [Lazy and unleashable free variables]</span><span>
</span><a name="line-655"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684362153"><a href="#local-6989586621684362153"><span class="hs-identifier">lazy_fv</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362154"><a href="#local-6989586621684362154"><span class="hs-identifier">sig_fv</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitFVs</span><span> </span><a href="#local-6989586621684362158"><span class="hs-identifier hs-var">is_thunk</span></a><span> </span><a href="#local-6989586621684362152"><span class="hs-identifier hs-var">rhs_fv1</span></a><span>
</span><a name="line-656"></a><span>
</span><a name="line-657"></a><span>    </span><a name="local-6989586621684362155"><a href="#local-6989586621684362155"><span class="hs-identifier">rhs_res'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">trimCPRInfo</span><span> </span><a href="#local-6989586621684362156"><span class="hs-identifier hs-var">trim_all</span></a><span> </span><a href="#local-6989586621684362157"><span class="hs-identifier hs-var">trim_sums</span></a><span> </span><a href="#local-6989586621684362148"><span class="hs-identifier hs-var">rhs_res</span></a><span>
</span><a name="line-658"></a><span>    </span><a name="local-6989586621684362156"><a href="#local-6989586621684362156"><span class="hs-identifier">trim_all</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362158"><span class="hs-identifier hs-var">is_thunk</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684362159"><span class="hs-identifier hs-var">not_strict</span></a><span>
</span><a name="line-659"></a><span>    </span><a name="local-6989586621684362157"><a href="#local-6989586621684362157"><span class="hs-identifier">trim_sums</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isTopLevel</span><span> </span><a href="#local-6989586621684362133"><span class="hs-identifier hs-var">top_lvl</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- See Note [CPR for sum types]</span><span>
</span><a name="line-660"></a><span>
</span><a name="line-661"></a><span>    </span><span class="hs-comment">-- See Note [CPR for thunks]</span><span>
</span><a name="line-662"></a><span>    </span><a name="local-6989586621684362158"><a href="#local-6989586621684362158"><span class="hs-identifier">is_thunk</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprIsHNF</span><span> </span><a href="#local-6989586621684362138"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isJoinId</span><span> </span><a href="#local-6989586621684362137"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-663"></a><span>    </span><a name="local-6989586621684362159"><a href="#local-6989586621684362159"><span class="hs-identifier">not_strict</span></a></a><span>
</span><a name="line-664"></a><span>       </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">isTopLevel</span><span> </span><a href="#local-6989586621684362133"><span class="hs-identifier hs-var">top_lvl</span></a><span>  </span><span class="hs-comment">-- Top level and recursive things don't</span><span>
</span><a name="line-665"></a><span>       </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><a href="#local-6989586621684362134"><span class="hs-identifier hs-var">rec_flag</span></a><span>     </span><span class="hs-comment">-- get their demandInfo set at all</span><span>
</span><a name="line-666"></a><span>       </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isStrictDmd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idDemandInfo</span><span> </span><a href="#local-6989586621684362137"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier">ae_virgin</span><span> </span><a href="#local-6989586621684362135"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-667"></a><span>          </span><span class="hs-comment">-- See Note [Optimistic CPR in the &quot;virgin&quot; case]</span><span>
</span><a name="line-668"></a><span>
</span><a name="line-669"></a><span class="hs-identifier">mkBodyDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CleanDemand</span><span>
</span><a name="line-670"></a><span class="hs-comment">-- See Note [Product demands for function body]</span><span>
</span><a name="line-671"></a><a name="mkBodyDmd"><a href="DmdAnal.html#mkBodyDmd"><span class="hs-identifier">mkBodyDmd</span></a></a><span> </span><a name="local-6989586621684362167"><a href="#local-6989586621684362167"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684362168"><a href="#local-6989586621684362168"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-672"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="WwLib.html#deepSplitProductType_maybe"><span class="hs-identifier hs-var">deepSplitProductType_maybe</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ae_fam_envs</span><span> </span><a href="#local-6989586621684362167"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprType</span><span> </span><a href="#local-6989586621684362168"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-673"></a><span>       </span><span class="hs-identifier hs-var">Nothing</span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">cleanEvalDmd</span><span>
</span><a name="line-674"></a><span>       </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684362169"><a href="#local-6989586621684362169"><span class="hs-identifier">dc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">cleanEvalProdDmd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConRepArity</span><span> </span><a href="#local-6989586621684362169"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span>
</span><a name="line-675"></a><span>
</span><a name="line-676"></a><span class="hs-identifier">unpackTrivial</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-677"></a><span class="hs-comment">-- Returns (Just v) if the arg is really equal to v, modulo</span><span>
</span><a name="line-678"></a><span class="hs-comment">-- casts, type applications etc</span><span>
</span><a name="line-679"></a><span class="hs-comment">-- See Note [Demand analysis for trivial right-hand sides]</span><span>
</span><a name="line-680"></a><a name="unpackTrivial"><a href="DmdAnal.html#unpackTrivial"><span class="hs-identifier">unpackTrivial</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a name="local-6989586621684362170"><a href="#local-6989586621684362170"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621684362170"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-681"></a><span class="hs-identifier">unpackTrivial</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Cast</span><span> </span><a name="local-6989586621684362171"><a href="#local-6989586621684362171"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#unpackTrivial"><span class="hs-identifier hs-var">unpackTrivial</span></a><span> </span><a href="#local-6989586621684362171"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-682"></a><span class="hs-identifier">unpackTrivial</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Lam</span><span> </span><a name="local-6989586621684362172"><a href="#local-6989586621684362172"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621684362173"><a href="#local-6989586621684362173"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTyVar</span><span> </span><a href="#local-6989586621684362172"><span class="hs-identifier hs-var">v</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#unpackTrivial"><span class="hs-identifier hs-var">unpackTrivial</span></a><span> </span><a href="#local-6989586621684362173"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-683"></a><span class="hs-identifier">unpackTrivial</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">App</span><span> </span><a name="local-6989586621684362174"><a href="#local-6989586621684362174"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621684362175"><a href="#local-6989586621684362175"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTypeArg</span><span> </span><a href="#local-6989586621684362175"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#unpackTrivial"><span class="hs-identifier hs-var">unpackTrivial</span></a><span> </span><a href="#local-6989586621684362174"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-684"></a><span class="hs-identifier">unpackTrivial</span><span> </span><span class="hs-identifier">_</span><span>                       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-685"></a><span>
</span><a name="line-686"></a><span class="hs-comment">-- | If given the RHS of a let-binding, this 'useLetUp' determines</span><span>
</span><a name="line-687"></a><span class="hs-comment">-- whether we should process the binding up (body before rhs) or</span><span>
</span><a name="line-688"></a><span class="hs-comment">-- down (rhs before body).</span><span>
</span><a name="line-689"></a><span class="hs-comment">--</span><span>
</span><a name="line-690"></a><span class="hs-comment">-- We use LetDown if there is a chance to get a useful strictness signature.</span><span>
</span><a name="line-691"></a><span class="hs-comment">-- This is the case when there are manifest value lambdas or the binding is a</span><span>
</span><a name="line-692"></a><span class="hs-comment">-- join point (hence always acts like a function, not a value).</span><span>
</span><a name="line-693"></a><span class="hs-identifier">useLetUp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Var</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-694"></a><a name="useLetUp"><a href="DmdAnal.html#useLetUp"><span class="hs-identifier">useLetUp</span></a></a><span> </span><a name="local-6989586621684362176"><a href="#local-6989586621684362176"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isJoinId</span><span> </span><a href="#local-6989586621684362176"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-695"></a><span class="hs-identifier">useLetUp</span><span> </span><a name="local-6989586621684362177"><a href="#local-6989586621684362177"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Lam</span><span> </span><a name="local-6989586621684362178"><a href="#local-6989586621684362178"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621684362179"><a href="#local-6989586621684362179"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTyVar</span><span> </span><a href="#local-6989586621684362178"><span class="hs-identifier hs-var">v</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#useLetUp"><span class="hs-identifier hs-var">useLetUp</span></a><span> </span><a href="#local-6989586621684362177"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621684362179"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-696"></a><span class="hs-identifier">useLetUp</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Lam</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-697"></a><span class="hs-identifier">useLetUp</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>                      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-698"></a><span>
</span><a name="line-699"></a><span>
</span><a name="line-700"></a><span class="hs-comment">{- Note [Demand analysis for join points]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   g :: (Int,Int) -&gt; Int
   g (p,q) = p+q

   f :: T -&gt; Int -&gt; Int
   f x p = g (join j y = (p,y)
              in case x of
                   A -&gt; j 3
                   B -&gt; j 4
                   C -&gt; (p,7))

If j was a vanilla function definition, we'd analyse its body with
evalDmd, and think that it was lazy in p.  But for join points we can
do better!  We know that j's body will (if called at all) be evaluated
with the demand that consumes the entire join-binding, in this case
the argument demand from g.  Whizzo!  g evaluates both components of
its argument pair, so p will certainly be evaluated if j is called.

For f to be strict in p, we need /all/ paths to evaluate p; in this
case the C branch does so too, so we are fine.  So, as usual, we need
to transport demands on free variables to the call site(s).  Compare
Note [Lazy and unleashable free variables].

The implementation is easy.  When analysing a join point, we can
analyse its body with the demand from the entire join-binding (written
let_dmd here).

Another win for join points!  Trac #13543.

Note [Demand analysis for trivial right-hand sides]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
        foo = plusInt |&gt; co
where plusInt is an arity-2 function with known strictness.  Clearly
we want plusInt's strictness to propagate to foo!  But because it has
no manifest lambdas, it won't do so automatically, and indeed 'co' might
have type (Int-&gt;Int-&gt;Int) ~ T, so we *can't* eta-expand.  So we have a
special case for right-hand sides that are &quot;trivial&quot;, namely variables,
casts, type applications, and the like.

Note that this can mean that 'foo' has an arity that is smaller than that
indicated by its demand info.  e.g. if co :: (Int-&gt;Int-&gt;Int) ~ T, then
foo's arity will be zero (see Note [exprArity invariant] in CoreArity),
but its demand signature will be that of plusInt. A small example is the
test case of Trac #8963.


Note [Product demands for function body]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
This example comes from shootout/binary_trees:

    Main.check' = \ b z ds. case z of z' { I# ip -&gt;
                                case ds_d13s of
                                  Main.Nil -&gt; z'
                                  Main.Node s14k s14l s14m -&gt;
                                    Main.check' (not b)
                                      (Main.check' b
                                         (case b {
                                            False -&gt; I# (-# s14h s14k);
                                            True  -&gt; I# (+# s14h s14k)
                                          })
                                         s14l)
                                     s14m   }   }   }

Here we *really* want to unbox z, even though it appears to be used boxed in
the Nil case.  Partly the Nil case is not a hot path.  But more specifically,
the whole function gets the CPR property if we do.

So for the demand on the body of a RHS we use a product demand if it's
a product type.

************************************************************************
*                                                                      *
\subsection{Strictness signatures and types}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-779"></a><span>
</span><a name="line-780"></a><span class="hs-identifier">unitDmdType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DmdEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DmdType</span><span>
</span><a name="line-781"></a><a name="unitDmdType"><a href="DmdAnal.html#unitDmdType"><span class="hs-identifier">unitDmdType</span></a></a><span> </span><a name="local-6989586621684362180"><a href="#local-6989586621684362180"><span class="hs-identifier">dmd_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DmdType</span><span> </span><a href="#local-6989586621684362180"><span class="hs-identifier hs-var">dmd_env</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">topRes</span><span>
</span><a name="line-782"></a><span>
</span><a name="line-783"></a><span class="hs-identifier">coercionDmdEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Coercion</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DmdEnv</span><span>
</span><a name="line-784"></a><a name="coercionDmdEnv"><a href="DmdAnal.html#coercionDmdEnv"><span class="hs-identifier">coercionDmdEnv</span></a></a><span> </span><a name="local-6989586621684362181"><a href="#local-6989586621684362181"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapVarEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-identifier hs-var">topDmd</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getUniqSet</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">coVarsOfCo</span><span> </span><a href="#local-6989586621684362181"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-785"></a><span>                    </span><span class="hs-comment">-- The VarSet from coVarsOfCo is really a VarEnv Var</span><span>
</span><a name="line-786"></a><span>
</span><a name="line-787"></a><span class="hs-identifier">addVarDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DmdType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Var</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Demand</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DmdType</span><span>
</span><a name="line-788"></a><a name="addVarDmd"><a href="DmdAnal.html#addVarDmd"><span class="hs-identifier">addVarDmd</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DmdType</span><span> </span><a name="local-6989586621684362182"><a href="#local-6989586621684362182"><span class="hs-identifier">fv</span></a></a><span> </span><a name="local-6989586621684362183"><a href="#local-6989586621684362183"><span class="hs-identifier">ds</span></a></a><span> </span><a name="local-6989586621684362184"><a href="#local-6989586621684362184"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684362185"><a href="#local-6989586621684362185"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621684362186"><a href="#local-6989586621684362186"><span class="hs-identifier">dmd</span></a></a><span>
</span><a name="line-789"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DmdType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">extendVarEnv_C</span><span> </span><span class="hs-identifier hs-var">bothDmd</span><span> </span><a href="#local-6989586621684362182"><span class="hs-identifier hs-var">fv</span></a><span> </span><a href="#local-6989586621684362185"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621684362186"><span class="hs-identifier hs-var">dmd</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684362183"><span class="hs-identifier hs-var">ds</span></a><span> </span><a href="#local-6989586621684362184"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-790"></a><span>
</span><a name="line-791"></a><span class="hs-identifier">addLazyFVs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DmdType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DmdEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DmdType</span><span>
</span><a name="line-792"></a><a name="addLazyFVs"><a href="DmdAnal.html#addLazyFVs"><span class="hs-identifier">addLazyFVs</span></a></a><span> </span><a name="local-6989586621684362187"><a href="#local-6989586621684362187"><span class="hs-identifier">dmd_ty</span></a></a><span> </span><a name="local-6989586621684362188"><a href="#local-6989586621684362188"><span class="hs-identifier">lazy_fvs</span></a></a><span>
</span><a name="line-793"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362187"><span class="hs-identifier hs-var">dmd_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">bothDmdType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">mkBothDmdArg</span><span> </span><a href="#local-6989586621684362188"><span class="hs-identifier hs-var">lazy_fvs</span></a><span>
</span><a name="line-794"></a><span>        </span><span class="hs-comment">-- Using bothDmdType (rather than just both'ing the envs)</span><span>
</span><a name="line-795"></a><span>        </span><span class="hs-comment">-- is vital.  Consider</span><span>
</span><a name="line-796"></a><span>        </span><span class="hs-comment">--      let f = \x -&gt; (x,y)</span><span>
</span><a name="line-797"></a><span>        </span><span class="hs-comment">--      in  error (f 3)</span><span>
</span><a name="line-798"></a><span>        </span><span class="hs-comment">-- Here, y is treated as a lazy-fv of f, but we must `bothDmd` that L</span><span>
</span><a name="line-799"></a><span>        </span><span class="hs-comment">-- demand with the bottom coming up from 'error'</span><span>
</span><a name="line-800"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-801"></a><span>        </span><span class="hs-comment">-- I got a loop in the fixpointer without this, due to an interaction</span><span>
</span><a name="line-802"></a><span>        </span><span class="hs-comment">-- with the lazy_fv filtering in dmdAnalRhsLetDown.  Roughly, it was</span><span>
</span><a name="line-803"></a><span>        </span><span class="hs-comment">--      letrec f n x</span><span>
</span><a name="line-804"></a><span>        </span><span class="hs-comment">--          = letrec g y = x `fatbar`</span><span>
</span><a name="line-805"></a><span>        </span><span class="hs-comment">--                         letrec h z = z + ...g...</span><span>
</span><a name="line-806"></a><span>        </span><span class="hs-comment">--                         in h (f (n-1) x)</span><span>
</span><a name="line-807"></a><span>        </span><span class="hs-comment">--      in ...</span><span>
</span><a name="line-808"></a><span>        </span><span class="hs-comment">-- In the initial iteration for f, f=Bot</span><span>
</span><a name="line-809"></a><span>        </span><span class="hs-comment">-- Suppose h is found to be strict in z, but the occurrence of g in its RHS</span><span>
</span><a name="line-810"></a><span>        </span><span class="hs-comment">-- is lazy.  Now consider the fixpoint iteration for g, esp the demands it</span><span>
</span><a name="line-811"></a><span>        </span><span class="hs-comment">-- places on its free variables.  Suppose it places none.  Then the</span><span>
</span><a name="line-812"></a><span>        </span><span class="hs-comment">--      x `fatbar` ...call to h...</span><span>
</span><a name="line-813"></a><span>        </span><span class="hs-comment">-- will give a x-&gt;V demand for x.  That turns into a L demand for x,</span><span>
</span><a name="line-814"></a><span>        </span><span class="hs-comment">-- which floats out of the defn for h.  Without the modifyEnv, that</span><span>
</span><a name="line-815"></a><span>        </span><span class="hs-comment">-- L demand doesn't get both'd with the Bot coming up from the inner</span><span>
</span><a name="line-816"></a><span>        </span><span class="hs-comment">-- call to f.  So we just get an L demand for x for g.</span><span>
</span><a name="line-817"></a><span>
</span><a name="line-818"></a><span class="hs-comment">{-
Note [Do not strictify the argument dictionaries of a dfun]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The typechecker can tie recursive knots involving dfuns, so we do the
conservative thing and refrain from strictifying a dfun's argument
dictionaries.
-}</span><span>
</span><a name="line-825"></a><span>
</span><a name="line-826"></a><span class="hs-identifier">setBndrsDemandInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Var</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Demand</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Var</span><span class="hs-special">]</span><span>
</span><a name="line-827"></a><a name="setBndrsDemandInfo"><a href="DmdAnal.html#setBndrsDemandInfo"><span class="hs-identifier">setBndrsDemandInfo</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684362189"><a href="#local-6989586621684362189"><span class="hs-identifier">b</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684362190"><a href="#local-6989586621684362190"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684362191"><a href="#local-6989586621684362191"><span class="hs-identifier">d</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684362192"><a href="#local-6989586621684362192"><span class="hs-identifier">ds</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-828"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTyVar</span><span> </span><a href="#local-6989586621684362189"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362189"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="DmdAnal.html#setBndrsDemandInfo"><span class="hs-identifier hs-var">setBndrsDemandInfo</span></a><span> </span><a href="#local-6989586621684362190"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684362191"><span class="hs-identifier hs-var">d</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684362192"><span class="hs-identifier hs-var">ds</span></a><span class="hs-special">)</span><span>
</span><a name="line-829"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">setIdDemandInfo</span><span> </span><a href="#local-6989586621684362189"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621684362191"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="DmdAnal.html#setBndrsDemandInfo"><span class="hs-identifier hs-var">setBndrsDemandInfo</span></a><span> </span><a href="#local-6989586621684362190"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-6989586621684362192"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-830"></a><span class="hs-identifier">setBndrsDemandInfo</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621684362193"><a href="#local-6989586621684362193"><span class="hs-identifier">ds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-identifier hs-var">ds</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-831"></a><span class="hs-identifier">setBndrsDemandInfo</span><span> </span><a name="local-6989586621684362194"><a href="#local-6989586621684362194"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;setBndrsDemandInfo&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684362194"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span>
</span><a name="line-832"></a><span>
</span><a name="line-833"></a><span class="hs-identifier">annotateBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DmdType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Var</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DmdType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Var</span><span class="hs-special">)</span><span>
</span><a name="line-834"></a><span class="hs-comment">-- The returned env has the var deleted</span><span>
</span><a name="line-835"></a><span class="hs-comment">-- The returned var is annotated with demand info</span><span>
</span><a name="line-836"></a><span class="hs-comment">-- according to the result demand of the provided demand type</span><span>
</span><a name="line-837"></a><span class="hs-comment">-- No effect on the argument demands</span><span>
</span><a name="line-838"></a><a name="annotateBndr"><a href="DmdAnal.html#annotateBndr"><span class="hs-identifier">annotateBndr</span></a></a><span> </span><a name="local-6989586621684362195"><a href="#local-6989586621684362195"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684362196"><a href="#local-6989586621684362196"><span class="hs-identifier">dmd_ty</span></a></a><span> </span><a name="local-6989586621684362197"><a href="#local-6989586621684362197"><span class="hs-identifier">var</span></a></a><span>
</span><a name="line-839"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isId</span><span> </span><a href="#local-6989586621684362197"><span class="hs-identifier hs-var">var</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684362198"><span class="hs-identifier hs-var">dmd_ty'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">setIdDemandInfo</span><span> </span><a href="#local-6989586621684362197"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621684362199"><span class="hs-identifier hs-var">dmd</span></a><span class="hs-special">)</span><span>
</span><a name="line-840"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684362196"><span class="hs-identifier hs-var">dmd_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684362197"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span>
</span><a name="line-841"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-842"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684362198"><a href="#local-6989586621684362198"><span class="hs-identifier">dmd_ty'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362199"><a href="#local-6989586621684362199"><span class="hs-identifier">dmd</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#findBndrDmd"><span class="hs-identifier hs-var">findBndrDmd</span></a><span> </span><a href="#local-6989586621684362195"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621684362196"><span class="hs-identifier hs-var">dmd_ty</span></a><span> </span><a href="#local-6989586621684362197"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-843"></a><span>
</span><a name="line-844"></a><span class="hs-identifier">annotateLamBndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DmdAnal.html#DFunFlag"><span class="hs-identifier hs-type">DFunFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DmdType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Var</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DmdType</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Var</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-845"></a><a name="annotateLamBndrs"><a href="DmdAnal.html#annotateLamBndrs"><span class="hs-identifier">annotateLamBndrs</span></a></a><span> </span><a name="local-6989586621684362200"><a href="#local-6989586621684362200"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684362201"><a href="#local-6989586621684362201"><span class="hs-identifier">args_of_dfun</span></a></a><span> </span><a name="local-6989586621684362202"><a href="#local-6989586621684362202"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621684362203"><a href="#local-6989586621684362203"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAccumR</span><span> </span><a href="#local-6989586621684362204"><span class="hs-identifier hs-var">annotate</span></a><span> </span><a href="#local-6989586621684362202"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621684362203"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-846"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-847"></a><span>    </span><a name="local-6989586621684362204"><a href="#local-6989586621684362204"><span class="hs-identifier">annotate</span></a></a><span> </span><a name="local-6989586621684362205"><a href="#local-6989586621684362205"><span class="hs-identifier">dmd_ty</span></a></a><span> </span><a name="local-6989586621684362206"><a href="#local-6989586621684362206"><span class="hs-identifier">bndr</span></a></a><span>
</span><a name="line-848"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isId</span><span> </span><a href="#local-6989586621684362206"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#annotateLamIdBndr"><span class="hs-identifier hs-var">annotateLamIdBndr</span></a><span> </span><a href="#local-6989586621684362200"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684362201"><span class="hs-identifier hs-var">args_of_dfun</span></a><span> </span><a href="#local-6989586621684362205"><span class="hs-identifier hs-var">dmd_ty</span></a><span> </span><a href="#local-6989586621684362206"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-849"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684362205"><span class="hs-identifier hs-var">dmd_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684362206"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-850"></a><span>
</span><a name="line-851"></a><span class="hs-identifier">annotateLamIdBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span>
</span><a name="line-852"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DmdAnal.html#DFunFlag"><span class="hs-identifier hs-type">DFunFlag</span></a><span>   </span><span class="hs-comment">-- is this lambda at the top of the RHS of a dfun?</span><span>
</span><a name="line-853"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DmdType</span><span>    </span><span class="hs-comment">-- Demand type of body</span><span>
</span><a name="line-854"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span>         </span><span class="hs-comment">-- Lambda binder</span><span>
</span><a name="line-855"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DmdType</span><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- Demand type of lambda</span><span>
</span><a name="line-856"></a><span>                      </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">)</span><span>       </span><span class="hs-comment">-- and binder annotated with demand</span><span>
</span><a name="line-857"></a><span>
</span><a name="line-858"></a><a name="annotateLamIdBndr"><a href="DmdAnal.html#annotateLamIdBndr"><span class="hs-identifier">annotateLamIdBndr</span></a></a><span> </span><a name="local-6989586621684362207"><a href="#local-6989586621684362207"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684362208"><a href="#local-6989586621684362208"><span class="hs-identifier">arg_of_dfun</span></a></a><span> </span><a name="local-6989586621684362209"><a href="#local-6989586621684362209"><span class="hs-identifier">dmd_ty</span></a></a><span> </span><a name="local-6989586621684362210"><a href="#local-6989586621684362210"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-859"></a><span class="hs-comment">-- For lambdas we add the demand to the argument demands</span><span>
</span><a name="line-860"></a><span class="hs-comment">-- Only called for Ids</span><span>
</span><a name="line-861"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">isId</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-862"></a><span>    </span><span class="hs-comment">-- pprTrace &quot;annLamBndr&quot; (vcat [ppr id, ppr _dmd_ty]) $</span><span>
</span><a name="line-863"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621684362211"><span class="hs-identifier hs-var">final_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">setIdDemandInfo</span><span> </span><a href="#local-6989586621684362210"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684362214"><span class="hs-identifier hs-var">dmd</span></a><span class="hs-special">)</span><span>
</span><a name="line-864"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-865"></a><span>      </span><span class="hs-comment">-- Watch out!  See note [Lambda-bound unfoldings]</span><span>
</span><a name="line-866"></a><span>    </span><a name="local-6989586621684362211"><a href="#local-6989586621684362211"><span class="hs-identifier">final_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">maybeUnfoldingTemplate</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idUnfolding</span><span> </span><a href="#local-6989586621684362210"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-867"></a><span>                 </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684362212"><span class="hs-identifier hs-var">main_ty</span></a><span>
</span><a name="line-868"></a><span>                 </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684362215"><a href="#local-6989586621684362215"><span class="hs-identifier">unf</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684362212"><span class="hs-identifier hs-var">main_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">bothDmdType</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684362216"><span class="hs-identifier hs-var">unf_ty</span></a><span>
</span><a name="line-869"></a><span>                          </span><span class="hs-keyword">where</span><span>
</span><a name="line-870"></a><span>                             </span><span class="hs-special">(</span><a name="local-6989586621684362216"><a href="#local-6989586621684362216"><span class="hs-identifier">unf_ty</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#dmdAnalStar"><span class="hs-identifier hs-var">dmdAnalStar</span></a><span> </span><a href="#local-6989586621684362207"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684362214"><span class="hs-identifier hs-var">dmd</span></a><span> </span><a href="#local-6989586621684362215"><span class="hs-identifier hs-var">unf</span></a><span>
</span><a name="line-871"></a><span>
</span><a name="line-872"></a><span>    </span><a name="local-6989586621684362212"><a href="#local-6989586621684362212"><span class="hs-identifier">main_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addDemand</span><span> </span><a href="#local-6989586621684362214"><span class="hs-identifier hs-var">dmd</span></a><span> </span><a href="#local-6989586621684362213"><span class="hs-identifier hs-var">dmd_ty'</span></a><span>
</span><a name="line-873"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684362213"><a href="#local-6989586621684362213"><span class="hs-identifier">dmd_ty'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362214"><a href="#local-6989586621684362214"><span class="hs-identifier">dmd</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#findBndrDmd"><span class="hs-identifier hs-var">findBndrDmd</span></a><span> </span><a href="#local-6989586621684362207"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684362208"><span class="hs-identifier hs-var">arg_of_dfun</span></a><span> </span><a href="#local-6989586621684362209"><span class="hs-identifier hs-var">dmd_ty</span></a><span> </span><a href="#local-6989586621684362210"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-874"></a><span>
</span><a name="line-875"></a><span class="hs-identifier">deleteFVs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DmdType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Var</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DmdType</span><span>
</span><a name="line-876"></a><a name="deleteFVs"><a href="DmdAnal.html#deleteFVs"><span class="hs-identifier">deleteFVs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DmdType</span><span> </span><a name="local-6989586621684362217"><a href="#local-6989586621684362217"><span class="hs-identifier">fvs</span></a></a><span> </span><a name="local-6989586621684362218"><a href="#local-6989586621684362218"><span class="hs-identifier">dmds</span></a></a><span> </span><a name="local-6989586621684362219"><a href="#local-6989586621684362219"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684362220"><a href="#local-6989586621684362220"><span class="hs-identifier">bndrs</span></a></a><span>
</span><a name="line-877"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DmdType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">delVarEnvList</span><span> </span><a href="#local-6989586621684362217"><span class="hs-identifier hs-var">fvs</span></a><span> </span><a href="#local-6989586621684362220"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684362218"><span class="hs-identifier hs-var">dmds</span></a><span> </span><a href="#local-6989586621684362219"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-878"></a><span>
</span><a name="line-879"></a><span class="hs-comment">{-
Note [CPR for sum types]
~~~~~~~~~~~~~~~~~~~~~~~~
At the moment we do not do CPR for let-bindings that
   * non-top level
   * bind a sum type
Reason: I found that in some benchmarks we were losing let-no-escapes,
which messed it all up.  Example
   let j = \x. ....
   in case y of
        True  -&gt; j False
        False -&gt; j True
If we w/w this we get
   let j' = \x. ....
   in case y of
        True  -&gt; case j' False of { (# a #) -&gt; Just a }
        False -&gt; case j' True of { (# a #) -&gt; Just a }
Notice that j' is not a let-no-escape any more.

However this means in turn that the *enclosing* function
may be CPR'd (via the returned Justs).  But in the case of
sums, there may be Nothing alternatives; and that messes
up the sum-type CPR.

Conclusion: only do this for products.  It's still not
guaranteed OK for products, but sums definitely lose sometimes.

Note [CPR for thunks]
~~~~~~~~~~~~~~~~~~~~~
If the rhs is a thunk, we usually forget the CPR info, because
it is presumably shared (else it would have been inlined, and
so we'd lose sharing if w/w'd it into a function).  E.g.

        let r = case expensive of
                  (a,b) -&gt; (b,a)
        in ...

If we marked r as having the CPR property, then we'd w/w into

        let $wr = \() -&gt; case expensive of
                            (a,b) -&gt; (# b, a #)
            r = case $wr () of
                  (# b,a #) -&gt; (b,a)
        in ...

But now r is a thunk, which won't be inlined, so we are no further ahead.
But consider

        f x = let r = case expensive of (a,b) -&gt; (b,a)
              in if foo r then r else (x,x)

Does f have the CPR property?  Well, no.

However, if the strictness analyser has figured out (in a previous
iteration) that it's strict, then we DON'T need to forget the CPR info.
Instead we can retain the CPR info and do the thunk-splitting transform
(see WorkWrap.splitThunk).

This made a big difference to PrelBase.modInt, which had something like
        modInt = \ x -&gt; let r = ... -&gt; I# v in
                        ...body strict in r...
r's RHS isn't a value yet; but modInt returns r in various branches, so
if r doesn't have the CPR property then neither does modInt
Another case I found in practice (in Complex.magnitude), looks like this:
                let k = if ... then I# a else I# b
                in ... body strict in k ....
(For this example, it doesn't matter whether k is returned as part of
the overall result; but it does matter that k's RHS has the CPR property.)
Left to itself, the simplifier will make a join point thus:
                let $j k = ...body strict in k...
                if ... then $j (I# a) else $j (I# b)
With thunk-splitting, we get instead
                let $j x = let k = I#x in ...body strict in k...
                in if ... then $j a else $j b
This is much better; there's a good chance the I# won't get allocated.

The difficulty with this is that we need the strictness type to
look at the body... but we now need the body to calculate the demand
on the variable, so we can decide whether its strictness type should
have a CPR in it or not.  Simple solution:
        a) use strictness info from the previous iteration
        b) make sure we do at least 2 iterations, by doing a second
           round for top-level non-recs.  Top level recs will get at
           least 2 iterations except for totally-bottom functions
           which aren't very interesting anyway.

NB: strictly_demanded is never true of a top-level Id, or of a recursive Id.

Note [Optimistic CPR in the &quot;virgin&quot; case]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Demand and strictness info are initialized by top elements. However,
this prevents from inferring a CPR property in the first pass of the
analyser, so we keep an explicit flag ae_virgin in the AnalEnv
datatype.

We can't start with 'not-demanded' (i.e., top) because then consider
        f x = let
                  t = ... I# x
              in
              if ... then t else I# y else f x'

In the first iteration we'd have no demand info for x, so assume
not-demanded; then we'd get TopRes for f's CPR info.  Next iteration
we'd see that t was demanded, and so give it the CPR property, but by
now f has TopRes, so it will stay TopRes.  Instead, by checking the
ae_virgin flag at the first time round, we say 'yes t is demanded' the
first time.

However, this does mean that for non-recursive bindings we must
iterate twice to be sure of not getting over-optimistic CPR info,
in the case where t turns out to be not-demanded.  This is handled
by dmdAnalTopBind.


Note [NOINLINE and strictness]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The strictness analyser used to have a HACK which ensured that NOINLNE
things were not strictness-analysed.  The reason was unsafePerformIO.
Left to itself, the strictness analyser would discover this strictness
for unsafePerformIO:
        unsafePerformIO:  C(U(AV))
But then consider this sub-expression
        unsafePerformIO (\s -&gt; let r = f x in
                               case writeIORef v r s of (# s1, _ #) -&gt;
                               (# s1, r #)
The strictness analyser will now find that r is sure to be eval'd,
and may then hoist it out.  This makes tests/lib/should_run/memo002
deadlock.

Solving this by making all NOINLINE things have no strictness info is overkill.
In particular, it's overkill for runST, which is perfectly respectable.
Consider
        f x = runST (return x)
This should be strict in x.

So the new plan is to define unsafePerformIO using the 'lazy' combinator:

        unsafePerformIO (IO m) = lazy (case m realWorld# of (# _, r #) -&gt; r)

Remember, 'lazy' is a wired-in identity-function Id, of type a-&gt;a, which is
magically NON-STRICT, and is inlined after strictness analysis.  So
unsafePerformIO will look non-strict, and that's what we want.

Now we don't need the hack in the strictness analyser.  HOWEVER, this
decision does mean that even a NOINLINE function is not entirely
opaque: some aspect of its implementation leaks out, notably its
strictness.  For example, if you have a function implemented by an
error stub, but which has RULES, you may want it not to be eliminated
in favour of error!

Note [Lazy and unleashable free variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We put the strict and once-used FVs in the DmdType of the Id, so
that at its call sites we unleash demands on its strict fvs.
An example is 'roll' in imaginary/wheel-sieve2
Something like this:
        roll x = letrec
                     go y = if ... then roll (x-1) else x+1
                 in
                 go ms
We want to see that roll is strict in x, which is because
go is called.   So we put the DmdEnv for x in go's DmdType.

Another example:

        f :: Int -&gt; Int -&gt; Int
        f x y = let t = x+1
            h z = if z==0 then t else
                  if z==1 then x+1 else
                  x + h (z-1)
        in h y

Calling h does indeed evaluate x, but we can only see
that if we unleash a demand on x at the call site for t.

Incidentally, here's a place where lambda-lifting h would
lose the cigar --- we couldn't see the joint strictness in t/x

        ON THE OTHER HAND

We don't want to put *all* the fv's from the RHS into the
DmdType. Because

 * it makes the strictness signatures larger, and hence slows down fixpointing

and

 * it is useless information at the call site anyways:
   For lazy, used-many times fv's we will never get any better result than
   that, no matter how good the actual demand on the function at the call site
   is (unless it is always absent, but then the whole binder is useless).

Therefore we exclude lazy multiple-used fv's from the environment in the
DmdType.

But now the signature lies! (Missing variables are assumed to be absent.) To
make up for this, the code that analyses the binding keeps the demand on those
variable separate (usually called &quot;lazy_fv&quot;) and adds it to the demand of the
whole binding later.

What if we decide _not_ to store a strictness signature for a binding at all, as
we do when aborting a fixed-point iteration? The we risk losing the information
that the strict variables are being used. In that case, we take all free variables
mentioned in the (unsound) strictness signature, conservatively approximate the
demand put on them (topDmd), and add that to the &quot;lazy_fv&quot; returned by &quot;dmdFix&quot;.


Note [Lambda-bound unfoldings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We allow a lambda-bound variable to carry an unfolding, a facility that is used
exclusively for join points; see Note [Case binders and join points].  If so,
we must be careful to demand-analyse the RHS of the unfolding!  Example
   \x. \y{=Just x}. &lt;body&gt;
Then if &lt;body&gt; uses 'y', then transitively it uses 'x', and we must not
forget that fact, otherwise we might make 'x' absent when it isn't.


************************************************************************
*                                                                      *
\subsection{Strictness signatures}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1102"></a><span>
</span><a name="line-1103"></a><span class="hs-keyword">type</span><span> </span><a name="DFunFlag"><a href="DmdAnal.html#DFunFlag"><span class="hs-identifier">DFunFlag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>  </span><span class="hs-comment">-- indicates if the lambda being considered is in the</span><span>
</span><a name="line-1104"></a><span>                      </span><span class="hs-comment">-- sequence of lambdas at the top of the RHS of a dfun</span><span>
</span><a name="line-1105"></a><span class="hs-identifier">notArgOfDfun</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DmdAnal.html#DFunFlag"><span class="hs-identifier hs-type">DFunFlag</span></a><span>
</span><a name="line-1106"></a><a name="notArgOfDfun"><a href="DmdAnal.html#notArgOfDfun"><span class="hs-identifier">notArgOfDfun</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1107"></a><span>
</span><a name="line-1108"></a><span class="hs-keyword">data</span><span> </span><a name="AnalEnv"><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier">AnalEnv</span></a></a><span>
</span><a name="line-1109"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="AE"><a href="DmdAnal.html#AE"><span class="hs-identifier">AE</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="ae_dflags"><a href="DmdAnal.html#ae_dflags"><span class="hs-identifier">ae_dflags</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-1110"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="ae_sigs"><a href="DmdAnal.html#ae_sigs"><span class="hs-identifier">ae_sigs</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="DmdAnal.html#SigEnv"><span class="hs-identifier hs-type">SigEnv</span></a><span>
</span><a name="line-1111"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="ae_virgin"><a href="DmdAnal.html#ae_virgin"><span class="hs-identifier">ae_virgin</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>    </span><span class="hs-comment">-- True on first iteration only</span><span>
</span><a name="line-1112"></a><span>                              </span><span class="hs-comment">-- See Note [Initialising strictness]</span><span>
</span><a name="line-1113"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="ae_rec_tc"><a href="DmdAnal.html#ae_rec_tc"><span class="hs-identifier">ae_rec_tc</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RecTcChecker</span><span>
</span><a name="line-1114"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="ae_fam_envs"><a href="DmdAnal.html#ae_fam_envs"><span class="hs-identifier">ae_fam_envs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FamInstEnvs</span><span>
</span><a name="line-1115"></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1116"></a><span>
</span><a name="line-1117"></a><span>        </span><span class="hs-comment">-- We use the se_env to tell us whether to</span><span>
</span><a name="line-1118"></a><span>        </span><span class="hs-comment">-- record info about a variable in the DmdEnv</span><span>
</span><a name="line-1119"></a><span>        </span><span class="hs-comment">-- We do so if it's a LocalId, but not top-level</span><span>
</span><a name="line-1120"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-1121"></a><span>        </span><span class="hs-comment">-- The DmdEnv gives the demand on the free vars of the function</span><span>
</span><a name="line-1122"></a><span>        </span><span class="hs-comment">-- when it is given enough args to satisfy the strictness signature</span><span>
</span><a name="line-1123"></a><span>
</span><a name="line-1124"></a><span class="hs-keyword">type</span><span> </span><a name="SigEnv"><a href="DmdAnal.html#SigEnv"><span class="hs-identifier">SigEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">VarEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">StrictSig</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span class="hs-special">)</span><span>
</span><a name="line-1125"></a><span>
</span><a name="line-1126"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1127"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="DmdAnal.html#AE"><span class="hs-identifier hs-var">AE</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ae_sigs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684361903"><a href="#local-6989586621684361903"><span class="hs-identifier">env</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ae_virgin</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684361904"><a href="#local-6989586621684361904"><span class="hs-identifier">virgin</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1128"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;AE&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">braces</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span>
</span><a name="line-1129"></a><span>         </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;ae_virgin =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684361904"><span class="hs-identifier hs-var">virgin</span></a><span>
</span><a name="line-1130"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;ae_sigs =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684361903"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1131"></a><span>
</span><a name="line-1132"></a><span class="hs-identifier">emptyAnalEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FamInstEnvs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span>
</span><a name="line-1133"></a><a name="emptyAnalEnv"><a href="DmdAnal.html#emptyAnalEnv"><span class="hs-identifier">emptyAnalEnv</span></a></a><span> </span><a name="local-6989586621684362221"><a href="#local-6989586621684362221"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684362222"><a href="#local-6989586621684362222"><span class="hs-identifier">fam_envs</span></a></a><span>
</span><a name="line-1134"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#AE"><span class="hs-identifier hs-var">AE</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ae_dflags</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362221"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1135"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ae_sigs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#emptySigEnv"><span class="hs-identifier hs-var">emptySigEnv</span></a><span>
</span><a name="line-1136"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ae_virgin</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1137"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ae_rec_tc</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">initRecTc</span><span>
</span><a name="line-1138"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ae_fam_envs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362222"><span class="hs-identifier hs-var">fam_envs</span></a><span>
</span><a name="line-1139"></a><span>         </span><span class="hs-special">}</span><span>
</span><a name="line-1140"></a><span>
</span><a name="line-1141"></a><span class="hs-identifier">emptySigEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DmdAnal.html#SigEnv"><span class="hs-identifier hs-type">SigEnv</span></a><span>
</span><a name="line-1142"></a><a name="emptySigEnv"><a href="DmdAnal.html#emptySigEnv"><span class="hs-identifier">emptySigEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyVarEnv</span><span>
</span><a name="line-1143"></a><span>
</span><a name="line-1144"></a><span class="hs-comment">-- | Extend an environment with the strictness IDs attached to the id</span><span>
</span><a name="line-1145"></a><span class="hs-identifier">extendAnalEnvs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span>
</span><a name="line-1146"></a><a name="extendAnalEnvs"><a href="DmdAnal.html#extendAnalEnvs"><span class="hs-identifier">extendAnalEnvs</span></a></a><span> </span><a name="local-6989586621684362223"><a href="#local-6989586621684362223"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621684362224"><a href="#local-6989586621684362224"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684362225"><a href="#local-6989586621684362225"><span class="hs-identifier">vars</span></a></a><span>
</span><a name="line-1147"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362224"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ae_sigs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#extendSigEnvs"><span class="hs-identifier hs-var">extendSigEnvs</span></a><span> </span><a href="#local-6989586621684362223"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ae_sigs</span><span> </span><a href="#local-6989586621684362224"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684362225"><span class="hs-identifier hs-var">vars</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1148"></a><span>
</span><a name="line-1149"></a><span class="hs-identifier">extendSigEnvs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DmdAnal.html#SigEnv"><span class="hs-identifier hs-type">SigEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DmdAnal.html#SigEnv"><span class="hs-identifier hs-type">SigEnv</span></a><span>
</span><a name="line-1150"></a><a name="extendSigEnvs"><a href="DmdAnal.html#extendSigEnvs"><span class="hs-identifier">extendSigEnvs</span></a></a><span> </span><a name="local-6989586621684362226"><a href="#local-6989586621684362226"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621684362227"><a href="#local-6989586621684362227"><span class="hs-identifier">sigs</span></a></a><span> </span><a name="local-6989586621684362228"><a href="#local-6989586621684362228"><span class="hs-identifier">vars</span></a></a><span>
</span><a name="line-1151"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendVarEnvList</span><span> </span><a href="#local-6989586621684362227"><span class="hs-identifier hs-var">sigs</span></a><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684362229"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idStrictness</span><span> </span><a href="#local-6989586621684362229"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684362226"><span class="hs-identifier hs-var">top_lvl</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621684362229"><a href="#local-6989586621684362229"><span class="hs-identifier">var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684362228"><span class="hs-identifier hs-var">vars</span></a><span class="hs-special">]</span><span>
</span><a name="line-1152"></a><span>
</span><a name="line-1153"></a><span class="hs-identifier">extendAnalEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">StrictSig</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span>
</span><a name="line-1154"></a><a name="extendAnalEnv"><a href="DmdAnal.html#extendAnalEnv"><span class="hs-identifier">extendAnalEnv</span></a></a><span> </span><a name="local-6989586621684362230"><a href="#local-6989586621684362230"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621684362231"><a href="#local-6989586621684362231"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684362232"><a href="#local-6989586621684362232"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621684362233"><a href="#local-6989586621684362233"><span class="hs-identifier">sig</span></a></a><span>
</span><a name="line-1155"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362231"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ae_sigs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#extendSigEnv"><span class="hs-identifier hs-var">extendSigEnv</span></a><span> </span><a href="#local-6989586621684362230"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ae_sigs</span><span> </span><a href="#local-6989586621684362231"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684362232"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621684362233"><span class="hs-identifier hs-var">sig</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1156"></a><span>
</span><a name="line-1157"></a><span class="hs-identifier">extendSigEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DmdAnal.html#SigEnv"><span class="hs-identifier hs-type">SigEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">StrictSig</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DmdAnal.html#SigEnv"><span class="hs-identifier hs-type">SigEnv</span></a><span>
</span><a name="line-1158"></a><a name="extendSigEnv"><a href="DmdAnal.html#extendSigEnv"><span class="hs-identifier">extendSigEnv</span></a></a><span> </span><a name="local-6989586621684362234"><a href="#local-6989586621684362234"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621684362235"><a href="#local-6989586621684362235"><span class="hs-identifier">sigs</span></a></a><span> </span><a name="local-6989586621684362236"><a href="#local-6989586621684362236"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621684362237"><a href="#local-6989586621684362237"><span class="hs-identifier">sig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendVarEnv</span><span> </span><a href="#local-6989586621684362235"><span class="hs-identifier hs-var">sigs</span></a><span> </span><a href="#local-6989586621684362236"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684362237"><span class="hs-identifier hs-var">sig</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684362234"><span class="hs-identifier hs-var">top_lvl</span></a><span class="hs-special">)</span><span>
</span><a name="line-1159"></a><span>
</span><a name="line-1160"></a><span class="hs-identifier">lookupSigEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">StrictSig</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span class="hs-special">)</span><span>
</span><a name="line-1161"></a><a name="lookupSigEnv"><a href="DmdAnal.html#lookupSigEnv"><span class="hs-identifier">lookupSigEnv</span></a></a><span> </span><a name="local-6989586621684362238"><a href="#local-6989586621684362238"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684362239"><a href="#local-6989586621684362239"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupVarEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ae_sigs</span><span> </span><a href="#local-6989586621684362238"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684362239"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-1162"></a><span>
</span><a name="line-1163"></a><span class="hs-identifier">getStrictness</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">StrictSig</span><span>
</span><a name="line-1164"></a><a name="getStrictness"><a href="DmdAnal.html#getStrictness"><span class="hs-identifier">getStrictness</span></a></a><span> </span><a name="local-6989586621684362240"><a href="#local-6989586621684362240"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684362241"><a href="#local-6989586621684362241"><span class="hs-identifier">fn</span></a></a><span>
</span><a name="line-1165"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isGlobalId</span><span> </span><a href="#local-6989586621684362241"><span class="hs-identifier hs-var">fn</span></a><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idStrictness</span><span> </span><a href="#local-6989586621684362241"><span class="hs-identifier hs-var">fn</span></a><span>
</span><a name="line-1166"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684362242"><a href="#local-6989586621684362242"><span class="hs-identifier">sig</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DmdAnal.html#lookupSigEnv"><span class="hs-identifier hs-var">lookupSigEnv</span></a><span> </span><a href="#local-6989586621684362240"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684362241"><span class="hs-identifier hs-var">fn</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362242"><span class="hs-identifier hs-var">sig</span></a><span>
</span><a name="line-1167"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nopSig</span><span>
</span><a name="line-1168"></a><span>
</span><a name="line-1169"></a><span class="hs-identifier">nonVirgin</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span>
</span><a name="line-1170"></a><a name="nonVirgin"><a href="DmdAnal.html#nonVirgin"><span class="hs-identifier">nonVirgin</span></a></a><span> </span><a name="local-6989586621684362243"><a href="#local-6989586621684362243"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362243"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ae_virgin</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1171"></a><span>
</span><a name="line-1172"></a><span class="hs-identifier">extendSigsWithLam</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span>
</span><a name="line-1173"></a><span class="hs-comment">-- Extend the AnalEnv when we meet a lambda binder</span><span>
</span><a name="line-1174"></a><a name="extendSigsWithLam"><a href="DmdAnal.html#extendSigsWithLam"><span class="hs-identifier">extendSigsWithLam</span></a></a><span> </span><a name="local-6989586621684362244"><a href="#local-6989586621684362244"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684362245"><a href="#local-6989586621684362245"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-1175"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isId</span><span> </span><a href="#local-6989586621684362245"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-1176"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isStrictDmd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idDemandInfo</span><span> </span><a href="#local-6989586621684362245"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier">ae_virgin</span><span> </span><a href="#local-6989586621684362244"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-1177"></a><span>       </span><span class="hs-comment">-- See Note [Optimistic CPR in the &quot;virgin&quot; case]</span><span>
</span><a name="line-1178"></a><span>       </span><span class="hs-comment">-- See Note [Initial CPR for strict binders]</span><span>
</span><a name="line-1179"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684362246"><a href="#local-6989586621684362246"><span class="hs-identifier">dc</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="WwLib.html#deepSplitProductType_maybe"><span class="hs-identifier hs-var">deepSplitProductType_maybe</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ae_fam_envs</span><span> </span><a href="#local-6989586621684362244"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621684362245"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-1180"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#extendAnalEnv"><span class="hs-identifier hs-var">extendAnalEnv</span></a><span> </span><span class="hs-identifier hs-var">NotTopLevel</span><span> </span><a href="#local-6989586621684362244"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684362245"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cprProdSig</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConRepArity</span><span> </span><a href="#local-6989586621684362246"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1181"></a><span>
</span><a name="line-1182"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1183"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362244"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-1184"></a><span>
</span><a name="line-1185"></a><span class="hs-identifier">extendEnvForProdAlt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Var</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span>
</span><a name="line-1186"></a><span class="hs-comment">-- See Note [CPR in a product case alternative]</span><span>
</span><a name="line-1187"></a><a name="extendEnvForProdAlt"><a href="DmdAnal.html#extendEnvForProdAlt"><span class="hs-identifier">extendEnvForProdAlt</span></a></a><span> </span><a name="local-6989586621684362247"><a href="#local-6989586621684362247"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684362248"><a href="#local-6989586621684362248"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621684362249"><a href="#local-6989586621684362249"><span class="hs-identifier">case_bndr</span></a></a><span> </span><a name="local-6989586621684362250"><a href="#local-6989586621684362250"><span class="hs-identifier">dc</span></a></a><span> </span><a name="local-6989586621684362251"><a href="#local-6989586621684362251"><span class="hs-identifier">bndrs</span></a></a><span>
</span><a name="line-1188"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="#local-6989586621684362256"><span class="hs-identifier hs-var">do_con_arg</span></a><span> </span><a href="#local-6989586621684362252"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621684362253"><span class="hs-identifier hs-var">ids_w_strs</span></a><span>
</span><a name="line-1189"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1190"></a><span>    </span><a name="local-6989586621684362252"><a href="#local-6989586621684362252"><span class="hs-identifier">env1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#extendAnalEnv"><span class="hs-identifier hs-var">extendAnalEnv</span></a><span> </span><span class="hs-identifier hs-var">NotTopLevel</span><span> </span><a href="#local-6989586621684362247"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684362249"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><a href="#local-6989586621684362254"><span class="hs-identifier hs-var">case_bndr_sig</span></a><span>
</span><a name="line-1191"></a><span>
</span><a name="line-1192"></a><span>    </span><a name="local-6989586621684362253"><a href="#local-6989586621684362253"><span class="hs-identifier">ids_w_strs</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-identifier hs-var">isId</span><span> </span><a href="#local-6989586621684362251"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">dataConRepStrictness</span><span> </span><a href="#local-6989586621684362250"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-1193"></a><span>    </span><a name="local-6989586621684362254"><a href="#local-6989586621684362254"><span class="hs-identifier">case_bndr_sig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cprProdSig</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConRepArity</span><span> </span><a href="#local-6989586621684362250"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1194"></a><span>    </span><a name="local-6989586621684362255"><a href="#local-6989586621684362255"><span class="hs-identifier">fam_envs</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ae_fam_envs</span><span> </span><a href="#local-6989586621684362247"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-1195"></a><span>
</span><a name="line-1196"></a><span>    </span><a name="local-6989586621684362256"><a href="#local-6989586621684362256"><span class="hs-identifier">do_con_arg</span></a></a><span> </span><a name="local-6989586621684362259"><a href="#local-6989586621684362259"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684362260"><a href="#local-6989586621684362260"><span class="hs-identifier">id</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362261"><a href="#local-6989586621684362261"><span class="hs-identifier">str</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1197"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684362262"><a href="#local-6989586621684362262"><span class="hs-identifier">is_strict</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isStrictDmd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idDemandInfo</span><span> </span><a href="#local-6989586621684362260"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">isMarkedStrict</span><span> </span><a href="#local-6989586621684362261"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-1198"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ae_virgin</span><span> </span><a href="#local-6989586621684362259"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684362257"><span class="hs-identifier hs-var">is_var_scrut</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684362262"><span class="hs-identifier hs-var">is_strict</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- See Note [CPR in a product case alternative]</span><span>
</span><a name="line-1199"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684362263"><a href="#local-6989586621684362263"><span class="hs-identifier">dc</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="WwLib.html#deepSplitProductType_maybe"><span class="hs-identifier hs-var">deepSplitProductType_maybe</span></a><span> </span><a href="#local-6989586621684362255"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621684362260"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-1200"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#extendAnalEnv"><span class="hs-identifier hs-var">extendAnalEnv</span></a><span> </span><span class="hs-identifier hs-var">NotTopLevel</span><span> </span><a href="#local-6989586621684362259"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684362260"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cprProdSig</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConRepArity</span><span> </span><a href="#local-6989586621684362263"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1201"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1202"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362259"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-1203"></a><span>
</span><a name="line-1204"></a><span>    </span><a name="local-6989586621684362257"><a href="#local-6989586621684362257"><span class="hs-identifier">is_var_scrut</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362258"><span class="hs-identifier hs-var">is_var</span></a><span> </span><a href="#local-6989586621684362248"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-1205"></a><span>    </span><a name="local-6989586621684362258"><a href="#local-6989586621684362258"><span class="hs-identifier">is_var</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Cast</span><span> </span><a name="local-6989586621684362264"><a href="#local-6989586621684362264"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362258"><span class="hs-identifier hs-var">is_var</span></a><span> </span><a href="#local-6989586621684362264"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1206"></a><span>    </span><span class="hs-identifier">is_var</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a name="local-6989586621684362265"><a href="#local-6989586621684362265"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isLocalId</span><span> </span><a href="#local-6989586621684362265"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-1207"></a><span>    </span><span class="hs-identifier">is_var</span><span> </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1208"></a><span>
</span><a name="line-1209"></a><span class="hs-identifier">findBndrsDmds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DmdType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Var</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DmdType</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Demand</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1210"></a><span class="hs-comment">-- Return the demands on the Ids in the [Var]</span><span>
</span><a name="line-1211"></a><a name="findBndrsDmds"><a href="DmdAnal.html#findBndrsDmds"><span class="hs-identifier">findBndrsDmds</span></a></a><span> </span><a name="local-6989586621684362266"><a href="#local-6989586621684362266"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684362267"><a href="#local-6989586621684362267"><span class="hs-identifier">dmd_ty</span></a></a><span> </span><a name="local-6989586621684362268"><a href="#local-6989586621684362268"><span class="hs-identifier">bndrs</span></a></a><span>
</span><a name="line-1212"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362269"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684362267"><span class="hs-identifier hs-var">dmd_ty</span></a><span> </span><a href="#local-6989586621684362268"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-1213"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1214"></a><span>    </span><a name="local-6989586621684362269"><a href="#local-6989586621684362269"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621684362270"><a href="#local-6989586621684362270"><span class="hs-identifier">dmd_ty</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684362270"><span class="hs-identifier hs-var">dmd_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1215"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621684362271"><a href="#local-6989586621684362271"><span class="hs-identifier">dmd_ty</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684362272"><a href="#local-6989586621684362272"><span class="hs-identifier">b</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684362273"><a href="#local-6989586621684362273"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1216"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isId</span><span> </span><a href="#local-6989586621684362272"><span class="hs-identifier hs-var">b</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684362274"><a href="#local-6989586621684362274"><span class="hs-identifier">dmd_ty1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362275"><a href="#local-6989586621684362275"><span class="hs-identifier">dmds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362269"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684362271"><span class="hs-identifier hs-var">dmd_ty</span></a><span> </span><a href="#local-6989586621684362273"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-1217"></a><span>                        </span><span class="hs-special">(</span><a name="local-6989586621684362276"><a href="#local-6989586621684362276"><span class="hs-identifier">dmd_ty2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362277"><a href="#local-6989586621684362277"><span class="hs-identifier">dmd</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DmdAnal.html#findBndrDmd"><span class="hs-identifier hs-var">findBndrDmd</span></a><span> </span><a href="#local-6989586621684362266"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621684362274"><span class="hs-identifier hs-var">dmd_ty1</span></a><span> </span><a href="#local-6989586621684362272"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-1218"></a><span>                    </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684362276"><span class="hs-identifier hs-var">dmd_ty2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684362277"><span class="hs-identifier hs-var">dmd</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684362275"><span class="hs-identifier hs-var">dmds</span></a><span class="hs-special">)</span><span>
</span><a name="line-1219"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362269"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684362271"><span class="hs-identifier hs-var">dmd_ty</span></a><span> </span><a href="#local-6989586621684362273"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-1220"></a><span>
</span><a name="line-1221"></a><span class="hs-identifier">findBndrDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DmdType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DmdType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Demand</span><span class="hs-special">)</span><span>
</span><a name="line-1222"></a><span class="hs-comment">-- See Note [Trimming a demand to a type] in Demand.hs</span><span>
</span><a name="line-1223"></a><a name="findBndrDmd"><a href="DmdAnal.html#findBndrDmd"><span class="hs-identifier">findBndrDmd</span></a></a><span> </span><a name="local-6989586621684362278"><a href="#local-6989586621684362278"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684362279"><a href="#local-6989586621684362279"><span class="hs-identifier">arg_of_dfun</span></a></a><span> </span><a name="local-6989586621684362280"><a href="#local-6989586621684362280"><span class="hs-identifier">dmd_ty</span></a></a><span> </span><a name="local-6989586621684362281"><a href="#local-6989586621684362281"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-1224"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684362283"><span class="hs-identifier hs-var">dmd_ty'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684362282"><span class="hs-identifier hs-var">dmd'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1225"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1226"></a><span>    </span><a name="local-6989586621684362282"><a href="#local-6989586621684362282"><span class="hs-identifier">dmd'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">killUsageDemand</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ae_dflags</span><span> </span><a href="#local-6989586621684362278"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1227"></a><span>           </span><a href="#local-6989586621684362286"><span class="hs-identifier hs-var">strictify</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1228"></a><span>           </span><span class="hs-identifier hs-var">trimToType</span><span> </span><a href="#local-6989586621684362284"><span class="hs-identifier hs-var">starting_dmd</span></a><span> </span><span class="hs-special">(</span><a href="WwLib.html#findTypeShape"><span class="hs-identifier hs-var">findTypeShape</span></a><span> </span><a href="#local-6989586621684362287"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><a href="#local-6989586621684362285"><span class="hs-identifier hs-var">id_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1229"></a><span>
</span><a name="line-1230"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684362283"><a href="#local-6989586621684362283"><span class="hs-identifier">dmd_ty'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684362284"><a href="#local-6989586621684362284"><span class="hs-identifier">starting_dmd</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">peelFV</span><span> </span><a href="#local-6989586621684362280"><span class="hs-identifier hs-var">dmd_ty</span></a><span> </span><a href="#local-6989586621684362281"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-1231"></a><span>
</span><a name="line-1232"></a><span>    </span><a name="local-6989586621684362285"><a href="#local-6989586621684362285"><span class="hs-identifier">id_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621684362281"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-1233"></a><span>
</span><a name="line-1234"></a><span>    </span><a name="local-6989586621684362286"><a href="#local-6989586621684362286"><span class="hs-identifier">strictify</span></a></a><span> </span><a name="local-6989586621684362288"><a href="#local-6989586621684362288"><span class="hs-identifier">dmd</span></a></a><span>
</span><a name="line-1235"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_DictsStrict</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ae_dflags</span><span> </span><a href="#local-6989586621684362278"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1236"></a><span>             </span><span class="hs-comment">-- We never want to strictify a recursive let. At the moment</span><span>
</span><a name="line-1237"></a><span>             </span><span class="hs-comment">-- annotateBndr is only call for non-recursive lets; if that</span><span>
</span><a name="line-1238"></a><span>             </span><span class="hs-comment">-- changes, we need a RecFlag parameter and another guard here.</span><span>
</span><a name="line-1239"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621684362279"><span class="hs-identifier hs-var">arg_of_dfun</span></a><span> </span><span class="hs-comment">-- See Note [Do not strictify the argument dictionaries of a dfun]</span><span>
</span><a name="line-1240"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">strictifyDictDmd</span><span> </span><a href="#local-6989586621684362285"><span class="hs-identifier hs-var">id_ty</span></a><span> </span><a href="#local-6989586621684362288"><span class="hs-identifier hs-var">dmd</span></a><span>
</span><a name="line-1241"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1242"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684362288"><span class="hs-identifier hs-var">dmd</span></a><span>
</span><a name="line-1243"></a><span>
</span><a name="line-1244"></a><span>    </span><a name="local-6989586621684362287"><a href="#local-6989586621684362287"><span class="hs-identifier">fam_envs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ae_fam_envs</span><span> </span><a href="#local-6989586621684362278"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-1245"></a><span>
</span><a name="line-1246"></a><span class="hs-identifier">set_idStrictness</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DmdAnal.html#AnalEnv"><span class="hs-identifier hs-type">AnalEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">StrictSig</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-1247"></a><a name="set_idStrictness"><a href="DmdAnal.html#set_idStrictness"><span class="hs-identifier">set_idStrictness</span></a></a><span> </span><a name="local-6989586621684362289"><a href="#local-6989586621684362289"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684362290"><a href="#local-6989586621684362290"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621684362291"><a href="#local-6989586621684362291"><span class="hs-identifier">sig</span></a></a><span>
</span><a name="line-1248"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">setIdStrictness</span><span> </span><a href="#local-6989586621684362290"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">killUsageSig</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ae_dflags</span><span> </span><a href="#local-6989586621684362289"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684362291"><span class="hs-identifier hs-var">sig</span></a><span class="hs-special">)</span><span>
</span><a name="line-1249"></a><span>
</span><a name="line-1250"></a><span class="hs-identifier">dumpStrSig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1251"></a><a name="dumpStrSig"><a href="DmdAnal.html#dumpStrSig"><span class="hs-identifier">dumpStrSig</span></a></a><span> </span><a name="local-6989586621684362292"><a href="#local-6989586621684362292"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621684362295"><span class="hs-identifier hs-var">printId</span></a><span> </span><a href="#local-6989586621684362293"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">)</span><span>
</span><a name="line-1252"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1253"></a><span>  </span><a name="local-6989586621684362293"><a href="#local-6989586621684362293"><span class="hs-identifier">ids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">stableNameCmp</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">on</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">getName</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="#local-6989586621684362294"><span class="hs-identifier hs-var">getIds</span></a><span> </span><a href="#local-6989586621684362292"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-1254"></a><span>  </span><a name="local-6989586621684362294"><a href="#local-6989586621684362294"><span class="hs-identifier">getIds</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a name="local-6989586621684362296"><a href="#local-6989586621684362296"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621684362296"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1255"></a><span>  </span><span class="hs-identifier">getIds</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><a name="local-6989586621684362297"><a href="#local-6989586621684362297"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621684362297"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-1256"></a><span>  </span><a name="local-6989586621684362295"><a href="#local-6989586621684362295"><span class="hs-identifier">printId</span></a></a><span> </span><a name="local-6989586621684362298"><a href="#local-6989586621684362298"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isExportedId</span><span> </span><a href="#local-6989586621684362298"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684362298"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">colon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprIfaceStrictSig</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idStrictness</span><span> </span><a href="#local-6989586621684362298"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-1257"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-1258"></a><span>
</span><a name="line-1259"></a><span class="hs-comment">{- Note [CPR in a product case alternative]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In a case alternative for a product type, we want to give some of the
binders the CPR property.  Specifically

 * The case binder; inside the alternative, the case binder always has
   the CPR property, meaning that a case on it will successfully cancel.
   Example:
        f True  x = case x of y { I# x' -&gt; if x' ==# 3
                                           then y
                                           else I# 8 }
        f False x = I# 3

   By giving 'y' the CPR property, we ensure that 'f' does too, so we get
        f b x = case fw b x of { r -&gt; I# r }
        fw True  x = case x of y { I# x' -&gt; if x' ==# 3 then x' else 8 }
        fw False x = 3

   Of course there is the usual risk of re-boxing: we have 'x' available
   boxed and unboxed, but we return the unboxed version for the wrapper to
   box.  If the wrapper doesn't cancel with its caller, we'll end up
   re-boxing something that we did have available in boxed form.

 * Any strict binders with product type, can use
   Note [Initial CPR for strict binders].  But we can go a little
   further. Consider

      data T = MkT !Int Int

      f2 (MkT x y) | y&gt;0       = f2 (MkT x (y-1))
                   | otherwise = x

   For $wf2 we are going to unbox the MkT *and*, since it is strict, the
   first argument of the MkT; see Note [Add demands for strict constructors]
   in WwLib. But then we don't want box it up again when returning it! We want
   'f2' to have the CPR property, so we give 'x' the CPR property.

 * It's a bit delicate because if this case is scrutinising something other
   than an argument the original function, we really don't have the unboxed
   version available.  E.g
      g v = case foo v of
              MkT x y | y&gt;0       -&gt; ...
                      | otherwise -&gt; x
   Here we don't have the unboxed 'x' available.  Hence the
   is_var_scrut test when making use of the strictness annotation.
   Slightly ad-hoc, because even if the scrutinee *is* a variable it
   might not be a onre of the arguments to the original function, or a
   sub-component thereof.  But it's simple, and nothing terrible
   happens if we get it wrong.  e.g. Trac #10694.


Note [Initial CPR for strict binders]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
CPR is initialized for a lambda binder in an optimistic manner, i.e,
if the binder is used strictly and at least some of its components as
a product are used, which is checked by the value of the absence
demand.

If the binder is marked demanded with a strict demand, then give it a
CPR signature. Here's a concrete example ('f1' in test T10482a),
assuming h is strict:

  f1 :: Int -&gt; Int
  f1 x = case h x of
          A -&gt; x
          B -&gt; f1 (x-1)
          C -&gt; x+1

If we notice that 'x' is used strictly, we can give it the CPR
property; and hence f1 gets the CPR property too.  It's sound (doesn't
change strictness) to give it the CPR property because by the time 'x'
is returned (case A above), it'll have been evaluated (by the wrapper
of 'h' in the example).

Moreover, if f itself is strict in x, then we'll pass x unboxed to
f1, and so the boxed version *won't* be available; in that case it's
very helpful to give 'x' the CPR property.

Note that

  * We only want to do this for something that definitely
    has product type, else we may get over-optimistic CPR results
    (e.g. from \x -&gt; x!).

  * See Note [CPR examples]

Note [CPR examples]
~~~~~~~~~~~~~~~~~~~~
Here are some examples (stranal/should_compile/T10482a) of the
usefulness of Note [CPR in a product case alternative].  The main
point: all of these functions can have the CPR property.

    ------- f1 -----------
    -- x is used strictly by h, so it'll be available
    -- unboxed before it is returned in the True branch

    f1 :: Int -&gt; Int
    f1 x = case h x x of
            True  -&gt; x
            False -&gt; f1 (x-1)


    ------- f2 -----------
    -- x is a strict field of MkT2, so we'll pass it unboxed
    -- to $wf2, so it's available unboxed.  This depends on
    -- the case expression analysing (a subcomponent of) one
    -- of the original arguments to the function, so it's
    -- a bit more delicate.

    data T2 = MkT2 !Int Int

    f2 :: T2 -&gt; Int
    f2 (MkT2 x y) | y&gt;0       = f2 (MkT2 x (y-1))
                  | otherwise = x


    ------- f3 -----------
    -- h is strict in x, so x will be unboxed before it
    -- is rerturned in the otherwise case.

    data T3 = MkT3 Int Int

    f1 :: T3 -&gt; Int
    f1 (MkT3 x y) | h x y     = f3 (MkT3 x (y-1))
                  | otherwise = x


    ------- f4 -----------
    -- Just like f2, but MkT4 can't unbox its strict
    -- argument automatically, as f2 can

    data family Foo a
    newtype instance Foo Int = Foo Int

    data T4 a = MkT4 !(Foo a) Int

    f4 :: T4 Int -&gt; Int
    f4 (MkT4 x@(Foo v) y) | y&gt;0       = f4 (MkT4 x (y-1))
                          | otherwise = v


Note [Initialising strictness]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
See section 9.2 (Finding fixpoints) of the paper.

Our basic plan is to initialise the strictness of each Id in a
recursive group to &quot;bottom&quot;, and find a fixpoint from there.  However,
this group B might be inside an *enclosing* recursive group A, in
which case we'll do the entire fixpoint shebang on for each iteration
of A. This can be illustrated by the following example:

Example:

  f [] = []
  f (x:xs) = let g []     = f xs
                 g (y:ys) = y+1 : g ys
              in g (h x)

At each iteration of the fixpoint for f, the analyser has to find a
fixpoint for the enclosed function g. In the meantime, the demand
values for g at each iteration for f are *greater* than those we
encountered in the previous iteration for f. Therefore, we can begin
the fixpoint for g not with the bottom value but rather with the
result of the previous analysis. I.e., when beginning the fixpoint
process for g, we can start from the demand signature computed for g
previously and attached to the binding occurrence of g.

To speed things up, we initialise each iteration of A (the enclosing
one) from the result of the last one, which is neatly recorded in each
binder.  That way we make use of earlier iterations of the fixpoint
algorithm. (Cunning plan.)

But on the *first* iteration we want to *ignore* the current strictness
of the Id, and start from &quot;bottom&quot;.  Nowadays the Id can have a current
strictness, because interface files record strictness for nested bindings.
To know when we are in the first iteration, we look at the ae_virgin
field of the AnalEnv.


Note [Final Demand Analyser run]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Some of the information that the demand analyser determines is not always
preserved by the simplifier.  For example, the simplifier will happily rewrite
  \y [Demand=1*U] let x = y in x + x
to
  \y [Demand=1*U] y + y
which is quite a lie.

The once-used information is (currently) only used by the code
generator, though.  So:

 * We zap the used-once info in the worker-wrapper;
   see Note [Zapping Used Once info in WorkWrap] in WorkWrap. If it's
   not reliable, it's better not to have it at all.

 * Just before TidyCore, we add a pass of the demand analyser,
      but WITHOUT subsequent worker/wrapper and simplifier,
   right before TidyCore.  See SimplCore.getCoreToDo.

   This way, correct information finds its way into the module interface
   (strictness signatures!) and the code generator (single-entry thunks!)

Note that, in contrast, the single-call information (C1(..)) /can/ be
relied upon, as the simplifier tends to be very careful about not
duplicating actual function calls.

Also see #11731.
-}</span><span>
</span><a name="line-1467"></a></pre></body></html>