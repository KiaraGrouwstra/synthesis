<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP, NamedFieldPuns, NondecreasingIndentation, BangPatterns #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# OPTIONS_GHC -fno-cse #-}</span><span>
</span><a name="line-3"></a><span class="hs-comment">-- -fno-cse is needed for GLOBAL_VAR's to behave properly</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-6"></a><span class="hs-comment">--</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- GHC Driver</span><span>
</span><a name="line-8"></a><span class="hs-comment">--</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- (c) The University of Glasgow 2005</span><span>
</span><a name="line-10"></a><span class="hs-comment">--</span><span>
</span><a name="line-11"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">DriverPipeline</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-14"></a><span>        </span><span class="hs-comment">-- Run a series of compilation steps in a pipeline, for a</span><span>
</span><a name="line-15"></a><span>        </span><span class="hs-comment">-- collection of source files.</span><span>
</span><a name="line-16"></a><span>   </span><a href="DriverPipeline.html#oneShot"><span class="hs-identifier hs-var">oneShot</span></a><span class="hs-special">,</span><span> </span><a href="DriverPipeline.html#compileFile"><span class="hs-identifier hs-var">compileFile</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span>        </span><span class="hs-comment">-- Interfaces for the batch-mode driver</span><span>
</span><a name="line-19"></a><span>   </span><a href="DriverPipeline.html#linkBinary"><span class="hs-identifier hs-var">linkBinary</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span>        </span><span class="hs-comment">-- Interfaces for the compilation manager (interpreted/batch-mode)</span><span>
</span><a name="line-22"></a><span>   </span><a href="DriverPipeline.html#preprocess"><span class="hs-identifier hs-var">preprocess</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>   </span><a href="DriverPipeline.html#compileOne"><span class="hs-identifier hs-var">compileOne</span></a><span class="hs-special">,</span><span> </span><a href="DriverPipeline.html#compileOne%27"><span class="hs-identifier hs-var">compileOne'</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>   </span><a href="DriverPipeline.html#link"><span class="hs-identifier hs-var">link</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span>        </span><span class="hs-comment">-- Exports for hooks to override runPhase and link</span><span>
</span><a name="line-27"></a><span>   </span><span class="hs-identifier hs-type">PhasePlus</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CompPipeline</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">PipeEnv</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">PipeState</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>   </span><a href="DriverPipeline.html#phaseOutputFilename"><span class="hs-identifier hs-var">phaseOutputFilename</span></a><span class="hs-special">,</span><span> </span><a href="DriverPipeline.html#getOutputFilename"><span class="hs-identifier hs-var">getOutputFilename</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">getPipeState</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">getPipeEnv</span><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>   </span><a href="DriverPipeline.html#hscPostBackendPhase"><span class="hs-identifier hs-var">hscPostBackendPhase</span></a><span class="hs-special">,</span><span> </span><a href="DriverPipeline.html#getLocation"><span class="hs-identifier hs-var">getLocation</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">setModLocation</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">setDynFlags</span><span class="hs-special">,</span><span>
</span><a name="line-30"></a><span>   </span><a href="DriverPipeline.html#runPhase"><span class="hs-identifier hs-var">runPhase</span></a><span class="hs-special">,</span><span> </span><a href="DriverPipeline.html#exeFileName"><span class="hs-identifier hs-var">exeFileName</span></a><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>   </span><a href="DriverPipeline.html#maybeCreateManifest"><span class="hs-identifier hs-var">maybeCreateManifest</span></a><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span>   </span><a href="DriverPipeline.html#linkingNeeded"><span class="hs-identifier hs-var">linkingNeeded</span></a><span class="hs-special">,</span><span> </span><a href="SysTools.ExtraObj.html#checkLinkInfo"><span class="hs-identifier hs-var">checkLinkInfo</span></a><span class="hs-special">,</span><span> </span><a href="DriverPipeline.html#writeInterfaceOnlyMode"><span class="hs-identifier hs-var">writeInterfaceOnlyMode</span></a><span>
</span><a name="line-33"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-38"></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PipelineMonad</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Packages</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HeaderInfo</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DriverPhases</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="SysTools.html"><span class="hs-identifier">SysTools</span></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="SysTools.ExtraObj.html"><span class="hs-identifier">SysTools.ExtraObj</span></a><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><a href="HscMain.html"><span class="hs-identifier">HscMain</span></a><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="Finder.html"><span class="hs-identifier">Finder</span></a><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Config</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Panic</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">StringBuffer</span><span>     </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">hGetStringBuffer</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">SuccessFlag</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>           </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">expectJust</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><a href="LlvmCodeGen.html"><span class="hs-identifier">LlvmCodeGen</span></a><span>      </span><span class="hs-special">(</span><span> </span><a href="LlvmMangler.html#llvmFixupAsm"><span class="hs-identifier hs-var">llvmFixupAsm</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MonadUtils</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Platform</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcRnTypes</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Hooks</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC.LanguageExtensions</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LangExt</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FileCleanup</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><a href="Ar.html"><span class="hs-identifier">Ar</span></a><span>
</span><a name="line-67"></a><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Exception</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Directory</span><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.FilePath</span><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.IO</span><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">isInfixOf</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isSuffixOf</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">intercalate</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Version</span><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Either</span><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">partitionEithers</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Time</span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">UTCTime</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span>
</span><a name="line-80"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-81"></a><span class="hs-comment">-- Pre-process</span><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span class="hs-comment">-- | Just preprocess a file, put the result in a temp. file (used by the</span><span>
</span><a name="line-84"></a><span class="hs-comment">-- compilation manager during the summary phase).</span><span>
</span><a name="line-85"></a><span class="hs-comment">--</span><span>
</span><a name="line-86"></a><span class="hs-comment">-- We return the augmented DynFlags, because they contain the result</span><span>
</span><a name="line-87"></a><span class="hs-comment">-- of slurping in the OPTIONS pragmas</span><span>
</span><a name="line-88"></a><span>
</span><a name="line-89"></a><span class="hs-identifier">preprocess</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-90"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Phase</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ filename and starting phase</span><span>
</span><a name="line-91"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DynFlags</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">)</span><span>
</span><a name="line-92"></a><a name="preprocess"><a href="DriverPipeline.html#preprocess"><span class="hs-identifier">preprocess</span></a></a><span> </span><a name="local-6989586621685141705"><a href="#local-6989586621685141705"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621685141706"><a href="#local-6989586621685141706"><span class="hs-identifier">filename</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685141707"><a href="#local-6989586621685141707"><span class="hs-identifier">mb_phase</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-93"></a><span>  </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span class="hs-identifier">isJust</span><span> </span><span class="hs-identifier">mb_phase</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier">isHaskellSrcFilename</span><span> </span><span class="hs-identifier hs-var">filename</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-identifier">filename</span><span class="hs-special">)</span><span>
</span><a name="line-94"></a><span>  </span><a href="DriverPipeline.html#runPipeline"><span class="hs-identifier hs-var">runPipeline</span></a><span> </span><span class="hs-identifier hs-var">anyHsc</span><span> </span><a href="#local-6989586621685141705"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621685141706"><span class="hs-identifier hs-var">filename</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">RealPhase</span><span> </span><a href="#local-6989586621685141707"><span class="hs-identifier hs-var">mb_phase</span></a><span class="hs-special">)</span><span>
</span><a name="line-95"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-96"></a><span>        </span><span class="hs-comment">-- We keep the processed file for the whole session to save on</span><span>
</span><a name="line-97"></a><span>        </span><span class="hs-comment">-- duplicated work in ghci.</span><span>
</span><a name="line-98"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Temporary</span><span> </span><span class="hs-identifier hs-var">TFL_GhcSession</span><span class="hs-special">)</span><span>
</span><a name="line-99"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-comment">{-no ModLocation-}</span><span>
</span><a name="line-100"></a><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-comment">{-no foreign objects-}</span><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span class="hs-comment">-- | Compile</span><span>
</span><a name="line-105"></a><span class="hs-comment">--</span><span>
</span><a name="line-106"></a><span class="hs-comment">-- Compile a single module, under the control of the compilation manager.</span><span>
</span><a name="line-107"></a><span class="hs-comment">--</span><span>
</span><a name="line-108"></a><span class="hs-comment">-- This is the interface between the compilation manager and the</span><span>
</span><a name="line-109"></a><span class="hs-comment">-- compiler proper (hsc), where we deal with tedious details like</span><span>
</span><a name="line-110"></a><span class="hs-comment">-- reading the OPTIONS pragma from the source file, converting the</span><span>
</span><a name="line-111"></a><span class="hs-comment">-- C or assembly that GHC produces into an object file, and compiling</span><span>
</span><a name="line-112"></a><span class="hs-comment">-- FFI stub files.</span><span>
</span><a name="line-113"></a><span class="hs-comment">--</span><span>
</span><a name="line-114"></a><span class="hs-comment">-- NB.  No old interface can also mean that the source has changed.</span><span>
</span><a name="line-115"></a><span>
</span><a name="line-116"></a><span class="hs-identifier">compileOne</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-117"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span>      </span><span class="hs-comment">-- ^ summary for module being compiled</span><span>
</span><a name="line-118"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>             </span><span class="hs-comment">-- ^ module N ...</span><span>
</span><a name="line-119"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>             </span><span class="hs-comment">-- ^ ... of M</span><span>
</span><a name="line-120"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span>  </span><span class="hs-comment">-- ^ old interface, if we have one</span><span>
</span><a name="line-121"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Linkable</span><span>  </span><span class="hs-comment">-- ^ old linkable, if we have one</span><span>
</span><a name="line-122"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SourceModified</span><span>
</span><a name="line-123"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">HomeModInfo</span><span>   </span><span class="hs-comment">-- ^ the complete HomeModInfo, if successful</span><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a><a name="compileOne"><a href="DriverPipeline.html#compileOne"><span class="hs-identifier">compileOne</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DriverPipeline.html#compileOne%27"><span class="hs-identifier hs-var">compileOne'</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="HscMain.html#batchMsg"><span class="hs-identifier hs-var">batchMsg</span></a><span class="hs-special">)</span><span>
</span><a name="line-126"></a><span>
</span><a name="line-127"></a><span class="hs-identifier">compileOne'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-128"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="HscMain.html#Messager"><span class="hs-identifier hs-type">Messager</span></a><span>
</span><a name="line-129"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-130"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span>      </span><span class="hs-comment">-- ^ summary for module being compiled</span><span>
</span><a name="line-131"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>             </span><span class="hs-comment">-- ^ module N ...</span><span>
</span><a name="line-132"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>             </span><span class="hs-comment">-- ^ ... of M</span><span>
</span><a name="line-133"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span>  </span><span class="hs-comment">-- ^ old interface, if we have one</span><span>
</span><a name="line-134"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Linkable</span><span>  </span><span class="hs-comment">-- ^ old linkable, if we have one</span><span>
</span><a name="line-135"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SourceModified</span><span>
</span><a name="line-136"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">HomeModInfo</span><span>   </span><span class="hs-comment">-- ^ the complete HomeModInfo, if successful</span><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><a name="compileOne%27"><a href="DriverPipeline.html#compileOne%27"><span class="hs-identifier">compileOne'</span></a></a><span> </span><a name="local-6989586621685141708"><a href="#local-6989586621685141708"><span class="hs-identifier">m_tc_result</span></a></a><span> </span><a name="local-6989586621685141709"><a href="#local-6989586621685141709"><span class="hs-identifier">mHscMessage</span></a></a><span>
</span><a name="line-139"></a><span>            </span><a name="local-6989586621685141710"><a href="#local-6989586621685141710"><span class="hs-identifier">hsc_env0</span></a></a><span> </span><a name="local-6989586621685141711"><a href="#local-6989586621685141711"><span class="hs-identifier">summary</span></a></a><span> </span><a name="local-6989586621685141712"><a href="#local-6989586621685141712"><span class="hs-identifier">mod_index</span></a></a><span> </span><a name="local-6989586621685141713"><a href="#local-6989586621685141713"><span class="hs-identifier">nmods</span></a></a><span> </span><a name="local-6989586621685141714"><a href="#local-6989586621685141714"><span class="hs-identifier">mb_old_iface</span></a></a><span> </span><a name="local-6989586621685141715"><a href="#local-6989586621685141715"><span class="hs-identifier">maybe_old_linkable</span></a></a><span>
</span><a name="line-140"></a><span>            </span><a name="local-6989586621685141716"><a href="#local-6989586621685141716"><span class="hs-identifier">source_modified0</span></a></a><span>
</span><a name="line-141"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span>   </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><a href="#local-6989586621685141731"><span class="hs-identifier hs-var">dflags1</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;compile: input file&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621685141721"><span class="hs-identifier hs-var">input_fnpp</span></a><span class="hs-special">)</span><span>
</span><a name="line-144"></a><span>
</span><a name="line-145"></a><span>   </span><span class="hs-special">(</span><a name="local-6989586621685141742"><a href="#local-6989586621685141742"><span class="hs-identifier">status</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685141743"><a href="#local-6989586621685141743"><span class="hs-identifier">hmi0</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#hscIncrementalCompile"><span class="hs-identifier hs-var">hscIncrementalCompile</span></a><span>
</span><a name="line-146"></a><span>                        </span><a href="#local-6989586621685141741"><span class="hs-identifier hs-var">always_do_basic_recompilation_check</span></a><span>
</span><a name="line-147"></a><span>                        </span><a href="#local-6989586621685141708"><span class="hs-identifier hs-var">m_tc_result</span></a><span> </span><a href="#local-6989586621685141709"><span class="hs-identifier hs-var">mHscMessage</span></a><span>
</span><a name="line-148"></a><span>                        </span><a href="#local-6989586621685141737"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685141711"><span class="hs-identifier hs-var">summary</span></a><span> </span><a href="#local-6989586621685141740"><span class="hs-identifier hs-var">source_modified</span></a><span> </span><a href="#local-6989586621685141714"><span class="hs-identifier hs-var">mb_old_iface</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621685141712"><span class="hs-identifier hs-var">mod_index</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685141713"><span class="hs-identifier hs-var">nmods</span></a><span class="hs-special">)</span><span>
</span><a name="line-149"></a><span>
</span><a name="line-150"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685141744"><a href="#local-6989586621685141744"><span class="hs-identifier">flags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685141710"><span class="hs-identifier hs-var">hsc_env0</span></a><span>
</span><a name="line-151"></a><span>     </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_KeepHiFiles</span><span> </span><a href="#local-6989586621685141744"><span class="hs-identifier hs-var">flags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-152"></a><span>               </span><span class="hs-identifier hs-var">addFilesToClean</span><span> </span><a href="#local-6989586621685141744"><span class="hs-identifier hs-var">flags</span></a><span> </span><span class="hs-identifier hs-var">TFL_CurrentModule</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-153"></a><span>                   </span><span class="hs-special">[</span><span class="hs-identifier">ml_hi_file</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">ms_location</span><span> </span><a href="#local-6989586621685141711"><span class="hs-identifier hs-var">summary</span></a><span class="hs-special">]</span><span>
</span><a name="line-154"></a><span>           </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_KeepOFiles</span><span> </span><a href="#local-6989586621685141744"><span class="hs-identifier hs-var">flags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-155"></a><span>               </span><span class="hs-identifier hs-var">addFilesToClean</span><span> </span><a href="#local-6989586621685141744"><span class="hs-identifier hs-var">flags</span></a><span> </span><span class="hs-identifier hs-var">TFL_GhcSession</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-156"></a><span>                   </span><span class="hs-special">[</span><span class="hs-identifier">ml_obj_file</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">ms_location</span><span> </span><a href="#local-6989586621685141711"><span class="hs-identifier hs-var">summary</span></a><span class="hs-special">]</span><span>
</span><a name="line-157"></a><span>
</span><a name="line-158"></a><span>   </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685141742"><span class="hs-identifier hs-var">status</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685141738"><span class="hs-identifier hs-var">hsc_lang</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-159"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HscUpToDate</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-160"></a><span>            </span><span class="hs-comment">-- TODO recomp014 triggers this assert. What's going on?!</span><span>
</span><a name="line-161"></a><span>            </span><span class="hs-comment">-- ASSERT( isJust maybe_old_linkable || isNoLink (ghcLink dflags) )</span><span>
</span><a name="line-162"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685141743"><span class="hs-identifier hs-var">hmi0</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hm_linkable</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141715"><span class="hs-identifier hs-var">maybe_old_linkable</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-163"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HscNotGeneratingCode</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HscNothing</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-164"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685141745"><a href="#local-6989586621685141745"><span class="hs-identifier">mb_linkable</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isHsBootOrSig</span><span> </span><a href="#local-6989586621685141727"><span class="hs-identifier hs-var">src_flavour</span></a><span>
</span><a name="line-165"></a><span>                                </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-166"></a><span>                                </span><span class="hs-comment">-- TODO: Questionable.</span><span>
</span><a name="line-167"></a><span>                                </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ms_hs_date</span><span> </span><a href="#local-6989586621685141711"><span class="hs-identifier hs-var">summary</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685141718"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-168"></a><span>            </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685141743"><span class="hs-identifier hs-var">hmi0</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hm_linkable</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141745"><span class="hs-identifier hs-var">mb_linkable</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-169"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HscNotGeneratingCode</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;compileOne HscNotGeneratingCode&quot;</span><span>
</span><a name="line-170"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HscNothing</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;compileOne HscNothing&quot;</span><span>
</span><a name="line-171"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HscUpdateBoot</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HscInterpreted</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-172"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685141743"><span class="hs-identifier hs-var">hmi0</span></a><span>
</span><a name="line-173"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HscUpdateBoot</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-174"></a><span>            </span><a href="DriverPipeline.html#touchObjectFile"><span class="hs-identifier hs-var">touchObjectFile</span></a><span> </span><a href="#local-6989586621685141736"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685141730"><span class="hs-identifier hs-var">object_filename</span></a><span>
</span><a name="line-175"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685141743"><span class="hs-identifier hs-var">hmi0</span></a><span>
</span><a name="line-176"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HscUpdateSig</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HscInterpreted</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-177"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685141746"><a href="#local-6989586621685141746"><span class="hs-identifier">linkable</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">LM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ms_hs_date</span><span> </span><a href="#local-6989586621685141711"><span class="hs-identifier hs-var">summary</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685141718"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-178"></a><span>            </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685141743"><span class="hs-identifier hs-var">hmi0</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hm_linkable</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685141746"><span class="hs-identifier hs-var">linkable</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-179"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HscUpdateSig</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-180"></a><span>            </span><a name="local-6989586621685141747"><a href="#local-6989586621685141747"><span class="hs-identifier">output_fn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#getOutputFilename"><span class="hs-identifier hs-var">getOutputFilename</span></a><span> </span><a href="#local-6989586621685141729"><span class="hs-identifier hs-var">next_phase</span></a><span>
</span><a name="line-181"></a><span>                            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Temporary</span><span> </span><span class="hs-identifier hs-var">TFL_CurrentModule</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685141732"><span class="hs-identifier hs-var">basename</span></a><span> </span><a href="#local-6989586621685141736"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-182"></a><span>                            </span><a href="#local-6989586621685141729"><span class="hs-identifier hs-var">next_phase</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685141719"><span class="hs-identifier hs-var">location</span></a><span class="hs-special">)</span><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a><span>            </span><span class="hs-comment">-- #10660: Use the pipeline instead of calling</span><span>
</span><a name="line-185"></a><span>            </span><span class="hs-comment">-- compileEmptyStub directly, so -dynamic-too gets</span><span>
</span><a name="line-186"></a><span>            </span><span class="hs-comment">-- handled properly</span><span>
</span><a name="line-187"></a><span>            </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#runPipeline"><span class="hs-identifier hs-var">runPipeline</span></a><span> </span><span class="hs-identifier hs-var">StopLn</span><span> </span><a href="#local-6989586621685141737"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-188"></a><span>                              </span><span class="hs-special">(</span><a href="#local-6989586621685141747"><span class="hs-identifier hs-var">output_fn</span></a><span class="hs-special">,</span><span>
</span><a name="line-189"></a><span>                               </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HscOut</span><span> </span><a href="#local-6989586621685141727"><span class="hs-identifier hs-var">src_flavour</span></a><span>
</span><a name="line-190"></a><span>                                            </span><a href="#local-6989586621685141728"><span class="hs-identifier hs-var">mod_name</span></a><span> </span><span class="hs-identifier hs-var">HscUpdateSig</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-191"></a><span>                              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685141732"><span class="hs-identifier hs-var">basename</span></a><span class="hs-special">)</span><span>
</span><a name="line-192"></a><span>                              </span><span class="hs-identifier hs-var">Persistent</span><span>
</span><a name="line-193"></a><span>                              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685141719"><span class="hs-identifier hs-var">location</span></a><span class="hs-special">)</span><span>
</span><a name="line-194"></a><span>                              </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-195"></a><span>            </span><a name="local-6989586621685141748"><a href="#local-6989586621685141748"><span class="hs-identifier">o_time</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModificationUTCTime</span><span> </span><a href="#local-6989586621685141730"><span class="hs-identifier hs-var">object_filename</span></a><span>
</span><a name="line-196"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685141749"><a href="#local-6989586621685141749"><span class="hs-identifier">linkable</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">LM</span><span> </span><a href="#local-6989586621685141748"><span class="hs-identifier hs-var">o_time</span></a><span> </span><a href="#local-6989586621685141718"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">DotO</span><span> </span><a href="#local-6989586621685141730"><span class="hs-identifier hs-var">object_filename</span></a><span class="hs-special">]</span><span>
</span><a name="line-197"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685141743"><span class="hs-identifier hs-var">hmi0</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hm_linkable</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685141749"><span class="hs-identifier hs-var">linkable</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-198"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HscRecomp</span><span> </span><a name="local-6989586621685141750"><a href="#local-6989586621685141750"><span class="hs-identifier">cgguts</span></a></a><span> </span><a name="local-6989586621685141751"><a href="#local-6989586621685141751"><span class="hs-identifier">summary</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HscInterpreted</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-199"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621685141752"><a href="#local-6989586621685141752"><span class="hs-identifier">hasStub</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685141753"><a href="#local-6989586621685141753"><span class="hs-identifier">comp_bc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685141754"><a href="#local-6989586621685141754"><span class="hs-identifier">spt_entries</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-200"></a><span>                </span><a href="HscMain.html#hscInteractive"><span class="hs-identifier hs-var">hscInteractive</span></a><span> </span><a href="#local-6989586621685141737"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685141750"><span class="hs-identifier hs-var">cgguts</span></a><span> </span><a href="#local-6989586621685141751"><span class="hs-identifier hs-var">summary</span></a><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span>            </span><a name="local-6989586621685141757"><a href="#local-6989586621685141757"><span class="hs-identifier">stub_o</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685141752"><span class="hs-identifier hs-var">hasStub</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-203"></a><span>                      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-204"></a><span>                      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685141755"><a href="#local-6989586621685141755"><span class="hs-identifier">stub_c</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-205"></a><span>                          </span><a name="local-6989586621685141756"><a href="#local-6989586621685141756"><span class="hs-identifier">stub_o</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#compileStub"><span class="hs-identifier hs-var">compileStub</span></a><span> </span><a href="#local-6989586621685141737"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685141755"><span class="hs-identifier hs-var">stub_c</span></a><span>
</span><a name="line-206"></a><span>                          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">DotO</span><span> </span><a href="#local-6989586621685141756"><span class="hs-identifier hs-var">stub_o</span></a><span class="hs-special">]</span><span>
</span><a name="line-207"></a><span>
</span><a name="line-208"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685141758"><a href="#local-6989586621685141758"><span class="hs-identifier">hs_unlinked</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">BCOs</span><span> </span><a href="#local-6989586621685141753"><span class="hs-identifier hs-var">comp_bc</span></a><span> </span><a href="#local-6989586621685141754"><span class="hs-identifier hs-var">spt_entries</span></a><span class="hs-special">]</span><span>
</span><a name="line-209"></a><span>                </span><a name="local-6989586621685141759"><a href="#local-6989586621685141759"><span class="hs-identifier">unlinked_time</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_hs_date</span><span> </span><a href="#local-6989586621685141751"><span class="hs-identifier hs-var">summary</span></a><span>
</span><a name="line-210"></a><span>              </span><span class="hs-comment">-- Why do we use the timestamp of the source file here,</span><span>
</span><a name="line-211"></a><span>              </span><span class="hs-comment">-- rather than the current time?  This works better in</span><span>
</span><a name="line-212"></a><span>              </span><span class="hs-comment">-- the case where the local clock is out of sync</span><span>
</span><a name="line-213"></a><span>              </span><span class="hs-comment">-- with the filesystem's clock.  It's just as accurate:</span><span>
</span><a name="line-214"></a><span>              </span><span class="hs-comment">-- if the source is modified, then the linkable will</span><span>
</span><a name="line-215"></a><span>              </span><span class="hs-comment">-- be out of date.</span><span>
</span><a name="line-216"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685141760"><a href="#local-6989586621685141760"><span class="hs-identifier">linkable</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">LM</span><span> </span><a href="#local-6989586621685141759"><span class="hs-identifier hs-var">unlinked_time</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ms_mod</span><span> </span><a href="#local-6989586621685141751"><span class="hs-identifier hs-var">summary</span></a><span class="hs-special">)</span><span>
</span><a name="line-217"></a><span>                           </span><span class="hs-special">(</span><a href="#local-6989586621685141758"><span class="hs-identifier hs-var">hs_unlinked</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685141757"><span class="hs-identifier hs-var">stub_o</span></a><span class="hs-special">)</span><span>
</span><a name="line-218"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685141743"><span class="hs-identifier hs-var">hmi0</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hm_linkable</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685141760"><span class="hs-identifier hs-var">linkable</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-219"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HscRecomp</span><span> </span><a name="local-6989586621685141761"><a href="#local-6989586621685141761"><span class="hs-identifier">cgguts</span></a></a><span> </span><a name="local-6989586621685141762"><a href="#local-6989586621685141762"><span class="hs-identifier">summary</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-220"></a><span>            </span><a name="local-6989586621685141763"><a href="#local-6989586621685141763"><span class="hs-identifier">output_fn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#getOutputFilename"><span class="hs-identifier hs-var">getOutputFilename</span></a><span> </span><a href="#local-6989586621685141729"><span class="hs-identifier hs-var">next_phase</span></a><span>
</span><a name="line-221"></a><span>                            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Temporary</span><span> </span><span class="hs-identifier hs-var">TFL_CurrentModule</span><span class="hs-special">)</span><span>
</span><a name="line-222"></a><span>                            </span><a href="#local-6989586621685141732"><span class="hs-identifier hs-var">basename</span></a><span> </span><a href="#local-6989586621685141736"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685141729"><span class="hs-identifier hs-var">next_phase</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685141719"><span class="hs-identifier hs-var">location</span></a><span class="hs-special">)</span><span>
</span><a name="line-223"></a><span>            </span><span class="hs-comment">-- We're in --make mode: finish the compilation pipeline.</span><span>
</span><a name="line-224"></a><span>            </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#runPipeline"><span class="hs-identifier hs-var">runPipeline</span></a><span> </span><span class="hs-identifier hs-var">StopLn</span><span> </span><a href="#local-6989586621685141737"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-225"></a><span>                              </span><span class="hs-special">(</span><a href="#local-6989586621685141763"><span class="hs-identifier hs-var">output_fn</span></a><span class="hs-special">,</span><span>
</span><a name="line-226"></a><span>                               </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HscOut</span><span> </span><a href="#local-6989586621685141727"><span class="hs-identifier hs-var">src_flavour</span></a><span> </span><a href="#local-6989586621685141728"><span class="hs-identifier hs-var">mod_name</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HscRecomp</span><span> </span><a href="#local-6989586621685141761"><span class="hs-identifier hs-var">cgguts</span></a><span> </span><a href="#local-6989586621685141762"><span class="hs-identifier hs-var">summary</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-227"></a><span>                              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685141732"><span class="hs-identifier hs-var">basename</span></a><span class="hs-special">)</span><span>
</span><a name="line-228"></a><span>                              </span><span class="hs-identifier hs-var">Persistent</span><span>
</span><a name="line-229"></a><span>                              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685141719"><span class="hs-identifier hs-var">location</span></a><span class="hs-special">)</span><span>
</span><a name="line-230"></a><span>                              </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-231"></a><span>                  </span><span class="hs-comment">-- The object filename comes from the ModLocation</span><span>
</span><a name="line-232"></a><span>            </span><a name="local-6989586621685141764"><a href="#local-6989586621685141764"><span class="hs-identifier">o_time</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModificationUTCTime</span><span> </span><a href="#local-6989586621685141730"><span class="hs-identifier hs-var">object_filename</span></a><span>
</span><a name="line-233"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685141765"><a href="#local-6989586621685141765"><span class="hs-identifier">linkable</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">LM</span><span> </span><a href="#local-6989586621685141764"><span class="hs-identifier hs-var">o_time</span></a><span> </span><a href="#local-6989586621685141718"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">DotO</span><span> </span><a href="#local-6989586621685141730"><span class="hs-identifier hs-var">object_filename</span></a><span class="hs-special">]</span><span>
</span><a name="line-234"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685141743"><span class="hs-identifier hs-var">hmi0</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hm_linkable</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685141765"><span class="hs-identifier hs-var">linkable</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-235"></a><span>
</span><a name="line-236"></a><span> </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621685141717"><a href="#local-6989586621685141717"><span class="hs-identifier">dflags0</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_hspp_opts</span><span> </span><a href="#local-6989586621685141711"><span class="hs-identifier hs-var">summary</span></a><span>
</span><a name="line-237"></a><span>
</span><a name="line-238"></a><span>       </span><a name="local-6989586621685141718"><a href="#local-6989586621685141718"><span class="hs-identifier">this_mod</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_mod</span><span> </span><a href="#local-6989586621685141711"><span class="hs-identifier hs-var">summary</span></a><span>
</span><a name="line-239"></a><span>       </span><a name="local-6989586621685141719"><a href="#local-6989586621685141719"><span class="hs-identifier">location</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_location</span><span> </span><a href="#local-6989586621685141711"><span class="hs-identifier hs-var">summary</span></a><span>
</span><a name="line-240"></a><span>       </span><a name="local-6989586621685141720"><a href="#local-6989586621685141720"><span class="hs-identifier">input_fn</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">expectJust</span><span> </span><span class="hs-string">&quot;compile:hs&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ml_hs_file</span><span> </span><a href="#local-6989586621685141719"><span class="hs-identifier hs-var">location</span></a><span class="hs-special">)</span><span>
</span><a name="line-241"></a><span>       </span><a name="local-6989586621685141721"><a href="#local-6989586621685141721"><span class="hs-identifier">input_fnpp</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_hspp_file</span><span> </span><a href="#local-6989586621685141711"><span class="hs-identifier hs-var">summary</span></a><span>
</span><a name="line-242"></a><span>       </span><a name="local-6989586621685141722"><a href="#local-6989586621685141722"><span class="hs-identifier">mod_graph</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_mod_graph</span><span> </span><a href="#local-6989586621685141710"><span class="hs-identifier hs-var">hsc_env0</span></a><span>
</span><a name="line-243"></a><span>       </span><a name="local-6989586621685141723"><a href="#local-6989586621685141723"><span class="hs-identifier">needsLinker</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">needsTemplateHaskellOrQQ</span><span> </span><a href="#local-6989586621685141722"><span class="hs-identifier hs-var">mod_graph</span></a><span>
</span><a name="line-244"></a><span>       </span><a name="local-6989586621685141724"><a href="#local-6989586621685141724"><span class="hs-identifier">isDynWay</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">WayDyn</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ways</span><span> </span><a href="#local-6989586621685141717"><span class="hs-identifier hs-var">dflags0</span></a><span class="hs-special">)</span><span>
</span><a name="line-245"></a><span>       </span><a name="local-6989586621685141725"><a href="#local-6989586621685141725"><span class="hs-identifier">isProfWay</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">WayProf</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ways</span><span> </span><a href="#local-6989586621685141717"><span class="hs-identifier hs-var">dflags0</span></a><span class="hs-special">)</span><span>
</span><a name="line-246"></a><span>       </span><a name="local-6989586621685141726"><a href="#local-6989586621685141726"><span class="hs-identifier">internalInterpreter</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_ExternalInterpreter</span><span> </span><a href="#local-6989586621685141717"><span class="hs-identifier hs-var">dflags0</span></a><span class="hs-special">)</span><span>
</span><a name="line-247"></a><span>
</span><a name="line-248"></a><span>       </span><a name="local-6989586621685141727"><a href="#local-6989586621685141727"><span class="hs-identifier">src_flavour</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_hsc_src</span><span> </span><a href="#local-6989586621685141711"><span class="hs-identifier hs-var">summary</span></a><span>
</span><a name="line-249"></a><span>       </span><a name="local-6989586621685141728"><a href="#local-6989586621685141728"><span class="hs-identifier">mod_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ms_mod_name</span><span> </span><a href="#local-6989586621685141711"><span class="hs-identifier hs-var">summary</span></a><span>
</span><a name="line-250"></a><span>       </span><a name="local-6989586621685141729"><a href="#local-6989586621685141729"><span class="hs-identifier">next_phase</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DriverPipeline.html#hscPostBackendPhase"><span class="hs-identifier hs-var">hscPostBackendPhase</span></a><span> </span><a href="#local-6989586621685141736"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685141727"><span class="hs-identifier hs-var">src_flavour</span></a><span> </span><a href="#local-6989586621685141738"><span class="hs-identifier hs-var">hsc_lang</span></a><span>
</span><a name="line-251"></a><span>       </span><a name="local-6989586621685141730"><a href="#local-6989586621685141730"><span class="hs-identifier">object_filename</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ml_obj_file</span><span> </span><a href="#local-6989586621685141719"><span class="hs-identifier hs-var">location</span></a><span>
</span><a name="line-252"></a><span>
</span><a name="line-253"></a><span>       </span><span class="hs-comment">-- #8180 - when using TemplateHaskell, switch on -dynamic-too so</span><span>
</span><a name="line-254"></a><span>       </span><span class="hs-comment">-- the linker can correctly load the object files.  This isn't necessary</span><span>
</span><a name="line-255"></a><span>       </span><span class="hs-comment">-- when using -fexternal-interpreter.</span><span>
</span><a name="line-256"></a><span>       </span><a name="local-6989586621685141731"><a href="#local-6989586621685141731"><span class="hs-identifier">dflags1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">dynamicGhc</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621685141726"><span class="hs-identifier hs-var">internalInterpreter</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-257"></a><span>                    </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621685141724"><span class="hs-identifier hs-var">isDynWay</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621685141725"><span class="hs-identifier hs-var">isProfWay</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621685141723"><span class="hs-identifier hs-var">needsLinker</span></a><span>
</span><a name="line-258"></a><span>                  </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">gopt_set</span><span> </span><a href="#local-6989586621685141717"><span class="hs-identifier hs-var">dflags0</span></a><span> </span><span class="hs-identifier hs-var">Opt_BuildDynamicToo</span><span>
</span><a name="line-259"></a><span>                  </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621685141717"><span class="hs-identifier hs-var">dflags0</span></a><span>
</span><a name="line-260"></a><span>
</span><a name="line-261"></a><span>       </span><a name="local-6989586621685141732"><a href="#local-6989586621685141732"><span class="hs-identifier">basename</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dropExtension</span><span> </span><a href="#local-6989586621685141720"><span class="hs-identifier hs-var">input_fn</span></a><span>
</span><a name="line-262"></a><span>
</span><a name="line-263"></a><span>       </span><span class="hs-comment">-- We add the directory in which the .hs files resides) to the import</span><span>
</span><a name="line-264"></a><span>       </span><span class="hs-comment">-- path.  This is needed when we try to compile the .hc file later, if it</span><span>
</span><a name="line-265"></a><span>       </span><span class="hs-comment">-- imports a _stub.h file that we created here.</span><span>
</span><a name="line-266"></a><span>       </span><a name="local-6989586621685141733"><a href="#local-6989586621685141733"><span class="hs-identifier">current_dir</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">takeDirectory</span><span> </span><a href="#local-6989586621685141732"><span class="hs-identifier hs-var">basename</span></a><span>
</span><a name="line-267"></a><span>       </span><a name="local-6989586621685141734"><a href="#local-6989586621685141734"><span class="hs-identifier">old_paths</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">includePaths</span><span> </span><a href="#local-6989586621685141731"><span class="hs-identifier hs-var">dflags1</span></a><span>
</span><a name="line-268"></a><span>       </span><span class="hs-glyph">!</span><a name="local-6989586621685141735"><a href="#local-6989586621685141735"><span class="hs-identifier">prevailing_dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685141710"><span class="hs-identifier hs-var">hsc_env0</span></a><span>
</span><a name="line-269"></a><span>       </span><a name="local-6989586621685141736"><a href="#local-6989586621685141736"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-270"></a><span>          </span><a href="#local-6989586621685141731"><span class="hs-identifier hs-var">dflags1</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">includePaths</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addQuoteInclude</span><span> </span><a href="#local-6989586621685141734"><span class="hs-identifier hs-var">old_paths</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621685141733"><span class="hs-identifier hs-var">current_dir</span></a><span class="hs-special">]</span><span>
</span><a name="line-271"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">log_action</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">log_action</span><span> </span><a href="#local-6989586621685141735"><span class="hs-identifier hs-var">prevailing_dflags</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-272"></a><span>                  </span><span class="hs-comment">-- use the prevailing log_action / log_finaliser,</span><span>
</span><a name="line-273"></a><span>                  </span><span class="hs-comment">-- not the one cached in the summary.  This is so</span><span>
</span><a name="line-274"></a><span>                  </span><span class="hs-comment">-- that we can change the log_action without having</span><span>
</span><a name="line-275"></a><span>                  </span><span class="hs-comment">-- to re-summarize all the source files.</span><span>
</span><a name="line-276"></a><span>       </span><a name="local-6989586621685141737"><a href="#local-6989586621685141737"><span class="hs-identifier">hsc_env</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141710"><span class="hs-identifier hs-var">hsc_env0</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">hsc_dflags</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141736"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">}</span><span>
</span><a name="line-277"></a><span>
</span><a name="line-278"></a><span>       </span><span class="hs-comment">-- Figure out what lang we're generating</span><span>
</span><a name="line-279"></a><span>       </span><a name="local-6989586621685141738"><a href="#local-6989586621685141738"><span class="hs-identifier">hsc_lang</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hscTarget</span><span> </span><a href="#local-6989586621685141736"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-280"></a><span>
</span><a name="line-281"></a><span>       </span><span class="hs-comment">-- -fforce-recomp should also work with --make</span><span>
</span><a name="line-282"></a><span>       </span><a name="local-6989586621685141739"><a href="#local-6989586621685141739"><span class="hs-identifier">force_recomp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_ForceRecomp</span><span> </span><a href="#local-6989586621685141736"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-283"></a><span>       </span><a name="local-6989586621685141740"><a href="#local-6989586621685141740"><span class="hs-identifier">source_modified</span></a></a><span>
</span><a name="line-284"></a><span>         </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685141739"><span class="hs-identifier hs-var">force_recomp</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">SourceModified</span><span>
</span><a name="line-285"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141716"><span class="hs-identifier hs-var">source_modified0</span></a><span>
</span><a name="line-286"></a><span>
</span><a name="line-287"></a><span>       </span><a name="local-6989586621685141741"><a href="#local-6989586621685141741"><span class="hs-identifier">always_do_basic_recompilation_check</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685141738"><span class="hs-identifier hs-var">hsc_lang</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-288"></a><span>                                             </span><span class="hs-identifier hs-var">HscInterpreted</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-289"></a><span>                                             </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-290"></a><span>
</span><a name="line-291"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-292"></a><span class="hs-comment">-- stub .h and .c files (for foreign export support), and cc files.</span><span>
</span><a name="line-293"></a><span>
</span><a name="line-294"></a><span class="hs-comment">-- The _stub.c file is derived from the haskell source file, possibly taking</span><span>
</span><a name="line-295"></a><span class="hs-comment">-- into account the -stubdir option.</span><span>
</span><a name="line-296"></a><span class="hs-comment">--</span><span>
</span><a name="line-297"></a><span class="hs-comment">-- The object file created by compiling the _stub.c file is put into a</span><span>
</span><a name="line-298"></a><span class="hs-comment">-- temporary file, which will be later combined with the main .o file</span><span>
</span><a name="line-299"></a><span class="hs-comment">-- (see the MergeForeigns phase).</span><span>
</span><a name="line-300"></a><span class="hs-comment">--</span><span>
</span><a name="line-301"></a><span class="hs-comment">-- Moreover, we also let the user emit arbitrary C/C++/ObjC/ObjC++ files</span><span>
</span><a name="line-302"></a><span class="hs-comment">-- from TH, that are then compiled and linked to the module. This is</span><span>
</span><a name="line-303"></a><span class="hs-comment">-- useful to implement facilities such as inline-c.</span><span>
</span><a name="line-304"></a><span>
</span><a name="line-305"></a><span class="hs-identifier">compileForeign</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignSrcLang</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-306"></a><a name="compileForeign"><a href="DriverPipeline.html#compileForeign"><span class="hs-identifier">compileForeign</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">RawObject</span><span> </span><a name="local-6989586621685141766"><a href="#local-6989586621685141766"><span class="hs-identifier">object_file</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685141766"><span class="hs-identifier hs-var">object_file</span></a><span>
</span><a name="line-307"></a><span class="hs-identifier">compileForeign</span><span> </span><a name="local-6989586621685141767"><a href="#local-6989586621685141767"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621685141768"><a href="#local-6989586621685141768"><span class="hs-identifier">lang</span></a></a><span> </span><a name="local-6989586621685141769"><a href="#local-6989586621685141769"><span class="hs-identifier">stub_c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-308"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685141770"><a href="#local-6989586621685141770"><span class="hs-identifier">phase</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685141768"><span class="hs-identifier hs-var">lang</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-309"></a><span>              </span><span class="hs-identifier hs-var">LangC</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Cc</span><span>
</span><a name="line-310"></a><span>              </span><span class="hs-identifier hs-var">LangCxx</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Ccxx</span><span>
</span><a name="line-311"></a><span>              </span><span class="hs-identifier hs-var">LangObjc</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Cobjc</span><span>
</span><a name="line-312"></a><span>              </span><span class="hs-identifier hs-var">LangObjcxx</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Cobjcxx</span><span>
</span><a name="line-313"></a><span>              </span><span class="hs-identifier hs-var">LangAsm</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">As</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-comment">-- allow CPP</span><span>
</span><a name="line-314"></a><span>              </span><span class="hs-identifier hs-var">RawObject</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;compileForeign: should be unreachable&quot;</span><span>
</span><a name="line-315"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621685141771"><a href="#local-6989586621685141771"><span class="hs-identifier">stub_o</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#runPipeline"><span class="hs-identifier hs-var">runPipeline</span></a><span> </span><span class="hs-identifier hs-var">StopLn</span><span> </span><a href="#local-6989586621685141767"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-316"></a><span>                       </span><span class="hs-special">(</span><a href="#local-6989586621685141769"><span class="hs-identifier hs-var">stub_c</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><a href="#local-6989586621685141770"><span class="hs-identifier hs-var">phase</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-317"></a><span>                       </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Temporary</span><span> </span><span class="hs-identifier hs-var">TFL_GhcSession</span><span class="hs-special">)</span><span>
</span><a name="line-318"></a><span>                       </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-comment">{-no ModLocation-}</span><span>
</span><a name="line-319"></a><span>                       </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-320"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685141771"><span class="hs-identifier hs-var">stub_o</span></a><span>
</span><a name="line-321"></a><span>
</span><a name="line-322"></a><span class="hs-identifier">compileStub</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-323"></a><a name="compileStub"><a href="DriverPipeline.html#compileStub"><span class="hs-identifier">compileStub</span></a></a><span> </span><a name="local-6989586621685141772"><a href="#local-6989586621685141772"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621685141773"><a href="#local-6989586621685141773"><span class="hs-identifier">stub_c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DriverPipeline.html#compileForeign"><span class="hs-identifier hs-var">compileForeign</span></a><span> </span><a href="#local-6989586621685141772"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-identifier hs-var">LangC</span><span> </span><a href="#local-6989586621685141773"><span class="hs-identifier hs-var">stub_c</span></a><span>
</span><a name="line-324"></a><span>
</span><a name="line-325"></a><span class="hs-identifier">compileEmptyStub</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModLocation</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-326"></a><a name="compileEmptyStub"><a href="DriverPipeline.html#compileEmptyStub"><span class="hs-identifier">compileEmptyStub</span></a></a><span> </span><a name="local-6989586621685141774"><a href="#local-6989586621685141774"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685141775"><a href="#local-6989586621685141775"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621685141776"><a href="#local-6989586621685141776"><span class="hs-identifier">basename</span></a></a><span> </span><a name="local-6989586621685141777"><a href="#local-6989586621685141777"><span class="hs-identifier">location</span></a></a><span> </span><a name="local-6989586621685141778"><a href="#local-6989586621685141778"><span class="hs-identifier">mod_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-327"></a><span>  </span><span class="hs-comment">-- To maintain the invariant that every Haskell file</span><span>
</span><a name="line-328"></a><span>  </span><span class="hs-comment">-- compiles to object code, we make an empty (but</span><span>
</span><a name="line-329"></a><span>  </span><span class="hs-comment">-- valid) stub object file for signatures.  However,</span><span>
</span><a name="line-330"></a><span>  </span><span class="hs-comment">-- we make sure this object file has a unique symbol,</span><span>
</span><a name="line-331"></a><span>  </span><span class="hs-comment">-- so that ranlib on OS X doesn't complain, see</span><span>
</span><a name="line-332"></a><span>  </span><span class="hs-comment">-- http://ghc.haskell.org/trac/ghc/ticket/12673</span><span>
</span><a name="line-333"></a><span>  </span><span class="hs-comment">-- and https://github.com/haskell/cabal/issues/2257</span><span>
</span><a name="line-334"></a><span>  </span><a name="local-6989586621685141779"><a href="#local-6989586621685141779"><span class="hs-identifier">empty_stub</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newTempName</span><span> </span><a href="#local-6989586621685141774"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">TFL_CurrentModule</span><span> </span><span class="hs-string">&quot;c&quot;</span><span>
</span><a name="line-335"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685141780"><a href="#local-6989586621685141780"><span class="hs-identifier">src</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;int&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkModule</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">thisPackage</span><span> </span><a href="#local-6989586621685141774"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685141778"><span class="hs-identifier hs-var">mod_name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;= 0;&quot;</span><span>
</span><a name="line-336"></a><span>  </span><span class="hs-identifier hs-var">writeFile</span><span> </span><a href="#local-6989586621685141779"><span class="hs-identifier hs-var">empty_stub</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">showSDoc</span><span> </span><a href="#local-6989586621685141774"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprCode</span><span> </span><span class="hs-identifier hs-var">CStyle</span><span> </span><a href="#local-6989586621685141780"><span class="hs-identifier hs-var">src</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-337"></a><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#runPipeline"><span class="hs-identifier hs-var">runPipeline</span></a><span> </span><span class="hs-identifier hs-var">StopLn</span><span> </span><a href="#local-6989586621685141775"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-338"></a><span>                  </span><span class="hs-special">(</span><a href="#local-6989586621685141779"><span class="hs-identifier hs-var">empty_stub</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-339"></a><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685141776"><span class="hs-identifier hs-var">basename</span></a><span class="hs-special">)</span><span>
</span><a name="line-340"></a><span>                  </span><span class="hs-identifier hs-var">Persistent</span><span>
</span><a name="line-341"></a><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685141777"><span class="hs-identifier hs-var">location</span></a><span class="hs-special">)</span><span>
</span><a name="line-342"></a><span>                  </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-343"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-344"></a><span>
</span><a name="line-345"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-346"></a><span class="hs-comment">-- Link</span><span>
</span><a name="line-347"></a><span>
</span><a name="line-348"></a><span class="hs-identifier">link</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcLink</span><span>                 </span><span class="hs-comment">-- interactive or batch</span><span>
</span><a name="line-349"></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>                </span><span class="hs-comment">-- dynamic flags</span><span>
</span><a name="line-350"></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>                    </span><span class="hs-comment">-- attempt linking in batch mode?</span><span>
</span><a name="line-351"></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HomePackageTable</span><span>        </span><span class="hs-comment">-- what to link</span><span>
</span><a name="line-352"></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">SuccessFlag</span><span>
</span><a name="line-353"></a><span>
</span><a name="line-354"></a><span class="hs-comment">-- For the moment, in the batch linker, we don't bother to tell doLink</span><span>
</span><a name="line-355"></a><span class="hs-comment">-- which packages to link -- it just tries all that are available.</span><span>
</span><a name="line-356"></a><span class="hs-comment">-- batch_attempt_linking should only be *looked at* in batch mode.  It</span><span>
</span><a name="line-357"></a><span class="hs-comment">-- should only be True if the upsweep was successful and someone</span><span>
</span><a name="line-358"></a><span class="hs-comment">-- exports main, i.e., we have good reason to believe that linking</span><span>
</span><a name="line-359"></a><span class="hs-comment">-- will succeed.</span><span>
</span><a name="line-360"></a><span>
</span><a name="line-361"></a><a name="link"><a href="DriverPipeline.html#link"><span class="hs-identifier">link</span></a></a><span> </span><a name="local-6989586621685141781"><a href="#local-6989586621685141781"><span class="hs-identifier">ghcLink</span></a></a><span> </span><a name="local-6989586621685141782"><a href="#local-6989586621685141782"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-362"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupHook</span><span> </span><span class="hs-identifier">linkHook</span><span> </span><a href="#local-6989586621685141783"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621685141782"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685141781"><span class="hs-identifier hs-var">ghcLink</span></a><span> </span><a href="#local-6989586621685141782"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-363"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-364"></a><span>    </span><a name="local-6989586621685141783"><a href="#local-6989586621685141783"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-identifier hs-var">LinkInMemory</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-365"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">cGhcWithInterpreter</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-string">&quot;YES&quot;</span><span>
</span><a name="line-366"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-comment">-- Not Linking...(demand linker will do the job)</span><span>
</span><a name="line-367"></a><span>             </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Succeeded</span><span>
</span><a name="line-368"></a><span>        </span><span class="hs-keyword">else</span><span> </span><a href="DriverPipeline.html#panicBadLink"><span class="hs-identifier hs-var">panicBadLink</span></a><span> </span><span class="hs-identifier hs-var">LinkInMemory</span><span>
</span><a name="line-369"></a><span>
</span><a name="line-370"></a><span>    </span><span class="hs-identifier">l</span><span> </span><span class="hs-identifier hs-var">NoLink</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-371"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Succeeded</span><span>
</span><a name="line-372"></a><span>
</span><a name="line-373"></a><span>    </span><span class="hs-identifier">l</span><span> </span><span class="hs-identifier hs-var">LinkBinary</span><span> </span><a name="local-6989586621685141784"><a href="#local-6989586621685141784"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685141785"><a href="#local-6989586621685141785"><span class="hs-identifier">batch_attempt_linking</span></a></a><span> </span><a name="local-6989586621685141786"><a href="#local-6989586621685141786"><span class="hs-identifier">hpt</span></a></a><span>
</span><a name="line-374"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="DriverPipeline.html#link%27"><span class="hs-identifier hs-var">link'</span></a><span> </span><a href="#local-6989586621685141784"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685141785"><span class="hs-identifier hs-var">batch_attempt_linking</span></a><span> </span><a href="#local-6989586621685141786"><span class="hs-identifier hs-var">hpt</span></a><span>
</span><a name="line-375"></a><span>
</span><a name="line-376"></a><span>    </span><span class="hs-identifier">l</span><span> </span><span class="hs-identifier hs-var">LinkStaticLib</span><span> </span><a name="local-6989586621685141787"><a href="#local-6989586621685141787"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685141788"><a href="#local-6989586621685141788"><span class="hs-identifier">batch_attempt_linking</span></a></a><span> </span><a name="local-6989586621685141789"><a href="#local-6989586621685141789"><span class="hs-identifier">hpt</span></a></a><span>
</span><a name="line-377"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="DriverPipeline.html#link%27"><span class="hs-identifier hs-var">link'</span></a><span> </span><a href="#local-6989586621685141787"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685141788"><span class="hs-identifier hs-var">batch_attempt_linking</span></a><span> </span><a href="#local-6989586621685141789"><span class="hs-identifier hs-var">hpt</span></a><span>
</span><a name="line-378"></a><span>
</span><a name="line-379"></a><span>    </span><span class="hs-identifier">l</span><span> </span><span class="hs-identifier hs-var">LinkDynLib</span><span> </span><a name="local-6989586621685141790"><a href="#local-6989586621685141790"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685141791"><a href="#local-6989586621685141791"><span class="hs-identifier">batch_attempt_linking</span></a></a><span> </span><a name="local-6989586621685141792"><a href="#local-6989586621685141792"><span class="hs-identifier">hpt</span></a></a><span>
</span><a name="line-380"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="DriverPipeline.html#link%27"><span class="hs-identifier hs-var">link'</span></a><span> </span><a href="#local-6989586621685141790"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685141791"><span class="hs-identifier hs-var">batch_attempt_linking</span></a><span> </span><a href="#local-6989586621685141792"><span class="hs-identifier hs-var">hpt</span></a><span>
</span><a name="line-381"></a><span>
</span><a name="line-382"></a><span class="hs-identifier">panicBadLink</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhcLink</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685141704"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-383"></a><a name="panicBadLink"><a href="DriverPipeline.html#panicBadLink"><span class="hs-identifier">panicBadLink</span></a></a><span> </span><a name="local-6989586621685141793"><a href="#local-6989586621685141793"><span class="hs-identifier">other</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;link: GHC not built to link this way: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-384"></a><span>                            </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621685141793"><span class="hs-identifier hs-var">other</span></a><span class="hs-special">)</span><span>
</span><a name="line-385"></a><span>
</span><a name="line-386"></a><span class="hs-identifier">link'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>                </span><span class="hs-comment">-- dynamic flags</span><span>
</span><a name="line-387"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>                    </span><span class="hs-comment">-- attempt linking in batch mode?</span><span>
</span><a name="line-388"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HomePackageTable</span><span>        </span><span class="hs-comment">-- what to link</span><span>
</span><a name="line-389"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">SuccessFlag</span><span>
</span><a name="line-390"></a><span>
</span><a name="line-391"></a><a name="link%27"><a href="DriverPipeline.html#link%27"><span class="hs-identifier">link'</span></a></a><span> </span><a name="local-6989586621685141794"><a href="#local-6989586621685141794"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685141795"><a href="#local-6989586621685141795"><span class="hs-identifier">batch_attempt_linking</span></a></a><span> </span><a name="local-6989586621685141796"><a href="#local-6989586621685141796"><span class="hs-identifier">hpt</span></a></a><span>
</span><a name="line-392"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685141795"><span class="hs-identifier hs-var">batch_attempt_linking</span></a><span>
</span><a name="line-393"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-394"></a><span>        </span><span class="hs-keyword">let</span><span>
</span><a name="line-395"></a><span>            </span><a name="local-6989586621685141797"><a href="#local-6989586621685141797"><span class="hs-identifier">staticLink</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">ghcLink</span><span> </span><a href="#local-6989586621685141794"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-396"></a><span>                          </span><span class="hs-identifier hs-var">LinkStaticLib</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-397"></a><span>                          </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-398"></a><span>
</span><a name="line-399"></a><span>            </span><a name="local-6989586621685141798"><a href="#local-6989586621685141798"><span class="hs-identifier">home_mod_infos</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">eltsHpt</span><span> </span><a href="#local-6989586621685141796"><span class="hs-identifier hs-var">hpt</span></a><span>
</span><a name="line-400"></a><span>
</span><a name="line-401"></a><span>            </span><span class="hs-comment">-- the packages we depend on</span><span>
</span><a name="line-402"></a><span>            </span><a name="local-6989586621685141799"><a href="#local-6989586621685141799"><span class="hs-identifier">pkg_deps</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">dep_pkgs</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">mi_deps</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">hm_iface</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685141798"><span class="hs-identifier hs-var">home_mod_infos</span></a><span>
</span><a name="line-403"></a><span>
</span><a name="line-404"></a><span>            </span><span class="hs-comment">-- the linkables to link</span><span>
</span><a name="line-405"></a><span>            </span><a name="local-6989586621685141800"><a href="#local-6989586621685141800"><span class="hs-identifier">linkables</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">expectJust</span><span> </span><span class="hs-string">&quot;link&quot;</span><span class="hs-operator hs-var">.</span><span class="hs-identifier">hm_linkable</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685141798"><span class="hs-identifier hs-var">home_mod_infos</span></a><span>
</span><a name="line-406"></a><span>
</span><a name="line-407"></a><span>        </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><a href="#local-6989586621685141794"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">3</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;link: linkables are ...&quot;</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685141800"><span class="hs-identifier hs-var">linkables</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-408"></a><span>
</span><a name="line-409"></a><span>        </span><span class="hs-comment">-- check for the -no-link flag</span><span>
</span><a name="line-410"></a><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isNoLink</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ghcLink</span><span> </span><a href="#local-6989586621685141794"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-411"></a><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><a href="#local-6989586621685141794"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">3</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;link(batch): linking omitted (-c flag given).&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-412"></a><span>                  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Succeeded</span><span>
</span><a name="line-413"></a><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-414"></a><span>
</span><a name="line-415"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685141801"><a href="#local-6989586621685141801"><span class="hs-identifier">getOfiles</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LM</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621685141804"><a href="#local-6989586621685141804"><span class="hs-identifier">us</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">nameOfObject</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-identifier hs-var">isObject</span><span> </span><a href="#local-6989586621685141804"><span class="hs-identifier hs-var">us</span></a><span class="hs-special">)</span><span>
</span><a name="line-416"></a><span>            </span><a name="local-6989586621685141802"><a href="#local-6989586621685141802"><span class="hs-identifier">obj_files</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="#local-6989586621685141801"><span class="hs-identifier hs-var">getOfiles</span></a><span> </span><a href="#local-6989586621685141800"><span class="hs-identifier hs-var">linkables</span></a><span>
</span><a name="line-417"></a><span>
</span><a name="line-418"></a><span>            </span><a name="local-6989586621685141803"><a href="#local-6989586621685141803"><span class="hs-identifier">exe_file</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DriverPipeline.html#exeFileName"><span class="hs-identifier hs-var">exeFileName</span></a><span> </span><a href="#local-6989586621685141797"><span class="hs-identifier hs-var">staticLink</span></a><span> </span><a href="#local-6989586621685141794"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-419"></a><span>
</span><a name="line-420"></a><span>        </span><a name="local-6989586621685141805"><a href="#local-6989586621685141805"><span class="hs-identifier">linking_needed</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#linkingNeeded"><span class="hs-identifier hs-var">linkingNeeded</span></a><span> </span><a href="#local-6989586621685141794"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685141797"><span class="hs-identifier hs-var">staticLink</span></a><span> </span><a href="#local-6989586621685141800"><span class="hs-identifier hs-var">linkables</span></a><span> </span><a href="#local-6989586621685141799"><span class="hs-identifier hs-var">pkg_deps</span></a><span>
</span><a name="line-421"></a><span>
</span><a name="line-422"></a><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_ForceRecomp</span><span> </span><a href="#local-6989586621685141794"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621685141805"><span class="hs-identifier hs-var">linking_needed</span></a><span>
</span><a name="line-423"></a><span>           </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><a href="#local-6989586621685141794"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621685141803"><span class="hs-identifier hs-var">exe_file</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is up to date, linking not required.&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-424"></a><span>                   </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Succeeded</span><span>
</span><a name="line-425"></a><span>           </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-426"></a><span>
</span><a name="line-427"></a><span>        </span><span class="hs-identifier hs-var">compilationProgressMsg</span><span> </span><a href="#local-6989586621685141794"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Linking &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685141803"><span class="hs-identifier hs-var">exe_file</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; ...&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-428"></a><span>
</span><a name="line-429"></a><span>        </span><span class="hs-comment">-- Don't showPass in Batch mode; doLink will do that for us.</span><span>
</span><a name="line-430"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685141806"><a href="#local-6989586621685141806"><span class="hs-identifier">link</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">ghcLink</span><span> </span><a href="#local-6989586621685141794"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-431"></a><span>                </span><span class="hs-identifier hs-var">LinkBinary</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DriverPipeline.html#linkBinary"><span class="hs-identifier hs-var">linkBinary</span></a><span>
</span><a name="line-432"></a><span>                </span><span class="hs-identifier hs-var">LinkStaticLib</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DriverPipeline.html#linkStaticLib"><span class="hs-identifier hs-var">linkStaticLib</span></a><span>
</span><a name="line-433"></a><span>                </span><span class="hs-identifier hs-var">LinkDynLib</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DriverPipeline.html#linkDynLibCheck"><span class="hs-identifier hs-var">linkDynLibCheck</span></a><span>
</span><a name="line-434"></a><span>                </span><a name="local-6989586621685141807"><a href="#local-6989586621685141807"><span class="hs-identifier">other</span></a></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DriverPipeline.html#panicBadLink"><span class="hs-identifier hs-var">panicBadLink</span></a><span> </span><a href="#local-6989586621685141807"><span class="hs-identifier hs-var">other</span></a><span>
</span><a name="line-435"></a><span>        </span><a href="#local-6989586621685141806"><span class="hs-identifier hs-var">link</span></a><span> </span><a href="#local-6989586621685141794"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685141802"><span class="hs-identifier hs-var">obj_files</span></a><span> </span><a href="#local-6989586621685141799"><span class="hs-identifier hs-var">pkg_deps</span></a><span>
</span><a name="line-436"></a><span>
</span><a name="line-437"></a><span>        </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><a href="#local-6989586621685141794"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">3</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;link: done&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-438"></a><span>
</span><a name="line-439"></a><span>        </span><span class="hs-comment">-- linkBinary only returns if it succeeds</span><span>
</span><a name="line-440"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Succeeded</span><span>
</span><a name="line-441"></a><span>
</span><a name="line-442"></a><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-443"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><a href="#local-6989586621685141794"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">3</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;link(batch): upsweep (partially) failed OR&quot;</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-444"></a><span>                                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;   Main.main not exported; not linking.&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-445"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Succeeded</span><span>
</span><a name="line-446"></a><span>
</span><a name="line-447"></a><span>
</span><a name="line-448"></a><span class="hs-identifier">linkingNeeded</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Linkable</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">InstalledUnitId</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-449"></a><a name="linkingNeeded"><a href="DriverPipeline.html#linkingNeeded"><span class="hs-identifier">linkingNeeded</span></a></a><span> </span><a name="local-6989586621685141808"><a href="#local-6989586621685141808"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685141809"><a href="#local-6989586621685141809"><span class="hs-identifier">staticLink</span></a></a><span> </span><a name="local-6989586621685141810"><a href="#local-6989586621685141810"><span class="hs-identifier">linkables</span></a></a><span> </span><a name="local-6989586621685141811"><a href="#local-6989586621685141811"><span class="hs-identifier">pkg_deps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-450"></a><span>        </span><span class="hs-comment">-- if the modification time on the executable is later than the</span><span>
</span><a name="line-451"></a><span>        </span><span class="hs-comment">-- modification times on all of the objects and libraries, then omit</span><span>
</span><a name="line-452"></a><span>        </span><span class="hs-comment">-- linking (unless the -fforce-recomp flag was given).</span><span>
</span><a name="line-453"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685141812"><a href="#local-6989586621685141812"><span class="hs-identifier">exe_file</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DriverPipeline.html#exeFileName"><span class="hs-identifier hs-var">exeFileName</span></a><span> </span><a href="#local-6989586621685141809"><span class="hs-identifier hs-var">staticLink</span></a><span> </span><a href="#local-6989586621685141808"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-454"></a><span>  </span><a name="local-6989586621685141813"><a href="#local-6989586621685141813"><span class="hs-identifier">e_exe_time</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tryIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">getModificationUTCTime</span><span> </span><a href="#local-6989586621685141812"><span class="hs-identifier hs-var">exe_file</span></a><span>
</span><a name="line-455"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685141813"><span class="hs-identifier hs-var">e_exe_time</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-456"></a><span>    </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-457"></a><span>    </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621685141814"><a href="#local-6989586621685141814"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-458"></a><span>        </span><span class="hs-comment">-- first check object files and extra_ld_inputs</span><span>
</span><a name="line-459"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685141815"><a href="#local-6989586621685141815"><span class="hs-identifier">extra_ld_inputs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621685141816"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">FileOption</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621685141816"><a href="#local-6989586621685141816"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">ldInputs</span><span> </span><a href="#local-6989586621685141808"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-460"></a><span>        </span><a name="local-6989586621685141817"><a href="#local-6989586621685141817"><span class="hs-identifier">e_extra_times</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tryIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">getModificationUTCTime</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685141815"><span class="hs-identifier hs-var">extra_ld_inputs</span></a><span>
</span><a name="line-461"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685141818"><a href="#local-6989586621685141818"><span class="hs-identifier">errs</span></a></a><span class="hs-special">,</span><a name="local-6989586621685141819"><a href="#local-6989586621685141819"><span class="hs-identifier">extra_times</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partitionEithers</span><span> </span><a href="#local-6989586621685141817"><span class="hs-identifier hs-var">e_extra_times</span></a><span>
</span><a name="line-462"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685141820"><a href="#local-6989586621685141820"><span class="hs-identifier">obj_times</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">linkableTime</span><span> </span><a href="#local-6989586621685141810"><span class="hs-identifier hs-var">linkables</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685141819"><span class="hs-identifier hs-var">extra_times</span></a><span>
</span><a name="line-463"></a><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621685141818"><span class="hs-identifier hs-var">errs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685141814"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685141820"><span class="hs-identifier hs-var">obj_times</span></a><span>
</span><a name="line-464"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-465"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-466"></a><span>
</span><a name="line-467"></a><span>        </span><span class="hs-comment">-- next, check libraries. XXX this only checks Haskell libraries,</span><span>
</span><a name="line-468"></a><span>        </span><span class="hs-comment">-- not extra_libraries or -l things from the command line.</span><span>
</span><a name="line-469"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685141821"><a href="#local-6989586621685141821"><span class="hs-identifier">pkg_hslibs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">collectLibraryPaths</span><span> </span><a href="#local-6989586621685141808"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621685141822"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685141823"><span class="hs-identifier hs-var">lib</span></a><span class="hs-special">)</span><span>
</span><a name="line-470"></a><span>                          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685141822"><a href="#local-6989586621685141822"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lookupInstalledPackage</span><span> </span><a href="#local-6989586621685141808"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685141811"><span class="hs-identifier hs-var">pkg_deps</span></a><span class="hs-special">,</span><span>
</span><a name="line-471"></a><span>                            </span><a name="local-6989586621685141823"><a href="#local-6989586621685141823"><span class="hs-identifier">lib</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">packageHsLibs</span><span> </span><a href="#local-6989586621685141808"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685141822"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-472"></a><span>
</span><a name="line-473"></a><span>        </span><a name="local-6989586621685141824"><a href="#local-6989586621685141824"><span class="hs-identifier">pkg_libfiles</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uncurry</span><span> </span><span class="hs-special">(</span><a href="DriverPipeline.html#findHSLib"><span class="hs-identifier hs-var">findHSLib</span></a><span> </span><a href="#local-6989586621685141808"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685141821"><span class="hs-identifier hs-var">pkg_hslibs</span></a><span>
</span><a name="line-474"></a><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-identifier hs-var">isNothing</span><span> </span><a href="#local-6989586621685141824"><span class="hs-identifier hs-var">pkg_libfiles</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-475"></a><span>        </span><a name="local-6989586621685141825"><a href="#local-6989586621685141825"><span class="hs-identifier">e_lib_times</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tryIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">getModificationUTCTime</span><span class="hs-special">)</span><span>
</span><a name="line-476"></a><span>                          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">catMaybes</span><span> </span><a href="#local-6989586621685141824"><span class="hs-identifier hs-var">pkg_libfiles</span></a><span class="hs-special">)</span><span>
</span><a name="line-477"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685141826"><a href="#local-6989586621685141826"><span class="hs-identifier">lib_errs</span></a></a><span class="hs-special">,</span><a name="local-6989586621685141827"><a href="#local-6989586621685141827"><span class="hs-identifier">lib_times</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partitionEithers</span><span> </span><a href="#local-6989586621685141825"><span class="hs-identifier hs-var">e_lib_times</span></a><span>
</span><a name="line-478"></a><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621685141826"><span class="hs-identifier hs-var">lib_errs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685141814"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685141827"><span class="hs-identifier hs-var">lib_times</span></a><span>
</span><a name="line-479"></a><span>           </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-480"></a><span>           </span><span class="hs-keyword">else</span><span> </span><a href="SysTools.ExtraObj.html#checkLinkInfo"><span class="hs-identifier hs-var">checkLinkInfo</span></a><span> </span><a href="#local-6989586621685141808"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685141811"><span class="hs-identifier hs-var">pkg_deps</span></a><span> </span><a href="#local-6989586621685141812"><span class="hs-identifier hs-var">exe_file</span></a><span>
</span><a name="line-481"></a><span>
</span><a name="line-482"></a><span class="hs-identifier">findHSLib</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">)</span><span>
</span><a name="line-483"></a><a name="findHSLib"><a href="DriverPipeline.html#findHSLib"><span class="hs-identifier">findHSLib</span></a></a><span> </span><a name="local-6989586621685141828"><a href="#local-6989586621685141828"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685141829"><a href="#local-6989586621685141829"><span class="hs-identifier">dirs</span></a></a><span> </span><a name="local-6989586621685141830"><a href="#local-6989586621685141830"><span class="hs-identifier">lib</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-484"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685141831"><a href="#local-6989586621685141831"><span class="hs-identifier">batch_lib_file</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">WayDyn</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">notElem</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">ways</span><span> </span><a href="#local-6989586621685141828"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-485"></a><span>                      </span><span class="hs-keyword">then</span><span> </span><span class="hs-string">&quot;lib&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685141830"><span class="hs-identifier hs-var">lib</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><span class="hs-string">&quot;a&quot;</span><span>
</span><a name="line-486"></a><span>                      </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">mkSOName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621685141828"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685141830"><span class="hs-identifier hs-var">lib</span></a><span>
</span><a name="line-487"></a><span>  </span><a name="local-6989586621685141832"><a href="#local-6989586621685141832"><span class="hs-identifier">found</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">filterM</span><span> </span><span class="hs-identifier hs-var">doesFileExist</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><a href="#local-6989586621685141831"><span class="hs-identifier hs-var">batch_lib_file</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685141829"><span class="hs-identifier hs-var">dirs</span></a><span class="hs-special">)</span><span>
</span><a name="line-488"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685141832"><span class="hs-identifier hs-var">found</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-489"></a><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-490"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621685141833"><a href="#local-6989586621685141833"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685141833"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-491"></a><span>
</span><a name="line-492"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-493"></a><span class="hs-comment">-- Compile files in one-shot mode.</span><span>
</span><a name="line-494"></a><span>
</span><a name="line-495"></a><span class="hs-identifier">oneShot</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Phase</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Phase</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-496"></a><a name="oneShot"><a href="DriverPipeline.html#oneShot"><span class="hs-identifier">oneShot</span></a></a><span> </span><a name="local-6989586621685141834"><a href="#local-6989586621685141834"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621685141835"><a href="#local-6989586621685141835"><span class="hs-identifier">stop_phase</span></a></a><span> </span><a name="local-6989586621685141836"><a href="#local-6989586621685141836"><span class="hs-identifier">srcs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-497"></a><span>  </span><a name="local-6989586621685141837"><a href="#local-6989586621685141837"><span class="hs-identifier">o_files</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="DriverPipeline.html#compileFile"><span class="hs-identifier hs-var">compileFile</span></a><span> </span><a href="#local-6989586621685141834"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685141835"><span class="hs-identifier hs-var">stop_phase</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685141836"><span class="hs-identifier hs-var">srcs</span></a><span>
</span><a name="line-498"></a><span>  </span><a href="DriverPipeline.html#doLink"><span class="hs-identifier hs-var">doLink</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685141834"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685141835"><span class="hs-identifier hs-var">stop_phase</span></a><span> </span><a href="#local-6989586621685141837"><span class="hs-identifier hs-var">o_files</span></a><span>
</span><a name="line-499"></a><span>
</span><a name="line-500"></a><span class="hs-identifier">compileFile</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Phase</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Phase</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-501"></a><a name="compileFile"><a href="DriverPipeline.html#compileFile"><span class="hs-identifier">compileFile</span></a></a><span> </span><a name="local-6989586621685141838"><a href="#local-6989586621685141838"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621685141839"><a href="#local-6989586621685141839"><span class="hs-identifier">stop_phase</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621685141840"><a href="#local-6989586621685141840"><span class="hs-identifier">src</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685141841"><a href="#local-6989586621685141841"><span class="hs-identifier">mb_phase</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-502"></a><span>   </span><a name="local-6989586621685141842"><a href="#local-6989586621685141842"><span class="hs-identifier">exists</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">doesFileExist</span><span> </span><a href="#local-6989586621685141840"><span class="hs-identifier hs-var">src</span></a><span>
</span><a name="line-503"></a><span>   </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621685141842"><span class="hs-identifier hs-var">exists</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-504"></a><span>        </span><span class="hs-identifier hs-var">throwGhcExceptionIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CmdLineError</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;does not exist: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685141840"><span class="hs-identifier hs-var">src</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-505"></a><span>
</span><a name="line-506"></a><span>   </span><span class="hs-keyword">let</span><span>
</span><a name="line-507"></a><span>        </span><a name="local-6989586621685141843"><a href="#local-6989586621685141843"><span class="hs-identifier">dflags</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685141838"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-508"></a><span>        </span><a name="local-6989586621685141844"><a href="#local-6989586621685141844"><span class="hs-identifier">split</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_SplitObjs</span><span> </span><a href="#local-6989586621685141843"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-509"></a><span>        </span><a name="local-6989586621685141845"><a href="#local-6989586621685141845"><span class="hs-identifier">mb_o_file</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">outputFile</span><span> </span><a href="#local-6989586621685141843"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-510"></a><span>        </span><a name="local-6989586621685141846"><a href="#local-6989586621685141846"><span class="hs-identifier">ghc_link</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ghcLink</span><span> </span><a href="#local-6989586621685141843"><span class="hs-identifier hs-var">dflags</span></a><span>      </span><span class="hs-comment">-- Set by -c or -no-link</span><span>
</span><a name="line-511"></a><span>
</span><a name="line-512"></a><span>        </span><span class="hs-comment">-- When linking, the -o argument refers to the linker's output.</span><span>
</span><a name="line-513"></a><span>        </span><span class="hs-comment">-- otherwise, we use it as the name for the pipeline's output.</span><span>
</span><a name="line-514"></a><span>        </span><a name="local-6989586621685141847"><a href="#local-6989586621685141847"><span class="hs-identifier">output</span></a></a><span>
</span><a name="line-515"></a><span>         </span><span class="hs-comment">-- If we are doing -fno-code, then act as if the output is</span><span>
</span><a name="line-516"></a><span>         </span><span class="hs-comment">-- 'Temporary'. This stops GHC trying to copy files to their</span><span>
</span><a name="line-517"></a><span>         </span><span class="hs-comment">-- final location.</span><span>
</span><a name="line-518"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">HscNothing</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">hscTarget</span><span> </span><a href="#local-6989586621685141843"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Temporary</span><span> </span><span class="hs-identifier hs-var">TFL_CurrentModule</span><span>
</span><a name="line-519"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">StopLn</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685141839"><span class="hs-identifier hs-var">stop_phase</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isNoLink</span><span> </span><a href="#local-6989586621685141846"><span class="hs-identifier hs-var">ghc_link</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Persistent</span><span>
</span><a name="line-520"></a><span>                </span><span class="hs-comment">-- -o foo applies to linker</span><span>
</span><a name="line-521"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><a href="#local-6989586621685141845"><span class="hs-identifier hs-var">mb_o_file</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">SpecificFile</span><span>
</span><a name="line-522"></a><span>                </span><span class="hs-comment">-- -o foo applies to the file we are compiling now</span><span>
</span><a name="line-523"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Persistent</span><span>
</span><a name="line-524"></a><span>
</span><a name="line-525"></a><span>        </span><a name="local-6989586621685141848"><a href="#local-6989586621685141848"><span class="hs-identifier">stop_phase'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685141839"><span class="hs-identifier hs-var">stop_phase</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-526"></a><span>                        </span><span class="hs-identifier hs-var">As</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685141844"><span class="hs-identifier hs-var">split</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">SplitAs</span><span>
</span><a name="line-527"></a><span>                        </span><span class="hs-identifier">_</span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685141839"><span class="hs-identifier hs-var">stop_phase</span></a><span>
</span><a name="line-528"></a><span>
</span><a name="line-529"></a><span>   </span><span class="hs-special">(</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621685141849"><a href="#local-6989586621685141849"><span class="hs-identifier">out_file</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#runPipeline"><span class="hs-identifier hs-var">runPipeline</span></a><span> </span><a href="#local-6989586621685141848"><span class="hs-identifier hs-var">stop_phase'</span></a><span> </span><a href="#local-6989586621685141838"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-530"></a><span>                            </span><span class="hs-special">(</span><a href="#local-6989586621685141840"><span class="hs-identifier hs-var">src</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">RealPhase</span><span> </span><a href="#local-6989586621685141841"><span class="hs-identifier hs-var">mb_phase</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621685141847"><span class="hs-identifier hs-var">output</span></a><span>
</span><a name="line-531"></a><span>                            </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-comment">{-no ModLocation-}</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-532"></a><span>   </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685141849"><span class="hs-identifier hs-var">out_file</span></a><span>
</span><a name="line-533"></a><span>
</span><a name="line-534"></a><span>
</span><a name="line-535"></a><span class="hs-identifier">doLink</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Phase</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-536"></a><a name="doLink"><a href="DriverPipeline.html#doLink"><span class="hs-identifier">doLink</span></a></a><span> </span><a name="local-6989586621685141850"><a href="#local-6989586621685141850"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685141851"><a href="#local-6989586621685141851"><span class="hs-identifier">stop_phase</span></a></a><span> </span><a name="local-6989586621685141852"><a href="#local-6989586621685141852"><span class="hs-identifier">o_files</span></a></a><span>
</span><a name="line-537"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isStopLn</span><span> </span><a href="#local-6989586621685141851"><span class="hs-identifier hs-var">stop_phase</span></a><span class="hs-special">)</span><span>
</span><a name="line-538"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>           </span><span class="hs-comment">-- We stopped before the linking phase</span><span>
</span><a name="line-539"></a><span>
</span><a name="line-540"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-541"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">ghcLink</span><span> </span><a href="#local-6989586621685141850"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-542"></a><span>        </span><span class="hs-identifier hs-var">NoLink</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-543"></a><span>        </span><span class="hs-identifier hs-var">LinkBinary</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DriverPipeline.html#linkBinary"><span class="hs-identifier hs-var">linkBinary</span></a><span>         </span><a href="#local-6989586621685141850"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685141852"><span class="hs-identifier hs-var">o_files</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-544"></a><span>        </span><span class="hs-identifier hs-var">LinkStaticLib</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DriverPipeline.html#linkStaticLib"><span class="hs-identifier hs-var">linkStaticLib</span></a><span>      </span><a href="#local-6989586621685141850"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685141852"><span class="hs-identifier hs-var">o_files</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-545"></a><span>        </span><span class="hs-identifier hs-var">LinkDynLib</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DriverPipeline.html#linkDynLibCheck"><span class="hs-identifier hs-var">linkDynLibCheck</span></a><span>    </span><a href="#local-6989586621685141850"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685141852"><span class="hs-identifier hs-var">o_files</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-546"></a><span>        </span><a name="local-6989586621685141853"><a href="#local-6989586621685141853"><span class="hs-identifier">other</span></a></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DriverPipeline.html#panicBadLink"><span class="hs-identifier hs-var">panicBadLink</span></a><span> </span><a href="#local-6989586621685141853"><span class="hs-identifier hs-var">other</span></a><span>
</span><a name="line-547"></a><span>
</span><a name="line-548"></a><span>
</span><a name="line-549"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-550"></a><span>
</span><a name="line-551"></a><span class="hs-comment">-- | Run a compilation pipeline, consisting of multiple phases.</span><span>
</span><a name="line-552"></a><span class="hs-comment">--</span><span>
</span><a name="line-553"></a><span class="hs-comment">-- This is the interface to the compilation pipeline, which runs</span><span>
</span><a name="line-554"></a><span class="hs-comment">-- a series of compilation steps on a single source file, specifying</span><span>
</span><a name="line-555"></a><span class="hs-comment">-- at which stage to stop.</span><span>
</span><a name="line-556"></a><span class="hs-comment">--</span><span>
</span><a name="line-557"></a><span class="hs-comment">-- The DynFlags can be modified by phases in the pipeline (eg. by</span><span>
</span><a name="line-558"></a><span class="hs-comment">-- OPTIONS_GHC pragmas), and the changes affect later phases in the</span><span>
</span><a name="line-559"></a><span class="hs-comment">-- pipeline.</span><span>
</span><a name="line-560"></a><span class="hs-identifier">runPipeline</span><span>
</span><a name="line-561"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Phase</span><span>                      </span><span class="hs-comment">-- ^ When to stop</span><span>
</span><a name="line-562"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>                     </span><span class="hs-comment">-- ^ Compilation environment</span><span>
</span><a name="line-563"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">PhasePlus</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ Input filename (and maybe -x suffix)</span><span>
</span><a name="line-564"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>             </span><span class="hs-comment">-- ^ original basename (if different from ^^^)</span><span>
</span><a name="line-565"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PipelineOutput</span><span>             </span><span class="hs-comment">-- ^ Output filename</span><span>
</span><a name="line-566"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">ModLocation</span><span>          </span><span class="hs-comment">-- ^ A ModLocation, if this is a Haskell module</span><span>
</span><a name="line-567"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">]</span><span>                 </span><span class="hs-comment">-- ^ foreign objects</span><span>
</span><a name="line-568"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DynFlags</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- ^ (final flags, output filename)</span><span>
</span><a name="line-569"></a><a name="runPipeline"><a href="DriverPipeline.html#runPipeline"><span class="hs-identifier">runPipeline</span></a></a><span> </span><a name="local-6989586621685141854"><a href="#local-6989586621685141854"><span class="hs-identifier">stop_phase</span></a></a><span> </span><a name="local-6989586621685141855"><a href="#local-6989586621685141855"><span class="hs-identifier">hsc_env0</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621685141856"><a href="#local-6989586621685141856"><span class="hs-identifier">input_fn</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685141857"><a href="#local-6989586621685141857"><span class="hs-identifier">mb_phase</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-570"></a><span>             </span><a name="local-6989586621685141858"><a href="#local-6989586621685141858"><span class="hs-identifier">mb_basename</span></a></a><span> </span><a name="local-6989586621685141859"><a href="#local-6989586621685141859"><span class="hs-identifier">output</span></a></a><span> </span><a name="local-6989586621685141860"><a href="#local-6989586621685141860"><span class="hs-identifier">maybe_loc</span></a></a><span> </span><a name="local-6989586621685141861"><a href="#local-6989586621685141861"><span class="hs-identifier">foreign_os</span></a></a><span>
</span><a name="line-571"></a><span>
</span><a name="line-572"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-573"></a><span>             </span><a name="local-6989586621685141862"><a href="#local-6989586621685141862"><span class="hs-identifier">dflags0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685141855"><span class="hs-identifier hs-var">hsc_env0</span></a><span>
</span><a name="line-574"></a><span>
</span><a name="line-575"></a><span>             </span><span class="hs-comment">-- Decide where dump files should go based on the pipeline output</span><span>
</span><a name="line-576"></a><span>             </span><a name="local-6989586621685141863"><a href="#local-6989586621685141863"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141862"><span class="hs-identifier hs-var">dflags0</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dumpPrefix</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685141868"><span class="hs-identifier hs-var">basename</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;.&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-577"></a><span>             </span><a name="local-6989586621685141864"><a href="#local-6989586621685141864"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141855"><span class="hs-identifier hs-var">hsc_env0</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">hsc_dflags</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141863"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">}</span><span>
</span><a name="line-578"></a><span>
</span><a name="line-579"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621685141865"><a href="#local-6989586621685141865"><span class="hs-identifier">input_basename</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685141866"><a href="#local-6989586621685141866"><span class="hs-identifier">suffix</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitExtension</span><span> </span><a href="#local-6989586621685141856"><span class="hs-identifier hs-var">input_fn</span></a><span>
</span><a name="line-580"></a><span>             </span><a name="local-6989586621685141867"><a href="#local-6989586621685141867"><span class="hs-identifier">suffix'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">drop</span><span> </span><span class="hs-number">1</span><span> </span><a href="#local-6989586621685141866"><span class="hs-identifier hs-var">suffix</span></a><span> </span><span class="hs-comment">-- strip off the .</span><span>
</span><a name="line-581"></a><span>             </span><a name="local-6989586621685141868"><a href="#local-6989586621685141868"><span class="hs-identifier">basename</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685141873"><a href="#local-6989586621685141873"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685141858"><span class="hs-identifier hs-var">mb_basename</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141873"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-582"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141865"><span class="hs-identifier hs-var">input_basename</span></a><span>
</span><a name="line-583"></a><span>
</span><a name="line-584"></a><span>             </span><span class="hs-comment">-- If we were given a -x flag, then use that phase to start from</span><span>
</span><a name="line-585"></a><span>             </span><a name="local-6989586621685141869"><a href="#local-6989586621685141869"><span class="hs-identifier">start_phase</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">startPhase</span><span> </span><a href="#local-6989586621685141867"><span class="hs-identifier hs-var">suffix'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685141857"><span class="hs-identifier hs-var">mb_phase</span></a><span>
</span><a name="line-586"></a><span>
</span><a name="line-587"></a><span>             </span><a name="local-6989586621685141870"><a href="#local-6989586621685141870"><span class="hs-identifier">isHaskell</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Unlit</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-588"></a><span>             </span><span class="hs-identifier">isHaskell</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Cpp</span><span>   </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-589"></a><span>             </span><span class="hs-identifier">isHaskell</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsPp</span><span>  </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-590"></a><span>             </span><span class="hs-identifier">isHaskell</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Hsc</span><span>   </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-591"></a><span>             </span><span class="hs-identifier">isHaskell</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HscOut</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-592"></a><span>             </span><span class="hs-identifier">isHaskell</span><span> </span><span class="hs-identifier">_</span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-593"></a><span>
</span><a name="line-594"></a><span>             </span><a name="local-6989586621685141871"><a href="#local-6989586621685141871"><span class="hs-identifier">isHaskellishFile</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141870"><span class="hs-identifier hs-var">isHaskell</span></a><span> </span><a href="#local-6989586621685141869"><span class="hs-identifier hs-var">start_phase</span></a><span>
</span><a name="line-595"></a><span>
</span><a name="line-596"></a><span>             </span><a name="local-6989586621685141872"><a href="#local-6989586621685141872"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">PipeEnv</span><span class="hs-special">{</span><span> </span><a href="#local-6989586621685141854"><span class="hs-identifier hs-var">stop_phase</span></a><span class="hs-special">,</span><span>
</span><a name="line-597"></a><span>                            </span><span class="hs-identifier">src_filename</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141856"><span class="hs-identifier hs-var">input_fn</span></a><span class="hs-special">,</span><span>
</span><a name="line-598"></a><span>                            </span><span class="hs-identifier">src_basename</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141868"><span class="hs-identifier hs-var">basename</span></a><span class="hs-special">,</span><span>
</span><a name="line-599"></a><span>                            </span><span class="hs-identifier">src_suffix</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141867"><span class="hs-identifier hs-var">suffix'</span></a><span class="hs-special">,</span><span>
</span><a name="line-600"></a><span>                            </span><span class="hs-identifier">output_spec</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141859"><span class="hs-identifier hs-var">output</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-601"></a><span>
</span><a name="line-602"></a><span>         </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isBackpackishSuffix</span><span> </span><a href="#local-6989586621685141867"><span class="hs-identifier hs-var">suffix'</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-603"></a><span>           </span><span class="hs-identifier hs-var">throwGhcExceptionIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">UsageError</span><span>
</span><a name="line-604"></a><span>                       </span><span class="hs-special">(</span><span class="hs-string">&quot;use --backpack to process &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685141856"><span class="hs-identifier hs-var">input_fn</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-605"></a><span>
</span><a name="line-606"></a><span>         </span><span class="hs-comment">-- We want to catch cases of &quot;you can't get there from here&quot; before</span><span>
</span><a name="line-607"></a><span>         </span><span class="hs-comment">-- we start the pipeline, because otherwise it will just run off the</span><span>
</span><a name="line-608"></a><span>         </span><span class="hs-comment">-- end.</span><span>
</span><a name="line-609"></a><span>         </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685141874"><a href="#local-6989586621685141874"><span class="hs-identifier">happensBefore'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">happensBefore</span><span> </span><a href="#local-6989586621685141863"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-610"></a><span>         </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685141869"><span class="hs-identifier hs-var">start_phase</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-611"></a><span>             </span><span class="hs-identifier hs-var">RealPhase</span><span> </span><a name="local-6989586621685141875"><a href="#local-6989586621685141875"><span class="hs-identifier">start_phase'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-612"></a><span>                 </span><span class="hs-comment">-- See Note [Partial ordering on phases]</span><span>
</span><a name="line-613"></a><span>                 </span><span class="hs-comment">-- Not the same as: (stop_phase `happensBefore` start_phase')</span><span>
</span><a name="line-614"></a><span>                 </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685141875"><span class="hs-identifier hs-var">start_phase'</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621685141874"><span class="hs-identifier hs-var">happensBefore'</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621685141854"><span class="hs-identifier hs-var">stop_phase</span></a><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-615"></a><span>                            </span><a href="#local-6989586621685141875"><span class="hs-identifier hs-var">start_phase'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqPhase</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685141854"><span class="hs-identifier hs-var">stop_phase</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-616"></a><span>                       </span><span class="hs-identifier hs-var">throwGhcExceptionIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">UsageError</span><span>
</span><a name="line-617"></a><span>                                   </span><span class="hs-special">(</span><span class="hs-string">&quot;cannot compile this file to desired target: &quot;</span><span>
</span><a name="line-618"></a><span>                                      </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685141856"><span class="hs-identifier hs-var">input_fn</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-619"></a><span>             </span><span class="hs-identifier hs-var">HscOut</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-620"></a><span>
</span><a name="line-621"></a><span>         </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><a href="#local-6989586621685141863"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">4</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Running the pipeline&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-622"></a><span>         </span><a name="local-6989586621685141876"><a href="#local-6989586621685141876"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#runPipeline%27"><span class="hs-identifier hs-var">runPipeline'</span></a><span> </span><a href="#local-6989586621685141869"><span class="hs-identifier hs-var">start_phase</span></a><span> </span><a href="#local-6989586621685141864"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685141872"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621685141856"><span class="hs-identifier hs-var">input_fn</span></a><span>
</span><a name="line-623"></a><span>                           </span><a href="#local-6989586621685141860"><span class="hs-identifier hs-var">maybe_loc</span></a><span> </span><a href="#local-6989586621685141861"><span class="hs-identifier hs-var">foreign_os</span></a><span>
</span><a name="line-624"></a><span>
</span><a name="line-625"></a><span>         </span><span class="hs-comment">-- If we are compiling a Haskell module, and doing</span><span>
</span><a name="line-626"></a><span>         </span><span class="hs-comment">-- -dynamic-too, but couldn't do the -dynamic-too fast</span><span>
</span><a name="line-627"></a><span>         </span><span class="hs-comment">-- path, then rerun the pipeline for the dyn way</span><span>
</span><a name="line-628"></a><span>         </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685141877"><a href="#local-6989586621685141877"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685141864"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-629"></a><span>         </span><span class="hs-comment">-- NB: Currently disabled on Windows (ref #7134, #8228, and #5987)</span><span>
</span><a name="line-630"></a><span>         </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">platformOS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621685141877"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">OSMinGW32</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-631"></a><span>           </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621685141871"><span class="hs-identifier hs-var">isHaskellishFile</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">whenCannotGenerateDynamicToo</span><span> </span><a href="#local-6989586621685141877"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-632"></a><span>               </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><a href="#local-6989586621685141877"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">4</span><span>
</span><a name="line-633"></a><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Running the pipeline again for -dynamic-too&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-634"></a><span>               </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685141878"><a href="#local-6989586621685141878"><span class="hs-identifier">dflags'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dynamicTooMkDynamicDynFlags</span><span> </span><a href="#local-6989586621685141877"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-635"></a><span>               </span><a name="local-6989586621685141879"><a href="#local-6989586621685141879"><span class="hs-identifier">hsc_env'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#newHscEnv"><span class="hs-identifier hs-var">newHscEnv</span></a><span> </span><a href="#local-6989586621685141878"><span class="hs-identifier hs-var">dflags'</span></a><span>
</span><a name="line-636"></a><span>               </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#runPipeline%27"><span class="hs-identifier hs-var">runPipeline'</span></a><span> </span><a href="#local-6989586621685141869"><span class="hs-identifier hs-var">start_phase</span></a><span> </span><a href="#local-6989586621685141879"><span class="hs-identifier hs-var">hsc_env'</span></a><span> </span><a href="#local-6989586621685141872"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621685141856"><span class="hs-identifier hs-var">input_fn</span></a><span>
</span><a name="line-637"></a><span>                                 </span><a href="#local-6989586621685141860"><span class="hs-identifier hs-var">maybe_loc</span></a><span> </span><a href="#local-6989586621685141861"><span class="hs-identifier hs-var">foreign_os</span></a><span>
</span><a name="line-638"></a><span>               </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-639"></a><span>         </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685141876"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-640"></a><span>
</span><a name="line-641"></a><span class="hs-identifier">runPipeline'</span><span>
</span><a name="line-642"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PhasePlus</span><span>                  </span><span class="hs-comment">-- ^ When to start</span><span>
</span><a name="line-643"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>                     </span><span class="hs-comment">-- ^ Compilation environment</span><span>
</span><a name="line-644"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PipeEnv</span><span>
</span><a name="line-645"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>                   </span><span class="hs-comment">-- ^ Input filename</span><span>
</span><a name="line-646"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">ModLocation</span><span>          </span><span class="hs-comment">-- ^ A ModLocation, if this is a Haskell module</span><span>
</span><a name="line-647"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">]</span><span>                 </span><span class="hs-comment">-- ^ foreign objects, if we have one</span><span>
</span><a name="line-648"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DynFlags</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- ^ (final flags, output filename)</span><span>
</span><a name="line-649"></a><a name="runPipeline%27"><a href="DriverPipeline.html#runPipeline%27"><span class="hs-identifier">runPipeline'</span></a></a><span> </span><a name="local-6989586621685141880"><a href="#local-6989586621685141880"><span class="hs-identifier">start_phase</span></a></a><span> </span><a name="local-6989586621685141881"><a href="#local-6989586621685141881"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621685141882"><a href="#local-6989586621685141882"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621685141883"><a href="#local-6989586621685141883"><span class="hs-identifier">input_fn</span></a></a><span>
</span><a name="line-650"></a><span>             </span><a name="local-6989586621685141884"><a href="#local-6989586621685141884"><span class="hs-identifier">maybe_loc</span></a></a><span> </span><a name="local-6989586621685141885"><a href="#local-6989586621685141885"><span class="hs-identifier">foreign_os</span></a></a><span>
</span><a name="line-651"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-652"></a><span>  </span><span class="hs-comment">-- Execute the pipeline...</span><span>
</span><a name="line-653"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685141886"><a href="#local-6989586621685141886"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">PipeState</span><span class="hs-special">{</span><span> </span><a href="#local-6989586621685141881"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685141884"><span class="hs-identifier hs-var">maybe_loc</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">foreign_os</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141885"><span class="hs-identifier hs-var">foreign_os</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-654"></a><span>
</span><a name="line-655"></a><span>  </span><span class="hs-identifier hs-var">evalP</span><span> </span><span class="hs-special">(</span><a href="DriverPipeline.html#pipeLoop"><span class="hs-identifier hs-var">pipeLoop</span></a><span> </span><a href="#local-6989586621685141880"><span class="hs-identifier hs-var">start_phase</span></a><span> </span><a href="#local-6989586621685141883"><span class="hs-identifier hs-var">input_fn</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685141882"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621685141886"><span class="hs-identifier hs-var">state</span></a><span>
</span><a name="line-656"></a><span>
</span><a name="line-657"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-658"></a><span class="hs-comment">-- outer pipeline loop</span><span>
</span><a name="line-659"></a><span>
</span><a name="line-660"></a><span class="hs-comment">-- | pipeLoop runs phases until we reach the stop phase</span><span>
</span><a name="line-661"></a><span class="hs-identifier">pipeLoop</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PhasePlus</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CompPipeline</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DynFlags</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">)</span><span>
</span><a name="line-662"></a><a name="pipeLoop"><a href="DriverPipeline.html#pipeLoop"><span class="hs-identifier">pipeLoop</span></a></a><span> </span><a name="local-6989586621685141887"><a href="#local-6989586621685141887"><span class="hs-identifier">phase</span></a></a><span> </span><a name="local-6989586621685141888"><a href="#local-6989586621685141888"><span class="hs-identifier">input_fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-663"></a><span>  </span><a name="local-6989586621685141889"><a href="#local-6989586621685141889"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getPipeEnv</span><span>
</span><a name="line-664"></a><span>  </span><a name="local-6989586621685141890"><a href="#local-6989586621685141890"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-665"></a><span>  </span><span class="hs-comment">-- See Note [Partial ordering on phases]</span><span>
</span><a name="line-666"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685141891"><a href="#local-6989586621685141891"><span class="hs-identifier">happensBefore'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">happensBefore</span><span> </span><a href="#local-6989586621685141890"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-667"></a><span>      </span><a name="local-6989586621685141892"><a href="#local-6989586621685141892"><span class="hs-identifier">stopPhase</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">stop_phase</span><span> </span><a href="#local-6989586621685141889"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-668"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685141887"><span class="hs-identifier hs-var">phase</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-669"></a><span>   </span><span class="hs-identifier hs-var">RealPhase</span><span> </span><a name="local-6989586621685141893"><a href="#local-6989586621685141893"><span class="hs-identifier">realPhase</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685141893"><span class="hs-identifier hs-var">realPhase</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqPhase</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685141892"><span class="hs-identifier hs-var">stopPhase</span></a><span>            </span><span class="hs-comment">-- All done</span><span>
</span><a name="line-670"></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- Sometimes, a compilation phase doesn't actually generate any output</span><span>
</span><a name="line-671"></a><span>        </span><span class="hs-comment">-- (eg. the CPP phase when -fcpp is not turned on).  If we end on this</span><span>
</span><a name="line-672"></a><span>        </span><span class="hs-comment">-- stage, but we wanted to keep the output, then we have to explicitly</span><span>
</span><a name="line-673"></a><span>        </span><span class="hs-comment">-- copy the file, remembering to prepend a {-# LINE #-} pragma so that</span><span>
</span><a name="line-674"></a><span>        </span><span class="hs-comment">-- further compilation stages can tell what the original filename was.</span><span>
</span><a name="line-675"></a><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">output_spec</span><span> </span><a href="#local-6989586621685141889"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-676"></a><span>        </span><span class="hs-identifier hs-var">Temporary</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-677"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685141890"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685141888"><span class="hs-identifier hs-var">input_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-678"></a><span>        </span><a name="local-6989586621685141894"><a href="#local-6989586621685141894"><span class="hs-identifier">output</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-679"></a><span>            </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621685141895"><a href="#local-6989586621685141895"><span class="hs-identifier">pst</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getPipeState</span><span>
</span><a name="line-680"></a><span>               </span><a name="local-6989586621685141896"><a href="#local-6989586621685141896"><span class="hs-identifier">final_fn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="DriverPipeline.html#getOutputFilename"><span class="hs-identifier hs-var">getOutputFilename</span></a><span>
</span><a name="line-681"></a><span>                                        </span><a href="#local-6989586621685141892"><span class="hs-identifier hs-var">stopPhase</span></a><span> </span><a href="#local-6989586621685141894"><span class="hs-identifier hs-var">output</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">src_basename</span><span> </span><a href="#local-6989586621685141889"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-682"></a><span>                                        </span><a href="#local-6989586621685141890"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685141892"><span class="hs-identifier hs-var">stopPhase</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">maybe_loc</span><span> </span><a href="#local-6989586621685141895"><span class="hs-identifier hs-var">pst</span></a><span class="hs-special">)</span><span>
</span><a name="line-683"></a><span>               </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685141896"><span class="hs-identifier hs-var">final_fn</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621685141888"><span class="hs-identifier hs-var">input_fn</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-684"></a><span>                  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685141897"><a href="#local-6989586621685141897"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Copying `&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685141888"><span class="hs-identifier hs-var">input_fn</span></a><span> </span><span class="hs-operator hs-var">++</span><span class="hs-string">&quot;' to `&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685141896"><span class="hs-identifier hs-var">final_fn</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;'&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-685"></a><span>                      </span><a name="local-6989586621685141898"><a href="#local-6989586621685141898"><span class="hs-identifier">line_prag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;{-# LINE 1 \&quot;&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier">src_filename</span><span> </span><a href="#local-6989586621685141889"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;\&quot; #-}\n&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-686"></a><span>                  </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="SysTools.html#copyWithHeader"><span class="hs-identifier hs-var">copyWithHeader</span></a><span> </span><a href="#local-6989586621685141890"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685141897"><span class="hs-identifier hs-var">msg</span></a><span> </span><a href="#local-6989586621685141898"><span class="hs-identifier hs-var">line_prag</span></a><span> </span><a href="#local-6989586621685141888"><span class="hs-identifier hs-var">input_fn</span></a><span> </span><a href="#local-6989586621685141896"><span class="hs-identifier hs-var">final_fn</span></a><span>
</span><a name="line-687"></a><span>               </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685141890"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685141896"><span class="hs-identifier hs-var">final_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-688"></a><span>
</span><a name="line-689"></a><span>
</span><a name="line-690"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685141893"><span class="hs-identifier hs-var">realPhase</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621685141891"><span class="hs-identifier hs-var">happensBefore'</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621685141892"><span class="hs-identifier hs-var">stopPhase</span></a><span class="hs-special">)</span><span>
</span><a name="line-691"></a><span>        </span><span class="hs-comment">-- Something has gone wrong.  We'll try to cover all the cases when</span><span>
</span><a name="line-692"></a><span>        </span><span class="hs-comment">-- this could happen, so if we reach here it is a panic.</span><span>
</span><a name="line-693"></a><span>        </span><span class="hs-comment">-- eg. it might happen if the -C flag is used on a source file that</span><span>
</span><a name="line-694"></a><span>        </span><span class="hs-comment">-- has {-# OPTIONS -fasm #-}.</span><span>
</span><a name="line-695"></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;pipeLoop: at phase &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621685141893"><span class="hs-identifier hs-var">realPhase</span></a><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-696"></a><span>           </span><span class="hs-string">&quot; but I wanted to stop at phase &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621685141892"><span class="hs-identifier hs-var">stopPhase</span></a><span class="hs-special">)</span><span>
</span><a name="line-697"></a><span>
</span><a name="line-698"></a><span>   </span><span class="hs-identifier">_</span><span>
</span><a name="line-699"></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><a href="#local-6989586621685141890"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">4</span><span>
</span><a name="line-700"></a><span>                                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Running phase&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685141887"><span class="hs-identifier hs-var">phase</span></a><span class="hs-special">)</span><span>
</span><a name="line-701"></a><span>           </span><span class="hs-special">(</span><a name="local-6989586621685141899"><a href="#local-6989586621685141899"><span class="hs-identifier">next_phase</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685141900"><a href="#local-6989586621685141900"><span class="hs-identifier">output_fn</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#runHookedPhase"><span class="hs-identifier hs-var">runHookedPhase</span></a><span> </span><a href="#local-6989586621685141887"><span class="hs-identifier hs-var">phase</span></a><span> </span><a href="#local-6989586621685141888"><span class="hs-identifier hs-var">input_fn</span></a><span> </span><a href="#local-6989586621685141890"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-702"></a><span>           </span><a name="local-6989586621685141901"><a href="#local-6989586621685141901"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#pipeLoop"><span class="hs-identifier hs-var">pipeLoop</span></a><span> </span><a href="#local-6989586621685141899"><span class="hs-identifier hs-var">next_phase</span></a><span> </span><a href="#local-6989586621685141900"><span class="hs-identifier hs-var">output_fn</span></a><span>
</span><a name="line-703"></a><span>           </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685141887"><span class="hs-identifier hs-var">phase</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-704"></a><span>               </span><span class="hs-identifier hs-var">HscOut</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-705"></a><span>                   </span><span class="hs-identifier hs-var">whenGeneratingDynamicToo</span><span> </span><a href="#local-6989586621685141890"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-706"></a><span>                       </span><span class="hs-identifier hs-var">setDynFlags</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">dynamicTooMkDynamicDynFlags</span><span> </span><a href="#local-6989586621685141890"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-707"></a><span>                       </span><span class="hs-comment">-- TODO shouldn't ignore result:</span><span>
</span><a name="line-708"></a><span>                       </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#pipeLoop"><span class="hs-identifier hs-var">pipeLoop</span></a><span> </span><a href="#local-6989586621685141887"><span class="hs-identifier hs-var">phase</span></a><span> </span><a href="#local-6989586621685141888"><span class="hs-identifier hs-var">input_fn</span></a><span>
</span><a name="line-709"></a><span>                       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-710"></a><span>               </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-711"></a><span>                   </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-712"></a><span>           </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685141901"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-713"></a><span>
</span><a name="line-714"></a><span class="hs-identifier">runHookedPhase</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PhasePlus</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-715"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CompPipeline</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">PhasePlus</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">)</span><span>
</span><a name="line-716"></a><a name="runHookedPhase"><a href="DriverPipeline.html#runHookedPhase"><span class="hs-identifier">runHookedPhase</span></a></a><span> </span><a name="local-6989586621685141902"><a href="#local-6989586621685141902"><span class="hs-identifier">pp</span></a></a><span> </span><a name="local-6989586621685141903"><a href="#local-6989586621685141903"><span class="hs-identifier">input</span></a></a><span> </span><a name="local-6989586621685141904"><a href="#local-6989586621685141904"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-717"></a><span>  </span><span class="hs-identifier hs-var">lookupHook</span><span> </span><span class="hs-identifier">runPhaseHook</span><span> </span><a href="DriverPipeline.html#runPhase"><span class="hs-identifier hs-var">runPhase</span></a><span> </span><a href="#local-6989586621685141904"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685141902"><span class="hs-identifier hs-var">pp</span></a><span> </span><a href="#local-6989586621685141903"><span class="hs-identifier hs-var">input</span></a><span> </span><a href="#local-6989586621685141904"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-718"></a><span>
</span><a name="line-719"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-720"></a><span class="hs-comment">-- In each phase, we need to know into what filename to generate the</span><span>
</span><a name="line-721"></a><span class="hs-comment">-- output.  All the logic about which filenames we generate output</span><span>
</span><a name="line-722"></a><span class="hs-comment">-- into is embodied in the following function.</span><span>
</span><a name="line-723"></a><span>
</span><a name="line-724"></a><span class="hs-comment">-- | Computes the next output filename after we run @next_phase@.</span><span>
</span><a name="line-725"></a><span class="hs-comment">-- Like 'getOutputFilename', but it operates in the 'CompPipeline' monad</span><span>
</span><a name="line-726"></a><span class="hs-comment">-- (which specifies all of the ambient information.)</span><span>
</span><a name="line-727"></a><span class="hs-identifier">phaseOutputFilename</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Phase</span><span class="hs-comment">{-next phase-}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CompPipeline</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-728"></a><a name="phaseOutputFilename"><a href="DriverPipeline.html#phaseOutputFilename"><span class="hs-identifier">phaseOutputFilename</span></a></a><span> </span><a name="local-6989586621685141905"><a href="#local-6989586621685141905"><span class="hs-identifier">next_phase</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-729"></a><span>  </span><span class="hs-identifier hs-var">PipeEnv</span><span class="hs-special">{</span><a name="local-6989586621685141906"><a href="#local-6989586621685141906"><span class="hs-identifier">stop_phase</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685141907"><a href="#local-6989586621685141907"><span class="hs-identifier">src_basename</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685141908"><a href="#local-6989586621685141908"><span class="hs-identifier">output_spec</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getPipeEnv</span><span>
</span><a name="line-730"></a><span>  </span><span class="hs-identifier hs-var">PipeState</span><span class="hs-special">{</span><a name="local-6989586621685141909"><a href="#local-6989586621685141909"><span class="hs-identifier">maybe_loc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685141910"><a href="#local-6989586621685141910"><span class="hs-identifier">hsc_env</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getPipeState</span><span>
</span><a name="line-731"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685141911"><a href="#local-6989586621685141911"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685141910"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-732"></a><span>  </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="DriverPipeline.html#getOutputFilename"><span class="hs-identifier hs-var">getOutputFilename</span></a><span> </span><a href="#local-6989586621685141906"><span class="hs-identifier hs-var">stop_phase</span></a><span> </span><a href="#local-6989586621685141908"><span class="hs-identifier hs-var">output_spec</span></a><span>
</span><a name="line-733"></a><span>                             </span><a href="#local-6989586621685141907"><span class="hs-identifier hs-var">src_basename</span></a><span> </span><a href="#local-6989586621685141911"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685141905"><span class="hs-identifier hs-var">next_phase</span></a><span> </span><a href="#local-6989586621685141909"><span class="hs-identifier hs-var">maybe_loc</span></a><span>
</span><a name="line-734"></a><span>
</span><a name="line-735"></a><span class="hs-comment">-- | Computes the next output filename for something in the compilation</span><span>
</span><a name="line-736"></a><span class="hs-comment">-- pipeline.  This is controlled by several variables:</span><span>
</span><a name="line-737"></a><span class="hs-comment">--</span><span>
</span><a name="line-738"></a><span class="hs-comment">--      1. 'Phase': the last phase to be run (e.g. 'stopPhase').  This</span><span>
</span><a name="line-739"></a><span class="hs-comment">--         is used to tell if we're in the last phase or not, because</span><span>
</span><a name="line-740"></a><span class="hs-comment">--         in that case flags like @-o@ may be important.</span><span>
</span><a name="line-741"></a><span class="hs-comment">--      2. 'PipelineOutput': is this intended to be a 'Temporary' or</span><span>
</span><a name="line-742"></a><span class="hs-comment">--         'Persistent' build output?  Temporary files just go in</span><span>
</span><a name="line-743"></a><span class="hs-comment">--         a fresh temporary name.</span><span>
</span><a name="line-744"></a><span class="hs-comment">--      3. 'String': what was the basename of the original input file?</span><span>
</span><a name="line-745"></a><span class="hs-comment">--      4. 'DynFlags': the obvious thing</span><span>
</span><a name="line-746"></a><span class="hs-comment">--      5. 'Phase': the phase we want to determine the output filename of.</span><span>
</span><a name="line-747"></a><span class="hs-comment">--      6. @Maybe ModLocation@: the 'ModLocation' of the module we're</span><span>
</span><a name="line-748"></a><span class="hs-comment">--         compiling; this can be used to override the default output</span><span>
</span><a name="line-749"></a><span class="hs-comment">--         of an object file.  (TODO: do we actually need this?)</span><span>
</span><a name="line-750"></a><span class="hs-identifier">getOutputFilename</span><span>
</span><a name="line-751"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Phase</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PipelineOutput</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-752"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Phase</span><span class="hs-comment">{-next phase-}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">ModLocation</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-753"></a><a name="getOutputFilename"><a href="DriverPipeline.html#getOutputFilename"><span class="hs-identifier">getOutputFilename</span></a></a><span> </span><a name="local-6989586621685141912"><a href="#local-6989586621685141912"><span class="hs-identifier">stop_phase</span></a></a><span> </span><a name="local-6989586621685141913"><a href="#local-6989586621685141913"><span class="hs-identifier">output</span></a></a><span> </span><a name="local-6989586621685141914"><a href="#local-6989586621685141914"><span class="hs-identifier">basename</span></a></a><span> </span><a name="local-6989586621685141915"><a href="#local-6989586621685141915"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685141916"><a href="#local-6989586621685141916"><span class="hs-identifier">next_phase</span></a></a><span> </span><a name="local-6989586621685141917"><a href="#local-6989586621685141917"><span class="hs-identifier">maybe_location</span></a></a><span>
</span><a name="line-754"></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685141926"><span class="hs-identifier hs-var">is_last_phase</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Persistent</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685141913"><span class="hs-identifier hs-var">output</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141929"><span class="hs-identifier hs-var">persistent_fn</span></a><span>
</span><a name="line-755"></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685141926"><span class="hs-identifier hs-var">is_last_phase</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SpecificFile</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685141913"><span class="hs-identifier hs-var">output</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">outputFile</span><span> </span><a href="#local-6989586621685141915"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-756"></a><span>                                           </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685141936"><a href="#local-6989586621685141936"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685141936"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-757"></a><span>                                           </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-758"></a><span>                                               </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;SpecificFile: No filename&quot;</span><span>
</span><a name="line-759"></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685141927"><span class="hs-identifier hs-var">keep_this_output</span></a><span>                      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141929"><span class="hs-identifier hs-var">persistent_fn</span></a><span>
</span><a name="line-760"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Temporary</span><span> </span><a name="local-6989586621685141937"><a href="#local-6989586621685141937"><span class="hs-identifier">lifetime</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685141913"><span class="hs-identifier hs-var">output</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">newTempName</span><span> </span><a href="#local-6989586621685141915"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685141937"><span class="hs-identifier hs-var">lifetime</span></a><span> </span><a href="#local-6989586621685141928"><span class="hs-identifier hs-var">suffix</span></a><span>
</span><a name="line-761"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">newTempName</span><span> </span><a href="#local-6989586621685141915"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">TFL_CurrentModule</span><span>
</span><a name="line-762"></a><span>   </span><a href="#local-6989586621685141928"><span class="hs-identifier hs-var">suffix</span></a><span>
</span><a name="line-763"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-764"></a><span>          </span><a name="local-6989586621685141918"><a href="#local-6989586621685141918"><span class="hs-identifier">hcsuf</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hcSuf</span><span> </span><a href="#local-6989586621685141915"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-765"></a><span>          </span><a name="local-6989586621685141919"><a href="#local-6989586621685141919"><span class="hs-identifier">odir</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">objectDir</span><span> </span><a href="#local-6989586621685141915"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-766"></a><span>          </span><a name="local-6989586621685141920"><a href="#local-6989586621685141920"><span class="hs-identifier">osuf</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">objectSuf</span><span> </span><a href="#local-6989586621685141915"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-767"></a><span>          </span><a name="local-6989586621685141921"><a href="#local-6989586621685141921"><span class="hs-identifier">keep_hc</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_KeepHcFiles</span><span> </span><a href="#local-6989586621685141915"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-768"></a><span>          </span><a name="local-6989586621685141922"><a href="#local-6989586621685141922"><span class="hs-identifier">keep_hscpp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_KeepHscppFiles</span><span> </span><a href="#local-6989586621685141915"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-769"></a><span>          </span><a name="local-6989586621685141923"><a href="#local-6989586621685141923"><span class="hs-identifier">keep_s</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_KeepSFiles</span><span> </span><a href="#local-6989586621685141915"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-770"></a><span>          </span><a name="local-6989586621685141924"><a href="#local-6989586621685141924"><span class="hs-identifier">keep_bc</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_KeepLlvmFiles</span><span> </span><a href="#local-6989586621685141915"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-771"></a><span>
</span><a name="line-772"></a><span>          </span><a name="local-6989586621685141925"><a href="#local-6989586621685141925"><span class="hs-identifier">myPhaseInputExt</span></a></a><span> </span><span class="hs-identifier hs-var">HCc</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141918"><span class="hs-identifier hs-var">hcsuf</span></a><span>
</span><a name="line-773"></a><span>          </span><span class="hs-identifier">myPhaseInputExt</span><span> </span><span class="hs-identifier hs-var">MergeForeign</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141920"><span class="hs-identifier hs-var">osuf</span></a><span>
</span><a name="line-774"></a><span>          </span><span class="hs-identifier">myPhaseInputExt</span><span> </span><span class="hs-identifier hs-var">StopLn</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141920"><span class="hs-identifier hs-var">osuf</span></a><span>
</span><a name="line-775"></a><span>          </span><span class="hs-identifier">myPhaseInputExt</span><span> </span><a name="local-6989586621685141932"><a href="#local-6989586621685141932"><span class="hs-identifier">other</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">phaseInputExt</span><span> </span><a href="#local-6989586621685141932"><span class="hs-identifier hs-var">other</span></a><span>
</span><a name="line-776"></a><span>
</span><a name="line-777"></a><span>          </span><a name="local-6989586621685141926"><a href="#local-6989586621685141926"><span class="hs-identifier">is_last_phase</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141916"><span class="hs-identifier hs-var">next_phase</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqPhase</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685141912"><span class="hs-identifier hs-var">stop_phase</span></a><span>
</span><a name="line-778"></a><span>
</span><a name="line-779"></a><span>          </span><span class="hs-comment">-- sometimes, we keep output from intermediate stages</span><span>
</span><a name="line-780"></a><span>          </span><a name="local-6989586621685141927"><a href="#local-6989586621685141927"><span class="hs-identifier">keep_this_output</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-781"></a><span>               </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685141916"><span class="hs-identifier hs-var">next_phase</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-782"></a><span>                       </span><span class="hs-identifier hs-var">As</span><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685141923"><span class="hs-identifier hs-var">keep_s</span></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-783"></a><span>                       </span><span class="hs-identifier hs-var">LlvmOpt</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685141924"><span class="hs-identifier hs-var">keep_bc</span></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-784"></a><span>                       </span><span class="hs-identifier hs-var">HCc</span><span>     </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685141921"><span class="hs-identifier hs-var">keep_hc</span></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-785"></a><span>                       </span><span class="hs-identifier hs-var">HsPp</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685141922"><span class="hs-identifier hs-var">keep_hscpp</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>   </span><span class="hs-comment">-- See Trac #10869</span><span>
</span><a name="line-786"></a><span>                       </span><a name="local-6989586621685141933"><a href="#local-6989586621685141933"><span class="hs-identifier">_other</span></a></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-787"></a><span>
</span><a name="line-788"></a><span>          </span><a name="local-6989586621685141928"><a href="#local-6989586621685141928"><span class="hs-identifier">suffix</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141925"><span class="hs-identifier hs-var">myPhaseInputExt</span></a><span> </span><a href="#local-6989586621685141916"><span class="hs-identifier hs-var">next_phase</span></a><span>
</span><a name="line-789"></a><span>
</span><a name="line-790"></a><span>          </span><span class="hs-comment">-- persistent object files get put in odir</span><span>
</span><a name="line-791"></a><span>          </span><a name="local-6989586621685141929"><a href="#local-6989586621685141929"><span class="hs-identifier">persistent_fn</span></a></a><span>
</span><a name="line-792"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">StopLn</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685141916"><span class="hs-identifier hs-var">next_phase</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685141931"><span class="hs-identifier hs-var">odir_persistent</span></a><span>
</span><a name="line-793"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685141930"><span class="hs-identifier hs-var">persistent</span></a><span>
</span><a name="line-794"></a><span>
</span><a name="line-795"></a><span>          </span><a name="local-6989586621685141930"><a href="#local-6989586621685141930"><span class="hs-identifier">persistent</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141914"><span class="hs-identifier hs-var">basename</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><a href="#local-6989586621685141928"><span class="hs-identifier hs-var">suffix</span></a><span>
</span><a name="line-796"></a><span>
</span><a name="line-797"></a><span>          </span><a name="local-6989586621685141931"><a href="#local-6989586621685141931"><span class="hs-identifier">odir_persistent</span></a></a><span>
</span><a name="line-798"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685141934"><a href="#local-6989586621685141934"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685141917"><span class="hs-identifier hs-var">maybe_location</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ml_obj_file</span><span> </span><a href="#local-6989586621685141934"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-799"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685141935"><a href="#local-6989586621685141935"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685141919"><span class="hs-identifier hs-var">odir</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141935"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><a href="#local-6989586621685141930"><span class="hs-identifier hs-var">persistent</span></a><span>
</span><a name="line-800"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141930"><span class="hs-identifier hs-var">persistent</span></a><span>
</span><a name="line-801"></a><span>
</span><a name="line-802"></a><span>
</span><a name="line-803"></a><span class="hs-comment">-- | The fast LLVM Pipeline skips the mangler and assembler,</span><span>
</span><a name="line-804"></a><span class="hs-comment">-- emitting object code directly from llc.</span><span>
</span><a name="line-805"></a><span class="hs-comment">--</span><span>
</span><a name="line-806"></a><span class="hs-comment">-- slow: opt -&gt; llc -&gt; .s -&gt; mangler -&gt; as -&gt; .o</span><span>
</span><a name="line-807"></a><span class="hs-comment">-- fast: opt -&gt; llc -&gt; .o</span><span>
</span><a name="line-808"></a><span class="hs-comment">--</span><span>
</span><a name="line-809"></a><span class="hs-comment">-- hidden flag: -ffast-llvm</span><span>
</span><a name="line-810"></a><span class="hs-comment">--</span><span>
</span><a name="line-811"></a><span class="hs-comment">-- if keep-s-files is specified, we need to go through</span><span>
</span><a name="line-812"></a><span class="hs-comment">-- the slow pipeline (Kavon Farvardin requested this).</span><span>
</span><a name="line-813"></a><span class="hs-identifier">fastLlvmPipeline</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-814"></a><a name="fastLlvmPipeline"><a href="DriverPipeline.html#fastLlvmPipeline"><span class="hs-identifier">fastLlvmPipeline</span></a></a><span> </span><a name="local-6989586621685141938"><a href="#local-6989586621685141938"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-815"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_KeepSFiles</span><span> </span><a href="#local-6989586621685141938"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_FastLlvm</span><span> </span><a href="#local-6989586621685141938"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-816"></a><span>
</span><a name="line-817"></a><span class="hs-comment">-- | LLVM Options. These are flags to be passed to opt and llc, to ensure</span><span>
</span><a name="line-818"></a><span class="hs-comment">-- consistency we list them in pairs, so that they form groups.</span><span>
</span><a name="line-819"></a><span class="hs-identifier">llvmOptions</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-820"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- ^ pairs of (opt, llc) arguments</span><span>
</span><a name="line-821"></a><a name="llvmOptions"><a href="DriverPipeline.html#llvmOptions"><span class="hs-identifier">llvmOptions</span></a></a><span> </span><a name="local-6989586621685141939"><a href="#local-6989586621685141939"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-822"></a><span>       </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-string">&quot;-enable-tbaa -tbaa&quot;</span><span class="hs-special">,</span><span>  </span><span class="hs-string">&quot;-enable-tbaa&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_LlvmTBAA</span><span> </span><a href="#local-6989586621685141939"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-823"></a><span>    </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-string">&quot;-relocation-model=&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685141943"><span class="hs-identifier hs-var">rmodel</span></a><span>
</span><a name="line-824"></a><span>        </span><span class="hs-special">,</span><span class="hs-string">&quot;-relocation-model=&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685141943"><span class="hs-identifier hs-var">rmodel</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621685141943"><span class="hs-identifier hs-var">rmodel</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-825"></a><span>    </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-string">&quot;-stack-alignment=&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621685141944"><span class="hs-identifier hs-var">align</span></a><span class="hs-special">)</span><span>
</span><a name="line-826"></a><span>        </span><span class="hs-special">,</span><span class="hs-string">&quot;-stack-alignment=&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621685141944"><span class="hs-identifier hs-var">align</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685141944"><span class="hs-identifier hs-var">align</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-827"></a><span>    </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-string">&quot;&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;-filetype=obj&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="DriverPipeline.html#fastLlvmPipeline"><span class="hs-identifier hs-var">fastLlvmPipeline</span></a><span> </span><a href="#local-6989586621685141939"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-828"></a><span>
</span><a name="line-829"></a><span>    </span><span class="hs-comment">-- Additional llc flags</span><span>
</span><a name="line-830"></a><span>    </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-string">&quot;&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;-mcpu=&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685141941"><span class="hs-identifier hs-var">mcpu</span></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621685141941"><span class="hs-identifier hs-var">mcpu</span></a><span class="hs-special">)</span><span>
</span><a name="line-831"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isInfixOf</span><span> </span><span class="hs-string">&quot;-mcpu&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOpts</span><span> </span><a href="#local-6989586621685141939"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">opt_lc</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-832"></a><span>    </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-string">&quot;&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;-mattr=&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685141945"><span class="hs-identifier hs-var">attrs</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621685141945"><span class="hs-identifier hs-var">attrs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-833"></a><span>
</span><a name="line-834"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621685141940"><a href="#local-6989586621685141940"><span class="hs-identifier">target</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">LLVM_TARGET</span><span>
</span><a name="line-835"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LlvmTarget</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621685141941"><a href="#local-6989586621685141941"><span class="hs-identifier">mcpu</span></a></a><span> </span><a name="local-6989586621685141942"><a href="#local-6989586621685141942"><span class="hs-identifier">mattr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621685141940"><span class="hs-identifier hs-var">target</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">llvmTargets</span><span> </span><a href="#local-6989586621685141939"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-836"></a><span>
</span><a name="line-837"></a><span>        </span><span class="hs-comment">-- Relocation models</span><span>
</span><a name="line-838"></a><span>        </span><a name="local-6989586621685141943"><a href="#local-6989586621685141943"><span class="hs-identifier">rmodel</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_PIC</span><span> </span><a href="#local-6989586621685141939"><span class="hs-identifier hs-var">dflags</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;pic&quot;</span><span>
</span><a name="line-839"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">positionIndependent</span><span> </span><a href="#local-6989586621685141939"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;pic&quot;</span><span>
</span><a name="line-840"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">WayDyn</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">ways</span><span> </span><a href="#local-6989586621685141939"><span class="hs-identifier hs-var">dflags</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;dynamic-no-pic&quot;</span><span>
</span><a name="line-841"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;static&quot;</span><span>
</span><a name="line-842"></a><span>
</span><a name="line-843"></a><span>        </span><span class="hs-identifier">align</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-844"></a><span>        </span><a name="local-6989586621685141944"><a href="#local-6989586621685141944"><span class="hs-identifier">align</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">platformArch</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621685141939"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-845"></a><span>                  </span><span class="hs-identifier hs-var">ArchX86_64</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isAvxEnabled</span><span> </span><a href="#local-6989586621685141939"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-number">32</span><span>
</span><a name="line-846"></a><span>                  </span><span class="hs-identifier">_</span><span>                                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-847"></a><span>
</span><a name="line-848"></a><span>        </span><span class="hs-identifier">attrs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-849"></a><span>        </span><a name="local-6989586621685141945"><a href="#local-6989586621685141945"><span class="hs-identifier">attrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">intercalate</span><span> </span><span class="hs-string">&quot;,&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621685141942"><span class="hs-identifier hs-var">mattr</span></a><span>
</span><a name="line-850"></a><span>              </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;+sse42&quot;</span><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isSse4_2Enabled</span><span> </span><a href="#local-6989586621685141939"><span class="hs-identifier hs-var">dflags</span></a><span>   </span><span class="hs-special">]</span><span>
</span><a name="line-851"></a><span>              </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;+sse2&quot;</span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isSse2Enabled</span><span> </span><a href="#local-6989586621685141939"><span class="hs-identifier hs-var">dflags</span></a><span>     </span><span class="hs-special">]</span><span>
</span><a name="line-852"></a><span>              </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;+sse&quot;</span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isSseEnabled</span><span> </span><a href="#local-6989586621685141939"><span class="hs-identifier hs-var">dflags</span></a><span>      </span><span class="hs-special">]</span><span>
</span><a name="line-853"></a><span>              </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;+avx512f&quot;</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isAvx512fEnabled</span><span> </span><a href="#local-6989586621685141939"><span class="hs-identifier hs-var">dflags</span></a><span>  </span><span class="hs-special">]</span><span>
</span><a name="line-854"></a><span>              </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;+avx2&quot;</span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isAvx2Enabled</span><span> </span><a href="#local-6989586621685141939"><span class="hs-identifier hs-var">dflags</span></a><span>     </span><span class="hs-special">]</span><span>
</span><a name="line-855"></a><span>              </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;+avx&quot;</span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isAvxEnabled</span><span> </span><a href="#local-6989586621685141939"><span class="hs-identifier hs-var">dflags</span></a><span>      </span><span class="hs-special">]</span><span>
</span><a name="line-856"></a><span>              </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;+avx512cd&quot;</span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isAvx512cdEnabled</span><span> </span><a href="#local-6989586621685141939"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-857"></a><span>              </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;+avx512er&quot;</span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isAvx512erEnabled</span><span> </span><a href="#local-6989586621685141939"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-858"></a><span>              </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;+avx512pf&quot;</span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isAvx512pfEnabled</span><span> </span><a href="#local-6989586621685141939"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-859"></a><span>              </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;+bmi&quot;</span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isBmiEnabled</span><span> </span><a href="#local-6989586621685141939"><span class="hs-identifier hs-var">dflags</span></a><span>      </span><span class="hs-special">]</span><span>
</span><a name="line-860"></a><span>              </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;+bmi2&quot;</span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isBmi2Enabled</span><span> </span><a href="#local-6989586621685141939"><span class="hs-identifier hs-var">dflags</span></a><span>     </span><span class="hs-special">]</span><span>
</span><a name="line-861"></a><span>
</span><a name="line-862"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-863"></a><span class="hs-comment">-- | Each phase in the pipeline returns the next phase to execute, and the</span><span>
</span><a name="line-864"></a><span class="hs-comment">-- name of the file in which the output was placed.</span><span>
</span><a name="line-865"></a><span class="hs-comment">--</span><span>
</span><a name="line-866"></a><span class="hs-comment">-- We must do things dynamically this way, because we often don't know</span><span>
</span><a name="line-867"></a><span class="hs-comment">-- what the rest of the phases will be until part-way through the</span><span>
</span><a name="line-868"></a><span class="hs-comment">-- compilation: for example, an {-# OPTIONS -fasm #-} at the beginning</span><span>
</span><a name="line-869"></a><span class="hs-comment">-- of a source file can change the latter stages of the pipeline from</span><span>
</span><a name="line-870"></a><span class="hs-comment">-- taking the LLVM route to using the native code generator.</span><span>
</span><a name="line-871"></a><span class="hs-comment">--</span><span>
</span><a name="line-872"></a><span class="hs-identifier">runPhase</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PhasePlus</span><span>   </span><span class="hs-comment">-- ^ Run this phase</span><span>
</span><a name="line-873"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>    </span><span class="hs-comment">-- ^ name of the input file</span><span>
</span><a name="line-874"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>    </span><span class="hs-comment">-- ^ for convenience, we pass the current dflags in</span><span>
</span><a name="line-875"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CompPipeline</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">PhasePlus</span><span class="hs-special">,</span><span>           </span><span class="hs-comment">-- next phase to run</span><span>
</span><a name="line-876"></a><span>                          </span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">)</span><span>            </span><span class="hs-comment">-- output filename</span><span>
</span><a name="line-877"></a><span>
</span><a name="line-878"></a><span>        </span><span class="hs-comment">-- Invariant: the output filename always contains the output</span><span>
</span><a name="line-879"></a><span>        </span><span class="hs-comment">-- Interesting case: Hsc when there is no recompilation to do</span><span>
</span><a name="line-880"></a><span>        </span><span class="hs-comment">--                   Then the output filename is still a .o file</span><span>
</span><a name="line-881"></a><span>
</span><a name="line-882"></a><span>
</span><a name="line-883"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-884"></a><span class="hs-comment">-- Unlit phase</span><span>
</span><a name="line-885"></a><span>
</span><a name="line-886"></a><a name="runPhase"><a href="DriverPipeline.html#runPhase"><span class="hs-identifier">runPhase</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Unlit</span><span> </span><a name="local-6989586621685141946"><a href="#local-6989586621685141946"><span class="hs-identifier">sf</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621685141947"><a href="#local-6989586621685141947"><span class="hs-identifier">input_fn</span></a></a><span> </span><a name="local-6989586621685141948"><a href="#local-6989586621685141948"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-887"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-888"></a><span>       </span><a name="local-6989586621685141955"><a href="#local-6989586621685141955"><span class="hs-identifier">output_fn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#phaseOutputFilename"><span class="hs-identifier hs-var">phaseOutputFilename</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Cpp</span><span> </span><a href="#local-6989586621685141946"><span class="hs-identifier hs-var">sf</span></a><span class="hs-special">)</span><span>
</span><a name="line-889"></a><span>
</span><a name="line-890"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685141956"><a href="#local-6989586621685141956"><span class="hs-identifier">flags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-comment">-- The -h option passes the file name for unlit to</span><span>
</span><a name="line-891"></a><span>                     </span><span class="hs-comment">-- put in a #line directive</span><span>
</span><a name="line-892"></a><span>                     </span><span class="hs-identifier hs-var">SysTools.Option</span><span>     </span><span class="hs-string">&quot;-h&quot;</span><span>
</span><a name="line-893"></a><span>                     </span><span class="hs-comment">-- See Note [Don't normalise input filenames].</span><span>
</span><a name="line-894"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621685141949"><span class="hs-identifier hs-var">escape</span></a><span> </span><a href="#local-6989586621685141947"><span class="hs-identifier hs-var">input_fn</span></a><span>
</span><a name="line-895"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SysTools.FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621685141947"><span class="hs-identifier hs-var">input_fn</span></a><span>
</span><a name="line-896"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SysTools.FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621685141955"><span class="hs-identifier hs-var">output_fn</span></a><span>
</span><a name="line-897"></a><span>                   </span><span class="hs-special">]</span><span>
</span><a name="line-898"></a><span>
</span><a name="line-899"></a><span>       </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="SysTools.Tasks.html#runUnlit"><span class="hs-identifier hs-var">SysTools.runUnlit</span></a><span> </span><a href="#local-6989586621685141948"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685141956"><span class="hs-identifier hs-var">flags</span></a><span>
</span><a name="line-900"></a><span>
</span><a name="line-901"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Cpp</span><span> </span><a href="#local-6989586621685141946"><span class="hs-identifier hs-var">sf</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685141955"><span class="hs-identifier hs-var">output_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-902"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-903"></a><span>       </span><span class="hs-comment">-- escape the characters \, &quot;, and ', but don't try to escape</span><span>
</span><a name="line-904"></a><span>       </span><span class="hs-comment">-- Unicode or anything else (so we don't use Util.charToC</span><span>
</span><a name="line-905"></a><span>       </span><span class="hs-comment">-- here).  If we get this wrong, then in</span><span>
</span><a name="line-906"></a><span>       </span><span class="hs-comment">-- Coverage.isGoodTickSrcSpan where we check that the filename in</span><span>
</span><a name="line-907"></a><span>       </span><span class="hs-comment">-- a SrcLoc is the same as the source filenaame, the two will</span><span>
</span><a name="line-908"></a><span>       </span><span class="hs-comment">-- look bogusly different. See test:</span><span>
</span><a name="line-909"></a><span>       </span><span class="hs-comment">-- libraries/hpc/tests/function/subdir/tough2.hs</span><span>
</span><a name="line-910"></a><span>       </span><a name="local-6989586621685141949"><a href="#local-6989586621685141949"><span class="hs-identifier">escape</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-char">'\\'</span><span class="hs-glyph">:</span><a name="local-6989586621685141950"><a href="#local-6989586621685141950"><span class="hs-identifier">cs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-char">'\\'</span><span class="hs-glyph">:</span><span class="hs-char">'\\'</span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621685141949"><span class="hs-identifier hs-var">escape</span></a><span> </span><a href="#local-6989586621685141950"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-911"></a><span>       </span><span class="hs-identifier">escape</span><span> </span><span class="hs-special">(</span><span class="hs-char">'\&quot;'</span><span class="hs-glyph">:</span><a name="local-6989586621685141951"><a href="#local-6989586621685141951"><span class="hs-identifier">cs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-char">'\\'</span><span class="hs-glyph">:</span><span class="hs-char">'\&quot;'</span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621685141949"><span class="hs-identifier hs-var">escape</span></a><span> </span><a href="#local-6989586621685141951"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-912"></a><span>       </span><span class="hs-identifier">escape</span><span> </span><span class="hs-special">(</span><span class="hs-char">'\''</span><span class="hs-glyph">:</span><a name="local-6989586621685141952"><a href="#local-6989586621685141952"><span class="hs-identifier">cs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-char">'\\'</span><span class="hs-glyph">:</span><span class="hs-char">'\''</span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621685141949"><span class="hs-identifier hs-var">escape</span></a><span> </span><a href="#local-6989586621685141952"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-913"></a><span>       </span><span class="hs-identifier">escape</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685141953"><a href="#local-6989586621685141953"><span class="hs-identifier">c</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621685141954"><a href="#local-6989586621685141954"><span class="hs-identifier">cs</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141953"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621685141949"><span class="hs-identifier hs-var">escape</span></a><span> </span><a href="#local-6989586621685141954"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-914"></a><span>       </span><span class="hs-identifier">escape</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-915"></a><span>
</span><a name="line-916"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-917"></a><span class="hs-comment">-- Cpp phase : (a) gets OPTIONS out of file</span><span>
</span><a name="line-918"></a><span class="hs-comment">--             (b) runs cpp if necessary</span><span>
</span><a name="line-919"></a><span>
</span><a name="line-920"></a><span class="hs-identifier">runPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Cpp</span><span> </span><a name="local-6989586621685141957"><a href="#local-6989586621685141957"><span class="hs-identifier">sf</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621685141958"><a href="#local-6989586621685141958"><span class="hs-identifier">input_fn</span></a></a><span> </span><a name="local-6989586621685141959"><a href="#local-6989586621685141959"><span class="hs-identifier">dflags0</span></a></a><span>
</span><a name="line-921"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-922"></a><span>       </span><a name="local-6989586621685141960"><a href="#local-6989586621685141960"><span class="hs-identifier">src_opts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">getOptionsFromFile</span><span> </span><a href="#local-6989586621685141959"><span class="hs-identifier hs-var">dflags0</span></a><span> </span><a href="#local-6989586621685141958"><span class="hs-identifier hs-var">input_fn</span></a><span>
</span><a name="line-923"></a><span>       </span><span class="hs-special">(</span><a name="local-6989586621685141961"><a href="#local-6989586621685141961"><span class="hs-identifier">dflags1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685141962"><a href="#local-6989586621685141962"><span class="hs-identifier">unhandled_flags</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685141963"><a href="#local-6989586621685141963"><span class="hs-identifier">warns</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-924"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">parseDynamicFilePragma</span><span> </span><a href="#local-6989586621685141959"><span class="hs-identifier hs-var">dflags0</span></a><span> </span><a href="#local-6989586621685141960"><span class="hs-identifier hs-var">src_opts</span></a><span>
</span><a name="line-925"></a><span>       </span><span class="hs-identifier hs-var">setDynFlags</span><span> </span><a href="#local-6989586621685141961"><span class="hs-identifier hs-var">dflags1</span></a><span>
</span><a name="line-926"></a><span>       </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">checkProcessArgsResult</span><span> </span><a href="#local-6989586621685141961"><span class="hs-identifier hs-var">dflags1</span></a><span> </span><a href="#local-6989586621685141962"><span class="hs-identifier hs-var">unhandled_flags</span></a><span>
</span><a name="line-927"></a><span>
</span><a name="line-928"></a><span>       </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">xopt</span><span> </span><span class="hs-identifier hs-var">LangExt.Cpp</span><span> </span><a href="#local-6989586621685141961"><span class="hs-identifier hs-var">dflags1</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-929"></a><span>           </span><span class="hs-comment">-- we have to be careful to emit warnings only once.</span><span>
</span><a name="line-930"></a><span>           </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_Pp</span><span> </span><a href="#local-6989586621685141961"><span class="hs-identifier hs-var">dflags1</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-931"></a><span>               </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">handleFlagWarnings</span><span> </span><a href="#local-6989586621685141961"><span class="hs-identifier hs-var">dflags1</span></a><span> </span><a href="#local-6989586621685141963"><span class="hs-identifier hs-var">warns</span></a><span>
</span><a name="line-932"></a><span>
</span><a name="line-933"></a><span>           </span><span class="hs-comment">-- no need to preprocess CPP, just pass input file along</span><span>
</span><a name="line-934"></a><span>           </span><span class="hs-comment">-- to the next phase of the pipeline.</span><span>
</span><a name="line-935"></a><span>           </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsPp</span><span> </span><a href="#local-6989586621685141957"><span class="hs-identifier hs-var">sf</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685141958"><span class="hs-identifier hs-var">input_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-936"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-937"></a><span>            </span><a name="local-6989586621685141964"><a href="#local-6989586621685141964"><span class="hs-identifier">output_fn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#phaseOutputFilename"><span class="hs-identifier hs-var">phaseOutputFilename</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsPp</span><span> </span><a href="#local-6989586621685141957"><span class="hs-identifier hs-var">sf</span></a><span class="hs-special">)</span><span>
</span><a name="line-938"></a><span>            </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="DriverPipeline.html#doCpp"><span class="hs-identifier hs-var">doCpp</span></a><span> </span><a href="#local-6989586621685141961"><span class="hs-identifier hs-var">dflags1</span></a><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-comment">{-raw-}</span><span>
</span><a name="line-939"></a><span>                           </span><a href="#local-6989586621685141958"><span class="hs-identifier hs-var">input_fn</span></a><span> </span><a href="#local-6989586621685141964"><span class="hs-identifier hs-var">output_fn</span></a><span>
</span><a name="line-940"></a><span>            </span><span class="hs-comment">-- re-read the pragmas now that we've preprocessed the file</span><span>
</span><a name="line-941"></a><span>            </span><span class="hs-comment">-- See #2464,#3457</span><span>
</span><a name="line-942"></a><span>            </span><a name="local-6989586621685141965"><a href="#local-6989586621685141965"><span class="hs-identifier">src_opts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">getOptionsFromFile</span><span> </span><a href="#local-6989586621685141959"><span class="hs-identifier hs-var">dflags0</span></a><span> </span><a href="#local-6989586621685141964"><span class="hs-identifier hs-var">output_fn</span></a><span>
</span><a name="line-943"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621685141966"><a href="#local-6989586621685141966"><span class="hs-identifier">dflags2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685141967"><a href="#local-6989586621685141967"><span class="hs-identifier">unhandled_flags</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685141968"><a href="#local-6989586621685141968"><span class="hs-identifier">warns</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-944"></a><span>                </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">parseDynamicFilePragma</span><span> </span><a href="#local-6989586621685141959"><span class="hs-identifier hs-var">dflags0</span></a><span> </span><a href="#local-6989586621685141965"><span class="hs-identifier hs-var">src_opts</span></a><span>
</span><a name="line-945"></a><span>            </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">checkProcessArgsResult</span><span> </span><a href="#local-6989586621685141966"><span class="hs-identifier hs-var">dflags2</span></a><span> </span><a href="#local-6989586621685141967"><span class="hs-identifier hs-var">unhandled_flags</span></a><span>
</span><a name="line-946"></a><span>            </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_Pp</span><span> </span><a href="#local-6989586621685141966"><span class="hs-identifier hs-var">dflags2</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-947"></a><span>                </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">handleFlagWarnings</span><span> </span><a href="#local-6989586621685141966"><span class="hs-identifier hs-var">dflags2</span></a><span> </span><a href="#local-6989586621685141968"><span class="hs-identifier hs-var">warns</span></a><span>
</span><a name="line-948"></a><span>            </span><span class="hs-comment">-- the HsPp pass below will emit warnings</span><span>
</span><a name="line-949"></a><span>
</span><a name="line-950"></a><span>            </span><span class="hs-identifier hs-var">setDynFlags</span><span> </span><a href="#local-6989586621685141966"><span class="hs-identifier hs-var">dflags2</span></a><span>
</span><a name="line-951"></a><span>
</span><a name="line-952"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsPp</span><span> </span><a href="#local-6989586621685141957"><span class="hs-identifier hs-var">sf</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685141964"><span class="hs-identifier hs-var">output_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-953"></a><span>
</span><a name="line-954"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-955"></a><span class="hs-comment">-- HsPp phase</span><span>
</span><a name="line-956"></a><span>
</span><a name="line-957"></a><span class="hs-identifier">runPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsPp</span><span> </span><a name="local-6989586621685141969"><a href="#local-6989586621685141969"><span class="hs-identifier">sf</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621685141970"><a href="#local-6989586621685141970"><span class="hs-identifier">input_fn</span></a></a><span> </span><a name="local-6989586621685141971"><a href="#local-6989586621685141971"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-958"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-959"></a><span>       </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_Pp</span><span> </span><a href="#local-6989586621685141971"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-960"></a><span>           </span><span class="hs-comment">-- no need to preprocess, just pass input file along</span><span>
</span><a name="line-961"></a><span>           </span><span class="hs-comment">-- to the next phase of the pipeline.</span><span>
</span><a name="line-962"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Hsc</span><span> </span><a href="#local-6989586621685141969"><span class="hs-identifier hs-var">sf</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685141970"><span class="hs-identifier hs-var">input_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-963"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-964"></a><span>            </span><span class="hs-identifier hs-var">PipeEnv</span><span class="hs-special">{</span><a name="local-6989586621685141972"><a href="#local-6989586621685141972"><span class="hs-identifier">src_basename</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685141973"><a href="#local-6989586621685141973"><span class="hs-identifier">src_suffix</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getPipeEnv</span><span>
</span><a name="line-965"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685141974"><a href="#local-6989586621685141974"><span class="hs-identifier">orig_fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141972"><span class="hs-identifier hs-var">src_basename</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><a href="#local-6989586621685141973"><span class="hs-identifier hs-var">src_suffix</span></a><span>
</span><a name="line-966"></a><span>            </span><a name="local-6989586621685141975"><a href="#local-6989586621685141975"><span class="hs-identifier">output_fn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#phaseOutputFilename"><span class="hs-identifier hs-var">phaseOutputFilename</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Hsc</span><span> </span><a href="#local-6989586621685141969"><span class="hs-identifier hs-var">sf</span></a><span class="hs-special">)</span><span>
</span><a name="line-967"></a><span>            </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="SysTools.Tasks.html#runPp"><span class="hs-identifier hs-var">SysTools.runPp</span></a><span> </span><a href="#local-6989586621685141971"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-968"></a><span>                           </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span>     </span><a href="#local-6989586621685141974"><span class="hs-identifier hs-var">orig_fn</span></a><span>
</span><a name="line-969"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span>     </span><a href="#local-6989586621685141970"><span class="hs-identifier hs-var">input_fn</span></a><span>
</span><a name="line-970"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SysTools.FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621685141975"><span class="hs-identifier hs-var">output_fn</span></a><span>
</span><a name="line-971"></a><span>                             </span><span class="hs-special">]</span><span>
</span><a name="line-972"></a><span>                           </span><span class="hs-special">)</span><span>
</span><a name="line-973"></a><span>
</span><a name="line-974"></a><span>            </span><span class="hs-comment">-- re-read pragmas now that we've parsed the file (see #3674)</span><span>
</span><a name="line-975"></a><span>            </span><a name="local-6989586621685141976"><a href="#local-6989586621685141976"><span class="hs-identifier">src_opts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">getOptionsFromFile</span><span> </span><a href="#local-6989586621685141971"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685141975"><span class="hs-identifier hs-var">output_fn</span></a><span>
</span><a name="line-976"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621685141977"><a href="#local-6989586621685141977"><span class="hs-identifier">dflags1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685141978"><a href="#local-6989586621685141978"><span class="hs-identifier">unhandled_flags</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685141979"><a href="#local-6989586621685141979"><span class="hs-identifier">warns</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-977"></a><span>                </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">parseDynamicFilePragma</span><span> </span><a href="#local-6989586621685141971"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685141976"><span class="hs-identifier hs-var">src_opts</span></a><span>
</span><a name="line-978"></a><span>            </span><span class="hs-identifier hs-var">setDynFlags</span><span> </span><a href="#local-6989586621685141977"><span class="hs-identifier hs-var">dflags1</span></a><span>
</span><a name="line-979"></a><span>            </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">checkProcessArgsResult</span><span> </span><a href="#local-6989586621685141977"><span class="hs-identifier hs-var">dflags1</span></a><span> </span><a href="#local-6989586621685141978"><span class="hs-identifier hs-var">unhandled_flags</span></a><span>
</span><a name="line-980"></a><span>            </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">handleFlagWarnings</span><span> </span><a href="#local-6989586621685141977"><span class="hs-identifier hs-var">dflags1</span></a><span> </span><a href="#local-6989586621685141979"><span class="hs-identifier hs-var">warns</span></a><span>
</span><a name="line-981"></a><span>
</span><a name="line-982"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Hsc</span><span> </span><a href="#local-6989586621685141969"><span class="hs-identifier hs-var">sf</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685141975"><span class="hs-identifier hs-var">output_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-983"></a><span>
</span><a name="line-984"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-985"></a><span class="hs-comment">-- Hsc phase</span><span>
</span><a name="line-986"></a><span>
</span><a name="line-987"></a><span class="hs-comment">-- Compilation of a single module, in &quot;legacy&quot; mode (_not_ under</span><span>
</span><a name="line-988"></a><span class="hs-comment">-- the direction of the compilation manager).</span><span>
</span><a name="line-989"></a><span class="hs-identifier">runPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Hsc</span><span> </span><a name="local-6989586621685141980"><a href="#local-6989586621685141980"><span class="hs-identifier">src_flavour</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621685141981"><a href="#local-6989586621685141981"><span class="hs-identifier">input_fn</span></a></a><span> </span><a name="local-6989586621685141982"><a href="#local-6989586621685141982"><span class="hs-identifier">dflags0</span></a></a><span>
</span><a name="line-990"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>   </span><span class="hs-comment">-- normal Hsc mode, not mkdependHS</span><span>
</span><a name="line-991"></a><span>
</span><a name="line-992"></a><span>        </span><span class="hs-identifier hs-var">PipeEnv</span><span class="hs-special">{</span><span> </span><span class="hs-identifier">stop_phase</span><span class="hs-glyph">=</span><a name="local-6989586621685141983"><a href="#local-6989586621685141983"><span class="hs-identifier">stop</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-993"></a><span>                 </span><span class="hs-identifier">src_basename</span><span class="hs-glyph">=</span><a name="local-6989586621685141984"><a href="#local-6989586621685141984"><span class="hs-identifier">basename</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-994"></a><span>                 </span><span class="hs-identifier">src_suffix</span><span class="hs-glyph">=</span><a name="local-6989586621685141985"><a href="#local-6989586621685141985"><span class="hs-identifier">suff</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getPipeEnv</span><span>
</span><a name="line-995"></a><span>
</span><a name="line-996"></a><span>  </span><span class="hs-comment">-- we add the current directory (i.e. the directory in which</span><span>
</span><a name="line-997"></a><span>  </span><span class="hs-comment">-- the .hs files resides) to the include path, since this is</span><span>
</span><a name="line-998"></a><span>  </span><span class="hs-comment">-- what gcc does, and it's probably what you want.</span><span>
</span><a name="line-999"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685141986"><a href="#local-6989586621685141986"><span class="hs-identifier">current_dir</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">takeDirectory</span><span> </span><a href="#local-6989586621685141984"><span class="hs-identifier hs-var">basename</span></a><span>
</span><a name="line-1000"></a><span>            </span><a name="local-6989586621685141987"><a href="#local-6989586621685141987"><span class="hs-identifier">new_includes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addQuoteInclude</span><span> </span><a href="#local-6989586621685141988"><span class="hs-identifier hs-var">paths</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621685141986"><span class="hs-identifier hs-var">current_dir</span></a><span class="hs-special">]</span><span>
</span><a name="line-1001"></a><span>            </span><a name="local-6989586621685141988"><a href="#local-6989586621685141988"><span class="hs-identifier">paths</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">includePaths</span><span> </span><a href="#local-6989586621685141982"><span class="hs-identifier hs-var">dflags0</span></a><span>
</span><a name="line-1002"></a><span>            </span><a name="local-6989586621685141989"><a href="#local-6989586621685141989"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141982"><span class="hs-identifier hs-var">dflags0</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">includePaths</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141987"><span class="hs-identifier hs-var">new_includes</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1003"></a><span>
</span><a name="line-1004"></a><span>        </span><span class="hs-identifier hs-var">setDynFlags</span><span> </span><a href="#local-6989586621685141989"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1005"></a><span>
</span><a name="line-1006"></a><span>  </span><span class="hs-comment">-- gather the imports and module name</span><span>
</span><a name="line-1007"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621685141994"><a href="#local-6989586621685141994"><span class="hs-identifier">hspp_buf</span></a></a><span class="hs-special">,</span><a name="local-6989586621685141995"><a href="#local-6989586621685141995"><span class="hs-identifier">mod_name</span></a></a><span class="hs-special">,</span><a name="local-6989586621685141996"><a href="#local-6989586621685141996"><span class="hs-identifier">imps</span></a></a><span class="hs-special">,</span><a name="local-6989586621685141997"><a href="#local-6989586621685141997"><span class="hs-identifier">src_imps</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1008"></a><span>          </span><span class="hs-keyword">do</span><span>
</span><a name="line-1009"></a><span>            </span><a name="local-6989586621685141990"><a href="#local-6989586621685141990"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">hGetStringBuffer</span><span> </span><a href="#local-6989586621685141981"><span class="hs-identifier hs-var">input_fn</span></a><span>
</span><a name="line-1010"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621685141991"><a href="#local-6989586621685141991"><span class="hs-identifier">src_imps</span></a></a><span class="hs-special">,</span><a name="local-6989586621685141992"><a href="#local-6989586621685141992"><span class="hs-identifier">imps</span></a></a><span class="hs-special">,</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621685141993"><a href="#local-6989586621685141993"><span class="hs-identifier">mod_name</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getImports</span><span> </span><a href="#local-6989586621685141989"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685141990"><span class="hs-identifier hs-var">buf</span></a><span> </span><a href="#local-6989586621685141981"><span class="hs-identifier hs-var">input_fn</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621685141984"><span class="hs-identifier hs-var">basename</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><a href="#local-6989586621685141985"><span class="hs-identifier hs-var">suff</span></a><span class="hs-special">)</span><span>
</span><a name="line-1011"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685141990"><span class="hs-identifier hs-var">buf</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685141993"><span class="hs-identifier hs-var">mod_name</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685141992"><span class="hs-identifier hs-var">imps</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685141991"><span class="hs-identifier hs-var">src_imps</span></a><span class="hs-special">)</span><span>
</span><a name="line-1012"></a><span>
</span><a name="line-1013"></a><span>  </span><span class="hs-comment">-- Take -o into account if present</span><span>
</span><a name="line-1014"></a><span>  </span><span class="hs-comment">-- Very like -ohi, but we must *only* do this if we aren't linking</span><span>
</span><a name="line-1015"></a><span>  </span><span class="hs-comment">-- (If we're linking then the -o applies to the linked thing, not to</span><span>
</span><a name="line-1016"></a><span>  </span><span class="hs-comment">-- the object file for one module.)</span><span>
</span><a name="line-1017"></a><span>  </span><span class="hs-comment">-- Note the nasty duplication with the same computation in compileFile above</span><span>
</span><a name="line-1018"></a><span>        </span><a name="local-6989586621685141998"><a href="#local-6989586621685141998"><span class="hs-identifier">location</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#getLocation"><span class="hs-identifier hs-var">getLocation</span></a><span> </span><a href="#local-6989586621685141980"><span class="hs-identifier hs-var">src_flavour</span></a><span> </span><a href="#local-6989586621685141995"><span class="hs-identifier hs-var">mod_name</span></a><span>
</span><a name="line-1019"></a><span>
</span><a name="line-1020"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685141999"><a href="#local-6989586621685141999"><span class="hs-identifier">o_file</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ml_obj_file</span><span> </span><a href="#local-6989586621685141998"><span class="hs-identifier hs-var">location</span></a><span> </span><span class="hs-comment">-- The real object file</span><span>
</span><a name="line-1021"></a><span>            </span><a name="local-6989586621685142000"><a href="#local-6989586621685142000"><span class="hs-identifier">hi_file</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ml_hi_file</span><span> </span><a href="#local-6989586621685141998"><span class="hs-identifier hs-var">location</span></a><span>
</span><a name="line-1022"></a><span>            </span><a name="local-6989586621685142001"><a href="#local-6989586621685142001"><span class="hs-identifier">hie_file</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ml_hie_file</span><span> </span><a href="#local-6989586621685141998"><span class="hs-identifier hs-var">location</span></a><span>
</span><a name="line-1023"></a><span>            </span><a name="local-6989586621685142002"><a href="#local-6989586621685142002"><span class="hs-identifier">dest_file</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="DriverPipeline.html#writeInterfaceOnlyMode"><span class="hs-identifier hs-var">writeInterfaceOnlyMode</span></a><span> </span><a href="#local-6989586621685141989"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1024"></a><span>                            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685142000"><span class="hs-identifier hs-var">hi_file</span></a><span>
</span><a name="line-1025"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1026"></a><span>                            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141999"><span class="hs-identifier hs-var">o_file</span></a><span>
</span><a name="line-1027"></a><span>
</span><a name="line-1028"></a><span>  </span><span class="hs-comment">-- Figure out if the source has changed, for recompilation avoidance.</span><span>
</span><a name="line-1029"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-1030"></a><span>  </span><span class="hs-comment">-- Setting source_unchanged to True means that M.o (or M.hie) seems</span><span>
</span><a name="line-1031"></a><span>  </span><span class="hs-comment">-- to be up to date wrt M.hs; so no need to recompile unless imports have</span><span>
</span><a name="line-1032"></a><span>  </span><span class="hs-comment">-- changed (which the compiler itself figures out).</span><span>
</span><a name="line-1033"></a><span>  </span><span class="hs-comment">-- Setting source_unchanged to False tells the compiler that M.o is out of</span><span>
</span><a name="line-1034"></a><span>  </span><span class="hs-comment">-- date wrt M.hs (or M.o doesn't exist) so we must recompile regardless.</span><span>
</span><a name="line-1035"></a><span>        </span><a name="local-6989586621685142003"><a href="#local-6989586621685142003"><span class="hs-identifier">src_timestamp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">getModificationUTCTime</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685141984"><span class="hs-identifier hs-var">basename</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><a href="#local-6989586621685141985"><span class="hs-identifier hs-var">suff</span></a><span class="hs-special">)</span><span>
</span><a name="line-1036"></a><span>
</span><a name="line-1037"></a><span>        </span><a name="local-6989586621685142006"><a href="#local-6989586621685142006"><span class="hs-identifier">source_unchanged</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1038"></a><span>          </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isStopLn</span><span> </span><a href="#local-6989586621685141983"><span class="hs-identifier hs-var">stop</span></a><span class="hs-special">)</span><span>
</span><a name="line-1039"></a><span>                </span><span class="hs-comment">-- SourceModified unconditionally if</span><span>
</span><a name="line-1040"></a><span>                </span><span class="hs-comment">--      (a) recompilation checker is off, or</span><span>
</span><a name="line-1041"></a><span>                </span><span class="hs-comment">--      (b) we aren't going all the way to .o file (e.g. ghc -S)</span><span>
</span><a name="line-1042"></a><span>             </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">SourceModified</span><span>
</span><a name="line-1043"></a><span>                </span><span class="hs-comment">-- Otherwise look at file modification dates</span><span>
</span><a name="line-1044"></a><span>             </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621685142004"><a href="#local-6989586621685142004"><span class="hs-identifier">dest_file_mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#sourceModified"><span class="hs-identifier hs-var">sourceModified</span></a><span> </span><a href="#local-6989586621685142002"><span class="hs-identifier hs-var">dest_file</span></a><span> </span><a href="#local-6989586621685142003"><span class="hs-identifier hs-var">src_timestamp</span></a><span>
</span><a name="line-1045"></a><span>                     </span><a name="local-6989586621685142005"><a href="#local-6989586621685142005"><span class="hs-identifier">hie_file_mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_WriteHie</span><span> </span><a href="#local-6989586621685141989"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1046"></a><span>                                        </span><span class="hs-keyword">then</span><span> </span><a href="DriverPipeline.html#sourceModified"><span class="hs-identifier hs-var">sourceModified</span></a><span> </span><a href="#local-6989586621685142001"><span class="hs-identifier hs-var">hie_file</span></a><span>
</span><a name="line-1047"></a><span>                                                            </span><a href="#local-6989586621685142003"><span class="hs-identifier hs-var">src_timestamp</span></a><span>
</span><a name="line-1048"></a><span>                                        </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1049"></a><span>                     </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621685142004"><span class="hs-identifier hs-var">dest_file_mod</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621685142005"><span class="hs-identifier hs-var">hie_file_mod</span></a><span>
</span><a name="line-1050"></a><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">SourceModified</span><span>
</span><a name="line-1051"></a><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">SourceUnmodified</span><span>
</span><a name="line-1052"></a><span>
</span><a name="line-1053"></a><span>        </span><span class="hs-identifier hs-var">PipeState</span><span class="hs-special">{</span><span class="hs-identifier">hsc_env</span><span class="hs-glyph">=</span><a name="local-6989586621685142007"><a href="#local-6989586621685142007"><span class="hs-identifier">hsc_env'</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getPipeState</span><span>
</span><a name="line-1054"></a><span>
</span><a name="line-1055"></a><span>  </span><span class="hs-comment">-- Tell the finder cache about this module</span><span>
</span><a name="line-1056"></a><span>        </span><a name="local-6989586621685142008"><a href="#local-6989586621685142008"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Finder.html#addHomeModuleToFinder"><span class="hs-identifier hs-var">addHomeModuleToFinder</span></a><span> </span><a href="#local-6989586621685142007"><span class="hs-identifier hs-var">hsc_env'</span></a><span> </span><a href="#local-6989586621685141995"><span class="hs-identifier hs-var">mod_name</span></a><span> </span><a href="#local-6989586621685141998"><span class="hs-identifier hs-var">location</span></a><span>
</span><a name="line-1057"></a><span>
</span><a name="line-1058"></a><span>  </span><span class="hs-comment">-- Make the ModSummary to hand to hscMain</span><span>
</span><a name="line-1059"></a><span>        </span><span class="hs-keyword">let</span><span>
</span><a name="line-1060"></a><span>            </span><a name="local-6989586621685142009"><a href="#local-6989586621685142009"><span class="hs-identifier">mod_summary</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ModSummary</span><span> </span><span class="hs-special">{</span><span>  </span><span class="hs-identifier">ms_mod</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685142008"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">,</span><span>
</span><a name="line-1061"></a><span>                                        </span><span class="hs-identifier">ms_hsc_src</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141980"><span class="hs-identifier hs-var">src_flavour</span></a><span class="hs-special">,</span><span>
</span><a name="line-1062"></a><span>                                        </span><span class="hs-identifier">ms_hspp_file</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141981"><span class="hs-identifier hs-var">input_fn</span></a><span class="hs-special">,</span><span>
</span><a name="line-1063"></a><span>                                        </span><span class="hs-identifier">ms_hspp_opts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141989"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">,</span><span>
</span><a name="line-1064"></a><span>                                        </span><span class="hs-identifier">ms_hspp_buf</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141994"><span class="hs-identifier hs-var">hspp_buf</span></a><span class="hs-special">,</span><span>
</span><a name="line-1065"></a><span>                                        </span><span class="hs-identifier">ms_location</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141998"><span class="hs-identifier hs-var">location</span></a><span class="hs-special">,</span><span>
</span><a name="line-1066"></a><span>                                        </span><span class="hs-identifier">ms_hs_date</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685142003"><span class="hs-identifier hs-var">src_timestamp</span></a><span class="hs-special">,</span><span>
</span><a name="line-1067"></a><span>                                        </span><span class="hs-identifier">ms_obj_date</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span>
</span><a name="line-1068"></a><span>                                        </span><span class="hs-identifier">ms_parsed_mod</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span>
</span><a name="line-1069"></a><span>                                        </span><span class="hs-identifier">ms_iface_date</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span>
</span><a name="line-1070"></a><span>                                        </span><span class="hs-identifier">ms_hie_date</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span>
</span><a name="line-1071"></a><span>                                        </span><span class="hs-identifier">ms_textual_imps</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141996"><span class="hs-identifier hs-var">imps</span></a><span class="hs-special">,</span><span>
</span><a name="line-1072"></a><span>                                        </span><span class="hs-identifier">ms_srcimps</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685141997"><span class="hs-identifier hs-var">src_imps</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1073"></a><span>
</span><a name="line-1074"></a><span>  </span><span class="hs-comment">-- run the compiler!</span><span>
</span><a name="line-1075"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142010"><a href="#local-6989586621685142010"><span class="hs-identifier">msg</span></a></a><span> </span><a name="local-6989586621685142011"><a href="#local-6989586621685142011"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621685142012"><a href="#local-6989586621685142012"><span class="hs-identifier">what</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="HscMain.html#oneShotMsg"><span class="hs-identifier hs-var">oneShotMsg</span></a><span> </span><a href="#local-6989586621685142011"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685142012"><span class="hs-identifier hs-var">what</span></a><span>
</span><a name="line-1076"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621685142013"><a href="#local-6989586621685142013"><span class="hs-identifier">result</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#hscIncrementalCompile"><span class="hs-identifier hs-var">hscIncrementalCompile</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685142010"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685142007"><span class="hs-identifier hs-var">hsc_env'</span></a><span>
</span><a name="line-1077"></a><span>                            </span><a href="#local-6989586621685142009"><span class="hs-identifier hs-var">mod_summary</span></a><span> </span><a href="#local-6989586621685142006"><span class="hs-identifier hs-var">source_unchanged</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span class="hs-special">,</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-1078"></a><span>
</span><a name="line-1079"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HscOut</span><span> </span><a href="#local-6989586621685141980"><span class="hs-identifier hs-var">src_flavour</span></a><span> </span><a href="#local-6989586621685141995"><span class="hs-identifier hs-var">mod_name</span></a><span> </span><a href="#local-6989586621685142013"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">,</span><span>
</span><a name="line-1080"></a><span>                </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;HscOut doesn't have an input filename&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1081"></a><span>
</span><a name="line-1082"></a><span class="hs-identifier">runPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HscOut</span><span> </span><a name="local-6989586621685142014"><a href="#local-6989586621685142014"><span class="hs-identifier">src_flavour</span></a></a><span> </span><a name="local-6989586621685142015"><a href="#local-6989586621685142015"><span class="hs-identifier">mod_name</span></a></a><span> </span><a name="local-6989586621685142016"><a href="#local-6989586621685142016"><span class="hs-identifier">result</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621685142017"><a href="#local-6989586621685142017"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1083"></a><span>        </span><a name="local-6989586621685142018"><a href="#local-6989586621685142018"><span class="hs-identifier">location</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#getLocation"><span class="hs-identifier hs-var">getLocation</span></a><span> </span><a href="#local-6989586621685142014"><span class="hs-identifier hs-var">src_flavour</span></a><span> </span><a href="#local-6989586621685142015"><span class="hs-identifier hs-var">mod_name</span></a><span>
</span><a name="line-1084"></a><span>        </span><span class="hs-identifier hs-var">setModLocation</span><span> </span><a href="#local-6989586621685142018"><span class="hs-identifier hs-var">location</span></a><span>
</span><a name="line-1085"></a><span>
</span><a name="line-1086"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142019"><a href="#local-6989586621685142019"><span class="hs-identifier">o_file</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ml_obj_file</span><span> </span><a href="#local-6989586621685142018"><span class="hs-identifier hs-var">location</span></a><span> </span><span class="hs-comment">-- The real object file</span><span>
</span><a name="line-1087"></a><span>            </span><a name="local-6989586621685142020"><a href="#local-6989586621685142020"><span class="hs-identifier">hsc_lang</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hscTarget</span><span> </span><a href="#local-6989586621685142017"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1088"></a><span>            </span><a name="local-6989586621685142021"><a href="#local-6989586621685142021"><span class="hs-identifier">next_phase</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DriverPipeline.html#hscPostBackendPhase"><span class="hs-identifier hs-var">hscPostBackendPhase</span></a><span> </span><a href="#local-6989586621685142017"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685142014"><span class="hs-identifier hs-var">src_flavour</span></a><span> </span><a href="#local-6989586621685142020"><span class="hs-identifier hs-var">hsc_lang</span></a><span>
</span><a name="line-1089"></a><span>
</span><a name="line-1090"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685142016"><span class="hs-identifier hs-var">result</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1091"></a><span>            </span><span class="hs-identifier hs-var">HscNotGeneratingCode</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1092"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-identifier hs-var">StopLn</span><span class="hs-special">,</span><span>
</span><a name="line-1093"></a><span>                        </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;No output filename from Hsc when no-code&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1094"></a><span>            </span><span class="hs-identifier hs-var">HscUpToDate</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1095"></a><span>                </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="DriverPipeline.html#touchObjectFile"><span class="hs-identifier hs-var">touchObjectFile</span></a><span> </span><a href="#local-6989586621685142017"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685142019"><span class="hs-identifier hs-var">o_file</span></a><span>
</span><a name="line-1096"></a><span>                   </span><span class="hs-comment">-- The .o file must have a later modification date</span><span>
</span><a name="line-1097"></a><span>                   </span><span class="hs-comment">-- than the source file (else we wouldn't get Nothing)</span><span>
</span><a name="line-1098"></a><span>                   </span><span class="hs-comment">-- but we touch it anyway, to keep 'make' happy (we think).</span><span>
</span><a name="line-1099"></a><span>                   </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-identifier hs-var">StopLn</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685142019"><span class="hs-identifier hs-var">o_file</span></a><span class="hs-special">)</span><span>
</span><a name="line-1100"></a><span>            </span><span class="hs-identifier hs-var">HscUpdateBoot</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1101"></a><span>                </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- In the case of hs-boot files, generate a dummy .o-boot</span><span>
</span><a name="line-1102"></a><span>                   </span><span class="hs-comment">-- stamp file for the benefit of Make</span><span>
</span><a name="line-1103"></a><span>                   </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="DriverPipeline.html#touchObjectFile"><span class="hs-identifier hs-var">touchObjectFile</span></a><span> </span><a href="#local-6989586621685142017"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685142019"><span class="hs-identifier hs-var">o_file</span></a><span>
</span><a name="line-1104"></a><span>                   </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-identifier hs-var">StopLn</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685142019"><span class="hs-identifier hs-var">o_file</span></a><span class="hs-special">)</span><span>
</span><a name="line-1105"></a><span>            </span><span class="hs-identifier hs-var">HscUpdateSig</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1106"></a><span>                </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- We need to create a REAL but empty .o file</span><span>
</span><a name="line-1107"></a><span>                   </span><span class="hs-comment">-- because we are going to attempt to put it in a library</span><span>
</span><a name="line-1108"></a><span>                   </span><span class="hs-identifier hs-var">PipeState</span><span class="hs-special">{</span><span class="hs-identifier">hsc_env</span><span class="hs-glyph">=</span><a name="local-6989586621685142022"><a href="#local-6989586621685142022"><span class="hs-identifier">hsc_env'</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getPipeState</span><span>
</span><a name="line-1109"></a><span>                   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142023"><a href="#local-6989586621685142023"><span class="hs-identifier">input_fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">expectJust</span><span> </span><span class="hs-string">&quot;runPhase&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ml_hs_file</span><span> </span><a href="#local-6989586621685142018"><span class="hs-identifier hs-var">location</span></a><span class="hs-special">)</span><span>
</span><a name="line-1110"></a><span>                       </span><a name="local-6989586621685142024"><a href="#local-6989586621685142024"><span class="hs-identifier">basename</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dropExtension</span><span> </span><a href="#local-6989586621685142023"><span class="hs-identifier hs-var">input_fn</span></a><span>
</span><a name="line-1111"></a><span>                   </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="DriverPipeline.html#compileEmptyStub"><span class="hs-identifier hs-var">compileEmptyStub</span></a><span> </span><a href="#local-6989586621685142017"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685142022"><span class="hs-identifier hs-var">hsc_env'</span></a><span> </span><a href="#local-6989586621685142024"><span class="hs-identifier hs-var">basename</span></a><span> </span><a href="#local-6989586621685142018"><span class="hs-identifier hs-var">location</span></a><span> </span><a href="#local-6989586621685142015"><span class="hs-identifier hs-var">mod_name</span></a><span>
</span><a name="line-1112"></a><span>                   </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-identifier hs-var">StopLn</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685142019"><span class="hs-identifier hs-var">o_file</span></a><span class="hs-special">)</span><span>
</span><a name="line-1113"></a><span>            </span><span class="hs-identifier hs-var">HscRecomp</span><span> </span><a name="local-6989586621685142025"><a href="#local-6989586621685142025"><span class="hs-identifier">cgguts</span></a></a><span> </span><a name="local-6989586621685142026"><a href="#local-6989586621685142026"><span class="hs-identifier">mod_summary</span></a></a><span>
</span><a name="line-1114"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621685142027"><a href="#local-6989586621685142027"><span class="hs-identifier">output_fn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#phaseOutputFilename"><span class="hs-identifier hs-var">phaseOutputFilename</span></a><span> </span><a href="#local-6989586621685142021"><span class="hs-identifier hs-var">next_phase</span></a><span>
</span><a name="line-1115"></a><span>
</span><a name="line-1116"></a><span>                    </span><span class="hs-identifier hs-var">PipeState</span><span class="hs-special">{</span><span class="hs-identifier">hsc_env</span><span class="hs-glyph">=</span><a name="local-6989586621685142028"><a href="#local-6989586621685142028"><span class="hs-identifier">hsc_env'</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getPipeState</span><span>
</span><a name="line-1117"></a><span>
</span><a name="line-1118"></a><span>                    </span><span class="hs-special">(</span><a name="local-6989586621685142029"><a href="#local-6989586621685142029"><span class="hs-identifier">outputFilename</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685142030"><a href="#local-6989586621685142030"><span class="hs-identifier">mStub</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685142031"><a href="#local-6989586621685142031"><span class="hs-identifier">foreign_files</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1119"></a><span>                      </span><a href="HscMain.html#hscGenHardCode"><span class="hs-identifier hs-var">hscGenHardCode</span></a><span> </span><a href="#local-6989586621685142028"><span class="hs-identifier hs-var">hsc_env'</span></a><span> </span><a href="#local-6989586621685142025"><span class="hs-identifier hs-var">cgguts</span></a><span> </span><a href="#local-6989586621685142026"><span class="hs-identifier hs-var">mod_summary</span></a><span> </span><a href="#local-6989586621685142027"><span class="hs-identifier hs-var">output_fn</span></a><span>
</span><a name="line-1120"></a><span>                    </span><a name="local-6989586621685142032"><a href="#local-6989586621685142032"><span class="hs-identifier">stub_o</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="DriverPipeline.html#compileStub"><span class="hs-identifier hs-var">compileStub</span></a><span> </span><a href="#local-6989586621685142028"><span class="hs-identifier hs-var">hsc_env'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685142030"><span class="hs-identifier hs-var">mStub</span></a><span class="hs-special">)</span><span>
</span><a name="line-1121"></a><span>                    </span><a name="local-6989586621685142033"><a href="#local-6989586621685142033"><span class="hs-identifier">foreign_os</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1122"></a><span>                      </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uncurry</span><span> </span><span class="hs-special">(</span><a href="DriverPipeline.html#compileForeign"><span class="hs-identifier hs-var">compileForeign</span></a><span> </span><a href="#local-6989586621685142028"><span class="hs-identifier hs-var">hsc_env'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685142031"><span class="hs-identifier hs-var">foreign_files</span></a><span>
</span><a name="line-1123"></a><span>                    </span><span class="hs-identifier hs-var">setForeignOs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685142032"><span class="hs-identifier hs-var">stub_o</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142033"><span class="hs-identifier hs-var">foreign_os</span></a><span class="hs-special">)</span><span>
</span><a name="line-1124"></a><span>
</span><a name="line-1125"></a><span>                    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><a href="#local-6989586621685142021"><span class="hs-identifier hs-var">next_phase</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685142029"><span class="hs-identifier hs-var">outputFilename</span></a><span class="hs-special">)</span><span>
</span><a name="line-1126"></a><span>
</span><a name="line-1127"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-1128"></a><span class="hs-comment">-- Cmm phase</span><span>
</span><a name="line-1129"></a><span>
</span><a name="line-1130"></a><span class="hs-identifier">runPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-identifier hs-var">CmmCpp</span><span class="hs-special">)</span><span> </span><a name="local-6989586621685142034"><a href="#local-6989586621685142034"><span class="hs-identifier">input_fn</span></a></a><span> </span><a name="local-6989586621685142035"><a href="#local-6989586621685142035"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-1131"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1132"></a><span>       </span><a name="local-6989586621685142036"><a href="#local-6989586621685142036"><span class="hs-identifier">output_fn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#phaseOutputFilename"><span class="hs-identifier hs-var">phaseOutputFilename</span></a><span> </span><span class="hs-identifier hs-var">Cmm</span><span>
</span><a name="line-1133"></a><span>       </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="DriverPipeline.html#doCpp"><span class="hs-identifier hs-var">doCpp</span></a><span> </span><a href="#local-6989586621685142035"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-comment">{-not raw-}</span><span>
</span><a name="line-1134"></a><span>                      </span><a href="#local-6989586621685142034"><span class="hs-identifier hs-var">input_fn</span></a><span> </span><a href="#local-6989586621685142036"><span class="hs-identifier hs-var">output_fn</span></a><span>
</span><a name="line-1135"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-identifier hs-var">Cmm</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685142036"><span class="hs-identifier hs-var">output_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1136"></a><span>
</span><a name="line-1137"></a><span class="hs-identifier">runPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-identifier hs-var">Cmm</span><span class="hs-special">)</span><span> </span><a name="local-6989586621685142037"><a href="#local-6989586621685142037"><span class="hs-identifier">input_fn</span></a></a><span> </span><a name="local-6989586621685142038"><a href="#local-6989586621685142038"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-1138"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1139"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142039"><a href="#local-6989586621685142039"><span class="hs-identifier">hsc_lang</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hscTarget</span><span> </span><a href="#local-6989586621685142038"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1140"></a><span>
</span><a name="line-1141"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142040"><a href="#local-6989586621685142040"><span class="hs-identifier">next_phase</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DriverPipeline.html#hscPostBackendPhase"><span class="hs-identifier hs-var">hscPostBackendPhase</span></a><span> </span><a href="#local-6989586621685142038"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">HsSrcFile</span><span> </span><a href="#local-6989586621685142039"><span class="hs-identifier hs-var">hsc_lang</span></a><span>
</span><a name="line-1142"></a><span>
</span><a name="line-1143"></a><span>        </span><a name="local-6989586621685142041"><a href="#local-6989586621685142041"><span class="hs-identifier">output_fn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#phaseOutputFilename"><span class="hs-identifier hs-var">phaseOutputFilename</span></a><span> </span><a href="#local-6989586621685142040"><span class="hs-identifier hs-var">next_phase</span></a><span>
</span><a name="line-1144"></a><span>
</span><a name="line-1145"></a><span>        </span><span class="hs-identifier hs-var">PipeState</span><span class="hs-special">{</span><a name="local-6989586621685142042"><a href="#local-6989586621685142042"><span class="hs-identifier">hsc_env</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getPipeState</span><span>
</span><a name="line-1146"></a><span>
</span><a name="line-1147"></a><span>        </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#hscCompileCmmFile"><span class="hs-identifier hs-var">hscCompileCmmFile</span></a><span> </span><a href="#local-6989586621685142042"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685142037"><span class="hs-identifier hs-var">input_fn</span></a><span> </span><a href="#local-6989586621685142041"><span class="hs-identifier hs-var">output_fn</span></a><span>
</span><a name="line-1148"></a><span>
</span><a name="line-1149"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><a href="#local-6989586621685142040"><span class="hs-identifier hs-var">next_phase</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685142041"><span class="hs-identifier hs-var">output_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1150"></a><span>
</span><a name="line-1151"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-1152"></a><span class="hs-comment">-- Cc phase</span><span>
</span><a name="line-1153"></a><span>
</span><a name="line-1154"></a><span class="hs-comment">-- we don't support preprocessing .c files (with -E) now.  Doing so introduces</span><span>
</span><a name="line-1155"></a><span class="hs-comment">-- way too many hacks, and I can't say I've ever used it anyway.</span><span>
</span><a name="line-1156"></a><span>
</span><a name="line-1157"></a><span class="hs-identifier">runPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><a name="local-6989586621685142043"><a href="#local-6989586621685142043"><span class="hs-identifier">cc_phase</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621685142044"><a href="#local-6989586621685142044"><span class="hs-identifier">input_fn</span></a></a><span> </span><a name="local-6989586621685142045"><a href="#local-6989586621685142045"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-1158"></a><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685142043"><span class="hs-identifier hs-var">cc_phase</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqPhase</span><span class="hs-special">`</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Cc</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Ccxx</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HCc</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Cobjc</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Cobjcxx</span><span class="hs-special">]</span><span>
</span><a name="line-1159"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1160"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142046"><a href="#local-6989586621685142046"><span class="hs-identifier">platform</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621685142045"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1161"></a><span>            </span><a name="local-6989586621685142047"><a href="#local-6989586621685142047"><span class="hs-identifier">hcc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685142043"><span class="hs-identifier hs-var">cc_phase</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqPhase</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">HCc</span><span>
</span><a name="line-1162"></a><span>
</span><a name="line-1163"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142048"><a href="#local-6989586621685142048"><span class="hs-identifier">cmdline_include_paths</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">includePaths</span><span> </span><a href="#local-6989586621685142045"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1164"></a><span>
</span><a name="line-1165"></a><span>        </span><span class="hs-comment">-- HC files have the dependent packages stamped into them</span><span>
</span><a name="line-1166"></a><span>        </span><a name="local-6989586621685142049"><a href="#local-6989586621685142049"><span class="hs-identifier">pkgs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621685142047"><span class="hs-identifier hs-var">hcc</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="DriverPipeline.html#getHCFilePackages"><span class="hs-identifier hs-var">getHCFilePackages</span></a><span> </span><a href="#local-6989586621685142044"><span class="hs-identifier hs-var">input_fn</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1167"></a><span>
</span><a name="line-1168"></a><span>        </span><span class="hs-comment">-- add package include paths even if we're just compiling .c</span><span>
</span><a name="line-1169"></a><span>        </span><span class="hs-comment">-- files; this is the Value Add(TM) that using ghc instead of</span><span>
</span><a name="line-1170"></a><span>        </span><span class="hs-comment">-- gcc gives you :)</span><span>
</span><a name="line-1171"></a><span>        </span><a name="local-6989586621685142050"><a href="#local-6989586621685142050"><span class="hs-identifier">pkg_include_dirs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">getPackageIncludePath</span><span> </span><a href="#local-6989586621685142045"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685142049"><span class="hs-identifier hs-var">pkgs</span></a><span>
</span><a name="line-1172"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142051"><a href="#local-6989586621685142051"><span class="hs-identifier">include_paths_global</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621685142052"><a href="#local-6989586621685142052"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621685142053"><a href="#local-6989586621685142053"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;-I&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142052"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621685142053"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1173"></a><span>              </span><span class="hs-special">(</span><span class="hs-identifier">includePathsGlobal</span><span> </span><a href="#local-6989586621685142048"><span class="hs-identifier hs-var">cmdline_include_paths</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142050"><span class="hs-identifier hs-var">pkg_include_dirs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1174"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142054"><a href="#local-6989586621685142054"><span class="hs-identifier">include_paths_quote</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621685142055"><a href="#local-6989586621685142055"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621685142056"><a href="#local-6989586621685142056"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;-iquote&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142055"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621685142056"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1175"></a><span>              </span><span class="hs-special">(</span><span class="hs-identifier">includePathsQuote</span><span> </span><a href="#local-6989586621685142048"><span class="hs-identifier hs-var">cmdline_include_paths</span></a><span class="hs-special">)</span><span>
</span><a name="line-1176"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142057"><a href="#local-6989586621685142057"><span class="hs-identifier">include_paths</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685142054"><span class="hs-identifier hs-var">include_paths_quote</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142051"><span class="hs-identifier hs-var">include_paths_global</span></a><span>
</span><a name="line-1177"></a><span>
</span><a name="line-1178"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142058"><a href="#local-6989586621685142058"><span class="hs-identifier">gcc_extra_viac_flags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extraGccViaCFlags</span><span> </span><a href="#local-6989586621685142045"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1179"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142059"><a href="#local-6989586621685142059"><span class="hs-identifier">pic_c_flags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">picCCOpts</span><span> </span><a href="#local-6989586621685142045"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1180"></a><span>
</span><a name="line-1181"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142060"><a href="#local-6989586621685142060"><span class="hs-identifier">verbFlags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getVerbFlags</span><span> </span><a href="#local-6989586621685142045"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1182"></a><span>
</span><a name="line-1183"></a><span>        </span><span class="hs-comment">-- cc-options are not passed when compiling .hc files.  Our</span><span>
</span><a name="line-1184"></a><span>        </span><span class="hs-comment">-- hc code doesn't not #include any header files anyway, so these</span><span>
</span><a name="line-1185"></a><span>        </span><span class="hs-comment">-- options aren't necessary.</span><span>
</span><a name="line-1186"></a><span>        </span><a name="local-6989586621685142061"><a href="#local-6989586621685142061"><span class="hs-identifier">pkg_extra_cc_opts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1187"></a><span>          </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621685142043"><span class="hs-identifier hs-var">cc_phase</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqPhase</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">HCc</span><span>
</span><a name="line-1188"></a><span>             </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1189"></a><span>             </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">getPackageExtraCcOpts</span><span> </span><a href="#local-6989586621685142045"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685142049"><span class="hs-identifier hs-var">pkgs</span></a><span>
</span><a name="line-1190"></a><span>
</span><a name="line-1191"></a><span>        </span><a name="local-6989586621685142064"><a href="#local-6989586621685142064"><span class="hs-identifier">framework_paths</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-1192"></a><span>            </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">platformUsesFrameworks</span><span> </span><a href="#local-6989586621685142046"><span class="hs-identifier hs-var">platform</span></a><span>
</span><a name="line-1193"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621685142062"><a href="#local-6989586621685142062"><span class="hs-identifier">pkgFrameworkPaths</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">getPackageFrameworkPath</span><span> </span><a href="#local-6989586621685142045"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685142049"><span class="hs-identifier hs-var">pkgs</span></a><span>
</span><a name="line-1194"></a><span>                    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142063"><a href="#local-6989586621685142063"><span class="hs-identifier">cmdlineFrameworkPaths</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">frameworkPaths</span><span> </span><a href="#local-6989586621685142045"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1195"></a><span>                    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;-F&quot;</span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span>
</span><a name="line-1196"></a><span>                                 </span><span class="hs-special">(</span><a href="#local-6989586621685142063"><span class="hs-identifier hs-var">cmdlineFrameworkPaths</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142062"><span class="hs-identifier hs-var">pkgFrameworkPaths</span></a><span class="hs-special">)</span><span>
</span><a name="line-1197"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1198"></a><span>
</span><a name="line-1199"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142065"><a href="#local-6989586621685142065"><span class="hs-identifier">cc_opt</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">optLevel</span><span> </span><a href="#local-6989586621685142045"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;-O2&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1200"></a><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">optLevel</span><span> </span><a href="#local-6989586621685142045"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;-O&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1201"></a><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1202"></a><span>
</span><a name="line-1203"></a><span>        </span><span class="hs-comment">-- Decide next phase</span><span>
</span><a name="line-1204"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142066"><a href="#local-6989586621685142066"><span class="hs-identifier">next_phase</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">As</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1205"></a><span>        </span><a name="local-6989586621685142067"><a href="#local-6989586621685142067"><span class="hs-identifier">output_fn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#phaseOutputFilename"><span class="hs-identifier hs-var">phaseOutputFilename</span></a><span> </span><a href="#local-6989586621685142066"><span class="hs-identifier hs-var">next_phase</span></a><span>
</span><a name="line-1206"></a><span>
</span><a name="line-1207"></a><span>        </span><span class="hs-keyword">let</span><span>
</span><a name="line-1208"></a><span>          </span><a name="local-6989586621685142068"><a href="#local-6989586621685142068"><span class="hs-identifier">more_hcc_opts</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1209"></a><span>                </span><span class="hs-comment">-- on x86 the floating point regs have greater precision</span><span>
</span><a name="line-1210"></a><span>                </span><span class="hs-comment">-- than a double, which leads to unpredictable results.</span><span>
</span><a name="line-1211"></a><span>                </span><span class="hs-comment">-- By default, we turn this off with -ffloat-store unless</span><span>
</span><a name="line-1212"></a><span>                </span><span class="hs-comment">-- the user specified -fexcess-precision.</span><span>
</span><a name="line-1213"></a><span>                </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">platformArch</span><span> </span><a href="#local-6989586621685142046"><span class="hs-identifier hs-var">platform</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">ArchX86</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-1214"></a><span>                    </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_ExcessPrecision</span><span> </span><a href="#local-6989586621685142045"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1215"></a><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;-ffloat-store&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1216"></a><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1217"></a><span>
</span><a name="line-1218"></a><span>                </span><span class="hs-comment">-- gcc's -fstrict-aliasing allows two accesses to memory</span><span>
</span><a name="line-1219"></a><span>                </span><span class="hs-comment">-- to be considered non-aliasing if they have different types.</span><span>
</span><a name="line-1220"></a><span>                </span><span class="hs-comment">-- This interacts badly with the C code we generate, which is</span><span>
</span><a name="line-1221"></a><span>                </span><span class="hs-comment">-- very weakly typed, being derived from C--.</span><span>
</span><a name="line-1222"></a><span>                </span><span class="hs-special">[</span><span class="hs-string">&quot;-fno-strict-aliasing&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-1223"></a><span>
</span><a name="line-1224"></a><span>        </span><a name="local-6989586621685142069"><a href="#local-6989586621685142069"><span class="hs-identifier">ghcVersionH</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="DriverPipeline.html#getGhcVersionPathName"><span class="hs-identifier hs-var">getGhcVersionPathName</span></a><span> </span><a href="#local-6989586621685142045"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1225"></a><span>
</span><a name="line-1226"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142070"><a href="#local-6989586621685142070"><span class="hs-identifier">gcc_lang_opt</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685142043"><span class="hs-identifier hs-var">cc_phase</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqPhase</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">Ccxx</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;c++&quot;</span><span>
</span><a name="line-1227"></a><span>                         </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685142043"><span class="hs-identifier hs-var">cc_phase</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqPhase</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">Cobjc</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;objective-c&quot;</span><span>
</span><a name="line-1228"></a><span>                         </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685142043"><span class="hs-identifier hs-var">cc_phase</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqPhase</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">Cobjcxx</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;objective-c++&quot;</span><span>
</span><a name="line-1229"></a><span>                         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;c&quot;</span><span>
</span><a name="line-1230"></a><span>        </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="SysTools.Tasks.html#runCc"><span class="hs-identifier hs-var">SysTools.runCc</span></a><span> </span><a href="#local-6989586621685142045"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span>
</span><a name="line-1231"></a><span>                </span><span class="hs-comment">-- force the C compiler to interpret this file as C when</span><span>
</span><a name="line-1232"></a><span>                </span><span class="hs-comment">-- compiling .hc files, by adding the -x c option.</span><span>
</span><a name="line-1233"></a><span>                </span><span class="hs-comment">-- Also useful for plain .c files, just in case GHC saw a</span><span>
</span><a name="line-1234"></a><span>                </span><span class="hs-comment">-- -x c option.</span><span>
</span><a name="line-1235"></a><span>                        </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-string">&quot;-x&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><a href="#local-6989586621685142070"><span class="hs-identifier hs-var">gcc_lang_opt</span></a><span>
</span><a name="line-1236"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SysTools.FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621685142044"><span class="hs-identifier hs-var">input_fn</span></a><span>
</span><a name="line-1237"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-string">&quot;-o&quot;</span><span>
</span><a name="line-1238"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SysTools.FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621685142067"><span class="hs-identifier hs-var">output_fn</span></a><span>
</span><a name="line-1239"></a><span>                        </span><span class="hs-special">]</span><span>
</span><a name="line-1240"></a><span>                       </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-1241"></a><span>                          </span><a href="#local-6989586621685142059"><span class="hs-identifier hs-var">pic_c_flags</span></a><span>
</span><a name="line-1242"></a><span>
</span><a name="line-1243"></a><span>                </span><span class="hs-comment">-- Stub files generated for foreign exports references the runIO_closure</span><span>
</span><a name="line-1244"></a><span>                </span><span class="hs-comment">-- and runNonIO_closure symbols, which are defined in the base package.</span><span>
</span><a name="line-1245"></a><span>                </span><span class="hs-comment">-- These symbols are imported into the stub.c file via RtsAPI.h, and the</span><span>
</span><a name="line-1246"></a><span>                </span><span class="hs-comment">-- way we do the import depends on whether we're currently compiling</span><span>
</span><a name="line-1247"></a><span>                </span><span class="hs-comment">-- the base package or not.</span><span>
</span><a name="line-1248"></a><span>                       </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">platformOS</span><span> </span><a href="#local-6989586621685142046"><span class="hs-identifier hs-var">platform</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">OSMinGW32</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-1249"></a><span>                              </span><span class="hs-identifier hs-var">thisPackage</span><span> </span><a href="#local-6989586621685142045"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">baseUnitId</span><span>
</span><a name="line-1250"></a><span>                                </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;-DCOMPILING_BASE_PACKAGE&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1251"></a><span>                                </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1252"></a><span>
</span><a name="line-1253"></a><span>        </span><span class="hs-comment">-- We only support SparcV9 and better because V8 lacks an atomic CAS</span><span>
</span><a name="line-1254"></a><span>        </span><span class="hs-comment">-- instruction. Note that the user can still override this</span><span>
</span><a name="line-1255"></a><span>        </span><span class="hs-comment">-- (e.g., -mcpu=ultrasparc) as GCC picks the &quot;best&quot; -mcpu flag</span><span>
</span><a name="line-1256"></a><span>        </span><span class="hs-comment">-- regardless of the ordering.</span><span>
</span><a name="line-1257"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-1258"></a><span>        </span><span class="hs-comment">-- This is a temporary hack. See #2872, commit</span><span>
</span><a name="line-1259"></a><span>        </span><span class="hs-comment">-- 5bd3072ac30216a505151601884ac88bf404c9f2</span><span>
</span><a name="line-1260"></a><span>                       </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">platformArch</span><span> </span><a href="#local-6989586621685142046"><span class="hs-identifier hs-var">platform</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">ArchSPARC</span><span>
</span><a name="line-1261"></a><span>                           </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;-mcpu=v9&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-1262"></a><span>                           </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1263"></a><span>
</span><a name="line-1264"></a><span>                       </span><span class="hs-comment">-- GCC 4.6+ doesn't like -Wimplicit when compiling C++.</span><span>
</span><a name="line-1265"></a><span>                       </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685142043"><span class="hs-identifier hs-var">cc_phase</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">Ccxx</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621685142043"><span class="hs-identifier hs-var">cc_phase</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">Cobjcxx</span><span class="hs-special">)</span><span>
</span><a name="line-1266"></a><span>                             </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;-Wimplicit&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-1267"></a><span>                             </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1268"></a><span>
</span><a name="line-1269"></a><span>                       </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621685142047"><span class="hs-identifier hs-var">hcc</span></a><span>
</span><a name="line-1270"></a><span>                             </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621685142058"><span class="hs-identifier hs-var">gcc_extra_viac_flags</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142068"><span class="hs-identifier hs-var">more_hcc_opts</span></a><span>
</span><a name="line-1271"></a><span>                             </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1272"></a><span>                       </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142060"><span class="hs-identifier hs-var">verbFlags</span></a><span>
</span><a name="line-1273"></a><span>                       </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;-S&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1274"></a><span>                       </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142065"><span class="hs-identifier hs-var">cc_opt</span></a><span>
</span><a name="line-1275"></a><span>                       </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;-include&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685142069"><span class="hs-identifier hs-var">ghcVersionH</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1276"></a><span>                       </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142064"><span class="hs-identifier hs-var">framework_paths</span></a><span>
</span><a name="line-1277"></a><span>                       </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142057"><span class="hs-identifier hs-var">include_paths</span></a><span>
</span><a name="line-1278"></a><span>                       </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142061"><span class="hs-identifier hs-var">pkg_extra_cc_opts</span></a><span>
</span><a name="line-1279"></a><span>                       </span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1280"></a><span>
</span><a name="line-1281"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><a href="#local-6989586621685142066"><span class="hs-identifier hs-var">next_phase</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685142067"><span class="hs-identifier hs-var">output_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1282"></a><span>
</span><a name="line-1283"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-1284"></a><span class="hs-comment">-- Splitting phase</span><span>
</span><a name="line-1285"></a><span>
</span><a name="line-1286"></a><span class="hs-identifier">runPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-identifier hs-var">Splitter</span><span class="hs-special">)</span><span> </span><a name="local-6989586621685142071"><a href="#local-6989586621685142071"><span class="hs-identifier">input_fn</span></a></a><span> </span><a name="local-6989586621685142072"><a href="#local-6989586621685142072"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-1287"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-comment">-- tmp_pfx is the prefix used for the split .s files</span><span>
</span><a name="line-1288"></a><span>
</span><a name="line-1289"></a><span>        </span><a name="local-6989586621685142073"><a href="#local-6989586621685142073"><span class="hs-identifier">split_s_prefix</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-1290"></a><span>          </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">newTempName</span><span> </span><a href="#local-6989586621685142072"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">TFL_CurrentModule</span><span> </span><span class="hs-string">&quot;split&quot;</span><span>
</span><a name="line-1291"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142074"><a href="#local-6989586621685142074"><span class="hs-identifier">n_files_fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685142073"><span class="hs-identifier hs-var">split_s_prefix</span></a><span>
</span><a name="line-1292"></a><span>
</span><a name="line-1293"></a><span>        </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="SysTools.Tasks.html#runSplit"><span class="hs-identifier hs-var">SysTools.runSplit</span></a><span> </span><a href="#local-6989586621685142072"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1294"></a><span>                          </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">SysTools.FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621685142071"><span class="hs-identifier hs-var">input_fn</span></a><span>
</span><a name="line-1295"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SysTools.FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621685142073"><span class="hs-identifier hs-var">split_s_prefix</span></a><span>
</span><a name="line-1296"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SysTools.FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621685142074"><span class="hs-identifier hs-var">n_files_fn</span></a><span>
</span><a name="line-1297"></a><span>                          </span><span class="hs-special">]</span><span>
</span><a name="line-1298"></a><span>
</span><a name="line-1299"></a><span>        </span><span class="hs-comment">-- Save the number of split files for future references</span><span>
</span><a name="line-1300"></a><span>        </span><a name="local-6989586621685142075"><a href="#local-6989586621685142075"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">readFile</span><span> </span><a href="#local-6989586621685142074"><span class="hs-identifier hs-var">n_files_fn</span></a><span>
</span><a name="line-1301"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142076"><a href="#local-6989586621685142076"><span class="hs-identifier">n_files</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">read</span><span> </span><a href="#local-6989586621685142075"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1302"></a><span>            </span><a name="local-6989586621685142077"><a href="#local-6989586621685142077"><span class="hs-identifier">dflags'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685142072"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">splitInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685142073"><span class="hs-identifier hs-var">split_s_prefix</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685142076"><span class="hs-identifier hs-var">n_files</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1303"></a><span>
</span><a name="line-1304"></a><span>        </span><span class="hs-identifier hs-var">setDynFlags</span><span> </span><a href="#local-6989586621685142077"><span class="hs-identifier hs-var">dflags'</span></a><span>
</span><a name="line-1305"></a><span>
</span><a name="line-1306"></a><span>        </span><span class="hs-comment">-- Remember to delete all these files</span><span>
</span><a name="line-1307"></a><span>        </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">addFilesToClean</span><span> </span><a href="#local-6989586621685142077"><span class="hs-identifier hs-var">dflags'</span></a><span> </span><span class="hs-identifier hs-var">TFL_CurrentModule</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1308"></a><span>                                 </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621685142073"><span class="hs-identifier hs-var">split_s_prefix</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;__&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621685142078"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;.s&quot;</span><span>
</span><a name="line-1309"></a><span>                                 </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621685142078"><a href="#local-6989586621685142078"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-glyph">..</span><a href="#local-6989586621685142076"><span class="hs-identifier hs-var">n_files</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-1310"></a><span>
</span><a name="line-1311"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-identifier hs-var">SplitAs</span><span class="hs-special">,</span><span>
</span><a name="line-1312"></a><span>                </span><span class="hs-string">&quot;**splitter**&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- we don't use the filename in SplitAs</span><span>
</span><a name="line-1313"></a><span>
</span><a name="line-1314"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-1315"></a><span class="hs-comment">-- As, SpitAs phase : Assembler</span><span>
</span><a name="line-1316"></a><span>
</span><a name="line-1317"></a><span class="hs-comment">-- This is for calling the assembler on a regular assembly file (not split).</span><span>
</span><a name="line-1318"></a><span class="hs-identifier">runPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">As</span><span> </span><a name="local-6989586621685142079"><a href="#local-6989586621685142079"><span class="hs-identifier">with_cpp</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621685142080"><a href="#local-6989586621685142080"><span class="hs-identifier">input_fn</span></a></a><span> </span><a name="local-6989586621685142081"><a href="#local-6989586621685142081"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-1319"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1320"></a><span>        </span><span class="hs-comment">-- LLVM from version 3.0 onwards doesn't support the OS X system</span><span>
</span><a name="line-1321"></a><span>        </span><span class="hs-comment">-- assembler, so we use clang as the assembler instead. (#5636)</span><span>
</span><a name="line-1322"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142082"><a href="#local-6989586621685142082"><span class="hs-identifier">whichAsProg</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">hscTarget</span><span> </span><a href="#local-6989586621685142081"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">HscLlvm</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-1323"></a><span>                          </span><span class="hs-identifier">platformOS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621685142081"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">OSDarwin</span><span>
</span><a name="line-1324"></a><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="SysTools.Tasks.html#runClang"><span class="hs-identifier hs-var">SysTools.runClang</span></a><span>
</span><a name="line-1325"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="SysTools.Tasks.html#runAs"><span class="hs-identifier hs-var">SysTools.runAs</span></a><span>
</span><a name="line-1326"></a><span>
</span><a name="line-1327"></a><span>        </span><a name="local-6989586621685142083"><a href="#local-6989586621685142083"><span class="hs-identifier">as_prog</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685142082"><span class="hs-identifier hs-var">whichAsProg</span></a><span>
</span><a name="line-1328"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142084"><a href="#local-6989586621685142084"><span class="hs-identifier">cmdline_include_paths</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">includePaths</span><span> </span><a href="#local-6989586621685142081"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1329"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142085"><a href="#local-6989586621685142085"><span class="hs-identifier">pic_c_flags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">picCCOpts</span><span> </span><a href="#local-6989586621685142081"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1330"></a><span>
</span><a name="line-1331"></a><span>        </span><a name="local-6989586621685142086"><a href="#local-6989586621685142086"><span class="hs-identifier">next_phase</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#maybeMergeForeign"><span class="hs-identifier hs-var">maybeMergeForeign</span></a><span>
</span><a name="line-1332"></a><span>        </span><a name="local-6989586621685142087"><a href="#local-6989586621685142087"><span class="hs-identifier">output_fn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#phaseOutputFilename"><span class="hs-identifier hs-var">phaseOutputFilename</span></a><span> </span><a href="#local-6989586621685142086"><span class="hs-identifier hs-var">next_phase</span></a><span>
</span><a name="line-1333"></a><span>
</span><a name="line-1334"></a><span>        </span><span class="hs-comment">-- we create directories for the object file, because it</span><span>
</span><a name="line-1335"></a><span>        </span><span class="hs-comment">-- might be a hierarchical module.</span><span>
</span><a name="line-1336"></a><span>        </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">createDirectoryIfMissing</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">takeDirectory</span><span> </span><a href="#local-6989586621685142087"><span class="hs-identifier hs-var">output_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1337"></a><span>
</span><a name="line-1338"></a><span>        </span><a name="local-6989586621685142088"><a href="#local-6989586621685142088"><span class="hs-identifier">ccInfo</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="SysTools.Info.html#getCompilerInfo"><span class="hs-identifier hs-var">getCompilerInfo</span></a><span> </span><a href="#local-6989586621685142081"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1339"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142089"><a href="#local-6989586621685142089"><span class="hs-identifier">global_includes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;-I&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142090"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-1340"></a><span>                              </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621685142090"><a href="#local-6989586621685142090"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">includePathsGlobal</span><span> </span><a href="#local-6989586621685142084"><span class="hs-identifier hs-var">cmdline_include_paths</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1341"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142091"><a href="#local-6989586621685142091"><span class="hs-identifier">local_includes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;-iquote&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142092"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-1342"></a><span>                             </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621685142092"><a href="#local-6989586621685142092"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">includePathsQuote</span><span> </span><a href="#local-6989586621685142084"><span class="hs-identifier hs-var">cmdline_include_paths</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1343"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142093"><a href="#local-6989586621685142093"><span class="hs-identifier">runAssembler</span></a></a><span> </span><a name="local-6989586621685142094"><a href="#local-6989586621685142094"><span class="hs-identifier">inputFilename</span></a></a><span> </span><a name="local-6989586621685142095"><a href="#local-6989586621685142095"><span class="hs-identifier">outputFilename</span></a></a><span>
</span><a name="line-1344"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621685142083"><span class="hs-identifier hs-var">as_prog</span></a><span> </span><a href="#local-6989586621685142081"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1345"></a><span>                       </span><span class="hs-special">(</span><a href="#local-6989586621685142091"><span class="hs-identifier hs-var">local_includes</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142089"><span class="hs-identifier hs-var">global_includes</span></a><span>
</span><a name="line-1346"></a><span>                       </span><span class="hs-comment">-- See Note [-fPIC for assembler]</span><span>
</span><a name="line-1347"></a><span>                       </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><a href="#local-6989586621685142085"><span class="hs-identifier hs-var">pic_c_flags</span></a><span>
</span><a name="line-1348"></a><span>                       </span><span class="hs-comment">-- See Note [Produce big objects on Windows]</span><span>
</span><a name="line-1349"></a><span>                       </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-string">&quot;-Wa,-mbig-obj&quot;</span><span>
</span><a name="line-1350"></a><span>                          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">platformOS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621685142081"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">OSMinGW32</span><span>
</span><a name="line-1351"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">target32Bit</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621685142081"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1352"></a><span>                          </span><span class="hs-special">]</span><span>
</span><a name="line-1353"></a><span>
</span><a name="line-1354"></a><span>        </span><span class="hs-comment">-- We only support SparcV9 and better because V8 lacks an atomic CAS</span><span>
</span><a name="line-1355"></a><span>        </span><span class="hs-comment">-- instruction so we have to make sure that the assembler accepts the</span><span>
</span><a name="line-1356"></a><span>        </span><span class="hs-comment">-- instruction set. Note that the user can still override this</span><span>
</span><a name="line-1357"></a><span>        </span><span class="hs-comment">-- (e.g., -mcpu=ultrasparc). GCC picks the &quot;best&quot; -mcpu flag</span><span>
</span><a name="line-1358"></a><span>        </span><span class="hs-comment">-- regardless of the ordering.</span><span>
</span><a name="line-1359"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-1360"></a><span>        </span><span class="hs-comment">-- This is a temporary hack.</span><span>
</span><a name="line-1361"></a><span>                       </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">platformArch</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621685142081"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">ArchSPARC</span><span>
</span><a name="line-1362"></a><span>                           </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-string">&quot;-mcpu=v9&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-1363"></a><span>                           </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1364"></a><span>                       </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685142088"><span class="hs-identifier hs-var">ccInfo</span></a><span> </span><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Clang</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">AppleClang</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">AppleClang51</span><span class="hs-special">]</span><span>
</span><a name="line-1365"></a><span>                            </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-string">&quot;-Qunused-arguments&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-1366"></a><span>                            </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1367"></a><span>                       </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-string">&quot;-x&quot;</span><span>
</span><a name="line-1368"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621685142079"><span class="hs-identifier hs-var">with_cpp</span></a><span>
</span><a name="line-1369"></a><span>                              </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-string">&quot;assembler-with-cpp&quot;</span><span>
</span><a name="line-1370"></a><span>                              </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-string">&quot;assembler&quot;</span><span>
</span><a name="line-1371"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-string">&quot;-c&quot;</span><span>
</span><a name="line-1372"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SysTools.FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621685142094"><span class="hs-identifier hs-var">inputFilename</span></a><span>
</span><a name="line-1373"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-string">&quot;-o&quot;</span><span>
</span><a name="line-1374"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SysTools.FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621685142095"><span class="hs-identifier hs-var">outputFilename</span></a><span>
</span><a name="line-1375"></a><span>                          </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1376"></a><span>
</span><a name="line-1377"></a><span>        </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><a href="#local-6989586621685142081"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">4</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Running the assembler&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1378"></a><span>        </span><a href="#local-6989586621685142093"><span class="hs-identifier hs-var">runAssembler</span></a><span> </span><a href="#local-6989586621685142080"><span class="hs-identifier hs-var">input_fn</span></a><span> </span><a href="#local-6989586621685142087"><span class="hs-identifier hs-var">output_fn</span></a><span>
</span><a name="line-1379"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><a href="#local-6989586621685142086"><span class="hs-identifier hs-var">next_phase</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685142087"><span class="hs-identifier hs-var">output_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1380"></a><span>
</span><a name="line-1381"></a><span>
</span><a name="line-1382"></a><span class="hs-comment">-- This is for calling the assembler on a split assembly file (so a collection</span><span>
</span><a name="line-1383"></a><span class="hs-comment">-- of assembly files)</span><span>
</span><a name="line-1384"></a><span class="hs-identifier">runPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-identifier hs-var">SplitAs</span><span class="hs-special">)</span><span> </span><a name="local-6989586621685142096"><a href="#local-6989586621685142096"><span class="hs-identifier">_input_fn</span></a></a><span> </span><a name="local-6989586621685142097"><a href="#local-6989586621685142097"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-1385"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1386"></a><span>        </span><span class="hs-comment">-- we'll handle the stub_o file in this phase, so don't MergeForeign,</span><span>
</span><a name="line-1387"></a><span>        </span><span class="hs-comment">-- just jump straight to StopLn afterwards.</span><span>
</span><a name="line-1388"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142098"><a href="#local-6989586621685142098"><span class="hs-identifier">next_phase</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">StopLn</span><span>
</span><a name="line-1389"></a><span>        </span><a name="local-6989586621685142099"><a href="#local-6989586621685142099"><span class="hs-identifier">output_fn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#phaseOutputFilename"><span class="hs-identifier hs-var">phaseOutputFilename</span></a><span> </span><a href="#local-6989586621685142098"><span class="hs-identifier hs-var">next_phase</span></a><span>
</span><a name="line-1390"></a><span>
</span><a name="line-1391"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142100"><a href="#local-6989586621685142100"><span class="hs-identifier">base_o</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dropExtension</span><span> </span><a href="#local-6989586621685142099"><span class="hs-identifier hs-var">output_fn</span></a><span>
</span><a name="line-1392"></a><span>            </span><a name="local-6989586621685142101"><a href="#local-6989586621685142101"><span class="hs-identifier">osuf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">objectSuf</span><span> </span><a href="#local-6989586621685142097"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1393"></a><span>            </span><a name="local-6989586621685142102"><a href="#local-6989586621685142102"><span class="hs-identifier">split_odir</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685142100"><span class="hs-identifier hs-var">base_o</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;_&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142101"><span class="hs-identifier hs-var">osuf</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;_split&quot;</span><span>
</span><a name="line-1394"></a><span>
</span><a name="line-1395"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142103"><a href="#local-6989586621685142103"><span class="hs-identifier">pic_c_flags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">picCCOpts</span><span> </span><a href="#local-6989586621685142097"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1396"></a><span>
</span><a name="line-1397"></a><span>        </span><span class="hs-comment">-- this also creates the hierarchy</span><span>
</span><a name="line-1398"></a><span>        </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">createDirectoryIfMissing</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621685142102"><span class="hs-identifier hs-var">split_odir</span></a><span>
</span><a name="line-1399"></a><span>
</span><a name="line-1400"></a><span>        </span><span class="hs-comment">-- remove M_split/ *.o, because we're going to archive M_split/ *.o</span><span>
</span><a name="line-1401"></a><span>        </span><span class="hs-comment">-- later and we don't want to pick up any old objects.</span><span>
</span><a name="line-1402"></a><span>        </span><a name="local-6989586621685142104"><a href="#local-6989586621685142104"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">getDirectoryContents</span><span> </span><a href="#local-6989586621685142102"><span class="hs-identifier hs-var">split_odir</span></a><span>
</span><a name="line-1403"></a><span>        </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-identifier hs-var">removeFile</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1404"></a><span>                </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685142102"><span class="hs-identifier hs-var">split_odir</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685142101"><span class="hs-identifier hs-var">osuf</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">isSuffixOf</span><span class="hs-special">`</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685142104"><span class="hs-identifier hs-var">fs</span></a><span>
</span><a name="line-1405"></a><span>
</span><a name="line-1406"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685142105"><a href="#local-6989586621685142105"><span class="hs-identifier">split_s_prefix</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685142106"><a href="#local-6989586621685142106"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">splitInfo</span><span> </span><a href="#local-6989586621685142097"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1407"></a><span>                                  </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;No split info&quot;</span><span>
</span><a name="line-1408"></a><span>                                  </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685142107"><a href="#local-6989586621685142107"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685142107"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-1409"></a><span>
</span><a name="line-1410"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142108"><a href="#local-6989586621685142108"><span class="hs-identifier">split_s</span></a></a><span>   </span><a name="local-6989586621685142110"><a href="#local-6989586621685142110"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685142105"><span class="hs-identifier hs-var">split_s_prefix</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;__&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621685142110"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><span class="hs-string">&quot;s&quot;</span><span>
</span><a name="line-1411"></a><span>
</span><a name="line-1412"></a><span>            </span><span class="hs-identifier">split_obj</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-1413"></a><span>            </span><a name="local-6989586621685142109"><a href="#local-6989586621685142109"><span class="hs-identifier">split_obj</span></a></a><span> </span><a name="local-6989586621685142111"><a href="#local-6989586621685142111"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685142102"><span class="hs-identifier hs-var">split_odir</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span>
</span><a name="line-1414"></a><span>                          </span><span class="hs-identifier hs-var">takeFileName</span><span> </span><a href="#local-6989586621685142100"><span class="hs-identifier hs-var">base_o</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;__&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621685142111"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><a href="#local-6989586621685142101"><span class="hs-identifier hs-var">osuf</span></a><span>
</span><a name="line-1415"></a><span>
</span><a name="line-1416"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142112"><a href="#local-6989586621685142112"><span class="hs-identifier">assemble_file</span></a></a><span> </span><a name="local-6989586621685142113"><a href="#local-6989586621685142113"><span class="hs-identifier">n</span></a></a><span>
</span><a name="line-1417"></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="SysTools.Tasks.html#runAs"><span class="hs-identifier hs-var">SysTools.runAs</span></a><span> </span><a href="#local-6989586621685142097"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span>
</span><a name="line-1418"></a><span>
</span><a name="line-1419"></a><span>        </span><span class="hs-comment">-- We only support SparcV9 and better because V8 lacks an atomic CAS</span><span>
</span><a name="line-1420"></a><span>        </span><span class="hs-comment">-- instruction so we have to make sure that the assembler accepts the</span><span>
</span><a name="line-1421"></a><span>        </span><span class="hs-comment">-- instruction set. Note that the user can still override this</span><span>
</span><a name="line-1422"></a><span>        </span><span class="hs-comment">-- (e.g., -mcpu=ultrasparc). GCC picks the &quot;best&quot; -mcpu flag</span><span>
</span><a name="line-1423"></a><span>        </span><span class="hs-comment">-- regardless of the ordering.</span><span>
</span><a name="line-1424"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-1425"></a><span>        </span><span class="hs-comment">-- This is a temporary hack.</span><span>
</span><a name="line-1426"></a><span>                          </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">platformArch</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621685142097"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">ArchSPARC</span><span>
</span><a name="line-1427"></a><span>                           </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-string">&quot;-mcpu=v9&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-1428"></a><span>                           </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1429"></a><span>
</span><a name="line-1430"></a><span>                          </span><span class="hs-comment">-- See Note [-fPIC for assembler]</span><span>
</span><a name="line-1431"></a><span>                          </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><a href="#local-6989586621685142103"><span class="hs-identifier hs-var">pic_c_flags</span></a><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1432"></a><span>
</span><a name="line-1433"></a><span>                          </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-string">&quot;-c&quot;</span><span>
</span><a name="line-1434"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-string">&quot;-o&quot;</span><span>
</span><a name="line-1435"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SysTools.FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685142109"><span class="hs-identifier hs-var">split_obj</span></a><span> </span><a href="#local-6989586621685142113"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-1436"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SysTools.FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685142108"><span class="hs-identifier hs-var">split_s</span></a><span> </span><a href="#local-6989586621685142113"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-1437"></a><span>                          </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1438"></a><span>
</span><a name="line-1439"></a><span>        </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="#local-6989586621685142112"><span class="hs-identifier hs-var">assemble_file</span></a><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-glyph">..</span><a href="#local-6989586621685142106"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">]</span><span>
</span><a name="line-1440"></a><span>
</span><a name="line-1441"></a><span>        </span><span class="hs-comment">-- Note [pipeline-split-init]</span><span>
</span><a name="line-1442"></a><span>        </span><span class="hs-comment">-- If we have a stub file -- which will be part of foreign_os --</span><span>
</span><a name="line-1443"></a><span>        </span><span class="hs-comment">--  it may contain constructor</span><span>
</span><a name="line-1444"></a><span>        </span><span class="hs-comment">-- functions for initialisation of this module.  We can't</span><span>
</span><a name="line-1445"></a><span>        </span><span class="hs-comment">-- simply leave the stub as a separate object file, because it</span><span>
</span><a name="line-1446"></a><span>        </span><span class="hs-comment">-- will never be linked in: nothing refers to it.  We need to</span><span>
</span><a name="line-1447"></a><span>        </span><span class="hs-comment">-- ensure that if we ever refer to the data in this module</span><span>
</span><a name="line-1448"></a><span>        </span><span class="hs-comment">-- that needs initialisation, then we also pull in the</span><span>
</span><a name="line-1449"></a><span>        </span><span class="hs-comment">-- initialisation routine.</span><span>
</span><a name="line-1450"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-1451"></a><span>        </span><span class="hs-comment">-- To that end, we make a DANGEROUS ASSUMPTION here: the data</span><span>
</span><a name="line-1452"></a><span>        </span><span class="hs-comment">-- that needs to be initialised is all in the FIRST split</span><span>
</span><a name="line-1453"></a><span>        </span><span class="hs-comment">-- object.  See Note [codegen-split-init].</span><span>
</span><a name="line-1454"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-1455"></a><span>        </span><span class="hs-comment">-- We also merge in all the foreign objects since we're at it.</span><span>
</span><a name="line-1456"></a><span>
</span><a name="line-1457"></a><span>        </span><span class="hs-identifier hs-var">PipeState</span><span class="hs-special">{</span><a name="local-6989586621685142114"><a href="#local-6989586621685142114"><span class="hs-identifier">foreign_os</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getPipeState</span><span>
</span><a name="line-1458"></a><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621685142114"><span class="hs-identifier hs-var">foreign_os</span></a><span>
</span><a name="line-1459"></a><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1460"></a><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1461"></a><span>             </span><a name="local-6989586621685142115"><a href="#local-6989586621685142115"><span class="hs-identifier">tmp_split_1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newTempName</span><span> </span><a href="#local-6989586621685142097"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">TFL_CurrentModule</span><span> </span><a href="#local-6989586621685142101"><span class="hs-identifier hs-var">osuf</span></a><span>
</span><a name="line-1462"></a><span>             </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142116"><a href="#local-6989586621685142116"><span class="hs-identifier">split_1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685142109"><span class="hs-identifier hs-var">split_obj</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-1463"></a><span>             </span><span class="hs-identifier hs-var">copyFile</span><span> </span><a href="#local-6989586621685142116"><span class="hs-identifier hs-var">split_1</span></a><span> </span><a href="#local-6989586621685142115"><span class="hs-identifier hs-var">tmp_split_1</span></a><span>
</span><a name="line-1464"></a><span>             </span><span class="hs-identifier hs-var">removeFile</span><span> </span><a href="#local-6989586621685142116"><span class="hs-identifier hs-var">split_1</span></a><span>
</span><a name="line-1465"></a><span>             </span><a href="DriverPipeline.html#joinObjectFiles"><span class="hs-identifier hs-var">joinObjectFiles</span></a><span> </span><a href="#local-6989586621685142097"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621685142115"><span class="hs-identifier hs-var">tmp_split_1</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621685142114"><span class="hs-identifier hs-var">foreign_os</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685142116"><span class="hs-identifier hs-var">split_1</span></a><span>
</span><a name="line-1466"></a><span>
</span><a name="line-1467"></a><span>        </span><span class="hs-comment">-- join them into a single .o file</span><span>
</span><a name="line-1468"></a><span>        </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="DriverPipeline.html#joinObjectFiles"><span class="hs-identifier hs-var">joinObjectFiles</span></a><span> </span><a href="#local-6989586621685142097"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621685142109"><span class="hs-identifier hs-var">split_obj</span></a><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-glyph">..</span><a href="#local-6989586621685142106"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685142099"><span class="hs-identifier hs-var">output_fn</span></a><span>
</span><a name="line-1469"></a><span>
</span><a name="line-1470"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><a href="#local-6989586621685142098"><span class="hs-identifier hs-var">next_phase</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685142099"><span class="hs-identifier hs-var">output_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1471"></a><span>
</span><a name="line-1472"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-1473"></a><span class="hs-comment">-- LlvmOpt phase</span><span>
</span><a name="line-1474"></a><span class="hs-identifier">runPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-identifier hs-var">LlvmOpt</span><span class="hs-special">)</span><span> </span><a name="local-6989586621685142117"><a href="#local-6989586621685142117"><span class="hs-identifier">input_fn</span></a></a><span> </span><a name="local-6989586621685142118"><a href="#local-6989586621685142118"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-1475"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1476"></a><span>    </span><a name="local-6989586621685142124"><a href="#local-6989586621685142124"><span class="hs-identifier">output_fn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#phaseOutputFilename"><span class="hs-identifier hs-var">phaseOutputFilename</span></a><span> </span><span class="hs-identifier hs-var">LlvmLlc</span><span>
</span><a name="line-1477"></a><span>
</span><a name="line-1478"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="SysTools.Tasks.html#runLlvmOpt"><span class="hs-identifier hs-var">SysTools.runLlvmOpt</span></a><span> </span><a href="#local-6989586621685142118"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1479"></a><span>               </span><span class="hs-special">(</span><span>   </span><a href="#local-6989586621685142121"><span class="hs-identifier hs-var">optFlag</span></a><span>
</span><a name="line-1480"></a><span>                </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142122"><span class="hs-identifier hs-var">defaultOptions</span></a><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1481"></a><span>                </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">SysTools.FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621685142117"><span class="hs-identifier hs-var">input_fn</span></a><span>
</span><a name="line-1482"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-string">&quot;-o&quot;</span><span>
</span><a name="line-1483"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SysTools.FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621685142124"><span class="hs-identifier hs-var">output_fn</span></a><span class="hs-special">]</span><span>
</span><a name="line-1484"></a><span>                </span><span class="hs-special">)</span><span>
</span><a name="line-1485"></a><span>
</span><a name="line-1486"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-identifier hs-var">LlvmLlc</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685142124"><span class="hs-identifier hs-var">output_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1487"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1488"></a><span>        </span><span class="hs-comment">-- we always (unless -optlo specified) run Opt since we rely on it to</span><span>
</span><a name="line-1489"></a><span>        </span><span class="hs-comment">-- fix up some pretty big deficiencies in the code we generate</span><span>
</span><a name="line-1490"></a><span>        </span><a name="local-6989586621685142119"><a href="#local-6989586621685142119"><span class="hs-identifier">optIdx</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">max</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">min</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">optLevel</span><span> </span><a href="#local-6989586621685142118"><span class="hs-identifier hs-var">dflags</span></a><span>  </span><span class="hs-comment">-- ensure we're in [0,2]</span><span>
</span><a name="line-1491"></a><span>        </span><a name="local-6989586621685142120"><a href="#local-6989586621685142120"><span class="hs-identifier">llvmOpts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621685142119"><span class="hs-identifier hs-var">optIdx</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">llvmPasses</span><span> </span><a href="#local-6989586621685142118"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1492"></a><span>                    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685142123"><a href="#local-6989586621685142123"><span class="hs-identifier">passes</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685142123"><span class="hs-identifier hs-var">passes</span></a><span>
</span><a name="line-1493"></a><span>                    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;runPhase LlvmOpt: llvm-passes file &quot;</span><span>
</span><a name="line-1494"></a><span>                                      </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;is missing passes for level &quot;</span><span>
</span><a name="line-1495"></a><span>                                      </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621685142119"><span class="hs-identifier hs-var">optIdx</span></a><span class="hs-special">)</span><span>
</span><a name="line-1496"></a><span>
</span><a name="line-1497"></a><span>        </span><span class="hs-comment">-- don't specify anything if user has specified commands. We do this</span><span>
</span><a name="line-1498"></a><span>        </span><span class="hs-comment">-- for opt but not llc since opt is very specifically for optimisation</span><span>
</span><a name="line-1499"></a><span>        </span><span class="hs-comment">-- passes only, so if the user is passing us extra options we assume</span><span>
</span><a name="line-1500"></a><span>        </span><span class="hs-comment">-- they know what they are doing and don't get in the way.</span><span>
</span><a name="line-1501"></a><span>        </span><a name="local-6989586621685142121"><a href="#local-6989586621685142121"><span class="hs-identifier">optFlag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOpts</span><span> </span><a href="#local-6989586621685142118"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">opt_lo</span><span class="hs-special">)</span><span>
</span><a name="line-1502"></a><span>                  </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">words</span><span> </span><a href="#local-6989586621685142120"><span class="hs-identifier hs-var">llvmOpts</span></a><span>
</span><a name="line-1503"></a><span>                  </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1504"></a><span>
</span><a name="line-1505"></a><span>        </span><a name="local-6989586621685142122"><a href="#local-6989586621685142122"><span class="hs-identifier">defaultOptions</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">words</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span>
</span><a name="line-1506"></a><span>                       </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><span class="hs-special">(</span><a href="DriverPipeline.html#llvmOptions"><span class="hs-identifier hs-var">llvmOptions</span></a><span> </span><a href="#local-6989586621685142118"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1507"></a><span>
</span><a name="line-1508"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-1509"></a><span class="hs-comment">-- LlvmLlc phase</span><span>
</span><a name="line-1510"></a><span>
</span><a name="line-1511"></a><span class="hs-identifier">runPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-identifier hs-var">LlvmLlc</span><span class="hs-special">)</span><span> </span><a name="local-6989586621685142125"><a href="#local-6989586621685142125"><span class="hs-identifier">input_fn</span></a></a><span> </span><a name="local-6989586621685142126"><a href="#local-6989586621685142126"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-1512"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1513"></a><span>    </span><a name="local-6989586621685142130"><a href="#local-6989586621685142130"><span class="hs-identifier">next_phase</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="DriverPipeline.html#fastLlvmPipeline"><span class="hs-identifier hs-var">fastLlvmPipeline</span></a><span> </span><a href="#local-6989586621685142126"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1514"></a><span>                  </span><span class="hs-keyword">then</span><span> </span><a href="DriverPipeline.html#maybeMergeForeign"><span class="hs-identifier hs-var">maybeMergeForeign</span></a><span>
</span><a name="line-1515"></a><span>                  </span><span class="hs-comment">-- hidden debugging flag '-dno-llvm-mangler' to skip mangling</span><span>
</span><a name="line-1516"></a><span>                  </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_NoLlvmMangler</span><span> </span><a href="#local-6989586621685142126"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1517"></a><span>                         </span><span class="hs-identifier hs-var">False</span><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">LlvmMangle</span><span>
</span><a name="line-1518"></a><span>                         </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_SplitObjs</span><span> </span><a href="#local-6989586621685142126"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Splitter</span><span>
</span><a name="line-1519"></a><span>                         </span><span class="hs-identifier hs-var">True</span><span>                             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">As</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span>
</span><a name="line-1520"></a><span>
</span><a name="line-1521"></a><span>    </span><a name="local-6989586621685142131"><a href="#local-6989586621685142131"><span class="hs-identifier">output_fn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#phaseOutputFilename"><span class="hs-identifier hs-var">phaseOutputFilename</span></a><span> </span><a href="#local-6989586621685142130"><span class="hs-identifier hs-var">next_phase</span></a><span>
</span><a name="line-1522"></a><span>
</span><a name="line-1523"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="SysTools.Tasks.html#runLlvmLlc"><span class="hs-identifier hs-var">SysTools.runLlvmLlc</span></a><span> </span><a href="#local-6989586621685142126"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1524"></a><span>                </span><span class="hs-special">(</span><span>  </span><a href="#local-6989586621685142128"><span class="hs-identifier hs-var">optFlag</span></a><span>
</span><a name="line-1525"></a><span>                </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142129"><span class="hs-identifier hs-var">defaultOptions</span></a><span>
</span><a name="line-1526"></a><span>                </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">SysTools.FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621685142125"><span class="hs-identifier hs-var">input_fn</span></a><span>
</span><a name="line-1527"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-string">&quot;-o&quot;</span><span>
</span><a name="line-1528"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SysTools.FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621685142131"><span class="hs-identifier hs-var">output_fn</span></a><span>
</span><a name="line-1529"></a><span>                   </span><span class="hs-special">]</span><span>
</span><a name="line-1530"></a><span>                </span><span class="hs-special">)</span><span>
</span><a name="line-1531"></a><span>
</span><a name="line-1532"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><a href="#local-6989586621685142130"><span class="hs-identifier hs-var">next_phase</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685142131"><span class="hs-identifier hs-var">output_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1533"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1534"></a><span>    </span><span class="hs-comment">-- Note [Clamping of llc optimizations]</span><span>
</span><a name="line-1535"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1536"></a><span>    </span><span class="hs-comment">-- See #13724</span><span>
</span><a name="line-1537"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1538"></a><span>    </span><span class="hs-comment">-- we clamp the llc optimization between [1,2]. This is because passing -O0</span><span>
</span><a name="line-1539"></a><span>    </span><span class="hs-comment">-- to llc 3.9 or llc 4.0, the naive register allocator can fail with</span><span>
</span><a name="line-1540"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1541"></a><span>    </span><span class="hs-comment">--   Error while trying to spill R1 from class GPR: Cannot scavenge register</span><span>
</span><a name="line-1542"></a><span>    </span><span class="hs-comment">--   without an emergency spill slot!</span><span>
</span><a name="line-1543"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1544"></a><span>    </span><span class="hs-comment">-- Observed at least with target 'arm-unknown-linux-gnueabihf'.</span><span>
</span><a name="line-1545"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1546"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1547"></a><span>    </span><span class="hs-comment">-- With LLVM4, llc -O3 crashes when ghc-stage1 tries to compile</span><span>
</span><a name="line-1548"></a><span>    </span><span class="hs-comment">--   rts/HeapStackCheck.cmm</span><span>
</span><a name="line-1549"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1550"></a><span>    </span><span class="hs-comment">-- llc -O3 '-mtriple=arm-unknown-linux-gnueabihf' -enable-tbaa /var/folders/fv/xqjrpfj516n5xq_m_ljpsjx00000gn/T/ghc33674_0/ghc_6.bc -o /var/folders/fv/xqjrpfj516n5xq_m_ljpsjx00000gn/T/ghc33674_0/ghc_7.lm_s</span><span>
</span><a name="line-1551"></a><span>    </span><span class="hs-comment">-- 0  llc                      0x0000000102ae63e8 llvm::sys::PrintStackTrace(llvm::raw_ostream&amp;) + 40</span><span>
</span><a name="line-1552"></a><span>    </span><span class="hs-comment">-- 1  llc                      0x0000000102ae69a6 SignalHandler(int) + 358</span><span>
</span><a name="line-1553"></a><span>    </span><span class="hs-comment">-- 2  libsystem_platform.dylib 0x00007fffc23f4b3a _sigtramp + 26</span><span>
</span><a name="line-1554"></a><span>    </span><span class="hs-comment">-- 3  libsystem_c.dylib        0x00007fffc226498b __vfprintf + 17876</span><span>
</span><a name="line-1555"></a><span>    </span><span class="hs-comment">-- 4  llc                      0x00000001029d5123 llvm::SelectionDAGISel::LowerArguments(llvm::Function const&amp;) + 5699</span><span>
</span><a name="line-1556"></a><span>    </span><span class="hs-comment">-- 5  llc                      0x0000000102a21a35 llvm::SelectionDAGISel::SelectAllBasicBlocks(llvm::Function const&amp;) + 3381</span><span>
</span><a name="line-1557"></a><span>    </span><span class="hs-comment">-- 6  llc                      0x0000000102a202b1 llvm::SelectionDAGISel::runOnMachineFunction(llvm::MachineFunction&amp;) + 1457</span><span>
</span><a name="line-1558"></a><span>    </span><span class="hs-comment">-- 7  llc                      0x0000000101bdc474 (anonymous namespace)::ARMDAGToDAGISel::runOnMachineFunction(llvm::MachineFunction&amp;) + 20</span><span>
</span><a name="line-1559"></a><span>    </span><span class="hs-comment">-- 8  llc                      0x00000001025573a6 llvm::MachineFunctionPass::runOnFunction(llvm::Function&amp;) + 134</span><span>
</span><a name="line-1560"></a><span>    </span><span class="hs-comment">-- 9  llc                      0x000000010274fb12 llvm::FPPassManager::runOnFunction(llvm::Function&amp;) + 498</span><span>
</span><a name="line-1561"></a><span>    </span><span class="hs-comment">-- 10 llc                      0x000000010274fd23 llvm::FPPassManager::runOnModule(llvm::Module&amp;) + 67</span><span>
</span><a name="line-1562"></a><span>    </span><span class="hs-comment">-- 11 llc                      0x00000001027501b8 llvm::legacy::PassManagerImpl::run(llvm::Module&amp;) + 920</span><span>
</span><a name="line-1563"></a><span>    </span><span class="hs-comment">-- 12 llc                      0x000000010195f075 compileModule(char**, llvm::LLVMContext&amp;) + 12133</span><span>
</span><a name="line-1564"></a><span>    </span><span class="hs-comment">-- 13 llc                      0x000000010195bf0b main + 491</span><span>
</span><a name="line-1565"></a><span>    </span><span class="hs-comment">-- 14 libdyld.dylib            0x00007fffc21e5235 start + 1</span><span>
</span><a name="line-1566"></a><span>    </span><span class="hs-comment">-- Stack dump:</span><span>
</span><a name="line-1567"></a><span>    </span><span class="hs-comment">-- 0.  Program arguments: llc -O3 -mtriple=arm-unknown-linux-gnueabihf -enable-tbaa /var/folders/fv/xqjrpfj516n5xq_m_ljpsjx00000gn/T/ghc33674_0/ghc_6.bc -o /var/folders/fv/xqjrpfj516n5xq_m_ljpsjx00000gn/T/ghc33674_0/ghc_7.lm_s</span><span>
</span><a name="line-1568"></a><span>    </span><span class="hs-comment">-- 1.  Running pass 'Function Pass Manager' on module '/var/folders/fv/xqjrpfj516n5xq_m_ljpsjx00000gn/T/ghc33674_0/ghc_6.bc'.</span><span>
</span><a name="line-1569"></a><span>    </span><span class="hs-comment">-- 2.  Running pass 'ARM Instruction Selection' on function '@&quot;stg_gc_f1$def&quot;'</span><span>
</span><a name="line-1570"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1571"></a><span>    </span><span class="hs-comment">-- Observed at least with -mtriple=arm-unknown-linux-gnueabihf -enable-tbaa</span><span>
</span><a name="line-1572"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1573"></a><span>    </span><a name="local-6989586621685142127"><a href="#local-6989586621685142127"><span class="hs-identifier">llvmOpts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">optLevel</span><span> </span><a href="#local-6989586621685142126"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1574"></a><span>      </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;-O1&quot;</span><span> </span><span class="hs-comment">-- required to get the non-naive reg allocator. Passing -regalloc=greedy is not sufficient.</span><span>
</span><a name="line-1575"></a><span>      </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;-O1&quot;</span><span>
</span><a name="line-1576"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;-O2&quot;</span><span>
</span><a name="line-1577"></a><span>
</span><a name="line-1578"></a><span>    </span><a name="local-6989586621685142128"><a href="#local-6989586621685142128"><span class="hs-identifier">optFlag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOpts</span><span> </span><a href="#local-6989586621685142126"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">opt_lc</span><span class="hs-special">)</span><span>
</span><a name="line-1579"></a><span>              </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">words</span><span> </span><a href="#local-6989586621685142127"><span class="hs-identifier hs-var">llvmOpts</span></a><span>
</span><a name="line-1580"></a><span>              </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1581"></a><span>
</span><a name="line-1582"></a><span>    </span><a name="local-6989586621685142129"><a href="#local-6989586621685142129"><span class="hs-identifier">defaultOptions</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">words</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">snd</span><span>
</span><a name="line-1583"></a><span>                   </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><span class="hs-special">(</span><a href="DriverPipeline.html#llvmOptions"><span class="hs-identifier hs-var">llvmOptions</span></a><span> </span><a href="#local-6989586621685142126"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1584"></a><span>
</span><a name="line-1585"></a><span>
</span><a name="line-1586"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-1587"></a><span class="hs-comment">-- LlvmMangle phase</span><span>
</span><a name="line-1588"></a><span>
</span><a name="line-1589"></a><span class="hs-identifier">runPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-identifier hs-var">LlvmMangle</span><span class="hs-special">)</span><span> </span><a name="local-6989586621685142132"><a href="#local-6989586621685142132"><span class="hs-identifier">input_fn</span></a></a><span> </span><a name="local-6989586621685142133"><a href="#local-6989586621685142133"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-1590"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1591"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142134"><a href="#local-6989586621685142134"><span class="hs-identifier">next_phase</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_SplitObjs</span><span> </span><a href="#local-6989586621685142133"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Splitter</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">As</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1592"></a><span>      </span><a name="local-6989586621685142135"><a href="#local-6989586621685142135"><span class="hs-identifier">output_fn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#phaseOutputFilename"><span class="hs-identifier hs-var">phaseOutputFilename</span></a><span> </span><a href="#local-6989586621685142134"><span class="hs-identifier hs-var">next_phase</span></a><span>
</span><a name="line-1593"></a><span>      </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="LlvmMangler.html#llvmFixupAsm"><span class="hs-identifier hs-var">llvmFixupAsm</span></a><span> </span><a href="#local-6989586621685142133"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685142132"><span class="hs-identifier hs-var">input_fn</span></a><span> </span><a href="#local-6989586621685142135"><span class="hs-identifier hs-var">output_fn</span></a><span>
</span><a name="line-1594"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><a href="#local-6989586621685142134"><span class="hs-identifier hs-var">next_phase</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685142135"><span class="hs-identifier hs-var">output_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1595"></a><span>
</span><a name="line-1596"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-1597"></a><span class="hs-comment">-- merge in stub objects</span><span>
</span><a name="line-1598"></a><span>
</span><a name="line-1599"></a><span class="hs-identifier">runPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-identifier hs-var">MergeForeign</span><span class="hs-special">)</span><span> </span><a name="local-6989586621685142136"><a href="#local-6989586621685142136"><span class="hs-identifier">input_fn</span></a></a><span> </span><a name="local-6989586621685142137"><a href="#local-6989586621685142137"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-1600"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1601"></a><span>     </span><span class="hs-identifier hs-var">PipeState</span><span class="hs-special">{</span><a name="local-6989586621685142138"><a href="#local-6989586621685142138"><span class="hs-identifier">foreign_os</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getPipeState</span><span>
</span><a name="line-1602"></a><span>     </span><a name="local-6989586621685142139"><a href="#local-6989586621685142139"><span class="hs-identifier">output_fn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#phaseOutputFilename"><span class="hs-identifier hs-var">phaseOutputFilename</span></a><span> </span><span class="hs-identifier hs-var">StopLn</span><span>
</span><a name="line-1603"></a><span>     </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">createDirectoryIfMissing</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">takeDirectory</span><span> </span><a href="#local-6989586621685142139"><span class="hs-identifier hs-var">output_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1604"></a><span>     </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621685142138"><span class="hs-identifier hs-var">foreign_os</span></a><span>
</span><a name="line-1605"></a><span>       </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;runPhase(MergeForeign): no foreign objects&quot;</span><span>
</span><a name="line-1606"></a><span>       </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1607"></a><span>         </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="DriverPipeline.html#joinObjectFiles"><span class="hs-identifier hs-var">joinObjectFiles</span></a><span> </span><a href="#local-6989586621685142137"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621685142136"><span class="hs-identifier hs-var">input_fn</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621685142138"><span class="hs-identifier hs-var">foreign_os</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685142139"><span class="hs-identifier hs-var">output_fn</span></a><span>
</span><a name="line-1608"></a><span>         </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><span class="hs-identifier hs-var">StopLn</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685142139"><span class="hs-identifier hs-var">output_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1609"></a><span>
</span><a name="line-1610"></a><span class="hs-comment">-- warning suppression</span><span>
</span><a name="line-1611"></a><span class="hs-identifier">runPhase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealPhase</span><span> </span><a name="local-6989586621685142140"><a href="#local-6989586621685142140"><span class="hs-identifier">other</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621685142141"><a href="#local-6989586621685142141"><span class="hs-identifier">_input_fn</span></a></a><span> </span><a name="local-6989586621685142142"><a href="#local-6989586621685142142"><span class="hs-identifier">_dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1612"></a><span>   </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;runPhase: don't know how to run phase &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621685142140"><span class="hs-identifier hs-var">other</span></a><span class="hs-special">)</span><span>
</span><a name="line-1613"></a><span>
</span><a name="line-1614"></a><span class="hs-identifier">maybeMergeForeign</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CompPipeline</span><span> </span><span class="hs-identifier hs-type">Phase</span><span>
</span><a name="line-1615"></a><a name="maybeMergeForeign"><a href="DriverPipeline.html#maybeMergeForeign"><span class="hs-identifier">maybeMergeForeign</span></a></a><span>
</span><a name="line-1616"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1617"></a><span>     </span><span class="hs-identifier hs-var">PipeState</span><span class="hs-special">{</span><a name="local-6989586621685142143"><a href="#local-6989586621685142143"><span class="hs-identifier">foreign_os</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getPipeState</span><span>
</span><a name="line-1618"></a><span>     </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621685142143"><span class="hs-identifier hs-var">foreign_os</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">StopLn</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">MergeForeign</span><span>
</span><a name="line-1619"></a><span>
</span><a name="line-1620"></a><span class="hs-identifier">getLocation</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscSource</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CompPipeline</span><span> </span><span class="hs-identifier hs-type">ModLocation</span><span>
</span><a name="line-1621"></a><a name="getLocation"><a href="DriverPipeline.html#getLocation"><span class="hs-identifier">getLocation</span></a></a><span> </span><a name="local-6989586621685142144"><a href="#local-6989586621685142144"><span class="hs-identifier">src_flavour</span></a></a><span> </span><a name="local-6989586621685142145"><a href="#local-6989586621685142145"><span class="hs-identifier">mod_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1622"></a><span>    </span><a name="local-6989586621685142146"><a href="#local-6989586621685142146"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1623"></a><span>
</span><a name="line-1624"></a><span>    </span><span class="hs-identifier hs-var">PipeEnv</span><span class="hs-special">{</span><span> </span><span class="hs-identifier">src_basename</span><span class="hs-glyph">=</span><a name="local-6989586621685142147"><a href="#local-6989586621685142147"><span class="hs-identifier">basename</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1625"></a><span>             </span><span class="hs-identifier">src_suffix</span><span class="hs-glyph">=</span><a name="local-6989586621685142148"><a href="#local-6989586621685142148"><span class="hs-identifier">suff</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getPipeEnv</span><span>
</span><a name="line-1626"></a><span>    </span><span class="hs-identifier hs-var">PipeState</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">maybe_loc</span><span class="hs-glyph">=</span><a name="local-6989586621685142149"><a href="#local-6989586621685142149"><span class="hs-identifier">maybe_loc</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getPipeState</span><span>
</span><a name="line-1627"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685142149"><span class="hs-identifier hs-var">maybe_loc</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1628"></a><span>        </span><span class="hs-comment">-- Build a ModLocation to pass to hscMain.</span><span>
</span><a name="line-1629"></a><span>        </span><span class="hs-comment">-- The source filename is rather irrelevant by now, but it's used</span><span>
</span><a name="line-1630"></a><span>        </span><span class="hs-comment">-- by hscMain for messages.  hscMain also needs</span><span>
</span><a name="line-1631"></a><span>        </span><span class="hs-comment">-- the .hi and .o filenames. If we already have a ModLocation</span><span>
</span><a name="line-1632"></a><span>        </span><span class="hs-comment">-- then simply update the extensions of the interface and object</span><span>
</span><a name="line-1633"></a><span>        </span><span class="hs-comment">-- files to match the DynFlags, otherwise use the logic in Finder.</span><span>
</span><a name="line-1634"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685142150"><a href="#local-6989586621685142150"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621685142150"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-1635"></a><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ml_hs_file</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621685142147"><span class="hs-identifier hs-var">basename</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><a href="#local-6989586621685142148"><span class="hs-identifier hs-var">suff</span></a><span>
</span><a name="line-1636"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ml_hi_file</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ml_hi_file</span><span> </span><a href="#local-6989586621685142150"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">-&lt;.&gt;</span><span> </span><span class="hs-identifier">hiSuf</span><span> </span><a href="#local-6989586621685142146"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1637"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ml_obj_file</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ml_obj_file</span><span> </span><a href="#local-6989586621685142150"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">-&lt;.&gt;</span><span> </span><span class="hs-identifier">objectSuf</span><span> </span><a href="#local-6989586621685142146"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1638"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-1639"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1640"></a><span>        </span><a name="local-6989586621685142151"><a href="#local-6989586621685142151"><span class="hs-identifier">location1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Finder.html#mkHomeModLocation2"><span class="hs-identifier hs-var">mkHomeModLocation2</span></a><span> </span><a href="#local-6989586621685142146"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685142145"><span class="hs-identifier hs-var">mod_name</span></a><span> </span><a href="#local-6989586621685142147"><span class="hs-identifier hs-var">basename</span></a><span> </span><a href="#local-6989586621685142148"><span class="hs-identifier hs-var">suff</span></a><span>
</span><a name="line-1641"></a><span>
</span><a name="line-1642"></a><span>        </span><span class="hs-comment">-- Boot-ify it if necessary</span><span>
</span><a name="line-1643"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142152"><a href="#local-6989586621685142152"><span class="hs-identifier">location2</span></a></a><span>
</span><a name="line-1644"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">HsBootFile</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685142144"><span class="hs-identifier hs-var">src_flavour</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addBootSuffixLocnOut</span><span> </span><a href="#local-6989586621685142151"><span class="hs-identifier hs-var">location1</span></a><span>
</span><a name="line-1645"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685142151"><span class="hs-identifier hs-var">location1</span></a><span>
</span><a name="line-1646"></a><span>
</span><a name="line-1647"></a><span>
</span><a name="line-1648"></a><span>        </span><span class="hs-comment">-- Take -ohi into account if present</span><span>
</span><a name="line-1649"></a><span>        </span><span class="hs-comment">-- This can't be done in mkHomeModuleLocation because</span><span>
</span><a name="line-1650"></a><span>        </span><span class="hs-comment">-- it only applies to the module being compiles</span><span>
</span><a name="line-1651"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142153"><a href="#local-6989586621685142153"><span class="hs-identifier">ohi</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">outputHi</span><span> </span><a href="#local-6989586621685142146"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1652"></a><span>            </span><a name="local-6989586621685142154"><a href="#local-6989586621685142154"><span class="hs-identifier">location3</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685142155"><a href="#local-6989586621685142155"><span class="hs-identifier">fn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685142153"><span class="hs-identifier hs-var">ohi</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685142152"><span class="hs-identifier hs-var">location2</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">ml_hi_file</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685142155"><span class="hs-identifier hs-var">fn</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1653"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685142152"><span class="hs-identifier hs-var">location2</span></a><span>
</span><a name="line-1654"></a><span>
</span><a name="line-1655"></a><span>        </span><span class="hs-comment">-- Take -o into account if present</span><span>
</span><a name="line-1656"></a><span>        </span><span class="hs-comment">-- Very like -ohi, but we must *only* do this if we aren't linking</span><span>
</span><a name="line-1657"></a><span>        </span><span class="hs-comment">-- (If we're linking then the -o applies to the linked thing, not to</span><span>
</span><a name="line-1658"></a><span>        </span><span class="hs-comment">-- the object file for one module.)</span><span>
</span><a name="line-1659"></a><span>        </span><span class="hs-comment">-- Note the nasty duplication with the same computation in compileFile</span><span>
</span><a name="line-1660"></a><span>        </span><span class="hs-comment">-- above</span><span>
</span><a name="line-1661"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142156"><a href="#local-6989586621685142156"><span class="hs-identifier">expl_o_file</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">outputFile</span><span> </span><a href="#local-6989586621685142146"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1662"></a><span>            </span><a name="local-6989586621685142157"><a href="#local-6989586621685142157"><span class="hs-identifier">location4</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685142158"><a href="#local-6989586621685142158"><span class="hs-identifier">ofile</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685142156"><span class="hs-identifier hs-var">expl_o_file</span></a><span>
</span><a name="line-1663"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isNoLink</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ghcLink</span><span> </span><a href="#local-6989586621685142146"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1664"></a><span>                      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685142154"><span class="hs-identifier hs-var">location3</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ml_obj_file</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685142158"><span class="hs-identifier hs-var">ofile</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1665"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685142154"><span class="hs-identifier hs-var">location3</span></a><span>
</span><a name="line-1666"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685142157"><span class="hs-identifier hs-var">location4</span></a><span>
</span><a name="line-1667"></a><span>
</span><a name="line-1668"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-1669"></a><span class="hs-comment">-- Look for the /* GHC_PACKAGES ... */ comment at the top of a .hc file</span><span>
</span><a name="line-1670"></a><span>
</span><a name="line-1671"></a><span class="hs-identifier">getHCFilePackages</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">InstalledUnitId</span><span class="hs-special">]</span><span>
</span><a name="line-1672"></a><a name="getHCFilePackages"><a href="DriverPipeline.html#getHCFilePackages"><span class="hs-identifier">getHCFilePackages</span></a></a><span> </span><a name="local-6989586621685142159"><a href="#local-6989586621685142159"><span class="hs-identifier">filename</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1673"></a><span>  </span><span class="hs-identifier hs-var">Exception.bracket</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">openFile</span><span> </span><a href="#local-6989586621685142159"><span class="hs-identifier hs-var">filename</span></a><span> </span><span class="hs-identifier hs-var">ReadMode</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">hClose</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685142160"><a href="#local-6989586621685142160"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1674"></a><span>    </span><a name="local-6989586621685142161"><a href="#local-6989586621685142161"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">hGetLine</span><span> </span><a href="#local-6989586621685142160"><span class="hs-identifier hs-var">h</span></a><span>
</span><a name="line-1675"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685142161"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1676"></a><span>      </span><span class="hs-char">'/'</span><span class="hs-glyph">:</span><span class="hs-char">'*'</span><span class="hs-glyph">:</span><span class="hs-char">' '</span><span class="hs-glyph">:</span><span class="hs-char">'G'</span><span class="hs-glyph">:</span><span class="hs-char">'H'</span><span class="hs-glyph">:</span><span class="hs-char">'C'</span><span class="hs-glyph">:</span><span class="hs-char">'_'</span><span class="hs-glyph">:</span><span class="hs-char">'P'</span><span class="hs-glyph">:</span><span class="hs-char">'A'</span><span class="hs-glyph">:</span><span class="hs-char">'C'</span><span class="hs-glyph">:</span><span class="hs-char">'K'</span><span class="hs-glyph">:</span><span class="hs-char">'A'</span><span class="hs-glyph">:</span><span class="hs-char">'G'</span><span class="hs-glyph">:</span><span class="hs-char">'E'</span><span class="hs-glyph">:</span><span class="hs-char">'S'</span><span class="hs-glyph">:</span><a name="local-6989586621685142162"><a href="#local-6989586621685142162"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1677"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">stringToInstalledUnitId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">words</span><span> </span><a href="#local-6989586621685142162"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1678"></a><span>      </span><a name="local-6989586621685142163"><a href="#local-6989586621685142163"><span class="hs-identifier">_other</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1679"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1680"></a><span>
</span><a name="line-1681"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-1682"></a><span class="hs-comment">-- Static linking, of .o files</span><span>
</span><a name="line-1683"></a><span>
</span><a name="line-1684"></a><span class="hs-comment">-- The list of packages passed to link is the list of packages on</span><span>
</span><a name="line-1685"></a><span class="hs-comment">-- which this program depends, as discovered by the compilation</span><span>
</span><a name="line-1686"></a><span class="hs-comment">-- manager.  It is combined with the list of packages that the user</span><span>
</span><a name="line-1687"></a><span class="hs-comment">-- specifies on the command line with -package flags.</span><span>
</span><a name="line-1688"></a><span class="hs-comment">--</span><span>
</span><a name="line-1689"></a><span class="hs-comment">-- In one-shot linking mode, we can't discover the package</span><span>
</span><a name="line-1690"></a><span class="hs-comment">-- dependencies (because we haven't actually done any compilation or</span><span>
</span><a name="line-1691"></a><span class="hs-comment">-- read any interface files), so the user must explicitly specify all</span><span>
</span><a name="line-1692"></a><span class="hs-comment">-- the packages.</span><span>
</span><a name="line-1693"></a><span>
</span><a name="line-1694"></a><span class="hs-comment">{-
Note [-Xlinker -rpath vs -Wl,-rpath]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

-Wl takes a comma-separated list of options which in the case of
-Wl,-rpath -Wl,some,path,with,commas parses the path with commas
as separate options.
Buck, the build system, produces paths with commas in them.

-Xlinker doesn't have this disadvantage and as far as I can tell
it is supported by both gcc and clang. Anecdotally nvcc supports
-Xlinker, but not -Wl.
-}</span><span>
</span><a name="line-1707"></a><span>
</span><a name="line-1708"></a><span class="hs-identifier">linkBinary</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">InstalledUnitId</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1709"></a><a name="linkBinary"><a href="DriverPipeline.html#linkBinary"><span class="hs-identifier">linkBinary</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DriverPipeline.html#linkBinary%27"><span class="hs-identifier hs-var">linkBinary'</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1710"></a><span>
</span><a name="line-1711"></a><span class="hs-identifier">linkBinary'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">InstalledUnitId</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1712"></a><a name="linkBinary%27"><a href="DriverPipeline.html#linkBinary%27"><span class="hs-identifier">linkBinary'</span></a></a><span> </span><a name="local-6989586621685142164"><a href="#local-6989586621685142164"><span class="hs-identifier">staticLink</span></a></a><span> </span><a name="local-6989586621685142165"><a href="#local-6989586621685142165"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685142166"><a href="#local-6989586621685142166"><span class="hs-identifier">o_files</span></a></a><span> </span><a name="local-6989586621685142167"><a href="#local-6989586621685142167"><span class="hs-identifier">dep_packages</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1713"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142168"><a href="#local-6989586621685142168"><span class="hs-identifier">platform</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1714"></a><span>        </span><a name="local-6989586621685142169"><a href="#local-6989586621685142169"><span class="hs-identifier">mySettings</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">settings</span><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1715"></a><span>        </span><a name="local-6989586621685142170"><a href="#local-6989586621685142170"><span class="hs-identifier">verbFlags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getVerbFlags</span><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1716"></a><span>        </span><a name="local-6989586621685142171"><a href="#local-6989586621685142171"><span class="hs-identifier">output_fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DriverPipeline.html#exeFileName"><span class="hs-identifier hs-var">exeFileName</span></a><span> </span><a href="#local-6989586621685142164"><span class="hs-identifier hs-var">staticLink</span></a><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1717"></a><span>
</span><a name="line-1718"></a><span>    </span><span class="hs-comment">-- get the full list of packages to link with, by combining the</span><span>
</span><a name="line-1719"></a><span>    </span><span class="hs-comment">-- explicit packages with the auto packages and all of their</span><span>
</span><a name="line-1720"></a><span>    </span><span class="hs-comment">-- dependencies, and eliminating duplicates.</span><span>
</span><a name="line-1721"></a><span>
</span><a name="line-1722"></a><span>    </span><a name="local-6989586621685142173"><a href="#local-6989586621685142173"><span class="hs-identifier">full_output_fn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isAbsolute</span><span> </span><a href="#local-6989586621685142171"><span class="hs-identifier hs-var">output_fn</span></a><span>
</span><a name="line-1723"></a><span>                      </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685142171"><span class="hs-identifier hs-var">output_fn</span></a><span>
</span><a name="line-1724"></a><span>                      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621685142172"><a href="#local-6989586621685142172"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getCurrentDirectory</span><span>
</span><a name="line-1725"></a><span>                              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">normalise</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685142172"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><a href="#local-6989586621685142171"><span class="hs-identifier hs-var">output_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1726"></a><span>    </span><a name="local-6989586621685142174"><a href="#local-6989586621685142174"><span class="hs-identifier">pkg_lib_paths</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getPackageLibraryPath</span><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685142167"><span class="hs-identifier hs-var">dep_packages</span></a><span>
</span><a name="line-1727"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142175"><a href="#local-6989586621685142175"><span class="hs-identifier">pkg_lib_path_opts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="#local-6989586621685142176"><span class="hs-identifier hs-var">get_pkg_lib_path_opts</span></a><span> </span><a href="#local-6989586621685142174"><span class="hs-identifier hs-var">pkg_lib_paths</span></a><span>
</span><a name="line-1728"></a><span>        </span><a name="local-6989586621685142176"><a href="#local-6989586621685142176"><span class="hs-identifier">get_pkg_lib_path_opts</span></a></a><span> </span><a name="local-6989586621685142177"><a href="#local-6989586621685142177"><span class="hs-identifier">l</span></a></a><span>
</span><a name="line-1729"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">osElfTarget</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">platformOS</span><span> </span><a href="#local-6989586621685142168"><span class="hs-identifier hs-var">platform</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-1730"></a><span>           </span><span class="hs-identifier">dynLibLoader</span><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">SystemDependent</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-1731"></a><span>           </span><span class="hs-identifier hs-var">WayDyn</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">ways</span><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1732"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142178"><a href="#local-6989586621685142178"><span class="hs-identifier">libpath</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_RelativeDynlibPaths</span><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1733"></a><span>                            </span><span class="hs-keyword">then</span><span> </span><span class="hs-string">&quot;$ORIGIN&quot;</span><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span>
</span><a name="line-1734"></a><span>                                 </span><span class="hs-special">(</span><a href="#local-6989586621685142177"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">makeRelativeTo</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685142173"><span class="hs-identifier hs-var">full_output_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1735"></a><span>                            </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621685142177"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-1736"></a><span>                  </span><span class="hs-comment">-- See Note [-Xlinker -rpath vs -Wl,-rpath]</span><span>
</span><a name="line-1737"></a><span>                  </span><a name="local-6989586621685142179"><a href="#local-6989586621685142179"><span class="hs-identifier">rpath</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_RPath</span><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1738"></a><span>                          </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;-Xlinker&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;-rpath&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;-Xlinker&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685142178"><span class="hs-identifier hs-var">libpath</span></a><span class="hs-special">]</span><span>
</span><a name="line-1739"></a><span>                          </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1740"></a><span>                  </span><span class="hs-comment">-- Solaris 11's linker does not support -rpath-link option. It silently</span><span>
</span><a name="line-1741"></a><span>                  </span><span class="hs-comment">-- ignores it and then complains about next option which is -l&lt;some</span><span>
</span><a name="line-1742"></a><span>                  </span><span class="hs-comment">-- dir&gt; as being a directory and not expected object file, E.g</span><span>
</span><a name="line-1743"></a><span>                  </span><span class="hs-comment">-- ld: elf error: file</span><span>
</span><a name="line-1744"></a><span>                  </span><span class="hs-comment">-- /tmp/ghc-src/libraries/base/dist-install/build:</span><span>
</span><a name="line-1745"></a><span>                  </span><span class="hs-comment">-- elf_begin: I/O error: region read: Is a directory</span><span>
</span><a name="line-1746"></a><span>                  </span><a name="local-6989586621685142180"><a href="#local-6989586621685142180"><span class="hs-identifier">rpathlink</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">platformOS</span><span> </span><a href="#local-6989586621685142168"><span class="hs-identifier hs-var">platform</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">OSSolaris2</span><span>
</span><a name="line-1747"></a><span>                              </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1748"></a><span>                              </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;-Xlinker&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;-rpath-link&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;-Xlinker&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685142177"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">]</span><span>
</span><a name="line-1749"></a><span>              </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;-L&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142177"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142180"><span class="hs-identifier hs-var">rpathlink</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142179"><span class="hs-identifier hs-var">rpath</span></a><span>
</span><a name="line-1750"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">osMachOTarget</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">platformOS</span><span> </span><a href="#local-6989586621685142168"><span class="hs-identifier hs-var">platform</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-1751"></a><span>           </span><span class="hs-identifier">dynLibLoader</span><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">SystemDependent</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-1752"></a><span>           </span><span class="hs-identifier hs-var">WayDyn</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">ways</span><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-1753"></a><span>           </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_RPath</span><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1754"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142181"><a href="#local-6989586621685142181"><span class="hs-identifier">libpath</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_RelativeDynlibPaths</span><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1755"></a><span>                            </span><span class="hs-keyword">then</span><span> </span><span class="hs-string">&quot;@loader_path&quot;</span><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span>
</span><a name="line-1756"></a><span>                                 </span><span class="hs-special">(</span><a href="#local-6989586621685142177"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">makeRelativeTo</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685142173"><span class="hs-identifier hs-var">full_output_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1757"></a><span>                            </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621685142177"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-1758"></a><span>              </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;-L&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142177"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;-Xlinker&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;-rpath&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;-Xlinker&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685142181"><span class="hs-identifier hs-var">libpath</span></a><span class="hs-special">]</span><span>
</span><a name="line-1759"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;-L&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142177"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">]</span><span>
</span><a name="line-1760"></a><span>
</span><a name="line-1761"></a><span>    </span><a name="local-6989586621685142186"><a href="#local-6989586621685142186"><span class="hs-identifier">pkg_lib_path_opts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-1762"></a><span>      </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_SingleLibFolder</span><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1763"></a><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1764"></a><span>        </span><a name="local-6989586621685142182"><a href="#local-6989586621685142182"><span class="hs-identifier">libs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getLibs</span><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685142167"><span class="hs-identifier hs-var">dep_packages</span></a><span>
</span><a name="line-1765"></a><span>        </span><a name="local-6989586621685142183"><a href="#local-6989586621685142183"><span class="hs-identifier">tmpDir</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newTempDir</span><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1766"></a><span>        </span><span class="hs-identifier hs-var">sequence_</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">copyFile</span><span> </span><a href="#local-6989586621685142184"><span class="hs-identifier hs-var">lib</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621685142183"><span class="hs-identifier hs-var">tmpDir</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><a href="#local-6989586621685142185"><span class="hs-identifier hs-var">basename</span></a><span class="hs-special">)</span><span>
</span><a name="line-1767"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685142184"><a href="#local-6989586621685142184"><span class="hs-identifier">lib</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685142185"><a href="#local-6989586621685142185"><span class="hs-identifier">basename</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685142182"><span class="hs-identifier hs-var">libs</span></a><span class="hs-special">]</span><span>
</span><a name="line-1768"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;-L&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142183"><span class="hs-identifier hs-var">tmpDir</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1769"></a><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621685142175"><span class="hs-identifier hs-var">pkg_lib_path_opts</span></a><span>
</span><a name="line-1770"></a><span>
</span><a name="line-1771"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-1772"></a><span>      </span><a name="local-6989586621685142187"><a href="#local-6989586621685142187"><span class="hs-identifier">dead_strip</span></a></a><span>
</span><a name="line-1773"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_WholeArchiveHsLibs</span><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1774"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">osSubsectionsViaSymbols</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">platformOS</span><span> </span><a href="#local-6989586621685142168"><span class="hs-identifier hs-var">platform</span></a><span class="hs-special">)</span><span>
</span><a name="line-1775"></a><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;-Wl,-dead_strip&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-1776"></a><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1777"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142188"><a href="#local-6989586621685142188"><span class="hs-identifier">lib_paths</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">libraryPaths</span><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1778"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142189"><a href="#local-6989586621685142189"><span class="hs-identifier">lib_path_opts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;-L&quot;</span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685142188"><span class="hs-identifier hs-var">lib_paths</span></a><span>
</span><a name="line-1779"></a><span>
</span><a name="line-1780"></a><span>    </span><a name="local-6989586621685142190"><a href="#local-6989586621685142190"><span class="hs-identifier">extraLinkObj</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SysTools.ExtraObj.html#mkExtraObjToLinkIntoBinary"><span class="hs-identifier hs-var">mkExtraObjToLinkIntoBinary</span></a><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1781"></a><span>    </span><a name="local-6989586621685142191"><a href="#local-6989586621685142191"><span class="hs-identifier">noteLinkObjs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SysTools.ExtraObj.html#mkNoteObjsToLinkIntoBinary"><span class="hs-identifier hs-var">mkNoteObjsToLinkIntoBinary</span></a><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685142167"><span class="hs-identifier hs-var">dep_packages</span></a><span>
</span><a name="line-1782"></a><span>
</span><a name="line-1783"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-1784"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621685142192"><a href="#local-6989586621685142192"><span class="hs-identifier">pre_hs_libs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685142193"><a href="#local-6989586621685142193"><span class="hs-identifier">post_hs_libs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1785"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_WholeArchiveHsLibs</span><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1786"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">platformOS</span><span> </span><a href="#local-6989586621685142168"><span class="hs-identifier hs-var">platform</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">OSDarwin</span><span>
</span><a name="line-1787"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-string">&quot;-Wl,-all_load&quot;</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1788"></a><span>              </span><span class="hs-comment">-- OS X does not have a flag to turn off -all_load</span><span>
</span><a name="line-1789"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-string">&quot;-Wl,--whole-archive&quot;</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;-Wl,--no-whole-archive&quot;</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1790"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1791"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1792"></a><span>
</span><a name="line-1793"></a><span>    </span><a name="local-6989586621685142197"><a href="#local-6989586621685142197"><span class="hs-identifier">pkg_link_opts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1794"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621685142194"><a href="#local-6989586621685142194"><span class="hs-identifier">package_hs_libs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685142195"><a href="#local-6989586621685142195"><span class="hs-identifier">extra_libs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685142196"><a href="#local-6989586621685142196"><span class="hs-identifier">other_flags</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getPackageLinkOpts</span><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685142167"><span class="hs-identifier hs-var">dep_packages</span></a><span>
</span><a name="line-1795"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621685142164"><span class="hs-identifier hs-var">staticLink</span></a><span>
</span><a name="line-1796"></a><span>            </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621685142194"><span class="hs-identifier hs-var">package_hs_libs</span></a><span> </span><span class="hs-comment">-- If building an executable really means making a static</span><span>
</span><a name="line-1797"></a><span>                                 </span><span class="hs-comment">-- library (e.g. iOS), then we only keep the -l options for</span><span>
</span><a name="line-1798"></a><span>                                 </span><span class="hs-comment">-- HS packages, because libtool doesn't accept other options.</span><span>
</span><a name="line-1799"></a><span>                                 </span><span class="hs-comment">-- In the case of iOS these need to be added by hand to the</span><span>
</span><a name="line-1800"></a><span>                                 </span><span class="hs-comment">-- final link in Xcode.</span><span>
</span><a name="line-1801"></a><span>            </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621685142196"><span class="hs-identifier hs-var">other_flags</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142187"><span class="hs-identifier hs-var">dead_strip</span></a><span>
</span><a name="line-1802"></a><span>                  </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142192"><span class="hs-identifier hs-var">pre_hs_libs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142194"><span class="hs-identifier hs-var">package_hs_libs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142193"><span class="hs-identifier hs-var">post_hs_libs</span></a><span>
</span><a name="line-1803"></a><span>                  </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142195"><span class="hs-identifier hs-var">extra_libs</span></a><span>
</span><a name="line-1804"></a><span>                 </span><span class="hs-comment">-- -Wl,-u,&lt;sym&gt; contained in other_flags</span><span>
</span><a name="line-1805"></a><span>                 </span><span class="hs-comment">-- needs to be put before -l&lt;package&gt;,</span><span>
</span><a name="line-1806"></a><span>                 </span><span class="hs-comment">-- otherwise Solaris linker fails linking</span><span>
</span><a name="line-1807"></a><span>                 </span><span class="hs-comment">-- a binary with unresolved symbols in RTS</span><span>
</span><a name="line-1808"></a><span>                 </span><span class="hs-comment">-- which are defined in base package</span><span>
</span><a name="line-1809"></a><span>                 </span><span class="hs-comment">-- the reason for this is a note in ld(1) about</span><span>
</span><a name="line-1810"></a><span>                 </span><span class="hs-comment">-- '-u' option: &quot;The placement of this option</span><span>
</span><a name="line-1811"></a><span>                 </span><span class="hs-comment">-- on the command line is significant.</span><span>
</span><a name="line-1812"></a><span>                 </span><span class="hs-comment">-- This option must be placed before the library</span><span>
</span><a name="line-1813"></a><span>                 </span><span class="hs-comment">-- that defines the symbol.&quot;</span><span>
</span><a name="line-1814"></a><span>
</span><a name="line-1815"></a><span>    </span><span class="hs-comment">-- frameworks</span><span>
</span><a name="line-1816"></a><span>    </span><a name="local-6989586621685142198"><a href="#local-6989586621685142198"><span class="hs-identifier">pkg_framework_opts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SysTools.html#getPkgFrameworkOpts"><span class="hs-identifier hs-var">getPkgFrameworkOpts</span></a><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685142168"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621685142167"><span class="hs-identifier hs-var">dep_packages</span></a><span>
</span><a name="line-1817"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142199"><a href="#local-6989586621685142199"><span class="hs-identifier">framework_opts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SysTools.html#getFrameworkOpts"><span class="hs-identifier hs-var">getFrameworkOpts</span></a><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685142168"><span class="hs-identifier hs-var">platform</span></a><span>
</span><a name="line-1818"></a><span>
</span><a name="line-1819"></a><span>        </span><span class="hs-comment">-- probably _stub.o files</span><span>
</span><a name="line-1820"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142200"><a href="#local-6989586621685142200"><span class="hs-identifier">extra_ld_inputs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ldInputs</span><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1821"></a><span>
</span><a name="line-1822"></a><span>    </span><span class="hs-comment">-- Here are some libs that need to be linked at the *end* of</span><span>
</span><a name="line-1823"></a><span>    </span><span class="hs-comment">-- the command line, because they contain symbols that are referred to</span><span>
</span><a name="line-1824"></a><span>    </span><span class="hs-comment">-- by the RTS.  We can't therefore use the ordinary way opts for these.</span><span>
</span><a name="line-1825"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142201"><a href="#local-6989586621685142201"><span class="hs-identifier">debug_opts</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">WayDebug</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">ways</span><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-1826"></a><span class="hs-cpp">#if defined(HAVE_LIBBFD)
</span><span>                        </span><span class="hs-string">&quot;-lbfd&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;-liberty&quot;</span><span>
</span><a name="line-1828"></a><span class="hs-cpp">#endif
</span><span>                         </span><span class="hs-special">]</span><span>
</span><a name="line-1830"></a><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1831"></a><span>
</span><a name="line-1832"></a><span>        </span><a name="local-6989586621685142202"><a href="#local-6989586621685142202"><span class="hs-identifier">thread_opts</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">WayThreaded</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">ways</span><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-1833"></a><span class="hs-cpp">#if NEED_PTHREAD_LIB
</span><span>                        </span><span class="hs-string">&quot;-lpthread&quot;</span><span>
</span><a name="line-1835"></a><span class="hs-cpp">#endif
</span><span>                        </span><span class="hs-special">]</span><span>
</span><a name="line-1837"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1838"></a><span>
</span><a name="line-1839"></a><span>    </span><a name="local-6989586621685142203"><a href="#local-6989586621685142203"><span class="hs-identifier">rc_objs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#maybeCreateManifest"><span class="hs-identifier hs-var">maybeCreateManifest</span></a><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685142171"><span class="hs-identifier hs-var">output_fn</span></a><span>
</span><a name="line-1840"></a><span>
</span><a name="line-1841"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142204"><a href="#local-6989586621685142204"><span class="hs-identifier">link</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621685142164"><span class="hs-identifier hs-var">staticLink</span></a><span>
</span><a name="line-1842"></a><span>                   </span><span class="hs-keyword">then</span><span> </span><a href="SysTools.Tasks.html#runLibtool"><span class="hs-identifier hs-var">SysTools.runLibtool</span></a><span>
</span><a name="line-1843"></a><span>                   </span><span class="hs-keyword">else</span><span> </span><a href="SysTools.Tasks.html#runLink"><span class="hs-identifier hs-var">SysTools.runLink</span></a><span>
</span><a name="line-1844"></a><span>    </span><a href="#local-6989586621685142204"><span class="hs-identifier hs-var">link</span></a><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span>
</span><a name="line-1845"></a><span>                       </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><a href="#local-6989586621685142170"><span class="hs-identifier hs-var">verbFlags</span></a><span>
</span><a name="line-1846"></a><span>                      </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-string">&quot;-o&quot;</span><span>
</span><a name="line-1847"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SysTools.FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621685142171"><span class="hs-identifier hs-var">output_fn</span></a><span>
</span><a name="line-1848"></a><span>                         </span><span class="hs-special">]</span><span>
</span><a name="line-1849"></a><span>                      </span><span class="hs-operator hs-var">++</span><span> </span><a href="SysTools.html#libmLinkOpts"><span class="hs-identifier hs-var">libmLinkOpts</span></a><span>
</span><a name="line-1850"></a><span>                      </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-1851"></a><span>                         </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1852"></a><span>
</span><a name="line-1853"></a><span>                      </span><span class="hs-comment">-- See Note [No PIE when linking]</span><span>
</span><a name="line-1854"></a><span>                      </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">picCCOpts</span><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1855"></a><span>
</span><a name="line-1856"></a><span>                      </span><span class="hs-comment">-- Permit the linker to auto link _symbol to _imp_symbol.</span><span>
</span><a name="line-1857"></a><span>                      </span><span class="hs-comment">-- This lets us link against DLLs without needing an &quot;import library&quot;.</span><span>
</span><a name="line-1858"></a><span>                      </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">platformOS</span><span> </span><a href="#local-6989586621685142168"><span class="hs-identifier hs-var">platform</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">OSMinGW32</span><span>
</span><a name="line-1859"></a><span>                          </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;-Wl,--enable-auto-import&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-1860"></a><span>                          </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1861"></a><span>
</span><a name="line-1862"></a><span>                      </span><span class="hs-comment">-- '-no_compact_unwind'</span><span>
</span><a name="line-1863"></a><span>                      </span><span class="hs-comment">-- C++/Objective-C exceptions cannot use optimised</span><span>
</span><a name="line-1864"></a><span>                      </span><span class="hs-comment">-- stack unwinding code. The optimised form is the</span><span>
</span><a name="line-1865"></a><span>                      </span><span class="hs-comment">-- default in Xcode 4 on at least x86_64, and</span><span>
</span><a name="line-1866"></a><span>                      </span><span class="hs-comment">-- without this flag we're also seeing warnings</span><span>
</span><a name="line-1867"></a><span>                      </span><span class="hs-comment">-- like</span><span>
</span><a name="line-1868"></a><span>                      </span><span class="hs-comment">--     ld: warning: could not create compact unwind for .LFB3: non-standard register 5 being saved in prolog</span><span>
</span><a name="line-1869"></a><span>                      </span><span class="hs-comment">-- on x86.</span><span>
</span><a name="line-1870"></a><span>                      </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">sLdSupportsCompactUnwind</span><span> </span><a href="#local-6989586621685142169"><span class="hs-identifier hs-var">mySettings</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-1871"></a><span>                             </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621685142164"><span class="hs-identifier hs-var">staticLink</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-1872"></a><span>                             </span><span class="hs-special">(</span><span class="hs-identifier">platformOS</span><span> </span><a href="#local-6989586621685142168"><span class="hs-identifier hs-var">platform</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">OSDarwin</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-1873"></a><span>                             </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">platformArch</span><span> </span><a href="#local-6989586621685142168"><span class="hs-identifier hs-var">platform</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1874"></a><span>                               </span><span class="hs-identifier hs-var">ArchX86</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1875"></a><span>                               </span><span class="hs-identifier hs-var">ArchX86_64</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1876"></a><span>                               </span><span class="hs-identifier hs-var">ArchARM</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1877"></a><span>                               </span><span class="hs-identifier hs-var">ArchARM64</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1878"></a><span>                               </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1879"></a><span>                          </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;-Wl,-no_compact_unwind&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-1880"></a><span>                          </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1881"></a><span>
</span><a name="line-1882"></a><span>                      </span><span class="hs-comment">-- '-Wl,-read_only_relocs,suppress'</span><span>
</span><a name="line-1883"></a><span>                      </span><span class="hs-comment">-- ld gives loads of warnings like:</span><span>
</span><a name="line-1884"></a><span>                      </span><span class="hs-comment">--     ld: warning: text reloc in _base_GHCziArr_unsafeArray_info to _base_GHCziArr_unsafeArray_closure</span><span>
</span><a name="line-1885"></a><span>                      </span><span class="hs-comment">-- when linking any program. We're not sure</span><span>
</span><a name="line-1886"></a><span>                      </span><span class="hs-comment">-- whether this is something we ought to fix, but</span><span>
</span><a name="line-1887"></a><span>                      </span><span class="hs-comment">-- for now this flags silences them.</span><span>
</span><a name="line-1888"></a><span>                      </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">platformOS</span><span>   </span><a href="#local-6989586621685142168"><span class="hs-identifier hs-var">platform</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">OSDarwin</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-1889"></a><span>                             </span><span class="hs-identifier">platformArch</span><span> </span><a href="#local-6989586621685142168"><span class="hs-identifier hs-var">platform</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">ArchX86</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-1890"></a><span>                             </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621685142164"><span class="hs-identifier hs-var">staticLink</span></a><span>
</span><a name="line-1891"></a><span>                          </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;-Wl,-read_only_relocs,suppress&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-1892"></a><span>                          </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1893"></a><span>
</span><a name="line-1894"></a><span>                      </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">sLdIsGnuLd</span><span> </span><a href="#local-6989586621685142169"><span class="hs-identifier hs-var">mySettings</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-1895"></a><span>                             </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_WholeArchiveHsLibs</span><span> </span><a href="#local-6989586621685142165"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1896"></a><span>                          </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;-Wl,--gc-sections&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-1897"></a><span>                          </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1898"></a><span>
</span><a name="line-1899"></a><span>                      </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142166"><span class="hs-identifier hs-var">o_files</span></a><span>
</span><a name="line-1900"></a><span>                      </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142189"><span class="hs-identifier hs-var">lib_path_opts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1901"></a><span>                      </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142200"><span class="hs-identifier hs-var">extra_ld_inputs</span></a><span>
</span><a name="line-1902"></a><span>                      </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-1903"></a><span>                         </span><a href="#local-6989586621685142203"><span class="hs-identifier hs-var">rc_objs</span></a><span>
</span><a name="line-1904"></a><span>                      </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142199"><span class="hs-identifier hs-var">framework_opts</span></a><span>
</span><a name="line-1905"></a><span>                      </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142186"><span class="hs-identifier hs-var">pkg_lib_path_opts</span></a><span>
</span><a name="line-1906"></a><span>                      </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142190"><span class="hs-identifier hs-var">extraLinkObj</span></a><span class="hs-glyph">:</span><a href="#local-6989586621685142191"><span class="hs-identifier hs-var">noteLinkObjs</span></a><span>
</span><a name="line-1907"></a><span>                      </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142197"><span class="hs-identifier hs-var">pkg_link_opts</span></a><span>
</span><a name="line-1908"></a><span>                      </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142198"><span class="hs-identifier hs-var">pkg_framework_opts</span></a><span>
</span><a name="line-1909"></a><span>                      </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142201"><span class="hs-identifier hs-var">debug_opts</span></a><span>
</span><a name="line-1910"></a><span>                      </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142202"><span class="hs-identifier hs-var">thread_opts</span></a><span>
</span><a name="line-1911"></a><span>                      </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">platformOS</span><span> </span><a href="#local-6989586621685142168"><span class="hs-identifier hs-var">platform</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">OSDarwin</span><span>
</span><a name="line-1912"></a><span>                          </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;-Wl,-dead_strip_dylibs&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1913"></a><span>                          </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1914"></a><span>                    </span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1915"></a><span>
</span><a name="line-1916"></a><span class="hs-identifier">exeFileName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-1917"></a><a name="exeFileName"><a href="DriverPipeline.html#exeFileName"><span class="hs-identifier">exeFileName</span></a></a><span> </span><a name="local-6989586621685142205"><a href="#local-6989586621685142205"><span class="hs-identifier">staticLink</span></a></a><span> </span><a name="local-6989586621685142206"><a href="#local-6989586621685142206"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-1918"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685142210"><a href="#local-6989586621685142210"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">outputFile</span><span> </span><a href="#local-6989586621685142206"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1919"></a><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">platformOS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621685142206"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1920"></a><span>          </span><span class="hs-identifier hs-var">OSMinGW32</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685142210"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621685142207"><span class="hs-operator hs-var">&lt;?.&gt;</span></a><span> </span><span class="hs-string">&quot;exe&quot;</span><span>
</span><a name="line-1921"></a><span>          </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621685142205"><span class="hs-identifier hs-var">staticLink</span></a><span>
</span><a name="line-1922"></a><span>                         </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621685142210"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621685142207"><span class="hs-operator hs-var">&lt;?.&gt;</span></a><span> </span><span class="hs-string">&quot;a&quot;</span><span>
</span><a name="line-1923"></a><span>                         </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621685142210"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-1924"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1925"></a><span>      </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">platformOS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621685142206"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">OSMinGW32</span><span>
</span><a name="line-1926"></a><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-string">&quot;main.exe&quot;</span><span>
</span><a name="line-1927"></a><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621685142205"><span class="hs-identifier hs-var">staticLink</span></a><span>
</span><a name="line-1928"></a><span>           </span><span class="hs-keyword">then</span><span> </span><span class="hs-string">&quot;liba.a&quot;</span><span>
</span><a name="line-1929"></a><span>           </span><span class="hs-keyword">else</span><span> </span><span class="hs-string">&quot;a.out&quot;</span><span>
</span><a name="line-1930"></a><span> </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621685142208"><a href="#local-6989586621685142208"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621685142207"><a href="#local-6989586621685142207"><span class="hs-operator">&lt;?.&gt;</span></a></a><span> </span><a name="local-6989586621685142209"><a href="#local-6989586621685142209"><span class="hs-identifier">ext</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">takeExtension</span><span> </span><a href="#local-6989586621685142208"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685142208"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><a href="#local-6989586621685142209"><span class="hs-identifier hs-var">ext</span></a><span>
</span><a name="line-1931"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685142208"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-1932"></a><span>
</span><a name="line-1933"></a><span class="hs-identifier">maybeCreateManifest</span><span>
</span><a name="line-1934"></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-1935"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>                          </span><span class="hs-comment">-- filename of executable</span><span>
</span><a name="line-1936"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">]</span><span>                     </span><span class="hs-comment">-- extra objects to embed, maybe</span><span>
</span><a name="line-1937"></a><a name="maybeCreateManifest"><a href="DriverPipeline.html#maybeCreateManifest"><span class="hs-identifier">maybeCreateManifest</span></a></a><span> </span><a name="local-6989586621685142211"><a href="#local-6989586621685142211"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685142212"><a href="#local-6989586621685142212"><span class="hs-identifier">exe_filename</span></a></a><span>
</span><a name="line-1938"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">platformOS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621685142211"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">OSMinGW32</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-1939"></a><span>   </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_GenManifest</span><span> </span><a href="#local-6989586621685142211"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1940"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142213"><a href="#local-6989586621685142213"><span class="hs-identifier">manifest_filename</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685142212"><span class="hs-identifier hs-var">exe_filename</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><span class="hs-string">&quot;manifest&quot;</span><span>
</span><a name="line-1941"></a><span>
</span><a name="line-1942"></a><span>         </span><span class="hs-identifier hs-var">writeFile</span><span> </span><a href="#local-6989586621685142213"><span class="hs-identifier hs-var">manifest_filename</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1943"></a><span>             </span><span class="hs-string">&quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot; standalone=\&quot;yes\&quot;?&gt;\n&quot;</span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1944"></a><span>             </span><span class="hs-string">&quot;  &lt;assembly xmlns=\&quot;urn:schemas-microsoft-com:asm.v1\&quot; manifestVersion=\&quot;1.0\&quot;&gt;\n&quot;</span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1945"></a><span>             </span><span class="hs-string">&quot;  &lt;assemblyIdentity version=\&quot;1.0.0.0\&quot;\n&quot;</span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1946"></a><span>             </span><span class="hs-string">&quot;     processorArchitecture=\&quot;X86\&quot;\n&quot;</span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1947"></a><span>             </span><span class="hs-string">&quot;     name=\&quot;&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">dropExtension</span><span> </span><a href="#local-6989586621685142212"><span class="hs-identifier hs-var">exe_filename</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;\&quot;\n&quot;</span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1948"></a><span>             </span><span class="hs-string">&quot;     type=\&quot;win32\&quot;/&gt;\n\n&quot;</span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1949"></a><span>             </span><span class="hs-string">&quot;  &lt;trustInfo xmlns=\&quot;urn:schemas-microsoft-com:asm.v3\&quot;&gt;\n&quot;</span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1950"></a><span>             </span><span class="hs-string">&quot;    &lt;security&gt;\n&quot;</span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1951"></a><span>             </span><span class="hs-string">&quot;      &lt;requestedPrivileges&gt;\n&quot;</span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1952"></a><span>             </span><span class="hs-string">&quot;        &lt;requestedExecutionLevel level=\&quot;asInvoker\&quot; uiAccess=\&quot;false\&quot;/&gt;\n&quot;</span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1953"></a><span>             </span><span class="hs-string">&quot;        &lt;/requestedPrivileges&gt;\n&quot;</span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1954"></a><span>             </span><span class="hs-string">&quot;       &lt;/security&gt;\n&quot;</span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1955"></a><span>             </span><span class="hs-string">&quot;  &lt;/trustInfo&gt;\n&quot;</span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1956"></a><span>             </span><span class="hs-string">&quot;&lt;/assembly&gt;\n&quot;</span><span>
</span><a name="line-1957"></a><span>
</span><a name="line-1958"></a><span>         </span><span class="hs-comment">-- Windows will find the manifest file if it is named</span><span>
</span><a name="line-1959"></a><span>         </span><span class="hs-comment">-- foo.exe.manifest. However, for extra robustness, and so that</span><span>
</span><a name="line-1960"></a><span>         </span><span class="hs-comment">-- we can move the binary around, we can embed the manifest in</span><span>
</span><a name="line-1961"></a><span>         </span><span class="hs-comment">-- the binary itself using windres:</span><span>
</span><a name="line-1962"></a><span>         </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_EmbedManifest</span><span> </span><a href="#local-6989586621685142211"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1963"></a><span>
</span><a name="line-1964"></a><span>         </span><a name="local-6989586621685142214"><a href="#local-6989586621685142214"><span class="hs-identifier">rc_filename</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newTempName</span><span> </span><a href="#local-6989586621685142211"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">TFL_CurrentModule</span><span> </span><span class="hs-string">&quot;rc&quot;</span><span>
</span><a name="line-1965"></a><span>         </span><a name="local-6989586621685142215"><a href="#local-6989586621685142215"><span class="hs-identifier">rc_obj_filename</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-1966"></a><span>           </span><span class="hs-identifier hs-var">newTempName</span><span> </span><a href="#local-6989586621685142211"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">TFL_GhcSession</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">objectSuf</span><span> </span><a href="#local-6989586621685142211"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1967"></a><span>
</span><a name="line-1968"></a><span>         </span><span class="hs-identifier hs-var">writeFile</span><span> </span><a href="#local-6989586621685142214"><span class="hs-identifier hs-var">rc_filename</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1969"></a><span>             </span><span class="hs-string">&quot;1 24 MOVEABLE PURE &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621685142213"><span class="hs-identifier hs-var">manifest_filename</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;\n&quot;</span><span>
</span><a name="line-1970"></a><span>               </span><span class="hs-comment">-- magic numbers :-)</span><span>
</span><a name="line-1971"></a><span>               </span><span class="hs-comment">-- show is a bit hackish above, but we need to escape the</span><span>
</span><a name="line-1972"></a><span>               </span><span class="hs-comment">-- backslashes in the path.</span><span>
</span><a name="line-1973"></a><span>
</span><a name="line-1974"></a><span>         </span><a href="SysTools.Tasks.html#runWindres"><span class="hs-identifier hs-var">runWindres</span></a><span> </span><a href="#local-6989586621685142211"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1975"></a><span>               </span><span class="hs-special">[</span><span class="hs-string">&quot;--input=&quot;</span><span class="hs-operator hs-var">++</span><a href="#local-6989586621685142214"><span class="hs-identifier hs-var">rc_filename</span></a><span class="hs-special">,</span><span>
</span><a name="line-1976"></a><span>                </span><span class="hs-string">&quot;--output=&quot;</span><span class="hs-operator hs-var">++</span><a href="#local-6989586621685142215"><span class="hs-identifier hs-var">rc_obj_filename</span></a><span class="hs-special">,</span><span>
</span><a name="line-1977"></a><span>                </span><span class="hs-string">&quot;--output-format=coff&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-1978"></a><span>               </span><span class="hs-comment">-- no FileOptions here: windres doesn't like seeing</span><span>
</span><a name="line-1979"></a><span>               </span><span class="hs-comment">-- backslashes, apparently</span><span>
</span><a name="line-1980"></a><span>
</span><a name="line-1981"></a><span>         </span><span class="hs-identifier hs-var">removeFile</span><span> </span><a href="#local-6989586621685142213"><span class="hs-identifier hs-var">manifest_filename</span></a><span>
</span><a name="line-1982"></a><span>
</span><a name="line-1983"></a><span>         </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621685142215"><span class="hs-identifier hs-var">rc_obj_filename</span></a><span class="hs-special">]</span><span>
</span><a name="line-1984"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1985"></a><span>
</span><a name="line-1986"></a><span>
</span><a name="line-1987"></a><span class="hs-identifier">linkDynLibCheck</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">InstalledUnitId</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1988"></a><a name="linkDynLibCheck"><a href="DriverPipeline.html#linkDynLibCheck"><span class="hs-identifier">linkDynLibCheck</span></a></a><span> </span><a name="local-6989586621685142216"><a href="#local-6989586621685142216"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685142217"><a href="#local-6989586621685142217"><span class="hs-identifier">o_files</span></a></a><span> </span><a name="local-6989586621685142218"><a href="#local-6989586621685142218"><span class="hs-identifier">dep_packages</span></a></a><span>
</span><a name="line-1989"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1990"></a><span>    </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="SysTools.ExtraObj.html#haveRtsOptsFlags"><span class="hs-identifier hs-var">haveRtsOptsFlags</span></a><span> </span><a href="#local-6989586621685142216"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1991"></a><span>      </span><span class="hs-identifier hs-var">putLogMsg</span><span> </span><a href="#local-6989586621685142216"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">NoReason</span><span> </span><span class="hs-identifier hs-var">SevInfo</span><span> </span><span class="hs-identifier hs-var">noSrcSpan</span><span>
</span><a name="line-1992"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">defaultUserStyle</span><span> </span><a href="#local-6989586621685142216"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1993"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Warning: -rtsopts and -with-rtsopts have no effect with -shared.&quot;</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-1994"></a><span>           </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;    Call hs_init_ghc() from your main() function to set these options.&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1995"></a><span>
</span><a name="line-1996"></a><span>    </span><a href="SysTools.html#linkDynLib"><span class="hs-identifier hs-var">linkDynLib</span></a><span> </span><a href="#local-6989586621685142216"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685142217"><span class="hs-identifier hs-var">o_files</span></a><span> </span><a href="#local-6989586621685142218"><span class="hs-identifier hs-var">dep_packages</span></a><span>
</span><a name="line-1997"></a><span>
</span><a name="line-1998"></a><span class="hs-comment">-- | Linking a static lib will not really link anything. It will merely produce</span><span>
</span><a name="line-1999"></a><span class="hs-comment">-- a static archive of all dependent static libraries. The resulting library</span><span>
</span><a name="line-2000"></a><span class="hs-comment">-- will still need to be linked with any remaining link flags.</span><span>
</span><a name="line-2001"></a><span class="hs-identifier">linkStaticLib</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">InstalledUnitId</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2002"></a><a name="linkStaticLib"><a href="DriverPipeline.html#linkStaticLib"><span class="hs-identifier">linkStaticLib</span></a></a><span> </span><a name="local-6989586621685142219"><a href="#local-6989586621685142219"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685142220"><a href="#local-6989586621685142220"><span class="hs-identifier">o_files</span></a></a><span> </span><a name="local-6989586621685142221"><a href="#local-6989586621685142221"><span class="hs-identifier">dep_packages</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2003"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142222"><a href="#local-6989586621685142222"><span class="hs-identifier">extra_ld_inputs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621685142225"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">FileOption</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621685142225"><a href="#local-6989586621685142225"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">ldInputs</span><span> </span><a href="#local-6989586621685142219"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2004"></a><span>      </span><a name="local-6989586621685142223"><a href="#local-6989586621685142223"><span class="hs-identifier">modules</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685142220"><span class="hs-identifier hs-var">o_files</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142222"><span class="hs-identifier hs-var">extra_ld_inputs</span></a><span>
</span><a name="line-2005"></a><span>      </span><a name="local-6989586621685142224"><a href="#local-6989586621685142224"><span class="hs-identifier">output_fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DriverPipeline.html#exeFileName"><span class="hs-identifier hs-var">exeFileName</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621685142219"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-2006"></a><span>
</span><a name="line-2007"></a><span>  </span><a name="local-6989586621685142227"><a href="#local-6989586621685142227"><span class="hs-identifier">full_output_fn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isAbsolute</span><span> </span><a href="#local-6989586621685142224"><span class="hs-identifier hs-var">output_fn</span></a><span>
</span><a name="line-2008"></a><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685142224"><span class="hs-identifier hs-var">output_fn</span></a><span>
</span><a name="line-2009"></a><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621685142226"><a href="#local-6989586621685142226"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getCurrentDirectory</span><span>
</span><a name="line-2010"></a><span>                            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">normalise</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685142226"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><a href="#local-6989586621685142224"><span class="hs-identifier hs-var">output_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-2011"></a><span>  </span><a name="local-6989586621685142228"><a href="#local-6989586621685142228"><span class="hs-identifier">output_exists</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">doesFileExist</span><span> </span><a href="#local-6989586621685142227"><span class="hs-identifier hs-var">full_output_fn</span></a><span>
</span><a name="line-2012"></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621685142228"><span class="hs-identifier hs-var">output_exists</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">removeFile</span><span> </span><a href="#local-6989586621685142227"><span class="hs-identifier hs-var">full_output_fn</span></a><span>
</span><a name="line-2013"></a><span>
</span><a name="line-2014"></a><span>  </span><a name="local-6989586621685142229"><a href="#local-6989586621685142229"><span class="hs-identifier">pkg_cfgs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getPreloadPackagesAnd</span><span> </span><a href="#local-6989586621685142219"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685142221"><span class="hs-identifier hs-var">dep_packages</span></a><span>
</span><a name="line-2015"></a><span>  </span><a name="local-6989586621685142230"><a href="#local-6989586621685142230"><span class="hs-identifier">archives</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">collectArchives</span><span> </span><a href="#local-6989586621685142219"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685142229"><span class="hs-identifier hs-var">pkg_cfgs</span></a><span>
</span><a name="line-2016"></a><span>
</span><a name="line-2017"></a><span>  </span><a name="local-6989586621685142231"><a href="#local-6989586621685142231"><span class="hs-identifier">ar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">foldl</span><span> </span><span class="hs-identifier hs-var">mappend</span><span>
</span><a name="line-2018"></a><span>        </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-special">(</span><a href="Ar.html#Archive"><span class="hs-identifier hs-var">Archive</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="Ar.html#loadObj"><span class="hs-identifier hs-var">loadObj</span></a><span> </span><a href="#local-6989586621685142223"><span class="hs-identifier hs-var">modules</span></a><span class="hs-special">)</span><span>
</span><a name="line-2019"></a><span>        </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="Ar.html#loadAr"><span class="hs-identifier hs-var">loadAr</span></a><span> </span><a href="#local-6989586621685142230"><span class="hs-identifier hs-var">archives</span></a><span>
</span><a name="line-2020"></a><span>
</span><a name="line-2021"></a><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">sLdIsGnuLd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">settings</span><span> </span><a href="#local-6989586621685142219"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-2022"></a><span>    </span><span class="hs-keyword">then</span><span> </span><a href="Ar.html#writeGNUAr"><span class="hs-identifier hs-var">writeGNUAr</span></a><span> </span><a href="#local-6989586621685142224"><span class="hs-identifier hs-var">output_fn</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ar.html#afilter"><span class="hs-identifier hs-var">afilter</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Ar.html#isGNUSymdef"><span class="hs-identifier hs-var">isGNUSymdef</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685142231"><span class="hs-identifier hs-var">ar</span></a><span>
</span><a name="line-2023"></a><span>    </span><span class="hs-keyword">else</span><span> </span><a href="Ar.html#writeBSDAr"><span class="hs-identifier hs-var">writeBSDAr</span></a><span> </span><a href="#local-6989586621685142224"><span class="hs-identifier hs-var">output_fn</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Ar.html#afilter"><span class="hs-identifier hs-var">afilter</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Ar.html#isBSDSymdef"><span class="hs-identifier hs-var">isBSDSymdef</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685142231"><span class="hs-identifier hs-var">ar</span></a><span>
</span><a name="line-2024"></a><span>
</span><a name="line-2025"></a><span>  </span><span class="hs-comment">-- run ranlib over the archive. write*Ar does *not* create the symbol index.</span><span>
</span><a name="line-2026"></a><span>  </span><a href="SysTools.Tasks.html#runRanlib"><span class="hs-identifier hs-var">runRanlib</span></a><span> </span><a href="#local-6989586621685142219"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">SysTools.FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621685142224"><span class="hs-identifier hs-var">output_fn</span></a><span class="hs-special">]</span><span>
</span><a name="line-2027"></a><span>
</span><a name="line-2028"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-2029"></a><span class="hs-comment">-- Running CPP</span><span>
</span><a name="line-2030"></a><span>
</span><a name="line-2031"></a><span class="hs-identifier">doCpp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2032"></a><a name="doCpp"><a href="DriverPipeline.html#doCpp"><span class="hs-identifier">doCpp</span></a></a><span> </span><a name="local-6989586621685142232"><a href="#local-6989586621685142232"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685142233"><a href="#local-6989586621685142233"><span class="hs-identifier">raw</span></a></a><span> </span><a name="local-6989586621685142234"><a href="#local-6989586621685142234"><span class="hs-identifier">input_fn</span></a></a><span> </span><a name="local-6989586621685142235"><a href="#local-6989586621685142235"><span class="hs-identifier">output_fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2033"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142236"><a href="#local-6989586621685142236"><span class="hs-identifier">hscpp_opts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">picPOpts</span><span> </span><a href="#local-6989586621685142232"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-2034"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142237"><a href="#local-6989586621685142237"><span class="hs-identifier">cmdline_include_paths</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">includePaths</span><span> </span><a href="#local-6989586621685142232"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-2035"></a><span>
</span><a name="line-2036"></a><span>    </span><a name="local-6989586621685142238"><a href="#local-6989586621685142238"><span class="hs-identifier">pkg_include_dirs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getPackageIncludePath</span><span> </span><a href="#local-6989586621685142232"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2037"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142239"><a href="#local-6989586621685142239"><span class="hs-identifier">include_paths_global</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621685142240"><a href="#local-6989586621685142240"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621685142241"><a href="#local-6989586621685142241"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;-I&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142240"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621685142241"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2038"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier">includePathsGlobal</span><span> </span><a href="#local-6989586621685142237"><span class="hs-identifier hs-var">cmdline_include_paths</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142238"><span class="hs-identifier hs-var">pkg_include_dirs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2039"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142242"><a href="#local-6989586621685142242"><span class="hs-identifier">include_paths_quote</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621685142243"><a href="#local-6989586621685142243"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621685142244"><a href="#local-6989586621685142244"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;-iquote&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142243"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621685142244"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2040"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier">includePathsQuote</span><span> </span><a href="#local-6989586621685142237"><span class="hs-identifier hs-var">cmdline_include_paths</span></a><span class="hs-special">)</span><span>
</span><a name="line-2041"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142245"><a href="#local-6989586621685142245"><span class="hs-identifier">include_paths</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685142242"><span class="hs-identifier hs-var">include_paths_quote</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142239"><span class="hs-identifier hs-var">include_paths_global</span></a><span>
</span><a name="line-2042"></a><span>
</span><a name="line-2043"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142246"><a href="#local-6989586621685142246"><span class="hs-identifier">verbFlags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getVerbFlags</span><span> </span><a href="#local-6989586621685142232"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-2044"></a><span>
</span><a name="line-2045"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142247"><a href="#local-6989586621685142247"><span class="hs-identifier">cpp_prog</span></a></a><span> </span><a name="local-6989586621685142248"><a href="#local-6989586621685142248"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685142233"><span class="hs-identifier hs-var">raw</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="SysTools.Tasks.html#runCpp"><span class="hs-identifier hs-var">SysTools.runCpp</span></a><span> </span><a href="#local-6989586621685142232"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685142248"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-2046"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SysTools.Tasks.html#runCc"><span class="hs-identifier hs-var">SysTools.runCc</span></a><span> </span><a href="#local-6989586621685142232"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-string">&quot;-E&quot;</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621685142248"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-2047"></a><span>
</span><a name="line-2048"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142249"><a href="#local-6989586621685142249"><span class="hs-identifier">target_defs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2049"></a><span>          </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;-D&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier">HOST_OS</span><span>     </span><span class="hs-operator">++</span><span> </span><span class="hs-string">&quot;_BUILD_OS&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-2050"></a><span>            </span><span class="hs-string">&quot;-D&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier">HOST_ARCH</span><span>   </span><span class="hs-operator">++</span><span> </span><span class="hs-string">&quot;_BUILD_ARCH&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-2051"></a><span>            </span><span class="hs-string">&quot;-D&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier">TARGET_OS</span><span>   </span><span class="hs-operator">++</span><span> </span><span class="hs-string">&quot;_HOST_OS&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-2052"></a><span>            </span><span class="hs-string">&quot;-D&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier">TARGET_ARCH</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-string">&quot;_HOST_ARCH&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2053"></a><span>        </span><span class="hs-comment">-- remember, in code we *compile*, the HOST is the same our TARGET,</span><span>
</span><a name="line-2054"></a><span>        </span><span class="hs-comment">-- and BUILD is the same as our HOST.</span><span>
</span><a name="line-2055"></a><span>
</span><a name="line-2056"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142250"><a href="#local-6989586621685142250"><span class="hs-identifier">sse_defs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2057"></a><span>          </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;-D__SSE__&quot;</span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isSseEnabled</span><span>      </span><a href="#local-6989586621685142232"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-2058"></a><span>          </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;-D__SSE2__&quot;</span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isSse2Enabled</span><span>     </span><a href="#local-6989586621685142232"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-2059"></a><span>          </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;-D__SSE4_2__&quot;</span><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isSse4_2Enabled</span><span>   </span><a href="#local-6989586621685142232"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2060"></a><span>
</span><a name="line-2061"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142251"><a href="#local-6989586621685142251"><span class="hs-identifier">avx_defs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2062"></a><span>          </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;-D__AVX__&quot;</span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isAvxEnabled</span><span>      </span><a href="#local-6989586621685142232"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-2063"></a><span>          </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;-D__AVX2__&quot;</span><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isAvx2Enabled</span><span>     </span><a href="#local-6989586621685142232"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-2064"></a><span>          </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;-D__AVX512CD__&quot;</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isAvx512cdEnabled</span><span> </span><a href="#local-6989586621685142232"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-2065"></a><span>          </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;-D__AVX512ER__&quot;</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isAvx512erEnabled</span><span> </span><a href="#local-6989586621685142232"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-2066"></a><span>          </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;-D__AVX512F__&quot;</span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isAvx512fEnabled</span><span>  </span><a href="#local-6989586621685142232"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-2067"></a><span>          </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;-D__AVX512PF__&quot;</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isAvx512pfEnabled</span><span> </span><a href="#local-6989586621685142232"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2068"></a><span>
</span><a name="line-2069"></a><span>    </span><a name="local-6989586621685142252"><a href="#local-6989586621685142252"><span class="hs-identifier">backend_defs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#getBackendDefs"><span class="hs-identifier hs-var">getBackendDefs</span></a><span> </span><a href="#local-6989586621685142232"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-2070"></a><span>
</span><a name="line-2071"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142253"><a href="#local-6989586621685142253"><span class="hs-identifier">th_defs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;-D__GLASGOW_HASKELL_TH__&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2072"></a><span>    </span><span class="hs-comment">-- Default CPP defines in Haskell source</span><span>
</span><a name="line-2073"></a><span>    </span><a name="local-6989586621685142254"><a href="#local-6989586621685142254"><span class="hs-identifier">ghcVersionH</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DriverPipeline.html#getGhcVersionPathName"><span class="hs-identifier hs-var">getGhcVersionPathName</span></a><span> </span><a href="#local-6989586621685142232"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-2074"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142255"><a href="#local-6989586621685142255"><span class="hs-identifier">hsSourceCppOpts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;-include&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685142254"><span class="hs-identifier hs-var">ghcVersionH</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2075"></a><span>
</span><a name="line-2076"></a><span>    </span><span class="hs-comment">-- MIN_VERSION macros</span><span>
</span><a name="line-2077"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142256"><a href="#local-6989586621685142256"><span class="hs-identifier">uids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">explicitPackages</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pkgState</span><span> </span><a href="#local-6989586621685142232"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-2078"></a><span>        </span><a name="local-6989586621685142257"><a href="#local-6989586621685142257"><span class="hs-identifier">pkgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lookupPackage</span><span> </span><a href="#local-6989586621685142232"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685142256"><span class="hs-identifier hs-var">uids</span></a><span class="hs-special">)</span><span>
</span><a name="line-2079"></a><span>    </span><a name="local-6989586621685142259"><a href="#local-6989586621685142259"><span class="hs-identifier">mb_macro_include</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-2080"></a><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621685142257"><span class="hs-identifier hs-var">pkgs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_VersionMacros</span><span> </span><a href="#local-6989586621685142232"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-2081"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621685142258"><a href="#local-6989586621685142258"><span class="hs-identifier">macro_stub</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newTempName</span><span> </span><a href="#local-6989586621685142232"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">TFL_CurrentModule</span><span> </span><span class="hs-string">&quot;h&quot;</span><span>
</span><a name="line-2082"></a><span>                    </span><span class="hs-identifier hs-var">writeFile</span><span> </span><a href="#local-6989586621685142258"><span class="hs-identifier hs-var">macro_stub</span></a><span> </span><span class="hs-special">(</span><a href="DriverPipeline.html#generatePackageVersionMacros"><span class="hs-identifier hs-var">generatePackageVersionMacros</span></a><span> </span><a href="#local-6989586621685142257"><span class="hs-identifier hs-var">pkgs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2083"></a><span>                    </span><span class="hs-comment">-- Include version macros for every *exposed* package.</span><span>
</span><a name="line-2084"></a><span>                    </span><span class="hs-comment">-- Without -hide-all-packages and with a package database</span><span>
</span><a name="line-2085"></a><span>                    </span><span class="hs-comment">-- size of 1000 packages, it takes cpp an estimated 2</span><span>
</span><a name="line-2086"></a><span>                    </span><span class="hs-comment">-- milliseconds to process this file. See Trac #10970</span><span>
</span><a name="line-2087"></a><span>                    </span><span class="hs-comment">-- comment 8.</span><span>
</span><a name="line-2088"></a><span>                    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">SysTools.FileOption</span><span> </span><span class="hs-string">&quot;-include&quot;</span><span> </span><a href="#local-6989586621685142258"><span class="hs-identifier hs-var">macro_stub</span></a><span class="hs-special">]</span><span>
</span><a name="line-2089"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2090"></a><span>
</span><a name="line-2091"></a><span>    </span><a href="#local-6989586621685142247"><span class="hs-identifier hs-var">cpp_prog</span></a><span>       </span><span class="hs-special">(</span><span>   </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><a href="#local-6989586621685142246"><span class="hs-identifier hs-var">verbFlags</span></a><span>
</span><a name="line-2092"></a><span>                    </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><a href="#local-6989586621685142245"><span class="hs-identifier hs-var">include_paths</span></a><span>
</span><a name="line-2093"></a><span>                    </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><a href="#local-6989586621685142255"><span class="hs-identifier hs-var">hsSourceCppOpts</span></a><span>
</span><a name="line-2094"></a><span>                    </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><a href="#local-6989586621685142249"><span class="hs-identifier hs-var">target_defs</span></a><span>
</span><a name="line-2095"></a><span>                    </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><a href="#local-6989586621685142252"><span class="hs-identifier hs-var">backend_defs</span></a><span>
</span><a name="line-2096"></a><span>                    </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><a href="#local-6989586621685142253"><span class="hs-identifier hs-var">th_defs</span></a><span>
</span><a name="line-2097"></a><span>                    </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><a href="#local-6989586621685142236"><span class="hs-identifier hs-var">hscpp_opts</span></a><span>
</span><a name="line-2098"></a><span>                    </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><a href="#local-6989586621685142250"><span class="hs-identifier hs-var">sse_defs</span></a><span>
</span><a name="line-2099"></a><span>                    </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><a href="#local-6989586621685142251"><span class="hs-identifier hs-var">avx_defs</span></a><span>
</span><a name="line-2100"></a><span>                    </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142259"><span class="hs-identifier hs-var">mb_macro_include</span></a><span>
</span><a name="line-2101"></a><span>        </span><span class="hs-comment">-- Set the language mode to assembler-with-cpp when preprocessing. This</span><span>
</span><a name="line-2102"></a><span>        </span><span class="hs-comment">-- alleviates some of the C99 macro rules relating to whitespace and the hash</span><span>
</span><a name="line-2103"></a><span>        </span><span class="hs-comment">-- operator, which we tend to abuse. Clang in particular is not very happy</span><span>
</span><a name="line-2104"></a><span>        </span><span class="hs-comment">-- about this.</span><span>
</span><a name="line-2105"></a><span>                    </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span>     </span><span class="hs-string">&quot;-x&quot;</span><span>
</span><a name="line-2106"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span>     </span><span class="hs-string">&quot;assembler-with-cpp&quot;</span><span>
</span><a name="line-2107"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span>     </span><a href="#local-6989586621685142234"><span class="hs-identifier hs-var">input_fn</span></a><span>
</span><a name="line-2108"></a><span>        </span><span class="hs-comment">-- We hackily use Option instead of FileOption here, so that the file</span><span>
</span><a name="line-2109"></a><span>        </span><span class="hs-comment">-- name is not back-slashed on Windows.  cpp is capable of</span><span>
</span><a name="line-2110"></a><span>        </span><span class="hs-comment">-- dealing with / in filenames, so it works fine.  Furthermore</span><span>
</span><a name="line-2111"></a><span>        </span><span class="hs-comment">-- if we put in backslashes, cpp outputs #line directives</span><span>
</span><a name="line-2112"></a><span>        </span><span class="hs-comment">-- with *double* backslashes.   And that in turn means that</span><span>
</span><a name="line-2113"></a><span>        </span><span class="hs-comment">-- our error messages get double backslashes in them.</span><span>
</span><a name="line-2114"></a><span>        </span><span class="hs-comment">-- In due course we should arrange that the lexer deals</span><span>
</span><a name="line-2115"></a><span>        </span><span class="hs-comment">-- with these \\ escapes properly.</span><span>
</span><a name="line-2116"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span>     </span><span class="hs-string">&quot;-o&quot;</span><span>
</span><a name="line-2117"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SysTools.FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621685142235"><span class="hs-identifier hs-var">output_fn</span></a><span>
</span><a name="line-2118"></a><span>                       </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2119"></a><span>
</span><a name="line-2120"></a><span class="hs-identifier">getBackendDefs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span>
</span><a name="line-2121"></a><a name="getBackendDefs"><a href="DriverPipeline.html#getBackendDefs"><span class="hs-identifier">getBackendDefs</span></a></a><span> </span><a name="local-6989586621685142260"><a href="#local-6989586621685142260"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">hscTarget</span><span> </span><a href="#local-6989586621685142260"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">HscLlvm</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2122"></a><span>    </span><a name="local-6989586621685142264"><a href="#local-6989586621685142264"><span class="hs-identifier">llvmVer</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SysTools.Tasks.html#figureLlvmVersion"><span class="hs-identifier hs-var">figureLlvmVersion</span></a><span> </span><a href="#local-6989586621685142260"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-2123"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685142264"><span class="hs-identifier hs-var">llvmVer</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2124"></a><span>               </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685142265"><a href="#local-6989586621685142265"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;-D__GLASGOW_HASKELL_LLVM__=&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142261"><span class="hs-identifier hs-var">format</span></a><span> </span><a href="#local-6989586621685142265"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2125"></a><span>               </span><span class="hs-identifier">_</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2126"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2127"></a><span>    </span><a name="local-6989586621685142261"><a href="#local-6989586621685142261"><span class="hs-identifier">format</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621685142262"><a href="#local-6989586621685142262"><span class="hs-identifier">major</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685142263"><a href="#local-6989586621685142263"><span class="hs-identifier">minor</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2128"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685142263"><span class="hs-identifier hs-var">minor</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">100</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;getBackendDefs: Unsupported minor version&quot;</span><span>
</span><a name="line-2129"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-number">100</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><a href="#local-6989586621685142262"><span class="hs-identifier hs-var">major</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621685142263"><span class="hs-identifier hs-var">minor</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Contract is Int</span><span>
</span><a name="line-2130"></a><span>
</span><a name="line-2131"></a><span class="hs-identifier">getBackendDefs</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2132"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2133"></a><span>
</span><a name="line-2134"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-2135"></a><span class="hs-comment">-- Macros (cribbed from Cabal)</span><span>
</span><a name="line-2136"></a><span>
</span><a name="line-2137"></a><span class="hs-identifier">generatePackageVersionMacros</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">PackageConfig</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-2138"></a><a name="generatePackageVersionMacros"><a href="DriverPipeline.html#generatePackageVersionMacros"><span class="hs-identifier">generatePackageVersionMacros</span></a></a><span> </span><a name="local-6989586621685142266"><a href="#local-6989586621685142266"><span class="hs-identifier">pkgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concat</span><span>
</span><a name="line-2139"></a><span>  </span><span class="hs-comment">-- Do not add any C-style comments. See Trac #3389.</span><span>
</span><a name="line-2140"></a><span>  </span><span class="hs-special">[</span><span> </span><a href="DriverPipeline.html#generateMacros"><span class="hs-identifier hs-var">generateMacros</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621685142269"><span class="hs-identifier hs-var">pkgname</span></a><span> </span><a href="#local-6989586621685142268"><span class="hs-identifier hs-var">version</span></a><span>
</span><a name="line-2141"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621685142267"><a href="#local-6989586621685142267"><span class="hs-identifier">pkg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685142266"><span class="hs-identifier hs-var">pkgs</span></a><span>
</span><a name="line-2142"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142268"><a href="#local-6989586621685142268"><span class="hs-identifier">version</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">packageVersion</span><span> </span><a href="#local-6989586621685142267"><span class="hs-identifier hs-var">pkg</span></a><span>
</span><a name="line-2143"></a><span>        </span><a name="local-6989586621685142269"><a href="#local-6989586621685142269"><span class="hs-identifier">pkgname</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="DriverPipeline.html#fixchar"><span class="hs-identifier hs-var">fixchar</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">packageNameString</span><span> </span><a href="#local-6989586621685142267"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">)</span><span>
</span><a name="line-2144"></a><span>  </span><span class="hs-special">]</span><span>
</span><a name="line-2145"></a><span>
</span><a name="line-2146"></a><span class="hs-identifier">fixchar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Char</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Char</span><span>
</span><a name="line-2147"></a><a name="fixchar"><a href="DriverPipeline.html#fixchar"><span class="hs-identifier">fixchar</span></a></a><span> </span><span class="hs-char">'-'</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-char">'_'</span><span>
</span><a name="line-2148"></a><span class="hs-identifier">fixchar</span><span> </span><a name="local-6989586621685142270"><a href="#local-6989586621685142270"><span class="hs-identifier">c</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685142270"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-2149"></a><span>
</span><a name="line-2150"></a><span class="hs-identifier">generateMacros</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Version</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-2151"></a><a name="generateMacros"><a href="DriverPipeline.html#generateMacros"><span class="hs-identifier">generateMacros</span></a></a><span> </span><a name="local-6989586621685142271"><a href="#local-6989586621685142271"><span class="hs-identifier">prefix</span></a></a><span> </span><a name="local-6989586621685142272"><a href="#local-6989586621685142272"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621685142273"><a href="#local-6989586621685142273"><span class="hs-identifier">version</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2152"></a><span>  </span><span class="hs-identifier hs-var">concat</span><span>
</span><a name="line-2153"></a><span>  </span><span class="hs-special">[</span><span class="hs-string">&quot;#define &quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685142271"><span class="hs-identifier hs-var">prefix</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;VERSION_&quot;</span><span class="hs-special">,</span><a href="#local-6989586621685142272"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span class="hs-string">&quot; &quot;</span><span class="hs-special">,</span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">showVersion</span><span> </span><a href="#local-6989586621685142273"><span class="hs-identifier hs-var">version</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-string">&quot;\n&quot;</span><span>
</span><a name="line-2154"></a><span>  </span><span class="hs-special">,</span><span class="hs-string">&quot;#define MIN_&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685142271"><span class="hs-identifier hs-var">prefix</span></a><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;VERSION_&quot;</span><span class="hs-special">,</span><a href="#local-6989586621685142272"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span class="hs-string">&quot;(major1,major2,minor) (\\\n&quot;</span><span>
</span><a name="line-2155"></a><span>  </span><span class="hs-special">,</span><span class="hs-string">&quot;  (major1) &lt;  &quot;</span><span class="hs-special">,</span><a href="#local-6989586621685142274"><span class="hs-identifier hs-var">major1</span></a><span class="hs-special">,</span><span class="hs-string">&quot; || \\\n&quot;</span><span>
</span><a name="line-2156"></a><span>  </span><span class="hs-special">,</span><span class="hs-string">&quot;  (major1) == &quot;</span><span class="hs-special">,</span><a href="#local-6989586621685142274"><span class="hs-identifier hs-var">major1</span></a><span class="hs-special">,</span><span class="hs-string">&quot; &amp;&amp; (major2) &lt;  &quot;</span><span class="hs-special">,</span><a href="#local-6989586621685142275"><span class="hs-identifier hs-var">major2</span></a><span class="hs-special">,</span><span class="hs-string">&quot; || \\\n&quot;</span><span>
</span><a name="line-2157"></a><span>  </span><span class="hs-special">,</span><span class="hs-string">&quot;  (major1) == &quot;</span><span class="hs-special">,</span><a href="#local-6989586621685142274"><span class="hs-identifier hs-var">major1</span></a><span class="hs-special">,</span><span class="hs-string">&quot; &amp;&amp; (major2) == &quot;</span><span class="hs-special">,</span><a href="#local-6989586621685142275"><span class="hs-identifier hs-var">major2</span></a><span class="hs-special">,</span><span class="hs-string">&quot; &amp;&amp; (minor) &lt;= &quot;</span><span class="hs-special">,</span><a href="#local-6989586621685142276"><span class="hs-identifier hs-var">minor</span></a><span class="hs-special">,</span><span class="hs-string">&quot;)&quot;</span><span>
</span><a name="line-2158"></a><span>  </span><span class="hs-special">,</span><span class="hs-string">&quot;\n\n&quot;</span><span>
</span><a name="line-2159"></a><span>  </span><span class="hs-special">]</span><span>
</span><a name="line-2160"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2161"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621685142274"><a href="#local-6989586621685142274"><span class="hs-identifier">major1</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621685142275"><a href="#local-6989586621685142275"><span class="hs-identifier">major2</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621685142276"><a href="#local-6989586621685142276"><span class="hs-identifier">minor</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">versionBranch</span><span> </span><a href="#local-6989586621685142273"><span class="hs-identifier hs-var">version</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">repeat</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-2162"></a><span>
</span><a name="line-2163"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-2164"></a><span class="hs-comment">-- join object files into a single relocatable object file, using ld -r</span><span>
</span><a name="line-2165"></a><span>
</span><a name="line-2166"></a><span class="hs-comment">{-
Note [Produce big objects on Windows]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The Windows Portable Executable object format has a limit of 32k sections, which
we tend to blow through pretty easily. Thankfully, there is a &quot;big object&quot;
extension, which raises this limit to 2^32. However, it must be explicitly
enabled in the toolchain:

 * the assembler accepts the -mbig-obj flag, which causes it to produce a
   bigobj-enabled COFF object.

 * the linker accepts the --oformat pe-bigobj-x86-64 flag. Despite what the name
   suggests, this tells the linker to produce a bigobj-enabled COFF object, no a
   PE executable.

We must enable bigobj output in a few places:

 * When merging object files (DriverPipeline.joinObjectFiles)

 * When assembling (DriverPipeline.runPhase (RealPhase As ...))

Unfortunately the big object format is not supported on 32-bit targets so
none of this can be used in that case.
-}</span><span>
</span><a name="line-2191"></a><span>
</span><a name="line-2192"></a><span class="hs-identifier">joinObjectFiles</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2193"></a><a name="joinObjectFiles"><a href="DriverPipeline.html#joinObjectFiles"><span class="hs-identifier">joinObjectFiles</span></a></a><span> </span><a name="local-6989586621685142277"><a href="#local-6989586621685142277"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685142278"><a href="#local-6989586621685142278"><span class="hs-identifier">o_files</span></a></a><span> </span><a name="local-6989586621685142279"><a href="#local-6989586621685142279"><span class="hs-identifier">output_fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2194"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142280"><a href="#local-6989586621685142280"><span class="hs-identifier">mySettings</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">settings</span><span> </span><a href="#local-6989586621685142277"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-2195"></a><span>      </span><a name="local-6989586621685142281"><a href="#local-6989586621685142281"><span class="hs-identifier">ldIsGnuLd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sLdIsGnuLd</span><span> </span><a href="#local-6989586621685142280"><span class="hs-identifier hs-var">mySettings</span></a><span>
</span><a name="line-2196"></a><span>      </span><a name="local-6989586621685142282"><a href="#local-6989586621685142282"><span class="hs-identifier">osInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">platformOS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621685142277"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-2197"></a><span>      </span><a name="local-6989586621685142283"><a href="#local-6989586621685142283"><span class="hs-identifier">ld_r</span></a></a><span> </span><a name="local-6989586621685142285"><a href="#local-6989586621685142285"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621685142286"><a href="#local-6989586621685142286"><span class="hs-identifier">cc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SysTools.Tasks.html#runLink"><span class="hs-identifier hs-var">SysTools.runLink</span></a><span> </span><a href="#local-6989586621685142277"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span>
</span><a name="line-2198"></a><span>                       </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-string">&quot;-nostdlib&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-2199"></a><span>                       </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-string">&quot;-Wl,-r&quot;</span><span>
</span><a name="line-2200"></a><span>                     </span><span class="hs-special">]</span><span>
</span><a name="line-2201"></a><span>                        </span><span class="hs-comment">-- See Note [No PIE while linking] in DynFlags</span><span>
</span><a name="line-2202"></a><span>                     </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">sGccSupportsNoPie</span><span> </span><a href="#local-6989586621685142280"><span class="hs-identifier hs-var">mySettings</span></a><span>
</span><a name="line-2203"></a><span>                          </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-string">&quot;-no-pie&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-2204"></a><span>                          </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2205"></a><span>
</span><a name="line-2206"></a><span>                     </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685142286"><span class="hs-identifier hs-var">cc</span></a><span> </span><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Clang</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">AppleClang</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">AppleClang51</span><span class="hs-special">]</span><span>
</span><a name="line-2207"></a><span>                          </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2208"></a><span>                          </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-string">&quot;-nodefaultlibs&quot;</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2209"></a><span>                     </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621685142282"><span class="hs-identifier hs-var">osInfo</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">OSFreeBSD</span><span>
</span><a name="line-2210"></a><span>                          </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-string">&quot;-L/usr/lib&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-2211"></a><span>                          </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2212"></a><span>                        </span><span class="hs-comment">-- gcc on sparc sets -Wl,--relax implicitly, but</span><span>
</span><a name="line-2213"></a><span>                        </span><span class="hs-comment">-- -r and --relax are incompatible for ld, so</span><span>
</span><a name="line-2214"></a><span>                        </span><span class="hs-comment">-- disable --relax explicitly.</span><span>
</span><a name="line-2215"></a><span>                     </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">platformArch</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621685142277"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-2216"></a><span>                                </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ArchSPARC</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ArchSPARC64</span><span class="hs-special">]</span><span>
</span><a name="line-2217"></a><span>                         </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621685142281"><span class="hs-identifier hs-var">ldIsGnuLd</span></a><span>
</span><a name="line-2218"></a><span>                            </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-string">&quot;-Wl,-no-relax&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-2219"></a><span>                            </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2220"></a><span>                        </span><span class="hs-comment">-- See Note [Produce big objects on Windows]</span><span>
</span><a name="line-2221"></a><span>                     </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-string">&quot;-Wl,--oformat,pe-bigobj-x86-64&quot;</span><span>
</span><a name="line-2222"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">OSMinGW32</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621685142282"><span class="hs-identifier hs-var">osInfo</span></a><span>
</span><a name="line-2223"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">target32Bit</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621685142277"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-2224"></a><span>                        </span><span class="hs-special">]</span><span>
</span><a name="line-2225"></a><span>                     </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><a href="#local-6989586621685142284"><span class="hs-identifier hs-var">ld_build_id</span></a><span>
</span><a name="line-2226"></a><span>                     </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-string">&quot;-o&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-2227"></a><span>                          </span><span class="hs-identifier hs-var">SysTools.FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621685142279"><span class="hs-identifier hs-var">output_fn</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2228"></a><span>                     </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685142285"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-2229"></a><span>
</span><a name="line-2230"></a><span>      </span><span class="hs-comment">-- suppress the generation of the .note.gnu.build-id section,</span><span>
</span><a name="line-2231"></a><span>      </span><span class="hs-comment">-- which we don't need and sometimes causes ld to emit a</span><span>
</span><a name="line-2232"></a><span>      </span><span class="hs-comment">-- warning:</span><span>
</span><a name="line-2233"></a><span>      </span><a name="local-6989586621685142284"><a href="#local-6989586621685142284"><span class="hs-identifier">ld_build_id</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">sLdSupportsBuildId</span><span> </span><a href="#local-6989586621685142280"><span class="hs-identifier hs-var">mySettings</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;-Wl,--build-id=none&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-2234"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2235"></a><span>
</span><a name="line-2236"></a><span>  </span><a name="local-6989586621685142287"><a href="#local-6989586621685142287"><span class="hs-identifier">ccInfo</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SysTools.Info.html#getCompilerInfo"><span class="hs-identifier hs-var">getCompilerInfo</span></a><span> </span><a href="#local-6989586621685142277"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-2237"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621685142281"><span class="hs-identifier hs-var">ldIsGnuLd</span></a><span>
</span><a name="line-2238"></a><span>     </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2239"></a><span>          </span><a name="local-6989586621685142288"><a href="#local-6989586621685142288"><span class="hs-identifier">script</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newTempName</span><span> </span><a href="#local-6989586621685142277"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">TFL_CurrentModule</span><span> </span><span class="hs-string">&quot;ldscript&quot;</span><span>
</span><a name="line-2240"></a><span>          </span><a name="local-6989586621685142289"><a href="#local-6989586621685142289"><span class="hs-identifier">cwd</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getCurrentDirectory</span><span>
</span><a name="line-2241"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685142290"><a href="#local-6989586621685142290"><span class="hs-identifier">o_files_abs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621685142291"><a href="#local-6989586621685142291"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;\&quot;&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685142289"><span class="hs-identifier hs-var">cwd</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><a href="#local-6989586621685142291"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;\&quot;&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685142278"><span class="hs-identifier hs-var">o_files</span></a><span>
</span><a name="line-2242"></a><span>          </span><span class="hs-identifier hs-var">writeFile</span><span> </span><a href="#local-6989586621685142288"><span class="hs-identifier hs-var">script</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;INPUT(&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">unwords</span><span> </span><a href="#local-6989586621685142290"><span class="hs-identifier hs-var">o_files_abs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;)&quot;</span><span>
</span><a name="line-2243"></a><span>          </span><a href="#local-6989586621685142283"><span class="hs-identifier hs-var">ld_r</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">SysTools.FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621685142288"><span class="hs-identifier hs-var">script</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621685142287"><span class="hs-identifier hs-var">ccInfo</span></a><span>
</span><a name="line-2244"></a><span>     </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">sLdSupportsFilelist</span><span> </span><a href="#local-6989586621685142280"><span class="hs-identifier hs-var">mySettings</span></a><span>
</span><a name="line-2245"></a><span>     </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2246"></a><span>          </span><a name="local-6989586621685142292"><a href="#local-6989586621685142292"><span class="hs-identifier">filelist</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newTempName</span><span> </span><a href="#local-6989586621685142277"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">TFL_CurrentModule</span><span> </span><span class="hs-string">&quot;filelist&quot;</span><span>
</span><a name="line-2247"></a><span>          </span><span class="hs-identifier hs-var">writeFile</span><span> </span><a href="#local-6989586621685142292"><span class="hs-identifier hs-var">filelist</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unlines</span><span> </span><a href="#local-6989586621685142278"><span class="hs-identifier hs-var">o_files</span></a><span>
</span><a name="line-2248"></a><span>          </span><a href="#local-6989586621685142283"><span class="hs-identifier hs-var">ld_r</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">SysTools.Option</span><span> </span><span class="hs-string">&quot;-Wl,-filelist&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-2249"></a><span>                </span><span class="hs-identifier hs-var">SysTools.FileOption</span><span> </span><span class="hs-string">&quot;-Wl,&quot;</span><span> </span><a href="#local-6989586621685142292"><span class="hs-identifier hs-var">filelist</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621685142287"><span class="hs-identifier hs-var">ccInfo</span></a><span>
</span><a name="line-2250"></a><span>     </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2251"></a><span>          </span><a href="#local-6989586621685142283"><span class="hs-identifier hs-var">ld_r</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SysTools.FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685142278"><span class="hs-identifier hs-var">o_files</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685142287"><span class="hs-identifier hs-var">ccInfo</span></a><span>
</span><a name="line-2252"></a><span>
</span><a name="line-2253"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-2254"></a><span class="hs-comment">-- Misc.</span><span>
</span><a name="line-2255"></a><span>
</span><a name="line-2256"></a><span class="hs-identifier">writeInterfaceOnlyMode</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2257"></a><a name="writeInterfaceOnlyMode"><a href="DriverPipeline.html#writeInterfaceOnlyMode"><span class="hs-identifier">writeInterfaceOnlyMode</span></a></a><span> </span><a name="local-6989586621685142293"><a href="#local-6989586621685142293"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2258"></a><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_WriteInterface</span><span> </span><a href="#local-6989586621685142293"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-2259"></a><span> </span><span class="hs-identifier hs-var">HscNothing</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">hscTarget</span><span> </span><a href="#local-6989586621685142293"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-2260"></a><span>
</span><a name="line-2261"></a><span class="hs-comment">-- | Figure out if a source file was modified after an output file (or if we</span><span>
</span><a name="line-2262"></a><span class="hs-comment">-- anyways need to consider the source file modified since the output is gone).</span><span>
</span><a name="line-2263"></a><span class="hs-identifier">sourceModified</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-comment">-- ^ destination file we are looking for</span><span>
</span><a name="line-2264"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UTCTime</span><span>  </span><span class="hs-comment">-- ^ last time of modification of source file</span><span>
</span><a name="line-2265"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>  </span><span class="hs-comment">-- ^ do we need to regenerate the output?</span><span>
</span><a name="line-2266"></a><a name="sourceModified"><a href="DriverPipeline.html#sourceModified"><span class="hs-identifier">sourceModified</span></a></a><span> </span><a name="local-6989586621685142294"><a href="#local-6989586621685142294"><span class="hs-identifier">dest_file</span></a></a><span> </span><a name="local-6989586621685142295"><a href="#local-6989586621685142295"><span class="hs-identifier">src_timestamp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2267"></a><span>  </span><a name="local-6989586621685142296"><a href="#local-6989586621685142296"><span class="hs-identifier">dest_file_exists</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">doesFileExist</span><span> </span><a href="#local-6989586621685142294"><span class="hs-identifier hs-var">dest_file</span></a><span>
</span><a name="line-2268"></a><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621685142296"><span class="hs-identifier hs-var">dest_file_exists</span></a><span>
</span><a name="line-2269"></a><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">True</span><span>       </span><span class="hs-comment">-- Need to recompile</span><span>
</span><a name="line-2270"></a><span>     </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621685142297"><a href="#local-6989586621685142297"><span class="hs-identifier">t2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModificationUTCTime</span><span> </span><a href="#local-6989586621685142294"><span class="hs-identifier hs-var">dest_file</span></a><span>
</span><a name="line-2271"></a><span>             </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685142297"><span class="hs-identifier hs-var">t2</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><a href="#local-6989586621685142295"><span class="hs-identifier hs-var">src_timestamp</span></a><span class="hs-special">)</span><span>
</span><a name="line-2272"></a><span>
</span><a name="line-2273"></a><span class="hs-comment">-- | What phase to run after one of the backend code generators has run</span><span>
</span><a name="line-2274"></a><span class="hs-identifier">hscPostBackendPhase</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HscSource</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HscTarget</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Phase</span><span>
</span><a name="line-2275"></a><a name="hscPostBackendPhase"><a href="DriverPipeline.html#hscPostBackendPhase"><span class="hs-identifier">hscPostBackendPhase</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">HsBootFile</span><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">StopLn</span><span>
</span><a name="line-2276"></a><span class="hs-identifier">hscPostBackendPhase</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">HsigFile</span><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">StopLn</span><span>
</span><a name="line-2277"></a><span class="hs-identifier">hscPostBackendPhase</span><span> </span><a name="local-6989586621685142298"><a href="#local-6989586621685142298"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621685142299"><a href="#local-6989586621685142299"><span class="hs-identifier">hsc_lang</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2278"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685142299"><span class="hs-identifier hs-var">hsc_lang</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2279"></a><span>        </span><span class="hs-identifier hs-var">HscC</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">HCc</span><span>
</span><a name="line-2280"></a><span>        </span><span class="hs-identifier hs-var">HscAsm</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_SplitObjs</span><span> </span><a href="#local-6989586621685142298"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Splitter</span><span>
</span><a name="line-2281"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">As</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2282"></a><span>        </span><span class="hs-identifier hs-var">HscLlvm</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">LlvmOpt</span><span>
</span><a name="line-2283"></a><span>        </span><span class="hs-identifier hs-var">HscNothing</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">StopLn</span><span>
</span><a name="line-2284"></a><span>        </span><span class="hs-identifier hs-var">HscInterpreted</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">StopLn</span><span>
</span><a name="line-2285"></a><span>
</span><a name="line-2286"></a><span class="hs-identifier">touchObjectFile</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2287"></a><a name="touchObjectFile"><a href="DriverPipeline.html#touchObjectFile"><span class="hs-identifier">touchObjectFile</span></a></a><span> </span><a name="local-6989586621685142300"><a href="#local-6989586621685142300"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621685142301"><a href="#local-6989586621685142301"><span class="hs-identifier">path</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2288"></a><span>  </span><span class="hs-identifier hs-var">createDirectoryIfMissing</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">takeDirectory</span><span> </span><a href="#local-6989586621685142301"><span class="hs-identifier hs-var">path</span></a><span>
</span><a name="line-2289"></a><span>  </span><a href="SysTools.Tasks.html#touch"><span class="hs-identifier hs-var">SysTools.touch</span></a><span> </span><a href="#local-6989586621685142300"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-string">&quot;Touching object file&quot;</span><span> </span><a href="#local-6989586621685142301"><span class="hs-identifier hs-var">path</span></a><span>
</span><a name="line-2290"></a><span>
</span><a name="line-2291"></a><span class="hs-comment">-- | Find out path to @ghcversion.h@ file</span><span>
</span><a name="line-2292"></a><span class="hs-identifier">getGhcVersionPathName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-2293"></a><a name="getGhcVersionPathName"><a href="DriverPipeline.html#getGhcVersionPathName"><span class="hs-identifier">getGhcVersionPathName</span></a></a><span> </span><a name="local-6989586621685142302"><a href="#local-6989586621685142302"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2294"></a><span>  </span><a name="local-6989586621685142304"><a href="#local-6989586621685142304"><span class="hs-identifier">candidates</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">ghcVersionFile</span><span> </span><a href="#local-6989586621685142302"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2295"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685142303"><a href="#local-6989586621685142303"><span class="hs-identifier">path</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621685142303"><span class="hs-identifier hs-var">path</span></a><span class="hs-special">]</span><span>
</span><a name="line-2296"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><span class="hs-string">&quot;ghcversion.h&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span>
</span><a name="line-2297"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getPackageIncludePath</span><span> </span><a href="#local-6989586621685142302"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">toInstalledUnitId</span><span> </span><span class="hs-identifier hs-var">rtsUnitId</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2298"></a><span>
</span><a name="line-2299"></a><span>  </span><a name="local-6989586621685142305"><a href="#local-6989586621685142305"><span class="hs-identifier">found</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">filterM</span><span> </span><span class="hs-identifier hs-var">doesFileExist</span><span> </span><a href="#local-6989586621685142304"><span class="hs-identifier hs-var">candidates</span></a><span>
</span><a name="line-2300"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685142305"><span class="hs-identifier hs-var">found</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2301"></a><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throwGhcExceptionIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">InstallationError</span><span>
</span><a name="line-2302"></a><span>                                    </span><span class="hs-special">(</span><span class="hs-string">&quot;ghcversion.h missing; tried: &quot;</span><span>
</span><a name="line-2303"></a><span>                                      </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">intercalate</span><span> </span><span class="hs-string">&quot;, &quot;</span><span> </span><a href="#local-6989586621685142304"><span class="hs-identifier hs-var">candidates</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2304"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621685142306"><a href="#local-6989586621685142306"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685142306"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-2305"></a><span>
</span><a name="line-2306"></a><span class="hs-comment">-- Note [-fPIC for assembler]</span><span>
</span><a name="line-2307"></a><span class="hs-comment">-- When compiling .c source file GHC's driver pipeline basically</span><span>
</span><a name="line-2308"></a><span class="hs-comment">-- does the following two things:</span><span>
</span><a name="line-2309"></a><span class="hs-comment">--   1. ${CC}              -S 'PIC_CFLAGS' source.c</span><span>
</span><a name="line-2310"></a><span class="hs-comment">--   2. ${CC} -x assembler -c 'PIC_CFLAGS' source.S</span><span>
</span><a name="line-2311"></a><span class="hs-comment">--</span><span>
</span><a name="line-2312"></a><span class="hs-comment">-- Why do we need to pass 'PIC_CFLAGS' both to C compiler and assembler?</span><span>
</span><a name="line-2313"></a><span class="hs-comment">-- Because on some architectures (at least sparc32) assembler also chooses</span><span>
</span><a name="line-2314"></a><span class="hs-comment">-- the relocation type!</span><span>
</span><a name="line-2315"></a><span class="hs-comment">-- Consider the following C module:</span><span>
</span><a name="line-2316"></a><span class="hs-comment">--</span><span>
</span><a name="line-2317"></a><span class="hs-comment">--     /* pic-sample.c */</span><span>
</span><a name="line-2318"></a><span class="hs-comment">--     int v;</span><span>
</span><a name="line-2319"></a><span class="hs-comment">--     void set_v (int n) { v = n; }</span><span>
</span><a name="line-2320"></a><span class="hs-comment">--     int  get_v (void)  { return v; }</span><span>
</span><a name="line-2321"></a><span class="hs-comment">--</span><span>
</span><a name="line-2322"></a><span class="hs-comment">--     $ gcc -S -fPIC pic-sample.c</span><span>
</span><a name="line-2323"></a><span class="hs-comment">--     $ gcc -c       pic-sample.s -o pic-sample.no-pic.o # incorrect binary</span><span>
</span><a name="line-2324"></a><span class="hs-comment">--     $ gcc -c -fPIC pic-sample.s -o pic-sample.pic.o    # correct binary</span><span>
</span><a name="line-2325"></a><span class="hs-comment">--</span><span>
</span><a name="line-2326"></a><span class="hs-comment">--     $ objdump -r -d pic-sample.pic.o    &gt; pic-sample.pic.o.od</span><span>
</span><a name="line-2327"></a><span class="hs-comment">--     $ objdump -r -d pic-sample.no-pic.o &gt; pic-sample.no-pic.o.od</span><span>
</span><a name="line-2328"></a><span class="hs-comment">--     $ diff -u pic-sample.pic.o.od pic-sample.no-pic.o.od</span><span>
</span><a name="line-2329"></a><span class="hs-comment">--</span><span>
</span><a name="line-2330"></a><span class="hs-comment">-- Most of architectures won't show any difference in this test, but on sparc32</span><span>
</span><a name="line-2331"></a><span class="hs-comment">-- the following assembly snippet:</span><span>
</span><a name="line-2332"></a><span class="hs-comment">--</span><span>
</span><a name="line-2333"></a><span class="hs-comment">--    sethi   %hi(_GLOBAL_OFFSET_TABLE_-8), %l7</span><span>
</span><a name="line-2334"></a><span class="hs-comment">--</span><span>
</span><a name="line-2335"></a><span class="hs-comment">-- generates two kinds or relocations, only 'R_SPARC_PC22' is correct:</span><span>
</span><a name="line-2336"></a><span class="hs-comment">--</span><span>
</span><a name="line-2337"></a><span class="hs-comment">--       3c:  2f 00 00 00     sethi  %hi(0), %l7</span><span>
</span><a name="line-2338"></a><span class="hs-comment">--    -                       3c: R_SPARC_PC22        _GLOBAL_OFFSET_TABLE_-0x8</span><span>
</span><a name="line-2339"></a><span class="hs-comment">--    +                       3c: R_SPARC_HI22        _GLOBAL_OFFSET_TABLE_-0x8</span><span>
</span><a name="line-2340"></a><span>
</span><a name="line-2341"></a><span class="hs-comment">{- Note [Don't normalise input filenames]

Summary
  We used to normalise input filenames when starting the unlit phase. This
  broke hpc in `--make` mode with imported literate modules (#2991).

Introduction
  1) --main
  When compiling a module with --main, GHC scans its imports to find out which
  other modules it needs to compile too. It turns out that there is a small
  difference between saying `ghc --make A.hs`, when `A` imports `B`, and
  specifying both modules on the command line with `ghc --make A.hs B.hs`. In
  the former case, the filename for B is inferred to be './B.hs' instead of
  'B.hs'.

  2) unlit
  When GHC compiles a literate haskell file, the source code first needs to go
  through unlit, which turns it into normal Haskell source code. At the start
  of the unlit phase, in `Driver.Pipeline.runPhase`, we call unlit with the
  option `-h` and the name of the original file. We used to normalise this
  filename using System.FilePath.normalise, which among other things removes
  an initial './'. unlit then uses that filename in #line directives that it
  inserts in the transformed source code.

  3) SrcSpan
  A SrcSpan represents a portion of a source code file. It has fields
  linenumber, start column, end column, and also a reference to the file it
  originated from. The SrcSpans for a literate haskell file refer to the
  filename that was passed to unlit -h.

  4) -fhpc
  At some point during compilation with -fhpc, in the function
  `deSugar.Coverage.isGoodTickSrcSpan`, we compare the filename that a
  `SrcSpan` refers to with the name of the file we are currently compiling.
  For some reason I don't yet understand, they can sometimes legitimally be
  different, and then hpc ignores that SrcSpan.

Problem
  When running `ghc --make -fhpc A.hs`, where `A.hs` imports the literate
  module `B.lhs`, `B` is inferred to be in the file `./B.lhs` (1). At the
  start of the unlit phase, the name `./B.lhs` is normalised to `B.lhs` (2).
  Therefore the SrcSpans of `B` refer to the file `B.lhs` (3), but we are
  still compiling `./B.lhs`. Hpc thinks these two filenames are different (4),
  doesn't include ticks for B, and we have unhappy customers (#2991).

Solution
  Do not normalise `input_fn` when starting the unlit phase.

Alternative solution
  Another option would be to not compare the two filenames on equality, but to
  use System.FilePath.equalFilePath. That function first normalises its
  arguments. The problem is that by the time we need to do the comparison, the
  filenames have been turned into FastStrings, probably for performance
  reasons, so System.FilePath.equalFilePath can not be used directly.

Archeology
  The call to `normalise` was added in a commit called &quot;Fix slash
  direction on Windows with the new filePath code&quot; (c9b6b5e8). The problem
  that commit was addressing has since been solved in a different manner, in a
  commit called &quot;Fix the filename passed to unlit&quot; (1eedbc6b). So the
  `normalise` is no longer necessary.
-}</span><span>
</span><a name="line-2403"></a></pre></body></html>