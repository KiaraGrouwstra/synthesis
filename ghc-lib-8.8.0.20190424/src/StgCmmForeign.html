<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-2"></a><span class="hs-comment">--</span><span>
</span><a name="line-3"></a><span class="hs-comment">-- Code generation for foreign calls.</span><span>
</span><a name="line-4"></a><span class="hs-comment">--</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- (c) The University of Glasgow 2004-2006</span><span>
</span><a name="line-6"></a><span class="hs-comment">--</span><span>
</span><a name="line-7"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">StgCmmForeign</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-10"></a><span>  </span><a href="StgCmmForeign.html#cgForeignCall"><span class="hs-identifier hs-var">cgForeignCall</span></a><span class="hs-special">,</span><span>
</span><a name="line-11"></a><span>  </span><a href="StgCmmForeign.html#emitPrimCall"><span class="hs-identifier hs-var">emitPrimCall</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmForeign.html#emitCCall"><span class="hs-identifier hs-var">emitCCall</span></a><span class="hs-special">,</span><span>
</span><a name="line-12"></a><span>  </span><a href="StgCmmForeign.html#emitForeignCall"><span class="hs-identifier hs-var">emitForeignCall</span></a><span class="hs-special">,</span><span>     </span><span class="hs-comment">-- For CmmParse</span><span>
</span><a name="line-13"></a><span>  </span><a href="StgCmmForeign.html#emitSaveThreadState"><span class="hs-identifier hs-var">emitSaveThreadState</span></a><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>  </span><a href="StgCmmForeign.html#saveThreadState"><span class="hs-identifier hs-var">saveThreadState</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>  </span><a href="StgCmmForeign.html#emitLoadThreadState"><span class="hs-identifier hs-var">emitLoadThreadState</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>  </span><a href="StgCmmForeign.html#loadThreadState"><span class="hs-identifier hs-var">loadThreadState</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>  </span><a href="StgCmmForeign.html#emitOpenNursery"><span class="hs-identifier hs-var">emitOpenNursery</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>  </span><a href="StgCmmForeign.html#emitCloseNursery"><span class="hs-identifier hs-var">emitCloseNursery</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span> </span><span class="hs-keyword">hiding</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">succ</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;*&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="StgSyn.html"><span class="hs-identifier">StgSyn</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmProf.html"><span class="hs-identifier">StgCmmProf</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmProf.html#storeCurCCS"><span class="hs-identifier hs-var">storeCurCCS</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmProf.html#ccsType"><span class="hs-identifier hs-var">ccsType</span></a><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmEnv.html"><span class="hs-identifier">StgCmmEnv</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmMonad.html"><span class="hs-identifier">StgCmmMonad</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmUtils.html"><span class="hs-identifier">StgCmmUtils</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmClosure.html"><span class="hs-identifier">StgCmmClosure</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmLayout.html"><span class="hs-identifier">StgCmmLayout</span></a><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="BlockId.html"><span class="hs-identifier">BlockId</span></a><span> </span><span class="hs-special">(</span><a href="BlockId.html#newBlockId"><span class="hs-identifier hs-var">newBlockId</span></a><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="Cmm.html"><span class="hs-identifier">Cmm</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="CmmUtils.html"><span class="hs-identifier">CmmUtils</span></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="MkGraph.html"><span class="hs-identifier">MkGraph</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RepType</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysPrim</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="CLabel.html"><span class="hs-identifier">CLabel</span></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="SMRep.html"><span class="hs-identifier">SMRep</span></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ForeignCall</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSupply</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-50"></a><span class="hs-comment">-- Code generation for Foreign Calls</span><span>
</span><a name="line-51"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span class="hs-comment">-- | emit code for a foreign call, and return the results to the sequel.</span><span>
</span><a name="line-54"></a><span class="hs-comment">--</span><span>
</span><a name="line-55"></a><span class="hs-identifier">cgForeignCall</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ForeignCall</span><span>            </span><span class="hs-comment">-- the op</span><span>
</span><a name="line-56"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span class="hs-special">]</span><span>               </span><span class="hs-comment">-- x,y    arguments</span><span>
</span><a name="line-57"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>                   </span><span class="hs-comment">-- result type</span><span>
</span><a name="line-58"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="StgCmmMonad.html#ReturnKind"><span class="hs-identifier hs-type">ReturnKind</span></a><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><a name="cgForeignCall"><a href="StgCmmForeign.html#cgForeignCall"><span class="hs-identifier">cgForeignCall</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CCall</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CCallSpec</span><span> </span><a name="local-6989586621680964731"><a href="#local-6989586621680964731"><span class="hs-identifier">target</span></a></a><span> </span><a name="local-6989586621680964732"><a href="#local-6989586621680964732"><span class="hs-identifier">cconv</span></a></a><span> </span><a name="local-6989586621680964733"><a href="#local-6989586621680964733"><span class="hs-identifier">safety</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680964734"><a href="#local-6989586621680964734"><span class="hs-identifier">stg_args</span></a></a><span> </span><a name="local-6989586621680964735"><a href="#local-6989586621680964735"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-61"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680964736"><a href="#local-6989586621680964736"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-62"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- in the stdcall calling convention, the symbol needs @size appended</span><span>
</span><a name="line-63"></a><span>              </span><span class="hs-comment">-- to it, where size is the total number of bytes of arguments.  We</span><span>
</span><a name="line-64"></a><span>              </span><span class="hs-comment">-- attach this info to the CLabel here, and the CLabel pretty printer</span><span>
</span><a name="line-65"></a><span>              </span><span class="hs-comment">-- will generate the suffix when the label is printed.</span><span>
</span><a name="line-66"></a><span>            </span><a name="local-6989586621680964737"><a href="#local-6989586621680964737"><span class="hs-identifier">call_size</span></a></a><span> </span><a name="local-6989586621680964739"><a href="#local-6989586621680964739"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-67"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">StdCallConv</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680964732"><span class="hs-identifier hs-var">cconv</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sum</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621680964738"><span class="hs-identifier hs-var">arg_size</span></a><span> </span><a href="#local-6989586621680964739"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-68"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-69"></a><span>
</span><a name="line-70"></a><span>              </span><span class="hs-comment">-- ToDo: this might not be correct for 64-bit API</span><span>
</span><a name="line-71"></a><span>            </span><a name="local-6989586621680964738"><a href="#local-6989586621680964738"><span class="hs-identifier">arg_size</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680964740"><a href="#local-6989586621680964740"><span class="hs-identifier">arg</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">max</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">widthInBytes</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">typeWidth</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmExpr.html#cmmExprType"><span class="hs-identifier hs-var">cmmExprType</span></a><span> </span><a href="#local-6989586621680964736"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680964740"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span>                                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wORD_SIZE</span><span> </span><a href="#local-6989586621680964736"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680964741"><a href="#local-6989586621680964741"><span class="hs-identifier">cmm_args</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmForeign.html#getFCallArgs"><span class="hs-identifier hs-var">getFCallArgs</span></a><span> </span><a href="#local-6989586621680964734"><span class="hs-identifier hs-var">stg_args</span></a><span>
</span><a name="line-74"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680964742"><a href="#local-6989586621680964742"><span class="hs-identifier">res_regs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680964743"><a href="#local-6989586621680964743"><span class="hs-identifier">res_hints</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmUtils.html#newUnboxedTupleRegs"><span class="hs-identifier hs-var">newUnboxedTupleRegs</span></a><span> </span><a href="#local-6989586621680964735"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-75"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621680964744"><a href="#local-6989586621680964744"><span class="hs-identifier">call_args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680964745"><a href="#local-6989586621680964745"><span class="hs-identifier">arg_hints</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680964746"><a href="#local-6989586621680964746"><span class="hs-identifier">cmm_target</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-76"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680964731"><span class="hs-identifier hs-var">target</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-77"></a><span>                   </span><span class="hs-identifier hs-var">StaticTarget</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-identifier">_</span><span>      </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-78"></a><span>                       </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;cgForeignCall: unexpected FFI value import&quot;</span><span>
</span><a name="line-79"></a><span>                   </span><span class="hs-identifier hs-var">StaticTarget</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680964749"><a href="#local-6989586621680964749"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621680964750"><a href="#local-6989586621680964750"><span class="hs-identifier">mPkgId</span></a></a><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-80"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680964751"><a href="#local-6989586621680964751"><span class="hs-identifier">labelSource</span></a></a><span>
</span><a name="line-81"></a><span>                                </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680964750"><span class="hs-identifier hs-var">mPkgId</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-82"></a><span>                                        </span><span class="hs-identifier hs-var">Nothing</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#ForeignLabelInThisPackage"><span class="hs-identifier hs-var">ForeignLabelInThisPackage</span></a><span>
</span><a name="line-83"></a><span>                                        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680964753"><a href="#local-6989586621680964753"><span class="hs-identifier">pkgId</span></a></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#ForeignLabelInPackage"><span class="hs-identifier hs-var">ForeignLabelInPackage</span></a><span> </span><a href="#local-6989586621680964753"><span class="hs-identifier hs-var">pkgId</span></a><span>
</span><a name="line-84"></a><span>                            </span><a name="local-6989586621680964752"><a href="#local-6989586621680964752"><span class="hs-identifier">size</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680964737"><span class="hs-identifier hs-var">call_size</span></a><span> </span><a href="#local-6989586621680964741"><span class="hs-identifier hs-var">cmm_args</span></a><span>
</span><a name="line-85"></a><span>                        </span><span class="hs-keyword">in</span><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621680964741"><span class="hs-identifier hs-var">cmm_args</span></a><span>
</span><a name="line-86"></a><span>                            </span><span class="hs-special">,</span><span> </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLabel"><span class="hs-identifier hs-var">CmmLabel</span></a><span>
</span><a name="line-87"></a><span>                                        </span><span class="hs-special">(</span><a href="CLabel.html#mkForeignLabel"><span class="hs-identifier hs-var">mkForeignLabel</span></a><span> </span><a href="#local-6989586621680964749"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621680964752"><span class="hs-identifier hs-var">size</span></a><span> </span><a href="#local-6989586621680964751"><span class="hs-identifier hs-var">labelSource</span></a><span> </span><span class="hs-identifier hs-var">IsFunction</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-88"></a><span>
</span><a name="line-89"></a><span>                   </span><span class="hs-identifier hs-var">DynamicTarget</span><span>    </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680964741"><span class="hs-identifier hs-var">cmm_args</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-90"></a><span>                                           </span><span class="hs-special">(</span><a name="local-6989586621680964754"><a href="#local-6989586621680964754"><span class="hs-identifier">fn</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621680964755"><a href="#local-6989586621680964755"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621680964755"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680964754"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-91"></a><span>                                           </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;cgForeignCall []&quot;</span><span>
</span><a name="line-92"></a><span>              </span><a name="local-6989586621680964747"><a href="#local-6989586621680964747"><span class="hs-identifier">fc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#ForeignConvention"><span class="hs-identifier hs-var">ForeignConvention</span></a><span> </span><a href="#local-6989586621680964732"><span class="hs-identifier hs-var">cconv</span></a><span> </span><a href="#local-6989586621680964745"><span class="hs-identifier hs-var">arg_hints</span></a><span> </span><a href="#local-6989586621680964743"><span class="hs-identifier hs-var">res_hints</span></a><span> </span><a href="CmmNode.html#CmmMayReturn"><span class="hs-identifier hs-var">CmmMayReturn</span></a><span>
</span><a name="line-93"></a><span>              </span><a name="local-6989586621680964748"><a href="#local-6989586621680964748"><span class="hs-identifier">call_target</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-var">ForeignTarget</span></a><span> </span><a href="#local-6989586621680964746"><span class="hs-identifier hs-var">cmm_target</span></a><span> </span><a href="#local-6989586621680964747"><span class="hs-identifier hs-var">fc</span></a><span>
</span><a name="line-94"></a><span>
</span><a name="line-95"></a><span>        </span><span class="hs-comment">-- we want to emit code for the call, and then emitReturn.</span><span>
</span><a name="line-96"></a><span>        </span><span class="hs-comment">-- However, if the sequel is AssignTo, we shortcut a little</span><span>
</span><a name="line-97"></a><span>        </span><span class="hs-comment">-- and generate a foreign call that assigns the results</span><span>
</span><a name="line-98"></a><span>        </span><span class="hs-comment">-- directly.  Otherwise we end up generating a bunch of</span><span>
</span><a name="line-99"></a><span>        </span><span class="hs-comment">-- useless &quot;r = r&quot; assignments, which are not merely annoying:</span><span>
</span><a name="line-100"></a><span>        </span><span class="hs-comment">-- they prevent the common block elimination from working correctly</span><span>
</span><a name="line-101"></a><span>        </span><span class="hs-comment">-- in the case of a safe foreign call.</span><span>
</span><a name="line-102"></a><span>        </span><span class="hs-comment">-- See Note [safe foreign call convention]</span><span>
</span><a name="line-103"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-104"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680964756"><a href="#local-6989586621680964756"><span class="hs-identifier">sequel</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getSequel"><span class="hs-identifier hs-var">getSequel</span></a><span>
</span><a name="line-105"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680964756"><span class="hs-identifier hs-var">sequel</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-106"></a><span>            </span><a href="StgCmmMonad.html#AssignTo"><span class="hs-identifier hs-var">AssignTo</span></a><span> </span><a name="local-6989586621680964757"><a href="#local-6989586621680964757"><span class="hs-identifier">assign_to_these</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-107"></a><span>                </span><a href="StgCmmForeign.html#emitForeignCall"><span class="hs-identifier hs-var">emitForeignCall</span></a><span> </span><a href="#local-6989586621680964733"><span class="hs-identifier hs-var">safety</span></a><span> </span><a href="#local-6989586621680964757"><span class="hs-identifier hs-var">assign_to_these</span></a><span> </span><a href="#local-6989586621680964748"><span class="hs-identifier hs-var">call_target</span></a><span> </span><a href="#local-6989586621680964744"><span class="hs-identifier hs-var">call_args</span></a><span>
</span><a name="line-108"></a><span>
</span><a name="line-109"></a><span>            </span><a name="local-6989586621680964758"><a href="#local-6989586621680964758"><span class="hs-identifier">_something_else</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-110"></a><span>                </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmForeign.html#emitForeignCall"><span class="hs-identifier hs-var">emitForeignCall</span></a><span> </span><a href="#local-6989586621680964733"><span class="hs-identifier hs-var">safety</span></a><span> </span><a href="#local-6989586621680964742"><span class="hs-identifier hs-var">res_regs</span></a><span> </span><a href="#local-6989586621680964748"><span class="hs-identifier hs-var">call_target</span></a><span> </span><a href="#local-6989586621680964744"><span class="hs-identifier hs-var">call_args</span></a><span>
</span><a name="line-111"></a><span>                   </span><span class="hs-special">;</span><span> </span><a href="StgCmmLayout.html#emitReturn"><span class="hs-identifier hs-var">emitReturn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680964742"><span class="hs-identifier hs-var">res_regs</span></a><span class="hs-special">)</span><span>
</span><a name="line-112"></a><span>                   </span><span class="hs-special">}</span><span>
</span><a name="line-113"></a><span>         </span><span class="hs-special">}</span><span>
</span><a name="line-114"></a><span>
</span><a name="line-115"></a><span class="hs-comment">{- Note [safe foreign call convention]

The simple thing to do for a safe foreign call would be the same as an
unsafe one: just

    emitForeignCall ...
    emitReturn ...

but consider what happens in this case

   case foo x y z of
     (# s, r #) -&gt; ...

The sequel is AssignTo [r].  The call to newUnboxedTupleRegs picks [r]
as the result reg, and we generate

  r = foo(x,y,z) returns to L1  -- emitForeignCall
 L1:
  r = r  -- emitReturn
  goto L2
L2:
  ...

Now L1 is a proc point (by definition, it is the continuation of the
safe foreign call).  If L2 does a heap check, then L2 will also be a
proc point.

Furthermore, the stack layout algorithm has to arrange to save r
somewhere between the call and the jump to L1, which is annoying: we
would have to treat r differently from the other live variables, which
have to be saved *before* the call.

So we adopt a special convention for safe foreign calls: the results
are copied out according to the NativeReturn convention by the call,
and the continuation of the call should copyIn the results.  (The
copyOut code is actually inserted when the safe foreign call is
lowered later).  The result regs attached to the safe foreign call are
only used temporarily to hold the results before they are copied out.

We will now generate this:

  r = foo(x,y,z) returns to L1
 L1:
  r = R1  -- copyIn, inserted by mkSafeCall
  goto L2
 L2:
  ... r ...

And when the safe foreign call is lowered later (see Note [lower safe
foreign calls]) we get this:

  suspendThread()
  r = foo(x,y,z)
  resumeThread()
  R1 = r  -- copyOut, inserted by lowerSafeForeignCall
  jump L1
 L1:
  r = R1  -- copyIn, inserted by mkSafeCall
  goto L2
 L2:
  ... r ...

Now consider what happens if L2 does a heap check: the Adams
optimisation kicks in and commons up L1 with the heap-check
continuation, resulting in just one proc point instead of two. Yay!
-}</span><span>
</span><a name="line-181"></a><span>
</span><a name="line-182"></a><span>
</span><a name="line-183"></a><span class="hs-identifier">emitCCall</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CmmNode.html#CmmFormal"><span class="hs-identifier hs-type">CmmFormal</span></a><span class="hs-special">,</span><span class="hs-identifier hs-type">ForeignHint</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-184"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>
</span><a name="line-185"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CmmNode.html#CmmActual"><span class="hs-identifier hs-type">CmmActual</span></a><span class="hs-special">,</span><span class="hs-identifier hs-type">ForeignHint</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-186"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-187"></a><a name="emitCCall"><a href="StgCmmForeign.html#emitCCall"><span class="hs-identifier">emitCCall</span></a></a><span> </span><a name="local-6989586621680964759"><a href="#local-6989586621680964759"><span class="hs-identifier">hinted_results</span></a></a><span> </span><a name="local-6989586621680964760"><a href="#local-6989586621680964760"><span class="hs-identifier">fn</span></a></a><span> </span><a name="local-6989586621680964761"><a href="#local-6989586621680964761"><span class="hs-identifier">hinted_args</span></a></a><span>
</span><a name="line-188"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="StgCmmForeign.html#emitForeignCall"><span class="hs-identifier hs-var">emitForeignCall</span></a><span> </span><span class="hs-identifier hs-var">PlayRisky</span><span> </span><a href="#local-6989586621680964764"><span class="hs-identifier hs-var">results</span></a><span> </span><a href="#local-6989586621680964766"><span class="hs-identifier hs-var">target</span></a><span> </span><a href="#local-6989586621680964762"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-189"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-190"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680964762"><a href="#local-6989586621680964762"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680964763"><a href="#local-6989586621680964763"><span class="hs-identifier">arg_hints</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621680964761"><span class="hs-identifier hs-var">hinted_args</span></a><span>
</span><a name="line-191"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680964764"><a href="#local-6989586621680964764"><span class="hs-identifier">results</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680964765"><a href="#local-6989586621680964765"><span class="hs-identifier">result_hints</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621680964759"><span class="hs-identifier hs-var">hinted_results</span></a><span>
</span><a name="line-192"></a><span>    </span><a name="local-6989586621680964766"><a href="#local-6989586621680964766"><span class="hs-identifier">target</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-var">ForeignTarget</span></a><span> </span><a href="#local-6989586621680964760"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621680964767"><span class="hs-identifier hs-var">fc</span></a><span>
</span><a name="line-193"></a><span>    </span><a name="local-6989586621680964767"><a href="#local-6989586621680964767"><span class="hs-identifier">fc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#ForeignConvention"><span class="hs-identifier hs-var">ForeignConvention</span></a><span> </span><span class="hs-identifier hs-var">CCallConv</span><span> </span><a href="#local-6989586621680964763"><span class="hs-identifier hs-var">arg_hints</span></a><span> </span><a href="#local-6989586621680964765"><span class="hs-identifier hs-var">result_hints</span></a><span> </span><a href="CmmNode.html#CmmMayReturn"><span class="hs-identifier hs-var">CmmMayReturn</span></a><span>
</span><a name="line-194"></a><span>
</span><a name="line-195"></a><span>
</span><a name="line-196"></a><span class="hs-identifier">emitPrimCall</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CmmNode.html#CmmFormal"><span class="hs-identifier hs-type">CmmFormal</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmMachOp.html#CallishMachOp"><span class="hs-identifier hs-type">CallishMachOp</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmNode.html#CmmActual"><span class="hs-identifier hs-type">CmmActual</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-197"></a><a name="emitPrimCall"><a href="StgCmmForeign.html#emitPrimCall"><span class="hs-identifier">emitPrimCall</span></a></a><span> </span><a name="local-6989586621680964768"><a href="#local-6989586621680964768"><span class="hs-identifier">res</span></a></a><span> </span><a name="local-6989586621680964769"><a href="#local-6989586621680964769"><span class="hs-identifier">op</span></a></a><span> </span><a name="local-6989586621680964770"><a href="#local-6989586621680964770"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-198"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="StgCmmForeign.html#emitForeignCall"><span class="hs-identifier hs-var">emitForeignCall</span></a><span> </span><span class="hs-identifier hs-var">PlayRisky</span><span> </span><a href="#local-6989586621680964768"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#PrimTarget"><span class="hs-identifier hs-var">PrimTarget</span></a><span> </span><a href="#local-6989586621680964769"><span class="hs-identifier hs-var">op</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680964770"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-199"></a><span>
</span><a name="line-200"></a><span class="hs-comment">-- alternative entry point, used by CmmParse</span><span>
</span><a name="line-201"></a><span class="hs-identifier">emitForeignCall</span><span>
</span><a name="line-202"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Safety</span><span>
</span><a name="line-203"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmNode.html#CmmFormal"><span class="hs-identifier hs-type">CmmFormal</span></a><span class="hs-special">]</span><span>          </span><span class="hs-comment">-- where to put the results</span><span>
</span><a name="line-204"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-type">ForeignTarget</span></a><span>        </span><span class="hs-comment">-- the op</span><span>
</span><a name="line-205"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmNode.html#CmmActual"><span class="hs-identifier hs-type">CmmActual</span></a><span class="hs-special">]</span><span>          </span><span class="hs-comment">-- arguments</span><span>
</span><a name="line-206"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="StgCmmMonad.html#ReturnKind"><span class="hs-identifier hs-type">ReturnKind</span></a><span>
</span><a name="line-207"></a><a name="emitForeignCall"><a href="StgCmmForeign.html#emitForeignCall"><span class="hs-identifier">emitForeignCall</span></a></a><span> </span><a name="local-6989586621680964771"><a href="#local-6989586621680964771"><span class="hs-identifier">safety</span></a></a><span> </span><a name="local-6989586621680964772"><a href="#local-6989586621680964772"><span class="hs-identifier">results</span></a></a><span> </span><a name="local-6989586621680964773"><a href="#local-6989586621680964773"><span class="hs-identifier">target</span></a></a><span> </span><a name="local-6989586621680964774"><a href="#local-6989586621680964774"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-208"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">playSafe</span><span> </span><a href="#local-6989586621680964771"><span class="hs-identifier hs-var">safety</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-209"></a><span>    </span><a name="local-6989586621680964775"><a href="#local-6989586621680964775"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-210"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680964776"><a href="#local-6989586621680964776"><span class="hs-identifier">caller_save</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680964777"><a href="#local-6989586621680964777"><span class="hs-identifier">caller_load</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmUtils.html#callerSaveVolatileRegs"><span class="hs-identifier hs-var">callerSaveVolatileRegs</span></a><span> </span><a href="#local-6989586621680964775"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-211"></a><span>    </span><a href="StgCmmMonad.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><a href="#local-6989586621680964776"><span class="hs-identifier hs-var">caller_save</span></a><span>
</span><a name="line-212"></a><span>    </span><a name="local-6989586621680964778"><a href="#local-6989586621680964778"><span class="hs-identifier">target'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmForeign.html#load_target_into_temp"><span class="hs-identifier hs-var">load_target_into_temp</span></a><span> </span><a href="#local-6989586621680964773"><span class="hs-identifier hs-var">target</span></a><span>
</span><a name="line-213"></a><span>    </span><a name="local-6989586621680964779"><a href="#local-6989586621680964779"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="StgCmmForeign.html#maybe_assign_temp"><span class="hs-identifier hs-var">maybe_assign_temp</span></a><span> </span><a href="#local-6989586621680964774"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-214"></a><span>    </span><a href="StgCmmMonad.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="MkGraph.html#mkUnsafeCall"><span class="hs-identifier hs-var">mkUnsafeCall</span></a><span> </span><a href="#local-6989586621680964778"><span class="hs-identifier hs-var">target'</span></a><span> </span><a href="#local-6989586621680964772"><span class="hs-identifier hs-var">results</span></a><span> </span><a href="#local-6989586621680964779"><span class="hs-identifier hs-var">args'</span></a><span>
</span><a name="line-215"></a><span>    </span><a href="StgCmmMonad.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><a href="#local-6989586621680964777"><span class="hs-identifier hs-var">caller_load</span></a><span>
</span><a name="line-216"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="StgCmmMonad.html#AssignedDirectly"><span class="hs-identifier hs-var">AssignedDirectly</span></a><span>
</span><a name="line-217"></a><span>
</span><a name="line-218"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-219"></a><span>    </span><a name="local-6989586621680964780"><a href="#local-6989586621680964780"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-220"></a><span>    </span><a name="local-6989586621680964781"><a href="#local-6989586621680964781"><span class="hs-identifier">updfr_off</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getUpdFrameOff"><span class="hs-identifier hs-var">getUpdFrameOff</span></a><span>
</span><a name="line-221"></a><span>    </span><a name="local-6989586621680964782"><a href="#local-6989586621680964782"><span class="hs-identifier">target'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmForeign.html#load_target_into_temp"><span class="hs-identifier hs-var">load_target_into_temp</span></a><span> </span><a href="#local-6989586621680964773"><span class="hs-identifier hs-var">target</span></a><span>
</span><a name="line-222"></a><span>    </span><a name="local-6989586621680964783"><a href="#local-6989586621680964783"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="StgCmmForeign.html#maybe_assign_temp"><span class="hs-identifier hs-var">maybe_assign_temp</span></a><span> </span><a href="#local-6989586621680964774"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-223"></a><span>    </span><a name="local-6989586621680964784"><a href="#local-6989586621680964784"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BlockId.html#newBlockId"><span class="hs-identifier hs-var">newBlockId</span></a><span>
</span><a name="line-224"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680964785"><a href="#local-6989586621680964785"><span class="hs-identifier">off</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680964786"><a href="#local-6989586621680964786"><span class="hs-identifier">copyout</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkGraph.html#copyInOflow"><span class="hs-identifier hs-var">copyInOflow</span></a><span> </span><a href="#local-6989586621680964780"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="CmmNode.html#NativeReturn"><span class="hs-identifier hs-var">NativeReturn</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#Young"><span class="hs-identifier hs-var">Young</span></a><span> </span><a href="#local-6989586621680964784"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680964772"><span class="hs-identifier hs-var">results</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-225"></a><span>       </span><span class="hs-comment">-- see Note [safe foreign call convention]</span><span>
</span><a name="line-226"></a><span>    </span><a name="local-6989586621680964787"><a href="#local-6989586621680964787"><span class="hs-identifier">tscope</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getTickScope"><span class="hs-identifier hs-var">getTickScope</span></a><span>
</span><a name="line-227"></a><span>    </span><a href="StgCmmMonad.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-228"></a><span>           </span><span class="hs-special">(</span><span>    </span><a href="MkGraph.html#mkStore"><span class="hs-identifier hs-var">mkStore</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmStackSlot"><span class="hs-identifier hs-var">CmmStackSlot</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#Young"><span class="hs-identifier hs-var">Young</span></a><span> </span><a href="#local-6989586621680964784"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">widthInBytes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wordWidth</span><span> </span><a href="#local-6989586621680964780"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-229"></a><span>                        </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmBlock"><span class="hs-identifier hs-var">CmmBlock</span></a><span> </span><a href="#local-6989586621680964784"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-230"></a><span>            </span><a href="MkGraph.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a><span> </span><a href="MkGraph.html#mkLast"><span class="hs-identifier hs-var">mkLast</span></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmForeignCall"><span class="hs-identifier hs-var">CmmForeignCall</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tgt</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680964782"><span class="hs-identifier hs-var">target'</span></a><span>
</span><a name="line-231"></a><span>                                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">res</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680964772"><span class="hs-identifier hs-var">results</span></a><span>
</span><a name="line-232"></a><span>                                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">args</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680964783"><span class="hs-identifier hs-var">args'</span></a><span>
</span><a name="line-233"></a><span>                                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">succ</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680964784"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-234"></a><span>                                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ret_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680964785"><span class="hs-identifier hs-var">off</span></a><span>
</span><a name="line-235"></a><span>                                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ret_off</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680964781"><span class="hs-identifier hs-var">updfr_off</span></a><span>
</span><a name="line-236"></a><span>                                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">intrbl</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">playInterruptible</span><span> </span><a href="#local-6989586621680964771"><span class="hs-identifier hs-var">safety</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-237"></a><span>            </span><a href="MkGraph.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a><span> </span><a href="MkGraph.html#mkLabel"><span class="hs-identifier hs-var">mkLabel</span></a><span> </span><a href="#local-6989586621680964784"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621680964787"><span class="hs-identifier hs-var">tscope</span></a><span>
</span><a name="line-238"></a><span>            </span><a href="MkGraph.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a><span> </span><a href="#local-6989586621680964786"><span class="hs-identifier hs-var">copyout</span></a><span>
</span><a name="line-239"></a><span>           </span><span class="hs-special">)</span><span>
</span><a name="line-240"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="StgCmmMonad.html#ReturnedTo"><span class="hs-identifier hs-var">ReturnedTo</span></a><span> </span><a href="#local-6989586621680964784"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621680964785"><span class="hs-identifier hs-var">off</span></a><span class="hs-special">)</span><span>
</span><a name="line-241"></a><span>
</span><a name="line-242"></a><span class="hs-identifier">load_target_into_temp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-type">ForeignTarget</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-type">ForeignTarget</span></a><span>
</span><a name="line-243"></a><a name="load_target_into_temp"><a href="StgCmmForeign.html#load_target_into_temp"><span class="hs-identifier">load_target_into_temp</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-var">ForeignTarget</span></a><span> </span><a name="local-6989586621680964788"><a href="#local-6989586621680964788"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621680964789"><a href="#local-6989586621680964789"><span class="hs-identifier">conv</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-244"></a><span>  </span><a name="local-6989586621680964790"><a href="#local-6989586621680964790"><span class="hs-identifier">tmp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmForeign.html#maybe_assign_temp"><span class="hs-identifier hs-var">maybe_assign_temp</span></a><span> </span><a href="#local-6989586621680964788"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-245"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-var">ForeignTarget</span></a><span> </span><a href="#local-6989586621680964790"><span class="hs-identifier hs-var">tmp</span></a><span> </span><a href="#local-6989586621680964789"><span class="hs-identifier hs-var">conv</span></a><span class="hs-special">)</span><span>
</span><a name="line-246"></a><span class="hs-identifier">load_target_into_temp</span><span> </span><a name="local-6989586621680964791"><a href="#local-6989586621680964791"><span class="hs-identifier">other_target</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CmmNode.html#PrimTarget"><span class="hs-identifier hs-var">PrimTarget</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-247"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680964791"><span class="hs-identifier hs-var">other_target</span></a><span>
</span><a name="line-248"></a><span>
</span><a name="line-249"></a><span class="hs-comment">-- What we want to do here is create a new temporary for the foreign</span><span>
</span><a name="line-250"></a><span class="hs-comment">-- call argument if it is not safe to use the expression directly,</span><span>
</span><a name="line-251"></a><span class="hs-comment">-- because the expression mentions caller-saves GlobalRegs (see</span><span>
</span><a name="line-252"></a><span class="hs-comment">-- Note [Register Parameter Passing]).</span><span>
</span><a name="line-253"></a><span class="hs-comment">--</span><span>
</span><a name="line-254"></a><span class="hs-comment">-- However, we can't pattern-match on the expression here, because</span><span>
</span><a name="line-255"></a><span class="hs-comment">-- this is used in a loop by CmmParse, and testing the expression</span><span>
</span><a name="line-256"></a><span class="hs-comment">-- results in a black hole.  So we always create a temporary, and rely</span><span>
</span><a name="line-257"></a><span class="hs-comment">-- on CmmSink to clean it up later.  (Yuck, ToDo).  The generated code</span><span>
</span><a name="line-258"></a><span class="hs-comment">-- ends up being the same, at least for the RTS .cmm code.</span><span>
</span><a name="line-259"></a><span class="hs-comment">--</span><span>
</span><a name="line-260"></a><span class="hs-identifier">maybe_assign_temp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>
</span><a name="line-261"></a><a name="maybe_assign_temp"><a href="StgCmmForeign.html#maybe_assign_temp"><span class="hs-identifier">maybe_assign_temp</span></a></a><span> </span><a name="local-6989586621680964792"><a href="#local-6989586621680964792"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-262"></a><span>  </span><a name="local-6989586621680964793"><a href="#local-6989586621680964793"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-263"></a><span>  </span><a name="local-6989586621680964794"><a href="#local-6989586621680964794"><span class="hs-identifier">reg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmUtils.html#newTemp"><span class="hs-identifier hs-var">newTemp</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#cmmExprType"><span class="hs-identifier hs-var">cmmExprType</span></a><span> </span><a href="#local-6989586621680964793"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680964792"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-264"></a><span>  </span><a href="StgCmmMonad.html#emitAssign"><span class="hs-identifier hs-var">emitAssign</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621680964794"><span class="hs-identifier hs-var">reg</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680964792"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-265"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621680964794"><span class="hs-identifier hs-var">reg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-266"></a><span>
</span><a name="line-267"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-268"></a><span class="hs-comment">-- Save/restore the thread state in the TSO</span><span>
</span><a name="line-269"></a><span>
</span><a name="line-270"></a><span class="hs-comment">-- This stuff can't be done in suspendThread/resumeThread, because it</span><span>
</span><a name="line-271"></a><span class="hs-comment">-- refers to global registers which aren't available in the C world.</span><span>
</span><a name="line-272"></a><span>
</span><a name="line-273"></a><span class="hs-identifier">emitSaveThreadState</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-274"></a><a name="emitSaveThreadState"><a href="StgCmmForeign.html#emitSaveThreadState"><span class="hs-identifier">emitSaveThreadState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-275"></a><span>  </span><a name="local-6989586621680964795"><a href="#local-6989586621680964795"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-276"></a><span>  </span><a name="local-6989586621680964796"><a href="#local-6989586621680964796"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmForeign.html#saveThreadState"><span class="hs-identifier hs-var">saveThreadState</span></a><span> </span><a href="#local-6989586621680964795"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-277"></a><span>  </span><a href="StgCmmMonad.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><a href="#local-6989586621680964796"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-278"></a><span>
</span><a name="line-279"></a><span class="hs-comment">-- | Produce code to save the current thread state to @CurrentTSO@</span><span>
</span><a name="line-280"></a><span class="hs-identifier">saveThreadState</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadUnique</span><span> </span><a href="#local-6989586621680964730"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680964730"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="MkGraph.html#CmmAGraph"><span class="hs-identifier hs-type">CmmAGraph</span></a><span>
</span><a name="line-281"></a><a name="saveThreadState"><a href="StgCmmForeign.html#saveThreadState"><span class="hs-identifier">saveThreadState</span></a></a><span> </span><a name="local-6989586621680964797"><a href="#local-6989586621680964797"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-282"></a><span>  </span><a name="local-6989586621680964798"><a href="#local-6989586621680964798"><span class="hs-identifier">tso</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmUtils.html#newTemp"><span class="hs-identifier hs-var">newTemp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gcWord</span><span> </span><a href="#local-6989586621680964797"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-283"></a><span>  </span><a name="local-6989586621680964799"><a href="#local-6989586621680964799"><span class="hs-identifier">close_nursery</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmForeign.html#closeNursery"><span class="hs-identifier hs-var">closeNursery</span></a><span> </span><a href="#local-6989586621680964797"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680964798"><span class="hs-identifier hs-var">tso</span></a><span>
</span><a name="line-284"></a><span>  </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="MkGraph.html#catAGraphs"><span class="hs-identifier hs-var">catAGraphs</span></a><span> </span><span class="hs-special">[</span><span>
</span><a name="line-285"></a><span>    </span><span class="hs-comment">-- tso = CurrentTSO;</span><span>
</span><a name="line-286"></a><span>    </span><a href="MkGraph.html#mkAssign"><span class="hs-identifier hs-var">mkAssign</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621680964798"><span class="hs-identifier hs-var">tso</span></a><span class="hs-special">)</span><span> </span><a href="CmmUtils.html#currentTSOExpr"><span class="hs-identifier hs-var">currentTSOExpr</span></a><span class="hs-special">,</span><span>
</span><a name="line-287"></a><span>    </span><span class="hs-comment">-- tso-&gt;stackobj-&gt;sp = Sp;</span><span>
</span><a name="line-288"></a><span>    </span><a href="MkGraph.html#mkStore"><span class="hs-identifier hs-var">mkStore</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmOffset"><span class="hs-identifier hs-var">cmmOffset</span></a><span> </span><a href="#local-6989586621680964797"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-289"></a><span>                       </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLoad"><span class="hs-identifier hs-var">CmmLoad</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmOffset"><span class="hs-identifier hs-var">cmmOffset</span></a><span> </span><a href="#local-6989586621680964797"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-290"></a><span>                                           </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621680964798"><span class="hs-identifier hs-var">tso</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-291"></a><span>                                           </span><span class="hs-special">(</span><a href="StgCmmForeign.html#tso_stackobj"><span class="hs-identifier hs-var">tso_stackobj</span></a><span> </span><a href="#local-6989586621680964797"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-292"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bWord</span><span> </span><a href="#local-6989586621680964797"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-293"></a><span>                       </span><span class="hs-special">(</span><a href="StgCmmForeign.html#stack_SP"><span class="hs-identifier hs-var">stack_SP</span></a><span> </span><a href="#local-6989586621680964797"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-294"></a><span>            </span><a href="CmmUtils.html#spExpr"><span class="hs-identifier hs-var">spExpr</span></a><span class="hs-special">,</span><span>
</span><a name="line-295"></a><span>    </span><a href="#local-6989586621680964799"><span class="hs-identifier hs-var">close_nursery</span></a><span class="hs-special">,</span><span>
</span><a name="line-296"></a><span>    </span><span class="hs-comment">-- and save the current cost centre stack in the TSO when profiling:</span><span>
</span><a name="line-297"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_SccProfilingOn</span><span> </span><a href="#local-6989586621680964797"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-298"></a><span>        </span><a href="MkGraph.html#mkStore"><span class="hs-identifier hs-var">mkStore</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmOffset"><span class="hs-identifier hs-var">cmmOffset</span></a><span> </span><a href="#local-6989586621680964797"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621680964798"><span class="hs-identifier hs-var">tso</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="StgCmmForeign.html#tso_CCCS"><span class="hs-identifier hs-var">tso_CCCS</span></a><span> </span><a href="#local-6989586621680964797"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="CmmUtils.html#cccsExpr"><span class="hs-identifier hs-var">cccsExpr</span></a><span>
</span><a name="line-299"></a><span>      </span><span class="hs-keyword">else</span><span> </span><a href="MkGraph.html#mkNop"><span class="hs-identifier hs-var">mkNop</span></a><span>
</span><a name="line-300"></a><span>    </span><span class="hs-special">]</span><span>
</span><a name="line-301"></a><span>
</span><a name="line-302"></a><span class="hs-identifier">emitCloseNursery</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-303"></a><a name="emitCloseNursery"><a href="StgCmmForeign.html#emitCloseNursery"><span class="hs-identifier">emitCloseNursery</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-304"></a><span>  </span><a name="local-6989586621680964800"><a href="#local-6989586621680964800"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-305"></a><span>  </span><a name="local-6989586621680964801"><a href="#local-6989586621680964801"><span class="hs-identifier">tso</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmUtils.html#newTemp"><span class="hs-identifier hs-var">newTemp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bWord</span><span> </span><a href="#local-6989586621680964800"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-306"></a><span>  </span><a name="local-6989586621680964802"><a href="#local-6989586621680964802"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmForeign.html#closeNursery"><span class="hs-identifier hs-var">closeNursery</span></a><span> </span><a href="#local-6989586621680964800"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680964801"><span class="hs-identifier hs-var">tso</span></a><span>
</span><a name="line-307"></a><span>  </span><a href="StgCmmMonad.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="MkGraph.html#mkAssign"><span class="hs-identifier hs-var">mkAssign</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621680964801"><span class="hs-identifier hs-var">tso</span></a><span class="hs-special">)</span><span> </span><a href="CmmUtils.html#currentTSOExpr"><span class="hs-identifier hs-var">currentTSOExpr</span></a><span> </span><a href="MkGraph.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a><span> </span><a href="#local-6989586621680964802"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-308"></a><span>
</span><a name="line-309"></a><span class="hs-comment">{- |
@closeNursery dflags tso@ produces code to close the nursery.
A local register holding the value of @CurrentTSO@ is expected for
efficiency.

Closing the nursery corresponds to the following code:

@
  tso = CurrentTSO;
  cn = CurrentNuresry;

  // Update the allocation limit for the current thread.  We don't
  // check to see whether it has overflowed at this point, that check is
  // made when we run out of space in the current heap block (stg_gc_noregs)
  // and in the scheduler when context switching (schedulePostRunThread).
  tso-&gt;alloc_limit -= Hp + WDS(1) - cn-&gt;start;

  // Set cn-&gt;free to the next unoccupied word in the block
  cn-&gt;free = Hp + WDS(1);
@
-}</span><span>
</span><a name="line-330"></a><span class="hs-identifier">closeNursery</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadUnique</span><span> </span><a href="#local-6989586621680964729"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680964729"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="MkGraph.html#CmmAGraph"><span class="hs-identifier hs-type">CmmAGraph</span></a><span>
</span><a name="line-331"></a><a name="closeNursery"><a href="StgCmmForeign.html#closeNursery"><span class="hs-identifier">closeNursery</span></a></a><span> </span><a name="local-6989586621680964803"><a href="#local-6989586621680964803"><span class="hs-identifier">df</span></a></a><span> </span><a name="local-6989586621680964804"><a href="#local-6989586621680964804"><span class="hs-identifier">tso</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-332"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680964805"><a href="#local-6989586621680964805"><span class="hs-identifier">tsoreg</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621680964804"><span class="hs-identifier hs-var">tso</span></a><span>
</span><a name="line-333"></a><span>  </span><a name="local-6989586621680964806"><a href="#local-6989586621680964806"><span class="hs-identifier">cnreg</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="StgCmmUtils.html#newTemp"><span class="hs-identifier hs-var">newTemp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bWord</span><span> </span><a href="#local-6989586621680964803"><span class="hs-identifier hs-var">df</span></a><span class="hs-special">)</span><span>
</span><a name="line-334"></a><span>  </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="MkGraph.html#catAGraphs"><span class="hs-identifier hs-var">catAGraphs</span></a><span> </span><span class="hs-special">[</span><span>
</span><a name="line-335"></a><span>    </span><a href="MkGraph.html#mkAssign"><span class="hs-identifier hs-var">mkAssign</span></a><span> </span><a href="#local-6989586621680964806"><span class="hs-identifier hs-var">cnreg</span></a><span> </span><a href="CmmUtils.html#currentNurseryExpr"><span class="hs-identifier hs-var">currentNurseryExpr</span></a><span class="hs-special">,</span><span>
</span><a name="line-336"></a><span>
</span><a name="line-337"></a><span>    </span><span class="hs-comment">-- CurrentNursery-&gt;free = Hp+1;</span><span>
</span><a name="line-338"></a><span>    </span><a href="MkGraph.html#mkStore"><span class="hs-identifier hs-var">mkStore</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmForeign.html#nursery_bdescr_free"><span class="hs-identifier hs-var">nursery_bdescr_free</span></a><span> </span><a href="#local-6989586621680964803"><span class="hs-identifier hs-var">df</span></a><span> </span><a href="#local-6989586621680964806"><span class="hs-identifier hs-var">cnreg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmOffsetW"><span class="hs-identifier hs-var">cmmOffsetW</span></a><span> </span><a href="#local-6989586621680964803"><span class="hs-identifier hs-var">df</span></a><span> </span><a href="CmmUtils.html#hpExpr"><span class="hs-identifier hs-var">hpExpr</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-339"></a><span>
</span><a name="line-340"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680964807"><a href="#local-6989586621680964807"><span class="hs-identifier">alloc</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-341"></a><span>           </span><a href="CmmExpr.html#CmmMachOp"><span class="hs-identifier hs-var">CmmMachOp</span></a><span> </span><span class="hs-special">(</span><a href="CmmMachOp.html#mo_wordSub"><span class="hs-identifier hs-var">mo_wordSub</span></a><span> </span><a href="#local-6989586621680964803"><span class="hs-identifier hs-var">df</span></a><span class="hs-special">)</span><span>
</span><a name="line-342"></a><span>              </span><span class="hs-special">[</span><span> </span><a href="CmmUtils.html#cmmOffsetW"><span class="hs-identifier hs-var">cmmOffsetW</span></a><span> </span><a href="#local-6989586621680964803"><span class="hs-identifier hs-var">df</span></a><span> </span><a href="CmmUtils.html#hpExpr"><span class="hs-identifier hs-var">hpExpr</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-343"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="CmmExpr.html#CmmLoad"><span class="hs-identifier hs-var">CmmLoad</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmForeign.html#nursery_bdescr_start"><span class="hs-identifier hs-var">nursery_bdescr_start</span></a><span> </span><a href="#local-6989586621680964803"><span class="hs-identifier hs-var">df</span></a><span> </span><a href="#local-6989586621680964806"><span class="hs-identifier hs-var">cnreg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bWord</span><span> </span><a href="#local-6989586621680964803"><span class="hs-identifier hs-var">df</span></a><span class="hs-special">)</span><span>
</span><a name="line-344"></a><span>              </span><span class="hs-special">]</span><span>
</span><a name="line-345"></a><span>
</span><a name="line-346"></a><span>        </span><a name="local-6989586621680964808"><a href="#local-6989586621680964808"><span class="hs-identifier">alloc_limit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmUtils.html#cmmOffset"><span class="hs-identifier hs-var">cmmOffset</span></a><span> </span><a href="#local-6989586621680964803"><span class="hs-identifier hs-var">df</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><a href="#local-6989586621680964805"><span class="hs-identifier hs-var">tsoreg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="StgCmmForeign.html#tso_alloc_limit"><span class="hs-identifier hs-var">tso_alloc_limit</span></a><span> </span><a href="#local-6989586621680964803"><span class="hs-identifier hs-var">df</span></a><span class="hs-special">)</span><span>
</span><a name="line-347"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-348"></a><span>
</span><a name="line-349"></a><span>    </span><span class="hs-comment">-- tso-&gt;alloc_limit += alloc</span><span>
</span><a name="line-350"></a><span>    </span><a href="MkGraph.html#mkStore"><span class="hs-identifier hs-var">mkStore</span></a><span> </span><a href="#local-6989586621680964808"><span class="hs-identifier hs-var">alloc_limit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmMachOp"><span class="hs-identifier hs-var">CmmMachOp</span></a><span> </span><span class="hs-special">(</span><a href="CmmMachOp.html#MO_Sub"><span class="hs-identifier hs-var">MO_Sub</span></a><span> </span><span class="hs-identifier hs-var">W64</span><span class="hs-special">)</span><span>
</span><a name="line-351"></a><span>                               </span><span class="hs-special">[</span><span> </span><a href="CmmExpr.html#CmmLoad"><span class="hs-identifier hs-var">CmmLoad</span></a><span> </span><a href="#local-6989586621680964808"><span class="hs-identifier hs-var">alloc_limit</span></a><span> </span><span class="hs-identifier hs-var">b64</span><span>
</span><a name="line-352"></a><span>                               </span><span class="hs-special">,</span><span> </span><a href="CmmExpr.html#CmmMachOp"><span class="hs-identifier hs-var">CmmMachOp</span></a><span> </span><span class="hs-special">(</span><a href="CmmMachOp.html#mo_WordTo64"><span class="hs-identifier hs-var">mo_WordTo64</span></a><span> </span><a href="#local-6989586621680964803"><span class="hs-identifier hs-var">df</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680964807"><span class="hs-identifier hs-var">alloc</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-353"></a><span>   </span><span class="hs-special">]</span><span>
</span><a name="line-354"></a><span>
</span><a name="line-355"></a><span class="hs-identifier">emitLoadThreadState</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-356"></a><a name="emitLoadThreadState"><a href="StgCmmForeign.html#emitLoadThreadState"><span class="hs-identifier">emitLoadThreadState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-357"></a><span>  </span><a name="local-6989586621680964809"><a href="#local-6989586621680964809"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-358"></a><span>  </span><a name="local-6989586621680964810"><a href="#local-6989586621680964810"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmForeign.html#loadThreadState"><span class="hs-identifier hs-var">loadThreadState</span></a><span> </span><a href="#local-6989586621680964809"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-359"></a><span>  </span><a href="StgCmmMonad.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><a href="#local-6989586621680964810"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-360"></a><span>
</span><a name="line-361"></a><span class="hs-comment">-- | Produce code to load the current thread state from @CurrentTSO@</span><span>
</span><a name="line-362"></a><span class="hs-identifier">loadThreadState</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadUnique</span><span> </span><a href="#local-6989586621680964728"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680964728"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="MkGraph.html#CmmAGraph"><span class="hs-identifier hs-type">CmmAGraph</span></a><span>
</span><a name="line-363"></a><a name="loadThreadState"><a href="StgCmmForeign.html#loadThreadState"><span class="hs-identifier">loadThreadState</span></a></a><span> </span><a name="local-6989586621680964811"><a href="#local-6989586621680964811"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-364"></a><span>  </span><a name="local-6989586621680964812"><a href="#local-6989586621680964812"><span class="hs-identifier">tso</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmUtils.html#newTemp"><span class="hs-identifier hs-var">newTemp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gcWord</span><span> </span><a href="#local-6989586621680964811"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-365"></a><span>  </span><a name="local-6989586621680964813"><a href="#local-6989586621680964813"><span class="hs-identifier">stack</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmUtils.html#newTemp"><span class="hs-identifier hs-var">newTemp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gcWord</span><span> </span><a href="#local-6989586621680964811"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-366"></a><span>  </span><a name="local-6989586621680964814"><a href="#local-6989586621680964814"><span class="hs-identifier">open_nursery</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmForeign.html#openNursery"><span class="hs-identifier hs-var">openNursery</span></a><span> </span><a href="#local-6989586621680964811"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680964812"><span class="hs-identifier hs-var">tso</span></a><span>
</span><a name="line-367"></a><span>  </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="MkGraph.html#catAGraphs"><span class="hs-identifier hs-var">catAGraphs</span></a><span> </span><span class="hs-special">[</span><span>
</span><a name="line-368"></a><span>    </span><span class="hs-comment">-- tso = CurrentTSO;</span><span>
</span><a name="line-369"></a><span>    </span><a href="MkGraph.html#mkAssign"><span class="hs-identifier hs-var">mkAssign</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621680964812"><span class="hs-identifier hs-var">tso</span></a><span class="hs-special">)</span><span> </span><a href="CmmUtils.html#currentTSOExpr"><span class="hs-identifier hs-var">currentTSOExpr</span></a><span class="hs-special">,</span><span>
</span><a name="line-370"></a><span>    </span><span class="hs-comment">-- stack = tso-&gt;stackobj;</span><span>
</span><a name="line-371"></a><span>    </span><a href="MkGraph.html#mkAssign"><span class="hs-identifier hs-var">mkAssign</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621680964813"><span class="hs-identifier hs-var">stack</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLoad"><span class="hs-identifier hs-var">CmmLoad</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmOffset"><span class="hs-identifier hs-var">cmmOffset</span></a><span> </span><a href="#local-6989586621680964811"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621680964812"><span class="hs-identifier hs-var">tso</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="StgCmmForeign.html#tso_stackobj"><span class="hs-identifier hs-var">tso_stackobj</span></a><span> </span><a href="#local-6989586621680964811"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bWord</span><span> </span><a href="#local-6989586621680964811"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-372"></a><span>    </span><span class="hs-comment">-- Sp = stack-&gt;sp;</span><span>
</span><a name="line-373"></a><span>    </span><a href="MkGraph.html#mkAssign"><span class="hs-identifier hs-var">mkAssign</span></a><span> </span><a href="CmmExpr.html#spReg"><span class="hs-identifier hs-var">spReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLoad"><span class="hs-identifier hs-var">CmmLoad</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmOffset"><span class="hs-identifier hs-var">cmmOffset</span></a><span> </span><a href="#local-6989586621680964811"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621680964813"><span class="hs-identifier hs-var">stack</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="StgCmmForeign.html#stack_SP"><span class="hs-identifier hs-var">stack_SP</span></a><span> </span><a href="#local-6989586621680964811"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bWord</span><span> </span><a href="#local-6989586621680964811"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-374"></a><span>    </span><span class="hs-comment">-- SpLim = stack-&gt;stack + RESERVED_STACK_WORDS;</span><span>
</span><a name="line-375"></a><span>    </span><a href="MkGraph.html#mkAssign"><span class="hs-identifier hs-var">mkAssign</span></a><span> </span><a href="CmmExpr.html#spLimReg"><span class="hs-identifier hs-var">spLimReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmOffsetW"><span class="hs-identifier hs-var">cmmOffsetW</span></a><span> </span><a href="#local-6989586621680964811"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmOffset"><span class="hs-identifier hs-var">cmmOffset</span></a><span> </span><a href="#local-6989586621680964811"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621680964813"><span class="hs-identifier hs-var">stack</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="StgCmmForeign.html#stack_STACK"><span class="hs-identifier hs-var">stack_STACK</span></a><span> </span><a href="#local-6989586621680964811"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-376"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">rESERVED_STACK_WORDS</span><span> </span><a href="#local-6989586621680964811"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-377"></a><span>    </span><span class="hs-comment">-- HpAlloc = 0;</span><span>
</span><a name="line-378"></a><span>    </span><span class="hs-comment">--   HpAlloc is assumed to be set to non-zero only by a failed</span><span>
</span><a name="line-379"></a><span>    </span><span class="hs-comment">--   a heap check, see HeapStackCheck.cmm:GC_GENERIC</span><span>
</span><a name="line-380"></a><span>    </span><a href="MkGraph.html#mkAssign"><span class="hs-identifier hs-var">mkAssign</span></a><span> </span><a href="CmmExpr.html#hpAllocReg"><span class="hs-identifier hs-var">hpAllocReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#zeroExpr"><span class="hs-identifier hs-var">zeroExpr</span></a><span> </span><a href="#local-6989586621680964811"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-381"></a><span>    </span><a href="#local-6989586621680964814"><span class="hs-identifier hs-var">open_nursery</span></a><span class="hs-special">,</span><span>
</span><a name="line-382"></a><span>    </span><span class="hs-comment">-- and load the current cost centre stack from the TSO when profiling:</span><span>
</span><a name="line-383"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_SccProfilingOn</span><span> </span><a href="#local-6989586621680964811"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-384"></a><span>       </span><span class="hs-keyword">then</span><span> </span><a href="StgCmmProf.html#storeCurCCS"><span class="hs-identifier hs-var">storeCurCCS</span></a><span>
</span><a name="line-385"></a><span>              </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLoad"><span class="hs-identifier hs-var">CmmLoad</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmOffset"><span class="hs-identifier hs-var">cmmOffset</span></a><span> </span><a href="#local-6989586621680964811"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621680964812"><span class="hs-identifier hs-var">tso</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-386"></a><span>                 </span><span class="hs-special">(</span><a href="StgCmmForeign.html#tso_CCCS"><span class="hs-identifier hs-var">tso_CCCS</span></a><span> </span><a href="#local-6989586621680964811"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="StgCmmProf.html#ccsType"><span class="hs-identifier hs-var">ccsType</span></a><span> </span><a href="#local-6989586621680964811"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-387"></a><span>       </span><span class="hs-keyword">else</span><span> </span><a href="MkGraph.html#mkNop"><span class="hs-identifier hs-var">mkNop</span></a><span>
</span><a name="line-388"></a><span>   </span><span class="hs-special">]</span><span>
</span><a name="line-389"></a><span>
</span><a name="line-390"></a><span>
</span><a name="line-391"></a><span class="hs-identifier">emitOpenNursery</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-392"></a><a name="emitOpenNursery"><a href="StgCmmForeign.html#emitOpenNursery"><span class="hs-identifier">emitOpenNursery</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-393"></a><span>  </span><a name="local-6989586621680964815"><a href="#local-6989586621680964815"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-394"></a><span>  </span><a name="local-6989586621680964816"><a href="#local-6989586621680964816"><span class="hs-identifier">tso</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmUtils.html#newTemp"><span class="hs-identifier hs-var">newTemp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bWord</span><span> </span><a href="#local-6989586621680964815"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-395"></a><span>  </span><a name="local-6989586621680964817"><a href="#local-6989586621680964817"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmForeign.html#openNursery"><span class="hs-identifier hs-var">openNursery</span></a><span> </span><a href="#local-6989586621680964815"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680964816"><span class="hs-identifier hs-var">tso</span></a><span>
</span><a name="line-396"></a><span>  </span><a href="StgCmmMonad.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="MkGraph.html#mkAssign"><span class="hs-identifier hs-var">mkAssign</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621680964816"><span class="hs-identifier hs-var">tso</span></a><span class="hs-special">)</span><span> </span><a href="CmmUtils.html#currentTSOExpr"><span class="hs-identifier hs-var">currentTSOExpr</span></a><span> </span><a href="MkGraph.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a><span> </span><a href="#local-6989586621680964817"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-397"></a><span>
</span><a name="line-398"></a><span class="hs-comment">{- |
@openNursery dflags tso@ produces code to open the nursery. A local register
holding the value of @CurrentTSO@ is expected for efficiency.

Opening the nursery corresponds to the following code:

@
   tso = CurrentTSO;
   cn = CurrentNursery;
   bdfree = CurrentNursery-&gt;free;
   bdstart = CurrentNursery-&gt;start;

   // We *add* the currently occupied portion of the nursery block to
   // the allocation limit, because we will subtract it again in
   // closeNursery.
   tso-&gt;alloc_limit += bdfree - bdstart;

   // Set Hp to the last occupied word of the heap block.  Why not the
   // next unocupied word?  Doing it this way means that we get to use
   // an offset of zero more often, which might lead to slightly smaller
   // code on some architectures.
   Hp = bdfree - WDS(1);

   // Set HpLim to the end of the current nursery block (note that this block
   // might be a block group, consisting of several adjacent blocks.
   HpLim = bdstart + CurrentNursery-&gt;blocks*BLOCK_SIZE_W - 1;
@
-}</span><span>
</span><a name="line-426"></a><span class="hs-identifier">openNursery</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadUnique</span><span> </span><a href="#local-6989586621680964727"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680964727"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="MkGraph.html#CmmAGraph"><span class="hs-identifier hs-type">CmmAGraph</span></a><span>
</span><a name="line-427"></a><a name="openNursery"><a href="StgCmmForeign.html#openNursery"><span class="hs-identifier">openNursery</span></a></a><span> </span><a name="local-6989586621680964818"><a href="#local-6989586621680964818"><span class="hs-identifier">df</span></a></a><span> </span><a name="local-6989586621680964819"><a href="#local-6989586621680964819"><span class="hs-identifier">tso</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-428"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680964820"><a href="#local-6989586621680964820"><span class="hs-identifier">tsoreg</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621680964819"><span class="hs-identifier hs-var">tso</span></a><span>
</span><a name="line-429"></a><span>  </span><a name="local-6989586621680964821"><a href="#local-6989586621680964821"><span class="hs-identifier">cnreg</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="StgCmmUtils.html#newTemp"><span class="hs-identifier hs-var">newTemp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bWord</span><span> </span><a href="#local-6989586621680964818"><span class="hs-identifier hs-var">df</span></a><span class="hs-special">)</span><span>
</span><a name="line-430"></a><span>  </span><a name="local-6989586621680964822"><a href="#local-6989586621680964822"><span class="hs-identifier">bdfreereg</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="StgCmmUtils.html#newTemp"><span class="hs-identifier hs-var">newTemp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bWord</span><span> </span><a href="#local-6989586621680964818"><span class="hs-identifier hs-var">df</span></a><span class="hs-special">)</span><span>
</span><a name="line-431"></a><span>  </span><a name="local-6989586621680964823"><a href="#local-6989586621680964823"><span class="hs-identifier">bdstartreg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="StgCmmUtils.html#newTemp"><span class="hs-identifier hs-var">newTemp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bWord</span><span> </span><a href="#local-6989586621680964818"><span class="hs-identifier hs-var">df</span></a><span class="hs-special">)</span><span>
</span><a name="line-432"></a><span>
</span><a name="line-433"></a><span>  </span><span class="hs-comment">-- These assignments are carefully ordered to reduce register</span><span>
</span><a name="line-434"></a><span>  </span><span class="hs-comment">-- pressure and generate not completely awful code on x86.  To see</span><span>
</span><a name="line-435"></a><span>  </span><span class="hs-comment">-- what code we generate, look at the assembly for</span><span>
</span><a name="line-436"></a><span>  </span><span class="hs-comment">-- stg_returnToStackTop in rts/StgStartup.cmm.</span><span>
</span><a name="line-437"></a><span>  </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="MkGraph.html#catAGraphs"><span class="hs-identifier hs-var">catAGraphs</span></a><span> </span><span class="hs-special">[</span><span>
</span><a name="line-438"></a><span>     </span><a href="MkGraph.html#mkAssign"><span class="hs-identifier hs-var">mkAssign</span></a><span> </span><a href="#local-6989586621680964821"><span class="hs-identifier hs-var">cnreg</span></a><span> </span><a href="CmmUtils.html#currentNurseryExpr"><span class="hs-identifier hs-var">currentNurseryExpr</span></a><span class="hs-special">,</span><span>
</span><a name="line-439"></a><span>     </span><a href="MkGraph.html#mkAssign"><span class="hs-identifier hs-var">mkAssign</span></a><span> </span><a href="#local-6989586621680964822"><span class="hs-identifier hs-var">bdfreereg</span></a><span>  </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLoad"><span class="hs-identifier hs-var">CmmLoad</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmForeign.html#nursery_bdescr_free"><span class="hs-identifier hs-var">nursery_bdescr_free</span></a><span> </span><a href="#local-6989586621680964818"><span class="hs-identifier hs-var">df</span></a><span> </span><a href="#local-6989586621680964821"><span class="hs-identifier hs-var">cnreg</span></a><span class="hs-special">)</span><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bWord</span><span> </span><a href="#local-6989586621680964818"><span class="hs-identifier hs-var">df</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-440"></a><span>
</span><a name="line-441"></a><span>     </span><span class="hs-comment">-- Hp = CurrentNursery-&gt;free - 1;</span><span>
</span><a name="line-442"></a><span>     </span><a href="MkGraph.html#mkAssign"><span class="hs-identifier hs-var">mkAssign</span></a><span> </span><a href="CmmExpr.html#hpReg"><span class="hs-identifier hs-var">hpReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmOffsetW"><span class="hs-identifier hs-var">cmmOffsetW</span></a><span> </span><a href="#local-6989586621680964818"><span class="hs-identifier hs-var">df</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><a href="#local-6989586621680964822"><span class="hs-identifier hs-var">bdfreereg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-443"></a><span>
</span><a name="line-444"></a><span>     </span><a href="MkGraph.html#mkAssign"><span class="hs-identifier hs-var">mkAssign</span></a><span> </span><a href="#local-6989586621680964823"><span class="hs-identifier hs-var">bdstartreg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLoad"><span class="hs-identifier hs-var">CmmLoad</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmForeign.html#nursery_bdescr_start"><span class="hs-identifier hs-var">nursery_bdescr_start</span></a><span> </span><a href="#local-6989586621680964818"><span class="hs-identifier hs-var">df</span></a><span> </span><a href="#local-6989586621680964821"><span class="hs-identifier hs-var">cnreg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bWord</span><span> </span><a href="#local-6989586621680964818"><span class="hs-identifier hs-var">df</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-445"></a><span>
</span><a name="line-446"></a><span>     </span><span class="hs-comment">-- HpLim = CurrentNursery-&gt;start +</span><span>
</span><a name="line-447"></a><span>     </span><span class="hs-comment">--              CurrentNursery-&gt;blocks*BLOCK_SIZE_W - 1;</span><span>
</span><a name="line-448"></a><span>     </span><a href="MkGraph.html#mkAssign"><span class="hs-identifier hs-var">mkAssign</span></a><span> </span><a href="CmmExpr.html#hpLimReg"><span class="hs-identifier hs-var">hpLimReg</span></a><span>
</span><a name="line-449"></a><span>         </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmOffsetExpr"><span class="hs-identifier hs-var">cmmOffsetExpr</span></a><span> </span><a href="#local-6989586621680964818"><span class="hs-identifier hs-var">df</span></a><span>
</span><a name="line-450"></a><span>             </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><a href="#local-6989586621680964823"><span class="hs-identifier hs-var">bdstartreg</span></a><span class="hs-special">)</span><span>
</span><a name="line-451"></a><span>             </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmOffset"><span class="hs-identifier hs-var">cmmOffset</span></a><span> </span><a href="#local-6989586621680964818"><span class="hs-identifier hs-var">df</span></a><span>
</span><a name="line-452"></a><span>               </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmMachOp"><span class="hs-identifier hs-var">CmmMachOp</span></a><span> </span><span class="hs-special">(</span><a href="CmmMachOp.html#mo_wordMul"><span class="hs-identifier hs-var">mo_wordMul</span></a><span> </span><a href="#local-6989586621680964818"><span class="hs-identifier hs-var">df</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-453"></a><span>                 </span><a href="CmmExpr.html#CmmMachOp"><span class="hs-identifier hs-var">CmmMachOp</span></a><span> </span><span class="hs-special">(</span><a href="CmmMachOp.html#MO_SS_Conv"><span class="hs-identifier hs-var">MO_SS_Conv</span></a><span> </span><span class="hs-identifier hs-var">W32</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wordWidth</span><span> </span><a href="#local-6989586621680964818"><span class="hs-identifier hs-var">df</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-454"></a><span>                   </span><span class="hs-special">[</span><a href="CmmExpr.html#CmmLoad"><span class="hs-identifier hs-var">CmmLoad</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmForeign.html#nursery_bdescr_blocks"><span class="hs-identifier hs-var">nursery_bdescr_blocks</span></a><span> </span><a href="#local-6989586621680964818"><span class="hs-identifier hs-var">df</span></a><span> </span><a href="#local-6989586621680964821"><span class="hs-identifier hs-var">cnreg</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">b32</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-455"></a><span>                 </span><a href="CmmUtils.html#mkIntExpr"><span class="hs-identifier hs-var">mkIntExpr</span></a><span> </span><a href="#local-6989586621680964818"><span class="hs-identifier hs-var">df</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bLOCK_SIZE</span><span> </span><a href="#local-6989586621680964818"><span class="hs-identifier hs-var">df</span></a><span class="hs-special">)</span><span>
</span><a name="line-456"></a><span>                </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-457"></a><span>               </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-458"></a><span>             </span><span class="hs-special">)</span><span>
</span><a name="line-459"></a><span>         </span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-460"></a><span>
</span><a name="line-461"></a><span>     </span><span class="hs-comment">-- alloc = bd-&gt;free - bd-&gt;start</span><span>
</span><a name="line-462"></a><span>     </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680964824"><a href="#local-6989586621680964824"><span class="hs-identifier">alloc</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-463"></a><span>           </span><a href="CmmExpr.html#CmmMachOp"><span class="hs-identifier hs-var">CmmMachOp</span></a><span> </span><span class="hs-special">(</span><a href="CmmMachOp.html#mo_wordSub"><span class="hs-identifier hs-var">mo_wordSub</span></a><span> </span><a href="#local-6989586621680964818"><span class="hs-identifier hs-var">df</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><a href="#local-6989586621680964822"><span class="hs-identifier hs-var">bdfreereg</span></a><span class="hs-special">,</span><span> </span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><a href="#local-6989586621680964823"><span class="hs-identifier hs-var">bdstartreg</span></a><span class="hs-special">]</span><span>
</span><a name="line-464"></a><span>
</span><a name="line-465"></a><span>         </span><a name="local-6989586621680964825"><a href="#local-6989586621680964825"><span class="hs-identifier">alloc_limit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmUtils.html#cmmOffset"><span class="hs-identifier hs-var">cmmOffset</span></a><span> </span><a href="#local-6989586621680964818"><span class="hs-identifier hs-var">df</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><a href="#local-6989586621680964820"><span class="hs-identifier hs-var">tsoreg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="StgCmmForeign.html#tso_alloc_limit"><span class="hs-identifier hs-var">tso_alloc_limit</span></a><span> </span><a href="#local-6989586621680964818"><span class="hs-identifier hs-var">df</span></a><span class="hs-special">)</span><span>
</span><a name="line-466"></a><span>     </span><span class="hs-keyword">in</span><span>
</span><a name="line-467"></a><span>
</span><a name="line-468"></a><span>     </span><span class="hs-comment">-- tso-&gt;alloc_limit += alloc</span><span>
</span><a name="line-469"></a><span>     </span><a href="MkGraph.html#mkStore"><span class="hs-identifier hs-var">mkStore</span></a><span> </span><a href="#local-6989586621680964825"><span class="hs-identifier hs-var">alloc_limit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmMachOp"><span class="hs-identifier hs-var">CmmMachOp</span></a><span> </span><span class="hs-special">(</span><a href="CmmMachOp.html#MO_Add"><span class="hs-identifier hs-var">MO_Add</span></a><span> </span><span class="hs-identifier hs-var">W64</span><span class="hs-special">)</span><span>
</span><a name="line-470"></a><span>                               </span><span class="hs-special">[</span><span> </span><a href="CmmExpr.html#CmmLoad"><span class="hs-identifier hs-var">CmmLoad</span></a><span> </span><a href="#local-6989586621680964825"><span class="hs-identifier hs-var">alloc_limit</span></a><span> </span><span class="hs-identifier hs-var">b64</span><span>
</span><a name="line-471"></a><span>                               </span><span class="hs-special">,</span><span> </span><a href="CmmExpr.html#CmmMachOp"><span class="hs-identifier hs-var">CmmMachOp</span></a><span> </span><span class="hs-special">(</span><a href="CmmMachOp.html#mo_WordTo64"><span class="hs-identifier hs-var">mo_WordTo64</span></a><span> </span><a href="#local-6989586621680964818"><span class="hs-identifier hs-var">df</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680964824"><span class="hs-identifier hs-var">alloc</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-472"></a><span>
</span><a name="line-473"></a><span>   </span><span class="hs-special">]</span><span>
</span><a name="line-474"></a><span>
</span><a name="line-475"></a><span class="hs-identifier">nursery_bdescr_free</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">nursery_bdescr_start</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">nursery_bdescr_blocks</span><span>
</span><a name="line-476"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-type">CmmReg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>
</span><a name="line-477"></a><a name="nursery_bdescr_free"><a href="StgCmmForeign.html#nursery_bdescr_free"><span class="hs-identifier">nursery_bdescr_free</span></a></a><span>   </span><a name="local-6989586621680964826"><a href="#local-6989586621680964826"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680964827"><a href="#local-6989586621680964827"><span class="hs-identifier">cn</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-478"></a><span>  </span><a href="CmmUtils.html#cmmOffset"><span class="hs-identifier hs-var">cmmOffset</span></a><span> </span><a href="#local-6989586621680964826"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><a href="#local-6989586621680964827"><span class="hs-identifier hs-var">cn</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">oFFSET_bdescr_free</span><span> </span><a href="#local-6989586621680964826"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-479"></a><a name="nursery_bdescr_start"><a href="StgCmmForeign.html#nursery_bdescr_start"><span class="hs-identifier">nursery_bdescr_start</span></a></a><span>  </span><a name="local-6989586621680964828"><a href="#local-6989586621680964828"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680964829"><a href="#local-6989586621680964829"><span class="hs-identifier">cn</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-480"></a><span>  </span><a href="CmmUtils.html#cmmOffset"><span class="hs-identifier hs-var">cmmOffset</span></a><span> </span><a href="#local-6989586621680964828"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><a href="#local-6989586621680964829"><span class="hs-identifier hs-var">cn</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">oFFSET_bdescr_start</span><span> </span><a href="#local-6989586621680964828"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-481"></a><a name="nursery_bdescr_blocks"><a href="StgCmmForeign.html#nursery_bdescr_blocks"><span class="hs-identifier">nursery_bdescr_blocks</span></a></a><span> </span><a name="local-6989586621680964830"><a href="#local-6989586621680964830"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680964831"><a href="#local-6989586621680964831"><span class="hs-identifier">cn</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-482"></a><span>  </span><a href="CmmUtils.html#cmmOffset"><span class="hs-identifier hs-var">cmmOffset</span></a><span> </span><a href="#local-6989586621680964830"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><a href="#local-6989586621680964831"><span class="hs-identifier hs-var">cn</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">oFFSET_bdescr_blocks</span><span> </span><a href="#local-6989586621680964830"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-483"></a><span>
</span><a name="line-484"></a><span class="hs-identifier">tso_stackobj</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tso_CCCS</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tso_alloc_limit</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">stack_STACK</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">stack_SP</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>
</span><a name="line-485"></a><a name="tso_stackobj"><a href="StgCmmForeign.html#tso_stackobj"><span class="hs-identifier">tso_stackobj</span></a></a><span> </span><a name="local-6989586621680964832"><a href="#local-6989586621680964832"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmForeign.html#closureField"><span class="hs-identifier hs-var">closureField</span></a><span> </span><a href="#local-6989586621680964832"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">oFFSET_StgTSO_stackobj</span><span> </span><a href="#local-6989586621680964832"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-486"></a><a name="tso_alloc_limit"><a href="StgCmmForeign.html#tso_alloc_limit"><span class="hs-identifier">tso_alloc_limit</span></a></a><span> </span><a name="local-6989586621680964833"><a href="#local-6989586621680964833"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmForeign.html#closureField"><span class="hs-identifier hs-var">closureField</span></a><span> </span><a href="#local-6989586621680964833"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">oFFSET_StgTSO_alloc_limit</span><span> </span><a href="#local-6989586621680964833"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-487"></a><a name="tso_CCCS"><a href="StgCmmForeign.html#tso_CCCS"><span class="hs-identifier">tso_CCCS</span></a></a><span>     </span><a name="local-6989586621680964834"><a href="#local-6989586621680964834"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmForeign.html#closureField"><span class="hs-identifier hs-var">closureField</span></a><span> </span><a href="#local-6989586621680964834"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">oFFSET_StgTSO_cccs</span><span> </span><a href="#local-6989586621680964834"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-488"></a><a name="stack_STACK"><a href="StgCmmForeign.html#stack_STACK"><span class="hs-identifier">stack_STACK</span></a></a><span>  </span><a name="local-6989586621680964835"><a href="#local-6989586621680964835"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmForeign.html#closureField"><span class="hs-identifier hs-var">closureField</span></a><span> </span><a href="#local-6989586621680964835"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">oFFSET_StgStack_stack</span><span> </span><a href="#local-6989586621680964835"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-489"></a><a name="stack_SP"><a href="StgCmmForeign.html#stack_SP"><span class="hs-identifier">stack_SP</span></a></a><span>     </span><a name="local-6989586621680964836"><a href="#local-6989586621680964836"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmForeign.html#closureField"><span class="hs-identifier hs-var">closureField</span></a><span> </span><a href="#local-6989586621680964836"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">oFFSET_StgStack_sp</span><span> </span><a href="#local-6989586621680964836"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-490"></a><span>
</span><a name="line-491"></a><span>
</span><a name="line-492"></a><span class="hs-identifier">closureField</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>
</span><a name="line-493"></a><a name="closureField"><a href="StgCmmForeign.html#closureField"><span class="hs-identifier">closureField</span></a></a><span> </span><a name="local-6989586621680964837"><a href="#local-6989586621680964837"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680964838"><a href="#local-6989586621680964838"><span class="hs-identifier">off</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680964838"><span class="hs-identifier hs-var">off</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="SMRep.html#fixedHdrSize"><span class="hs-identifier hs-var">fixedHdrSize</span></a><span> </span><a href="#local-6989586621680964837"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-494"></a><span>
</span><a name="line-495"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-496"></a><span class="hs-comment">-- For certain types passed to foreign calls, we adjust the actual</span><span>
</span><a name="line-497"></a><span class="hs-comment">-- value passed to the call.  For ByteArray#/Array# we pass the</span><span>
</span><a name="line-498"></a><span class="hs-comment">-- address of the actual array, not the address of the heap object.</span><span>
</span><a name="line-499"></a><span>
</span><a name="line-500"></a><span class="hs-identifier">getFCallArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ForeignHint</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-501"></a><span class="hs-comment">-- (a) Drop void args</span><span>
</span><a name="line-502"></a><span class="hs-comment">-- (b) Add foreign-call shim code</span><span>
</span><a name="line-503"></a><span class="hs-comment">-- It's (b) that makes this differ from getNonVoidArgAmodes</span><span>
</span><a name="line-504"></a><span>
</span><a name="line-505"></a><a name="getFCallArgs"><a href="StgCmmForeign.html#getFCallArgs"><span class="hs-identifier">getFCallArgs</span></a></a><span> </span><a name="local-6989586621680964839"><a href="#local-6989586621680964839"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-506"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680964847"><a href="#local-6989586621680964847"><span class="hs-identifier">mb_cmms</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621680964840"><span class="hs-identifier hs-var">get</span></a><span> </span><a href="#local-6989586621680964839"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-507"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">catMaybes</span><span> </span><a href="#local-6989586621680964847"><span class="hs-identifier hs-var">mb_cmms</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-508"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-509"></a><span>    </span><a name="local-6989586621680964840"><a href="#local-6989586621680964840"><span class="hs-identifier">get</span></a></a><span> </span><a name="local-6989586621680964841"><a href="#local-6989586621680964841"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621680964843"><span class="hs-identifier hs-var">arg_reps</span></a><span>
</span><a name="line-510"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-511"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-512"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680964845"><a href="#local-6989586621680964845"><span class="hs-identifier">cmm</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmEnv.html#getArgAmode"><span class="hs-identifier hs-var">getArgAmode</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-var">NonVoid</span></a><span> </span><a href="#local-6989586621680964841"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span>
</span><a name="line-513"></a><span>                 </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680964846"><a href="#local-6989586621680964846"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-514"></a><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="StgCmmForeign.html#add_shim"><span class="hs-identifier hs-var">add_shim</span></a><span> </span><a href="#local-6989586621680964846"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680964842"><span class="hs-identifier hs-var">arg_ty</span></a><span> </span><a href="#local-6989586621680964845"><span class="hs-identifier hs-var">cmm</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680964844"><span class="hs-identifier hs-var">hint</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-515"></a><span>            </span><span class="hs-keyword">where</span><span>
</span><a name="line-516"></a><span>              </span><a name="local-6989586621680964842"><a href="#local-6989586621680964842"><span class="hs-identifier">arg_ty</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#stgArgType"><span class="hs-identifier hs-var">stgArgType</span></a><span> </span><a href="#local-6989586621680964841"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-517"></a><span>              </span><a name="local-6989586621680964843"><a href="#local-6989586621680964843"><span class="hs-identifier">arg_reps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">typePrimRep</span><span> </span><a href="#local-6989586621680964842"><span class="hs-identifier hs-var">arg_ty</span></a><span>
</span><a name="line-518"></a><span>              </span><a name="local-6989586621680964844"><a href="#local-6989586621680964844"><span class="hs-identifier">hint</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CmmUtils.html#typeForeignHint"><span class="hs-identifier hs-var">typeForeignHint</span></a><span> </span><a href="#local-6989586621680964842"><span class="hs-identifier hs-var">arg_ty</span></a><span>
</span><a name="line-519"></a><span>
</span><a name="line-520"></a><span class="hs-identifier">add_shim</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>
</span><a name="line-521"></a><a name="add_shim"><a href="StgCmmForeign.html#add_shim"><span class="hs-identifier">add_shim</span></a></a><span> </span><a name="local-6989586621680964848"><a href="#local-6989586621680964848"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680964849"><a href="#local-6989586621680964849"><span class="hs-identifier">arg_ty</span></a></a><span> </span><a name="local-6989586621680964850"><a href="#local-6989586621680964850"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-522"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680964851"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">arrayPrimTyCon</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621680964851"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">mutableArrayPrimTyCon</span><span>
</span><a name="line-523"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CmmUtils.html#cmmOffsetB"><span class="hs-identifier hs-var">cmmOffsetB</span></a><span> </span><a href="#local-6989586621680964848"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680964850"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">(</span><a href="SMRep.html#arrPtrsHdrSize"><span class="hs-identifier hs-var">arrPtrsHdrSize</span></a><span> </span><a href="#local-6989586621680964848"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-524"></a><span>
</span><a name="line-525"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680964851"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">smallArrayPrimTyCon</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621680964851"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">smallMutableArrayPrimTyCon</span><span>
</span><a name="line-526"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CmmUtils.html#cmmOffsetB"><span class="hs-identifier hs-var">cmmOffsetB</span></a><span> </span><a href="#local-6989586621680964848"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680964850"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">(</span><a href="SMRep.html#smallArrPtrsHdrSize"><span class="hs-identifier hs-var">smallArrPtrsHdrSize</span></a><span> </span><a href="#local-6989586621680964848"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-527"></a><span>
</span><a name="line-528"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680964851"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">byteArrayPrimTyCon</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621680964851"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">mutableByteArrayPrimTyCon</span><span>
</span><a name="line-529"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CmmUtils.html#cmmOffsetB"><span class="hs-identifier hs-var">cmmOffsetB</span></a><span> </span><a href="#local-6989586621680964848"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680964850"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">(</span><a href="SMRep.html#arrWordsHdrSize"><span class="hs-identifier hs-var">arrWordsHdrSize</span></a><span> </span><a href="#local-6989586621680964848"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-530"></a><span>
</span><a name="line-531"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680964850"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-532"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-533"></a><span>    </span><a name="local-6989586621680964851"><a href="#local-6989586621680964851"><span class="hs-identifier">tycon</span></a></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConAppTyCon</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unwrapType</span><span> </span><a href="#local-6989586621680964849"><span class="hs-identifier hs-var">arg_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-534"></a><span>        </span><span class="hs-comment">-- should be a tycon app, since this is a foreign call</span><span>
</span><a name="line-535"></a></pre></body></html>