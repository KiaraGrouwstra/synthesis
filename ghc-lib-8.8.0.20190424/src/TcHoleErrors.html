<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">TcHoleErrors</span><span> </span><span class="hs-special">(</span><span> </span><a href="TcHoleErrors.html#findValidHoleFits"><span class="hs-identifier hs-var">findValidHoleFits</span></a><span class="hs-special">,</span><span> </span><a href="TcHoleErrors.html#tcFilterHoleFits"><span class="hs-identifier hs-var">tcFilterHoleFits</span></a><span class="hs-special">,</span><span> </span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-type">HoleFit</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-2"></a><span>                    </span><span class="hs-special">,</span><span> </span><a href="TcHoleErrors.html#HoleFitCandidate"><span class="hs-identifier hs-type">HoleFitCandidate</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="TcHoleErrors.html#tcCheckHoleFit"><span class="hs-identifier hs-var">tcCheckHoleFit</span></a><span class="hs-special">,</span><span> </span><a href="TcHoleErrors.html#tcSubsumes"><span class="hs-identifier hs-var">tcSubsumes</span></a><span>
</span><a name="line-3"></a><span>                    </span><span class="hs-special">,</span><span> </span><a href="TcHoleErrors.html#withoutUnification"><span class="hs-identifier hs-var">withoutUnification</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcRnTypes</span><span>
</span><a name="line-8"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-9"></a><span class="hs-keyword">import</span><span> </span><a href="TcMType.html"><span class="hs-identifier">TcMType</span></a><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcEvidence</span><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RdrName</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">pprNameProvenance</span><span> </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">GlobalRdrElt</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">globalRdrEnvElts</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">gHC_ERR</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarSet</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarEnv</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Bag</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ConLike</span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">ConLike</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="TcEnv.html"><span class="hs-identifier">TcEnv</span></a><span> </span><span class="hs-special">(</span><a href="TcEnv.html#tcLookup"><span class="hs-identifier hs-var">tcLookup</span></a><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FV</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">fvVarList</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fvVarSet</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unionFV</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkFVs</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FV</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Arrow</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&amp;&amp;&amp;</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">filterM</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">replicateM</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">partition</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">sort</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">sortOn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nubBy</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Graph</span><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">graphFromEdges</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">topSort</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Function</span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">on</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="TcSimplify.html"><span class="hs-identifier">TcSimplify</span></a><span>    </span><span class="hs-special">(</span><span> </span><a href="TcSimplify.html#simpl_top"><span class="hs-identifier hs-var">simpl_top</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#runTcSDeriveds"><span class="hs-identifier hs-var">runTcSDeriveds</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="TcUnify.html"><span class="hs-identifier">TcUnify</span></a><span>       </span><span class="hs-special">(</span><span> </span><a href="TcUnify.html#tcSubType_NC"><span class="hs-identifier hs-var">tcSubType_NC</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="ExtractDocs.html"><span class="hs-identifier">ExtractDocs</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="ExtractDocs.html#extractDocs"><span class="hs-identifier hs-var">extractDocs</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsDoc</span><span>           </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">HsDocString</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unpackHDS</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DeclDocMap</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="LoadIface.html"><span class="hs-identifier">LoadIface</span></a><span>       </span><span class="hs-special">(</span><span> </span><a href="LoadIface.html#loadInterfaceForNameMaybe"><span class="hs-identifier hs-var">loadInterfaceForNameMaybe</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="PrelInfo.html"><span class="hs-identifier">PrelInfo</span></a><span> </span><span class="hs-special">(</span><a href="PrelInfo.html#knownKeyNames"><span class="hs-identifier hs-var">knownKeyNames</span></a><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-comment">{-
Note [Valid hole fits include ...]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
`findValidHoleFits` returns the &quot;Valid hole fits include ...&quot; message.
For example, look at the following definitions in a file called test.hs:

   import Data.List (inits)

   f :: [String]
   f = _ &quot;hello, world&quot;

The hole in `f` would generate the message:

  &#8226; Found hole: _ :: [Char] -&gt; [String]
  &#8226; In the expression: _
    In the expression: _ &quot;hello, world&quot;
    In an equation for &#8216;f&#8217;: f = _ &quot;hello, world&quot;
  &#8226; Relevant bindings include f :: [String] (bound at test.hs:6:1)
    Valid hole fits include
      lines :: String -&gt; [String]
        (imported from &#8216;Prelude&#8217; at mpt.hs:3:8-9
          (and originally defined in &#8216;base-4.11.0.0:Data.OldList&#8217;))
      words :: String -&gt; [String]
        (imported from &#8216;Prelude&#8217; at mpt.hs:3:8-9
          (and originally defined in &#8216;base-4.11.0.0:Data.OldList&#8217;))
      inits :: forall a. [a] -&gt; [[a]]
        with inits @Char
        (imported from &#8216;Data.List&#8217; at mpt.hs:4:19-23
          (and originally defined in &#8216;base-4.11.0.0:Data.OldList&#8217;))
      repeat :: forall a. a -&gt; [a]
        with repeat @String
        (imported from &#8216;Prelude&#8217; at mpt.hs:3:8-9
          (and originally defined in &#8216;GHC.List&#8217;))
      fail :: forall (m :: * -&gt; *). Monad m =&gt; forall a. String -&gt; m a
        with fail @[] @String
        (imported from &#8216;Prelude&#8217; at mpt.hs:3:8-9
          (and originally defined in &#8216;GHC.Base&#8217;))
      return :: forall (m :: * -&gt; *). Monad m =&gt; forall a. a -&gt; m a
        with return @[] @String
        (imported from &#8216;Prelude&#8217; at mpt.hs:3:8-9
          (and originally defined in &#8216;GHC.Base&#8217;))
      pure :: forall (f :: * -&gt; *). Applicative f =&gt; forall a. a -&gt; f a
        with pure @[] @String
        (imported from &#8216;Prelude&#8217; at mpt.hs:3:8-9
          (and originally defined in &#8216;GHC.Base&#8217;))
      read :: forall a. Read a =&gt; String -&gt; a
        with read @[String]
        (imported from &#8216;Prelude&#8217; at mpt.hs:3:8-9
          (and originally defined in &#8216;Text.Read&#8217;))
      mempty :: forall a. Monoid a =&gt; a
        with mempty @([Char] -&gt; [String])
        (imported from &#8216;Prelude&#8217; at mpt.hs:3:8-9
          (and originally defined in &#8216;GHC.Base&#8217;))

Valid hole fits are found by checking top level identifiers and local bindings
in scope for whether their type can be instantiated to the the type of the hole.
Additionally, we also need to check whether all relevant constraints are solved
by choosing an identifier of that type as well, see Note [Relevant Constraints]

Since checking for subsumption results in the side-effect of type variables
being unified by the simplifier, we need to take care to restore them after
to being flexible type variables after we've checked for subsumption.
This is to avoid affecting the hole and later checks by prematurely having
unified one of the free unification variables.

When outputting, we sort the hole fits by the size of the types we'd need to
apply by type application to the type of the fit to to make it fit. This is done
in order to display &quot;more relevant&quot; suggestions first. Another option is to
sort by building a subsumption graph of fits, i.e. a graph of which fits subsume
what other fits, and then outputting those fits which are are subsumed by other
fits (i.e. those more specific than other fits) first. This results in the ones
&quot;closest&quot; to the type of the hole to be displayed first.

To help users understand how the suggested fit works, we also display the values
that the quantified type variables would take if that fit is used, like
`mempty @([Char] -&gt; [String])` and `pure @[] @String` in the example above.
If -XTypeApplications is enabled, this can even be copied verbatim as a
replacement for the hole.


Note [Nested implications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

For the simplifier to be able to use any givens present in the enclosing
implications to solve relevant constraints, we nest the wanted subsumption
constraints and relevant constraints within the enclosing implications.

As an example, let's look at the following code:

  f :: Show a =&gt; a -&gt; String
  f x = show _

The hole will result in the hole constraint:

  [WD] __a1ph {0}:: a0_a1pd[tau:2] (CHoleCan: ExprHole(_))

Here the nested implications are just one level deep, namely:

  [Implic {
      TcLevel = 2
      Skolems = a_a1pa[sk:2]
      No-eqs = True
      Status = Unsolved
      Given = $dShow_a1pc :: Show a_a1pa[sk:2]
      Wanted =
        WC {wc_simple =
              [WD] __a1ph {0}:: a_a1pd[tau:2] (CHoleCan: ExprHole(_))
              [WD] $dShow_a1pe {0}:: Show a_a1pd[tau:2] (CDictCan(psc))}
      Binds = EvBindsVar&lt;a1pi&gt;
      Needed inner = []
      Needed outer = []
      the type signature for:
        f :: forall a. Show a =&gt; a -&gt; String }]

As we can see, the givens say that the information about the skolem
`a_a1pa[sk:2]` fulfills the Show constraint.

The simples are:

  [[WD] __a1ph {0}:: a0_a1pd[tau:2] (CHoleCan: ExprHole(_)),
    [WD] $dShow_a1pe {0}:: Show a0_a1pd[tau:2] (CNonCanonical)]

I.e. the hole `a0_a1pd[tau:2]` and the constraint that the type of the hole must
fulfill `Show a0_a1pd[tau:2])`.

So when we run the check, we need to make sure that the

  [WD] $dShow_a1pe {0}:: Show a0_a1pd[tau:2] (CNonCanonical)

Constraint gets solved. When we now check for whether `x :: a0_a1pd[tau:2]` fits
the hole in `tcCheckHoleFit`, the call to `tcSubType` will end up writing the
meta type variable `a0_a1pd[tau:2] := a_a1pa[sk:2]`. By wrapping the wanted
constraints needed by tcSubType_NC and the relevant constraints (see
Note [Relevant Constraints] for more details) in the nested implications, we
can pass the information in the givens along to the simplifier. For our example,
we end up needing to check whether the following constraints are soluble.

  WC {wc_impl =
        Implic {
          TcLevel = 2
          Skolems = a_a1pa[sk:2]
          No-eqs = True
          Status = Unsolved
          Given = $dShow_a1pc :: Show a_a1pa[sk:2]
          Wanted =
            WC {wc_simple =
                  [WD] $dShow_a1pe {0}:: Show a0_a1pd[tau:2] (CNonCanonical)}
          Binds = EvBindsVar&lt;a1pl&gt;
          Needed inner = []
          Needed outer = []
          the type signature for:
            f :: forall a. Show a =&gt; a -&gt; String }}

But since `a0_a1pd[tau:2] := a_a1pa[sk:2]` and we have from the nested
implications that Show a_a1pa[sk:2] is a given, this is trivial, and we end up
with a final WC of WC {}, confirming x :: a0_a1pd[tau:2] as a match.

To avoid side-effects on the nested implications, we create a new EvBindsVar so
that any changes to the ev binds during a check remains localised to that check.


Note [Valid refinement hole fits include ...]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When the `-frefinement-level-hole-fits=N` flag is given, we additionally look
for &quot;valid refinement hole fits&quot;&quot;, i.e. valid hole fits with up to N
additional holes in them.

With `-frefinement-level-hole-fits=0` (the default), GHC will find all
identifiers 'f' (top-level or nested) that will fit in the hole.

With `-frefinement-level-hole-fits=1`, GHC will additionally find all
applications 'f _' that will fit in the hole, where 'f' is an in-scope
identifier, applied to single argument.  It will also report the type of the
needed argument (a new hole).

And similarly as the number of arguments increases

As an example, let's look at the following code:

  f :: [Integer] -&gt; Integer
  f = _

with `-frefinement-level-hole-fits=1`, we'd get:

  Valid refinement hole fits include

    foldl1 (_ :: Integer -&gt; Integer -&gt; Integer)
      with foldl1 @[] @Integer
      where foldl1 :: forall (t :: * -&gt; *).
                      Foldable t =&gt;
                      forall a. (a -&gt; a -&gt; a) -&gt; t a -&gt; a
    foldr1 (_ :: Integer -&gt; Integer -&gt; Integer)
      with foldr1 @[] @Integer
      where foldr1 :: forall (t :: * -&gt; *).
                      Foldable t =&gt;
                      forall a. (a -&gt; a -&gt; a) -&gt; t a -&gt; a
    const (_ :: Integer)
      with const @Integer @[Integer]
      where const :: forall a b. a -&gt; b -&gt; a
    ($) (_ :: [Integer] -&gt; Integer)
      with ($) @'GHC.Types.LiftedRep @[Integer] @Integer
      where ($) :: forall a b. (a -&gt; b) -&gt; a -&gt; b
    fail (_ :: String)
      with fail @((-&gt;) [Integer]) @Integer
      where fail :: forall (m :: * -&gt; *).
                    Monad m =&gt;
                    forall a. String -&gt; m a
    return (_ :: Integer)
      with return @((-&gt;) [Integer]) @Integer
      where return :: forall (m :: * -&gt; *). Monad m =&gt; forall a. a -&gt; m a
    (Some refinement hole fits suppressed;
      use -fmax-refinement-hole-fits=N or -fno-max-refinement-hole-fits)

Which are hole fits with holes in them. This allows e.g. beginners to
discover the fold functions and similar, but also allows for advanced users
to figure out the valid functions in the Free monad, e.g.

  instance Functor f =&gt; Monad (Free f) where
      Pure a &gt;&gt;= f = f a
      Free f &gt;&gt;= g = Free (fmap _a f)

Will output (with -frefinment-level-hole-fits=1):
    Found hole: _a :: Free f a -&gt; Free f b
          Where: &#8216;a&#8217;, &#8216;b&#8217; are rigid type variables bound by
                  the type signature for:
                    (&gt;&gt;=) :: forall a b. Free f a -&gt; (a -&gt; Free f b) -&gt; Free f b
                  at fms.hs:25:12-14
                &#8216;f&#8217; is a rigid type variable bound by
    ...
    Relevant bindings include
      g :: a -&gt; Free f b (bound at fms.hs:27:16)
      f :: f (Free f a) (bound at fms.hs:27:10)
      (&gt;&gt;=) :: Free f a -&gt; (a -&gt; Free f b) -&gt; Free f b
        (bound at fms.hs:25:12)
    ...
    Valid refinement hole fits include
      ...
      (=&lt;&lt;) (_ :: a -&gt; Free f b)
        with (=&lt;&lt;) @(Free f) @a @b
        where (=&lt;&lt;) :: forall (m :: * -&gt; *) a b.
                      Monad m =&gt;
                      (a -&gt; m b) -&gt; m a -&gt; m b
        (imported from &#8216;Prelude&#8217; at fms.hs:5:18-22
        (and originally defined in &#8216;GHC.Base&#8217;))
      ...

Where `(=&lt;&lt;) _` is precisely the function we want (we ultimately want `&gt;&gt;= g`).

We find these refinement suggestions by considering hole fits that don't
fit the type of the hole, but ones that would fit if given an additional
argument. We do this by creating a new type variable with `newOpenFlexiTyVar`
(e.g. `t_a1/m[tau:1]`), and then considering hole fits of the type
`t_a1/m[tau:1] -&gt; v` where `v` is the type of the hole.

Since the simplifier is free to unify this new type variable with any type, we
can discover any identifiers that would fit if given another identifier of a
suitable type. This is then generalized so that we can consider any number of
additional arguments by setting the `-frefinement-level-hole-fits` flag to any
number, and then considering hole fits like e.g. `foldl _ _` with two additional
arguments.

To make sure that the refinement hole fits are useful, we check that the types
of the additional holes have a concrete value and not just an invented type
variable. This eliminates suggestions such as `head (_ :: [t0 -&gt; a]) (_ :: t0)`,
and limits the number of less than useful refinement hole fits.

Additionally, to further aid the user in their implementation, we show the
types of the holes the binding would have to be applied to in order to work.
In the free monad example above, this is demonstrated with
`(=&lt;&lt;) (_ :: a -&gt; Free f b)`, which tells the user that the `(=&lt;&lt;)` needs to
be applied to an expression of type `a -&gt; Free f b` in order to match.
If -XScopedTypeVariables is enabled, this hole fit can even be copied verbatim.


Note [Relevant Constraints]
~~~~~~~~~~~~~~~~~~~

As highlighted by Trac #14273, we need to check any relevant constraints as well
as checking for subsumption. Relevant constraints are the simple constraints
whose free unification variables are mentioned in the type of the hole.

In the simplest case, these are all non-hole constraints in the simples, such
as is the case in

  f :: String
  f = show _

Where the simples will be :

  [[WD] __a1kz {0}:: a0_a1kv[tau:1] (CHoleCan: ExprHole(_)),
    [WD] $dShow_a1kw {0}:: Show a0_a1kv[tau:1] (CNonCanonical)]

However, when there are multiple holes, we need to be more careful. As an
example, Let's take a look at the following code:

  f :: Show a =&gt; a -&gt; String
  f x = show (_b (show _a))

Here there are two holes, `_a` and `_b`, and the simple constraints passed to
findValidHoleFits are:

  [[WD] _a_a1pi {0}:: String
                        -&gt; a0_a1pd[tau:2] (CHoleCan: ExprHole(_b)),
    [WD] _b_a1ps {0}:: a1_a1po[tau:2] (CHoleCan: ExprHole(_a)),
    [WD] $dShow_a1pe {0}:: Show a0_a1pd[tau:2] (CNonCanonical),
    [WD] $dShow_a1pp {0}:: Show a1_a1po[tau:2] (CNonCanonical)]


Here we have the two hole constraints for `_a` and `_b`, but also additional
constraints that these holes must fulfill. When we are looking for a match for
the hole `_a`, we filter the simple constraints to the &quot;Relevant constraints&quot;,
by throwing out all hole constraints and any constraints which do not mention
a variable mentioned in the type of the hole. For hole `_a`, we will then
only require that the `$dShow_a1pp` constraint is solved, since that is
the only non-hole constraint that mentions any free type variables mentioned in
the hole constraint for `_a`, namely `a_a1pd[tau:2]` , and similarly for the
hole `_b` we only require that the `$dShow_a1pe` constraint is solved.

Note [Leaking errors]
~~~~~~~~~~~~~~~~~~~

When considering candidates, GHC believes that we're checking for validity in
actual source. However, As evidenced by #15321, #15007 and #15202, this can
cause bewildering error messages. The solution here is simple: if a candidate
would cause the type checker to error, it is not a valid hole fit, and thus it
is discarded.

-}</span><span>
</span><a name="line-377"></a><span>
</span><a name="line-378"></a><span>
</span><a name="line-379"></a><span class="hs-keyword">data</span><span> </span><a name="HoleFitDispConfig"><a href="TcHoleErrors.html#HoleFitDispConfig"><span class="hs-identifier">HoleFitDispConfig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="HFDC"><a href="TcHoleErrors.html#HFDC"><span class="hs-identifier">HFDC</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="showWrap"><a href="TcHoleErrors.html#showWrap"><span class="hs-identifier">showWrap</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-380"></a><span>                              </span><span class="hs-special">,</span><span> </span><a name="showWrapVars"><a href="TcHoleErrors.html#showWrapVars"><span class="hs-identifier">showWrapVars</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-381"></a><span>                              </span><span class="hs-special">,</span><span> </span><a name="showType"><a href="TcHoleErrors.html#showType"><span class="hs-identifier">showType</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-382"></a><span>                              </span><span class="hs-special">,</span><span> </span><a name="showProv"><a href="TcHoleErrors.html#showProv"><span class="hs-identifier">showProv</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-383"></a><span>                              </span><span class="hs-special">,</span><span> </span><a name="showMatches"><a href="TcHoleErrors.html#showMatches"><span class="hs-identifier">showMatches</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-384"></a><span>
</span><a name="line-385"></a><span class="hs-identifier">debugHoleFitDispConfig</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcHoleErrors.html#HoleFitDispConfig"><span class="hs-identifier hs-type">HoleFitDispConfig</span></a><span>
</span><a name="line-386"></a><a name="debugHoleFitDispConfig"><a href="TcHoleErrors.html#debugHoleFitDispConfig"><span class="hs-identifier">debugHoleFitDispConfig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHoleErrors.html#HFDC"><span class="hs-identifier hs-var">HFDC</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-387"></a><span>
</span><a name="line-388"></a><span>
</span><a name="line-389"></a><span class="hs-comment">-- We read the various -no-show-*-of-hole-fits flags</span><span>
</span><a name="line-390"></a><span class="hs-comment">-- and set the display config accordingly.</span><span>
</span><a name="line-391"></a><span class="hs-identifier">getHoleFitDispConfig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="TcHoleErrors.html#HoleFitDispConfig"><span class="hs-identifier hs-type">HoleFitDispConfig</span></a><span>
</span><a name="line-392"></a><a name="getHoleFitDispConfig"><a href="TcHoleErrors.html#getHoleFitDispConfig"><span class="hs-identifier">getHoleFitDispConfig</span></a></a><span>
</span><a name="line-393"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683006298"><a href="#local-6989586621683006298"><span class="hs-identifier">sWrap</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#goptM"><span class="hs-identifier hs-var">goptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_ShowTypeAppOfHoleFits</span><span>
</span><a name="line-394"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683006299"><a href="#local-6989586621683006299"><span class="hs-identifier">sWrapVars</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#goptM"><span class="hs-identifier hs-var">goptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_ShowTypeAppVarsOfHoleFits</span><span>
</span><a name="line-395"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683006300"><a href="#local-6989586621683006300"><span class="hs-identifier">sType</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#goptM"><span class="hs-identifier hs-var">goptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_ShowTypeOfHoleFits</span><span>
</span><a name="line-396"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683006301"><a href="#local-6989586621683006301"><span class="hs-identifier">sProv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#goptM"><span class="hs-identifier hs-var">goptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_ShowProvOfHoleFits</span><span>
</span><a name="line-397"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683006302"><a href="#local-6989586621683006302"><span class="hs-identifier">sMatc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#goptM"><span class="hs-identifier hs-var">goptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_ShowMatchesOfHoleFits</span><span>
</span><a name="line-398"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="TcHoleErrors.html#HFDC"><span class="hs-identifier hs-var">HFDC</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">showWrap</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006298"><span class="hs-identifier hs-var">sWrap</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">showWrapVars</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006299"><span class="hs-identifier hs-var">sWrapVars</span></a><span>
</span><a name="line-399"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">showProv</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006301"><span class="hs-identifier hs-var">sProv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">showType</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006300"><span class="hs-identifier hs-var">sType</span></a><span>
</span><a name="line-400"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">showMatches</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006302"><span class="hs-identifier hs-var">sMatc</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-401"></a><span>
</span><a name="line-402"></a><span class="hs-comment">-- Which sorting algorithm to use</span><span>
</span><a name="line-403"></a><span class="hs-keyword">data</span><span> </span><a name="SortingAlg"><a href="TcHoleErrors.html#SortingAlg"><span class="hs-identifier">SortingAlg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="NoSorting"><a href="TcHoleErrors.html#NoSorting"><span class="hs-identifier">NoSorting</span></a></a><span>      </span><span class="hs-comment">-- Do not sort the fits at all</span><span>
</span><a name="line-404"></a><span>                </span><span class="hs-glyph">|</span><span> </span><a name="BySize"><a href="TcHoleErrors.html#BySize"><span class="hs-identifier">BySize</span></a></a><span>         </span><span class="hs-comment">-- Sort them by the size of the match</span><span>
</span><a name="line-405"></a><span>                </span><span class="hs-glyph">|</span><span> </span><a name="BySubsumption"><a href="TcHoleErrors.html#BySubsumption"><span class="hs-identifier">BySubsumption</span></a></a><span>  </span><span class="hs-comment">-- Sort by full subsumption</span><span>
</span><a name="line-406"></a><span>                </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">)</span><span>
</span><a name="line-407"></a><span>
</span><a name="line-408"></a><span class="hs-identifier">getSortingAlg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="TcHoleErrors.html#SortingAlg"><span class="hs-identifier hs-type">SortingAlg</span></a><span>
</span><a name="line-409"></a><a name="getSortingAlg"><a href="TcHoleErrors.html#getSortingAlg"><span class="hs-identifier">getSortingAlg</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-410"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683006303"><a href="#local-6989586621683006303"><span class="hs-identifier">shouldSort</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#goptM"><span class="hs-identifier hs-var">goptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_SortValidHoleFits</span><span>
</span><a name="line-411"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683006304"><a href="#local-6989586621683006304"><span class="hs-identifier">subsumSort</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#goptM"><span class="hs-identifier hs-var">goptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_SortBySubsumHoleFits</span><span>
</span><a name="line-412"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683006305"><a href="#local-6989586621683006305"><span class="hs-identifier">sizeSort</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#goptM"><span class="hs-identifier hs-var">goptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_SortBySizeHoleFits</span><span>
</span><a name="line-413"></a><span>       </span><span class="hs-comment">-- We default to sizeSort unless it has been explicitly turned off</span><span>
</span><a name="line-414"></a><span>       </span><span class="hs-comment">-- or subsumption sorting has been turned on.</span><span>
</span><a name="line-415"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621683006303"><span class="hs-identifier hs-var">shouldSort</span></a><span>
</span><a name="line-416"></a><span>                    </span><span class="hs-keyword">then</span><span> </span><a href="TcHoleErrors.html#NoSorting"><span class="hs-identifier hs-var">NoSorting</span></a><span>
</span><a name="line-417"></a><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683006304"><span class="hs-identifier hs-var">subsumSort</span></a><span>
</span><a name="line-418"></a><span>                         </span><span class="hs-keyword">then</span><span> </span><a href="TcHoleErrors.html#BySubsumption"><span class="hs-identifier hs-var">BySubsumption</span></a><span>
</span><a name="line-419"></a><span>                         </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683006305"><span class="hs-identifier hs-var">sizeSort</span></a><span>
</span><a name="line-420"></a><span>                              </span><span class="hs-keyword">then</span><span> </span><a href="TcHoleErrors.html#BySize"><span class="hs-identifier hs-var">BySize</span></a><span>
</span><a name="line-421"></a><span>                              </span><span class="hs-keyword">else</span><span> </span><a href="TcHoleErrors.html#NoSorting"><span class="hs-identifier hs-var">NoSorting</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-422"></a><span>
</span><a name="line-423"></a><span>
</span><a name="line-424"></a><span class="hs-comment">-- | HoleFitCandidates are passed to the filter and checked whether they can be</span><span>
</span><a name="line-425"></a><span class="hs-comment">-- made to fit.</span><span>
</span><a name="line-426"></a><span class="hs-keyword">data</span><span> </span><a name="HoleFitCandidate"><a href="TcHoleErrors.html#HoleFitCandidate"><span class="hs-identifier">HoleFitCandidate</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="IdHFCand"><a href="TcHoleErrors.html#IdHFCand"><span class="hs-identifier">IdHFCand</span></a></a><span> </span><span class="hs-identifier hs-type">Id</span><span>             </span><span class="hs-comment">-- An id, like locals.</span><span>
</span><a name="line-427"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><a name="NameHFCand"><a href="TcHoleErrors.html#NameHFCand"><span class="hs-identifier">NameHFCand</span></a></a><span> </span><span class="hs-identifier hs-type">Name</span><span>         </span><span class="hs-comment">-- A name, like built-in syntax.</span><span>
</span><a name="line-428"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><a name="GreHFCand"><a href="TcHoleErrors.html#GreHFCand"><span class="hs-identifier">GreHFCand</span></a></a><span> </span><span class="hs-identifier hs-type">GlobalRdrElt</span><span>  </span><span class="hs-comment">-- A global, like imported ids.</span><span>
</span><a name="line-429"></a><span>                      </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-430"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="TcHoleErrors.html#HoleFitCandidate"><span class="hs-identifier hs-type">HoleFitCandidate</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-431"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHoleErrors.html#pprHoleFitCand"><span class="hs-identifier hs-var">pprHoleFitCand</span></a><span>
</span><a name="line-432"></a><span>
</span><a name="line-433"></a><span class="hs-identifier">pprHoleFitCand</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcHoleErrors.html#HoleFitCandidate"><span class="hs-identifier hs-type">HoleFitCandidate</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-434"></a><a name="pprHoleFitCand"><a href="TcHoleErrors.html#pprHoleFitCand"><span class="hs-identifier">pprHoleFitCand</span></a></a><span> </span><span class="hs-special">(</span><a href="TcHoleErrors.html#IdHFCand"><span class="hs-identifier hs-var">IdHFCand</span></a><span> </span><a name="local-6989586621683006306"><a href="#local-6989586621683006306"><span class="hs-identifier">id</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Id HFC: &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683006306"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-435"></a><span class="hs-identifier">pprHoleFitCand</span><span> </span><span class="hs-special">(</span><a href="TcHoleErrors.html#NameHFCand"><span class="hs-identifier hs-var">NameHFCand</span></a><span> </span><a name="local-6989586621683006307"><a href="#local-6989586621683006307"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Name HFC: &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683006307"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-436"></a><span class="hs-identifier">pprHoleFitCand</span><span> </span><span class="hs-special">(</span><a href="TcHoleErrors.html#GreHFCand"><span class="hs-identifier hs-var">GreHFCand</span></a><span> </span><a name="local-6989586621683006308"><a href="#local-6989586621683006308"><span class="hs-identifier">gre</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Gre HFC: &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683006308"><span class="hs-identifier hs-var">gre</span></a><span>
</span><a name="line-437"></a><span>
</span><a name="line-438"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">HasOccName</span><span> </span><a href="TcHoleErrors.html#HoleFitCandidate"><span class="hs-identifier hs-type">HoleFitCandidate</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-439"></a><span>  </span><a name="local-8214565720323803527"><span class="hs-identifier">occName</span></a><span> </span><a name="local-6989586621683006293"><a href="#local-6989586621683006293"><span class="hs-identifier">hfc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683006293"><span class="hs-identifier hs-var">hfc</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-440"></a><span>                  </span><a href="TcHoleErrors.html#IdHFCand"><span class="hs-identifier hs-var">IdHFCand</span></a><span> </span><a name="local-6989586621683006294"><a href="#local-6989586621683006294"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">occName</span><span> </span><a href="#local-6989586621683006294"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-441"></a><span>                  </span><a href="TcHoleErrors.html#NameHFCand"><span class="hs-identifier hs-var">NameHFCand</span></a><span> </span><a name="local-6989586621683006295"><a href="#local-6989586621683006295"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">occName</span><span> </span><a href="#local-6989586621683006295"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-442"></a><span>                  </span><a href="TcHoleErrors.html#GreHFCand"><span class="hs-identifier hs-var">GreHFCand</span></a><span> </span><a name="local-6989586621683006296"><a href="#local-6989586621683006296"><span class="hs-identifier">gre</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">occName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">gre_name</span><span> </span><a href="#local-6989586621683006296"><span class="hs-identifier hs-var">gre</span></a><span class="hs-special">)</span><span>
</span><a name="line-443"></a><span>
</span><a name="line-444"></a><span class="hs-comment">-- | HoleFit is the type we use for valid hole fits. It contains the</span><span>
</span><a name="line-445"></a><span class="hs-comment">-- element that was checked, the Id of that element as found by `tcLookup`,</span><span>
</span><a name="line-446"></a><span class="hs-comment">-- and the refinement level of the fit, which is the number of extra argument</span><span>
</span><a name="line-447"></a><span class="hs-comment">-- holes that this fit uses (e.g. if hfRefLvl is 2, the fit is for `Id _ _`).</span><span>
</span><a name="line-448"></a><span class="hs-keyword">data</span><span> </span><a name="HoleFit"><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier">HoleFit</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-449"></a><span>  </span><a name="HoleFit"><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier">HoleFit</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="hfId"><a href="TcHoleErrors.html#hfId"><span class="hs-identifier">hfId</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span>       </span><span class="hs-comment">-- The elements id in the TcM</span><span>
</span><a name="line-450"></a><span>          </span><span class="hs-special">,</span><span> </span><a name="hfCand"><a href="TcHoleErrors.html#hfCand"><span class="hs-identifier">hfCand</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcHoleErrors.html#HoleFitCandidate"><span class="hs-identifier hs-type">HoleFitCandidate</span></a><span>  </span><span class="hs-comment">-- The candidate that was checked.</span><span>
</span><a name="line-451"></a><span>          </span><span class="hs-special">,</span><span> </span><a name="hfType"><a href="TcHoleErrors.html#hfType"><span class="hs-identifier">hfType</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-comment">-- The type of the id, possibly zonked.</span><span>
</span><a name="line-452"></a><span>          </span><span class="hs-special">,</span><span> </span><a name="hfRefLvl"><a href="TcHoleErrors.html#hfRefLvl"><span class="hs-identifier">hfRefLvl</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>  </span><span class="hs-comment">-- The number of holes in this fit.</span><span>
</span><a name="line-453"></a><span>          </span><span class="hs-special">,</span><span> </span><a name="hfWrap"><a href="TcHoleErrors.html#hfWrap"><span class="hs-identifier">hfWrap</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- The wrapper for the match.</span><span>
</span><a name="line-454"></a><span>          </span><span class="hs-special">,</span><span> </span><a name="hfMatches"><a href="TcHoleErrors.html#hfMatches"><span class="hs-identifier">hfMatches</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- What the refinement variables got matched</span><span>
</span><a name="line-455"></a><span>                                   </span><span class="hs-comment">-- with, if anything</span><span>
</span><a name="line-456"></a><span>          </span><span class="hs-special">,</span><span> </span><a name="hfDoc"><a href="TcHoleErrors.html#hfDoc"><span class="hs-identifier">hfDoc</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">HsDocString</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-comment">-- Documentation of this HoleFit, if</span><span>
</span><a name="line-457"></a><span>                                         </span><span class="hs-comment">-- available.</span><span>
</span><a name="line-458"></a><span>
</span><a name="line-459"></a><span>
</span><a name="line-460"></a><span class="hs-identifier">hfName</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-type">HoleFit</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-461"></a><a name="hfName"><a href="TcHoleErrors.html#hfName"><span class="hs-identifier">hfName</span></a></a><span> </span><a name="local-6989586621683006309"><a href="#local-6989586621683006309"><span class="hs-identifier">hf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">hfCand</span><span> </span><a href="#local-6989586621683006309"><span class="hs-identifier hs-var">hf</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-462"></a><span>              </span><a href="TcHoleErrors.html#IdHFCand"><span class="hs-identifier hs-var">IdHFCand</span></a><span> </span><a name="local-6989586621683006310"><a href="#local-6989586621683006310"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621683006310"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-463"></a><span>              </span><a href="TcHoleErrors.html#NameHFCand"><span class="hs-identifier hs-var">NameHFCand</span></a><span> </span><a name="local-6989586621683006311"><a href="#local-6989586621683006311"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683006311"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-464"></a><span>              </span><a href="TcHoleErrors.html#GreHFCand"><span class="hs-identifier hs-var">GreHFCand</span></a><span> </span><a name="local-6989586621683006312"><a href="#local-6989586621683006312"><span class="hs-identifier">gre</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">gre_name</span><span> </span><a href="#local-6989586621683006312"><span class="hs-identifier hs-var">gre</span></a><span>
</span><a name="line-465"></a><span>
</span><a name="line-466"></a><span class="hs-identifier">hfIsLcl</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-type">HoleFit</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-467"></a><a name="hfIsLcl"><a href="TcHoleErrors.html#hfIsLcl"><span class="hs-identifier">hfIsLcl</span></a></a><span> </span><a name="local-6989586621683006313"><a href="#local-6989586621683006313"><span class="hs-identifier">hf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">hfCand</span><span> </span><a href="#local-6989586621683006313"><span class="hs-identifier hs-var">hf</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-468"></a><span>               </span><a href="TcHoleErrors.html#IdHFCand"><span class="hs-identifier hs-var">IdHFCand</span></a><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-469"></a><span>               </span><a href="TcHoleErrors.html#NameHFCand"><span class="hs-identifier hs-var">NameHFCand</span></a><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-470"></a><span>               </span><a href="TcHoleErrors.html#GreHFCand"><span class="hs-identifier hs-var">GreHFCand</span></a><span> </span><a name="local-6989586621683006314"><a href="#local-6989586621683006314"><span class="hs-identifier">gre</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">gre_lcl</span><span> </span><a href="#local-6989586621683006314"><span class="hs-identifier hs-var">gre</span></a><span>
</span><a name="line-471"></a><span>
</span><a name="line-472"></a><span class="hs-comment">-- We define an Eq and Ord instance to be able to build a graph.</span><span>
</span><a name="line-473"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-type">HoleFit</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-474"></a><span>   </span><span class="hs-special">(</span><a name="local-3458764513820541095"><span class="hs-operator">==</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">on</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">hfId</span><span>
</span><a name="line-475"></a><span>
</span><a name="line-476"></a><span class="hs-comment">-- We compare HoleFits by their name instead of their Id, since we don't</span><span>
</span><a name="line-477"></a><span class="hs-comment">-- want our tests to be affected by the non-determinism of `nonDetCmpVar`,</span><span>
</span><a name="line-478"></a><span class="hs-comment">-- which is used to compare Ids. When comparing, we want HoleFits with a lower</span><span>
</span><a name="line-479"></a><span class="hs-comment">-- refinement level to come first.</span><span>
</span><a name="line-480"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-type">HoleFit</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-481"></a><span>  </span><a name="local-8214565720323790496"><span class="hs-identifier">compare</span></a><span> </span><a name="local-6989586621683006290"><a href="#local-6989586621683006290"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621683006291"><a href="#local-6989586621683006291"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006292"><span class="hs-identifier hs-var">cmp</span></a><span> </span><a href="#local-6989586621683006290"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621683006291"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-482"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621683006292"><a href="#local-6989586621683006292"><span class="hs-identifier">cmp</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">hfRefLvl</span><span> </span><a href="#local-6989586621683006290"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">hfRefLvl</span><span> </span><a href="#local-6989586621683006291"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-483"></a><span>                 </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">compare</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">on</span><span class="hs-special">`</span><span> </span><a href="TcHoleErrors.html#hfName"><span class="hs-identifier hs-var">hfName</span></a><span>
</span><a name="line-484"></a><span>                 </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">compare</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">on</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">hfRefLvl</span><span>
</span><a name="line-485"></a><span>
</span><a name="line-486"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-type">HoleFit</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-487"></a><span>    </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHoleErrors.html#pprHoleFit"><span class="hs-identifier hs-var">pprHoleFit</span></a><span> </span><a href="TcHoleErrors.html#debugHoleFitDispConfig"><span class="hs-identifier hs-var">debugHoleFitDispConfig</span></a><span>
</span><a name="line-488"></a><span>
</span><a name="line-489"></a><span class="hs-comment">-- If enabled, we go through the fits and add any associated documentation,</span><span>
</span><a name="line-490"></a><span class="hs-comment">-- by looking it up in the module or the environment (for local fits)</span><span>
</span><a name="line-491"></a><span class="hs-identifier">addDocs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-type">HoleFit</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-type">HoleFit</span></a><span class="hs-special">]</span><span>
</span><a name="line-492"></a><a name="addDocs"><a href="TcHoleErrors.html#addDocs"><span class="hs-identifier">addDocs</span></a></a><span> </span><a name="local-6989586621683006315"><a href="#local-6989586621683006315"><span class="hs-identifier">fits</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-493"></a><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683006326"><a href="#local-6989586621683006326"><span class="hs-identifier">showDocs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#goptM"><span class="hs-identifier hs-var">goptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_ShowDocsOfHoleFits</span><span>
</span><a name="line-494"></a><span>     </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683006326"><span class="hs-identifier hs-var">showDocs</span></a><span>
</span><a name="line-495"></a><span>       </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">DeclDocMap</span><span> </span><a name="local-6989586621683006327"><a href="#local-6989586621683006327"><span class="hs-identifier">lclDocs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ExtractDocs.html#extractDocs"><span class="hs-identifier hs-var">extractDocs</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-496"></a><span>               </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683006318"><span class="hs-identifier hs-var">upd</span></a><span> </span><a href="#local-6989586621683006327"><span class="hs-identifier hs-var">lclDocs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683006315"><span class="hs-identifier hs-var">fits</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-497"></a><span>       </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683006315"><span class="hs-identifier hs-var">fits</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-498"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-499"></a><span>   </span><a name="local-6989586621683006316"><a href="#local-6989586621683006316"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;TcHoleErrors addDocs&quot;</span><span>
</span><a name="line-500"></a><span>   </span><a name="local-6989586621683006317"><a href="#local-6989586621683006317"><span class="hs-identifier">lookupInIface</span></a></a><span> </span><a name="local-6989586621683006319"><a href="#local-6989586621683006319"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ModIface</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mi_decl_docs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DeclDocMap</span><span> </span><a name="local-6989586621683006320"><a href="#local-6989586621683006320"><span class="hs-identifier">dmap</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-501"></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621683006319"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683006320"><span class="hs-identifier hs-var">dmap</span></a><span>
</span><a name="line-502"></a><span>   </span><a name="local-6989586621683006318"><a href="#local-6989586621683006318"><span class="hs-identifier">upd</span></a></a><span> </span><a name="local-6989586621683006321"><a href="#local-6989586621683006321"><span class="hs-identifier">lclDocs</span></a></a><span> </span><a name="local-6989586621683006322"><a href="#local-6989586621683006322"><span class="hs-identifier">fit</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-503"></a><span>     </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683006323"><a href="#local-6989586621683006323"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHoleErrors.html#hfName"><span class="hs-identifier hs-var">hfName</span></a><span> </span><a href="#local-6989586621683006322"><span class="hs-identifier hs-var">fit</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-504"></a><span>     </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683006325"><a href="#local-6989586621683006325"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="TcHoleErrors.html#hfIsLcl"><span class="hs-identifier hs-var">hfIsLcl</span></a><span> </span><a href="#local-6989586621683006322"><span class="hs-identifier hs-var">fit</span></a><span>
</span><a name="line-505"></a><span>                 </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621683006323"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683006321"><span class="hs-identifier hs-var">lclDocs</span></a><span class="hs-special">)</span><span>
</span><a name="line-506"></a><span>                 </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683006324"><a href="#local-6989586621683006324"><span class="hs-identifier">mbIface</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="LoadIface.html#loadInterfaceForNameMaybe"><span class="hs-identifier hs-var">loadInterfaceForNameMaybe</span></a><span> </span><a href="#local-6989586621683006316"><span class="hs-identifier hs-var">msg</span></a><span> </span><a href="#local-6989586621683006323"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-507"></a><span>                         </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683006324"><span class="hs-identifier hs-var">mbIface</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="#local-6989586621683006317"><span class="hs-identifier hs-var">lookupInIface</span></a><span> </span><a href="#local-6989586621683006323"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-508"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683006322"><span class="hs-identifier hs-var">fit</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">hfDoc</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006325"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-509"></a><span>
</span><a name="line-510"></a><span class="hs-comment">-- For pretty printing hole fits, we display the name and type of the fit,</span><span>
</span><a name="line-511"></a><span class="hs-comment">-- with added '_' to represent any extra arguments in case of a non-zero</span><span>
</span><a name="line-512"></a><span class="hs-comment">-- refinement level.</span><span>
</span><a name="line-513"></a><span class="hs-identifier">pprHoleFit</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcHoleErrors.html#HoleFitDispConfig"><span class="hs-identifier hs-type">HoleFitDispConfig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-type">HoleFit</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-514"></a><a name="pprHoleFit"><a href="TcHoleErrors.html#pprHoleFit"><span class="hs-identifier">pprHoleFit</span></a></a><span> </span><span class="hs-special">(</span><a href="TcHoleErrors.html#HFDC"><span class="hs-identifier hs-var">HFDC</span></a><span> </span><a name="local-6989586621683006328"><a href="#local-6989586621683006328"><span class="hs-identifier">sWrp</span></a></a><span> </span><a name="local-6989586621683006329"><a href="#local-6989586621683006329"><span class="hs-identifier">sWrpVars</span></a></a><span> </span><a name="local-6989586621683006330"><a href="#local-6989586621683006330"><span class="hs-identifier">sTy</span></a></a><span> </span><a name="local-6989586621683006331"><a href="#local-6989586621683006331"><span class="hs-identifier">sProv</span></a></a><span> </span><a name="local-6989586621683006332"><a href="#local-6989586621683006332"><span class="hs-identifier">sMs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683006333"><a href="#local-6989586621683006333"><span class="hs-identifier">hf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><a href="#local-6989586621683006349"><span class="hs-identifier hs-var">display</span></a><span> </span><span class="hs-number">2</span><span> </span><a href="#local-6989586621683006350"><span class="hs-identifier hs-var">provenance</span></a><span>
</span><a name="line-515"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621683006334"><a href="#local-6989586621683006334"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHoleErrors.html#hfName"><span class="hs-identifier hs-var">hfName</span></a><span> </span><a href="#local-6989586621683006333"><span class="hs-identifier hs-var">hf</span></a><span>
</span><a name="line-516"></a><span>          </span><a name="local-6989586621683006335"><a href="#local-6989586621683006335"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hfType</span><span> </span><a href="#local-6989586621683006333"><span class="hs-identifier hs-var">hf</span></a><span>
</span><a name="line-517"></a><span>          </span><a name="local-6989586621683006336"><a href="#local-6989586621683006336"><span class="hs-identifier">matches</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier">hfMatches</span><span> </span><a href="#local-6989586621683006333"><span class="hs-identifier hs-var">hf</span></a><span>
</span><a name="line-518"></a><span>          </span><a name="local-6989586621683006337"><a href="#local-6989586621683006337"><span class="hs-identifier">wrap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hfWrap</span><span> </span><a href="#local-6989586621683006333"><span class="hs-identifier hs-var">hf</span></a><span>
</span><a name="line-519"></a><span>          </span><a name="local-6989586621683006338"><a href="#local-6989586621683006338"><span class="hs-identifier">tyApp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;@&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">pprParendType</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683006337"><span class="hs-identifier hs-var">wrap</span></a><span>
</span><a name="line-520"></a><span>          </span><a name="local-6989586621683006339"><a href="#local-6989586621683006339"><span class="hs-identifier">tyAppVars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">punctuate</span><span> </span><span class="hs-identifier hs-var">comma</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-521"></a><span>              </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621683006357"><a href="#local-6989586621683006357"><span class="hs-identifier">v</span></a></a><span class="hs-special">,</span><a name="local-6989586621683006358"><a href="#local-6989586621683006358"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683006357"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;~&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprParendType</span><span> </span><a href="#local-6989586621683006358"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-522"></a><span>                </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621683006351"><span class="hs-identifier hs-var">vars</span></a><span> </span><a href="#local-6989586621683006337"><span class="hs-identifier hs-var">wrap</span></a><span>
</span><a name="line-523"></a><span>            </span><span class="hs-keyword">where</span><span>
</span><a name="line-524"></a><span>              </span><a name="local-6989586621683006351"><a href="#local-6989586621683006351"><span class="hs-identifier">vars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006352"><span class="hs-identifier hs-var">unwrapTypeVars</span></a><span> </span><a href="#local-6989586621683006335"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-525"></a><span>              </span><span class="hs-comment">-- Attempts to get all the quantified type variables in a type,</span><span>
</span><a name="line-526"></a><span>              </span><span class="hs-comment">-- e.g.</span><span>
</span><a name="line-527"></a><span>              </span><span class="hs-comment">-- return :: forall (m :: * -&gt; *) Monad m =&gt; (forall a . a) -&gt; m a</span><span>
</span><a name="line-528"></a><span>              </span><span class="hs-comment">-- into [m, a]</span><span>
</span><a name="line-529"></a><span>              </span><span class="hs-identifier">unwrapTypeVars</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span>
</span><a name="line-530"></a><span>              </span><a name="local-6989586621683006352"><a href="#local-6989586621683006352"><span class="hs-identifier">unwrapTypeVars</span></a></a><span> </span><a name="local-6989586621683006353"><a href="#local-6989586621683006353"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006354"><span class="hs-identifier hs-var">vars</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">splitFunTy_maybe</span><span> </span><a href="#local-6989586621683006355"><span class="hs-identifier hs-var">unforalled</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-531"></a><span>                                  </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683006356"><a href="#local-6989586621683006356"><span class="hs-identifier">unfunned</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683006352"><span class="hs-identifier hs-var">unwrapTypeVars</span></a><span> </span><a href="#local-6989586621683006356"><span class="hs-identifier hs-var">unfunned</span></a><span>
</span><a name="line-532"></a><span>                                  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-533"></a><span>                </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683006354"><a href="#local-6989586621683006354"><span class="hs-identifier">vars</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683006355"><a href="#local-6989586621683006355"><span class="hs-identifier">unforalled</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitForAllTys</span><span> </span><a href="#local-6989586621683006353"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-534"></a><span>          </span><a name="local-6989586621683006340"><a href="#local-6989586621683006340"><span class="hs-identifier">holeVs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;_&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">ppr</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683006336"><span class="hs-identifier hs-var">matches</span></a><span>
</span><a name="line-535"></a><span>          </span><a name="local-6989586621683006341"><a href="#local-6989586621683006341"><span class="hs-identifier">holeDisp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683006332"><span class="hs-identifier hs-var">sMs</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621683006340"><span class="hs-identifier hs-var">holeVs</span></a><span>
</span><a name="line-536"></a><span>                     </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">replicate</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621683006336"><span class="hs-identifier hs-var">matches</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;_&quot;</span><span>
</span><a name="line-537"></a><span>          </span><a name="local-6989586621683006342"><a href="#local-6989586621683006342"><span class="hs-identifier">occDisp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPrefixOcc</span><span> </span><a href="#local-6989586621683006334"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-538"></a><span>          </span><a name="local-6989586621683006343"><a href="#local-6989586621683006343"><span class="hs-identifier">tyDisp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppWhen</span><span> </span><a href="#local-6989586621683006330"><span class="hs-identifier hs-var">sTy</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683006335"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-539"></a><span>          </span><a name="local-6989586621683006344"><a href="#local-6989586621683006344"><span class="hs-identifier">has</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">null</span><span>
</span><a name="line-540"></a><span>          </span><a name="local-6989586621683006345"><a href="#local-6989586621683006345"><span class="hs-identifier">wrapDisp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppWhen</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683006344"><span class="hs-identifier hs-var">has</span></a><span> </span><a href="#local-6989586621683006337"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683006328"><span class="hs-identifier hs-var">sWrp</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621683006329"><span class="hs-identifier hs-var">sWrpVars</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-541"></a><span>                      </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;with&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683006328"><span class="hs-identifier hs-var">sWrp</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621683006330"><span class="hs-identifier hs-var">sTy</span></a><span>
</span><a name="line-542"></a><span>                                        </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621683006342"><span class="hs-identifier hs-var">occDisp</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621683006338"><span class="hs-identifier hs-var">tyApp</span></a><span>
</span><a name="line-543"></a><span>                                        </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621683006339"><span class="hs-identifier hs-var">tyAppVars</span></a><span>
</span><a name="line-544"></a><span>          </span><a name="local-6989586621683006346"><a href="#local-6989586621683006346"><span class="hs-identifier">docs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">hfDoc</span><span> </span><a href="#local-6989586621683006333"><span class="hs-identifier hs-var">hf</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-545"></a><span>                   </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683006359"><a href="#local-6989586621683006359"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;{-^&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-546"></a><span>                             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">lines</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unpackHDS</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683006359"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-547"></a><span>                             </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;-}&quot;</span><span>
</span><a name="line-548"></a><span>                   </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-549"></a><span>          </span><a name="local-6989586621683006347"><a href="#local-6989586621683006347"><span class="hs-identifier">funcInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppWhen</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683006344"><span class="hs-identifier hs-var">has</span></a><span> </span><a href="#local-6989586621683006336"><span class="hs-identifier hs-var">matches</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621683006330"><span class="hs-identifier hs-var">sTy</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-550"></a><span>                       </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;where&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621683006342"><span class="hs-identifier hs-var">occDisp</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621683006343"><span class="hs-identifier hs-var">tyDisp</span></a><span>
</span><a name="line-551"></a><span>          </span><a name="local-6989586621683006348"><a href="#local-6989586621683006348"><span class="hs-identifier">subDisp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006342"><span class="hs-identifier hs-var">occDisp</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683006344"><span class="hs-identifier hs-var">has</span></a><span> </span><a href="#local-6989586621683006336"><span class="hs-identifier hs-var">matches</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621683006341"><span class="hs-identifier hs-var">holeDisp</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621683006343"><span class="hs-identifier hs-var">tyDisp</span></a><span>
</span><a name="line-552"></a><span>          </span><a name="local-6989586621683006349"><a href="#local-6989586621683006349"><span class="hs-identifier">display</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><a href="#local-6989586621683006348"><span class="hs-identifier hs-var">subDisp</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683006347"><span class="hs-identifier hs-var">funcInfo</span></a><span> </span><span class="hs-operator hs-var">$+$</span><span> </span><a href="#local-6989586621683006346"><span class="hs-identifier hs-var">docs</span></a><span> </span><span class="hs-operator hs-var">$+$</span><span> </span><a href="#local-6989586621683006345"><span class="hs-identifier hs-var">wrapDisp</span></a><span class="hs-special">)</span><span>
</span><a name="line-553"></a><span>          </span><a name="local-6989586621683006350"><a href="#local-6989586621683006350"><span class="hs-identifier">provenance</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppWhen</span><span> </span><a href="#local-6989586621683006331"><span class="hs-identifier hs-var">sProv</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-554"></a><span>                </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">hfCand</span><span> </span><a href="#local-6989586621683006333"><span class="hs-identifier hs-var">hf</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-555"></a><span>                    </span><a href="TcHoleErrors.html#GreHFCand"><span class="hs-identifier hs-var">GreHFCand</span></a><span> </span><a name="local-6989586621683006360"><a href="#local-6989586621683006360"><span class="hs-identifier">gre</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprNameProvenance</span><span> </span><a href="#local-6989586621683006360"><span class="hs-identifier hs-var">gre</span></a><span>
</span><a name="line-556"></a><span>                    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;bound at&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getSrcLoc</span><span> </span><a href="#local-6989586621683006334"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-557"></a><span>
</span><a name="line-558"></a><span class="hs-identifier">getLocalBindings</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TidyEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>
</span><a name="line-559"></a><a name="getLocalBindings"><a href="TcHoleErrors.html#getLocalBindings"><span class="hs-identifier">getLocalBindings</span></a></a><span> </span><a name="local-6989586621683006361"><a href="#local-6989586621683006361"><span class="hs-identifier">tidy_orig</span></a></a><span> </span><a name="local-6989586621683006362"><a href="#local-6989586621683006362"><span class="hs-identifier">ct</span></a></a><span>
</span><a name="line-560"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683006375"><a href="#local-6989586621683006375"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTidyOrigin"><span class="hs-identifier hs-var">zonkTidyOrigin</span></a><span> </span><a href="#local-6989586621683006361"><span class="hs-identifier hs-var">tidy_orig</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctLocOrigin</span><span> </span><a href="#local-6989586621683006363"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">)</span><span>
</span><a name="line-561"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621683006365"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683006375"><span class="hs-identifier hs-var">env1</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">removeBindingShadowing</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">tcl_bndrs</span><span> </span><a href="#local-6989586621683006364"><span class="hs-identifier hs-var">lcl_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-562"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-563"></a><span>    </span><a name="local-6989586621683006363"><a href="#local-6989586621683006363"><span class="hs-identifier">loc</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ctEvLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvidence</span><span> </span><a href="#local-6989586621683006362"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-564"></a><span>    </span><a name="local-6989586621683006364"><a href="#local-6989586621683006364"><span class="hs-identifier">lcl_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ctLocEnv</span><span> </span><a href="#local-6989586621683006363"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-565"></a><span>
</span><a name="line-566"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TidyEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcBinder</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>
</span><a name="line-567"></a><span>    </span><a name="local-6989586621683006365"><a href="#local-6989586621683006365"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683006366"><a href="#local-6989586621683006366"><span class="hs-identifier">sofar</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621683006366"><span class="hs-identifier hs-var">sofar</span></a><span class="hs-special">)</span><span>
</span><a name="line-568"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621683006367"><a href="#local-6989586621683006367"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621683006368"><a href="#local-6989586621683006368"><span class="hs-identifier">sofar</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683006369"><a href="#local-6989586621683006369"><span class="hs-identifier">tc_bndr</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683006370"><a href="#local-6989586621683006370"><span class="hs-identifier">tc_bndrs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-569"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683006369"><span class="hs-identifier hs-var">tc_bndr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-570"></a><span>          </span><span class="hs-identifier hs-var">TcIdBndr</span><span> </span><a name="local-6989586621683006374"><a href="#local-6989586621683006374"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683006372"><span class="hs-identifier hs-var">keep_it</span></a><span> </span><a href="#local-6989586621683006374"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-571"></a><span>          </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683006371"><span class="hs-identifier hs-var">discard_it</span></a><span>
</span><a name="line-572"></a><span>     </span><span class="hs-keyword">where</span><span>
</span><a name="line-573"></a><span>        </span><a name="local-6989586621683006371"><a href="#local-6989586621683006371"><span class="hs-identifier">discard_it</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006365"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683006367"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621683006368"><span class="hs-identifier hs-var">sofar</span></a><span> </span><a href="#local-6989586621683006370"><span class="hs-identifier hs-var">tc_bndrs</span></a><span>
</span><a name="line-574"></a><span>        </span><a name="local-6989586621683006372"><a href="#local-6989586621683006372"><span class="hs-identifier">keep_it</span></a></a><span> </span><a name="local-6989586621683006373"><a href="#local-6989586621683006373"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006365"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683006367"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683006373"><span class="hs-identifier hs-var">id</span></a><span class="hs-glyph">:</span><a href="#local-6989586621683006368"><span class="hs-identifier hs-var">sofar</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683006370"><span class="hs-identifier hs-var">tc_bndrs</span></a><span>
</span><a name="line-575"></a><span>
</span><a name="line-576"></a><span>
</span><a name="line-577"></a><span>
</span><a name="line-578"></a><span class="hs-comment">-- See Note [Valid hole fits include ...]</span><span>
</span><a name="line-579"></a><span class="hs-identifier">findValidHoleFits</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TidyEnv</span><span>        </span><span class="hs-comment">-- ^ The tidy_env for zonking</span><span>
</span><a name="line-580"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Implication</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- ^ Enclosing implications for givens</span><span>
</span><a name="line-581"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">]</span><span>
</span><a name="line-582"></a><span>                  </span><span class="hs-comment">-- ^ The  unsolved simple constraints in the implication for</span><span>
</span><a name="line-583"></a><span>                  </span><span class="hs-comment">-- the hole.</span><span>
</span><a name="line-584"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-comment">-- ^ The hole constraint itself</span><span>
</span><a name="line-585"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TidyEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">)</span><span>
</span><a name="line-586"></a><a name="findValidHoleFits"><a href="TcHoleErrors.html#findValidHoleFits"><span class="hs-identifier">findValidHoleFits</span></a></a><span> </span><a name="local-6989586621683006376"><a href="#local-6989586621683006376"><span class="hs-identifier">tidy_env</span></a></a><span> </span><a name="local-6989586621683006377"><a href="#local-6989586621683006377"><span class="hs-identifier">implics</span></a></a><span> </span><a name="local-6989586621683006378"><a href="#local-6989586621683006378"><span class="hs-identifier">simples</span></a></a><span> </span><a name="local-6989586621683006379"><a href="#local-6989586621683006379"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isExprHoleCt</span><span> </span><a href="#local-6989586621683006379"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-587"></a><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683006453"><a href="#local-6989586621683006453"><span class="hs-identifier">rdr_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGlobalRdrEnv"><span class="hs-identifier hs-var">getGlobalRdrEnv</span></a><span>
</span><a name="line-588"></a><span>     </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683006454"><a href="#local-6989586621683006454"><span class="hs-identifier">lclBinds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHoleErrors.html#getLocalBindings"><span class="hs-identifier hs-var">getLocalBindings</span></a><span> </span><a href="#local-6989586621683006376"><span class="hs-identifier hs-var">tidy_env</span></a><span> </span><a href="#local-6989586621683006379"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-589"></a><span>     </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683006455"><a href="#local-6989586621683006455"><span class="hs-identifier">maxVSubs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">maxValidHoleFits</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-590"></a><span>     </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683006456"><a href="#local-6989586621683006456"><span class="hs-identifier">hfdc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHoleErrors.html#getHoleFitDispConfig"><span class="hs-identifier hs-var">getHoleFitDispConfig</span></a><span>
</span><a name="line-591"></a><span>     </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683006457"><a href="#local-6989586621683006457"><span class="hs-identifier">sortingAlg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHoleErrors.html#getSortingAlg"><span class="hs-identifier hs-var">getSortingAlg</span></a><span>
</span><a name="line-592"></a><span>     </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683006458"><a href="#local-6989586621683006458"><span class="hs-identifier">findVLimit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683006457"><span class="hs-identifier hs-var">sortingAlg</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="TcHoleErrors.html#NoSorting"><span class="hs-identifier hs-var">NoSorting</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621683006455"><span class="hs-identifier hs-var">maxVSubs</span></a><span>
</span><a name="line-593"></a><span>     </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683006459"><a href="#local-6989586621683006459"><span class="hs-identifier">refLevel</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">refLevelHoleFits</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-594"></a><span>     </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;findingValidHoleFitsFor { &quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683006379"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-595"></a><span>     </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;hole_lvl is:&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683006382"><span class="hs-identifier hs-var">hole_lvl</span></a><span>
</span><a name="line-596"></a><span>     </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;implics are: &quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683006377"><span class="hs-identifier hs-var">implics</span></a><span>
</span><a name="line-597"></a><span>     </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;simples are: &quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683006378"><span class="hs-identifier hs-var">simples</span></a><span>
</span><a name="line-598"></a><span>     </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;locals are: &quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683006454"><span class="hs-identifier hs-var">lclBinds</span></a><span>
</span><a name="line-599"></a><span>     </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683006460"><a href="#local-6989586621683006460"><span class="hs-identifier">lcl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683006461"><a href="#local-6989586621683006461"><span class="hs-identifier">gbl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partition</span><span> </span><span class="hs-identifier">gre_lcl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">globalRdrEnvElts</span><span> </span><a href="#local-6989586621683006453"><span class="hs-identifier hs-var">rdr_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-600"></a><span>           </span><span class="hs-comment">-- We remove binding shadowings here, but only for the local level.</span><span>
</span><a name="line-601"></a><span>           </span><span class="hs-comment">-- this is so we e.g. suggest the global fmap from the Functor class</span><span>
</span><a name="line-602"></a><span>           </span><span class="hs-comment">-- even though there is a local definition as well, such as in the</span><span>
</span><a name="line-603"></a><span>           </span><span class="hs-comment">-- Free monad example.</span><span>
</span><a name="line-604"></a><span>           </span><a name="local-6989586621683006462"><a href="#local-6989586621683006462"><span class="hs-identifier">locals</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">removeBindingShadowing</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-605"></a><span>                      </span><span class="hs-identifier hs-var">map</span><span> </span><a href="TcHoleErrors.html#IdHFCand"><span class="hs-identifier hs-var">IdHFCand</span></a><span> </span><a href="#local-6989586621683006454"><span class="hs-identifier hs-var">lclBinds</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="TcHoleErrors.html#GreHFCand"><span class="hs-identifier hs-var">GreHFCand</span></a><span> </span><a href="#local-6989586621683006460"><span class="hs-identifier hs-var">lcl</span></a><span>
</span><a name="line-606"></a><span>           </span><a name="local-6989586621683006463"><a href="#local-6989586621683006463"><span class="hs-identifier">globals</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="TcHoleErrors.html#GreHFCand"><span class="hs-identifier hs-var">GreHFCand</span></a><span> </span><a href="#local-6989586621683006461"><span class="hs-identifier hs-var">gbl</span></a><span>
</span><a name="line-607"></a><span>           </span><a name="local-6989586621683006464"><a href="#local-6989586621683006464"><span class="hs-identifier">syntax</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="TcHoleErrors.html#NameHFCand"><span class="hs-identifier hs-var">NameHFCand</span></a><span> </span><a href="#local-6989586621683006383"><span class="hs-identifier hs-var">builtIns</span></a><span>
</span><a name="line-608"></a><span>           </span><a name="local-6989586621683006465"><a href="#local-6989586621683006465"><span class="hs-identifier">to_check</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006462"><span class="hs-identifier hs-var">locals</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683006464"><span class="hs-identifier hs-var">syntax</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683006463"><span class="hs-identifier hs-var">globals</span></a><span>
</span><a name="line-609"></a><span>     </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683006466"><a href="#local-6989586621683006466"><span class="hs-identifier">searchDiscards</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683006467"><a href="#local-6989586621683006467"><span class="hs-identifier">subs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-610"></a><span>        </span><a href="TcHoleErrors.html#tcFilterHoleFits"><span class="hs-identifier hs-var">tcFilterHoleFits</span></a><span> </span><a href="#local-6989586621683006458"><span class="hs-identifier hs-var">findVLimit</span></a><span> </span><a href="#local-6989586621683006377"><span class="hs-identifier hs-var">implics</span></a><span> </span><a href="#local-6989586621683006386"><span class="hs-identifier hs-var">relevantCts</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683006380"><span class="hs-identifier hs-var">hole_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683006465"><span class="hs-identifier hs-var">to_check</span></a><span>
</span><a name="line-611"></a><span>     </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683006468"><a href="#local-6989586621683006468"><span class="hs-identifier">tidy_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683006469"><a href="#local-6989586621683006469"><span class="hs-identifier">tidy_subs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683006387"><span class="hs-identifier hs-var">zonkSubs</span></a><span> </span><a href="#local-6989586621683006376"><span class="hs-identifier hs-var">tidy_env</span></a><span> </span><a href="#local-6989586621683006467"><span class="hs-identifier hs-var">subs</span></a><span>
</span><a name="line-612"></a><span>     </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683006470"><a href="#local-6989586621683006470"><span class="hs-identifier">tidy_sorted_subs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683006385"><span class="hs-identifier hs-var">sortFits</span></a><span> </span><a href="#local-6989586621683006457"><span class="hs-identifier hs-var">sortingAlg</span></a><span> </span><a href="#local-6989586621683006469"><span class="hs-identifier hs-var">tidy_subs</span></a><span>
</span><a name="line-613"></a><span>     </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683006471"><a href="#local-6989586621683006471"><span class="hs-identifier">pVDisc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683006472"><a href="#local-6989586621683006472"><span class="hs-identifier">limited_subs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006388"><span class="hs-identifier hs-var">possiblyDiscard</span></a><span> </span><a href="#local-6989586621683006455"><span class="hs-identifier hs-var">maxVSubs</span></a><span> </span><a href="#local-6989586621683006470"><span class="hs-identifier hs-var">tidy_sorted_subs</span></a><span>
</span><a name="line-614"></a><span>           </span><a name="local-6989586621683006473"><a href="#local-6989586621683006473"><span class="hs-identifier">vDiscards</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006471"><span class="hs-identifier hs-var">pVDisc</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621683006466"><span class="hs-identifier hs-var">searchDiscards</span></a><span>
</span><a name="line-615"></a><span>     </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683006474"><a href="#local-6989586621683006474"><span class="hs-identifier">subs_with_docs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHoleErrors.html#addDocs"><span class="hs-identifier hs-var">addDocs</span></a><span> </span><a href="#local-6989586621683006472"><span class="hs-identifier hs-var">limited_subs</span></a><span>
</span><a name="line-616"></a><span>     </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683006475"><a href="#local-6989586621683006475"><span class="hs-identifier">vMsg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppUnless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683006474"><span class="hs-identifier hs-var">subs_with_docs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-617"></a><span>                    </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Valid hole fits include&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-618"></a><span>                      </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="TcHoleErrors.html#pprHoleFit"><span class="hs-identifier hs-var">pprHoleFit</span></a><span> </span><a href="#local-6989586621683006456"><span class="hs-identifier hs-var">hfdc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683006474"><span class="hs-identifier hs-var">subs_with_docs</span></a><span class="hs-special">)</span><span>
</span><a name="line-619"></a><span>                        </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppWhen</span><span> </span><a href="#local-6989586621683006473"><span class="hs-identifier hs-var">vDiscards</span></a><span> </span><a href="TcHoleErrors.html#subsDiscardMsg"><span class="hs-identifier hs-var">subsDiscardMsg</span></a><span>
</span><a name="line-620"></a><span>     </span><span class="hs-comment">-- Refinement hole fits. See Note [Valid refinement hole fits include ...]</span><span>
</span><a name="line-621"></a><span>     </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683006493"><a href="#local-6989586621683006493"><span class="hs-identifier">tidy_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683006494"><a href="#local-6989586621683006494"><span class="hs-identifier">refMsg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683006459"><span class="hs-identifier hs-var">refLevel</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-622"></a><span>         </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683006476"><a href="#local-6989586621683006476"><span class="hs-identifier">maxRSubs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">maxRefHoleFits</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-623"></a><span>            </span><span class="hs-comment">-- We can use from just, since we know that Nothing &gt;= _ is False.</span><span>
</span><a name="line-624"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683006477"><a href="#local-6989586621683006477"><span class="hs-identifier">refLvls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-glyph">..</span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromJust</span><span> </span><a href="#local-6989586621683006459"><span class="hs-identifier hs-var">refLevel</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-625"></a><span>            </span><span class="hs-comment">-- We make a new refinement type for each level of refinement, where</span><span>
</span><a name="line-626"></a><span>            </span><span class="hs-comment">-- the level of refinement indicates number of additional arguments</span><span>
</span><a name="line-627"></a><span>            </span><span class="hs-comment">-- to allow.</span><span>
</span><a name="line-628"></a><span>            </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683006478"><a href="#local-6989586621683006478"><span class="hs-identifier">ref_tys</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621683006384"><span class="hs-identifier hs-var">mkRefTy</span></a><span> </span><a href="#local-6989586621683006477"><span class="hs-identifier hs-var">refLvls</span></a><span>
</span><a name="line-629"></a><span>            </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;ref_tys are&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683006478"><span class="hs-identifier hs-var">ref_tys</span></a><span>
</span><a name="line-630"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683006479"><a href="#local-6989586621683006479"><span class="hs-identifier">findRLimit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683006457"><span class="hs-identifier hs-var">sortingAlg</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="TcHoleErrors.html#NoSorting"><span class="hs-identifier hs-var">NoSorting</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-631"></a><span>                                                         </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621683006476"><span class="hs-identifier hs-var">maxRSubs</span></a><span>
</span><a name="line-632"></a><span>            </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683006480"><a href="#local-6989586621683006480"><span class="hs-identifier">refDs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-special">(</span><a href="TcHoleErrors.html#tcFilterHoleFits"><span class="hs-identifier hs-var">tcFilterHoleFits</span></a><span> </span><a href="#local-6989586621683006479"><span class="hs-identifier hs-var">findRLimit</span></a><span> </span><a href="#local-6989586621683006377"><span class="hs-identifier hs-var">implics</span></a><span>
</span><a name="line-633"></a><span>                                     </span><a href="#local-6989586621683006386"><span class="hs-identifier hs-var">relevantCts</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683006465"><span class="hs-identifier hs-var">to_check</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683006478"><span class="hs-identifier hs-var">ref_tys</span></a><span>
</span><a name="line-634"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683006481"><a href="#local-6989586621683006481"><span class="hs-identifier">tidy_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683006482"><a href="#local-6989586621683006482"><span class="hs-identifier">tidy_rsubs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683006387"><span class="hs-identifier hs-var">zonkSubs</span></a><span> </span><a href="#local-6989586621683006468"><span class="hs-identifier hs-var">tidy_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621683006480"><span class="hs-identifier hs-var">refDs</span></a><span>
</span><a name="line-635"></a><span>            </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683006483"><a href="#local-6989586621683006483"><span class="hs-identifier">tidy_sorted_rsubs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683006385"><span class="hs-identifier hs-var">sortFits</span></a><span> </span><a href="#local-6989586621683006457"><span class="hs-identifier hs-var">sortingAlg</span></a><span> </span><a href="#local-6989586621683006482"><span class="hs-identifier hs-var">tidy_rsubs</span></a><span>
</span><a name="line-636"></a><span>            </span><span class="hs-comment">-- For refinement substitutions we want matches</span><span>
</span><a name="line-637"></a><span>            </span><span class="hs-comment">-- like id (_ :: t), head (_ :: [t]), asTypeOf (_ :: t),</span><span>
</span><a name="line-638"></a><span>            </span><span class="hs-comment">-- and others in that vein to appear last, since these are</span><span>
</span><a name="line-639"></a><span>            </span><span class="hs-comment">-- unlikely to be the most relevant fits.</span><span>
</span><a name="line-640"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683006484"><a href="#local-6989586621683006484"><span class="hs-identifier">tidy_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683006485"><a href="#local-6989586621683006485"><span class="hs-identifier">tidy_hole_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTidyTcType"><span class="hs-identifier hs-var">zonkTidyTcType</span></a><span> </span><a href="#local-6989586621683006481"><span class="hs-identifier hs-var">tidy_env</span></a><span> </span><a href="#local-6989586621683006380"><span class="hs-identifier hs-var">hole_ty</span></a><span>
</span><a name="line-641"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683006486"><a href="#local-6989586621683006486"><span class="hs-identifier">hasExactApp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tcEqType</span><span> </span><a href="#local-6989586621683006485"><span class="hs-identifier hs-var">tidy_hole_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">hfWrap</span><span>
</span><a name="line-642"></a><span>                  </span><span class="hs-special">(</span><a name="local-6989586621683006487"><a href="#local-6989586621683006487"><span class="hs-identifier">exact</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683006488"><a href="#local-6989586621683006488"><span class="hs-identifier">not_exact</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partition</span><span> </span><a href="#local-6989586621683006486"><span class="hs-identifier hs-var">hasExactApp</span></a><span> </span><a href="#local-6989586621683006483"><span class="hs-identifier hs-var">tidy_sorted_rsubs</span></a><span>
</span><a name="line-643"></a><span>                  </span><span class="hs-special">(</span><a name="local-6989586621683006489"><a href="#local-6989586621683006489"><span class="hs-identifier">pRDisc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683006490"><a href="#local-6989586621683006490"><span class="hs-identifier">exact_last_rfits</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-644"></a><span>                    </span><a href="#local-6989586621683006388"><span class="hs-identifier hs-var">possiblyDiscard</span></a><span> </span><a href="#local-6989586621683006476"><span class="hs-identifier hs-var">maxRSubs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683006488"><span class="hs-identifier hs-var">not_exact</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683006487"><span class="hs-identifier hs-var">exact</span></a><span>
</span><a name="line-645"></a><span>                  </span><a name="local-6989586621683006491"><a href="#local-6989586621683006491"><span class="hs-identifier">rDiscards</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006489"><span class="hs-identifier hs-var">pRDisc</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621683006480"><span class="hs-identifier hs-var">refDs</span></a><span>
</span><a name="line-646"></a><span>            </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683006492"><a href="#local-6989586621683006492"><span class="hs-identifier">rsubs_with_docs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHoleErrors.html#addDocs"><span class="hs-identifier hs-var">addDocs</span></a><span> </span><a href="#local-6989586621683006490"><span class="hs-identifier hs-var">exact_last_rfits</span></a><span>
</span><a name="line-647"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683006484"><span class="hs-identifier hs-var">tidy_env</span></a><span class="hs-special">,</span><span>
</span><a name="line-648"></a><span>                </span><span class="hs-identifier hs-var">ppUnless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683006492"><span class="hs-identifier hs-var">rsubs_with_docs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-649"></a><span>                  </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Valid refinement hole fits include&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-650"></a><span>                  </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="TcHoleErrors.html#pprHoleFit"><span class="hs-identifier hs-var">pprHoleFit</span></a><span> </span><a href="#local-6989586621683006456"><span class="hs-identifier hs-var">hfdc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683006492"><span class="hs-identifier hs-var">rsubs_with_docs</span></a><span class="hs-special">)</span><span>
</span><a name="line-651"></a><span>                    </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppWhen</span><span> </span><a href="#local-6989586621683006491"><span class="hs-identifier hs-var">rDiscards</span></a><span> </span><a href="TcHoleErrors.html#refSubsDiscardMsg"><span class="hs-identifier hs-var">refSubsDiscardMsg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-652"></a><span>       </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683006468"><span class="hs-identifier hs-var">tidy_env</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">empty</span><span class="hs-special">)</span><span>
</span><a name="line-653"></a><span>     </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;findingValidHoleFitsFor }&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-654"></a><span>     </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683006493"><span class="hs-identifier hs-var">tidy_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683006475"><span class="hs-identifier hs-var">vMsg</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><a href="#local-6989586621683006494"><span class="hs-identifier hs-var">refMsg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-655"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-656"></a><span>    </span><span class="hs-comment">-- We extract the type, the tcLevel and the types free variables</span><span>
</span><a name="line-657"></a><span>    </span><span class="hs-comment">-- from from the constraint.</span><span>
</span><a name="line-658"></a><span>    </span><span class="hs-identifier">hole_ty</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcPredType</span><span>
</span><a name="line-659"></a><span>    </span><a name="local-6989586621683006380"><a href="#local-6989586621683006380"><span class="hs-identifier">hole_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ctPred</span><span> </span><a href="#local-6989586621683006379"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-660"></a><span>    </span><span class="hs-identifier">hole_fvs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FV</span><span>
</span><a name="line-661"></a><span>    </span><a name="local-6989586621683006381"><a href="#local-6989586621683006381"><span class="hs-identifier">hole_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyCoFVsOfType</span><span> </span><a href="#local-6989586621683006380"><span class="hs-identifier hs-var">hole_ty</span></a><span>
</span><a name="line-662"></a><span>    </span><a name="local-6989586621683006382"><a href="#local-6989586621683006382"><span class="hs-identifier">hole_lvl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ctLocLevel</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ctEvLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ctEvidence</span><span> </span><a href="#local-6989586621683006379"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-663"></a><span>
</span><a name="line-664"></a><span>    </span><span class="hs-comment">-- BuiltInSyntax names like (:) and []</span><span>
</span><a name="line-665"></a><span>    </span><span class="hs-identifier">builtIns</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-666"></a><span>    </span><a name="local-6989586621683006383"><a href="#local-6989586621683006383"><span class="hs-identifier">builtIns</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-identifier hs-var">isBuiltInSyntax</span><span> </span><a href="PrelInfo.html#knownKeyNames"><span class="hs-identifier hs-var">knownKeyNames</span></a><span>
</span><a name="line-667"></a><span>
</span><a name="line-668"></a><span>    </span><span class="hs-comment">-- We make a refinement type by adding a new type variable in front</span><span>
</span><a name="line-669"></a><span>    </span><span class="hs-comment">-- of the type of t h hole, going from e.g. [Integer] -&gt; Integer</span><span>
</span><a name="line-670"></a><span>    </span><span class="hs-comment">-- to t_a1/m[tau:1] -&gt; [Integer] -&gt; Integer. This allows the simplifier</span><span>
</span><a name="line-671"></a><span>    </span><span class="hs-comment">-- to unify the new type variable with any type, allowing us</span><span>
</span><a name="line-672"></a><span>    </span><span class="hs-comment">-- to suggest a &quot;refinement hole fit&quot;, like `(foldl1 _)` instead</span><span>
</span><a name="line-673"></a><span>    </span><span class="hs-comment">-- of only concrete hole fits like `sum`.</span><span>
</span><a name="line-674"></a><span>    </span><span class="hs-identifier">mkRefTy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-675"></a><span>    </span><a name="local-6989586621683006384"><a href="#local-6989586621683006384"><span class="hs-identifier">mkRefTy</span></a></a><span> </span><a name="local-6989586621683006391"><a href="#local-6989586621683006391"><span class="hs-identifier">refLvl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683006394"><span class="hs-identifier hs-var">wrapWithVars</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">id</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621683006392"><span class="hs-identifier hs-var">newTyVars</span></a><span>
</span><a name="line-676"></a><span>      </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621683006392"><a href="#local-6989586621683006392"><span class="hs-identifier">newTyVars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">replicateM</span><span> </span><a href="#local-6989586621683006391"><span class="hs-identifier hs-var">refLvl</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683006393"><span class="hs-identifier hs-var">setLvl</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span>
</span><a name="line-677"></a><span>                            </span><span class="hs-special">(</span><a href="TcMType.html#newOpenTypeKind"><span class="hs-identifier hs-var">newOpenTypeKind</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="TcMType.html#newFlexiTyVar"><span class="hs-identifier hs-var">newFlexiTyVar</span></a><span class="hs-special">)</span><span>
</span><a name="line-678"></a><span>            </span><a name="local-6989586621683006393"><a href="#local-6989586621683006393"><span class="hs-identifier">setLvl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier hs-var">setMetaTyVarTcLevel</span><span> </span><a href="#local-6989586621683006382"><span class="hs-identifier hs-var">hole_lvl</span></a><span>
</span><a name="line-679"></a><span>            </span><a name="local-6989586621683006394"><a href="#local-6989586621683006394"><span class="hs-identifier">wrapWithVars</span></a></a><span> </span><a name="local-6989586621683006395"><a href="#local-6989586621683006395"><span class="hs-identifier">vars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkFunTys</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621683006395"><span class="hs-identifier hs-var">vars</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683006380"><span class="hs-identifier hs-var">hole_ty</span></a><span>
</span><a name="line-680"></a><span>
</span><a name="line-681"></a><span>    </span><span class="hs-identifier">sortFits</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcHoleErrors.html#SortingAlg"><span class="hs-identifier hs-type">SortingAlg</span></a><span>    </span><span class="hs-comment">-- How we should sort the hole fits</span><span>
</span><a name="line-682"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-type">HoleFit</span></a><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- The subs to sort</span><span>
</span><a name="line-683"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-type">HoleFit</span></a><span class="hs-special">]</span><span>
</span><a name="line-684"></a><span>    </span><a name="local-6989586621683006385"><a href="#local-6989586621683006385"><span class="hs-identifier">sortFits</span></a></a><span> </span><a href="TcHoleErrors.html#NoSorting"><span class="hs-identifier hs-var">NoSorting</span></a><span> </span><a name="local-6989586621683006396"><a href="#local-6989586621683006396"><span class="hs-identifier">subs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683006396"><span class="hs-identifier hs-var">subs</span></a><span>
</span><a name="line-685"></a><span>    </span><span class="hs-identifier">sortFits</span><span> </span><a href="TcHoleErrors.html#BySize"><span class="hs-identifier hs-var">BySize</span></a><span> </span><a name="local-6989586621683006397"><a href="#local-6989586621683006397"><span class="hs-identifier">subs</span></a></a><span>
</span><a name="line-686"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621683006389"><span class="hs-identifier hs-var">sortBySize</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sort</span><span> </span><a href="#local-6989586621683006398"><span class="hs-identifier hs-var">lclFits</span></a><span class="hs-special">)</span><span>
</span><a name="line-687"></a><span>               </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="#local-6989586621683006389"><span class="hs-identifier hs-var">sortBySize</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sort</span><span> </span><a href="#local-6989586621683006399"><span class="hs-identifier hs-var">gblFits</span></a><span class="hs-special">)</span><span>
</span><a name="line-688"></a><span>        </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683006398"><a href="#local-6989586621683006398"><span class="hs-identifier">lclFits</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683006399"><a href="#local-6989586621683006399"><span class="hs-identifier">gblFits</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">span</span><span> </span><a href="TcHoleErrors.html#hfIsLcl"><span class="hs-identifier hs-var">hfIsLcl</span></a><span> </span><a href="#local-6989586621683006397"><span class="hs-identifier hs-var">subs</span></a><span>
</span><a name="line-689"></a><span>
</span><a name="line-690"></a><span>    </span><span class="hs-comment">-- To sort by subsumption, we invoke the sortByGraph function, which</span><span>
</span><a name="line-691"></a><span>    </span><span class="hs-comment">-- builds the subsumption graph for the fits and then sorts them using a</span><span>
</span><a name="line-692"></a><span>    </span><span class="hs-comment">-- graph sort.  Since we want locals to come first anyway, we can sort</span><span>
</span><a name="line-693"></a><span>    </span><span class="hs-comment">-- them separately. The substitutions are already checked in local then</span><span>
</span><a name="line-694"></a><span>    </span><span class="hs-comment">-- global order, so we can get away with using span here.</span><span>
</span><a name="line-695"></a><span>    </span><span class="hs-comment">-- We use (&lt;*&gt;) to expose the parallelism, in case it becomes useful later.</span><span>
</span><a name="line-696"></a><span>    </span><span class="hs-identifier">sortFits</span><span> </span><a href="TcHoleErrors.html#BySubsumption"><span class="hs-identifier hs-var">BySubsumption</span></a><span> </span><a name="local-6989586621683006400"><a href="#local-6989586621683006400"><span class="hs-identifier">subs</span></a></a><span>
</span><a name="line-697"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621683006390"><span class="hs-identifier hs-var">sortByGraph</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sort</span><span> </span><a href="#local-6989586621683006401"><span class="hs-identifier hs-var">lclFits</span></a><span class="hs-special">)</span><span>
</span><a name="line-698"></a><span>               </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="#local-6989586621683006390"><span class="hs-identifier hs-var">sortByGraph</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sort</span><span> </span><a href="#local-6989586621683006402"><span class="hs-identifier hs-var">gblFits</span></a><span class="hs-special">)</span><span>
</span><a name="line-699"></a><span>        </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683006401"><a href="#local-6989586621683006401"><span class="hs-identifier">lclFits</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683006402"><a href="#local-6989586621683006402"><span class="hs-identifier">gblFits</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">span</span><span> </span><a href="TcHoleErrors.html#hfIsLcl"><span class="hs-identifier hs-var">hfIsLcl</span></a><span> </span><a href="#local-6989586621683006400"><span class="hs-identifier hs-var">subs</span></a><span>
</span><a name="line-700"></a><span>
</span><a name="line-701"></a><span>    </span><span class="hs-comment">-- See Note [Relevant Constraints]</span><span>
</span><a name="line-702"></a><span>    </span><span class="hs-identifier">relevantCts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">]</span><span>
</span><a name="line-703"></a><span>    </span><a name="local-6989586621683006386"><a href="#local-6989586621683006386"><span class="hs-identifier">relevantCts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isEmptyVarSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fvVarSet</span><span> </span><a href="#local-6989586621683006381"><span class="hs-identifier hs-var">hole_fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-704"></a><span>                  </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621683006406"><span class="hs-identifier hs-var">isRelevant</span></a><span> </span><a href="#local-6989586621683006378"><span class="hs-identifier hs-var">simples</span></a><span>
</span><a name="line-705"></a><span>      </span><span class="hs-keyword">where</span><span> </span><span class="hs-identifier">ctFreeVarSet</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">VarSet</span><span>
</span><a name="line-706"></a><span>            </span><a name="local-6989586621683006403"><a href="#local-6989586621683006403"><span class="hs-identifier">ctFreeVarSet</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fvVarSet</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">tyCoFVsOfType</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">ctPred</span><span>
</span><a name="line-707"></a><span>            </span><a name="local-6989586621683006404"><a href="#local-6989586621683006404"><span class="hs-identifier">hole_fv_set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fvVarSet</span><span> </span><a href="#local-6989586621683006381"><span class="hs-identifier hs-var">hole_fvs</span></a><span>
</span><a name="line-708"></a><span>            </span><span class="hs-identifier">anyFVMentioned</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-709"></a><span>            </span><a name="local-6989586621683006405"><a href="#local-6989586621683006405"><span class="hs-identifier">anyFVMentioned</span></a></a><span> </span><a name="local-6989586621683006407"><a href="#local-6989586621683006407"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">isEmptyVarSet</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-710"></a><span>                                  </span><a href="#local-6989586621683006403"><span class="hs-identifier hs-var">ctFreeVarSet</span></a><span> </span><a href="#local-6989586621683006407"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">intersectVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683006404"><span class="hs-identifier hs-var">hole_fv_set</span></a><span>
</span><a name="line-711"></a><span>            </span><span class="hs-comment">-- We filter out those constraints that have no variables (since</span><span>
</span><a name="line-712"></a><span>            </span><span class="hs-comment">-- they won't be solved by finding a type for the type variable</span><span>
</span><a name="line-713"></a><span>            </span><span class="hs-comment">-- representing the hole) and also other holes, since we're not</span><span>
</span><a name="line-714"></a><span>            </span><span class="hs-comment">-- trying to find hole fits for many holes at once.</span><span>
</span><a name="line-715"></a><span>            </span><a name="local-6989586621683006406"><a href="#local-6989586621683006406"><span class="hs-identifier">isRelevant</span></a></a><span> </span><a name="local-6989586621683006408"><a href="#local-6989586621683006408"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isEmptyVarSet</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683006403"><span class="hs-identifier hs-var">ctFreeVarSet</span></a><span> </span><a href="#local-6989586621683006408"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-716"></a><span>                            </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621683006405"><span class="hs-identifier hs-var">anyFVMentioned</span></a><span> </span><a href="#local-6989586621683006408"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-717"></a><span>                            </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isHoleCt</span><span> </span><a href="#local-6989586621683006408"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-718"></a><span>
</span><a name="line-719"></a><span>    </span><span class="hs-comment">-- We zonk the hole fits so that the output aligns with the rest</span><span>
</span><a name="line-720"></a><span>    </span><span class="hs-comment">-- of the typed hole error message output.</span><span>
</span><a name="line-721"></a><span>    </span><span class="hs-identifier">zonkSubs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TidyEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-type">HoleFit</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TidyEnv</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-type">HoleFit</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-722"></a><span>    </span><a name="local-6989586621683006387"><a href="#local-6989586621683006387"><span class="hs-identifier">zonkSubs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006409"><span class="hs-identifier hs-var">zonkSubs'</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-723"></a><span>      </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621683006409"><a href="#local-6989586621683006409"><span class="hs-identifier">zonkSubs'</span></a></a><span> </span><a name="local-6989586621683006411"><a href="#local-6989586621683006411"><span class="hs-identifier">zs</span></a></a><span> </span><a name="local-6989586621683006412"><a href="#local-6989586621683006412"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683006412"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621683006411"><span class="hs-identifier hs-var">zs</span></a><span class="hs-special">)</span><span>
</span><a name="line-724"></a><span>            </span><span class="hs-identifier">zonkSubs'</span><span> </span><a name="local-6989586621683006413"><a href="#local-6989586621683006413"><span class="hs-identifier">zs</span></a></a><span> </span><a name="local-6989586621683006414"><a href="#local-6989586621683006414"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683006415"><a href="#local-6989586621683006415"><span class="hs-identifier">hf</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621683006416"><a href="#local-6989586621683006416"><span class="hs-identifier">hfs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683006417"><a href="#local-6989586621683006417"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683006418"><a href="#local-6989586621683006418"><span class="hs-identifier">z</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683006410"><span class="hs-identifier hs-var">zonkSub</span></a><span> </span><a href="#local-6989586621683006414"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621683006415"><span class="hs-identifier hs-var">hf</span></a><span>
</span><a name="line-725"></a><span>                                           </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621683006409"><span class="hs-identifier hs-var">zonkSubs'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683006418"><span class="hs-identifier hs-var">z</span></a><span class="hs-glyph">:</span><a href="#local-6989586621683006413"><span class="hs-identifier hs-var">zs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683006417"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621683006416"><span class="hs-identifier hs-var">hfs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-726"></a><span>            </span><a name="local-6989586621683006410"><a href="#local-6989586621683006410"><span class="hs-identifier">zonkSub</span></a></a><span> </span><a name="local-6989586621683006419"><a href="#local-6989586621683006419"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621683006420"><a href="#local-6989586621683006420"><span class="hs-identifier">hf</span></a></a><span class="hs-glyph">@</span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-var">HoleFit</span></a><span class="hs-special">{</span><span class="hs-identifier">hfType</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683006421"><a href="#local-6989586621683006421"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">hfMatches</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683006422"><a href="#local-6989586621683006422"><span class="hs-identifier">m</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">hfWrap</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683006423"><a href="#local-6989586621683006423"><span class="hs-identifier">wrp</span></a></a><span class="hs-special">}</span><span>
</span><a name="line-727"></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683006424"><a href="#local-6989586621683006424"><span class="hs-identifier">env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683006425"><a href="#local-6989586621683006425"><span class="hs-identifier">ty'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTidyTcType"><span class="hs-identifier hs-var">zonkTidyTcType</span></a><span> </span><a href="#local-6989586621683006419"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621683006421"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-728"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683006426"><a href="#local-6989586621683006426"><span class="hs-identifier">env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683006427"><a href="#local-6989586621683006427"><span class="hs-identifier">m'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTidyTcTypes"><span class="hs-identifier hs-var">zonkTidyTcTypes</span></a><span> </span><a href="#local-6989586621683006424"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621683006422"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-729"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683006428"><a href="#local-6989586621683006428"><span class="hs-identifier">env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683006429"><a href="#local-6989586621683006429"><span class="hs-identifier">wrp'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTidyTcTypes"><span class="hs-identifier hs-var">zonkTidyTcTypes</span></a><span> </span><a href="#local-6989586621683006426"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621683006423"><span class="hs-identifier hs-var">wrp</span></a><span>
</span><a name="line-730"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683006430"><a href="#local-6989586621683006430"><span class="hs-identifier">zFit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006420"><span class="hs-identifier hs-var">hf</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">hfType</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006425"><span class="hs-identifier hs-var">ty'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">hfMatches</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006427"><span class="hs-identifier hs-var">m'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">hfWrap</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006429"><span class="hs-identifier hs-var">wrp'</span></a><span class="hs-special">}</span><span>
</span><a name="line-731"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683006428"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683006430"><span class="hs-identifier hs-var">zFit</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-732"></a><span>
</span><a name="line-733"></a><span>    </span><span class="hs-comment">-- Based on the flags, we might possibly discard some or all the</span><span>
</span><a name="line-734"></a><span>    </span><span class="hs-comment">-- fits we've found.</span><span>
</span><a name="line-735"></a><span>    </span><span class="hs-identifier">possiblyDiscard</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-type">HoleFit</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-type">HoleFit</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-736"></a><span>    </span><a name="local-6989586621683006388"><a href="#local-6989586621683006388"><span class="hs-identifier">possiblyDiscard</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683006431"><a href="#local-6989586621683006431"><span class="hs-identifier">max</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683006432"><a href="#local-6989586621683006432"><span class="hs-identifier">fits</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683006432"><span class="hs-identifier hs-var">fits</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">lengthExceeds</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683006431"><span class="hs-identifier hs-var">max</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">take</span><span> </span><a href="#local-6989586621683006431"><span class="hs-identifier hs-var">max</span></a><span> </span><a href="#local-6989586621683006432"><span class="hs-identifier hs-var">fits</span></a><span class="hs-special">)</span><span>
</span><a name="line-737"></a><span>    </span><span class="hs-identifier">possiblyDiscard</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a name="local-6989586621683006433"><a href="#local-6989586621683006433"><span class="hs-identifier">fits</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683006433"><span class="hs-identifier hs-var">fits</span></a><span class="hs-special">)</span><span>
</span><a name="line-738"></a><span>
</span><a name="line-739"></a><span>    </span><span class="hs-comment">-- Sort by size uses as a measure for relevance the sizes of the</span><span>
</span><a name="line-740"></a><span>    </span><span class="hs-comment">-- different types needed to instantiate the fit to the type of the hole.</span><span>
</span><a name="line-741"></a><span>    </span><span class="hs-comment">-- This is much quicker than sorting by subsumption, and gives reasonable</span><span>
</span><a name="line-742"></a><span>    </span><span class="hs-comment">-- results in most cases.</span><span>
</span><a name="line-743"></a><span>    </span><span class="hs-identifier">sortBySize</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-type">HoleFit</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-type">HoleFit</span></a><span class="hs-special">]</span><span>
</span><a name="line-744"></a><span>    </span><a name="local-6989586621683006389"><a href="#local-6989586621683006389"><span class="hs-identifier">sortBySize</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">sortOn</span><span> </span><a href="#local-6989586621683006434"><span class="hs-identifier hs-var">sizeOfFit</span></a><span>
</span><a name="line-745"></a><span>      </span><span class="hs-keyword">where</span><span> </span><span class="hs-identifier">sizeOfFit</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-type">HoleFit</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TypeSize</span><span>
</span><a name="line-746"></a><span>            </span><a name="local-6989586621683006434"><a href="#local-6989586621683006434"><span class="hs-identifier">sizeOfFit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sizeTypes</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">nubBy</span><span> </span><span class="hs-identifier hs-var">tcEqType</span><span> </span><span class="hs-operator hs-var">.</span><span>  </span><span class="hs-identifier">hfWrap</span><span>
</span><a name="line-747"></a><span>
</span><a name="line-748"></a><span>    </span><span class="hs-comment">-- Based on a suggestion by phadej on #ghc, we can sort the found fits</span><span>
</span><a name="line-749"></a><span>    </span><span class="hs-comment">-- by constructing a subsumption graph, and then do a topological sort of</span><span>
</span><a name="line-750"></a><span>    </span><span class="hs-comment">-- the graph. This makes the most specific types appear first, which are</span><span>
</span><a name="line-751"></a><span>    </span><span class="hs-comment">-- probably those most relevant. This takes a lot of work (but results in</span><span>
</span><a name="line-752"></a><span>    </span><span class="hs-comment">-- much more useful output), and can be disabled by</span><span>
</span><a name="line-753"></a><span>    </span><span class="hs-comment">-- '-fno-sort-valid-hole-fits'.</span><span>
</span><a name="line-754"></a><span>    </span><span class="hs-identifier">sortByGraph</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-type">HoleFit</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-type">HoleFit</span></a><span class="hs-special">]</span><span>
</span><a name="line-755"></a><span>    </span><a name="local-6989586621683006390"><a href="#local-6989586621683006390"><span class="hs-identifier">sortByGraph</span></a></a><span> </span><a name="local-6989586621683006435"><a href="#local-6989586621683006435"><span class="hs-identifier">fits</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006437"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621683006435"><span class="hs-identifier hs-var">fits</span></a><span>
</span><a name="line-756"></a><span>      </span><span class="hs-keyword">where</span><span> </span><span class="hs-identifier">tcSubsumesWCloning</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-757"></a><span>            </span><a name="local-6989586621683006436"><a href="#local-6989586621683006436"><span class="hs-identifier">tcSubsumesWCloning</span></a></a><span> </span><a name="local-6989586621683006438"><a href="#local-6989586621683006438"><span class="hs-identifier">ht</span></a></a><span> </span><a name="local-6989586621683006439"><a href="#local-6989586621683006439"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHoleErrors.html#withoutUnification"><span class="hs-identifier hs-var">withoutUnification</span></a><span> </span><a href="#local-6989586621683006440"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">(</span><a href="TcHoleErrors.html#tcSubsumes"><span class="hs-identifier hs-var">tcSubsumes</span></a><span> </span><a href="#local-6989586621683006438"><span class="hs-identifier hs-var">ht</span></a><span> </span><a href="#local-6989586621683006439"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-758"></a><span>              </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621683006440"><a href="#local-6989586621683006440"><span class="hs-identifier">fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyCoFVsOfTypes</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683006438"><span class="hs-identifier hs-var">ht</span></a><span class="hs-special">,</span><a href="#local-6989586621683006439"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-759"></a><span>            </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-type">HoleFit</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-type">HoleFit</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-type">HoleFit</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-type">HoleFit</span></a><span class="hs-special">]</span><span>
</span><a name="line-760"></a><span>            </span><a name="local-6989586621683006437"><a href="#local-6989586621683006437"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621683006441"><a href="#local-6989586621683006441"><span class="hs-identifier">sofar</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;subsumptionGraph was&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683006441"><span class="hs-identifier hs-var">sofar</span></a><span>
</span><a name="line-761"></a><span>                             </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">uncurry</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span>
</span><a name="line-762"></a><span>                                         </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">partition</span><span> </span><a href="TcHoleErrors.html#hfIsLcl"><span class="hs-identifier hs-var">hfIsLcl</span></a><span> </span><a href="#local-6989586621683006445"><span class="hs-identifier hs-var">topSorted</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-763"></a><span>              </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621683006442"><a href="#local-6989586621683006442"><span class="hs-identifier">toV</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683006446"><a href="#local-6989586621683006446"><span class="hs-identifier">hf</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683006447"><a href="#local-6989586621683006447"><span class="hs-identifier">adjs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683006446"><span class="hs-identifier hs-var">hf</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">hfId</span><span> </span><a href="#local-6989586621683006446"><span class="hs-identifier hs-var">hf</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">hfId</span><span> </span><a href="#local-6989586621683006447"><span class="hs-identifier hs-var">adjs</span></a><span class="hs-special">)</span><span>
</span><a name="line-764"></a><span>                    </span><span class="hs-special">(</span><a name="local-6989586621683006443"><a href="#local-6989586621683006443"><span class="hs-identifier">graph</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683006444"><a href="#local-6989586621683006444"><span class="hs-identifier">fromV</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">graphFromEdges</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621683006442"><span class="hs-identifier hs-var">toV</span></a><span> </span><a href="#local-6989586621683006441"><span class="hs-identifier hs-var">sofar</span></a><span>
</span><a name="line-765"></a><span>                    </span><a name="local-6989586621683006445"><a href="#local-6989586621683006445"><span class="hs-identifier">topSorted</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621683006448"><a href="#local-6989586621683006448"><span class="hs-identifier">h</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683006448"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621683006444"><span class="hs-identifier hs-var">fromV</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">topSort</span><span> </span><a href="#local-6989586621683006443"><span class="hs-identifier hs-var">graph</span></a><span>
</span><a name="line-766"></a><span>            </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621683006449"><a href="#local-6989586621683006449"><span class="hs-identifier">sofar</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683006450"><a href="#local-6989586621683006450"><span class="hs-identifier">hf</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621683006451"><a href="#local-6989586621683006451"><span class="hs-identifier">hfs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-767"></a><span>              </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683006452"><a href="#local-6989586621683006452"><span class="hs-identifier">adjs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-768"></a><span>                     </span><span class="hs-identifier hs-var">filterM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683006436"><span class="hs-identifier hs-var">tcSubsumesWCloning</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">hfType</span><span> </span><a href="#local-6989586621683006450"><span class="hs-identifier hs-var">hf</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">hfType</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683006435"><span class="hs-identifier hs-var">fits</span></a><span>
</span><a name="line-769"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621683006437"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621683006450"><span class="hs-identifier hs-var">hf</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683006452"><span class="hs-identifier hs-var">adjs</span></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a href="#local-6989586621683006449"><span class="hs-identifier hs-var">sofar</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683006451"><span class="hs-identifier hs-var">hfs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-770"></a><span>
</span><a name="line-771"></a><span class="hs-comment">-- We don't (as of yet) handle holes in types, only in expressions.</span><span>
</span><a name="line-772"></a><span class="hs-identifier">findValidHoleFits</span><span> </span><a name="local-6989586621683006495"><a href="#local-6989586621683006495"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683006495"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">empty</span><span class="hs-special">)</span><span>
</span><a name="line-773"></a><span>
</span><a name="line-774"></a><span>
</span><a name="line-775"></a><span class="hs-comment">-- | tcFilterHoleFits filters the candidates by whether, given the implications</span><span>
</span><a name="line-776"></a><span class="hs-comment">-- and the relevant constraints, they can be made to match the type by</span><span>
</span><a name="line-777"></a><span class="hs-comment">-- running the type checker. Stops after finding limit matches.</span><span>
</span><a name="line-778"></a><span class="hs-identifier">tcFilterHoleFits</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-779"></a><span>               </span><span class="hs-comment">-- ^ How many we should output, if limited</span><span>
</span><a name="line-780"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Implication</span><span class="hs-special">]</span><span>
</span><a name="line-781"></a><span>               </span><span class="hs-comment">-- ^ Enclosing implications for givens</span><span>
</span><a name="line-782"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">]</span><span>
</span><a name="line-783"></a><span>               </span><span class="hs-comment">-- ^ Any relevant unsolved simple constraints</span><span>
</span><a name="line-784"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-785"></a><span>               </span><span class="hs-comment">-- ^ The type to check for fits and a list of refinement</span><span>
</span><a name="line-786"></a><span>               </span><span class="hs-comment">-- variables (free type variables in the type) for emulating</span><span>
</span><a name="line-787"></a><span>               </span><span class="hs-comment">-- additional holes.</span><span>
</span><a name="line-788"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcHoleErrors.html#HoleFitCandidate"><span class="hs-identifier hs-type">HoleFitCandidate</span></a><span class="hs-special">]</span><span>
</span><a name="line-789"></a><span>               </span><span class="hs-comment">-- ^ The candidates to check whether fit.</span><span>
</span><a name="line-790"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-type">HoleFit</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-791"></a><span>               </span><span class="hs-comment">-- ^ We return whether or not we stopped due to hitting the limit</span><span>
</span><a name="line-792"></a><span>               </span><span class="hs-comment">-- and the fits we found.</span><span>
</span><a name="line-793"></a><a name="tcFilterHoleFits"><a href="TcHoleErrors.html#tcFilterHoleFits"><span class="hs-identifier">tcFilterHoleFits</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Stop right away on 0</span><span>
</span><a name="line-794"></a><span class="hs-identifier">tcFilterHoleFits</span><span> </span><a name="local-6989586621683006496"><a href="#local-6989586621683006496"><span class="hs-identifier">limit</span></a></a><span> </span><a name="local-6989586621683006497"><a href="#local-6989586621683006497"><span class="hs-identifier">implics</span></a></a><span> </span><a name="local-6989586621683006498"><a href="#local-6989586621683006498"><span class="hs-identifier">relevantCts</span></a></a><span> </span><a name="local-6989586621683006499"><a href="#local-6989586621683006499"><span class="hs-identifier">ht</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621683006500"><a href="#local-6989586621683006500"><span class="hs-identifier">hole_ty</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683006501"><a href="#local-6989586621683006501"><span class="hs-identifier">candidates</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-795"></a><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;checkingFitsFor {&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683006500"><span class="hs-identifier hs-var">hole_ty</span></a><span>
</span><a name="line-796"></a><span>     </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683006559"><a href="#local-6989586621683006559"><span class="hs-identifier">discards</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683006560"><a href="#local-6989586621683006560"><span class="hs-identifier">subs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683006503"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">emptyVarSet</span><span> </span><a href="#local-6989586621683006496"><span class="hs-identifier hs-var">limit</span></a><span> </span><a href="#local-6989586621683006499"><span class="hs-identifier hs-var">ht</span></a><span> </span><a href="#local-6989586621683006501"><span class="hs-identifier hs-var">candidates</span></a><span>
</span><a name="line-797"></a><span>     </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;checkingFitsFor }&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-798"></a><span>     </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683006559"><span class="hs-identifier hs-var">discards</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683006560"><span class="hs-identifier hs-var">subs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-799"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-800"></a><span>    </span><span class="hs-identifier">hole_fvs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FV</span><span>
</span><a name="line-801"></a><span>    </span><a name="local-6989586621683006502"><a href="#local-6989586621683006502"><span class="hs-identifier">hole_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyCoFVsOfType</span><span> </span><a href="#local-6989586621683006500"><span class="hs-identifier hs-var">hole_ty</span></a><span>
</span><a name="line-802"></a><span>    </span><span class="hs-comment">-- Kickoff the checking of the elements.</span><span>
</span><a name="line-803"></a><span>    </span><span class="hs-comment">-- We iterate over the elements, checking each one in turn for whether</span><span>
</span><a name="line-804"></a><span>    </span><span class="hs-comment">-- it fits, and adding it to the results if it does.</span><span>
</span><a name="line-805"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-type">HoleFit</span></a><span class="hs-special">]</span><span>           </span><span class="hs-comment">-- What we've found so far.</span><span>
</span><a name="line-806"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">VarSet</span><span>              </span><span class="hs-comment">-- Ids we've already checked</span><span>
</span><a name="line-807"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span>           </span><span class="hs-comment">-- How many we're allowed to find, if limited</span><span>
</span><a name="line-808"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- The type, and its refinement variables.</span><span>
</span><a name="line-809"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcHoleErrors.html#HoleFitCandidate"><span class="hs-identifier hs-type">HoleFitCandidate</span></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- The elements we've yet to check.</span><span>
</span><a name="line-810"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-type">HoleFit</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-811"></a><span>    </span><a name="local-6989586621683006503"><a href="#local-6989586621683006503"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621683006506"><a href="#local-6989586621683006506"><span class="hs-identifier">subs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621683006506"><span class="hs-identifier hs-var">subs</span></a><span class="hs-special">)</span><span>
</span><a name="line-812"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621683006507"><a href="#local-6989586621683006507"><span class="hs-identifier">subs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621683006507"><span class="hs-identifier hs-var">subs</span></a><span class="hs-special">)</span><span>
</span><a name="line-813"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621683006508"><a href="#local-6989586621683006508"><span class="hs-identifier">subs</span></a></a><span> </span><a name="local-6989586621683006509"><a href="#local-6989586621683006509"><span class="hs-identifier">seen</span></a></a><span> </span><a name="local-6989586621683006510"><a href="#local-6989586621683006510"><span class="hs-identifier">maxleft</span></a></a><span> </span><a name="local-6989586621683006511"><a href="#local-6989586621683006511"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683006512"><a href="#local-6989586621683006512"><span class="hs-identifier">el</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621683006513"><a href="#local-6989586621683006513"><span class="hs-identifier">elts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-814"></a><span>        </span><span class="hs-comment">-- See Note [Leaking errors]</span><span>
</span><a name="line-815"></a><span>        </span><a href="TcRnMonad.html#tryTcDiscardingErrs"><span class="hs-identifier hs-var">tryTcDiscardingErrs</span></a><span> </span><a href="#local-6989586621683006516"><span class="hs-identifier hs-var">discard_it</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-816"></a><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;lookingUp&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683006512"><span class="hs-identifier hs-var">el</span></a><span>
</span><a name="line-817"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683006534"><a href="#local-6989586621683006534"><span class="hs-identifier">maybeThing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683006515"><span class="hs-identifier hs-var">lookup</span></a><span> </span><a href="#local-6989586621683006512"><span class="hs-identifier hs-var">el</span></a><span>
</span><a name="line-818"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683006534"><span class="hs-identifier hs-var">maybeThing</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-819"></a><span>               </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683006535"><a href="#local-6989586621683006535"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683006514"><span class="hs-identifier hs-var">not_trivial</span></a><span> </span><a href="#local-6989586621683006535"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-820"></a><span>                       </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683006536"><a href="#local-6989586621683006536"><span class="hs-identifier">fits</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683006505"><span class="hs-identifier hs-var">fitsHole</span></a><span> </span><a href="#local-6989586621683006511"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683006535"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-821"></a><span>                          </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683006536"><span class="hs-identifier hs-var">fits</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-822"></a><span>                              </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683006537"><a href="#local-6989586621683006537"><span class="hs-identifier">wrp</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683006538"><a href="#local-6989586621683006538"><span class="hs-identifier">matches</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683006517"><span class="hs-identifier hs-var">keep_it</span></a><span> </span><a href="#local-6989586621683006535"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621683006537"><span class="hs-identifier hs-var">wrp</span></a><span> </span><a href="#local-6989586621683006538"><span class="hs-identifier hs-var">matches</span></a><span>
</span><a name="line-823"></a><span>                              </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683006516"><span class="hs-identifier hs-var">discard_it</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-824"></a><span>               </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683006516"><span class="hs-identifier hs-var">discard_it</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-825"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-826"></a><span>          </span><span class="hs-comment">-- We want to filter out undefined and the likes from GHC.Err</span><span>
</span><a name="line-827"></a><span>          </span><a name="local-6989586621683006514"><a href="#local-6989586621683006514"><span class="hs-identifier">not_trivial</span></a></a><span> </span><a name="local-6989586621683006518"><a href="#local-6989586621683006518"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameModule_maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621683006518"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">gHC_ERR</span><span>
</span><a name="line-828"></a><span>
</span><a name="line-829"></a><span>          </span><span class="hs-identifier">lookup</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcHoleErrors.html#HoleFitCandidate"><span class="hs-identifier hs-type">HoleFitCandidate</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">)</span><span>
</span><a name="line-830"></a><span>          </span><a name="local-6989586621683006515"><a href="#local-6989586621683006515"><span class="hs-identifier">lookup</span></a></a><span> </span><span class="hs-special">(</span><a href="TcHoleErrors.html#IdHFCand"><span class="hs-identifier hs-var">IdHFCand</span></a><span> </span><a name="local-6989586621683006519"><a href="#local-6989586621683006519"><span class="hs-identifier">id</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683006519"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-831"></a><span>          </span><span class="hs-identifier">lookup</span><span> </span><a name="local-6989586621683006520"><a href="#local-6989586621683006520"><span class="hs-identifier">hfc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683006525"><a href="#local-6989586621683006525"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookup"><span class="hs-identifier hs-var">tcLookup</span></a><span> </span><a href="#local-6989586621683006521"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-832"></a><span>                          </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683006525"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-833"></a><span>                                       </span><span class="hs-identifier hs-var">ATcId</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">tct_id</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683006526"><a href="#local-6989586621683006526"><span class="hs-identifier">id</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683006526"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-834"></a><span>                                       </span><span class="hs-identifier hs-var">AGlobal</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnId</span><span> </span><a name="local-6989586621683006527"><a href="#local-6989586621683006527"><span class="hs-identifier">id</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683006527"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-835"></a><span>                                       </span><span class="hs-identifier hs-var">AGlobal</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AConLike</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealDataCon</span><span> </span><a name="local-6989586621683006528"><a href="#local-6989586621683006528"><span class="hs-identifier">con</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-836"></a><span>                                           </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConWrapId</span><span> </span><a href="#local-6989586621683006528"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-837"></a><span>                                       </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-838"></a><span>            </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621683006521"><a href="#local-6989586621683006521"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683006520"><span class="hs-identifier hs-var">hfc</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-839"></a><span>                           </span><a href="TcHoleErrors.html#IdHFCand"><span class="hs-identifier hs-var">IdHFCand</span></a><span> </span><a name="local-6989586621683006522"><a href="#local-6989586621683006522"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621683006522"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-840"></a><span>                           </span><a href="TcHoleErrors.html#GreHFCand"><span class="hs-identifier hs-var">GreHFCand</span></a><span> </span><a name="local-6989586621683006523"><a href="#local-6989586621683006523"><span class="hs-identifier">gre</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">gre_name</span><span> </span><a href="#local-6989586621683006523"><span class="hs-identifier hs-var">gre</span></a><span>
</span><a name="line-841"></a><span>                           </span><a href="TcHoleErrors.html#NameHFCand"><span class="hs-identifier hs-var">NameHFCand</span></a><span> </span><a name="local-6989586621683006524"><a href="#local-6989586621683006524"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683006524"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-842"></a><span>          </span><a name="local-6989586621683006516"><a href="#local-6989586621683006516"><span class="hs-identifier">discard_it</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006503"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683006508"><span class="hs-identifier hs-var">subs</span></a><span> </span><a href="#local-6989586621683006509"><span class="hs-identifier hs-var">seen</span></a><span> </span><a href="#local-6989586621683006510"><span class="hs-identifier hs-var">maxleft</span></a><span> </span><a href="#local-6989586621683006511"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683006513"><span class="hs-identifier hs-var">elts</span></a><span>
</span><a name="line-843"></a><span>          </span><a name="local-6989586621683006517"><a href="#local-6989586621683006517"><span class="hs-identifier">keep_it</span></a></a><span> </span><a name="local-6989586621683006529"><a href="#local-6989586621683006529"><span class="hs-identifier">eid</span></a></a><span> </span><a name="local-6989586621683006530"><a href="#local-6989586621683006530"><span class="hs-identifier">wrp</span></a></a><span> </span><a name="local-6989586621683006531"><a href="#local-6989586621683006531"><span class="hs-identifier">ms</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006503"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683006532"><span class="hs-identifier hs-var">fit</span></a><span class="hs-glyph">:</span><a href="#local-6989586621683006508"><span class="hs-identifier hs-var">subs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">extendVarSet</span><span> </span><a href="#local-6989586621683006509"><span class="hs-identifier hs-var">seen</span></a><span> </span><a href="#local-6989586621683006529"><span class="hs-identifier hs-var">eid</span></a><span class="hs-special">)</span><span>
</span><a name="line-844"></a><span>                                 </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621683006533"><a href="#local-6989586621683006533"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683006533"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621683006510"><span class="hs-identifier hs-var">maxleft</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683006511"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683006513"><span class="hs-identifier hs-var">elts</span></a><span>
</span><a name="line-845"></a><span>            </span><span class="hs-keyword">where</span><span>
</span><a name="line-846"></a><span>              </span><a name="local-6989586621683006532"><a href="#local-6989586621683006532"><span class="hs-identifier">fit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHoleErrors.html#HoleFit"><span class="hs-identifier hs-var">HoleFit</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hfId</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006529"><span class="hs-identifier hs-var">eid</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">hfCand</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006512"><span class="hs-identifier hs-var">el</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">hfType</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683006529"><span class="hs-identifier hs-var">eid</span></a><span class="hs-special">)</span><span>
</span><a name="line-847"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hfRefLvl</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621683006511"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-848"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hfWrap</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006530"><span class="hs-identifier hs-var">wrp</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">hfMatches</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006531"><span class="hs-identifier hs-var">ms</span></a><span>
</span><a name="line-849"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hfDoc</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-850"></a><span>
</span><a name="line-851"></a><span>
</span><a name="line-852"></a><span>
</span><a name="line-853"></a><span>
</span><a name="line-854"></a><span>    </span><span class="hs-identifier">unfoldWrapper</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsWrapper</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-855"></a><span>    </span><a name="local-6989586621683006504"><a href="#local-6989586621683006504"><span class="hs-identifier">unfoldWrapper</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621683006539"><span class="hs-identifier hs-var">unfWrp'</span></a><span>
</span><a name="line-856"></a><span>      </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621683006539"><a href="#local-6989586621683006539"><span class="hs-identifier">unfWrp'</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WpTyApp</span><span> </span><a name="local-6989586621683006540"><a href="#local-6989586621683006540"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683006540"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-857"></a><span>            </span><span class="hs-identifier">unfWrp'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WpCompose</span><span> </span><a name="local-6989586621683006541"><a href="#local-6989586621683006541"><span class="hs-identifier">w1</span></a></a><span> </span><a name="local-6989586621683006542"><a href="#local-6989586621683006542"><span class="hs-identifier">w2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006539"><span class="hs-identifier hs-var">unfWrp'</span></a><span> </span><a href="#local-6989586621683006541"><span class="hs-identifier hs-var">w1</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683006539"><span class="hs-identifier hs-var">unfWrp'</span></a><span> </span><a href="#local-6989586621683006542"><span class="hs-identifier hs-var">w2</span></a><span>
</span><a name="line-858"></a><span>            </span><span class="hs-identifier">unfWrp'</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-859"></a><span>
</span><a name="line-860"></a><span>
</span><a name="line-861"></a><span>    </span><span class="hs-comment">-- The real work happens here, where we invoke the type checker using</span><span>
</span><a name="line-862"></a><span>    </span><span class="hs-comment">-- tcCheckHoleFit to see whether the given type fits the hole.</span><span>
</span><a name="line-863"></a><span>    </span><span class="hs-identifier">fitsHole</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- The type of the hole wrapped with the</span><span>
</span><a name="line-864"></a><span>                                    </span><span class="hs-comment">-- refinement variables created to simulate</span><span>
</span><a name="line-865"></a><span>                                    </span><span class="hs-comment">-- additional holes (if any), and the list</span><span>
</span><a name="line-866"></a><span>                                    </span><span class="hs-comment">-- of those variables (possibly empty).</span><span>
</span><a name="line-867"></a><span>                                    </span><span class="hs-comment">-- As an example: If the actual type of the</span><span>
</span><a name="line-868"></a><span>                                    </span><span class="hs-comment">-- hole (as specified by the hole</span><span>
</span><a name="line-869"></a><span>                                    </span><span class="hs-comment">-- constraint CHoleExpr passed to</span><span>
</span><a name="line-870"></a><span>                                    </span><span class="hs-comment">-- findValidHoleFits) is t and we want to</span><span>
</span><a name="line-871"></a><span>                                    </span><span class="hs-comment">-- simulate N additional holes, h_ty will</span><span>
</span><a name="line-872"></a><span>                                    </span><span class="hs-comment">-- be  r_1 -&gt; ... -&gt; r_N -&gt; t, and</span><span>
</span><a name="line-873"></a><span>                                    </span><span class="hs-comment">-- ref_vars will be [r_1, ... , r_N].</span><span>
</span><a name="line-874"></a><span>                                    </span><span class="hs-comment">-- In the base case with no additional</span><span>
</span><a name="line-875"></a><span>                                    </span><span class="hs-comment">-- holes, h_ty will just be t and ref_vars</span><span>
</span><a name="line-876"></a><span>                                    </span><span class="hs-comment">-- will be [].</span><span>
</span><a name="line-877"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-comment">-- The type we're checking to whether it can be</span><span>
</span><a name="line-878"></a><span>                       </span><span class="hs-comment">-- instantiated to the type h_ty.</span><span>
</span><a name="line-879"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- If it is not a match, we</span><span>
</span><a name="line-880"></a><span>                                                 </span><span class="hs-comment">-- return Nothing. Otherwise,</span><span>
</span><a name="line-881"></a><span>                                                 </span><span class="hs-comment">-- we Just return the list of</span><span>
</span><a name="line-882"></a><span>                                                 </span><span class="hs-comment">-- types that quantified type</span><span>
</span><a name="line-883"></a><span>                                                 </span><span class="hs-comment">-- variables in ty would take</span><span>
</span><a name="line-884"></a><span>                                                 </span><span class="hs-comment">-- if used in place of h_ty,</span><span>
</span><a name="line-885"></a><span>                                                 </span><span class="hs-comment">-- and the list types of any</span><span>
</span><a name="line-886"></a><span>                                                 </span><span class="hs-comment">-- additional holes simulated</span><span>
</span><a name="line-887"></a><span>                                                 </span><span class="hs-comment">-- with the refinement</span><span>
</span><a name="line-888"></a><span>                                                 </span><span class="hs-comment">-- variables in ref_vars.</span><span>
</span><a name="line-889"></a><span>    </span><a name="local-6989586621683006505"><a href="#local-6989586621683006505"><span class="hs-identifier">fitsHole</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683006543"><a href="#local-6989586621683006543"><span class="hs-identifier">h_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683006544"><a href="#local-6989586621683006544"><span class="hs-identifier">ref_vars</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683006545"><a href="#local-6989586621683006545"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-890"></a><span>    </span><span class="hs-comment">-- We wrap this with the withoutUnification to avoid having side-effects</span><span>
</span><a name="line-891"></a><span>    </span><span class="hs-comment">-- beyond the check, but we rely on the side-effects when looking for</span><span>
</span><a name="line-892"></a><span>    </span><span class="hs-comment">-- refinement hole fits, so we can't wrap the side-effects deeper than this.</span><span>
</span><a name="line-893"></a><span>      </span><a href="TcHoleErrors.html#withoutUnification"><span class="hs-identifier hs-var">withoutUnification</span></a><span> </span><a href="#local-6989586621683006546"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-894"></a><span>      </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;checkingFitOf {&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683006545"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-895"></a><span>         </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683006547"><a href="#local-6989586621683006547"><span class="hs-identifier">fits</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683006548"><a href="#local-6989586621683006548"><span class="hs-identifier">wrp</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHoleErrors.html#tcCheckHoleFit"><span class="hs-identifier hs-var">tcCheckHoleFit</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">listToBag</span><span> </span><a href="#local-6989586621683006498"><span class="hs-identifier hs-var">relevantCts</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683006497"><span class="hs-identifier hs-var">implics</span></a><span> </span><a href="#local-6989586621683006543"><span class="hs-identifier hs-var">h_ty</span></a><span> </span><a href="#local-6989586621683006545"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-896"></a><span>         </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Did it fit?&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683006547"><span class="hs-identifier hs-var">fits</span></a><span>
</span><a name="line-897"></a><span>         </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;wrap is: &quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683006548"><span class="hs-identifier hs-var">wrp</span></a><span>
</span><a name="line-898"></a><span>         </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;checkingFitOf }&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-899"></a><span>         </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683006549"><a href="#local-6989586621683006549"><span class="hs-identifier">z_wrp_tys</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcTypes"><span class="hs-identifier hs-var">zonkTcTypes</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683006504"><span class="hs-identifier hs-var">unfoldWrapper</span></a><span> </span><a href="#local-6989586621683006548"><span class="hs-identifier hs-var">wrp</span></a><span class="hs-special">)</span><span>
</span><a name="line-900"></a><span>         </span><span class="hs-comment">-- We'd like to avoid refinement suggestions like `id _ _` or</span><span>
</span><a name="line-901"></a><span>         </span><span class="hs-comment">-- `head _ _`, and only suggest refinements where our all phantom</span><span>
</span><a name="line-902"></a><span>         </span><span class="hs-comment">-- variables got unified during the checking. This can be disabled</span><span>
</span><a name="line-903"></a><span>         </span><span class="hs-comment">-- with the `-fabstract-refinement-hole-fits` flag.</span><span>
</span><a name="line-904"></a><span>         </span><span class="hs-comment">-- Here we do the additional handling when there are refinement</span><span>
</span><a name="line-905"></a><span>         </span><span class="hs-comment">-- variables, i.e. zonk them to read their final value to check for</span><span>
</span><a name="line-906"></a><span>         </span><span class="hs-comment">-- abstract refinements, and to report what the type of the simulated</span><span>
</span><a name="line-907"></a><span>         </span><span class="hs-comment">-- holes must be for this to be a match.</span><span>
</span><a name="line-908"></a><span>         </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683006547"><span class="hs-identifier hs-var">fits</span></a><span>
</span><a name="line-909"></a><span>           </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683006544"><span class="hs-identifier hs-var">ref_vars</span></a><span>
</span><a name="line-910"></a><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683006549"><span class="hs-identifier hs-var">z_wrp_tys</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-911"></a><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- To be concrete matches, matches have to</span><span>
</span><a name="line-912"></a><span>                              </span><span class="hs-comment">-- be more than just an invented type variable.</span><span>
</span><a name="line-913"></a><span>                              </span><a name="local-6989586621683006550"><a href="#local-6989586621683006550"><span class="hs-identifier">fvSet</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fvVarSet</span><span> </span><a href="#local-6989586621683006546"><span class="hs-identifier hs-var">fvs</span></a><span>
</span><a name="line-914"></a><span>                              </span><span class="hs-identifier">notAbstract</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-915"></a><span>                              </span><a name="local-6989586621683006551"><a href="#local-6989586621683006551"><span class="hs-identifier">notAbstract</span></a></a><span> </span><a name="local-6989586621683006553"><a href="#local-6989586621683006553"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">getTyVar_maybe</span><span> </span><a href="#local-6989586621683006553"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-916"></a><span>                                                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683006554"><a href="#local-6989586621683006554"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683006554"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683006550"><span class="hs-identifier hs-var">fvSet</span></a><span>
</span><a name="line-917"></a><span>                                                </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-918"></a><span>                              </span><a name="local-6989586621683006552"><a href="#local-6989586621683006552"><span class="hs-identifier">allConcrete</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><a href="#local-6989586621683006551"><span class="hs-identifier hs-var">notAbstract</span></a><span> </span><a href="#local-6989586621683006549"><span class="hs-identifier hs-var">z_wrp_tys</span></a><span>
</span><a name="line-919"></a><span>                        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683006555"><a href="#local-6989586621683006555"><span class="hs-identifier">z_vars</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcTyVars"><span class="hs-identifier hs-var">zonkTcTyVars</span></a><span> </span><a href="#local-6989586621683006544"><span class="hs-identifier hs-var">ref_vars</span></a><span>
</span><a name="line-920"></a><span>                        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683006556"><a href="#local-6989586621683006556"><span class="hs-identifier">z_mtvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><span class="hs-identifier hs-var">tcGetTyVar_maybe</span><span> </span><a href="#local-6989586621683006555"><span class="hs-identifier hs-var">z_vars</span></a><span>
</span><a name="line-921"></a><span>                        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683006557"><a href="#local-6989586621683006557"><span class="hs-identifier">allFilled</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">anyM</span><span> </span><a href="TcHoleErrors.html#isFlexiTyVar"><span class="hs-identifier hs-var">isFlexiTyVar</span></a><span> </span><a href="#local-6989586621683006556"><span class="hs-identifier hs-var">z_mtvs</span></a><span>
</span><a name="line-922"></a><span>                        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683006558"><a href="#local-6989586621683006558"><span class="hs-identifier">allowAbstract</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#goptM"><span class="hs-identifier hs-var">goptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_AbstractRefHoleFits</span><span>
</span><a name="line-923"></a><span>                        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683006558"><span class="hs-identifier hs-var">allowAbstract</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683006557"><span class="hs-identifier hs-var">allFilled</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621683006552"><span class="hs-identifier hs-var">allConcrete</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-924"></a><span>                          </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683006549"><span class="hs-identifier hs-var">z_wrp_tys</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683006555"><span class="hs-identifier hs-var">z_vars</span></a><span class="hs-special">)</span><span>
</span><a name="line-925"></a><span>                          </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-926"></a><span>           </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-927"></a><span>     </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621683006546"><a href="#local-6989586621683006546"><span class="hs-identifier">fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkFVs</span><span> </span><a href="#local-6989586621683006544"><span class="hs-identifier hs-var">ref_vars</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683006502"><span class="hs-identifier hs-var">hole_fvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionFV</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">tyCoFVsOfType</span><span> </span><a href="#local-6989586621683006545"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-928"></a><span>
</span><a name="line-929"></a><span>
</span><a name="line-930"></a><span class="hs-identifier">subsDiscardMsg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-931"></a><a name="subsDiscardMsg"><a href="TcHoleErrors.html#subsDiscardMsg"><span class="hs-identifier">subsDiscardMsg</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-932"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;(Some hole fits suppressed;&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-933"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;use -fmax-valid-hole-fits=N&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-934"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;or -fno-max-valid-hole-fits)&quot;</span><span>
</span><a name="line-935"></a><span>
</span><a name="line-936"></a><span class="hs-identifier">refSubsDiscardMsg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-937"></a><a name="refSubsDiscardMsg"><a href="TcHoleErrors.html#refSubsDiscardMsg"><span class="hs-identifier">refSubsDiscardMsg</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-938"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;(Some refinement hole fits suppressed;&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-939"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;use -fmax-refinement-hole-fits=N&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-940"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;or -fno-max-refinement-hole-fits)&quot;</span><span>
</span><a name="line-941"></a><span>
</span><a name="line-942"></a><span>
</span><a name="line-943"></a><span class="hs-comment">-- | Checks whether a MetaTyVar is flexible or not.</span><span>
</span><a name="line-944"></a><span class="hs-identifier">isFlexiTyVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-945"></a><a name="isFlexiTyVar"><a href="TcHoleErrors.html#isFlexiTyVar"><span class="hs-identifier">isFlexiTyVar</span></a></a><span> </span><a name="local-6989586621683006561"><a href="#local-6989586621683006561"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isMetaTyVar</span><span> </span><a href="#local-6989586621683006561"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isFlexi</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcMType.html#readMetaTyVar"><span class="hs-identifier hs-var">readMetaTyVar</span></a><span> </span><a href="#local-6989586621683006561"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-946"></a><span class="hs-identifier">isFlexiTyVar</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-947"></a><span>
</span><a name="line-948"></a><span class="hs-comment">-- | Takes a list of free variables and restores any Flexi type variables in</span><span>
</span><a name="line-949"></a><span class="hs-comment">-- free_vars after the action is run.</span><span>
</span><a name="line-950"></a><span class="hs-identifier">withoutUnification</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FV</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683006297"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683006297"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-951"></a><a name="withoutUnification"><a href="TcHoleErrors.html#withoutUnification"><span class="hs-identifier">withoutUnification</span></a></a><span> </span><a name="local-6989586621683006562"><a href="#local-6989586621683006562"><span class="hs-identifier">free_vars</span></a></a><span> </span><a name="local-6989586621683006563"><a href="#local-6989586621683006563"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-952"></a><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683006566"><a href="#local-6989586621683006566"><span class="hs-identifier">flexis</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">filterM</span><span> </span><a href="TcHoleErrors.html#isFlexiTyVar"><span class="hs-identifier hs-var">isFlexiTyVar</span></a><span> </span><a href="#local-6989586621683006565"><span class="hs-identifier hs-var">fuvs</span></a><span>
</span><a name="line-953"></a><span>     </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683006567"><a href="#local-6989586621683006567"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683006563"><span class="hs-identifier hs-var">action</span></a><span>
</span><a name="line-954"></a><span>          </span><span class="hs-comment">-- Reset any mutated free variables</span><span>
</span><a name="line-955"></a><span>     </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="#local-6989586621683006564"><span class="hs-identifier hs-var">restore</span></a><span> </span><a href="#local-6989586621683006566"><span class="hs-identifier hs-var">flexis</span></a><span>
</span><a name="line-956"></a><span>     </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683006567"><span class="hs-identifier hs-var">result</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-957"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621683006564"><a href="#local-6989586621683006564"><span class="hs-identifier">restore</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">writeTcRef</span></a><span> </span><span class="hs-identifier hs-var">Flexi</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">metaTyVarRef</span><span>
</span><a name="line-958"></a><span>        </span><a name="local-6989586621683006565"><a href="#local-6989586621683006565"><span class="hs-identifier">fuvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fvVarList</span><span> </span><a href="#local-6989586621683006562"><span class="hs-identifier hs-var">free_vars</span></a><span>
</span><a name="line-959"></a><span>
</span><a name="line-960"></a><span class="hs-comment">-- | Reports whether first type (ty_a) subsumes the second type (ty_b),</span><span>
</span><a name="line-961"></a><span class="hs-comment">-- discarding any errors. Subsumption here means that the ty_b can fit into the</span><span>
</span><a name="line-962"></a><span class="hs-comment">-- ty_a, i.e. `tcSubsumes a b == True` if b is a subtype of a.</span><span>
</span><a name="line-963"></a><span class="hs-identifier">tcSubsumes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcSigmaType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcSigmaType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-964"></a><a name="tcSubsumes"><a href="TcHoleErrors.html#tcSubsumes"><span class="hs-identifier">tcSubsumes</span></a></a><span> </span><a name="local-6989586621683006568"><a href="#local-6989586621683006568"><span class="hs-identifier">ty_a</span></a></a><span> </span><a name="local-6989586621683006569"><a href="#local-6989586621683006569"><span class="hs-identifier">ty_b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcHoleErrors.html#tcCheckHoleFit"><span class="hs-identifier hs-var">tcCheckHoleFit</span></a><span> </span><span class="hs-identifier hs-var">emptyBag</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621683006568"><span class="hs-identifier hs-var">ty_a</span></a><span> </span><a href="#local-6989586621683006569"><span class="hs-identifier hs-var">ty_b</span></a><span>
</span><a name="line-965"></a><span>
</span><a name="line-966"></a><span>
</span><a name="line-967"></a><span class="hs-comment">-- | A tcSubsumes which takes into account relevant constraints, to fix trac</span><span>
</span><a name="line-968"></a><span class="hs-comment">-- #14273. This makes sure that when checking whether a type fits the hole,</span><span>
</span><a name="line-969"></a><span class="hs-comment">-- the type has to be subsumed by type of the hole as well as fulfill all</span><span>
</span><a name="line-970"></a><span class="hs-comment">-- constraints on the type of the hole.</span><span>
</span><a name="line-971"></a><span class="hs-comment">-- Note: The simplifier may perform unification, so make sure to restore any</span><span>
</span><a name="line-972"></a><span class="hs-comment">-- free type variables to avoid side-effects.</span><span>
</span><a name="line-973"></a><span class="hs-identifier">tcCheckHoleFit</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Cts</span><span>                   </span><span class="hs-comment">-- ^  Any relevant Cts to the hole.</span><span>
</span><a name="line-974"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Implication</span><span class="hs-special">]</span><span>
</span><a name="line-975"></a><span>               </span><span class="hs-comment">-- ^ The nested implications of the hole with the innermost</span><span>
</span><a name="line-976"></a><span>               </span><span class="hs-comment">-- implication first.</span><span>
</span><a name="line-977"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcSigmaType</span><span>           </span><span class="hs-comment">-- ^ The type of the hole.</span><span>
</span><a name="line-978"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcSigmaType</span><span>           </span><span class="hs-comment">-- ^ The type to check whether fits.</span><span>
</span><a name="line-979"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HsWrapper</span><span class="hs-special">)</span><span>
</span><a name="line-980"></a><span>               </span><span class="hs-comment">-- ^ Whether it was a match, and the wrapper from hole_ty to ty.</span><span>
</span><a name="line-981"></a><a name="tcCheckHoleFit"><a href="TcHoleErrors.html#tcCheckHoleFit"><span class="hs-identifier">tcCheckHoleFit</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683006570"><a href="#local-6989586621683006570"><span class="hs-identifier">hole_ty</span></a></a><span> </span><a name="local-6989586621683006571"><a href="#local-6989586621683006571"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683006570"><span class="hs-identifier hs-var">hole_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqType</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683006571"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-982"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">idHsWrapper</span><span class="hs-special">)</span><span>
</span><a name="line-983"></a><span class="hs-identifier">tcCheckHoleFit</span><span> </span><a name="local-6989586621683006572"><a href="#local-6989586621683006572"><span class="hs-identifier">relevantCts</span></a></a><span> </span><a name="local-6989586621683006573"><a href="#local-6989586621683006573"><span class="hs-identifier">implics</span></a></a><span> </span><a name="local-6989586621683006574"><a href="#local-6989586621683006574"><span class="hs-identifier">hole_ty</span></a></a><span> </span><a name="local-6989586621683006575"><a href="#local-6989586621683006575"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#discardErrs"><span class="hs-identifier hs-var">discardErrs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-984"></a><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- We wrap the subtype constraint in the implications to pass along the</span><span>
</span><a name="line-985"></a><span>       </span><span class="hs-comment">-- givens, and so we must ensure that any nested implications and skolems</span><span>
</span><a name="line-986"></a><span>       </span><span class="hs-comment">-- end up with the correct level. The implications are ordered so that</span><span>
</span><a name="line-987"></a><span>       </span><span class="hs-comment">-- the innermost (the one with the highest level) is first, so it</span><span>
</span><a name="line-988"></a><span>       </span><span class="hs-comment">-- suffices to get the level of the first one (or the current level, if</span><span>
</span><a name="line-989"></a><span>       </span><span class="hs-comment">-- there are no implications involved).</span><span>
</span><a name="line-990"></a><span>       </span><a name="local-6989586621683006581"><a href="#local-6989586621683006581"><span class="hs-identifier">innermost_lvl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683006573"><span class="hs-identifier hs-var">implics</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-991"></a><span>                          </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#getTcLevel"><span class="hs-identifier hs-var">getTcLevel</span></a><span>
</span><a name="line-992"></a><span>                          </span><span class="hs-comment">-- imp is the innermost implication</span><span>
</span><a name="line-993"></a><span>                          </span><span class="hs-special">(</span><a name="local-6989586621683006580"><a href="#local-6989586621683006580"><span class="hs-identifier">imp</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ic_tclvl</span><span> </span><a href="#local-6989586621683006580"><span class="hs-identifier hs-var">imp</span></a><span class="hs-special">)</span><span>
</span><a name="line-994"></a><span>     </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683006582"><a href="#local-6989586621683006582"><span class="hs-identifier">wrp</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683006583"><a href="#local-6989586621683006583"><span class="hs-identifier">wanted</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setTcLevel"><span class="hs-identifier hs-var">setTcLevel</span></a><span> </span><a href="#local-6989586621683006581"><span class="hs-identifier hs-var">innermost_lvl</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnMonad.html#captureConstraints"><span class="hs-identifier hs-var">captureConstraints</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-995"></a><span>                          </span><a href="TcUnify.html#tcSubType_NC"><span class="hs-identifier hs-var">tcSubType_NC</span></a><span> </span><span class="hs-identifier hs-var">ExprSigCtxt</span><span> </span><a href="#local-6989586621683006575"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683006574"><span class="hs-identifier hs-var">hole_ty</span></a><span>
</span><a name="line-996"></a><span>     </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Checking hole fit {&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-997"></a><span>     </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;wanteds are: &quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683006583"><span class="hs-identifier hs-var">wanted</span></a><span>
</span><a name="line-998"></a><span>     </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isEmptyWC</span><span> </span><a href="#local-6989586621683006583"><span class="hs-identifier hs-var">wanted</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isEmptyBag</span><span> </span><a href="#local-6989586621683006572"><span class="hs-identifier hs-var">relevantCts</span></a><span>
</span><a name="line-999"></a><span>       </span><span class="hs-keyword">then</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;}&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683006582"><span class="hs-identifier hs-var">wrp</span></a><span class="hs-special">)</span><span>
</span><a name="line-1000"></a><span>       </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683006584"><a href="#local-6989586621683006584"><span class="hs-identifier">fresh_binds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newTcEvBinds"><span class="hs-identifier hs-var">newTcEvBinds</span></a><span>
</span><a name="line-1001"></a><span>                </span><span class="hs-comment">-- The relevant constraints may contain HoleDests, so we must</span><span>
</span><a name="line-1002"></a><span>                </span><span class="hs-comment">-- take care to clone them as well (to avoid #15370).</span><span>
</span><a name="line-1003"></a><span>               </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683006585"><a href="#local-6989586621683006585"><span class="hs-identifier">cloned_relevants</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapBagM</span><span> </span><a href="TcMType.html#cloneWanted"><span class="hs-identifier hs-var">cloneWanted</span></a><span> </span><a href="#local-6989586621683006572"><span class="hs-identifier hs-var">relevantCts</span></a><span>
</span><a name="line-1004"></a><span>                 </span><span class="hs-comment">-- We wrap the WC in the nested implications, see</span><span>
</span><a name="line-1005"></a><span>                 </span><span class="hs-comment">-- Note [Nested Implications]</span><span>
</span><a name="line-1006"></a><span>               </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683006586"><a href="#local-6989586621683006586"><span class="hs-identifier">outermost_first</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621683006573"><span class="hs-identifier hs-var">implics</span></a><span>
</span><a name="line-1007"></a><span>                     </span><a name="local-6989586621683006587"><a href="#local-6989586621683006587"><span class="hs-identifier">setWC</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006576"><span class="hs-identifier hs-var">setWCAndBinds</span></a><span> </span><a href="#local-6989586621683006584"><span class="hs-identifier hs-var">fresh_binds</span></a><span>
</span><a name="line-1008"></a><span>                    </span><span class="hs-comment">-- We add the cloned relevants to the wanteds generated by</span><span>
</span><a name="line-1009"></a><span>                    </span><span class="hs-comment">-- the call to tcSubType_NC, see Note [Relevant Constraints]</span><span>
</span><a name="line-1010"></a><span>                    </span><span class="hs-comment">-- There's no need to clone the wanteds, because they are</span><span>
</span><a name="line-1011"></a><span>                    </span><span class="hs-comment">-- freshly generated by `tcSubtype_NC`.</span><span>
</span><a name="line-1012"></a><span>                     </span><a name="local-6989586621683006588"><a href="#local-6989586621683006588"><span class="hs-identifier">w_rel_cts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addSimples</span><span> </span><a href="#local-6989586621683006583"><span class="hs-identifier hs-var">wanted</span></a><span> </span><a href="#local-6989586621683006585"><span class="hs-identifier hs-var">cloned_relevants</span></a><span>
</span><a name="line-1013"></a><span>                     </span><a name="local-6989586621683006589"><a href="#local-6989586621683006589"><span class="hs-identifier">w_givens</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621683006587"><span class="hs-identifier hs-var">setWC</span></a><span> </span><a href="#local-6989586621683006588"><span class="hs-identifier hs-var">w_rel_cts</span></a><span> </span><a href="#local-6989586621683006586"><span class="hs-identifier hs-var">outermost_first</span></a><span>
</span><a name="line-1014"></a><span>               </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;w_givens are: &quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683006589"><span class="hs-identifier hs-var">w_givens</span></a><span>
</span><a name="line-1015"></a><span>               </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683006590"><a href="#local-6989586621683006590"><span class="hs-identifier">rem</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#runTcSDeriveds"><span class="hs-identifier hs-var">runTcSDeriveds</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcSimplify.html#simpl_top"><span class="hs-identifier hs-var">simpl_top</span></a><span> </span><a href="#local-6989586621683006589"><span class="hs-identifier hs-var">w_givens</span></a><span>
</span><a name="line-1016"></a><span>               </span><span class="hs-comment">-- We don't want any insoluble or simple constraints left, but</span><span>
</span><a name="line-1017"></a><span>               </span><span class="hs-comment">-- solved implications are ok (and neccessary for e.g. undefined)</span><span>
</span><a name="line-1018"></a><span>               </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;rems was:&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683006590"><span class="hs-identifier hs-var">rem</span></a><span>
</span><a name="line-1019"></a><span>               </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;}&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-1020"></a><span>               </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isSolvedWC</span><span> </span><a href="#local-6989586621683006590"><span class="hs-identifier hs-var">rem</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683006582"><span class="hs-identifier hs-var">wrp</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1021"></a><span>     </span><span class="hs-keyword">where</span><span>
</span><a name="line-1022"></a><span>       </span><span class="hs-identifier">setWCAndBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">EvBindsVar</span><span>         </span><span class="hs-comment">-- Fresh ev binds var.</span><span>
</span><a name="line-1023"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Implication</span><span>        </span><span class="hs-comment">-- The implication to put WC in.</span><span>
</span><a name="line-1024"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">WantedConstraints</span><span>  </span><span class="hs-comment">-- The WC constraints to put implic.</span><span>
</span><a name="line-1025"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">WantedConstraints</span><span>  </span><span class="hs-comment">-- The new constraints.</span><span>
</span><a name="line-1026"></a><span>       </span><a name="local-6989586621683006576"><a href="#local-6989586621683006576"><span class="hs-identifier">setWCAndBinds</span></a></a><span> </span><a name="local-6989586621683006577"><a href="#local-6989586621683006577"><span class="hs-identifier">binds</span></a></a><span> </span><a name="local-6989586621683006578"><a href="#local-6989586621683006578"><span class="hs-identifier">imp</span></a></a><span> </span><a name="local-6989586621683006579"><a href="#local-6989586621683006579"><span class="hs-identifier">wc</span></a></a><span>
</span><a name="line-1027"></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">WC</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wc_simple</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyBag</span><span>
</span><a name="line-1028"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wc_impl</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unitBag</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683006578"><span class="hs-identifier hs-var">imp</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ic_wanted</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006579"><span class="hs-identifier hs-var">wc</span></a><span> </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ic_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683006577"><span class="hs-identifier hs-var">binds</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1029"></a></pre></body></html>