<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- The @FamInst@ type: family instance heads</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE CPP, GADTs #-}</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">FamInst</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-6"></a><span>        </span><span class="hs-identifier hs-type">FamInstEnvs</span><span class="hs-special">,</span><span> </span><a href="FamInst.html#tcGetFamInstEnvs"><span class="hs-identifier hs-var">tcGetFamInstEnvs</span></a><span class="hs-special">,</span><span>
</span><a name="line-7"></a><span>        </span><a href="FamInst.html#checkFamInstConsistency"><span class="hs-identifier hs-var">checkFamInstConsistency</span></a><span class="hs-special">,</span><span> </span><a href="FamInst.html#tcExtendLocalFamInstEnv"><span class="hs-identifier hs-var">tcExtendLocalFamInstEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-8"></a><span>        </span><a href="FamInst.html#tcLookupDataFamInst"><span class="hs-identifier hs-var">tcLookupDataFamInst</span></a><span class="hs-special">,</span><span> </span><a href="FamInst.html#tcLookupDataFamInst_maybe"><span class="hs-identifier hs-var">tcLookupDataFamInst_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-9"></a><span>        </span><a href="FamInst.html#tcInstNewTyCon_maybe"><span class="hs-identifier hs-var">tcInstNewTyCon_maybe</span></a><span class="hs-special">,</span><span> </span><a href="FamInst.html#tcTopNormaliseNewTypeTF_maybe"><span class="hs-identifier hs-var">tcTopNormaliseNewTypeTF_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-10"></a><span>        </span><a href="FamInst.html#newFamInst"><span class="hs-identifier hs-var">newFamInst</span></a><span class="hs-special">,</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span>        </span><span class="hs-comment">-- * Injectivity</span><span>
</span><a name="line-13"></a><span>        </span><a href="FamInst.html#makeInjectivityErrors"><span class="hs-identifier hs-var">makeInjectivityErrors</span></a><span class="hs-special">,</span><span> </span><a href="FamInst.html#injTyVarsOfType"><span class="hs-identifier hs-var">injTyVarsOfType</span></a><span class="hs-special">,</span><span> </span><a href="FamInst.html#injTyVarsOfTypes"><span class="hs-identifier hs-var">injTyVarsOfTypes</span></a><span>
</span><a name="line-14"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FamInstEnv</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">InstEnv</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">roughMatchTcs</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Coercion</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="CoreLint.html"><span class="hs-identifier">CoreLint</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcEvidence</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="LoadIface.html"><span class="hs-identifier">LoadIface</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoAxiom</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RdrName</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">dataConName</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCoRep</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="TcMType.html"><span class="hs-identifier">TcMType</span></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Pair</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Panic</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarSet</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Bag</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Bag</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unionBags</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unitBag</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-49"></a><span class="hs-comment">{- Note [The type family instance consistency story]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To preserve type safety we must ensure that for any given module, all
the type family instances used either in that module or in any module
it directly or indirectly imports are consistent. For example, consider

  module F where
    type family F a

  module A where
    import F( F )
    type instance F Int = Bool
    f :: F Int -&gt; Bool
    f x = x

  module B where
    import F( F )
    type instance F Int = Char
    g :: Char -&gt; F Int
    g x = x

  module Bad where
    import A( f )
    import B( g )
    bad :: Char -&gt; Int
    bad c = f (g c)

Even though module Bad never mentions the type family F at all, by
combining the functions f and g that were type checked in contradictory
type family instance environments, the function bad is able to coerce
from one type to another. So when we type check Bad we must verify that
the type family instances defined in module A are consistent with those
defined in module B.

How do we ensure that we maintain the necessary consistency?

* Call a module which defines at least one type family instance a
  &quot;family instance module&quot;. This flag `mi_finsts` is recorded in the
  interface file.

* For every module we calculate the set of all of its direct and
  indirect dependencies that are family instance modules. This list
  `dep_finsts` is also recorded in the interface file so we can compute
  this list for a module from the lists for its direct dependencies.

* When type checking a module M we check consistency of all the type
  family instances that are either provided by its `dep_finsts` or
  defined in the module M itself. This is a pairwise check, i.e., for
  every pair of instances we must check that they are consistent.

  - For family instances coming from `dep_finsts`, this is checked in
    checkFamInstConsistency, called from tcRnImports. See Note
    [Checking family instance consistency] for details on this check
    (and in particular how we avoid having to do all these checks for
    every module we compile).

  - That leaves checking the family instances defined in M itself
    against instances defined in either M or its `dep_finsts`. This is
    checked in `tcExtendLocalFamInstEnv'.

There are four subtle points in this scheme which have not been
addressed yet.

* We have checked consistency of the family instances *defined* by M
  or its imports, but this is not by definition the same thing as the
  family instances *used* by M or its imports.  Specifically, we need to
  ensure when we use a type family instance while compiling M that this
  instance was really defined from either M or one of its imports,
  rather than being an instance that we happened to know about from
  reading an interface file in the course of compiling an unrelated
  module. Otherwise, we'll end up with no record of the fact that M
  depends on this family instance and type safety will be compromised.
  See #13102.

* It can also happen that M uses a function defined in another module
  which is not transitively imported by M. Examples include the
  desugaring of various overloaded constructs, and references inserted
  by Template Haskell splices. If that function's definition makes use
  of type family instances which are not checked against those visible
  from M, type safety can again be compromised. See #13251.

* When a module C imports a boot module B.hs-boot, we check that C's
  type family instances are compatible with those visible from
  B.hs-boot. However, C will eventually be linked against a different
  module B.hs, which might define additional type family instances which
  are inconsistent with C's. This can also lead to loss of type safety.
  See #9562.

* The call to checkFamConsistency for imported functions occurs very
  early (in tcRnImports) and that causes problems if the imported
  instances use type declared in the module being compiled.
  See Note [Loading your own hi-boot file] in LoadIface.
-}</span><span>
</span><a name="line-143"></a><span>
</span><a name="line-144"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                 Making a FamInst
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-151"></a><span>
</span><a name="line-152"></a><span class="hs-comment">-- All type variables in a FamInst must be fresh. This function</span><span>
</span><a name="line-153"></a><span class="hs-comment">-- creates the fresh variables and applies the necessary substitution</span><span>
</span><a name="line-154"></a><span class="hs-comment">-- It is defined here to avoid a dependency from FamInstEnv on the monad</span><span>
</span><a name="line-155"></a><span class="hs-comment">-- code.</span><span>
</span><a name="line-156"></a><span>
</span><a name="line-157"></a><span class="hs-identifier">newFamInst</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FamFlavor</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoAxiom</span><span> </span><span class="hs-identifier hs-type">Unbranched</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">FamInst</span><span>
</span><a name="line-158"></a><span class="hs-comment">-- Freshen the type variables of the FamInst branches</span><span>
</span><a name="line-159"></a><a name="newFamInst"><a href="FamInst.html#newFamInst"><span class="hs-identifier">newFamInst</span></a></a><span> </span><a name="local-6989586621682473762"><a href="#local-6989586621682473762"><span class="hs-identifier">flavor</span></a></a><span> </span><a name="local-6989586621682473763"><a href="#local-6989586621682473763"><span class="hs-identifier">axiom</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoAxiom</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">co_ax_tc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682473764"><a href="#local-6989586621682473764"><span class="hs-identifier">fam_tc</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-160"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">tyCoVarsOfTypes</span><span> </span><span class="hs-identifier hs-var">lhs</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">subVarSet</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">tcv_set</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;lhs&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">pp_ax</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-161"></a><span>    </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">tyCoVarsOfType</span><span>  </span><span class="hs-identifier hs-var">rhs</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">subVarSet</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">tcv_set</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;rhs&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">pp_ax</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-162"></a><span>    </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">lhs_kind</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">rhs_kind</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;kind&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">pp_ax</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-identifier">lhs_kind</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">rhs_kind</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-163"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682473773"><a href="#local-6989586621682473773"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682473774"><a href="#local-6989586621682473774"><span class="hs-identifier">tvs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#freshenTyVarBndrs"><span class="hs-identifier hs-var">freshenTyVarBndrs</span></a><span> </span><a href="#local-6989586621682473769"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-164"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682473775"><a href="#local-6989586621682473775"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682473776"><a href="#local-6989586621682473776"><span class="hs-identifier">cvs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#freshenCoVarBndrsX"><span class="hs-identifier hs-var">freshenCoVarBndrsX</span></a><span> </span><a href="#local-6989586621682473773"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682473770"><span class="hs-identifier hs-var">cvs</span></a><span>
</span><a name="line-165"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682473777"><a href="#local-6989586621682473777"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-166"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682473778"><a href="#local-6989586621682473778"><span class="hs-identifier">lhs'</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTys</span><span> </span><a href="#local-6989586621682473775"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682473771"><span class="hs-identifier hs-var">lhs</span></a><span>
</span><a name="line-167"></a><span>             </span><a name="local-6989586621682473779"><a href="#local-6989586621682473779"><span class="hs-identifier">rhs'</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTy</span><span>  </span><a href="#local-6989586621682473775"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682473772"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-168"></a><span>             </span><a name="local-6989586621682473780"><a href="#local-6989586621682473780"><span class="hs-identifier">tcvs'</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682473774"><span class="hs-identifier hs-var">tvs'</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682473776"><span class="hs-identifier hs-var">cvs'</span></a><span>
</span><a name="line-169"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#ifErrsM"><span class="hs-identifier hs-var">ifErrsM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-comment">-- Don't lint when there are errors, because</span><span>
</span><a name="line-170"></a><span>                               </span><span class="hs-comment">-- errors might mean TcTyCons.</span><span>
</span><a name="line-171"></a><span>                               </span><span class="hs-comment">-- See Note [Recover from validity error] in TcTyClsDecls</span><span>
</span><a name="line-172"></a><span>         </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_DoCoreLinting</span><span> </span><a href="#local-6989586621682473777"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-173"></a><span>           </span><span class="hs-comment">-- Check that the types involved in this instance are well formed.</span><span>
</span><a name="line-174"></a><span>           </span><span class="hs-comment">-- Do /not/ expand type synonyms, for the reasons discussed in</span><span>
</span><a name="line-175"></a><span>           </span><span class="hs-comment">-- Note [Linting type synonym applications].</span><span>
</span><a name="line-176"></a><span>           </span><span class="hs-keyword">case</span><span> </span><a href="CoreLint.html#lintTypes"><span class="hs-identifier hs-var">lintTypes</span></a><span> </span><a href="#local-6989586621682473777"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682473780"><span class="hs-identifier hs-var">tcvs'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682473779"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-glyph">:</span><a href="#local-6989586621682473778"><span class="hs-identifier hs-var">lhs'</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-177"></a><span>             </span><span class="hs-identifier hs-var">Nothing</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-178"></a><span>             </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682473781"><a href="#local-6989586621682473781"><span class="hs-identifier">fail_msg</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;Core Lint error&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621682473781"><span class="hs-identifier hs-var">fail_msg</span></a><span>
</span><a name="line-179"></a><span>                                                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682473764"><span class="hs-identifier hs-var">fam_tc</span></a><span>
</span><a name="line-180"></a><span>                                                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682473775"><span class="hs-identifier hs-var">subst</span></a><span>
</span><a name="line-181"></a><span>                                                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682473774"><span class="hs-identifier hs-var">tvs'</span></a><span>
</span><a name="line-182"></a><span>                                                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682473776"><span class="hs-identifier hs-var">cvs'</span></a><span>
</span><a name="line-183"></a><span>                                                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682473778"><span class="hs-identifier hs-var">lhs'</span></a><span>
</span><a name="line-184"></a><span>                                                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682473779"><span class="hs-identifier hs-var">rhs'</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-185"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FamInst</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fi_fam</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621682473764"><span class="hs-identifier hs-var">fam_tc</span></a><span>
</span><a name="line-186"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fi_flavor</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682473762"><span class="hs-identifier hs-var">flavor</span></a><span>
</span><a name="line-187"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fi_tcs</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">roughMatchTcs</span><span> </span><a href="#local-6989586621682473771"><span class="hs-identifier hs-var">lhs</span></a><span>
</span><a name="line-188"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fi_tvs</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682473774"><span class="hs-identifier hs-var">tvs'</span></a><span>
</span><a name="line-189"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fi_cvs</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682473776"><span class="hs-identifier hs-var">cvs'</span></a><span>
</span><a name="line-190"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fi_tys</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682473778"><span class="hs-identifier hs-var">lhs'</span></a><span>
</span><a name="line-191"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fi_rhs</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682473779"><span class="hs-identifier hs-var">rhs'</span></a><span>
</span><a name="line-192"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fi_axiom</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682473763"><span class="hs-identifier hs-var">axiom</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-193"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-194"></a><span>    </span><a name="local-6989586621682473765"><a href="#local-6989586621682473765"><span class="hs-identifier">lhs_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcTypeKind</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621682473764"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="#local-6989586621682473771"><span class="hs-identifier hs-var">lhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-195"></a><span>    </span><a name="local-6989586621682473766"><a href="#local-6989586621682473766"><span class="hs-identifier">rhs_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcTypeKind</span><span> </span><a href="#local-6989586621682473772"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-196"></a><span>    </span><a name="local-6989586621682473767"><a href="#local-6989586621682473767"><span class="hs-identifier">tcv_set</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkVarSet</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682473769"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682473770"><span class="hs-identifier hs-var">cvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-197"></a><span>    </span><a name="local-6989586621682473768"><a href="#local-6989586621682473768"><span class="hs-identifier">pp_ax</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprCoAxiom</span><span> </span><a href="#local-6989586621682473763"><span class="hs-identifier hs-var">axiom</span></a><span>
</span><a name="line-198"></a><span>    </span><span class="hs-identifier hs-var">CoAxBranch</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cab_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682473769"><a href="#local-6989586621682473769"><span class="hs-identifier">tvs</span></a></a><span>
</span><a name="line-199"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_cvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682473770"><a href="#local-6989586621682473770"><span class="hs-identifier">cvs</span></a></a><span>
</span><a name="line-200"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682473771"><a href="#local-6989586621682473771"><span class="hs-identifier">lhs</span></a></a><span>
</span><a name="line-201"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682473772"><a href="#local-6989586621682473772"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">coAxiomSingleBranch</span><span> </span><a href="#local-6989586621682473763"><span class="hs-identifier hs-var">axiom</span></a><span>
</span><a name="line-202"></a><span>
</span><a name="line-203"></a><span>
</span><a name="line-204"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Optimised overlap checking for family instances
*                                                                      *
************************************************************************

Note [Checking family instance consistency]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For any two family instance modules that we import directly or indirectly, we
check whether the instances in the two modules are consistent, *unless* we can
be certain that the instances of the two modules have already been checked for
consistency during the compilation of modules that we import.

Why do we need to check?  Consider
   module X1 where                module X2 where
    data T1                         data T2
    type instance F T1 b = Int      type instance F a T2 = Char
    f1 :: F T1 a -&gt; Int             f2 :: Char -&gt; F a T2
    f1 x = x                        f2 x = x

Now if we import both X1 and X2 we could make (f2 . f1) :: Int -&gt; Char.
Notice that neither instance is an orphan.

How do we know which pairs of modules have already been checked? For each
module M we directly import, we look up the family instance modules that M
imports (directly or indirectly), say F1, ..., FN. For any two modules
among M, F1, ..., FN, we know that the family instances defined in those
two modules are consistent--because we checked that when we compiled M.

For every other pair of family instance modules we import (directly or
indirectly), we check that they are consistent now. (So that we can be
certain that the modules in our `HscTypes.dep_finsts' are consistent.)

There is some fancy footwork regarding hs-boot module loops, see
Note [Don't check hs-boot type family instances too early]

Note [Checking family instance optimization]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
As explained in Note [Checking family instance consistency]
we need to ensure that every pair of transitive imports that define type family
instances is consistent.

Let's define df(A) = transitive imports of A that define type family instances
+ A, if A defines type family instances

Then for every direct import A, df(A) is already consistent.

Let's name the current module M.

We want to make sure that df(M) is consistent.
df(M) = df(D_1) U df(D_2) U ... U df(D_i) where D_1 .. D_i are direct imports.

We perform the check iteratively, maintaining a set of consistent modules 'C'
and trying to add df(D_i) to it.

The key part is how to ensure that the union C U df(D_i) is consistent.

Let's consider two modules: A and B from C U df(D_i).
There are nine possible ways to choose A and B from C U df(D_i):

             | A in C only      | A in C and B in df(D_i) | A in df(D_i) only
--------------------------------------------------------------------------------
B in C only  | Already checked  | Already checked         | Needs to be checked
             | when checking C  | when checking C         |
--------------------------------------------------------------------------------
B in C and   | Already checked  | Already checked         | Already checked when
B in df(D_i) | when checking C  | when checking C         | checking df(D_i)
--------------------------------------------------------------------------------
B in df(D_i) | Needs to be      | Already checked         | Already checked when
only         | checked          | when checking df(D_i)   | checking df(D_i)

That means to ensure that C U df(D_i) is consistent we need to check every
module from C - df(D_i) against every module from df(D_i) - C and
every module from df(D_i) - C against every module from C - df(D_i).
But since the checks are symmetric it suffices to pick A from C - df(D_i)
and B from df(D_i) - C.

In other words these are the modules we need to check:
  [ (m1, m2) | m1 &lt;- C, m1 not in df(D_i)
             , m2 &lt;- df(D_i), m2 not in C ]

One final thing to note here is that if there's lot of overlap between
subsequent df(D_i)'s then we expect those set differences to be small.
That situation should be pretty common in practice, there's usually
a set of utility modules that every module imports directly or indirectly.

This is basically the idea from #13092, comment:14.
-}</span><span>
</span><a name="line-293"></a><span>
</span><a name="line-294"></a><span class="hs-comment">-- This function doesn't check ALL instances for consistency,</span><span>
</span><a name="line-295"></a><span class="hs-comment">-- only ones that aren't involved in recursive knot-tying</span><span>
</span><a name="line-296"></a><span class="hs-comment">-- loops; see Note [Don't check hs-boot type family instances too early].</span><span>
</span><a name="line-297"></a><span class="hs-comment">-- We don't need to check the current module, this is done in</span><span>
</span><a name="line-298"></a><span class="hs-comment">-- tcExtendLocalFamInstEnv.</span><span>
</span><a name="line-299"></a><span class="hs-comment">-- See Note [The type family instance consistency story].</span><span>
</span><a name="line-300"></a><span class="hs-identifier">checkFamInstConsistency</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Module</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-301"></a><a name="checkFamInstConsistency"><a href="FamInst.html#checkFamInstConsistency"><span class="hs-identifier">checkFamInstConsistency</span></a></a><span> </span><a name="local-6989586621682474081"><a href="#local-6989586621682474081"><span class="hs-identifier">directlyImpMods</span></a></a><span>
</span><a name="line-302"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682474110"><a href="#local-6989586621682474110"><span class="hs-identifier">dflags</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-303"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682474111"><a href="#local-6989586621682474111"><span class="hs-identifier">eps</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682474112"><a href="#local-6989586621682474112"><span class="hs-identifier">hpt</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getEpsAndHpt"><span class="hs-identifier hs-var">getEpsAndHpt</span></a><span>
</span><a name="line-304"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;checkFamInstConsistency&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682474081"><span class="hs-identifier hs-var">directlyImpMods</span></a><span class="hs-special">)</span><span>
</span><a name="line-305"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Fetch the iface of a given module.  Must succeed as</span><span>
</span><a name="line-306"></a><span>               </span><span class="hs-comment">-- all directly imported modules must already have been loaded.</span><span>
</span><a name="line-307"></a><span>               </span><a name="local-6989586621682474113"><a href="#local-6989586621682474113"><span class="hs-identifier">modIface</span></a></a><span> </span><a name="local-6989586621682474118"><a href="#local-6989586621682474118"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-308"></a><span>                 </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupIfaceByModule</span><span> </span><a href="#local-6989586621682474110"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682474112"><span class="hs-identifier hs-var">hpt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_PIT</span><span> </span><a href="#local-6989586621682474111"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682474118"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-309"></a><span>                   </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panicDoc</span><span> </span><span class="hs-string">&quot;FamInst.checkFamInstConsistency&quot;</span><span>
</span><a name="line-310"></a><span>                                          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682474118"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">pprHPT</span><span> </span><a href="#local-6989586621682474112"><span class="hs-identifier hs-var">hpt</span></a><span class="hs-special">)</span><span>
</span><a name="line-311"></a><span>                   </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682474119"><a href="#local-6989586621682474119"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682474119"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-312"></a><span>
</span><a name="line-313"></a><span>               </span><span class="hs-comment">-- Which family instance modules were checked for consistency</span><span>
</span><a name="line-314"></a><span>               </span><span class="hs-comment">-- when we compiled `mod`?</span><span>
</span><a name="line-315"></a><span>               </span><span class="hs-comment">-- Itself (if a family instance module) and its dep_finsts.</span><span>
</span><a name="line-316"></a><span>               </span><span class="hs-comment">-- This is df(D_i) from</span><span>
</span><a name="line-317"></a><span>               </span><span class="hs-comment">-- Note [Checking family instance optimization]</span><span>
</span><a name="line-318"></a><span>             </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">modConsistent</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Module</span><span class="hs-special">]</span><span>
</span><a name="line-319"></a><span>             </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682474114"><a href="#local-6989586621682474114"><span class="hs-identifier">modConsistent</span></a></a><span> </span><a name="local-6989586621682474120"><a href="#local-6989586621682474120"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-320"></a><span>                 </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">mi_finsts</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682474113"><span class="hs-identifier hs-var">modIface</span></a><span> </span><a href="#local-6989586621682474120"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621682474120"><span class="hs-identifier hs-var">mod</span></a><span class="hs-glyph">:</span><a href="#local-6989586621682474121"><span class="hs-identifier hs-var">deps</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621682474121"><span class="hs-identifier hs-var">deps</span></a><span>
</span><a name="line-321"></a><span>                 </span><span class="hs-keyword">where</span><span>
</span><a name="line-322"></a><span>                 </span><a name="local-6989586621682474121"><a href="#local-6989586621682474121"><span class="hs-identifier">deps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">dep_finsts</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">mi_deps</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621682474113"><span class="hs-identifier hs-var">modIface</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682474120"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-323"></a><span>
</span><a name="line-324"></a><span>             </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682474115"><a href="#local-6989586621682474115"><span class="hs-identifier">hmiModule</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_module</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">hm_iface</span><span>
</span><a name="line-325"></a><span>             </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682474116"><a href="#local-6989586621682474116"><span class="hs-identifier">hmiFamInstEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendFamInstEnvList</span><span> </span><span class="hs-identifier hs-var">emptyFamInstEnv</span><span>
</span><a name="line-326"></a><span>                               </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">md_fam_insts</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">hm_details</span><span>
</span><a name="line-327"></a><span>             </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682474117"><a href="#local-6989586621682474117"><span class="hs-identifier">hpt_fam_insts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkModuleEnv</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682474115"><span class="hs-identifier hs-var">hmiModule</span></a><span> </span><a href="#local-6989586621682474122"><span class="hs-identifier hs-var">hmi</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682474116"><span class="hs-identifier hs-var">hmiFamInstEnv</span></a><span> </span><a href="#local-6989586621682474122"><span class="hs-identifier hs-var">hmi</span></a><span class="hs-special">)</span><span>
</span><a name="line-328"></a><span>                                           </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621682474122"><a href="#local-6989586621682474122"><span class="hs-identifier">hmi</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">eltsHpt</span><span> </span><a href="#local-6989586621682474112"><span class="hs-identifier hs-var">hpt</span></a><span class="hs-special">]</span><span>
</span><a name="line-329"></a><span>
</span><a name="line-330"></a><span>             </span><span class="hs-special">}</span><span>
</span><a name="line-331"></a><span>
</span><a name="line-332"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621682474082"><span class="hs-identifier hs-var">checkMany</span></a><span> </span><a href="#local-6989586621682474117"><span class="hs-identifier hs-var">hpt_fam_insts</span></a><span> </span><a href="#local-6989586621682474114"><span class="hs-identifier hs-var">modConsistent</span></a><span> </span><a href="#local-6989586621682474081"><span class="hs-identifier hs-var">directlyImpMods</span></a><span>
</span><a name="line-333"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-334"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-335"></a><span>    </span><span class="hs-comment">-- See Note [Checking family instance optimization]</span><span>
</span><a name="line-336"></a><span>    </span><span class="hs-identifier">checkMany</span><span>
</span><a name="line-337"></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModuleEnv</span><span> </span><span class="hs-identifier hs-type">FamInstEnv</span><span>   </span><span class="hs-comment">-- home package family instances</span><span>
</span><a name="line-338"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Module</span><span class="hs-special">]</span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- given A, modules checked when A was checked</span><span>
</span><a name="line-339"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Module</span><span class="hs-special">]</span><span>               </span><span class="hs-comment">-- modules to process</span><span>
</span><a name="line-340"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-341"></a><span>    </span><a name="local-6989586621682474082"><a href="#local-6989586621682474082"><span class="hs-identifier">checkMany</span></a></a><span> </span><a name="local-6989586621682474084"><a href="#local-6989586621682474084"><span class="hs-identifier">hpt_fam_insts</span></a></a><span> </span><a name="local-6989586621682474085"><a href="#local-6989586621682474085"><span class="hs-identifier">modConsistent</span></a></a><span> </span><a name="local-6989586621682474086"><a href="#local-6989586621682474086"><span class="hs-identifier">mods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682474087"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">emptyModuleSet</span><span> </span><a href="#local-6989586621682474086"><span class="hs-identifier hs-var">mods</span></a><span>
</span><a name="line-342"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-343"></a><span>      </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Module</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- list of consistent modules</span><span>
</span><a name="line-344"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModuleSet</span><span> </span><span class="hs-comment">-- set of consistent modules, same elements as the</span><span>
</span><a name="line-345"></a><span>                      </span><span class="hs-comment">-- list above</span><span>
</span><a name="line-346"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Module</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- modules to process</span><span>
</span><a name="line-347"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-348"></a><span>      </span><a name="local-6989586621682474087"><a href="#local-6989586621682474087"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-349"></a><span>      </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682474088"><a href="#local-6989586621682474088"><span class="hs-identifier">consistent</span></a></a><span> </span><a name="local-6989586621682474089"><a href="#local-6989586621682474089"><span class="hs-identifier">consistent_set</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682474090"><a href="#local-6989586621682474090"><span class="hs-identifier">mod</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682474091"><a href="#local-6989586621682474091"><span class="hs-identifier">mods</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-350"></a><span>        </span><span class="hs-identifier hs-var">sequence_</span><span>
</span><a name="line-351"></a><span>          </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621682474083"><span class="hs-identifier hs-var">check</span></a><span> </span><a href="#local-6989586621682474084"><span class="hs-identifier hs-var">hpt_fam_insts</span></a><span> </span><a href="#local-6989586621682474098"><span class="hs-identifier hs-var">m1</span></a><span> </span><a href="#local-6989586621682474099"><span class="hs-identifier hs-var">m2</span></a><span>
</span><a name="line-352"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621682474098"><a href="#local-6989586621682474098"><span class="hs-identifier">m1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682474097"><span class="hs-identifier hs-var">to_check_from_mod</span></a><span>
</span><a name="line-353"></a><span>            </span><span class="hs-comment">-- loop over toCheckFromMod first, it's usually smaller,</span><span>
</span><a name="line-354"></a><span>            </span><span class="hs-comment">-- it may even be empty</span><span>
</span><a name="line-355"></a><span>          </span><span class="hs-special">,</span><span> </span><a name="local-6989586621682474099"><a href="#local-6989586621682474099"><span class="hs-identifier">m2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682474096"><span class="hs-identifier hs-var">to_check_from_consistent</span></a><span>
</span><a name="line-356"></a><span>          </span><span class="hs-special">]</span><span>
</span><a name="line-357"></a><span>        </span><a href="#local-6989586621682474087"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682474094"><span class="hs-identifier hs-var">consistent'</span></a><span> </span><a href="#local-6989586621682474095"><span class="hs-identifier hs-var">consistent_set'</span></a><span> </span><a href="#local-6989586621682474091"><span class="hs-identifier hs-var">mods</span></a><span>
</span><a name="line-358"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-359"></a><span>        </span><a name="local-6989586621682474092"><a href="#local-6989586621682474092"><span class="hs-identifier">mod_deps_consistent</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><a href="#local-6989586621682474085"><span class="hs-identifier hs-var">modConsistent</span></a><span> </span><a href="#local-6989586621682474090"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-360"></a><span>        </span><a name="local-6989586621682474093"><a href="#local-6989586621682474093"><span class="hs-identifier">mod_deps_consistent_set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkModuleSet</span><span> </span><a href="#local-6989586621682474092"><span class="hs-identifier hs-var">mod_deps_consistent</span></a><span>
</span><a name="line-361"></a><span>        </span><a name="local-6989586621682474094"><a href="#local-6989586621682474094"><span class="hs-identifier">consistent'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682474097"><span class="hs-identifier hs-var">to_check_from_mod</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682474088"><span class="hs-identifier hs-var">consistent</span></a><span>
</span><a name="line-362"></a><span>        </span><a name="local-6989586621682474095"><a href="#local-6989586621682474095"><span class="hs-identifier">consistent_set'</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-363"></a><span>          </span><span class="hs-identifier hs-var">extendModuleSetList</span><span> </span><a href="#local-6989586621682474089"><span class="hs-identifier hs-var">consistent_set</span></a><span> </span><a href="#local-6989586621682474097"><span class="hs-identifier hs-var">to_check_from_mod</span></a><span>
</span><a name="line-364"></a><span>        </span><a name="local-6989586621682474096"><a href="#local-6989586621682474096"><span class="hs-identifier">to_check_from_consistent</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-365"></a><span>          </span><span class="hs-identifier hs-var">filterOut</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemModuleSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682474093"><span class="hs-identifier hs-var">mod_deps_consistent_set</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682474088"><span class="hs-identifier hs-var">consistent</span></a><span>
</span><a name="line-366"></a><span>        </span><a name="local-6989586621682474097"><a href="#local-6989586621682474097"><span class="hs-identifier">to_check_from_mod</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-367"></a><span>          </span><span class="hs-identifier hs-var">filterOut</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemModuleSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682474089"><span class="hs-identifier hs-var">consistent_set</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682474092"><span class="hs-identifier hs-var">mod_deps_consistent</span></a><span>
</span><a name="line-368"></a><span>        </span><span class="hs-comment">-- Why don't we just minusModuleSet here?</span><span>
</span><a name="line-369"></a><span>        </span><span class="hs-comment">-- We could, but doing so means one of two things:</span><span>
</span><a name="line-370"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-371"></a><span>        </span><span class="hs-comment">--   1. When looping over the cartesian product we convert</span><span>
</span><a name="line-372"></a><span>        </span><span class="hs-comment">--   a set into a non-deterministicly ordered list. Which</span><span>
</span><a name="line-373"></a><span>        </span><span class="hs-comment">--   happens to be fine for interface file determinism</span><span>
</span><a name="line-374"></a><span>        </span><span class="hs-comment">--   in this case, today, because the order only</span><span>
</span><a name="line-375"></a><span>        </span><span class="hs-comment">--   determines the order of deferred checks. But such</span><span>
</span><a name="line-376"></a><span>        </span><span class="hs-comment">--   invariants are hard to keep.</span><span>
</span><a name="line-377"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-378"></a><span>        </span><span class="hs-comment">--   2. When looping over the cartesian product we convert</span><span>
</span><a name="line-379"></a><span>        </span><span class="hs-comment">--   a set into a deterministically ordered list - this</span><span>
</span><a name="line-380"></a><span>        </span><span class="hs-comment">--   adds some additional cost of sorting for every</span><span>
</span><a name="line-381"></a><span>        </span><span class="hs-comment">--   direct import.</span><span>
</span><a name="line-382"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-383"></a><span>        </span><span class="hs-comment">--   That also explains why we need to keep both 'consistent'</span><span>
</span><a name="line-384"></a><span>        </span><span class="hs-comment">--   and 'consistentSet'.</span><span>
</span><a name="line-385"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-386"></a><span>        </span><span class="hs-comment">--   See also Note [ModuleEnv performance and determinism].</span><span>
</span><a name="line-387"></a><span>    </span><a name="local-6989586621682474083"><a href="#local-6989586621682474083"><span class="hs-identifier">check</span></a></a><span> </span><a name="local-6989586621682474100"><a href="#local-6989586621682474100"><span class="hs-identifier">hpt_fam_insts</span></a></a><span> </span><a name="local-6989586621682474101"><a href="#local-6989586621682474101"><span class="hs-identifier">m1</span></a></a><span> </span><a name="local-6989586621682474102"><a href="#local-6989586621682474102"><span class="hs-identifier">m2</span></a></a><span>
</span><a name="line-388"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682474103"><a href="#local-6989586621682474103"><span class="hs-identifier">env1'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#getFamInsts"><span class="hs-identifier hs-var">getFamInsts</span></a><span> </span><a href="#local-6989586621682474100"><span class="hs-identifier hs-var">hpt_fam_insts</span></a><span> </span><a href="#local-6989586621682474101"><span class="hs-identifier hs-var">m1</span></a><span>
</span><a name="line-389"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682474104"><a href="#local-6989586621682474104"><span class="hs-identifier">env2'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#getFamInsts"><span class="hs-identifier hs-var">getFamInsts</span></a><span> </span><a href="#local-6989586621682474100"><span class="hs-identifier hs-var">hpt_fam_insts</span></a><span> </span><a href="#local-6989586621682474102"><span class="hs-identifier hs-var">m2</span></a><span>
</span><a name="line-390"></a><span>           </span><span class="hs-comment">-- We're checking each element of env1 against env2.</span><span>
</span><a name="line-391"></a><span>           </span><span class="hs-comment">-- The cost of that is dominated by the size of env1, because</span><span>
</span><a name="line-392"></a><span>           </span><span class="hs-comment">-- for each instance in env1 we look it up in the type family</span><span>
</span><a name="line-393"></a><span>           </span><span class="hs-comment">-- environment env2, and lookup is cheap.</span><span>
</span><a name="line-394"></a><span>           </span><span class="hs-comment">-- The code below ensures that env1 is the smaller environment.</span><span>
</span><a name="line-395"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682474105"><a href="#local-6989586621682474105"><span class="hs-identifier">sizeE1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">famInstEnvSize</span><span> </span><a href="#local-6989586621682474103"><span class="hs-identifier hs-var">env1'</span></a><span>
</span><a name="line-396"></a><span>                 </span><a name="local-6989586621682474106"><a href="#local-6989586621682474106"><span class="hs-identifier">sizeE2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">famInstEnvSize</span><span> </span><a href="#local-6989586621682474104"><span class="hs-identifier hs-var">env2'</span></a><span>
</span><a name="line-397"></a><span>                 </span><span class="hs-special">(</span><a name="local-6989586621682474107"><a href="#local-6989586621682474107"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682474108"><a href="#local-6989586621682474108"><span class="hs-identifier">env2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682474105"><span class="hs-identifier hs-var">sizeE1</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621682474106"><span class="hs-identifier hs-var">sizeE2</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682474103"><span class="hs-identifier hs-var">env1'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682474104"><span class="hs-identifier hs-var">env2'</span></a><span class="hs-special">)</span><span>
</span><a name="line-398"></a><span>                                                   </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682474104"><span class="hs-identifier hs-var">env2'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682474103"><span class="hs-identifier hs-var">env1'</span></a><span class="hs-special">)</span><span>
</span><a name="line-399"></a><span>           </span><span class="hs-comment">-- Note [Don't check hs-boot type family instances too early]</span><span>
</span><a name="line-400"></a><span>           </span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-401"></a><span>           </span><span class="hs-comment">-- Family instance consistency checking involves checking that</span><span>
</span><a name="line-402"></a><span>           </span><span class="hs-comment">-- the family instances of our imported modules are consistent with</span><span>
</span><a name="line-403"></a><span>           </span><span class="hs-comment">-- one another; this might lead you to think that this process</span><span>
</span><a name="line-404"></a><span>           </span><span class="hs-comment">-- has nothing to do with the module we are about to typecheck.</span><span>
</span><a name="line-405"></a><span>           </span><span class="hs-comment">-- Not so!  Consider the following case:</span><span>
</span><a name="line-406"></a><span>           </span><span class="hs-comment">--</span><span>
</span><a name="line-407"></a><span>           </span><span class="hs-comment">--   -- A.hs-boot</span><span>
</span><a name="line-408"></a><span>           </span><span class="hs-comment">--   type family F a</span><span>
</span><a name="line-409"></a><span>           </span><span class="hs-comment">--</span><span>
</span><a name="line-410"></a><span>           </span><span class="hs-comment">--   -- B.hs</span><span>
</span><a name="line-411"></a><span>           </span><span class="hs-comment">--   import {-# SOURCE #-} A</span><span>
</span><a name="line-412"></a><span>           </span><span class="hs-comment">--   type instance F Int = Bool</span><span>
</span><a name="line-413"></a><span>           </span><span class="hs-comment">--</span><span>
</span><a name="line-414"></a><span>           </span><span class="hs-comment">--   -- A.hs</span><span>
</span><a name="line-415"></a><span>           </span><span class="hs-comment">--   import B</span><span>
</span><a name="line-416"></a><span>           </span><span class="hs-comment">--   type family F a</span><span>
</span><a name="line-417"></a><span>           </span><span class="hs-comment">--</span><span>
</span><a name="line-418"></a><span>           </span><span class="hs-comment">-- When typechecking A, we are NOT allowed to poke the TyThing</span><span>
</span><a name="line-419"></a><span>           </span><span class="hs-comment">-- for F until we have typechecked the family.  Thus, we</span><span>
</span><a name="line-420"></a><span>           </span><span class="hs-comment">-- can't do consistency checking for the instance in B</span><span>
</span><a name="line-421"></a><span>           </span><span class="hs-comment">-- (checkFamInstConsistency is called during renaming).</span><span>
</span><a name="line-422"></a><span>           </span><span class="hs-comment">-- Failing to defer the consistency check lead to #11062.</span><span>
</span><a name="line-423"></a><span>           </span><span class="hs-comment">--</span><span>
</span><a name="line-424"></a><span>           </span><span class="hs-comment">-- Additionally, we should also defer consistency checking when</span><span>
</span><a name="line-425"></a><span>           </span><span class="hs-comment">-- type from the hs-boot file of the current module occurs on</span><span>
</span><a name="line-426"></a><span>           </span><span class="hs-comment">-- the left hand side, as we will poke its TyThing when checking</span><span>
</span><a name="line-427"></a><span>           </span><span class="hs-comment">-- for overlap.</span><span>
</span><a name="line-428"></a><span>           </span><span class="hs-comment">--</span><span>
</span><a name="line-429"></a><span>           </span><span class="hs-comment">--   -- F.hs</span><span>
</span><a name="line-430"></a><span>           </span><span class="hs-comment">--   type family F a</span><span>
</span><a name="line-431"></a><span>           </span><span class="hs-comment">--</span><span>
</span><a name="line-432"></a><span>           </span><span class="hs-comment">--   -- A.hs-boot</span><span>
</span><a name="line-433"></a><span>           </span><span class="hs-comment">--   import F</span><span>
</span><a name="line-434"></a><span>           </span><span class="hs-comment">--   data T</span><span>
</span><a name="line-435"></a><span>           </span><span class="hs-comment">--</span><span>
</span><a name="line-436"></a><span>           </span><span class="hs-comment">--   -- B.hs</span><span>
</span><a name="line-437"></a><span>           </span><span class="hs-comment">--   import {-# SOURCE #-} A</span><span>
</span><a name="line-438"></a><span>           </span><span class="hs-comment">--   import F</span><span>
</span><a name="line-439"></a><span>           </span><span class="hs-comment">--   type instance F T = Int</span><span>
</span><a name="line-440"></a><span>           </span><span class="hs-comment">--</span><span>
</span><a name="line-441"></a><span>           </span><span class="hs-comment">--   -- A.hs</span><span>
</span><a name="line-442"></a><span>           </span><span class="hs-comment">--   import B</span><span>
</span><a name="line-443"></a><span>           </span><span class="hs-comment">--   data T = MkT</span><span>
</span><a name="line-444"></a><span>           </span><span class="hs-comment">--</span><span>
</span><a name="line-445"></a><span>           </span><span class="hs-comment">-- In fact, it is even necessary to defer for occurrences in</span><span>
</span><a name="line-446"></a><span>           </span><span class="hs-comment">-- the RHS, because we may test for *compatibility* in event</span><span>
</span><a name="line-447"></a><span>           </span><span class="hs-comment">-- of an overlap.</span><span>
</span><a name="line-448"></a><span>           </span><span class="hs-comment">--</span><span>
</span><a name="line-449"></a><span>           </span><span class="hs-comment">-- Why don't we defer ALL of the checks to later?  Well, many</span><span>
</span><a name="line-450"></a><span>           </span><span class="hs-comment">-- instances aren't involved in the recursive loop at all.  So</span><span>
</span><a name="line-451"></a><span>           </span><span class="hs-comment">-- we might as well check them immediately; and there isn't</span><span>
</span><a name="line-452"></a><span>           </span><span class="hs-comment">-- a good time to check them later in any case: every time</span><span>
</span><a name="line-453"></a><span>           </span><span class="hs-comment">-- we finish kind-checking a type declaration and add it to</span><span>
</span><a name="line-454"></a><span>           </span><span class="hs-comment">-- a context, we *then* consistency check all of the instances</span><span>
</span><a name="line-455"></a><span>           </span><span class="hs-comment">-- which mentioned that type.  We DO want to check instances</span><span>
</span><a name="line-456"></a><span>           </span><span class="hs-comment">-- as quickly as possible, so that we aren't typechecking</span><span>
</span><a name="line-457"></a><span>           </span><span class="hs-comment">-- values with inconsistent axioms in scope.</span><span>
</span><a name="line-458"></a><span>           </span><span class="hs-comment">--</span><span>
</span><a name="line-459"></a><span>           </span><span class="hs-comment">-- See also Note [Tying the knot]</span><span>
</span><a name="line-460"></a><span>           </span><span class="hs-comment">-- for why we are doing this at all.</span><span>
</span><a name="line-461"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682474109"><a href="#local-6989586621682474109"><span class="hs-identifier">check_now</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">famInstEnvElts</span><span> </span><a href="#local-6989586621682474107"><span class="hs-identifier hs-var">env1</span></a><span>
</span><a name="line-462"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="FamInst.html#checkForConflicts"><span class="hs-identifier hs-var">checkForConflicts</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">emptyFamInstEnv</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682474108"><span class="hs-identifier hs-var">env2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>           </span><a href="#local-6989586621682474109"><span class="hs-identifier hs-var">check_now</span></a><span>
</span><a name="line-463"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="FamInst.html#checkForInjectivityConflicts"><span class="hs-identifier hs-var">checkForInjectivityConflicts</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">emptyFamInstEnv</span><span class="hs-special">,</span><a href="#local-6989586621682474108"><span class="hs-identifier hs-var">env2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682474109"><span class="hs-identifier hs-var">check_now</span></a><span>
</span><a name="line-464"></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-465"></a><span>
</span><a name="line-466"></a><span class="hs-identifier">getFamInsts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModuleEnv</span><span> </span><span class="hs-identifier hs-type">FamInstEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">FamInstEnv</span><span>
</span><a name="line-467"></a><a name="getFamInsts"><a href="FamInst.html#getFamInsts"><span class="hs-identifier">getFamInsts</span></a></a><span> </span><a name="local-6989586621682474123"><a href="#local-6989586621682474123"><span class="hs-identifier">hpt_fam_insts</span></a></a><span> </span><a name="local-6989586621682474124"><a href="#local-6989586621682474124"><span class="hs-identifier">mod</span></a></a><span>
</span><a name="line-468"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682474126"><a href="#local-6989586621682474126"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupModuleEnv</span><span> </span><a href="#local-6989586621682474123"><span class="hs-identifier hs-var">hpt_fam_insts</span></a><span> </span><a href="#local-6989586621682474124"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682474126"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-469"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#initIfaceTcRn"><span class="hs-identifier hs-var">initIfaceTcRn</span></a><span> </span><span class="hs-special">(</span><a href="LoadIface.html#loadSysInterface"><span class="hs-identifier hs-var">loadSysInterface</span></a><span> </span><a href="#local-6989586621682474125"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621682474124"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-470"></a><span>                   </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682474127"><a href="#local-6989586621682474127"><span class="hs-identifier">eps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getEps"><span class="hs-identifier hs-var">getEps</span></a><span>
</span><a name="line-471"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">expectJust</span><span> </span><span class="hs-string">&quot;checkFamInstConsistency&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-472"></a><span>                             </span><span class="hs-identifier hs-var">lookupModuleEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_mod_fam_inst_env</span><span> </span><a href="#local-6989586621682474127"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682474124"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-473"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-474"></a><span>    </span><a name="local-6989586621682474125"><a href="#local-6989586621682474125"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682474124"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is a family-instance module&quot;</span><span>
</span><a name="line-475"></a><span>
</span><a name="line-476"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Lookup
*                                                                      *
************************************************************************

-}</span><span>
</span><a name="line-484"></a><span>
</span><a name="line-485"></a><span class="hs-comment">-- | If @co :: T ts ~ rep_ty@ then:</span><span>
</span><a name="line-486"></a><span class="hs-comment">--</span><span>
</span><a name="line-487"></a><span class="hs-comment">-- &gt; instNewTyCon_maybe T ts = Just (rep_ty, co)</span><span>
</span><a name="line-488"></a><span class="hs-comment">--</span><span>
</span><a name="line-489"></a><span class="hs-comment">-- Checks for a newtype, and for being saturated</span><span>
</span><a name="line-490"></a><span class="hs-comment">-- Just like Coercion.instNewTyCon_maybe, but returns a TcCoercion</span><span>
</span><a name="line-491"></a><span class="hs-identifier">tcInstNewTyCon_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcCoercion</span><span class="hs-special">)</span><span>
</span><a name="line-492"></a><a name="tcInstNewTyCon_maybe"><a href="FamInst.html#tcInstNewTyCon_maybe"><span class="hs-identifier">tcInstNewTyCon_maybe</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">instNewTyCon_maybe</span><span>
</span><a name="line-493"></a><span>
</span><a name="line-494"></a><span class="hs-comment">-- | Like 'tcLookupDataFamInst_maybe', but returns the arguments back if</span><span>
</span><a name="line-495"></a><span class="hs-comment">-- there is no data family to unwrap.</span><span>
</span><a name="line-496"></a><span class="hs-comment">-- Returns a Representational coercion</span><span>
</span><a name="line-497"></a><span class="hs-identifier">tcLookupDataFamInst</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FamInstEnvs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span>
</span><a name="line-498"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TyCon</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Coercion</span><span class="hs-special">)</span><span>
</span><a name="line-499"></a><a name="tcLookupDataFamInst"><a href="FamInst.html#tcLookupDataFamInst"><span class="hs-identifier">tcLookupDataFamInst</span></a></a><span> </span><a name="local-6989586621682474128"><a href="#local-6989586621682474128"><span class="hs-identifier">fam_inst_envs</span></a></a><span> </span><a name="local-6989586621682474129"><a href="#local-6989586621682474129"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682474130"><a href="#local-6989586621682474130"><span class="hs-identifier">tc_args</span></a></a><span>
</span><a name="line-500"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682474131"><a href="#local-6989586621682474131"><span class="hs-identifier">rep_tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682474132"><a href="#local-6989586621682474132"><span class="hs-identifier">rep_args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682474133"><a href="#local-6989586621682474133"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-501"></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#tcLookupDataFamInst_maybe"><span class="hs-identifier hs-var">tcLookupDataFamInst_maybe</span></a><span> </span><a href="#local-6989586621682474128"><span class="hs-identifier hs-var">fam_inst_envs</span></a><span> </span><a href="#local-6989586621682474129"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682474130"><span class="hs-identifier hs-var">tc_args</span></a><span>
</span><a name="line-502"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682474131"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682474132"><span class="hs-identifier hs-var">rep_args</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682474133"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-503"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-504"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682474129"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682474130"><span class="hs-identifier hs-var">tc_args</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkRepReflCo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621682474129"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682474130"><span class="hs-identifier hs-var">tc_args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-505"></a><span>
</span><a name="line-506"></a><span class="hs-identifier">tcLookupDataFamInst_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FamInstEnvs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span>
</span><a name="line-507"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TyCon</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Coercion</span><span class="hs-special">)</span><span>
</span><a name="line-508"></a><span class="hs-comment">-- ^ Converts a data family type (eg F [a]) to its representation type (eg FList a)</span><span>
</span><a name="line-509"></a><span class="hs-comment">-- and returns a coercion between the two: co :: F [a] ~R FList a.</span><span>
</span><a name="line-510"></a><a name="tcLookupDataFamInst_maybe"><a href="FamInst.html#tcLookupDataFamInst_maybe"><span class="hs-identifier">tcLookupDataFamInst_maybe</span></a></a><span> </span><a name="local-6989586621682474134"><a href="#local-6989586621682474134"><span class="hs-identifier">fam_inst_envs</span></a></a><span> </span><a name="local-6989586621682474135"><a href="#local-6989586621682474135"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682474136"><a href="#local-6989586621682474136"><span class="hs-identifier">tc_args</span></a></a><span>
</span><a name="line-511"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isDataFamilyTyCon</span><span> </span><a href="#local-6989586621682474135"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-512"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="local-6989586621682474137"><a href="#local-6989586621682474137"><span class="hs-identifier">match</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupFamInstEnv</span><span> </span><a href="#local-6989586621682474134"><span class="hs-identifier hs-var">fam_inst_envs</span></a><span> </span><a href="#local-6989586621682474135"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682474136"><span class="hs-identifier hs-var">tc_args</span></a><span>
</span><a name="line-513"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">FamInstMatch</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fim_instance</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682474138"><a href="#local-6989586621682474138"><span class="hs-identifier">rep_fam</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">FamInst</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fi_axiom</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682474139"><a href="#local-6989586621682474139"><span class="hs-identifier">ax</span></a></a><span>
</span><a name="line-514"></a><span>                                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fi_cvs</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682474140"><a href="#local-6989586621682474140"><span class="hs-identifier">cvs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-515"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fim_tys</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682474141"><a href="#local-6989586621682474141"><span class="hs-identifier">rep_args</span></a></a><span>
</span><a name="line-516"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fim_cos</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682474142"><a href="#local-6989586621682474142"><span class="hs-identifier">rep_cos</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682474137"><span class="hs-identifier hs-var">match</span></a><span>
</span><a name="line-517"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682474143"><a href="#local-6989586621682474143"><span class="hs-identifier">rep_tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataFamInstRepTyCon</span><span> </span><a href="#local-6989586621682474138"><span class="hs-identifier hs-var">rep_fam</span></a><span>
</span><a name="line-518"></a><span>        </span><a name="local-6989586621682474144"><a href="#local-6989586621682474144"><span class="hs-identifier">co</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkUnbranchedAxInstCo</span><span> </span><span class="hs-identifier hs-var">Representational</span><span> </span><a href="#local-6989586621682474139"><span class="hs-identifier hs-var">ax</span></a><span> </span><a href="#local-6989586621682474141"><span class="hs-identifier hs-var">rep_args</span></a><span>
</span><a name="line-519"></a><span>                                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCoVarCos</span><span> </span><a href="#local-6989586621682474140"><span class="hs-identifier hs-var">cvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-520"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-identifier">rep_cos</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- See Note [Constrained family instances] in FamInstEnv</span><span>
</span><a name="line-521"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682474143"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682474141"><span class="hs-identifier hs-var">rep_args</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682474144"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-522"></a><span>
</span><a name="line-523"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-524"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-525"></a><span>
</span><a name="line-526"></a><span class="hs-comment">-- | 'tcTopNormaliseNewTypeTF_maybe' gets rid of top-level newtypes,</span><span>
</span><a name="line-527"></a><span class="hs-comment">-- potentially looking through newtype /instances/.</span><span>
</span><a name="line-528"></a><span class="hs-comment">--</span><span>
</span><a name="line-529"></a><span class="hs-comment">-- It is only used by the type inference engine (specifically, when</span><span>
</span><a name="line-530"></a><span class="hs-comment">-- solving representational equality), and hence it is careful to unwrap</span><span>
</span><a name="line-531"></a><span class="hs-comment">-- only if the relevant data constructor is in scope.  That's why</span><span>
</span><a name="line-532"></a><span class="hs-comment">-- it get a GlobalRdrEnv argument.</span><span>
</span><a name="line-533"></a><span class="hs-comment">--</span><span>
</span><a name="line-534"></a><span class="hs-comment">-- It is careful not to unwrap data/newtype instances if it can't</span><span>
</span><a name="line-535"></a><span class="hs-comment">-- continue unwrapping.  Such care is necessary for proper error</span><span>
</span><a name="line-536"></a><span class="hs-comment">-- messages.</span><span>
</span><a name="line-537"></a><span class="hs-comment">--</span><span>
</span><a name="line-538"></a><span class="hs-comment">-- It does not look through type families.</span><span>
</span><a name="line-539"></a><span class="hs-comment">-- It does not normalise arguments to a tycon.</span><span>
</span><a name="line-540"></a><span class="hs-comment">--</span><span>
</span><a name="line-541"></a><span class="hs-comment">-- If the result is Just (rep_ty, (co, gres), rep_ty), then</span><span>
</span><a name="line-542"></a><span class="hs-comment">--    co : ty ~R rep_ty</span><span>
</span><a name="line-543"></a><span class="hs-comment">--    gres are the GREs for the data constructors that</span><span>
</span><a name="line-544"></a><span class="hs-comment">--                          had to be in scope</span><span>
</span><a name="line-545"></a><span class="hs-identifier">tcTopNormaliseNewTypeTF_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FamInstEnvs</span><span>
</span><a name="line-546"></a><span>                              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">GlobalRdrEnv</span><span>
</span><a name="line-547"></a><span>                              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-548"></a><span>                              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bag</span><span> </span><span class="hs-identifier hs-type">GlobalRdrElt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcCoercion</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span>
</span><a name="line-549"></a><a name="tcTopNormaliseNewTypeTF_maybe"><a href="FamInst.html#tcTopNormaliseNewTypeTF_maybe"><span class="hs-identifier">tcTopNormaliseNewTypeTF_maybe</span></a></a><span> </span><a name="local-6989586621682474145"><a href="#local-6989586621682474145"><span class="hs-identifier">faminsts</span></a></a><span> </span><a name="local-6989586621682474146"><a href="#local-6989586621682474146"><span class="hs-identifier">rdr_env</span></a></a><span> </span><a name="local-6989586621682474147"><a href="#local-6989586621682474147"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-550"></a><span class="hs-comment">-- cf. FamInstEnv.topNormaliseType_maybe and Coercion.topNormaliseNewType_maybe</span><span>
</span><a name="line-551"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">topNormaliseTypeX</span><span> </span><a href="#local-6989586621682474149"><span class="hs-identifier hs-var">stepper</span></a><span> </span><a href="#local-6989586621682474148"><span class="hs-identifier hs-var">plus</span></a><span> </span><a href="#local-6989586621682474147"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-552"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-553"></a><span>    </span><span class="hs-identifier">plus</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bag</span><span> </span><span class="hs-identifier hs-type">GlobalRdrElt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcCoercion</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bag</span><span> </span><span class="hs-identifier hs-type">GlobalRdrElt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcCoercion</span><span class="hs-special">)</span><span>
</span><a name="line-554"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bag</span><span> </span><span class="hs-identifier hs-type">GlobalRdrElt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcCoercion</span><span class="hs-special">)</span><span>
</span><a name="line-555"></a><span>    </span><a name="local-6989586621682474148"><a href="#local-6989586621682474148"><span class="hs-identifier">plus</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682474152"><a href="#local-6989586621682474152"><span class="hs-identifier">gres1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682474153"><a href="#local-6989586621682474153"><span class="hs-identifier">co1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682474154"><a href="#local-6989586621682474154"><span class="hs-identifier">gres2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682474155"><a href="#local-6989586621682474155"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621682474152"><span class="hs-identifier hs-var">gres1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionBags</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682474154"><span class="hs-identifier hs-var">gres2</span></a><span>
</span><a name="line-556"></a><span>                                     </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682474153"><span class="hs-identifier hs-var">co1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkTransCo</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682474155"><span class="hs-identifier hs-var">co2</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-557"></a><span>
</span><a name="line-558"></a><span>    </span><span class="hs-identifier">stepper</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NormaliseStepper</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bag</span><span> </span><span class="hs-identifier hs-type">GlobalRdrElt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcCoercion</span><span class="hs-special">)</span><span>
</span><a name="line-559"></a><span>    </span><a name="local-6989586621682474149"><a href="#local-6989586621682474149"><span class="hs-identifier">stepper</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682474151"><span class="hs-identifier hs-var">unwrap_newtype</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">composeSteppers</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682474150"><span class="hs-identifier hs-var">unwrap_newtype_instance</span></a><span>
</span><a name="line-560"></a><span>
</span><a name="line-561"></a><span>    </span><span class="hs-comment">-- For newtype instances we take a double step or nothing, so that</span><span>
</span><a name="line-562"></a><span>    </span><span class="hs-comment">-- we don't return the representation type of the newtype instance,</span><span>
</span><a name="line-563"></a><span>    </span><span class="hs-comment">-- which would lead to terrible error messages</span><span>
</span><a name="line-564"></a><span>    </span><a name="local-6989586621682474150"><a href="#local-6989586621682474150"><span class="hs-identifier">unwrap_newtype_instance</span></a></a><span> </span><a name="local-6989586621682474156"><a href="#local-6989586621682474156"><span class="hs-identifier">rec_nts</span></a></a><span> </span><a name="local-6989586621682474157"><a href="#local-6989586621682474157"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682474158"><a href="#local-6989586621682474158"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-565"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682474159"><a href="#local-6989586621682474159"><span class="hs-identifier">tc'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682474160"><a href="#local-6989586621682474160"><span class="hs-identifier">tys'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682474161"><a href="#local-6989586621682474161"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#tcLookupDataFamInst_maybe"><span class="hs-identifier hs-var">tcLookupDataFamInst_maybe</span></a><span> </span><a href="#local-6989586621682474145"><span class="hs-identifier hs-var">faminsts</span></a><span> </span><a href="#local-6989586621682474157"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682474158"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-566"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapStepResult</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621682474162"><a href="#local-6989586621682474162"><span class="hs-identifier">gres</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682474163"><a href="#local-6989586621682474163"><span class="hs-identifier">co1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682474162"><span class="hs-identifier hs-var">gres</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682474161"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkTransCo</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682474163"><span class="hs-identifier hs-var">co1</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-567"></a><span>        </span><a href="#local-6989586621682474151"><span class="hs-identifier hs-var">unwrap_newtype</span></a><span> </span><a href="#local-6989586621682474156"><span class="hs-identifier hs-var">rec_nts</span></a><span> </span><a href="#local-6989586621682474159"><span class="hs-identifier hs-var">tc'</span></a><span> </span><a href="#local-6989586621682474160"><span class="hs-identifier hs-var">tys'</span></a><span>
</span><a name="line-568"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NS_Done</span><span>
</span><a name="line-569"></a><span>
</span><a name="line-570"></a><span>    </span><a name="local-6989586621682474151"><a href="#local-6989586621682474151"><span class="hs-identifier">unwrap_newtype</span></a></a><span> </span><a name="local-6989586621682474164"><a href="#local-6989586621682474164"><span class="hs-identifier">rec_nts</span></a></a><span> </span><a name="local-6989586621682474165"><a href="#local-6989586621682474165"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682474166"><a href="#local-6989586621682474166"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-571"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682474167"><a href="#local-6989586621682474167"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newTyConDataCon_maybe</span><span> </span><a href="#local-6989586621682474165"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-572"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682474168"><a href="#local-6989586621682474168"><span class="hs-identifier">gre</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupGRE_Name</span><span> </span><a href="#local-6989586621682474146"><span class="hs-identifier hs-var">rdr_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConName</span><span> </span><a href="#local-6989586621682474167"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-573"></a><span>           </span><span class="hs-comment">-- This is where we check that the</span><span>
</span><a name="line-574"></a><span>           </span><span class="hs-comment">-- data constructor is in scope</span><span>
</span><a name="line-575"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapStepResult</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682474169"><a href="#local-6989586621682474169"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitBag</span><span> </span><a href="#local-6989586621682474168"><span class="hs-identifier hs-var">gre</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682474169"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-576"></a><span>        </span><span class="hs-identifier hs-var">unwrapNewTypeStepper</span><span> </span><a href="#local-6989586621682474164"><span class="hs-identifier hs-var">rec_nts</span></a><span> </span><a href="#local-6989586621682474165"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682474166"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-577"></a><span>
</span><a name="line-578"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-579"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NS_Done</span><span>
</span><a name="line-580"></a><span>
</span><a name="line-581"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Extending the family instance environment
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-588"></a><span>
</span><a name="line-589"></a><span class="hs-comment">-- Add new locally-defined family instances, checking consistency with</span><span>
</span><a name="line-590"></a><span class="hs-comment">-- previous locally-defined family instances as well as all instances</span><span>
</span><a name="line-591"></a><span class="hs-comment">-- available from imported modules. This requires loading all of our</span><span>
</span><a name="line-592"></a><span class="hs-comment">-- imports that define family instances (if we haven't loaded them already).</span><span>
</span><a name="line-593"></a><span class="hs-identifier">tcExtendLocalFamInstEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FamInst</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621682473761"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621682473761"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-594"></a><span>
</span><a name="line-595"></a><span class="hs-comment">-- If we weren't actually given any instances to add, then we don't want</span><span>
</span><a name="line-596"></a><span class="hs-comment">-- to go to the bother of loading family instance module dependencies.</span><span>
</span><a name="line-597"></a><a name="tcExtendLocalFamInstEnv"><a href="FamInst.html#tcExtendLocalFamInstEnv"><span class="hs-identifier">tcExtendLocalFamInstEnv</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621682474170"><a href="#local-6989586621682474170"><span class="hs-identifier">thing_inside</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682474170"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-598"></a><span>
</span><a name="line-599"></a><span class="hs-comment">-- Otherwise proceed...</span><span>
</span><a name="line-600"></a><span class="hs-identifier">tcExtendLocalFamInstEnv</span><span> </span><a name="local-6989586621682474171"><a href="#local-6989586621682474171"><span class="hs-identifier">fam_insts</span></a></a><span> </span><a name="local-6989586621682474172"><a href="#local-6989586621682474172"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-601"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Load family-instance modules &quot;below&quot; this module, so that</span><span>
</span><a name="line-602"></a><span>        </span><span class="hs-comment">-- allLocalFamInst can check for consistency with them</span><span>
</span><a name="line-603"></a><span>        </span><span class="hs-comment">-- See Note [The type family instance consistency story]</span><span>
</span><a name="line-604"></a><span>        </span><a href="FamInst.html#loadDependentFamInstModules"><span class="hs-identifier hs-var">loadDependentFamInstModules</span></a><span> </span><a href="#local-6989586621682474171"><span class="hs-identifier hs-var">fam_insts</span></a><span>
</span><a name="line-605"></a><span>
</span><a name="line-606"></a><span>        </span><span class="hs-comment">-- Now add the instances one by one</span><span>
</span><a name="line-607"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682474173"><a href="#local-6989586621682474173"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-608"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682474174"><a href="#local-6989586621682474174"><span class="hs-identifier">inst_env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682474175"><a href="#local-6989586621682474175"><span class="hs-identifier">fam_insts'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">foldlM</span><span> </span><a href="FamInst.html#addLocalFamInst"><span class="hs-identifier hs-var">addLocalFamInst</span></a><span>
</span><a name="line-609"></a><span>                                       </span><span class="hs-special">(</span><span class="hs-identifier">tcg_fam_inst_env</span><span> </span><a href="#local-6989586621682474173"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_fam_insts</span><span> </span><a href="#local-6989586621682474173"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-610"></a><span>                                       </span><a href="#local-6989586621682474171"><span class="hs-identifier hs-var">fam_insts</span></a><span>
</span><a name="line-611"></a><span>
</span><a name="line-612"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682474176"><a href="#local-6989586621682474176"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682474173"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_fam_insts</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682474175"><span class="hs-identifier hs-var">fam_insts'</span></a><span>
</span><a name="line-613"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_fam_inst_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682474174"><span class="hs-identifier hs-var">inst_env'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-614"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><a href="#local-6989586621682474176"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621682474172"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-615"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-616"></a><span>
</span><a name="line-617"></a><span class="hs-identifier">loadDependentFamInstModules</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FamInst</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-618"></a><span class="hs-comment">-- Load family-instance modules &quot;below&quot; this module, so that</span><span>
</span><a name="line-619"></a><span class="hs-comment">-- allLocalFamInst can check for consistency with them</span><span>
</span><a name="line-620"></a><span class="hs-comment">-- See Note [The type family instance consistency story]</span><span>
</span><a name="line-621"></a><a name="loadDependentFamInstModules"><a href="FamInst.html#loadDependentFamInstModules"><span class="hs-identifier">loadDependentFamInstModules</span></a></a><span> </span><a name="local-6989586621682474177"><a href="#local-6989586621682474177"><span class="hs-identifier">fam_insts</span></a></a><span>
</span><a name="line-622"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682474178"><a href="#local-6989586621682474178"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-623"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682474179"><a href="#local-6989586621682474179"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_mod</span><span> </span><a href="#local-6989586621682474178"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-624"></a><span>            </span><a name="local-6989586621682474180"><a href="#local-6989586621682474180"><span class="hs-identifier">imports</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_imports</span><span> </span><a href="#local-6989586621682474178"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-625"></a><span>
</span><a name="line-626"></a><span>            </span><a name="local-6989586621682474181"><a href="#local-6989586621682474181"><span class="hs-identifier">want_module</span></a></a><span> </span><a name="local-6989586621682474183"><a href="#local-6989586621682474183"><span class="hs-identifier">mod</span></a></a><span>  </span><span class="hs-comment">-- See Note [Home package family instances]</span><span>
</span><a name="line-627"></a><span>              </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682474183"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682474179"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-628"></a><span>              </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682474182"><span class="hs-identifier hs-var">home_fams_only</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621682474183"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621682474179"><span class="hs-identifier hs-var">this_mod</span></a><span>
</span><a name="line-629"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-630"></a><span>            </span><a name="local-6989586621682474182"><a href="#local-6989586621682474182"><span class="hs-identifier">home_fams_only</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameIsHomePackage</span><span> </span><a href="#local-6989586621682474179"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">fi_fam</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682474177"><span class="hs-identifier hs-var">fam_insts</span></a><span>
</span><a name="line-631"></a><span>
</span><a name="line-632"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="LoadIface.html#loadModuleInterfaces"><span class="hs-identifier hs-var">loadModuleInterfaces</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Loading family-instance modules&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-633"></a><span>        </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621682474181"><span class="hs-identifier hs-var">want_module</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">imp_finsts</span><span> </span><a href="#local-6989586621682474180"><span class="hs-identifier hs-var">imports</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-634"></a><span>
</span><a name="line-635"></a><span class="hs-comment">{- Note [Home package family instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Optimization: If we're only defining type family instances
for type families *defined in the home package*, then we
only have to load interface files that belong to the home
package. The reason is that there's no recursion between
packages, so modules in other packages can't possibly define
instances for our type families.

(Within the home package, we could import a module M that
imports us via an hs-boot file, and thereby defines an
instance of a type family defined in this module. So we can't
apply the same logic to avoid reading any interface files at
all, when we define an instances for type family defined in
the current module.
-}</span><span>
</span><a name="line-651"></a><span>
</span><a name="line-652"></a><span class="hs-comment">-- Check that the proposed new instance is OK,</span><span>
</span><a name="line-653"></a><span class="hs-comment">-- and then add it to the home inst env</span><span>
</span><a name="line-654"></a><span class="hs-comment">-- This must be lazy in the fam_inst arguments, see Note [Lazy axiom match]</span><span>
</span><a name="line-655"></a><span class="hs-comment">-- in FamInstEnv.hs</span><span>
</span><a name="line-656"></a><span class="hs-identifier">addLocalFamInst</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">FamInstEnv</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-identifier hs-type">FamInst</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-657"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FamInst</span><span>
</span><a name="line-658"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">FamInstEnv</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FamInst</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-659"></a><a name="addLocalFamInst"><a href="FamInst.html#addLocalFamInst"><span class="hs-identifier">addLocalFamInst</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682474184"><a href="#local-6989586621682474184"><span class="hs-identifier">home_fie</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682474185"><a href="#local-6989586621682474185"><span class="hs-identifier">my_fis</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682474186"><a href="#local-6989586621682474186"><span class="hs-identifier">fam_inst</span></a></a><span>
</span><a name="line-660"></a><span>        </span><span class="hs-comment">-- home_fie includes home package and this module</span><span>
</span><a name="line-661"></a><span>        </span><span class="hs-comment">-- my_fies is just the ones from this module</span><span>
</span><a name="line-662"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;addLocalFamInst&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682474186"><span class="hs-identifier hs-var">fam_inst</span></a><span class="hs-special">)</span><span>
</span><a name="line-663"></a><span>
</span><a name="line-664"></a><span>           </span><span class="hs-comment">-- Unlike the case of class instances, don't override existing</span><span>
</span><a name="line-665"></a><span>           </span><span class="hs-comment">-- instances in GHCi; it's unsound. See #7102.</span><span>
</span><a name="line-666"></a><span>
</span><a name="line-667"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682474187"><a href="#local-6989586621682474187"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-668"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;alfi&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682474187"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-669"></a><span>
</span><a name="line-670"></a><span>           </span><span class="hs-comment">-- Fetch imported instances, so that we report</span><span>
</span><a name="line-671"></a><span>           </span><span class="hs-comment">-- overlaps correctly.</span><span>
</span><a name="line-672"></a><span>           </span><span class="hs-comment">-- Really we ought to only check consistency with</span><span>
</span><a name="line-673"></a><span>           </span><span class="hs-comment">-- those instances which are transitively imported</span><span>
</span><a name="line-674"></a><span>           </span><span class="hs-comment">-- by the current module, rather than every instance</span><span>
</span><a name="line-675"></a><span>           </span><span class="hs-comment">-- we've ever seen. Fixing this is part of #13102.</span><span>
</span><a name="line-676"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682474188"><a href="#local-6989586621682474188"><span class="hs-identifier">eps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getEps"><span class="hs-identifier hs-var">getEps</span></a><span>
</span><a name="line-677"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682474189"><a href="#local-6989586621682474189"><span class="hs-identifier">inst_envs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_fam_inst_env</span><span> </span><a href="#local-6989586621682474188"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682474184"><span class="hs-identifier hs-var">home_fie</span></a><span class="hs-special">)</span><span>
</span><a name="line-678"></a><span>             </span><a name="local-6989586621682474190"><a href="#local-6989586621682474190"><span class="hs-identifier">home_fie'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendFamInstEnv</span><span> </span><a href="#local-6989586621682474184"><span class="hs-identifier hs-var">home_fie</span></a><span> </span><a href="#local-6989586621682474186"><span class="hs-identifier hs-var">fam_inst</span></a><span>
</span><a name="line-679"></a><span>
</span><a name="line-680"></a><span>           </span><span class="hs-comment">-- Check for conflicting instance decls and injectivity violations</span><span>
</span><a name="line-681"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682474191"><a href="#local-6989586621682474191"><span class="hs-identifier">no_conflict</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#checkForConflicts"><span class="hs-identifier hs-var">checkForConflicts</span></a><span>            </span><a href="#local-6989586621682474189"><span class="hs-identifier hs-var">inst_envs</span></a><span> </span><a href="#local-6989586621682474186"><span class="hs-identifier hs-var">fam_inst</span></a><span>
</span><a name="line-682"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682474192"><a href="#local-6989586621682474192"><span class="hs-identifier">injectivity_ok</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#checkForInjectivityConflicts"><span class="hs-identifier hs-var">checkForInjectivityConflicts</span></a><span> </span><a href="#local-6989586621682474189"><span class="hs-identifier hs-var">inst_envs</span></a><span> </span><a href="#local-6989586621682474186"><span class="hs-identifier hs-var">fam_inst</span></a><span>
</span><a name="line-683"></a><span>
</span><a name="line-684"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682474191"><span class="hs-identifier hs-var">no_conflict</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621682474192"><span class="hs-identifier hs-var">injectivity_ok</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-685"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682474190"><span class="hs-identifier hs-var">home_fie'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682474186"><span class="hs-identifier hs-var">fam_inst</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682474185"><span class="hs-identifier hs-var">my_fis</span></a><span class="hs-special">)</span><span>
</span><a name="line-686"></a><span>         </span><span class="hs-keyword">else</span><span>
</span><a name="line-687"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682474184"><span class="hs-identifier hs-var">home_fie</span></a><span class="hs-special">,</span><span>  </span><a href="#local-6989586621682474185"><span class="hs-identifier hs-var">my_fis</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-688"></a><span>
</span><a name="line-689"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Checking an instance against conflicts with an instance env
*                                                                      *
************************************************************************

Check whether a single family instance conflicts with those in two instance
environments (one for the EPS and one for the HPT).
-}</span><span>
</span><a name="line-699"></a><span>
</span><a name="line-700"></a><span class="hs-identifier">checkForConflicts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FamInstEnvs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FamInst</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-701"></a><a name="checkForConflicts"><a href="FamInst.html#checkForConflicts"><span class="hs-identifier">checkForConflicts</span></a></a><span> </span><a name="local-6989586621682474193"><a href="#local-6989586621682474193"><span class="hs-identifier">inst_envs</span></a></a><span> </span><a name="local-6989586621682474194"><a href="#local-6989586621682474194"><span class="hs-identifier">fam_inst</span></a></a><span>
</span><a name="line-702"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682474195"><a href="#local-6989586621682474195"><span class="hs-identifier">conflicts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupFamInstEnvConflicts</span><span> </span><a href="#local-6989586621682474193"><span class="hs-identifier hs-var">inst_envs</span></a><span> </span><a href="#local-6989586621682474194"><span class="hs-identifier hs-var">fam_inst</span></a><span>
</span><a name="line-703"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;checkForConflicts&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-704"></a><span>         </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">fim_instance</span><span> </span><a href="#local-6989586621682474195"><span class="hs-identifier hs-var">conflicts</span></a><span class="hs-special">)</span><span>
</span><a name="line-705"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682474194"><span class="hs-identifier hs-var">fam_inst</span></a><span>
</span><a name="line-706"></a><span>              </span><span class="hs-comment">-- , ppr inst_envs</span><span>
</span><a name="line-707"></a><span>         </span><span class="hs-special">]</span><span>
</span><a name="line-708"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="FamInst.html#reportConflictInstErr"><span class="hs-identifier hs-var">reportConflictInstErr</span></a><span> </span><a href="#local-6989586621682474194"><span class="hs-identifier hs-var">fam_inst</span></a><span> </span><a href="#local-6989586621682474195"><span class="hs-identifier hs-var">conflicts</span></a><span>
</span><a name="line-709"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682474195"><span class="hs-identifier hs-var">conflicts</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-710"></a><span>
</span><a name="line-711"></a><span class="hs-comment">-- | Check whether a new open type family equation can be added without</span><span>
</span><a name="line-712"></a><span class="hs-comment">-- violating injectivity annotation supplied by the user. Returns True when</span><span>
</span><a name="line-713"></a><span class="hs-comment">-- this is possible and False if adding this equation would violate injectivity</span><span>
</span><a name="line-714"></a><span class="hs-comment">-- annotation.</span><span>
</span><a name="line-715"></a><span class="hs-identifier">checkForInjectivityConflicts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FamInstEnvs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FamInst</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-716"></a><a name="checkForInjectivityConflicts"><a href="FamInst.html#checkForInjectivityConflicts"><span class="hs-identifier">checkForInjectivityConflicts</span></a></a><span> </span><a name="local-6989586621682474196"><a href="#local-6989586621682474196"><span class="hs-identifier">instEnvs</span></a></a><span> </span><a name="local-6989586621682474197"><a href="#local-6989586621682474197"><span class="hs-identifier">famInst</span></a></a><span>
</span><a name="line-717"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTypeFamilyTyCon</span><span> </span><a href="#local-6989586621682474198"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-718"></a><span>    </span><span class="hs-comment">-- type family is injective in at least one argument</span><span>
</span><a name="line-719"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Injective</span><span> </span><a name="local-6989586621682474200"><a href="#local-6989586621682474200"><span class="hs-identifier">inj</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tyConInjectivityInfo</span><span> </span><a href="#local-6989586621682474198"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-720"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682474201"><a href="#local-6989586621682474201"><span class="hs-identifier">axiom</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">coAxiomSingleBranch</span><span> </span><a href="#local-6989586621682474199"><span class="hs-identifier hs-var">fi_ax</span></a><span>
</span><a name="line-721"></a><span>          </span><a name="local-6989586621682474202"><a href="#local-6989586621682474202"><span class="hs-identifier">conflicts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupFamInstEnvInjectivityConflicts</span><span> </span><a href="#local-6989586621682474200"><span class="hs-identifier hs-var">inj</span></a><span> </span><a href="#local-6989586621682474196"><span class="hs-identifier hs-var">instEnvs</span></a><span> </span><a href="#local-6989586621682474197"><span class="hs-identifier hs-var">famInst</span></a><span>
</span><a name="line-722"></a><span>          </span><span class="hs-comment">-- see Note [Verifying injectivity annotation] in FamInstEnv</span><span>
</span><a name="line-723"></a><span>          </span><a name="local-6989586621682474203"><a href="#local-6989586621682474203"><span class="hs-identifier">errs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInst.html#makeInjectivityErrors"><span class="hs-identifier hs-var">makeInjectivityErrors</span></a><span> </span><a href="#local-6989586621682474199"><span class="hs-identifier hs-var">fi_ax</span></a><span> </span><a href="#local-6989586621682474201"><span class="hs-identifier hs-var">axiom</span></a><span> </span><a href="#local-6989586621682474200"><span class="hs-identifier hs-var">inj</span></a><span> </span><a href="#local-6989586621682474202"><span class="hs-identifier hs-var">conflicts</span></a><span>
</span><a name="line-724"></a><span>    </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621682474204"><a href="#local-6989586621682474204"><span class="hs-identifier">err</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682474205"><a href="#local-6989586621682474205"><span class="hs-identifier">span</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621682474205"><span class="hs-identifier hs-var">span</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><a href="#local-6989586621682474204"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682474203"><span class="hs-identifier hs-var">errs</span></a><span>
</span><a name="line-725"></a><span>    </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682474203"><span class="hs-identifier hs-var">errs</span></a><span class="hs-special">)</span><span>
</span><a name="line-726"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-727"></a><span>
</span><a name="line-728"></a><span>    </span><span class="hs-comment">-- if there was no injectivity annotation or tycon does not represent a</span><span>
</span><a name="line-729"></a><span>    </span><span class="hs-comment">-- type family we report no conflicts</span><span>
</span><a name="line-730"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-731"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682474198"><a href="#local-6989586621682474198"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">famInstTyCon</span><span> </span><a href="#local-6989586621682474197"><span class="hs-identifier hs-var">famInst</span></a><span>
</span><a name="line-732"></a><span>          </span><a name="local-6989586621682474199"><a href="#local-6989586621682474199"><span class="hs-identifier">fi_ax</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fi_axiom</span><span> </span><a href="#local-6989586621682474197"><span class="hs-identifier hs-var">famInst</span></a><span>
</span><a name="line-733"></a><span>
</span><a name="line-734"></a><span class="hs-comment">-- | Build a list of injectivity errors together with their source locations.</span><span>
</span><a name="line-735"></a><span class="hs-identifier">makeInjectivityErrors</span><span>
</span><a name="line-736"></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoAxiom</span><span> </span><a href="#local-6989586621682473760"><span class="hs-identifier hs-type">br</span></a><span>   </span><span class="hs-comment">-- ^ Type family for which we generate errors</span><span>
</span><a name="line-737"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoAxBranch</span><span>   </span><span class="hs-comment">-- ^ Currently checked equation (represented by axiom)</span><span>
</span><a name="line-738"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- ^ Injectivity annotation</span><span>
</span><a name="line-739"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoAxBranch</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- ^ List of injectivity conflicts</span><span>
</span><a name="line-740"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-741"></a><a name="makeInjectivityErrors"><a href="FamInst.html#makeInjectivityErrors"><span class="hs-identifier">makeInjectivityErrors</span></a></a><span> </span><a name="local-6989586621682474206"><a href="#local-6989586621682474206"><span class="hs-identifier">fi_ax</span></a></a><span> </span><a name="local-6989586621682474207"><a href="#local-6989586621682474207"><span class="hs-identifier">axiom</span></a></a><span> </span><a name="local-6989586621682474208"><a href="#local-6989586621682474208"><span class="hs-identifier">inj</span></a></a><span> </span><a name="local-6989586621682474209"><a href="#local-6989586621682474209"><span class="hs-identifier">conflicts</span></a></a><span>
</span><a name="line-742"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-identifier hs-var">inj</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;No injective type variables&quot;</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-743"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682474210"><a href="#local-6989586621682474210"><span class="hs-identifier">lhs</span></a></a><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">coAxBranchLHS</span><span> </span><a href="#local-6989586621682474207"><span class="hs-identifier hs-var">axiom</span></a><span>
</span><a name="line-744"></a><span>        </span><a name="local-6989586621682474211"><a href="#local-6989586621682474211"><span class="hs-identifier">rhs</span></a></a><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">coAxBranchRHS</span><span> </span><a href="#local-6989586621682474207"><span class="hs-identifier hs-var">axiom</span></a><span>
</span><a name="line-745"></a><span>        </span><a name="local-6989586621682474212"><a href="#local-6989586621682474212"><span class="hs-identifier">fam_tc</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">coAxiomTyCon</span><span> </span><a href="#local-6989586621682474206"><span class="hs-identifier hs-var">fi_ax</span></a><span>
</span><a name="line-746"></a><span>        </span><a name="local-6989586621682474213"><a href="#local-6989586621682474213"><span class="hs-identifier">are_conflicts</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682474209"><span class="hs-identifier hs-var">conflicts</span></a><span>
</span><a name="line-747"></a><span>        </span><a name="local-6989586621682474214"><a href="#local-6989586621682474214"><span class="hs-identifier">unused_inj_tvs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="FamInst.html#unusedInjTvsInRHS"><span class="hs-identifier hs-var">unusedInjTvsInRHS</span></a><span> </span><a href="#local-6989586621682474212"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="#local-6989586621682474208"><span class="hs-identifier hs-var">inj</span></a><span> </span><a href="#local-6989586621682474210"><span class="hs-identifier hs-var">lhs</span></a><span> </span><a href="#local-6989586621682474211"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-748"></a><span>        </span><a name="local-6989586621682474215"><a href="#local-6989586621682474215"><span class="hs-identifier">inj_tvs_unused</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">and</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isEmptyVarSet</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621682474214"><span class="hs-identifier hs-var">unused_inj_tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-749"></a><span>        </span><a name="local-6989586621682474216"><a href="#local-6989586621682474216"><span class="hs-identifier">tf_headed</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="FamInst.html#isTFHeaded"><span class="hs-identifier hs-var">isTFHeaded</span></a><span> </span><a href="#local-6989586621682474211"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-750"></a><span>        </span><a name="local-6989586621682474217"><a href="#local-6989586621682474217"><span class="hs-identifier">bare_variables</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="FamInst.html#bareTvInRHSViolated"><span class="hs-identifier hs-var">bareTvInRHSViolated</span></a><span> </span><a href="#local-6989586621682474210"><span class="hs-identifier hs-var">lhs</span></a><span> </span><a href="#local-6989586621682474211"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-751"></a><span>        </span><a name="local-6989586621682474218"><a href="#local-6989586621682474218"><span class="hs-identifier">wrong_bare_rhs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682474217"><span class="hs-identifier hs-var">bare_variables</span></a><span>
</span><a name="line-752"></a><span>
</span><a name="line-753"></a><span>        </span><a name="local-6989586621682474219"><a href="#local-6989586621682474219"><span class="hs-identifier">err_builder</span></a></a><span> </span><a name="local-6989586621682474221"><a href="#local-6989586621682474221"><span class="hs-identifier">herald</span></a></a><span> </span><a name="local-6989586621682474222"><a href="#local-6989586621682474222"><span class="hs-identifier">eqns</span></a></a><span>
</span><a name="line-754"></a><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><a href="#local-6989586621682474221"><span class="hs-identifier hs-var">herald</span></a><span>
</span><a name="line-755"></a><span>                               </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprCoAxBranchUser</span><span> </span><a href="#local-6989586621682474212"><span class="hs-identifier hs-var">fam_tc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682474222"><span class="hs-identifier hs-var">eqns</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-756"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">coAxBranchSpan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621682474222"><span class="hs-identifier hs-var">eqns</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-757"></a><span>        </span><a name="local-6989586621682474220"><a href="#local-6989586621682474220"><span class="hs-identifier">errorIf</span></a></a><span> </span><a name="local-6989586621682474223"><a href="#local-6989586621682474223"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621682474224"><a href="#local-6989586621682474224"><span class="hs-identifier">f</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682474223"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682474224"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621682474219"><span class="hs-identifier hs-var">err_builder</span></a><span> </span><a href="#local-6989586621682474207"><span class="hs-identifier hs-var">axiom</span></a><span class="hs-special">]</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-758"></a><span>     </span><span class="hs-keyword">in</span><span>    </span><a href="#local-6989586621682474220"><span class="hs-identifier hs-var">errorIf</span></a><span> </span><a href="#local-6989586621682474213"><span class="hs-identifier hs-var">are_conflicts</span></a><span>  </span><span class="hs-special">(</span><a href="FamInst.html#conflictInjInstErr"><span class="hs-identifier hs-var">conflictInjInstErr</span></a><span>     </span><a href="#local-6989586621682474209"><span class="hs-identifier hs-var">conflicts</span></a><span>     </span><span class="hs-special">)</span><span>
</span><a name="line-759"></a><span>        </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682474220"><span class="hs-identifier hs-var">errorIf</span></a><span> </span><a href="#local-6989586621682474215"><span class="hs-identifier hs-var">inj_tvs_unused</span></a><span> </span><span class="hs-special">(</span><a href="FamInst.html#unusedInjectiveVarsErr"><span class="hs-identifier hs-var">unusedInjectiveVarsErr</span></a><span> </span><a href="#local-6989586621682474214"><span class="hs-identifier hs-var">unused_inj_tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-760"></a><span>        </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682474220"><span class="hs-identifier hs-var">errorIf</span></a><span> </span><a href="#local-6989586621682474216"><span class="hs-identifier hs-var">tf_headed</span></a><span>       </span><a href="FamInst.html#tfHeadedErr"><span class="hs-identifier hs-var">tfHeadedErr</span></a><span>
</span><a name="line-761"></a><span>        </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682474220"><span class="hs-identifier hs-var">errorIf</span></a><span> </span><a href="#local-6989586621682474218"><span class="hs-identifier hs-var">wrong_bare_rhs</span></a><span> </span><span class="hs-special">(</span><a href="FamInst.html#bareVariableInRHSErr"><span class="hs-identifier hs-var">bareVariableInRHSErr</span></a><span>   </span><a href="#local-6989586621682474217"><span class="hs-identifier hs-var">bare_variables</span></a><span class="hs-special">)</span><span>
</span><a name="line-762"></a><span>
</span><a name="line-763"></a><span>
</span><a name="line-764"></a><span class="hs-comment">-- | Return a list of type variables that the function is injective in and that</span><span>
</span><a name="line-765"></a><span class="hs-comment">-- do not appear on injective positions in the RHS of a family instance</span><span>
</span><a name="line-766"></a><span class="hs-comment">-- declaration. The returned Pair includes invisible vars followed by visible ones</span><span>
</span><a name="line-767"></a><span class="hs-identifier">unusedInjTvsInRHS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Pair</span><span> </span><span class="hs-identifier hs-type">TyVarSet</span><span>
</span><a name="line-768"></a><span class="hs-comment">-- INVARIANT: [Bool] list contains at least one True value</span><span>
</span><a name="line-769"></a><span class="hs-comment">-- See Note [Verifying injectivity annotation]. This function implements fourth</span><span>
</span><a name="line-770"></a><span class="hs-comment">-- check described there.</span><span>
</span><a name="line-771"></a><span class="hs-comment">-- In theory, instead of implementing this whole check in this way, we could</span><span>
</span><a name="line-772"></a><span class="hs-comment">-- attempt to unify equation with itself.  We would reject exactly the same</span><span>
</span><a name="line-773"></a><span class="hs-comment">-- equations but this method gives us more precise error messages by returning</span><span>
</span><a name="line-774"></a><span class="hs-comment">-- precise names of variables that are not mentioned in the RHS.</span><span>
</span><a name="line-775"></a><a name="unusedInjTvsInRHS"><a href="FamInst.html#unusedInjTvsInRHS"><span class="hs-identifier">unusedInjTvsInRHS</span></a></a><span> </span><a name="local-6989586621682474225"><a href="#local-6989586621682474225"><span class="hs-identifier">tycon</span></a></a><span> </span><a name="local-6989586621682474226"><a href="#local-6989586621682474226"><span class="hs-identifier">injList</span></a></a><span> </span><a name="local-6989586621682474227"><a href="#local-6989586621682474227"><span class="hs-identifier">lhs</span></a></a><span> </span><a name="local-6989586621682474228"><a href="#local-6989586621682474228"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-776"></a><span>  </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">minusVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682474236"><span class="hs-identifier hs-var">injRhsVars</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621682474235"><span class="hs-identifier hs-var">injLHSVars</span></a><span>
</span><a name="line-777"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-778"></a><span>      </span><span class="hs-identifier">inj_pairs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ArgFlag</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-779"></a><span>      </span><span class="hs-comment">-- All the injective arguments, paired with their visibility</span><span>
</span><a name="line-780"></a><span>      </span><a name="local-6989586621682474229"><a href="#local-6989586621682474229"><span class="hs-identifier">inj_pairs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">injList</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">equalLength</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">lhs</span><span>
</span><a name="line-781"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">tycon</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">injList</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">lhs</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-782"></a><span>                  </span><span class="hs-identifier hs-var">filterByList</span><span> </span><a href="#local-6989586621682474226"><span class="hs-identifier hs-var">injList</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682474227"><span class="hs-identifier hs-var">lhs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">tyConArgFlags</span><span> </span><a href="#local-6989586621682474225"><span class="hs-identifier hs-var">tycon</span></a><span> </span><a href="#local-6989586621682474227"><span class="hs-identifier hs-var">lhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-783"></a><span>
</span><a name="line-784"></a><span>      </span><span class="hs-comment">-- set of type and kind variables in which type family is injective</span><span>
</span><a name="line-785"></a><span>      </span><span class="hs-identifier">invis_lhs</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">vis_lhs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-786"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621682474230"><a href="#local-6989586621682474230"><span class="hs-identifier">invis_lhs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682474231"><a href="#local-6989586621682474231"><span class="hs-identifier">vis_lhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partitionInvisibles</span><span> </span><a href="#local-6989586621682474229"><span class="hs-identifier hs-var">inj_pairs</span></a><span>
</span><a name="line-787"></a><span>
</span><a name="line-788"></a><span>      </span><a name="local-6989586621682474232"><a href="#local-6989586621682474232"><span class="hs-identifier">invis_vars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyCoVarsOfTypes</span><span> </span><a href="#local-6989586621682474230"><span class="hs-identifier hs-var">invis_lhs</span></a><span>
</span><a name="line-789"></a><span>      </span><span class="hs-identifier hs-var">Pair</span><span> </span><a name="local-6989586621682474233"><a href="#local-6989586621682474233"><span class="hs-identifier">invis_vars'</span></a></a><span> </span><a name="local-6989586621682474234"><a href="#local-6989586621682474234"><span class="hs-identifier">vis_vars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitVisVarsOfTypes</span><span> </span><a href="#local-6989586621682474231"><span class="hs-identifier hs-var">vis_lhs</span></a><span>
</span><a name="line-790"></a><span>      </span><a name="local-6989586621682474235"><a href="#local-6989586621682474235"><span class="hs-identifier">injLHSVars</span></a></a><span>
</span><a name="line-791"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Pair</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682474232"><span class="hs-identifier hs-var">invis_vars</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">minusVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682474234"><span class="hs-identifier hs-var">vis_vars</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682474233"><span class="hs-identifier hs-var">invis_vars'</span></a><span class="hs-special">)</span><span>
</span><a name="line-792"></a><span>               </span><a href="#local-6989586621682474234"><span class="hs-identifier hs-var">vis_vars</span></a><span>
</span><a name="line-793"></a><span>
</span><a name="line-794"></a><span>      </span><span class="hs-comment">-- set of type variables appearing in the RHS on an injective position.</span><span>
</span><a name="line-795"></a><span>      </span><span class="hs-comment">-- For all returned variables we assume their associated kind variables</span><span>
</span><a name="line-796"></a><span>      </span><span class="hs-comment">-- also appear in the RHS.</span><span>
</span><a name="line-797"></a><span>      </span><a name="local-6989586621682474236"><a href="#local-6989586621682474236"><span class="hs-identifier">injRhsVars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInst.html#injTyVarsOfType"><span class="hs-identifier hs-var">injTyVarsOfType</span></a><span> </span><a href="#local-6989586621682474228"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-798"></a><span>
</span><a name="line-799"></a><span class="hs-identifier">injTyVarsOfType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcTauType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcTyVarSet</span><span>
</span><a name="line-800"></a><span class="hs-comment">-- Collect all type variables that are either arguments to a type</span><span>
</span><a name="line-801"></a><span class="hs-comment">--   constructor or to /injective/ type families.</span><span>
</span><a name="line-802"></a><span class="hs-comment">-- Determining the overall type determines thes variables</span><span>
</span><a name="line-803"></a><span class="hs-comment">--</span><span>
</span><a name="line-804"></a><span class="hs-comment">-- E.g.   Suppose F is injective in its second arg, but not its first</span><span>
</span><a name="line-805"></a><span class="hs-comment">--        then injVarOfType (Either a (F [b] (a,c))) = {a,c}</span><span>
</span><a name="line-806"></a><span class="hs-comment">--        Determining the overall type determines a,c but not b.</span><span>
</span><a name="line-807"></a><a name="injTyVarsOfType"><a href="FamInst.html#injTyVarsOfType"><span class="hs-identifier">injTyVarsOfType</span></a></a><span> </span><a name="local-6989586621682474237"><a href="#local-6989586621682474237"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-808"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682474238"><a href="#local-6989586621682474238"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">coreView</span><span> </span><a href="#local-6989586621682474237"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-comment">-- #12430</span><span>
</span><a name="line-809"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="FamInst.html#injTyVarsOfType"><span class="hs-identifier hs-var">injTyVarsOfType</span></a><span> </span><a href="#local-6989586621682474238"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-810"></a><span class="hs-identifier">injTyVarsOfType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyVarTy</span><span> </span><a name="local-6989586621682474239"><a href="#local-6989586621682474239"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-811"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unitVarSet</span><span> </span><a href="#local-6989586621682474239"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionVarSet</span><span class="hs-special">`</span><span> </span><a href="FamInst.html#injTyVarsOfType"><span class="hs-identifier hs-var">injTyVarsOfType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyVarKind</span><span> </span><a href="#local-6989586621682474239"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-812"></a><span class="hs-identifier">injTyVarsOfType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyConApp</span><span> </span><a name="local-6989586621682474240"><a href="#local-6989586621682474240"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682474241"><a href="#local-6989586621682474241"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-813"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTypeFamilyTyCon</span><span> </span><a href="#local-6989586621682474240"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-814"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">tyConInjectivityInfo</span><span> </span><a href="#local-6989586621682474240"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-815"></a><span>        </span><span class="hs-identifier hs-var">NotInjective</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">emptyVarSet</span><span>
</span><a name="line-816"></a><span>        </span><span class="hs-identifier hs-var">Injective</span><span> </span><a name="local-6989586621682474242"><a href="#local-6989586621682474242"><span class="hs-identifier">inj</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInst.html#injTyVarsOfTypes"><span class="hs-identifier hs-var">injTyVarsOfTypes</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filterByList</span><span> </span><a href="#local-6989586621682474242"><span class="hs-identifier hs-var">inj</span></a><span> </span><a href="#local-6989586621682474241"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-817"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-818"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="FamInst.html#injTyVarsOfTypes"><span class="hs-identifier hs-var">injTyVarsOfTypes</span></a><span> </span><a href="#local-6989586621682474241"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-819"></a><span class="hs-identifier">injTyVarsOfType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitTy</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-820"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyVarSet</span><span>
</span><a name="line-821"></a><span class="hs-identifier">injTyVarsOfType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunTy</span><span> </span><a name="local-6989586621682474243"><a href="#local-6989586621682474243"><span class="hs-identifier">arg</span></a></a><span> </span><a name="local-6989586621682474244"><a href="#local-6989586621682474244"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-822"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="FamInst.html#injTyVarsOfType"><span class="hs-identifier hs-var">injTyVarsOfType</span></a><span> </span><a href="#local-6989586621682474243"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionVarSet</span><span class="hs-special">`</span><span> </span><a href="FamInst.html#injTyVarsOfType"><span class="hs-identifier hs-var">injTyVarsOfType</span></a><span> </span><a href="#local-6989586621682474244"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-823"></a><span class="hs-identifier">injTyVarsOfType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AppTy</span><span> </span><a name="local-6989586621682474245"><a href="#local-6989586621682474245"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621682474246"><a href="#local-6989586621682474246"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-824"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="FamInst.html#injTyVarsOfType"><span class="hs-identifier hs-var">injTyVarsOfType</span></a><span> </span><a href="#local-6989586621682474245"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionVarSet</span><span class="hs-special">`</span><span> </span><a href="FamInst.html#injTyVarsOfType"><span class="hs-identifier hs-var">injTyVarsOfType</span></a><span> </span><a href="#local-6989586621682474246"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-825"></a><span class="hs-comment">-- No forall types in the RHS of a type family</span><span>
</span><a name="line-826"></a><span class="hs-identifier">injTyVarsOfType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CastTy</span><span> </span><a name="local-6989586621682474247"><a href="#local-6989586621682474247"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="FamInst.html#injTyVarsOfType"><span class="hs-identifier hs-var">injTyVarsOfType</span></a><span> </span><a href="#local-6989586621682474247"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-827"></a><span class="hs-identifier">injTyVarsOfType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoercionTy</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyVarSet</span><span>
</span><a name="line-828"></a><span class="hs-identifier">injTyVarsOfType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ForAllTy</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span>
</span><a name="line-829"></a><span>    </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;unusedInjTvsInRHS.injTyVarsOfType&quot;</span><span>
</span><a name="line-830"></a><span>
</span><a name="line-831"></a><span class="hs-identifier">injTyVarsOfTypes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">VarSet</span><span>
</span><a name="line-832"></a><a name="injTyVarsOfTypes"><a href="FamInst.html#injTyVarsOfTypes"><span class="hs-identifier">injTyVarsOfTypes</span></a></a><span> </span><a name="local-6989586621682474248"><a href="#local-6989586621682474248"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapUnionVarSet</span><span> </span><a href="FamInst.html#injTyVarsOfType"><span class="hs-identifier hs-var">injTyVarsOfType</span></a><span> </span><a href="#local-6989586621682474248"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-833"></a><span>
</span><a name="line-834"></a><span class="hs-comment">-- | Is type headed by a type family application?</span><span>
</span><a name="line-835"></a><span class="hs-identifier">isTFHeaded</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-836"></a><span class="hs-comment">-- See Note [Verifying injectivity annotation]. This function implements third</span><span>
</span><a name="line-837"></a><span class="hs-comment">-- check described there.</span><span>
</span><a name="line-838"></a><a name="isTFHeaded"><a href="FamInst.html#isTFHeaded"><span class="hs-identifier">isTFHeaded</span></a></a><span> </span><a name="local-6989586621682474249"><a href="#local-6989586621682474249"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682474250"><a href="#local-6989586621682474250"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">coreView</span><span> </span><a href="#local-6989586621682474249"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-839"></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="FamInst.html#isTFHeaded"><span class="hs-identifier hs-var">isTFHeaded</span></a><span> </span><a href="#local-6989586621682474250"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-840"></a><span class="hs-identifier">isTFHeaded</span><span> </span><a name="local-6989586621682474251"><a href="#local-6989586621682474251"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyConApp</span><span> </span><a name="local-6989586621682474252"><a href="#local-6989586621682474252"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682474253"><a href="#local-6989586621682474253"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682474251"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-841"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isTypeFamilyTyCon</span><span> </span><a href="#local-6989586621682474252"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-842"></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682474253"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">lengthIs</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">tyConArity</span><span> </span><a href="#local-6989586621682474252"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-843"></a><span class="hs-identifier">isTFHeaded</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-844"></a><span>
</span><a name="line-845"></a><span>
</span><a name="line-846"></a><span class="hs-comment">-- | If a RHS is a bare type variable return a set of LHS patterns that are not</span><span>
</span><a name="line-847"></a><span class="hs-comment">-- bare type variables.</span><span>
</span><a name="line-848"></a><span class="hs-identifier">bareTvInRHSViolated</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-849"></a><span class="hs-comment">-- See Note [Verifying injectivity annotation]. This function implements second</span><span>
</span><a name="line-850"></a><span class="hs-comment">-- check described there.</span><span>
</span><a name="line-851"></a><a name="bareTvInRHSViolated"><a href="FamInst.html#bareTvInRHSViolated"><span class="hs-identifier">bareTvInRHSViolated</span></a></a><span> </span><a name="local-6989586621682474254"><a href="#local-6989586621682474254"><span class="hs-identifier">pats</span></a></a><span> </span><a name="local-6989586621682474255"><a href="#local-6989586621682474255"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTyVarTy</span><span> </span><a href="#local-6989586621682474255"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-852"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">isTyVarTy</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682474254"><span class="hs-identifier hs-var">pats</span></a><span>
</span><a name="line-853"></a><span class="hs-identifier">bareTvInRHSViolated</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-854"></a><span>
</span><a name="line-855"></a><span>
</span><a name="line-856"></a><span class="hs-comment">-- | Type of functions that use error message and a list of axioms to build full</span><span>
</span><a name="line-857"></a><span class="hs-comment">-- error message (with a source location) for injective type families.</span><span>
</span><a name="line-858"></a><span class="hs-keyword">type</span><span> </span><a name="InjErrorBuilder"><a href="FamInst.html#InjErrorBuilder"><span class="hs-identifier">InjErrorBuilder</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoAxBranch</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span class="hs-special">)</span><span>
</span><a name="line-859"></a><span>
</span><a name="line-860"></a><span class="hs-comment">-- | Build injecivity error herald common to all injectivity errors.</span><span>
</span><a name="line-861"></a><span class="hs-identifier">injectivityErrorHerald</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-862"></a><a name="injectivityErrorHerald"><a href="FamInst.html#injectivityErrorHerald"><span class="hs-identifier">injectivityErrorHerald</span></a></a><span> </span><a name="local-6989586621682474256"><a href="#local-6989586621682474256"><span class="hs-identifier">isSingular</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-863"></a><span>  </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Type family equation&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621682474257"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621682474256"><span class="hs-identifier hs-var">isSingular</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;violate&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-864"></a><span>  </span><a href="#local-6989586621682474257"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621682474256"><span class="hs-identifier hs-var">isSingular</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;injectivity annotation&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-865"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682474256"><span class="hs-identifier hs-var">isSingular</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">dot</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">colon</span><span>
</span><a name="line-866"></a><span>  </span><span class="hs-comment">-- Above is an ugly hack.  We want this: &quot;sentence. herald:&quot; (note the dot and</span><span>
</span><a name="line-867"></a><span>  </span><span class="hs-comment">-- colon).  But if herald is empty we want &quot;sentence:&quot; (note the colon).  We</span><span>
</span><a name="line-868"></a><span>  </span><span class="hs-comment">-- can't test herald for emptiness so we rely on the fact that herald is empty</span><span>
</span><a name="line-869"></a><span>  </span><span class="hs-comment">-- only when isSingular is False.  If herald is non empty it must end with a</span><span>
</span><a name="line-870"></a><span>  </span><span class="hs-comment">-- colon.</span><span>
</span><a name="line-871"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-872"></a><span>      </span><a name="local-6989586621682474257"><a href="#local-6989586621682474257"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;s&quot;</span><span>
</span><a name="line-873"></a><span>      </span><span class="hs-identifier">s</span><span> </span><span class="hs-identifier hs-var">True</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-874"></a><span>
</span><a name="line-875"></a><span class="hs-comment">-- | Build error message for a pair of equations violating an injectivity</span><span>
</span><a name="line-876"></a><span class="hs-comment">-- annotation.</span><span>
</span><a name="line-877"></a><span class="hs-identifier">conflictInjInstErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoAxBranch</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInst.html#InjErrorBuilder"><span class="hs-identifier hs-type">InjErrorBuilder</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoAxBranch</span><span>
</span><a name="line-878"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span class="hs-special">)</span><span>
</span><a name="line-879"></a><a name="conflictInjInstErr"><a href="FamInst.html#conflictInjInstErr"><span class="hs-identifier">conflictInjInstErr</span></a></a><span> </span><a name="local-6989586621682474258"><a href="#local-6989586621682474258"><span class="hs-identifier">conflictingEqns</span></a></a><span> </span><a name="local-6989586621682474259"><a href="#local-6989586621682474259"><span class="hs-identifier">errorBuilder</span></a></a><span> </span><a name="local-6989586621682474260"><a href="#local-6989586621682474260"><span class="hs-identifier">tyfamEqn</span></a></a><span>
</span><a name="line-880"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621682474261"><a href="#local-6989586621682474261"><span class="hs-identifier">confEqn</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682474258"><span class="hs-identifier hs-var">conflictingEqns</span></a><span>
</span><a name="line-881"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682474259"><span class="hs-identifier hs-var">errorBuilder</span></a><span> </span><span class="hs-special">(</span><a href="FamInst.html#injectivityErrorHerald"><span class="hs-identifier hs-var">injectivityErrorHerald</span></a><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682474261"><span class="hs-identifier hs-var">confEqn</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682474260"><span class="hs-identifier hs-var">tyfamEqn</span></a><span class="hs-special">]</span><span>
</span><a name="line-882"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-883"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;conflictInjInstErr&quot;</span><span>
</span><a name="line-884"></a><span>
</span><a name="line-885"></a><span class="hs-comment">-- | Build error message for equation with injective type variables unused in</span><span>
</span><a name="line-886"></a><span class="hs-comment">-- the RHS.</span><span>
</span><a name="line-887"></a><span class="hs-identifier">unusedInjectiveVarsErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Pair</span><span> </span><span class="hs-identifier hs-type">TyVarSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInst.html#InjErrorBuilder"><span class="hs-identifier hs-type">InjErrorBuilder</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoAxBranch</span><span>
</span><a name="line-888"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span class="hs-special">)</span><span>
</span><a name="line-889"></a><a name="unusedInjectiveVarsErr"><a href="FamInst.html#unusedInjectiveVarsErr"><span class="hs-identifier">unusedInjectiveVarsErr</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Pair</span><span> </span><a name="local-6989586621682474262"><a href="#local-6989586621682474262"><span class="hs-identifier">invis_vars</span></a></a><span> </span><a name="local-6989586621682474263"><a href="#local-6989586621682474263"><span class="hs-identifier">vis_vars</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682474264"><a href="#local-6989586621682474264"><span class="hs-identifier">errorBuilder</span></a></a><span> </span><a name="local-6989586621682474265"><a href="#local-6989586621682474265"><span class="hs-identifier">tyfamEqn</span></a></a><span>
</span><a name="line-890"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682474272"><a href="#local-6989586621682474272"><span class="hs-identifier">doc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682474273"><a href="#local-6989586621682474273"><span class="hs-identifier">loc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682474264"><span class="hs-identifier hs-var">errorBuilder</span></a><span> </span><span class="hs-special">(</span><a href="FamInst.html#injectivityErrorHerald"><span class="hs-identifier hs-var">injectivityErrorHerald</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><a href="#local-6989586621682474271"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-891"></a><span>                                  </span><span class="hs-special">[</span><a href="#local-6989586621682474265"><span class="hs-identifier hs-var">tyfamEqn</span></a><span class="hs-special">]</span><span>
</span><a name="line-892"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprWithExplicitKindsWhen</span><span> </span><a href="#local-6989586621682474268"><span class="hs-identifier hs-var">has_kinds</span></a><span> </span><a href="#local-6989586621682474272"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682474273"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">)</span><span>
</span><a name="line-893"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-894"></a><span>      </span><a name="local-6989586621682474266"><a href="#local-6989586621682474266"><span class="hs-identifier">tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682474262"><span class="hs-identifier hs-var">invis_vars</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682474263"><span class="hs-identifier hs-var">vis_vars</span></a><span>
</span><a name="line-895"></a><span>      </span><a name="local-6989586621682474267"><a href="#local-6989586621682474267"><span class="hs-identifier">has_types</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">isEmptyVarSet</span><span> </span><a href="#local-6989586621682474263"><span class="hs-identifier hs-var">vis_vars</span></a><span>
</span><a name="line-896"></a><span>      </span><a name="local-6989586621682474268"><a href="#local-6989586621682474268"><span class="hs-identifier">has_kinds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">isEmptyVarSet</span><span> </span><a href="#local-6989586621682474262"><span class="hs-identifier hs-var">invis_vars</span></a><span>
</span><a name="line-897"></a><span>
</span><a name="line-898"></a><span>      </span><a name="local-6989586621682474269"><a href="#local-6989586621682474269"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621682474270"><span class="hs-identifier hs-var">what</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;variable&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-899"></a><span>                  </span><span class="hs-identifier hs-var">pluralVarSet</span><span> </span><a href="#local-6989586621682474266"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprVarSet</span><span> </span><a href="#local-6989586621682474266"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprQuotedList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">scopedSort</span><span class="hs-special">)</span><span>
</span><a name="line-900"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;cannot be inferred from the right-hand side.&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-901"></a><span>      </span><a name="local-6989586621682474270"><a href="#local-6989586621682474270"><span class="hs-identifier">what</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682474267"><span class="hs-identifier hs-var">has_types</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682474268"><span class="hs-identifier hs-var">has_kinds</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-902"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Type and kind&quot;</span><span>
</span><a name="line-903"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Type&quot;</span><span>
</span><a name="line-904"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Kind&quot;</span><span>
</span><a name="line-905"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;mkUnusedInjectiveVarsErr&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682474266"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-906"></a><span>      </span><a name="local-6989586621682474271"><a href="#local-6989586621682474271"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682474269"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;In the type family equation:&quot;</span><span>
</span><a name="line-907"></a><span>
</span><a name="line-908"></a><span class="hs-comment">-- | Build error message for equation that has a type family call at the top</span><span>
</span><a name="line-909"></a><span class="hs-comment">-- level of RHS</span><span>
</span><a name="line-910"></a><span class="hs-identifier">tfHeadedErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInst.html#InjErrorBuilder"><span class="hs-identifier hs-type">InjErrorBuilder</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoAxBranch</span><span>
</span><a name="line-911"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span class="hs-special">)</span><span>
</span><a name="line-912"></a><a name="tfHeadedErr"><a href="FamInst.html#tfHeadedErr"><span class="hs-identifier">tfHeadedErr</span></a></a><span> </span><a name="local-6989586621682474274"><a href="#local-6989586621682474274"><span class="hs-identifier">errorBuilder</span></a></a><span> </span><a name="local-6989586621682474275"><a href="#local-6989586621682474275"><span class="hs-identifier">famInst</span></a></a><span>
</span><a name="line-913"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682474274"><span class="hs-identifier hs-var">errorBuilder</span></a><span> </span><span class="hs-special">(</span><a href="FamInst.html#injectivityErrorHerald"><span class="hs-identifier hs-var">injectivityErrorHerald</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-914"></a><span>                  </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;RHS of injective type family equation cannot&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-915"></a><span>                  </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;be a type family:&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682474275"><span class="hs-identifier hs-var">famInst</span></a><span class="hs-special">]</span><span>
</span><a name="line-916"></a><span>
</span><a name="line-917"></a><span class="hs-comment">-- | Build error message for equation that has a bare type variable in the RHS</span><span>
</span><a name="line-918"></a><span class="hs-comment">-- but LHS pattern is not a bare type variable.</span><span>
</span><a name="line-919"></a><span class="hs-identifier">bareVariableInRHSErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInst.html#InjErrorBuilder"><span class="hs-identifier hs-type">InjErrorBuilder</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoAxBranch</span><span>
</span><a name="line-920"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span class="hs-special">)</span><span>
</span><a name="line-921"></a><a name="bareVariableInRHSErr"><a href="FamInst.html#bareVariableInRHSErr"><span class="hs-identifier">bareVariableInRHSErr</span></a></a><span> </span><a name="local-6989586621682474276"><a href="#local-6989586621682474276"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-6989586621682474277"><a href="#local-6989586621682474277"><span class="hs-identifier">errorBuilder</span></a></a><span> </span><a name="local-6989586621682474278"><a href="#local-6989586621682474278"><span class="hs-identifier">famInst</span></a></a><span>
</span><a name="line-922"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682474277"><span class="hs-identifier hs-var">errorBuilder</span></a><span> </span><span class="hs-special">(</span><a href="FamInst.html#injectivityErrorHerald"><span class="hs-identifier hs-var">injectivityErrorHerald</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-923"></a><span>                  </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;RHS of injective type family equation is a bare&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-924"></a><span>                  </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;type variable&quot;</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-925"></a><span>                  </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;but these LHS type and kind patterns are not bare&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-926"></a><span>                  </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;variables:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprQuotedList</span><span> </span><a href="#local-6989586621682474276"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682474278"><span class="hs-identifier hs-var">famInst</span></a><span class="hs-special">]</span><span>
</span><a name="line-927"></a><span>
</span><a name="line-928"></a><span>
</span><a name="line-929"></a><span class="hs-identifier">reportConflictInstErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FamInst</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FamInstMatch</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-930"></a><a name="reportConflictInstErr"><a href="FamInst.html#reportConflictInstErr"><span class="hs-identifier">reportConflictInstErr</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-931"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- No conflicts</span><span>
</span><a name="line-932"></a><span class="hs-identifier">reportConflictInstErr</span><span> </span><a name="local-6989586621682474279"><a href="#local-6989586621682474279"><span class="hs-identifier">fam_inst</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682474280"><a href="#local-6989586621682474280"><span class="hs-identifier">match1</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-933"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">FamInstMatch</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fim_instance</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682474282"><a href="#local-6989586621682474282"><span class="hs-identifier">conf_inst</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682474280"><span class="hs-identifier hs-var">match1</span></a><span>
</span><a name="line-934"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682474283"><a href="#local-6989586621682474283"><span class="hs-identifier">sorted</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortWith</span><span> </span><a href="#local-6989586621682474281"><span class="hs-identifier hs-var">getSpan</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621682474279"><span class="hs-identifier hs-var">fam_inst</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682474282"><span class="hs-identifier hs-var">conf_inst</span></a><span class="hs-special">]</span><span>
</span><a name="line-935"></a><span>        </span><a name="local-6989586621682474284"><a href="#local-6989586621682474284"><span class="hs-identifier">fi1</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621682474283"><span class="hs-identifier hs-var">sorted</span></a><span>
</span><a name="line-936"></a><span>        </span><a name="local-6989586621682474285"><a href="#local-6989586621682474285"><span class="hs-identifier">span</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">coAxBranchSpan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">coAxiomSingleBranch</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">famInstAxiom</span><span> </span><a href="#local-6989586621682474284"><span class="hs-identifier hs-var">fi1</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-937"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621682474285"><span class="hs-identifier hs-var">span</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-938"></a><span>    </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Conflicting family instance declarations:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-939"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">pprCoAxBranchUser</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">coAxiomTyCon</span><span> </span><a href="#local-6989586621682474287"><span class="hs-identifier hs-var">ax</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">coAxiomSingleBranch</span><span> </span><a href="#local-6989586621682474287"><span class="hs-identifier hs-var">ax</span></a><span class="hs-special">)</span><span>
</span><a name="line-940"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621682474286"><a href="#local-6989586621682474286"><span class="hs-identifier">fi</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682474283"><span class="hs-identifier hs-var">sorted</span></a><span>
</span><a name="line-941"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682474287"><a href="#local-6989586621682474287"><span class="hs-identifier">ax</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">famInstAxiom</span><span> </span><a href="#local-6989586621682474286"><span class="hs-identifier hs-var">fi</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-942"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-943"></a><span>   </span><a name="local-6989586621682474281"><a href="#local-6989586621682474281"><span class="hs-identifier">getSpan</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getSrcLoc</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">famInstAxiom</span><span>
</span><a name="line-944"></a><span>   </span><span class="hs-comment">-- The sortWith just arranges that instances are dislayed in order</span><span>
</span><a name="line-945"></a><span>   </span><span class="hs-comment">-- of source location, which reduced wobbling in error messages,</span><span>
</span><a name="line-946"></a><span>   </span><span class="hs-comment">-- and is better for users</span><span>
</span><a name="line-947"></a><span>
</span><a name="line-948"></a><span class="hs-identifier">tcGetFamInstEnvs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">FamInstEnvs</span><span>
</span><a name="line-949"></a><span class="hs-comment">-- Gets both the external-package inst-env</span><span>
</span><a name="line-950"></a><span class="hs-comment">-- and the home-pkg inst env (includes module being compiled)</span><span>
</span><a name="line-951"></a><a name="tcGetFamInstEnvs"><a href="FamInst.html#tcGetFamInstEnvs"><span class="hs-identifier">tcGetFamInstEnvs</span></a></a><span>
</span><a name="line-952"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682474288"><a href="#local-6989586621682474288"><span class="hs-identifier">eps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getEps"><span class="hs-identifier hs-var">getEps</span></a><span class="hs-special">;</span><span> </span><a name="local-6989586621682474289"><a href="#local-6989586621682474289"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-953"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">eps_fam_inst_env</span><span> </span><a href="#local-6989586621682474288"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_fam_inst_env</span><span> </span><a href="#local-6989586621682474289"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-954"></a></pre></body></html>