<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998


The @match@ function
-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE ViewPatterns #-}</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Match</span><span> </span><span class="hs-special">(</span><span> </span><a href="Match.html#match"><span class="hs-identifier hs-var">match</span></a><span class="hs-special">,</span><span> </span><a href="Match.html#matchEquations"><span class="hs-identifier hs-var">matchEquations</span></a><span class="hs-special">,</span><span> </span><a href="Match.html#matchWrapper"><span class="hs-identifier hs-var">matchWrapper</span></a><span class="hs-special">,</span><span> </span><a href="Match.html#matchSimply"><span class="hs-identifier hs-var">matchSimply</span></a><span>
</span><a name="line-14"></a><span>             </span><span class="hs-special">,</span><span> </span><a href="Match.html#matchSinglePat"><span class="hs-identifier hs-var">matchSinglePat</span></a><span class="hs-special">,</span><span> </span><a href="Match.html#matchSinglePatVar"><span class="hs-identifier hs-var">matchSinglePatVar</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-#SOURCE</span><span class="hs-pragma">#-}</span><span> </span><a href="DsExpr.html"><span class="hs-identifier">DsExpr</span></a><span> </span><span class="hs-special">(</span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span class="hs-special">,</span><span> </span><a href="DsExpr.html#dsSyntaxExpr"><span class="hs-identifier hs-var">dsSyntaxExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Origin</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="TcHsSyn.html"><span class="hs-identifier">TcHsSyn</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcEvidence</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="Check.html"><span class="hs-identifier">Check</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreSyn</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Literal</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreUtils</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MkCore</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="DsMonad.html"><span class="hs-identifier">DsMonad</span></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="DsBinds.html"><span class="hs-identifier">DsBinds</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="DsGRHSs.html"><span class="hs-identifier">DsGRHSs</span></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="DsUtils.html"><span class="hs-identifier">DsUtils</span></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ConLike</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PatSyn</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="MatchCon.html"><span class="hs-identifier">MatchCon</span></a><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><a href="MatchLit.html"><span class="hs-identifier">MatchLit</span></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Coercion</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">eqCoercion</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">isNewTyCon</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysWiredIn</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">isGenerated</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">il_value</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fl_value</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Unique</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqDFM</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">when</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">groupBy</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-60"></a><span>
</span><a name="line-61"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                The main matching function
*                                                                      *
************************************************************************

The function @match@ is basically the same as in the Wadler chapter
from &quot;The Implementation of Functional Programming Languages&quot;,
except it is monadised, to carry around the name supply, info about
annotations, etc.

Notes on @match@'s arguments, assuming $m$ equations and $n$ patterns:
\begin{enumerate}
\item
A list of $n$ variable names, those variables presumably bound to the
$n$ expressions being matched against the $n$ patterns.  Using the
list of $n$ expressions as the first argument showed no benefit and
some inelegance.

\item
The second argument, a list giving the ``equation info'' for each of
the $m$ equations:
\begin{itemize}
\item
the $n$ patterns for that equation, and
\item
a list of Core bindings [@(Id, CoreExpr)@ pairs] to be ``stuck on
the front'' of the matching code, as in:
\begin{verbatim}
let &lt;binds&gt;
in  &lt;matching-code&gt;
\end{verbatim}
\item
and finally: (ToDo: fill in)

The right way to think about the ``after-match function'' is that it
is an embryonic @CoreExpr@ with a ``hole'' at the end for the
final ``else expression''.
\end{itemize}

There is a data type, @EquationInfo@, defined in module @DsMonad@.

An experiment with re-ordering this information about equations (in
particular, having the patterns available in column-major order)
showed no benefit.

\item
A default expression---what to evaluate if the overall pattern-match
fails.  This expression will (almost?) always be
a measly expression @Var@, unless we know it will only be used once
(as we do in @glue_success_exprs@).

Leaving out this third argument to @match@ (and slamming in lots of
@Var &quot;fail&quot;@s) is a positively {\em bad} idea, because it makes it
impossible to share the default expressions.  (Also, it stands no
chance of working in our post-upheaval world of @Locals@.)
\end{enumerate}

Note: @match@ is often called via @matchWrapper@ (end of this module),
a function that does much of the house-keeping that goes with a call
to @match@.

It is also worth mentioning the {\em typical} way a block of equations
is desugared with @match@.  At each stage, it is the first column of
patterns that is examined.  The steps carried out are roughly:
\begin{enumerate}
\item
Tidy the patterns in column~1 with @tidyEqnInfo@ (this may add
bindings to the second component of the equation-info):
\item
Now {\em unmix} the equations into {\em blocks} [w\/ local function
@match_groups@], in which the equations in a block all have the same
 match group.
(see ``the mixture rule'' in SLPJ).
\item
Call the right match variant on each block of equations; it will do the
appropriate thing for each kind of column-1 pattern.
\end{enumerate}

We are a little more paranoid about the ``empty rule'' (SLPJ, p.~87)
than the Wadler-chapter code for @match@ (p.~93, first @match@ clause).
And gluing the ``success expressions'' together isn't quite so pretty.

This  @match@ uses @tidyEqnInfo@
to get `as'- and `twiddle'-patterns out of the way (tidying), before
applying ``the mixture rule'' (SLPJ, p.~88) [which really {\em
un}mixes the equations], producing a list of equation-info
blocks, each block having as its first column patterns compatible with each other.

Note [Match Ids]
~~~~~~~~~~~~~~~~
Most of the matching functions take an Id or [Id] as argument.  This Id
is the scrutinee(s) of the match. The desugared expression may
sometimes use that Id in a local binding or as a case binder.  So it
should not have an External name; Lint rejects non-top-level binders
with External names (Trac #13043).

See also Note [Localise pattern binders] in DsUtils
-}</span><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span class="hs-keyword">type</span><span> </span><a name="MatchId"><a href="Match.html#MatchId"><span class="hs-identifier">MatchId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Id</span><span>   </span><span class="hs-comment">-- See Note [Match Ids]</span><span>
</span><a name="line-163"></a><span>
</span><a name="line-164"></a><span class="hs-identifier">match</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Match.html#MatchId"><span class="hs-identifier hs-type">MatchId</span></a><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- ^ Variables rep\'ing the exprs we\'re matching with</span><span>
</span><a name="line-165"></a><span>                          </span><span class="hs-comment">-- ^ See Note [Match Ids]</span><span>
</span><a name="line-166"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>             </span><span class="hs-comment">-- ^ Type of the case expression</span><span>
</span><a name="line-167"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- ^ Info about patterns, etc. (type synonym below)</span><span>
</span><a name="line-168"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span>  </span><span class="hs-comment">-- ^ Desugared result!</span><span>
</span><a name="line-169"></a><span>
</span><a name="line-170"></a><a name="match"><a href="Match.html#match"><span class="hs-identifier">match</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621684064032"><a href="#local-6989586621684064032"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621684064033"><a href="#local-6989586621684064033"><span class="hs-identifier">eqns</span></a></a><span>
</span><a name="line-171"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">null</span><span> </span><span class="hs-identifier">eqns</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">ty</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-172"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldr1</span><span> </span><a href="DsUtils.html#combineMatchResults"><span class="hs-identifier hs-var">combineMatchResults</span></a><span> </span><a href="#local-6989586621684064034"><span class="hs-identifier hs-var">match_results</span></a><span class="hs-special">)</span><span>
</span><a name="line-173"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-174"></a><span>    </span><a name="local-6989586621684064034"><a href="#local-6989586621684064034"><span class="hs-identifier">match_results</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">eqn_pats</span><span> </span><span class="hs-identifier hs-var">eqn</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-175"></a><span>                      </span><span class="hs-identifier">eqn_rhs</span><span> </span><a href="#local-6989586621684064035"><span class="hs-identifier hs-var">eqn</span></a><span>
</span><a name="line-176"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621684064035"><a href="#local-6989586621684064035"><span class="hs-identifier">eqn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684064033"><span class="hs-identifier hs-var">eqns</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-177"></a><span>
</span><a name="line-178"></a><span class="hs-identifier">match</span><span> </span><a name="local-6989586621684064036"><a href="#local-6989586621684064036"><span class="hs-identifier">vars</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621684064037"><a href="#local-6989586621684064037"><span class="hs-identifier">v</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684064038"><a href="#local-6989586621684064038"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621684064039"><a href="#local-6989586621684064039"><span class="hs-identifier">eqns</span></a></a><span>    </span><span class="hs-comment">-- Eqns *can* be empty</span><span>
</span><a name="line-179"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isInternalName</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">idName</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">vars</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-identifier">vars</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-180"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684064060"><a href="#local-6989586621684064060"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-181"></a><span>                </span><span class="hs-comment">-- Tidy the first pattern, generating</span><span>
</span><a name="line-182"></a><span>                </span><span class="hs-comment">-- auxiliary bindings if necessary</span><span>
</span><a name="line-183"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684064061"><a href="#local-6989586621684064061"><span class="hs-identifier">aux_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684064062"><a href="#local-6989586621684064062"><span class="hs-identifier">tidy_eqns</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapAndUnzipM</span><span> </span><span class="hs-special">(</span><a href="Match.html#tidyEqnInfo"><span class="hs-identifier hs-var">tidyEqnInfo</span></a><span> </span><a href="#local-6989586621684064037"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684064039"><span class="hs-identifier hs-var">eqns</span></a><span>
</span><a name="line-184"></a><span>
</span><a name="line-185"></a><span>                </span><span class="hs-comment">-- Group the equations and match each group in turn</span><span>
</span><a name="line-186"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684064063"><a href="#local-6989586621684064063"><span class="hs-identifier">grouped</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Match.html#groupEquations"><span class="hs-identifier hs-var">groupEquations</span></a><span> </span><a href="#local-6989586621684064060"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684064062"><span class="hs-identifier hs-var">tidy_eqns</span></a><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span>         </span><span class="hs-comment">-- print the view patterns that are commoned up to help debug</span><span>
</span><a name="line-189"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#whenDOptM"><span class="hs-identifier hs-var">whenDOptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_view_pattern_commoning</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064043"><span class="hs-identifier hs-var">debug</span></a><span> </span><a href="#local-6989586621684064063"><span class="hs-identifier hs-var">grouped</span></a><span class="hs-special">)</span><span>
</span><a name="line-190"></a><span>
</span><a name="line-191"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684064064"><a href="#local-6989586621684064064"><span class="hs-identifier">match_results</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684064041"><span class="hs-identifier hs-var">match_groups</span></a><span> </span><a href="#local-6989586621684064063"><span class="hs-identifier hs-var">grouped</span></a><span>
</span><a name="line-192"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="DsUtils.html#adjustMatchResult"><span class="hs-identifier hs-var">adjustMatchResult</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">.</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><a href="#local-6989586621684064061"><span class="hs-identifier hs-var">aux_binds</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-193"></a><span>                  </span><span class="hs-identifier hs-var">foldr1</span><span> </span><a href="DsUtils.html#combineMatchResults"><span class="hs-identifier hs-var">combineMatchResults</span></a><span> </span><a href="#local-6989586621684064064"><span class="hs-identifier hs-var">match_results</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-194"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-195"></a><span>    </span><span class="hs-identifier">dropGroup</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Match.html#PatGroup"><span class="hs-identifier hs-type">PatGroup</span></a><span class="hs-special">,</span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">]</span><span>
</span><a name="line-196"></a><span>    </span><a name="local-6989586621684064040"><a href="#local-6989586621684064040"><span class="hs-identifier">dropGroup</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span>
</span><a name="line-197"></a><span>
</span><a name="line-198"></a><span>    </span><span class="hs-identifier">match_groups</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Match.html#PatGroup"><span class="hs-identifier hs-type">PatGroup</span></a><span class="hs-special">,</span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">[</span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span class="hs-special">]</span><span>
</span><a name="line-199"></a><span>    </span><span class="hs-comment">-- Result list of [MatchResult] is always non-empty</span><span>
</span><a name="line-200"></a><span>    </span><a name="local-6989586621684064041"><a href="#local-6989586621684064041"><span class="hs-identifier">match_groups</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Match.html#matchEmpty"><span class="hs-identifier hs-var">matchEmpty</span></a><span> </span><a href="#local-6989586621684064037"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621684064038"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-201"></a><span>    </span><span class="hs-identifier">match_groups</span><span> </span><a name="local-6989586621684064044"><a href="#local-6989586621684064044"><span class="hs-identifier">gs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621684064042"><span class="hs-identifier hs-var">match_group</span></a><span> </span><a href="#local-6989586621684064044"><span class="hs-identifier hs-var">gs</span></a><span>
</span><a name="line-202"></a><span>
</span><a name="line-203"></a><span>    </span><span class="hs-identifier">match_group</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Match.html#PatGroup"><span class="hs-identifier hs-type">PatGroup</span></a><span class="hs-special">,</span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span>
</span><a name="line-204"></a><span>    </span><a name="local-6989586621684064042"><a href="#local-6989586621684064042"><span class="hs-identifier">match_group</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;match_group&quot;</span><span>
</span><a name="line-205"></a><span>    </span><span class="hs-identifier">match_group</span><span> </span><a name="local-6989586621684064045"><a href="#local-6989586621684064045"><span class="hs-identifier">eqns</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621684064046"><a href="#local-6989586621684064046"><span class="hs-identifier">group</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-206"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684064046"><span class="hs-identifier hs-var">group</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-207"></a><span>            </span><a href="Match.html#PgCon"><span class="hs-identifier hs-var">PgCon</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MatchCon.html#matchConFamily"><span class="hs-identifier hs-var">matchConFamily</span></a><span>  </span><a href="#local-6989586621684064036"><span class="hs-identifier hs-var">vars</span></a><span> </span><a href="#local-6989586621684064038"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><a href="Match.html#subGroupUniq"><span class="hs-identifier hs-var">subGroupUniq</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621684064047"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">,</span><a href="#local-6989586621684064048"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a href="Match.html#PgCon"><span class="hs-identifier hs-var">PgCon</span></a><span> </span><a name="local-6989586621684064047"><a href="#local-6989586621684064047"><span class="hs-identifier">c</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684064048"><a href="#local-6989586621684064048"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684064045"><span class="hs-identifier hs-var">eqns</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-208"></a><span>            </span><a href="Match.html#PgSyn"><span class="hs-identifier hs-var">PgSyn</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MatchCon.html#matchPatSyn"><span class="hs-identifier hs-var">matchPatSyn</span></a><span>     </span><a href="#local-6989586621684064036"><span class="hs-identifier hs-var">vars</span></a><span> </span><a href="#local-6989586621684064038"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064040"><span class="hs-identifier hs-var">dropGroup</span></a><span> </span><a href="#local-6989586621684064045"><span class="hs-identifier hs-var">eqns</span></a><span class="hs-special">)</span><span>
</span><a name="line-209"></a><span>            </span><a href="Match.html#PgLit"><span class="hs-identifier hs-var">PgLit</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MatchLit.html#matchLiterals"><span class="hs-identifier hs-var">matchLiterals</span></a><span>   </span><a href="#local-6989586621684064036"><span class="hs-identifier hs-var">vars</span></a><span> </span><a href="#local-6989586621684064038"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><a href="Match.html#subGroupOrd"><span class="hs-identifier hs-var">subGroupOrd</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621684064049"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">,</span><a href="#local-6989586621684064050"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a href="Match.html#PgLit"><span class="hs-identifier hs-var">PgLit</span></a><span> </span><a name="local-6989586621684064049"><a href="#local-6989586621684064049"><span class="hs-identifier">l</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684064050"><a href="#local-6989586621684064050"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684064045"><span class="hs-identifier hs-var">eqns</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-210"></a><span>            </span><a href="Match.html#PgAny"><span class="hs-identifier hs-var">PgAny</span></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Match.html#matchVariables"><span class="hs-identifier hs-var">matchVariables</span></a><span>  </span><a href="#local-6989586621684064036"><span class="hs-identifier hs-var">vars</span></a><span> </span><a href="#local-6989586621684064038"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064040"><span class="hs-identifier hs-var">dropGroup</span></a><span> </span><a href="#local-6989586621684064045"><span class="hs-identifier hs-var">eqns</span></a><span class="hs-special">)</span><span>
</span><a name="line-211"></a><span>            </span><a href="Match.html#PgN"><span class="hs-identifier hs-var">PgN</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MatchLit.html#matchNPats"><span class="hs-identifier hs-var">matchNPats</span></a><span>      </span><a href="#local-6989586621684064036"><span class="hs-identifier hs-var">vars</span></a><span> </span><a href="#local-6989586621684064038"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064040"><span class="hs-identifier hs-var">dropGroup</span></a><span> </span><a href="#local-6989586621684064045"><span class="hs-identifier hs-var">eqns</span></a><span class="hs-special">)</span><span>
</span><a name="line-212"></a><span>            </span><a href="Match.html#PgOverS"><span class="hs-identifier hs-var">PgOverS</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-glyph">-&gt;</span><span> </span><a href="MatchLit.html#matchNPats"><span class="hs-identifier hs-var">matchNPats</span></a><span>      </span><a href="#local-6989586621684064036"><span class="hs-identifier hs-var">vars</span></a><span> </span><a href="#local-6989586621684064038"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064040"><span class="hs-identifier hs-var">dropGroup</span></a><span> </span><a href="#local-6989586621684064045"><span class="hs-identifier hs-var">eqns</span></a><span class="hs-special">)</span><span>
</span><a name="line-213"></a><span>            </span><a href="Match.html#PgNpK"><span class="hs-identifier hs-var">PgNpK</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MatchLit.html#matchNPlusKPats"><span class="hs-identifier hs-var">matchNPlusKPats</span></a><span> </span><a href="#local-6989586621684064036"><span class="hs-identifier hs-var">vars</span></a><span> </span><a href="#local-6989586621684064038"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064040"><span class="hs-identifier hs-var">dropGroup</span></a><span> </span><a href="#local-6989586621684064045"><span class="hs-identifier hs-var">eqns</span></a><span class="hs-special">)</span><span>
</span><a name="line-214"></a><span>            </span><a href="Match.html#PgBang"><span class="hs-identifier hs-var">PgBang</span></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Match.html#matchBangs"><span class="hs-identifier hs-var">matchBangs</span></a><span>      </span><a href="#local-6989586621684064036"><span class="hs-identifier hs-var">vars</span></a><span> </span><a href="#local-6989586621684064038"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064040"><span class="hs-identifier hs-var">dropGroup</span></a><span> </span><a href="#local-6989586621684064045"><span class="hs-identifier hs-var">eqns</span></a><span class="hs-special">)</span><span>
</span><a name="line-215"></a><span>            </span><a href="Match.html#PgCo"><span class="hs-identifier hs-var">PgCo</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Match.html#matchCoercion"><span class="hs-identifier hs-var">matchCoercion</span></a><span>   </span><a href="#local-6989586621684064036"><span class="hs-identifier hs-var">vars</span></a><span> </span><a href="#local-6989586621684064038"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064040"><span class="hs-identifier hs-var">dropGroup</span></a><span> </span><a href="#local-6989586621684064045"><span class="hs-identifier hs-var">eqns</span></a><span class="hs-special">)</span><span>
</span><a name="line-216"></a><span>            </span><a href="Match.html#PgView"><span class="hs-identifier hs-var">PgView</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Match.html#matchView"><span class="hs-identifier hs-var">matchView</span></a><span>       </span><a href="#local-6989586621684064036"><span class="hs-identifier hs-var">vars</span></a><span> </span><a href="#local-6989586621684064038"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064040"><span class="hs-identifier hs-var">dropGroup</span></a><span> </span><a href="#local-6989586621684064045"><span class="hs-identifier hs-var">eqns</span></a><span class="hs-special">)</span><span>
</span><a name="line-217"></a><span>            </span><a href="Match.html#PgOverloadedList"><span class="hs-identifier hs-var">PgOverloadedList</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Match.html#matchOverloadedList"><span class="hs-identifier hs-var">matchOverloadedList</span></a><span> </span><a href="#local-6989586621684064036"><span class="hs-identifier hs-var">vars</span></a><span> </span><a href="#local-6989586621684064038"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064040"><span class="hs-identifier hs-var">dropGroup</span></a><span> </span><a href="#local-6989586621684064045"><span class="hs-identifier hs-var">eqns</span></a><span class="hs-special">)</span><span>
</span><a name="line-218"></a><span>
</span><a name="line-219"></a><span>    </span><span class="hs-comment">-- FIXME: we should also warn about view patterns that should be</span><span>
</span><a name="line-220"></a><span>    </span><span class="hs-comment">-- commoned up but are not</span><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span>    </span><span class="hs-comment">-- print some stuff to see what's getting grouped</span><span>
</span><a name="line-223"></a><span>    </span><span class="hs-comment">-- use -dppr-debug to see the resolution of overloaded literals</span><span>
</span><a name="line-224"></a><span>    </span><a name="local-6989586621684064043"><a href="#local-6989586621684064043"><span class="hs-identifier">debug</span></a></a><span> </span><a name="local-6989586621684064051"><a href="#local-6989586621684064051"><span class="hs-identifier">eqns</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-225"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684064052"><a href="#local-6989586621684064052"><span class="hs-identifier">gs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684064054"><a href="#local-6989586621684064054"><span class="hs-identifier">group</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684064055"><a href="#local-6989586621684064055"><span class="hs-identifier">p</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621684064056"><a href="#local-6989586621684064056"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-226"></a><span>                                           </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684064055"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-keyword">of</span><span> </span><a href="Match.html#PgView"><span class="hs-identifier hs-var">PgView</span></a><span> </span><a name="local-6989586621684064057"><a href="#local-6989586621684064057"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684064057"><span class="hs-identifier hs-var">e</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684064056"><span class="hs-identifier hs-var">acc</span></a><span>
</span><a name="line-227"></a><span>                                                     </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684064056"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621684064054"><span class="hs-identifier hs-var">group</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684064051"><span class="hs-identifier hs-var">eqns</span></a><span>
</span><a name="line-228"></a><span>            </span><a name="local-6989586621684064053"><a href="#local-6989586621684064053"><span class="hs-identifier">maybeWarn</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-229"></a><span>            </span><span class="hs-identifier">maybeWarn</span><span> </span><a name="local-6989586621684064058"><a href="#local-6989586621684064058"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#warnDs"><span class="hs-identifier hs-var">warnDs</span></a><span> </span><span class="hs-identifier hs-var">NoReason</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><a href="#local-6989586621684064058"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span>
</span><a name="line-230"></a><span>        </span><span class="hs-keyword">in</span><span>
</span><a name="line-231"></a><span>          </span><a href="#local-6989586621684064053"><span class="hs-identifier hs-var">maybeWarn</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684064059"><a href="#local-6989586621684064059"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Putting these view expressions into the same case:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684064059"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-232"></a><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">null</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684064052"><span class="hs-identifier hs-var">gs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-233"></a><span>
</span><a name="line-234"></a><span class="hs-identifier">matchEmpty</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Match.html#MatchId"><span class="hs-identifier hs-type">MatchId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">[</span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span class="hs-special">]</span><span>
</span><a name="line-235"></a><span class="hs-comment">-- See Note [Empty case expressions]</span><span>
</span><a name="line-236"></a><a name="matchEmpty"><a href="Match.html#matchEmpty"><span class="hs-identifier">matchEmpty</span></a></a><span> </span><a name="local-6989586621684064065"><a href="#local-6989586621684064065"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621684064066"><a href="#local-6989586621684064066"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-237"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-var">MatchResult</span></a><span> </span><a href="DsMonad.html#CanFail"><span class="hs-identifier hs-var">CanFail</span></a><span> </span><a href="#local-6989586621684064067"><span class="hs-identifier hs-var">mk_seq</span></a><span class="hs-special">]</span><span>
</span><a name="line-238"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-239"></a><span>    </span><a name="local-6989586621684064067"><a href="#local-6989586621684064067"><span class="hs-identifier">mk_seq</span></a></a><span> </span><a name="local-6989586621684064068"><a href="#local-6989586621684064068"><span class="hs-identifier">fail</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkWildCase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684064065"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621684064065"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684064066"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-240"></a><span>                                      </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DEFAULT</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684064068"><span class="hs-identifier hs-var">fail</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-241"></a><span>
</span><a name="line-242"></a><span class="hs-identifier">matchVariables</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Match.html#MatchId"><span class="hs-identifier hs-type">MatchId</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span>
</span><a name="line-243"></a><span class="hs-comment">-- Real true variables, just like in matchVar, SLPJ p 94</span><span>
</span><a name="line-244"></a><span class="hs-comment">-- No binding to do: they'll all be wildcards by now (done in tidy)</span><span>
</span><a name="line-245"></a><a name="matchVariables"><a href="Match.html#matchVariables"><span class="hs-identifier">matchVariables</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><a name="local-6989586621684064069"><a href="#local-6989586621684064069"><span class="hs-identifier">vars</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684064070"><a href="#local-6989586621684064070"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621684064071"><a href="#local-6989586621684064071"><span class="hs-identifier">eqns</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Match.html#match"><span class="hs-identifier hs-var">match</span></a><span> </span><a href="#local-6989586621684064069"><span class="hs-identifier hs-var">vars</span></a><span> </span><a href="#local-6989586621684064070"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><a href="DsUtils.html#shiftEqns"><span class="hs-identifier hs-var">shiftEqns</span></a><span> </span><a href="#local-6989586621684064071"><span class="hs-identifier hs-var">eqns</span></a><span class="hs-special">)</span><span>
</span><a name="line-246"></a><span class="hs-identifier">matchVariables</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;matchVariables&quot;</span><span>
</span><a name="line-247"></a><span>
</span><a name="line-248"></a><span class="hs-identifier">matchBangs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Match.html#MatchId"><span class="hs-identifier hs-type">MatchId</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span>
</span><a name="line-249"></a><a name="matchBangs"><a href="Match.html#matchBangs"><span class="hs-identifier">matchBangs</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684064072"><a href="#local-6989586621684064072"><span class="hs-identifier">var</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684064073"><a href="#local-6989586621684064073"><span class="hs-identifier">vars</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684064074"><a href="#local-6989586621684064074"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621684064075"><a href="#local-6989586621684064075"><span class="hs-identifier">eqns</span></a></a><span>
</span><a name="line-250"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684064076"><a href="#local-6989586621684064076"><span class="hs-identifier">match_result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Match.html#match"><span class="hs-identifier hs-var">match</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064072"><span class="hs-identifier hs-var">var</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684064073"><span class="hs-identifier hs-var">vars</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684064074"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-251"></a><span>                          </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Match.html#decomposeFirstPat"><span class="hs-identifier hs-var">decomposeFirstPat</span></a><span> </span><a href="Match.html#getBangPat"><span class="hs-identifier hs-var">getBangPat</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684064075"><span class="hs-identifier hs-var">eqns</span></a><span>
</span><a name="line-252"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="DsUtils.html#mkEvalMatchResult"><span class="hs-identifier hs-var">mkEvalMatchResult</span></a><span> </span><a href="#local-6989586621684064072"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621684064074"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621684064076"><span class="hs-identifier hs-var">match_result</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-253"></a><span class="hs-identifier">matchBangs</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;matchBangs&quot;</span><span>
</span><a name="line-254"></a><span>
</span><a name="line-255"></a><span class="hs-identifier">matchCoercion</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Match.html#MatchId"><span class="hs-identifier hs-type">MatchId</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span>
</span><a name="line-256"></a><span class="hs-comment">-- Apply the coercion to the match variable and then match that</span><span>
</span><a name="line-257"></a><a name="matchCoercion"><a href="Match.html#matchCoercion"><span class="hs-identifier">matchCoercion</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684064077"><a href="#local-6989586621684064077"><span class="hs-identifier">var</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684064078"><a href="#local-6989586621684064078"><span class="hs-identifier">vars</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684064079"><a href="#local-6989586621684064079"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684064080"><a href="#local-6989586621684064080"><span class="hs-identifier">eqns</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621684064081"><a href="#local-6989586621684064081"><span class="hs-identifier">eqn1</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-258"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier hs-var">CoPat</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064082"><a href="#local-6989586621684064082"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621684064083"><a href="#local-6989586621684064083"><span class="hs-identifier">pat</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#firstPat"><span class="hs-identifier hs-var">firstPat</span></a><span> </span><a href="#local-6989586621684064081"><span class="hs-identifier hs-var">eqn1</span></a><span>
</span><a name="line-259"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684064084"><a href="#local-6989586621684064084"><span class="hs-identifier">pat_ty'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsSyn.html#hsPatType"><span class="hs-identifier hs-var">hsPatType</span></a><span> </span><a href="#local-6989586621684064083"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-260"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684064085"><a href="#local-6989586621684064085"><span class="hs-identifier">var'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#newUniqueId"><span class="hs-identifier hs-var">newUniqueId</span></a><span> </span><a href="#local-6989586621684064077"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621684064084"><span class="hs-identifier hs-var">pat_ty'</span></a><span>
</span><a name="line-261"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684064086"><a href="#local-6989586621684064086"><span class="hs-identifier">match_result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Match.html#match"><span class="hs-identifier hs-var">match</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064085"><span class="hs-identifier hs-var">var'</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684064078"><span class="hs-identifier hs-var">vars</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684064079"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-262"></a><span>                          </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Match.html#decomposeFirstPat"><span class="hs-identifier hs-var">decomposeFirstPat</span></a><span> </span><a href="Match.html#getCoPat"><span class="hs-identifier hs-var">getCoPat</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684064080"><span class="hs-identifier hs-var">eqns</span></a><span>
</span><a name="line-263"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684064087"><a href="#local-6989586621684064087"><span class="hs-identifier">core_wrap</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#dsHsWrapper"><span class="hs-identifier hs-var">dsHsWrapper</span></a><span> </span><a href="#local-6989586621684064082"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-264"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684064088"><a href="#local-6989586621684064088"><span class="hs-identifier">bind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621684064085"><span class="hs-identifier hs-var">var'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064087"><span class="hs-identifier hs-var">core_wrap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684064077"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-265"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="DsUtils.html#mkCoLetMatchResult"><span class="hs-identifier hs-var">mkCoLetMatchResult</span></a><span> </span><a href="#local-6989586621684064088"><span class="hs-identifier hs-var">bind</span></a><span> </span><a href="#local-6989586621684064086"><span class="hs-identifier hs-var">match_result</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-266"></a><span class="hs-identifier">matchCoercion</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;matchCoercion&quot;</span><span>
</span><a name="line-267"></a><span>
</span><a name="line-268"></a><span class="hs-identifier">matchView</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Match.html#MatchId"><span class="hs-identifier hs-type">MatchId</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span>
</span><a name="line-269"></a><span class="hs-comment">-- Apply the view function to the match variable and then match that</span><span>
</span><a name="line-270"></a><a name="matchView"><a href="Match.html#matchView"><span class="hs-identifier">matchView</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684064089"><a href="#local-6989586621684064089"><span class="hs-identifier">var</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684064090"><a href="#local-6989586621684064090"><span class="hs-identifier">vars</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684064091"><a href="#local-6989586621684064091"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684064092"><a href="#local-6989586621684064092"><span class="hs-identifier">eqns</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621684064093"><a href="#local-6989586621684064093"><span class="hs-identifier">eqn1</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-271"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- we could pass in the expr from the PgView,</span><span>
</span><a name="line-272"></a><span>         </span><span class="hs-comment">-- but this needs to extract the pat anyway</span><span>
</span><a name="line-273"></a><span>         </span><span class="hs-comment">-- to figure out the type of the fresh variable</span><span>
</span><a name="line-274"></a><span>         </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier hs-var">ViewPat</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064094"><a href="#local-6989586621684064094"><span class="hs-identifier">viewExpr</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064095"><a href="#local-6989586621684064095"><span class="hs-identifier">pat</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#firstPat"><span class="hs-identifier hs-var">firstPat</span></a><span> </span><a href="#local-6989586621684064093"><span class="hs-identifier hs-var">eqn1</span></a><span>
</span><a name="line-275"></a><span>         </span><span class="hs-comment">-- do the rest of the compilation</span><span>
</span><a name="line-276"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684064096"><a href="#local-6989586621684064096"><span class="hs-identifier">pat_ty'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsSyn.html#hsPatType"><span class="hs-identifier hs-var">hsPatType</span></a><span> </span><a href="#local-6989586621684064095"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-277"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684064097"><a href="#local-6989586621684064097"><span class="hs-identifier">var'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#newUniqueId"><span class="hs-identifier hs-var">newUniqueId</span></a><span> </span><a href="#local-6989586621684064089"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621684064096"><span class="hs-identifier hs-var">pat_ty'</span></a><span>
</span><a name="line-278"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684064098"><a href="#local-6989586621684064098"><span class="hs-identifier">match_result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Match.html#match"><span class="hs-identifier hs-var">match</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064097"><span class="hs-identifier hs-var">var'</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684064090"><span class="hs-identifier hs-var">vars</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684064091"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-279"></a><span>                          </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Match.html#decomposeFirstPat"><span class="hs-identifier hs-var">decomposeFirstPat</span></a><span> </span><a href="Match.html#getViewPat"><span class="hs-identifier hs-var">getViewPat</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684064092"><span class="hs-identifier hs-var">eqns</span></a><span>
</span><a name="line-280"></a><span>         </span><span class="hs-comment">-- compile the view expressions</span><span>
</span><a name="line-281"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684064099"><a href="#local-6989586621684064099"><span class="hs-identifier">viewExpr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684064094"><span class="hs-identifier hs-var">viewExpr</span></a><span>
</span><a name="line-282"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="DsUtils.html#mkViewMatchResult"><span class="hs-identifier hs-var">mkViewMatchResult</span></a><span> </span><a href="#local-6989586621684064097"><span class="hs-identifier hs-var">var'</span></a><span>
</span><a name="line-283"></a><span>                    </span><span class="hs-special">(</span><a href="DsUtils.html#mkCoreAppDs"><span class="hs-identifier hs-var">mkCoreAppDs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;matchView&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684064099"><span class="hs-identifier hs-var">viewExpr'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684064089"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-284"></a><span>                    </span><a href="#local-6989586621684064098"><span class="hs-identifier hs-var">match_result</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-285"></a><span class="hs-identifier">matchView</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;matchView&quot;</span><span>
</span><a name="line-286"></a><span>
</span><a name="line-287"></a><span class="hs-identifier">matchOverloadedList</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Match.html#MatchId"><span class="hs-identifier hs-type">MatchId</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span>
</span><a name="line-288"></a><a name="matchOverloadedList"><a href="Match.html#matchOverloadedList"><span class="hs-identifier">matchOverloadedList</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684064100"><a href="#local-6989586621684064100"><span class="hs-identifier">var</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684064101"><a href="#local-6989586621684064101"><span class="hs-identifier">vars</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684064102"><a href="#local-6989586621684064102"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684064103"><a href="#local-6989586621684064103"><span class="hs-identifier">eqns</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621684064104"><a href="#local-6989586621684064104"><span class="hs-identifier">eqn1</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-289"></a><span class="hs-comment">-- Since overloaded list patterns are treated as view patterns,</span><span>
</span><a name="line-290"></a><span class="hs-comment">-- the code is roughly the same as for matchView</span><span>
</span><a name="line-291"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier hs-var">ListPat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ListPatTc</span><span> </span><a name="local-6989586621684064105"><a href="#local-6989586621684064105"><span class="hs-identifier">elt_ty</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621684064106"><a href="#local-6989586621684064106"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#firstPat"><span class="hs-identifier hs-var">firstPat</span></a><span> </span><a href="#local-6989586621684064104"><span class="hs-identifier hs-var">eqn1</span></a><span>
</span><a name="line-292"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684064107"><a href="#local-6989586621684064107"><span class="hs-identifier">var'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#newUniqueId"><span class="hs-identifier hs-var">newUniqueId</span></a><span> </span><a href="#local-6989586621684064100"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkListTy</span><span> </span><a href="#local-6989586621684064105"><span class="hs-identifier hs-var">elt_ty</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- we construct the overall type by hand</span><span>
</span><a name="line-293"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684064108"><a href="#local-6989586621684064108"><span class="hs-identifier">match_result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Match.html#match"><span class="hs-identifier hs-var">match</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064107"><span class="hs-identifier hs-var">var'</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684064101"><span class="hs-identifier hs-var">vars</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684064102"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-294"></a><span>                            </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Match.html#decomposeFirstPat"><span class="hs-identifier hs-var">decomposeFirstPat</span></a><span> </span><a href="Match.html#getOLPat"><span class="hs-identifier hs-var">getOLPat</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684064103"><span class="hs-identifier hs-var">eqns</span></a><span> </span><span class="hs-comment">-- getOLPat builds the pattern inside as a non-overloaded version of the overloaded list pattern</span><span>
</span><a name="line-295"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684064109"><a href="#local-6989586621684064109"><span class="hs-identifier">e'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsSyntaxExpr"><span class="hs-identifier hs-var">dsSyntaxExpr</span></a><span> </span><a href="#local-6989586621684064106"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684064100"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">]</span><span>
</span><a name="line-296"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="DsUtils.html#mkViewMatchResult"><span class="hs-identifier hs-var">mkViewMatchResult</span></a><span> </span><a href="#local-6989586621684064107"><span class="hs-identifier hs-var">var'</span></a><span> </span><a href="#local-6989586621684064109"><span class="hs-identifier hs-var">e'</span></a><span> </span><a href="#local-6989586621684064108"><span class="hs-identifier hs-var">match_result</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-297"></a><span class="hs-identifier">matchOverloadedList</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;matchOverloadedList&quot;</span><span>
</span><a name="line-298"></a><span>
</span><a name="line-299"></a><span class="hs-comment">-- decompose the first pattern and leave the rest alone</span><span>
</span><a name="line-300"></a><span class="hs-identifier">decomposeFirstPat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Pat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Pat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span>
</span><a name="line-301"></a><a name="decomposeFirstPat"><a href="Match.html#decomposeFirstPat"><span class="hs-identifier">decomposeFirstPat</span></a></a><span> </span><a name="local-6989586621684064110"><a href="#local-6989586621684064110"><span class="hs-identifier">extractpat</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684064111"><a href="#local-6989586621684064111"><span class="hs-identifier">eqn</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="DsMonad.html#EqnInfo"><span class="hs-identifier hs-var">EqnInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">eqn_pats</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684064112"><a href="#local-6989586621684064112"><span class="hs-identifier">pat</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684064113"><a href="#local-6989586621684064113"><span class="hs-identifier">pats</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-302"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064111"><span class="hs-identifier hs-var">eqn</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">eqn_pats</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064110"><span class="hs-identifier hs-var">extractpat</span></a><span> </span><a href="#local-6989586621684064112"><span class="hs-identifier hs-var">pat</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684064113"><span class="hs-identifier hs-var">pats</span></a><span class="hs-special">}</span><span>
</span><a name="line-303"></a><span class="hs-identifier">decomposeFirstPat</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;decomposeFirstPat&quot;</span><span>
</span><a name="line-304"></a><span>
</span><a name="line-305"></a><span class="hs-identifier">getCoPat</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">getBangPat</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">getViewPat</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">getOLPat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Pat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Pat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-306"></a><a name="getCoPat"><a href="Match.html#getCoPat"><span class="hs-identifier">getCoPat</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoPat</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064114"><a href="#local-6989586621684064114"><span class="hs-identifier">pat</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064114"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-307"></a><span class="hs-identifier">getCoPat</span><span> </span><span class="hs-identifier">_</span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;getCoPat&quot;</span><span>
</span><a name="line-308"></a><a name="getBangPat"><a href="Match.html#getBangPat"><span class="hs-identifier">getBangPat</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BangPat</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064115"><a href="#local-6989586621684064115"><span class="hs-identifier">pat</span></a></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621684064115"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-309"></a><span class="hs-identifier">getBangPat</span><span> </span><span class="hs-identifier">_</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;getBangPat&quot;</span><span>
</span><a name="line-310"></a><a name="getViewPat"><a href="Match.html#getViewPat"><span class="hs-identifier">getViewPat</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ViewPat</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064116"><a href="#local-6989586621684064116"><span class="hs-identifier">pat</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621684064116"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-311"></a><span class="hs-identifier">getViewPat</span><span> </span><span class="hs-identifier">_</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;getViewPat&quot;</span><span>
</span><a name="line-312"></a><a name="getOLPat"><a href="Match.html#getOLPat"><span class="hs-identifier">getOLPat</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ListPat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ListPatTc</span><span> </span><a name="local-6989586621684064117"><a href="#local-6989586621684064117"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684064118"><a href="#local-6989586621684064118"><span class="hs-identifier">pats</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-313"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ListPat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ListPatTc</span><span> </span><a href="#local-6989586621684064117"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>  </span><a href="#local-6989586621684064118"><span class="hs-identifier hs-var">pats</span></a><span>
</span><a name="line-314"></a><span class="hs-identifier">getOLPat</span><span> </span><span class="hs-identifier">_</span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;getOLPat&quot;</span><span>
</span><a name="line-315"></a><span>
</span><a name="line-316"></a><span class="hs-comment">{-
Note [Empty case alternatives]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The list of EquationInfo can be empty, arising from
    case x of {}   or    \case {}
In that situation we desugar to
    case x of { _ -&gt; error &quot;pattern match failure&quot; }
The *desugarer* isn't certain whether there really should be no
alternatives, so it adds a default case, as it always does.  A later
pass may remove it if it's inaccessible.  (See also Note [Empty case
alternatives] in CoreSyn.)

We do *not* desugar simply to
   error &quot;empty case&quot;
or some such, because 'x' might be bound to (error &quot;hello&quot;), in which
case we want to see that &quot;hello&quot; exception, not (error &quot;empty case&quot;).
See also Note [Case elimination: lifted case] in Simplify.


************************************************************************
*                                                                      *
                Tidying patterns
*                                                                      *
************************************************************************

Tidy up the leftmost pattern in an @EquationInfo@, given the variable @v@
which will be scrutinised.

This makes desugaring the pattern match simpler by transforming some of
the patterns to simpler forms. (Tuples to Constructor Patterns)

Among other things in the resulting Pattern:
* Variables and irrefutable(lazy) patterns are replaced by Wildcards
* As patterns are replaced by the patterns they wrap.

The bindings created by the above patterns are put into the returned wrapper
instead.

This means a definition of the form:
  f x = rhs
when called with v get's desugared to the equivalent of:
  let x = v
  in
  f _ = rhs

The same principle holds for as patterns (@) and
irrefutable/lazy patterns (~).
In the case of irrefutable patterns the irrefutable pattern is pushed into
the binding.

Pattern Constructors which only represent syntactic sugar are converted into
their desugared representation.
This usually means converting them to Constructor patterns but for some
depends on enabled extensions. (Eg OverloadedLists)

GHC also tries to convert overloaded Literals into regular ones.

The result of this tidying is that the column of patterns will include
only these which can be assigned a PatternGroup (see patGroup).

-}</span><span>
</span><a name="line-377"></a><span>
</span><a name="line-378"></a><span class="hs-identifier">tidyEqnInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span>
</span><a name="line-379"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><a href="DsMonad.html#DsWrapper"><span class="hs-identifier hs-type">DsWrapper</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">)</span><span>
</span><a name="line-380"></a><span>        </span><span class="hs-comment">-- DsM'd because of internal call to dsLHsBinds</span><span>
</span><a name="line-381"></a><span>        </span><span class="hs-comment">--      and mkSelectorBinds.</span><span>
</span><a name="line-382"></a><span>        </span><span class="hs-comment">-- &quot;tidy1&quot; does the interesting stuff, looking at</span><span>
</span><a name="line-383"></a><span>        </span><span class="hs-comment">-- one pattern and fiddling the list of bindings.</span><span>
</span><a name="line-384"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-385"></a><span>        </span><span class="hs-comment">-- POST CONDITION: head pattern in the EqnInfo is</span><span>
</span><a name="line-386"></a><span>        </span><span class="hs-comment">--      one of these for which patGroup is defined.</span><span>
</span><a name="line-387"></a><span>
</span><a name="line-388"></a><a name="tidyEqnInfo"><a href="Match.html#tidyEqnInfo"><span class="hs-identifier">tidyEqnInfo</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="DsMonad.html#EqnInfo"><span class="hs-identifier hs-var">EqnInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">eqn_pats</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-389"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tidyEqnInfo&quot;</span><span>
</span><a name="line-390"></a><span>
</span><a name="line-391"></a><span class="hs-identifier">tidyEqnInfo</span><span> </span><a name="local-6989586621684064119"><a href="#local-6989586621684064119"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621684064120"><a href="#local-6989586621684064120"><span class="hs-identifier">eqn</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="DsMonad.html#EqnInfo"><span class="hs-identifier hs-var">EqnInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">eqn_pats</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684064121"><a href="#local-6989586621684064121"><span class="hs-identifier">pat</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684064122"><a href="#local-6989586621684064122"><span class="hs-identifier">pats</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">eqn_orig</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684064123"><a href="#local-6989586621684064123"><span class="hs-identifier">orig</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-392"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684064124"><a href="#local-6989586621684064124"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684064125"><a href="#local-6989586621684064125"><span class="hs-identifier">pat'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Match.html#tidy1"><span class="hs-identifier hs-var">tidy1</span></a><span> </span><a href="#local-6989586621684064119"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621684064123"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621684064121"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-393"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064124"><span class="hs-identifier hs-var">wrap</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684064120"><span class="hs-identifier hs-var">eqn</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">eqn_pats</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="#local-6989586621684064125"><span class="hs-identifier hs-var">pat'</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684064122"><span class="hs-identifier hs-var">pats</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-394"></a><span>
</span><a name="line-395"></a><span class="hs-identifier">tidy1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span>                  </span><span class="hs-comment">-- The Id being scrutinised</span><span>
</span><a name="line-396"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Origin</span><span>              </span><span class="hs-comment">-- Was this a pattern the user wrote?</span><span>
</span><a name="line-397"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Pat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>           </span><span class="hs-comment">-- The pattern against which it is to be matched</span><span>
</span><a name="line-398"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><a href="DsMonad.html#DsWrapper"><span class="hs-identifier hs-type">DsWrapper</span></a><span class="hs-special">,</span><span>     </span><span class="hs-comment">-- Extra bindings to do before the match</span><span>
</span><a name="line-399"></a><span>              </span><span class="hs-identifier hs-type">Pat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- Equivalent pattern</span><span>
</span><a name="line-400"></a><span>
</span><a name="line-401"></a><span class="hs-comment">-------------------------------------------------------</span><span>
</span><a name="line-402"></a><span class="hs-comment">--      (pat', mr') = tidy1 v pat mr</span><span>
</span><a name="line-403"></a><span class="hs-comment">-- tidies the *outer level only* of pat, giving pat'</span><span>
</span><a name="line-404"></a><span class="hs-comment">-- It eliminates many pattern forms (as-patterns, variable patterns,</span><span>
</span><a name="line-405"></a><span class="hs-comment">-- list patterns, etc) and returns any created bindings in the wrapper.</span><span>
</span><a name="line-406"></a><span>
</span><a name="line-407"></a><a name="tidy1"><a href="Match.html#tidy1"><span class="hs-identifier">tidy1</span></a></a><span> </span><a name="local-6989586621684064126"><a href="#local-6989586621684064126"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621684064127"><a href="#local-6989586621684064127"><span class="hs-identifier">o</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParPat</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064128"><a href="#local-6989586621684064128"><span class="hs-identifier">pat</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Match.html#tidy1"><span class="hs-identifier hs-var">tidy1</span></a><span> </span><a href="#local-6989586621684064126"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621684064127"><span class="hs-identifier hs-var">o</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621684064128"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">)</span><span>
</span><a name="line-408"></a><span class="hs-identifier">tidy1</span><span> </span><a name="local-6989586621684064129"><a href="#local-6989586621684064129"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621684064130"><a href="#local-6989586621684064130"><span class="hs-identifier">o</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SigPat</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064131"><a href="#local-6989586621684064131"><span class="hs-identifier">pat</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Match.html#tidy1"><span class="hs-identifier hs-var">tidy1</span></a><span> </span><a href="#local-6989586621684064129"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621684064130"><span class="hs-identifier hs-var">o</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621684064131"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">)</span><span>
</span><a name="line-409"></a><span class="hs-identifier">tidy1</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WildPat</span><span> </span><a name="local-6989586621684064132"><a href="#local-6989586621684064132"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="DsMonad.html#idDsWrapper"><span class="hs-identifier hs-var">idDsWrapper</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">WildPat</span><span> </span><a href="#local-6989586621684064132"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-410"></a><span class="hs-identifier">tidy1</span><span> </span><a name="local-6989586621684064133"><a href="#local-6989586621684064133"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621684064134"><a href="#local-6989586621684064134"><span class="hs-identifier">o</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BangPat</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621684064135"><a href="#local-6989586621684064135"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621684064136"><a href="#local-6989586621684064136"><span class="hs-identifier">p</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Match.html#tidy_bang_pat"><span class="hs-identifier hs-var">tidy_bang_pat</span></a><span> </span><a href="#local-6989586621684064133"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621684064134"><span class="hs-identifier hs-var">o</span></a><span> </span><a href="#local-6989586621684064135"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621684064136"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-411"></a><span>
</span><a name="line-412"></a><span>        </span><span class="hs-comment">-- case v of { x -&gt; mr[] }</span><span>
</span><a name="line-413"></a><span>        </span><span class="hs-comment">-- = case v of { _ -&gt; let x=v in mr[] }</span><span>
</span><a name="line-414"></a><span class="hs-identifier">tidy1</span><span> </span><a name="local-6989586621684064137"><a href="#local-6989586621684064137"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarPat</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064138"><a href="#local-6989586621684064138"><span class="hs-identifier">var</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-415"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="DsUtils.html#wrapBind"><span class="hs-identifier hs-var">wrapBind</span></a><span> </span><a href="#local-6989586621684064138"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621684064137"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">WildPat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621684064138"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-416"></a><span>
</span><a name="line-417"></a><span>        </span><span class="hs-comment">-- case v of { x@p -&gt; mr[] }</span><span>
</span><a name="line-418"></a><span>        </span><span class="hs-comment">-- = case v of { p -&gt; let x=v in mr[] }</span><span>
</span><a name="line-419"></a><span class="hs-identifier">tidy1</span><span> </span><a name="local-6989586621684064139"><a href="#local-6989586621684064139"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621684064140"><a href="#local-6989586621684064140"><span class="hs-identifier">o</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AsPat</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064141"><a href="#local-6989586621684064141"><span class="hs-identifier">var</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684064142"><a href="#local-6989586621684064142"><span class="hs-identifier">pat</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-420"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684064143"><a href="#local-6989586621684064143"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684064144"><a href="#local-6989586621684064144"><span class="hs-identifier">pat'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Match.html#tidy1"><span class="hs-identifier hs-var">tidy1</span></a><span> </span><a href="#local-6989586621684064139"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621684064140"><span class="hs-identifier hs-var">o</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621684064142"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">)</span><span>
</span><a name="line-421"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="DsUtils.html#wrapBind"><span class="hs-identifier hs-var">wrapBind</span></a><span> </span><a href="#local-6989586621684064141"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621684064139"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621684064143"><span class="hs-identifier hs-var">wrap</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684064144"><span class="hs-identifier hs-var">pat'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-422"></a><span>
</span><a name="line-423"></a><span class="hs-comment">{- now, here we handle lazy patterns:
    tidy1 v ~p bs = (v, v1 = case v of p -&gt; v1 :
                        v2 = case v of p -&gt; v2 : ... : bs )

    where the v_i's are the binders in the pattern.

    ToDo: in &quot;v_i = ... -&gt; v_i&quot;, are the v_i's really the same thing?

    The case expr for v_i is just: match [v] [(p, [], \ x -&gt; Var v_i)] any_expr
-}</span><span>
</span><a name="line-433"></a><span>
</span><a name="line-434"></a><span class="hs-identifier">tidy1</span><span> </span><a name="local-6989586621684064145"><a href="#local-6989586621684064145"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LazyPat</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064146"><a href="#local-6989586621684064146"><span class="hs-identifier">pat</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-435"></a><span>    </span><span class="hs-comment">-- This is a convenient place to check for unlifted types under a lazy pattern.</span><span>
</span><a name="line-436"></a><span>    </span><span class="hs-comment">-- Doing this check during type-checking is unsatisfactory because we may</span><span>
</span><a name="line-437"></a><span>    </span><span class="hs-comment">-- not fully know the zonked types yet. We sure do here.</span><span>
</span><a name="line-438"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684064147"><a href="#local-6989586621684064147"><span class="hs-identifier">unlifted_bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isUnliftedType</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">idType</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">collectPatBinders</span><span> </span><a href="#local-6989586621684064146"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">)</span><span>
</span><a name="line-439"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621684064147"><span class="hs-identifier hs-var">unlifted_bndrs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-440"></a><span>          </span><a href="DsMonad.html#putSrcSpanDs"><span class="hs-identifier hs-var">putSrcSpanDs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getLoc</span><span> </span><a href="#local-6989586621684064146"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-441"></a><span>          </span><a href="DsMonad.html#errDs"><span class="hs-identifier hs-var">errDs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;A lazy (~) pattern cannot bind variables of unlifted type.&quot;</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-442"></a><span>                       </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Unlifted variables:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-443"></a><span>                    </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684064148"><a href="#local-6989586621684064148"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684064148"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621684064148"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-444"></a><span>                                 </span><a href="#local-6989586621684064147"><span class="hs-identifier hs-var">unlifted_bndrs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-445"></a><span>
</span><a name="line-446"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621684064149"><a href="#local-6989586621684064149"><span class="hs-identifier">sel_prs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsUtils.html#mkSelectorBinds"><span class="hs-identifier hs-var">mkSelectorBinds</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621684064146"><span class="hs-identifier hs-var">pat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684064145"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-447"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684064150"><a href="#local-6989586621684064150"><span class="hs-identifier">sel_binds</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-special">[</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621684064151"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621684064152"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684064151"><a href="#local-6989586621684064151"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><a name="local-6989586621684064152"><a href="#local-6989586621684064152"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684064149"><span class="hs-identifier hs-var">sel_prs</span></a><span class="hs-special">]</span><span>
</span><a name="line-448"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCoreLets</span><span> </span><a href="#local-6989586621684064150"><span class="hs-identifier hs-var">sel_binds</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">WildPat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621684064145"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-449"></a><span>
</span><a name="line-450"></a><span class="hs-identifier">tidy1</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ListPat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ListPatTc</span><span> </span><a name="local-6989586621684064153"><a href="#local-6989586621684064153"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684064154"><a href="#local-6989586621684064154"><span class="hs-identifier">pats</span></a></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-451"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="DsMonad.html#idDsWrapper"><span class="hs-identifier hs-var">idDsWrapper</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621684064155"><span class="hs-identifier hs-var">list_ConPat</span></a><span class="hs-special">)</span><span>
</span><a name="line-452"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-453"></a><span>    </span><a name="local-6989586621684064155"><a href="#local-6989586621684064155"><span class="hs-identifier">list_ConPat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621684064156"><a href="#local-6989586621684064156"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621684064157"><a href="#local-6989586621684064157"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">mkPrefixConPat</span><span> </span><span class="hs-identifier hs-var">consDataCon</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684064156"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684064157"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684064153"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-454"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkNilPat</span><span> </span><a href="#local-6989586621684064153"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-455"></a><span>                        </span><a href="#local-6989586621684064154"><span class="hs-identifier hs-var">pats</span></a><span>
</span><a name="line-456"></a><span>
</span><a name="line-457"></a><span class="hs-identifier">tidy1</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TuplePat</span><span> </span><a name="local-6989586621684064158"><a href="#local-6989586621684064158"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-6989586621684064159"><a href="#local-6989586621684064159"><span class="hs-identifier">pats</span></a></a><span> </span><a name="local-6989586621684064160"><a href="#local-6989586621684064160"><span class="hs-identifier">boxity</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-458"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="DsMonad.html#idDsWrapper"><span class="hs-identifier hs-var">idDsWrapper</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621684064162"><span class="hs-identifier hs-var">tuple_ConPat</span></a><span class="hs-special">)</span><span>
</span><a name="line-459"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-460"></a><span>    </span><a name="local-6989586621684064161"><a href="#local-6989586621684064161"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621684064159"><span class="hs-identifier hs-var">pats</span></a><span>
</span><a name="line-461"></a><span>    </span><a name="local-6989586621684064162"><a href="#local-6989586621684064162"><span class="hs-identifier">tuple_ConPat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkPrefixConPat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tupleDataCon</span><span> </span><a href="#local-6989586621684064160"><span class="hs-identifier hs-var">boxity</span></a><span> </span><a href="#local-6989586621684064161"><span class="hs-identifier hs-var">arity</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684064159"><span class="hs-identifier hs-var">pats</span></a><span> </span><a href="#local-6989586621684064158"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-462"></a><span>
</span><a name="line-463"></a><span class="hs-identifier">tidy1</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SumPat</span><span> </span><a name="local-6989586621684064163"><a href="#local-6989586621684064163"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-6989586621684064164"><a href="#local-6989586621684064164"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621684064165"><a href="#local-6989586621684064165"><span class="hs-identifier">alt</span></a></a><span> </span><a name="local-6989586621684064166"><a href="#local-6989586621684064166"><span class="hs-identifier">arity</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-464"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="DsMonad.html#idDsWrapper"><span class="hs-identifier hs-var">idDsWrapper</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621684064167"><span class="hs-identifier hs-var">sum_ConPat</span></a><span class="hs-special">)</span><span>
</span><a name="line-465"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-466"></a><span>    </span><a name="local-6989586621684064167"><a href="#local-6989586621684064167"><span class="hs-identifier">sum_ConPat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkPrefixConPat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sumDataCon</span><span> </span><a href="#local-6989586621684064165"><span class="hs-identifier hs-var">alt</span></a><span> </span><a href="#local-6989586621684064166"><span class="hs-identifier hs-var">arity</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684064164"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621684064163"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-467"></a><span>
</span><a name="line-468"></a><span class="hs-comment">-- LitPats: we *might* be able to replace these w/ a simpler form</span><span>
</span><a name="line-469"></a><span class="hs-identifier">tidy1</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064168"><a href="#local-6989586621684064168"><span class="hs-identifier">o</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitPat</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064169"><a href="#local-6989586621684064169"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-470"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isGenerated</span><span> </span><a href="#local-6989586621684064168"><span class="hs-identifier hs-var">o</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-471"></a><span>           </span><a href="MatchLit.html#warnAboutOverflowedLit"><span class="hs-identifier hs-var">warnAboutOverflowedLit</span></a><span> </span><a href="#local-6989586621684064169"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-472"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="DsMonad.html#idDsWrapper"><span class="hs-identifier hs-var">idDsWrapper</span></a><span class="hs-special">,</span><span> </span><a href="MatchLit.html#tidyLitPat"><span class="hs-identifier hs-var">tidyLitPat</span></a><span> </span><a href="#local-6989586621684064169"><span class="hs-identifier hs-var">lit</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-473"></a><span>
</span><a name="line-474"></a><span class="hs-comment">-- NPats: we *might* be able to replace these w/ a simpler form</span><span>
</span><a name="line-475"></a><span class="hs-identifier">tidy1</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064170"><a href="#local-6989586621684064170"><span class="hs-identifier">o</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NPat</span><span> </span><a name="local-6989586621684064171"><a href="#local-6989586621684064171"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064172"><a href="#local-6989586621684064172"><span class="hs-identifier">lit</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">OverLit</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ol_val</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684064173"><a href="#local-6989586621684064173"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684064174"><a href="#local-6989586621684064174"><span class="hs-identifier">mb_neg</span></a></a><span> </span><a name="local-6989586621684064175"><a href="#local-6989586621684064175"><span class="hs-identifier">eq</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-476"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isGenerated</span><span> </span><a href="#local-6989586621684064170"><span class="hs-identifier hs-var">o</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-477"></a><span>           </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684064176"><a href="#local-6989586621684064176"><span class="hs-identifier">lit'</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684064174"><span class="hs-identifier hs-var">mb_neg</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064172"><span class="hs-identifier hs-var">lit</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">ol_val</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">negateOverLitVal</span><span> </span><a href="#local-6989586621684064173"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-478"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064172"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-479"></a><span>           </span><span class="hs-keyword">in</span><span> </span><a href="MatchLit.html#warnAboutOverflowedOverLit"><span class="hs-identifier hs-var">warnAboutOverflowedOverLit</span></a><span> </span><a href="#local-6989586621684064176"><span class="hs-identifier hs-var">lit'</span></a><span>
</span><a name="line-480"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="DsMonad.html#idDsWrapper"><span class="hs-identifier hs-var">idDsWrapper</span></a><span class="hs-special">,</span><span> </span><a href="MatchLit.html#tidyNPat"><span class="hs-identifier hs-var">tidyNPat</span></a><span> </span><a href="#local-6989586621684064172"><span class="hs-identifier hs-var">lit</span></a><span> </span><a href="#local-6989586621684064174"><span class="hs-identifier hs-var">mb_neg</span></a><span> </span><a href="#local-6989586621684064175"><span class="hs-identifier hs-var">eq</span></a><span> </span><a href="#local-6989586621684064171"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-481"></a><span>
</span><a name="line-482"></a><span class="hs-comment">-- NPlusKPat: we may want to warn about the literals</span><span>
</span><a name="line-483"></a><span class="hs-identifier">tidy1</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064177"><a href="#local-6989586621684064177"><span class="hs-identifier">o</span></a></a><span> </span><a name="local-6989586621684064178"><a href="#local-6989586621684064178"><span class="hs-identifier">n</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">NPlusKPat</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064179"><a href="#local-6989586621684064179"><span class="hs-identifier">lit1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684064180"><a href="#local-6989586621684064180"><span class="hs-identifier">lit2</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-484"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isGenerated</span><span> </span><a href="#local-6989586621684064177"><span class="hs-identifier hs-var">o</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-485"></a><span>           </span><a href="MatchLit.html#warnAboutOverflowedOverLit"><span class="hs-identifier hs-var">warnAboutOverflowedOverLit</span></a><span> </span><a href="#local-6989586621684064179"><span class="hs-identifier hs-var">lit1</span></a><span>
</span><a name="line-486"></a><span>           </span><a href="MatchLit.html#warnAboutOverflowedOverLit"><span class="hs-identifier hs-var">warnAboutOverflowedOverLit</span></a><span> </span><a href="#local-6989586621684064180"><span class="hs-identifier hs-var">lit2</span></a><span>
</span><a name="line-487"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="DsMonad.html#idDsWrapper"><span class="hs-identifier hs-var">idDsWrapper</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684064178"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-488"></a><span>
</span><a name="line-489"></a><span class="hs-comment">-- Everything else goes through unchanged...</span><span>
</span><a name="line-490"></a><span class="hs-identifier">tidy1</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064181"><a href="#local-6989586621684064181"><span class="hs-identifier">non_interesting_pat</span></a></a><span>
</span><a name="line-491"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="DsMonad.html#idDsWrapper"><span class="hs-identifier hs-var">idDsWrapper</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684064181"><span class="hs-identifier hs-var">non_interesting_pat</span></a><span class="hs-special">)</span><span>
</span><a name="line-492"></a><span>
</span><a name="line-493"></a><span class="hs-comment">--------------------</span><span>
</span><a name="line-494"></a><span class="hs-identifier">tidy_bang_pat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Origin</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Pat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-495"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><a href="DsMonad.html#DsWrapper"><span class="hs-identifier hs-type">DsWrapper</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Pat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span>
</span><a name="line-496"></a><span>
</span><a name="line-497"></a><span class="hs-comment">-- Discard par/sig under a bang</span><span>
</span><a name="line-498"></a><a name="tidy_bang_pat"><a href="Match.html#tidy_bang_pat"><span class="hs-identifier">tidy_bang_pat</span></a></a><span> </span><a name="local-6989586621684064182"><a href="#local-6989586621684064182"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621684064183"><a href="#local-6989586621684064183"><span class="hs-identifier">o</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParPat</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621684064184"><a href="#local-6989586621684064184"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621684064185"><a href="#local-6989586621684064185"><span class="hs-identifier">p</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Match.html#tidy_bang_pat"><span class="hs-identifier hs-var">tidy_bang_pat</span></a><span> </span><a href="#local-6989586621684064182"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621684064183"><span class="hs-identifier hs-var">o</span></a><span> </span><a href="#local-6989586621684064184"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621684064185"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-499"></a><span class="hs-identifier">tidy_bang_pat</span><span> </span><a name="local-6989586621684064186"><a href="#local-6989586621684064186"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621684064187"><a href="#local-6989586621684064187"><span class="hs-identifier">o</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SigPat</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621684064188"><a href="#local-6989586621684064188"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621684064189"><a href="#local-6989586621684064189"><span class="hs-identifier">p</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Match.html#tidy_bang_pat"><span class="hs-identifier hs-var">tidy_bang_pat</span></a><span> </span><a href="#local-6989586621684064186"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621684064187"><span class="hs-identifier hs-var">o</span></a><span> </span><a href="#local-6989586621684064188"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621684064189"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-500"></a><span>
</span><a name="line-501"></a><span class="hs-comment">-- Push the bang-pattern inwards, in the hope that</span><span>
</span><a name="line-502"></a><span class="hs-comment">-- it may disappear next time</span><span>
</span><a name="line-503"></a><span class="hs-identifier">tidy_bang_pat</span><span> </span><a name="local-6989586621684064190"><a href="#local-6989586621684064190"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621684064191"><a href="#local-6989586621684064191"><span class="hs-identifier">o</span></a></a><span> </span><a name="local-6989586621684064192"><a href="#local-6989586621684064192"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AsPat</span><span> </span><a name="local-6989586621684064193"><a href="#local-6989586621684064193"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621684064194"><a href="#local-6989586621684064194"><span class="hs-identifier">v'</span></a></a><span> </span><a name="local-6989586621684064195"><a href="#local-6989586621684064195"><span class="hs-identifier">p</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-504"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Match.html#tidy1"><span class="hs-identifier hs-var">tidy1</span></a><span> </span><a href="#local-6989586621684064190"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621684064191"><span class="hs-identifier hs-var">o</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AsPat</span><span> </span><a href="#local-6989586621684064193"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621684064194"><span class="hs-identifier hs-var">v'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621684064192"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BangPat</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621684064195"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-505"></a><span class="hs-identifier">tidy_bang_pat</span><span> </span><a name="local-6989586621684064196"><a href="#local-6989586621684064196"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621684064197"><a href="#local-6989586621684064197"><span class="hs-identifier">o</span></a></a><span> </span><a name="local-6989586621684064198"><a href="#local-6989586621684064198"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoPat</span><span> </span><a name="local-6989586621684064199"><a href="#local-6989586621684064199"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621684064200"><a href="#local-6989586621684064200"><span class="hs-identifier">w</span></a></a><span> </span><a name="local-6989586621684064201"><a href="#local-6989586621684064201"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621684064202"><a href="#local-6989586621684064202"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-506"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Match.html#tidy1"><span class="hs-identifier hs-var">tidy1</span></a><span> </span><a href="#local-6989586621684064196"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621684064197"><span class="hs-identifier hs-var">o</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoPat</span><span> </span><a href="#local-6989586621684064199"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621684064200"><span class="hs-identifier hs-var">w</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BangPat</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621684064198"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621684064201"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684064202"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-507"></a><span>
</span><a name="line-508"></a><span class="hs-comment">-- Discard bang around strict pattern</span><span>
</span><a name="line-509"></a><span class="hs-identifier">tidy_bang_pat</span><span> </span><a name="local-6989586621684064203"><a href="#local-6989586621684064203"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621684064204"><a href="#local-6989586621684064204"><span class="hs-identifier">o</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064205"><a href="#local-6989586621684064205"><span class="hs-identifier">p</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitPat</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Match.html#tidy1"><span class="hs-identifier hs-var">tidy1</span></a><span> </span><a href="#local-6989586621684064203"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621684064204"><span class="hs-identifier hs-var">o</span></a><span> </span><a href="#local-6989586621684064205"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-510"></a><span class="hs-identifier">tidy_bang_pat</span><span> </span><a name="local-6989586621684064206"><a href="#local-6989586621684064206"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621684064207"><a href="#local-6989586621684064207"><span class="hs-identifier">o</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064208"><a href="#local-6989586621684064208"><span class="hs-identifier">p</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">ListPat</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Match.html#tidy1"><span class="hs-identifier hs-var">tidy1</span></a><span> </span><a href="#local-6989586621684064206"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621684064207"><span class="hs-identifier hs-var">o</span></a><span> </span><a href="#local-6989586621684064208"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-511"></a><span class="hs-identifier">tidy_bang_pat</span><span> </span><a name="local-6989586621684064209"><a href="#local-6989586621684064209"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621684064210"><a href="#local-6989586621684064210"><span class="hs-identifier">o</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064211"><a href="#local-6989586621684064211"><span class="hs-identifier">p</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">TuplePat</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Match.html#tidy1"><span class="hs-identifier hs-var">tidy1</span></a><span> </span><a href="#local-6989586621684064209"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621684064210"><span class="hs-identifier hs-var">o</span></a><span> </span><a href="#local-6989586621684064211"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-512"></a><span class="hs-identifier">tidy_bang_pat</span><span> </span><a name="local-6989586621684064212"><a href="#local-6989586621684064212"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621684064213"><a href="#local-6989586621684064213"><span class="hs-identifier">o</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064214"><a href="#local-6989586621684064214"><span class="hs-identifier">p</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">SumPat</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Match.html#tidy1"><span class="hs-identifier hs-var">tidy1</span></a><span> </span><a href="#local-6989586621684064212"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621684064213"><span class="hs-identifier hs-var">o</span></a><span> </span><a href="#local-6989586621684064214"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-513"></a><span>
</span><a name="line-514"></a><span class="hs-comment">-- Data/newtype constructors</span><span>
</span><a name="line-515"></a><span class="hs-identifier">tidy_bang_pat</span><span> </span><a name="local-6989586621684064215"><a href="#local-6989586621684064215"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621684064216"><a href="#local-6989586621684064216"><span class="hs-identifier">o</span></a></a><span> </span><a name="local-6989586621684064217"><a href="#local-6989586621684064217"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621684064218"><a href="#local-6989586621684064218"><span class="hs-identifier">p</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">ConPatOut</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pat_con</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealDataCon</span><span> </span><a name="local-6989586621684064219"><a href="#local-6989586621684064219"><span class="hs-identifier">dc</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-516"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pat_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684064220"><a href="#local-6989586621684064220"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-517"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pat_arg_tys</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684064221"><a href="#local-6989586621684064221"><span class="hs-identifier">arg_tys</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-518"></a><span>  </span><span class="hs-comment">-- Newtypes: push bang inwards (Trac #9844)</span><span>
</span><a name="line-519"></a><span>  </span><span class="hs-glyph">=</span><span>
</span><a name="line-520"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isNewTyCon</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConTyCon</span><span> </span><a href="#local-6989586621684064219"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span>
</span><a name="line-521"></a><span>      </span><span class="hs-keyword">then</span><span> </span><a href="Match.html#tidy1"><span class="hs-identifier hs-var">tidy1</span></a><span> </span><a href="#local-6989586621684064215"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621684064216"><span class="hs-identifier hs-var">o</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064218"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pat_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Match.html#push_bang_into_newtype_arg"><span class="hs-identifier hs-var">push_bang_into_newtype_arg</span></a><span> </span><a href="#local-6989586621684064217"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621684064222"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621684064220"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-522"></a><span>      </span><span class="hs-keyword">else</span><span> </span><a href="Match.html#tidy1"><span class="hs-identifier hs-var">tidy1</span></a><span> </span><a href="#local-6989586621684064215"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621684064216"><span class="hs-identifier hs-var">o</span></a><span> </span><a href="#local-6989586621684064218"><span class="hs-identifier hs-var">p</span></a><span>  </span><span class="hs-comment">-- Data types: discard the bang</span><span>
</span><a name="line-523"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-524"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621684064222"><a href="#local-6989586621684064222"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConInstArgTys</span><span> </span><a href="#local-6989586621684064219"><span class="hs-identifier hs-var">dc</span></a><span> </span><a href="#local-6989586621684064221"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-525"></a><span>
</span><a name="line-526"></a><span class="hs-comment">-------------------</span><span>
</span><a name="line-527"></a><span class="hs-comment">-- Default case, leave the bang there:</span><span>
</span><a name="line-528"></a><span class="hs-comment">--    VarPat,</span><span>
</span><a name="line-529"></a><span class="hs-comment">--    LazyPat,</span><span>
</span><a name="line-530"></a><span class="hs-comment">--    WildPat,</span><span>
</span><a name="line-531"></a><span class="hs-comment">--    ViewPat,</span><span>
</span><a name="line-532"></a><span class="hs-comment">--    pattern synonyms (ConPatOut with PatSynCon)</span><span>
</span><a name="line-533"></a><span class="hs-comment">--    NPat,</span><span>
</span><a name="line-534"></a><span class="hs-comment">--    NPlusKPat</span><span>
</span><a name="line-535"></a><span class="hs-comment">--</span><span>
</span><a name="line-536"></a><span class="hs-comment">-- For LazyPat, remember that it's semantically like a VarPat</span><span>
</span><a name="line-537"></a><span class="hs-comment">--  i.e.  !(~p) is not like ~p, or p!  (Trac #8952)</span><span>
</span><a name="line-538"></a><span class="hs-comment">--</span><span>
</span><a name="line-539"></a><span class="hs-comment">-- NB: SigPatIn, ConPatIn should not happen</span><span>
</span><a name="line-540"></a><span>
</span><a name="line-541"></a><span class="hs-identifier">tidy_bang_pat</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064223"><a href="#local-6989586621684064223"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621684064224"><a href="#local-6989586621684064224"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="DsMonad.html#idDsWrapper"><span class="hs-identifier hs-var">idDsWrapper</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">BangPat</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621684064223"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621684064224"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-542"></a><span>
</span><a name="line-543"></a><span class="hs-comment">-------------------</span><span>
</span><a name="line-544"></a><span class="hs-identifier">push_bang_into_newtype_arg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span>
</span><a name="line-545"></a><span>                           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-comment">-- The type of the argument we are pushing</span><span>
</span><a name="line-546"></a><span>                                   </span><span class="hs-comment">-- onto</span><span>
</span><a name="line-547"></a><span>                           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsConPatDetails</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsConPatDetails</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-548"></a><span class="hs-comment">-- See Note [Bang patterns and newtypes]</span><span>
</span><a name="line-549"></a><span class="hs-comment">-- We are transforming   !(N p)   into   (N !p)</span><span>
</span><a name="line-550"></a><a name="push_bang_into_newtype_arg"><a href="Match.html#push_bang_into_newtype_arg"><span class="hs-identifier">push_bang_into_newtype_arg</span></a></a><span> </span><a name="local-6989586621684064225"><a href="#local-6989586621684064225"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621684064226"><a href="#local-6989586621684064226"><span class="hs-identifier">_ty</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PrefixCon</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684064227"><a href="#local-6989586621684064227"><span class="hs-identifier">arg</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684064228"><a href="#local-6989586621684064228"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-551"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-identifier">args</span><span class="hs-special">)</span><span>
</span><a name="line-552"></a><span>    </span><span class="hs-identifier hs-var">PrefixCon</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621684064225"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BangPat</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621684064227"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-553"></a><span class="hs-identifier">push_bang_into_newtype_arg</span><span> </span><a name="local-6989586621684064229"><a href="#local-6989586621684064229"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621684064230"><a href="#local-6989586621684064230"><span class="hs-identifier">_ty</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecCon</span><span> </span><a name="local-6989586621684064231"><a href="#local-6989586621684064231"><span class="hs-identifier">rf</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-554"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">HsRecFields</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rec_flds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621684064232"><a href="#local-6989586621684064232"><span class="hs-identifier">lf</span></a></a><span> </span><a name="local-6989586621684064233"><a href="#local-6989586621684064233"><span class="hs-identifier">fld</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684064234"><a href="#local-6989586621684064234"><span class="hs-identifier">flds</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684064231"><span class="hs-identifier hs-var">rf</span></a><span>
</span><a name="line-555"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HsRecField</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsRecFieldArg</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684064235"><a href="#local-6989586621684064235"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684064233"><span class="hs-identifier hs-var">fld</span></a><span>
</span><a name="line-556"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-identifier">flds</span><span class="hs-special">)</span><span>
</span><a name="line-557"></a><span>    </span><span class="hs-identifier hs-var">RecCon</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064231"><span class="hs-identifier hs-var">rf</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rec_flds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621684064232"><span class="hs-identifier hs-var">lf</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064233"><span class="hs-identifier hs-var">fld</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsRecFieldArg</span><span>
</span><a name="line-558"></a><span>                                           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621684064229"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BangPat</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621684064235"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-559"></a><span class="hs-identifier">push_bang_into_newtype_arg</span><span> </span><a name="local-6989586621684064236"><a href="#local-6989586621684064236"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621684064237"><a href="#local-6989586621684064237"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecCon</span><span> </span><a name="local-6989586621684064238"><a href="#local-6989586621684064238"><span class="hs-identifier">rf</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- If a user writes !(T {})</span><span>
</span><a name="line-560"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">HsRecFields</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rec_flds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684064238"><span class="hs-identifier hs-var">rf</span></a><span>
</span><a name="line-561"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">PrefixCon</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621684064236"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BangPat</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WildPat</span><span> </span><a href="#local-6989586621684064237"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-562"></a><span class="hs-identifier">push_bang_into_newtype_arg</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064239"><a href="#local-6989586621684064239"><span class="hs-identifier">cd</span></a></a><span>
</span><a name="line-563"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;push_bang_into_newtype_arg&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprConArgs</span><span> </span><a href="#local-6989586621684064239"><span class="hs-identifier hs-var">cd</span></a><span class="hs-special">)</span><span>
</span><a name="line-564"></a><span>
</span><a name="line-565"></a><span class="hs-comment">{-
Note [Bang patterns and newtypes]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For the pattern  !(Just pat)  we can discard the bang, because
the pattern is strict anyway. But for !(N pat), where
  newtype NT = N Int
we definitely can't discard the bang.  Trac #9844.

So what we do is to push the bang inwards, in the hope that it will
get discarded there.  So we transform
   !(N pat)   into    (N !pat)

But what if there is nothing to push the bang onto? In at least one instance
a user has written !(N {}) which we translate into (N !_). See #13215


\noindent
{\bf Previous @matchTwiddled@ stuff:}

Now we get to the only interesting part; note: there are choices for
translation [from Simon's notes]; translation~1:
\begin{verbatim}
deTwiddle [s,t] e
\end{verbatim}
returns
\begin{verbatim}
[ w = e,
  s = case w of [s,t] -&gt; s
  t = case w of [s,t] -&gt; t
]
\end{verbatim}

Here \tr{w} is a fresh variable, and the \tr{w}-binding prevents multiple
evaluation of \tr{e}.  An alternative translation (No.~2):
\begin{verbatim}
[ w = case e of [s,t] -&gt; (s,t)
  s = case w of (s,t) -&gt; s
  t = case w of (s,t) -&gt; t
]
\end{verbatim}

************************************************************************
*                                                                      *
\subsubsection[improved-unmixing]{UNIMPLEMENTED idea for improved unmixing}
*                                                                      *
************************************************************************

We might be able to optimise unmixing when confronted by
only-one-constructor-possible, of which tuples are the most notable
examples.  Consider:
\begin{verbatim}
f (a,b,c) ... = ...
f d ... (e:f) = ...
f (g,h,i) ... = ...
f j ...       = ...
\end{verbatim}
This definition would normally be unmixed into four equation blocks,
one per equation.  But it could be unmixed into just one equation
block, because if the one equation matches (on the first column),
the others certainly will.

You have to be careful, though; the example
\begin{verbatim}
f j ...       = ...
-------------------
f (a,b,c) ... = ...
f d ... (e:f) = ...
f (g,h,i) ... = ...
\end{verbatim}
{\em must} be broken into two blocks at the line shown; otherwise, you
are forcing unnecessary evaluation.  In any case, the top-left pattern
always gives the cue.  You could then unmix blocks into groups of...
\begin{description}
\item[all variables:]
As it is now.
\item[constructors or variables (mixed):]
Need to make sure the right names get bound for the variable patterns.
\item[literals or variables (mixed):]
Presumably just a variant on the constructor case (as it is now).
\end{description}

************************************************************************
*                                                                      *
*  matchWrapper: a convenient way to call @match@                      *
*                                                                      *
************************************************************************
\subsection[matchWrapper]{@matchWrapper@: a convenient interface to @match@}

Calls to @match@ often involve similar (non-trivial) work; that work
is collected here, in @matchWrapper@.  This function takes as
arguments:
\begin{itemize}
\item
Typechecked @Matches@ (of a function definition, or a case or lambda
expression)---the main input;
\item
An error message to be inserted into any (runtime) pattern-matching
failure messages.
\end{itemize}

As results, @matchWrapper@ produces:
\begin{itemize}
\item
A list of variables (@Locals@) that the caller must ``promise'' to
bind to appropriate values; and
\item
a @CoreExpr@, the desugared output (main result).
\end{itemize}

The main actions of @matchWrapper@ include:
\begin{enumerate}
\item
Flatten the @[TypecheckedMatch]@ into a suitable list of
@EquationInfo@s.
\item
Create as many new variables as there are patterns in a pattern-list
(in any one of the @EquationInfo@s).
\item
Create a suitable ``if it fails'' expression---a call to @error@ using
the error-string input; the {\em type} of this fail value can be found
by examining one of the RHS expressions in one of the @EquationInfo@s.
\item
Call @match@ with all of this information!
\end{enumerate}
-}</span><span>
</span><a name="line-690"></a><span>
</span><a name="line-691"></a><span class="hs-identifier">matchWrapper</span><span>
</span><a name="line-692"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsMatchContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span>               </span><span class="hs-comment">-- ^ For shadowing warning messages</span><span>
</span><a name="line-693"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span>             </span><span class="hs-comment">-- ^ Scrutinee, if we check a case expr</span><span>
</span><a name="line-694"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MatchGroup</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ Matches being desugared</span><span>
</span><a name="line-695"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span>              </span><span class="hs-comment">-- ^ Results (usually passed to 'match')</span><span>
</span><a name="line-696"></a><span>
</span><a name="line-697"></a><span class="hs-comment">{-
 There is one small problem with the Lambda Patterns, when somebody
 writes something similar to:
\begin{verbatim}
    (\ (x:xs) -&gt; ...)
\end{verbatim}
 he/she don't want a warning about incomplete patterns, that is done with
 the flag @opt_WarnSimplePatterns@.
 This problem also appears in the:
\begin{itemize}
\item @do@ patterns, but if the @do@ can fail
      it creates another equation if the match can fail
      (see @DsExpr.doDo@ function)
\item @let@ patterns, are treated by @matchSimply@
   List Comprension Patterns, are treated by @matchSimply@ also
\end{itemize}

We can't call @matchSimply@ with Lambda patterns,
due to the fact that lambda patterns can have more than
one pattern, and match simply only accepts one pattern.

JJQC 30-Nov-1997
-}</span><span>
</span><a name="line-720"></a><span>
</span><a name="line-721"></a><a name="matchWrapper"><a href="Match.html#matchWrapper"><span class="hs-identifier">matchWrapper</span></a></a><span> </span><a name="local-6989586621684064240"><a href="#local-6989586621684064240"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621684064241"><a href="#local-6989586621684064241"><span class="hs-identifier">mb_scr</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">MG</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mg_alts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064242"><a href="#local-6989586621684064242"><span class="hs-identifier">matches</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-722"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">MatchGroupTc</span><span> </span><a name="local-6989586621684064243"><a href="#local-6989586621684064243"><span class="hs-identifier">arg_tys</span></a></a><span> </span><a name="local-6989586621684064244"><a href="#local-6989586621684064244"><span class="hs-identifier">rhs_ty</span></a></a><span>
</span><a name="line-723"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_origin</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684064245"><a href="#local-6989586621684064245"><span class="hs-identifier">origin</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-724"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684064256"><a href="#local-6989586621684064256"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-725"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684064257"><a href="#local-6989586621684064257"><span class="hs-identifier">locn</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#getSrcSpanDs"><span class="hs-identifier hs-var">getSrcSpanDs</span></a><span>
</span><a name="line-726"></a><span>
</span><a name="line-727"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684064259"><a href="#local-6989586621684064259"><span class="hs-identifier">new_vars</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684064242"><span class="hs-identifier hs-var">matches</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-728"></a><span>                           </span><span class="hs-special">[</span><span class="hs-special">]</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="DsMonad.html#newSysLocalDsNoLP"><span class="hs-identifier hs-var">newSysLocalDsNoLP</span></a><span> </span><a href="#local-6989586621684064243"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-729"></a><span>                           </span><span class="hs-special">(</span><a name="local-6989586621684064258"><a href="#local-6989586621684064258"><span class="hs-identifier">m</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsUtils.html#selectMatchVars"><span class="hs-identifier hs-var">selectMatchVars</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hsLMatchPats</span><span> </span><a href="#local-6989586621684064258"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-730"></a><span>
</span><a name="line-731"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684064260"><a href="#local-6989586621684064260"><span class="hs-identifier">eqns_info</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064246"><span class="hs-identifier hs-var">mk_eqn_info</span></a><span> </span><a href="#local-6989586621684064259"><span class="hs-identifier hs-var">new_vars</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684064242"><span class="hs-identifier hs-var">matches</span></a><span>
</span><a name="line-732"></a><span>
</span><a name="line-733"></a><span>        </span><span class="hs-comment">-- pattern match check warnings</span><span>
</span><a name="line-734"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isGenerated</span><span> </span><a href="#local-6989586621684064245"><span class="hs-identifier hs-var">origin</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-735"></a><span>          </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="Check.html#isAnyPmCheckEnabled"><span class="hs-identifier hs-var">isAnyPmCheckEnabled</span></a><span> </span><a href="#local-6989586621684064256"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="DsMonad.html#DsMatchContext"><span class="hs-identifier hs-var">DsMatchContext</span></a><span> </span><a href="#local-6989586621684064240"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621684064257"><span class="hs-identifier hs-var">locn</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-736"></a><span>          </span><a href="DsMonad.html#addTmCsDs"><span class="hs-identifier hs-var">addTmCsDs</span></a><span> </span><span class="hs-special">(</span><a href="Check.html#genCaseTmCs1"><span class="hs-identifier hs-var">genCaseTmCs1</span></a><span> </span><a href="#local-6989586621684064241"><span class="hs-identifier hs-var">mb_scr</span></a><span> </span><a href="#local-6989586621684064259"><span class="hs-identifier hs-var">new_vars</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-737"></a><span>              </span><span class="hs-comment">-- See Note [Type and Term Equality Propagation]</span><span>
</span><a name="line-738"></a><span>          </span><a href="Check.html#checkMatches"><span class="hs-identifier hs-var">checkMatches</span></a><span> </span><a href="#local-6989586621684064256"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="DsMonad.html#DsMatchContext"><span class="hs-identifier hs-var">DsMatchContext</span></a><span> </span><a href="#local-6989586621684064240"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621684064257"><span class="hs-identifier hs-var">locn</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684064259"><span class="hs-identifier hs-var">new_vars</span></a><span> </span><a href="#local-6989586621684064242"><span class="hs-identifier hs-var">matches</span></a><span>
</span><a name="line-739"></a><span>
</span><a name="line-740"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684064261"><a href="#local-6989586621684064261"><span class="hs-identifier">result_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684064247"><span class="hs-identifier hs-var">handleWarnings</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-741"></a><span>                         </span><a href="Match.html#matchEquations"><span class="hs-identifier hs-var">matchEquations</span></a><span> </span><a href="#local-6989586621684064240"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621684064259"><span class="hs-identifier hs-var">new_vars</span></a><span> </span><a href="#local-6989586621684064260"><span class="hs-identifier hs-var">eqns_info</span></a><span> </span><a href="#local-6989586621684064244"><span class="hs-identifier hs-var">rhs_ty</span></a><span>
</span><a name="line-742"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064259"><span class="hs-identifier hs-var">new_vars</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684064261"><span class="hs-identifier hs-var">result_expr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-743"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-744"></a><span>    </span><a name="local-6989586621684064246"><a href="#local-6989586621684064246"><span class="hs-identifier">mk_eqn_info</span></a></a><span> </span><a name="local-6989586621684064248"><a href="#local-6989586621684064248"><span class="hs-identifier">vars</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Match</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">m_pats</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684064249"><a href="#local-6989586621684064249"><span class="hs-identifier">pats</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">m_grhss</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684064250"><a href="#local-6989586621684064250"><span class="hs-identifier">grhss</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-745"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684064251"><a href="#local-6989586621684064251"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-746"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684064252"><a href="#local-6989586621684064252"><span class="hs-identifier">upats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="DsUtils.html#decideBangHood"><span class="hs-identifier hs-var">decideBangHood</span></a><span> </span><a href="#local-6989586621684064251"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684064249"><span class="hs-identifier hs-var">pats</span></a><span>
</span><a name="line-747"></a><span>                 </span><a name="local-6989586621684064253"><a href="#local-6989586621684064253"><span class="hs-identifier">dicts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">collectEvVarsPats</span><span> </span><a href="#local-6989586621684064252"><span class="hs-identifier hs-var">upats</span></a><span>
</span><a name="line-748"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684064254"><a href="#local-6989586621684064254"><span class="hs-identifier">tm_cs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Check.html#genCaseTmCs2"><span class="hs-identifier hs-var">genCaseTmCs2</span></a><span> </span><a href="#local-6989586621684064241"><span class="hs-identifier hs-var">mb_scr</span></a><span> </span><a href="#local-6989586621684064252"><span class="hs-identifier hs-var">upats</span></a><span> </span><a href="#local-6989586621684064248"><span class="hs-identifier hs-var">vars</span></a><span>
</span><a name="line-749"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684064255"><a href="#local-6989586621684064255"><span class="hs-identifier">match_result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#addDictsDs"><span class="hs-identifier hs-var">addDictsDs</span></a><span> </span><a href="#local-6989586621684064253"><span class="hs-identifier hs-var">dicts</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-comment">-- See Note [Type and Term Equality Propagation]</span><span>
</span><a name="line-750"></a><span>                             </span><a href="DsMonad.html#addTmCsDs"><span class="hs-identifier hs-var">addTmCsDs</span></a><span> </span><a href="#local-6989586621684064254"><span class="hs-identifier hs-var">tm_cs</span></a><span>  </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-comment">-- See Note [Type and Term Equality Propagation]</span><span>
</span><a name="line-751"></a><span>                             </span><a href="DsGRHSs.html#dsGRHSs"><span class="hs-identifier hs-var">dsGRHSs</span></a><span> </span><a href="#local-6989586621684064240"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621684064250"><span class="hs-identifier hs-var">grhss</span></a><span> </span><a href="#local-6989586621684064244"><span class="hs-identifier hs-var">rhs_ty</span></a><span>
</span><a name="line-752"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="DsMonad.html#EqnInfo"><span class="hs-identifier hs-var">EqnInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">eqn_pats</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064252"><span class="hs-identifier hs-var">upats</span></a><span>
</span><a name="line-753"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">eqn_orig</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">FromSource</span><span>
</span><a name="line-754"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">eqn_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064255"><span class="hs-identifier hs-var">match_result</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-755"></a><span>    </span><span class="hs-identifier">mk_eqn_info</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XMatch</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;matchWrapper&quot;</span><span>
</span><a name="line-756"></a><span>    </span><span class="hs-identifier">mk_eqn_info</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;mk_eqn_info: Impossible Match&quot;</span><span> </span><span class="hs-comment">-- due to #15884</span><span>
</span><a name="line-757"></a><span>
</span><a name="line-758"></a><span>    </span><a name="local-6989586621684064247"><a href="#local-6989586621684064247"><span class="hs-identifier">handleWarnings</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isGenerated</span><span> </span><a href="#local-6989586621684064245"><span class="hs-identifier hs-var">origin</span></a><span>
</span><a name="line-759"></a><span>                     </span><span class="hs-keyword">then</span><span> </span><a href="DsMonad.html#discardWarningsDs"><span class="hs-identifier hs-var">discardWarningsDs</span></a><span>
</span><a name="line-760"></a><span>                     </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-761"></a><span class="hs-identifier">matchWrapper</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XMatchGroup</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;matchWrapper&quot;</span><span>
</span><a name="line-762"></a><span>
</span><a name="line-763"></a><span class="hs-identifier">matchEquations</span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsMatchContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-764"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Match.html#MatchId"><span class="hs-identifier hs-type">MatchId</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-765"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-766"></a><a name="matchEquations"><a href="Match.html#matchEquations"><span class="hs-identifier">matchEquations</span></a></a><span> </span><a name="local-6989586621684064262"><a href="#local-6989586621684064262"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621684064263"><a href="#local-6989586621684064263"><span class="hs-identifier">vars</span></a></a><span> </span><a name="local-6989586621684064264"><a href="#local-6989586621684064264"><span class="hs-identifier">eqns_info</span></a></a><span> </span><a name="local-6989586621684064265"><a href="#local-6989586621684064265"><span class="hs-identifier">rhs_ty</span></a></a><span>
</span><a name="line-767"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684064266"><a href="#local-6989586621684064266"><span class="hs-identifier">error_doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">matchContextErrString</span><span> </span><a href="#local-6989586621684064262"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-768"></a><span>
</span><a name="line-769"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684064267"><a href="#local-6989586621684064267"><span class="hs-identifier">match_result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Match.html#match"><span class="hs-identifier hs-var">match</span></a><span> </span><a href="#local-6989586621684064263"><span class="hs-identifier hs-var">vars</span></a><span> </span><a href="#local-6989586621684064265"><span class="hs-identifier hs-var">rhs_ty</span></a><span> </span><a href="#local-6989586621684064264"><span class="hs-identifier hs-var">eqns_info</span></a><span>
</span><a name="line-770"></a><span>
</span><a name="line-771"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684064268"><a href="#local-6989586621684064268"><span class="hs-identifier">fail_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsUtils.html#mkErrorAppDs"><span class="hs-identifier hs-var">mkErrorAppDs</span></a><span> </span><span class="hs-identifier hs-var">pAT_ERROR_ID</span><span> </span><a href="#local-6989586621684064265"><span class="hs-identifier hs-var">rhs_ty</span></a><span> </span><a href="#local-6989586621684064266"><span class="hs-identifier hs-var">error_doc</span></a><span>
</span><a name="line-772"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="DsUtils.html#extractMatchResult"><span class="hs-identifier hs-var">extractMatchResult</span></a><span> </span><a href="#local-6989586621684064267"><span class="hs-identifier hs-var">match_result</span></a><span> </span><a href="#local-6989586621684064268"><span class="hs-identifier hs-var">fail_expr</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-773"></a><span>
</span><a name="line-774"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection[matchSimply]{@matchSimply@: match a single expression against a single pattern}
*                                                                      *
************************************************************************

@mkSimpleMatch@ is a wrapper for @match@ which deals with the
situation where we want to match a single expression against a single
pattern. It returns an expression.
-}</span><span>
</span><a name="line-785"></a><span>
</span><a name="line-786"></a><span class="hs-identifier">matchSimply</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>                 </span><span class="hs-comment">-- ^ Scrutinee</span><span>
</span><a name="line-787"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsMatchContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span>      </span><span class="hs-comment">-- ^ Match kind</span><span>
</span><a name="line-788"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>               </span><span class="hs-comment">-- ^ Pattern it should match</span><span>
</span><a name="line-789"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>                 </span><span class="hs-comment">-- ^ Return this if it matches</span><span>
</span><a name="line-790"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>                 </span><span class="hs-comment">-- ^ Return this if it doesn't</span><span>
</span><a name="line-791"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-792"></a><span class="hs-comment">-- Do not warn about incomplete patterns; see matchSinglePat comments</span><span>
</span><a name="line-793"></a><a name="matchSimply"><a href="Match.html#matchSimply"><span class="hs-identifier">matchSimply</span></a></a><span> </span><a name="local-6989586621684064269"><a href="#local-6989586621684064269"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621684064270"><a href="#local-6989586621684064270"><span class="hs-identifier">hs_ctx</span></a></a><span> </span><a name="local-6989586621684064271"><a href="#local-6989586621684064271"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621684064272"><a href="#local-6989586621684064272"><span class="hs-identifier">result_expr</span></a></a><span> </span><a name="local-6989586621684064273"><a href="#local-6989586621684064273"><span class="hs-identifier">fail_expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-794"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-795"></a><span>      </span><a name="local-6989586621684064274"><a href="#local-6989586621684064274"><span class="hs-identifier">match_result</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#cantFailMatchResult"><span class="hs-identifier hs-var">cantFailMatchResult</span></a><span> </span><a href="#local-6989586621684064272"><span class="hs-identifier hs-var">result_expr</span></a><span>
</span><a name="line-796"></a><span>      </span><a name="local-6989586621684064275"><a href="#local-6989586621684064275"><span class="hs-identifier">rhs_ty</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">exprType</span><span> </span><a href="#local-6989586621684064273"><span class="hs-identifier hs-var">fail_expr</span></a><span>
</span><a name="line-797"></a><span>        </span><span class="hs-comment">-- Use exprType of fail_expr, because won't refine in the case of failure!</span><span>
</span><a name="line-798"></a><span>    </span><a name="local-6989586621684064276"><a href="#local-6989586621684064276"><span class="hs-identifier">match_result'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Match.html#matchSinglePat"><span class="hs-identifier hs-var">matchSinglePat</span></a><span> </span><a href="#local-6989586621684064269"><span class="hs-identifier hs-var">scrut</span></a><span> </span><a href="#local-6989586621684064270"><span class="hs-identifier hs-var">hs_ctx</span></a><span> </span><a href="#local-6989586621684064271"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621684064275"><span class="hs-identifier hs-var">rhs_ty</span></a><span> </span><a href="#local-6989586621684064274"><span class="hs-identifier hs-var">match_result</span></a><span>
</span><a name="line-799"></a><span>    </span><a href="DsUtils.html#extractMatchResult"><span class="hs-identifier hs-var">extractMatchResult</span></a><span> </span><a href="#local-6989586621684064276"><span class="hs-identifier hs-var">match_result'</span></a><span> </span><a href="#local-6989586621684064273"><span class="hs-identifier hs-var">fail_expr</span></a><span>
</span><a name="line-800"></a><span>
</span><a name="line-801"></a><span class="hs-identifier">matchSinglePat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsMatchContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-802"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span>
</span><a name="line-803"></a><span class="hs-comment">-- matchSinglePat ensures that the scrutinee is a variable</span><span>
</span><a name="line-804"></a><span class="hs-comment">-- and then calls matchSinglePatVar</span><span>
</span><a name="line-805"></a><span class="hs-comment">--</span><span>
</span><a name="line-806"></a><span class="hs-comment">-- matchSinglePat does not warn about incomplete patterns</span><span>
</span><a name="line-807"></a><span class="hs-comment">-- Used for things like [ e | pat &lt;- stuff ], where</span><span>
</span><a name="line-808"></a><span class="hs-comment">-- incomplete patterns are just fine</span><span>
</span><a name="line-809"></a><span>
</span><a name="line-810"></a><a name="matchSinglePat"><a href="Match.html#matchSinglePat"><span class="hs-identifier">matchSinglePat</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a name="local-6989586621684064277"><a href="#local-6989586621684064277"><span class="hs-identifier">var</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684064278"><a href="#local-6989586621684064278"><span class="hs-identifier">ctx</span></a></a><span> </span><a name="local-6989586621684064279"><a href="#local-6989586621684064279"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621684064280"><a href="#local-6989586621684064280"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621684064281"><a href="#local-6989586621684064281"><span class="hs-identifier">match_result</span></a></a><span>
</span><a name="line-811"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isExternalName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621684064277"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-812"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Match.html#matchSinglePatVar"><span class="hs-identifier hs-var">matchSinglePatVar</span></a><span> </span><a href="#local-6989586621684064277"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621684064278"><span class="hs-identifier hs-var">ctx</span></a><span> </span><a href="#local-6989586621684064279"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621684064280"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621684064281"><span class="hs-identifier hs-var">match_result</span></a><span>
</span><a name="line-813"></a><span>
</span><a name="line-814"></a><span class="hs-identifier">matchSinglePat</span><span> </span><a name="local-6989586621684064282"><a href="#local-6989586621684064282"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621684064283"><a href="#local-6989586621684064283"><span class="hs-identifier">hs_ctx</span></a></a><span> </span><a name="local-6989586621684064284"><a href="#local-6989586621684064284"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621684064285"><a href="#local-6989586621684064285"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621684064286"><a href="#local-6989586621684064286"><span class="hs-identifier">match_result</span></a></a><span>
</span><a name="line-815"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684064287"><a href="#local-6989586621684064287"><span class="hs-identifier">var</span></a></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsUtils.html#selectSimpleMatchVarL"><span class="hs-identifier hs-var">selectSimpleMatchVarL</span></a><span> </span><a href="#local-6989586621684064284"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-816"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684064288"><a href="#local-6989586621684064288"><span class="hs-identifier">match_result'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Match.html#matchSinglePatVar"><span class="hs-identifier hs-var">matchSinglePatVar</span></a><span> </span><a href="#local-6989586621684064287"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621684064283"><span class="hs-identifier hs-var">hs_ctx</span></a><span> </span><a href="#local-6989586621684064284"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621684064285"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621684064286"><span class="hs-identifier hs-var">match_result</span></a><span>
</span><a name="line-817"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="DsUtils.html#adjustMatchResult"><span class="hs-identifier hs-var">adjustMatchResult</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bindNonRec</span><span> </span><a href="#local-6989586621684064287"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621684064282"><span class="hs-identifier hs-var">scrut</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684064288"><span class="hs-identifier hs-var">match_result'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-818"></a><span>
</span><a name="line-819"></a><span class="hs-identifier">matchSinglePatVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span>   </span><span class="hs-comment">-- See Note [Match Ids]</span><span>
</span><a name="line-820"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsMatchContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-821"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span>
</span><a name="line-822"></a><a name="matchSinglePatVar"><a href="Match.html#matchSinglePatVar"><span class="hs-identifier">matchSinglePatVar</span></a></a><span> </span><a name="local-6989586621684064289"><a href="#local-6989586621684064289"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621684064290"><a href="#local-6989586621684064290"><span class="hs-identifier">ctx</span></a></a><span> </span><a name="local-6989586621684064291"><a href="#local-6989586621684064291"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621684064292"><a href="#local-6989586621684064292"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621684064293"><a href="#local-6989586621684064293"><span class="hs-identifier">match_result</span></a></a><span>
</span><a name="line-823"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isInternalName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><span class="hs-identifier hs-var">var</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-identifier">var</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-824"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684064294"><a href="#local-6989586621684064294"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-825"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684064295"><a href="#local-6989586621684064295"><span class="hs-identifier">locn</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#getSrcSpanDs"><span class="hs-identifier hs-var">getSrcSpanDs</span></a><span>
</span><a name="line-826"></a><span>
</span><a name="line-827"></a><span>                    </span><span class="hs-comment">-- Pattern match check warnings</span><span>
</span><a name="line-828"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="Check.html#checkSingle"><span class="hs-identifier hs-var">checkSingle</span></a><span> </span><a href="#local-6989586621684064294"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="DsMonad.html#DsMatchContext"><span class="hs-identifier hs-var">DsMatchContext</span></a><span> </span><a href="#local-6989586621684064290"><span class="hs-identifier hs-var">ctx</span></a><span> </span><a href="#local-6989586621684064295"><span class="hs-identifier hs-var">locn</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684064289"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621684064291"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">)</span><span>
</span><a name="line-829"></a><span>
</span><a name="line-830"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684064296"><a href="#local-6989586621684064296"><span class="hs-identifier">eqn_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#EqnInfo"><span class="hs-identifier hs-var">EqnInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">eqn_pats</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-special">(</span><a href="DsUtils.html#decideBangHood"><span class="hs-identifier hs-var">decideBangHood</span></a><span> </span><a href="#local-6989586621684064294"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684064291"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-831"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">eqn_orig</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">FromSource</span><span>
</span><a name="line-832"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">eqn_rhs</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064293"><span class="hs-identifier hs-var">match_result</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-833"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="Match.html#match"><span class="hs-identifier hs-var">match</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684064289"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621684064292"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684064296"><span class="hs-identifier hs-var">eqn_info</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-834"></a><span>
</span><a name="line-835"></a><span>
</span><a name="line-836"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Pattern classification
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-843"></a><span>
</span><a name="line-844"></a><span class="hs-keyword">data</span><span> </span><a name="PatGroup"><a href="Match.html#PatGroup"><span class="hs-identifier">PatGroup</span></a></a><span>
</span><a name="line-845"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="PgAny"><a href="Match.html#PgAny"><span class="hs-identifier">PgAny</span></a></a><span>               </span><span class="hs-comment">-- Immediate match: variables, wildcards,</span><span>
</span><a name="line-846"></a><span>                        </span><span class="hs-comment">--                  lazy patterns</span><span>
</span><a name="line-847"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="PgCon"><a href="Match.html#PgCon"><span class="hs-identifier">PgCon</span></a></a><span> </span><span class="hs-identifier hs-type">DataCon</span><span>       </span><span class="hs-comment">-- Constructor patterns (incl list, tuple)</span><span>
</span><a name="line-848"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="PgSyn"><a href="Match.html#PgSyn"><span class="hs-identifier">PgSyn</span></a></a><span> </span><span class="hs-identifier hs-type">PatSyn</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- See Note [Pattern synonym groups]</span><span>
</span><a name="line-849"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="PgLit"><a href="Match.html#PgLit"><span class="hs-identifier">PgLit</span></a></a><span> </span><span class="hs-identifier hs-type">Literal</span><span>       </span><span class="hs-comment">-- Literal patterns</span><span>
</span><a name="line-850"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="PgN"><a href="Match.html#PgN"><span class="hs-identifier">PgN</span></a></a><span>   </span><span class="hs-identifier hs-type">Rational</span><span>      </span><span class="hs-comment">-- Overloaded numeric literals;</span><span>
</span><a name="line-851"></a><span>                        </span><span class="hs-comment">-- see Note [Don't use Literal for PgN]</span><span>
</span><a name="line-852"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="PgOverS"><a href="Match.html#PgOverS"><span class="hs-identifier">PgOverS</span></a></a><span> </span><span class="hs-identifier hs-type">FastString</span><span>  </span><span class="hs-comment">-- Overloaded string literals</span><span>
</span><a name="line-853"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="PgNpK"><a href="Match.html#PgNpK"><span class="hs-identifier">PgNpK</span></a></a><span> </span><span class="hs-identifier hs-type">Integer</span><span>       </span><span class="hs-comment">-- n+k patterns</span><span>
</span><a name="line-854"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="PgBang"><a href="Match.html#PgBang"><span class="hs-identifier">PgBang</span></a></a><span>              </span><span class="hs-comment">-- Bang patterns</span><span>
</span><a name="line-855"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="PgCo"><a href="Match.html#PgCo"><span class="hs-identifier">PgCo</span></a></a><span> </span><span class="hs-identifier hs-type">Type</span><span>           </span><span class="hs-comment">-- Coercion patterns; the type is the type</span><span>
</span><a name="line-856"></a><span>                        </span><span class="hs-comment">--      of the pattern *inside*</span><span>
</span><a name="line-857"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="PgView"><a href="Match.html#PgView"><span class="hs-identifier">PgView</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- view pattern (e -&gt; p):</span><span>
</span><a name="line-858"></a><span>                        </span><span class="hs-comment">-- the LHsExpr is the expression e</span><span>
</span><a name="line-859"></a><span>           </span><span class="hs-identifier hs-type">Type</span><span>         </span><span class="hs-comment">-- the Type is the type of p (equivalently, the result type of e)</span><span>
</span><a name="line-860"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="PgOverloadedList"><a href="Match.html#PgOverloadedList"><span class="hs-identifier">PgOverloadedList</span></a></a><span>
</span><a name="line-861"></a><span>
</span><a name="line-862"></a><span class="hs-comment">{- Note [Don't use Literal for PgN]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Previously we had, as PatGroup constructors

  | ...
  | PgN   Literal       -- Overloaded literals
  | PgNpK Literal       -- n+k patterns
  | ...

But Literal is really supposed to represent an *unboxed* literal, like Int#.
We were sticking the literal from, say, an overloaded numeric literal pattern
into a LitInt constructor. This didn't really make sense; and we now have
the invariant that value in a LitInt must be in the range of the target
machine's Int# type, and an overloaded literal could meaningfully be larger.

Solution: For pattern grouping purposes, just store the literal directly in
the PgN constructor as a Rational if numeric, and add a PgOverStr constructor
for overloaded strings.
-}</span><span>
</span><a name="line-881"></a><span>
</span><a name="line-882"></a><span class="hs-identifier">groupEquations</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Match.html#PatGroup"><span class="hs-identifier hs-type">PatGroup</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-883"></a><span class="hs-comment">-- If the result is of form [g1, g2, g3],</span><span>
</span><a name="line-884"></a><span class="hs-comment">-- (a) all the (pg,eq) pairs in g1 have the same pg</span><span>
</span><a name="line-885"></a><span class="hs-comment">-- (b) none of the gi are empty</span><span>
</span><a name="line-886"></a><span class="hs-comment">-- The ordering of equations is unchanged</span><span>
</span><a name="line-887"></a><a name="groupEquations"><a href="Match.html#groupEquations"><span class="hs-identifier">groupEquations</span></a></a><span> </span><a name="local-6989586621684064297"><a href="#local-6989586621684064297"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684064298"><a href="#local-6989586621684064298"><span class="hs-identifier">eqns</span></a></a><span>
</span><a name="line-888"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">groupBy</span><span> </span><a href="#local-6989586621684064299"><span class="hs-identifier hs-var">same_gp</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Match.html#patGroup"><span class="hs-identifier hs-var">patGroup</span></a><span> </span><a href="#local-6989586621684064297"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="DsUtils.html#firstPat"><span class="hs-identifier hs-var">firstPat</span></a><span> </span><a href="#local-6989586621684064302"><span class="hs-identifier hs-var">eqn</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684064302"><span class="hs-identifier hs-var">eqn</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621684064302"><a href="#local-6989586621684064302"><span class="hs-identifier">eqn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684064298"><span class="hs-identifier hs-var">eqns</span></a><span class="hs-special">]</span><span>
</span><a name="line-889"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-890"></a><span>    </span><span class="hs-identifier">same_gp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Match.html#PatGroup"><span class="hs-identifier hs-type">PatGroup</span></a><span class="hs-special">,</span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Match.html#PatGroup"><span class="hs-identifier hs-type">PatGroup</span></a><span class="hs-special">,</span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-891"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684064300"><a href="#local-6989586621684064300"><span class="hs-identifier">pg1</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a name="local-6989586621684064299"><a href="#local-6989586621684064299"><span class="hs-identifier">same_gp</span></a></a><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684064301"><a href="#local-6989586621684064301"><span class="hs-identifier">pg2</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064300"><span class="hs-identifier hs-var">pg1</span></a><span> </span><span class="hs-special">`</span><a href="Match.html#sameGroup"><span class="hs-identifier hs-var">sameGroup</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684064301"><span class="hs-identifier hs-var">pg2</span></a><span>
</span><a name="line-892"></a><span>
</span><a name="line-893"></a><span class="hs-identifier">subGroup</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064030"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Map.elems</span><span>
</span><a name="line-894"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684064030"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-comment">-- Map.empty</span><span>
</span><a name="line-895"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064031"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684064030"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Map.lookup</span><span>
</span><a name="line-896"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064031"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684064030"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684064030"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Map.insert</span><span>
</span><a name="line-897"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621684064031"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-898"></a><span class="hs-comment">-- Input is a particular group.  The result sub-groups the</span><span>
</span><a name="line-899"></a><span class="hs-comment">-- equations by with particular constructor, literal etc they match.</span><span>
</span><a name="line-900"></a><span class="hs-comment">-- Each sub-list in the result has the same PatGroup</span><span>
</span><a name="line-901"></a><span class="hs-comment">-- See Note [Take care with pattern order]</span><span>
</span><a name="line-902"></a><span class="hs-comment">-- Parameterized by map operations to allow different implementations</span><span>
</span><a name="line-903"></a><span class="hs-comment">-- and constraints, eg. types without Ord instance.</span><span>
</span><a name="line-904"></a><a name="subGroup"><a href="Match.html#subGroup"><span class="hs-identifier">subGroup</span></a></a><span> </span><a name="local-6989586621684064303"><a href="#local-6989586621684064303"><span class="hs-identifier">elems</span></a></a><span> </span><a name="local-6989586621684064304"><a href="#local-6989586621684064304"><span class="hs-identifier">empty</span></a></a><span> </span><a name="local-6989586621684064305"><a href="#local-6989586621684064305"><span class="hs-identifier">lookup</span></a></a><span> </span><a name="local-6989586621684064306"><a href="#local-6989586621684064306"><span class="hs-identifier">insert</span></a></a><span> </span><a name="local-6989586621684064307"><a href="#local-6989586621684064307"><span class="hs-identifier">group</span></a></a><span>
</span><a name="line-905"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684064303"><span class="hs-identifier hs-var">elems</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="#local-6989586621684064308"><span class="hs-identifier hs-var">accumulate</span></a><span> </span><a href="#local-6989586621684064304"><span class="hs-identifier hs-var">empty</span></a><span> </span><a href="#local-6989586621684064307"><span class="hs-identifier hs-var">group</span></a><span>
</span><a name="line-906"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-907"></a><span>    </span><a name="local-6989586621684064308"><a href="#local-6989586621684064308"><span class="hs-identifier">accumulate</span></a></a><span> </span><a name="local-6989586621684064309"><a href="#local-6989586621684064309"><span class="hs-identifier">pg_map</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684064310"><a href="#local-6989586621684064310"><span class="hs-identifier">pg</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684064311"><a href="#local-6989586621684064311"><span class="hs-identifier">eqn</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-908"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684064305"><span class="hs-identifier hs-var">lookup</span></a><span> </span><a href="#local-6989586621684064310"><span class="hs-identifier hs-var">pg</span></a><span> </span><a href="#local-6989586621684064309"><span class="hs-identifier hs-var">pg_map</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-909"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684064312"><a href="#local-6989586621684064312"><span class="hs-identifier">eqns</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684064306"><span class="hs-identifier hs-var">insert</span></a><span> </span><a href="#local-6989586621684064310"><span class="hs-identifier hs-var">pg</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064311"><span class="hs-identifier hs-var">eqn</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684064312"><span class="hs-identifier hs-var">eqns</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684064309"><span class="hs-identifier hs-var">pg_map</span></a><span>
</span><a name="line-910"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684064306"><span class="hs-identifier hs-var">insert</span></a><span> </span><a href="#local-6989586621684064310"><span class="hs-identifier hs-var">pg</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684064311"><span class="hs-identifier hs-var">eqn</span></a><span class="hs-special">]</span><span>      </span><a href="#local-6989586621684064309"><span class="hs-identifier hs-var">pg_map</span></a><span>
</span><a name="line-911"></a><span>    </span><span class="hs-comment">-- pg_map :: Map a [EquationInfo]</span><span>
</span><a name="line-912"></a><span>    </span><span class="hs-comment">-- Equations seen so far in reverse order of appearance</span><span>
</span><a name="line-913"></a><span>
</span><a name="line-914"></a><span class="hs-identifier">subGroupOrd</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621684064029"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621684064029"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-915"></a><a name="subGroupOrd"><a href="Match.html#subGroupOrd"><span class="hs-identifier">subGroupOrd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Match.html#subGroup"><span class="hs-identifier hs-var">subGroup</span></a><span> </span><span class="hs-identifier hs-var">Map.elems</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><span class="hs-identifier hs-var">Map.insert</span><span>
</span><a name="line-916"></a><span>
</span><a name="line-917"></a><span class="hs-identifier">subGroupUniq</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Uniquable</span><span> </span><a href="#local-6989586621684064028"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621684064028"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-918"></a><a name="subGroupUniq"><a href="Match.html#subGroupUniq"><span class="hs-identifier">subGroupUniq</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-919"></a><span>  </span><a href="Match.html#subGroup"><span class="hs-identifier hs-var">subGroup</span></a><span> </span><span class="hs-identifier hs-var">eltsUDFM</span><span> </span><span class="hs-identifier hs-var">emptyUDFM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier hs-var">lookupUDFM</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684064313"><a href="#local-6989586621684064313"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621684064314"><a href="#local-6989586621684064314"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621684064315"><a href="#local-6989586621684064315"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">addToUDFM</span><span> </span><a href="#local-6989586621684064315"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621684064313"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621684064314"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-920"></a><span>
</span><a name="line-921"></a><span class="hs-comment">{- Note [Pattern synonym groups]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we see
  f (P a) = e1
  f (P b) = e2
    ...
where P is a pattern synonym, can we put (P a -&gt; e1) and (P b -&gt; e2) in the
same group?  We can if P is a constructor, but /not/ if P is a pattern synonym.
Consider (Trac #11224)
   -- readMaybe :: Read a =&gt; String -&gt; Maybe a
   pattern PRead :: Read a =&gt; () =&gt; a -&gt; String
   pattern PRead a &lt;- (readMaybe -&gt; Just a)

   f (PRead (x::Int))  = e1
   f (PRead (y::Bool)) = e2
This is all fine: we match the string by trying to read an Int; if that
fails we try to read a Bool. But clearly we can't combine the two into a single
match.

Conclusion: we can combine when we invoke PRead /at the same type/.  Hence
in PgSyn we record the instantiaing types, and use them in sameGroup.

Note [Take care with pattern order]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In the subGroup function we must be very careful about pattern re-ordering,
Consider the patterns [ (True, Nothing), (False, x), (True, y) ]
Then in bringing together the patterns for True, we must not
swap the Nothing and y!
-}</span><span>
</span><a name="line-950"></a><span>
</span><a name="line-951"></a><span class="hs-identifier">sameGroup</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Match.html#PatGroup"><span class="hs-identifier hs-type">PatGroup</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Match.html#PatGroup"><span class="hs-identifier hs-type">PatGroup</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-952"></a><span class="hs-comment">-- Same group means that a single case expression</span><span>
</span><a name="line-953"></a><span class="hs-comment">-- or test will suffice to match both, *and* the order</span><span>
</span><a name="line-954"></a><span class="hs-comment">-- of testing within the group is insignificant.</span><span>
</span><a name="line-955"></a><a name="sameGroup"><a href="Match.html#sameGroup"><span class="hs-identifier">sameGroup</span></a></a><span> </span><a href="Match.html#PgAny"><span class="hs-identifier hs-var">PgAny</span></a><span>         </span><a href="Match.html#PgAny"><span class="hs-identifier hs-var">PgAny</span></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-956"></a><span class="hs-identifier">sameGroup</span><span> </span><a href="Match.html#PgBang"><span class="hs-identifier hs-var">PgBang</span></a><span>        </span><a href="Match.html#PgBang"><span class="hs-identifier hs-var">PgBang</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-957"></a><span class="hs-identifier">sameGroup</span><span> </span><span class="hs-special">(</span><a href="Match.html#PgCon"><span class="hs-identifier hs-var">PgCon</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>     </span><span class="hs-special">(</span><a href="Match.html#PgCon"><span class="hs-identifier hs-var">PgCon</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>    </span><span class="hs-comment">-- One case expression</span><span>
</span><a name="line-958"></a><span class="hs-identifier">sameGroup</span><span> </span><span class="hs-special">(</span><a href="Match.html#PgSyn"><span class="hs-identifier hs-var">PgSyn</span></a><span> </span><a name="local-6989586621684064316"><a href="#local-6989586621684064316"><span class="hs-identifier">p1</span></a></a><span> </span><a name="local-6989586621684064317"><a href="#local-6989586621684064317"><span class="hs-identifier">t1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Match.html#PgSyn"><span class="hs-identifier hs-var">PgSyn</span></a><span> </span><a name="local-6989586621684064318"><a href="#local-6989586621684064318"><span class="hs-identifier">p2</span></a></a><span> </span><a name="local-6989586621684064319"><a href="#local-6989586621684064319"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064316"><span class="hs-identifier hs-var">p1</span></a><span class="hs-operator hs-var">==</span><a href="#local-6989586621684064318"><span class="hs-identifier hs-var">p2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">eqTypes</span><span> </span><a href="#local-6989586621684064317"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-6989586621684064319"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-959"></a><span>                                                </span><span class="hs-comment">-- eqTypes: See Note [Pattern synonym groups]</span><span>
</span><a name="line-960"></a><span class="hs-identifier">sameGroup</span><span> </span><span class="hs-special">(</span><a href="Match.html#PgLit"><span class="hs-identifier hs-var">PgLit</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>     </span><span class="hs-special">(</span><a href="Match.html#PgLit"><span class="hs-identifier hs-var">PgLit</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>    </span><span class="hs-comment">-- One case expression</span><span>
</span><a name="line-961"></a><span class="hs-identifier">sameGroup</span><span> </span><span class="hs-special">(</span><a href="Match.html#PgN"><span class="hs-identifier hs-var">PgN</span></a><span> </span><a name="local-6989586621684064320"><a href="#local-6989586621684064320"><span class="hs-identifier">l1</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-special">(</span><a href="Match.html#PgN"><span class="hs-identifier hs-var">PgN</span></a><span> </span><a name="local-6989586621684064321"><a href="#local-6989586621684064321"><span class="hs-identifier">l2</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064320"><span class="hs-identifier hs-var">l1</span></a><span class="hs-operator hs-var">==</span><a href="#local-6989586621684064321"><span class="hs-identifier hs-var">l2</span></a><span>  </span><span class="hs-comment">-- Order is significant</span><span>
</span><a name="line-962"></a><span class="hs-identifier">sameGroup</span><span> </span><span class="hs-special">(</span><a href="Match.html#PgOverS"><span class="hs-identifier hs-var">PgOverS</span></a><span> </span><a name="local-6989586621684064322"><a href="#local-6989586621684064322"><span class="hs-identifier">s1</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-special">(</span><a href="Match.html#PgOverS"><span class="hs-identifier hs-var">PgOverS</span></a><span> </span><a name="local-6989586621684064323"><a href="#local-6989586621684064323"><span class="hs-identifier">s2</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064322"><span class="hs-identifier hs-var">s1</span></a><span class="hs-operator hs-var">==</span><a href="#local-6989586621684064323"><span class="hs-identifier hs-var">s2</span></a><span>
</span><a name="line-963"></a><span class="hs-identifier">sameGroup</span><span> </span><span class="hs-special">(</span><a href="Match.html#PgNpK"><span class="hs-identifier hs-var">PgNpK</span></a><span> </span><a name="local-6989586621684064324"><a href="#local-6989586621684064324"><span class="hs-identifier">l1</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-special">(</span><a href="Match.html#PgNpK"><span class="hs-identifier hs-var">PgNpK</span></a><span> </span><a name="local-6989586621684064325"><a href="#local-6989586621684064325"><span class="hs-identifier">l2</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064324"><span class="hs-identifier hs-var">l1</span></a><span class="hs-operator hs-var">==</span><a href="#local-6989586621684064325"><span class="hs-identifier hs-var">l2</span></a><span>  </span><span class="hs-comment">-- See Note [Grouping overloaded literal patterns]</span><span>
</span><a name="line-964"></a><span class="hs-identifier">sameGroup</span><span> </span><span class="hs-special">(</span><a href="Match.html#PgCo"><span class="hs-identifier hs-var">PgCo</span></a><span> </span><a name="local-6989586621684064326"><a href="#local-6989586621684064326"><span class="hs-identifier">t1</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-special">(</span><a href="Match.html#PgCo"><span class="hs-identifier hs-var">PgCo</span></a><span> </span><a name="local-6989586621684064327"><a href="#local-6989586621684064327"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064326"><span class="hs-identifier hs-var">t1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqType</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684064327"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-965"></a><span>        </span><span class="hs-comment">-- CoPats are in the same goup only if the type of the</span><span>
</span><a name="line-966"></a><span>        </span><span class="hs-comment">-- enclosed pattern is the same. The patterns outside the CoPat</span><span>
</span><a name="line-967"></a><span>        </span><span class="hs-comment">-- always have the same type, so this boils down to saying that</span><span>
</span><a name="line-968"></a><span>        </span><span class="hs-comment">-- the two coercions are identical.</span><span>
</span><a name="line-969"></a><span class="hs-identifier">sameGroup</span><span> </span><span class="hs-special">(</span><a href="Match.html#PgView"><span class="hs-identifier hs-var">PgView</span></a><span> </span><a name="local-6989586621684064328"><a href="#local-6989586621684064328"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-6989586621684064329"><a href="#local-6989586621684064329"><span class="hs-identifier">t1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Match.html#PgView"><span class="hs-identifier hs-var">PgView</span></a><span> </span><a name="local-6989586621684064330"><a href="#local-6989586621684064330"><span class="hs-identifier">e2</span></a></a><span> </span><a name="local-6989586621684064331"><a href="#local-6989586621684064331"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Match.html#viewLExprEq"><span class="hs-identifier hs-var">viewLExprEq</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064328"><span class="hs-identifier hs-var">e1</span></a><span class="hs-special">,</span><a href="#local-6989586621684064329"><span class="hs-identifier hs-var">t1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064330"><span class="hs-identifier hs-var">e2</span></a><span class="hs-special">,</span><a href="#local-6989586621684064331"><span class="hs-identifier hs-var">t2</span></a><span class="hs-special">)</span><span>
</span><a name="line-970"></a><span>       </span><span class="hs-comment">-- ViewPats are in the same group iff the expressions</span><span>
</span><a name="line-971"></a><span>       </span><span class="hs-comment">-- are &quot;equal&quot;---conservatively, we use syntactic equality</span><span>
</span><a name="line-972"></a><span class="hs-identifier">sameGroup</span><span> </span><span class="hs-identifier">_</span><span>          </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-973"></a><span>
</span><a name="line-974"></a><span class="hs-comment">-- An approximation of syntactic equality used for determining when view</span><span>
</span><a name="line-975"></a><span class="hs-comment">-- exprs are in the same group.</span><span>
</span><a name="line-976"></a><span class="hs-comment">-- This function can always safely return false;</span><span>
</span><a name="line-977"></a><span class="hs-comment">-- but doing so will result in the application of the view function being repeated.</span><span>
</span><a name="line-978"></a><span class="hs-comment">--</span><span>
</span><a name="line-979"></a><span class="hs-comment">-- Currently: compare applications of literals and variables</span><span>
</span><a name="line-980"></a><span class="hs-comment">--            and anything else that we can do without involving other</span><span>
</span><a name="line-981"></a><span class="hs-comment">--            HsSyn types in the recursion</span><span>
</span><a name="line-982"></a><span class="hs-comment">--</span><span>
</span><a name="line-983"></a><span class="hs-comment">-- NB we can't assume that the two view expressions have the same type.  Consider</span><span>
</span><a name="line-984"></a><span class="hs-comment">--   f (e1 -&gt; True) = ...</span><span>
</span><a name="line-985"></a><span class="hs-comment">--   f (e2 -&gt; &quot;hi&quot;) = ...</span><span>
</span><a name="line-986"></a><span class="hs-identifier">viewLExprEq</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-987"></a><a name="viewLExprEq"><a href="Match.html#viewLExprEq"><span class="hs-identifier">viewLExprEq</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684064332"><a href="#local-6989586621684064332"><span class="hs-identifier">e1</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684064333"><a href="#local-6989586621684064333"><span class="hs-identifier">e2</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064334"><span class="hs-identifier hs-var">lexp</span></a><span> </span><a href="#local-6989586621684064332"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-6989586621684064333"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-988"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-989"></a><span>    </span><span class="hs-identifier">lexp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-990"></a><span>    </span><a name="local-6989586621684064334"><a href="#local-6989586621684064334"><span class="hs-identifier">lexp</span></a></a><span> </span><a name="local-6989586621684064342"><a href="#local-6989586621684064342"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621684064343"><a href="#local-6989586621684064343"><span class="hs-identifier">e'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064335"><span class="hs-identifier hs-var">exp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621684064342"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621684064343"><span class="hs-identifier hs-var">e'</span></a><span class="hs-special">)</span><span>
</span><a name="line-991"></a><span>
</span><a name="line-992"></a><span>    </span><span class="hs-comment">---------</span><span>
</span><a name="line-993"></a><span>    </span><span class="hs-identifier">exp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-994"></a><span>    </span><span class="hs-comment">-- real comparison is on HsExpr's</span><span>
</span><a name="line-995"></a><span>    </span><span class="hs-comment">-- strip parens</span><span>
</span><a name="line-996"></a><span>    </span><a name="local-6989586621684064335"><a href="#local-6989586621684064335"><span class="hs-identifier">exp</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsPar</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064344"><a href="#local-6989586621684064344"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684064345"><a href="#local-6989586621684064345"><span class="hs-identifier">e'</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064335"><span class="hs-identifier hs-var">exp</span></a><span> </span><a href="#local-6989586621684064344"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621684064345"><span class="hs-identifier hs-var">e'</span></a><span>
</span><a name="line-997"></a><span>    </span><span class="hs-identifier">exp</span><span> </span><a name="local-6989586621684064346"><a href="#local-6989586621684064346"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsPar</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064347"><a href="#local-6989586621684064347"><span class="hs-identifier">e'</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064335"><span class="hs-identifier hs-var">exp</span></a><span> </span><a href="#local-6989586621684064346"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621684064347"><span class="hs-identifier hs-var">e'</span></a><span>
</span><a name="line-998"></a><span>    </span><span class="hs-comment">-- because the expressions do not necessarily have the same type,</span><span>
</span><a name="line-999"></a><span>    </span><span class="hs-comment">-- we have to compare the wrappers</span><span>
</span><a name="line-1000"></a><span>    </span><span class="hs-identifier">exp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsWrap</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064348"><a href="#local-6989586621684064348"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-6989586621684064349"><a href="#local-6989586621684064349"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsWrap</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064350"><a href="#local-6989586621684064350"><span class="hs-identifier">h'</span></a></a><span> </span><a name="local-6989586621684064351"><a href="#local-6989586621684064351"><span class="hs-identifier">e'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064338"><span class="hs-identifier hs-var">wrap</span></a><span> </span><a href="#local-6989586621684064348"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621684064350"><span class="hs-identifier hs-var">h'</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684064335"><span class="hs-identifier hs-var">exp</span></a><span> </span><a href="#local-6989586621684064349"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621684064351"><span class="hs-identifier hs-var">e'</span></a><span>
</span><a name="line-1001"></a><span>    </span><span class="hs-identifier">exp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064352"><a href="#local-6989586621684064352"><span class="hs-identifier">i</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064353"><a href="#local-6989586621684064353"><span class="hs-identifier">i'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>  </span><a href="#local-6989586621684064352"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684064353"><span class="hs-identifier hs-var">i'</span></a><span>
</span><a name="line-1002"></a><span>    </span><span class="hs-identifier">exp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsConLikeOut</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064354"><a href="#local-6989586621684064354"><span class="hs-identifier">c</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsConLikeOut</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064355"><a href="#local-6989586621684064355"><span class="hs-identifier">c'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064354"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684064355"><span class="hs-identifier hs-var">c'</span></a><span>
</span><a name="line-1003"></a><span>    </span><span class="hs-comment">-- the instance for IPName derives using the id, so this works if the</span><span>
</span><a name="line-1004"></a><span>    </span><span class="hs-comment">-- above does</span><span>
</span><a name="line-1005"></a><span>    </span><span class="hs-identifier">exp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIPVar</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064356"><a href="#local-6989586621684064356"><span class="hs-identifier">i</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIPVar</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064357"><a href="#local-6989586621684064357"><span class="hs-identifier">i'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064356"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684064357"><span class="hs-identifier hs-var">i'</span></a><span>
</span><a name="line-1006"></a><span>    </span><span class="hs-identifier">exp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsOverLabel</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064358"><a href="#local-6989586621684064358"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621684064359"><a href="#local-6989586621684064359"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsOverLabel</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064360"><a href="#local-6989586621684064360"><span class="hs-identifier">l'</span></a></a><span> </span><a name="local-6989586621684064361"><a href="#local-6989586621684064361"><span class="hs-identifier">x'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064358"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684064360"><span class="hs-identifier hs-var">l'</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684064359"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684064361"><span class="hs-identifier hs-var">x'</span></a><span>
</span><a name="line-1007"></a><span>    </span><span class="hs-identifier">exp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsOverLit</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064362"><a href="#local-6989586621684064362"><span class="hs-identifier">l</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsOverLit</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064363"><a href="#local-6989586621684064363"><span class="hs-identifier">l'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1008"></a><span>        </span><span class="hs-comment">-- Overloaded lits are equal if they have the same type</span><span>
</span><a name="line-1009"></a><span>        </span><span class="hs-comment">-- and the data is the same.</span><span>
</span><a name="line-1010"></a><span>        </span><span class="hs-comment">-- this is coarser than comparing the SyntaxExpr's in l and l',</span><span>
</span><a name="line-1011"></a><span>        </span><span class="hs-comment">-- which resolve the overloading (e.g., fromInteger 1),</span><span>
</span><a name="line-1012"></a><span>        </span><span class="hs-comment">-- because these expressions get written as a bunch of different variables</span><span>
</span><a name="line-1013"></a><span>        </span><span class="hs-comment">-- (presumably to improve sharing)</span><span>
</span><a name="line-1014"></a><span>        </span><span class="hs-identifier hs-var">eqType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">overLitType</span><span> </span><a href="#local-6989586621684064362"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">overLitType</span><span> </span><a href="#local-6989586621684064363"><span class="hs-identifier hs-var">l'</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684064362"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684064363"><span class="hs-identifier hs-var">l'</span></a><span>
</span><a name="line-1015"></a><span>    </span><span class="hs-identifier">exp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsApp</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064364"><a href="#local-6989586621684064364"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-6989586621684064365"><a href="#local-6989586621684064365"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsApp</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064366"><a href="#local-6989586621684064366"><span class="hs-identifier">e1'</span></a></a><span> </span><a name="local-6989586621684064367"><a href="#local-6989586621684064367"><span class="hs-identifier">e2'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064334"><span class="hs-identifier hs-var">lexp</span></a><span> </span><a href="#local-6989586621684064364"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-6989586621684064366"><span class="hs-identifier hs-var">e1'</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684064334"><span class="hs-identifier hs-var">lexp</span></a><span> </span><a href="#local-6989586621684064365"><span class="hs-identifier hs-var">e2</span></a><span> </span><a href="#local-6989586621684064367"><span class="hs-identifier hs-var">e2'</span></a><span>
</span><a name="line-1016"></a><span>    </span><span class="hs-comment">-- the fixities have been straightened out by now, so it's safe</span><span>
</span><a name="line-1017"></a><span>    </span><span class="hs-comment">-- to ignore them?</span><span>
</span><a name="line-1018"></a><span>    </span><span class="hs-identifier">exp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">OpApp</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064368"><a href="#local-6989586621684064368"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621684064369"><a href="#local-6989586621684064369"><span class="hs-identifier">o</span></a></a><span> </span><a name="local-6989586621684064370"><a href="#local-6989586621684064370"><span class="hs-identifier">ri</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">OpApp</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064371"><a href="#local-6989586621684064371"><span class="hs-identifier">l'</span></a></a><span> </span><a name="local-6989586621684064372"><a href="#local-6989586621684064372"><span class="hs-identifier">o'</span></a></a><span> </span><a name="local-6989586621684064373"><a href="#local-6989586621684064373"><span class="hs-identifier">ri'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1019"></a><span>        </span><a href="#local-6989586621684064334"><span class="hs-identifier hs-var">lexp</span></a><span> </span><a href="#local-6989586621684064368"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621684064371"><span class="hs-identifier hs-var">l'</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684064334"><span class="hs-identifier hs-var">lexp</span></a><span> </span><a href="#local-6989586621684064369"><span class="hs-identifier hs-var">o</span></a><span> </span><a href="#local-6989586621684064372"><span class="hs-identifier hs-var">o'</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684064334"><span class="hs-identifier hs-var">lexp</span></a><span> </span><a href="#local-6989586621684064370"><span class="hs-identifier hs-var">ri</span></a><span> </span><a href="#local-6989586621684064373"><span class="hs-identifier hs-var">ri'</span></a><span>
</span><a name="line-1020"></a><span>    </span><span class="hs-identifier">exp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NegApp</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064374"><a href="#local-6989586621684064374"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621684064375"><a href="#local-6989586621684064375"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NegApp</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064376"><a href="#local-6989586621684064376"><span class="hs-identifier">e'</span></a></a><span> </span><a name="local-6989586621684064377"><a href="#local-6989586621684064377"><span class="hs-identifier">n'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064334"><span class="hs-identifier hs-var">lexp</span></a><span> </span><a href="#local-6989586621684064374"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621684064376"><span class="hs-identifier hs-var">e'</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684064336"><span class="hs-identifier hs-var">syn_exp</span></a><span> </span><a href="#local-6989586621684064375"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621684064377"><span class="hs-identifier hs-var">n'</span></a><span>
</span><a name="line-1021"></a><span>    </span><span class="hs-identifier">exp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SectionL</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064378"><a href="#local-6989586621684064378"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-6989586621684064379"><a href="#local-6989586621684064379"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SectionL</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064380"><a href="#local-6989586621684064380"><span class="hs-identifier">e1'</span></a></a><span> </span><a name="local-6989586621684064381"><a href="#local-6989586621684064381"><span class="hs-identifier">e2'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1022"></a><span>        </span><a href="#local-6989586621684064334"><span class="hs-identifier hs-var">lexp</span></a><span> </span><a href="#local-6989586621684064378"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-6989586621684064380"><span class="hs-identifier hs-var">e1'</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684064334"><span class="hs-identifier hs-var">lexp</span></a><span> </span><a href="#local-6989586621684064379"><span class="hs-identifier hs-var">e2</span></a><span> </span><a href="#local-6989586621684064381"><span class="hs-identifier hs-var">e2'</span></a><span>
</span><a name="line-1023"></a><span>    </span><span class="hs-identifier">exp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SectionR</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064382"><a href="#local-6989586621684064382"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-6989586621684064383"><a href="#local-6989586621684064383"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SectionR</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064384"><a href="#local-6989586621684064384"><span class="hs-identifier">e1'</span></a></a><span> </span><a name="local-6989586621684064385"><a href="#local-6989586621684064385"><span class="hs-identifier">e2'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1024"></a><span>        </span><a href="#local-6989586621684064334"><span class="hs-identifier hs-var">lexp</span></a><span> </span><a href="#local-6989586621684064382"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-6989586621684064384"><span class="hs-identifier hs-var">e1'</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684064334"><span class="hs-identifier hs-var">lexp</span></a><span> </span><a href="#local-6989586621684064383"><span class="hs-identifier hs-var">e2</span></a><span> </span><a href="#local-6989586621684064385"><span class="hs-identifier hs-var">e2'</span></a><span>
</span><a name="line-1025"></a><span>    </span><span class="hs-identifier">exp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExplicitTuple</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064386"><a href="#local-6989586621684064386"><span class="hs-identifier">es1</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExplicitTuple</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064387"><a href="#local-6989586621684064387"><span class="hs-identifier">es2</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1026"></a><span>        </span><a href="#local-6989586621684064340"><span class="hs-identifier hs-var">eq_list</span></a><span> </span><a href="#local-6989586621684064337"><span class="hs-identifier hs-var">tup_arg</span></a><span> </span><a href="#local-6989586621684064386"><span class="hs-identifier hs-var">es1</span></a><span> </span><a href="#local-6989586621684064387"><span class="hs-identifier hs-var">es2</span></a><span>
</span><a name="line-1027"></a><span>    </span><span class="hs-identifier">exp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExplicitSum</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064388"><a href="#local-6989586621684064388"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExplicitSum</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064389"><a href="#local-6989586621684064389"><span class="hs-identifier">e'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064334"><span class="hs-identifier hs-var">lexp</span></a><span> </span><a href="#local-6989586621684064388"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621684064389"><span class="hs-identifier hs-var">e'</span></a><span>
</span><a name="line-1028"></a><span>    </span><span class="hs-identifier">exp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIf</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064390"><a href="#local-6989586621684064390"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621684064391"><a href="#local-6989586621684064391"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-6989586621684064392"><a href="#local-6989586621684064392"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIf</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064393"><a href="#local-6989586621684064393"><span class="hs-identifier">e'</span></a></a><span> </span><a name="local-6989586621684064394"><a href="#local-6989586621684064394"><span class="hs-identifier">e1'</span></a></a><span> </span><a name="local-6989586621684064395"><a href="#local-6989586621684064395"><span class="hs-identifier">e2'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1029"></a><span>        </span><a href="#local-6989586621684064334"><span class="hs-identifier hs-var">lexp</span></a><span> </span><a href="#local-6989586621684064390"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621684064393"><span class="hs-identifier hs-var">e'</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684064334"><span class="hs-identifier hs-var">lexp</span></a><span> </span><a href="#local-6989586621684064391"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-6989586621684064394"><span class="hs-identifier hs-var">e1'</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684064334"><span class="hs-identifier hs-var">lexp</span></a><span> </span><a href="#local-6989586621684064392"><span class="hs-identifier hs-var">e2</span></a><span> </span><a href="#local-6989586621684064395"><span class="hs-identifier hs-var">e2'</span></a><span>
</span><a name="line-1030"></a><span>
</span><a name="line-1031"></a><span>    </span><span class="hs-comment">-- Enhancement: could implement equality for more expressions</span><span>
</span><a name="line-1032"></a><span>    </span><span class="hs-comment">--   if it seems useful</span><span>
</span><a name="line-1033"></a><span>    </span><span class="hs-comment">-- But no need for HsLit, ExplicitList, ExplicitTuple,</span><span>
</span><a name="line-1034"></a><span>    </span><span class="hs-comment">-- because they cannot be functions</span><span>
</span><a name="line-1035"></a><span>    </span><span class="hs-identifier">exp</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1036"></a><span>
</span><a name="line-1037"></a><span>    </span><span class="hs-comment">---------</span><span>
</span><a name="line-1038"></a><span>    </span><span class="hs-identifier">syn_exp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SyntaxExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SyntaxExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1039"></a><span>    </span><a name="local-6989586621684064336"><a href="#local-6989586621684064336"><span class="hs-identifier">syn_exp</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SyntaxExpr</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">syn_expr</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684064396"><a href="#local-6989586621684064396"><span class="hs-identifier">expr1</span></a></a><span>
</span><a name="line-1040"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">syn_arg_wraps</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684064397"><a href="#local-6989586621684064397"><span class="hs-identifier">arg_wraps1</span></a></a><span>
</span><a name="line-1041"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">syn_res_wrap</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684064398"><a href="#local-6989586621684064398"><span class="hs-identifier">res_wrap1</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1042"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SyntaxExpr</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">syn_expr</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684064399"><a href="#local-6989586621684064399"><span class="hs-identifier">expr2</span></a></a><span>
</span><a name="line-1043"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">syn_arg_wraps</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684064400"><a href="#local-6989586621684064400"><span class="hs-identifier">arg_wraps2</span></a></a><span>
</span><a name="line-1044"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">syn_res_wrap</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684064401"><a href="#local-6989586621684064401"><span class="hs-identifier">res_wrap2</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1045"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064335"><span class="hs-identifier hs-var">exp</span></a><span> </span><a href="#local-6989586621684064396"><span class="hs-identifier hs-var">expr1</span></a><span> </span><a href="#local-6989586621684064399"><span class="hs-identifier hs-var">expr2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-1046"></a><span>        </span><span class="hs-identifier hs-var">and</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipWithEqual</span><span> </span><span class="hs-string">&quot;viewLExprEq&quot;</span><span> </span><a href="#local-6989586621684064338"><span class="hs-identifier hs-var">wrap</span></a><span> </span><a href="#local-6989586621684064397"><span class="hs-identifier hs-var">arg_wraps1</span></a><span> </span><a href="#local-6989586621684064400"><span class="hs-identifier hs-var">arg_wraps2</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-1047"></a><span>        </span><a href="#local-6989586621684064338"><span class="hs-identifier hs-var">wrap</span></a><span> </span><a href="#local-6989586621684064398"><span class="hs-identifier hs-var">res_wrap1</span></a><span> </span><a href="#local-6989586621684064401"><span class="hs-identifier hs-var">res_wrap2</span></a><span>
</span><a name="line-1048"></a><span>
</span><a name="line-1049"></a><span>    </span><span class="hs-comment">---------</span><span>
</span><a name="line-1050"></a><span>    </span><a name="local-6989586621684064337"><a href="#local-6989586621684064337"><span class="hs-identifier">tup_arg</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Present</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064402"><a href="#local-6989586621684064402"><span class="hs-identifier">e1</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Present</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064403"><a href="#local-6989586621684064403"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064334"><span class="hs-identifier hs-var">lexp</span></a><span> </span><a href="#local-6989586621684064402"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-6989586621684064403"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-1051"></a><span>    </span><span class="hs-identifier">tup_arg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Missing</span><span> </span><a name="local-6989586621684064404"><a href="#local-6989586621684064404"><span class="hs-identifier">t1</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Missing</span><span> </span><a name="local-6989586621684064405"><a href="#local-6989586621684064405"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">eqType</span><span> </span><a href="#local-6989586621684064404"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-6989586621684064405"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-1052"></a><span>    </span><span class="hs-identifier">tup_arg</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1053"></a><span>
</span><a name="line-1054"></a><span>    </span><span class="hs-comment">---------</span><span>
</span><a name="line-1055"></a><span>    </span><span class="hs-identifier">wrap</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsWrapper</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsWrapper</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1056"></a><span>    </span><span class="hs-comment">-- Conservative, in that it demands that wrappers be</span><span>
</span><a name="line-1057"></a><span>    </span><span class="hs-comment">-- syntactically identical and doesn't look under binders</span><span>
</span><a name="line-1058"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1059"></a><span>    </span><span class="hs-comment">-- Coarser notions of equality are possible</span><span>
</span><a name="line-1060"></a><span>    </span><span class="hs-comment">-- (e.g., reassociating compositions,</span><span>
</span><a name="line-1061"></a><span>    </span><span class="hs-comment">--        equating different ways of writing a coercion)</span><span>
</span><a name="line-1062"></a><span>    </span><a name="local-6989586621684064338"><a href="#local-6989586621684064338"><span class="hs-identifier">wrap</span></a></a><span> </span><span class="hs-identifier hs-var">WpHole</span><span> </span><span class="hs-identifier hs-var">WpHole</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1063"></a><span>    </span><span class="hs-identifier">wrap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WpCompose</span><span> </span><a name="local-6989586621684064406"><a href="#local-6989586621684064406"><span class="hs-identifier">w1</span></a></a><span> </span><a name="local-6989586621684064407"><a href="#local-6989586621684064407"><span class="hs-identifier">w2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WpCompose</span><span> </span><a name="local-6989586621684064408"><a href="#local-6989586621684064408"><span class="hs-identifier">w1'</span></a></a><span> </span><a name="local-6989586621684064409"><a href="#local-6989586621684064409"><span class="hs-identifier">w2'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064338"><span class="hs-identifier hs-var">wrap</span></a><span> </span><a href="#local-6989586621684064406"><span class="hs-identifier hs-var">w1</span></a><span> </span><a href="#local-6989586621684064408"><span class="hs-identifier hs-var">w1'</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684064338"><span class="hs-identifier hs-var">wrap</span></a><span> </span><a href="#local-6989586621684064407"><span class="hs-identifier hs-var">w2</span></a><span> </span><a href="#local-6989586621684064409"><span class="hs-identifier hs-var">w2'</span></a><span>
</span><a name="line-1064"></a><span>    </span><span class="hs-identifier">wrap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WpFun</span><span> </span><a name="local-6989586621684064410"><a href="#local-6989586621684064410"><span class="hs-identifier">w1</span></a></a><span> </span><a name="local-6989586621684064411"><a href="#local-6989586621684064411"><span class="hs-identifier">w2</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WpFun</span><span> </span><a name="local-6989586621684064412"><a href="#local-6989586621684064412"><span class="hs-identifier">w1'</span></a></a><span> </span><a name="local-6989586621684064413"><a href="#local-6989586621684064413"><span class="hs-identifier">w2'</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064338"><span class="hs-identifier hs-var">wrap</span></a><span> </span><a href="#local-6989586621684064410"><span class="hs-identifier hs-var">w1</span></a><span> </span><a href="#local-6989586621684064412"><span class="hs-identifier hs-var">w1'</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684064338"><span class="hs-identifier hs-var">wrap</span></a><span> </span><a href="#local-6989586621684064411"><span class="hs-identifier hs-var">w2</span></a><span> </span><a href="#local-6989586621684064413"><span class="hs-identifier hs-var">w2'</span></a><span>
</span><a name="line-1065"></a><span>    </span><span class="hs-identifier">wrap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WpCast</span><span> </span><a name="local-6989586621684064414"><a href="#local-6989586621684064414"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WpCast</span><span> </span><a name="local-6989586621684064415"><a href="#local-6989586621684064415"><span class="hs-identifier">co'</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064414"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqCoercion</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684064415"><span class="hs-identifier hs-var">co'</span></a><span>
</span><a name="line-1066"></a><span>    </span><span class="hs-identifier">wrap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WpEvApp</span><span> </span><a name="local-6989586621684064416"><a href="#local-6989586621684064416"><span class="hs-identifier">et1</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WpEvApp</span><span> </span><a name="local-6989586621684064417"><a href="#local-6989586621684064417"><span class="hs-identifier">et2</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064416"><span class="hs-identifier hs-var">et1</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621684064339"><span class="hs-identifier hs-var">ev_term</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684064417"><span class="hs-identifier hs-var">et2</span></a><span>
</span><a name="line-1067"></a><span>    </span><span class="hs-identifier">wrap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WpTyApp</span><span> </span><a name="local-6989586621684064418"><a href="#local-6989586621684064418"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WpTyApp</span><span> </span><a name="local-6989586621684064419"><a href="#local-6989586621684064419"><span class="hs-identifier">t'</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">eqType</span><span> </span><a href="#local-6989586621684064418"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621684064419"><span class="hs-identifier hs-var">t'</span></a><span>
</span><a name="line-1068"></a><span>    </span><span class="hs-comment">-- Enhancement: could implement equality for more wrappers</span><span>
</span><a name="line-1069"></a><span>    </span><span class="hs-comment">--   if it seems useful (lams and lets)</span><span>
</span><a name="line-1070"></a><span>    </span><span class="hs-identifier">wrap</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1071"></a><span>
</span><a name="line-1072"></a><span>    </span><span class="hs-comment">---------</span><span>
</span><a name="line-1073"></a><span>    </span><span class="hs-identifier">ev_term</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">EvTerm</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">EvTerm</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1074"></a><span>    </span><a name="local-6989586621684064339"><a href="#local-6989586621684064339"><span class="hs-identifier">ev_term</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a name="local-6989586621684064420"><a href="#local-6989586621684064420"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvExpr</span><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a name="local-6989586621684064421"><a href="#local-6989586621684064421"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064420"><span class="hs-identifier hs-var">a</span></a><span class="hs-operator hs-var">==</span><a href="#local-6989586621684064421"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-1075"></a><span>    </span><span class="hs-identifier">ev_term</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Coercion</span><span> </span><a name="local-6989586621684064422"><a href="#local-6989586621684064422"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Coercion</span><span> </span><a name="local-6989586621684064423"><a href="#local-6989586621684064423"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064422"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqCoercion</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684064423"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-1076"></a><span>    </span><span class="hs-identifier">ev_term</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1077"></a><span>
</span><a name="line-1078"></a><span>    </span><span class="hs-comment">---------</span><span>
</span><a name="line-1079"></a><span>    </span><span class="hs-identifier">eq_list</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064341"><span class="hs-identifier hs-type">a</span></a><span class="hs-glyph">-&gt;</span><a href="#local-6989586621684064341"><span class="hs-identifier hs-type">a</span></a><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684064341"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684064341"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1080"></a><span>    </span><a name="local-6989586621684064340"><a href="#local-6989586621684064340"><span class="hs-identifier">eq_list</span></a></a><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1081"></a><span>    </span><span class="hs-identifier">eq_list</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1082"></a><span>    </span><span class="hs-identifier">eq_list</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1083"></a><span>    </span><span class="hs-identifier">eq_list</span><span> </span><a name="local-6989586621684064424"><a href="#local-6989586621684064424"><span class="hs-identifier">eq</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684064425"><a href="#local-6989586621684064425"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684064426"><a href="#local-6989586621684064426"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684064427"><a href="#local-6989586621684064427"><span class="hs-identifier">y</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684064428"><a href="#local-6989586621684064428"><span class="hs-identifier">ys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684064424"><span class="hs-identifier hs-var">eq</span></a><span> </span><a href="#local-6989586621684064425"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621684064427"><span class="hs-identifier hs-var">y</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684064340"><span class="hs-identifier hs-var">eq_list</span></a><span> </span><a href="#local-6989586621684064424"><span class="hs-identifier hs-var">eq</span></a><span> </span><a href="#local-6989586621684064426"><span class="hs-identifier hs-var">xs</span></a><span> </span><a href="#local-6989586621684064428"><span class="hs-identifier hs-var">ys</span></a><span>
</span><a name="line-1084"></a><span>
</span><a name="line-1085"></a><span class="hs-identifier">patGroup</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Pat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Match.html#PatGroup"><span class="hs-identifier hs-type">PatGroup</span></a><span>
</span><a name="line-1086"></a><a name="patGroup"><a href="Match.html#patGroup"><span class="hs-identifier">patGroup</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ConPatOut</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pat_con</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064429"><a href="#local-6989586621684064429"><span class="hs-identifier">con</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1087"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pat_arg_tys</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684064430"><a href="#local-6989586621684064430"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1088"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">RealDataCon</span><span> </span><a name="local-6989586621684064431"><a href="#local-6989586621684064431"><span class="hs-identifier">dcon</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684064429"><span class="hs-identifier hs-var">con</span></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="Match.html#PgCon"><span class="hs-identifier hs-var">PgCon</span></a><span> </span><a href="#local-6989586621684064431"><span class="hs-identifier hs-var">dcon</span></a><span>
</span><a name="line-1089"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">PatSynCon</span><span> </span><a name="local-6989586621684064432"><a href="#local-6989586621684064432"><span class="hs-identifier">psyn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684064429"><span class="hs-identifier hs-var">con</span></a><span>                </span><span class="hs-glyph">=</span><span> </span><a href="Match.html#PgSyn"><span class="hs-identifier hs-var">PgSyn</span></a><span> </span><a href="#local-6989586621684064432"><span class="hs-identifier hs-var">psyn</span></a><span> </span><a href="#local-6989586621684064430"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1090"></a><span class="hs-identifier">patGroup</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WildPat</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="Match.html#PgAny"><span class="hs-identifier hs-var">PgAny</span></a><span>
</span><a name="line-1091"></a><span class="hs-identifier">patGroup</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BangPat</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="Match.html#PgBang"><span class="hs-identifier hs-var">PgBang</span></a><span>
</span><a name="line-1092"></a><span class="hs-identifier">patGroup</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NPat</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">OverLit</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">ol_val</span><span class="hs-glyph">=</span><a name="local-6989586621684064433"><a href="#local-6989586621684064433"><span class="hs-identifier">oval</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684064434"><a href="#local-6989586621684064434"><span class="hs-identifier">mb_neg</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1093"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684064433"><span class="hs-identifier hs-var">oval</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><a href="#local-6989586621684064434"><span class="hs-identifier hs-var">mb_neg</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1094"></a><span>   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIntegral</span><span>   </span><a name="local-6989586621684064435"><a href="#local-6989586621684064435"><span class="hs-identifier">i</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Match.html#PgN"><span class="hs-identifier hs-var">PgN</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromInteger</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">il_value</span><span> </span><a href="#local-6989586621684064435"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1095"></a><span>   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIntegral</span><span>   </span><a name="local-6989586621684064436"><a href="#local-6989586621684064436"><span class="hs-identifier">i</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Match.html#PgN"><span class="hs-identifier hs-var">PgN</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-identifier hs-var">fromInteger</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">il_value</span><span> </span><a href="#local-6989586621684064436"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1096"></a><span>   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsFractional</span><span> </span><a name="local-6989586621684064437"><a href="#local-6989586621684064437"><span class="hs-identifier">r</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Match.html#PgN"><span class="hs-identifier hs-var">PgN</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fl_value</span><span> </span><a href="#local-6989586621684064437"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-1097"></a><span>   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsFractional</span><span> </span><a name="local-6989586621684064438"><a href="#local-6989586621684064438"><span class="hs-identifier">r</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Match.html#PgN"><span class="hs-identifier hs-var">PgN</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-identifier">fl_value</span><span> </span><a href="#local-6989586621684064438"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-1098"></a><span>   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIsString</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064439"><a href="#local-6989586621684064439"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier">isNothing</span><span> </span><span class="hs-identifier">mb_neg</span><span class="hs-special">)</span><span>
</span><a name="line-1099"></a><span>                          </span><a href="Match.html#PgOverS"><span class="hs-identifier hs-var">PgOverS</span></a><span> </span><a href="#local-6989586621684064439"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-1100"></a><span class="hs-identifier">patGroup</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NPlusKPat</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">OverLit</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">ol_val</span><span class="hs-glyph">=</span><a name="local-6989586621684064440"><a href="#local-6989586621684064440"><span class="hs-identifier">oval</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1101"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684064440"><span class="hs-identifier hs-var">oval</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1102"></a><span>   </span><span class="hs-identifier hs-var">HsIntegral</span><span> </span><a name="local-6989586621684064441"><a href="#local-6989586621684064441"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Match.html#PgNpK"><span class="hs-identifier hs-var">PgNpK</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">il_value</span><span> </span><a href="#local-6989586621684064441"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span>
</span><a name="line-1103"></a><span>   </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;patGroup NPlusKPat&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684064440"><span class="hs-identifier hs-var">oval</span></a><span class="hs-special">)</span><span>
</span><a name="line-1104"></a><span class="hs-identifier">patGroup</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoPat</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064442"><a href="#local-6989586621684064442"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="Match.html#PgCo"><span class="hs-identifier hs-var">PgCo</span></a><span>  </span><span class="hs-special">(</span><a href="TcHsSyn.html#hsPatType"><span class="hs-identifier hs-var">hsPatType</span></a><span> </span><a href="#local-6989586621684064442"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-1105"></a><span>                                                    </span><span class="hs-comment">-- Type of innelexp pattern</span><span>
</span><a name="line-1106"></a><span class="hs-identifier">patGroup</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ViewPat</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064443"><a href="#local-6989586621684064443"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621684064444"><a href="#local-6989586621684064444"><span class="hs-identifier">p</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="Match.html#PgView"><span class="hs-identifier hs-var">PgView</span></a><span> </span><a href="#local-6989586621684064443"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">(</span><a href="TcHsSyn.html#hsPatType"><span class="hs-identifier hs-var">hsPatType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621684064444"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1107"></a><span class="hs-identifier">patGroup</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ListPat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ListPatTc</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Match.html#PgOverloadedList"><span class="hs-identifier hs-var">PgOverloadedList</span></a><span>
</span><a name="line-1108"></a><span class="hs-identifier">patGroup</span><span> </span><a name="local-6989586621684064445"><a href="#local-6989586621684064445"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitPat</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064446"><a href="#local-6989586621684064446"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Match.html#PgLit"><span class="hs-identifier hs-var">PgLit</span></a><span> </span><span class="hs-special">(</span><a href="MatchLit.html#hsLitKey"><span class="hs-identifier hs-var">hsLitKey</span></a><span> </span><a href="#local-6989586621684064445"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684064446"><span class="hs-identifier hs-var">lit</span></a><span class="hs-special">)</span><span>
</span><a name="line-1109"></a><span class="hs-identifier">patGroup</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684064447"><a href="#local-6989586621684064447"><span class="hs-identifier">pat</span></a></a><span>                          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;patGroup&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684064447"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">)</span><span>
</span><a name="line-1110"></a><span>
</span><a name="line-1111"></a><span class="hs-comment">{-
Note [Grouping overloaded literal patterns]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
WATCH OUT!  Consider

        f (n+1) = ...
        f (n+2) = ...
        f (n+1) = ...

We can't group the first and third together, because the second may match
the same thing as the first.  Same goes for *overloaded* literal patterns
        f 1 True = ...
        f 2 False = ...
        f 1 False = ...
If the first arg matches '1' but the second does not match 'True', we
cannot jump to the third equation!  Because the same argument might
match '2'!
Hence we don't regard 1 and 2, or (n+1) and (n+2), as part of the same group.
-}</span><span>
</span><a name="line-1130"></a></pre></body></html>