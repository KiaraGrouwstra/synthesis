<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP, RecordWildCards #-}</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-4"></a><span class="hs-comment">--</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- Stg to C-- code generation:</span><span>
</span><a name="line-6"></a><span class="hs-comment">--</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- The types   LambdaFormInfo</span><span>
</span><a name="line-8"></a><span class="hs-comment">--             ClosureInfo</span><span>
</span><a name="line-9"></a><span class="hs-comment">--</span><span>
</span><a name="line-10"></a><span class="hs-comment">-- Nothing monadic in here!</span><span>
</span><a name="line-11"></a><span class="hs-comment">--</span><span>
</span><a name="line-12"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">StgCmmClosure</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-15"></a><span>        </span><a href="StgCmmClosure.html#DynTag"><span class="hs-identifier hs-type">DynTag</span></a><span class="hs-special">,</span><span>  </span><a href="StgCmmClosure.html#tagForCon"><span class="hs-identifier hs-var">tagForCon</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmClosure.html#isSmallFamily"><span class="hs-identifier hs-var">isSmallFamily</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span>        </span><a href="StgCmmClosure.html#idPrimRep"><span class="hs-identifier hs-var">idPrimRep</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isVoidRep</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isGcPtrRep</span><span class="hs-special">,</span><span> </span><a href="StgCmmClosure.html#addIdReps"><span class="hs-identifier hs-var">addIdReps</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmClosure.html#addArgReps"><span class="hs-identifier hs-var">addArgReps</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>        </span><a href="StgCmmClosure.html#argPrimRep"><span class="hs-identifier hs-var">argPrimRep</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span>        </span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="StgCmmClosure.html#fromNonVoid"><span class="hs-identifier hs-var">fromNonVoid</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmClosure.html#nonVoidIds"><span class="hs-identifier hs-var">nonVoidIds</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmClosure.html#nonVoidStgArgs"><span class="hs-identifier hs-var">nonVoidStgArgs</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>        </span><a href="StgCmmClosure.html#assertNonVoidIds"><span class="hs-identifier hs-var">assertNonVoidIds</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmClosure.html#assertNonVoidStgArgs"><span class="hs-identifier hs-var">assertNonVoidStgArgs</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span>        </span><span class="hs-comment">-- * LambdaFormInfo</span><span>
</span><a name="line-24"></a><span>        </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span class="hs-special">,</span><span>         </span><span class="hs-comment">-- Abstract</span><span>
</span><a name="line-25"></a><span>        </span><a href="StgCmmClosure.html#StandardFormInfo"><span class="hs-identifier hs-type">StandardFormInfo</span></a><span class="hs-special">,</span><span>        </span><span class="hs-comment">-- ...ditto...</span><span>
</span><a name="line-26"></a><span>        </span><a href="StgCmmClosure.html#mkLFThunk"><span class="hs-identifier hs-var">mkLFThunk</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmClosure.html#mkLFReEntrant"><span class="hs-identifier hs-var">mkLFReEntrant</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmClosure.html#mkConLFInfo"><span class="hs-identifier hs-var">mkConLFInfo</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmClosure.html#mkSelectorLFInfo"><span class="hs-identifier hs-var">mkSelectorLFInfo</span></a><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>        </span><a href="StgCmmClosure.html#mkApLFInfo"><span class="hs-identifier hs-var">mkApLFInfo</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmClosure.html#mkLFImported"><span class="hs-identifier hs-var">mkLFImported</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmClosure.html#mkLFArgument"><span class="hs-identifier hs-var">mkLFArgument</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmClosure.html#mkLFLetNoEscape"><span class="hs-identifier hs-var">mkLFLetNoEscape</span></a><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>        </span><a href="StgCmmClosure.html#mkLFStringLit"><span class="hs-identifier hs-var">mkLFStringLit</span></a><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>        </span><a href="StgCmmClosure.html#lfDynTag"><span class="hs-identifier hs-var">lfDynTag</span></a><span class="hs-special">,</span><span>
</span><a name="line-30"></a><span>        </span><a href="StgCmmClosure.html#isLFThunk"><span class="hs-identifier hs-var">isLFThunk</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmClosure.html#isLFReEntrant"><span class="hs-identifier hs-var">isLFReEntrant</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmClosure.html#lfUpdatable"><span class="hs-identifier hs-var">lfUpdatable</span></a><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span>        </span><span class="hs-comment">-- * Used by other modules</span><span>
</span><a name="line-33"></a><span>        </span><a href="StgCmmClosure.html#CgLoc"><span class="hs-identifier hs-type">CgLoc</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="StgCmmClosure.html#SelfLoopInfo"><span class="hs-identifier hs-type">SelfLoopInfo</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmClosure.html#CallMethod"><span class="hs-identifier hs-type">CallMethod</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-34"></a><span>        </span><a href="StgCmmClosure.html#nodeMustPointToIt"><span class="hs-identifier hs-var">nodeMustPointToIt</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmClosure.html#isKnownFun"><span class="hs-identifier hs-var">isKnownFun</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmClosure.html#funTag"><span class="hs-identifier hs-var">funTag</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmClosure.html#tagForArity"><span class="hs-identifier hs-var">tagForArity</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmClosure.html#getCallMethod"><span class="hs-identifier hs-var">getCallMethod</span></a><span class="hs-special">,</span><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span>        </span><span class="hs-comment">-- * ClosureInfo</span><span>
</span><a name="line-37"></a><span>        </span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-type">ClosureInfo</span></a><span class="hs-special">,</span><span>
</span><a name="line-38"></a><span>        </span><a href="StgCmmClosure.html#mkClosureInfo"><span class="hs-identifier hs-var">mkClosureInfo</span></a><span class="hs-special">,</span><span>
</span><a name="line-39"></a><span>        </span><a href="StgCmmClosure.html#mkCmmInfo"><span class="hs-identifier hs-var">mkCmmInfo</span></a><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span>        </span><span class="hs-comment">-- ** Inspection</span><span>
</span><a name="line-42"></a><span>        </span><a href="StgCmmClosure.html#closureLFInfo"><span class="hs-identifier hs-var">closureLFInfo</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmClosure.html#closureName"><span class="hs-identifier hs-var">closureName</span></a><span class="hs-special">,</span><span>
</span><a name="line-43"></a><span>
</span><a name="line-44"></a><span>        </span><span class="hs-comment">-- ** Labels</span><span>
</span><a name="line-45"></a><span>        </span><span class="hs-comment">-- These just need the info table label</span><span>
</span><a name="line-46"></a><span>        </span><a href="StgCmmClosure.html#closureInfoLabel"><span class="hs-identifier hs-var">closureInfoLabel</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmClosure.html#staticClosureLabel"><span class="hs-identifier hs-var">staticClosureLabel</span></a><span class="hs-special">,</span><span>
</span><a name="line-47"></a><span>        </span><a href="StgCmmClosure.html#closureSlowEntryLabel"><span class="hs-identifier hs-var">closureSlowEntryLabel</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmClosure.html#closureLocalEntryLabel"><span class="hs-identifier hs-var">closureLocalEntryLabel</span></a><span class="hs-special">,</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span>        </span><span class="hs-comment">-- ** Predicates</span><span>
</span><a name="line-50"></a><span>        </span><span class="hs-comment">-- These are really just functions on LambdaFormInfo</span><span>
</span><a name="line-51"></a><span>        </span><a href="StgCmmClosure.html#closureUpdReqd"><span class="hs-identifier hs-var">closureUpdReqd</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmClosure.html#closureSingleEntry"><span class="hs-identifier hs-var">closureSingleEntry</span></a><span class="hs-special">,</span><span>
</span><a name="line-52"></a><span>        </span><a href="StgCmmClosure.html#closureReEntrant"><span class="hs-identifier hs-var">closureReEntrant</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmClosure.html#closureFunInfo"><span class="hs-identifier hs-var">closureFunInfo</span></a><span class="hs-special">,</span><span>
</span><a name="line-53"></a><span>        </span><a href="StgCmmClosure.html#isToplevClosure"><span class="hs-identifier hs-var">isToplevClosure</span></a><span class="hs-special">,</span><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span>        </span><a href="StgCmmClosure.html#blackHoleOnEntry"><span class="hs-identifier hs-var">blackHoleOnEntry</span></a><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- Needs LambdaFormInfo and SMRep</span><span>
</span><a name="line-56"></a><span>        </span><a href="StgCmmClosure.html#isStaticClosure"><span class="hs-identifier hs-var">isStaticClosure</span></a><span class="hs-special">,</span><span>   </span><span class="hs-comment">-- Needs SMPre</span><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span>        </span><span class="hs-comment">-- * InfoTables</span><span>
</span><a name="line-59"></a><span>        </span><a href="StgCmmClosure.html#mkDataConInfoTable"><span class="hs-identifier hs-var">mkDataConInfoTable</span></a><span class="hs-special">,</span><span>
</span><a name="line-60"></a><span>        </span><a href="StgCmmClosure.html#cafBlackHoleInfoTable"><span class="hs-identifier hs-var">cafBlackHoleInfoTable</span></a><span class="hs-special">,</span><span>
</span><a name="line-61"></a><span>        </span><a href="StgCmmClosure.html#indStaticInfoTable"><span class="hs-identifier hs-var">indStaticInfoTable</span></a><span class="hs-special">,</span><span>
</span><a name="line-62"></a><span>        </span><a href="StgCmmClosure.html#staticClosureNeedsLink"><span class="hs-identifier hs-var">staticClosureNeedsLink</span></a><span class="hs-special">,</span><span>
</span><a name="line-63"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span class="hs-cpp">#include &quot;../includes/MachDeps.h&quot;
</span><span>
</span><a name="line-67"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-70"></a><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><a href="StgSyn.html"><span class="hs-identifier">StgSyn</span></a><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><a href="SMRep.html"><span class="hs-identifier">SMRep</span></a><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><a href="Cmm.html"><span class="hs-identifier">Cmm</span></a><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span> </span><a href="PprCmmExpr.html"><span class="hs-identifier">PprCmmExpr</span></a><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-75"></a><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CostCentre</span><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span> </span><a href="BlockId.html"><span class="hs-identifier">BlockId</span></a><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span> </span><a href="CLabel.html"><span class="hs-identifier">CLabel</span></a><span>
</span><a name="line-79"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-80"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">IdInfo</span><span>
</span><a name="line-81"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span>
</span><a name="line-82"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-83"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-84"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCoRep</span><span>
</span><a name="line-85"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span>
</span><a name="line-86"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-87"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RepType</span><span>
</span><a name="line-88"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-89"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-90"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-91"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-92"></a><span>
</span><a name="line-93"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Coerce</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">coerce</span><span class="hs-special">)</span><span>
</span><a name="line-94"></a><span>
</span><a name="line-95"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-96"></a><span class="hs-comment">--                Data types and synonyms</span><span>
</span><a name="line-97"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-98"></a><span>
</span><a name="line-99"></a><span class="hs-comment">-- These data types are mostly used by other modules, especially StgCmmMonad,</span><span>
</span><a name="line-100"></a><span class="hs-comment">-- but we define them here because some functions in this module need to</span><span>
</span><a name="line-101"></a><span class="hs-comment">-- have access to them as well</span><span>
</span><a name="line-102"></a><span>
</span><a name="line-103"></a><span class="hs-keyword">data</span><span> </span><a name="CgLoc"><a href="StgCmmClosure.html#CgLoc"><span class="hs-identifier">CgLoc</span></a></a><span>
</span><a name="line-104"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="CmmLoc"><a href="StgCmmClosure.html#CmmLoc"><span class="hs-identifier">CmmLoc</span></a></a><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>      </span><span class="hs-comment">-- A stable CmmExpr; that is, one not mentioning</span><span>
</span><a name="line-105"></a><span>                        </span><span class="hs-comment">-- Hp, so that it remains valid across calls</span><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="LneLoc"><a href="StgCmmClosure.html#LneLoc"><span class="hs-identifier">LneLoc</span></a></a><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span class="hs-special">]</span><span>             </span><span class="hs-comment">-- A join point</span><span>
</span><a name="line-108"></a><span>        </span><span class="hs-comment">-- A join point (= let-no-escape) should only</span><span>
</span><a name="line-109"></a><span>        </span><span class="hs-comment">-- be tail-called, and in a saturated way.</span><span>
</span><a name="line-110"></a><span>        </span><span class="hs-comment">-- To tail-call it, assign to these locals,</span><span>
</span><a name="line-111"></a><span>        </span><span class="hs-comment">-- and branch to the block id</span><span>
</span><a name="line-112"></a><span>
</span><a name="line-113"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="StgCmmClosure.html#CgLoc"><span class="hs-identifier hs-type">CgLoc</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-114"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#CmmLoc"><span class="hs-identifier hs-var">CmmLoc</span></a><span> </span><a name="local-6989586621680685078"><a href="#local-6989586621680685078"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;cmm&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680685078"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-115"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#LneLoc"><span class="hs-identifier hs-var">LneLoc</span></a><span> </span><a name="local-6989586621680685079"><a href="#local-6989586621680685079"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621680685080"><a href="#local-6989586621680685080"><span class="hs-identifier">rs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;lne&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680685079"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680685080"><span class="hs-identifier hs-var">rs</span></a><span>
</span><a name="line-116"></a><span>
</span><a name="line-117"></a><span class="hs-keyword">type</span><span> </span><a name="SelfLoopInfo"><a href="StgCmmClosure.html#SelfLoopInfo"><span class="hs-identifier">SelfLoopInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-118"></a><span>
</span><a name="line-119"></a><span class="hs-comment">-- used by ticky profiling</span><span>
</span><a name="line-120"></a><span class="hs-identifier">isKnownFun</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-121"></a><a name="isKnownFun"><a href="StgCmmClosure.html#isKnownFun"><span class="hs-identifier">isKnownFun</span></a></a><span> </span><a href="StgCmmClosure.html#LFReEntrant"><span class="hs-identifier hs-var">LFReEntrant</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-122"></a><span class="hs-identifier">isKnownFun</span><span> </span><a href="StgCmmClosure.html#LFLetNoEscape"><span class="hs-identifier hs-var">LFLetNoEscape</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-123"></a><span class="hs-identifier">isKnownFun</span><span> </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a><span>
</span><a name="line-126"></a><span class="hs-comment">-------------------------------------</span><span>
</span><a name="line-127"></a><span class="hs-comment">--        Non-void types</span><span>
</span><a name="line-128"></a><span class="hs-comment">-------------------------------------</span><span>
</span><a name="line-129"></a><span class="hs-comment">-- We frequently need the invariant that an Id or a an argument</span><span>
</span><a name="line-130"></a><span class="hs-comment">-- is of a non-void type. This type is a witness to the invariant.</span><span>
</span><a name="line-131"></a><span>
</span><a name="line-132"></a><span class="hs-keyword">newtype</span><span> </span><a name="NonVoid"><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier">NonVoid</span></a></a><span> </span><a name="local-6989586621680685075"><a href="#local-6989586621680685075"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="NonVoid"><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier">NonVoid</span></a></a><span> </span><a href="#local-6989586621680685075"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-133"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span class="hs-identifier">fromNonVoid</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><a href="#local-6989586621680685081"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680685081"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-136"></a><a name="fromNonVoid"><a href="StgCmmClosure.html#fromNonVoid"><span class="hs-identifier">fromNonVoid</span></a></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-var">NonVoid</span></a><span> </span><a name="local-6989586621680685082"><a href="#local-6989586621680685082"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680685082"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621680685076"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><a href="#local-6989586621680685076"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-139"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-var">NonVoid</span></a><span> </span><a name="local-6989586621680685077"><a href="#local-6989586621680685077"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680685077"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-140"></a><span>
</span><a name="line-141"></a><span class="hs-identifier">nonVoidIds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>
</span><a name="line-142"></a><a name="nonVoidIds"><a href="StgCmmClosure.html#nonVoidIds"><span class="hs-identifier">nonVoidIds</span></a></a><span> </span><a name="local-6989586621680685083"><a href="#local-6989586621680685083"><span class="hs-identifier">ids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-var">NonVoid</span></a><span> </span><a href="#local-6989586621680685084"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621680685084"><a href="#local-6989586621680685084"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680685083"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isVoidTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621680685084"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-143"></a><span>
</span><a name="line-144"></a><span class="hs-comment">-- | Used in places where some invariant ensures that all these Ids are</span><span>
</span><a name="line-145"></a><span class="hs-comment">-- non-void; e.g. constructor field binders in case expressions.</span><span>
</span><a name="line-146"></a><span class="hs-comment">-- See Note [Post-unarisation invariants] in UnariseStg.</span><span>
</span><a name="line-147"></a><span class="hs-identifier">assertNonVoidIds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>
</span><a name="line-148"></a><a name="assertNonVoidIds"><a href="StgCmmClosure.html#assertNonVoidIds"><span class="hs-identifier">assertNonVoidIds</span></a></a><span> </span><a name="local-6989586621680685085"><a href="#local-6989586621680685085"><span class="hs-identifier">ids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">any</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isVoidTy</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">idType</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">ids</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-149"></a><span>                       </span><span class="hs-identifier hs-var">coerce</span><span> </span><a href="#local-6989586621680685085"><span class="hs-identifier hs-var">ids</span></a><span>
</span><a name="line-150"></a><span>
</span><a name="line-151"></a><span class="hs-identifier">nonVoidStgArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span class="hs-special">]</span><span>
</span><a name="line-152"></a><a name="nonVoidStgArgs"><a href="StgCmmClosure.html#nonVoidStgArgs"><span class="hs-identifier">nonVoidStgArgs</span></a></a><span> </span><a name="local-6989586621680685086"><a href="#local-6989586621680685086"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-var">NonVoid</span></a><span> </span><a href="#local-6989586621680685087"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621680685087"><a href="#local-6989586621680685087"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680685086"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isVoidTy</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#stgArgType"><span class="hs-identifier hs-var">stgArgType</span></a><span> </span><a href="#local-6989586621680685087"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-153"></a><span>
</span><a name="line-154"></a><span class="hs-comment">-- | Used in places where some invariant ensures that all these arguments are</span><span>
</span><a name="line-155"></a><span class="hs-comment">-- non-void; e.g. constructor arguments.</span><span>
</span><a name="line-156"></a><span class="hs-comment">-- See Note [Post-unarisation invariants] in UnariseStg.</span><span>
</span><a name="line-157"></a><span class="hs-identifier">assertNonVoidStgArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span class="hs-special">]</span><span>
</span><a name="line-158"></a><a name="assertNonVoidStgArgs"><a href="StgCmmClosure.html#assertNonVoidStgArgs"><span class="hs-identifier">assertNonVoidStgArgs</span></a></a><span> </span><a name="local-6989586621680685088"><a href="#local-6989586621680685088"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">any</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isVoidTy</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">stgArgType</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">args</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-159"></a><span>                            </span><span class="hs-identifier hs-var">coerce</span><span> </span><a href="#local-6989586621680685088"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-160"></a><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-163"></a><span class="hs-comment">--                Representations</span><span>
</span><a name="line-164"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-165"></a><span>
</span><a name="line-166"></a><span class="hs-comment">-- Why are these here?</span><span>
</span><a name="line-167"></a><span>
</span><a name="line-168"></a><span class="hs-identifier">idPrimRep</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PrimRep</span><span>
</span><a name="line-169"></a><a name="idPrimRep"><a href="StgCmmClosure.html#idPrimRep"><span class="hs-identifier">idPrimRep</span></a></a><span> </span><a name="local-6989586621680685089"><a href="#local-6989586621680685089"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">typePrimRep1</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621680685089"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-170"></a><span>    </span><span class="hs-comment">-- NB: typePrimRep1 fails on unboxed tuples,</span><span>
</span><a name="line-171"></a><span>    </span><span class="hs-comment">--     but by StgCmm no Ids have unboxed tuple type</span><span>
</span><a name="line-172"></a><span>
</span><a name="line-173"></a><span class="hs-identifier">addIdReps</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">PrimRep</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-174"></a><a name="addIdReps"><a href="StgCmmClosure.html#addIdReps"><span class="hs-identifier">addIdReps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680685090"><a href="#local-6989586621680685090"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680685091"><a href="#local-6989586621680685091"><span class="hs-identifier">id'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#fromNonVoid"><span class="hs-identifier hs-var">fromNonVoid</span></a><span> </span><a href="#local-6989586621680685090"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-175"></a><span>                         </span><span class="hs-keyword">in</span><span> </span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-var">NonVoid</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#idPrimRep"><span class="hs-identifier hs-var">idPrimRep</span></a><span> </span><a href="#local-6989586621680685091"><span class="hs-identifier hs-var">id'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680685091"><span class="hs-identifier hs-var">id'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-176"></a><span>
</span><a name="line-177"></a><span class="hs-identifier">addArgReps</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">PrimRep</span><span class="hs-special">,</span><span> </span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-178"></a><a name="addArgReps"><a href="StgCmmClosure.html#addArgReps"><span class="hs-identifier">addArgReps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680685092"><a href="#local-6989586621680685092"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680685093"><a href="#local-6989586621680685093"><span class="hs-identifier">arg'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#fromNonVoid"><span class="hs-identifier hs-var">fromNonVoid</span></a><span> </span><a href="#local-6989586621680685092"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-179"></a><span>                           </span><span class="hs-keyword">in</span><span> </span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-var">NonVoid</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#argPrimRep"><span class="hs-identifier hs-var">argPrimRep</span></a><span> </span><a href="#local-6989586621680685093"><span class="hs-identifier hs-var">arg'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680685093"><span class="hs-identifier hs-var">arg'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-180"></a><span>
</span><a name="line-181"></a><span class="hs-identifier">argPrimRep</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PrimRep</span><span>
</span><a name="line-182"></a><a name="argPrimRep"><a href="StgCmmClosure.html#argPrimRep"><span class="hs-identifier">argPrimRep</span></a></a><span> </span><a name="local-6989586621680685094"><a href="#local-6989586621680685094"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">typePrimRep1</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#stgArgType"><span class="hs-identifier hs-var">stgArgType</span></a><span> </span><a href="#local-6989586621680685094"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a><span>
</span><a name="line-185"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-186"></a><span class="hs-comment">--                LambdaFormInfo</span><span>
</span><a name="line-187"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-188"></a><span>
</span><a name="line-189"></a><span class="hs-comment">-- Information about an identifier, from the code generator's point of</span><span>
</span><a name="line-190"></a><span class="hs-comment">-- view.  Every identifier is bound to a LambdaFormInfo in the</span><span>
</span><a name="line-191"></a><span class="hs-comment">-- environment, which gives the code generator enough info to be able to</span><span>
</span><a name="line-192"></a><span class="hs-comment">-- tail call or return that identifier.</span><span>
</span><a name="line-193"></a><span>
</span><a name="line-194"></a><span class="hs-keyword">data</span><span> </span><a name="LambdaFormInfo"><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier">LambdaFormInfo</span></a></a><span>
</span><a name="line-195"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="LFReEntrant"><a href="StgCmmClosure.html#LFReEntrant"><span class="hs-identifier">LFReEntrant</span></a></a><span>         </span><span class="hs-comment">-- Reentrant closure (a function)</span><span>
</span><a name="line-196"></a><span>        </span><span class="hs-identifier hs-type">TopLevelFlag</span><span>    </span><span class="hs-comment">-- True if top level</span><span>
</span><a name="line-197"></a><span>        </span><span class="hs-identifier hs-type">OneShotInfo</span><span>
</span><a name="line-198"></a><span>        </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">RepArity</span><span>       </span><span class="hs-comment">-- Arity. Invariant: always &gt; 0</span><span>
</span><a name="line-199"></a><span>        </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Bool</span><span>           </span><span class="hs-comment">-- True &lt;=&gt; no fvs</span><span>
</span><a name="line-200"></a><span>        </span><a href="SMRep.html#ArgDescr"><span class="hs-identifier hs-type">ArgDescr</span></a><span>        </span><span class="hs-comment">-- Argument descriptor (should really be in ClosureInfo)</span><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="LFThunk"><a href="StgCmmClosure.html#LFThunk"><span class="hs-identifier">LFThunk</span></a></a><span>             </span><span class="hs-comment">-- Thunk (zero arity)</span><span>
</span><a name="line-203"></a><span>        </span><span class="hs-identifier hs-type">TopLevelFlag</span><span>
</span><a name="line-204"></a><span>        </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Bool</span><span>           </span><span class="hs-comment">-- True &lt;=&gt; no free vars</span><span>
</span><a name="line-205"></a><span>        </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Bool</span><span>           </span><span class="hs-comment">-- True &lt;=&gt; updatable (i.e., *not* single-entry)</span><span>
</span><a name="line-206"></a><span>        </span><a href="StgCmmClosure.html#StandardFormInfo"><span class="hs-identifier hs-type">StandardFormInfo</span></a><span>
</span><a name="line-207"></a><span>        </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Bool</span><span>           </span><span class="hs-comment">-- True &lt;=&gt; *might* be a function type</span><span>
</span><a name="line-208"></a><span>
</span><a name="line-209"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="LFCon"><a href="StgCmmClosure.html#LFCon"><span class="hs-identifier">LFCon</span></a></a><span>               </span><span class="hs-comment">-- A saturated constructor application</span><span>
</span><a name="line-210"></a><span>        </span><span class="hs-identifier hs-type">DataCon</span><span>         </span><span class="hs-comment">-- The constructor</span><span>
</span><a name="line-211"></a><span>
</span><a name="line-212"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="LFUnknown"><a href="StgCmmClosure.html#LFUnknown"><span class="hs-identifier">LFUnknown</span></a></a><span>           </span><span class="hs-comment">-- Used for function arguments and imported things.</span><span>
</span><a name="line-213"></a><span>                        </span><span class="hs-comment">-- We know nothing about this closure.</span><span>
</span><a name="line-214"></a><span>                        </span><span class="hs-comment">-- Treat like updatable &quot;LFThunk&quot;...</span><span>
</span><a name="line-215"></a><span>                        </span><span class="hs-comment">-- Imported things which we *do* know something about use</span><span>
</span><a name="line-216"></a><span>                        </span><span class="hs-comment">-- one of the other LF constructors (eg LFReEntrant for</span><span>
</span><a name="line-217"></a><span>                        </span><span class="hs-comment">-- known functions)</span><span>
</span><a name="line-218"></a><span>        </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Bool</span><span>           </span><span class="hs-comment">-- True &lt;=&gt; *might* be a function type</span><span>
</span><a name="line-219"></a><span>                        </span><span class="hs-comment">--      The False case is good when we want to enter it,</span><span>
</span><a name="line-220"></a><span>                        </span><span class="hs-comment">--        because then we know the entry code will do</span><span>
</span><a name="line-221"></a><span>                        </span><span class="hs-comment">--        For a function, the entry code is the fast entry point</span><span>
</span><a name="line-222"></a><span>
</span><a name="line-223"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="LFUnlifted"><a href="StgCmmClosure.html#LFUnlifted"><span class="hs-identifier">LFUnlifted</span></a></a><span>          </span><span class="hs-comment">-- A value of unboxed type;</span><span>
</span><a name="line-224"></a><span>                        </span><span class="hs-comment">-- always a value, needs evaluation</span><span>
</span><a name="line-225"></a><span>
</span><a name="line-226"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="LFLetNoEscape"><a href="StgCmmClosure.html#LFLetNoEscape"><span class="hs-identifier">LFLetNoEscape</span></a></a><span>       </span><span class="hs-comment">-- See LetNoEscape module for precise description</span><span>
</span><a name="line-227"></a><span>
</span><a name="line-228"></a><span>
</span><a name="line-229"></a><span class="hs-comment">-------------------------</span><span>
</span><a name="line-230"></a><span class="hs-comment">-- StandardFormInfo tells whether this thunk has one of</span><span>
</span><a name="line-231"></a><span class="hs-comment">-- a small number of standard forms</span><span>
</span><a name="line-232"></a><span>
</span><a name="line-233"></a><span class="hs-keyword">data</span><span> </span><a name="StandardFormInfo"><a href="StgCmmClosure.html#StandardFormInfo"><span class="hs-identifier">StandardFormInfo</span></a></a><span>
</span><a name="line-234"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="NonStandardThunk"><a href="StgCmmClosure.html#NonStandardThunk"><span class="hs-identifier">NonStandardThunk</span></a></a><span>
</span><a name="line-235"></a><span>        </span><span class="hs-comment">-- The usual case: not of the standard forms</span><span>
</span><a name="line-236"></a><span>
</span><a name="line-237"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="SelectorThunk"><a href="StgCmmClosure.html#SelectorThunk"><span class="hs-identifier">SelectorThunk</span></a></a><span>
</span><a name="line-238"></a><span>        </span><span class="hs-comment">-- A SelectorThunk is of form</span><span>
</span><a name="line-239"></a><span>        </span><span class="hs-comment">--      case x of</span><span>
</span><a name="line-240"></a><span>        </span><span class="hs-comment">--           con a1,..,an -&gt; ak</span><span>
</span><a name="line-241"></a><span>        </span><span class="hs-comment">-- and the constructor is from a single-constr type.</span><span>
</span><a name="line-242"></a><span>       </span><a href="SMRep.html#WordOff"><span class="hs-identifier hs-type">WordOff</span></a><span>          </span><span class="hs-comment">-- 0-origin offset of ak within the &quot;goods&quot; of</span><span>
</span><a name="line-243"></a><span>                        </span><span class="hs-comment">-- constructor (Recall that the a1,...,an may be laid</span><span>
</span><a name="line-244"></a><span>                        </span><span class="hs-comment">-- out in the heap in a non-obvious order.)</span><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="ApThunk"><a href="StgCmmClosure.html#ApThunk"><span class="hs-identifier">ApThunk</span></a></a><span>
</span><a name="line-247"></a><span>        </span><span class="hs-comment">-- An ApThunk is of form</span><span>
</span><a name="line-248"></a><span>        </span><span class="hs-comment">--        x1 ... xn</span><span>
</span><a name="line-249"></a><span>        </span><span class="hs-comment">-- The code for the thunk just pushes x2..xn on the stack and enters x1.</span><span>
</span><a name="line-250"></a><span>        </span><span class="hs-comment">-- There are a few of these (for 1 &lt;= n &lt;= MAX_SPEC_AP_SIZE) pre-compiled</span><span>
</span><a name="line-251"></a><span>        </span><span class="hs-comment">-- in the RTS to save space.</span><span>
</span><a name="line-252"></a><span>        </span><span class="hs-identifier hs-type">RepArity</span><span>                </span><span class="hs-comment">-- Arity, n</span><span>
</span><a name="line-253"></a><span>
</span><a name="line-254"></a><span>
</span><a name="line-255"></a><span class="hs-comment">------------------------------------------------------</span><span>
</span><a name="line-256"></a><span class="hs-comment">--                Building LambdaFormInfo</span><span>
</span><a name="line-257"></a><span class="hs-comment">------------------------------------------------------</span><span>
</span><a name="line-258"></a><span>
</span><a name="line-259"></a><span class="hs-identifier">mkLFArgument</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span>
</span><a name="line-260"></a><a name="mkLFArgument"><a href="StgCmmClosure.html#mkLFArgument"><span class="hs-identifier">mkLFArgument</span></a></a><span> </span><a name="local-6989586621680685095"><a href="#local-6989586621680685095"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-261"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isUnliftedType</span><span> </span><a href="#local-6989586621680685096"><span class="hs-identifier hs-var">ty</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#LFUnlifted"><span class="hs-identifier hs-var">LFUnlifted</span></a><span>
</span><a name="line-262"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="StgCmmClosure.html#might_be_a_function"><span class="hs-identifier hs-var">might_be_a_function</span></a><span> </span><a href="#local-6989586621680685096"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#LFUnknown"><span class="hs-identifier hs-var">LFUnknown</span></a><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-263"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#LFUnknown"><span class="hs-identifier hs-var">LFUnknown</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-264"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-265"></a><span>    </span><a name="local-6989586621680685096"><a href="#local-6989586621680685096"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621680685095"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-266"></a><span>
</span><a name="line-267"></a><span class="hs-comment">-------------</span><span>
</span><a name="line-268"></a><span class="hs-identifier">mkLFLetNoEscape</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span>
</span><a name="line-269"></a><a name="mkLFLetNoEscape"><a href="StgCmmClosure.html#mkLFLetNoEscape"><span class="hs-identifier">mkLFLetNoEscape</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#LFLetNoEscape"><span class="hs-identifier hs-var">LFLetNoEscape</span></a><span>
</span><a name="line-270"></a><span>
</span><a name="line-271"></a><span class="hs-comment">-------------</span><span>
</span><a name="line-272"></a><span class="hs-identifier">mkLFReEntrant</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span>    </span><span class="hs-comment">-- True of top level</span><span>
</span><a name="line-273"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>            </span><span class="hs-comment">-- Free vars</span><span>
</span><a name="line-274"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>            </span><span class="hs-comment">-- Args</span><span>
</span><a name="line-275"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ArgDescr"><span class="hs-identifier hs-type">ArgDescr</span></a><span>        </span><span class="hs-comment">-- Argument descriptor</span><span>
</span><a name="line-276"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span>
</span><a name="line-277"></a><span>
</span><a name="line-278"></a><a name="mkLFReEntrant"><a href="StgCmmClosure.html#mkLFReEntrant"><span class="hs-identifier">mkLFReEntrant</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-279"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;mkLFReEntrant&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-280"></a><span class="hs-identifier">mkLFReEntrant</span><span> </span><a name="local-6989586621680685097"><a href="#local-6989586621680685097"><span class="hs-identifier">top</span></a></a><span> </span><a name="local-6989586621680685098"><a href="#local-6989586621680685098"><span class="hs-identifier">fvs</span></a></a><span> </span><a name="local-6989586621680685099"><a href="#local-6989586621680685099"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621680685100"><a href="#local-6989586621680685100"><span class="hs-identifier">arg_descr</span></a></a><span>
</span><a name="line-281"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#LFReEntrant"><span class="hs-identifier hs-var">LFReEntrant</span></a><span> </span><a href="#local-6989586621680685097"><span class="hs-identifier hs-var">top</span></a><span> </span><a href="#local-6989586621680685101"><span class="hs-identifier hs-var">os_info</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621680685099"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621680685098"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680685100"><span class="hs-identifier hs-var">arg_descr</span></a><span>
</span><a name="line-282"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621680685101"><a href="#local-6989586621680685101"><span class="hs-identifier">os_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idOneShotInfo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621680685099"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-283"></a><span>
</span><a name="line-284"></a><span class="hs-comment">-------------</span><span>
</span><a name="line-285"></a><span class="hs-identifier">mkLFThunk</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#UpdateFlag"><span class="hs-identifier hs-type">UpdateFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span>
</span><a name="line-286"></a><a name="mkLFThunk"><a href="StgCmmClosure.html#mkLFThunk"><span class="hs-identifier">mkLFThunk</span></a></a><span> </span><a name="local-6989586621680685102"><a href="#local-6989586621680685102"><span class="hs-identifier">thunk_ty</span></a></a><span> </span><a name="local-6989586621680685103"><a href="#local-6989586621680685103"><span class="hs-identifier">top</span></a></a><span> </span><a name="local-6989586621680685104"><a href="#local-6989586621680685104"><span class="hs-identifier">fvs</span></a></a><span> </span><a name="local-6989586621680685105"><a href="#local-6989586621680685105"><span class="hs-identifier">upd_flag</span></a></a><span>
</span><a name="line-287"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isUpdatable</span><span> </span><span class="hs-identifier">upd_flag</span><span class="hs-special">)</span><span> </span><a href="StgSyn.html#isUpdatable"><span class="hs-operator hs-var">||</span></a><span> </span><span class="hs-identifier">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isUnliftedType</span><span> </span><span class="hs-identifier hs-var">thunk_ty</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-288"></a><span>    </span><a href="StgCmmClosure.html#LFThunk"><span class="hs-identifier hs-var">LFThunk</span></a><span> </span><a href="#local-6989586621680685103"><span class="hs-identifier hs-var">top</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621680685104"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-289"></a><span>            </span><span class="hs-special">(</span><a href="StgSyn.html#isUpdatable"><span class="hs-identifier hs-var">isUpdatable</span></a><span> </span><a href="#local-6989586621680685105"><span class="hs-identifier hs-var">upd_flag</span></a><span class="hs-special">)</span><span>
</span><a name="line-290"></a><span>            </span><a href="StgCmmClosure.html#NonStandardThunk"><span class="hs-identifier hs-var">NonStandardThunk</span></a><span>
</span><a name="line-291"></a><span>            </span><span class="hs-special">(</span><a href="StgCmmClosure.html#might_be_a_function"><span class="hs-identifier hs-var">might_be_a_function</span></a><span> </span><a href="#local-6989586621680685102"><span class="hs-identifier hs-var">thunk_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-292"></a><span>
</span><a name="line-293"></a><span class="hs-comment">--------------</span><span>
</span><a name="line-294"></a><span class="hs-identifier">might_be_a_function</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-295"></a><span class="hs-comment">-- Return False only if we are *sure* it's a data type</span><span>
</span><a name="line-296"></a><span class="hs-comment">-- Look through newtypes etc as much as poss</span><span>
</span><a name="line-297"></a><a name="might_be_a_function"><a href="StgCmmClosure.html#might_be_a_function"><span class="hs-identifier">might_be_a_function</span></a></a><span> </span><a name="local-6989586621680685106"><a href="#local-6989586621680685106"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-298"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">LiftedRep</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">typePrimRep</span><span> </span><a href="#local-6989586621680685106"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-299"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680685107"><a href="#local-6989586621680685107"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tyConAppTyCon_maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unwrapType</span><span> </span><a href="#local-6989586621680685106"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-300"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isDataTyCon</span><span> </span><a href="#local-6989586621680685107"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-301"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-302"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-303"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-304"></a><span>
</span><a name="line-305"></a><span class="hs-comment">-------------</span><span>
</span><a name="line-306"></a><span class="hs-identifier">mkConLFInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span>
</span><a name="line-307"></a><a name="mkConLFInfo"><a href="StgCmmClosure.html#mkConLFInfo"><span class="hs-identifier">mkConLFInfo</span></a></a><span> </span><a name="local-6989586621680685108"><a href="#local-6989586621680685108"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#LFCon"><span class="hs-identifier hs-var">LFCon</span></a><span> </span><a href="#local-6989586621680685108"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-308"></a><span>
</span><a name="line-309"></a><span class="hs-comment">-------------</span><span>
</span><a name="line-310"></a><span class="hs-identifier">mkSelectorLFInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span>
</span><a name="line-311"></a><a name="mkSelectorLFInfo"><a href="StgCmmClosure.html#mkSelectorLFInfo"><span class="hs-identifier">mkSelectorLFInfo</span></a></a><span> </span><a name="local-6989586621680685109"><a href="#local-6989586621680685109"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621680685110"><a href="#local-6989586621680685110"><span class="hs-identifier">offset</span></a></a><span> </span><a name="local-6989586621680685111"><a href="#local-6989586621680685111"><span class="hs-identifier">updatable</span></a></a><span>
</span><a name="line-312"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#LFThunk"><span class="hs-identifier hs-var">LFThunk</span></a><span> </span><span class="hs-identifier hs-var">NotTopLevel</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621680685111"><span class="hs-identifier hs-var">updatable</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#SelectorThunk"><span class="hs-identifier hs-var">SelectorThunk</span></a><span> </span><a href="#local-6989586621680685110"><span class="hs-identifier hs-var">offset</span></a><span class="hs-special">)</span><span>
</span><a name="line-313"></a><span>        </span><span class="hs-special">(</span><a href="StgCmmClosure.html#might_be_a_function"><span class="hs-identifier hs-var">might_be_a_function</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621680685109"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-314"></a><span>
</span><a name="line-315"></a><span class="hs-comment">-------------</span><span>
</span><a name="line-316"></a><span class="hs-identifier">mkApLFInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#UpdateFlag"><span class="hs-identifier hs-type">UpdateFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Arity</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span>
</span><a name="line-317"></a><a name="mkApLFInfo"><a href="StgCmmClosure.html#mkApLFInfo"><span class="hs-identifier">mkApLFInfo</span></a></a><span> </span><a name="local-6989586621680685112"><a href="#local-6989586621680685112"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621680685113"><a href="#local-6989586621680685113"><span class="hs-identifier">upd_flag</span></a></a><span> </span><a name="local-6989586621680685114"><a href="#local-6989586621680685114"><span class="hs-identifier">arity</span></a></a><span>
</span><a name="line-318"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#LFThunk"><span class="hs-identifier hs-var">LFThunk</span></a><span> </span><span class="hs-identifier hs-var">NotTopLevel</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680685114"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#isUpdatable"><span class="hs-identifier hs-var">isUpdatable</span></a><span> </span><a href="#local-6989586621680685113"><span class="hs-identifier hs-var">upd_flag</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#ApThunk"><span class="hs-identifier hs-var">ApThunk</span></a><span> </span><a href="#local-6989586621680685114"><span class="hs-identifier hs-var">arity</span></a><span class="hs-special">)</span><span>
</span><a name="line-319"></a><span>        </span><span class="hs-special">(</span><a href="StgCmmClosure.html#might_be_a_function"><span class="hs-identifier hs-var">might_be_a_function</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621680685112"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-320"></a><span>
</span><a name="line-321"></a><span class="hs-comment">-------------</span><span>
</span><a name="line-322"></a><span class="hs-identifier">mkLFImported</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span>
</span><a name="line-323"></a><a name="mkLFImported"><a href="StgCmmClosure.html#mkLFImported"><span class="hs-identifier">mkLFImported</span></a></a><span> </span><a name="local-6989586621680685115"><a href="#local-6989586621680685115"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-324"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680685117"><a href="#local-6989586621680685117"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">isDataConWorkId_maybe</span><span> </span><a href="#local-6989586621680685115"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-325"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isNullaryRepDataCon</span><span> </span><a href="#local-6989586621680685117"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-326"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#LFCon"><span class="hs-identifier hs-var">LFCon</span></a><span> </span><a href="#local-6989586621680685117"><span class="hs-identifier hs-var">con</span></a><span>   </span><span class="hs-comment">-- An imported nullary constructor</span><span>
</span><a name="line-327"></a><span>                </span><span class="hs-comment">-- We assume that the constructor is evaluated so that</span><span>
</span><a name="line-328"></a><span>                </span><span class="hs-comment">-- the id really does point directly to the constructor</span><span>
</span><a name="line-329"></a><span>
</span><a name="line-330"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680685116"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-331"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#LFReEntrant"><span class="hs-identifier hs-var">LFReEntrant</span></a><span> </span><span class="hs-identifier hs-var">TopLevel</span><span> </span><span class="hs-identifier hs-var">noOneShotInfo</span><span> </span><a href="#local-6989586621680685116"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;arg_descr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-332"></a><span>
</span><a name="line-333"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-334"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#mkLFArgument"><span class="hs-identifier hs-var">mkLFArgument</span></a><span> </span><a href="#local-6989586621680685115"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-comment">-- Not sure of exact arity</span><span>
</span><a name="line-335"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-336"></a><span>    </span><a name="local-6989586621680685116"><a href="#local-6989586621680685116"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idFunRepArity</span><span> </span><a href="#local-6989586621680685115"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-337"></a><span>
</span><a name="line-338"></a><span class="hs-comment">-------------</span><span>
</span><a name="line-339"></a><span class="hs-identifier">mkLFStringLit</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span>
</span><a name="line-340"></a><a name="mkLFStringLit"><a href="StgCmmClosure.html#mkLFStringLit"><span class="hs-identifier">mkLFStringLit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#LFUnlifted"><span class="hs-identifier hs-var">LFUnlifted</span></a><span>
</span><a name="line-341"></a><span>
</span><a name="line-342"></a><span class="hs-comment">-----------------------------------------------------</span><span>
</span><a name="line-343"></a><span class="hs-comment">--                Dynamic pointer tagging</span><span>
</span><a name="line-344"></a><span class="hs-comment">-----------------------------------------------------</span><span>
</span><a name="line-345"></a><span>
</span><a name="line-346"></a><span class="hs-keyword">type</span><span> </span><a name="DynTag"><a href="StgCmmClosure.html#DynTag"><span class="hs-identifier">DynTag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Int</span><span>       </span><span class="hs-comment">-- The tag on a *pointer*</span><span>
</span><a name="line-347"></a><span>                        </span><span class="hs-comment">-- (from the dynamic-tagging paper)</span><span>
</span><a name="line-348"></a><span>
</span><a name="line-349"></a><span class="hs-comment">-- Note [Data constructor dynamic tags]</span><span>
</span><a name="line-350"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-351"></a><span class="hs-comment">--</span><span>
</span><a name="line-352"></a><span class="hs-comment">-- The family size of a data type (the number of constructors</span><span>
</span><a name="line-353"></a><span class="hs-comment">-- or the arity of a function) can be either:</span><span>
</span><a name="line-354"></a><span class="hs-comment">--    * small, if the family size &lt; 2**tag_bits</span><span>
</span><a name="line-355"></a><span class="hs-comment">--    * big, otherwise.</span><span>
</span><a name="line-356"></a><span class="hs-comment">--</span><span>
</span><a name="line-357"></a><span class="hs-comment">-- Small families can have the constructor tag in the tag bits.</span><span>
</span><a name="line-358"></a><span class="hs-comment">-- Big families only use the tag value 1 to represent evaluatedness.</span><span>
</span><a name="line-359"></a><span class="hs-comment">-- We don't have very many tag bits: for example, we have 2 bits on</span><span>
</span><a name="line-360"></a><span class="hs-comment">-- x86-32 and 3 bits on x86-64.</span><span>
</span><a name="line-361"></a><span>
</span><a name="line-362"></a><span class="hs-identifier">isSmallFamily</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-363"></a><a name="isSmallFamily"><a href="StgCmmClosure.html#isSmallFamily"><span class="hs-identifier">isSmallFamily</span></a></a><span> </span><a name="local-6989586621680685118"><a href="#local-6989586621680685118"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680685119"><a href="#local-6989586621680685119"><span class="hs-identifier">fam_size</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680685119"><span class="hs-identifier hs-var">fam_size</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-identifier hs-var">mAX_PTR_TAG</span><span> </span><a href="#local-6989586621680685118"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-364"></a><span>
</span><a name="line-365"></a><span class="hs-identifier">tagForCon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#DynTag"><span class="hs-identifier hs-type">DynTag</span></a><span>
</span><a name="line-366"></a><a name="tagForCon"><a href="StgCmmClosure.html#tagForCon"><span class="hs-identifier">tagForCon</span></a></a><span> </span><a name="local-6989586621680685120"><a href="#local-6989586621680685120"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680685121"><a href="#local-6989586621680685121"><span class="hs-identifier">con</span></a></a><span>
</span><a name="line-367"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="StgCmmClosure.html#isSmallFamily"><span class="hs-identifier hs-var">isSmallFamily</span></a><span> </span><a href="#local-6989586621680685120"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680685123"><span class="hs-identifier hs-var">fam_size</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680685122"><span class="hs-identifier hs-var">con_tag</span></a><span>
</span><a name="line-368"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-369"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-370"></a><span>    </span><a name="local-6989586621680685122"><a href="#local-6989586621680685122"><span class="hs-identifier">con_tag</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConTag</span><span> </span><a href="#local-6989586621680685121"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-comment">-- NB: 1-indexed</span><span>
</span><a name="line-371"></a><span>    </span><a name="local-6989586621680685123"><a href="#local-6989586621680685123"><span class="hs-identifier">fam_size</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConFamilySize</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConTyCon</span><span> </span><a href="#local-6989586621680685121"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-372"></a><span>
</span><a name="line-373"></a><span class="hs-identifier">tagForArity</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RepArity</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#DynTag"><span class="hs-identifier hs-type">DynTag</span></a><span>
</span><a name="line-374"></a><a name="tagForArity"><a href="StgCmmClosure.html#tagForArity"><span class="hs-identifier">tagForArity</span></a></a><span> </span><a name="local-6989586621680685124"><a href="#local-6989586621680685124"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680685125"><a href="#local-6989586621680685125"><span class="hs-identifier">arity</span></a></a><span>
</span><a name="line-375"></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="StgCmmClosure.html#isSmallFamily"><span class="hs-identifier hs-var">isSmallFamily</span></a><span> </span><a href="#local-6989586621680685124"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680685125"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680685125"><span class="hs-identifier hs-var">arity</span></a><span>
</span><a name="line-376"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-377"></a><span>
</span><a name="line-378"></a><span class="hs-identifier">lfDynTag</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#DynTag"><span class="hs-identifier hs-type">DynTag</span></a><span>
</span><a name="line-379"></a><span class="hs-comment">-- Return the tag in the low order bits of a variable bound</span><span>
</span><a name="line-380"></a><span class="hs-comment">-- to this LambdaForm</span><span>
</span><a name="line-381"></a><a name="lfDynTag"><a href="StgCmmClosure.html#lfDynTag"><span class="hs-identifier">lfDynTag</span></a></a><span> </span><a name="local-6989586621680685126"><a href="#local-6989586621680685126"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#LFCon"><span class="hs-identifier hs-var">LFCon</span></a><span> </span><a name="local-6989586621680685127"><a href="#local-6989586621680685127"><span class="hs-identifier">con</span></a></a><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#tagForCon"><span class="hs-identifier hs-var">tagForCon</span></a><span> </span><a href="#local-6989586621680685126"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680685127"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-382"></a><span class="hs-identifier">lfDynTag</span><span> </span><a name="local-6989586621680685128"><a href="#local-6989586621680685128"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#LFReEntrant"><span class="hs-identifier hs-var">LFReEntrant</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680685129"><a href="#local-6989586621680685129"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#tagForArity"><span class="hs-identifier hs-var">tagForArity</span></a><span> </span><a href="#local-6989586621680685128"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680685129"><span class="hs-identifier hs-var">arity</span></a><span>
</span><a name="line-383"></a><span class="hs-identifier">lfDynTag</span><span> </span><span class="hs-identifier">_</span><span>      </span><a name="local-6989586621680685130"><a href="#local-6989586621680685130"><span class="hs-identifier">_other</span></a></a><span>                      </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-384"></a><span>
</span><a name="line-385"></a><span>
</span><a name="line-386"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-387"></a><span class="hs-comment">--                Observing LambdaFormInfo</span><span>
</span><a name="line-388"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-389"></a><span>
</span><a name="line-390"></a><span class="hs-comment">------------</span><span>
</span><a name="line-391"></a><span class="hs-identifier">isLFThunk</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-392"></a><a name="isLFThunk"><a href="StgCmmClosure.html#isLFThunk"><span class="hs-identifier">isLFThunk</span></a></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#LFThunk"><span class="hs-identifier hs-var">LFThunk</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-393"></a><span class="hs-identifier">isLFThunk</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-394"></a><span>
</span><a name="line-395"></a><span class="hs-identifier">isLFReEntrant</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-396"></a><a name="isLFReEntrant"><a href="StgCmmClosure.html#isLFReEntrant"><span class="hs-identifier">isLFReEntrant</span></a></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#LFReEntrant"><span class="hs-identifier hs-var">LFReEntrant</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-397"></a><span class="hs-identifier">isLFReEntrant</span><span> </span><span class="hs-identifier">_</span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-398"></a><span>
</span><a name="line-399"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-400"></a><span class="hs-comment">--                Choosing SM reps</span><span>
</span><a name="line-401"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-402"></a><span>
</span><a name="line-403"></a><span class="hs-identifier">lfClosureType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ClosureTypeInfo"><span class="hs-identifier hs-type">ClosureTypeInfo</span></a><span>
</span><a name="line-404"></a><a name="lfClosureType"><a href="StgCmmClosure.html#lfClosureType"><span class="hs-identifier">lfClosureType</span></a></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#LFReEntrant"><span class="hs-identifier hs-var">LFReEntrant</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680685131"><a href="#local-6989586621680685131"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680685132"><a href="#local-6989586621680685132"><span class="hs-identifier">argd</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SMRep.html#Fun"><span class="hs-identifier hs-var">Fun</span></a><span> </span><a href="#local-6989586621680685131"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621680685132"><span class="hs-identifier hs-var">argd</span></a><span>
</span><a name="line-405"></a><span class="hs-identifier">lfClosureType</span><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#LFCon"><span class="hs-identifier hs-var">LFCon</span></a><span> </span><a name="local-6989586621680685133"><a href="#local-6989586621680685133"><span class="hs-identifier">con</span></a></a><span class="hs-special">)</span><span>                    </span><span class="hs-glyph">=</span><span> </span><a href="SMRep.html#Constr"><span class="hs-identifier hs-var">Constr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConTagZ</span><span> </span><a href="#local-6989586621680685133"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-406"></a><span>                                                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConIdentity</span><span> </span><a href="#local-6989586621680685133"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-407"></a><span class="hs-identifier">lfClosureType</span><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#LFThunk"><span class="hs-identifier hs-var">LFThunk</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680685134"><a href="#local-6989586621680685134"><span class="hs-identifier">is_sel</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#thunkClosureType"><span class="hs-identifier hs-var">thunkClosureType</span></a><span> </span><a href="#local-6989586621680685134"><span class="hs-identifier hs-var">is_sel</span></a><span>
</span><a name="line-408"></a><span class="hs-identifier">lfClosureType</span><span> </span><span class="hs-identifier">_</span><span>                              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;lfClosureType&quot;</span><span>
</span><a name="line-409"></a><span>
</span><a name="line-410"></a><span class="hs-identifier">thunkClosureType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#StandardFormInfo"><span class="hs-identifier hs-type">StandardFormInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ClosureTypeInfo"><span class="hs-identifier hs-type">ClosureTypeInfo</span></a><span>
</span><a name="line-411"></a><a name="thunkClosureType"><a href="StgCmmClosure.html#thunkClosureType"><span class="hs-identifier">thunkClosureType</span></a></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#SelectorThunk"><span class="hs-identifier hs-var">SelectorThunk</span></a><span> </span><a name="local-6989586621680685135"><a href="#local-6989586621680685135"><span class="hs-identifier">off</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SMRep.html#ThunkSelector"><span class="hs-identifier hs-var">ThunkSelector</span></a><span> </span><a href="#local-6989586621680685135"><span class="hs-identifier hs-var">off</span></a><span>
</span><a name="line-412"></a><span class="hs-identifier">thunkClosureType</span><span> </span><span class="hs-identifier">_</span><span>                   </span><span class="hs-glyph">=</span><span> </span><a href="SMRep.html#Thunk"><span class="hs-identifier hs-var">Thunk</span></a><span>
</span><a name="line-413"></a><span>
</span><a name="line-414"></a><span class="hs-comment">-- We *do* get non-updatable top-level thunks sometimes.  eg. f = g</span><span>
</span><a name="line-415"></a><span class="hs-comment">-- gets compiled to a jump to g (if g has non-zero arity), instead of</span><span>
</span><a name="line-416"></a><span class="hs-comment">-- messing around with update frames and PAPs.  We set the closure type</span><span>
</span><a name="line-417"></a><span class="hs-comment">-- to FUN_STATIC in this case.</span><span>
</span><a name="line-418"></a><span>
</span><a name="line-419"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-420"></a><span class="hs-comment">--                nodeMustPointToIt</span><span>
</span><a name="line-421"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-422"></a><span>
</span><a name="line-423"></a><span class="hs-identifier">nodeMustPointToIt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-424"></a><span class="hs-comment">-- If nodeMustPointToIt is true, then the entry convention for</span><span>
</span><a name="line-425"></a><span class="hs-comment">-- this closure has R1 (the &quot;Node&quot; register) pointing to the</span><span>
</span><a name="line-426"></a><span class="hs-comment">-- closure itself --- the &quot;self&quot; argument</span><span>
</span><a name="line-427"></a><span>
</span><a name="line-428"></a><a name="nodeMustPointToIt"><a href="StgCmmClosure.html#nodeMustPointToIt"><span class="hs-identifier">nodeMustPointToIt</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#LFReEntrant"><span class="hs-identifier hs-var">LFReEntrant</span></a><span> </span><a name="local-6989586621680685136"><a href="#local-6989586621680685136"><span class="hs-identifier">top</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680685137"><a href="#local-6989586621680685137"><span class="hs-identifier">no_fvs</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-429"></a><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680685137"><span class="hs-identifier hs-var">no_fvs</span></a><span>          </span><span class="hs-comment">-- Certainly if it has fvs we need to point to it</span><span>
</span><a name="line-430"></a><span>  </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">isNotTopLevel</span><span> </span><a href="#local-6989586621680685136"><span class="hs-identifier hs-var">top</span></a><span>   </span><span class="hs-comment">-- See Note [GC recovery]</span><span>
</span><a name="line-431"></a><span>        </span><span class="hs-comment">-- For lex_profiling we also access the cost centre for a</span><span>
</span><a name="line-432"></a><span>        </span><span class="hs-comment">-- non-inherited (i.e. non-top-level) function.</span><span>
</span><a name="line-433"></a><span>        </span><span class="hs-comment">-- The isNotTopLevel test above ensures this is ok.</span><span>
</span><a name="line-434"></a><span>
</span><a name="line-435"></a><span class="hs-identifier">nodeMustPointToIt</span><span> </span><a name="local-6989586621680685138"><a href="#local-6989586621680685138"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#LFThunk"><span class="hs-identifier hs-var">LFThunk</span></a><span> </span><a name="local-6989586621680685139"><a href="#local-6989586621680685139"><span class="hs-identifier">top</span></a></a><span> </span><a name="local-6989586621680685140"><a href="#local-6989586621680685140"><span class="hs-identifier">no_fvs</span></a></a><span> </span><a name="local-6989586621680685141"><a href="#local-6989586621680685141"><span class="hs-identifier">updatable</span></a></a><span> </span><a href="StgCmmClosure.html#NonStandardThunk"><span class="hs-identifier hs-var">NonStandardThunk</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-436"></a><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680685140"><span class="hs-identifier hs-var">no_fvs</span></a><span>            </span><span class="hs-comment">-- Self parameter</span><span>
</span><a name="line-437"></a><span>  </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">isNotTopLevel</span><span> </span><a href="#local-6989586621680685139"><span class="hs-identifier hs-var">top</span></a><span>     </span><span class="hs-comment">-- Note [GC recovery]</span><span>
</span><a name="line-438"></a><span>  </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621680685141"><span class="hs-identifier hs-var">updatable</span></a><span>             </span><span class="hs-comment">-- Need to push update frame</span><span>
</span><a name="line-439"></a><span>  </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_SccProfilingOn</span><span> </span><a href="#local-6989586621680685138"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-440"></a><span>          </span><span class="hs-comment">-- For the non-updatable (single-entry case):</span><span>
</span><a name="line-441"></a><span>          </span><span class="hs-comment">--</span><span>
</span><a name="line-442"></a><span>          </span><span class="hs-comment">-- True if has fvs (in which case we need access to them, and we</span><span>
</span><a name="line-443"></a><span>          </span><span class="hs-comment">--                    should black-hole it)</span><span>
</span><a name="line-444"></a><span>          </span><span class="hs-comment">-- or profiling (in which case we need to recover the cost centre</span><span>
</span><a name="line-445"></a><span>          </span><span class="hs-comment">--                 from inside it)  ToDo: do we need this even for</span><span>
</span><a name="line-446"></a><span>          </span><span class="hs-comment">--                                    top-level thunks? If not,</span><span>
</span><a name="line-447"></a><span>          </span><span class="hs-comment">--                                    isNotTopLevel subsumes this</span><span>
</span><a name="line-448"></a><span>
</span><a name="line-449"></a><span class="hs-identifier">nodeMustPointToIt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#LFThunk"><span class="hs-identifier hs-var">LFThunk</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- Node must point to a standard-form thunk</span><span>
</span><a name="line-450"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-451"></a><span>
</span><a name="line-452"></a><span class="hs-identifier">nodeMustPointToIt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#LFCon"><span class="hs-identifier hs-var">LFCon</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-453"></a><span>
</span><a name="line-454"></a><span>        </span><span class="hs-comment">-- Strictly speaking, the above two don't need Node to point</span><span>
</span><a name="line-455"></a><span>        </span><span class="hs-comment">-- to it if the arity = 0.  But this is a *really* unlikely</span><span>
</span><a name="line-456"></a><span>        </span><span class="hs-comment">-- situation.  If we know it's nil (say) and we are entering</span><span>
</span><a name="line-457"></a><span>        </span><span class="hs-comment">-- it. Eg: let x = [] in x then we will certainly have inlined</span><span>
</span><a name="line-458"></a><span>        </span><span class="hs-comment">-- x, since nil is a simple atom.  So we gain little by not</span><span>
</span><a name="line-459"></a><span>        </span><span class="hs-comment">-- having Node point to known zero-arity things.  On the other</span><span>
</span><a name="line-460"></a><span>        </span><span class="hs-comment">-- hand, we do lose something; Patrick's code for figuring out</span><span>
</span><a name="line-461"></a><span>        </span><span class="hs-comment">-- when something has been updated but not entered relies on</span><span>
</span><a name="line-462"></a><span>        </span><span class="hs-comment">-- having Node point to the result of an update.  SLPJ</span><span>
</span><a name="line-463"></a><span>        </span><span class="hs-comment">-- 27/11/92.</span><span>
</span><a name="line-464"></a><span>
</span><a name="line-465"></a><span class="hs-identifier">nodeMustPointToIt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#LFUnknown"><span class="hs-identifier hs-var">LFUnknown</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-466"></a><span class="hs-identifier">nodeMustPointToIt</span><span> </span><span class="hs-identifier">_</span><span> </span><a href="StgCmmClosure.html#LFUnlifted"><span class="hs-identifier hs-var">LFUnlifted</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-467"></a><span class="hs-identifier">nodeMustPointToIt</span><span> </span><span class="hs-identifier">_</span><span> </span><a href="StgCmmClosure.html#LFLetNoEscape"><span class="hs-identifier hs-var">LFLetNoEscape</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-468"></a><span>
</span><a name="line-469"></a><span class="hs-comment">{- Note [GC recovery]
~~~~~~~~~~~~~~~~~~~~~
If we a have a local let-binding (function or thunk)
   let f = &lt;body&gt; in ...
AND &lt;body&gt; allocates, then the heap-overflow check needs to know how
to re-start the evaluation.  It uses the &quot;self&quot; pointer to do this.
So even if there are no free variables in &lt;body&gt;, we still make
nodeMustPointToIt be True for non-top-level bindings.

Why do any such bindings exist?  After all, let-floating should have
floated them out.  Well, a clever optimiser might leave one there to
avoid a space leak, deliberately recomputing a thunk.  Also (and this
really does happen occasionally) let-floating may make a function f smaller
so it can be inlined, so now (f True) may generate a local no-fv closure.
This actually happened during bootstrapping GHC itself, with f=mkRdrFunBind
in TcGenDeriv.) -}</span><span>
</span><a name="line-485"></a><span>
</span><a name="line-486"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-487"></a><span class="hs-comment">--                getCallMethod</span><span>
</span><a name="line-488"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-489"></a><span>
</span><a name="line-490"></a><span class="hs-comment">{- The entry conventions depend on the type of closure being entered,
whether or not it has free variables, and whether we're running
sequentially or in parallel.

Closure                           Node   Argument   Enter
Characteristics              Par   Req'd  Passing    Via
---------------------------------------------------------------------------
Unknown                     &amp; no  &amp; yes &amp; stack     &amp; node
Known fun (&gt;1 arg), no fvs  &amp; no  &amp; no  &amp; registers &amp; fast entry (enough args)
                                                    &amp; slow entry (otherwise)
Known fun (&gt;1 arg), fvs     &amp; no  &amp; yes &amp; registers &amp; fast entry (enough args)
0 arg, no fvs \r,\s         &amp; no  &amp; no  &amp; n/a       &amp; direct entry
0 arg, no fvs \u            &amp; no  &amp; yes &amp; n/a       &amp; node
0 arg, fvs \r,\s,selector   &amp; no  &amp; yes &amp; n/a       &amp; node
0 arg, fvs \r,\s            &amp; no  &amp; yes &amp; n/a       &amp; direct entry
0 arg, fvs \u               &amp; no  &amp; yes &amp; n/a       &amp; node
Unknown                     &amp; yes &amp; yes &amp; stack     &amp; node
Known fun (&gt;1 arg), no fvs  &amp; yes &amp; no  &amp; registers &amp; fast entry (enough args)
                                                    &amp; slow entry (otherwise)
Known fun (&gt;1 arg), fvs     &amp; yes &amp; yes &amp; registers &amp; node
0 arg, fvs \r,\s,selector   &amp; yes &amp; yes &amp; n/a       &amp; node
0 arg, no fvs \r,\s         &amp; yes &amp; no  &amp; n/a       &amp; direct entry
0 arg, no fvs \u            &amp; yes &amp; yes &amp; n/a       &amp; node
0 arg, fvs \r,\s            &amp; yes &amp; yes &amp; n/a       &amp; node
0 arg, fvs \u               &amp; yes &amp; yes &amp; n/a       &amp; node

When black-holing, single-entry closures could also be entered via node
(rather than directly) to catch double-entry. -}</span><span>
</span><a name="line-518"></a><span>
</span><a name="line-519"></a><span class="hs-keyword">data</span><span> </span><a name="CallMethod"><a href="StgCmmClosure.html#CallMethod"><span class="hs-identifier">CallMethod</span></a></a><span>
</span><a name="line-520"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="EnterIt"><a href="StgCmmClosure.html#EnterIt"><span class="hs-identifier">EnterIt</span></a></a><span>             </span><span class="hs-comment">-- No args, not a function</span><span>
</span><a name="line-521"></a><span>
</span><a name="line-522"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="JumpToIt"><a href="StgCmmClosure.html#JumpToIt"><span class="hs-identifier">JumpToIt</span></a></a><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- A join point or a header of a local loop</span><span>
</span><a name="line-523"></a><span>
</span><a name="line-524"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="ReturnIt"><a href="StgCmmClosure.html#ReturnIt"><span class="hs-identifier">ReturnIt</span></a></a><span>            </span><span class="hs-comment">-- It's a value (function, unboxed value,</span><span>
</span><a name="line-525"></a><span>                        </span><span class="hs-comment">-- or constructor), so just return it.</span><span>
</span><a name="line-526"></a><span>
</span><a name="line-527"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="SlowCall"><a href="StgCmmClosure.html#SlowCall"><span class="hs-identifier">SlowCall</span></a></a><span>                </span><span class="hs-comment">-- Unknown fun, or known fun with</span><span>
</span><a name="line-528"></a><span>                        </span><span class="hs-comment">-- too few args.</span><span>
</span><a name="line-529"></a><span>
</span><a name="line-530"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="DirectEntry"><a href="StgCmmClosure.html#DirectEntry"><span class="hs-identifier">DirectEntry</span></a></a><span>         </span><span class="hs-comment">-- Jump directly, with args in regs</span><span>
</span><a name="line-531"></a><span>        </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span>          </span><span class="hs-comment">--   The code label</span><span>
</span><a name="line-532"></a><span>        </span><span class="hs-identifier hs-type">RepArity</span><span>        </span><span class="hs-comment">--   Its arity</span><span>
</span><a name="line-533"></a><span>
</span><a name="line-534"></a><span class="hs-identifier">getCallMethod</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-535"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>           </span><span class="hs-comment">-- Function being applied</span><span>
</span><a name="line-536"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span>             </span><span class="hs-comment">-- Function Id used to chech if it can refer to</span><span>
</span><a name="line-537"></a><span>                                </span><span class="hs-comment">-- CAF's and whether the function is tail-calling</span><span>
</span><a name="line-538"></a><span>                                </span><span class="hs-comment">-- itself</span><span>
</span><a name="line-539"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span> </span><span class="hs-comment">-- Its info</span><span>
</span><a name="line-540"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RepArity</span><span>       </span><span class="hs-comment">-- Number of available arguments</span><span>
</span><a name="line-541"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RepArity</span><span>       </span><span class="hs-comment">-- Number of them being void arguments</span><span>
</span><a name="line-542"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#CgLoc"><span class="hs-identifier hs-type">CgLoc</span></a><span>          </span><span class="hs-comment">-- Passed in from cgIdApp so that we can</span><span>
</span><a name="line-543"></a><span>                                </span><span class="hs-comment">-- handle let-no-escape bindings and self-recursive</span><span>
</span><a name="line-544"></a><span>                                </span><span class="hs-comment">-- tail calls using the same data constructor,</span><span>
</span><a name="line-545"></a><span>                                </span><span class="hs-comment">-- JumpToIt. This saves us one case branch in</span><span>
</span><a name="line-546"></a><span>                                </span><span class="hs-comment">-- cgIdApp</span><span>
</span><a name="line-547"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="StgCmmClosure.html#SelfLoopInfo"><span class="hs-identifier hs-type">SelfLoopInfo</span></a><span> </span><span class="hs-comment">-- can we perform a self-recursive tail call?</span><span>
</span><a name="line-548"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#CallMethod"><span class="hs-identifier hs-type">CallMethod</span></a><span>
</span><a name="line-549"></a><span>
</span><a name="line-550"></a><a name="getCallMethod"><a href="StgCmmClosure.html#getCallMethod"><span class="hs-identifier">getCallMethod</span></a></a><span> </span><a name="local-6989586621680685142"><a href="#local-6989586621680685142"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680685143"><a href="#local-6989586621680685143"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680685144"><a href="#local-6989586621680685144"><span class="hs-identifier">n_args</span></a></a><span> </span><a name="local-6989586621680685145"><a href="#local-6989586621680685145"><span class="hs-identifier">v_args</span></a></a><span> </span><a name="local-6989586621680685146"><a href="#local-6989586621680685146"><span class="hs-identifier">_cg_loc</span></a></a><span>
</span><a name="line-551"></a><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680685147"><a href="#local-6989586621680685147"><span class="hs-identifier">self_loop_id</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680685148"><a href="#local-6989586621680685148"><span class="hs-identifier">block_id</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680685149"><a href="#local-6989586621680685149"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-552"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_Loopification</span><span> </span><a href="#local-6989586621680685142"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-553"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680685143"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680685147"><span class="hs-identifier hs-var">self_loop_id</span></a><span>
</span><a name="line-554"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680685149"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">lengthIs</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680685144"><span class="hs-identifier hs-var">n_args</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621680685145"><span class="hs-identifier hs-var">v_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-555"></a><span>  </span><span class="hs-comment">-- If these patterns match then we know that:</span><span>
</span><a name="line-556"></a><span>  </span><span class="hs-comment">--   * loopification optimisation is turned on</span><span>
</span><a name="line-557"></a><span>  </span><span class="hs-comment">--   * function is performing a self-recursive call in a tail position</span><span>
</span><a name="line-558"></a><span>  </span><span class="hs-comment">--   * number of non-void parameters of the function matches functions arity.</span><span>
</span><a name="line-559"></a><span>  </span><span class="hs-comment">-- See Note [Self-recursive tail calls] and Note [Void arguments in</span><span>
</span><a name="line-560"></a><span>  </span><span class="hs-comment">-- self-recursive tail calls] in StgCmmExpr for more details</span><span>
</span><a name="line-561"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#JumpToIt"><span class="hs-identifier hs-var">JumpToIt</span></a><span> </span><a href="#local-6989586621680685148"><span class="hs-identifier hs-var">block_id</span></a><span> </span><a href="#local-6989586621680685149"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-562"></a><span>
</span><a name="line-563"></a><span class="hs-identifier">getCallMethod</span><span> </span><a name="local-6989586621680685150"><a href="#local-6989586621680685150"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680685151"><a href="#local-6989586621680685151"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621680685152"><a href="#local-6989586621680685152"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#LFReEntrant"><span class="hs-identifier hs-var">LFReEntrant</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680685153"><a href="#local-6989586621680685153"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680685154"><a href="#local-6989586621680685154"><span class="hs-identifier">n_args</span></a></a><span> </span><a name="local-6989586621680685155"><a href="#local-6989586621680685155"><span class="hs-identifier">_v_args</span></a></a><span> </span><a name="local-6989586621680685156"><a href="#local-6989586621680685156"><span class="hs-identifier">_cg_loc</span></a></a><span>
</span><a name="line-564"></a><span>              </span><a name="local-6989586621680685157"><a href="#local-6989586621680685157"><span class="hs-identifier">_self_loop_info</span></a></a><span>
</span><a name="line-565"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680685154"><span class="hs-identifier hs-var">n_args</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-comment">-- No args at all</span><span>
</span><a name="line-566"></a><span>  </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_SccProfilingOn</span><span> </span><a href="#local-6989586621680685150"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-567"></a><span>     </span><span class="hs-comment">-- See Note [Evaluating functions with profiling] in rts/Apply.cmm</span><span>
</span><a name="line-568"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">arity</span><span> </span><span class="hs-operator">/=</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ReturnIt</span><span>
</span><a name="line-569"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680685154"><span class="hs-identifier hs-var">n_args</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621680685153"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#SlowCall"><span class="hs-identifier hs-var">SlowCall</span></a><span>        </span><span class="hs-comment">-- Not enough args</span><span>
</span><a name="line-570"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#DirectEntry"><span class="hs-identifier hs-var">DirectEntry</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#enterIdLabel"><span class="hs-identifier hs-var">enterIdLabel</span></a><span> </span><a href="#local-6989586621680685150"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680685151"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idCafInfo</span><span> </span><a href="#local-6989586621680685152"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680685153"><span class="hs-identifier hs-var">arity</span></a><span>
</span><a name="line-571"></a><span>
</span><a name="line-572"></a><span class="hs-identifier">getCallMethod</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680685158"><a href="#local-6989586621680685158"><span class="hs-identifier">_name</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a href="StgCmmClosure.html#LFUnlifted"><span class="hs-identifier hs-var">LFUnlifted</span></a><span> </span><a name="local-6989586621680685159"><a href="#local-6989586621680685159"><span class="hs-identifier">n_args</span></a></a><span> </span><a name="local-6989586621680685160"><a href="#local-6989586621680685160"><span class="hs-identifier">_v_args</span></a></a><span> </span><a name="local-6989586621680685161"><a href="#local-6989586621680685161"><span class="hs-identifier">_cg_loc</span></a></a><span> </span><a name="local-6989586621680685162"><a href="#local-6989586621680685162"><span class="hs-identifier">_self_loop_info</span></a></a><span>
</span><a name="line-573"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">n_args</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ReturnIt</span><span>
</span><a name="line-574"></a><span>
</span><a name="line-575"></a><span class="hs-identifier">getCallMethod</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680685163"><a href="#local-6989586621680685163"><span class="hs-identifier">_name</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#LFCon"><span class="hs-identifier hs-var">LFCon</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680685164"><a href="#local-6989586621680685164"><span class="hs-identifier">n_args</span></a></a><span> </span><a name="local-6989586621680685165"><a href="#local-6989586621680685165"><span class="hs-identifier">_v_args</span></a></a><span> </span><a name="local-6989586621680685166"><a href="#local-6989586621680685166"><span class="hs-identifier">_cg_loc</span></a></a><span> </span><a name="local-6989586621680685167"><a href="#local-6989586621680685167"><span class="hs-identifier">_self_loop_info</span></a></a><span>
</span><a name="line-576"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">n_args</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ReturnIt</span><span>
</span><a name="line-577"></a><span>    </span><span class="hs-comment">-- n_args=0 because it'd be ill-typed to apply a saturated</span><span>
</span><a name="line-578"></a><span>    </span><span class="hs-comment">--          constructor application to anything</span><span>
</span><a name="line-579"></a><span>
</span><a name="line-580"></a><span class="hs-identifier">getCallMethod</span><span> </span><a name="local-6989586621680685168"><a href="#local-6989586621680685168"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680685169"><a href="#local-6989586621680685169"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621680685170"><a href="#local-6989586621680685170"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#LFThunk"><span class="hs-identifier hs-var">LFThunk</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680685171"><a href="#local-6989586621680685171"><span class="hs-identifier">updatable</span></a></a><span> </span><a name="local-6989586621680685172"><a href="#local-6989586621680685172"><span class="hs-identifier">std_form_info</span></a></a><span> </span><a name="local-6989586621680685173"><a href="#local-6989586621680685173"><span class="hs-identifier">is_fun</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-581"></a><span>              </span><a name="local-6989586621680685174"><a href="#local-6989586621680685174"><span class="hs-identifier">n_args</span></a></a><span> </span><a name="local-6989586621680685175"><a href="#local-6989586621680685175"><span class="hs-identifier">_v_args</span></a></a><span> </span><a name="local-6989586621680685176"><a href="#local-6989586621680685176"><span class="hs-identifier">_cg_loc</span></a></a><span> </span><a name="local-6989586621680685177"><a href="#local-6989586621680685177"><span class="hs-identifier">_self_loop_info</span></a></a><span>
</span><a name="line-582"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680685173"><span class="hs-identifier hs-var">is_fun</span></a><span>      </span><span class="hs-comment">-- it *might* be a function, so we must &quot;call&quot; it (which is always safe)</span><span>
</span><a name="line-583"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#SlowCall"><span class="hs-identifier hs-var">SlowCall</span></a><span>    </span><span class="hs-comment">-- We cannot just enter it [in eval/apply, the entry code</span><span>
</span><a name="line-584"></a><span>                </span><span class="hs-comment">-- is the fast-entry code]</span><span>
</span><a name="line-585"></a><span>
</span><a name="line-586"></a><span>  </span><span class="hs-comment">-- Since is_fun is False, we are *definitely* looking at a data value</span><span>
</span><a name="line-587"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680685171"><span class="hs-identifier hs-var">updatable</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_Ticky</span><span> </span><a href="#local-6989586621680685168"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-comment">-- to catch double entry</span><span>
</span><a name="line-588"></a><span>      </span><span class="hs-comment">{- OLD: || opt_SMP
         I decided to remove this, because in SMP mode it doesn't matter
         if we enter the same thunk multiple times, so the optimisation
         of jumping directly to the entry code is still valid.  --SDM
        -}</span><span>
</span><a name="line-593"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#EnterIt"><span class="hs-identifier hs-var">EnterIt</span></a><span>
</span><a name="line-594"></a><span>
</span><a name="line-595"></a><span>  </span><span class="hs-comment">-- even a non-updatable selector thunk can be updated by the garbage</span><span>
</span><a name="line-596"></a><span>  </span><span class="hs-comment">-- collector, so we must enter it. (#8817)</span><span>
</span><a name="line-597"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="StgCmmClosure.html#SelectorThunk"><span class="hs-identifier hs-var">SelectorThunk</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680685172"><span class="hs-identifier hs-var">std_form_info</span></a><span>
</span><a name="line-598"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#EnterIt"><span class="hs-identifier hs-var">EnterIt</span></a><span>
</span><a name="line-599"></a><span>
</span><a name="line-600"></a><span>    </span><span class="hs-comment">-- We used to have ASSERT( n_args == 0 ), but actually it is</span><span>
</span><a name="line-601"></a><span>    </span><span class="hs-comment">-- possible for the optimiser to generate</span><span>
</span><a name="line-602"></a><span>    </span><span class="hs-comment">--   let bot :: Int = error Int &quot;urk&quot;</span><span>
</span><a name="line-603"></a><span>    </span><span class="hs-comment">--   in (bot `cast` unsafeCoerce Int (Int -&gt; Int)) 3</span><span>
</span><a name="line-604"></a><span>    </span><span class="hs-comment">-- This happens as a result of the case-of-error transformation</span><span>
</span><a name="line-605"></a><span>    </span><span class="hs-comment">-- So the right thing to do is just to enter the thing</span><span>
</span><a name="line-606"></a><span>
</span><a name="line-607"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>        </span><span class="hs-comment">-- Jump direct to code for single-entry thunks</span><span>
</span><a name="line-608"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">n_args</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-609"></a><span>    </span><a href="StgCmmClosure.html#DirectEntry"><span class="hs-identifier hs-var">DirectEntry</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#thunkEntryLabel"><span class="hs-identifier hs-var">thunkEntryLabel</span></a><span> </span><a href="#local-6989586621680685168"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680685169"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idCafInfo</span><span> </span><a href="#local-6989586621680685170"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680685172"><span class="hs-identifier hs-var">std_form_info</span></a><span>
</span><a name="line-610"></a><span>                </span><a href="#local-6989586621680685171"><span class="hs-identifier hs-var">updatable</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-611"></a><span>
</span><a name="line-612"></a><span class="hs-identifier">getCallMethod</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680685178"><a href="#local-6989586621680685178"><span class="hs-identifier">_name</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#LFUnknown"><span class="hs-identifier hs-var">LFUnknown</span></a><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680685179"><a href="#local-6989586621680685179"><span class="hs-identifier">_n_arg</span></a></a><span> </span><a name="local-6989586621680685180"><a href="#local-6989586621680685180"><span class="hs-identifier">_v_args</span></a></a><span> </span><a name="local-6989586621680685181"><a href="#local-6989586621680685181"><span class="hs-identifier">_cg_locs</span></a></a><span> </span><a name="local-6989586621680685182"><a href="#local-6989586621680685182"><span class="hs-identifier">_self_loop_info</span></a></a><span>
</span><a name="line-613"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#SlowCall"><span class="hs-identifier hs-var">SlowCall</span></a><span> </span><span class="hs-comment">-- might be a function</span><span>
</span><a name="line-614"></a><span>
</span><a name="line-615"></a><span class="hs-identifier">getCallMethod</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680685183"><a href="#local-6989586621680685183"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#LFUnknown"><span class="hs-identifier hs-var">LFUnknown</span></a><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680685184"><a href="#local-6989586621680685184"><span class="hs-identifier">n_args</span></a></a><span> </span><a name="local-6989586621680685185"><a href="#local-6989586621680685185"><span class="hs-identifier">_v_args</span></a></a><span> </span><a name="local-6989586621680685186"><a href="#local-6989586621680685186"><span class="hs-identifier">_cg_loc</span></a></a><span> </span><a name="local-6989586621680685187"><a href="#local-6989586621680685187"><span class="hs-identifier">_self_loop_info</span></a></a><span>
</span><a name="line-616"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">n_args</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680685184"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-identifier">name</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">n_args</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-617"></a><span>    </span><a href="StgCmmClosure.html#EnterIt"><span class="hs-identifier hs-var">EnterIt</span></a><span> </span><span class="hs-comment">-- Not a function</span><span>
</span><a name="line-618"></a><span>
</span><a name="line-619"></a><span class="hs-identifier">getCallMethod</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680685188"><a href="#local-6989586621680685188"><span class="hs-identifier">_name</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a href="StgCmmClosure.html#LFLetNoEscape"><span class="hs-identifier hs-var">LFLetNoEscape</span></a><span> </span><a name="local-6989586621680685189"><a href="#local-6989586621680685189"><span class="hs-identifier">_n_args</span></a></a><span> </span><a name="local-6989586621680685190"><a href="#local-6989586621680685190"><span class="hs-identifier">_v_args</span></a></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#LneLoc"><span class="hs-identifier hs-var">LneLoc</span></a><span> </span><a name="local-6989586621680685191"><a href="#local-6989586621680685191"><span class="hs-identifier">blk_id</span></a></a><span> </span><a name="local-6989586621680685192"><a href="#local-6989586621680685192"><span class="hs-identifier">lne_regs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-620"></a><span>              </span><a name="local-6989586621680685193"><a href="#local-6989586621680685193"><span class="hs-identifier">_self_loop_info</span></a></a><span>
</span><a name="line-621"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#JumpToIt"><span class="hs-identifier hs-var">JumpToIt</span></a><span> </span><a href="#local-6989586621680685191"><span class="hs-identifier hs-var">blk_id</span></a><span> </span><a href="#local-6989586621680685192"><span class="hs-identifier hs-var">lne_regs</span></a><span>
</span><a name="line-622"></a><span>
</span><a name="line-623"></a><span class="hs-identifier">getCallMethod</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;Unknown call method&quot;</span><span>
</span><a name="line-624"></a><span>
</span><a name="line-625"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-626"></a><span class="hs-comment">--              Data types for closure information</span><span>
</span><a name="line-627"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-628"></a><span>
</span><a name="line-629"></a><span>
</span><a name="line-630"></a><span class="hs-comment">{- ClosureInfo: information about a binding

   We make a ClosureInfo for each let binding (both top level and not),
   but not bindings for data constructors: for those we build a CmmInfoTable
   directly (see mkDataConInfoTable).

   To a first approximation:
       ClosureInfo = (LambdaFormInfo, CmmInfoTable)

   A ClosureInfo has enough information
     a) to construct the info table itself, and build other things
        related to the binding (e.g. slow entry points for a function)
     b) to allocate a closure containing that info pointer (i.e.
           it knows the info table label)
-}</span><span>
</span><a name="line-645"></a><span>
</span><a name="line-646"></a><span class="hs-keyword">data</span><span> </span><a name="ClosureInfo"><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier">ClosureInfo</span></a></a><span>
</span><a name="line-647"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="ClosureInfo"><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier">ClosureInfo</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-648"></a><span>        </span><a name="closureName"><a href="StgCmmClosure.html#closureName"><span class="hs-identifier">closureName</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span>           </span><span class="hs-comment">-- The thing bound to this closure</span><span>
</span><a name="line-649"></a><span>           </span><span class="hs-comment">-- we don't really need this field: it's only used in generating</span><span>
</span><a name="line-650"></a><span>           </span><span class="hs-comment">-- code for ticky and profiling, and we could pass the information</span><span>
</span><a name="line-651"></a><span>           </span><span class="hs-comment">-- around separately, but it doesn't do much harm to keep it here.</span><span>
</span><a name="line-652"></a><span>
</span><a name="line-653"></a><span>        </span><a name="closureLFInfo"><a href="StgCmmClosure.html#closureLFInfo"><span class="hs-identifier">closureLFInfo</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span class="hs-special">,</span><span> </span><span class="hs-comment">-- NOTE: not an LFCon</span><span>
</span><a name="line-654"></a><span>          </span><span class="hs-comment">-- this tells us about what the closure contains: it's right-hand-side.</span><span>
</span><a name="line-655"></a><span>
</span><a name="line-656"></a><span>          </span><span class="hs-comment">-- the rest is just an unpacked CmmInfoTable.</span><span>
</span><a name="line-657"></a><span>        </span><a name="closureInfoLabel"><a href="StgCmmClosure.html#closureInfoLabel"><span class="hs-identifier">closureInfoLabel</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span class="hs-special">,</span><span>
</span><a name="line-658"></a><span>        </span><a name="closureSMRep"><a href="StgCmmClosure.html#closureSMRep"><span class="hs-identifier">closureSMRep</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="SMRep.html#SMRep"><span class="hs-identifier hs-type">SMRep</span></a><span class="hs-special">,</span><span>          </span><span class="hs-comment">-- representation used by storage mgr</span><span>
</span><a name="line-659"></a><span>        </span><a name="closureProf"><a href="StgCmmClosure.html#closureProf"><span class="hs-identifier">closureProf</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Cmm.html#ProfilingInfo"><span class="hs-identifier hs-type">ProfilingInfo</span></a><span>
</span><a name="line-660"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-661"></a><span>
</span><a name="line-662"></a><span class="hs-comment">-- | Convert from 'ClosureInfo' to 'CmmInfoTable'.</span><span>
</span><a name="line-663"></a><span class="hs-identifier">mkCmmInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-type">ClosureInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CostCentreStack</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#CmmInfoTable"><span class="hs-identifier hs-type">CmmInfoTable</span></a><span>
</span><a name="line-664"></a><a name="mkCmmInfo"><a href="StgCmmClosure.html#mkCmmInfo"><span class="hs-identifier">mkCmmInfo</span></a></a><span> </span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-var">ClosureInfo</span></a><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><a name="local-6989586621680685199"><a href="#local-6989586621680685199"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621680685200"><a href="#local-6989586621680685200"><span class="hs-identifier">ccs</span></a></a><span>
</span><a name="line-665"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#CmmInfoTable"><span class="hs-identifier hs-var">CmmInfoTable</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cit_lbl</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680685196"><span class="hs-identifier hs-var">closureInfoLabel</span></a><span>
</span><a name="line-666"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cit_rep</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680685197"><span class="hs-identifier hs-var">closureSMRep</span></a><span>
</span><a name="line-667"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cit_prof</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680685198"><span class="hs-identifier hs-var">closureProf</span></a><span>
</span><a name="line-668"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cit_srt</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-669"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cit_clo</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="SMRep.html#isStaticRep"><span class="hs-identifier hs-var">isStaticRep</span></a><span> </span><a href="#local-6989586621680685197"><span class="hs-identifier hs-var">closureSMRep</span></a><span>
</span><a name="line-670"></a><span>                                </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680685199"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">,</span><a href="#local-6989586621680685200"><span class="hs-identifier hs-var">ccs</span></a><span class="hs-special">)</span><span>
</span><a name="line-671"></a><span>                                </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-672"></a><span>
</span><a name="line-673"></a><span class="hs-comment">--------------------------------------</span><span>
</span><a name="line-674"></a><span class="hs-comment">--        Building ClosureInfos</span><span>
</span><a name="line-675"></a><span class="hs-comment">--------------------------------------</span><span>
</span><a name="line-676"></a><span>
</span><a name="line-677"></a><span class="hs-identifier">mkClosureInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-678"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>                </span><span class="hs-comment">-- Is static</span><span>
</span><a name="line-679"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-680"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span>
</span><a name="line-681"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>        </span><span class="hs-comment">-- Total and pointer words</span><span>
</span><a name="line-682"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>         </span><span class="hs-comment">-- String descriptor</span><span>
</span><a name="line-683"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-type">ClosureInfo</span></a><span>
</span><a name="line-684"></a><a name="mkClosureInfo"><a href="StgCmmClosure.html#mkClosureInfo"><span class="hs-identifier">mkClosureInfo</span></a></a><span> </span><a name="local-6989586621680685201"><a href="#local-6989586621680685201"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680685202"><a href="#local-6989586621680685202"><span class="hs-identifier">is_static</span></a></a><span> </span><a name="local-6989586621680685203"><a href="#local-6989586621680685203"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621680685204"><a href="#local-6989586621680685204"><span class="hs-identifier">lf_info</span></a></a><span> </span><a name="local-6989586621680685205"><a href="#local-6989586621680685205"><span class="hs-identifier">tot_wds</span></a></a><span> </span><a name="local-6989586621680685206"><a href="#local-6989586621680685206"><span class="hs-identifier">ptr_wds</span></a></a><span> </span><a name="local-6989586621680685207"><a href="#local-6989586621680685207"><span class="hs-identifier">val_descr</span></a></a><span>
</span><a name="line-685"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-var">ClosureInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">closureName</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680685208"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-686"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">closureLFInfo</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680685204"><span class="hs-identifier hs-var">lf_info</span></a><span>
</span><a name="line-687"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">closureInfoLabel</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680685212"><span class="hs-identifier hs-var">info_lbl</span></a><span>   </span><span class="hs-comment">-- These three fields are</span><span>
</span><a name="line-688"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">closureSMRep</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680685209"><span class="hs-identifier hs-var">sm_rep</span></a><span>     </span><span class="hs-comment">-- (almost) an info table</span><span>
</span><a name="line-689"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">closureProf</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680685210"><span class="hs-identifier hs-var">prof</span></a><span> </span><span class="hs-special">}</span><span>     </span><span class="hs-comment">-- (we don't have an SRT yet)</span><span>
</span><a name="line-690"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-691"></a><span>    </span><a name="local-6989586621680685208"><a href="#local-6989586621680685208"><span class="hs-identifier">name</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621680685203"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-692"></a><span>    </span><a name="local-6989586621680685209"><a href="#local-6989586621680685209"><span class="hs-identifier">sm_rep</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="SMRep.html#mkHeapRep"><span class="hs-identifier hs-var">mkHeapRep</span></a><span> </span><a href="#local-6989586621680685201"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680685202"><span class="hs-identifier hs-var">is_static</span></a><span> </span><a href="#local-6989586621680685206"><span class="hs-identifier hs-var">ptr_wds</span></a><span> </span><a href="#local-6989586621680685211"><span class="hs-identifier hs-var">nonptr_wds</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#lfClosureType"><span class="hs-identifier hs-var">lfClosureType</span></a><span> </span><a href="#local-6989586621680685204"><span class="hs-identifier hs-var">lf_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-693"></a><span>    </span><a name="local-6989586621680685210"><a href="#local-6989586621680685210"><span class="hs-identifier">prof</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#mkProfilingInfo"><span class="hs-identifier hs-var">mkProfilingInfo</span></a><span> </span><a href="#local-6989586621680685201"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680685203"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621680685207"><span class="hs-identifier hs-var">val_descr</span></a><span>
</span><a name="line-694"></a><span>    </span><a name="local-6989586621680685211"><a href="#local-6989586621680685211"><span class="hs-identifier">nonptr_wds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680685205"><span class="hs-identifier hs-var">tot_wds</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621680685206"><span class="hs-identifier hs-var">ptr_wds</span></a><span>
</span><a name="line-695"></a><span>
</span><a name="line-696"></a><span>    </span><a name="local-6989586621680685212"><a href="#local-6989586621680685212"><span class="hs-identifier">info_lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#mkClosureInfoTableLabel"><span class="hs-identifier hs-var">mkClosureInfoTableLabel</span></a><span> </span><a href="#local-6989586621680685203"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621680685204"><span class="hs-identifier hs-var">lf_info</span></a><span>
</span><a name="line-697"></a><span>
</span><a name="line-698"></a><span class="hs-comment">--------------------------------------</span><span>
</span><a name="line-699"></a><span class="hs-comment">--   Other functions over ClosureInfo</span><span>
</span><a name="line-700"></a><span class="hs-comment">--------------------------------------</span><span>
</span><a name="line-701"></a><span>
</span><a name="line-702"></a><span class="hs-comment">-- Eager blackholing is normally disabled, but can be turned on with</span><span>
</span><a name="line-703"></a><span class="hs-comment">-- -feager-blackholing.  When it is on, we replace the info pointer of</span><span>
</span><a name="line-704"></a><span class="hs-comment">-- the thunk with stg_EAGER_BLACKHOLE_info on entry.</span><span>
</span><a name="line-705"></a><span>
</span><a name="line-706"></a><span class="hs-comment">-- If we wanted to do eager blackholing with slop filling,</span><span>
</span><a name="line-707"></a><span class="hs-comment">-- we'd need to do it at the *end* of a basic block, otherwise</span><span>
</span><a name="line-708"></a><span class="hs-comment">-- we overwrite the free variables in the thunk that we still</span><span>
</span><a name="line-709"></a><span class="hs-comment">-- need.  We have a patch for this from Andy Cheadle, but not</span><span>
</span><a name="line-710"></a><span class="hs-comment">-- incorporated yet. --SDM [6/2004]</span><span>
</span><a name="line-711"></a><span class="hs-comment">--</span><span>
</span><a name="line-712"></a><span class="hs-comment">-- Previously, eager blackholing was enabled when ticky-ticky</span><span>
</span><a name="line-713"></a><span class="hs-comment">-- was on. But it didn't work, and it wasn't strictly necessary</span><span>
</span><a name="line-714"></a><span class="hs-comment">-- to bring back minimal ticky-ticky, so now EAGER_BLACKHOLING</span><span>
</span><a name="line-715"></a><span class="hs-comment">-- is unconditionally disabled. -- krc 1/2007</span><span>
</span><a name="line-716"></a><span class="hs-comment">--</span><span>
</span><a name="line-717"></a><span class="hs-comment">-- Static closures are never themselves black-holed.</span><span>
</span><a name="line-718"></a><span>
</span><a name="line-719"></a><span class="hs-identifier">blackHoleOnEntry</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-type">ClosureInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-720"></a><a name="blackHoleOnEntry"><a href="StgCmmClosure.html#blackHoleOnEntry"><span class="hs-identifier">blackHoleOnEntry</span></a></a><span> </span><a name="local-6989586621680685213"><a href="#local-6989586621680685213"><span class="hs-identifier">cl_info</span></a></a><span>
</span><a name="line-721"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="SMRep.html#isStaticRep"><span class="hs-identifier hs-var">isStaticRep</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">closureSMRep</span><span> </span><a href="#local-6989586621680685213"><span class="hs-identifier hs-var">cl_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-722"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>        </span><span class="hs-comment">-- Never black-hole a static closure</span><span>
</span><a name="line-723"></a><span>
</span><a name="line-724"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-725"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">closureLFInfo</span><span> </span><a href="#local-6989586621680685213"><span class="hs-identifier hs-var">cl_info</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-726"></a><span>      </span><a href="StgCmmClosure.html#LFReEntrant"><span class="hs-identifier hs-var">LFReEntrant</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-727"></a><span>      </span><a href="StgCmmClosure.html#LFLetNoEscape"><span class="hs-identifier hs-var">LFLetNoEscape</span></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-728"></a><span>      </span><a href="StgCmmClosure.html#LFThunk"><span class="hs-identifier hs-var">LFThunk</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680685214"><a href="#local-6989586621680685214"><span class="hs-identifier">_no_fvs</span></a></a><span> </span><a name="local-6989586621680685215"><a href="#local-6989586621680685215"><span class="hs-identifier">upd</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680685215"><span class="hs-identifier hs-var">upd</span></a><span>   </span><span class="hs-comment">-- See Note [Black-holing non-updatable thunks]</span><span>
</span><a name="line-729"></a><span>      </span><a name="local-6989586621680685216"><a href="#local-6989586621680685216"><span class="hs-identifier">_other</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;blackHoleOnEntry&quot;</span><span>
</span><a name="line-730"></a><span>
</span><a name="line-731"></a><span class="hs-comment">{- Note [Black-holing non-updatable thunks]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We must not black-hole non-updatable (single-entry) thunks otherwise
we run into issues like Trac #10414. Specifically:

  * There is no reason to black-hole a non-updatable thunk: it should
    not be competed for by multiple threads

  * It could, conceivably, cause a space leak if we don't black-hole
    it, if there was a live but never-followed pointer pointing to it.
    Let's hope that doesn't happen.

  * It is dangerous to black-hole a non-updatable thunk because
     - is not updated (of course)
     - hence, if it is black-holed and another thread tries to evaluate
       it, that thread will block forever
    This actually happened in Trac #10414.  So we do not black-hole
    non-updatable thunks.

  * How could two threads evaluate the same non-updatable (single-entry)
    thunk?  See Reid Barton's example below.

  * Only eager blackholing could possibly black-hole a non-updatable
    thunk, because lazy black-holing only affects thunks with an
    update frame on the stack.

Here is and example due to Reid Barton (Trac #10414):
    x = \u []  concat [[1], []]
with the following definitions,

    concat x = case x of
        []       -&gt; []
        (:) x xs -&gt; (++) x (concat xs)

    (++) xs ys = case xs of
        []         -&gt; ys
        (:) x rest -&gt; (:) x ((++) rest ys)

Where we use the syntax @\u []@ to denote an updatable thunk and @\s []@ to
denote a single-entry (i.e. non-updatable) thunk. After a thread evaluates @x@
to WHNF and calls @(++)@ the heap will contain the following thunks,

    x = 1 : y
    y = \u []  (++) [] z
    z = \s []  concat []

Now that the stage is set, consider the follow evaluations by two racing threads
A and B,

  1. Both threads enter @y@ before either is able to replace it with an
     indirection

  2. Thread A does the case analysis in @(++)@ and consequently enters @z@,
     replacing it with a black-hole

  3. At some later point thread B does the same case analysis and also attempts
     to enter @z@. However, it finds that it has been replaced with a black-hole
     so it blocks.

  4. Thread A eventually finishes evaluating @z@ (to @[]@) and updates @y@
     accordingly. It does *not* update @z@, however, as it is single-entry. This
     leaves Thread B blocked forever on a black-hole which will never be
     updated.

To avoid this sort of condition we never black-hole non-updatable thunks.
-}</span><span>
</span><a name="line-797"></a><span>
</span><a name="line-798"></a><span class="hs-identifier">isStaticClosure</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-type">ClosureInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-799"></a><a name="isStaticClosure"><a href="StgCmmClosure.html#isStaticClosure"><span class="hs-identifier">isStaticClosure</span></a></a><span> </span><a name="local-6989586621680685217"><a href="#local-6989586621680685217"><span class="hs-identifier">cl_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SMRep.html#isStaticRep"><span class="hs-identifier hs-var">isStaticRep</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">closureSMRep</span><span> </span><a href="#local-6989586621680685217"><span class="hs-identifier hs-var">cl_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-800"></a><span>
</span><a name="line-801"></a><span class="hs-identifier">closureUpdReqd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-type">ClosureInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-802"></a><a name="closureUpdReqd"><a href="StgCmmClosure.html#closureUpdReqd"><span class="hs-identifier">closureUpdReqd</span></a></a><span> </span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-var">ClosureInfo</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">closureLFInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680685218"><a href="#local-6989586621680685218"><span class="hs-identifier">lf_info</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#lfUpdatable"><span class="hs-identifier hs-var">lfUpdatable</span></a><span> </span><a href="#local-6989586621680685218"><span class="hs-identifier hs-var">lf_info</span></a><span>
</span><a name="line-803"></a><span>
</span><a name="line-804"></a><span class="hs-identifier">lfUpdatable</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-805"></a><a name="lfUpdatable"><a href="StgCmmClosure.html#lfUpdatable"><span class="hs-identifier">lfUpdatable</span></a></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#LFThunk"><span class="hs-identifier hs-var">LFThunk</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680685219"><a href="#local-6989586621680685219"><span class="hs-identifier">upd</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680685219"><span class="hs-identifier hs-var">upd</span></a><span>
</span><a name="line-806"></a><span class="hs-identifier">lfUpdatable</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-807"></a><span>
</span><a name="line-808"></a><span class="hs-identifier">closureSingleEntry</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-type">ClosureInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-809"></a><a name="closureSingleEntry"><a href="StgCmmClosure.html#closureSingleEntry"><span class="hs-identifier">closureSingleEntry</span></a></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-var">ClosureInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">closureLFInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#LFThunk"><span class="hs-identifier hs-var">LFThunk</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680685220"><a href="#local-6989586621680685220"><span class="hs-identifier">upd</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680685220"><span class="hs-identifier hs-var">upd</span></a><span>
</span><a name="line-810"></a><span class="hs-identifier">closureSingleEntry</span><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-var">ClosureInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">closureLFInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#LFReEntrant"><span class="hs-identifier hs-var">LFReEntrant</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">OneShotLam</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-811"></a><span class="hs-identifier">closureSingleEntry</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-812"></a><span>
</span><a name="line-813"></a><span class="hs-identifier">closureReEntrant</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-type">ClosureInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-814"></a><a name="closureReEntrant"><a href="StgCmmClosure.html#closureReEntrant"><span class="hs-identifier">closureReEntrant</span></a></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-var">ClosureInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">closureLFInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#LFReEntrant"><span class="hs-identifier hs-var">LFReEntrant</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-815"></a><span class="hs-identifier">closureReEntrant</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-816"></a><span>
</span><a name="line-817"></a><span class="hs-identifier">closureFunInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-type">ClosureInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">RepArity</span><span class="hs-special">,</span><span> </span><a href="SMRep.html#ArgDescr"><span class="hs-identifier hs-type">ArgDescr</span></a><span class="hs-special">)</span><span>
</span><a name="line-818"></a><a name="closureFunInfo"><a href="StgCmmClosure.html#closureFunInfo"><span class="hs-identifier">closureFunInfo</span></a></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-var">ClosureInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">closureLFInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680685221"><a href="#local-6989586621680685221"><span class="hs-identifier">lf_info</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#lfFunInfo"><span class="hs-identifier hs-var">lfFunInfo</span></a><span> </span><a href="#local-6989586621680685221"><span class="hs-identifier hs-var">lf_info</span></a><span>
</span><a name="line-819"></a><span>
</span><a name="line-820"></a><span class="hs-identifier">lfFunInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">RepArity</span><span class="hs-special">,</span><span> </span><a href="SMRep.html#ArgDescr"><span class="hs-identifier hs-type">ArgDescr</span></a><span class="hs-special">)</span><span>
</span><a name="line-821"></a><a name="lfFunInfo"><a href="StgCmmClosure.html#lfFunInfo"><span class="hs-identifier">lfFunInfo</span></a></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#LFReEntrant"><span class="hs-identifier hs-var">LFReEntrant</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680685222"><a href="#local-6989586621680685222"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680685223"><a href="#local-6989586621680685223"><span class="hs-identifier">arg_desc</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680685222"><span class="hs-identifier hs-var">arity</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680685223"><span class="hs-identifier hs-var">arg_desc</span></a><span class="hs-special">)</span><span>
</span><a name="line-822"></a><span class="hs-identifier">lfFunInfo</span><span> </span><span class="hs-identifier">_</span><span>                                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-823"></a><span>
</span><a name="line-824"></a><span class="hs-identifier">funTag</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-type">ClosureInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#DynTag"><span class="hs-identifier hs-type">DynTag</span></a><span>
</span><a name="line-825"></a><a name="funTag"><a href="StgCmmClosure.html#funTag"><span class="hs-identifier">funTag</span></a></a><span> </span><a name="local-6989586621680685224"><a href="#local-6989586621680685224"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-var">ClosureInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">closureLFInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680685225"><a href="#local-6989586621680685225"><span class="hs-identifier">lf_info</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-826"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#lfDynTag"><span class="hs-identifier hs-var">lfDynTag</span></a><span> </span><a href="#local-6989586621680685224"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680685225"><span class="hs-identifier hs-var">lf_info</span></a><span>
</span><a name="line-827"></a><span>
</span><a name="line-828"></a><span class="hs-identifier">isToplevClosure</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-type">ClosureInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-829"></a><a name="isToplevClosure"><a href="StgCmmClosure.html#isToplevClosure"><span class="hs-identifier">isToplevClosure</span></a></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-var">ClosureInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">closureLFInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680685226"><a href="#local-6989586621680685226"><span class="hs-identifier">lf_info</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-830"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680685226"><span class="hs-identifier hs-var">lf_info</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-831"></a><span>      </span><a href="StgCmmClosure.html#LFReEntrant"><span class="hs-identifier hs-var">LFReEntrant</span></a><span> </span><span class="hs-identifier hs-var">TopLevel</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-832"></a><span>      </span><a href="StgCmmClosure.html#LFThunk"><span class="hs-identifier hs-var">LFThunk</span></a><span> </span><span class="hs-identifier hs-var">TopLevel</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-833"></a><span>      </span><a name="local-6989586621680685227"><a href="#local-6989586621680685227"><span class="hs-identifier">_other</span></a></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-834"></a><span>
</span><a name="line-835"></a><span class="hs-comment">--------------------------------------</span><span>
</span><a name="line-836"></a><span class="hs-comment">--   Label generation</span><span>
</span><a name="line-837"></a><span class="hs-comment">--------------------------------------</span><span>
</span><a name="line-838"></a><span>
</span><a name="line-839"></a><span class="hs-identifier">staticClosureLabel</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-type">ClosureInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span>
</span><a name="line-840"></a><a name="staticClosureLabel"><a href="StgCmmClosure.html#staticClosureLabel"><span class="hs-identifier">staticClosureLabel</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#toClosureLbl"><span class="hs-identifier hs-var">toClosureLbl</span></a><span> </span><span class="hs-operator hs-var">.</span><span>  </span><span class="hs-identifier">closureInfoLabel</span><span>
</span><a name="line-841"></a><span>
</span><a name="line-842"></a><span class="hs-identifier">closureSlowEntryLabel</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-type">ClosureInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span>
</span><a name="line-843"></a><a name="closureSlowEntryLabel"><a href="StgCmmClosure.html#closureSlowEntryLabel"><span class="hs-identifier">closureSlowEntryLabel</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#toSlowEntryLbl"><span class="hs-identifier hs-var">toSlowEntryLbl</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">closureInfoLabel</span><span>
</span><a name="line-844"></a><span>
</span><a name="line-845"></a><span class="hs-identifier">closureLocalEntryLabel</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-type">ClosureInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span>
</span><a name="line-846"></a><a name="closureLocalEntryLabel"><a href="StgCmmClosure.html#closureLocalEntryLabel"><span class="hs-identifier">closureLocalEntryLabel</span></a></a><span> </span><a name="local-6989586621680685228"><a href="#local-6989586621680685228"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-847"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">tablesNextToCode</span><span> </span><a href="#local-6989586621680685228"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#toInfoLbl"><span class="hs-identifier hs-var">toInfoLbl</span></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">closureInfoLabel</span><span>
</span><a name="line-848"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>               </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#toEntryLbl"><span class="hs-identifier hs-var">toEntryLbl</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">closureInfoLabel</span><span>
</span><a name="line-849"></a><span>
</span><a name="line-850"></a><span class="hs-identifier">mkClosureInfoTableLabel</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span>
</span><a name="line-851"></a><a name="mkClosureInfoTableLabel"><a href="StgCmmClosure.html#mkClosureInfoTableLabel"><span class="hs-identifier">mkClosureInfoTableLabel</span></a></a><span> </span><a name="local-6989586621680685229"><a href="#local-6989586621680685229"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621680685230"><a href="#local-6989586621680685230"><span class="hs-identifier">lf_info</span></a></a><span>
</span><a name="line-852"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680685230"><span class="hs-identifier hs-var">lf_info</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-853"></a><span>        </span><a href="StgCmmClosure.html#LFThunk"><span class="hs-identifier hs-var">LFThunk</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680685235"><a href="#local-6989586621680685235"><span class="hs-identifier">upd_flag</span></a></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#SelectorThunk"><span class="hs-identifier hs-var">SelectorThunk</span></a><span> </span><a name="local-6989586621680685236"><a href="#local-6989586621680685236"><span class="hs-identifier">offset</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-854"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#mkSelectorInfoLabel"><span class="hs-identifier hs-var">mkSelectorInfoLabel</span></a><span> </span><a href="#local-6989586621680685235"><span class="hs-identifier hs-var">upd_flag</span></a><span> </span><a href="#local-6989586621680685236"><span class="hs-identifier hs-var">offset</span></a><span>
</span><a name="line-855"></a><span>
</span><a name="line-856"></a><span>        </span><a href="StgCmmClosure.html#LFThunk"><span class="hs-identifier hs-var">LFThunk</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680685237"><a href="#local-6989586621680685237"><span class="hs-identifier">upd_flag</span></a></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#ApThunk"><span class="hs-identifier hs-var">ApThunk</span></a><span> </span><a name="local-6989586621680685238"><a href="#local-6989586621680685238"><span class="hs-identifier">arity</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-857"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#mkApInfoTableLabel"><span class="hs-identifier hs-var">mkApInfoTableLabel</span></a><span> </span><a href="#local-6989586621680685237"><span class="hs-identifier hs-var">upd_flag</span></a><span> </span><a href="#local-6989586621680685238"><span class="hs-identifier hs-var">arity</span></a><span>
</span><a name="line-858"></a><span>
</span><a name="line-859"></a><span>        </span><a href="StgCmmClosure.html#LFThunk"><span class="hs-identifier hs-var">LFThunk</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680685232"><span class="hs-identifier hs-var">std_mk_lbl</span></a><span> </span><a href="#local-6989586621680685231"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621680685233"><span class="hs-identifier hs-var">cafs</span></a><span>
</span><a name="line-860"></a><span>        </span><a href="StgCmmClosure.html#LFReEntrant"><span class="hs-identifier hs-var">LFReEntrant</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680685232"><span class="hs-identifier hs-var">std_mk_lbl</span></a><span> </span><a href="#local-6989586621680685231"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621680685233"><span class="hs-identifier hs-var">cafs</span></a><span>
</span><a name="line-861"></a><span>        </span><a name="local-6989586621680685239"><a href="#local-6989586621680685239"><span class="hs-identifier">_other</span></a></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;closureInfoTableLabel&quot;</span><span>
</span><a name="line-862"></a><span>
</span><a name="line-863"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-864"></a><span>    </span><a name="local-6989586621680685231"><a href="#local-6989586621680685231"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621680685229"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-865"></a><span>
</span><a name="line-866"></a><span>    </span><a name="local-6989586621680685232"><a href="#local-6989586621680685232"><span class="hs-identifier">std_mk_lbl</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680685234"><span class="hs-identifier hs-var">is_local</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkLocalInfoTableLabel"><span class="hs-identifier hs-var">mkLocalInfoTableLabel</span></a><span>
</span><a name="line-867"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkInfoTableLabel"><span class="hs-identifier hs-var">mkInfoTableLabel</span></a><span>
</span><a name="line-868"></a><span>
</span><a name="line-869"></a><span>    </span><a name="local-6989586621680685233"><a href="#local-6989586621680685233"><span class="hs-identifier">cafs</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idCafInfo</span><span> </span><a href="#local-6989586621680685229"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-870"></a><span>    </span><a name="local-6989586621680685234"><a href="#local-6989586621680685234"><span class="hs-identifier">is_local</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isDataConWorkId</span><span> </span><a href="#local-6989586621680685229"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-871"></a><span>       </span><span class="hs-comment">-- Make the _info pointer for the implicit datacon worker</span><span>
</span><a name="line-872"></a><span>       </span><span class="hs-comment">-- binding local. The reason we can do this is that importing</span><span>
</span><a name="line-873"></a><span>       </span><span class="hs-comment">-- code always either uses the _closure or _con_info. By the</span><span>
</span><a name="line-874"></a><span>       </span><span class="hs-comment">-- invariants in CorePrep anything else gets eta expanded.</span><span>
</span><a name="line-875"></a><span>
</span><a name="line-876"></a><span>
</span><a name="line-877"></a><span class="hs-identifier">thunkEntryLabel</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CafInfo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#StandardFormInfo"><span class="hs-identifier hs-type">StandardFormInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span>
</span><a name="line-878"></a><span class="hs-comment">-- thunkEntryLabel is a local help function, not exported.  It's used from</span><span>
</span><a name="line-879"></a><span class="hs-comment">-- getCallMethod.</span><span>
</span><a name="line-880"></a><a name="thunkEntryLabel"><a href="StgCmmClosure.html#thunkEntryLabel"><span class="hs-identifier">thunkEntryLabel</span></a></a><span> </span><a name="local-6989586621680685240"><a href="#local-6989586621680685240"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680685241"><a href="#local-6989586621680685241"><span class="hs-identifier">_thunk_id</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#ApThunk"><span class="hs-identifier hs-var">ApThunk</span></a><span> </span><a name="local-6989586621680685242"><a href="#local-6989586621680685242"><span class="hs-identifier">arity</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680685243"><a href="#local-6989586621680685243"><span class="hs-identifier">upd_flag</span></a></a><span>
</span><a name="line-881"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#enterApLabel"><span class="hs-identifier hs-var">enterApLabel</span></a><span> </span><a href="#local-6989586621680685240"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680685243"><span class="hs-identifier hs-var">upd_flag</span></a><span> </span><a href="#local-6989586621680685242"><span class="hs-identifier hs-var">arity</span></a><span>
</span><a name="line-882"></a><span class="hs-identifier">thunkEntryLabel</span><span> </span><a name="local-6989586621680685244"><a href="#local-6989586621680685244"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680685245"><a href="#local-6989586621680685245"><span class="hs-identifier">_thunk_id</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#SelectorThunk"><span class="hs-identifier hs-var">SelectorThunk</span></a><span> </span><a name="local-6989586621680685246"><a href="#local-6989586621680685246"><span class="hs-identifier">offset</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680685247"><a href="#local-6989586621680685247"><span class="hs-identifier">upd_flag</span></a></a><span>
</span><a name="line-883"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#enterSelectorLabel"><span class="hs-identifier hs-var">enterSelectorLabel</span></a><span> </span><a href="#local-6989586621680685244"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680685247"><span class="hs-identifier hs-var">upd_flag</span></a><span> </span><a href="#local-6989586621680685246"><span class="hs-identifier hs-var">offset</span></a><span>
</span><a name="line-884"></a><span class="hs-identifier">thunkEntryLabel</span><span> </span><a name="local-6989586621680685248"><a href="#local-6989586621680685248"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680685249"><a href="#local-6989586621680685249"><span class="hs-identifier">thunk_id</span></a></a><span> </span><a name="local-6989586621680685250"><a href="#local-6989586621680685250"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-885"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#enterIdLabel"><span class="hs-identifier hs-var">enterIdLabel</span></a><span> </span><a href="#local-6989586621680685248"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680685249"><span class="hs-identifier hs-var">thunk_id</span></a><span> </span><a href="#local-6989586621680685250"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-886"></a><span>
</span><a name="line-887"></a><span class="hs-identifier">enterApLabel</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Arity</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span>
</span><a name="line-888"></a><a name="enterApLabel"><a href="StgCmmClosure.html#enterApLabel"><span class="hs-identifier">enterApLabel</span></a></a><span> </span><a name="local-6989586621680685251"><a href="#local-6989586621680685251"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680685252"><a href="#local-6989586621680685252"><span class="hs-identifier">is_updatable</span></a></a><span> </span><a name="local-6989586621680685253"><a href="#local-6989586621680685253"><span class="hs-identifier">arity</span></a></a><span>
</span><a name="line-889"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">tablesNextToCode</span><span> </span><a href="#local-6989586621680685251"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkApInfoTableLabel"><span class="hs-identifier hs-var">mkApInfoTableLabel</span></a><span> </span><a href="#local-6989586621680685252"><span class="hs-identifier hs-var">is_updatable</span></a><span> </span><a href="#local-6989586621680685253"><span class="hs-identifier hs-var">arity</span></a><span>
</span><a name="line-890"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>               </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkApEntryLabel"><span class="hs-identifier hs-var">mkApEntryLabel</span></a><span> </span><a href="#local-6989586621680685252"><span class="hs-identifier hs-var">is_updatable</span></a><span> </span><a href="#local-6989586621680685253"><span class="hs-identifier hs-var">arity</span></a><span>
</span><a name="line-891"></a><span>
</span><a name="line-892"></a><span class="hs-identifier">enterSelectorLabel</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#WordOff"><span class="hs-identifier hs-type">WordOff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span>
</span><a name="line-893"></a><a name="enterSelectorLabel"><a href="StgCmmClosure.html#enterSelectorLabel"><span class="hs-identifier">enterSelectorLabel</span></a></a><span> </span><a name="local-6989586621680685254"><a href="#local-6989586621680685254"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680685255"><a href="#local-6989586621680685255"><span class="hs-identifier">upd_flag</span></a></a><span> </span><a name="local-6989586621680685256"><a href="#local-6989586621680685256"><span class="hs-identifier">offset</span></a></a><span>
</span><a name="line-894"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">tablesNextToCode</span><span> </span><a href="#local-6989586621680685254"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkSelectorInfoLabel"><span class="hs-identifier hs-var">mkSelectorInfoLabel</span></a><span> </span><a href="#local-6989586621680685255"><span class="hs-identifier hs-var">upd_flag</span></a><span> </span><a href="#local-6989586621680685256"><span class="hs-identifier hs-var">offset</span></a><span>
</span><a name="line-895"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>               </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkSelectorEntryLabel"><span class="hs-identifier hs-var">mkSelectorEntryLabel</span></a><span> </span><a href="#local-6989586621680685255"><span class="hs-identifier hs-var">upd_flag</span></a><span> </span><a href="#local-6989586621680685256"><span class="hs-identifier hs-var">offset</span></a><span>
</span><a name="line-896"></a><span>
</span><a name="line-897"></a><span class="hs-identifier">enterIdLabel</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CafInfo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span>
</span><a name="line-898"></a><a name="enterIdLabel"><a href="StgCmmClosure.html#enterIdLabel"><span class="hs-identifier">enterIdLabel</span></a></a><span> </span><a name="local-6989586621680685257"><a href="#local-6989586621680685257"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680685258"><a href="#local-6989586621680685258"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621680685259"><a href="#local-6989586621680685259"><span class="hs-identifier">c</span></a></a><span>
</span><a name="line-899"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">tablesNextToCode</span><span> </span><a href="#local-6989586621680685257"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkInfoTableLabel"><span class="hs-identifier hs-var">mkInfoTableLabel</span></a><span> </span><a href="#local-6989586621680685258"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621680685259"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-900"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>               </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkEntryLabel"><span class="hs-identifier hs-var">mkEntryLabel</span></a><span> </span><a href="#local-6989586621680685258"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621680685259"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-901"></a><span>
</span><a name="line-902"></a><span>
</span><a name="line-903"></a><span class="hs-comment">--------------------------------------</span><span>
</span><a name="line-904"></a><span class="hs-comment">--   Profiling</span><span>
</span><a name="line-905"></a><span class="hs-comment">--------------------------------------</span><span>
</span><a name="line-906"></a><span>
</span><a name="line-907"></a><span class="hs-comment">-- Profiling requires two pieces of information to be determined for</span><span>
</span><a name="line-908"></a><span class="hs-comment">-- each closure's info table --- description and type.</span><span>
</span><a name="line-909"></a><span>
</span><a name="line-910"></a><span class="hs-comment">-- The description is stored directly in the @CClosureInfoTable@ when the</span><span>
</span><a name="line-911"></a><span class="hs-comment">-- info table is built.</span><span>
</span><a name="line-912"></a><span>
</span><a name="line-913"></a><span class="hs-comment">-- The type is determined from the type information stored with the @Id@</span><span>
</span><a name="line-914"></a><span class="hs-comment">-- in the closure info using @closureTypeDescr@.</span><span>
</span><a name="line-915"></a><span>
</span><a name="line-916"></a><span class="hs-identifier">mkProfilingInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#ProfilingInfo"><span class="hs-identifier hs-type">ProfilingInfo</span></a><span>
</span><a name="line-917"></a><a name="mkProfilingInfo"><a href="StgCmmClosure.html#mkProfilingInfo"><span class="hs-identifier">mkProfilingInfo</span></a></a><span> </span><a name="local-6989586621680685260"><a href="#local-6989586621680685260"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680685261"><a href="#local-6989586621680685261"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621680685262"><a href="#local-6989586621680685262"><span class="hs-identifier">val_descr</span></a></a><span>
</span><a name="line-918"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_SccProfilingOn</span><span> </span><a href="#local-6989586621680685260"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#NoProfilingInfo"><span class="hs-identifier hs-var">NoProfilingInfo</span></a><span>
</span><a name="line-919"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#ProfilingInfo"><span class="hs-identifier hs-var">ProfilingInfo</span></a><span> </span><a href="#local-6989586621680685263"><span class="hs-identifier hs-var">ty_descr_w8</span></a><span> </span><a href="#local-6989586621680685264"><span class="hs-identifier hs-var">val_descr_w8</span></a><span>
</span><a name="line-920"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-921"></a><span>    </span><a name="local-6989586621680685263"><a href="#local-6989586621680685263"><span class="hs-identifier">ty_descr_w8</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SMRep.html#stringToWord8s"><span class="hs-identifier hs-var">stringToWord8s</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#getTyDescription"><span class="hs-identifier hs-var">getTyDescription</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621680685261"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-922"></a><span>    </span><a name="local-6989586621680685264"><a href="#local-6989586621680685264"><span class="hs-identifier">val_descr_w8</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SMRep.html#stringToWord8s"><span class="hs-identifier hs-var">stringToWord8s</span></a><span> </span><a href="#local-6989586621680685262"><span class="hs-identifier hs-var">val_descr</span></a><span>
</span><a name="line-923"></a><span>
</span><a name="line-924"></a><span class="hs-identifier">getTyDescription</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-925"></a><a name="getTyDescription"><a href="StgCmmClosure.html#getTyDescription"><span class="hs-identifier">getTyDescription</span></a></a><span> </span><a name="local-6989586621680685265"><a href="#local-6989586621680685265"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-926"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tcSplitSigmaTy</span><span> </span><a href="#local-6989586621680685265"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680685269"><a href="#local-6989586621680685269"><span class="hs-identifier">tau_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-927"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680685269"><span class="hs-identifier hs-var">tau_ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-928"></a><span>      </span><span class="hs-identifier hs-var">TyVarTy</span><span> </span><span class="hs-identifier">_</span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;*&quot;</span><span>
</span><a name="line-929"></a><span>      </span><span class="hs-identifier hs-var">AppTy</span><span> </span><a name="local-6989586621680685270"><a href="#local-6989586621680685270"><span class="hs-identifier">fun</span></a></a><span> </span><span class="hs-identifier">_</span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#getTyDescription"><span class="hs-identifier hs-var">getTyDescription</span></a><span> </span><a href="#local-6989586621680685270"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-930"></a><span>      </span><span class="hs-identifier hs-var">TyConApp</span><span> </span><a name="local-6989586621680685271"><a href="#local-6989586621680685271"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">getOccString</span><span> </span><a href="#local-6989586621680685271"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-931"></a><span>      </span><span class="hs-identifier hs-var">FunTy</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680685272"><a href="#local-6989586621680685272"><span class="hs-identifier">res</span></a></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-char">'-'</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-char">'&gt;'</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680685266"><span class="hs-identifier hs-var">fun_result</span></a><span> </span><a href="#local-6989586621680685272"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-932"></a><span>      </span><span class="hs-identifier hs-var">ForAllTy</span><span> </span><span class="hs-identifier">_</span><span>  </span><a name="local-6989586621680685273"><a href="#local-6989586621680685273"><span class="hs-identifier">ty</span></a></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#getTyDescription"><span class="hs-identifier hs-var">getTyDescription</span></a><span> </span><a href="#local-6989586621680685273"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-933"></a><span>      </span><span class="hs-identifier hs-var">LitTy</span><span> </span><a name="local-6989586621680685274"><a href="#local-6989586621680685274"><span class="hs-identifier">n</span></a></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#getTyLitDescription"><span class="hs-identifier hs-var">getTyLitDescription</span></a><span> </span><a href="#local-6989586621680685274"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-934"></a><span>      </span><span class="hs-identifier hs-var">CastTy</span><span> </span><a name="local-6989586621680685275"><a href="#local-6989586621680685275"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-identifier">_</span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#getTyDescription"><span class="hs-identifier hs-var">getTyDescription</span></a><span> </span><a href="#local-6989586621680685275"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-935"></a><span>      </span><span class="hs-identifier hs-var">CoercionTy</span><span> </span><a name="local-6989586621680685276"><a href="#local-6989586621680685276"><span class="hs-identifier">co</span></a></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;getTyDescription&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680685276"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-936"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-937"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-938"></a><span>    </span><a name="local-6989586621680685266"><a href="#local-6989586621680685266"><span class="hs-identifier">fun_result</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunTy</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680685267"><a href="#local-6989586621680685267"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-char">'&gt;'</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680685266"><span class="hs-identifier hs-var">fun_result</span></a><span> </span><a href="#local-6989586621680685267"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-939"></a><span>    </span><span class="hs-identifier">fun_result</span><span> </span><a name="local-6989586621680685268"><a href="#local-6989586621680685268"><span class="hs-identifier">other</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#getTyDescription"><span class="hs-identifier hs-var">getTyDescription</span></a><span> </span><a href="#local-6989586621680685268"><span class="hs-identifier hs-var">other</span></a><span>
</span><a name="line-940"></a><span>
</span><a name="line-941"></a><span class="hs-identifier">getTyLitDescription</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyLit</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-942"></a><a name="getTyLitDescription"><a href="StgCmmClosure.html#getTyLitDescription"><span class="hs-identifier">getTyLitDescription</span></a></a><span> </span><a name="local-6989586621680685277"><a href="#local-6989586621680685277"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-943"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680685277"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-944"></a><span>    </span><span class="hs-identifier hs-var">NumTyLit</span><span> </span><a name="local-6989586621680685278"><a href="#local-6989586621680685278"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621680685278"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-945"></a><span>    </span><span class="hs-identifier hs-var">StrTyLit</span><span> </span><a name="local-6989586621680685279"><a href="#local-6989586621680685279"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621680685279"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-946"></a><span>
</span><a name="line-947"></a><span class="hs-comment">--------------------------------------</span><span>
</span><a name="line-948"></a><span class="hs-comment">--   CmmInfoTable-related things</span><span>
</span><a name="line-949"></a><span class="hs-comment">--------------------------------------</span><span>
</span><a name="line-950"></a><span>
</span><a name="line-951"></a><span class="hs-identifier">mkDataConInfoTable</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#CmmInfoTable"><span class="hs-identifier hs-type">CmmInfoTable</span></a><span>
</span><a name="line-952"></a><a name="mkDataConInfoTable"><a href="StgCmmClosure.html#mkDataConInfoTable"><span class="hs-identifier">mkDataConInfoTable</span></a></a><span> </span><a name="local-6989586621680685280"><a href="#local-6989586621680685280"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680685281"><a href="#local-6989586621680685281"><span class="hs-identifier">data_con</span></a></a><span> </span><a name="local-6989586621680685282"><a href="#local-6989586621680685282"><span class="hs-identifier">is_static</span></a></a><span> </span><a name="local-6989586621680685283"><a href="#local-6989586621680685283"><span class="hs-identifier">ptr_wds</span></a></a><span> </span><a name="local-6989586621680685284"><a href="#local-6989586621680685284"><span class="hs-identifier">nonptr_wds</span></a></a><span>
</span><a name="line-953"></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#CmmInfoTable"><span class="hs-identifier hs-var">CmmInfoTable</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cit_lbl</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680685286"><span class="hs-identifier hs-var">info_lbl</span></a><span>
</span><a name="line-954"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cit_rep</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680685287"><span class="hs-identifier hs-var">sm_rep</span></a><span>
</span><a name="line-955"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cit_prof</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680685289"><span class="hs-identifier hs-var">prof</span></a><span>
</span><a name="line-956"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cit_srt</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-957"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cit_clo</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-958"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-959"></a><span>   </span><a name="local-6989586621680685285"><a href="#local-6989586621680685285"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConName</span><span> </span><a href="#local-6989586621680685281"><span class="hs-identifier hs-var">data_con</span></a><span>
</span><a name="line-960"></a><span>   </span><a name="local-6989586621680685286"><a href="#local-6989586621680685286"><span class="hs-identifier">info_lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkConInfoTableLabel"><span class="hs-identifier hs-var">mkConInfoTableLabel</span></a><span> </span><a href="#local-6989586621680685285"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-identifier hs-var">NoCafRefs</span><span>
</span><a name="line-961"></a><span>   </span><a name="local-6989586621680685287"><a href="#local-6989586621680685287"><span class="hs-identifier">sm_rep</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SMRep.html#mkHeapRep"><span class="hs-identifier hs-var">mkHeapRep</span></a><span> </span><a href="#local-6989586621680685280"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680685282"><span class="hs-identifier hs-var">is_static</span></a><span> </span><a href="#local-6989586621680685283"><span class="hs-identifier hs-var">ptr_wds</span></a><span> </span><a href="#local-6989586621680685284"><span class="hs-identifier hs-var">nonptr_wds</span></a><span> </span><a href="#local-6989586621680685288"><span class="hs-identifier hs-var">cl_type</span></a><span>
</span><a name="line-962"></a><span>   </span><a name="local-6989586621680685288"><a href="#local-6989586621680685288"><span class="hs-identifier">cl_type</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SMRep.html#Constr"><span class="hs-identifier hs-var">Constr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConTagZ</span><span> </span><a href="#local-6989586621680685281"><span class="hs-identifier hs-var">data_con</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConIdentity</span><span> </span><a href="#local-6989586621680685281"><span class="hs-identifier hs-var">data_con</span></a><span class="hs-special">)</span><span>
</span><a name="line-963"></a><span>                  </span><span class="hs-comment">-- We keep the *zero-indexed* tag in the srt_len field</span><span>
</span><a name="line-964"></a><span>                  </span><span class="hs-comment">-- of the info table of a data constructor.</span><span>
</span><a name="line-965"></a><span>
</span><a name="line-966"></a><span>   </span><a name="local-6989586621680685289"><a href="#local-6989586621680685289"><span class="hs-identifier">prof</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_SccProfilingOn</span><span> </span><a href="#local-6989586621680685280"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#NoProfilingInfo"><span class="hs-identifier hs-var">NoProfilingInfo</span></a><span>
</span><a name="line-967"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                            </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#ProfilingInfo"><span class="hs-identifier hs-var">ProfilingInfo</span></a><span> </span><a href="#local-6989586621680685290"><span class="hs-identifier hs-var">ty_descr</span></a><span> </span><a href="#local-6989586621680685291"><span class="hs-identifier hs-var">val_descr</span></a><span>
</span><a name="line-968"></a><span>
</span><a name="line-969"></a><span>   </span><a name="local-6989586621680685290"><a href="#local-6989586621680685290"><span class="hs-identifier">ty_descr</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SMRep.html#stringToWord8s"><span class="hs-identifier hs-var">stringToWord8s</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">occNameString</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">getOccName</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">dataConTyCon</span><span> </span><a href="#local-6989586621680685281"><span class="hs-identifier hs-var">data_con</span></a><span>
</span><a name="line-970"></a><span>   </span><a name="local-6989586621680685291"><a href="#local-6989586621680685291"><span class="hs-identifier">val_descr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SMRep.html#stringToWord8s"><span class="hs-identifier hs-var">stringToWord8s</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">occNameString</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">getOccName</span><span> </span><a href="#local-6989586621680685281"><span class="hs-identifier hs-var">data_con</span></a><span>
</span><a name="line-971"></a><span>
</span><a name="line-972"></a><span class="hs-comment">-- We need a black-hole closure info to pass to @allocDynClosure@ when we</span><span>
</span><a name="line-973"></a><span class="hs-comment">-- want to allocate the black hole on entry to a CAF.</span><span>
</span><a name="line-974"></a><span>
</span><a name="line-975"></a><span class="hs-identifier">cafBlackHoleInfoTable</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Cmm.html#CmmInfoTable"><span class="hs-identifier hs-type">CmmInfoTable</span></a><span>
</span><a name="line-976"></a><a name="cafBlackHoleInfoTable"><a href="StgCmmClosure.html#cafBlackHoleInfoTable"><span class="hs-identifier">cafBlackHoleInfoTable</span></a></a><span>
</span><a name="line-977"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#CmmInfoTable"><span class="hs-identifier hs-var">CmmInfoTable</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cit_lbl</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkCAFBlackHoleInfoTableLabel"><span class="hs-identifier hs-var">mkCAFBlackHoleInfoTableLabel</span></a><span>
</span><a name="line-978"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cit_rep</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SMRep.html#blackHoleRep"><span class="hs-identifier hs-var">blackHoleRep</span></a><span>
</span><a name="line-979"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cit_prof</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#NoProfilingInfo"><span class="hs-identifier hs-var">NoProfilingInfo</span></a><span>
</span><a name="line-980"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cit_srt</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-981"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cit_clo</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-982"></a><span>
</span><a name="line-983"></a><span class="hs-identifier">indStaticInfoTable</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Cmm.html#CmmInfoTable"><span class="hs-identifier hs-type">CmmInfoTable</span></a><span>
</span><a name="line-984"></a><a name="indStaticInfoTable"><a href="StgCmmClosure.html#indStaticInfoTable"><span class="hs-identifier">indStaticInfoTable</span></a></a><span>
</span><a name="line-985"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#CmmInfoTable"><span class="hs-identifier hs-var">CmmInfoTable</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cit_lbl</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkIndStaticInfoLabel"><span class="hs-identifier hs-var">mkIndStaticInfoLabel</span></a><span>
</span><a name="line-986"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cit_rep</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SMRep.html#indStaticRep"><span class="hs-identifier hs-var">indStaticRep</span></a><span>
</span><a name="line-987"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cit_prof</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#NoProfilingInfo"><span class="hs-identifier hs-var">NoProfilingInfo</span></a><span>
</span><a name="line-988"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cit_srt</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-989"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cit_clo</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-990"></a><span>
</span><a name="line-991"></a><span class="hs-identifier">staticClosureNeedsLink</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#CmmInfoTable"><span class="hs-identifier hs-type">CmmInfoTable</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-992"></a><span class="hs-comment">-- A static closure needs a link field to aid the GC when traversing</span><span>
</span><a name="line-993"></a><span class="hs-comment">-- the static closure graph.  But it only needs such a field if either</span><span>
</span><a name="line-994"></a><span class="hs-comment">--        a) it has an SRT</span><span>
</span><a name="line-995"></a><span class="hs-comment">--        b) it's a constructor with one or more pointer fields</span><span>
</span><a name="line-996"></a><span class="hs-comment">-- In case (b), the constructor's fields themselves play the role</span><span>
</span><a name="line-997"></a><span class="hs-comment">-- of the SRT.</span><span>
</span><a name="line-998"></a><a name="staticClosureNeedsLink"><a href="StgCmmClosure.html#staticClosureNeedsLink"><span class="hs-identifier">staticClosureNeedsLink</span></a></a><span> </span><a name="local-6989586621680685292"><a href="#local-6989586621680685292"><span class="hs-identifier">has_srt</span></a></a><span> </span><a href="Cmm.html#CmmInfoTable"><span class="hs-identifier hs-var">CmmInfoTable</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">cit_rep</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680685293"><a href="#local-6989586621680685293"><span class="hs-identifier">smrep</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-999"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="SMRep.html#isConRep"><span class="hs-identifier hs-var">isConRep</span></a><span> </span><a href="#local-6989586621680685293"><span class="hs-identifier hs-var">smrep</span></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="SMRep.html#isStaticNoCafCon"><span class="hs-identifier hs-var">isStaticNoCafCon</span></a><span> </span><a href="#local-6989586621680685293"><span class="hs-identifier hs-var">smrep</span></a><span class="hs-special">)</span><span>
</span><a name="line-1000"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680685292"><span class="hs-identifier hs-var">has_srt</span></a><span>
</span><a name="line-1001"></a></pre></body></html>