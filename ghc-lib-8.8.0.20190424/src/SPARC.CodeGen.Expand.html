<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- | Expand out synthetic instructions into single machine instrs.</span><span>
</span><a name="line-2"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">SPARC.CodeGen.Expand</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-3"></a><span>        </span><a href="SPARC.CodeGen.Expand.html#expandTop"><span class="hs-identifier hs-var">expandTop</span></a><span>
</span><a name="line-4"></a><span class="hs-special">)</span><span>
</span><a name="line-5"></a><span>
</span><a name="line-6"></a><span class="hs-keyword">where</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span> </span><a href="SPARC.Instr.html"><span class="hs-identifier">SPARC.Instr</span></a><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span> </span><a href="SPARC.Imm.html"><span class="hs-identifier">SPARC.Imm</span></a><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><a href="SPARC.AddrMode.html"><span class="hs-identifier">SPARC.AddrMode</span></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><a href="SPARC.Regs.html"><span class="hs-identifier">SPARC.Regs</span></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><a href="SPARC.Ppr.html"><span class="hs-identifier">SPARC.Ppr</span></a><span>        </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><a href="Instruction.html"><span class="hs-identifier">Instruction</span></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><a href="Reg.html"><span class="hs-identifier">Reg</span></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><a href="Format.html"><span class="hs-identifier">Format</span></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><a href="Cmm.html"><span class="hs-identifier">Cmm</span></a><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">OrdList</span><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span class="hs-comment">-- | Expand out synthetic instructions in this top level thing</span><span>
</span><a name="line-25"></a><span class="hs-identifier">expandTop</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Instruction.html#NatCmmDecl"><span class="hs-identifier hs-type">NatCmmDecl</span></a><span> </span><a href="Cmm.html#CmmStatics"><span class="hs-identifier hs-type">CmmStatics</span></a><span> </span><a href="SPARC.Instr.html#Instr"><span class="hs-identifier hs-type">Instr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Instruction.html#NatCmmDecl"><span class="hs-identifier hs-type">NatCmmDecl</span></a><span> </span><a href="Cmm.html#CmmStatics"><span class="hs-identifier hs-type">CmmStatics</span></a><span> </span><a href="SPARC.Instr.html#Instr"><span class="hs-identifier hs-type">Instr</span></a><span>
</span><a name="line-26"></a><a name="expandTop"><a href="SPARC.CodeGen.Expand.html#expandTop"><span class="hs-identifier">expandTop</span></a></a><span> </span><a name="local-6989586621684526520"><a href="#local-6989586621684526520"><span class="hs-identifier">top</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Cmm.html#CmmData"><span class="hs-identifier hs-var">CmmData</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684526520"><span class="hs-identifier hs-var">top</span></a><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span class="hs-identifier">expandTop</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a name="local-6989586621684526521"><a href="#local-6989586621684526521"><span class="hs-identifier">info</span></a></a><span> </span><a name="local-6989586621684526522"><a href="#local-6989586621684526522"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621684526523"><a href="#local-6989586621684526523"><span class="hs-identifier">live</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-var">ListGraph</span></a><span> </span><a name="local-6989586621684526524"><a href="#local-6989586621684526524"><span class="hs-identifier">blocks</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a href="#local-6989586621684526521"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621684526522"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621684526523"><span class="hs-identifier hs-var">live</span></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-var">ListGraph</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="SPARC.CodeGen.Expand.html#expandBlock"><span class="hs-identifier hs-var">expandBlock</span></a><span> </span><a href="#local-6989586621684526524"><span class="hs-identifier hs-var">blocks</span></a><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-comment">-- | Expand out synthetic instructions in this block</span><span>
</span><a name="line-34"></a><span class="hs-identifier">expandBlock</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Instruction.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a><span> </span><a href="SPARC.Instr.html#Instr"><span class="hs-identifier hs-type">Instr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Instruction.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a><span> </span><a href="SPARC.Instr.html#Instr"><span class="hs-identifier hs-type">Instr</span></a><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><a name="expandBlock"><a href="SPARC.CodeGen.Expand.html#expandBlock"><span class="hs-identifier">expandBlock</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#BasicBlock"><span class="hs-identifier hs-var">BasicBlock</span></a><span> </span><span class="hs-keyword">label</span><span> </span><a name="local-6989586621684526526"><a href="#local-6989586621684526526"><span class="hs-identifier">instrs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>  </span><a name="local-6989586621684526527"><a href="#local-6989586621684526527"><span class="hs-identifier">instrs_ol</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="SPARC.CodeGen.Expand.html#expandBlockInstrs"><span class="hs-identifier hs-var">expandBlockInstrs</span></a><span> </span><a href="#local-6989586621684526526"><span class="hs-identifier hs-var">instrs</span></a><span>
</span><a name="line-38"></a><span>        </span><a name="local-6989586621684526528"><a href="#local-6989586621684526528"><span class="hs-identifier">instrs'</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromOL</span><span> </span><a href="#local-6989586621684526527"><span class="hs-identifier hs-var">instrs_ol</span></a><span>
</span><a name="line-39"></a><span>   </span><span class="hs-keyword">in</span><span>   </span><a href="Cmm.html#BasicBlock"><span class="hs-identifier hs-var">BasicBlock</span></a><span> </span><span class="hs-keyword">label</span><span> </span><a href="#local-6989586621684526528"><span class="hs-identifier hs-var">instrs'</span></a><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span>
</span><a name="line-42"></a><span class="hs-comment">-- | Expand out some instructions</span><span>
</span><a name="line-43"></a><span class="hs-identifier">expandBlockInstrs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="SPARC.Instr.html#Instr"><span class="hs-identifier hs-type">Instr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OrdList</span><span> </span><a href="SPARC.Instr.html#Instr"><span class="hs-identifier hs-type">Instr</span></a><span>
</span><a name="line-44"></a><a name="expandBlockInstrs"><a href="SPARC.CodeGen.Expand.html#expandBlockInstrs"><span class="hs-identifier">expandBlockInstrs</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nilOL</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span class="hs-identifier">expandBlockInstrs</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684526529"><a href="#local-6989586621684526529"><span class="hs-identifier">ii</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684526530"><a href="#local-6989586621684526530"><span class="hs-identifier">is</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>  </span><a name="local-6989586621684526531"><a href="#local-6989586621684526531"><span class="hs-identifier">ii_doubleRegs</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="SPARC.CodeGen.Expand.html#remapRegPair"><span class="hs-identifier hs-var">remapRegPair</span></a><span> </span><a href="#local-6989586621684526529"><span class="hs-identifier hs-var">ii</span></a><span>
</span><a name="line-48"></a><span>        </span><a name="local-6989586621684526532"><a href="#local-6989586621684526532"><span class="hs-identifier">is_misaligned</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="SPARC.CodeGen.Expand.html#expandMisalignedDoubles"><span class="hs-identifier hs-var">expandMisalignedDoubles</span></a><span> </span><a href="#local-6989586621684526531"><span class="hs-identifier hs-var">ii_doubleRegs</span></a><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span>   </span><span class="hs-keyword">in</span><span>   </span><a href="#local-6989586621684526532"><span class="hs-identifier hs-var">is_misaligned</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span> </span><a href="SPARC.CodeGen.Expand.html#expandBlockInstrs"><span class="hs-identifier hs-var">expandBlockInstrs</span></a><span> </span><a href="#local-6989586621684526530"><span class="hs-identifier hs-var">is</span></a><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span>
</span><a name="line-54"></a><span class="hs-comment">-- | In the SPARC instruction set the FP register pairs that are used</span><span>
</span><a name="line-55"></a><span class="hs-comment">--      to hold 64 bit floats are refered to by just the first reg</span><span>
</span><a name="line-56"></a><span class="hs-comment">--      of the pair. Remap our internal reg pairs to the appropriate reg.</span><span>
</span><a name="line-57"></a><span class="hs-comment">--</span><span>
</span><a name="line-58"></a><span class="hs-comment">--      For example:</span><span>
</span><a name="line-59"></a><span class="hs-comment">--          ldd [%l1], (%f0 | %f1)</span><span>
</span><a name="line-60"></a><span class="hs-comment">--</span><span>
</span><a name="line-61"></a><span class="hs-comment">--      gets mapped to</span><span>
</span><a name="line-62"></a><span class="hs-comment">--          ldd [$l1], %f0</span><span>
</span><a name="line-63"></a><span class="hs-comment">--</span><span>
</span><a name="line-64"></a><span class="hs-identifier">remapRegPair</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SPARC.Instr.html#Instr"><span class="hs-identifier hs-type">Instr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SPARC.Instr.html#Instr"><span class="hs-identifier hs-type">Instr</span></a><span>
</span><a name="line-65"></a><a name="remapRegPair"><a href="SPARC.CodeGen.Expand.html#remapRegPair"><span class="hs-identifier">remapRegPair</span></a></a><span> </span><a name="local-6989586621684526533"><a href="#local-6989586621684526533"><span class="hs-identifier">instr</span></a></a><span>
</span><a name="line-66"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>  </span><a name="local-6989586621684526534"><a href="#local-6989586621684526534"><span class="hs-identifier">patchF</span></a></a><span> </span><a name="local-6989586621684526535"><a href="#local-6989586621684526535"><span class="hs-identifier">reg</span></a></a><span>
</span><a name="line-67"></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684526535"><span class="hs-identifier hs-var">reg</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-68"></a><span>                </span><a href="Reg.html#RegReal"><span class="hs-identifier hs-var">RegReal</span></a><span> </span><span class="hs-special">(</span><a href="Reg.html#RealRegSingle"><span class="hs-identifier hs-var">RealRegSingle</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-69"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684526535"><span class="hs-identifier hs-var">reg</span></a><span>
</span><a name="line-70"></a><span>
</span><a name="line-71"></a><span>                </span><a href="Reg.html#RegReal"><span class="hs-identifier hs-var">RegReal</span></a><span> </span><span class="hs-special">(</span><a href="Reg.html#RealRegPair"><span class="hs-identifier hs-var">RealRegPair</span></a><span> </span><a name="local-6989586621684526536"><a href="#local-6989586621684526536"><span class="hs-identifier">r1</span></a></a><span> </span><a name="local-6989586621684526537"><a href="#local-6989586621684526537"><span class="hs-identifier">r2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span>                        </span><span class="hs-comment">-- sanity checking</span><span>
</span><a name="line-74"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684526536"><span class="hs-identifier hs-var">r1</span></a><span>         </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">32</span><span>
</span><a name="line-75"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684526536"><span class="hs-identifier hs-var">r1</span></a><span>         </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-number">63</span><span>
</span><a name="line-76"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684526536"><span class="hs-identifier hs-var">r1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mod</span><span class="hs-special">`</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-77"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684526537"><span class="hs-identifier hs-var">r2</span></a><span>         </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684526536"><span class="hs-identifier hs-var">r1</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-78"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reg.html#RegReal"><span class="hs-identifier hs-var">RegReal</span></a><span> </span><span class="hs-special">(</span><a href="Reg.html#RealRegSingle"><span class="hs-identifier hs-var">RealRegSingle</span></a><span> </span><a href="#local-6989586621684526536"><span class="hs-identifier hs-var">r1</span></a><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span>
</span><a name="line-80"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-81"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;SPARC.CodeGen.Expand: not remapping dodgy looking reg pair &quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684526535"><span class="hs-identifier hs-var">reg</span></a><span class="hs-special">)</span><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span>                </span><a href="Reg.html#RegVirtual"><span class="hs-identifier hs-var">RegVirtual</span></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-84"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;SPARC.CodeGen.Expand: not remapping virtual reg &quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684526535"><span class="hs-identifier hs-var">reg</span></a><span class="hs-special">)</span><span>
</span><a name="line-85"></a><span>
</span><a name="line-86"></a><span>   </span><span class="hs-keyword">in</span><span>   </span><a href="Instruction.html#patchRegsOfInstr"><span class="hs-identifier hs-var">patchRegsOfInstr</span></a><span> </span><a href="#local-6989586621684526533"><span class="hs-identifier hs-var">instr</span></a><span> </span><a href="#local-6989586621684526534"><span class="hs-identifier hs-var">patchF</span></a><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span>
</span><a name="line-91"></a><span class="hs-comment">-- Expand out 64 bit load/stores into individual instructions to handle</span><span>
</span><a name="line-92"></a><span class="hs-comment">--      possible double alignment problems.</span><span>
</span><a name="line-93"></a><span class="hs-comment">--</span><span>
</span><a name="line-94"></a><span class="hs-comment">--      TODO:   It'd be better to use a scratch reg instead of the add/sub thing.</span><span>
</span><a name="line-95"></a><span class="hs-comment">--              We might be able to do this faster if we use the UA2007 instr set</span><span>
</span><a name="line-96"></a><span class="hs-comment">--              instead of restricting ourselves to SPARC V9.</span><span>
</span><a name="line-97"></a><span class="hs-comment">--</span><span>
</span><a name="line-98"></a><span class="hs-identifier">expandMisalignedDoubles</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SPARC.Instr.html#Instr"><span class="hs-identifier hs-type">Instr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OrdList</span><span> </span><a href="SPARC.Instr.html#Instr"><span class="hs-identifier hs-type">Instr</span></a><span>
</span><a name="line-99"></a><a name="expandMisalignedDoubles"><a href="SPARC.CodeGen.Expand.html#expandMisalignedDoubles"><span class="hs-identifier">expandMisalignedDoubles</span></a></a><span> </span><a name="local-6989586621684526538"><a href="#local-6989586621684526538"><span class="hs-identifier">instr</span></a></a><span>
</span><a name="line-100"></a><span>
</span><a name="line-101"></a><span>        </span><span class="hs-comment">-- Translate to:</span><span>
</span><a name="line-102"></a><span>        </span><span class="hs-comment">--    add g1,g2,g1</span><span>
</span><a name="line-103"></a><span>        </span><span class="hs-comment">--    ld  [g1],%fn</span><span>
</span><a name="line-104"></a><span>        </span><span class="hs-comment">--    ld  [g1+4],%f(n+1)</span><span>
</span><a name="line-105"></a><span>        </span><span class="hs-comment">--    sub g1,g2,g1           -- to restore g1</span><span>
</span><a name="line-106"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="SPARC.Instr.html#LD"><span class="hs-identifier hs-var">LD</span></a><span> </span><a href="Format.html#FF64"><span class="hs-identifier hs-var">FF64</span></a><span> </span><span class="hs-special">(</span><a href="SPARC.AddrMode.html#AddrRegReg"><span class="hs-identifier hs-var">AddrRegReg</span></a><span> </span><a name="local-6989586621684526539"><a href="#local-6989586621684526539"><span class="hs-identifier">r1</span></a></a><span> </span><a name="local-6989586621684526540"><a href="#local-6989586621684526540"><span class="hs-identifier">r2</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684526541"><a href="#local-6989586621684526541"><span class="hs-identifier">fReg</span></a></a><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684526538"><span class="hs-identifier hs-var">instr</span></a><span>
</span><a name="line-107"></a><span>        </span><span class="hs-glyph">=</span><span>       </span><span class="hs-identifier hs-var">toOL</span><span>    </span><span class="hs-special">[</span><span> </span><a href="SPARC.Instr.html#ADD"><span class="hs-identifier hs-var">ADD</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621684526539"><span class="hs-identifier hs-var">r1</span></a><span> </span><span class="hs-special">(</span><a href="SPARC.Instr.html#RIReg"><span class="hs-identifier hs-var">RIReg</span></a><span> </span><a href="#local-6989586621684526540"><span class="hs-identifier hs-var">r2</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684526539"><span class="hs-identifier hs-var">r1</span></a><span>
</span><a name="line-108"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="SPARC.Instr.html#LD"><span class="hs-identifier hs-var">LD</span></a><span>  </span><a href="Format.html#FF32"><span class="hs-identifier hs-var">FF32</span></a><span>  </span><span class="hs-special">(</span><a href="SPARC.AddrMode.html#AddrRegReg"><span class="hs-identifier hs-var">AddrRegReg</span></a><span> </span><a href="#local-6989586621684526539"><span class="hs-identifier hs-var">r1</span></a><span> </span><a href="SPARC.Regs.html#g0"><span class="hs-identifier hs-var">g0</span></a><span class="hs-special">)</span><span>          </span><a href="#local-6989586621684526541"><span class="hs-identifier hs-var">fReg</span></a><span>
</span><a name="line-109"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="SPARC.Instr.html#LD"><span class="hs-identifier hs-var">LD</span></a><span>  </span><a href="Format.html#FF32"><span class="hs-identifier hs-var">FF32</span></a><span>  </span><span class="hs-special">(</span><a href="SPARC.AddrMode.html#AddrRegImm"><span class="hs-identifier hs-var">AddrRegImm</span></a><span> </span><a href="#local-6989586621684526539"><span class="hs-identifier hs-var">r1</span></a><span> </span><span class="hs-special">(</span><a href="SPARC.Imm.html#ImmInt"><span class="hs-identifier hs-var">ImmInt</span></a><span> </span><span class="hs-number">4</span><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="hs-special">(</span><a href="SPARC.CodeGen.Expand.html#fRegHi"><span class="hs-identifier hs-var">fRegHi</span></a><span> </span><a href="#local-6989586621684526541"><span class="hs-identifier hs-var">fReg</span></a><span class="hs-special">)</span><span>
</span><a name="line-110"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="SPARC.Instr.html#SUB"><span class="hs-identifier hs-var">SUB</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621684526539"><span class="hs-identifier hs-var">r1</span></a><span> </span><span class="hs-special">(</span><a href="SPARC.Instr.html#RIReg"><span class="hs-identifier hs-var">RIReg</span></a><span> </span><a href="#local-6989586621684526540"><span class="hs-identifier hs-var">r2</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684526539"><span class="hs-identifier hs-var">r1</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-111"></a><span>
</span><a name="line-112"></a><span>        </span><span class="hs-comment">-- Translate to</span><span>
</span><a name="line-113"></a><span>        </span><span class="hs-comment">--    ld  [addr],%fn</span><span>
</span><a name="line-114"></a><span>        </span><span class="hs-comment">--    ld  [addr+4],%f(n+1)</span><span>
</span><a name="line-115"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="SPARC.Instr.html#LD"><span class="hs-identifier hs-var">LD</span></a><span> </span><a href="Format.html#FF64"><span class="hs-identifier hs-var">FF64</span></a><span> </span><a name="local-6989586621684526542"><a href="#local-6989586621684526542"><span class="hs-identifier">addr</span></a></a><span> </span><a name="local-6989586621684526543"><a href="#local-6989586621684526543"><span class="hs-identifier">fReg</span></a></a><span>                     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684526538"><span class="hs-identifier hs-var">instr</span></a><span>
</span><a name="line-116"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>   </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684526544"><a href="#local-6989586621684526544"><span class="hs-identifier">addr'</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="SPARC.AddrMode.html#addrOffset"><span class="hs-identifier hs-var">addrOffset</span></a><span> </span><a href="#local-6989586621684526542"><span class="hs-identifier hs-var">addr</span></a><span> </span><span class="hs-number">4</span><span>
</span><a name="line-117"></a><span>          </span><span class="hs-keyword">in</span><span>    </span><span class="hs-identifier hs-var">toOL</span><span>    </span><span class="hs-special">[</span><span> </span><a href="SPARC.Instr.html#LD"><span class="hs-identifier hs-var">LD</span></a><span>  </span><a href="Format.html#FF32"><span class="hs-identifier hs-var">FF32</span></a><span>  </span><a href="#local-6989586621684526542"><span class="hs-identifier hs-var">addr</span></a><span>        </span><a href="#local-6989586621684526543"><span class="hs-identifier hs-var">fReg</span></a><span>
</span><a name="line-118"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="SPARC.Instr.html#LD"><span class="hs-identifier hs-var">LD</span></a><span>  </span><a href="Format.html#FF32"><span class="hs-identifier hs-var">FF32</span></a><span>  </span><a href="#local-6989586621684526544"><span class="hs-identifier hs-var">addr'</span></a><span>       </span><span class="hs-special">(</span><a href="SPARC.CodeGen.Expand.html#fRegHi"><span class="hs-identifier hs-var">fRegHi</span></a><span> </span><a href="#local-6989586621684526543"><span class="hs-identifier hs-var">fReg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-119"></a><span>
</span><a name="line-120"></a><span>        </span><span class="hs-comment">-- Translate to:</span><span>
</span><a name="line-121"></a><span>        </span><span class="hs-comment">--    add g1,g2,g1</span><span>
</span><a name="line-122"></a><span>        </span><span class="hs-comment">--    st  %fn,[g1]</span><span>
</span><a name="line-123"></a><span>        </span><span class="hs-comment">--    st  %f(n+1),[g1+4]</span><span>
</span><a name="line-124"></a><span>        </span><span class="hs-comment">--    sub g1,g2,g1           -- to restore g1</span><span>
</span><a name="line-125"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="SPARC.Instr.html#ST"><span class="hs-identifier hs-var">ST</span></a><span> </span><a href="Format.html#FF64"><span class="hs-identifier hs-var">FF64</span></a><span> </span><a name="local-6989586621684526545"><a href="#local-6989586621684526545"><span class="hs-identifier">fReg</span></a></a><span> </span><span class="hs-special">(</span><a href="SPARC.AddrMode.html#AddrRegReg"><span class="hs-identifier hs-var">AddrRegReg</span></a><span> </span><a name="local-6989586621684526546"><a href="#local-6989586621684526546"><span class="hs-identifier">r1</span></a></a><span> </span><a name="local-6989586621684526547"><a href="#local-6989586621684526547"><span class="hs-identifier">r2</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684526538"><span class="hs-identifier hs-var">instr</span></a><span>
</span><a name="line-126"></a><span>        </span><span class="hs-glyph">=</span><span>       </span><span class="hs-identifier hs-var">toOL</span><span>    </span><span class="hs-special">[</span><span> </span><a href="SPARC.Instr.html#ADD"><span class="hs-identifier hs-var">ADD</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621684526546"><span class="hs-identifier hs-var">r1</span></a><span> </span><span class="hs-special">(</span><a href="SPARC.Instr.html#RIReg"><span class="hs-identifier hs-var">RIReg</span></a><span> </span><a href="#local-6989586621684526547"><span class="hs-identifier hs-var">r2</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684526546"><span class="hs-identifier hs-var">r1</span></a><span>
</span><a name="line-127"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="SPARC.Instr.html#ST"><span class="hs-identifier hs-var">ST</span></a><span>  </span><a href="Format.html#FF32"><span class="hs-identifier hs-var">FF32</span></a><span>  </span><a href="#local-6989586621684526545"><span class="hs-identifier hs-var">fReg</span></a><span>           </span><span class="hs-special">(</span><a href="SPARC.AddrMode.html#AddrRegReg"><span class="hs-identifier hs-var">AddrRegReg</span></a><span> </span><a href="#local-6989586621684526546"><span class="hs-identifier hs-var">r1</span></a><span> </span><a href="SPARC.Regs.html#g0"><span class="hs-identifier hs-var">g0</span></a><span class="hs-special">)</span><span>
</span><a name="line-128"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="SPARC.Instr.html#ST"><span class="hs-identifier hs-var">ST</span></a><span>  </span><a href="Format.html#FF32"><span class="hs-identifier hs-var">FF32</span></a><span>  </span><span class="hs-special">(</span><a href="SPARC.CodeGen.Expand.html#fRegHi"><span class="hs-identifier hs-var">fRegHi</span></a><span> </span><a href="#local-6989586621684526545"><span class="hs-identifier hs-var">fReg</span></a><span class="hs-special">)</span><span>  </span><span class="hs-special">(</span><a href="SPARC.AddrMode.html#AddrRegImm"><span class="hs-identifier hs-var">AddrRegImm</span></a><span> </span><a href="#local-6989586621684526546"><span class="hs-identifier hs-var">r1</span></a><span> </span><span class="hs-special">(</span><a href="SPARC.Imm.html#ImmInt"><span class="hs-identifier hs-var">ImmInt</span></a><span> </span><span class="hs-number">4</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-129"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="SPARC.Instr.html#SUB"><span class="hs-identifier hs-var">SUB</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621684526546"><span class="hs-identifier hs-var">r1</span></a><span> </span><span class="hs-special">(</span><a href="SPARC.Instr.html#RIReg"><span class="hs-identifier hs-var">RIReg</span></a><span> </span><a href="#local-6989586621684526547"><span class="hs-identifier hs-var">r2</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684526546"><span class="hs-identifier hs-var">r1</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><span>        </span><span class="hs-comment">-- Translate to</span><span>
</span><a name="line-132"></a><span>        </span><span class="hs-comment">--    ld  [addr],%fn</span><span>
</span><a name="line-133"></a><span>        </span><span class="hs-comment">--    ld  [addr+4],%f(n+1)</span><span>
</span><a name="line-134"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="SPARC.Instr.html#ST"><span class="hs-identifier hs-var">ST</span></a><span> </span><a href="Format.html#FF64"><span class="hs-identifier hs-var">FF64</span></a><span> </span><a name="local-6989586621684526548"><a href="#local-6989586621684526548"><span class="hs-identifier">fReg</span></a></a><span> </span><a name="local-6989586621684526549"><a href="#local-6989586621684526549"><span class="hs-identifier">addr</span></a></a><span>                     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684526538"><span class="hs-identifier hs-var">instr</span></a><span>
</span><a name="line-135"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>   </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684526550"><a href="#local-6989586621684526550"><span class="hs-identifier">addr'</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="SPARC.AddrMode.html#addrOffset"><span class="hs-identifier hs-var">addrOffset</span></a><span> </span><a href="#local-6989586621684526549"><span class="hs-identifier hs-var">addr</span></a><span> </span><span class="hs-number">4</span><span>
</span><a name="line-136"></a><span>          </span><span class="hs-keyword">in</span><span>    </span><span class="hs-identifier hs-var">toOL</span><span>    </span><span class="hs-special">[</span><span> </span><a href="SPARC.Instr.html#ST"><span class="hs-identifier hs-var">ST</span></a><span>  </span><a href="Format.html#FF32"><span class="hs-identifier hs-var">FF32</span></a><span>  </span><a href="#local-6989586621684526548"><span class="hs-identifier hs-var">fReg</span></a><span>           </span><a href="#local-6989586621684526549"><span class="hs-identifier hs-var">addr</span></a><span>
</span><a name="line-137"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="SPARC.Instr.html#ST"><span class="hs-identifier hs-var">ST</span></a><span>  </span><a href="Format.html#FF32"><span class="hs-identifier hs-var">FF32</span></a><span>  </span><span class="hs-special">(</span><a href="SPARC.CodeGen.Expand.html#fRegHi"><span class="hs-identifier hs-var">fRegHi</span></a><span> </span><a href="#local-6989586621684526548"><span class="hs-identifier hs-var">fReg</span></a><span class="hs-special">)</span><span>  </span><a href="#local-6989586621684526550"><span class="hs-identifier hs-var">addr'</span></a><span>         </span><span class="hs-special">]</span><span>
</span><a name="line-138"></a><span>
</span><a name="line-139"></a><span>        </span><span class="hs-comment">-- some other instr</span><span>
</span><a name="line-140"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-141"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unitOL</span><span> </span><a href="#local-6989586621684526538"><span class="hs-identifier hs-var">instr</span></a><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span>
</span><a name="line-144"></a><span>
</span><a name="line-145"></a><span class="hs-comment">-- | The high partner for this float reg.</span><span>
</span><a name="line-146"></a><span class="hs-identifier">fRegHi</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Reg.html#Reg"><span class="hs-identifier hs-type">Reg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reg.html#Reg"><span class="hs-identifier hs-type">Reg</span></a><span>
</span><a name="line-147"></a><a name="fRegHi"><a href="SPARC.CodeGen.Expand.html#fRegHi"><span class="hs-identifier">fRegHi</span></a></a><span> </span><span class="hs-special">(</span><a href="Reg.html#RegReal"><span class="hs-identifier hs-var">RegReal</span></a><span> </span><span class="hs-special">(</span><a href="Reg.html#RealRegSingle"><span class="hs-identifier hs-var">RealRegSingle</span></a><span> </span><a name="local-6989586621684526551"><a href="#local-6989586621684526551"><span class="hs-identifier">r1</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-148"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684526551"><span class="hs-identifier hs-var">r1</span></a><span>            </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">32</span><span>
</span><a name="line-149"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684526551"><span class="hs-identifier hs-var">r1</span></a><span>            </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-number">63</span><span>
</span><a name="line-150"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684526551"><span class="hs-identifier hs-var">r1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mod</span><span class="hs-special">`</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-151"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Reg.html#RegReal"><span class="hs-identifier hs-var">RegReal</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Reg.html#RealRegSingle"><span class="hs-identifier hs-var">RealRegSingle</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684526551"><span class="hs-identifier hs-var">r1</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span class="hs-comment">-- Can't take high partner for non-low reg.</span><span>
</span><a name="line-154"></a><span class="hs-identifier">fRegHi</span><span> </span><a name="local-6989586621684526552"><a href="#local-6989586621684526552"><span class="hs-identifier">reg</span></a></a><span>
</span><a name="line-155"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;SPARC.CodeGen.Expand: can't take fRegHi from &quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684526552"><span class="hs-identifier hs-var">reg</span></a><span class="hs-special">)</span><span>
</span><a name="line-156"></a></pre></body></html>