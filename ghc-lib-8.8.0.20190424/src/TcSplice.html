<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998


TcSplice: Template Haskell splices
-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE MagicHash #-}</span><span>
</span><a name="line-12"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-13"></a><span class="hs-pragma">{-# LANGUAGE InstanceSigs #-}</span><span>
</span><a name="line-14"></a><span class="hs-pragma">{-# LANGUAGE GADTs #-}</span><span>
</span><a name="line-15"></a><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><a name="line-16"></a><span class="hs-pragma">{-# LANGUAGE MultiWayIf #-}</span><span>
</span><a name="line-17"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-18"></a><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-orphans #-}</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">TcSplice</span><span class="hs-special">(</span><span>
</span><a name="line-21"></a><span>     </span><a href="TcSplice.html#tcSpliceExpr"><span class="hs-identifier hs-var">tcSpliceExpr</span></a><span class="hs-special">,</span><span> </span><a href="TcSplice.html#tcTypedBracket"><span class="hs-identifier hs-var">tcTypedBracket</span></a><span class="hs-special">,</span><span> </span><a href="TcSplice.html#tcUntypedBracket"><span class="hs-identifier hs-var">tcUntypedBracket</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span class="hs-comment">--     runQuasiQuoteExpr, runQuasiQuotePat,</span><span>
</span><a name="line-23"></a><span class="hs-comment">--     runQuasiQuoteDecl, runQuasiQuoteType,</span><span>
</span><a name="line-24"></a><span>     </span><a href="TcSplice.html#runAnnotation"><span class="hs-identifier hs-var">runAnnotation</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span>     </span><a href="TcSplice.html#runMetaE"><span class="hs-identifier hs-var">runMetaE</span></a><span class="hs-special">,</span><span> </span><a href="TcSplice.html#runMetaP"><span class="hs-identifier hs-var">runMetaP</span></a><span class="hs-special">,</span><span> </span><a href="TcSplice.html#runMetaT"><span class="hs-identifier hs-var">runMetaT</span></a><span class="hs-special">,</span><span> </span><a href="TcSplice.html#runMetaD"><span class="hs-identifier hs-var">runMetaD</span></a><span class="hs-special">,</span><span> </span><a href="TcSplice.html#runQuasi"><span class="hs-identifier hs-var">runQuasi</span></a><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>     </span><a href="TcSplice.html#tcTopSpliceExpr"><span class="hs-identifier hs-var">tcTopSpliceExpr</span></a><span class="hs-special">,</span><span> </span><a href="TcSplice.html#lookupThName_maybe"><span class="hs-identifier hs-var">lookupThName_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>     </span><a href="TcSplice.html#defaultRunMeta"><span class="hs-identifier hs-var">defaultRunMeta</span></a><span class="hs-special">,</span><span> </span><a href="TcSplice.html#runMeta%27"><span class="hs-identifier hs-var">runMeta'</span></a><span class="hs-special">,</span><span> </span><a href="TcSplice.html#runRemoteModFinalizers"><span class="hs-identifier hs-var">runRemoteModFinalizers</span></a><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>     </span><a href="TcSplice.html#finishTH"><span class="hs-identifier hs-var">finishTH</span></a><span class="hs-special">,</span><span> </span><a href="TcSplice.html#runTopSplice"><span class="hs-identifier hs-var">runTopSplice</span></a><span>
</span><a name="line-30"></a><span>      </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Annotations</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="Finder.html"><span class="hs-identifier">Finder</span></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="TcExpr.html"><span class="hs-identifier">TcExpr</span></a><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="THNames.html"><span class="hs-identifier">THNames</span></a><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><a href="TcUnify.html"><span class="hs-identifier">TcUnify</span></a><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><a href="TcEnv.html"><span class="hs-identifier">TcEnv</span></a><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Coercion</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">etaExpandCoAxBranch</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FileCleanup</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">newTempName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TempFileLifetime</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-53"></a><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHCi.Message</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHCi.RemoteTypes</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><a href="GHCi.html"><span class="hs-identifier">GHCi</span></a><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><a href="HscMain.html"><span class="hs-identifier">HscMain</span></a><span>
</span><a name="line-58"></a><span>        </span><span class="hs-comment">-- These imports are the reason that TcSplice</span><span>
</span><a name="line-59"></a><span>        </span><span class="hs-comment">-- is very high up the module hierarchy</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FV</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><a href="RnSplice.html"><span class="hs-identifier">RnSplice</span></a><span class="hs-special">(</span><span> </span><a href="RnSplice.html#traceSplice"><span class="hs-identifier hs-var">traceSplice</span></a><span class="hs-special">,</span><span> </span><a href="RnSplice.html#SpliceInfo"><span class="hs-identifier hs-type">SpliceInfo</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RdrName</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><a href="Convert.html"><span class="hs-identifier">Convert</span></a><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><a href="RnExpr.html"><span class="hs-identifier">RnExpr</span></a><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><a href="RnEnv.html"><span class="hs-identifier">RnEnv</span></a><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><a href="RnUtils.html"><span class="hs-identifier">RnUtils</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="RnUtils.html#HsDocContext"><span class="hs-identifier hs-type">HsDocContext</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><a href="RnFixity.html"><span class="hs-identifier">RnFixity</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="RnFixity.html#lookupFixityRn_help"><span class="hs-identifier hs-var">lookupFixityRn_help</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><a href="RnTypes.html"><span class="hs-identifier">RnTypes</span></a><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><a href="TcHsSyn.html"><span class="hs-identifier">TcHsSyn</span></a><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><a href="TcSimplify.html"><span class="hs-identifier">TcSimplify</span></a><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameSet</span><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span> </span><a href="TcMType.html"><span class="hs-identifier">TcMType</span></a><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><a href="TcHsType.html"><span class="hs-identifier">TcHsType</span></a><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span> </span><a href="TcIface.html"><span class="hs-identifier">TcIface</span></a><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCoRep</span><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span> </span><a href="FamInst.html"><span class="hs-identifier">FamInst</span></a><span>
</span><a name="line-79"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FamInstEnv</span><span>
</span><a name="line-80"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">InstEnv</span><span>
</span><a name="line-81"></a><span class="hs-keyword">import</span><span> </span><a href="Inst.html"><span class="hs-identifier">Inst</span></a><span>
</span><a name="line-82"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameEnv</span><span>
</span><a name="line-83"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span>
</span><a name="line-84"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysWiredIn</span><span>
</span><a name="line-85"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">OccName</span><span>
</span><a name="line-86"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Hooks</span><span>
</span><a name="line-87"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Var</span><span>
</span><a name="line-88"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-89"></a><span class="hs-keyword">import</span><span> </span><a href="LoadIface.html"><span class="hs-identifier">LoadIface</span></a><span>
</span><a name="line-90"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Class</span><span>
</span><a name="line-91"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-92"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoAxiom</span><span>
</span><a name="line-93"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PatSyn</span><span>
</span><a name="line-94"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ConLike</span><span>
</span><a name="line-95"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span>
</span><a name="line-96"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcEvidence</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">TcEvBinds</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-97"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-98"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">IdInfo</span><span>
</span><a name="line-99"></a><span class="hs-keyword">import</span><span> </span><a href="DsExpr.html"><span class="hs-identifier">DsExpr</span></a><span>
</span><a name="line-100"></a><span class="hs-keyword">import</span><span> </span><a href="DsMonad.html"><span class="hs-identifier">DsMonad</span></a><span>
</span><a name="line-101"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.Serialized</span><span>
</span><a name="line-102"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span>
</span><a name="line-103"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-104"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Unique</span><span>
</span><a name="line-105"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarSet</span><span>
</span><a name="line-106"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">find</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-107"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span>
</span><a name="line-108"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-109"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span> </span><span class="hs-keyword">hiding</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">SuccessFlag</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-110"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">MaybeErr</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-111"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-112"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Panic</span><span>
</span><a name="line-113"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Lexeme</span><span>
</span><a name="line-114"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">EnumSet</span><span>
</span><a name="line-115"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Plugins</span><span>
</span><a name="line-116"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Bag</span><span>
</span><a name="line-117"></a><span>
</span><a name="line-118"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language.Haskell.TH</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TH</span><span>
</span><a name="line-119"></a><span class="hs-comment">-- THSyntax gives access to internal functions and data types</span><span>
</span><a name="line-120"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language.Haskell.TH.Syntax</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TH</span><span>
</span><a name="line-121"></a><span>
</span><a name="line-122"></a><span class="hs-comment">-- Because GHC.Desugar might not be in the base library of the bootstrapping compiler</span><span>
</span><a name="line-123"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.Desugar</span><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">AnnotationWrapper</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Exception</span><span>
</span><a name="line-126"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Binary</span><span>
</span><a name="line-127"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Binary.Get</span><span>
</span><a name="line-128"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">B</span><span>
</span><a name="line-129"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString.Lazy</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LB</span><span>
</span><a name="line-130"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Dynamic</span><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">fromDynamic</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">toDyn</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-131"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-132"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Typeable</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">typeOf</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TypeRep</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">typeRep</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-133"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Data</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Data</span><span class="hs-special">)</span><span>
</span><a name="line-134"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Proxy</span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Proxy</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-135"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.Exts</span><span>         </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">unsafeCoerce#</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-136"></a><span>
</span><a name="line-137"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Main interface + stubs for the non-GHCI case
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-144"></a><span>
</span><a name="line-145"></a><span class="hs-identifier">tcTypedBracket</span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsBracket</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span>
</span><a name="line-146"></a><span class="hs-identifier">tcUntypedBracket</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsBracket</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">PendingRnSplice</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span>
</span><a name="line-147"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span>
</span><a name="line-148"></a><span class="hs-identifier">tcSpliceExpr</span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsSplice</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span>
</span><a name="line-149"></a><span>        </span><span class="hs-comment">-- None of these functions add constraints to the LIE</span><span>
</span><a name="line-150"></a><span>
</span><a name="line-151"></a><span class="hs-comment">-- runQuasiQuoteExpr :: HsQuasiQuote RdrName -&gt; RnM (LHsExpr RdrName)</span><span>
</span><a name="line-152"></a><span class="hs-comment">-- runQuasiQuotePat  :: HsQuasiQuote RdrName -&gt; RnM (LPat RdrName)</span><span>
</span><a name="line-153"></a><span class="hs-comment">-- runQuasiQuoteType :: HsQuasiQuote RdrName -&gt; RnM (LHsType RdrName)</span><span>
</span><a name="line-154"></a><span class="hs-comment">-- runQuasiQuoteDecl :: HsQuasiQuote RdrName -&gt; RnM [LHsDecl RdrName]</span><span>
</span><a name="line-155"></a><span>
</span><a name="line-156"></a><span class="hs-identifier">runAnnotation</span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreAnnTarget</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Annotation</span><span>
</span><a name="line-157"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Quoting an expression}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-164"></a><span>
</span><a name="line-165"></a><span class="hs-comment">-- See Note [How brackets and nested splices are handled]</span><span>
</span><a name="line-166"></a><span class="hs-comment">-- tcTypedBracket :: HsBracket Name -&gt; TcRhoType -&gt; TcM (HsExpr TcId)</span><span>
</span><a name="line-167"></a><a name="tcTypedBracket"><a href="TcSplice.html#tcTypedBracket"><span class="hs-identifier">tcTypedBracket</span></a></a><span> </span><a name="local-6989586621685044336"><a href="#local-6989586621685044336"><span class="hs-identifier">rn_expr</span></a></a><span> </span><a name="local-6989586621685044337"><a href="#local-6989586621685044337"><span class="hs-identifier">brack</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">TExpBr</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621685044338"><a href="#local-6989586621685044338"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621685044339"><a href="#local-6989586621685044339"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-168"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcSplice.html#quotationCtxtDoc"><span class="hs-identifier hs-var">quotationCtxtDoc</span></a><span> </span><a href="#local-6989586621685044337"><span class="hs-identifier hs-var">brack</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-169"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044340"><a href="#local-6989586621685044340"><span class="hs-identifier">cur_stage</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getStage"><span class="hs-identifier hs-var">getStage</span></a><span>
</span><a name="line-170"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044341"><a href="#local-6989586621685044341"><span class="hs-identifier">ps_ref</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newMutVar</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-171"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044342"><a href="#local-6989586621685044342"><span class="hs-identifier">lie_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getConstraintVar"><span class="hs-identifier hs-var">getConstraintVar</span></a><span>   </span><span class="hs-comment">-- Any constraints arising from nested splices</span><span>
</span><a name="line-172"></a><span>                                       </span><span class="hs-comment">-- should get thrown into the constraint set</span><span>
</span><a name="line-173"></a><span>                                       </span><span class="hs-comment">-- from outside the bracket</span><span>
</span><a name="line-174"></a><span>
</span><a name="line-175"></a><span>       </span><span class="hs-comment">-- Typecheck expr to make sure it is valid,</span><span>
</span><a name="line-176"></a><span>       </span><span class="hs-comment">-- Throw away the typechecked expression but return its type.</span><span>
</span><a name="line-177"></a><span>       </span><span class="hs-comment">-- We'll typecheck it again when we splice it in somewhere</span><span>
</span><a name="line-178"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685044343"><a href="#local-6989586621685044343"><span class="hs-identifier">_tc_expr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044344"><a href="#local-6989586621685044344"><span class="hs-identifier">expr_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setStage"><span class="hs-identifier hs-var">setStage</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Brack</span><span> </span><a href="#local-6989586621685044340"><span class="hs-identifier hs-var">cur_stage</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TcPending</span><span> </span><a href="#local-6989586621685044341"><span class="hs-identifier hs-var">ps_ref</span></a><span> </span><a href="#local-6989586621685044342"><span class="hs-identifier hs-var">lie_var</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-179"></a><span>                                </span><a href="TcExpr.html#tcInferRhoNC"><span class="hs-identifier hs-var">tcInferRhoNC</span></a><span> </span><a href="#local-6989586621685044338"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-180"></a><span>                                </span><span class="hs-comment">-- NC for no context; tcBracket does that</span><span>
</span><a name="line-181"></a><span>
</span><a name="line-182"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044345"><a href="#local-6989586621685044345"><span class="hs-identifier">meta_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#tcTExpTy"><span class="hs-identifier hs-var">tcTExpTy</span></a><span> </span><a href="#local-6989586621685044344"><span class="hs-identifier hs-var">expr_ty</span></a><span>
</span><a name="line-183"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044346"><a href="#local-6989586621685044346"><span class="hs-identifier">ps'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readMutVar</span><span> </span><a href="#local-6989586621685044341"><span class="hs-identifier hs-var">ps_ref</span></a><span>
</span><a name="line-184"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044347"><a href="#local-6989586621685044347"><span class="hs-identifier">texpco</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupId"><span class="hs-identifier hs-var">tcLookupId</span></a><span> </span><a href="THNames.html#unsafeTExpCoerceName"><span class="hs-identifier hs-var">unsafeTExpCoerceName</span></a><span>
</span><a name="line-185"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcUnify.html#tcWrapResultO"><span class="hs-identifier hs-var">tcWrapResultO</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Shouldn'tHappenOrigin</span><span> </span><span class="hs-string">&quot;TExpBr&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-186"></a><span>                       </span><a href="#local-6989586621685044336"><span class="hs-identifier hs-var">rn_expr</span></a><span>
</span><a name="line-187"></a><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsTyApp</span><span> </span><a href="#local-6989586621685044347"><span class="hs-identifier hs-var">texpco</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621685044344"><span class="hs-identifier hs-var">expr_ty</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-188"></a><span>                                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTcBracketOut</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621685044337"><span class="hs-identifier hs-var">brack</span></a><span> </span><a href="#local-6989586621685044346"><span class="hs-identifier hs-var">ps'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-189"></a><span>                       </span><a href="#local-6989586621685044345"><span class="hs-identifier hs-var">meta_ty</span></a><span> </span><a href="#local-6989586621685044339"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-190"></a><span class="hs-identifier">tcTypedBracket</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621685044348"><a href="#local-6989586621685044348"><span class="hs-identifier">other_brack</span></a></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-191"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;tcTypedBracket&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044348"><span class="hs-identifier hs-var">other_brack</span></a><span class="hs-special">)</span><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span class="hs-comment">-- tcUntypedBracket :: HsBracket Name -&gt; [PendingRnSplice] -&gt; ExpRhoType -&gt; TcM (HsExpr TcId)</span><span>
</span><a name="line-194"></a><a name="tcUntypedBracket"><a href="TcSplice.html#tcUntypedBracket"><span class="hs-identifier">tcUntypedBracket</span></a></a><span> </span><a name="local-6989586621685044349"><a href="#local-6989586621685044349"><span class="hs-identifier">rn_expr</span></a></a><span> </span><a name="local-6989586621685044350"><a href="#local-6989586621685044350"><span class="hs-identifier">brack</span></a></a><span> </span><a name="local-6989586621685044351"><a href="#local-6989586621685044351"><span class="hs-identifier">ps</span></a></a><span> </span><a name="local-6989586621685044352"><a href="#local-6989586621685044352"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-195"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tc_bracket untyped&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044350"><span class="hs-identifier hs-var">brack</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044351"><span class="hs-identifier hs-var">ps</span></a><span class="hs-special">)</span><span>
</span><a name="line-196"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044353"><a href="#local-6989586621685044353"><span class="hs-identifier">ps'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="TcSplice.html#tcPendingSplice"><span class="hs-identifier hs-var">tcPendingSplice</span></a><span> </span><a href="#local-6989586621685044351"><span class="hs-identifier hs-var">ps</span></a><span>
</span><a name="line-197"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044354"><a href="#local-6989586621685044354"><span class="hs-identifier">meta_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#tcBrackTy"><span class="hs-identifier hs-var">tcBrackTy</span></a><span> </span><a href="#local-6989586621685044350"><span class="hs-identifier hs-var">brack</span></a><span>
</span><a name="line-198"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tc_bracket done untyped&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044354"><span class="hs-identifier hs-var">meta_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-199"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcUnify.html#tcWrapResultO"><span class="hs-identifier hs-var">tcWrapResultO</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Shouldn'tHappenOrigin</span><span> </span><span class="hs-string">&quot;untyped bracket&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-200"></a><span>                       </span><a href="#local-6989586621685044349"><span class="hs-identifier hs-var">rn_expr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTcBracketOut</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621685044350"><span class="hs-identifier hs-var">brack</span></a><span> </span><a href="#local-6989586621685044353"><span class="hs-identifier hs-var">ps'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044354"><span class="hs-identifier hs-var">meta_ty</span></a><span> </span><a href="#local-6989586621685044352"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span class="hs-comment">---------------</span><span>
</span><a name="line-203"></a><span class="hs-identifier">tcBrackTy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsBracket</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>
</span><a name="line-204"></a><a name="tcBrackTy"><a href="TcSplice.html#tcBrackTy"><span class="hs-identifier">tcBrackTy</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarBr</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#tcMetaTy"><span class="hs-identifier hs-var">tcMetaTy</span></a><span> </span><a href="THNames.html#nameTyConName"><span class="hs-identifier hs-var">nameTyConName</span></a><span>
</span><a name="line-205"></a><span>                                           </span><span class="hs-comment">-- Result type is Var (not Q-monadic)</span><span>
</span><a name="line-206"></a><span class="hs-identifier">tcBrackTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExpBr</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#tcMetaTy"><span class="hs-identifier hs-var">tcMetaTy</span></a><span> </span><a href="THNames.html#expQTyConName"><span class="hs-identifier hs-var">expQTyConName</span></a><span>  </span><span class="hs-comment">-- Result type is ExpQ (= Q Exp)</span><span>
</span><a name="line-207"></a><span class="hs-identifier">tcBrackTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TypBr</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#tcMetaTy"><span class="hs-identifier hs-var">tcMetaTy</span></a><span> </span><a href="THNames.html#typeQTyConName"><span class="hs-identifier hs-var">typeQTyConName</span></a><span> </span><span class="hs-comment">-- Result type is Type (= Q Typ)</span><span>
</span><a name="line-208"></a><span class="hs-identifier">tcBrackTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DecBrG</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#tcMetaTy"><span class="hs-identifier hs-var">tcMetaTy</span></a><span> </span><a href="THNames.html#decsQTyConName"><span class="hs-identifier hs-var">decsQTyConName</span></a><span> </span><span class="hs-comment">-- Result type is Q [Dec]</span><span>
</span><a name="line-209"></a><span class="hs-identifier">tcBrackTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PatBr</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#tcMetaTy"><span class="hs-identifier hs-var">tcMetaTy</span></a><span> </span><a href="THNames.html#patQTyConName"><span class="hs-identifier hs-var">patQTyConName</span></a><span>  </span><span class="hs-comment">-- Result type is PatQ (= Q Pat)</span><span>
</span><a name="line-210"></a><span class="hs-identifier">tcBrackTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DecBrL</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcBrackTy: Unexpected DecBrL&quot;</span><span>
</span><a name="line-211"></a><span class="hs-identifier">tcBrackTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TExpBr</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcUntypedBracket: Unexpected TExpBr&quot;</span><span>
</span><a name="line-212"></a><span class="hs-identifier">tcBrackTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XBracket</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcUntypedBracket: Unexpected XBracket&quot;</span><span>
</span><a name="line-213"></a><span>
</span><a name="line-214"></a><span class="hs-comment">---------------</span><span>
</span><a name="line-215"></a><span class="hs-identifier">tcPendingSplice</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PendingRnSplice</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">PendingTcSplice</span><span>
</span><a name="line-216"></a><a name="tcPendingSplice"><a href="TcSplice.html#tcPendingSplice"><span class="hs-identifier">tcPendingSplice</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PendingRnSplice</span><span> </span><a name="local-6989586621685044355"><a href="#local-6989586621685044355"><span class="hs-identifier">flavour</span></a></a><span> </span><a name="local-6989586621685044356"><a href="#local-6989586621685044356"><span class="hs-identifier">splice_name</span></a></a><span> </span><a name="local-6989586621685044357"><a href="#local-6989586621685044357"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-217"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044359"><a href="#local-6989586621685044359"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcMetaTy"><span class="hs-identifier hs-var">tcMetaTy</span></a><span> </span><a href="#local-6989586621685044358"><span class="hs-identifier hs-var">meta_ty_name</span></a><span>
</span><a name="line-218"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044360"><a href="#local-6989586621685044360"><span class="hs-identifier">expr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcMonoExpr"><span class="hs-identifier hs-var">tcMonoExpr</span></a><span> </span><a href="#local-6989586621685044357"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621685044359"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-219"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PendingTcSplice</span><span> </span><a href="#local-6989586621685044356"><span class="hs-identifier hs-var">splice_name</span></a><span> </span><a href="#local-6989586621685044360"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-220"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-221"></a><span>     </span><a name="local-6989586621685044358"><a href="#local-6989586621685044358"><span class="hs-identifier">meta_ty_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685044355"><span class="hs-identifier hs-var">flavour</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-222"></a><span>                       </span><span class="hs-identifier hs-var">UntypedExpSplice</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="THNames.html#expQTyConName"><span class="hs-identifier hs-var">expQTyConName</span></a><span>
</span><a name="line-223"></a><span>                       </span><span class="hs-identifier hs-var">UntypedPatSplice</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="THNames.html#patQTyConName"><span class="hs-identifier hs-var">patQTyConName</span></a><span>
</span><a name="line-224"></a><span>                       </span><span class="hs-identifier hs-var">UntypedTypeSplice</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="THNames.html#typeQTyConName"><span class="hs-identifier hs-var">typeQTyConName</span></a><span>
</span><a name="line-225"></a><span>                       </span><span class="hs-identifier hs-var">UntypedDeclSplice</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="THNames.html#decsQTyConName"><span class="hs-identifier hs-var">decsQTyConName</span></a><span>
</span><a name="line-226"></a><span>
</span><a name="line-227"></a><span class="hs-comment">---------------</span><span>
</span><a name="line-228"></a><span class="hs-comment">-- Takes a tau and returns the type Q (TExp tau)</span><span>
</span><a name="line-229"></a><span class="hs-identifier">tcTExpTy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>
</span><a name="line-230"></a><a name="tcTExpTy"><a href="TcSplice.html#tcTExpTy"><span class="hs-identifier">tcTExpTy</span></a></a><span> </span><a name="local-6989586621685044361"><a href="#local-6989586621685044361"><span class="hs-identifier">exp_ty</span></a></a><span>
</span><a name="line-231"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isTauTy</span><span> </span><a href="#local-6989586621685044361"><span class="hs-identifier hs-var">exp_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044362"><span class="hs-identifier hs-var">err_msg</span></a><span> </span><a href="#local-6989586621685044361"><span class="hs-identifier hs-var">exp_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-232"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044364"><a href="#local-6989586621685044364"><span class="hs-identifier">q</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><a href="THNames.html#qTyConName"><span class="hs-identifier hs-var">qTyConName</span></a><span>
</span><a name="line-233"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044365"><a href="#local-6989586621685044365"><span class="hs-identifier">texp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><a href="THNames.html#tExpTyConName"><span class="hs-identifier hs-var">tExpTyConName</span></a><span>
</span><a name="line-234"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621685044364"><span class="hs-identifier hs-var">q</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621685044365"><span class="hs-identifier hs-var">texp</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621685044361"><span class="hs-identifier hs-var">exp_ty</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-235"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-236"></a><span>    </span><a name="local-6989586621685044362"><a href="#local-6989586621685044362"><span class="hs-identifier">err_msg</span></a></a><span> </span><a name="local-6989586621685044363"><a href="#local-6989586621685044363"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-237"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Illegal polytype:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044363"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-238"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The type of a Typed Template Haskell expression must&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-239"></a><span>               </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;not have any quantification.&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-240"></a><span>
</span><a name="line-241"></a><span class="hs-identifier">quotationCtxtDoc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsBracket</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-242"></a><a name="quotationCtxtDoc"><a href="TcSplice.html#quotationCtxtDoc"><span class="hs-identifier">quotationCtxtDoc</span></a></a><span> </span><a name="local-6989586621685044366"><a href="#local-6989586621685044366"><span class="hs-identifier">br_body</span></a></a><span>
</span><a name="line-243"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;In the Template Haskell quotation&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-244"></a><span>         </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044366"><span class="hs-identifier hs-var">br_body</span></a><span class="hs-special">)</span><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span>
</span><a name="line-247"></a><span>  </span><span class="hs-comment">-- The whole of the rest of the file is the else-branch (ie stage2 only)</span><span>
</span><a name="line-248"></a><span>
</span><a name="line-249"></a><span class="hs-comment">{-
Note [How top-level splices are handled]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Top-level splices (those not inside a [| .. |] quotation bracket) are handled
very straightforwardly:

  1. tcTopSpliceExpr: typecheck the body e of the splice $(e)

  2. runMetaT: desugar, compile, run it, and convert result back to
     HsSyn RdrName (of the appropriate flavour, eg HsType RdrName,
     HsExpr RdrName etc)

  3. treat the result as if that's what you saw in the first place
     e.g for HsType, rename and kind-check
         for HsExpr, rename and type-check

     (The last step is different for decls, because they can *only* be
      top-level: we return the result of step 2.)

Note [How brackets and nested splices are handled]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Nested splices (those inside a [| .. |] quotation bracket),
are treated quite differently.

Remember, there are two forms of bracket
         typed   [|| e ||]
   and untyped   [|  e  |]

The life cycle of a typed bracket:
   * Starts as HsBracket

   * When renaming:
        * Set the ThStage to (Brack s RnPendingTyped)
        * Rename the body
        * Result is still a HsBracket

   * When typechecking:
        * Set the ThStage to (Brack s (TcPending ps_var lie_var))
        * Typecheck the body, and throw away the elaborated result
        * Nested splices (which must be typed) are typechecked, and
          the results accumulated in ps_var; their constraints
          accumulate in lie_var
        * Result is a HsTcBracketOut rn_brack pending_splices
          where rn_brack is the incoming renamed bracket

The life cycle of a un-typed bracket:
   * Starts as HsBracket

   * When renaming:
        * Set the ThStage to (Brack s (RnPendingUntyped ps_var))
        * Rename the body
        * Nested splices (which must be untyped) are renamed, and the
          results accumulated in ps_var
        * Result is still (HsRnBracketOut rn_body pending_splices)

   * When typechecking a HsRnBracketOut
        * Typecheck the pending_splices individually
        * Ignore the body of the bracket; just check that the context
          expects a bracket of that type (e.g. a [p| pat |] bracket should
          be in a context needing a (Q Pat)
        * Result is a HsTcBracketOut rn_brack pending_splices
          where rn_brack is the incoming renamed bracket


In both cases, desugaring happens like this:
  * HsTcBracketOut is desugared by DsMeta.dsBracket.  It

      a) Extends the ds_meta environment with the PendingSplices
         attached to the bracket

      b) Converts the quoted (HsExpr Name) to a CoreExpr that, when
         run, will produce a suitable TH expression/type/decl.  This
         is why we leave the *renamed* expression attached to the bracket:
         the quoted expression should not be decorated with all the goop
         added by the type checker

  * Each splice carries a unique Name, called a &quot;splice point&quot;, thus
    ${n}(e).  The name is initialised to an (Unqual &quot;splice&quot;) when the
    splice is created; the renamer gives it a unique.

  * When DsMeta (used to desugar the body of the bracket) comes across
    a splice, it looks up the splice's Name, n, in the ds_meta envt,
    to find an (HsExpr Id) that should be substituted for the splice;
    it just desugars it to get a CoreExpr (DsMeta.repSplice).

Example:
    Source:       f = [| Just $(g 3) |]
      The [| |] part is a HsBracket

    Typechecked:  f = [| Just ${s7}(g 3) |]{s7 = g Int 3}
      The [| |] part is a HsBracketOut, containing *renamed*
        (not typechecked) expression
      The &quot;s7&quot; is the &quot;splice point&quot;; the (g Int 3) part
        is a typechecked expression

    Desugared:    f = do { s7 &lt;- g Int 3
                         ; return (ConE &quot;Data.Maybe.Just&quot; s7) }


Note [Template Haskell state diagram]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Here are the ThStages, s, their corresponding level numbers
(the result of (thLevel s)), and their state transitions.
The top level of the program is stage Comp:

     Start here
         |
         V
      -----------     $      ------------   $
      |  Comp   | ---------&gt; |  Splice  | -----|
      |   1     |            |    0     | &lt;----|
      -----------            ------------
        ^     |                ^      |
      $ |     | [||]         $ |      | [||]
        |     v                |      v
   --------------          ----------------
   | Brack Comp |          | Brack Splice |
   |     2      |          |      1       |
   --------------          ----------------

* Normal top-level declarations start in state Comp
       (which has level 1).
  Annotations start in state Splice, since they are
       treated very like a splice (only without a '$')

* Code compiled in state Splice (and only such code)
  will be *run at compile time*, with the result replacing
  the splice

* The original paper used level -1 instead of 0, etc.

* The original paper did not allow a splice within a
  splice, but there is no reason not to. This is the
  $ transition in the top right.

Note [Template Haskell levels]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
* Imported things are impLevel (= 0)

* However things at level 0 are not *necessarily* imported.
      eg  $( \b -&gt; ... )   here b is bound at level 0

* In GHCi, variables bound by a previous command are treated
  as impLevel, because we have bytecode for them.

* Variables are bound at the &quot;current level&quot;

* The current level starts off at outerLevel (= 1)

* The level is decremented by splicing $(..)
               incremented by brackets [| |]
               incremented by name-quoting 'f

When a variable is used, we compare
        bind:  binding level, and
        use:   current level at usage site

  Generally
        bind &gt; use      Always error (bound later than used)
                        [| \x -&gt; $(f x) |]

        bind = use      Always OK (bound same stage as used)
                        [| \x -&gt; $(f [| x |]) |]

        bind &lt; use      Inside brackets, it depends
                        Inside splice, OK
                        Inside neither, OK

  For (bind &lt; use) inside brackets, there are three cases:
    - Imported things   OK      f = [| map |]
    - Top-level things  OK      g = [| f |]
    - Non-top-level     Only if there is a liftable instance
                                h = \(x:Int) -&gt; [| x |]

  To track top-level-ness we use the ThBindEnv in TcLclEnv

  For example:
           f = ...
           g1 = $(map ...)         is OK
           g2 = $(f ...)           is not OK; because we havn't compiled f yet

-}</span><span>
</span><a name="line-431"></a><span>
</span><a name="line-432"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Splicing an expression}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-439"></a><span>
</span><a name="line-440"></a><a name="tcSpliceExpr"><a href="TcSplice.html#tcSpliceExpr"><span class="hs-identifier">tcSpliceExpr</span></a></a><span> </span><a name="local-6989586621685044367"><a href="#local-6989586621685044367"><span class="hs-identifier">splice</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTypedSplice</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621685044368"><a href="#local-6989586621685044368"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621685044369"><a href="#local-6989586621685044369"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621685044370"><a href="#local-6989586621685044370"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-441"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcSplice.html#spliceCtxtDoc"><span class="hs-identifier hs-var">spliceCtxtDoc</span></a><span> </span><a href="#local-6989586621685044367"><span class="hs-identifier hs-var">splice</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-442"></a><span>    </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getLoc</span><span> </span><a href="#local-6989586621685044369"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>    </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-443"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044371"><a href="#local-6989586621685044371"><span class="hs-identifier">stage</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getStage"><span class="hs-identifier hs-var">getStage</span></a><span>
</span><a name="line-444"></a><span>    </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685044371"><span class="hs-identifier hs-var">stage</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-445"></a><span>          </span><span class="hs-identifier hs-var">Splice</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSplice.html#tcTopSplice"><span class="hs-identifier hs-var">tcTopSplice</span></a><span> </span><a href="#local-6989586621685044369"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621685044370"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-446"></a><span>          </span><span class="hs-identifier hs-var">Brack</span><span> </span><a name="local-6989586621685044372"><a href="#local-6989586621685044372"><span class="hs-identifier">pop_stage</span></a></a><span> </span><a name="local-6989586621685044373"><a href="#local-6989586621685044373"><span class="hs-identifier">pend</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSplice.html#tcNestedSplice"><span class="hs-identifier hs-var">tcNestedSplice</span></a><span> </span><a href="#local-6989586621685044372"><span class="hs-identifier hs-var">pop_stage</span></a><span> </span><a href="#local-6989586621685044373"><span class="hs-identifier hs-var">pend</span></a><span> </span><a href="#local-6989586621685044368"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621685044369"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621685044370"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-447"></a><span>          </span><span class="hs-identifier hs-var">RunSplice</span><span> </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-448"></a><span>            </span><span class="hs-comment">-- See Note [RunSplice ThLevel] in &quot;TcRnTypes&quot;.</span><span>
</span><a name="line-449"></a><span>            </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;tcSpliceExpr: attempted to typecheck a splice when &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-450"></a><span>                      </span><span class="hs-string">&quot;running another splice&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044367"><span class="hs-identifier hs-var">splice</span></a><span class="hs-special">)</span><span>
</span><a name="line-451"></a><span>          </span><span class="hs-identifier hs-var">Comp</span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSplice.html#tcTopSplice"><span class="hs-identifier hs-var">tcTopSplice</span></a><span> </span><a href="#local-6989586621685044369"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621685044370"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-452"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-453"></a><span class="hs-identifier">tcSpliceExpr</span><span> </span><a name="local-6989586621685044374"><a href="#local-6989586621685044374"><span class="hs-identifier">splice</span></a></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-454"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;tcSpliceExpr&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044374"><span class="hs-identifier hs-var">splice</span></a><span class="hs-special">)</span><span>
</span><a name="line-455"></a><span>
</span><a name="line-456"></a><span class="hs-comment">{- Note [Collecting modFinalizers in typed splices]
   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

'qAddModFinalizer' of the @Quasi TcM@ instance adds finalizers in the local
environment (see Note [Delaying modFinalizers in untyped splices] in
&quot;RnSplice&quot;). Thus after executing the splice, we move the finalizers to the
finalizer list in the global environment and set them to use the current local
environment (with 'addModFinalizersWithLclEnv').

-}</span><span>
</span><a name="line-466"></a><span>
</span><a name="line-467"></a><span class="hs-identifier">tcNestedSplice</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ThStage</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PendingStuff</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-468"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span>
</span><a name="line-469"></a><span>    </span><span class="hs-comment">-- See Note [How brackets and nested splices are handled]</span><span>
</span><a name="line-470"></a><span>    </span><span class="hs-comment">-- A splice inside brackets</span><span>
</span><a name="line-471"></a><a name="tcNestedSplice"><a href="TcSplice.html#tcNestedSplice"><span class="hs-identifier">tcNestedSplice</span></a></a><span> </span><a name="local-6989586621685044375"><a href="#local-6989586621685044375"><span class="hs-identifier">pop_stage</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TcPending</span><span> </span><a name="local-6989586621685044376"><a href="#local-6989586621685044376"><span class="hs-identifier">ps_var</span></a></a><span> </span><a name="local-6989586621685044377"><a href="#local-6989586621685044377"><span class="hs-identifier">lie_var</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621685044378"><a href="#local-6989586621685044378"><span class="hs-identifier">splice_name</span></a></a><span> </span><a name="local-6989586621685044379"><a href="#local-6989586621685044379"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621685044380"><a href="#local-6989586621685044380"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-472"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044381"><a href="#local-6989586621685044381"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#expTypeToType"><span class="hs-identifier hs-var">expTypeToType</span></a><span> </span><a href="#local-6989586621685044380"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-473"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044382"><a href="#local-6989586621685044382"><span class="hs-identifier">meta_exp_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#tcTExpTy"><span class="hs-identifier hs-var">tcTExpTy</span></a><span> </span><a href="#local-6989586621685044381"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-474"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044383"><a href="#local-6989586621685044383"><span class="hs-identifier">expr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setStage"><span class="hs-identifier hs-var">setStage</span></a><span> </span><a href="#local-6989586621685044375"><span class="hs-identifier hs-var">pop_stage</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-475"></a><span>                  </span><a href="TcRnMonad.html#setConstraintVar"><span class="hs-identifier hs-var">setConstraintVar</span></a><span> </span><a href="#local-6989586621685044377"><span class="hs-identifier hs-var">lie_var</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-476"></a><span>                  </span><a href="TcExpr.html#tcMonoExpr"><span class="hs-identifier hs-var">tcMonoExpr</span></a><span> </span><a href="#local-6989586621685044379"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621685044382"><span class="hs-identifier hs-var">meta_exp_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-477"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044384"><a href="#local-6989586621685044384"><span class="hs-identifier">untypeq</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupId"><span class="hs-identifier hs-var">tcLookupId</span></a><span> </span><a href="THNames.html#unTypeQName"><span class="hs-identifier hs-var">unTypeQName</span></a><span>
</span><a name="line-478"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044385"><a href="#local-6989586621685044385"><span class="hs-identifier">expr''</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkHsApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsTyApp</span><span> </span><a href="#local-6989586621685044384"><span class="hs-identifier hs-var">untypeq</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621685044381"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044383"><span class="hs-identifier hs-var">expr'</span></a><span>
</span><a name="line-479"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044386"><a href="#local-6989586621685044386"><span class="hs-identifier">ps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readMutVar</span><span> </span><a href="#local-6989586621685044376"><span class="hs-identifier hs-var">ps_var</span></a><span>
</span><a name="line-480"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">writeMutVar</span><span> </span><a href="#local-6989586621685044376"><span class="hs-identifier hs-var">ps_var</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PendingTcSplice</span><span> </span><a href="#local-6989586621685044378"><span class="hs-identifier hs-var">splice_name</span></a><span> </span><a href="#local-6989586621685044385"><span class="hs-identifier hs-var">expr''</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621685044386"><span class="hs-identifier hs-var">ps</span></a><span class="hs-special">)</span><span>
</span><a name="line-481"></a><span>
</span><a name="line-482"></a><span>       </span><span class="hs-comment">-- The returned expression is ignored; it's in the pending splices</span><span>
</span><a name="line-483"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcSpliceExpr&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-484"></a><span>
</span><a name="line-485"></a><span class="hs-identifier">tcNestedSplice</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621685044387"><a href="#local-6989586621685044387"><span class="hs-identifier">splice_name</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-486"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;tcNestedSplice: rename stage found&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044387"><span class="hs-identifier hs-var">splice_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-487"></a><span>
</span><a name="line-488"></a><span class="hs-identifier">tcTopSplice</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpRhoType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span>
</span><a name="line-489"></a><a name="tcTopSplice"><a href="TcSplice.html#tcTopSplice"><span class="hs-identifier">tcTopSplice</span></a></a><span> </span><a name="local-6989586621685044388"><a href="#local-6989586621685044388"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621685044389"><a href="#local-6989586621685044389"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-490"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Typecheck the expression,</span><span>
</span><a name="line-491"></a><span>         </span><span class="hs-comment">-- making sure it has type Q (T res_ty)</span><span>
</span><a name="line-492"></a><span>         </span><a name="local-6989586621685044390"><a href="#local-6989586621685044390"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#expTypeToType"><span class="hs-identifier hs-var">expTypeToType</span></a><span> </span><a href="#local-6989586621685044389"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-493"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044391"><a href="#local-6989586621685044391"><span class="hs-identifier">meta_exp_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#tcTExpTy"><span class="hs-identifier hs-var">tcTExpTy</span></a><span> </span><a href="#local-6989586621685044390"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-494"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044392"><a href="#local-6989586621685044392"><span class="hs-identifier">q_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#tcTopSpliceExpr"><span class="hs-identifier hs-var">tcTopSpliceExpr</span></a><span> </span><span class="hs-identifier hs-var">Typed</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-495"></a><span>                          </span><a href="TcExpr.html#tcMonoExpr"><span class="hs-identifier hs-var">tcMonoExpr</span></a><span> </span><a href="#local-6989586621685044388"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621685044391"><span class="hs-identifier hs-var">meta_exp_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-496"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044393"><a href="#local-6989586621685044393"><span class="hs-identifier">lcl_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span>
</span><a name="line-497"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044394"><a href="#local-6989586621685044394"><span class="hs-identifier">delayed_splice</span></a></a><span>
</span><a name="line-498"></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DelayedSplice</span><span> </span><a href="#local-6989586621685044393"><span class="hs-identifier hs-var">lcl_env</span></a><span> </span><a href="#local-6989586621685044388"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621685044390"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><a href="#local-6989586621685044392"><span class="hs-identifier hs-var">q_expr</span></a><span>
</span><a name="line-499"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSpliceE</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSplicedT</span><span> </span><a href="#local-6989586621685044394"><span class="hs-identifier hs-var">delayed_splice</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-500"></a><span>
</span><a name="line-501"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-502"></a><span>
</span><a name="line-503"></a><span>
</span><a name="line-504"></a><span class="hs-comment">-- This is called in the zonker</span><span>
</span><a name="line-505"></a><span class="hs-comment">-- See Note [Running typed splices in the zonker]</span><span>
</span><a name="line-506"></a><span class="hs-identifier">runTopSplice</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DelayedSplice</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span>
</span><a name="line-507"></a><a name="runTopSplice"><a href="TcSplice.html#runTopSplice"><span class="hs-identifier">runTopSplice</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DelayedSplice</span><span> </span><a name="local-6989586621685044395"><a href="#local-6989586621685044395"><span class="hs-identifier">lcl_env</span></a></a><span> </span><a name="local-6989586621685044396"><a href="#local-6989586621685044396"><span class="hs-identifier">orig_expr</span></a></a><span> </span><a name="local-6989586621685044397"><a href="#local-6989586621685044397"><span class="hs-identifier">res_ty</span></a></a><span> </span><a name="local-6989586621685044398"><a href="#local-6989586621685044398"><span class="hs-identifier">q_expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-508"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setLclEnv"><span class="hs-identifier hs-var">setLclEnv</span></a><span> </span><a href="#local-6989586621685044395"><span class="hs-identifier hs-var">lcl_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-509"></a><span>         </span><a name="local-6989586621685044399"><a href="#local-6989586621685044399"><span class="hs-identifier">zonked_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><a href="#local-6989586621685044397"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-510"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044400"><a href="#local-6989586621685044400"><span class="hs-identifier">zonked_q_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTopLExpr"><span class="hs-identifier hs-var">zonkTopLExpr</span></a><span> </span><a href="#local-6989586621685044398"><span class="hs-identifier hs-var">q_expr</span></a><span>
</span><a name="line-511"></a><span>        </span><span class="hs-comment">-- See Note [Collecting modFinalizers in typed splices].</span><span>
</span><a name="line-512"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044401"><a href="#local-6989586621685044401"><span class="hs-identifier">modfinalizers_ref</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newTcRef"><span class="hs-identifier hs-var">newTcRef</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-513"></a><span>         </span><span class="hs-comment">-- Run the expression</span><span>
</span><a name="line-514"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044402"><a href="#local-6989586621685044402"><span class="hs-identifier">expr2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setStage"><span class="hs-identifier hs-var">setStage</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RunSplice</span><span> </span><a href="#local-6989586621685044401"><span class="hs-identifier hs-var">modfinalizers_ref</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-515"></a><span>                    </span><a href="TcSplice.html#runMetaE"><span class="hs-identifier hs-var">runMetaE</span></a><span> </span><a href="#local-6989586621685044400"><span class="hs-identifier hs-var">zonked_q_expr</span></a><span>
</span><a name="line-516"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044403"><a href="#local-6989586621685044403"><span class="hs-identifier">mod_finalizers</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-6989586621685044401"><span class="hs-identifier hs-var">modfinalizers_ref</span></a><span>
</span><a name="line-517"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#addModFinalizersWithLclEnv"><span class="hs-identifier hs-var">addModFinalizersWithLclEnv</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ThModFinalizers</span><span> </span><a href="#local-6989586621685044403"><span class="hs-identifier hs-var">mod_finalizers</span></a><span>
</span><a name="line-518"></a><span>       </span><span class="hs-comment">-- We use orig_expr here and not q_expr when tracing as a call to</span><span>
</span><a name="line-519"></a><span>       </span><span class="hs-comment">-- unsafeTExpCoerce is added to the original expression by the</span><span>
</span><a name="line-520"></a><span>       </span><span class="hs-comment">-- typechecker when typed quotes are type checked.</span><span>
</span><a name="line-521"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="RnSplice.html#traceSplice"><span class="hs-identifier hs-var">traceSplice</span></a><span> </span><span class="hs-special">(</span><a href="RnSplice.html#SpliceInfo"><span class="hs-identifier hs-var">SpliceInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">spliceDescription</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;expression&quot;</span><span>
</span><a name="line-522"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">spliceIsDecl</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-523"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">spliceSource</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685044396"><span class="hs-identifier hs-var">orig_expr</span></a><span>
</span><a name="line-524"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">spliceGenerated</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044402"><span class="hs-identifier hs-var">expr2</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-525"></a><span>        </span><span class="hs-comment">-- Rename and typecheck the spliced-in expression,</span><span>
</span><a name="line-526"></a><span>        </span><span class="hs-comment">-- making sure it has type res_ty</span><span>
</span><a name="line-527"></a><span>        </span><span class="hs-comment">-- These steps should never fail; this is a *typed* splice</span><span>
</span><a name="line-528"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685044406"><a href="#local-6989586621685044406"><span class="hs-identifier">res</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044407"><a href="#local-6989586621685044407"><span class="hs-identifier">wcs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-529"></a><span>            </span><a href="TcRnMonad.html#captureConstraints"><span class="hs-identifier hs-var">captureConstraints</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-530"></a><span>              </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcSplice.html#spliceResultDoc"><span class="hs-identifier hs-var">spliceResultDoc</span></a><span> </span><a href="#local-6989586621685044400"><span class="hs-identifier hs-var">zonked_q_expr</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-531"></a><span>                </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685044404"><a href="#local-6989586621685044404"><span class="hs-identifier">exp3</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044405"><a href="#local-6989586621685044405"><span class="hs-identifier">_fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621685044402"><span class="hs-identifier hs-var">expr2</span></a><span>
</span><a name="line-532"></a><span>                </span><span class="hs-special">;</span><span> </span><a href="TcExpr.html#tcMonoExpr"><span class="hs-identifier hs-var">tcMonoExpr</span></a><span> </span><a href="#local-6989586621685044404"><span class="hs-identifier hs-var">exp3</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621685044399"><span class="hs-identifier hs-var">zonked_ty</span></a><span class="hs-special">)</span><span class="hs-special">}</span><span>
</span><a name="line-533"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044408"><a href="#local-6989586621685044408"><span class="hs-identifier">ev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#simplifyTop"><span class="hs-identifier hs-var">simplifyTop</span></a><span> </span><a href="#local-6989586621685044407"><span class="hs-identifier hs-var">wcs</span></a><span>
</span><a name="line-534"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsDictLet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvBinds</span><span> </span><a href="#local-6989586621685044408"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044406"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span>
</span><a name="line-535"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-536"></a><span>
</span><a name="line-537"></a><span>
</span><a name="line-538"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Error messages}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-545"></a><span>
</span><a name="line-546"></a><span class="hs-identifier">spliceCtxtDoc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsSplice</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-547"></a><a name="spliceCtxtDoc"><a href="TcSplice.html#spliceCtxtDoc"><span class="hs-identifier">spliceCtxtDoc</span></a></a><span> </span><a name="local-6989586621685044409"><a href="#local-6989586621685044409"><span class="hs-identifier">splice</span></a></a><span>
</span><a name="line-548"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;In the Template Haskell splice&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-549"></a><span>         </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprSplice</span><span> </span><a href="#local-6989586621685044409"><span class="hs-identifier hs-var">splice</span></a><span class="hs-special">)</span><span>
</span><a name="line-550"></a><span>
</span><a name="line-551"></a><span class="hs-identifier">spliceResultDoc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-552"></a><a name="spliceResultDoc"><a href="TcSplice.html#spliceResultDoc"><span class="hs-identifier">spliceResultDoc</span></a></a><span> </span><a name="local-6989586621685044410"><a href="#local-6989586621685044410"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-553"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;In the result of the splice:&quot;</span><span>
</span><a name="line-554"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">'$'</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044410"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-555"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;To see what the splice expanded to, use -ddump-splices&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-556"></a><span>
</span><a name="line-557"></a><span class="hs-comment">-------------------</span><span>
</span><a name="line-558"></a><span class="hs-identifier">tcTopSpliceExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SpliceType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span>
</span><a name="line-559"></a><span class="hs-comment">-- Note [How top-level splices are handled]</span><span>
</span><a name="line-560"></a><span class="hs-comment">-- Type check an expression that is the body of a top-level splice</span><span>
</span><a name="line-561"></a><span class="hs-comment">--   (the caller will compile and run it)</span><span>
</span><a name="line-562"></a><span class="hs-comment">-- Note that set the level to Splice, regardless of the original level,</span><span>
</span><a name="line-563"></a><span class="hs-comment">-- before typechecking the expression.  For example:</span><span>
</span><a name="line-564"></a><span class="hs-comment">--      f x = $( ...$(g 3) ... )</span><span>
</span><a name="line-565"></a><span class="hs-comment">-- The recursive call to tcPolyExpr will simply expand the</span><span>
</span><a name="line-566"></a><span class="hs-comment">-- inner escape before dealing with the outer one</span><span>
</span><a name="line-567"></a><span>
</span><a name="line-568"></a><a name="tcTopSpliceExpr"><a href="TcSplice.html#tcTopSpliceExpr"><span class="hs-identifier">tcTopSpliceExpr</span></a></a><span> </span><a name="local-6989586621685044411"><a href="#local-6989586621685044411"><span class="hs-identifier">isTypedSplice</span></a></a><span> </span><a name="local-6989586621685044412"><a href="#local-6989586621685044412"><span class="hs-identifier">tc_action</span></a></a><span>
</span><a name="line-569"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>  </span><span class="hs-comment">-- checkNoErrs: must not try to run the thing</span><span>
</span><a name="line-570"></a><span>                   </span><span class="hs-comment">-- if the type checker fails!</span><span>
</span><a name="line-571"></a><span>    </span><a href="TcRnMonad.html#unsetGOptM"><span class="hs-identifier hs-var">unsetGOptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_DeferTypeErrors</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-572"></a><span>                   </span><span class="hs-comment">-- Don't defer type errors.  Not only are we</span><span>
</span><a name="line-573"></a><span>                   </span><span class="hs-comment">-- going to run this code, but we do an unsafe</span><span>
</span><a name="line-574"></a><span>                   </span><span class="hs-comment">-- coerce, so we get a seg-fault if, say we</span><span>
</span><a name="line-575"></a><span>                   </span><span class="hs-comment">-- splice a type into a place where an expression</span><span>
</span><a name="line-576"></a><span>                   </span><span class="hs-comment">-- is expected (Trac #7276)</span><span>
</span><a name="line-577"></a><span>    </span><a href="TcRnMonad.html#setStage"><span class="hs-identifier hs-var">setStage</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Splice</span><span> </span><a href="#local-6989586621685044411"><span class="hs-identifier hs-var">isTypedSplice</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-578"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>    </span><span class="hs-comment">-- Typecheck the expression</span><span>
</span><a name="line-579"></a><span>         </span><span class="hs-special">(</span><a name="local-6989586621685044413"><a href="#local-6989586621685044413"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044414"><a href="#local-6989586621685044414"><span class="hs-identifier">wanted</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#captureConstraints"><span class="hs-identifier hs-var">captureConstraints</span></a><span> </span><a href="#local-6989586621685044412"><span class="hs-identifier hs-var">tc_action</span></a><span>
</span><a name="line-580"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044415"><a href="#local-6989586621685044415"><span class="hs-identifier">const_binds</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#simplifyTop"><span class="hs-identifier hs-var">simplifyTop</span></a><span> </span><a href="#local-6989586621685044414"><span class="hs-identifier hs-var">wanted</span></a><span>
</span><a name="line-581"></a><span>
</span><a name="line-582"></a><span>          </span><span class="hs-comment">-- Zonk it and tie the knot of dictionary bindings</span><span>
</span><a name="line-583"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkHsDictLet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvBinds</span><span> </span><a href="#local-6989586621685044415"><span class="hs-identifier hs-var">const_binds</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044413"><span class="hs-identifier hs-var">expr'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-584"></a><span>
</span><a name="line-585"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Annotations
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-592"></a><span>
</span><a name="line-593"></a><a name="runAnnotation"><a href="TcSplice.html#runAnnotation"><span class="hs-identifier">runAnnotation</span></a></a><span> </span><a name="local-6989586621685044416"><a href="#local-6989586621685044416"><span class="hs-identifier">target</span></a></a><span> </span><a name="local-6989586621685044417"><a href="#local-6989586621685044417"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-594"></a><span>    </span><span class="hs-comment">-- Find the classes we want instances for in order to call toAnnotationWrapper</span><span>
</span><a name="line-595"></a><span>    </span><a name="local-6989586621685044418"><a href="#local-6989586621685044418"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span>
</span><a name="line-596"></a><span>    </span><a name="local-6989586621685044419"><a href="#local-6989586621685044419"><span class="hs-identifier">data_class</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupClass"><span class="hs-identifier hs-var">tcLookupClass</span></a><span> </span><span class="hs-identifier hs-var">dataClassName</span><span>
</span><a name="line-597"></a><span>    </span><a name="local-6989586621685044420"><a href="#local-6989586621685044420"><span class="hs-identifier">to_annotation_wrapper_id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupId"><span class="hs-identifier hs-var">tcLookupId</span></a><span> </span><span class="hs-identifier hs-var">toAnnotationWrapperName</span><span>
</span><a name="line-598"></a><span>
</span><a name="line-599"></a><span>    </span><span class="hs-comment">-- Check the instances we require live in another module (we want to execute it..)</span><span>
</span><a name="line-600"></a><span>    </span><span class="hs-comment">-- and check identifiers live in other modules using TH stage checks. tcSimplifyStagedExpr</span><span>
</span><a name="line-601"></a><span>    </span><span class="hs-comment">-- also resolves the LIE constraints to detect e.g. instance ambiguity</span><span>
</span><a name="line-602"></a><span>    </span><a name="local-6989586621685044425"><a href="#local-6989586621685044425"><span class="hs-identifier">zonked_wrapped_expr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTopLExpr"><span class="hs-identifier hs-var">zonkTopLExpr</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="TcSplice.html#tcTopSpliceExpr"><span class="hs-identifier hs-var">tcTopSpliceExpr</span></a><span> </span><span class="hs-identifier hs-var">Untyped</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-603"></a><span>           </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685044421"><a href="#local-6989586621685044421"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044422"><a href="#local-6989586621685044422"><span class="hs-identifier">expr_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcInferRhoNC"><span class="hs-identifier hs-var">tcInferRhoNC</span></a><span> </span><a href="#local-6989586621685044417"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-604"></a><span>                </span><span class="hs-comment">-- We manually wrap the typechecked expression in a call to toAnnotationWrapper</span><span>
</span><a name="line-605"></a><span>                </span><span class="hs-comment">-- By instantiating the call &gt;here&lt; it gets registered in the</span><span>
</span><a name="line-606"></a><span>                </span><span class="hs-comment">-- LIE consulted by tcTopSpliceExpr</span><span>
</span><a name="line-607"></a><span>                </span><span class="hs-comment">-- and hence ensures the appropriate dictionary is bound by const_binds</span><span>
</span><a name="line-608"></a><span>              </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044423"><a href="#local-6989586621685044423"><span class="hs-identifier">wrapper</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#instCall"><span class="hs-identifier hs-var">instCall</span></a><span> </span><span class="hs-identifier hs-var">AnnOrigin</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621685044422"><span class="hs-identifier hs-var">expr_ty</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">mkClassPred</span><span> </span><a href="#local-6989586621685044419"><span class="hs-identifier hs-var">data_class</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621685044422"><span class="hs-identifier hs-var">expr_ty</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-609"></a><span>              </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044424"><a href="#local-6989586621685044424"><span class="hs-identifier">specialised_to_annotation_wrapper_expr</span></a></a><span>
</span><a name="line-610"></a><span>                      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621685044418"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><a href="#local-6989586621685044423"><span class="hs-identifier hs-var">wrapper</span></a><span>
</span><a name="line-611"></a><span>                                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621685044418"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621685044420"><span class="hs-identifier hs-var">to_annotation_wrapper_id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-612"></a><span>              </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621685044418"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsApp</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-613"></a><span>                                </span><a href="#local-6989586621685044424"><span class="hs-identifier hs-var">specialised_to_annotation_wrapper_expr</span></a><span> </span><a href="#local-6989586621685044421"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-614"></a><span>                                </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-615"></a><span>
</span><a name="line-616"></a><span>    </span><span class="hs-comment">-- Run the appropriately wrapped expression to get the value of</span><span>
</span><a name="line-617"></a><span>    </span><span class="hs-comment">-- the annotation and its dictionaries. The return value is of</span><span>
</span><a name="line-618"></a><span>    </span><span class="hs-comment">-- type AnnotationWrapper by construction, so this conversion is</span><span>
</span><a name="line-619"></a><span>    </span><span class="hs-comment">-- safe</span><span>
</span><a name="line-620"></a><span>    </span><a name="local-6989586621685044426"><a href="#local-6989586621685044426"><span class="hs-identifier">serialized</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#runMetaAW"><span class="hs-identifier hs-var">runMetaAW</span></a><span> </span><a href="#local-6989586621685044425"><span class="hs-identifier hs-var">zonked_wrapped_expr'</span></a><span>
</span><a name="line-621"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Annotation</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-622"></a><span>               </span><span class="hs-identifier">ann_target</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685044416"><span class="hs-identifier hs-var">target</span></a><span class="hs-special">,</span><span>
</span><a name="line-623"></a><span>               </span><span class="hs-identifier">ann_value</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685044426"><span class="hs-identifier hs-var">serialized</span></a><span>
</span><a name="line-624"></a><span>           </span><span class="hs-special">}</span><span>
</span><a name="line-625"></a><span>
</span><a name="line-626"></a><span class="hs-identifier">convertAnnotationWrapper</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-identifier hs-type">Serialized</span><span class="hs-special">)</span><span>
</span><a name="line-627"></a><a name="convertAnnotationWrapper"><a href="TcSplice.html#convertAnnotationWrapper"><span class="hs-identifier">convertAnnotationWrapper</span></a></a><span> </span><a name="local-6989586621685044427"><a href="#local-6989586621685044427"><span class="hs-identifier">fhv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-628"></a><span>  </span><a name="local-6989586621685044428"><a href="#local-6989586621685044428"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-629"></a><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_ExternalInterpreter</span><span> </span><a href="#local-6989586621685044428"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-630"></a><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-631"></a><span>      </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcSplice.html#runTH"><span class="hs-identifier hs-var">runTH</span></a><span> </span><span class="hs-identifier hs-var">THAnnWrapper</span><span> </span><a href="#local-6989586621685044427"><span class="hs-identifier hs-var">fhv</span></a><span>
</span><a name="line-632"></a><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-633"></a><span>      </span><a name="local-6989586621685044429"><a href="#local-6989586621685044429"><span class="hs-identifier">annotation_wrapper</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GHCi.html#wormhole"><span class="hs-identifier hs-var">wormhole</span></a><span> </span><a href="#local-6989586621685044428"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685044427"><span class="hs-identifier hs-var">fhv</span></a><span>
</span><a name="line-634"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-635"></a><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">unsafeCoerce#</span><span> </span><a href="#local-6989586621685044429"><span class="hs-identifier hs-var">annotation_wrapper</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-636"></a><span>           </span><span class="hs-identifier hs-var">AnnotationWrapper</span><span> </span><a name="local-6989586621685044430"><a href="#local-6989586621685044430"><span class="hs-identifier">value</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044431"><a href="#local-6989586621685044431"><span class="hs-identifier">serialized</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toSerialized</span><span> </span><span class="hs-identifier hs-var">serializeWithData</span><span> </span><a href="#local-6989586621685044430"><span class="hs-identifier hs-var">value</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-637"></a><span>               </span><span class="hs-comment">-- Got the value and dictionaries: build the serialized value and</span><span>
</span><a name="line-638"></a><span>               </span><span class="hs-comment">-- call it a day. We ensure that we seq the entire serialized value</span><span>
</span><a name="line-639"></a><span>               </span><span class="hs-comment">-- in order that any errors in the user-written code for the</span><span>
</span><a name="line-640"></a><span>               </span><span class="hs-comment">-- annotation are exposed at this point.  This is also why we are</span><span>
</span><a name="line-641"></a><span>               </span><span class="hs-comment">-- doing all this stuff inside the context of runMeta: it has the</span><span>
</span><a name="line-642"></a><span>               </span><span class="hs-comment">-- facilities to deal with user error in a meta-level expression</span><span>
</span><a name="line-643"></a><span>               </span><a href="TcSplice.html#seqSerialized"><span class="hs-identifier hs-var">seqSerialized</span></a><span> </span><a href="#local-6989586621685044431"><span class="hs-identifier hs-var">serialized</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685044431"><span class="hs-identifier hs-var">serialized</span></a><span>
</span><a name="line-644"></a><span>
</span><a name="line-645"></a><span class="hs-comment">-- | Force the contents of the Serialized value so weknow it doesn't contain any bottoms</span><span>
</span><a name="line-646"></a><span class="hs-identifier">seqSerialized</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Serialized</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-647"></a><a name="seqSerialized"><a href="TcSplice.html#seqSerialized"><span class="hs-identifier">seqSerialized</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Serialized</span><span> </span><a name="local-6989586621685044432"><a href="#local-6989586621685044432"><span class="hs-identifier">the_type</span></a></a><span> </span><a name="local-6989586621685044433"><a href="#local-6989586621685044433"><span class="hs-identifier">bytes</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685044432"><span class="hs-identifier hs-var">the_type</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685044433"><span class="hs-identifier hs-var">bytes</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seqList</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-648"></a><span>
</span><a name="line-649"></a><span>
</span><a name="line-650"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Running an expression}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-657"></a><span>
</span><a name="line-658"></a><span class="hs-identifier">runQuasi</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.Q</span><span> </span><a href="#local-6989586621685044335"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621685044335"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-659"></a><a name="runQuasi"><a href="TcSplice.html#runQuasi"><span class="hs-identifier">runQuasi</span></a></a><span> </span><a name="local-6989586621685044434"><a href="#local-6989586621685044434"><span class="hs-identifier">act</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.runQ</span><span> </span><a href="#local-6989586621685044434"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-660"></a><span>
</span><a name="line-661"></a><span class="hs-identifier">runRemoteModFinalizers</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ThModFinalizers</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-662"></a><a name="runRemoteModFinalizers"><a href="TcSplice.html#runRemoteModFinalizers"><span class="hs-identifier">runRemoteModFinalizers</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ThModFinalizers</span><span> </span><a name="local-6989586621685044435"><a href="#local-6989586621685044435"><span class="hs-identifier">finRefs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-663"></a><span>  </span><a name="local-6989586621685044436"><a href="#local-6989586621685044436"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-664"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044437"><a href="#local-6989586621685044437"><span class="hs-identifier">withForeignRefs</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621685044438"><a href="#local-6989586621685044438"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685044438"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-665"></a><span>      </span><span class="hs-identifier">withForeignRefs</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685044439"><a href="#local-6989586621685044439"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621685044440"><a href="#local-6989586621685044440"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621685044441"><a href="#local-6989586621685044441"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withForeignRef</span><span> </span><a href="#local-6989586621685044439"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685044442"><a href="#local-6989586621685044442"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-666"></a><span>        </span><a href="#local-6989586621685044437"><span class="hs-identifier hs-var">withForeignRefs</span></a><span> </span><a href="#local-6989586621685044440"><span class="hs-identifier hs-var">xs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685044443"><a href="#local-6989586621685044443"><span class="hs-identifier">rs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685044441"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044442"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621685044443"><span class="hs-identifier hs-var">rs</span></a><span class="hs-special">)</span><span>
</span><a name="line-667"></a><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_ExternalInterpreter</span><span> </span><a href="#local-6989586621685044436"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-668"></a><span>    </span><a name="local-6989586621685044444"><a href="#local-6989586621685044444"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">env_top</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">getEnv</span><span>
</span><a name="line-669"></a><span>    </span><a href="GHCi.html#withIServ"><span class="hs-identifier hs-var">withIServ</span></a><span> </span><a href="#local-6989586621685044444"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685044445"><a href="#local-6989586621685044445"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-670"></a><span>      </span><a name="local-6989586621685044446"><a href="#local-6989586621685044446"><span class="hs-identifier">tcg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-671"></a><span>      </span><a name="local-6989586621685044447"><a href="#local-6989586621685044447"><span class="hs-identifier">th_state</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_th_remote_state</span><span> </span><a href="#local-6989586621685044446"><span class="hs-identifier hs-var">tcg</span></a><span class="hs-special">)</span><span>
</span><a name="line-672"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685044447"><span class="hs-identifier hs-var">th_state</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-673"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- TH was not started, nothing to do</span><span>
</span><a name="line-674"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685044448"><a href="#local-6989586621685044448"><span class="hs-identifier">fhv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-675"></a><span>          </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">withForeignRef</span><span> </span><a href="#local-6989586621685044448"><span class="hs-identifier hs-var">fhv</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685044449"><a href="#local-6989586621685044449"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-676"></a><span>            </span><a href="#local-6989586621685044437"><span class="hs-identifier hs-var">withForeignRefs</span></a><span> </span><a href="#local-6989586621685044435"><span class="hs-identifier hs-var">finRefs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685044450"><a href="#local-6989586621685044450"><span class="hs-identifier">qrefs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-677"></a><span>              </span><a href="GHCi.html#writeIServ"><span class="hs-identifier hs-var">writeIServ</span></a><span> </span><a href="#local-6989586621685044445"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">putMessage</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RunModFinalizers</span><span> </span><a href="#local-6989586621685044449"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="#local-6989586621685044450"><span class="hs-identifier hs-var">qrefs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-678"></a><span>          </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#runRemoteTH"><span class="hs-identifier hs-var">runRemoteTH</span></a><span> </span><a href="#local-6989586621685044445"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-679"></a><span>          </span><a href="TcSplice.html#readQResult"><span class="hs-identifier hs-var">readQResult</span></a><span> </span><a href="#local-6989586621685044445"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-680"></a><span>  </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-681"></a><span>    </span><a name="local-6989586621685044451"><a href="#local-6989586621685044451"><span class="hs-identifier">qs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044437"><span class="hs-identifier hs-var">withForeignRefs</span></a><span> </span><a href="#local-6989586621685044435"><span class="hs-identifier hs-var">finRefs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-identifier hs-var">localRef</span><span class="hs-special">)</span><span>
</span><a name="line-682"></a><span>    </span><a href="TcSplice.html#runQuasi"><span class="hs-identifier hs-var">runQuasi</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">sequence_</span><span> </span><a href="#local-6989586621685044451"><span class="hs-identifier hs-var">qs</span></a><span>
</span><a name="line-683"></a><span>
</span><a name="line-684"></a><span class="hs-identifier">runQResult</span><span>
</span><a name="line-685"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044333"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span>
</span><a name="line-686"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685044333"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685044334"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-687"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ForeignHValue</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621685044333"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-688"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span>
</span><a name="line-689"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span> </span><span class="hs-comment">{- TH.Q a -}</span><span>
</span><a name="line-690"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621685044334"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-691"></a><a name="runQResult"><a href="TcSplice.html#runQResult"><span class="hs-identifier">runQResult</span></a></a><span> </span><a name="local-6989586621685044452"><a href="#local-6989586621685044452"><span class="hs-identifier">show_th</span></a></a><span> </span><a name="local-6989586621685044453"><a href="#local-6989586621685044453"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621685044454"><a href="#local-6989586621685044454"><span class="hs-identifier">runQ</span></a></a><span> </span><a name="local-6989586621685044455"><a href="#local-6989586621685044455"><span class="hs-identifier">expr_span</span></a></a><span> </span><a name="local-6989586621685044456"><a href="#local-6989586621685044456"><span class="hs-identifier">hval</span></a></a><span>
</span><a name="line-692"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044457"><a href="#local-6989586621685044457"><span class="hs-identifier">th_result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685044454"><span class="hs-identifier hs-var">runQ</span></a><span> </span><a href="#local-6989586621685044456"><span class="hs-identifier hs-var">hval</span></a><span>
</span><a name="line-693"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Got TH result:&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044452"><span class="hs-identifier hs-var">show_th</span></a><span> </span><a href="#local-6989586621685044457"><span class="hs-identifier hs-var">th_result</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-694"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044453"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621685044455"><span class="hs-identifier hs-var">expr_span</span></a><span> </span><a href="#local-6989586621685044457"><span class="hs-identifier hs-var">th_result</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-695"></a><span>
</span><a name="line-696"></a><span>
</span><a name="line-697"></a><span class="hs-comment">-----------------</span><span>
</span><a name="line-698"></a><span class="hs-identifier">runMeta</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MetaHook</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621685044332"><span class="hs-identifier hs-type">hs_syn</span></a><span class="hs-special">)</span><span>
</span><a name="line-699"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-700"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621685044332"><span class="hs-identifier hs-type">hs_syn</span></a><span>
</span><a name="line-701"></a><a name="runMeta"><a href="TcSplice.html#runMeta"><span class="hs-identifier">runMeta</span></a></a><span> </span><a name="local-6989586621685044458"><a href="#local-6989586621685044458"><span class="hs-identifier">unwrap</span></a></a><span> </span><a name="local-6989586621685044459"><a href="#local-6989586621685044459"><span class="hs-identifier">e</span></a></a><span>
</span><a name="line-702"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044460"><a href="#local-6989586621685044460"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getHooked</span><span> </span><span class="hs-identifier">runMetaHook</span><span> </span><a href="TcSplice.html#defaultRunMeta"><span class="hs-identifier hs-var">defaultRunMeta</span></a><span>
</span><a name="line-703"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621685044458"><span class="hs-identifier hs-var">unwrap</span></a><span> </span><a href="#local-6989586621685044460"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621685044459"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-704"></a><span>
</span><a name="line-705"></a><span class="hs-identifier">defaultRunMeta</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MetaHook</span><span> </span><span class="hs-identifier hs-type">TcM</span><span>
</span><a name="line-706"></a><a name="defaultRunMeta"><a href="TcSplice.html#defaultRunMeta"><span class="hs-identifier">defaultRunMeta</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">MetaE</span><span> </span><a name="local-6989586621685044461"><a href="#local-6989586621685044461"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-707"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621685044461"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="TcSplice.html#runMeta%27"><span class="hs-identifier hs-var">runMeta'</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#runQResult"><span class="hs-identifier hs-var">runQResult</span></a><span> </span><span class="hs-identifier hs-var">TH.pprint</span><span> </span><a href="Convert.html#convertToHsExpr"><span class="hs-identifier hs-var">convertToHsExpr</span></a><span> </span><a href="TcSplice.html#runTHExp"><span class="hs-identifier hs-var">runTHExp</span></a><span class="hs-special">)</span><span>
</span><a name="line-708"></a><span class="hs-identifier">defaultRunMeta</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">MetaP</span><span> </span><a name="local-6989586621685044462"><a href="#local-6989586621685044462"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-709"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621685044462"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="TcSplice.html#runMeta%27"><span class="hs-identifier hs-var">runMeta'</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#runQResult"><span class="hs-identifier hs-var">runQResult</span></a><span> </span><span class="hs-identifier hs-var">TH.pprint</span><span> </span><a href="Convert.html#convertToPat"><span class="hs-identifier hs-var">convertToPat</span></a><span> </span><a href="TcSplice.html#runTHPat"><span class="hs-identifier hs-var">runTHPat</span></a><span class="hs-special">)</span><span>
</span><a name="line-710"></a><span class="hs-identifier">defaultRunMeta</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">MetaT</span><span> </span><a name="local-6989586621685044463"><a href="#local-6989586621685044463"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-711"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621685044463"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="TcSplice.html#runMeta%27"><span class="hs-identifier hs-var">runMeta'</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#runQResult"><span class="hs-identifier hs-var">runQResult</span></a><span> </span><span class="hs-identifier hs-var">TH.pprint</span><span> </span><a href="Convert.html#convertToHsType"><span class="hs-identifier hs-var">convertToHsType</span></a><span> </span><a href="TcSplice.html#runTHType"><span class="hs-identifier hs-var">runTHType</span></a><span class="hs-special">)</span><span>
</span><a name="line-712"></a><span class="hs-identifier">defaultRunMeta</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">MetaD</span><span> </span><a name="local-6989586621685044464"><a href="#local-6989586621685044464"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-713"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621685044464"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="TcSplice.html#runMeta%27"><span class="hs-identifier hs-var">runMeta'</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#runQResult"><span class="hs-identifier hs-var">runQResult</span></a><span> </span><span class="hs-identifier hs-var">TH.pprint</span><span> </span><a href="Convert.html#convertToHsDecls"><span class="hs-identifier hs-var">convertToHsDecls</span></a><span> </span><a href="TcSplice.html#runTHDec"><span class="hs-identifier hs-var">runTHDec</span></a><span class="hs-special">)</span><span>
</span><a name="line-714"></a><span class="hs-identifier">defaultRunMeta</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">MetaAW</span><span> </span><a name="local-6989586621685044465"><a href="#local-6989586621685044465"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-715"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621685044465"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="TcSplice.html#runMeta%27"><span class="hs-identifier hs-var">runMeta'</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-identifier hs-var">empty</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><a href="TcSplice.html#convertAnnotationWrapper"><span class="hs-identifier hs-var">convertAnnotationWrapper</span></a><span class="hs-special">)</span><span>
</span><a name="line-716"></a><span>    </span><span class="hs-comment">-- We turn off showing the code in meta-level exceptions because doing so exposes</span><span>
</span><a name="line-717"></a><span>    </span><span class="hs-comment">-- the toAnnotationWrapper function that we slap around the user's code</span><span>
</span><a name="line-718"></a><span>
</span><a name="line-719"></a><span class="hs-comment">----------------</span><span>
</span><a name="line-720"></a><span class="hs-identifier">runMetaAW</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>         </span><span class="hs-comment">-- Of type AnnotationWrapper</span><span>
</span><a name="line-721"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Serialized</span><span>
</span><a name="line-722"></a><a name="runMetaAW"><a href="TcSplice.html#runMetaAW"><span class="hs-identifier">runMetaAW</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#runMeta"><span class="hs-identifier hs-var">runMeta</span></a><span> </span><span class="hs-identifier hs-var">metaRequestAW</span><span>
</span><a name="line-723"></a><span>
</span><a name="line-724"></a><span class="hs-identifier">runMetaE</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>          </span><span class="hs-comment">-- Of type (Q Exp)</span><span>
</span><a name="line-725"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span>
</span><a name="line-726"></a><a name="runMetaE"><a href="TcSplice.html#runMetaE"><span class="hs-identifier">runMetaE</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#runMeta"><span class="hs-identifier hs-var">runMeta</span></a><span> </span><span class="hs-identifier hs-var">metaRequestE</span><span>
</span><a name="line-727"></a><span>
</span><a name="line-728"></a><span class="hs-identifier">runMetaP</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>          </span><span class="hs-comment">-- Of type (Q Pat)</span><span>
</span><a name="line-729"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span>
</span><a name="line-730"></a><a name="runMetaP"><a href="TcSplice.html#runMetaP"><span class="hs-identifier">runMetaP</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#runMeta"><span class="hs-identifier hs-var">runMeta</span></a><span> </span><span class="hs-identifier hs-var">metaRequestP</span><span>
</span><a name="line-731"></a><span>
</span><a name="line-732"></a><span class="hs-identifier">runMetaT</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>          </span><span class="hs-comment">-- Of type (Q Type)</span><span>
</span><a name="line-733"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsType</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span>
</span><a name="line-734"></a><a name="runMetaT"><a href="TcSplice.html#runMetaT"><span class="hs-identifier">runMetaT</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#runMeta"><span class="hs-identifier hs-var">runMeta</span></a><span> </span><span class="hs-identifier hs-var">metaRequestT</span><span>
</span><a name="line-735"></a><span>
</span><a name="line-736"></a><span class="hs-identifier">runMetaD</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>          </span><span class="hs-comment">-- Of type Q [Dec]</span><span>
</span><a name="line-737"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span>
</span><a name="line-738"></a><a name="runMetaD"><a href="TcSplice.html#runMetaD"><span class="hs-identifier">runMetaD</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#runMeta"><span class="hs-identifier hs-var">runMeta</span></a><span> </span><span class="hs-identifier hs-var">metaRequestD</span><span>
</span><a name="line-739"></a><span>
</span><a name="line-740"></a><span class="hs-comment">---------------</span><span>
</span><a name="line-741"></a><span class="hs-identifier">runMeta'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>                 </span><span class="hs-comment">-- Whether code should be printed in the exception message</span><span>
</span><a name="line-742"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044331"><span class="hs-identifier hs-type">hs_syn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">)</span><span>                                    </span><span class="hs-comment">-- how to print the code</span><span>
</span><a name="line-743"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><a href="#local-6989586621685044331"><span class="hs-identifier hs-type">hs_syn</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- How to run x</span><span>
</span><a name="line-744"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>        </span><span class="hs-comment">-- Of type x; typically x = Q TH.Exp, or</span><span>
</span><a name="line-745"></a><span>                                 </span><span class="hs-comment">--    something like that</span><span>
</span><a name="line-746"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621685044331"><span class="hs-identifier hs-type">hs_syn</span></a><span>           </span><span class="hs-comment">-- Of type t</span><span>
</span><a name="line-747"></a><a name="runMeta%27"><a href="TcSplice.html#runMeta%27"><span class="hs-identifier">runMeta'</span></a></a><span> </span><a name="local-6989586621685044466"><a href="#local-6989586621685044466"><span class="hs-identifier">show_code</span></a></a><span> </span><a name="local-6989586621685044467"><a href="#local-6989586621685044467"><span class="hs-identifier">ppr_hs</span></a></a><span> </span><a name="local-6989586621685044468"><a href="#local-6989586621685044468"><span class="hs-identifier">run_and_convert</span></a></a><span> </span><a name="local-6989586621685044469"><a href="#local-6989586621685044469"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-748"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;About to run&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044469"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-749"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#recordThSpliceUse"><span class="hs-identifier hs-var">recordThSpliceUse</span></a><span> </span><span class="hs-comment">-- seems to be the best place to do this,</span><span>
</span><a name="line-750"></a><span>                            </span><span class="hs-comment">-- we catch all kinds of splices and annotations.</span><span>
</span><a name="line-751"></a><span>
</span><a name="line-752"></a><span>        </span><span class="hs-comment">-- Check that we've had no errors of any sort so far.</span><span>
</span><a name="line-753"></a><span>        </span><span class="hs-comment">-- For example, if we found an error in an earlier defn f, but</span><span>
</span><a name="line-754"></a><span>        </span><span class="hs-comment">-- recovered giving it type f :: forall a.a, it'd be very dodgy</span><span>
</span><a name="line-755"></a><span>        </span><span class="hs-comment">-- to carry ont.  Mind you, the staging restrictions mean we won't</span><span>
</span><a name="line-756"></a><span>        </span><span class="hs-comment">-- actually run f, but it still seems wrong. And, more concretely,</span><span>
</span><a name="line-757"></a><span>        </span><span class="hs-comment">-- see Trac #5358 for an example that fell over when trying to</span><span>
</span><a name="line-758"></a><span>        </span><span class="hs-comment">-- reify a function with a &quot;?&quot; kind in it.  (These don't occur</span><span>
</span><a name="line-759"></a><span>        </span><span class="hs-comment">-- in type-correct programs.</span><span>
</span><a name="line-760"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#failIfErrsM"><span class="hs-identifier hs-var">failIfErrsM</span></a><span>
</span><a name="line-761"></a><span>
</span><a name="line-762"></a><span>        </span><span class="hs-comment">-- run plugins</span><span>
</span><a name="line-763"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044477"><a href="#local-6989586621685044477"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a><span>
</span><a name="line-764"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044478"><a href="#local-6989586621685044478"><span class="hs-identifier">expr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">withPlugins</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621685044477"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">spliceRunAction</span><span> </span><a href="#local-6989586621685044469"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-765"></a><span>
</span><a name="line-766"></a><span>        </span><span class="hs-comment">-- Desugar</span><span>
</span><a name="line-767"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044479"><a href="#local-6989586621685044479"><span class="hs-identifier">ds_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#initDsTc"><span class="hs-identifier hs-var">initDsTc</span></a><span> </span><span class="hs-special">(</span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621685044478"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">)</span><span>
</span><a name="line-768"></a><span>        </span><span class="hs-comment">-- Compile and link it; might fail if linking fails</span><span>
</span><a name="line-769"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044480"><a href="#local-6989586621685044480"><span class="hs-identifier">src_span</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span>
</span><a name="line-770"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;About to run (desugared)&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044479"><span class="hs-identifier hs-var">ds_expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-771"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044481"><a href="#local-6989586621685044481"><span class="hs-identifier">either_hval</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tryM</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-772"></a><span>                         </span><a href="HscMain.html#hscCompileCoreExpr"><span class="hs-identifier hs-var">HscMain.hscCompileCoreExpr</span></a><span> </span><a href="#local-6989586621685044477"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685044480"><span class="hs-identifier hs-var">src_span</span></a><span> </span><a href="#local-6989586621685044479"><span class="hs-identifier hs-var">ds_expr</span></a><span>
</span><a name="line-773"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685044481"><span class="hs-identifier hs-var">either_hval</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-774"></a><span>            </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621685044482"><a href="#local-6989586621685044482"><span class="hs-identifier">exn</span></a></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685044470"><span class="hs-identifier hs-var">fail_with_exn</span></a><span> </span><span class="hs-string">&quot;compile and link&quot;</span><span> </span><a href="#local-6989586621685044482"><span class="hs-identifier hs-var">exn</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-775"></a><span>            </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621685044483"><a href="#local-6989586621685044483"><span class="hs-identifier">hval</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-776"></a><span>
</span><a name="line-777"></a><span>        </span><span class="hs-special">{</span><span>       </span><span class="hs-comment">-- Coerce it to Q t, and run it</span><span>
</span><a name="line-778"></a><span>
</span><a name="line-779"></a><span>                </span><span class="hs-comment">-- Running might fail if it throws an exception of any kind (hence tryAllM)</span><span>
</span><a name="line-780"></a><span>                </span><span class="hs-comment">-- including, say, a pattern-match exception in the code we are running</span><span>
</span><a name="line-781"></a><span>                </span><span class="hs-comment">--</span><span>
</span><a name="line-782"></a><span>                </span><span class="hs-comment">-- We also do the TH -&gt; HS syntax conversion inside the same</span><span>
</span><a name="line-783"></a><span>                </span><span class="hs-comment">-- exception-cacthing thing so that if there are any lurking</span><span>
</span><a name="line-784"></a><span>                </span><span class="hs-comment">-- exceptions in the data structure returned by hval, we'll</span><span>
</span><a name="line-785"></a><span>                </span><span class="hs-comment">-- encounter them inside the try</span><span>
</span><a name="line-786"></a><span>                </span><span class="hs-comment">--</span><span>
</span><a name="line-787"></a><span>                </span><span class="hs-comment">-- See Note [Exceptions in TH]</span><span>
</span><a name="line-788"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044484"><a href="#local-6989586621685044484"><span class="hs-identifier">expr_span</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getLoc</span><span> </span><a href="#local-6989586621685044469"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-789"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044488"><a href="#local-6989586621685044488"><span class="hs-identifier">either_tval</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tryAllM</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-790"></a><span>                         </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621685044484"><span class="hs-identifier hs-var">expr_span</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-comment">-- Set the span so that qLocation can</span><span>
</span><a name="line-791"></a><span>                                                </span><span class="hs-comment">-- see where this splice is</span><span>
</span><a name="line-792"></a><span>             </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044485"><a href="#local-6989586621685044485"><span class="hs-identifier">mb_result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685044468"><span class="hs-identifier hs-var">run_and_convert</span></a><span> </span><a href="#local-6989586621685044484"><span class="hs-identifier hs-var">expr_span</span></a><span> </span><a href="#local-6989586621685044483"><span class="hs-identifier hs-var">hval</span></a><span>
</span><a name="line-793"></a><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685044485"><span class="hs-identifier hs-var">mb_result</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-794"></a><span>                    </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621685044486"><a href="#local-6989586621685044486"><span class="hs-identifier">err</span></a></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><a href="#local-6989586621685044486"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-795"></a><span>                    </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621685044487"><a href="#local-6989586621685044487"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Got HsSyn result:&quot;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044467"><span class="hs-identifier hs-var">ppr_hs</span></a><span> </span><a href="#local-6989586621685044487"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">)</span><span>
</span><a name="line-796"></a><span>                                       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><a href="#local-6989586621685044487"><span class="hs-identifier hs-var">result</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-797"></a><span>
</span><a name="line-798"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685044488"><span class="hs-identifier hs-var">either_tval</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-799"></a><span>            </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621685044489"><a href="#local-6989586621685044489"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685044489"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-800"></a><span>            </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621685044490"><a href="#local-6989586621685044490"><span class="hs-identifier">se</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">fromException</span><span> </span><a href="#local-6989586621685044490"><span class="hs-identifier hs-var">se</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-801"></a><span>                         </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">IOEnvFailure</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">failM</span><span> </span><span class="hs-comment">-- Error already in Tc monad</span><span>
</span><a name="line-802"></a><span>                         </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685044470"><span class="hs-identifier hs-var">fail_with_exn</span></a><span> </span><span class="hs-string">&quot;run&quot;</span><span> </span><a href="#local-6989586621685044490"><span class="hs-identifier hs-var">se</span></a><span> </span><span class="hs-comment">-- Exception</span><span>
</span><a name="line-803"></a><span>        </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-804"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-805"></a><span>    </span><span class="hs-comment">-- see Note [Concealed TH exceptions]</span><span>
</span><a name="line-806"></a><span>    </span><span class="hs-identifier">fail_with_exn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Exception</span><span> </span><a href="#local-6989586621685044471"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685044471"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621685044472"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-807"></a><span>    </span><a name="local-6989586621685044470"><a href="#local-6989586621685044470"><span class="hs-identifier">fail_with_exn</span></a></a><span> </span><a name="local-6989586621685044473"><a href="#local-6989586621685044473"><span class="hs-identifier">phase</span></a></a><span> </span><a name="local-6989586621685044474"><a href="#local-6989586621685044474"><span class="hs-identifier">exn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-808"></a><span>        </span><a name="local-6989586621685044475"><a href="#local-6989586621685044475"><span class="hs-identifier">exn_msg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Panic.safeShowException</span><span> </span><a href="#local-6989586621685044474"><span class="hs-identifier hs-var">exn</span></a><span>
</span><a name="line-809"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044476"><a href="#local-6989586621685044476"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Exception when trying to&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621685044473"><span class="hs-identifier hs-var">phase</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;compile-time code:&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-810"></a><span>                        </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621685044475"><span class="hs-identifier hs-var">exn_msg</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-811"></a><span>                        </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621685044466"><span class="hs-identifier hs-var">show_code</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Code:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044469"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">empty</span><span class="hs-special">]</span><span>
</span><a name="line-812"></a><span>        </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><a href="#local-6989586621685044476"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-813"></a><span>
</span><a name="line-814"></a><span class="hs-comment">{-
Note [Running typed splices in the zonker]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

See #15471 for the full discussion.

For many years typed splices were run immediately after they were type checked
however, this is too early as it means to zonk some type variables before
they can be unified with type variables in the surrounding context.

For example,

```
module A where

test_foo :: forall a . Q (TExp (a -&gt; a))
test_foo = [|| id ||]

module B where

import A

qux = $$(test_foo)
```

We would expect `qux` to have inferred type `forall a . a -&gt; a` but if
we run the splices too early the unified variables are zonked to `Any`. The
inferred type is the unusable `Any -&gt; Any`.

To run the splice, we must compile `test_foo` all the way to byte code.
But at the moment when the type checker is looking at the splice, test_foo
has type `Q (TExp (alpha -&gt; alpha))` and we
certainly can't compile code involving unification variables!

We could default `alpha` to `Any` but then we infer `qux :: Any -&gt; Any`
which definitely is not what we want.  Moreover, if we had
  qux = [$$(test_foo), (\x -&gt; x +1::Int)]
then `alpha` would have to be `Int`.

Conclusion: we must defer taking decisions about `alpha` until the
typechecker is done; and *then* we can run the splice.  It's fine to do it
later, because we know it'll produce type-correct code.

Deferring running the splice until later, in the zonker, means that the
unification variables propagate upwards from the splice into the surrounding
context and are unified correctly.

This is implemented by storing the arguments we need for running the splice
in a `DelayedSplice`. In the zonker, the arguments are passed to
`TcSplice.runTopSplice` and the expression inserted into the AST as normal.



Note [Exceptions in TH]
~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have something like this
        $( f 4 )
where
        f :: Int -&gt; Q [Dec]
        f n | n&gt;3       = fail &quot;Too many declarations&quot;
            | otherwise = ...

The 'fail' is a user-generated failure, and should be displayed as a
perfectly ordinary compiler error message, not a panic or anything
like that.  Here's how it's processed:

  * 'fail' is the monad fail.  The monad instance for Q in TH.Syntax
    effectively transforms (fail s) to
        qReport True s &gt;&gt; fail
    where 'qReport' comes from the Quasi class and fail from its monad
    superclass.

  * The TcM monad is an instance of Quasi (see TcSplice), and it implements
    (qReport True s) by using addErr to add an error message to the bag of errors.
    The 'fail' in TcM raises an IOEnvFailure exception

 * 'qReport' forces the message to ensure any exception hidden in unevaluated
   thunk doesn't get into the bag of errors. Otherwise the following splice
   will triger panic (Trac #8987):
        $(fail undefined)
   See also Note [Concealed TH exceptions]

  * So, when running a splice, we catch all exceptions; then for
        - an IOEnvFailure exception, we assume the error is already
                in the error-bag (above)
        - other errors, we add an error to the bag
    and then fail

Note [Concealed TH exceptions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When displaying the error message contained in an exception originated from TH
code, we need to make sure that the error message itself does not contain an
exception.  For example, when executing the following splice:

    $( error (&quot;foo &quot; ++ error &quot;bar&quot;) )

the message for the outer exception is a thunk which will throw the inner
exception when evaluated.

For this reason, we display the message of a TH exception using the
'safeShowException' function, which recursively catches any exception thrown
when showing an error message.


To call runQ in the Tc monad, we need to make TcM an instance of Quasi:
-}</span><span>
</span><a name="line-920"></a><span>
</span><a name="line-921"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">TH.Quasi</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-922"></a><span>  </span><a name="local-8214565720323807939"><span class="hs-identifier">qNewName</span></a><span> </span><a name="local-6989586621685044270"><a href="#local-6989586621685044270"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044271"><a href="#local-6989586621685044271"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a><span>
</span><a name="line-923"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044272"><a href="#local-6989586621685044272"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getKey</span><span> </span><a href="#local-6989586621685044271"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-924"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.mkNameU</span><span> </span><a href="#local-6989586621685044270"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621685044272"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-925"></a><span>
</span><a name="line-926"></a><span>  </span><span class="hs-comment">-- 'msg' is forced to ensure exceptions don't escape,</span><span>
</span><a name="line-927"></a><span>  </span><span class="hs-comment">-- see Note [Exceptions in TH]</span><span>
</span><a name="line-928"></a><span>  </span><a name="local-8214565720323807938"><span class="hs-identifier">qReport</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a name="local-6989586621685044273"><a href="#local-6989586621685044273"><span class="hs-identifier">msg</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">seqList</span><span> </span><a href="#local-6989586621685044273"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621685044273"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-929"></a><span>  </span><span class="hs-identifier">qReport</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a name="local-6989586621685044274"><a href="#local-6989586621685044274"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">seqList</span><span> </span><a href="#local-6989586621685044274"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnMonad.html#addWarn"><span class="hs-identifier hs-var">addWarn</span></a><span> </span><span class="hs-identifier hs-var">NoReason</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621685044274"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-930"></a><span>
</span><a name="line-931"></a><span>  </span><a name="local-8214565720323807928"><span class="hs-identifier">qLocation</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044275"><a href="#local-6989586621685044275"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-932"></a><span>                 </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044276"><a href="#local-6989586621685044276"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span>
</span><a name="line-933"></a><span>                 </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044278"><a href="#local-6989586621685044278"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685044276"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-934"></a><span>                        </span><span class="hs-identifier hs-var">UnhelpfulSpan</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;qLocation: Unhelpful location&quot;</span><span>
</span><a name="line-935"></a><span>                                                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044276"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span>
</span><a name="line-936"></a><span>                        </span><span class="hs-identifier hs-var">RealSrcSpan</span><span> </span><a name="local-6989586621685044277"><a href="#local-6989586621685044277"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685044277"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-937"></a><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.Loc</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">TH.loc_filename</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unpackFS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">srcSpanFile</span><span> </span><a href="#local-6989586621685044278"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-938"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">TH.loc_module</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">moduleNameString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621685044275"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-939"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">TH.loc_package</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unitIdString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621685044275"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-940"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">TH.loc_start</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">srcSpanStartLine</span><span> </span><a href="#local-6989586621685044278"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">srcSpanStartCol</span><span> </span><a href="#local-6989586621685044278"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-941"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">TH.loc_end</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">srcSpanEndLine</span><span>   </span><a href="#local-6989586621685044278"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">srcSpanEndCol</span><span>   </span><a href="#local-6989586621685044278"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-942"></a><span>
</span><a name="line-943"></a><span>  </span><a name="local-8214565720323807936"><span class="hs-identifier">qLookupName</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#lookupName"><span class="hs-identifier hs-var">lookupName</span></a><span>
</span><a name="line-944"></a><span>  </span><a name="local-8214565720323807935"><span class="hs-identifier">qReify</span></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#reify"><span class="hs-identifier hs-var">reify</span></a><span>
</span><a name="line-945"></a><span>  </span><a name="local-8214565720323807934"><span class="hs-identifier">qReifyFixity</span></a><span> </span><a name="local-6989586621685044279"><a href="#local-6989586621685044279"><span class="hs-identifier">nm</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#lookupThName"><span class="hs-identifier hs-var">lookupThName</span></a><span> </span><a href="#local-6989586621685044279"><span class="hs-identifier hs-var">nm</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="TcSplice.html#reifyFixity"><span class="hs-identifier hs-var">reifyFixity</span></a><span>
</span><a name="line-946"></a><span>  </span><a name="local-8214565720323807933"><span class="hs-identifier">qReifyInstances</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#reifyInstances"><span class="hs-identifier hs-var">reifyInstances</span></a><span>
</span><a name="line-947"></a><span>  </span><a name="local-8214565720323807932"><span class="hs-identifier">qReifyRoles</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#reifyRoles"><span class="hs-identifier hs-var">reifyRoles</span></a><span>
</span><a name="line-948"></a><span>  </span><a name="local-8214565720323807931"><span class="hs-identifier">qReifyAnnotations</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#reifyAnnotations"><span class="hs-identifier hs-var">reifyAnnotations</span></a><span>
</span><a name="line-949"></a><span>  </span><a name="local-8214565720323807930"><span class="hs-identifier">qReifyModule</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#reifyModule"><span class="hs-identifier hs-var">reifyModule</span></a><span>
</span><a name="line-950"></a><span>  </span><a name="local-8214565720323807929"><span class="hs-identifier">qReifyConStrictness</span></a><span> </span><a name="local-6989586621685044280"><a href="#local-6989586621685044280"><span class="hs-identifier">nm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044281"><a href="#local-6989586621685044281"><span class="hs-identifier">nm'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#lookupThName"><span class="hs-identifier hs-var">lookupThName</span></a><span> </span><a href="#local-6989586621685044280"><span class="hs-identifier hs-var">nm</span></a><span>
</span><a name="line-951"></a><span>                              </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044282"><a href="#local-6989586621685044282"><span class="hs-identifier">dc</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupDataCon"><span class="hs-identifier hs-var">tcLookupDataCon</span></a><span> </span><a href="#local-6989586621685044281"><span class="hs-identifier hs-var">nm'</span></a><span>
</span><a name="line-952"></a><span>                              </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044283"><a href="#local-6989586621685044283"><span class="hs-identifier">bangs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConImplBangs</span><span> </span><a href="#local-6989586621685044282"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-953"></a><span>                              </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="TcSplice.html#reifyDecidedStrictness"><span class="hs-identifier hs-var">reifyDecidedStrictness</span></a><span> </span><a href="#local-6989586621685044283"><span class="hs-identifier hs-var">bangs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-954"></a><span>
</span><a name="line-955"></a><span>        </span><span class="hs-comment">-- For qRecover, discard error messages if</span><span>
</span><a name="line-956"></a><span>        </span><span class="hs-comment">-- the recovery action is chosen.  Otherwise</span><span>
</span><a name="line-957"></a><span>        </span><span class="hs-comment">-- we'll only fail higher up.</span><span>
</span><a name="line-958"></a><span>  </span><a name="local-8214565720323807937"><span class="hs-identifier">qRecover</span></a><span> </span><a name="local-6989586621685044284"><a href="#local-6989586621685044284"><span class="hs-identifier">recover</span></a></a><span> </span><a name="local-6989586621685044285"><a href="#local-6989586621685044285"><span class="hs-identifier">main</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#tryTcDiscardingErrs"><span class="hs-identifier hs-var">tryTcDiscardingErrs</span></a><span> </span><a href="#local-6989586621685044284"><span class="hs-identifier hs-var">recover</span></a><span> </span><a href="#local-6989586621685044285"><span class="hs-identifier hs-var">main</span></a><span>
</span><a name="line-959"></a><span>
</span><a name="line-960"></a><span>  </span><a name="local-8214565720323807926"><span class="hs-identifier">qAddDependentFile</span></a><span> </span><a name="local-6989586621685044286"><a href="#local-6989586621685044286"><span class="hs-identifier">fp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-961"></a><span>    </span><a name="local-6989586621685044287"><a href="#local-6989586621685044287"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier">tcg_dependent_files</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-962"></a><span>    </span><a name="local-6989586621685044288"><a href="#local-6989586621685044288"><span class="hs-identifier">dep_files</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-6989586621685044287"><span class="hs-identifier hs-var">ref</span></a><span>
</span><a name="line-963"></a><span>    </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">writeTcRef</span></a><span> </span><a href="#local-6989586621685044287"><span class="hs-identifier hs-var">ref</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044286"><span class="hs-identifier hs-var">fp</span></a><span class="hs-glyph">:</span><a href="#local-6989586621685044288"><span class="hs-identifier hs-var">dep_files</span></a><span class="hs-special">)</span><span>
</span><a name="line-964"></a><span>
</span><a name="line-965"></a><span>  </span><a name="local-8214565720323807925"><span class="hs-identifier">qAddTempFile</span></a><span> </span><a name="local-6989586621685044289"><a href="#local-6989586621685044289"><span class="hs-identifier">suffix</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-966"></a><span>    </span><a name="local-6989586621685044290"><a href="#local-6989586621685044290"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-967"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">newTempName</span><span> </span><a href="#local-6989586621685044290"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">TFL_GhcSession</span><span> </span><a href="#local-6989586621685044289"><span class="hs-identifier hs-var">suffix</span></a><span>
</span><a name="line-968"></a><span>
</span><a name="line-969"></a><span>  </span><a name="local-8214565720323807924"><span class="hs-identifier">qAddTopDecls</span></a><span> </span><a name="local-6989586621685044291"><a href="#local-6989586621685044291"><span class="hs-identifier">thds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-970"></a><span>      </span><a name="local-6989586621685044300"><a href="#local-6989586621685044300"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span>
</span><a name="line-971"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044301"><a href="#local-6989586621685044301"><span class="hs-identifier">either_hval</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Convert.html#convertToHsDecls"><span class="hs-identifier hs-var">convertToHsDecls</span></a><span> </span><a href="#local-6989586621685044300"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621685044291"><span class="hs-identifier hs-var">thds</span></a><span>
</span><a name="line-972"></a><span>      </span><a name="local-6989586621685044304"><a href="#local-6989586621685044304"><span class="hs-identifier">ds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685044301"><span class="hs-identifier hs-var">either_hval</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-973"></a><span>              </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621685044302"><a href="#local-6989586621685044302"><span class="hs-identifier">exn</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-974"></a><span>                </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Error in a declaration passed to addTopDecls:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-975"></a><span>                   </span><span class="hs-number">2</span><span> </span><a href="#local-6989586621685044302"><span class="hs-identifier hs-var">exn</span></a><span>
</span><a name="line-976"></a><span>              </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621685044303"><a href="#local-6989586621685044303"><span class="hs-identifier">ds</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685044303"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-977"></a><span>      </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044292"><span class="hs-identifier hs-var">checkTopDecl</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044304"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-978"></a><span>      </span><a name="local-6989586621685044305"><a href="#local-6989586621685044305"><span class="hs-identifier">th_topdecls_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier">tcg_th_topdecls</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-979"></a><span>      </span><a href="TcRnMonad.html#updTcRef"><span class="hs-identifier hs-var">updTcRef</span></a><span> </span><a href="#local-6989586621685044305"><span class="hs-identifier hs-var">th_topdecls_var</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621685044306"><a href="#local-6989586621685044306"><span class="hs-identifier">topds</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685044304"><span class="hs-identifier hs-var">ds</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685044306"><span class="hs-identifier hs-var">topds</span></a><span class="hs-special">)</span><span>
</span><a name="line-980"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-981"></a><span>      </span><span class="hs-identifier">checkTopDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-982"></a><span>      </span><a name="local-6989586621685044292"><a href="#local-6989586621685044292"><span class="hs-identifier">checkTopDecl</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ValD</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621685044294"><a href="#local-6989586621685044294"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-983"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="#local-6989586621685044293"><span class="hs-identifier hs-var">bindName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">collectHsBindBinders</span><span> </span><a href="#local-6989586621685044294"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-984"></a><span>      </span><span class="hs-identifier">checkTopDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SigD</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-985"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-986"></a><span>      </span><span class="hs-identifier">checkTopDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnD</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-987"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-988"></a><span>      </span><span class="hs-identifier">checkTopDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ForD</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ForeignImport</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fd_name</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621685044295"><a href="#local-6989586621685044295"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-989"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685044293"><span class="hs-identifier hs-var">bindName</span></a><span> </span><a href="#local-6989586621685044295"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-990"></a><span>      </span><span class="hs-identifier">checkTopDecl</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-991"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Only function, value, annotation, and foreign import declarations may be added with addTopDecl&quot;</span><span>
</span><a name="line-992"></a><span>
</span><a name="line-993"></a><span>      </span><span class="hs-identifier">bindName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-994"></a><span>      </span><a name="local-6989586621685044293"><a href="#local-6989586621685044293"><span class="hs-identifier">bindName</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Exact</span><span> </span><a name="local-6989586621685044296"><a href="#local-6989586621685044296"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-995"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044297"><a href="#local-6989586621685044297"><span class="hs-identifier">th_topnames_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier">tcg_th_topnames</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-996"></a><span>             </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#updTcRef"><span class="hs-identifier hs-var">updTcRef</span></a><span> </span><a href="#local-6989586621685044297"><span class="hs-identifier hs-var">th_topnames_var</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621685044298"><a href="#local-6989586621685044298"><span class="hs-identifier">ns</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">extendNameSet</span><span> </span><a href="#local-6989586621685044298"><span class="hs-identifier hs-var">ns</span></a><span> </span><a href="#local-6989586621685044296"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-997"></a><span>             </span><span class="hs-special">}</span><span>
</span><a name="line-998"></a><span>
</span><a name="line-999"></a><span>      </span><span class="hs-identifier">bindName</span><span> </span><a name="local-6989586621685044299"><a href="#local-6989586621685044299"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1000"></a><span>          </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1001"></a><span>          </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The binder&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044299"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ptext</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sLit</span><span> </span><span class="hs-string">&quot;is not a NameU.&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1002"></a><span>             </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Probable cause: you used mkName instead of newName to generate a binding.&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1003"></a><span>
</span><a name="line-1004"></a><span>  </span><a name="local-8214565720323807923"><span class="hs-identifier">qAddForeignFilePath</span></a><span> </span><a name="local-6989586621685044307"><a href="#local-6989586621685044307"><span class="hs-identifier">lang</span></a></a><span> </span><a name="local-6989586621685044308"><a href="#local-6989586621685044308"><span class="hs-identifier">fp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1005"></a><span>    </span><a name="local-6989586621685044309"><a href="#local-6989586621685044309"><span class="hs-identifier">var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier">tcg_th_foreign_files</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-1006"></a><span>    </span><a href="TcRnMonad.html#updTcRef"><span class="hs-identifier hs-var">updTcRef</span></a><span> </span><a href="#local-6989586621685044309"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621685044307"><span class="hs-identifier hs-var">lang</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685044308"><span class="hs-identifier hs-var">fp</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span class="hs-special">)</span><span>
</span><a name="line-1007"></a><span>
</span><a name="line-1008"></a><span>  </span><a name="local-8214565720323807922"><span class="hs-identifier">qAddModFinalizer</span></a><span> </span><a name="local-6989586621685044310"><a href="#local-6989586621685044310"><span class="hs-identifier">fin</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1009"></a><span>      </span><a name="local-6989586621685044311"><a href="#local-6989586621685044311"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkRemoteRef</span><span> </span><a href="#local-6989586621685044310"><span class="hs-identifier hs-var">fin</span></a><span>
</span><a name="line-1010"></a><span>      </span><a name="local-6989586621685044312"><a href="#local-6989586621685044312"><span class="hs-identifier">fref</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkForeignRef</span><span> </span><a href="#local-6989586621685044311"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">freeRemoteRef</span><span> </span><a href="#local-6989586621685044311"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-1011"></a><span>      </span><a href="TcSplice.html#addModFinalizerRef"><span class="hs-identifier hs-var">addModFinalizerRef</span></a><span> </span><a href="#local-6989586621685044312"><span class="hs-identifier hs-var">fref</span></a><span>
</span><a name="line-1012"></a><span>
</span><a name="line-1013"></a><span>  </span><a name="local-8214565720323807921"><span class="hs-identifier">qAddCorePlugin</span></a><span> </span><a name="local-6989586621685044313"><a href="#local-6989586621685044313"><span class="hs-identifier">plugin</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1014"></a><span>      </span><a name="local-6989586621685044314"><a href="#local-6989586621685044314"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">env_top</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">getEnv</span><span>
</span><a name="line-1015"></a><span>      </span><a name="local-6989586621685044315"><a href="#local-6989586621685044315"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Finder.html#findHomeModule"><span class="hs-identifier hs-var">findHomeModule</span></a><span> </span><a href="#local-6989586621685044314"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkModuleName</span><span> </span><a href="#local-6989586621685044313"><span class="hs-identifier hs-var">plugin</span></a><span class="hs-special">)</span><span>
</span><a name="line-1016"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044316"><a href="#local-6989586621685044316"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span>
</span><a name="line-1017"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;addCorePlugin: invalid plugin module &quot;</span><span>
</span><a name="line-1018"></a><span>               </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621685044313"><span class="hs-identifier hs-var">plugin</span></a><span class="hs-special">)</span><span>
</span><a name="line-1019"></a><span>            </span><span class="hs-special">)</span><span>
</span><a name="line-1020"></a><span>            </span><span class="hs-number">2</span><span>
</span><a name="line-1021"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Plugins in the current package can't be specified.&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1022"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685044315"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1023"></a><span>        </span><span class="hs-identifier hs-var">Found</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><a href="#local-6989586621685044316"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-1024"></a><span>        </span><span class="hs-identifier hs-var">FoundMultiple</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><a href="#local-6989586621685044316"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-1025"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1026"></a><span>      </span><a name="local-6989586621685044317"><a href="#local-6989586621685044317"><span class="hs-identifier">th_coreplugins_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">tcg_th_coreplugins</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-1027"></a><span>      </span><a href="TcRnMonad.html#updTcRef"><span class="hs-identifier hs-var">updTcRef</span></a><span> </span><a href="#local-6989586621685044317"><span class="hs-identifier hs-var">th_coreplugins_var</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044313"><span class="hs-identifier hs-var">plugin</span></a><span class="hs-glyph">:</span><span class="hs-special">)</span><span>
</span><a name="line-1028"></a><span>
</span><a name="line-1029"></a><span>  </span><span class="hs-identifier">qGetQ</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621685044269"><a href="#local-6989586621685044269"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-6989586621685044269"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621685044269"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1030"></a><span>  </span><a name="local-8214565720323807920"><span class="hs-identifier">qGetQ</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1031"></a><span>      </span><a name="local-6989586621685044318"><a href="#local-6989586621685044318"><span class="hs-identifier">th_state_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier">tcg_th_state</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-1032"></a><span>      </span><a name="local-6989586621685044319"><a href="#local-6989586621685044319"><span class="hs-identifier">th_state</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-6989586621685044318"><span class="hs-identifier hs-var">th_state_var</span></a><span>
</span><a name="line-1033"></a><span>      </span><span class="hs-comment">-- See #10596 for why we use a scoped type variable here.</span><span>
</span><a name="line-1034"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">typeRep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Proxy</span><span> </span><a href="#local-6989586621685044269"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044319"><span class="hs-identifier hs-var">th_state</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">fromDynamic</span><span class="hs-special">)</span><span>
</span><a name="line-1035"></a><span>
</span><a name="line-1036"></a><span>  </span><a name="local-8214565720323807919"><span class="hs-identifier">qPutQ</span></a><span> </span><a name="local-6989586621685044320"><a href="#local-6989586621685044320"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1037"></a><span>      </span><a name="local-6989586621685044321"><a href="#local-6989586621685044321"><span class="hs-identifier">th_state_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier">tcg_th_state</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-1038"></a><span>      </span><a href="TcRnMonad.html#updTcRef"><span class="hs-identifier hs-var">updTcRef</span></a><span> </span><a href="#local-6989586621685044321"><span class="hs-identifier hs-var">th_state_var</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621685044322"><a href="#local-6989586621685044322"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Map.insert</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">typeOf</span><span> </span><a href="#local-6989586621685044320"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toDyn</span><span> </span><a href="#local-6989586621685044320"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044322"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-1039"></a><span>
</span><a name="line-1040"></a><span>  </span><a name="local-8214565720323807918"><span class="hs-identifier">qIsExtEnabled</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span>
</span><a name="line-1041"></a><span>
</span><a name="line-1042"></a><span>  </span><a name="local-8214565720323807917"><span class="hs-identifier">qExtsEnabled</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1043"></a><span>    </span><span class="hs-identifier hs-var">EnumSet.toList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">extensionFlags</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcRnMonad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a><span>
</span><a name="line-1044"></a><span>
</span><a name="line-1045"></a><span class="hs-comment">-- | Adds a mod finalizer reference to the local environment.</span><span>
</span><a name="line-1046"></a><span class="hs-identifier">addModFinalizerRef</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ForeignRef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TH.Q</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1047"></a><a name="addModFinalizerRef"><a href="TcSplice.html#addModFinalizerRef"><span class="hs-identifier">addModFinalizerRef</span></a></a><span> </span><a name="local-6989586621685044491"><a href="#local-6989586621685044491"><span class="hs-identifier">finRef</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1048"></a><span>    </span><a name="local-6989586621685044492"><a href="#local-6989586621685044492"><span class="hs-identifier">th_stage</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getStage"><span class="hs-identifier hs-var">getStage</span></a><span>
</span><a name="line-1049"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685044492"><span class="hs-identifier hs-var">th_stage</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1050"></a><span>      </span><span class="hs-identifier hs-var">RunSplice</span><span> </span><a name="local-6989586621685044493"><a href="#local-6989586621685044493"><span class="hs-identifier">th_modfinalizers_var</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#updTcRef"><span class="hs-identifier hs-var">updTcRef</span></a><span> </span><a href="#local-6989586621685044493"><span class="hs-identifier hs-var">th_modfinalizers_var</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044491"><span class="hs-identifier hs-var">finRef</span></a><span> </span><span class="hs-glyph">:</span><span class="hs-special">)</span><span>
</span><a name="line-1051"></a><span>      </span><span class="hs-comment">-- This case happens only if a splice is executed and the caller does</span><span>
</span><a name="line-1052"></a><span>      </span><span class="hs-comment">-- not set the 'ThStage' to 'RunSplice' to collect finalizers.</span><span>
</span><a name="line-1053"></a><span>      </span><span class="hs-comment">-- See Note [Delaying modFinalizers in untyped splices] in RnSplice.</span><span>
</span><a name="line-1054"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1055"></a><span>        </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;addModFinalizer was called when no finalizers were collected&quot;</span><span>
</span><a name="line-1056"></a><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044492"><span class="hs-identifier hs-var">th_stage</span></a><span class="hs-special">)</span><span>
</span><a name="line-1057"></a><span>
</span><a name="line-1058"></a><span class="hs-comment">-- | Releases the external interpreter state.</span><span>
</span><a name="line-1059"></a><span class="hs-identifier">finishTH</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1060"></a><a name="finishTH"><a href="TcSplice.html#finishTH"><span class="hs-identifier">finishTH</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1061"></a><span>  </span><a name="local-6989586621685044494"><a href="#local-6989586621685044494"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1062"></a><span>  </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_ExternalInterpreter</span><span> </span><a href="#local-6989586621685044494"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1063"></a><span>    </span><a name="local-6989586621685044495"><a href="#local-6989586621685044495"><span class="hs-identifier">tcg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-1064"></a><span>    </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">writeTcRef</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_th_remote_state</span><span> </span><a href="#local-6989586621685044495"><span class="hs-identifier hs-var">tcg</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1065"></a><span>
</span><a name="line-1066"></a><span class="hs-identifier">runTHExp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TH.Exp</span><span>
</span><a name="line-1067"></a><a name="runTHExp"><a href="TcSplice.html#runTHExp"><span class="hs-identifier">runTHExp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#runTH"><span class="hs-identifier hs-var">runTH</span></a><span> </span><span class="hs-identifier hs-var">THExp</span><span>
</span><a name="line-1068"></a><span>
</span><a name="line-1069"></a><span class="hs-identifier">runTHPat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TH.Pat</span><span>
</span><a name="line-1070"></a><a name="runTHPat"><a href="TcSplice.html#runTHPat"><span class="hs-identifier">runTHPat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#runTH"><span class="hs-identifier hs-var">runTH</span></a><span> </span><span class="hs-identifier hs-var">THPat</span><span>
</span><a name="line-1071"></a><span>
</span><a name="line-1072"></a><span class="hs-identifier">runTHType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TH.Type</span><span>
</span><a name="line-1073"></a><a name="runTHType"><a href="TcSplice.html#runTHType"><span class="hs-identifier">runTHType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#runTH"><span class="hs-identifier hs-var">runTH</span></a><span> </span><span class="hs-identifier hs-var">THType</span><span>
</span><a name="line-1074"></a><span>
</span><a name="line-1075"></a><span class="hs-identifier">runTHDec</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TH.Dec</span><span class="hs-special">]</span><span>
</span><a name="line-1076"></a><a name="runTHDec"><a href="TcSplice.html#runTHDec"><span class="hs-identifier">runTHDec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#runTH"><span class="hs-identifier hs-var">runTH</span></a><span> </span><span class="hs-identifier hs-var">THDec</span><span>
</span><a name="line-1077"></a><span>
</span><a name="line-1078"></a><span class="hs-identifier">runTH</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Binary</span><span> </span><a href="#local-6989586621685044330"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">THResultType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621685044330"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1079"></a><a name="runTH"><a href="TcSplice.html#runTH"><span class="hs-identifier">runTH</span></a></a><span> </span><a name="local-6989586621685044496"><a href="#local-6989586621685044496"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621685044497"><a href="#local-6989586621685044497"><span class="hs-identifier">fhv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1080"></a><span>  </span><a name="local-6989586621685044498"><a href="#local-6989586621685044498"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">env_top</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">getEnv</span><span>
</span><a name="line-1081"></a><span>  </span><a name="local-6989586621685044499"><a href="#local-6989586621685044499"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1082"></a><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_ExternalInterpreter</span><span> </span><a href="#local-6989586621685044499"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1083"></a><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1084"></a><span>       </span><span class="hs-comment">-- Run it in the local TcM</span><span>
</span><a name="line-1085"></a><span>      </span><a name="local-6989586621685044500"><a href="#local-6989586621685044500"><span class="hs-identifier">hv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GHCi.html#wormhole"><span class="hs-identifier hs-var">wormhole</span></a><span> </span><a href="#local-6989586621685044499"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621685044497"><span class="hs-identifier hs-var">fhv</span></a><span>
</span><a name="line-1086"></a><span>      </span><a name="local-6989586621685044502"><a href="#local-6989586621685044502"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#runQuasi"><span class="hs-identifier hs-var">runQuasi</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unsafeCoerce#</span><span> </span><a href="#local-6989586621685044500"><span class="hs-identifier hs-var">hv</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.Q</span><span> </span><a href="#local-6989586621685044501"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1087"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685044502"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1088"></a><span>    </span><span class="hs-keyword">else</span><span>
</span><a name="line-1089"></a><span>      </span><span class="hs-comment">-- Run it on the server.  For an overview of how TH works with</span><span>
</span><a name="line-1090"></a><span>      </span><span class="hs-comment">-- Remote GHCi, see Note [Remote Template Haskell] in</span><span>
</span><a name="line-1091"></a><span>      </span><span class="hs-comment">-- libraries/ghci/GHCi/TH.hs.</span><span>
</span><a name="line-1092"></a><span>      </span><a href="GHCi.html#withIServ"><span class="hs-identifier hs-var">withIServ</span></a><span> </span><a href="#local-6989586621685044498"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685044503"><a href="#local-6989586621685044503"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1093"></a><span>        </span><a name="local-6989586621685044504"><a href="#local-6989586621685044504"><span class="hs-identifier">rstate</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#getTHState"><span class="hs-identifier hs-var">getTHState</span></a><span> </span><a href="#local-6989586621685044503"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-1094"></a><span>        </span><a name="local-6989586621685044505"><a href="#local-6989586621685044505"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">TH.qLocation</span><span>
</span><a name="line-1095"></a><span>        </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1096"></a><span>          </span><span class="hs-identifier hs-var">withForeignRef</span><span> </span><a href="#local-6989586621685044504"><span class="hs-identifier hs-var">rstate</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685044506"><a href="#local-6989586621685044506"><span class="hs-identifier">state_hv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1097"></a><span>          </span><span class="hs-identifier hs-var">withForeignRef</span><span> </span><a href="#local-6989586621685044497"><span class="hs-identifier hs-var">fhv</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621685044507"><a href="#local-6989586621685044507"><span class="hs-identifier">q_hv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1098"></a><span>            </span><a href="GHCi.html#writeIServ"><span class="hs-identifier hs-var">writeIServ</span></a><span> </span><a href="#local-6989586621685044503"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">putMessage</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RunTH</span><span> </span><a href="#local-6989586621685044506"><span class="hs-identifier hs-var">state_hv</span></a><span> </span><a href="#local-6989586621685044507"><span class="hs-identifier hs-var">q_hv</span></a><span> </span><a href="#local-6989586621685044496"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685044505"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1099"></a><span>        </span><a href="TcSplice.html#runRemoteTH"><span class="hs-identifier hs-var">runRemoteTH</span></a><span> </span><a href="#local-6989586621685044503"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1100"></a><span>        </span><a name="local-6989586621685044508"><a href="#local-6989586621685044508"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#readQResult"><span class="hs-identifier hs-var">readQResult</span></a><span> </span><a href="#local-6989586621685044503"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-1101"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><span class="hs-identifier hs-var">runGet</span><span> </span><span class="hs-identifier hs-var">get</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LB.fromStrict</span><span> </span><a href="#local-6989586621685044508"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1102"></a><span>
</span><a name="line-1103"></a><span>
</span><a name="line-1104"></a><span class="hs-comment">-- | communicate with a remotely-running TH computation until it finishes.</span><span>
</span><a name="line-1105"></a><span class="hs-comment">-- See Note [Remote Template Haskell] in libraries/ghci/GHCi/TH.hs.</span><span>
</span><a name="line-1106"></a><span class="hs-identifier">runRemoteTH</span><span>
</span><a name="line-1107"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IServ</span><span>
</span><a name="line-1108"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Messages</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">--  saved from nested calls to qRecover</span><span>
</span><a name="line-1109"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1110"></a><a name="runRemoteTH"><a href="TcSplice.html#runRemoteTH"><span class="hs-identifier">runRemoteTH</span></a></a><span> </span><a name="local-6989586621685044509"><a href="#local-6989586621685044509"><span class="hs-identifier">iserv</span></a></a><span> </span><a name="local-6989586621685044510"><a href="#local-6989586621685044510"><span class="hs-identifier">recovers</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1111"></a><span>  </span><span class="hs-identifier hs-var">THMsg</span><span> </span><a name="local-6989586621685044511"><a href="#local-6989586621685044511"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GHCi.html#readIServ"><span class="hs-identifier hs-var">readIServ</span></a><span> </span><a href="#local-6989586621685044509"><span class="hs-identifier hs-var">iserv</span></a><span> </span><span class="hs-identifier hs-var">getTHMessage</span><span>
</span><a name="line-1112"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685044511"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1113"></a><span>    </span><span class="hs-identifier hs-var">RunTHDone</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1114"></a><span>    </span><span class="hs-identifier hs-var">StartRecover</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- Note [TH recover with -fexternal-interpreter]</span><span>
</span><a name="line-1115"></a><span>      </span><a name="local-6989586621685044512"><a href="#local-6989586621685044512"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getErrsVar"><span class="hs-identifier hs-var">getErrsVar</span></a><span>
</span><a name="line-1116"></a><span>      </span><a name="local-6989586621685044513"><a href="#local-6989586621685044513"><span class="hs-identifier">msgs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-6989586621685044512"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-1117"></a><span>      </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">writeTcRef</span></a><span> </span><a href="#local-6989586621685044512"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-identifier hs-var">emptyMessages</span><span>
</span><a name="line-1118"></a><span>      </span><a href="TcSplice.html#runRemoteTH"><span class="hs-identifier hs-var">runRemoteTH</span></a><span> </span><a href="#local-6989586621685044509"><span class="hs-identifier hs-var">iserv</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044513"><span class="hs-identifier hs-var">msgs</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621685044510"><span class="hs-identifier hs-var">recovers</span></a><span class="hs-special">)</span><span>
</span><a name="line-1119"></a><span>    </span><span class="hs-identifier hs-var">EndRecover</span><span> </span><a name="local-6989586621685044514"><a href="#local-6989586621685044514"><span class="hs-identifier">caught_error</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1120"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685044515"><a href="#local-6989586621685044515"><span class="hs-identifier">prev_msgs</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621685044516"><a href="#local-6989586621685044516"><span class="hs-identifier">prev_warns</span></a></a><span class="hs-special">,</span><a name="local-6989586621685044517"><a href="#local-6989586621685044517"><span class="hs-identifier">prev_errs</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621685044518"><a href="#local-6989586621685044518"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685044510"><span class="hs-identifier hs-var">recovers</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1121"></a><span>             </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;EndRecover&quot;</span><span>
</span><a name="line-1122"></a><span>             </span><a name="local-6989586621685044519"><a href="#local-6989586621685044519"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621685044520"><a href="#local-6989586621685044520"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044519"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><a href="#local-6989586621685044520"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-1123"></a><span>      </span><a name="local-6989586621685044521"><a href="#local-6989586621685044521"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getErrsVar"><span class="hs-identifier hs-var">getErrsVar</span></a><span>
</span><a name="line-1124"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621685044522"><a href="#local-6989586621685044522"><span class="hs-identifier">warn_msgs</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-6989586621685044521"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-1125"></a><span>      </span><span class="hs-comment">-- keep the warnings only if there were no errors</span><span>
</span><a name="line-1126"></a><span>      </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">writeTcRef</span></a><span> </span><a href="#local-6989586621685044521"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621685044514"><span class="hs-identifier hs-var">caught_error</span></a><span>
</span><a name="line-1127"></a><span>        </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621685044515"><span class="hs-identifier hs-var">prev_msgs</span></a><span>
</span><a name="line-1128"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044516"><span class="hs-identifier hs-var">prev_warns</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionBags</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685044522"><span class="hs-identifier hs-var">warn_msgs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685044517"><span class="hs-identifier hs-var">prev_errs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1129"></a><span>      </span><a href="TcSplice.html#runRemoteTH"><span class="hs-identifier hs-var">runRemoteTH</span></a><span> </span><a href="#local-6989586621685044509"><span class="hs-identifier hs-var">iserv</span></a><span> </span><a href="#local-6989586621685044518"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-1130"></a><span>    </span><a name="local-6989586621685044523"><a href="#local-6989586621685044523"><span class="hs-identifier">_other</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1131"></a><span>      </span><a name="local-6989586621685044524"><a href="#local-6989586621685044524"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#handleTHMessage"><span class="hs-identifier hs-var">handleTHMessage</span></a><span> </span><a href="#local-6989586621685044511"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-1132"></a><span>      </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GHCi.html#writeIServ"><span class="hs-identifier hs-var">writeIServ</span></a><span> </span><a href="#local-6989586621685044509"><span class="hs-identifier hs-var">iserv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">put</span><span> </span><a href="#local-6989586621685044524"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-1133"></a><span>      </span><a href="TcSplice.html#runRemoteTH"><span class="hs-identifier hs-var">runRemoteTH</span></a><span> </span><a href="#local-6989586621685044509"><span class="hs-identifier hs-var">iserv</span></a><span> </span><a href="#local-6989586621685044510"><span class="hs-identifier hs-var">recovers</span></a><span>
</span><a name="line-1134"></a><span>
</span><a name="line-1135"></a><span class="hs-comment">-- | Read a value of type QResult from the iserv</span><span>
</span><a name="line-1136"></a><span class="hs-identifier">readQResult</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Binary</span><span> </span><a href="#local-6989586621685044329"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">IServ</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621685044329"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1137"></a><a name="readQResult"><a href="TcSplice.html#readQResult"><span class="hs-identifier">readQResult</span></a></a><span> </span><a name="local-6989586621685044525"><a href="#local-6989586621685044525"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1138"></a><span>  </span><a name="local-6989586621685044526"><a href="#local-6989586621685044526"><span class="hs-identifier">qr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GHCi.html#readIServ"><span class="hs-identifier hs-var">readIServ</span></a><span> </span><a href="#local-6989586621685044525"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-identifier hs-var">get</span><span>
</span><a name="line-1139"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685044526"><span class="hs-identifier hs-var">qr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1140"></a><span>    </span><span class="hs-identifier hs-var">QDone</span><span> </span><a name="local-6989586621685044527"><a href="#local-6989586621685044527"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685044527"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-1141"></a><span>    </span><span class="hs-identifier hs-var">QException</span><span> </span><a name="local-6989586621685044528"><a href="#local-6989586621685044528"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ErrorCall</span><span> </span><a href="#local-6989586621685044528"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">)</span><span>
</span><a name="line-1142"></a><span>    </span><span class="hs-identifier hs-var">QFail</span><span> </span><a name="local-6989586621685044529"><a href="#local-6989586621685044529"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><a href="#local-6989586621685044529"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-1143"></a><span>
</span><a name="line-1144"></a><span class="hs-comment">{- Note [TH recover with -fexternal-interpreter]

Recover is slightly tricky to implement.

The meaning of &quot;recover a b&quot; is
 - Do a
   - If it finished with no errors, then keep the warnings it generated
   - If it failed, discard any messages it generated, and do b

Note that &quot;failed&quot; here can mean either
  (1) threw an exception (failTc)
  (2) generated an error message (addErrTcM)

The messages are managed by GHC in the TcM monad, whereas the
exception-handling is done in the ghc-iserv process, so we have to
coordinate between the two.

On the server:
  - emit a StartRecover message
  - run &quot;a; FailIfErrs&quot; inside a try
  - emit an (EndRecover x) message, where x = True if &quot;a; FailIfErrs&quot; failed
  - if &quot;a; FailIfErrs&quot; failed, run &quot;b&quot;

Back in GHC, when we receive:

  FailIfErrrs
    failTc if there are any error messages (= failIfErrsM)
  StartRecover
    save the current messages and start with an empty set.
  EndRecover caught_error
    Restore the previous messages,
    and merge in the new messages if caught_error is false.
-}</span><span>
</span><a name="line-1177"></a><span>
</span><a name="line-1178"></a><span class="hs-comment">-- | Retrieve (or create, if it hasn't been created already), the</span><span>
</span><a name="line-1179"></a><span class="hs-comment">-- remote TH state.  The TH state is a remote reference to an IORef</span><span>
</span><a name="line-1180"></a><span class="hs-comment">-- QState living on the server, and we have to pass this to each RunTH</span><span>
</span><a name="line-1181"></a><span class="hs-comment">-- call we make.</span><span>
</span><a name="line-1182"></a><span class="hs-comment">--</span><span>
</span><a name="line-1183"></a><span class="hs-comment">-- The TH state is stored in tcg_th_remote_state in the TcGblEnv.</span><span>
</span><a name="line-1184"></a><span class="hs-comment">--</span><span>
</span><a name="line-1185"></a><span class="hs-identifier">getTHState</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IServ</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ForeignRef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IORef</span><span> </span><span class="hs-identifier hs-type">QState</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1186"></a><a name="getTHState"><a href="TcSplice.html#getTHState"><span class="hs-identifier">getTHState</span></a></a><span> </span><a name="local-6989586621685044530"><a href="#local-6989586621685044530"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1187"></a><span>  </span><a name="local-6989586621685044531"><a href="#local-6989586621685044531"><span class="hs-identifier">tcg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-1188"></a><span>  </span><a name="local-6989586621685044532"><a href="#local-6989586621685044532"><span class="hs-identifier">th_state</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_th_remote_state</span><span> </span><a href="#local-6989586621685044531"><span class="hs-identifier hs-var">tcg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1189"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685044532"><span class="hs-identifier hs-var">th_state</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1190"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685044533"><a href="#local-6989586621685044533"><span class="hs-identifier">rhv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685044533"><span class="hs-identifier hs-var">rhv</span></a><span>
</span><a name="line-1191"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1192"></a><span>      </span><a name="local-6989586621685044534"><a href="#local-6989586621685044534"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">env_top</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">getEnv</span><span>
</span><a name="line-1193"></a><span>      </span><a name="local-6989586621685044535"><a href="#local-6989586621685044535"><span class="hs-identifier">fhv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="GHCi.html#mkFinalizedHValue"><span class="hs-identifier hs-var">mkFinalizedHValue</span></a><span> </span><a href="#local-6989586621685044534"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="GHCi.html#iservCall"><span class="hs-identifier hs-var">iservCall</span></a><span> </span><a href="#local-6989586621685044530"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-identifier hs-var">StartTH</span><span>
</span><a name="line-1194"></a><span>      </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">writeTcRef</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_th_remote_state</span><span> </span><a href="#local-6989586621685044531"><span class="hs-identifier hs-var">tcg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685044535"><span class="hs-identifier hs-var">fhv</span></a><span class="hs-special">)</span><span>
</span><a name="line-1195"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685044535"><span class="hs-identifier hs-var">fhv</span></a><span>
</span><a name="line-1196"></a><span>
</span><a name="line-1197"></a><span class="hs-identifier">wrapTHResult</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621685044328"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">THResult</span><span> </span><a href="#local-6989586621685044328"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1198"></a><a name="wrapTHResult"><a href="TcSplice.html#wrapTHResult"><span class="hs-identifier">wrapTHResult</span></a></a><span> </span><a name="local-6989586621685044536"><a href="#local-6989586621685044536"><span class="hs-identifier">tcm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1199"></a><span>  </span><a name="local-6989586621685044537"><a href="#local-6989586621685044537"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tryM</span><span> </span><a href="#local-6989586621685044536"><span class="hs-identifier hs-var">tcm</span></a><span>   </span><span class="hs-comment">-- only catch 'fail', treat everything else as catastrophic</span><span>
</span><a name="line-1200"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685044537"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1201"></a><span>    </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621685044538"><a href="#local-6989586621685044538"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">THException</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621685044538"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1202"></a><span>    </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621685044539"><a href="#local-6989586621685044539"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">THComplete</span><span> </span><a href="#local-6989586621685044539"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1203"></a><span>
</span><a name="line-1204"></a><span class="hs-identifier">handleTHMessage</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">THMessage</span><span> </span><a href="#local-6989586621685044327"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621685044327"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1205"></a><a name="handleTHMessage"><a href="TcSplice.html#handleTHMessage"><span class="hs-identifier">handleTHMessage</span></a></a><span> </span><a name="local-6989586621685044540"><a href="#local-6989586621685044540"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685044540"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1206"></a><span>  </span><span class="hs-identifier hs-var">NewName</span><span> </span><a name="local-6989586621685044541"><a href="#local-6989586621685044541"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSplice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TH.qNewName</span><span> </span><a href="#local-6989586621685044541"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-1207"></a><span>  </span><span class="hs-identifier hs-var">Report</span><span> </span><a name="local-6989586621685044542"><a href="#local-6989586621685044542"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621685044543"><a href="#local-6989586621685044543"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSplice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TH.qReport</span><span> </span><a href="#local-6989586621685044542"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621685044543"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-1208"></a><span>  </span><span class="hs-identifier hs-var">LookupName</span><span> </span><a name="local-6989586621685044544"><a href="#local-6989586621685044544"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621685044545"><a href="#local-6989586621685044545"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSplice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TH.qLookupName</span><span> </span><a href="#local-6989586621685044544"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621685044545"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-1209"></a><span>  </span><span class="hs-identifier hs-var">Reify</span><span> </span><a name="local-6989586621685044546"><a href="#local-6989586621685044546"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSplice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TH.qReify</span><span> </span><a href="#local-6989586621685044546"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1210"></a><span>  </span><span class="hs-identifier hs-var">ReifyFixity</span><span> </span><a name="local-6989586621685044547"><a href="#local-6989586621685044547"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSplice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TH.qReifyFixity</span><span> </span><a href="#local-6989586621685044547"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1211"></a><span>  </span><span class="hs-identifier hs-var">ReifyInstances</span><span> </span><a name="local-6989586621685044548"><a href="#local-6989586621685044548"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621685044549"><a href="#local-6989586621685044549"><span class="hs-identifier">ts</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSplice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TH.qReifyInstances</span><span> </span><a href="#local-6989586621685044548"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621685044549"><span class="hs-identifier hs-var">ts</span></a><span>
</span><a name="line-1212"></a><span>  </span><span class="hs-identifier hs-var">ReifyRoles</span><span> </span><a name="local-6989586621685044550"><a href="#local-6989586621685044550"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSplice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TH.qReifyRoles</span><span> </span><a href="#local-6989586621685044550"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1213"></a><span>  </span><span class="hs-identifier hs-var">ReifyAnnotations</span><span> </span><a name="local-6989586621685044551"><a href="#local-6989586621685044551"><span class="hs-identifier">lookup</span></a></a><span> </span><a name="local-6989586621685044552"><a href="#local-6989586621685044552"><span class="hs-identifier">tyrep</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1214"></a><span>    </span><a href="TcSplice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">B.pack</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcSplice.html#getAnnotationsByTypeRep"><span class="hs-identifier hs-var">getAnnotationsByTypeRep</span></a><span> </span><a href="#local-6989586621685044551"><span class="hs-identifier hs-var">lookup</span></a><span> </span><a href="#local-6989586621685044552"><span class="hs-identifier hs-var">tyrep</span></a><span class="hs-special">)</span><span>
</span><a name="line-1215"></a><span>  </span><span class="hs-identifier hs-var">ReifyModule</span><span> </span><a name="local-6989586621685044553"><a href="#local-6989586621685044553"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSplice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TH.qReifyModule</span><span> </span><a href="#local-6989586621685044553"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-1216"></a><span>  </span><span class="hs-identifier hs-var">ReifyConStrictness</span><span> </span><a name="local-6989586621685044554"><a href="#local-6989586621685044554"><span class="hs-identifier">nm</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSplice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TH.qReifyConStrictness</span><span> </span><a href="#local-6989586621685044554"><span class="hs-identifier hs-var">nm</span></a><span>
</span><a name="line-1217"></a><span>  </span><span class="hs-identifier hs-var">AddDependentFile</span><span> </span><a name="local-6989586621685044555"><a href="#local-6989586621685044555"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSplice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TH.qAddDependentFile</span><span> </span><a href="#local-6989586621685044555"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-1218"></a><span>  </span><span class="hs-identifier hs-var">AddTempFile</span><span> </span><a name="local-6989586621685044556"><a href="#local-6989586621685044556"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSplice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TH.qAddTempFile</span><span> </span><a href="#local-6989586621685044556"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-1219"></a><span>  </span><span class="hs-identifier hs-var">AddModFinalizer</span><span> </span><a name="local-6989586621685044557"><a href="#local-6989586621685044557"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1220"></a><span>    </span><a name="local-6989586621685044558"><a href="#local-6989586621685044558"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">env_top</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">getEnv</span><span>
</span><a name="line-1221"></a><span>    </span><a href="TcSplice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><a href="GHCi.html#mkFinalizedHValue"><span class="hs-identifier hs-var">mkFinalizedHValue</span></a><span> </span><a href="#local-6989586621685044558"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621685044557"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="TcSplice.html#addModFinalizerRef"><span class="hs-identifier hs-var">addModFinalizerRef</span></a><span>
</span><a name="line-1222"></a><span>  </span><span class="hs-identifier hs-var">AddCorePlugin</span><span> </span><a name="local-6989586621685044559"><a href="#local-6989586621685044559"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSplice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TH.qAddCorePlugin</span><span> </span><a href="#local-6989586621685044559"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-1223"></a><span>  </span><span class="hs-identifier hs-var">AddTopDecls</span><span> </span><a name="local-6989586621685044560"><a href="#local-6989586621685044560"><span class="hs-identifier">decs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSplice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TH.qAddTopDecls</span><span> </span><a href="#local-6989586621685044560"><span class="hs-identifier hs-var">decs</span></a><span>
</span><a name="line-1224"></a><span>  </span><span class="hs-identifier hs-var">AddForeignFilePath</span><span> </span><a name="local-6989586621685044561"><a href="#local-6989586621685044561"><span class="hs-identifier">lang</span></a></a><span> </span><a name="local-6989586621685044562"><a href="#local-6989586621685044562"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSplice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TH.qAddForeignFilePath</span><span> </span><a href="#local-6989586621685044561"><span class="hs-identifier hs-var">lang</span></a><span> </span><a href="#local-6989586621685044562"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-1225"></a><span>  </span><span class="hs-identifier hs-var">IsExtEnabled</span><span> </span><a name="local-6989586621685044563"><a href="#local-6989586621685044563"><span class="hs-identifier">ext</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSplice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TH.qIsExtEnabled</span><span> </span><a href="#local-6989586621685044563"><span class="hs-identifier hs-var">ext</span></a><span>
</span><a name="line-1226"></a><span>  </span><span class="hs-identifier hs-var">ExtsEnabled</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSplice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TH.qExtsEnabled</span><span>
</span><a name="line-1227"></a><span>  </span><span class="hs-identifier hs-var">FailIfErrs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSplice.html#wrapTHResult"><span class="hs-identifier hs-var">wrapTHResult</span></a><span> </span><a href="TcRnMonad.html#failIfErrsM"><span class="hs-identifier hs-var">failIfErrsM</span></a><span>
</span><a name="line-1228"></a><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;handleTHMessage: unexpected message &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621685044540"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1229"></a><span>
</span><a name="line-1230"></a><span class="hs-identifier">getAnnotationsByTypeRep</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.AnnLookup</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TypeRep</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Word8</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-1231"></a><a name="getAnnotationsByTypeRep"><a href="TcSplice.html#getAnnotationsByTypeRep"><span class="hs-identifier">getAnnotationsByTypeRep</span></a></a><span> </span><a name="local-6989586621685044564"><a href="#local-6989586621685044564"><span class="hs-identifier">th_name</span></a></a><span> </span><a name="local-6989586621685044565"><a href="#local-6989586621685044565"><span class="hs-identifier">tyrep</span></a></a><span>
</span><a name="line-1232"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044566"><a href="#local-6989586621685044566"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#lookupThAnnLookup"><span class="hs-identifier hs-var">lookupThAnnLookup</span></a><span> </span><a href="#local-6989586621685044564"><span class="hs-identifier hs-var">th_name</span></a><span>
</span><a name="line-1233"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044567"><a href="#local-6989586621685044567"><span class="hs-identifier">topEnv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a><span>
</span><a name="line-1234"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044568"><a href="#local-6989586621685044568"><span class="hs-identifier">epsHptAnns</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">prepareAnnotations</span><span> </span><a href="#local-6989586621685044567"><span class="hs-identifier hs-var">topEnv</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1235"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044569"><a href="#local-6989586621685044569"><span class="hs-identifier">tcg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-1236"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044570"><a href="#local-6989586621685044570"><span class="hs-identifier">selectedEpsHptAnns</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">findAnnsByTypeRep</span><span> </span><a href="#local-6989586621685044568"><span class="hs-identifier hs-var">epsHptAnns</span></a><span> </span><a href="#local-6989586621685044566"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621685044565"><span class="hs-identifier hs-var">tyrep</span></a><span>
</span><a name="line-1237"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044571"><a href="#local-6989586621685044571"><span class="hs-identifier">selectedTcgAnns</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">findAnnsByTypeRep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_ann_env</span><span> </span><a href="#local-6989586621685044569"><span class="hs-identifier hs-var">tcg</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044566"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621685044565"><span class="hs-identifier hs-var">tyrep</span></a><span>
</span><a name="line-1238"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044570"><span class="hs-identifier hs-var">selectedEpsHptAnns</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685044571"><span class="hs-identifier hs-var">selectedTcgAnns</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1239"></a><span>
</span><a name="line-1240"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
            Instance Testing
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1247"></a><span>
</span><a name="line-1248"></a><span class="hs-identifier">reifyInstances</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TH.Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TH.Dec</span><span class="hs-special">]</span><span>
</span><a name="line-1249"></a><a name="reifyInstances"><a href="TcSplice.html#reifyInstances"><span class="hs-identifier">reifyInstances</span></a></a><span> </span><a name="local-6989586621685044572"><a href="#local-6989586621685044572"><span class="hs-identifier">th_nm</span></a></a><span> </span><a name="local-6989586621685044573"><a href="#local-6989586621685044573"><span class="hs-identifier">th_tys</span></a></a><span>
</span><a name="line-1250"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;In the argument of reifyInstances:&quot;</span><span>
</span><a name="line-1251"></a><span>                 </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="TcSplice.html#ppr_th"><span class="hs-identifier hs-var">ppr_th</span></a><span> </span><a href="#local-6989586621685044572"><span class="hs-identifier hs-var">th_nm</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="TcSplice.html#ppr_th"><span class="hs-identifier hs-var">ppr_th</span></a><span> </span><a href="#local-6989586621685044573"><span class="hs-identifier hs-var">th_tys</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1252"></a><span>     </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044582"><a href="#local-6989586621685044582"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span>
</span><a name="line-1253"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044583"><a href="#local-6989586621685044583"><span class="hs-identifier">rdr_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685044576"><span class="hs-identifier hs-var">cvt</span></a><span> </span><a href="#local-6989586621685044582"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><a href="TcSplice.html#mkThAppTs"><span class="hs-identifier hs-var">mkThAppTs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.ConT</span><span> </span><a href="#local-6989586621685044572"><span class="hs-identifier hs-var">th_nm</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044573"><span class="hs-identifier hs-var">th_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-1254"></a><span>          </span><span class="hs-comment">-- #9262 says to bring vars into scope, like in HsForAllTy case</span><span>
</span><a name="line-1255"></a><span>          </span><span class="hs-comment">-- of rnHsTyKi</span><span>
</span><a name="line-1256"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044584"><a href="#local-6989586621685044584"><span class="hs-identifier">tv_rdrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnTypes.html#freeKiTyVarsAllVars"><span class="hs-identifier hs-var">freeKiTyVarsAllVars</span></a><span> </span><span class="hs-special">(</span><a href="RnTypes.html#extractHsTyRdrTyVars"><span class="hs-identifier hs-var">extractHsTyRdrTyVars</span></a><span> </span><a href="#local-6989586621685044583"><span class="hs-identifier hs-var">rdr_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1257"></a><span>          </span><span class="hs-comment">-- Rename  to HsType Name</span><span>
</span><a name="line-1258"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621685044588"><a href="#local-6989586621685044588"><span class="hs-identifier">tv_names</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044589"><a href="#local-6989586621685044589"><span class="hs-identifier">rn_ty</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621685044590"><a href="#local-6989586621685044590"><span class="hs-identifier">_fvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1259"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-comment">-- If there are out-of-scope Names here, then we</span><span>
</span><a name="line-1260"></a><span>                             </span><span class="hs-comment">-- must error before proceeding to typecheck the</span><span>
</span><a name="line-1261"></a><span>                             </span><span class="hs-comment">-- renamed type, as that will result in GHC</span><span>
</span><a name="line-1262"></a><span>                             </span><span class="hs-comment">-- internal errors (#13837).</span><span>
</span><a name="line-1263"></a><span>               </span><a href="RnTypes.html#bindLRdrNames"><span class="hs-identifier hs-var">bindLRdrNames</span></a><span> </span><a href="#local-6989586621685044584"><span class="hs-identifier hs-var">tv_rdrs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621685044585"><a href="#local-6989586621685044585"><span class="hs-identifier">tv_names</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1264"></a><span>               </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685044586"><a href="#local-6989586621685044586"><span class="hs-identifier">rn_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044587"><a href="#local-6989586621685044587"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnTypes.html#rnLHsType"><span class="hs-identifier hs-var">rnLHsType</span></a><span> </span><a href="#local-6989586621685044574"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621685044583"><span class="hs-identifier hs-var">rdr_ty</span></a><span>
</span><a name="line-1265"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621685044585"><span class="hs-identifier hs-var">tv_names</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685044586"><span class="hs-identifier hs-var">rn_ty</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621685044587"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1266"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685044591"><a href="#local-6989586621685044591"><span class="hs-identifier">_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044592"><a href="#local-6989586621685044592"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1267"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#pushTcLevelM_"><span class="hs-identifier hs-var">pushTcLevelM_</span></a><span>   </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1268"></a><span>               </span><a href="TcSimplify.html#solveEqualities"><span class="hs-identifier hs-var">solveEqualities</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-comment">-- Avoid error cascade if there are unsolved</span><span>
</span><a name="line-1269"></a><span>               </span><a href="TcHsType.html#bindImplicitTKBndrs_Skol"><span class="hs-identifier hs-var">bindImplicitTKBndrs_Skol</span></a><span> </span><a href="#local-6989586621685044588"><span class="hs-identifier hs-var">tv_names</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1270"></a><span>               </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcHsType.html#tcLHsType"><span class="hs-identifier hs-var">tcLHsType</span></a><span> </span><a href="#local-6989586621685044589"><span class="hs-identifier hs-var">rn_ty</span></a><span>
</span><a name="line-1271"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044593"><a href="#local-6989586621685044593"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTcTypeToType"><span class="hs-identifier hs-var">zonkTcTypeToType</span></a><span> </span><a href="#local-6989586621685044592"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1272"></a><span>                </span><span class="hs-comment">-- Substitute out the meta type variables</span><span>
</span><a name="line-1273"></a><span>                </span><span class="hs-comment">-- In particular, the type might have kind</span><span>
</span><a name="line-1274"></a><span>                </span><span class="hs-comment">-- variables inside it (Trac #7477)</span><span>
</span><a name="line-1275"></a><span>
</span><a name="line-1276"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;reifyInstances&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044593"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tcTypeKind</span><span> </span><a href="#local-6989586621685044593"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1277"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">splitTyConApp_maybe</span><span> </span><a href="#local-6989586621685044593"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-keyword">of</span><span>   </span><span class="hs-comment">-- This expands any type synonyms</span><span>
</span><a name="line-1278"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685044594"><a href="#local-6989586621685044594"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044595"><a href="#local-6989586621685044595"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>                 </span><span class="hs-comment">-- See Trac #7910</span><span>
</span><a name="line-1279"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685044596"><a href="#local-6989586621685044596"><span class="hs-identifier">cls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tyConClass_maybe</span><span> </span><a href="#local-6989586621685044594"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1280"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044597"><a href="#local-6989586621685044597"><span class="hs-identifier">inst_envs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcGetInstEnvs"><span class="hs-identifier hs-var">tcGetInstEnvs</span></a><span>
</span><a name="line-1281"></a><span>                     </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685044598"><a href="#local-6989586621685044598"><span class="hs-identifier">matches</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044599"><a href="#local-6989586621685044599"><span class="hs-identifier">unifies</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupInstEnv</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621685044597"><span class="hs-identifier hs-var">inst_envs</span></a><span> </span><a href="#local-6989586621685044596"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621685044595"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1282"></a><span>                     </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;reifyInstances1&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044598"><span class="hs-identifier hs-var">matches</span></a><span class="hs-special">)</span><span>
</span><a name="line-1283"></a><span>                     </span><span class="hs-special">;</span><span> </span><a href="TcSplice.html#reifyClassInstances"><span class="hs-identifier hs-var">reifyClassInstances</span></a><span> </span><a href="#local-6989586621685044596"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621685044598"><span class="hs-identifier hs-var">matches</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685044599"><span class="hs-identifier hs-var">unifies</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1284"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isOpenFamilyTyCon</span><span> </span><a href="#local-6989586621685044594"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1285"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044600"><a href="#local-6989586621685044600"><span class="hs-identifier">inst_envs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#tcGetFamInstEnvs"><span class="hs-identifier hs-var">tcGetFamInstEnvs</span></a><span>
</span><a name="line-1286"></a><span>                     </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044601"><a href="#local-6989586621685044601"><span class="hs-identifier">matches</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupFamInstEnv</span><span> </span><a href="#local-6989586621685044600"><span class="hs-identifier hs-var">inst_envs</span></a><span> </span><a href="#local-6989586621685044594"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621685044595"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1287"></a><span>                     </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;reifyInstances2&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044601"><span class="hs-identifier hs-var">matches</span></a><span class="hs-special">)</span><span>
</span><a name="line-1288"></a><span>                     </span><span class="hs-special">;</span><span> </span><a href="TcSplice.html#reifyFamilyInstances"><span class="hs-identifier hs-var">reifyFamilyInstances</span></a><span> </span><a href="#local-6989586621685044594"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">fim_instance</span><span> </span><a href="#local-6989586621685044601"><span class="hs-identifier hs-var">matches</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1289"></a><span>            </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621685044575"><span class="hs-identifier hs-var">bale_out</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;reifyInstances:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044593"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1290"></a><span>                               </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is not a class constraint or type family application&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1291"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1292"></a><span>    </span><a name="local-6989586621685044574"><a href="#local-6989586621685044574"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnUtils.html#ClassInstanceCtx"><span class="hs-identifier hs-var">ClassInstanceCtx</span></a><span>
</span><a name="line-1293"></a><span>    </span><a name="local-6989586621685044575"><a href="#local-6989586621685044575"><span class="hs-identifier">bale_out</span></a></a><span> </span><a name="local-6989586621685044577"><a href="#local-6989586621685044577"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><a href="#local-6989586621685044577"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-1294"></a><span>
</span><a name="line-1295"></a><span>    </span><span class="hs-identifier">cvt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TH.Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsType</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span>
</span><a name="line-1296"></a><span>    </span><a name="local-6989586621685044576"><a href="#local-6989586621685044576"><span class="hs-identifier">cvt</span></a></a><span> </span><a name="local-6989586621685044578"><a href="#local-6989586621685044578"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621685044579"><a href="#local-6989586621685044579"><span class="hs-identifier">th_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Convert.html#convertToHsType"><span class="hs-identifier hs-var">convertToHsType</span></a><span> </span><a href="#local-6989586621685044578"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621685044579"><span class="hs-identifier hs-var">th_ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1297"></a><span>                      </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621685044580"><a href="#local-6989586621685044580"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><a href="#local-6989586621685044580"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-1298"></a><span>                      </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621685044581"><a href="#local-6989586621685044581"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685044581"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1299"></a><span>
</span><a name="line-1300"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                        Reification
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1307"></a><span>
</span><a name="line-1308"></a><span class="hs-identifier">lookupName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>      </span><span class="hs-comment">-- True  &lt;=&gt; type namespace</span><span>
</span><a name="line-1309"></a><span>                        </span><span class="hs-comment">-- False &lt;=&gt; value namespace</span><span>
</span><a name="line-1310"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TH.Name</span><span class="hs-special">)</span><span>
</span><a name="line-1311"></a><a name="lookupName"><a href="TcSplice.html#lookupName"><span class="hs-identifier">lookupName</span></a></a><span> </span><a name="local-6989586621685044602"><a href="#local-6989586621685044602"><span class="hs-identifier">is_type_name</span></a></a><span> </span><a name="local-6989586621685044603"><a href="#local-6989586621685044603"><span class="hs-identifier">s</span></a></a><span>
</span><a name="line-1312"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044609"><a href="#local-6989586621685044609"><span class="hs-identifier">lcl_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLocalRdrEnv"><span class="hs-identifier hs-var">getLocalRdrEnv</span></a><span>
</span><a name="line-1313"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupLocalRdrEnv</span><span> </span><a href="#local-6989586621685044609"><span class="hs-identifier hs-var">lcl_env</span></a><span> </span><a href="#local-6989586621685044607"><span class="hs-identifier hs-var">rdr_name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1314"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685044610"><a href="#local-6989586621685044610"><span class="hs-identifier">n</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><a href="#local-6989586621685044610"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1315"></a><span>           </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044611"><a href="#local-6989586621685044611"><span class="hs-identifier">mb_nm</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupGlobalOccRn_maybe"><span class="hs-identifier hs-var">lookupGlobalOccRn_maybe</span></a><span> </span><a href="#local-6989586621685044607"><span class="hs-identifier hs-var">rdr_name</span></a><span>
</span><a name="line-1316"></a><span>                         </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><a href="#local-6989586621685044611"><span class="hs-identifier hs-var">mb_nm</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1317"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1318"></a><span>    </span><a name="local-6989586621685044604"><a href="#local-6989586621685044604"><span class="hs-identifier">th_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.mkName</span><span> </span><a href="#local-6989586621685044603"><span class="hs-identifier hs-var">s</span></a><span>       </span><span class="hs-comment">-- Parses M.x into a base of 'x' and a module of 'M'</span><span>
</span><a name="line-1319"></a><span>
</span><a name="line-1320"></a><span>    </span><span class="hs-identifier">occ_fs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FastString</span><span>
</span><a name="line-1321"></a><span>    </span><a name="local-6989586621685044605"><a href="#local-6989586621685044605"><span class="hs-identifier">occ_fs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkFastString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.nameBase</span><span> </span><a href="#local-6989586621685044604"><span class="hs-identifier hs-var">th_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1322"></a><span>
</span><a name="line-1323"></a><span>    </span><span class="hs-identifier">occ</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OccName</span><span>
</span><a name="line-1324"></a><span>    </span><a name="local-6989586621685044606"><a href="#local-6989586621685044606"><span class="hs-identifier">occ</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685044602"><span class="hs-identifier hs-var">is_type_name</span></a><span>
</span><a name="line-1325"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isLexVarSym</span><span> </span><a href="#local-6989586621685044605"><span class="hs-identifier hs-var">occ_fs</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">isLexCon</span><span> </span><a href="#local-6989586621685044605"><span class="hs-identifier hs-var">occ_fs</span></a><span>
</span><a name="line-1326"></a><span>                             </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">mkTcOccFS</span><span>    </span><a href="#local-6989586621685044605"><span class="hs-identifier hs-var">occ_fs</span></a><span>
</span><a name="line-1327"></a><span>                             </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">mkTyVarOccFS</span><span> </span><a href="#local-6989586621685044605"><span class="hs-identifier hs-var">occ_fs</span></a><span>
</span><a name="line-1328"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1329"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isLexCon</span><span> </span><a href="#local-6989586621685044605"><span class="hs-identifier hs-var">occ_fs</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">mkDataOccFS</span><span> </span><a href="#local-6989586621685044605"><span class="hs-identifier hs-var">occ_fs</span></a><span>
</span><a name="line-1330"></a><span>                             </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">mkVarOccFS</span><span>  </span><a href="#local-6989586621685044605"><span class="hs-identifier hs-var">occ_fs</span></a><span>
</span><a name="line-1331"></a><span>
</span><a name="line-1332"></a><span>    </span><a name="local-6989586621685044607"><a href="#local-6989586621685044607"><span class="hs-identifier">rdr_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">TH.nameModule</span><span> </span><a href="#local-6989586621685044604"><span class="hs-identifier hs-var">th_name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1333"></a><span>                 </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">mkRdrUnqual</span><span> </span><a href="#local-6989586621685044606"><span class="hs-identifier hs-var">occ</span></a><span>
</span><a name="line-1334"></a><span>                 </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685044608"><a href="#local-6989586621685044608"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">mkRdrQual</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkModuleName</span><span> </span><a href="#local-6989586621685044608"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044606"><span class="hs-identifier hs-var">occ</span></a><span>
</span><a name="line-1335"></a><span>
</span><a name="line-1336"></a><span class="hs-identifier">getThing</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcTyThing</span><span>
</span><a name="line-1337"></a><a name="getThing"><a href="TcSplice.html#getThing"><span class="hs-identifier">getThing</span></a></a><span> </span><a name="local-6989586621685044612"><a href="#local-6989586621685044612"><span class="hs-identifier">th_name</span></a></a><span>
</span><a name="line-1338"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044620"><a href="#local-6989586621685044620"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#lookupThName"><span class="hs-identifier hs-var">lookupThName</span></a><span> </span><a href="#local-6989586621685044612"><span class="hs-identifier hs-var">th_name</span></a><span>
</span><a name="line-1339"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceIf"><span class="hs-identifier hs-var">traceIf</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;reify&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621685044612"><span class="hs-identifier hs-var">th_name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">brackets</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044613"><span class="hs-identifier hs-var">ppr_ns</span></a><span> </span><a href="#local-6989586621685044612"><span class="hs-identifier hs-var">th_name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044620"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1340"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcSplice.html#tcLookupTh"><span class="hs-identifier hs-var">tcLookupTh</span></a><span> </span><a href="#local-6989586621685044620"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1341"></a><span>        </span><span class="hs-comment">-- ToDo: this tcLookup could fail, which would give a</span><span>
</span><a name="line-1342"></a><span>        </span><span class="hs-comment">--       rather unhelpful error message</span><span>
</span><a name="line-1343"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1344"></a><span>    </span><a name="local-6989586621685044613"><a href="#local-6989586621685044613"><span class="hs-identifier">ppr_ns</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.Name</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.NameG</span><span> </span><span class="hs-identifier hs-var">TH.DataName</span><span>  </span><a name="local-6989586621685044614"><a href="#local-6989586621685044614"><span class="hs-identifier">_pkg</span></a></a><span> </span><a name="local-6989586621685044615"><a href="#local-6989586621685044615"><span class="hs-identifier">_mod</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;data&quot;</span><span>
</span><a name="line-1345"></a><span>    </span><span class="hs-identifier">ppr_ns</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.Name</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.NameG</span><span> </span><span class="hs-identifier hs-var">TH.TcClsName</span><span> </span><a name="local-6989586621685044616"><a href="#local-6989586621685044616"><span class="hs-identifier">_pkg</span></a></a><span> </span><a name="local-6989586621685044617"><a href="#local-6989586621685044617"><span class="hs-identifier">_mod</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;tc&quot;</span><span>
</span><a name="line-1346"></a><span>    </span><span class="hs-identifier">ppr_ns</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.Name</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.NameG</span><span> </span><span class="hs-identifier hs-var">TH.VarName</span><span>   </span><a name="local-6989586621685044618"><a href="#local-6989586621685044618"><span class="hs-identifier">_pkg</span></a></a><span> </span><a name="local-6989586621685044619"><a href="#local-6989586621685044619"><span class="hs-identifier">_mod</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;var&quot;</span><span>
</span><a name="line-1347"></a><span>    </span><span class="hs-identifier">ppr_ns</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;reify/ppr_ns&quot;</span><span>
</span><a name="line-1348"></a><span>
</span><a name="line-1349"></a><span class="hs-identifier">reify</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TH.Info</span><span>
</span><a name="line-1350"></a><a name="reify"><a href="TcSplice.html#reify"><span class="hs-identifier">reify</span></a></a><span> </span><a name="local-6989586621685044621"><a href="#local-6989586621685044621"><span class="hs-identifier">th_name</span></a></a><span>
</span><a name="line-1351"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;reify 1&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.showName</span><span> </span><a href="#local-6989586621685044621"><span class="hs-identifier hs-var">th_name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1352"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044622"><a href="#local-6989586621685044622"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#getThing"><span class="hs-identifier hs-var">getThing</span></a><span> </span><a href="#local-6989586621685044621"><span class="hs-identifier hs-var">th_name</span></a><span>
</span><a name="line-1353"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;reify 2&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044622"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-1354"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcSplice.html#reifyThing"><span class="hs-identifier hs-var">reifyThing</span></a><span> </span><a href="#local-6989586621685044622"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1355"></a><span>
</span><a name="line-1356"></a><span class="hs-identifier">lookupThName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1357"></a><a name="lookupThName"><a href="TcSplice.html#lookupThName"><span class="hs-identifier">lookupThName</span></a></a><span> </span><a name="local-6989586621685044623"><a href="#local-6989586621685044623"><span class="hs-identifier">th_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1358"></a><span>    </span><a name="local-6989586621685044624"><a href="#local-6989586621685044624"><span class="hs-identifier">mb_name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#lookupThName_maybe"><span class="hs-identifier hs-var">lookupThName_maybe</span></a><span> </span><a href="#local-6989586621685044623"><span class="hs-identifier hs-var">th_name</span></a><span>
</span><a name="line-1359"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685044624"><span class="hs-identifier hs-var">mb_name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1360"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-special">(</span><a href="TcSplice.html#notInScope"><span class="hs-identifier hs-var">notInScope</span></a><span> </span><a href="#local-6989586621685044623"><span class="hs-identifier hs-var">th_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1361"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685044625"><a href="#local-6989586621685044625"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685044625"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1362"></a><span>
</span><a name="line-1363"></a><span class="hs-identifier">lookupThName_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">)</span><span>
</span><a name="line-1364"></a><a name="lookupThName_maybe"><a href="TcSplice.html#lookupThName_maybe"><span class="hs-identifier">lookupThName_maybe</span></a></a><span> </span><a name="local-6989586621685044626"><a href="#local-6989586621685044626"><span class="hs-identifier">th_name</span></a></a><span>
</span><a name="line-1365"></a><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044631"><a href="#local-6989586621685044631"><span class="hs-identifier">names</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapMaybeM</span><span> </span><a href="#local-6989586621685044627"><span class="hs-identifier hs-var">lookup</span></a><span> </span><span class="hs-special">(</span><a href="Convert.html#thRdrNameGuesses"><span class="hs-identifier hs-var">thRdrNameGuesses</span></a><span> </span><a href="#local-6989586621685044626"><span class="hs-identifier hs-var">th_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1366"></a><span>          </span><span class="hs-comment">-- Pick the first that works</span><span>
</span><a name="line-1367"></a><span>          </span><span class="hs-comment">-- E.g. reify (mkName &quot;A&quot;) will pick the class A in preference to the data constructor A</span><span>
</span><a name="line-1368"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">listToMaybe</span><span> </span><a href="#local-6989586621685044631"><span class="hs-identifier hs-var">names</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1369"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1370"></a><span>    </span><a name="local-6989586621685044627"><a href="#local-6989586621685044627"><span class="hs-identifier">lookup</span></a></a><span> </span><a name="local-6989586621685044628"><a href="#local-6989586621685044628"><span class="hs-identifier">rdr_name</span></a></a><span>
</span><a name="line-1371"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>  </span><span class="hs-comment">-- Repeat much of lookupOccRn, because we want</span><span>
</span><a name="line-1372"></a><span>                </span><span class="hs-comment">-- to report errors in a TH-relevant way</span><span>
</span><a name="line-1373"></a><span>             </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044629"><a href="#local-6989586621685044629"><span class="hs-identifier">rdr_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLocalRdrEnv"><span class="hs-identifier hs-var">getLocalRdrEnv</span></a><span>
</span><a name="line-1374"></a><span>             </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupLocalRdrEnv</span><span> </span><a href="#local-6989586621685044629"><span class="hs-identifier hs-var">rdr_env</span></a><span> </span><a href="#local-6989586621685044628"><span class="hs-identifier hs-var">rdr_name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1375"></a><span>                 </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685044630"><a href="#local-6989586621685044630"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685044630"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1376"></a><span>                 </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnEnv.html#lookupGlobalOccRn_maybe"><span class="hs-identifier hs-var">lookupGlobalOccRn_maybe</span></a><span> </span><a href="#local-6989586621685044628"><span class="hs-identifier hs-var">rdr_name</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1377"></a><span>
</span><a name="line-1378"></a><span class="hs-identifier">tcLookupTh</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcTyThing</span><span>
</span><a name="line-1379"></a><span class="hs-comment">-- This is a specialised version of TcEnv.tcLookup; specialised mainly in that</span><span>
</span><a name="line-1380"></a><span class="hs-comment">-- it gives a reify-related error message on failure, whereas in the normal</span><span>
</span><a name="line-1381"></a><span class="hs-comment">-- tcLookup, failure is a bug.</span><span>
</span><a name="line-1382"></a><a name="tcLookupTh"><a href="TcSplice.html#tcLookupTh"><span class="hs-identifier">tcLookupTh</span></a></a><span> </span><a name="local-6989586621685044632"><a href="#local-6989586621685044632"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-1383"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685044633"><a href="#local-6989586621685044633"><span class="hs-identifier">gbl_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044634"><a href="#local-6989586621685044634"><span class="hs-identifier">lcl_env</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getEnvs"><span class="hs-identifier hs-var">getEnvs</span></a><span>
</span><a name="line-1384"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupNameEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcl_env</span><span> </span><a href="#local-6989586621685044634"><span class="hs-identifier hs-var">lcl_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044632"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1385"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685044635"><a href="#local-6989586621685044635"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685044635"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">;</span><span>
</span><a name="line-1386"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1387"></a><span>
</span><a name="line-1388"></a><span>          </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupNameEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_type_env</span><span> </span><a href="#local-6989586621685044633"><span class="hs-identifier hs-var">gbl_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044632"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1389"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685044636"><a href="#local-6989586621685044636"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AGlobal</span><span> </span><a href="#local-6989586621685044636"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span class="hs-special">;</span><span>
</span><a name="line-1390"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1391"></a><span>
</span><a name="line-1392"></a><span>          </span><span class="hs-comment">-- EZY: I don't think this choice matters, no TH in signatures!</span><span>
</span><a name="line-1393"></a><span>          </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">nameIsLocalOrFrom</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_semantic_mod</span><span> </span><a href="#local-6989586621685044633"><span class="hs-identifier hs-var">gbl_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044632"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1394"></a><span>          </span><span class="hs-keyword">then</span><span>  </span><span class="hs-comment">-- It's defined in this module</span><span>
</span><a name="line-1395"></a><span>                </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-special">(</span><a href="TcSplice.html#notInEnv"><span class="hs-identifier hs-var">notInEnv</span></a><span> </span><a href="#local-6989586621685044632"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1396"></a><span>
</span><a name="line-1397"></a><span>          </span><span class="hs-keyword">else</span><span>
</span><a name="line-1398"></a><span>     </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044637"><a href="#local-6989586621685044637"><span class="hs-identifier">mb_thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="LoadIface.html#tcLookupImported_maybe"><span class="hs-identifier hs-var">tcLookupImported_maybe</span></a><span> </span><a href="#local-6989586621685044632"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1399"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685044637"><span class="hs-identifier hs-var">mb_thing</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1400"></a><span>            </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><a name="local-6989586621685044638"><a href="#local-6989586621685044638"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AGlobal</span><span> </span><a href="#local-6989586621685044638"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-1401"></a><span>            </span><span class="hs-identifier hs-var">Failed</span><span> </span><a name="local-6989586621685044639"><a href="#local-6989586621685044639"><span class="hs-identifier">msg</span></a></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><a href="#local-6989586621685044639"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-1402"></a><span>    </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-1403"></a><span>
</span><a name="line-1404"></a><span class="hs-identifier">notInScope</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1405"></a><a name="notInScope"><a href="TcSplice.html#notInScope"><span class="hs-identifier">notInScope</span></a></a><span> </span><a name="local-6989586621685044640"><a href="#local-6989586621685044640"><span class="hs-identifier">th_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.pprint</span><span> </span><a href="#local-6989586621685044640"><span class="hs-identifier hs-var">th_name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1406"></a><span>                     </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is not in scope at a reify&quot;</span><span>
</span><a name="line-1407"></a><span>        </span><span class="hs-comment">-- Ugh! Rather an indirect way to display the name</span><span>
</span><a name="line-1408"></a><span>
</span><a name="line-1409"></a><span class="hs-identifier">notInEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1410"></a><a name="notInEnv"><a href="TcSplice.html#notInEnv"><span class="hs-identifier">notInEnv</span></a></a><span> </span><a name="local-6989586621685044641"><a href="#local-6989586621685044641"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044641"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1411"></a><span>                     </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is not in the type environment at a reify&quot;</span><span>
</span><a name="line-1412"></a><span>
</span><a name="line-1413"></a><span class="hs-comment">------------------------------</span><span>
</span><a name="line-1414"></a><span class="hs-identifier">reifyRoles</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TH.Role</span><span class="hs-special">]</span><span>
</span><a name="line-1415"></a><a name="reifyRoles"><a href="TcSplice.html#reifyRoles"><span class="hs-identifier">reifyRoles</span></a></a><span> </span><a name="local-6989586621685044642"><a href="#local-6989586621685044642"><span class="hs-identifier">th_name</span></a></a><span>
</span><a name="line-1416"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044644"><a href="#local-6989586621685044644"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#getThing"><span class="hs-identifier hs-var">getThing</span></a><span> </span><a href="#local-6989586621685044642"><span class="hs-identifier hs-var">th_name</span></a><span>
</span><a name="line-1417"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685044644"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1418"></a><span>           </span><span class="hs-identifier hs-var">AGlobal</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ATyCon</span><span> </span><a name="local-6989586621685044645"><a href="#local-6989586621685044645"><span class="hs-identifier">tc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621685044643"><span class="hs-identifier hs-var">reify_role</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConRoles</span><span> </span><a href="#local-6989586621685044645"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1419"></a><span>           </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;No roles associated with&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044644"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1420"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-1421"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1422"></a><span>    </span><a name="local-6989586621685044643"><a href="#local-6989586621685044643"><span class="hs-identifier">reify_role</span></a></a><span> </span><span class="hs-identifier hs-var">Nominal</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.NominalR</span><span>
</span><a name="line-1423"></a><span>    </span><span class="hs-identifier">reify_role</span><span> </span><span class="hs-identifier hs-var">Representational</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.RepresentationalR</span><span>
</span><a name="line-1424"></a><span>    </span><span class="hs-identifier">reify_role</span><span> </span><span class="hs-identifier hs-var">Phantom</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.PhantomR</span><span>
</span><a name="line-1425"></a><span>
</span><a name="line-1426"></a><span class="hs-comment">------------------------------</span><span>
</span><a name="line-1427"></a><span class="hs-identifier">reifyThing</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcTyThing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TH.Info</span><span>
</span><a name="line-1428"></a><span class="hs-comment">-- The only reason this is monadic is for error reporting,</span><span>
</span><a name="line-1429"></a><span class="hs-comment">-- which in turn is mainly for the case when TH can't express</span><span>
</span><a name="line-1430"></a><span class="hs-comment">-- some random GHC extension</span><span>
</span><a name="line-1431"></a><span>
</span><a name="line-1432"></a><a name="reifyThing"><a href="TcSplice.html#reifyThing"><span class="hs-identifier">reifyThing</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AGlobal</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnId</span><span> </span><a name="local-6989586621685044646"><a href="#local-6989586621685044646"><span class="hs-identifier">id</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1433"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044647"><a href="#local-6989586621685044647"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621685044646"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-1434"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044648"><a href="#local-6989586621685044648"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><a href="#local-6989586621685044646"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-1435"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">idDetails</span><span> </span><a href="#local-6989586621685044646"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1436"></a><span>            </span><span class="hs-identifier hs-var">ClassOpId</span><span> </span><a name="local-6989586621685044649"><a href="#local-6989586621685044649"><span class="hs-identifier">cls</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.ClassOpI</span><span> </span><a href="#local-6989586621685044648"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621685044647"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><a href="#local-6989586621685044649"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1437"></a><span>            </span><span class="hs-identifier hs-var">RecSelId</span><span class="hs-special">{</span><span class="hs-identifier">sel_tycon</span><span class="hs-glyph">=</span><span class="hs-identifier hs-var">RecSelData</span><span> </span><a name="local-6989586621685044650"><a href="#local-6989586621685044650"><span class="hs-identifier">tc</span></a></a><span class="hs-special">}</span><span>
</span><a name="line-1438"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.VarI</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#reifySelector"><span class="hs-identifier hs-var">reifySelector</span></a><span> </span><a href="#local-6989586621685044646"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621685044650"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044647"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-1439"></a><span>            </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.VarI</span><span>     </span><a href="#local-6989586621685044648"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621685044647"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-1440"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-1441"></a><span>
</span><a name="line-1442"></a><span class="hs-identifier">reifyThing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AGlobal</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ATyCon</span><span> </span><a name="local-6989586621685044651"><a href="#local-6989586621685044651"><span class="hs-identifier">tc</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#reifyTyCon"><span class="hs-identifier hs-var">reifyTyCon</span></a><span> </span><a href="#local-6989586621685044651"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1443"></a><span class="hs-identifier">reifyThing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AGlobal</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AConLike</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealDataCon</span><span> </span><a name="local-6989586621685044652"><a href="#local-6989586621685044652"><span class="hs-identifier">dc</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1444"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044653"><a href="#local-6989586621685044653"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConName</span><span> </span><a href="#local-6989586621685044652"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-1445"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044654"><a href="#local-6989586621685044654"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConWrapId</span><span> </span><a href="#local-6989586621685044652"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1446"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.DataConI</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><a href="#local-6989586621685044653"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044654"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1447"></a><span>                              </span><span class="hs-special">(</span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConOrigTyCon</span><span> </span><a href="#local-6989586621685044652"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1448"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-1449"></a><span>
</span><a name="line-1450"></a><span class="hs-identifier">reifyThing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AGlobal</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AConLike</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PatSynCon</span><span> </span><a name="local-6989586621685044655"><a href="#local-6989586621685044655"><span class="hs-identifier">ps</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1451"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044656"><a href="#local-6989586621685044656"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><a href="#local-6989586621685044655"><span class="hs-identifier hs-var">ps</span></a><span>
</span><a name="line-1452"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044657"><a href="#local-6989586621685044657"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyPatSynType"><span class="hs-identifier hs-var">reifyPatSynType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">patSynSig</span><span> </span><a href="#local-6989586621685044655"><span class="hs-identifier hs-var">ps</span></a><span class="hs-special">)</span><span>
</span><a name="line-1453"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.PatSynI</span><span> </span><a href="#local-6989586621685044656"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621685044657"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1454"></a><span>
</span><a name="line-1455"></a><span class="hs-identifier">reifyThing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ATcId</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">tct_id</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685044658"><a href="#local-6989586621685044658"><span class="hs-identifier">id</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1456"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044659"><a href="#local-6989586621685044659"><span class="hs-identifier">ty1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621685044658"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Make use of all the info we have, even</span><span>
</span><a name="line-1457"></a><span>                                        </span><span class="hs-comment">-- though it may be incomplete</span><span>
</span><a name="line-1458"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044660"><a href="#local-6989586621685044660"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a><span> </span><a href="#local-6989586621685044659"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-1459"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.VarI</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><a href="#local-6989586621685044658"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044660"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1460"></a><span>
</span><a name="line-1461"></a><span class="hs-identifier">reifyThing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ATyVar</span><span> </span><a name="local-6989586621685044661"><a href="#local-6989586621685044661"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-6989586621685044662"><a href="#local-6989586621685044662"><span class="hs-identifier">tv1</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1462"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044663"><a href="#local-6989586621685044663"><span class="hs-identifier">ty1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcTyVar"><span class="hs-identifier hs-var">zonkTcTyVar</span></a><span> </span><a href="#local-6989586621685044662"><span class="hs-identifier hs-var">tv1</span></a><span>
</span><a name="line-1463"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044664"><a href="#local-6989586621685044664"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a><span> </span><a href="#local-6989586621685044663"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-1464"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.TyVarI</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><a href="#local-6989586621685044661"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044664"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1465"></a><span>
</span><a name="line-1466"></a><span class="hs-identifier">reifyThing</span><span> </span><a name="local-6989586621685044665"><a href="#local-6989586621685044665"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;reifyThing&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprTcTyThingCategory</span><span> </span><a href="#local-6989586621685044665"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-1467"></a><span>
</span><a name="line-1468"></a><span class="hs-comment">-------------------------------------------</span><span>
</span><a name="line-1469"></a><span class="hs-identifier">reifyAxBranch</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoAxBranch</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TH.TySynEqn</span><span>
</span><a name="line-1470"></a><a name="reifyAxBranch"><a href="TcSplice.html#reifyAxBranch"><span class="hs-identifier">reifyAxBranch</span></a></a><span> </span><a name="local-6989586621685044666"><a href="#local-6989586621685044666"><span class="hs-identifier">fam_tc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoAxBranch</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cab_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685044667"><a href="#local-6989586621685044667"><span class="hs-identifier">tvs</span></a></a><span>
</span><a name="line-1471"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685044668"><a href="#local-6989586621685044668"><span class="hs-identifier">lhs</span></a></a><span>
</span><a name="line-1472"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685044669"><a href="#local-6989586621685044669"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1473"></a><span>            </span><span class="hs-comment">-- remove kind patterns (#8884)</span><span>
</span><a name="line-1474"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044671"><a href="#local-6989586621685044671"><span class="hs-identifier">tvs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyTyVarsToMaybe"><span class="hs-identifier hs-var">reifyTyVarsToMaybe</span></a><span> </span><a href="#local-6989586621685044667"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-1475"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044672"><a href="#local-6989586621685044672"><span class="hs-identifier">lhs_types_only</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filterOutInvisibleTypes</span><span> </span><a href="#local-6989586621685044666"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="#local-6989586621685044668"><span class="hs-identifier hs-var">lhs</span></a><span>
</span><a name="line-1476"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044673"><a href="#local-6989586621685044673"><span class="hs-identifier">lhs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyTypes"><span class="hs-identifier hs-var">reifyTypes</span></a><span> </span><a href="#local-6989586621685044672"><span class="hs-identifier hs-var">lhs_types_only</span></a><span>
</span><a name="line-1477"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044674"><a href="#local-6989586621685044674"><span class="hs-identifier">annot_th_lhs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zipWith3M</span><span> </span><a href="TcSplice.html#annotThType"><span class="hs-identifier hs-var">annotThType</span></a><span> </span><span class="hs-special">(</span><a href="TcSplice.html#mkIsPolyTvs"><span class="hs-identifier hs-var">mkIsPolyTvs</span></a><span> </span><a href="#local-6989586621685044670"><span class="hs-identifier hs-var">fam_tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1478"></a><span>                                   </span><a href="#local-6989586621685044672"><span class="hs-identifier hs-var">lhs_types_only</span></a><span> </span><a href="#local-6989586621685044673"><span class="hs-identifier hs-var">lhs'</span></a><span>
</span><a name="line-1479"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044675"><a href="#local-6989586621685044675"><span class="hs-identifier">lhs_type</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#mkThAppTs"><span class="hs-identifier hs-var">mkThAppTs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.ConT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><a href="#local-6989586621685044666"><span class="hs-identifier hs-var">fam_tc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044674"><span class="hs-identifier hs-var">annot_th_lhs</span></a><span>
</span><a name="line-1480"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044676"><a href="#local-6989586621685044676"><span class="hs-identifier">rhs'</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a><span> </span><a href="#local-6989586621685044669"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1481"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.TySynEqn</span><span> </span><a href="#local-6989586621685044671"><span class="hs-identifier hs-var">tvs'</span></a><span> </span><a href="#local-6989586621685044675"><span class="hs-identifier hs-var">lhs_type</span></a><span> </span><a href="#local-6989586621685044676"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1482"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1483"></a><span>    </span><a name="local-6989586621685044670"><a href="#local-6989586621685044670"><span class="hs-identifier">fam_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConVisibleTyVars</span><span> </span><a href="#local-6989586621685044666"><span class="hs-identifier hs-var">fam_tc</span></a><span>
</span><a name="line-1484"></a><span>
</span><a name="line-1485"></a><span class="hs-identifier">reifyTyCon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TH.Info</span><span>
</span><a name="line-1486"></a><a name="reifyTyCon"><a href="TcSplice.html#reifyTyCon"><span class="hs-identifier">reifyTyCon</span></a></a><span> </span><a name="local-6989586621685044677"><a href="#local-6989586621685044677"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-1487"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685044678"><a href="#local-6989586621685044678"><span class="hs-identifier">cls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tyConClass_maybe</span><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1488"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#reifyClass"><span class="hs-identifier hs-var">reifyClass</span></a><span> </span><a href="#local-6989586621685044678"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-1489"></a><span>
</span><a name="line-1490"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isFunTyCon</span><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1491"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.PrimTyConI</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">2</span><span>                </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span>
</span><a name="line-1492"></a><span>
</span><a name="line-1493"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isPrimTyCon</span><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1494"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.PrimTyConI</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConArity</span><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isUnliftedTyCon</span><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1495"></a><span>
</span><a name="line-1496"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTypeFamilyTyCon</span><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1497"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044679"><a href="#local-6989586621685044679"><span class="hs-identifier">tvs</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConTyVars</span><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1498"></a><span>             </span><a name="local-6989586621685044680"><a href="#local-6989586621685044680"><span class="hs-identifier">res_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConResKind</span><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1499"></a><span>             </span><a name="local-6989586621685044681"><a href="#local-6989586621685044681"><span class="hs-identifier">resVar</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">famTcResVar</span><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1500"></a><span>
</span><a name="line-1501"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044682"><a href="#local-6989586621685044682"><span class="hs-identifier">kind'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyKind"><span class="hs-identifier hs-var">reifyKind</span></a><span> </span><a href="#local-6989586621685044680"><span class="hs-identifier hs-var">res_kind</span></a><span>
</span><a name="line-1502"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685044683"><a href="#local-6989586621685044683"><span class="hs-identifier">resultSig</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044684"><a href="#local-6989586621685044684"><span class="hs-identifier">injectivity</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1503"></a><span>                 </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685044681"><span class="hs-identifier hs-var">resVar</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1504"></a><span>                   </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.KindSig</span><span> </span><a href="#local-6989586621685044682"><span class="hs-identifier hs-var">kind'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-1505"></a><span>                   </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685044685"><a href="#local-6989586621685044685"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1506"></a><span>                     </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044686"><a href="#local-6989586621685044686"><span class="hs-identifier">thName</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><a href="#local-6989586621685044685"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1507"></a><span>                         </span><a name="local-6989586621685044687"><a href="#local-6989586621685044687"><span class="hs-identifier">injAnnot</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConInjectivityInfo</span><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1508"></a><span>                         </span><a name="local-6989586621685044688"><a href="#local-6989586621685044688"><span class="hs-identifier">sig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.TyVarSig</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.KindedTV</span><span> </span><a href="#local-6989586621685044686"><span class="hs-identifier hs-var">thName</span></a><span> </span><a href="#local-6989586621685044682"><span class="hs-identifier hs-var">kind'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1509"></a><span>                         </span><a name="local-6989586621685044689"><a href="#local-6989586621685044689"><span class="hs-identifier">inj</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685044687"><span class="hs-identifier hs-var">injAnnot</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1510"></a><span>                                 </span><span class="hs-identifier hs-var">NotInjective</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1511"></a><span>                                 </span><span class="hs-identifier hs-var">Injective</span><span> </span><a name="local-6989586621685044690"><a href="#local-6989586621685044690"><span class="hs-identifier">ms</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1512"></a><span>                                     </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.InjectivityAnn</span><span> </span><a href="#local-6989586621685044686"><span class="hs-identifier hs-var">thName</span></a><span> </span><a href="#local-6989586621685044691"><span class="hs-identifier hs-var">injRHS</span></a><span class="hs-special">)</span><span>
</span><a name="line-1513"></a><span>                                   </span><span class="hs-keyword">where</span><span>
</span><a name="line-1514"></a><span>                                     </span><a name="local-6989586621685044691"><a href="#local-6989586621685044691"><span class="hs-identifier">injRHS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">tyVarName</span><span class="hs-special">)</span><span>
</span><a name="line-1515"></a><span>                                                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filterByList</span><span> </span><a href="#local-6989586621685044690"><span class="hs-identifier hs-var">ms</span></a><span> </span><a href="#local-6989586621685044679"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1516"></a><span>                     </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044688"><span class="hs-identifier hs-var">sig</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685044689"><span class="hs-identifier hs-var">inj</span></a><span class="hs-special">)</span><span>
</span><a name="line-1517"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044692"><a href="#local-6989586621685044692"><span class="hs-identifier">tvs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyTyVars"><span class="hs-identifier hs-var">reifyTyVars</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConVisibleTyVars</span><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1518"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044693"><a href="#local-6989586621685044693"><span class="hs-identifier">tfHead</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1519"></a><span>               </span><span class="hs-identifier hs-var">TH.TypeFamilyHead</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044692"><span class="hs-identifier hs-var">tvs'</span></a><span> </span><a href="#local-6989586621685044683"><span class="hs-identifier hs-var">resultSig</span></a><span> </span><a href="#local-6989586621685044684"><span class="hs-identifier hs-var">injectivity</span></a><span>
</span><a name="line-1520"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isOpenTypeFamilyTyCon</span><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1521"></a><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044694"><a href="#local-6989586621685044694"><span class="hs-identifier">fam_envs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#tcGetFamInstEnvs"><span class="hs-identifier hs-var">tcGetFamInstEnvs</span></a><span>
</span><a name="line-1522"></a><span>                 </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044695"><a href="#local-6989586621685044695"><span class="hs-identifier">instances</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyFamilyInstances"><span class="hs-identifier hs-var">reifyFamilyInstances</span></a><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1523"></a><span>                                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">familyInstances</span><span> </span><a href="#local-6989586621685044694"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1524"></a><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.FamilyI</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.OpenTypeFamilyD</span><span> </span><a href="#local-6989586621685044693"><span class="hs-identifier hs-var">tfHead</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044695"><span class="hs-identifier hs-var">instances</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1525"></a><span>         </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044697"><a href="#local-6989586621685044697"><span class="hs-identifier">eqns</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-1526"></a><span>                     </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">isClosedSynFamilyTyConWithAxiom_maybe</span><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1527"></a><span>                       </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685044696"><a href="#local-6989586621685044696"><span class="hs-identifier">ax</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#reifyAxBranch"><span class="hs-identifier hs-var">reifyAxBranch</span></a><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1528"></a><span>                                  </span><span class="hs-identifier hs-var">fromBranches</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">coAxiomBranches</span><span> </span><a href="#local-6989586621685044696"><span class="hs-identifier hs-var">ax</span></a><span>
</span><a name="line-1529"></a><span>                       </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1530"></a><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.FamilyI</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.ClosedTypeFamilyD</span><span> </span><a href="#local-6989586621685044693"><span class="hs-identifier hs-var">tfHead</span></a><span> </span><a href="#local-6989586621685044697"><span class="hs-identifier hs-var">eqns</span></a><span class="hs-special">)</span><span>
</span><a name="line-1531"></a><span>                      </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1532"></a><span>
</span><a name="line-1533"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isDataFamilyTyCon</span><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1534"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044698"><a href="#local-6989586621685044698"><span class="hs-identifier">res_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConResKind</span><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1535"></a><span>
</span><a name="line-1536"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044699"><a href="#local-6989586621685044699"><span class="hs-identifier">kind'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#reifyKind"><span class="hs-identifier hs-var">reifyKind</span></a><span> </span><a href="#local-6989586621685044698"><span class="hs-identifier hs-var">res_kind</span></a><span class="hs-special">)</span><span>
</span><a name="line-1537"></a><span>
</span><a name="line-1538"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044700"><a href="#local-6989586621685044700"><span class="hs-identifier">tvs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyTyVars"><span class="hs-identifier hs-var">reifyTyVars</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConVisibleTyVars</span><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1539"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044701"><a href="#local-6989586621685044701"><span class="hs-identifier">fam_envs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#tcGetFamInstEnvs"><span class="hs-identifier hs-var">tcGetFamInstEnvs</span></a><span>
</span><a name="line-1540"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044702"><a href="#local-6989586621685044702"><span class="hs-identifier">instances</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyFamilyInstances"><span class="hs-identifier hs-var">reifyFamilyInstances</span></a><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">familyInstances</span><span> </span><a href="#local-6989586621685044701"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1541"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.FamilyI</span><span>
</span><a name="line-1542"></a><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.DataFamilyD</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044700"><span class="hs-identifier hs-var">tvs'</span></a><span> </span><a href="#local-6989586621685044699"><span class="hs-identifier hs-var">kind'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044702"><span class="hs-identifier hs-var">instances</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1543"></a><span>
</span><a name="line-1544"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621685044703"><a href="#local-6989586621685044703"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">synTyConDefn_maybe</span><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span>  </span><span class="hs-comment">-- Vanilla type synonym</span><span>
</span><a name="line-1545"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044704"><a href="#local-6989586621685044704"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a><span> </span><a href="#local-6989586621685044703"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1546"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044705"><a href="#local-6989586621685044705"><span class="hs-identifier">tvs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyTyVars"><span class="hs-identifier hs-var">reifyTyVars</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConVisibleTyVars</span><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1547"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.TyConI</span><span>
</span><a name="line-1548"></a><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.TySynD</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044705"><span class="hs-identifier hs-var">tvs'</span></a><span> </span><a href="#local-6989586621685044704"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1549"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-1550"></a><span>
</span><a name="line-1551"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1552"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044706"><a href="#local-6989586621685044706"><span class="hs-identifier">cxt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyCxt"><span class="hs-identifier hs-var">reifyCxt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConStupidTheta</span><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1553"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044707"><a href="#local-6989586621685044707"><span class="hs-identifier">tvs</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConTyVars</span><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1554"></a><span>              </span><a name="local-6989586621685044708"><a href="#local-6989586621685044708"><span class="hs-identifier">dataCons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConDataCons</span><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1555"></a><span>              </span><a name="local-6989586621685044709"><a href="#local-6989586621685044709"><span class="hs-identifier">isGadt</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isGadtSyntaxTyCon</span><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1556"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044710"><a href="#local-6989586621685044710"><span class="hs-identifier">cons</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#reifyDataCon"><span class="hs-identifier hs-var">reifyDataCon</span></a><span> </span><a href="#local-6989586621685044709"><span class="hs-identifier hs-var">isGadt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarTys</span><span> </span><a href="#local-6989586621685044707"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044708"><span class="hs-identifier hs-var">dataCons</span></a><span>
</span><a name="line-1557"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044711"><a href="#local-6989586621685044711"><span class="hs-identifier">r_tvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyTyVars"><span class="hs-identifier hs-var">reifyTyVars</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConVisibleTyVars</span><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1558"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044712"><a href="#local-6989586621685044712"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1559"></a><span>              </span><a name="local-6989586621685044713"><a href="#local-6989586621685044713"><span class="hs-identifier">deriv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- Don't know about deriving</span><span>
</span><a name="line-1560"></a><span>              </span><a name="local-6989586621685044714"><a href="#local-6989586621685044714"><span class="hs-identifier">decl</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isNewTyCon</span><span> </span><a href="#local-6989586621685044677"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1561"></a><span>                       </span><span class="hs-identifier hs-var">TH.NewtypeD</span><span> </span><a href="#local-6989586621685044706"><span class="hs-identifier hs-var">cxt</span></a><span> </span><a href="#local-6989586621685044712"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621685044711"><span class="hs-identifier hs-var">r_tvs</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621685044710"><span class="hs-identifier hs-var">cons</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044713"><span class="hs-identifier hs-var">deriv</span></a><span>
</span><a name="line-1562"></a><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>     </span><span class="hs-glyph">=</span><span>
</span><a name="line-1563"></a><span>                       </span><span class="hs-identifier hs-var">TH.DataD</span><span>    </span><a href="#local-6989586621685044706"><span class="hs-identifier hs-var">cxt</span></a><span> </span><a href="#local-6989586621685044712"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621685044711"><span class="hs-identifier hs-var">r_tvs</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>       </span><a href="#local-6989586621685044710"><span class="hs-identifier hs-var">cons</span></a><span>  </span><a href="#local-6989586621685044713"><span class="hs-identifier hs-var">deriv</span></a><span>
</span><a name="line-1564"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.TyConI</span><span> </span><a href="#local-6989586621685044714"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1565"></a><span>
</span><a name="line-1566"></a><span class="hs-identifier">reifyDataCon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TH.Con</span><span>
</span><a name="line-1567"></a><a name="reifyDataCon"><a href="TcSplice.html#reifyDataCon"><span class="hs-identifier">reifyDataCon</span></a></a><span> </span><a name="local-6989586621685044715"><a href="#local-6989586621685044715"><span class="hs-identifier">isGadtDataCon</span></a></a><span> </span><a name="local-6989586621685044716"><a href="#local-6989586621685044716"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-6989586621685044717"><a href="#local-6989586621685044717"><span class="hs-identifier">dc</span></a></a><span>
</span><a name="line-1568"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- used for H98 data constructors</span><span>
</span><a name="line-1569"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621685044718"><a href="#local-6989586621685044718"><span class="hs-identifier">ex_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044719"><a href="#local-6989586621685044719"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044720"><a href="#local-6989586621685044720"><span class="hs-identifier">arg_tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1570"></a><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConInstSig</span><span> </span><a href="#local-6989586621685044717"><span class="hs-identifier hs-var">dc</span></a><span> </span><a href="#local-6989586621685044716"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1571"></a><span>             </span><span class="hs-comment">-- used for GADTs data constructors</span><span>
</span><a name="line-1572"></a><span>             </span><a name="local-6989586621685044721"><a href="#local-6989586621685044721"><span class="hs-identifier">g_user_tvs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConUserTyVars</span><span> </span><a href="#local-6989586621685044717"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-1573"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621685044722"><a href="#local-6989586621685044722"><span class="hs-identifier">g_univ_tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621685044723"><a href="#local-6989586621685044723"><span class="hs-identifier">g_eq_spec</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044724"><a href="#local-6989586621685044724"><span class="hs-identifier">g_theta'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044725"><a href="#local-6989586621685044725"><span class="hs-identifier">g_arg_tys'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044726"><a href="#local-6989586621685044726"><span class="hs-identifier">g_res_ty'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1574"></a><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConFullSig</span><span> </span><a href="#local-6989586621685044717"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-1575"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621685044727"><a href="#local-6989586621685044727"><span class="hs-identifier">srcUnpks</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044728"><a href="#local-6989586621685044728"><span class="hs-identifier">srcStricts</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1576"></a><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAndUnzip</span><span> </span><a href="TcSplice.html#reifySourceBang"><span class="hs-identifier hs-var">reifySourceBang</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConSrcBangs</span><span> </span><a href="#local-6989586621685044717"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1577"></a><span>             </span><a name="local-6989586621685044729"><a href="#local-6989586621685044729"><span class="hs-identifier">dcdBangs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-identifier hs-var">TH.Bang</span><span> </span><a href="#local-6989586621685044727"><span class="hs-identifier hs-var">srcUnpks</span></a><span> </span><a href="#local-6989586621685044728"><span class="hs-identifier hs-var">srcStricts</span></a><span>
</span><a name="line-1578"></a><span>             </span><a name="local-6989586621685044730"><a href="#local-6989586621685044730"><span class="hs-identifier">fields</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConFieldLabels</span><span> </span><a href="#local-6989586621685044717"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-1579"></a><span>             </span><a name="local-6989586621685044731"><a href="#local-6989586621685044731"><span class="hs-identifier">name</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><a href="#local-6989586621685044717"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-1580"></a><span>             </span><span class="hs-comment">-- Universal tvs present in eq_spec need to be filtered out, as</span><span>
</span><a name="line-1581"></a><span>             </span><span class="hs-comment">-- they will not appear anywhere in the type.</span><span>
</span><a name="line-1582"></a><span>             </span><a name="local-6989586621685044732"><a href="#local-6989586621685044732"><span class="hs-identifier">eq_spec_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkVarSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">eqSpecTyVar</span><span> </span><a href="#local-6989586621685044723"><span class="hs-identifier hs-var">g_eq_spec</span></a><span class="hs-special">)</span><span>
</span><a name="line-1583"></a><span>
</span><a name="line-1584"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685044733"><a href="#local-6989586621685044733"><span class="hs-identifier">univ_subst</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1585"></a><span>              </span><span class="hs-comment">-- See Note [Freshen reified GADT constructors' universal tyvars]</span><span>
</span><a name="line-1586"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#freshenTyVarBndrs"><span class="hs-identifier hs-var">freshenTyVarBndrs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1587"></a><span>              </span><span class="hs-identifier hs-var">filterOut</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685044732"><span class="hs-identifier hs-var">eq_spec_tvs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044722"><span class="hs-identifier hs-var">g_univ_tvs</span></a><span>
</span><a name="line-1588"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685044734"><a href="#local-6989586621685044734"><span class="hs-identifier">tvb_subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044735"><a href="#local-6989586621685044735"><span class="hs-identifier">g_user_tvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTyVarBndrs</span><span> </span><a href="#local-6989586621685044733"><span class="hs-identifier hs-var">univ_subst</span></a><span> </span><a href="#local-6989586621685044721"><span class="hs-identifier hs-var">g_user_tvs'</span></a><span>
</span><a name="line-1589"></a><span>             </span><a name="local-6989586621685044736"><a href="#local-6989586621685044736"><span class="hs-identifier">g_theta</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTys</span><span> </span><a href="#local-6989586621685044734"><span class="hs-identifier hs-var">tvb_subst</span></a><span> </span><a href="#local-6989586621685044724"><span class="hs-identifier hs-var">g_theta'</span></a><span>
</span><a name="line-1590"></a><span>             </span><a name="local-6989586621685044737"><a href="#local-6989586621685044737"><span class="hs-identifier">g_arg_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTys</span><span> </span><a href="#local-6989586621685044734"><span class="hs-identifier hs-var">tvb_subst</span></a><span> </span><a href="#local-6989586621685044725"><span class="hs-identifier hs-var">g_arg_tys'</span></a><span>
</span><a name="line-1591"></a><span>             </span><a name="local-6989586621685044738"><a href="#local-6989586621685044738"><span class="hs-identifier">g_res_ty</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTy</span><span>  </span><a href="#local-6989586621685044734"><span class="hs-identifier hs-var">tvb_subst</span></a><span> </span><a href="#local-6989586621685044726"><span class="hs-identifier hs-var">g_res_ty'</span></a><span>
</span><a name="line-1592"></a><span>
</span><a name="line-1593"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044739"><a href="#local-6989586621685044739"><span class="hs-identifier">r_arg_tys</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyTypes"><span class="hs-identifier hs-var">reifyTypes</span></a><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621685044715"><span class="hs-identifier hs-var">isGadtDataCon</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621685044737"><span class="hs-identifier hs-var">g_arg_tys</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621685044720"><span class="hs-identifier hs-var">arg_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-1594"></a><span>
</span><a name="line-1595"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044746"><a href="#local-6989586621685044746"><span class="hs-identifier">main_con</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-1596"></a><span>           </span><span class="hs-keyword">if</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621685044730"><span class="hs-identifier hs-var">fields</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621685044715"><span class="hs-identifier hs-var">isGadtDataCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1597"></a><span>                  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TH.RecC</span><span> </span><a href="#local-6989586621685044731"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip3</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="TcSplice.html#reifyFieldLabel"><span class="hs-identifier hs-var">reifyFieldLabel</span></a><span> </span><a href="#local-6989586621685044730"><span class="hs-identifier hs-var">fields</span></a><span class="hs-special">)</span><span>
</span><a name="line-1598"></a><span>                                         </span><a href="#local-6989586621685044729"><span class="hs-identifier hs-var">dcdBangs</span></a><span> </span><a href="#local-6989586621685044739"><span class="hs-identifier hs-var">r_arg_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-1599"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621685044730"><span class="hs-identifier hs-var">fields</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1600"></a><span>                  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044740"><a href="#local-6989586621685044740"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a><span> </span><a href="#local-6989586621685044738"><span class="hs-identifier hs-var">g_res_ty</span></a><span>
</span><a name="line-1601"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TH.RecGadtC</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621685044731"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">]</span><span>
</span><a name="line-1602"></a><span>                                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip3</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">flSelector</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044730"><span class="hs-identifier hs-var">fields</span></a><span class="hs-special">)</span><span>
</span><a name="line-1603"></a><span>                                      </span><a href="#local-6989586621685044729"><span class="hs-identifier hs-var">dcdBangs</span></a><span> </span><a href="#local-6989586621685044739"><span class="hs-identifier hs-var">r_arg_tys</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044740"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1604"></a><span>                </span><span class="hs-comment">-- We need to check not isGadtDataCon here because GADT</span><span>
</span><a name="line-1605"></a><span>                </span><span class="hs-comment">-- constructors can be declared infix.</span><span>
</span><a name="line-1606"></a><span>                </span><span class="hs-comment">-- See Note [Infix GADT constructors] in TcTyClsDecls.</span><span>
</span><a name="line-1607"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">dataConIsInfix</span><span> </span><a href="#local-6989586621685044717"><span class="hs-identifier hs-var">dc</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621685044715"><span class="hs-identifier hs-var">isGadtDataCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1608"></a><span>                  </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">arg_tys</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">lengthIs</span><span class="hs-special">`</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1609"></a><span>                  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">[</span><a name="local-6989586621685044741"><a href="#local-6989586621685044741"><span class="hs-identifier">r_a1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044742"><a href="#local-6989586621685044742"><span class="hs-identifier">r_a2</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685044739"><span class="hs-identifier hs-var">r_arg_tys</span></a><span>
</span><a name="line-1610"></a><span>                        </span><span class="hs-special">[</span><a name="local-6989586621685044743"><a href="#local-6989586621685044743"><span class="hs-identifier">s1</span></a></a><span class="hs-special">,</span><span>   </span><a name="local-6989586621685044744"><a href="#local-6989586621685044744"><span class="hs-identifier">s2</span></a></a><span class="hs-special">]</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685044729"><span class="hs-identifier hs-var">dcdBangs</span></a><span>
</span><a name="line-1611"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TH.InfixC</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044743"><span class="hs-identifier hs-var">s1</span></a><span class="hs-special">,</span><a href="#local-6989586621685044741"><span class="hs-identifier hs-var">r_a1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044731"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044744"><span class="hs-identifier hs-var">s2</span></a><span class="hs-special">,</span><a href="#local-6989586621685044742"><span class="hs-identifier hs-var">r_a2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1612"></a><span>              </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685044715"><span class="hs-identifier hs-var">isGadtDataCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1613"></a><span>                  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044745"><a href="#local-6989586621685044745"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a><span> </span><a href="#local-6989586621685044738"><span class="hs-identifier hs-var">g_res_ty</span></a><span>
</span><a name="line-1614"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TH.GadtC</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621685044731"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044729"><span class="hs-identifier hs-var">dcdBangs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685044739"><span class="hs-identifier hs-var">r_arg_tys</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044745"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1615"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1616"></a><span>                  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TH.NormalC</span><span> </span><a href="#local-6989586621685044731"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044729"><span class="hs-identifier hs-var">dcdBangs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685044739"><span class="hs-identifier hs-var">r_arg_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-1617"></a><span>
</span><a name="line-1618"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685044747"><a href="#local-6989586621685044747"><span class="hs-identifier">ex_tvs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044748"><a href="#local-6989586621685044748"><span class="hs-identifier">theta'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685044715"><span class="hs-identifier hs-var">isGadtDataCon</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044735"><span class="hs-identifier hs-var">g_user_tvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685044736"><span class="hs-identifier hs-var">g_theta</span></a><span class="hs-special">)</span><span>
</span><a name="line-1619"></a><span>                               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-identifier">isTyVar</span><span> </span><span class="hs-identifier">ex_tvs</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1620"></a><span>                                                 </span><span class="hs-comment">-- no covars for haskell syntax</span><span>
</span><a name="line-1621"></a><span>                                                 </span><span class="hs-special">(</span><a href="#local-6989586621685044718"><span class="hs-identifier hs-var">ex_tvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621685044719"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">)</span><span>
</span><a name="line-1622"></a><span>             </span><a name="local-6989586621685044749"><a href="#local-6989586621685044749"><span class="hs-identifier">ret_con</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621685044747"><span class="hs-identifier hs-var">ex_tvs'</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621685044748"><span class="hs-identifier hs-var">theta'</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685044746"><span class="hs-identifier hs-var">main_con</span></a><span>
</span><a name="line-1623"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1624"></a><span>                         </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044750"><a href="#local-6989586621685044750"><span class="hs-identifier">cxt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyCxt"><span class="hs-identifier hs-var">reifyCxt</span></a><span> </span><a href="#local-6989586621685044748"><span class="hs-identifier hs-var">theta'</span></a><span>
</span><a name="line-1625"></a><span>                         </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044751"><a href="#local-6989586621685044751"><span class="hs-identifier">ex_tvs''</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyTyVars"><span class="hs-identifier hs-var">reifyTyVars</span></a><span> </span><a href="#local-6989586621685044747"><span class="hs-identifier hs-var">ex_tvs'</span></a><span>
</span><a name="line-1626"></a><span>                         </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.ForallC</span><span> </span><a href="#local-6989586621685044751"><span class="hs-identifier hs-var">ex_tvs''</span></a><span> </span><a href="#local-6989586621685044750"><span class="hs-identifier hs-var">cxt</span></a><span> </span><a href="#local-6989586621685044746"><span class="hs-identifier hs-var">main_con</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1627"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">arg_tys</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">equalLength</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">dcdBangs</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1628"></a><span>         </span><a href="#local-6989586621685044749"><span class="hs-identifier hs-var">ret_con</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1629"></a><span>
</span><a name="line-1630"></a><span class="hs-comment">{-
Note [Freshen reified GADT constructors' universal tyvars]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose one were to reify this GADT:

  data a :~: b where
    Refl :: forall a b. (a ~ b) =&gt; a :~: b

We ought to be careful here about the uniques we give to the occurrences of `a`
and `b` in this definition. That is because in the original DataCon, all uses
of `a` and `b` have the same unique, since `a` and `b` are both universally
quantified type variables--that is, they are used in both the (:~:) tycon as
well as in the constructor type signature. But when we turn the DataCon
definition into the reified one, the `a` and `b` in the constructor type
signature becomes differently scoped than the `a` and `b` in `data a :~: b`.

While it wouldn't technically be *wrong* per se to re-use the same uniques for
`a` and `b` across these two different scopes, it's somewhat annoying for end
users of Template Haskell, since they wouldn't be able to rely on the
assumption that all TH names have globally distinct uniques (#13885). For this
reason, we freshen the universally quantified tyvars that go into the reified
GADT constructor type signature to give them distinct uniques from their
counterparts in the tycon.
-}</span><span>
</span><a name="line-1654"></a><span>
</span><a name="line-1655"></a><span class="hs-comment">------------------------------</span><span>
</span><a name="line-1656"></a><span class="hs-identifier">reifyClass</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TH.Info</span><span>
</span><a name="line-1657"></a><a name="reifyClass"><a href="TcSplice.html#reifyClass"><span class="hs-identifier">reifyClass</span></a></a><span> </span><a name="local-6989586621685044752"><a href="#local-6989586621685044752"><span class="hs-identifier">cls</span></a></a><span>
</span><a name="line-1658"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044784"><a href="#local-6989586621685044784"><span class="hs-identifier">cxt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyCxt"><span class="hs-identifier hs-var">reifyCxt</span></a><span> </span><a href="#local-6989586621685044754"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-1659"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044785"><a href="#local-6989586621685044785"><span class="hs-identifier">inst_envs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcGetInstEnvs"><span class="hs-identifier hs-var">tcGetInstEnvs</span></a><span>
</span><a name="line-1660"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044786"><a href="#local-6989586621685044786"><span class="hs-identifier">insts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyClassInstances"><span class="hs-identifier hs-var">reifyClassInstances</span></a><span> </span><a href="#local-6989586621685044752"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">InstEnv.classInstances</span><span> </span><a href="#local-6989586621685044785"><span class="hs-identifier hs-var">inst_envs</span></a><span> </span><a href="#local-6989586621685044752"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-1661"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044787"><a href="#local-6989586621685044787"><span class="hs-identifier">assocTys</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">concatMapM</span><span> </span><a href="#local-6989586621685044759"><span class="hs-identifier hs-var">reifyAT</span></a><span> </span><a href="#local-6989586621685044755"><span class="hs-identifier hs-var">ats</span></a><span>
</span><a name="line-1662"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044788"><a href="#local-6989586621685044788"><span class="hs-identifier">ops</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">concatMapM</span><span> </span><a href="#local-6989586621685044758"><span class="hs-identifier hs-var">reify_op</span></a><span> </span><a href="#local-6989586621685044756"><span class="hs-identifier hs-var">op_stuff</span></a><span>
</span><a name="line-1663"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044789"><a href="#local-6989586621685044789"><span class="hs-identifier">tvs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyTyVars"><span class="hs-identifier hs-var">reifyTyVars</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConVisibleTyVars</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">classTyCon</span><span> </span><a href="#local-6989586621685044752"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1664"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044790"><a href="#local-6989586621685044790"><span class="hs-identifier">dec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.ClassD</span><span> </span><a href="#local-6989586621685044784"><span class="hs-identifier hs-var">cxt</span></a><span> </span><span class="hs-special">(</span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><a href="#local-6989586621685044752"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044789"><span class="hs-identifier hs-var">tvs'</span></a><span> </span><a href="#local-6989586621685044757"><span class="hs-identifier hs-var">fds'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044787"><span class="hs-identifier hs-var">assocTys</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685044788"><span class="hs-identifier hs-var">ops</span></a><span class="hs-special">)</span><span>
</span><a name="line-1665"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.ClassI</span><span> </span><a href="#local-6989586621685044790"><span class="hs-identifier hs-var">dec</span></a><span> </span><a href="#local-6989586621685044786"><span class="hs-identifier hs-var">insts</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1666"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1667"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621685044753"><a href="#local-6989586621685044753"><span class="hs-identifier">fds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044754"><a href="#local-6989586621685044754"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621685044755"><a href="#local-6989586621685044755"><span class="hs-identifier">ats</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044756"><a href="#local-6989586621685044756"><span class="hs-identifier">op_stuff</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">classExtraBigSig</span><span> </span><a href="#local-6989586621685044752"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-1668"></a><span>    </span><a name="local-6989586621685044757"><a href="#local-6989586621685044757"><span class="hs-identifier">fds'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="TcSplice.html#reifyFunDep"><span class="hs-identifier hs-var">reifyFunDep</span></a><span> </span><a href="#local-6989586621685044753"><span class="hs-identifier hs-var">fds</span></a><span>
</span><a name="line-1669"></a><span>    </span><a name="local-6989586621685044758"><a href="#local-6989586621685044758"><span class="hs-identifier">reify_op</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621685044763"><a href="#local-6989586621685044763"><span class="hs-identifier">op</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044764"><a href="#local-6989586621685044764"><span class="hs-identifier">def_meth</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1670"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621685044765"><a href="#local-6989586621685044765"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitMethodTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621685044763"><span class="hs-identifier hs-var">op</span></a><span class="hs-special">)</span><span>
</span><a name="line-1671"></a><span>               </span><span class="hs-comment">-- Use tcSplitMethodTy to get rid of the extraneous class</span><span>
</span><a name="line-1672"></a><span>               </span><span class="hs-comment">-- variables and predicates at the beginning of op's type</span><span>
</span><a name="line-1673"></a><span>               </span><span class="hs-comment">-- (see #15551).</span><span>
</span><a name="line-1674"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044766"><a href="#local-6989586621685044766"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a><span> </span><a href="#local-6989586621685044765"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1675"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044767"><a href="#local-6989586621685044767"><span class="hs-identifier">nm'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><a href="#local-6989586621685044763"><span class="hs-identifier hs-var">op</span></a><span>
</span><a name="line-1676"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685044764"><span class="hs-identifier hs-var">def_meth</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1677"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">GenericDM</span><span> </span><a name="local-6989586621685044768"><a href="#local-6989586621685044768"><span class="hs-identifier">gdm_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1678"></a><span>                  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044769"><a href="#local-6989586621685044769"><span class="hs-identifier">gdm_ty'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a><span> </span><a href="#local-6989586621685044768"><span class="hs-identifier hs-var">gdm_ty</span></a><span>
</span><a name="line-1679"></a><span>                     </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">TH.SigD</span><span> </span><a href="#local-6989586621685044767"><span class="hs-identifier hs-var">nm'</span></a><span> </span><a href="#local-6989586621685044766"><span class="hs-identifier hs-var">ty'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">TH.DefaultSigD</span><span> </span><a href="#local-6989586621685044767"><span class="hs-identifier hs-var">nm'</span></a><span> </span><a href="#local-6989586621685044769"><span class="hs-identifier hs-var">gdm_ty'</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1680"></a><span>                </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">TH.SigD</span><span> </span><a href="#local-6989586621685044767"><span class="hs-identifier hs-var">nm'</span></a><span> </span><a href="#local-6989586621685044766"><span class="hs-identifier hs-var">ty'</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1681"></a><span>
</span><a name="line-1682"></a><span>    </span><span class="hs-identifier">reifyAT</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ClassATItem</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TH.Dec</span><span class="hs-special">]</span><span>
</span><a name="line-1683"></a><span>    </span><a name="local-6989586621685044759"><a href="#local-6989586621685044759"><span class="hs-identifier">reifyAT</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ATI</span><span> </span><a name="local-6989586621685044770"><a href="#local-6989586621685044770"><span class="hs-identifier">tycon</span></a></a><span> </span><a name="local-6989586621685044771"><a href="#local-6989586621685044771"><span class="hs-identifier">def</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1684"></a><span>      </span><a name="local-6989586621685044772"><a href="#local-6989586621685044772"><span class="hs-identifier">tycon'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyTyCon"><span class="hs-identifier hs-var">reifyTyCon</span></a><span> </span><a href="#local-6989586621685044770"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-1685"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685044772"><span class="hs-identifier hs-var">tycon'</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1686"></a><span>        </span><span class="hs-identifier hs-var">TH.FamilyI</span><span> </span><a name="local-6989586621685044773"><a href="#local-6989586621685044773"><span class="hs-identifier">dec</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1687"></a><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685044774"><a href="#local-6989586621685044774"><span class="hs-identifier">tyName</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044775"><a href="#local-6989586621685044775"><span class="hs-identifier">tyArgs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685044761"><span class="hs-identifier hs-var">tfNames</span></a><span> </span><a href="#local-6989586621685044773"><span class="hs-identifier hs-var">dec</span></a><span>
</span><a name="line-1688"></a><span>          </span><span class="hs-special">(</span><a href="#local-6989586621685044773"><span class="hs-identifier hs-var">dec</span></a><span> </span><span class="hs-glyph">:</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1689"></a><span>                            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621685044760"><span class="hs-identifier hs-var">reifyDefImpl</span></a><span> </span><a href="#local-6989586621685044774"><span class="hs-identifier hs-var">tyName</span></a><span> </span><a href="#local-6989586621685044775"><span class="hs-identifier hs-var">tyArgs</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span>
</span><a name="line-1690"></a><span>                            </span><a href="#local-6989586621685044771"><span class="hs-identifier hs-var">def</span></a><span>
</span><a name="line-1691"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;reifyAT&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621685044772"><span class="hs-identifier hs-var">tycon'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1692"></a><span>
</span><a name="line-1693"></a><span>    </span><span class="hs-identifier">reifyDefImpl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TH.Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TH.Dec</span><span>
</span><a name="line-1694"></a><span>    </span><a name="local-6989586621685044760"><a href="#local-6989586621685044760"><span class="hs-identifier">reifyDefImpl</span></a></a><span> </span><a name="local-6989586621685044776"><a href="#local-6989586621685044776"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621685044777"><a href="#local-6989586621685044777"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621685044778"><a href="#local-6989586621685044778"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1695"></a><span>      </span><span class="hs-identifier hs-var">TH.TySynInstD</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">TH.TySynEqn</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#mkThAppTs"><span class="hs-identifier hs-var">mkThAppTs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.ConT</span><span> </span><a href="#local-6989586621685044776"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">TH.VarT</span><span> </span><a href="#local-6989586621685044777"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1696"></a><span>                                  </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcSplice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a><span> </span><a href="#local-6989586621685044778"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1697"></a><span>
</span><a name="line-1698"></a><span>    </span><span class="hs-identifier">tfNames</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.Dec</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TH.Name</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TH.Name</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1699"></a><span>    </span><a name="local-6989586621685044761"><a href="#local-6989586621685044761"><span class="hs-identifier">tfNames</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.OpenTypeFamilyD</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.TypeFamilyHead</span><span> </span><a name="local-6989586621685044779"><a href="#local-6989586621685044779"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621685044780"><a href="#local-6989586621685044780"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1700"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044779"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621685044762"><span class="hs-identifier hs-var">bndrName</span></a><span> </span><a href="#local-6989586621685044780"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1701"></a><span>    </span><span class="hs-identifier">tfNames</span><span> </span><a name="local-6989586621685044781"><a href="#local-6989586621685044781"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;tfNames&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621685044781"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1702"></a><span>
</span><a name="line-1703"></a><span>    </span><span class="hs-identifier">bndrName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.TyVarBndr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TH.Name</span><span>
</span><a name="line-1704"></a><span>    </span><a name="local-6989586621685044762"><a href="#local-6989586621685044762"><span class="hs-identifier">bndrName</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.PlainTV</span><span> </span><a name="local-6989586621685044782"><a href="#local-6989586621685044782"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685044782"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1705"></a><span>    </span><span class="hs-identifier">bndrName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.KindedTV</span><span> </span><a name="local-6989586621685044783"><a href="#local-6989586621685044783"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685044783"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1706"></a><span>
</span><a name="line-1707"></a><span class="hs-comment">------------------------------</span><span>
</span><a name="line-1708"></a><span class="hs-comment">-- | Annotate (with TH.SigT) a type if the first parameter is True</span><span>
</span><a name="line-1709"></a><span class="hs-comment">-- and if the type contains a free variable.</span><span>
</span><a name="line-1710"></a><span class="hs-comment">-- This is used to annotate type patterns for poly-kinded tyvars in</span><span>
</span><a name="line-1711"></a><span class="hs-comment">-- reifying class and type instances. See #8953 and th/T8953.</span><span>
</span><a name="line-1712"></a><span class="hs-identifier">annotThType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>   </span><span class="hs-comment">-- True &lt;=&gt; annotate</span><span>
</span><a name="line-1713"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCoRep.Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TH.Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TH.Type</span><span>
</span><a name="line-1714"></a><span>  </span><span class="hs-comment">-- tiny optimization: if the type is annotated, don't annotate again.</span><span>
</span><a name="line-1715"></a><a name="annotThType"><a href="TcSplice.html#annotThType"><span class="hs-identifier">annotThType</span></a></a><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-identifier">_</span><span>  </span><a name="local-6989586621685044791"><a href="#local-6989586621685044791"><span class="hs-identifier">th_ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.SigT</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685044791"><span class="hs-identifier hs-var">th_ty</span></a><span>
</span><a name="line-1716"></a><span class="hs-identifier">annotThType</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a name="local-6989586621685044792"><a href="#local-6989586621685044792"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621685044793"><a href="#local-6989586621685044793"><span class="hs-identifier">th_ty</span></a></a><span>
</span><a name="line-1717"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">isEmptyVarSet</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">filterVarSet</span><span> </span><span class="hs-identifier hs-var">isTyVar</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">tyCoVarsOfType</span><span> </span><a href="#local-6989586621685044792"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1718"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044794"><a href="#local-6989586621685044794"><span class="hs-identifier">ki</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcTypeKind</span><span> </span><a href="#local-6989586621685044792"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1719"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044795"><a href="#local-6989586621685044795"><span class="hs-identifier">th_ki</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyKind"><span class="hs-identifier hs-var">reifyKind</span></a><span> </span><a href="#local-6989586621685044794"><span class="hs-identifier hs-var">ki</span></a><span>
</span><a name="line-1720"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.SigT</span><span> </span><a href="#local-6989586621685044793"><span class="hs-identifier hs-var">th_ty</span></a><span> </span><a href="#local-6989586621685044795"><span class="hs-identifier hs-var">th_ki</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1721"></a><span class="hs-identifier">annotThType</span><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621685044796"><a href="#local-6989586621685044796"><span class="hs-identifier">th_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685044796"><span class="hs-identifier hs-var">th_ty</span></a><span>
</span><a name="line-1722"></a><span>
</span><a name="line-1723"></a><span class="hs-comment">-- | For every type variable in the input,</span><span>
</span><a name="line-1724"></a><span class="hs-comment">-- report whether or not the tv is poly-kinded. This is used to eventually</span><span>
</span><a name="line-1725"></a><span class="hs-comment">-- feed into 'annotThType'.</span><span>
</span><a name="line-1726"></a><span class="hs-identifier">mkIsPolyTvs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">]</span><span>
</span><a name="line-1727"></a><a name="mkIsPolyTvs"><a href="TcSplice.html#mkIsPolyTvs"><span class="hs-identifier">mkIsPolyTvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621685044797"><span class="hs-identifier hs-var">is_poly_tv</span></a><span>
</span><a name="line-1728"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1729"></a><span>    </span><a name="local-6989586621685044797"><a href="#local-6989586621685044797"><span class="hs-identifier">is_poly_tv</span></a></a><span> </span><a name="local-6989586621685044798"><a href="#local-6989586621685044798"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1730"></a><span>                    </span><span class="hs-identifier hs-var">isEmptyVarSet</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1731"></a><span>                    </span><span class="hs-identifier hs-var">filterVarSet</span><span> </span><span class="hs-identifier hs-var">isTyVar</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1732"></a><span>                    </span><span class="hs-identifier hs-var">tyCoVarsOfType</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1733"></a><span>                    </span><span class="hs-identifier hs-var">tyVarKind</span><span> </span><a href="#local-6989586621685044798"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1734"></a><span>
</span><a name="line-1735"></a><span class="hs-comment">------------------------------</span><span>
</span><a name="line-1736"></a><span class="hs-identifier">reifyClassInstances</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ClsInst</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TH.Dec</span><span class="hs-special">]</span><span>
</span><a name="line-1737"></a><a name="reifyClassInstances"><a href="TcSplice.html#reifyClassInstances"><span class="hs-identifier">reifyClassInstances</span></a></a><span> </span><a name="local-6989586621685044799"><a href="#local-6989586621685044799"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621685044800"><a href="#local-6989586621685044800"><span class="hs-identifier">insts</span></a></a><span>
</span><a name="line-1738"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#reifyClassInstance"><span class="hs-identifier hs-var">reifyClassInstance</span></a><span> </span><span class="hs-special">(</span><a href="TcSplice.html#mkIsPolyTvs"><span class="hs-identifier hs-var">mkIsPolyTvs</span></a><span> </span><a href="#local-6989586621685044801"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044800"><span class="hs-identifier hs-var">insts</span></a><span>
</span><a name="line-1739"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1740"></a><span>    </span><a name="local-6989586621685044801"><a href="#local-6989586621685044801"><span class="hs-identifier">tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConVisibleTyVars</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">classTyCon</span><span> </span><a href="#local-6989586621685044799"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-1741"></a><span>
</span><a name="line-1742"></a><span class="hs-identifier">reifyClassInstance</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- True &lt;=&gt; the corresponding tv is poly-kinded</span><span>
</span><a name="line-1743"></a><span>                              </span><span class="hs-comment">-- includes only *visible* tvs</span><span>
</span><a name="line-1744"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ClsInst</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TH.Dec</span><span>
</span><a name="line-1745"></a><a name="reifyClassInstance"><a href="TcSplice.html#reifyClassInstance"><span class="hs-identifier">reifyClassInstance</span></a></a><span> </span><a name="local-6989586621685044802"><a href="#local-6989586621685044802"><span class="hs-identifier">is_poly_tvs</span></a></a><span> </span><a name="local-6989586621685044803"><a href="#local-6989586621685044803"><span class="hs-identifier">i</span></a></a><span>
</span><a name="line-1746"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044811"><a href="#local-6989586621685044811"><span class="hs-identifier">cxt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyCxt"><span class="hs-identifier hs-var">reifyCxt</span></a><span> </span><a href="#local-6989586621685044805"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-1747"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044812"><a href="#local-6989586621685044812"><span class="hs-identifier">vis_types</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filterOutInvisibleTypes</span><span> </span><a href="#local-6989586621685044808"><span class="hs-identifier hs-var">cls_tc</span></a><span> </span><a href="#local-6989586621685044807"><span class="hs-identifier hs-var">types</span></a><span>
</span><a name="line-1748"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044813"><a href="#local-6989586621685044813"><span class="hs-identifier">thtypes</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyTypes"><span class="hs-identifier hs-var">reifyTypes</span></a><span> </span><a href="#local-6989586621685044812"><span class="hs-identifier hs-var">vis_types</span></a><span>
</span><a name="line-1749"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044814"><a href="#local-6989586621685044814"><span class="hs-identifier">annot_thtypes</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zipWith3M</span><span> </span><a href="TcSplice.html#annotThType"><span class="hs-identifier hs-var">annotThType</span></a><span> </span><a href="#local-6989586621685044802"><span class="hs-identifier hs-var">is_poly_tvs</span></a><span> </span><a href="#local-6989586621685044812"><span class="hs-identifier hs-var">vis_types</span></a><span> </span><a href="#local-6989586621685044813"><span class="hs-identifier hs-var">thtypes</span></a><span>
</span><a name="line-1750"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044815"><a href="#local-6989586621685044815"><span class="hs-identifier">head_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#mkThAppTs"><span class="hs-identifier hs-var">mkThAppTs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.ConT</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><a href="#local-6989586621685044806"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044814"><span class="hs-identifier hs-var">annot_thtypes</span></a><span>
</span><a name="line-1751"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.InstanceD</span><span> </span><a href="#local-6989586621685044810"><span class="hs-identifier hs-var">over</span></a><span> </span><a href="#local-6989586621685044811"><span class="hs-identifier hs-var">cxt</span></a><span> </span><a href="#local-6989586621685044815"><span class="hs-identifier hs-var">head_ty</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1752"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1753"></a><span>     </span><span class="hs-special">(</span><a name="local-6989586621685044804"><a href="#local-6989586621685044804"><span class="hs-identifier">_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044805"><a href="#local-6989586621685044805"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044806"><a href="#local-6989586621685044806"><span class="hs-identifier">cls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044807"><a href="#local-6989586621685044807"><span class="hs-identifier">types</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitDFunTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621685044809"><span class="hs-identifier hs-var">dfun</span></a><span class="hs-special">)</span><span>
</span><a name="line-1754"></a><span>     </span><a name="local-6989586621685044808"><a href="#local-6989586621685044808"><span class="hs-identifier">cls_tc</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">classTyCon</span><span> </span><a href="#local-6989586621685044806"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-1755"></a><span>     </span><a name="local-6989586621685044809"><a href="#local-6989586621685044809"><span class="hs-identifier">dfun</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">instanceDFunId</span><span> </span><a href="#local-6989586621685044803"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-1756"></a><span>     </span><a name="local-6989586621685044810"><a href="#local-6989586621685044810"><span class="hs-identifier">over</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">overlapMode</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">is_flag</span><span> </span><a href="#local-6989586621685044803"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1757"></a><span>                  </span><span class="hs-identifier hs-var">NoOverlap</span><span> </span><span class="hs-identifier">_</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1758"></a><span>                  </span><span class="hs-identifier hs-var">Overlappable</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">TH.Overlappable</span><span>
</span><a name="line-1759"></a><span>                  </span><span class="hs-identifier hs-var">Overlapping</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">TH.Overlapping</span><span>
</span><a name="line-1760"></a><span>                  </span><span class="hs-identifier hs-var">Overlaps</span><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">TH.Overlaps</span><span>
</span><a name="line-1761"></a><span>                  </span><span class="hs-identifier hs-var">Incoherent</span><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">TH.Incoherent</span><span>
</span><a name="line-1762"></a><span>
</span><a name="line-1763"></a><span class="hs-comment">------------------------------</span><span>
</span><a name="line-1764"></a><span class="hs-identifier">reifyFamilyInstances</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FamInst</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TH.Dec</span><span class="hs-special">]</span><span>
</span><a name="line-1765"></a><a name="reifyFamilyInstances"><a href="TcSplice.html#reifyFamilyInstances"><span class="hs-identifier">reifyFamilyInstances</span></a></a><span> </span><a name="local-6989586621685044816"><a href="#local-6989586621685044816"><span class="hs-identifier">fam_tc</span></a></a><span> </span><a name="local-6989586621685044817"><a href="#local-6989586621685044817"><span class="hs-identifier">fam_insts</span></a></a><span>
</span><a name="line-1766"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#reifyFamilyInstance"><span class="hs-identifier hs-var">reifyFamilyInstance</span></a><span> </span><span class="hs-special">(</span><a href="TcSplice.html#mkIsPolyTvs"><span class="hs-identifier hs-var">mkIsPolyTvs</span></a><span> </span><a href="#local-6989586621685044818"><span class="hs-identifier hs-var">fam_tvs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044817"><span class="hs-identifier hs-var">fam_insts</span></a><span>
</span><a name="line-1767"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1768"></a><span>    </span><a name="local-6989586621685044818"><a href="#local-6989586621685044818"><span class="hs-identifier">fam_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConVisibleTyVars</span><span> </span><a href="#local-6989586621685044816"><span class="hs-identifier hs-var">fam_tc</span></a><span>
</span><a name="line-1769"></a><span>
</span><a name="line-1770"></a><span class="hs-identifier">reifyFamilyInstance</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- True &lt;=&gt; the corresponding tv is poly-kinded</span><span>
</span><a name="line-1771"></a><span>                              </span><span class="hs-comment">-- includes only *visible* tvs</span><span>
</span><a name="line-1772"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FamInst</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TH.Dec</span><span>
</span><a name="line-1773"></a><a name="reifyFamilyInstance"><a href="TcSplice.html#reifyFamilyInstance"><span class="hs-identifier">reifyFamilyInstance</span></a></a><span> </span><a name="local-6989586621685044819"><a href="#local-6989586621685044819"><span class="hs-identifier">is_poly_tvs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FamInst</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fi_flavor</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685044820"><a href="#local-6989586621685044820"><span class="hs-identifier">flavor</span></a></a><span>
</span><a name="line-1774"></a><span>                                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fi_axiom</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685044821"><a href="#local-6989586621685044821"><span class="hs-identifier">ax</span></a></a><span>
</span><a name="line-1775"></a><span>                                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fi_fam</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685044822"><a href="#local-6989586621685044822"><span class="hs-identifier">fam</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1776"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044823"><a href="#local-6989586621685044823"><span class="hs-identifier">fam_tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">coAxiomTyCon</span><span> </span><a href="#local-6989586621685044821"><span class="hs-identifier hs-var">ax</span></a><span>
</span><a name="line-1777"></a><span>        </span><a name="local-6989586621685044824"><a href="#local-6989586621685044824"><span class="hs-identifier">branch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">coAxiomSingleBranch</span><span> </span><a href="#local-6989586621685044821"><span class="hs-identifier hs-var">ax</span></a><span>
</span><a name="line-1778"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">CoAxBranch</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cab_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685044825"><a href="#local-6989586621685044825"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685044826"><a href="#local-6989586621685044826"><span class="hs-identifier">lhs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685044827"><a href="#local-6989586621685044827"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621685044824"><span class="hs-identifier hs-var">branch</span></a><span>
</span><a name="line-1779"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621685044820"><span class="hs-identifier hs-var">flavor</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1780"></a><span>      </span><span class="hs-identifier hs-var">SynFamilyInst</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1781"></a><span>               </span><span class="hs-comment">-- remove kind patterns (#8884)</span><span>
</span><a name="line-1782"></a><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044828"><a href="#local-6989586621685044828"><span class="hs-identifier">th_tvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyTyVarsToMaybe"><span class="hs-identifier hs-var">reifyTyVarsToMaybe</span></a><span> </span><a href="#local-6989586621685044825"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-1783"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044829"><a href="#local-6989586621685044829"><span class="hs-identifier">lhs_types_only</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filterOutInvisibleTypes</span><span> </span><a href="#local-6989586621685044823"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="#local-6989586621685044826"><span class="hs-identifier hs-var">lhs</span></a><span>
</span><a name="line-1784"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044830"><a href="#local-6989586621685044830"><span class="hs-identifier">th_lhs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyTypes"><span class="hs-identifier hs-var">reifyTypes</span></a><span> </span><a href="#local-6989586621685044829"><span class="hs-identifier hs-var">lhs_types_only</span></a><span>
</span><a name="line-1785"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044831"><a href="#local-6989586621685044831"><span class="hs-identifier">annot_th_lhs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zipWith3M</span><span> </span><a href="TcSplice.html#annotThType"><span class="hs-identifier hs-var">annotThType</span></a><span> </span><a href="#local-6989586621685044819"><span class="hs-identifier hs-var">is_poly_tvs</span></a><span> </span><a href="#local-6989586621685044829"><span class="hs-identifier hs-var">lhs_types_only</span></a><span>
</span><a name="line-1786"></a><span>                                                   </span><a href="#local-6989586621685044830"><span class="hs-identifier hs-var">th_lhs</span></a><span>
</span><a name="line-1787"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044832"><a href="#local-6989586621685044832"><span class="hs-identifier">lhs_type</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#mkThAppTs"><span class="hs-identifier hs-var">mkThAppTs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.ConT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><a href="#local-6989586621685044822"><span class="hs-identifier hs-var">fam</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044831"><span class="hs-identifier hs-var">annot_th_lhs</span></a><span>
</span><a name="line-1788"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044833"><a href="#local-6989586621685044833"><span class="hs-identifier">th_rhs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a><span> </span><a href="#local-6989586621685044827"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1789"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.TySynInstD</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.TySynEqn</span><span> </span><a href="#local-6989586621685044828"><span class="hs-identifier hs-var">th_tvs</span></a><span> </span><a href="#local-6989586621685044832"><span class="hs-identifier hs-var">lhs_type</span></a><span> </span><a href="#local-6989586621685044833"><span class="hs-identifier hs-var">th_rhs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1790"></a><span>
</span><a name="line-1791"></a><span>      </span><span class="hs-identifier hs-var">DataFamilyInst</span><span> </span><a name="local-6989586621685044834"><a href="#local-6989586621685044834"><span class="hs-identifier">rep_tc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1792"></a><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- eta-expand lhs types, because sometimes data/newtype</span><span>
</span><a name="line-1793"></a><span>                 </span><span class="hs-comment">-- instances are eta-reduced; See Trac #9692</span><span>
</span><a name="line-1794"></a><span>                 </span><span class="hs-comment">-- See Note [Eta reduction for data families] in FamInstEnv</span><span>
</span><a name="line-1795"></a><span>                 </span><span class="hs-special">(</span><a name="local-6989586621685044835"><a href="#local-6989586621685044835"><span class="hs-identifier">ee_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044836"><a href="#local-6989586621685044836"><span class="hs-identifier">ee_lhs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">etaExpandCoAxBranch</span><span> </span><a href="#local-6989586621685044824"><span class="hs-identifier hs-var">branch</span></a><span>
</span><a name="line-1796"></a><span>                 </span><a name="local-6989586621685044837"><a href="#local-6989586621685044837"><span class="hs-identifier">fam'</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><a href="#local-6989586621685044822"><span class="hs-identifier hs-var">fam</span></a><span>
</span><a name="line-1797"></a><span>                 </span><a name="local-6989586621685044838"><a href="#local-6989586621685044838"><span class="hs-identifier">dataCons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConDataCons</span><span> </span><a href="#local-6989586621685044834"><span class="hs-identifier hs-var">rep_tc</span></a><span>
</span><a name="line-1798"></a><span>                 </span><a name="local-6989586621685044839"><a href="#local-6989586621685044839"><span class="hs-identifier">isGadt</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isGadtSyntaxTyCon</span><span> </span><a href="#local-6989586621685044834"><span class="hs-identifier hs-var">rep_tc</span></a><span>
</span><a name="line-1799"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044840"><a href="#local-6989586621685044840"><span class="hs-identifier">th_tvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyTyVarsToMaybe"><span class="hs-identifier hs-var">reifyTyVarsToMaybe</span></a><span> </span><a href="#local-6989586621685044835"><span class="hs-identifier hs-var">ee_tvs</span></a><span>
</span><a name="line-1800"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044841"><a href="#local-6989586621685044841"><span class="hs-identifier">cons</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#reifyDataCon"><span class="hs-identifier hs-var">reifyDataCon</span></a><span> </span><a href="#local-6989586621685044839"><span class="hs-identifier hs-var">isGadt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarTys</span><span> </span><a href="#local-6989586621685044835"><span class="hs-identifier hs-var">ee_tvs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044838"><span class="hs-identifier hs-var">dataCons</span></a><span>
</span><a name="line-1801"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044842"><a href="#local-6989586621685044842"><span class="hs-identifier">types_only</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filterOutInvisibleTypes</span><span> </span><a href="#local-6989586621685044823"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="#local-6989586621685044836"><span class="hs-identifier hs-var">ee_lhs</span></a><span>
</span><a name="line-1802"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044843"><a href="#local-6989586621685044843"><span class="hs-identifier">th_tys</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyTypes"><span class="hs-identifier hs-var">reifyTypes</span></a><span> </span><a href="#local-6989586621685044842"><span class="hs-identifier hs-var">types_only</span></a><span>
</span><a name="line-1803"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044844"><a href="#local-6989586621685044844"><span class="hs-identifier">annot_th_tys</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zipWith3M</span><span> </span><a href="TcSplice.html#annotThType"><span class="hs-identifier hs-var">annotThType</span></a><span> </span><a href="#local-6989586621685044819"><span class="hs-identifier hs-var">is_poly_tvs</span></a><span> </span><a href="#local-6989586621685044842"><span class="hs-identifier hs-var">types_only</span></a><span> </span><a href="#local-6989586621685044843"><span class="hs-identifier hs-var">th_tys</span></a><span>
</span><a name="line-1804"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044845"><a href="#local-6989586621685044845"><span class="hs-identifier">lhs_type</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#mkThAppTs"><span class="hs-identifier hs-var">mkThAppTs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.ConT</span><span> </span><a href="#local-6989586621685044837"><span class="hs-identifier hs-var">fam'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044844"><span class="hs-identifier hs-var">annot_th_tys</span></a><span>
</span><a name="line-1805"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1806"></a><span>               </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isNewTyCon</span><span> </span><a href="#local-6989586621685044834"><span class="hs-identifier hs-var">rep_tc</span></a><span>
</span><a name="line-1807"></a><span>               </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">TH.NewtypeInstD</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621685044840"><span class="hs-identifier hs-var">th_tvs</span></a><span> </span><a href="#local-6989586621685044845"><span class="hs-identifier hs-var">lhs_type</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621685044841"><span class="hs-identifier hs-var">cons</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1808"></a><span>               </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">TH.DataInstD</span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621685044840"><span class="hs-identifier hs-var">th_tvs</span></a><span> </span><a href="#local-6989586621685044845"><span class="hs-identifier hs-var">lhs_type</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>       </span><a href="#local-6989586621685044841"><span class="hs-identifier hs-var">cons</span></a><span>  </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1809"></a><span>           </span><span class="hs-special">}</span><span>
</span><a name="line-1810"></a><span>
</span><a name="line-1811"></a><span class="hs-comment">------------------------------</span><span>
</span><a name="line-1812"></a><span class="hs-identifier">reifyType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCoRep.Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TH.Type</span><span>
</span><a name="line-1813"></a><span class="hs-comment">-- Monadic only because of failure</span><span>
</span><a name="line-1814"></a><a name="reifyType"><a href="TcSplice.html#reifyType"><span class="hs-identifier">reifyType</span></a></a><span> </span><a name="local-6989586621685044846"><a href="#local-6989586621685044846"><span class="hs-identifier">ty</span></a></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">tcIsLiftedTypeKind</span><span> </span><a href="#local-6989586621685044846"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">TH.StarT</span><span>
</span><a name="line-1815"></a><span>  </span><span class="hs-comment">-- Make sure to use tcIsLiftedTypeKind here, since we don't want to confuse it</span><span>
</span><a name="line-1816"></a><span>  </span><span class="hs-comment">-- with Constraint (#14869).</span><span>
</span><a name="line-1817"></a><span class="hs-identifier">reifyType</span><span> </span><a name="local-6989586621685044847"><a href="#local-6989586621685044847"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">ForAllTy</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#reify_for_all"><span class="hs-identifier hs-var">reify_for_all</span></a><span> </span><a href="#local-6989586621685044847"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1818"></a><span class="hs-identifier">reifyType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitTy</span><span> </span><a name="local-6989586621685044848"><a href="#local-6989586621685044848"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044849"><a href="#local-6989586621685044849"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyTyLit"><span class="hs-identifier hs-var">reifyTyLit</span></a><span> </span><a href="#local-6989586621685044848"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.LitT</span><span> </span><a href="#local-6989586621685044849"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1819"></a><span class="hs-identifier">reifyType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyVarTy</span><span> </span><a name="local-6989586621685044850"><a href="#local-6989586621685044850"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.VarT</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><a href="#local-6989586621685044850"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1820"></a><span class="hs-identifier">reifyType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyConApp</span><span> </span><a name="local-6989586621685044851"><a href="#local-6989586621685044851"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621685044852"><a href="#local-6989586621685044852"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#reify_tc_app"><span class="hs-identifier hs-var">reify_tc_app</span></a><span> </span><a href="#local-6989586621685044851"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621685044852"><span class="hs-identifier hs-var">tys</span></a><span>   </span><span class="hs-comment">-- Do not expand type synonyms here</span><span>
</span><a name="line-1821"></a><span class="hs-identifier">reifyType</span><span> </span><a name="local-6989586621685044853"><a href="#local-6989586621685044853"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">AppTy</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1822"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685044857"><a href="#local-6989586621685044857"><span class="hs-identifier">ty_head</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044858"><a href="#local-6989586621685044858"><span class="hs-identifier">ty_args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitAppTys</span><span> </span><a href="#local-6989586621685044853"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1823"></a><span>  </span><a name="local-6989586621685044859"><a href="#local-6989586621685044859"><span class="hs-identifier">ty_head'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a><span> </span><a href="#local-6989586621685044857"><span class="hs-identifier hs-var">ty_head</span></a><span>
</span><a name="line-1824"></a><span>  </span><a name="local-6989586621685044860"><a href="#local-6989586621685044860"><span class="hs-identifier">ty_args'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyTypes"><span class="hs-identifier hs-var">reifyTypes</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044854"><span class="hs-identifier hs-var">filter_out_invisible_args</span></a><span> </span><a href="#local-6989586621685044857"><span class="hs-identifier hs-var">ty_head</span></a><span> </span><a href="#local-6989586621685044858"><span class="hs-identifier hs-var">ty_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1825"></a><span>  </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcSplice.html#mkThAppTs"><span class="hs-identifier hs-var">mkThAppTs</span></a><span> </span><a href="#local-6989586621685044859"><span class="hs-identifier hs-var">ty_head'</span></a><span> </span><a href="#local-6989586621685044860"><span class="hs-identifier hs-var">ty_args'</span></a><span>
</span><a name="line-1826"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1827"></a><span>    </span><span class="hs-comment">-- Make sure to filter out any invisible arguments. For instance, if you</span><span>
</span><a name="line-1828"></a><span>    </span><span class="hs-comment">-- reify the following:</span><span>
</span><a name="line-1829"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1830"></a><span>    </span><span class="hs-comment">--   newtype T (f :: forall a. a -&gt; Type) = MkT (f Bool)</span><span>
</span><a name="line-1831"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1832"></a><span>    </span><span class="hs-comment">-- Then you should receive back `f Bool`, not `f Type Bool`, since the</span><span>
</span><a name="line-1833"></a><span>    </span><span class="hs-comment">-- `Type` argument is invisible (#15792).</span><span>
</span><a name="line-1834"></a><span>    </span><span class="hs-identifier">filter_out_invisible_args</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-1835"></a><span>    </span><a name="local-6989586621685044854"><a href="#local-6989586621685044854"><span class="hs-identifier">filter_out_invisible_args</span></a></a><span> </span><a name="local-6989586621685044855"><a href="#local-6989586621685044855"><span class="hs-identifier">ty_head</span></a></a><span> </span><a name="local-6989586621685044856"><a href="#local-6989586621685044856"><span class="hs-identifier">ty_args</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1836"></a><span>      </span><span class="hs-identifier hs-var">filterByList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">isVisibleArgFlag</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">appTyArgFlags</span><span> </span><a href="#local-6989586621685044855"><span class="hs-identifier hs-var">ty_head</span></a><span> </span><a href="#local-6989586621685044856"><span class="hs-identifier hs-var">ty_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1837"></a><span>                   </span><a href="#local-6989586621685044856"><span class="hs-identifier hs-var">ty_args</span></a><span>
</span><a name="line-1838"></a><span class="hs-identifier">reifyType</span><span> </span><a name="local-6989586621685044861"><a href="#local-6989586621685044861"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunTy</span><span> </span><a name="local-6989586621685044862"><a href="#local-6989586621685044862"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-6989586621685044863"><a href="#local-6989586621685044863"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1839"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isPredTy</span><span> </span><a href="#local-6989586621685044862"><span class="hs-identifier hs-var">t1</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#reify_for_all"><span class="hs-identifier hs-var">reify_for_all</span></a><span> </span><a href="#local-6989586621685044861"><span class="hs-identifier hs-var">ty</span></a><span>  </span><span class="hs-comment">-- Types like ((?x::Int) =&gt; Char -&gt; Char)</span><span>
</span><a name="line-1840"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">[</span><a name="local-6989586621685044864"><a href="#local-6989586621685044864"><span class="hs-identifier">r1</span></a></a><span class="hs-special">,</span><a name="local-6989586621685044865"><a href="#local-6989586621685044865"><span class="hs-identifier">r2</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyTypes"><span class="hs-identifier hs-var">reifyTypes</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621685044862"><span class="hs-identifier hs-var">t1</span></a><span class="hs-special">,</span><a href="#local-6989586621685044863"><span class="hs-identifier hs-var">t2</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.ArrowT</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">TH.AppT</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685044864"><span class="hs-identifier hs-var">r1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">TH.AppT</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621685044865"><span class="hs-identifier hs-var">r2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1841"></a><span class="hs-identifier">reifyType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CastTy</span><span> </span><a name="local-6989586621685044866"><a href="#local-6989586621685044866"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a><span> </span><a href="#local-6989586621685044866"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-comment">-- Casts are ignored in TH</span><span>
</span><a name="line-1842"></a><span class="hs-identifier">reifyType</span><span> </span><a name="local-6989586621685044867"><a href="#local-6989586621685044867"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoercionTy</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#noTH"><span class="hs-identifier hs-var">noTH</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sLit</span><span> </span><span class="hs-string">&quot;coercions in types&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044867"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1843"></a><span>
</span><a name="line-1844"></a><span class="hs-identifier">reify_for_all</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCoRep.Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TH.Type</span><span>
</span><a name="line-1845"></a><a name="reify_for_all"><a href="TcSplice.html#reify_for_all"><span class="hs-identifier">reify_for_all</span></a></a><span> </span><a name="local-6989586621685044868"><a href="#local-6989586621685044868"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1846"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044872"><a href="#local-6989586621685044872"><span class="hs-identifier">cxt'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyCxt"><span class="hs-identifier hs-var">reifyCxt</span></a><span> </span><a href="#local-6989586621685044870"><span class="hs-identifier hs-var">cxt</span></a><span class="hs-special">;</span><span>
</span><a name="line-1847"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044873"><a href="#local-6989586621685044873"><span class="hs-identifier">tau'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a><span> </span><a href="#local-6989586621685044871"><span class="hs-identifier hs-var">tau</span></a><span>
</span><a name="line-1848"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044874"><a href="#local-6989586621685044874"><span class="hs-identifier">tvs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyTyVars"><span class="hs-identifier hs-var">reifyTyVars</span></a><span> </span><a href="#local-6989586621685044869"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-1849"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.ForallT</span><span> </span><a href="#local-6989586621685044874"><span class="hs-identifier hs-var">tvs'</span></a><span> </span><a href="#local-6989586621685044872"><span class="hs-identifier hs-var">cxt'</span></a><span> </span><a href="#local-6989586621685044873"><span class="hs-identifier hs-var">tau'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1850"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1851"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621685044869"><a href="#local-6989586621685044869"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044870"><a href="#local-6989586621685044870"><span class="hs-identifier">cxt</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044871"><a href="#local-6989586621685044871"><span class="hs-identifier">tau</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitSigmaTy</span><span> </span><a href="#local-6989586621685044868"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1852"></a><span>
</span><a name="line-1853"></a><span class="hs-identifier">reifyTyLit</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCoRep.TyLit</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TH.TyLit</span><span>
</span><a name="line-1854"></a><a name="reifyTyLit"><a href="TcSplice.html#reifyTyLit"><span class="hs-identifier">reifyTyLit</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NumTyLit</span><span> </span><a name="local-6989586621685044875"><a href="#local-6989586621685044875"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.NumTyLit</span><span> </span><a href="#local-6989586621685044875"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-1855"></a><span class="hs-identifier">reifyTyLit</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">StrTyLit</span><span> </span><a name="local-6989586621685044876"><a href="#local-6989586621685044876"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.StrTyLit</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unpackFS</span><span> </span><a href="#local-6989586621685044876"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1856"></a><span>
</span><a name="line-1857"></a><span class="hs-identifier">reifyTypes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TH.Type</span><span class="hs-special">]</span><span>
</span><a name="line-1858"></a><a name="reifyTypes"><a href="TcSplice.html#reifyTypes"><span class="hs-identifier">reifyTypes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="TcSplice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a><span>
</span><a name="line-1859"></a><span>
</span><a name="line-1860"></a><span class="hs-identifier">reifyPatSynType</span><span>
</span><a name="line-1861"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ThetaType</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ThetaType</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TH.Type</span><span>
</span><a name="line-1862"></a><span class="hs-comment">-- reifies a pattern synonym's type and returns its *complete* type</span><span>
</span><a name="line-1863"></a><span class="hs-comment">-- signature; see NOTE [Pattern synonym signatures and Template</span><span>
</span><a name="line-1864"></a><span class="hs-comment">-- Haskell]</span><span>
</span><a name="line-1865"></a><a name="reifyPatSynType"><a href="TcSplice.html#reifyPatSynType"><span class="hs-identifier">reifyPatSynType</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621685044877"><a href="#local-6989586621685044877"><span class="hs-identifier">univTyVars</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044878"><a href="#local-6989586621685044878"><span class="hs-identifier">req</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044879"><a href="#local-6989586621685044879"><span class="hs-identifier">exTyVars</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044880"><a href="#local-6989586621685044880"><span class="hs-identifier">prov</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044881"><a href="#local-6989586621685044881"><span class="hs-identifier">argTys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044882"><a href="#local-6989586621685044882"><span class="hs-identifier">resTy</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1866"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044883"><a href="#local-6989586621685044883"><span class="hs-identifier">univTyVars'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyTyVars"><span class="hs-identifier hs-var">reifyTyVars</span></a><span> </span><a href="#local-6989586621685044877"><span class="hs-identifier hs-var">univTyVars</span></a><span>
</span><a name="line-1867"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044884"><a href="#local-6989586621685044884"><span class="hs-identifier">req'</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyCxt"><span class="hs-identifier hs-var">reifyCxt</span></a><span> </span><a href="#local-6989586621685044878"><span class="hs-identifier hs-var">req</span></a><span>
</span><a name="line-1868"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044885"><a href="#local-6989586621685044885"><span class="hs-identifier">exTyVars'</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyTyVars"><span class="hs-identifier hs-var">reifyTyVars</span></a><span> </span><a href="#local-6989586621685044879"><span class="hs-identifier hs-var">exTyVars</span></a><span>
</span><a name="line-1869"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044886"><a href="#local-6989586621685044886"><span class="hs-identifier">prov'</span></a></a><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyCxt"><span class="hs-identifier hs-var">reifyCxt</span></a><span> </span><a href="#local-6989586621685044880"><span class="hs-identifier hs-var">prov</span></a><span>
</span><a name="line-1870"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044887"><a href="#local-6989586621685044887"><span class="hs-identifier">tau'</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkFunTys</span><span> </span><a href="#local-6989586621685044881"><span class="hs-identifier hs-var">argTys</span></a><span> </span><a href="#local-6989586621685044882"><span class="hs-identifier hs-var">resTy</span></a><span class="hs-special">)</span><span>
</span><a name="line-1871"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TH.ForallT</span><span> </span><a href="#local-6989586621685044883"><span class="hs-identifier hs-var">univTyVars'</span></a><span> </span><a href="#local-6989586621685044884"><span class="hs-identifier hs-var">req'</span></a><span>
</span><a name="line-1872"></a><span>                </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TH.ForallT</span><span> </span><a href="#local-6989586621685044885"><span class="hs-identifier hs-var">exTyVars'</span></a><span> </span><a href="#local-6989586621685044886"><span class="hs-identifier hs-var">prov'</span></a><span> </span><a href="#local-6989586621685044887"><span class="hs-identifier hs-var">tau'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1873"></a><span>
</span><a name="line-1874"></a><span class="hs-identifier">reifyKind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Kind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TH.Kind</span><span>
</span><a name="line-1875"></a><a name="reifyKind"><a href="TcSplice.html#reifyKind"><span class="hs-identifier">reifyKind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a><span>
</span><a name="line-1876"></a><span>
</span><a name="line-1877"></a><span class="hs-identifier">reifyCxt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">PredType</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TH.Pred</span><span class="hs-special">]</span><span>
</span><a name="line-1878"></a><a name="reifyCxt"><a href="TcSplice.html#reifyCxt"><span class="hs-identifier">reifyCxt</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="TcSplice.html#reifyType"><span class="hs-identifier hs-var">reifyType</span></a><span>
</span><a name="line-1879"></a><span>
</span><a name="line-1880"></a><span class="hs-identifier">reifyFunDep</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TH.FunDep</span><span>
</span><a name="line-1881"></a><a name="reifyFunDep"><a href="TcSplice.html#reifyFunDep"><span class="hs-identifier">reifyFunDep</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621685044888"><a href="#local-6989586621685044888"><span class="hs-identifier">xs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044889"><a href="#local-6989586621685044889"><span class="hs-identifier">ys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.FunDep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><a href="#local-6989586621685044888"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><a href="#local-6989586621685044889"><span class="hs-identifier hs-var">ys</span></a><span class="hs-special">)</span><span>
</span><a name="line-1882"></a><span>
</span><a name="line-1883"></a><span class="hs-identifier">reifyTyVars</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TH.TyVarBndr</span><span class="hs-special">]</span><span>
</span><a name="line-1884"></a><a name="reifyTyVars"><a href="TcSplice.html#reifyTyVars"><span class="hs-identifier">reifyTyVars</span></a></a><span> </span><a name="local-6989586621685044890"><a href="#local-6989586621685044890"><span class="hs-identifier">tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621685044891"><span class="hs-identifier hs-var">reify_tv</span></a><span> </span><a href="#local-6989586621685044890"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-1885"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1886"></a><span>    </span><span class="hs-comment">-- even if the kind is *, we need to include a kind annotation,</span><span>
</span><a name="line-1887"></a><span>    </span><span class="hs-comment">-- in case a poly-kind would be inferred without the annotation.</span><span>
</span><a name="line-1888"></a><span>    </span><span class="hs-comment">-- See #8953 or test th/T8953</span><span>
</span><a name="line-1889"></a><span>    </span><a name="local-6989586621685044891"><a href="#local-6989586621685044891"><span class="hs-identifier">reify_tv</span></a></a><span> </span><a name="local-6989586621685044892"><a href="#local-6989586621685044892"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.KindedTV</span><span> </span><a href="#local-6989586621685044894"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcSplice.html#reifyKind"><span class="hs-identifier hs-var">reifyKind</span></a><span> </span><a href="#local-6989586621685044893"><span class="hs-identifier hs-var">kind</span></a><span>
</span><a name="line-1890"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1891"></a><span>        </span><a name="local-6989586621685044893"><a href="#local-6989586621685044893"><span class="hs-identifier">kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyVarKind</span><span> </span><a href="#local-6989586621685044892"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1892"></a><span>        </span><a name="local-6989586621685044894"><a href="#local-6989586621685044894"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><a href="#local-6989586621685044892"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1893"></a><span>
</span><a name="line-1894"></a><span class="hs-identifier">reifyTyVarsToMaybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TH.TyVarBndr</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1895"></a><a name="reifyTyVarsToMaybe"><a href="TcSplice.html#reifyTyVarsToMaybe"><span class="hs-identifier">reifyTyVarsToMaybe</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1896"></a><span class="hs-identifier">reifyTyVarsToMaybe</span><span> </span><a name="local-6989586621685044895"><a href="#local-6989586621685044895"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcSplice.html#reifyTyVars"><span class="hs-identifier hs-var">reifyTyVars</span></a><span> </span><a href="#local-6989586621685044895"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1897"></a><span>
</span><a name="line-1898"></a><span class="hs-comment">{-
Note [Kind annotations on TyConApps]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
A poly-kinded tycon sometimes needs a kind annotation to be unambiguous.
For example:

   type family F a :: k
   type instance F Int  = (Proxy :: * -&gt; *)
   type instance F Bool = (Proxy :: (* -&gt; *) -&gt; *)

It's hard to figure out where these annotations should appear, so we do this:
Suppose we have a tycon application (T ty1 ... tyn). Assuming that T is not
oversatured (more on this later), we can assume T's declaration is of the form
T (tvb1 :: s1) ... (tvbn :: sn) :: p. If any kind variable that
is free in p is not free in an injective position in tvb1 ... tvbn,
then we put on a kind annotation, since we would not otherwise be able to infer
the kind of the whole tycon application.

The injective positions in a tyvar binder are the injective positions in the
kind of its tyvar, provided the tyvar binder is either:

* Anonymous. For example, in the promoted data constructor '(:):

    '(:) :: forall a. a -&gt; [a] -&gt; [a]

  The second and third tyvar binders (of kinds `a` and `[a]`) are both
  anonymous, so if we had '(:) 'True '[], then the inferred kinds of 'True and
  '[] would contribute to the inferred kind of '(:) 'True '[].
* Has required visibility. For example, in the type family:

    type family Wurble k (a :: k) :: k
    Wurble :: forall k -&gt; k -&gt; k

  The first tyvar binder (of kind `forall k`) has required visibility, so if
  we had Wurble (Maybe a) Nothing, then the inferred kind of Maybe a would
  contribute to the inferred kind of Wurble (Maybe a) Nothing.

An injective position in a type is one that does not occur as an argument to
a non-injective type constructor (e.g., non-injective type families). See
injectiveVarsOfType.

How can be sure that this is correct? That is, how can we be sure that in the
event that we leave off a kind annotation, that one could infer the kind of the
tycon application from its arguments? It's essentially a proof by induction: if
we can infer the kinds of every subtree of a type, then the whole tycon
application will have an inferrable kind--unless, of course, the remainder of
the tycon application's kind has uninstantiated kind variables.

An earlier implementation of this algorithm only checked if p contained any
free variables. But this was unsatisfactory, since a datatype like this:

  data Foo = Foo (Proxy '[False, True])

Would be reified like this:

  data Foo = Foo (Proxy ('(:) False ('(:) True ('[] :: [Bool])
                                     :: [Bool]) :: [Bool]))

Which has a rather excessive amount of kind annotations. With the current
algorithm, we instead reify Foo to this:

  data Foo = Foo (Proxy ('(:) False ('(:) True ('[] :: [Bool]))))

Since in the case of '[], the kind p is [a], and there are no arguments in the
kind of '[]. On the other hand, in the case of '(:) True '[], the kind p is
(forall a. [a]), but a occurs free in the first and second arguments of the
full kind of '(:), which is (forall a. a -&gt; [a] -&gt; [a]). (See Trac #14060.)

What happens if T is oversaturated? That is, if T's kind has fewer than n
arguments, in the case that the concrete application instantiates a result
kind variable with an arrow kind? If we run out of arguments, we do not attach
a kind annotation. This should be a rare case, indeed. Here is an example:

   data T1 :: k1 -&gt; k2 -&gt; *
   data T2 :: k1 -&gt; k2 -&gt; *

   type family G (a :: k) :: k
   type instance G T1 = T2

   type instance F Char = (G T1 Bool :: (* -&gt; *) -&gt; *)   -- F from above

Here G's kind is (forall k. k -&gt; k), and the desugared RHS of that last
instance of F is (G (* -&gt; (* -&gt; *) -&gt; *) (T1 * (* -&gt; *)) Bool). According to
the algorithm above, there are 3 arguments to G so we should peel off 3
arguments in G's kind. But G's kind has only two arguments. This is the
rare special case, and we choose not to annotate the application of G with
a kind signature. After all, we needn't do this, since that instance would
be reified as:

   type instance F Char = G (T1 :: * -&gt; (* -&gt; *) -&gt; *) Bool

So the kind of G isn't ambiguous anymore due to the explicit kind annotation
on its argument. See #8953 and test th/T8953.
-}</span><span>
</span><a name="line-1992"></a><span>
</span><a name="line-1993"></a><span class="hs-identifier">reify_tc_app</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type.Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TH.Type</span><span>
</span><a name="line-1994"></a><a name="reify_tc_app"><a href="TcSplice.html#reify_tc_app"><span class="hs-identifier">reify_tc_app</span></a></a><span> </span><a name="local-6989586621685044896"><a href="#local-6989586621685044896"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621685044897"><a href="#local-6989586621685044897"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-1995"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044912"><a href="#local-6989586621685044912"><span class="hs-identifier">tys'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyTypes"><span class="hs-identifier hs-var">reifyTypes</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filterOutInvisibleTypes</span><span> </span><a href="#local-6989586621685044896"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621685044897"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-1996"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621685044902"><span class="hs-identifier hs-var">maybe_sig_t</span></a><span> </span><span class="hs-special">(</span><a href="TcSplice.html#mkThAppTs"><span class="hs-identifier hs-var">mkThAppTs</span></a><span> </span><a href="#local-6989586621685044901"><span class="hs-identifier hs-var">r_tc</span></a><span> </span><a href="#local-6989586621685044912"><span class="hs-identifier hs-var">tys'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1997"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1998"></a><span>    </span><a name="local-6989586621685044898"><a href="#local-6989586621685044898"><span class="hs-identifier">arity</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConArity</span><span> </span><a href="#local-6989586621685044896"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1999"></a><span>    </span><a name="local-6989586621685044899"><a href="#local-6989586621685044899"><span class="hs-identifier">tc_binders</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConBinders</span><span> </span><a href="#local-6989586621685044896"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-2000"></a><span>    </span><a name="local-6989586621685044900"><a href="#local-6989586621685044900"><span class="hs-identifier">tc_res_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConResKind</span><span> </span><a href="#local-6989586621685044896"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-2001"></a><span>
</span><a name="line-2002"></a><span>    </span><a name="local-6989586621685044901"><a href="#local-6989586621685044901"><span class="hs-identifier">r_tc</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isUnboxedSumTyCon</span><span> </span><a href="#local-6989586621685044896"><span class="hs-identifier hs-var">tc</span></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.UnboxedSumT</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044898"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">div</span><span class="hs-special">`</span><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span>
</span><a name="line-2003"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isUnboxedTupleTyCon</span><span> </span><a href="#local-6989586621685044896"><span class="hs-identifier hs-var">tc</span></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.UnboxedTupleT</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044898"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">div</span><span class="hs-special">`</span><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span>
</span><a name="line-2004"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isPromotedTupleTyCon</span><span> </span><a href="#local-6989586621685044896"><span class="hs-identifier hs-var">tc</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.PromotedTupleT</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044898"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">div</span><span class="hs-special">`</span><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span>
</span><a name="line-2005"></a><span>             </span><span class="hs-comment">-- See Note [Unboxed tuple RuntimeRep vars] in TyCon</span><span>
</span><a name="line-2006"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTupleTyCon</span><span> </span><a href="#local-6989586621685044896"><span class="hs-identifier hs-var">tc</span></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isPromotedDataCon</span><span> </span><a href="#local-6989586621685044896"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-2007"></a><span>                                            </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">TH.PromotedTupleT</span><span> </span><a href="#local-6989586621685044898"><span class="hs-identifier hs-var">arity</span></a><span>
</span><a name="line-2008"></a><span>                                            </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">TH.TupleT</span><span> </span><a href="#local-6989586621685044898"><span class="hs-identifier hs-var">arity</span></a><span>
</span><a name="line-2009"></a><span>         </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685044896"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">constraintKindTyConKey</span><span>
</span><a name="line-2010"></a><span>                                          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.ConstraintT</span><span>
</span><a name="line-2011"></a><span>         </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685044896"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">funTyConKey</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.ArrowT</span><span>
</span><a name="line-2012"></a><span>         </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685044896"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">listTyConKey</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.ListT</span><span>
</span><a name="line-2013"></a><span>         </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685044896"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">nilDataConKey</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.PromotedNilT</span><span>
</span><a name="line-2014"></a><span>         </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685044896"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">consDataConKey</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.PromotedConsT</span><span>
</span><a name="line-2015"></a><span>         </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685044896"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">heqTyConKey</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.EqualityT</span><span>
</span><a name="line-2016"></a><span>         </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685044896"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">eqPrimTyConKey</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.EqualityT</span><span>
</span><a name="line-2017"></a><span>         </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685044896"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">eqReprPrimTyConKey</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.ConT</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><span class="hs-identifier hs-var">coercibleTyCon</span><span class="hs-special">)</span><span>
</span><a name="line-2018"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isPromotedDataCon</span><span> </span><a href="#local-6989586621685044896"><span class="hs-identifier hs-var">tc</span></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.PromotedT</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><a href="#local-6989586621685044896"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-2019"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.ConT</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#reifyName"><span class="hs-identifier hs-var">reifyName</span></a><span> </span><a href="#local-6989586621685044896"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-2020"></a><span>
</span><a name="line-2021"></a><span>    </span><span class="hs-comment">-- See Note [Kind annotations on TyConApps]</span><span>
</span><a name="line-2022"></a><span>    </span><a name="local-6989586621685044902"><a href="#local-6989586621685044902"><span class="hs-identifier">maybe_sig_t</span></a></a><span> </span><a name="local-6989586621685044904"><a href="#local-6989586621685044904"><span class="hs-identifier">th_type</span></a></a><span>
</span><a name="line-2023"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621685044903"><span class="hs-identifier hs-var">needs_kind_sig</span></a><span>
</span><a name="line-2024"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044905"><a href="#local-6989586621685044905"><span class="hs-identifier">full_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcTypeKind</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621685044896"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621685044897"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-2025"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044906"><a href="#local-6989586621685044906"><span class="hs-identifier">th_full_kind</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#reifyKind"><span class="hs-identifier hs-var">reifyKind</span></a><span> </span><a href="#local-6989586621685044905"><span class="hs-identifier hs-var">full_kind</span></a><span>
</span><a name="line-2026"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.SigT</span><span> </span><a href="#local-6989586621685044904"><span class="hs-identifier hs-var">th_type</span></a><span> </span><a href="#local-6989586621685044906"><span class="hs-identifier hs-var">th_full_kind</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2027"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2028"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621685044904"><span class="hs-identifier hs-var">th_type</span></a><span>
</span><a name="line-2029"></a><span>
</span><a name="line-2030"></a><span>    </span><a name="local-6989586621685044903"><a href="#local-6989586621685044903"><span class="hs-identifier">needs_kind_sig</span></a></a><span>
</span><a name="line-2031"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">GT</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">compareLength</span><span> </span><a href="#local-6989586621685044897"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-6989586621685044899"><span class="hs-identifier hs-var">tc_binders</span></a><span>
</span><a name="line-2032"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2033"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2034"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685044907"><a href="#local-6989586621685044907"><span class="hs-identifier">dropped_binders</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044908"><a href="#local-6989586621685044908"><span class="hs-identifier">remaining_binders</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2035"></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitAtList</span><span>  </span><a href="#local-6989586621685044897"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-6989586621685044899"><span class="hs-identifier hs-var">tc_binders</span></a><span>
</span><a name="line-2036"></a><span>            </span><a name="local-6989586621685044909"><a href="#local-6989586621685044909"><span class="hs-identifier">result_kind</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConKind</span><span> </span><a href="#local-6989586621685044908"><span class="hs-identifier hs-var">remaining_binders</span></a><span> </span><a href="#local-6989586621685044900"><span class="hs-identifier hs-var">tc_res_kind</span></a><span>
</span><a name="line-2037"></a><span>            </span><a name="local-6989586621685044910"><a href="#local-6989586621685044910"><span class="hs-identifier">result_vars</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyCoVarsOfType</span><span> </span><a href="#local-6989586621685044909"><span class="hs-identifier hs-var">result_kind</span></a><span>
</span><a name="line-2038"></a><span>            </span><a name="local-6989586621685044911"><a href="#local-6989586621685044911"><span class="hs-identifier">dropped_vars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fvVarSet</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2039"></a><span>                           </span><span class="hs-identifier hs-var">mapUnionFV</span><span> </span><span class="hs-identifier hs-var">injectiveVarsOfBinder</span><span> </span><a href="#local-6989586621685044907"><span class="hs-identifier hs-var">dropped_binders</span></a><span>
</span><a name="line-2040"></a><span>
</span><a name="line-2041"></a><span>        </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">subVarSet</span><span> </span><a href="#local-6989586621685044910"><span class="hs-identifier hs-var">result_vars</span></a><span> </span><a href="#local-6989586621685044911"><span class="hs-identifier hs-var">dropped_vars</span></a><span class="hs-special">)</span><span>
</span><a name="line-2042"></a><span>
</span><a name="line-2043"></a><span class="hs-comment">------------------------------</span><span>
</span><a name="line-2044"></a><span class="hs-identifier">reifyName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NamedThing</span><span> </span><a href="#local-6989586621685044326"><span class="hs-identifier hs-type">n</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621685044326"><span class="hs-identifier hs-type">n</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TH.Name</span><span>
</span><a name="line-2045"></a><a name="reifyName"><a href="TcSplice.html#reifyName"><span class="hs-identifier">reifyName</span></a></a><span> </span><a name="local-6989586621685044913"><a href="#local-6989586621685044913"><span class="hs-identifier">thing</span></a></a><span>
</span><a name="line-2046"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isExternalName</span><span> </span><a href="#local-6989586621685044914"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621685044920"><span class="hs-identifier hs-var">mk_varg</span></a><span> </span><a href="#local-6989586621685044916"><span class="hs-identifier hs-var">pkg_str</span></a><span> </span><a href="#local-6989586621685044917"><span class="hs-identifier hs-var">mod_str</span></a><span> </span><a href="#local-6989586621685044918"><span class="hs-identifier hs-var">occ_str</span></a><span>
</span><a name="line-2047"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.mkNameU</span><span> </span><a href="#local-6989586621685044918"><span class="hs-identifier hs-var">occ_str</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getKey</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getUnique</span><span> </span><a href="#local-6989586621685044914"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2048"></a><span>        </span><span class="hs-comment">-- Many of the things we reify have local bindings, and</span><span>
</span><a name="line-2049"></a><span>        </span><span class="hs-comment">-- NameL's aren't supposed to appear in binding positions, so</span><span>
</span><a name="line-2050"></a><span>        </span><span class="hs-comment">-- we use NameU.  When/if we start to reify nested things, that</span><span>
</span><a name="line-2051"></a><span>        </span><span class="hs-comment">-- have free variables, we may need to generate NameL's for them.</span><span>
</span><a name="line-2052"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2053"></a><span>    </span><a name="local-6989586621685044914"><a href="#local-6989586621685044914"><span class="hs-identifier">name</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621685044913"><span class="hs-identifier hs-var">thing</span></a><span>
</span><a name="line-2054"></a><span>    </span><a name="local-6989586621685044915"><a href="#local-6989586621685044915"><span class="hs-identifier">mod</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isExternalName</span><span> </span><span class="hs-identifier hs-var">name</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">nameModule</span><span> </span><span class="hs-identifier">name</span><span>
</span><a name="line-2055"></a><span>    </span><a name="local-6989586621685044916"><a href="#local-6989586621685044916"><span class="hs-identifier">pkg_str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unitIdString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621685044915"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-2056"></a><span>    </span><a name="local-6989586621685044917"><a href="#local-6989586621685044917"><span class="hs-identifier">mod_str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">moduleNameString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621685044915"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-2057"></a><span>    </span><a name="local-6989586621685044918"><a href="#local-6989586621685044918"><span class="hs-identifier">occ_str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">occNameString</span><span> </span><a href="#local-6989586621685044919"><span class="hs-identifier hs-var">occ</span></a><span>
</span><a name="line-2058"></a><span>    </span><a name="local-6989586621685044919"><a href="#local-6989586621685044919"><span class="hs-identifier">occ</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621685044914"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-2059"></a><span>    </span><a name="local-6989586621685044920"><a href="#local-6989586621685044920"><span class="hs-identifier">mk_varg</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">OccName.isDataOcc</span><span> </span><a href="#local-6989586621685044919"><span class="hs-identifier hs-var">occ</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.mkNameG_d</span><span>
</span><a name="line-2060"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">OccName.isVarOcc</span><span>  </span><a href="#local-6989586621685044919"><span class="hs-identifier hs-var">occ</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.mkNameG_v</span><span>
</span><a name="line-2061"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">OccName.isTcOcc</span><span>   </span><a href="#local-6989586621685044919"><span class="hs-identifier hs-var">occ</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.mkNameG_tc</span><span>
</span><a name="line-2062"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;reifyName&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044914"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-2063"></a><span>
</span><a name="line-2064"></a><span class="hs-comment">-- See Note [Reifying field labels]</span><span>
</span><a name="line-2065"></a><span class="hs-identifier">reifyFieldLabel</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FieldLabel</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TH.Name</span><span>
</span><a name="line-2066"></a><a name="reifyFieldLabel"><a href="TcSplice.html#reifyFieldLabel"><span class="hs-identifier">reifyFieldLabel</span></a></a><span> </span><a name="local-6989586621685044921"><a href="#local-6989586621685044921"><span class="hs-identifier">fl</span></a></a><span>
</span><a name="line-2067"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">flIsOverloaded</span><span> </span><a href="#local-6989586621685044921"><span class="hs-identifier hs-var">fl</span></a><span>
</span><a name="line-2068"></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.Name</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.mkOccName</span><span> </span><a href="#local-6989586621685044926"><span class="hs-identifier hs-var">occ_str</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.NameQ</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.mkModName</span><span> </span><a href="#local-6989586621685044925"><span class="hs-identifier hs-var">mod_str</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2069"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.mkNameG_v</span><span> </span><a href="#local-6989586621685044924"><span class="hs-identifier hs-var">pkg_str</span></a><span> </span><a href="#local-6989586621685044925"><span class="hs-identifier hs-var">mod_str</span></a><span> </span><a href="#local-6989586621685044926"><span class="hs-identifier hs-var">occ_str</span></a><span>
</span><a name="line-2070"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2071"></a><span>    </span><a name="local-6989586621685044922"><a href="#local-6989586621685044922"><span class="hs-identifier">name</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">flSelector</span><span> </span><a href="#local-6989586621685044921"><span class="hs-identifier hs-var">fl</span></a><span>
</span><a name="line-2072"></a><span>    </span><a name="local-6989586621685044923"><a href="#local-6989586621685044923"><span class="hs-identifier">mod</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isExternalName</span><span> </span><span class="hs-identifier hs-var">name</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">nameModule</span><span> </span><span class="hs-identifier">name</span><span>
</span><a name="line-2073"></a><span>    </span><a name="local-6989586621685044924"><a href="#local-6989586621685044924"><span class="hs-identifier">pkg_str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unitIdString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621685044923"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-2074"></a><span>    </span><a name="local-6989586621685044925"><a href="#local-6989586621685044925"><span class="hs-identifier">mod_str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">moduleNameString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621685044923"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-2075"></a><span>    </span><a name="local-6989586621685044926"><a href="#local-6989586621685044926"><span class="hs-identifier">occ_str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unpackFS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">flLabel</span><span> </span><a href="#local-6989586621685044921"><span class="hs-identifier hs-var">fl</span></a><span class="hs-special">)</span><span>
</span><a name="line-2076"></a><span>
</span><a name="line-2077"></a><span class="hs-identifier">reifySelector</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TH.Name</span><span>
</span><a name="line-2078"></a><a name="reifySelector"><a href="TcSplice.html#reifySelector"><span class="hs-identifier">reifySelector</span></a></a><span> </span><a name="local-6989586621685044927"><a href="#local-6989586621685044927"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621685044928"><a href="#local-6989586621685044928"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-2079"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">find</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621685044927"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">flSelector</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConFieldLabels</span><span> </span><a href="#local-6989586621685044928"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2080"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685044929"><a href="#local-6989586621685044929"><span class="hs-identifier">fl</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSplice.html#reifyFieldLabel"><span class="hs-identifier hs-var">reifyFieldLabel</span></a><span> </span><a href="#local-6989586621685044929"><span class="hs-identifier hs-var">fl</span></a><span>
</span><a name="line-2081"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;reifySelector: missing field&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044927"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044928"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-2082"></a><span>
</span><a name="line-2083"></a><span class="hs-comment">------------------------------</span><span>
</span><a name="line-2084"></a><span class="hs-identifier">reifyFixity</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TH.Fixity</span><span class="hs-special">)</span><span>
</span><a name="line-2085"></a><a name="reifyFixity"><a href="TcSplice.html#reifyFixity"><span class="hs-identifier">reifyFixity</span></a></a><span> </span><a name="local-6989586621685044930"><a href="#local-6989586621685044930"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-2086"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621685044935"><a href="#local-6989586621685044935"><span class="hs-identifier">found</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621685044936"><a href="#local-6989586621685044936"><span class="hs-identifier">fix</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnFixity.html#lookupFixityRn_help"><span class="hs-identifier hs-var">lookupFixityRn_help</span></a><span> </span><a href="#local-6989586621685044930"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-2087"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621685044935"><span class="hs-identifier hs-var">found</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044931"><span class="hs-identifier hs-var">conv_fix</span></a><span> </span><a href="#local-6989586621685044936"><span class="hs-identifier hs-var">fix</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2088"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-2089"></a><span>      </span><a name="local-6989586621685044931"><a href="#local-6989586621685044931"><span class="hs-identifier">conv_fix</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BasicTypes.Fixity</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621685044933"><a href="#local-6989586621685044933"><span class="hs-identifier">i</span></a></a><span> </span><a name="local-6989586621685044934"><a href="#local-6989586621685044934"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.Fixity</span><span> </span><a href="#local-6989586621685044933"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044932"><span class="hs-identifier hs-var">conv_dir</span></a><span> </span><a href="#local-6989586621685044934"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span>
</span><a name="line-2090"></a><span>      </span><a name="local-6989586621685044932"><a href="#local-6989586621685044932"><span class="hs-identifier">conv_dir</span></a></a><span> </span><span class="hs-identifier hs-var">BasicTypes.InfixR</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.InfixR</span><span>
</span><a name="line-2091"></a><span>      </span><span class="hs-identifier">conv_dir</span><span> </span><span class="hs-identifier hs-var">BasicTypes.InfixL</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.InfixL</span><span>
</span><a name="line-2092"></a><span>      </span><span class="hs-identifier">conv_dir</span><span> </span><span class="hs-identifier hs-var">BasicTypes.InfixN</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.InfixN</span><span>
</span><a name="line-2093"></a><span>
</span><a name="line-2094"></a><span class="hs-identifier">reifyUnpackedness</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon.SrcUnpackedness</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TH.SourceUnpackedness</span><span>
</span><a name="line-2095"></a><a name="reifyUnpackedness"><a href="TcSplice.html#reifyUnpackedness"><span class="hs-identifier">reifyUnpackedness</span></a></a><span> </span><span class="hs-identifier hs-var">NoSrcUnpack</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.NoSourceUnpackedness</span><span>
</span><a name="line-2096"></a><span class="hs-identifier">reifyUnpackedness</span><span> </span><span class="hs-identifier hs-var">SrcNoUnpack</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.SourceNoUnpack</span><span>
</span><a name="line-2097"></a><span class="hs-identifier">reifyUnpackedness</span><span> </span><span class="hs-identifier hs-var">SrcUnpack</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.SourceUnpack</span><span>
</span><a name="line-2098"></a><span>
</span><a name="line-2099"></a><span class="hs-identifier">reifyStrictness</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon.SrcStrictness</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TH.SourceStrictness</span><span>
</span><a name="line-2100"></a><a name="reifyStrictness"><a href="TcSplice.html#reifyStrictness"><span class="hs-identifier">reifyStrictness</span></a></a><span> </span><span class="hs-identifier hs-var">NoSrcStrict</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.NoSourceStrictness</span><span>
</span><a name="line-2101"></a><span class="hs-identifier">reifyStrictness</span><span> </span><span class="hs-identifier hs-var">SrcStrict</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.SourceStrict</span><span>
</span><a name="line-2102"></a><span class="hs-identifier">reifyStrictness</span><span> </span><span class="hs-identifier hs-var">SrcLazy</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.SourceLazy</span><span>
</span><a name="line-2103"></a><span>
</span><a name="line-2104"></a><span class="hs-identifier">reifySourceBang</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon.HsSrcBang</span><span>
</span><a name="line-2105"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TH.SourceUnpackedness</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TH.SourceStrictness</span><span class="hs-special">)</span><span>
</span><a name="line-2106"></a><a name="reifySourceBang"><a href="TcSplice.html#reifySourceBang"><span class="hs-identifier">reifySourceBang</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSrcBang</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621685044937"><a href="#local-6989586621685044937"><span class="hs-identifier">u</span></a></a><span> </span><a name="local-6989586621685044938"><a href="#local-6989586621685044938"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#reifyUnpackedness"><span class="hs-identifier hs-var">reifyUnpackedness</span></a><span> </span><a href="#local-6989586621685044937"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">,</span><span> </span><a href="TcSplice.html#reifyStrictness"><span class="hs-identifier hs-var">reifyStrictness</span></a><span> </span><a href="#local-6989586621685044938"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-2107"></a><span>
</span><a name="line-2108"></a><span class="hs-identifier">reifyDecidedStrictness</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon.HsImplBang</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TH.DecidedStrictness</span><span>
</span><a name="line-2109"></a><a name="reifyDecidedStrictness"><a href="TcSplice.html#reifyDecidedStrictness"><span class="hs-identifier">reifyDecidedStrictness</span></a></a><span> </span><span class="hs-identifier hs-var">HsLazy</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.DecidedLazy</span><span>
</span><a name="line-2110"></a><span class="hs-identifier">reifyDecidedStrictness</span><span> </span><span class="hs-identifier hs-var">HsStrict</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.DecidedStrict</span><span>
</span><a name="line-2111"></a><span class="hs-identifier">reifyDecidedStrictness</span><span> </span><span class="hs-identifier hs-var">HsUnpack</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.DecidedUnpack</span><span>
</span><a name="line-2112"></a><span>
</span><a name="line-2113"></a><span class="hs-comment">------------------------------</span><span>
</span><a name="line-2114"></a><span class="hs-identifier">lookupThAnnLookup</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.AnnLookup</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">CoreAnnTarget</span><span>
</span><a name="line-2115"></a><a name="lookupThAnnLookup"><a href="TcSplice.html#lookupThAnnLookup"><span class="hs-identifier">lookupThAnnLookup</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.AnnLookupName</span><span> </span><a name="local-6989586621685044939"><a href="#local-6989586621685044939"><span class="hs-identifier">th_nm</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">NamedTarget</span><span> </span><span class="hs-special">(</span><a href="TcSplice.html#lookupThName"><span class="hs-identifier hs-var">lookupThName</span></a><span> </span><a href="#local-6989586621685044939"><span class="hs-identifier hs-var">th_nm</span></a><span class="hs-special">)</span><span>
</span><a name="line-2116"></a><span class="hs-identifier">lookupThAnnLookup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.AnnLookupModule</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.Module</span><span> </span><a name="local-6989586621685044940"><a href="#local-6989586621685044940"><span class="hs-identifier">pn</span></a></a><span> </span><a name="local-6989586621685044941"><a href="#local-6989586621685044941"><span class="hs-identifier">mn</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2117"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ModuleTarget</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2118"></a><span>    </span><span class="hs-identifier hs-var">mkModule</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">stringToUnitId</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TH.pkgString</span><span> </span><a href="#local-6989586621685044940"><span class="hs-identifier hs-var">pn</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkModuleName</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TH.modString</span><span> </span><a href="#local-6989586621685044941"><span class="hs-identifier hs-var">mn</span></a><span class="hs-special">)</span><span>
</span><a name="line-2119"></a><span>
</span><a name="line-2120"></a><span class="hs-identifier">reifyAnnotations</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Data</span><span> </span><a href="#local-6989586621685044325"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">TH.AnnLookup</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621685044325"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-2121"></a><a name="reifyAnnotations"><a href="TcSplice.html#reifyAnnotations"><span class="hs-identifier">reifyAnnotations</span></a></a><span> </span><a name="local-6989586621685044942"><a href="#local-6989586621685044942"><span class="hs-identifier">th_name</span></a></a><span>
</span><a name="line-2122"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621685044943"><a href="#local-6989586621685044943"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSplice.html#lookupThAnnLookup"><span class="hs-identifier hs-var">lookupThAnnLookup</span></a><span> </span><a href="#local-6989586621685044942"><span class="hs-identifier hs-var">th_name</span></a><span>
</span><a name="line-2123"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044944"><a href="#local-6989586621685044944"><span class="hs-identifier">topEnv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a><span>
</span><a name="line-2124"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044945"><a href="#local-6989586621685044945"><span class="hs-identifier">epsHptAnns</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">prepareAnnotations</span><span> </span><a href="#local-6989586621685044944"><span class="hs-identifier hs-var">topEnv</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-2125"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621685044946"><a href="#local-6989586621685044946"><span class="hs-identifier">tcg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-2126"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044947"><a href="#local-6989586621685044947"><span class="hs-identifier">selectedEpsHptAnns</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">findAnns</span><span> </span><span class="hs-identifier hs-var">deserializeWithData</span><span> </span><a href="#local-6989586621685044945"><span class="hs-identifier hs-var">epsHptAnns</span></a><span> </span><a href="#local-6989586621685044943"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-2127"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044948"><a href="#local-6989586621685044948"><span class="hs-identifier">selectedTcgAnns</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">findAnns</span><span> </span><span class="hs-identifier hs-var">deserializeWithData</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_ann_env</span><span> </span><a href="#local-6989586621685044946"><span class="hs-identifier hs-var">tcg</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044943"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-2128"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044947"><span class="hs-identifier hs-var">selectedEpsHptAnns</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621685044948"><span class="hs-identifier hs-var">selectedTcgAnns</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2129"></a><span>
</span><a name="line-2130"></a><span class="hs-comment">------------------------------</span><span>
</span><a name="line-2131"></a><span class="hs-identifier">modToTHMod</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TH.Module</span><span>
</span><a name="line-2132"></a><a name="modToTHMod"><a href="TcSplice.html#modToTHMod"><span class="hs-identifier">modToTHMod</span></a></a><span> </span><a name="local-6989586621685044949"><a href="#local-6989586621685044949"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.Module</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.PkgName</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unitIdString</span><span>  </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621685044949"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-2133"></a><span>                         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.ModName</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">moduleNameString</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621685044949"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-2134"></a><span>
</span><a name="line-2135"></a><span class="hs-identifier">reifyModule</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TH.ModuleInfo</span><span>
</span><a name="line-2136"></a><a name="reifyModule"><a href="TcSplice.html#reifyModule"><span class="hs-identifier">reifyModule</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.Module</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.PkgName</span><span> </span><a name="local-6989586621685044950"><a href="#local-6989586621685044950"><span class="hs-identifier">pkgString</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.ModName</span><span> </span><a name="local-6989586621685044951"><a href="#local-6989586621685044951"><span class="hs-identifier">mString</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2137"></a><span>  </span><a name="local-6989586621685044965"><a href="#local-6989586621685044965"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-2138"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044966"><a href="#local-6989586621685044966"><span class="hs-identifier">reifMod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkModule</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">stringToUnitId</span><span> </span><a href="#local-6989586621685044950"><span class="hs-identifier hs-var">pkgString</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkModuleName</span><span> </span><a href="#local-6989586621685044951"><span class="hs-identifier hs-var">mString</span></a><span class="hs-special">)</span><span>
</span><a name="line-2139"></a><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621685044966"><span class="hs-identifier hs-var">reifMod</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621685044965"><span class="hs-identifier hs-var">this_mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621685044952"><span class="hs-identifier hs-var">reifyThisModule</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621685044953"><span class="hs-identifier hs-var">reifyFromIface</span></a><span> </span><a href="#local-6989586621685044966"><span class="hs-identifier hs-var">reifMod</span></a><span>
</span><a name="line-2140"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-2141"></a><span>      </span><a name="local-6989586621685044952"><a href="#local-6989586621685044952"><span class="hs-identifier">reifyThisModule</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2142"></a><span>        </span><a name="local-6989586621685044955"><a href="#local-6989586621685044955"><span class="hs-identifier">usages</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="TcSplice.html#modToTHMod"><span class="hs-identifier hs-var">modToTHMod</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">moduleEnvKeys</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">imp_mods</span><span class="hs-special">)</span><span> </span><a href="TcRnMonad.html#getImports"><span class="hs-identifier hs-var">getImports</span></a><span>
</span><a name="line-2143"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TH.ModuleInfo</span><span> </span><a href="#local-6989586621685044955"><span class="hs-identifier hs-var">usages</span></a><span>
</span><a name="line-2144"></a><span>
</span><a name="line-2145"></a><span>      </span><a name="local-6989586621685044953"><a href="#local-6989586621685044953"><span class="hs-identifier">reifyFromIface</span></a></a><span> </span><a name="local-6989586621685044956"><a href="#local-6989586621685044956"><span class="hs-identifier">reifMod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2146"></a><span>        </span><a name="local-6989586621685044957"><a href="#local-6989586621685044957"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="LoadIface.html#loadInterfaceForModule"><span class="hs-identifier hs-var">loadInterfaceForModule</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;reifying module from TH for&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621685044956"><span class="hs-identifier hs-var">reifMod</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044956"><span class="hs-identifier hs-var">reifMod</span></a><span>
</span><a name="line-2147"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621685044958"><a href="#local-6989586621685044958"><span class="hs-identifier">usages</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="TcSplice.html#modToTHMod"><span class="hs-identifier hs-var">modToTHMod</span></a><span> </span><a href="#local-6989586621685044960"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621685044959"><a href="#local-6989586621685044959"><span class="hs-identifier">usage</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">mi_usages</span><span> </span><a href="#local-6989586621685044957"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">,</span><span>
</span><a name="line-2148"></a><span>                                     </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621685044960"><a href="#local-6989586621685044960"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621685044954"><span class="hs-identifier hs-var">usageToModule</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621685044956"><span class="hs-identifier hs-var">reifMod</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621685044959"><span class="hs-identifier hs-var">usage</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2149"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">TH.ModuleInfo</span><span> </span><a href="#local-6989586621685044958"><span class="hs-identifier hs-var">usages</span></a><span>
</span><a name="line-2150"></a><span>
</span><a name="line-2151"></a><span>      </span><span class="hs-identifier">usageToModule</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UnitId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Usage</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Module</span><span>
</span><a name="line-2152"></a><span>      </span><a name="local-6989586621685044954"><a href="#local-6989586621685044954"><span class="hs-identifier">usageToModule</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">UsageFile</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-2153"></a><span>      </span><span class="hs-identifier">usageToModule</span><span> </span><a name="local-6989586621685044961"><a href="#local-6989586621685044961"><span class="hs-identifier">this_pkg</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">UsageHomeModule</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">usg_mod_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685044962"><a href="#local-6989586621685044962"><span class="hs-identifier">mn</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkModule</span><span> </span><a href="#local-6989586621685044961"><span class="hs-identifier hs-var">this_pkg</span></a><span> </span><a href="#local-6989586621685044962"><span class="hs-identifier hs-var">mn</span></a><span>
</span><a name="line-2154"></a><span>      </span><span class="hs-identifier">usageToModule</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">UsagePackageModule</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">usg_mod</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685044963"><a href="#local-6989586621685044963"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685044963"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-2155"></a><span>      </span><span class="hs-identifier">usageToModule</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">UsageMergedRequirement</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">usg_mod</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621685044964"><a href="#local-6989586621685044964"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621685044964"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-2156"></a><span>
</span><a name="line-2157"></a><span class="hs-comment">------------------------------</span><span>
</span><a name="line-2158"></a><span class="hs-identifier">mkThAppTs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TH.Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TH.Type</span><span>
</span><a name="line-2159"></a><a name="mkThAppTs"><a href="TcSplice.html#mkThAppTs"><span class="hs-identifier">mkThAppTs</span></a></a><span> </span><a name="local-6989586621685044967"><a href="#local-6989586621685044967"><span class="hs-identifier">fun_ty</span></a></a><span> </span><a name="local-6989586621685044968"><a href="#local-6989586621685044968"><span class="hs-identifier">arg_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-identifier hs-var">TH.AppT</span><span> </span><a href="#local-6989586621685044967"><span class="hs-identifier hs-var">fun_ty</span></a><span> </span><a href="#local-6989586621685044968"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-2160"></a><span>
</span><a name="line-2161"></a><span class="hs-identifier">noTH</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PtrString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621685044324"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2162"></a><a name="noTH"><a href="TcSplice.html#noTH"><span class="hs-identifier">noTH</span></a></a><span> </span><a name="local-6989586621685044969"><a href="#local-6989586621685044969"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621685044970"><a href="#local-6989586621685044970"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hsep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Can't represent&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ptext</span><span> </span><a href="#local-6989586621685044969"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-2163"></a><span>                                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;in Template Haskell:&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-2164"></a><span>                             </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><a href="#local-6989586621685044970"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2165"></a><span>
</span><a name="line-2166"></a><span class="hs-identifier">ppr_th</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.Ppr</span><span> </span><a href="#local-6989586621685044323"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621685044323"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2167"></a><a name="ppr_th"><a href="TcSplice.html#ppr_th"><span class="hs-identifier">ppr_th</span></a></a><span> </span><a name="local-6989586621685044971"><a href="#local-6989586621685044971"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.pprint</span><span> </span><a href="#local-6989586621685044971"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-2168"></a><span>
</span><a name="line-2169"></a><span class="hs-comment">{-
Note [Reifying field labels]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When reifying a datatype declared with DuplicateRecordFields enabled, we want
the reified names of the fields to be labels rather than selector functions.
That is, we want (reify ''T) and (reify 'foo) to produce

    data T = MkT { foo :: Int }
    foo :: T -&gt; Int

rather than

    data T = MkT { $sel:foo:MkT :: Int }
    $sel:foo:MkT :: T -&gt; Int

because otherwise TH code that uses the field names as strings will silently do
the wrong thing.  Thus we use the field label (e.g. foo) as the OccName, rather
than the selector (e.g. $sel:foo:MkT).  Since the Orig name M.foo isn't in the
environment, NameG can't be used to represent such fields.  Instead,
reifyFieldLabel uses NameQ.

However, this means that extracting the field name from the output of reify, and
trying to reify it again, may fail with an ambiguity error if there are multiple
such fields defined in the module (see the test case
overloadedrecflds/should_fail/T11103.hs).  The &quot;proper&quot; fix requires changes to
the TH AST to make it able to represent duplicate record fields.
-}</span><span>
</span><a name="line-2196"></a></pre></body></html>