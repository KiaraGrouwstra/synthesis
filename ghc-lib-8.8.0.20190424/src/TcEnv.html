<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- (c) The University of Glasgow 2006</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE CPP, FlexibleInstances #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-orphans #-}</span><span>  </span><span class="hs-comment">-- instance MonadThings is necessarily an</span><span>
</span><a name="line-5"></a><span>                                       </span><span class="hs-comment">-- orphan</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span> </span><span class="hs-comment">-- Note [Pass sensitive types]</span><span>
</span><a name="line-7"></a><span>                                      </span><span class="hs-comment">-- in module PlaceHolder</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">TcEnv</span><span class="hs-special">(</span><span>
</span><a name="line-11"></a><span>        </span><span class="hs-identifier hs-type">TyThing</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcTyThing</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcId</span><span class="hs-special">,</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span>        </span><span class="hs-comment">-- Instance environment, and InstInfo type</span><span>
</span><a name="line-14"></a><span>        </span><a href="TcEnv.html#InstInfo"><span class="hs-identifier hs-type">InstInfo</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="TcEnv.html#iDFunId"><span class="hs-identifier hs-var">iDFunId</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#pprInstInfoDetails"><span class="hs-identifier hs-var">pprInstInfoDetails</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>        </span><a href="TcEnv.html#simpleInstInfoClsTy"><span class="hs-identifier hs-var">simpleInstInfoClsTy</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#simpleInstInfoTy"><span class="hs-identifier hs-var">simpleInstInfoTy</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#simpleInstInfoTyCon"><span class="hs-identifier hs-var">simpleInstInfoTyCon</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>        </span><a href="TcEnv.html#InstBindings"><span class="hs-identifier hs-type">InstBindings</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span>        </span><span class="hs-comment">-- Global environment</span><span>
</span><a name="line-19"></a><span>        </span><a href="TcEnv.html#tcExtendGlobalEnv"><span class="hs-identifier hs-var">tcExtendGlobalEnv</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcExtendTyConEnv"><span class="hs-identifier hs-var">tcExtendTyConEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>        </span><a href="TcEnv.html#tcExtendGlobalEnvImplicit"><span class="hs-identifier hs-var">tcExtendGlobalEnvImplicit</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#setGlobalTypeEnv"><span class="hs-identifier hs-var">setGlobalTypeEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>        </span><a href="TcEnv.html#tcExtendGlobalValEnv"><span class="hs-identifier hs-var">tcExtendGlobalValEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>        </span><a href="TcEnv.html#tcLookupLocatedGlobal"><span class="hs-identifier hs-var">tcLookupLocatedGlobal</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcLookupGlobal"><span class="hs-identifier hs-var">tcLookupGlobal</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcLookupGlobalOnly"><span class="hs-identifier hs-var">tcLookupGlobalOnly</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>        </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcLookupClass"><span class="hs-identifier hs-var">tcLookupClass</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>        </span><a href="TcEnv.html#tcLookupDataCon"><span class="hs-identifier hs-var">tcLookupDataCon</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcLookupPatSyn"><span class="hs-identifier hs-var">tcLookupPatSyn</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcLookupConLike"><span class="hs-identifier hs-var">tcLookupConLike</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>        </span><a href="TcEnv.html#tcLookupLocatedGlobalId"><span class="hs-identifier hs-var">tcLookupLocatedGlobalId</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcLookupLocatedTyCon"><span class="hs-identifier hs-var">tcLookupLocatedTyCon</span></a><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>        </span><a href="TcEnv.html#tcLookupLocatedClass"><span class="hs-identifier hs-var">tcLookupLocatedClass</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcLookupAxiom"><span class="hs-identifier hs-var">tcLookupAxiom</span></a><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>        </span><a href="TcEnv.html#lookupGlobal"><span class="hs-identifier hs-var">lookupGlobal</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#ioLookupDataCon"><span class="hs-identifier hs-var">ioLookupDataCon</span></a><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span>        </span><span class="hs-comment">-- Local environment</span><span>
</span><a name="line-30"></a><span>        </span><a href="TcEnv.html#tcExtendKindEnv"><span class="hs-identifier hs-var">tcExtendKindEnv</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcExtendKindEnvList"><span class="hs-identifier hs-var">tcExtendKindEnvList</span></a><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>        </span><a href="TcEnv.html#tcExtendTyVarEnv"><span class="hs-identifier hs-var">tcExtendTyVarEnv</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcExtendNameTyVarEnv"><span class="hs-identifier hs-var">tcExtendNameTyVarEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span>        </span><a href="TcEnv.html#tcExtendLetEnv"><span class="hs-identifier hs-var">tcExtendLetEnv</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcExtendSigIds"><span class="hs-identifier hs-var">tcExtendSigIds</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcExtendRecIds"><span class="hs-identifier hs-var">tcExtendRecIds</span></a><span class="hs-special">,</span><span>
</span><a name="line-33"></a><span>        </span><a href="TcEnv.html#tcExtendIdEnv"><span class="hs-identifier hs-var">tcExtendIdEnv</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcExtendIdEnv1"><span class="hs-identifier hs-var">tcExtendIdEnv1</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcExtendIdEnv2"><span class="hs-identifier hs-var">tcExtendIdEnv2</span></a><span class="hs-special">,</span><span>
</span><a name="line-34"></a><span>        </span><a href="TcEnv.html#tcExtendBinderStack"><span class="hs-identifier hs-var">tcExtendBinderStack</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcExtendLocalTypeEnv"><span class="hs-identifier hs-var">tcExtendLocalTypeEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-35"></a><span>        </span><a href="TcEnv.html#isTypeClosedLetBndr"><span class="hs-identifier hs-var">isTypeClosedLetBndr</span></a><span class="hs-special">,</span><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span>        </span><a href="TcEnv.html#tcLookup"><span class="hs-identifier hs-var">tcLookup</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcLookupLocated"><span class="hs-identifier hs-var">tcLookupLocated</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcLookupLocalIds"><span class="hs-identifier hs-var">tcLookupLocalIds</span></a><span class="hs-special">,</span><span>
</span><a name="line-38"></a><span>        </span><a href="TcEnv.html#tcLookupId"><span class="hs-identifier hs-var">tcLookupId</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcLookupIdMaybe"><span class="hs-identifier hs-var">tcLookupIdMaybe</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcLookupTyVar"><span class="hs-identifier hs-var">tcLookupTyVar</span></a><span class="hs-special">,</span><span>
</span><a name="line-39"></a><span>        </span><a href="TcEnv.html#tcLookupLcl_maybe"><span class="hs-identifier hs-var">tcLookupLcl_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>        </span><a href="TcEnv.html#getInLocalScope"><span class="hs-identifier hs-var">getInLocalScope</span></a><span class="hs-special">,</span><span>
</span><a name="line-41"></a><span>        </span><a href="TcEnv.html#wrongThingErr"><span class="hs-identifier hs-var">wrongThingErr</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#pprBinders"><span class="hs-identifier hs-var">pprBinders</span></a><span class="hs-special">,</span><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span>        </span><a href="TcEnv.html#tcAddDataFamConPlaceholders"><span class="hs-identifier hs-var">tcAddDataFamConPlaceholders</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcAddPatSynPlaceholders"><span class="hs-identifier hs-var">tcAddPatSynPlaceholders</span></a><span class="hs-special">,</span><span>
</span><a name="line-44"></a><span>        </span><a href="TcEnv.html#getTypeSigNames"><span class="hs-identifier hs-var">getTypeSigNames</span></a><span class="hs-special">,</span><span>
</span><a name="line-45"></a><span>        </span><a href="TcEnv.html#tcExtendRecEnv"><span class="hs-identifier hs-var">tcExtendRecEnv</span></a><span class="hs-special">,</span><span>         </span><span class="hs-comment">-- For knot-tying</span><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span>        </span><span class="hs-comment">-- Tidying</span><span>
</span><a name="line-48"></a><span>        </span><a href="TcEnv.html#tcInitTidyEnv"><span class="hs-identifier hs-var">tcInitTidyEnv</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcInitOpenTidyEnv"><span class="hs-identifier hs-var">tcInitOpenTidyEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span>        </span><span class="hs-comment">-- Instances</span><span>
</span><a name="line-51"></a><span>        </span><a href="TcEnv.html#tcLookupInstance"><span class="hs-identifier hs-var">tcLookupInstance</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcGetInstEnvs"><span class="hs-identifier hs-var">tcGetInstEnvs</span></a><span class="hs-special">,</span><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span>        </span><span class="hs-comment">-- Rules</span><span>
</span><a name="line-54"></a><span>        </span><a href="TcEnv.html#tcExtendRules"><span class="hs-identifier hs-var">tcExtendRules</span></a><span class="hs-special">,</span><span>
</span><a name="line-55"></a><span>
</span><a name="line-56"></a><span>        </span><span class="hs-comment">-- Defaults</span><span>
</span><a name="line-57"></a><span>        </span><a href="TcEnv.html#tcGetDefaultTys"><span class="hs-identifier hs-var">tcGetDefaultTys</span></a><span class="hs-special">,</span><span>
</span><a name="line-58"></a><span>
</span><a name="line-59"></a><span>        </span><span class="hs-comment">-- Global type variables</span><span>
</span><a name="line-60"></a><span>        </span><a href="TcMType.html#tcGetGlobalTyCoVars"><span class="hs-identifier hs-var">tcGetGlobalTyCoVars</span></a><span class="hs-special">,</span><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span>        </span><span class="hs-comment">-- Template Haskell stuff</span><span>
</span><a name="line-63"></a><span>        </span><a href="TcEnv.html#checkWellStaged"><span class="hs-identifier hs-var">checkWellStaged</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcMetaTy"><span class="hs-identifier hs-var">tcMetaTy</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">thLevel</span><span class="hs-special">,</span><span>
</span><a name="line-64"></a><span>        </span><a href="TcEnv.html#topIdLvl"><span class="hs-identifier hs-var">topIdLvl</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#isBrackStage"><span class="hs-identifier hs-var">isBrackStage</span></a><span class="hs-special">,</span><span>
</span><a name="line-65"></a><span>
</span><a name="line-66"></a><span>        </span><span class="hs-comment">-- New Ids</span><span>
</span><a name="line-67"></a><span>        </span><a href="TcEnv.html#newDFunName"><span class="hs-identifier hs-var">newDFunName</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#newDFunName%27"><span class="hs-identifier hs-var">newDFunName'</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#newFamInstTyConName"><span class="hs-identifier hs-var">newFamInstTyConName</span></a><span class="hs-special">,</span><span>
</span><a name="line-68"></a><span>        </span><a href="TcEnv.html#newFamInstAxiomName"><span class="hs-identifier hs-var">newFamInstAxiomName</span></a><span class="hs-special">,</span><span>
</span><a name="line-69"></a><span>        </span><a href="TcEnv.html#mkStableIdFromString"><span class="hs-identifier hs-var">mkStableIdFromString</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#mkStableIdFromName"><span class="hs-identifier hs-var">mkStableIdFromName</span></a><span class="hs-special">,</span><span>
</span><a name="line-70"></a><span>        </span><a href="TcEnv.html#mkWrapperName"><span class="hs-identifier hs-var">mkWrapperName</span></a><span>
</span><a name="line-71"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span> </span><a href="IfaceEnv.html"><span class="hs-identifier">IfaceEnv</span></a><span>
</span><a name="line-79"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-80"></a><span class="hs-keyword">import</span><span> </span><a href="TcMType.html"><span class="hs-identifier">TcMType</span></a><span>
</span><a name="line-81"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span>
</span><a name="line-82"></a><span class="hs-keyword">import</span><span> </span><a href="LoadIface.html"><span class="hs-identifier">LoadIface</span></a><span>
</span><a name="line-83"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span>
</span><a name="line-84"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysWiredIn</span><span>
</span><a name="line-85"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-86"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Var</span><span>
</span><a name="line-87"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarSet</span><span>
</span><a name="line-88"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RdrName</span><span>
</span><a name="line-89"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">InstEnv</span><span>
</span><a name="line-90"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-91"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PatSyn</span><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">PatSyn</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-92"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ConLike</span><span>
</span><a name="line-93"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-94"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-95"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoAxiom</span><span>
</span><a name="line-96"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Class</span><span>
</span><a name="line-97"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-98"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameSet</span><span>
</span><a name="line-99"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameEnv</span><span>
</span><a name="line-100"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarEnv</span><span>
</span><a name="line-101"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>
</span><a name="line-102"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-103"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-104"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span> </span><span class="hs-keyword">hiding</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">SuccessFlag</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-105"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-106"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-107"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Encoding</span><span>
</span><a name="line-108"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-109"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ListSetOps</span><span>
</span><a name="line-110"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span>
</span><a name="line-111"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-112"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">MaybeErr</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">orElse</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-113"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC.LanguageExtensions</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LangExt</span><span>
</span><a name="line-114"></a><span>
</span><a name="line-115"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.IORef</span><span>
</span><a name="line-116"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-117"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-118"></a><span>
</span><a name="line-119"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
            An IO interface to looking up globals
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a><span class="hs-identifier">lookupGlobal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">TyThing</span><span>
</span><a name="line-126"></a><span class="hs-comment">-- A variant of lookupGlobal_maybe for the clients which are not</span><span>
</span><a name="line-127"></a><span class="hs-comment">-- interested in recovering from lookup failure and accept panic.</span><span>
</span><a name="line-128"></a><a name="lookupGlobal"><a href="TcEnv.html#lookupGlobal"><span class="hs-identifier">lookupGlobal</span></a></a><span> </span><a name="local-6989586621681761962"><a href="#local-6989586621681761962"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621681761963"><a href="#local-6989586621681761963"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-129"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span>
</span><a name="line-130"></a><span>          </span><a name="local-6989586621681761964"><a href="#local-6989586621681761964"><span class="hs-identifier">mb_thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#lookupGlobal_maybe"><span class="hs-identifier hs-var">lookupGlobal_maybe</span></a><span> </span><a href="#local-6989586621681761962"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621681761963"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-131"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681761964"><span class="hs-identifier hs-var">mb_thing</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-132"></a><span>            </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><a name="local-6989586621681761965"><a href="#local-6989586621681761965"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681761965"><span class="hs-identifier hs-var">thing</span></a><span>
</span><a name="line-133"></a><span>            </span><span class="hs-identifier hs-var">Failed</span><span> </span><a name="local-6989586621681761966"><a href="#local-6989586621681761966"><span class="hs-identifier">msg</span></a></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;lookupGlobal&quot;</span><span> </span><a href="#local-6989586621681761966"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-134"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-135"></a><span>
</span><a name="line-136"></a><span class="hs-identifier">lookupGlobal_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MaybeErr</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-identifier hs-type">TyThing</span><span class="hs-special">)</span><span>
</span><a name="line-137"></a><span class="hs-comment">-- This may look up an Id that one one has previously looked up.</span><span>
</span><a name="line-138"></a><span class="hs-comment">-- If so, we are going to read its interface file, and add its bindings</span><span>
</span><a name="line-139"></a><span class="hs-comment">-- to the ExternalPackageTable.</span><span>
</span><a name="line-140"></a><a name="lookupGlobal_maybe"><a href="TcEnv.html#lookupGlobal_maybe"><span class="hs-identifier">lookupGlobal_maybe</span></a></a><span> </span><a name="local-6989586621681761967"><a href="#local-6989586621681761967"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621681761968"><a href="#local-6989586621681761968"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-141"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span>    </span><span class="hs-comment">-- Try local envt</span><span>
</span><a name="line-142"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681761969"><a href="#local-6989586621681761969"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">icInteractiveModule</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_IC</span><span> </span><a href="#local-6989586621681761967"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-143"></a><span>              </span><a name="local-6989586621681761970"><a href="#local-6989586621681761970"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621681761967"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-144"></a><span>              </span><a name="local-6989586621681761971"><a href="#local-6989586621681761971"><span class="hs-identifier">tcg_semantic_mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">canonicalizeModuleIfHome</span><span> </span><a href="#local-6989586621681761970"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681761969"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-145"></a><span>
</span><a name="line-146"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">nameIsLocalOrFrom</span><span> </span><a href="#local-6989586621681761971"><span class="hs-identifier hs-var">tcg_semantic_mod</span></a><span> </span><a href="#local-6989586621681761968"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-147"></a><span>              </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span>
</span><a name="line-148"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Failed</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Can't find local name: &quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681761968"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-149"></a><span>                  </span><span class="hs-comment">-- Internal names can happen in GHCi</span><span>
</span><a name="line-150"></a><span>              </span><span class="hs-keyword">else</span><span>
</span><a name="line-151"></a><span>           </span><span class="hs-comment">-- Try home package table and external package table</span><span>
</span><a name="line-152"></a><span>          </span><a href="TcEnv.html#lookupImported_maybe"><span class="hs-identifier hs-var">lookupImported_maybe</span></a><span> </span><a href="#local-6989586621681761967"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621681761968"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-153"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-154"></a><span>
</span><a name="line-155"></a><span class="hs-identifier">lookupImported_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MaybeErr</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-identifier hs-type">TyThing</span><span class="hs-special">)</span><span>
</span><a name="line-156"></a><span class="hs-comment">-- Returns (Failed err) if we can't find the interface file for the thing</span><span>
</span><a name="line-157"></a><a name="lookupImported_maybe"><a href="TcEnv.html#lookupImported_maybe"><span class="hs-identifier">lookupImported_maybe</span></a></a><span> </span><a name="local-6989586621681761972"><a href="#local-6989586621681761972"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621681761973"><a href="#local-6989586621681761973"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-158"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681761974"><a href="#local-6989586621681761974"><span class="hs-identifier">mb_thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupTypeHscEnv</span><span> </span><a href="#local-6989586621681761972"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621681761973"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-159"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681761974"><span class="hs-identifier hs-var">mb_thing</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-160"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681761975"><a href="#local-6989586621681761975"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Succeeded</span><span> </span><a href="#local-6989586621681761975"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-161"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcEnv.html#importDecl_maybe"><span class="hs-identifier hs-var">importDecl_maybe</span></a><span> </span><a href="#local-6989586621681761972"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621681761973"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-162"></a><span>            </span><span class="hs-special">}</span><span>
</span><a name="line-163"></a><span>
</span><a name="line-164"></a><span class="hs-identifier">importDecl_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MaybeErr</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-identifier hs-type">TyThing</span><span class="hs-special">)</span><span>
</span><a name="line-165"></a><a name="importDecl_maybe"><a href="TcEnv.html#importDecl_maybe"><span class="hs-identifier">importDecl_maybe</span></a></a><span> </span><a name="local-6989586621681761976"><a href="#local-6989586621681761976"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621681761977"><a href="#local-6989586621681761977"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-166"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681761978"><a href="#local-6989586621681761978"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">wiredInNameTyThing_maybe</span><span> </span><a href="#local-6989586621681761977"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-167"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="LoadIface.html#needWiredInHomeIface"><span class="hs-identifier hs-var">needWiredInHomeIface</span></a><span> </span><a href="#local-6989586621681761978"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-168"></a><span>               </span><span class="hs-special">(</span><a href="TcRnMonad.html#initIfaceLoad"><span class="hs-identifier hs-var">initIfaceLoad</span></a><span> </span><a href="#local-6989586621681761976"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><a href="LoadIface.html#loadWiredInHomeIface"><span class="hs-identifier hs-var">loadWiredInHomeIface</span></a><span> </span><a href="#local-6989586621681761977"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-169"></a><span>                </span><span class="hs-comment">-- See Note [Loading instances for wired-in things]</span><span>
</span><a name="line-170"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Succeeded</span><span> </span><a href="#local-6989586621681761978"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-171"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-172"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#initIfaceLoad"><span class="hs-identifier hs-var">initIfaceLoad</span></a><span> </span><a href="#local-6989586621681761976"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><a href="LoadIface.html#importDecl"><span class="hs-identifier hs-var">importDecl</span></a><span> </span><a href="#local-6989586621681761977"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-173"></a><span>
</span><a name="line-174"></a><span class="hs-identifier">ioLookupDataCon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span>
</span><a name="line-175"></a><a name="ioLookupDataCon"><a href="TcEnv.html#ioLookupDataCon"><span class="hs-identifier">ioLookupDataCon</span></a></a><span> </span><a name="local-6989586621681761979"><a href="#local-6989586621681761979"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621681761980"><a href="#local-6989586621681761980"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-176"></a><span>  </span><a name="local-6989586621681761981"><a href="#local-6989586621681761981"><span class="hs-identifier">mb_thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#ioLookupDataCon_maybe"><span class="hs-identifier hs-var">ioLookupDataCon_maybe</span></a><span> </span><a href="#local-6989586621681761979"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621681761980"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-177"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681761981"><span class="hs-identifier hs-var">mb_thing</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-178"></a><span>    </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><a name="local-6989586621681761982"><a href="#local-6989586621681761982"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681761982"><span class="hs-identifier hs-var">thing</span></a><span>
</span><a name="line-179"></a><span>    </span><span class="hs-identifier hs-var">Failed</span><span> </span><a name="local-6989586621681761983"><a href="#local-6989586621681761983"><span class="hs-identifier">msg</span></a></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;lookupDataConIO&quot;</span><span> </span><a href="#local-6989586621681761983"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-180"></a><span>
</span><a name="line-181"></a><span class="hs-identifier">ioLookupDataCon_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MaybeErr</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span class="hs-special">)</span><span>
</span><a name="line-182"></a><a name="ioLookupDataCon_maybe"><a href="TcEnv.html#ioLookupDataCon_maybe"><span class="hs-identifier">ioLookupDataCon_maybe</span></a></a><span> </span><a name="local-6989586621681761984"><a href="#local-6989586621681761984"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621681761985"><a href="#local-6989586621681761985"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-183"></a><span>    </span><a name="local-6989586621681761986"><a href="#local-6989586621681761986"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#lookupGlobal"><span class="hs-identifier hs-var">lookupGlobal</span></a><span> </span><a href="#local-6989586621681761984"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621681761985"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-184"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681761986"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-185"></a><span>        </span><span class="hs-identifier hs-var">AConLike</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealDataCon</span><span> </span><a name="local-6989586621681761987"><a href="#local-6989586621681761987"><span class="hs-identifier">con</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><a href="#local-6989586621681761987"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-186"></a><span>        </span><span class="hs-identifier">_</span><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Failed</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-187"></a><span>          </span><span class="hs-identifier hs-var">pprTcTyThingCategory</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AGlobal</span><span> </span><a href="#local-6989586621681761986"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681761985"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-188"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;used as a data constructor&quot;</span><span>
</span><a name="line-189"></a><span>
</span><a name="line-190"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
*                      tcLookupGlobal                                  *
*                                                                      *
************************************************************************

Using the Located versions (eg. tcLookupLocatedGlobal) is preferred,
unless you know that the SrcSpan in the monad is already set to the
span of the Name.
-}</span><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span>
</span><a name="line-203"></a><span class="hs-identifier">tcLookupLocatedGlobal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TyThing</span><span>
</span><a name="line-204"></a><span class="hs-comment">-- c.f. IfaceEnvEnv.tcIfaceGlobal</span><span>
</span><a name="line-205"></a><a name="tcLookupLocatedGlobal"><a href="TcEnv.html#tcLookupLocatedGlobal"><span class="hs-identifier">tcLookupLocatedGlobal</span></a></a><span> </span><a name="local-6989586621681761988"><a href="#local-6989586621681761988"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-206"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addLocM"><span class="hs-identifier hs-var">addLocM</span></a><span> </span><a href="TcEnv.html#tcLookupGlobal"><span class="hs-identifier hs-var">tcLookupGlobal</span></a><span> </span><a href="#local-6989586621681761988"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-207"></a><span>
</span><a name="line-208"></a><span class="hs-identifier">tcLookupGlobal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TyThing</span><span>
</span><a name="line-209"></a><span class="hs-comment">-- The Name is almost always an ExternalName, but not always</span><span>
</span><a name="line-210"></a><span class="hs-comment">-- In GHCi, we may make command-line bindings (ghci&gt; let x = True)</span><span>
</span><a name="line-211"></a><span class="hs-comment">-- that bind a GlobalId, but with an InternalName</span><span>
</span><a name="line-212"></a><a name="tcLookupGlobal"><a href="TcEnv.html#tcLookupGlobal"><span class="hs-identifier">tcLookupGlobal</span></a></a><span> </span><a name="local-6989586621681761989"><a href="#local-6989586621681761989"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-213"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span>    </span><span class="hs-comment">-- Try local envt</span><span>
</span><a name="line-214"></a><span>          </span><a name="local-6989586621681761990"><a href="#local-6989586621681761990"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-215"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupNameEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_type_env</span><span> </span><a href="#local-6989586621681761990"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681761989"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-216"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681761991"><a href="#local-6989586621681761991"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681761991"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-217"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-218"></a><span>
</span><a name="line-219"></a><span>                </span><span class="hs-comment">-- Should it have been in the local envt?</span><span>
</span><a name="line-220"></a><span>                </span><span class="hs-comment">-- (NB: use semantic mod here, since names never use</span><span>
</span><a name="line-221"></a><span>                </span><span class="hs-comment">-- identity module, see Note [Identity versus semantic module].)</span><span>
</span><a name="line-222"></a><span>          </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">nameIsLocalOrFrom</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_semantic_mod</span><span> </span><a href="#local-6989586621681761990"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681761989"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-223"></a><span>          </span><span class="hs-keyword">then</span><span> </span><a href="TcEnv.html#notFound"><span class="hs-identifier hs-var">notFound</span></a><span> </span><a href="#local-6989586621681761989"><span class="hs-identifier hs-var">name</span></a><span>  </span><span class="hs-comment">-- Internal names can happen in GHCi</span><span>
</span><a name="line-224"></a><span>          </span><span class="hs-keyword">else</span><span>
</span><a name="line-225"></a><span>
</span><a name="line-226"></a><span>           </span><span class="hs-comment">-- Try home package table and external package table</span><span>
</span><a name="line-227"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681761992"><a href="#local-6989586621681761992"><span class="hs-identifier">mb_thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="LoadIface.html#tcLookupImported_maybe"><span class="hs-identifier hs-var">tcLookupImported_maybe</span></a><span> </span><a href="#local-6989586621681761989"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-228"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681761992"><span class="hs-identifier hs-var">mb_thing</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-229"></a><span>            </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><a name="local-6989586621681761993"><a href="#local-6989586621681761993"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681761993"><span class="hs-identifier hs-var">thing</span></a><span>
</span><a name="line-230"></a><span>            </span><span class="hs-identifier hs-var">Failed</span><span> </span><a name="local-6989586621681761994"><a href="#local-6989586621681761994"><span class="hs-identifier">msg</span></a></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><a href="#local-6989586621681761994"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-231"></a><span>        </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-232"></a><span>
</span><a name="line-233"></a><span class="hs-comment">-- Look up only in this module's global env't. Don't look in imports, etc.</span><span>
</span><a name="line-234"></a><span class="hs-comment">-- Panic if it's not there.</span><span>
</span><a name="line-235"></a><span class="hs-identifier">tcLookupGlobalOnly</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TyThing</span><span>
</span><a name="line-236"></a><a name="tcLookupGlobalOnly"><a href="TcEnv.html#tcLookupGlobalOnly"><span class="hs-identifier">tcLookupGlobalOnly</span></a></a><span> </span><a name="local-6989586621681761995"><a href="#local-6989586621681761995"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-237"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681761996"><a href="#local-6989586621681761996"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-238"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupNameEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_type_env</span><span> </span><a href="#local-6989586621681761996"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681761995"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-239"></a><span>                    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681761997"><a href="#local-6989586621681761997"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681761997"><span class="hs-identifier hs-var">thing</span></a><span>
</span><a name="line-240"></a><span>                    </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;tcLookupGlobalOnly&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681761995"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-241"></a><span>
</span><a name="line-242"></a><span class="hs-identifier">tcLookupDataCon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span>
</span><a name="line-243"></a><a name="tcLookupDataCon"><a href="TcEnv.html#tcLookupDataCon"><span class="hs-identifier">tcLookupDataCon</span></a></a><span> </span><a name="local-6989586621681761998"><a href="#local-6989586621681761998"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-244"></a><span>    </span><a name="local-6989586621681761999"><a href="#local-6989586621681761999"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupGlobal"><span class="hs-identifier hs-var">tcLookupGlobal</span></a><span> </span><a href="#local-6989586621681761998"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-245"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681761999"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-246"></a><span>        </span><span class="hs-identifier hs-var">AConLike</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealDataCon</span><span> </span><a name="local-6989586621681762000"><a href="#local-6989586621681762000"><span class="hs-identifier">con</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681762000"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-247"></a><span>        </span><span class="hs-identifier">_</span><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcEnv.html#wrongThingErr"><span class="hs-identifier hs-var">wrongThingErr</span></a><span> </span><span class="hs-string">&quot;data constructor&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AGlobal</span><span> </span><a href="#local-6989586621681761999"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681761998"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-248"></a><span>
</span><a name="line-249"></a><span class="hs-identifier">tcLookupPatSyn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">PatSyn</span><span>
</span><a name="line-250"></a><a name="tcLookupPatSyn"><a href="TcEnv.html#tcLookupPatSyn"><span class="hs-identifier">tcLookupPatSyn</span></a></a><span> </span><a name="local-6989586621681762001"><a href="#local-6989586621681762001"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-251"></a><span>    </span><a name="local-6989586621681762002"><a href="#local-6989586621681762002"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupGlobal"><span class="hs-identifier hs-var">tcLookupGlobal</span></a><span> </span><a href="#local-6989586621681762001"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-252"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681762002"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-253"></a><span>        </span><span class="hs-identifier hs-var">AConLike</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PatSynCon</span><span> </span><a name="local-6989586621681762003"><a href="#local-6989586621681762003"><span class="hs-identifier">ps</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681762003"><span class="hs-identifier hs-var">ps</span></a><span>
</span><a name="line-254"></a><span>        </span><span class="hs-identifier">_</span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcEnv.html#wrongThingErr"><span class="hs-identifier hs-var">wrongThingErr</span></a><span> </span><span class="hs-string">&quot;pattern synonym&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AGlobal</span><span> </span><a href="#local-6989586621681762002"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681762001"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-255"></a><span>
</span><a name="line-256"></a><span class="hs-identifier">tcLookupConLike</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">ConLike</span><span>
</span><a name="line-257"></a><a name="tcLookupConLike"><a href="TcEnv.html#tcLookupConLike"><span class="hs-identifier">tcLookupConLike</span></a></a><span> </span><a name="local-6989586621681762004"><a href="#local-6989586621681762004"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-258"></a><span>    </span><a name="local-6989586621681762005"><a href="#local-6989586621681762005"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupGlobal"><span class="hs-identifier hs-var">tcLookupGlobal</span></a><span> </span><a href="#local-6989586621681762004"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-259"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681762005"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-260"></a><span>        </span><span class="hs-identifier hs-var">AConLike</span><span> </span><a name="local-6989586621681762006"><a href="#local-6989586621681762006"><span class="hs-identifier">cl</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681762006"><span class="hs-identifier hs-var">cl</span></a><span>
</span><a name="line-261"></a><span>        </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcEnv.html#wrongThingErr"><span class="hs-identifier hs-var">wrongThingErr</span></a><span> </span><span class="hs-string">&quot;constructor-like thing&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AGlobal</span><span> </span><a href="#local-6989586621681762005"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681762004"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-262"></a><span>
</span><a name="line-263"></a><span class="hs-identifier">tcLookupClass</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Class</span><span>
</span><a name="line-264"></a><a name="tcLookupClass"><a href="TcEnv.html#tcLookupClass"><span class="hs-identifier">tcLookupClass</span></a></a><span> </span><a name="local-6989586621681762007"><a href="#local-6989586621681762007"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-265"></a><span>    </span><a name="local-6989586621681762008"><a href="#local-6989586621681762008"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupGlobal"><span class="hs-identifier hs-var">tcLookupGlobal</span></a><span> </span><a href="#local-6989586621681762007"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-266"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681762008"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-267"></a><span>        </span><span class="hs-identifier hs-var">ATyCon</span><span> </span><a name="local-6989586621681762009"><a href="#local-6989586621681762009"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681762010"><a href="#local-6989586621681762010"><span class="hs-identifier">cls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tyConClass_maybe</span><span> </span><a href="#local-6989586621681762009"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681762010"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-268"></a><span>        </span><span class="hs-identifier">_</span><span>                                           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcEnv.html#wrongThingErr"><span class="hs-identifier hs-var">wrongThingErr</span></a><span> </span><span class="hs-string">&quot;class&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AGlobal</span><span> </span><a href="#local-6989586621681762008"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681762007"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-269"></a><span>
</span><a name="line-270"></a><span class="hs-identifier">tcLookupTyCon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span>
</span><a name="line-271"></a><a name="tcLookupTyCon"><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier">tcLookupTyCon</span></a></a><span> </span><a name="local-6989586621681762011"><a href="#local-6989586621681762011"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-272"></a><span>    </span><a name="local-6989586621681762012"><a href="#local-6989586621681762012"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupGlobal"><span class="hs-identifier hs-var">tcLookupGlobal</span></a><span> </span><a href="#local-6989586621681762011"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-273"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681762012"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-274"></a><span>        </span><span class="hs-identifier hs-var">ATyCon</span><span> </span><a name="local-6989586621681762013"><a href="#local-6989586621681762013"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681762013"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-275"></a><span>        </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcEnv.html#wrongThingErr"><span class="hs-identifier hs-var">wrongThingErr</span></a><span> </span><span class="hs-string">&quot;type constructor&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AGlobal</span><span> </span><a href="#local-6989586621681762012"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681762011"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-276"></a><span>
</span><a name="line-277"></a><span class="hs-identifier">tcLookupAxiom</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CoAxiom</span><span> </span><span class="hs-identifier hs-type">Branched</span><span class="hs-special">)</span><span>
</span><a name="line-278"></a><a name="tcLookupAxiom"><a href="TcEnv.html#tcLookupAxiom"><span class="hs-identifier">tcLookupAxiom</span></a></a><span> </span><a name="local-6989586621681762014"><a href="#local-6989586621681762014"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-279"></a><span>    </span><a name="local-6989586621681762015"><a href="#local-6989586621681762015"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupGlobal"><span class="hs-identifier hs-var">tcLookupGlobal</span></a><span> </span><a href="#local-6989586621681762014"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-280"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681762015"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-281"></a><span>        </span><span class="hs-identifier hs-var">ACoAxiom</span><span> </span><a name="local-6989586621681762016"><a href="#local-6989586621681762016"><span class="hs-identifier">ax</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681762016"><span class="hs-identifier hs-var">ax</span></a><span>
</span><a name="line-282"></a><span>        </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcEnv.html#wrongThingErr"><span class="hs-identifier hs-var">wrongThingErr</span></a><span> </span><span class="hs-string">&quot;axiom&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AGlobal</span><span> </span><a href="#local-6989586621681762015"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681762014"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-283"></a><span>
</span><a name="line-284"></a><span class="hs-identifier">tcLookupLocatedGlobalId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-285"></a><a name="tcLookupLocatedGlobalId"><a href="TcEnv.html#tcLookupLocatedGlobalId"><span class="hs-identifier">tcLookupLocatedGlobalId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addLocM"><span class="hs-identifier hs-var">addLocM</span></a><span> </span><a href="TcEnv.html#tcLookupId"><span class="hs-identifier hs-var">tcLookupId</span></a><span>
</span><a name="line-286"></a><span>
</span><a name="line-287"></a><span class="hs-identifier">tcLookupLocatedClass</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Class</span><span>
</span><a name="line-288"></a><a name="tcLookupLocatedClass"><a href="TcEnv.html#tcLookupLocatedClass"><span class="hs-identifier">tcLookupLocatedClass</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addLocM"><span class="hs-identifier hs-var">addLocM</span></a><span> </span><a href="TcEnv.html#tcLookupClass"><span class="hs-identifier hs-var">tcLookupClass</span></a><span>
</span><a name="line-289"></a><span>
</span><a name="line-290"></a><span class="hs-identifier">tcLookupLocatedTyCon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span>
</span><a name="line-291"></a><a name="tcLookupLocatedTyCon"><a href="TcEnv.html#tcLookupLocatedTyCon"><span class="hs-identifier">tcLookupLocatedTyCon</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addLocM"><span class="hs-identifier hs-var">addLocM</span></a><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span>
</span><a name="line-292"></a><span>
</span><a name="line-293"></a><span class="hs-comment">-- Find the instance that exactly matches a type class application.  The class arguments must be precisely</span><span>
</span><a name="line-294"></a><span class="hs-comment">-- the same as in the instance declaration (modulo renaming &amp; casts).</span><span>
</span><a name="line-295"></a><span class="hs-comment">--</span><span>
</span><a name="line-296"></a><span class="hs-identifier">tcLookupInstance</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">ClsInst</span><span>
</span><a name="line-297"></a><a name="tcLookupInstance"><a href="TcEnv.html#tcLookupInstance"><span class="hs-identifier">tcLookupInstance</span></a></a><span> </span><a name="local-6989586621681762017"><a href="#local-6989586621681762017"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621681762018"><a href="#local-6989586621681762018"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-298"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681762022"><a href="#local-6989586621681762022"><span class="hs-identifier">instEnv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcGetInstEnvs"><span class="hs-identifier hs-var">tcGetInstEnvs</span></a><span>
</span><a name="line-299"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupUniqueInstEnv</span><span> </span><a href="#local-6989586621681762022"><span class="hs-identifier hs-var">instEnv</span></a><span> </span><a href="#local-6989586621681762017"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621681762018"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-300"></a><span>           </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621681762023"><a href="#local-6989586621681762023"><span class="hs-identifier">err</span></a></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Couldn't match instance:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621681762023"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-301"></a><span>           </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681762024"><a href="#local-6989586621681762024"><span class="hs-identifier">inst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681762025"><a href="#local-6989586621681762025"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-302"></a><span>             </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681762020"><span class="hs-identifier hs-var">uniqueTyVars</span></a><span> </span><a href="#local-6989586621681762025"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681762024"><span class="hs-identifier hs-var">inst</span></a><span>
</span><a name="line-303"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><a href="#local-6989586621681762019"><span class="hs-identifier hs-var">errNotExact</span></a><span>
</span><a name="line-304"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-305"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-306"></a><span>    </span><a name="local-6989586621681762019"><a href="#local-6989586621681762019"><span class="hs-identifier">errNotExact</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Not an exact match (i.e., some variables get instantiated)&quot;</span><span>
</span><a name="line-307"></a><span>
</span><a name="line-308"></a><span>    </span><a name="local-6989586621681762020"><a href="#local-6989586621681762020"><span class="hs-identifier">uniqueTyVars</span></a></a><span> </span><a name="local-6989586621681762021"><a href="#local-6989586621681762021"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-identifier hs-var">isTyVarTy</span><span> </span><a href="#local-6989586621681762021"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-309"></a><span>                    </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">hasNoDups</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getTyVar</span><span> </span><span class="hs-string">&quot;tcLookupInstance&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681762021"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-310"></a><span>
</span><a name="line-311"></a><span class="hs-identifier">tcGetInstEnvs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">InstEnvs</span><span>
</span><a name="line-312"></a><span class="hs-comment">-- Gets both the external-package inst-env</span><span>
</span><a name="line-313"></a><span class="hs-comment">-- and the home-pkg inst env (includes module being compiled)</span><span>
</span><a name="line-314"></a><a name="tcGetInstEnvs"><a href="TcEnv.html#tcGetInstEnvs"><span class="hs-identifier">tcGetInstEnvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681762026"><a href="#local-6989586621681762026"><span class="hs-identifier">eps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getEps"><span class="hs-identifier hs-var">getEps</span></a><span>
</span><a name="line-315"></a><span>                   </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681762027"><a href="#local-6989586621681762027"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-316"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">InstEnvs</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ie_global</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">eps_inst_env</span><span> </span><a href="#local-6989586621681762026"><span class="hs-identifier hs-var">eps</span></a><span>
</span><a name="line-317"></a><span>                                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ie_local</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_inst_env</span><span> </span><a href="#local-6989586621681762027"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-318"></a><span>                                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ie_visible</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcVisibleOrphanMods</span><span> </span><a href="#local-6989586621681762027"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-319"></a><span>
</span><a name="line-320"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadThings</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IOEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Env</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-identifier hs-type">TcLclEnv</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-321"></a><span>    </span><a name="local-8214565720323794786"><span class="hs-identifier">lookupThing</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#tcLookupGlobal"><span class="hs-identifier hs-var">tcLookupGlobal</span></a><span>
</span><a name="line-322"></a><span>
</span><a name="line-323"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Extending the global environment
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-330"></a><span>
</span><a name="line-331"></a><span class="hs-identifier">setGlobalTypeEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TypeEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-332"></a><span class="hs-comment">-- Use this to update the global type env</span><span>
</span><a name="line-333"></a><span class="hs-comment">-- It updates both  * the normal tcg_type_env field</span><span>
</span><a name="line-334"></a><span class="hs-comment">--                  * the tcg_type_env_var field seen by interface files</span><span>
</span><a name="line-335"></a><a name="setGlobalTypeEnv"><a href="TcEnv.html#setGlobalTypeEnv"><span class="hs-identifier">setGlobalTypeEnv</span></a></a><span> </span><a name="local-6989586621681762028"><a href="#local-6989586621681762028"><span class="hs-identifier">tcg_env</span></a></a><span> </span><a name="local-6989586621681762029"><a href="#local-6989586621681762029"><span class="hs-identifier">new_type_env</span></a></a><span>
</span><a name="line-336"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span>     </span><span class="hs-comment">-- Sync the type-envt variable seen by interface files</span><span>
</span><a name="line-337"></a><span>           </span><span class="hs-identifier hs-var">writeMutVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_type_env_var</span><span> </span><a href="#local-6989586621681762028"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681762029"><span class="hs-identifier hs-var">new_type_env</span></a><span>
</span><a name="line-338"></a><span>         </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681762028"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_type_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681762029"><span class="hs-identifier hs-var">new_type_env</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-339"></a><span>
</span><a name="line-340"></a><span>
</span><a name="line-341"></a><span class="hs-identifier">tcExtendGlobalEnvImplicit</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyThing</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761961"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761961"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-342"></a><span>  </span><span class="hs-comment">-- Just extend the global environment with some TyThings</span><span>
</span><a name="line-343"></a><span>  </span><span class="hs-comment">-- Do not extend tcg_tcs, tcg_patsyns etc</span><span>
</span><a name="line-344"></a><a name="tcExtendGlobalEnvImplicit"><a href="TcEnv.html#tcExtendGlobalEnvImplicit"><span class="hs-identifier">tcExtendGlobalEnvImplicit</span></a></a><span> </span><a name="local-6989586621681762030"><a href="#local-6989586621681762030"><span class="hs-identifier">things</span></a></a><span> </span><a name="local-6989586621681762031"><a href="#local-6989586621681762031"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-345"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681762032"><a href="#local-6989586621681762032"><span class="hs-identifier">tcg_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-346"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681762033"><a href="#local-6989586621681762033"><span class="hs-identifier">ge'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendTypeEnvList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_type_env</span><span> </span><a href="#local-6989586621681762032"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681762030"><span class="hs-identifier hs-var">things</span></a><span>
</span><a name="line-347"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681762034"><a href="#local-6989586621681762034"><span class="hs-identifier">tcg_env'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#setGlobalTypeEnv"><span class="hs-identifier hs-var">setGlobalTypeEnv</span></a><span> </span><a href="#local-6989586621681762032"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><a href="#local-6989586621681762033"><span class="hs-identifier hs-var">ge'</span></a><span>
</span><a name="line-348"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><a href="#local-6989586621681762034"><span class="hs-identifier hs-var">tcg_env'</span></a><span> </span><a href="#local-6989586621681762031"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-349"></a><span>
</span><a name="line-350"></a><span class="hs-identifier">tcExtendGlobalEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyThing</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761960"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761960"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-351"></a><span>  </span><span class="hs-comment">-- Given a mixture of Ids, TyCons, Classes, all defined in the</span><span>
</span><a name="line-352"></a><span>  </span><span class="hs-comment">-- module being compiled, extend the global environment</span><span>
</span><a name="line-353"></a><a name="tcExtendGlobalEnv"><a href="TcEnv.html#tcExtendGlobalEnv"><span class="hs-identifier">tcExtendGlobalEnv</span></a></a><span> </span><a name="local-6989586621681762035"><a href="#local-6989586621681762035"><span class="hs-identifier">things</span></a></a><span> </span><a name="local-6989586621681762036"><a href="#local-6989586621681762036"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-354"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681762037"><a href="#local-6989586621681762037"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-355"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681762038"><a href="#local-6989586621681762038"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681762037"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_tcs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621681762039"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">ATyCon</span><span> </span><a name="local-6989586621681762039"><a href="#local-6989586621681762039"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681762035"><span class="hs-identifier hs-var">things</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier">tcg_tcs</span><span> </span><a href="#local-6989586621681762037"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span>
</span><a name="line-356"></a><span>                          </span><span class="hs-identifier">tcg_patsyns</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621681762040"><span class="hs-identifier hs-var">ps</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">AConLike</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PatSynCon</span><span> </span><a name="local-6989586621681762040"><a href="#local-6989586621681762040"><span class="hs-identifier">ps</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681762035"><span class="hs-identifier hs-var">things</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier">tcg_patsyns</span><span> </span><a href="#local-6989586621681762037"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-357"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><a href="#local-6989586621681762038"><span class="hs-identifier hs-var">env'</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-358"></a><span>            </span><a href="TcEnv.html#tcExtendGlobalEnvImplicit"><span class="hs-identifier hs-var">tcExtendGlobalEnvImplicit</span></a><span> </span><a href="#local-6989586621681762035"><span class="hs-identifier hs-var">things</span></a><span> </span><a href="#local-6989586621681762036"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-359"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-360"></a><span>
</span><a name="line-361"></a><span class="hs-identifier">tcExtendTyConEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyCon</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761959"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761959"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-362"></a><span>  </span><span class="hs-comment">-- Given a mixture of Ids, TyCons, Classes, all defined in the</span><span>
</span><a name="line-363"></a><span>  </span><span class="hs-comment">-- module being compiled, extend the global environment</span><span>
</span><a name="line-364"></a><a name="tcExtendTyConEnv"><a href="TcEnv.html#tcExtendTyConEnv"><span class="hs-identifier">tcExtendTyConEnv</span></a></a><span> </span><a name="local-6989586621681762041"><a href="#local-6989586621681762041"><span class="hs-identifier">tycons</span></a></a><span> </span><a name="local-6989586621681762042"><a href="#local-6989586621681762042"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-365"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681762043"><a href="#local-6989586621681762043"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-366"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681762044"><a href="#local-6989586621681762044"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681762043"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_tcs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681762041"><span class="hs-identifier hs-var">tycons</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier">tcg_tcs</span><span> </span><a href="#local-6989586621681762043"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-367"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><a href="#local-6989586621681762044"><span class="hs-identifier hs-var">env'</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-368"></a><span>         </span><a href="TcEnv.html#tcExtendGlobalEnvImplicit"><span class="hs-identifier hs-var">tcExtendGlobalEnvImplicit</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ATyCon</span><span> </span><a href="#local-6989586621681762041"><span class="hs-identifier hs-var">tycons</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681762042"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-369"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-370"></a><span>
</span><a name="line-371"></a><span class="hs-identifier">tcExtendGlobalValEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761958"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761958"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-372"></a><span>  </span><span class="hs-comment">-- Same deal as tcExtendGlobalEnv, but for Ids</span><span>
</span><a name="line-373"></a><a name="tcExtendGlobalValEnv"><a href="TcEnv.html#tcExtendGlobalValEnv"><span class="hs-identifier">tcExtendGlobalValEnv</span></a></a><span> </span><a name="local-6989586621681762045"><a href="#local-6989586621681762045"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-6989586621681762046"><a href="#local-6989586621681762046"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-374"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#tcExtendGlobalEnvImplicit"><span class="hs-identifier hs-var">tcExtendGlobalEnvImplicit</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">AnId</span><span> </span><a href="#local-6989586621681762047"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681762047"><a href="#local-6989586621681762047"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681762045"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621681762046"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-375"></a><span>
</span><a name="line-376"></a><span class="hs-identifier">tcExtendRecEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span class="hs-identifier hs-type">TyThing</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761957"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761957"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-377"></a><span class="hs-comment">-- Extend the global environments for the type/class knot tying game</span><span>
</span><a name="line-378"></a><span class="hs-comment">-- Just like tcExtendGlobalEnv, except the argument is a list of pairs</span><span>
</span><a name="line-379"></a><a name="tcExtendRecEnv"><a href="TcEnv.html#tcExtendRecEnv"><span class="hs-identifier">tcExtendRecEnv</span></a></a><span> </span><a name="local-6989586621681762048"><a href="#local-6989586621681762048"><span class="hs-identifier">gbl_stuff</span></a></a><span> </span><a name="local-6989586621681762049"><a href="#local-6989586621681762049"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-380"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681762050"><a href="#local-6989586621681762050"><span class="hs-identifier">tcg_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-381"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681762051"><a href="#local-6989586621681762051"><span class="hs-identifier">ge'</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendNameEnvList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_type_env</span><span> </span><a href="#local-6989586621681762050"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681762048"><span class="hs-identifier hs-var">gbl_stuff</span></a><span>
</span><a name="line-382"></a><span>             </span><a name="local-6989586621681762052"><a href="#local-6989586621681762052"><span class="hs-identifier">tcg_env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681762050"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_type_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681762051"><span class="hs-identifier hs-var">ge'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-383"></a><span>         </span><span class="hs-comment">-- No need for setGlobalTypeEnv (which side-effects the</span><span>
</span><a name="line-384"></a><span>         </span><span class="hs-comment">-- tcg_type_env_var); tcExtendRecEnv is used just</span><span>
</span><a name="line-385"></a><span>         </span><span class="hs-comment">-- when kind-check a group of type/class decls. It would</span><span>
</span><a name="line-386"></a><span>         </span><span class="hs-comment">-- in any case be wrong for an interface-file decl to end up</span><span>
</span><a name="line-387"></a><span>         </span><span class="hs-comment">-- with a TcTyCon in it!</span><span>
</span><a name="line-388"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><a href="#local-6989586621681762052"><span class="hs-identifier hs-var">tcg_env'</span></a><span> </span><a href="#local-6989586621681762049"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-389"></a><span>
</span><a name="line-390"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{The local environment}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-397"></a><span>
</span><a name="line-398"></a><span class="hs-identifier">tcLookupLocated</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcTyThing</span><span>
</span><a name="line-399"></a><a name="tcLookupLocated"><a href="TcEnv.html#tcLookupLocated"><span class="hs-identifier">tcLookupLocated</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addLocM"><span class="hs-identifier hs-var">addLocM</span></a><span> </span><a href="TcEnv.html#tcLookup"><span class="hs-identifier hs-var">tcLookup</span></a><span>
</span><a name="line-400"></a><span>
</span><a name="line-401"></a><span class="hs-identifier">tcLookupLcl_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TcTyThing</span><span class="hs-special">)</span><span>
</span><a name="line-402"></a><a name="tcLookupLcl_maybe"><a href="TcEnv.html#tcLookupLcl_maybe"><span class="hs-identifier">tcLookupLcl_maybe</span></a></a><span> </span><a name="local-6989586621681762053"><a href="#local-6989586621681762053"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-403"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681762054"><a href="#local-6989586621681762054"><span class="hs-identifier">local_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclTypeEnv"><span class="hs-identifier hs-var">getLclTypeEnv</span></a><span>
</span><a name="line-404"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lookupNameEnv</span><span> </span><a href="#local-6989586621681762054"><span class="hs-identifier hs-var">local_env</span></a><span> </span><a href="#local-6989586621681762053"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-405"></a><span>
</span><a name="line-406"></a><span class="hs-identifier">tcLookup</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcTyThing</span><span>
</span><a name="line-407"></a><a name="tcLookup"><a href="TcEnv.html#tcLookup"><span class="hs-identifier">tcLookup</span></a></a><span> </span><a name="local-6989586621681762055"><a href="#local-6989586621681762055"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-408"></a><span>    </span><a name="local-6989586621681762056"><a href="#local-6989586621681762056"><span class="hs-identifier">local_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclTypeEnv"><span class="hs-identifier hs-var">getLclTypeEnv</span></a><span>
</span><a name="line-409"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupNameEnv</span><span> </span><a href="#local-6989586621681762056"><span class="hs-identifier hs-var">local_env</span></a><span> </span><a href="#local-6989586621681762055"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-410"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681762057"><a href="#local-6989586621681762057"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681762057"><span class="hs-identifier hs-var">thing</span></a><span>
</span><a name="line-411"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">AGlobal</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcEnv.html#tcLookupGlobal"><span class="hs-identifier hs-var">tcLookupGlobal</span></a><span> </span><a href="#local-6989586621681762055"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-412"></a><span>
</span><a name="line-413"></a><span class="hs-identifier">tcLookupTyVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span>
</span><a name="line-414"></a><a name="tcLookupTyVar"><a href="TcEnv.html#tcLookupTyVar"><span class="hs-identifier">tcLookupTyVar</span></a></a><span> </span><a name="local-6989586621681762058"><a href="#local-6989586621681762058"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-415"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681762059"><a href="#local-6989586621681762059"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookup"><span class="hs-identifier hs-var">tcLookup</span></a><span> </span><a href="#local-6989586621681762058"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-416"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681762059"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-417"></a><span>           </span><span class="hs-identifier hs-var">ATyVar</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681762060"><a href="#local-6989586621681762060"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681762060"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-418"></a><span>           </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;tcLookupTyVar&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681762058"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-419"></a><span>
</span><a name="line-420"></a><span class="hs-identifier">tcLookupId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-421"></a><span class="hs-comment">-- Used when we aren't interested in the binding level, nor refinement.</span><span>
</span><a name="line-422"></a><span class="hs-comment">-- The &quot;no refinement&quot; part means that we return the un-refined Id regardless</span><span>
</span><a name="line-423"></a><span class="hs-comment">--</span><span>
</span><a name="line-424"></a><span class="hs-comment">-- The Id is never a DataCon. (Why does that matter? see TcExpr.tcId)</span><span>
</span><a name="line-425"></a><a name="tcLookupId"><a href="TcEnv.html#tcLookupId"><span class="hs-identifier">tcLookupId</span></a></a><span> </span><a name="local-6989586621681762061"><a href="#local-6989586621681762061"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-426"></a><span>    </span><a name="local-6989586621681762062"><a href="#local-6989586621681762062"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupIdMaybe"><span class="hs-identifier hs-var">tcLookupIdMaybe</span></a><span> </span><a href="#local-6989586621681762061"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-427"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681762062"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-428"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681762063"><a href="#local-6989586621681762063"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681762063"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-429"></a><span>        </span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;tcLookupId&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681762061"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-430"></a><span>
</span><a name="line-431"></a><span class="hs-identifier">tcLookupIdMaybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">)</span><span>
</span><a name="line-432"></a><a name="tcLookupIdMaybe"><a href="TcEnv.html#tcLookupIdMaybe"><span class="hs-identifier">tcLookupIdMaybe</span></a></a><span> </span><a name="local-6989586621681762064"><a href="#local-6989586621681762064"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-433"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681762065"><a href="#local-6989586621681762065"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookup"><span class="hs-identifier hs-var">tcLookup</span></a><span> </span><a href="#local-6989586621681762064"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-434"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681762065"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-435"></a><span>           </span><span class="hs-identifier hs-var">ATcId</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tct_id</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681762066"><a href="#local-6989586621681762066"><span class="hs-identifier">id</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681762066"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-436"></a><span>           </span><span class="hs-identifier hs-var">AGlobal</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnId</span><span> </span><a name="local-6989586621681762067"><a href="#local-6989586621681762067"><span class="hs-identifier">id</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681762067"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-437"></a><span>           </span><span class="hs-identifier">_</span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-438"></a><span>
</span><a name="line-439"></a><span class="hs-identifier">tcLookupLocalIds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcId</span><span class="hs-special">]</span><span>
</span><a name="line-440"></a><span class="hs-comment">-- We expect the variables to all be bound, and all at</span><span>
</span><a name="line-441"></a><span class="hs-comment">-- the same level as the lookup.  Only used in one place...</span><span>
</span><a name="line-442"></a><a name="tcLookupLocalIds"><a href="TcEnv.html#tcLookupLocalIds"><span class="hs-identifier">tcLookupLocalIds</span></a></a><span> </span><a name="local-6989586621681762068"><a href="#local-6989586621681762068"><span class="hs-identifier">ns</span></a></a><span>
</span><a name="line-443"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681762073"><a href="#local-6989586621681762073"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span>
</span><a name="line-444"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681762069"><span class="hs-identifier hs-var">lookup</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcl_env</span><span> </span><a href="#local-6989586621681762073"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681762068"><span class="hs-identifier hs-var">ns</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-445"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-446"></a><span>    </span><a name="local-6989586621681762069"><a href="#local-6989586621681762069"><span class="hs-identifier">lookup</span></a></a><span> </span><a name="local-6989586621681762070"><a href="#local-6989586621681762070"><span class="hs-identifier">lenv</span></a></a><span> </span><a name="local-6989586621681762071"><a href="#local-6989586621681762071"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-447"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupNameEnv</span><span> </span><a href="#local-6989586621681762070"><span class="hs-identifier hs-var">lenv</span></a><span> </span><a href="#local-6989586621681762071"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-448"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ATcId</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tct_id</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681762072"><a href="#local-6989586621681762072"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><a href="#local-6989586621681762072"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-449"></a><span>                </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;tcLookupLocalIds&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681762071"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-450"></a><span>
</span><a name="line-451"></a><span class="hs-identifier">getInLocalScope</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>
</span><a name="line-452"></a><a name="getInLocalScope"><a href="TcEnv.html#getInLocalScope"><span class="hs-identifier">getInLocalScope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681762074"><a href="#local-6989586621681762074"><span class="hs-identifier">lcl_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclTypeEnv"><span class="hs-identifier hs-var">getLclTypeEnv</span></a><span>
</span><a name="line-453"></a><span>                     </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemNameEnv</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681762074"><span class="hs-identifier hs-var">lcl_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-454"></a><span>
</span><a name="line-455"></a><span class="hs-identifier">tcExtendKindEnvList</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcTyThing</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761956"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761956"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-456"></a><span class="hs-comment">-- Used only during kind checking, for TcThings that are</span><span>
</span><a name="line-457"></a><span class="hs-comment">--      ATcTyCon or APromotionErr</span><span>
</span><a name="line-458"></a><span class="hs-comment">-- No need to update the global tyvars, or tcl_th_bndrs, or tcl_rdr</span><span>
</span><a name="line-459"></a><a name="tcExtendKindEnvList"><a href="TcEnv.html#tcExtendKindEnvList"><span class="hs-identifier">tcExtendKindEnvList</span></a></a><span> </span><a name="local-6989586621681762075"><a href="#local-6989586621681762075"><span class="hs-identifier">things</span></a></a><span> </span><a name="local-6989586621681762076"><a href="#local-6989586621681762076"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-460"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcExtendKindEnvList&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681762075"><span class="hs-identifier hs-var">things</span></a><span class="hs-special">)</span><span>
</span><a name="line-461"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#updLclEnv"><span class="hs-identifier hs-var">updLclEnv</span></a><span> </span><a href="#local-6989586621681762077"><span class="hs-identifier hs-var">upd_env</span></a><span> </span><a href="#local-6989586621681762076"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-462"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-463"></a><span>    </span><a name="local-6989586621681762077"><a href="#local-6989586621681762077"><span class="hs-identifier">upd_env</span></a></a><span> </span><a name="local-6989586621681762078"><a href="#local-6989586621681762078"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681762078"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcl_env</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendNameEnvList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcl_env</span><span> </span><a href="#local-6989586621681762078"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681762075"><span class="hs-identifier hs-var">things</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-464"></a><span>
</span><a name="line-465"></a><span class="hs-identifier">tcExtendKindEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NameEnv</span><span> </span><span class="hs-identifier hs-type">TcTyThing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761955"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761955"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-466"></a><span class="hs-comment">-- A variant of tcExtendKindEvnList</span><span>
</span><a name="line-467"></a><a name="tcExtendKindEnv"><a href="TcEnv.html#tcExtendKindEnv"><span class="hs-identifier">tcExtendKindEnv</span></a></a><span> </span><a name="local-6989586621681762079"><a href="#local-6989586621681762079"><span class="hs-identifier">extra_env</span></a></a><span> </span><a name="local-6989586621681762080"><a href="#local-6989586621681762080"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-468"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcExtendKindEnv&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681762079"><span class="hs-identifier hs-var">extra_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-469"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#updLclEnv"><span class="hs-identifier hs-var">updLclEnv</span></a><span> </span><a href="#local-6989586621681762081"><span class="hs-identifier hs-var">upd_env</span></a><span> </span><a href="#local-6989586621681762080"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-470"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-471"></a><span>    </span><a name="local-6989586621681762081"><a href="#local-6989586621681762081"><span class="hs-identifier">upd_env</span></a></a><span> </span><a name="local-6989586621681762082"><a href="#local-6989586621681762082"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681762082"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcl_env</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcl_env</span><span> </span><a href="#local-6989586621681762082"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusNameEnv</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681762079"><span class="hs-identifier hs-var">extra_env</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-472"></a><span>
</span><a name="line-473"></a><span class="hs-comment">-----------------------</span><span>
</span><a name="line-474"></a><span class="hs-comment">-- Scoped type and kind variables</span><span>
</span><a name="line-475"></a><span class="hs-identifier">tcExtendTyVarEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761954"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761954"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-476"></a><a name="tcExtendTyVarEnv"><a href="TcEnv.html#tcExtendTyVarEnv"><span class="hs-identifier">tcExtendTyVarEnv</span></a></a><span> </span><a name="local-6989586621681762083"><a href="#local-6989586621681762083"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621681762084"><a href="#local-6989586621681762084"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-477"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#tcExtendNameTyVarEnv"><span class="hs-identifier hs-var">tcExtendNameTyVarEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarNamePairs</span><span> </span><a href="#local-6989586621681762083"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681762084"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-478"></a><span>
</span><a name="line-479"></a><span class="hs-identifier">tcExtendNameTyVarEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761953"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761953"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-480"></a><a name="tcExtendNameTyVarEnv"><a href="TcEnv.html#tcExtendNameTyVarEnv"><span class="hs-identifier">tcExtendNameTyVarEnv</span></a></a><span> </span><a name="local-6989586621681762085"><a href="#local-6989586621681762085"><span class="hs-identifier">binds</span></a></a><span> </span><a name="local-6989586621681762086"><a href="#local-6989586621681762086"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-481"></a><span>  </span><span class="hs-comment">-- this should be used only for explicitly mentioned scoped variables.</span><span>
</span><a name="line-482"></a><span>  </span><span class="hs-comment">-- thus, no coercion variables</span><span>
</span><a name="line-483"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcEnv.html#tc_extend_local_env"><span class="hs-identifier hs-var">tc_extend_local_env</span></a><span> </span><span class="hs-identifier hs-var">NotTopLevel</span><span>
</span><a name="line-484"></a><span>                    </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621681762090"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ATyVar</span><span> </span><a href="#local-6989586621681762090"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621681762091"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681762090"><a href="#local-6989586621681762090"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681762091"><a href="#local-6989586621681762091"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681762085"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-485"></a><span>         </span><a href="TcEnv.html#tcExtendBinderStack"><span class="hs-identifier hs-var">tcExtendBinderStack</span></a><span> </span><a href="#local-6989586621681762087"><span class="hs-identifier hs-var">tv_binds</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-486"></a><span>         </span><a href="#local-6989586621681762086"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-487"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-488"></a><span>    </span><span class="hs-identifier">tv_binds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcBinder</span><span class="hs-special">]</span><span>
</span><a name="line-489"></a><span>    </span><a name="local-6989586621681762087"><a href="#local-6989586621681762087"><span class="hs-identifier">tv_binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">TcTvBndr</span><span> </span><a href="#local-6989586621681762088"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621681762089"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681762088"><a href="#local-6989586621681762088"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><a name="local-6989586621681762089"><a href="#local-6989586621681762089"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681762085"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">]</span><span>
</span><a name="line-490"></a><span>
</span><a name="line-491"></a><span class="hs-identifier">isTypeClosedLetBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-492"></a><span class="hs-comment">-- See Note [Bindings with closed types] in TcRnTypes</span><span>
</span><a name="line-493"></a><a name="isTypeClosedLetBndr"><a href="TcEnv.html#isTypeClosedLetBndr"><span class="hs-identifier">isTypeClosedLetBndr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noFreeVarsOfType</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">idType</span><span>
</span><a name="line-494"></a><span>
</span><a name="line-495"></a><span class="hs-identifier">tcExtendRecIds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcId</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761952"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761952"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-496"></a><span class="hs-comment">-- Used for binding the recurive uses of Ids in a binding</span><span>
</span><a name="line-497"></a><span class="hs-comment">-- both top-level value bindings and and nested let/where-bindings</span><span>
</span><a name="line-498"></a><span class="hs-comment">-- Does not extend the TcBinderStack</span><span>
</span><a name="line-499"></a><a name="tcExtendRecIds"><a href="TcEnv.html#tcExtendRecIds"><span class="hs-identifier">tcExtendRecIds</span></a></a><span> </span><a name="local-6989586621681762092"><a href="#local-6989586621681762092"><span class="hs-identifier">pairs</span></a></a><span> </span><a name="local-6989586621681762093"><a href="#local-6989586621681762093"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-500"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#tc_extend_local_env"><span class="hs-identifier hs-var">tc_extend_local_env</span></a><span> </span><span class="hs-identifier hs-var">NotTopLevel</span><span>
</span><a name="line-501"></a><span>          </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681762094"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ATcId</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tct_id</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681762095"><span class="hs-identifier hs-var">let_id</span></a><span>
</span><a name="line-502"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tct_info</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NonClosedLet</span><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-503"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681762094"><a href="#local-6989586621681762094"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681762095"><a href="#local-6989586621681762095"><span class="hs-identifier">let_id</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681762092"><span class="hs-identifier hs-var">pairs</span></a><span> </span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-504"></a><span>    </span><a href="#local-6989586621681762093"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-505"></a><span>
</span><a name="line-506"></a><span class="hs-identifier">tcExtendSigIds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcId</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761951"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761951"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-507"></a><span class="hs-comment">-- Used for binding the Ids that have a complete user type signature</span><span>
</span><a name="line-508"></a><span class="hs-comment">-- Does not extend the TcBinderStack</span><span>
</span><a name="line-509"></a><a name="tcExtendSigIds"><a href="TcEnv.html#tcExtendSigIds"><span class="hs-identifier">tcExtendSigIds</span></a></a><span> </span><a name="local-6989586621681762096"><a href="#local-6989586621681762096"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621681762097"><a href="#local-6989586621681762097"><span class="hs-identifier">sig_ids</span></a></a><span> </span><a name="local-6989586621681762098"><a href="#local-6989586621681762098"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-510"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#tc_extend_local_env"><span class="hs-identifier hs-var">tc_extend_local_env</span></a><span> </span><a href="#local-6989586621681762096"><span class="hs-identifier hs-var">top_lvl</span></a><span>
</span><a name="line-511"></a><span>          </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621681762099"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ATcId</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tct_id</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681762099"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-512"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tct_info</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681762101"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-513"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681762099"><a href="#local-6989586621681762099"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681762097"><span class="hs-identifier hs-var">sig_ids</span></a><span>
</span><a name="line-514"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681762100"><a href="#local-6989586621681762100"><span class="hs-identifier">closed</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#isTypeClosedLetBndr"><span class="hs-identifier hs-var">isTypeClosedLetBndr</span></a><span> </span><a href="#local-6989586621681762099"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-515"></a><span>                </span><a name="local-6989586621681762101"><a href="#local-6989586621681762101"><span class="hs-identifier">info</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NonClosedLet</span><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span> </span><a href="#local-6989586621681762100"><span class="hs-identifier hs-var">closed</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-516"></a><span>     </span><a href="#local-6989586621681762098"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-517"></a><span>
</span><a name="line-518"></a><span>
</span><a name="line-519"></a><span class="hs-identifier">tcExtendLetEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcSigFun</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IsGroupClosed</span><span>
</span><a name="line-520"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcId</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761950"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761950"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-521"></a><span class="hs-comment">-- Used for both top-level value bindings and and nested let/where-bindings</span><span>
</span><a name="line-522"></a><span class="hs-comment">-- Adds to the TcBinderStack too</span><span>
</span><a name="line-523"></a><a name="tcExtendLetEnv"><a href="TcEnv.html#tcExtendLetEnv"><span class="hs-identifier">tcExtendLetEnv</span></a></a><span> </span><a name="local-6989586621681762102"><a href="#local-6989586621681762102"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621681762103"><a href="#local-6989586621681762103"><span class="hs-identifier">sig_fn</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IsGroupClosed</span><span> </span><a name="local-6989586621681762104"><a href="#local-6989586621681762104"><span class="hs-identifier">fvs</span></a></a><span> </span><a name="local-6989586621681762105"><a href="#local-6989586621681762105"><span class="hs-identifier">fv_type_closed</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-524"></a><span>               </span><a name="local-6989586621681762106"><a href="#local-6989586621681762106"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-6989586621681762107"><a href="#local-6989586621681762107"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-525"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#tcExtendBinderStack"><span class="hs-identifier hs-var">tcExtendBinderStack</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">TcIdBndr</span><span> </span><a href="#local-6989586621681762113"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621681762102"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681762113"><a href="#local-6989586621681762113"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681762106"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-526"></a><span>    </span><a href="TcEnv.html#tc_extend_local_env"><span class="hs-identifier hs-var">tc_extend_local_env</span></a><span> </span><a href="#local-6989586621681762102"><span class="hs-identifier hs-var">top_lvl</span></a><span>
</span><a name="line-527"></a><span>          </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621681762114"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ATcId</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tct_id</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681762114"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-528"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tct_info</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681762108"><span class="hs-identifier hs-var">mk_tct_info</span></a><span> </span><a href="#local-6989586621681762114"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-529"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681762114"><a href="#local-6989586621681762114"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681762106"><span class="hs-identifier hs-var">ids</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-530"></a><span>    </span><a href="#local-6989586621681762107"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-531"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-532"></a><span>    </span><a name="local-6989586621681762108"><a href="#local-6989586621681762108"><span class="hs-identifier">mk_tct_info</span></a></a><span> </span><a name="local-6989586621681762109"><a href="#local-6989586621681762109"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-533"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681762112"><span class="hs-identifier hs-var">type_closed</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isEmptyNameSet</span><span> </span><a href="#local-6989586621681762111"><span class="hs-identifier hs-var">rhs_fvs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ClosedLet</span><span>
</span><a name="line-534"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NonClosedLet</span><span> </span><a href="#local-6989586621681762111"><span class="hs-identifier hs-var">rhs_fvs</span></a><span> </span><a href="#local-6989586621681762112"><span class="hs-identifier hs-var">type_closed</span></a><span>
</span><a name="line-535"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-536"></a><span>        </span><a name="local-6989586621681762110"><a href="#local-6989586621681762110"><span class="hs-identifier">name</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621681762109"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-537"></a><span>        </span><a name="local-6989586621681762111"><a href="#local-6989586621681762111"><span class="hs-identifier">rhs_fvs</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupNameEnv</span><span> </span><a href="#local-6989586621681762104"><span class="hs-identifier hs-var">fvs</span></a><span> </span><a href="#local-6989586621681762110"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">orElse</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span>
</span><a name="line-538"></a><span>        </span><a name="local-6989586621681762112"><a href="#local-6989586621681762112"><span class="hs-identifier">type_closed</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#isTypeClosedLetBndr"><span class="hs-identifier hs-var">isTypeClosedLetBndr</span></a><span> </span><a href="#local-6989586621681762109"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-539"></a><span>                      </span><span class="hs-special">(</span><a href="#local-6989586621681762105"><span class="hs-identifier hs-var">fv_type_closed</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">hasCompleteSig</span><span> </span><a href="#local-6989586621681762103"><span class="hs-identifier hs-var">sig_fn</span></a><span> </span><a href="#local-6989586621681762110"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-540"></a><span>
</span><a name="line-541"></a><span class="hs-identifier">tcExtendIdEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcId</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761949"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761949"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-542"></a><span class="hs-comment">-- For lambda-bound and case-bound Ids</span><span>
</span><a name="line-543"></a><span class="hs-comment">-- Extends the TcBinderStack as well</span><span>
</span><a name="line-544"></a><a name="tcExtendIdEnv"><a href="TcEnv.html#tcExtendIdEnv"><span class="hs-identifier">tcExtendIdEnv</span></a></a><span> </span><a name="local-6989586621681762115"><a href="#local-6989586621681762115"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-6989586621681762116"><a href="#local-6989586621681762116"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-545"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#tcExtendIdEnv2"><span class="hs-identifier hs-var">tcExtendIdEnv2</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621681762117"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681762117"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681762117"><a href="#local-6989586621681762117"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681762115"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621681762116"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-546"></a><span>
</span><a name="line-547"></a><span class="hs-identifier">tcExtendIdEnv1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761948"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761948"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-548"></a><span class="hs-comment">-- Exactly like tcExtendIdEnv2, but for a single (name,id) pair</span><span>
</span><a name="line-549"></a><a name="tcExtendIdEnv1"><a href="TcEnv.html#tcExtendIdEnv1"><span class="hs-identifier">tcExtendIdEnv1</span></a></a><span> </span><a name="local-6989586621681762118"><a href="#local-6989586621681762118"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621681762119"><a href="#local-6989586621681762119"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621681762120"><a href="#local-6989586621681762120"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-550"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#tcExtendIdEnv2"><span class="hs-identifier hs-var">tcExtendIdEnv2</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621681762118"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><a href="#local-6989586621681762119"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621681762120"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-551"></a><span>
</span><a name="line-552"></a><span class="hs-identifier">tcExtendIdEnv2</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span class="hs-identifier hs-type">TcId</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761947"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761947"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-553"></a><a name="tcExtendIdEnv2"><a href="TcEnv.html#tcExtendIdEnv2"><span class="hs-identifier">tcExtendIdEnv2</span></a></a><span> </span><a name="local-6989586621681762121"><a href="#local-6989586621681762121"><span class="hs-identifier">names_w_ids</span></a></a><span> </span><a name="local-6989586621681762122"><a href="#local-6989586621681762122"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-554"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#tcExtendBinderStack"><span class="hs-identifier hs-var">tcExtendBinderStack</span></a><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">TcIdBndr</span><span> </span><a href="#local-6989586621681762123"><span class="hs-identifier hs-var">mono_id</span></a><span> </span><span class="hs-identifier hs-var">NotTopLevel</span><span>
</span><a name="line-555"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621681762123"><a href="#local-6989586621681762123"><span class="hs-identifier">mono_id</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681762121"><span class="hs-identifier hs-var">names_w_ids</span></a><span> </span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-556"></a><span>    </span><a href="TcEnv.html#tc_extend_local_env"><span class="hs-identifier hs-var">tc_extend_local_env</span></a><span> </span><span class="hs-identifier hs-var">NotTopLevel</span><span>
</span><a name="line-557"></a><span>            </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681762124"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ATcId</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tct_id</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681762125"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-558"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tct_info</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NotLetBound</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-559"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681762124"><a href="#local-6989586621681762124"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><a name="local-6989586621681762125"><a href="#local-6989586621681762125"><span class="hs-identifier">id</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681762121"><span class="hs-identifier hs-var">names_w_ids</span></a><span class="hs-special">]</span><span>
</span><a name="line-560"></a><span>    </span><a href="#local-6989586621681762122"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-561"></a><span>
</span><a name="line-562"></a><span class="hs-identifier">tc_extend_local_env</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcTyThing</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761946"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761946"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-563"></a><a name="tc_extend_local_env"><a href="TcEnv.html#tc_extend_local_env"><span class="hs-identifier">tc_extend_local_env</span></a></a><span> </span><a name="local-6989586621681762126"><a href="#local-6989586621681762126"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621681762127"><a href="#local-6989586621681762127"><span class="hs-identifier">extra_env</span></a></a><span> </span><a name="local-6989586621681762128"><a href="#local-6989586621681762128"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-564"></a><span class="hs-comment">-- Precondition: the argument list extra_env has TcTyThings</span><span>
</span><a name="line-565"></a><span class="hs-comment">--               that ATcId or ATyVar, but nothing else</span><span>
</span><a name="line-566"></a><span class="hs-comment">--</span><span>
</span><a name="line-567"></a><span class="hs-comment">-- Invariant: the ATcIds are fully zonked. Reasons:</span><span>
</span><a name="line-568"></a><span class="hs-comment">--      (a) The kinds of the forall'd type variables are defaulted</span><span>
</span><a name="line-569"></a><span class="hs-comment">--          (see Kind.defaultKind, done in skolemiseQuantifiedTyVar)</span><span>
</span><a name="line-570"></a><span class="hs-comment">--      (b) There are no via-Indirect occurrences of the bound variables</span><span>
</span><a name="line-571"></a><span class="hs-comment">--          in the types, because instantiation does not look through such things</span><span>
</span><a name="line-572"></a><span class="hs-comment">--      (c) The call to tyCoVarsOfTypes is ok without looking through refs</span><span>
</span><a name="line-573"></a><span>
</span><a name="line-574"></a><span class="hs-comment">-- The second argument of type TyVarSet is a set of type variables</span><span>
</span><a name="line-575"></a><span class="hs-comment">-- that are bound together with extra_env and should not be regarded</span><span>
</span><a name="line-576"></a><span class="hs-comment">-- as free in the types of extra_env.</span><span>
</span><a name="line-577"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tc_extend_local_env&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681762127"><span class="hs-identifier hs-var">extra_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-578"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681762137"><a href="#local-6989586621681762137"><span class="hs-identifier">env0</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span>
</span><a name="line-579"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681762138"><a href="#local-6989586621681762138"><span class="hs-identifier">env1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcExtendLocalTypeEnv"><span class="hs-identifier hs-var">tcExtendLocalTypeEnv</span></a><span> </span><a href="#local-6989586621681762137"><span class="hs-identifier hs-var">env0</span></a><span> </span><a href="#local-6989586621681762127"><span class="hs-identifier hs-var">extra_env</span></a><span>
</span><a name="line-580"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681762139"><a href="#local-6989586621681762139"><span class="hs-identifier">stage</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getStage"><span class="hs-identifier hs-var">getStage</span></a><span>
</span><a name="line-581"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681762140"><a href="#local-6989586621681762140"><span class="hs-identifier">env2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681762129"><span class="hs-identifier hs-var">extend_local_env</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681762126"><span class="hs-identifier hs-var">top_lvl</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">thLevel</span><span> </span><a href="#local-6989586621681762139"><span class="hs-identifier hs-var">stage</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681762127"><span class="hs-identifier hs-var">extra_env</span></a><span> </span><a href="#local-6989586621681762138"><span class="hs-identifier hs-var">env1</span></a><span>
</span><a name="line-582"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setLclEnv"><span class="hs-identifier hs-var">setLclEnv</span></a><span> </span><a href="#local-6989586621681762140"><span class="hs-identifier hs-var">env2</span></a><span> </span><a href="#local-6989586621681762128"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-583"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-584"></a><span>    </span><span class="hs-identifier">extend_local_env</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TopLevelFlag</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ThLevel</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcTyThing</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcLclEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcLclEnv</span><span>
</span><a name="line-585"></a><span>    </span><span class="hs-comment">-- Extend the local LocalRdrEnv and Template Haskell staging env simultaneously</span><span>
</span><a name="line-586"></a><span>    </span><span class="hs-comment">-- Reason for extending LocalRdrEnv: after running a TH splice we need</span><span>
</span><a name="line-587"></a><span>    </span><span class="hs-comment">-- to do renaming.</span><span>
</span><a name="line-588"></a><span>    </span><a name="local-6989586621681762129"><a href="#local-6989586621681762129"><span class="hs-identifier">extend_local_env</span></a></a><span> </span><a name="local-6989586621681762130"><a href="#local-6989586621681762130"><span class="hs-identifier">thlvl</span></a></a><span> </span><a name="local-6989586621681762131"><a href="#local-6989586621681762131"><span class="hs-identifier">pairs</span></a></a><span> </span><a name="local-6989586621681762132"><a href="#local-6989586621681762132"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">TcLclEnv</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcl_rdr</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681762133"><a href="#local-6989586621681762133"><span class="hs-identifier">rdr_env</span></a></a><span>
</span><a name="line-589"></a><span>                                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcl_th_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681762134"><a href="#local-6989586621681762134"><span class="hs-identifier">th_bndrs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-590"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681762132"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcl_rdr</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendLocalRdrEnvList</span><span> </span><a href="#local-6989586621681762133"><span class="hs-identifier hs-var">rdr_env</span></a><span>
</span><a name="line-591"></a><span>                                </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621681762135"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681762135"><a href="#local-6989586621681762135"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681762131"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isInternalName</span><span> </span><a href="#local-6989586621681762135"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-592"></a><span>                                </span><span class="hs-comment">-- The LocalRdrEnv contains only non-top-level names</span><span>
</span><a name="line-593"></a><span>                                </span><span class="hs-comment">-- (GlobalRdrEnv handles the top level)</span><span>
</span><a name="line-594"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcl_th_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendNameEnvList</span><span> </span><a href="#local-6989586621681762134"><span class="hs-identifier hs-var">th_bndrs</span></a><span>  </span><span class="hs-comment">-- We only track Ids in tcl_th_bndrs</span><span>
</span><a name="line-595"></a><span>                                 </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621681762136"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681762130"><span class="hs-identifier hs-var">thlvl</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681762136"><a href="#local-6989586621681762136"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ATcId</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681762131"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-596"></a><span>
</span><a name="line-597"></a><span class="hs-identifier">tcExtendLocalTypeEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcLclEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcTyThing</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcLclEnv</span><span>
</span><a name="line-598"></a><a name="tcExtendLocalTypeEnv"><a href="TcEnv.html#tcExtendLocalTypeEnv"><span class="hs-identifier">tcExtendLocalTypeEnv</span></a></a><span> </span><a name="local-6989586621681762141"><a href="#local-6989586621681762141"><span class="hs-identifier">lcl_env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">TcLclEnv</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcl_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681762142"><a href="#local-6989586621681762142"><span class="hs-identifier">lcl_type_env</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621681762143"><a href="#local-6989586621681762143"><span class="hs-identifier">tc_ty_things</span></a></a><span>
</span><a name="line-599"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isEmptyVarSet</span><span> </span><a href="#local-6989586621681762144"><span class="hs-identifier hs-var">extra_tvs</span></a><span>
</span><a name="line-600"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681762141"><span class="hs-identifier hs-var">lcl_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcl_env</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendNameEnvList</span><span> </span><a href="#local-6989586621681762142"><span class="hs-identifier hs-var">lcl_type_env</span></a><span> </span><a href="#local-6989586621681762143"><span class="hs-identifier hs-var">tc_ty_things</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-601"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-602"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681762160"><a href="#local-6989586621681762160"><span class="hs-identifier">global_tvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readMutVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcl_tyvars</span><span> </span><a href="#local-6989586621681762141"><span class="hs-identifier hs-var">lcl_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-603"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681762161"><a href="#local-6989586621681762161"><span class="hs-identifier">new_g_var</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newMutVar</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681762160"><span class="hs-identifier hs-var">global_tvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681762144"><span class="hs-identifier hs-var">extra_tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-604"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681762141"><span class="hs-identifier hs-var">lcl_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcl_tyvars</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681762161"><span class="hs-identifier hs-var">new_g_var</span></a><span>
</span><a name="line-605"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcl_env</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendNameEnvList</span><span> </span><a href="#local-6989586621681762142"><span class="hs-identifier hs-var">lcl_type_env</span></a><span> </span><a href="#local-6989586621681762143"><span class="hs-identifier hs-var">tc_ty_things</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-606"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-607"></a><span>    </span><a name="local-6989586621681762144"><a href="#local-6989586621681762144"><span class="hs-identifier">extra_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621681762145"><span class="hs-identifier hs-var">get_tvs</span></a><span> </span><span class="hs-identifier hs-var">emptyVarSet</span><span> </span><a href="#local-6989586621681762143"><span class="hs-identifier hs-var">tc_ty_things</span></a><span>
</span><a name="line-608"></a><span>
</span><a name="line-609"></a><span>    </span><a name="local-6989586621681762145"><a href="#local-6989586621681762145"><span class="hs-identifier">get_tvs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ATcId</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tct_id</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681762146"><a href="#local-6989586621681762146"><span class="hs-identifier">id</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tct_info</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681762147"><a href="#local-6989586621681762147"><span class="hs-identifier">closed</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621681762148"><a href="#local-6989586621681762148"><span class="hs-identifier">tvs</span></a></a><span>
</span><a name="line-610"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681762147"><span class="hs-identifier hs-var">closed</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-611"></a><span>          </span><span class="hs-identifier hs-var">ClosedLet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">is_closed_type</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681762152"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621681762152"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621681762152"><span class="hs-operator hs-var">$$</span></a><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">idType</span><span> </span><span class="hs-identifier hs-var">id</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-612"></a><span>                       </span><a href="#local-6989586621681762148"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-613"></a><span>          </span><a name="local-6989586621681762153"><a href="#local-6989586621681762153"><span class="hs-identifier">_other</span></a></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681762148"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681762150"><span class="hs-identifier hs-var">id_tvs</span></a><span>
</span><a name="line-614"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-615"></a><span>           </span><a name="local-6989586621681762149"><a href="#local-6989586621681762149"><span class="hs-identifier">id_ty</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621681762146"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-616"></a><span>           </span><a name="local-6989586621681762150"><a href="#local-6989586621681762150"><span class="hs-identifier">id_tvs</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyCoVarsOfType</span><span> </span><a href="#local-6989586621681762149"><span class="hs-identifier hs-var">id_ty</span></a><span>
</span><a name="line-617"></a><span>           </span><a name="local-6989586621681762151"><a href="#local-6989586621681762151"><span class="hs-identifier">id_co_tvs</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">closeOverKinds</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">coVarsOfType</span><span> </span><a href="#local-6989586621681762149"><span class="hs-identifier hs-var">id_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-618"></a><span>           </span><a name="local-6989586621681762152"><a href="#local-6989586621681762152"><span class="hs-identifier">is_closed_type</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">anyVarSet</span><span> </span><span class="hs-identifier hs-var">isTyVar</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681762150"><span class="hs-identifier hs-var">id_tvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">minusVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681762151"><span class="hs-identifier hs-var">id_co_tvs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-619"></a><span>           </span><span class="hs-comment">-- We only care about being closed wrt /type/ variables</span><span>
</span><a name="line-620"></a><span>           </span><span class="hs-comment">-- E.g. a top-level binding might have a type like</span><span>
</span><a name="line-621"></a><span>           </span><span class="hs-comment">--          foo :: t |&gt; co</span><span>
</span><a name="line-622"></a><span>           </span><span class="hs-comment">-- where co :: * ~ *</span><span>
</span><a name="line-623"></a><span>           </span><span class="hs-comment">-- or some other as-yet-unsolved kind coercion</span><span>
</span><a name="line-624"></a><span>
</span><a name="line-625"></a><span>    </span><span class="hs-identifier">get_tvs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ATyVar</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681762154"><a href="#local-6989586621681762154"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681762155"><a href="#local-6989586621681762155"><span class="hs-identifier">tvs</span></a></a><span>          </span><span class="hs-comment">-- See Note [Global TyVars]</span><span>
</span><a name="line-626"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681762155"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionVarSet</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">tyCoVarsOfType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyVarKind</span><span> </span><a href="#local-6989586621681762154"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">extendVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681762154"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-627"></a><span>
</span><a name="line-628"></a><span>    </span><span class="hs-identifier">get_tvs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ATcTyCon</span><span> </span><a name="local-6989586621681762156"><a href="#local-6989586621681762156"><span class="hs-identifier">tc</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681762157"><a href="#local-6989586621681762157"><span class="hs-identifier">tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681762157"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionVarSet</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">tyCoVarsOfType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConKind</span><span> </span><a href="#local-6989586621681762156"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-629"></a><span>
</span><a name="line-630"></a><span>    </span><span class="hs-identifier">get_tvs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">AGlobal</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>       </span><a name="local-6989586621681762158"><a href="#local-6989586621681762158"><span class="hs-identifier">tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681762158"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-631"></a><span>    </span><span class="hs-identifier">get_tvs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">APromotionErr</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621681762159"><a href="#local-6989586621681762159"><span class="hs-identifier">tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681762159"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-632"></a><span>
</span><a name="line-633"></a><span>        </span><span class="hs-comment">-- Note [Global TyVars]</span><span>
</span><a name="line-634"></a><span>        </span><span class="hs-comment">-- It's important to add the in-scope tyvars to the global tyvar set</span><span>
</span><a name="line-635"></a><span>        </span><span class="hs-comment">-- as well.  Consider</span><span>
</span><a name="line-636"></a><span>        </span><span class="hs-comment">--      f (_::r) = let g y = y::r in ...</span><span>
</span><a name="line-637"></a><span>        </span><span class="hs-comment">-- Here, g mustn't be generalised.  This is also important during</span><span>
</span><a name="line-638"></a><span>        </span><span class="hs-comment">-- class and instance decls, when we mustn't generalise the class tyvars</span><span>
</span><a name="line-639"></a><span>        </span><span class="hs-comment">-- when typechecking the methods.</span><span>
</span><a name="line-640"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-641"></a><span>        </span><span class="hs-comment">-- Nor must we generalise g over any kind variables free in r's kind</span><span>
</span><a name="line-642"></a><span>
</span><a name="line-643"></a><span>
</span><a name="line-644"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
             The TcBinderStack
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-649"></a><span>
</span><a name="line-650"></a><span class="hs-identifier">tcExtendBinderStack</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcBinder</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761945"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761945"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-651"></a><a name="tcExtendBinderStack"><a href="TcEnv.html#tcExtendBinderStack"><span class="hs-identifier">tcExtendBinderStack</span></a></a><span> </span><a name="local-6989586621681762162"><a href="#local-6989586621681762162"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-6989586621681762163"><a href="#local-6989586621681762163"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-652"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcExtendBinderStack&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681762162"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-653"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#updLclEnv"><span class="hs-identifier hs-var">updLclEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681762164"><a href="#local-6989586621681762164"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681762164"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcl_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681762162"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier">tcl_bndrs</span><span> </span><a href="#local-6989586621681762164"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-654"></a><span>                   </span><a href="#local-6989586621681762163"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-655"></a><span>
</span><a name="line-656"></a><span class="hs-identifier">tcInitTidyEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TidyEnv</span><span>
</span><a name="line-657"></a><span class="hs-comment">-- We initialise the &quot;tidy-env&quot;, used for tidying types before printing,</span><span>
</span><a name="line-658"></a><span class="hs-comment">-- by building a reverse map from the in-scope type variables to the</span><span>
</span><a name="line-659"></a><span class="hs-comment">-- OccName that the programmer originally used for them</span><span>
</span><a name="line-660"></a><a name="tcInitTidyEnv"><a href="TcEnv.html#tcInitTidyEnv"><span class="hs-identifier">tcInitTidyEnv</span></a></a><span>
</span><a name="line-661"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681762179"><a href="#local-6989586621681762179"><span class="hs-identifier">lcl_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span>
</span><a name="line-662"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621681762165"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-identifier hs-var">emptyTidyEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcl_bndrs</span><span> </span><a href="#local-6989586621681762179"><span class="hs-identifier hs-var">lcl_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-663"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-664"></a><span>    </span><a name="local-6989586621681762165"><a href="#local-6989586621681762165"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681762166"><a href="#local-6989586621681762166"><span class="hs-identifier">env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681762167"><a href="#local-6989586621681762167"><span class="hs-identifier">subst</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-665"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681762166"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681762167"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span>
</span><a name="line-666"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681762168"><a href="#local-6989586621681762168"><span class="hs-identifier">env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681762169"><a href="#local-6989586621681762169"><span class="hs-identifier">subst</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681762170"><a href="#local-6989586621681762170"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621681762171"><a href="#local-6989586621681762171"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-667"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">TcTvBndr</span><span> </span><a name="local-6989586621681762172"><a href="#local-6989586621681762172"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621681762173"><a href="#local-6989586621681762173"><span class="hs-identifier">tyvar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681762170"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-668"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681762174"><a href="#local-6989586621681762174"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681762175"><a href="#local-6989586621681762175"><span class="hs-identifier">occ'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tidyOccName</span><span> </span><a href="#local-6989586621681762168"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621681762172"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-669"></a><span>                  </span><a name="local-6989586621681762176"><a href="#local-6989586621681762176"><span class="hs-identifier">name'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tidyNameOcc</span><span> </span><a href="#local-6989586621681762172"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621681762175"><span class="hs-identifier hs-var">occ'</span></a><span>
</span><a name="line-670"></a><span>                  </span><a name="local-6989586621681762177"><a href="#local-6989586621681762177"><span class="hs-identifier">tyvar1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">setTyVarName</span><span> </span><a href="#local-6989586621681762173"><span class="hs-identifier hs-var">tyvar</span></a><span> </span><a href="#local-6989586621681762176"><span class="hs-identifier hs-var">name'</span></a><span>
</span><a name="line-671"></a><span>            </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681762178"><a href="#local-6989586621681762178"><span class="hs-identifier">tyvar2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcTyVarToTyVar"><span class="hs-identifier hs-var">zonkTcTyVarToTyVar</span></a><span> </span><a href="#local-6989586621681762177"><span class="hs-identifier hs-var">tyvar1</span></a><span>
</span><a name="line-672"></a><span>              </span><span class="hs-comment">-- Be sure to zonk here!  Tidying applies to zonked</span><span>
</span><a name="line-673"></a><span>              </span><span class="hs-comment">-- types, so if we don't zonk we may create an</span><span>
</span><a name="line-674"></a><span>              </span><span class="hs-comment">-- ill-kinded type (Trac #14175)</span><span>
</span><a name="line-675"></a><span>            </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621681762165"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681762174"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">extendVarEnv</span><span> </span><a href="#local-6989586621681762169"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621681762173"><span class="hs-identifier hs-var">tyvar</span></a><span> </span><a href="#local-6989586621681762178"><span class="hs-identifier hs-var">tyvar2</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681762171"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-676"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-677"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681762165"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681762168"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681762169"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681762171"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-678"></a><span>
</span><a name="line-679"></a><span class="hs-comment">-- | Get a 'TidyEnv' that includes mappings for all vars free in the given</span><span>
</span><a name="line-680"></a><span class="hs-comment">-- type. Useful when tidying open types.</span><span>
</span><a name="line-681"></a><span class="hs-identifier">tcInitOpenTidyEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyCoVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TidyEnv</span><span>
</span><a name="line-682"></a><a name="tcInitOpenTidyEnv"><a href="TcEnv.html#tcInitOpenTidyEnv"><span class="hs-identifier">tcInitOpenTidyEnv</span></a></a><span> </span><a name="local-6989586621681762180"><a href="#local-6989586621681762180"><span class="hs-identifier">tvs</span></a></a><span>
</span><a name="line-683"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681762181"><a href="#local-6989586621681762181"><span class="hs-identifier">env1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcInitTidyEnv"><span class="hs-identifier hs-var">tcInitTidyEnv</span></a><span>
</span><a name="line-684"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681762182"><a href="#local-6989586621681762182"><span class="hs-identifier">env2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tidyFreeTyCoVars</span><span> </span><a href="#local-6989586621681762181"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621681762180"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-685"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681762182"><span class="hs-identifier hs-var">env2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-686"></a><span>
</span><a name="line-687"></a><span>
</span><a name="line-688"></a><span>
</span><a name="line-689"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
             Adding placeholders
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-694"></a><span>
</span><a name="line-695"></a><span class="hs-identifier">tcAddDataFamConPlaceholders</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LInstDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761944"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761944"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-696"></a><span class="hs-comment">-- See Note [AFamDataCon: not promoting data family constructors]</span><span>
</span><a name="line-697"></a><a name="tcAddDataFamConPlaceholders"><a href="TcEnv.html#tcAddDataFamConPlaceholders"><span class="hs-identifier">tcAddDataFamConPlaceholders</span></a></a><span> </span><a name="local-6989586621681762183"><a href="#local-6989586621681762183"><span class="hs-identifier">inst_decls</span></a></a><span> </span><a name="local-6989586621681762184"><a href="#local-6989586621681762184"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-698"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#tcExtendKindEnvList"><span class="hs-identifier hs-var">tcExtendKindEnvList</span></a><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681762191"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">APromotionErr</span><span> </span><span class="hs-identifier hs-var">FamDataConPE</span><span class="hs-special">)</span><span>
</span><a name="line-699"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681762190"><a href="#local-6989586621681762190"><span class="hs-identifier">lid</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681762183"><span class="hs-identifier hs-var">inst_decls</span></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681762191"><a href="#local-6989586621681762191"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681762185"><span class="hs-identifier hs-var">get_cons</span></a><span> </span><a href="#local-6989586621681762190"><span class="hs-identifier hs-var">lid</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-700"></a><span>      </span><a href="#local-6989586621681762184"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-701"></a><span>      </span><span class="hs-comment">-- Note [AFamDataCon: not promoting data family constructors]</span><span>
</span><a name="line-702"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-703"></a><span>    </span><span class="hs-comment">-- get_cons extracts the *constructor* bindings of the declaration</span><span>
</span><a name="line-704"></a><span>    </span><span class="hs-identifier">get_cons</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LInstDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-705"></a><span>    </span><a name="local-6989586621681762185"><a href="#local-6989586621681762185"><span class="hs-identifier">get_cons</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyFamInstD</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-706"></a><span>    </span><span class="hs-identifier">get_cons</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataFamInstD</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dfid_inst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681762187"><a href="#local-6989586621681762187"><span class="hs-identifier">fid</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681762186"><span class="hs-identifier hs-var">get_fi_cons</span></a><span> </span><a href="#local-6989586621681762187"><span class="hs-identifier hs-var">fid</span></a><span>
</span><a name="line-707"></a><span>    </span><span class="hs-identifier">get_cons</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ClsInstD</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cid_inst</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ClsInstDecl</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cid_datafam_insts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681762188"><a href="#local-6989586621681762188"><span class="hs-identifier">fids</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-708"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681762186"><span class="hs-identifier hs-var">get_fi_cons</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681762188"><span class="hs-identifier hs-var">fids</span></a><span>
</span><a name="line-709"></a><span>    </span><span class="hs-identifier">get_cons</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ClsInstD</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XClsInstDecl</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;get_cons&quot;</span><span>
</span><a name="line-710"></a><span>    </span><span class="hs-identifier">get_cons</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XInstDecl</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;get_cons&quot;</span><span>
</span><a name="line-711"></a><span>
</span><a name="line-712"></a><span>    </span><span class="hs-identifier">get_fi_cons</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataFamInstDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-713"></a><span>    </span><a name="local-6989586621681762186"><a href="#local-6989586621681762186"><span class="hs-identifier">get_fi_cons</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataFamInstDecl</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dfid_eqn</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HsIB</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsib_body</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-714"></a><span>                  </span><span class="hs-identifier hs-var">FamEqn</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">feqn_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HsDataDefn</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dd_cons</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681762189"><a href="#local-6989586621681762189"><span class="hs-identifier">cons</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-715"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getConNames</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681762189"><span class="hs-identifier hs-var">cons</span></a><span>
</span><a name="line-716"></a><span>    </span><span class="hs-identifier">get_fi_cons</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataFamInstDecl</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dfid_eqn</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HsIB</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsib_body</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-717"></a><span>                  </span><span class="hs-identifier hs-var">FamEqn</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">feqn_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">XHsDataDefn</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-718"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;get_fi_cons&quot;</span><span>
</span><a name="line-719"></a><span>    </span><span class="hs-identifier">get_fi_cons</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataFamInstDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIB</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XFamEqn</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;get_fi_cons&quot;</span><span>
</span><a name="line-720"></a><span>    </span><span class="hs-identifier">get_fi_cons</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataFamInstDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsImplicitBndrs</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;get_fi_cons&quot;</span><span>
</span><a name="line-721"></a><span>
</span><a name="line-722"></a><span>
</span><a name="line-723"></a><span class="hs-identifier">tcAddPatSynPlaceholders</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">PatSynBind</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761943"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761943"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-724"></a><span class="hs-comment">-- See Note [Don't promote pattern synonyms]</span><span>
</span><a name="line-725"></a><a name="tcAddPatSynPlaceholders"><a href="TcEnv.html#tcAddPatSynPlaceholders"><span class="hs-identifier">tcAddPatSynPlaceholders</span></a></a><span> </span><a name="local-6989586621681762192"><a href="#local-6989586621681762192"><span class="hs-identifier">pat_syns</span></a></a><span> </span><a name="local-6989586621681762193"><a href="#local-6989586621681762193"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-726"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#tcExtendKindEnvList"><span class="hs-identifier hs-var">tcExtendKindEnvList</span></a><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681762194"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">APromotionErr</span><span> </span><span class="hs-identifier hs-var">PatSynPE</span><span class="hs-special">)</span><span>
</span><a name="line-727"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">PSB</span><span class="hs-special">{</span><span> </span><span class="hs-identifier">psb_id</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681762194"><a href="#local-6989586621681762194"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681762192"><span class="hs-identifier hs-var">pat_syns</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-728"></a><span>       </span><a href="#local-6989586621681762193"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-729"></a><span>
</span><a name="line-730"></a><span class="hs-identifier">getTypeSigNames</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LSig</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span>
</span><a name="line-731"></a><span class="hs-comment">-- Get the names that have a user type sig</span><span>
</span><a name="line-732"></a><a name="getTypeSigNames"><a href="TcEnv.html#getTypeSigNames"><span class="hs-identifier">getTypeSigNames</span></a></a><span> </span><a name="local-6989586621681762195"><a href="#local-6989586621681762195"><span class="hs-identifier">sigs</span></a></a><span>
</span><a name="line-733"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621681762196"><span class="hs-identifier hs-var">get_type_sig</span></a><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span> </span><a href="#local-6989586621681762195"><span class="hs-identifier hs-var">sigs</span></a><span>
</span><a name="line-734"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-735"></a><span>    </span><span class="hs-identifier">get_type_sig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LSig</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span>
</span><a name="line-736"></a><span>    </span><a name="local-6989586621681762196"><a href="#local-6989586621681762196"><span class="hs-identifier">get_type_sig</span></a></a><span> </span><a name="local-6989586621681762197"><a href="#local-6989586621681762197"><span class="hs-identifier">sig</span></a></a><span> </span><a name="local-6989586621681762198"><a href="#local-6989586621681762198"><span class="hs-identifier">ns</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-737"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681762197"><span class="hs-identifier hs-var">sig</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-738"></a><span>        </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TypeSig</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681762199"><a href="#local-6989586621681762199"><span class="hs-identifier">names</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">extendNameSetList</span><span> </span><a href="#local-6989586621681762198"><span class="hs-identifier hs-var">ns</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621681762199"><span class="hs-identifier hs-var">names</span></a><span class="hs-special">)</span><span>
</span><a name="line-739"></a><span>        </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PatSynSig</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681762200"><a href="#local-6989586621681762200"><span class="hs-identifier">names</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">extendNameSetList</span><span> </span><a href="#local-6989586621681762198"><span class="hs-identifier hs-var">ns</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621681762200"><span class="hs-identifier hs-var">names</span></a><span class="hs-special">)</span><span>
</span><a name="line-740"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681762198"><span class="hs-identifier hs-var">ns</span></a><span>
</span><a name="line-741"></a><span>
</span><a name="line-742"></a><span>
</span><a name="line-743"></a><span class="hs-comment">{- Note [AFamDataCon: not promoting data family constructors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
  data family T a
  data instance T Int = MkT
  data Proxy (a :: k)
  data S = MkS (Proxy 'MkT)

Is it ok to use the promoted data family instance constructor 'MkT' in
the data declaration for S (where both declarations live in the same module)?
No, we don't allow this. It *might* make sense, but at least it would mean that
we'd have to interleave typechecking instances and data types, whereas at
present we do data types *then* instances.

So to check for this we put in the TcLclEnv a binding for all the family
constructors, bound to AFamDataCon, so that if we trip over 'MkT' when
type checking 'S' we'll produce a decent error message.

Trac #12088 describes this limitation. Of course, when MkT and S live in
different modules then all is well.

Note [Don't promote pattern synonyms]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We never promote pattern synonyms.

Consider this (Trac #11265):
  pattern A = True
  instance Eq A
We want a civilised error message from the occurrence of 'A'
in the instance, yet 'A' really has not yet been type checked.

Similarly (Trac #9161)
  {-# LANGUAGE PatternSynonyms, DataKinds #-}
  pattern A = ()
  b :: A
  b = undefined
Here, the type signature for b mentions A.  But A is a pattern
synonym, which is typechecked as part of a group of bindings (for very
good reasons; a view pattern in the RHS may mention a value binding).
It is entirely reasonable to reject this, but to do so we need A to be
in the kind environment when kind-checking the signature for B.

Hence tcAddPatSynPlaceholers adds a binding
    A -&gt; APromotionErr PatSynPE
to the environment. Then TcHsType.tcTyVar will find A in the kind
environment, and will give a 'wrongThingErr' as a result.  But the
lookup of A won't fail.


************************************************************************
*                                                                      *
\subsection{Rules}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-798"></a><span>
</span><a name="line-799"></a><span class="hs-identifier">tcExtendRules</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LRuleDecl</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761942"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761942"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-800"></a><span>        </span><span class="hs-comment">-- Just pop the new rules into the EPS and envt resp</span><span>
</span><a name="line-801"></a><span>        </span><span class="hs-comment">-- All the rules come from an interface file, not source</span><span>
</span><a name="line-802"></a><span>        </span><span class="hs-comment">-- Nevertheless, some may be for this module, if we read</span><span>
</span><a name="line-803"></a><span>        </span><span class="hs-comment">-- its interface instead of its source code</span><span>
</span><a name="line-804"></a><a name="tcExtendRules"><a href="TcEnv.html#tcExtendRules"><span class="hs-identifier">tcExtendRules</span></a></a><span> </span><a name="local-6989586621681762201"><a href="#local-6989586621681762201"><span class="hs-identifier">lcl_rules</span></a></a><span> </span><a name="local-6989586621681762202"><a href="#local-6989586621681762202"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-805"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681762203"><a href="#local-6989586621681762203"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-806"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-807"></a><span>          </span><a name="local-6989586621681762204"><a href="#local-6989586621681762204"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681762203"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_rules</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681762201"><span class="hs-identifier hs-var">lcl_rules</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier">tcg_rules</span><span> </span><a href="#local-6989586621681762203"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-808"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><a href="#local-6989586621681762204"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621681762202"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-809"></a><span>
</span><a name="line-810"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Meta level
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-817"></a><span>
</span><a name="line-818"></a><span class="hs-identifier">checkWellStaged</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>         </span><span class="hs-comment">-- What the stage check is for</span><span>
</span><a name="line-819"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ThLevel</span><span>      </span><span class="hs-comment">-- Binding level (increases inside brackets)</span><span>
</span><a name="line-820"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ThLevel</span><span>      </span><span class="hs-comment">-- Use stage</span><span>
</span><a name="line-821"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>       </span><span class="hs-comment">-- Fail if badly staged, adding an error</span><span>
</span><a name="line-822"></a><a name="checkWellStaged"><a href="TcEnv.html#checkWellStaged"><span class="hs-identifier">checkWellStaged</span></a></a><span> </span><a name="local-6989586621681762205"><a href="#local-6989586621681762205"><span class="hs-identifier">pp_thing</span></a></a><span> </span><a name="local-6989586621681762206"><a href="#local-6989586621681762206"><span class="hs-identifier">bind_lvl</span></a></a><span> </span><a name="local-6989586621681762207"><a href="#local-6989586621681762207"><span class="hs-identifier">use_lvl</span></a></a><span>
</span><a name="line-823"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681762207"><span class="hs-identifier hs-var">use_lvl</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621681762206"><span class="hs-identifier hs-var">bind_lvl</span></a><span>         </span><span class="hs-comment">-- OK! Used later than bound</span><span>
</span><a name="line-824"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>                   </span><span class="hs-comment">-- E.g.  \x -&gt; [| $(f x) |]</span><span>
</span><a name="line-825"></a><span>
</span><a name="line-826"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681762206"><span class="hs-identifier hs-var">bind_lvl</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">outerLevel</span><span>      </span><span class="hs-comment">-- GHC restriction on top level splices</span><span>
</span><a name="line-827"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#stageRestrictionError"><span class="hs-identifier hs-var">stageRestrictionError</span></a><span> </span><a href="#local-6989586621681762205"><span class="hs-identifier hs-var">pp_thing</span></a><span>
</span><a name="line-828"></a><span>
</span><a name="line-829"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                   </span><span class="hs-comment">-- Badly staged</span><span>
</span><a name="line-830"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>                </span><span class="hs-comment">-- E.g.  \x -&gt; $(f x)</span><span>
</span><a name="line-831"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Stage error:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621681762205"><span class="hs-identifier hs-var">pp_thing</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-832"></a><span>        </span><span class="hs-identifier hs-var">hsep</span><span>   </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is bound at stage&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681762206"><span class="hs-identifier hs-var">bind_lvl</span></a><span class="hs-special">,</span><span>
</span><a name="line-833"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;but used at stage&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681762207"><span class="hs-identifier hs-var">use_lvl</span></a><span class="hs-special">]</span><span>
</span><a name="line-834"></a><span>
</span><a name="line-835"></a><span class="hs-identifier">stageRestrictionError</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761941"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-836"></a><a name="stageRestrictionError"><a href="TcEnv.html#stageRestrictionError"><span class="hs-identifier">stageRestrictionError</span></a></a><span> </span><a name="local-6989586621681762208"><a href="#local-6989586621681762208"><span class="hs-identifier">pp_thing</span></a></a><span>
</span><a name="line-837"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-838"></a><span>    </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;GHC stage restriction:&quot;</span><span>
</span><a name="line-839"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621681762208"><span class="hs-identifier hs-var">pp_thing</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is used in a top-level splice, quasi-quote, or annotation,&quot;</span><span>
</span><a name="line-840"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;and must be imported, not defined locally&quot;</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-841"></a><span>
</span><a name="line-842"></a><span class="hs-identifier">topIdLvl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ThLevel</span><span>
</span><a name="line-843"></a><span class="hs-comment">-- Globals may either be imported, or may be from an earlier &quot;chunk&quot;</span><span>
</span><a name="line-844"></a><span class="hs-comment">-- (separated by declaration splices) of this module.  The former</span><span>
</span><a name="line-845"></a><span class="hs-comment">--  *can* be used inside a top-level splice, but the latter cannot.</span><span>
</span><a name="line-846"></a><span class="hs-comment">-- Hence we give the former impLevel, but the latter topLevel</span><span>
</span><a name="line-847"></a><span class="hs-comment">-- E.g. this is bad:</span><span>
</span><a name="line-848"></a><span class="hs-comment">--      x = [| foo |]</span><span>
</span><a name="line-849"></a><span class="hs-comment">--      $( f x )</span><span>
</span><a name="line-850"></a><span class="hs-comment">-- By the time we are prcessing the $(f x), the binding for &quot;x&quot;</span><span>
</span><a name="line-851"></a><span class="hs-comment">-- will be in the global env, not the local one.</span><span>
</span><a name="line-852"></a><a name="topIdLvl"><a href="TcEnv.html#topIdLvl"><span class="hs-identifier">topIdLvl</span></a></a><span> </span><a name="local-6989586621681762209"><a href="#local-6989586621681762209"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isLocalId</span><span> </span><a href="#local-6989586621681762209"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">outerLevel</span><span>
</span><a name="line-853"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">impLevel</span><span>
</span><a name="line-854"></a><span>
</span><a name="line-855"></a><span class="hs-identifier">tcMetaTy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-856"></a><span class="hs-comment">-- Given the name of a Template Haskell data type,</span><span>
</span><a name="line-857"></a><span class="hs-comment">-- return the type</span><span>
</span><a name="line-858"></a><span class="hs-comment">-- E.g. given the name &quot;Expr&quot; return the type &quot;Expr&quot;</span><span>
</span><a name="line-859"></a><a name="tcMetaTy"><a href="TcEnv.html#tcMetaTy"><span class="hs-identifier">tcMetaTy</span></a></a><span> </span><a name="local-6989586621681762210"><a href="#local-6989586621681762210"><span class="hs-identifier">tc_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-860"></a><span>    </span><a name="local-6989586621681762211"><a href="#local-6989586621681762211"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><a href="#local-6989586621681762210"><span class="hs-identifier hs-var">tc_name</span></a><span>
</span><a name="line-861"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621681762211"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-862"></a><span>
</span><a name="line-863"></a><span class="hs-identifier">isBrackStage</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ThStage</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-864"></a><a name="isBrackStage"><a href="TcEnv.html#isBrackStage"><span class="hs-identifier">isBrackStage</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Brack</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-865"></a><span class="hs-identifier">isBrackStage</span><span> </span><a name="local-6989586621681762212"><a href="#local-6989586621681762212"><span class="hs-identifier">_other</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-866"></a><span>
</span><a name="line-867"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                 getDefaultTys
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-874"></a><span>
</span><a name="line-875"></a><span class="hs-identifier">tcGetDefaultTys</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- Default types</span><span>
</span><a name="line-876"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- True &lt;=&gt; Use overloaded strings</span><span>
</span><a name="line-877"></a><span>                         </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- True &lt;=&gt; Use extended defaulting rules</span><span>
</span><a name="line-878"></a><a name="tcGetDefaultTys"><a href="TcEnv.html#tcGetDefaultTys"><span class="hs-identifier">tcGetDefaultTys</span></a></a><span>
</span><a name="line-879"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681762215"><a href="#local-6989586621681762215"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-880"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681762216"><a href="#local-6989586621681762216"><span class="hs-identifier">ovl_strings</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">xopt</span><span> </span><span class="hs-identifier hs-var">LangExt.OverloadedStrings</span><span> </span><a href="#local-6989586621681762215"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-881"></a><span>              </span><a name="local-6989586621681762217"><a href="#local-6989586621681762217"><span class="hs-identifier">extended_defaults</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">xopt</span><span> </span><span class="hs-identifier hs-var">LangExt.ExtendedDefaultRules</span><span> </span><a href="#local-6989586621681762215"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-882"></a><span>                                        </span><span class="hs-comment">-- See also Trac #1974</span><span>
</span><a name="line-883"></a><span>              </span><a name="local-6989586621681762218"><a href="#local-6989586621681762218"><span class="hs-identifier">flags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681762216"><span class="hs-identifier hs-var">ovl_strings</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681762217"><span class="hs-identifier hs-var">extended_defaults</span></a><span class="hs-special">)</span><span>
</span><a name="line-884"></a><span>
</span><a name="line-885"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681762219"><a href="#local-6989586621681762219"><span class="hs-identifier">mb_defaults</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getDeclaredDefaultTys"><span class="hs-identifier hs-var">getDeclaredDefaultTys</span></a><span>
</span><a name="line-886"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681762219"><span class="hs-identifier hs-var">mb_defaults</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-887"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681762220"><a href="#local-6989586621681762220"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681762220"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681762218"><span class="hs-identifier hs-var">flags</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-888"></a><span>                                </span><span class="hs-comment">-- User-supplied defaults</span><span>
</span><a name="line-889"></a><span>           </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-890"></a><span>
</span><a name="line-891"></a><span>        </span><span class="hs-comment">-- No use-supplied default</span><span>
</span><a name="line-892"></a><span>        </span><span class="hs-comment">-- Use [Integer, Double], plus modifications</span><span>
</span><a name="line-893"></a><span>        </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681762221"><a href="#local-6989586621681762221"><span class="hs-identifier">integer_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcMetaTy"><span class="hs-identifier hs-var">tcMetaTy</span></a><span> </span><span class="hs-identifier hs-var">integerTyConName</span><span>
</span><a name="line-894"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681762222"><a href="#local-6989586621681762222"><span class="hs-identifier">list_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcMetaTy"><span class="hs-identifier hs-var">tcMetaTy</span></a><span> </span><span class="hs-identifier hs-var">listTyConName</span><span>
</span><a name="line-895"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="LoadIface.html#checkWiredInTyCon"><span class="hs-identifier hs-var">checkWiredInTyCon</span></a><span> </span><span class="hs-identifier hs-var">doubleTyCon</span><span>
</span><a name="line-896"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681762223"><a href="#local-6989586621681762223"><span class="hs-identifier">deflt_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681762213"><span class="hs-identifier hs-var">opt_deflt</span></a><span> </span><a href="#local-6989586621681762217"><span class="hs-identifier hs-var">extended_defaults</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">unitTy</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681762222"><span class="hs-identifier hs-var">list_ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-897"></a><span>                          </span><span class="hs-comment">-- Note [Extended defaults]</span><span>
</span><a name="line-898"></a><span>                          </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621681762221"><span class="hs-identifier hs-var">integer_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">doubleTy</span><span class="hs-special">]</span><span>
</span><a name="line-899"></a><span>                          </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681762213"><span class="hs-identifier hs-var">opt_deflt</span></a><span> </span><a href="#local-6989586621681762216"><span class="hs-identifier hs-var">ovl_strings</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">stringTy</span><span class="hs-special">]</span><span>
</span><a name="line-900"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681762223"><span class="hs-identifier hs-var">deflt_tys</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681762218"><span class="hs-identifier hs-var">flags</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-901"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-902"></a><span>    </span><a name="local-6989586621681762213"><a href="#local-6989586621681762213"><span class="hs-identifier">opt_deflt</span></a></a><span> </span><span class="hs-identifier hs-var">True</span><span>  </span><a name="local-6989586621681762214"><a href="#local-6989586621681762214"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681762214"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-903"></a><span>    </span><span class="hs-identifier">opt_deflt</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-904"></a><span>
</span><a name="line-905"></a><span class="hs-comment">{-
Note [Extended defaults]
~~~~~~~~~~~~~~~~~~~~~
In interative mode (or with -XExtendedDefaultRules) we add () as the first type we
try when defaulting.  This has very little real impact, except in the following case.
Consider:
        Text.Printf.printf &quot;hello&quot;
This has type (forall a. IO a); it prints &quot;hello&quot;, and returns 'undefined'.  We don't
want the GHCi repl loop to try to print that 'undefined'.  The neatest thing is to
default the 'a' to (), rather than to Integer (which is what would otherwise happen;
and then GHCi doesn't attempt to print the ().  So in interactive mode, we add
() to the list of defaulting types.  See Trac #1200.

Additionally, the list type [] is added as a default specialization for
Traversable and Foldable. As such the default default list now has types of
varying kinds, e.g. ([] :: * -&gt; *)  and (Integer :: *).

************************************************************************
*                                                                      *
\subsection{The InstInfo type}
*                                                                      *
************************************************************************

The InstInfo type summarises the information in an instance declaration

    instance c =&gt; k (t tvs) where b

It is used just for *local* instance decls (not ones from interface files).
But local instance decls includes
        - derived ones
        - generic ones
as well as explicit user written ones.
-}</span><span>
</span><a name="line-938"></a><span>
</span><a name="line-939"></a><span class="hs-keyword">data</span><span> </span><a name="InstInfo"><a href="TcEnv.html#InstInfo"><span class="hs-identifier">InstInfo</span></a></a><span> </span><a name="local-6989586621681761932"><a href="#local-6989586621681761932"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-940"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="InstInfo"><a href="TcEnv.html#InstInfo"><span class="hs-identifier">InstInfo</span></a></a><span>
</span><a name="line-941"></a><span>      </span><span class="hs-special">{</span><span> </span><a name="iSpec"><a href="TcEnv.html#iSpec"><span class="hs-identifier">iSpec</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ClsInst</span><span>          </span><span class="hs-comment">-- Includes the dfun id</span><span>
</span><a name="line-942"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="iBinds"><a href="TcEnv.html#iBinds"><span class="hs-identifier">iBinds</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="TcEnv.html#InstBindings"><span class="hs-identifier hs-type">InstBindings</span></a><span> </span><a href="#local-6989586621681761932"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-943"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-944"></a><span>
</span><a name="line-945"></a><span class="hs-identifier">iDFunId</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcEnv.html#InstInfo"><span class="hs-identifier hs-type">InstInfo</span></a><span> </span><a href="#local-6989586621681761940"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DFunId</span><span>
</span><a name="line-946"></a><a name="iDFunId"><a href="TcEnv.html#iDFunId"><span class="hs-identifier">iDFunId</span></a></a><span> </span><a name="local-6989586621681762224"><a href="#local-6989586621681762224"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">instanceDFunId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">iSpec</span><span> </span><a href="#local-6989586621681762224"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span>
</span><a name="line-947"></a><span>
</span><a name="line-948"></a><span class="hs-keyword">data</span><span> </span><a name="InstBindings"><a href="TcEnv.html#InstBindings"><span class="hs-identifier">InstBindings</span></a></a><span> </span><a name="local-6989586621681761931"><a href="#local-6989586621681761931"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-949"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="InstBindings"><a href="TcEnv.html#InstBindings"><span class="hs-identifier">InstBindings</span></a></a><span>
</span><a name="line-950"></a><span>      </span><span class="hs-special">{</span><span> </span><a name="ib_tyvars"><a href="TcEnv.html#ib_tyvars"><span class="hs-identifier">ib_tyvars</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- Names of the tyvars from the instance head</span><span>
</span><a name="line-951"></a><span>                               </span><span class="hs-comment">-- that are lexically in scope in the bindings</span><span>
</span><a name="line-952"></a><span>                               </span><span class="hs-comment">-- Must correspond 1-1 with the forall'd tyvars</span><span>
</span><a name="line-953"></a><span>                               </span><span class="hs-comment">-- of the dfun Id.  When typechecking, we are</span><span>
</span><a name="line-954"></a><span>                               </span><span class="hs-comment">-- going to extend the typechecker's envt with</span><span>
</span><a name="line-955"></a><span>                               </span><span class="hs-comment">--     ib_tyvars -&gt; dfun_forall_tyvars</span><span>
</span><a name="line-956"></a><span>
</span><a name="line-957"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="ib_binds"><a href="TcEnv.html#ib_binds"><span class="hs-identifier">ib_binds</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><a href="#local-6989586621681761931"><span class="hs-identifier hs-type">a</span></a><span>    </span><span class="hs-comment">-- Bindings for the instance methods</span><span>
</span><a name="line-958"></a><span>
</span><a name="line-959"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="ib_pragmas"><a href="TcEnv.html#ib_pragmas"><span class="hs-identifier">ib_pragmas</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LSig</span><span> </span><a href="#local-6989586621681761931"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- User pragmas recorded for generating</span><span>
</span><a name="line-960"></a><span>                                    </span><span class="hs-comment">-- specialised instances</span><span>
</span><a name="line-961"></a><span>
</span><a name="line-962"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="ib_extensions"><a href="TcEnv.html#ib_extensions"><span class="hs-identifier">ib_extensions</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LangExt.Extension</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- Any extra extensions that should</span><span>
</span><a name="line-963"></a><span>                                             </span><span class="hs-comment">-- be enabled when type-checking</span><span>
</span><a name="line-964"></a><span>                                             </span><span class="hs-comment">-- this instance; needed for</span><span>
</span><a name="line-965"></a><span>                                             </span><span class="hs-comment">-- GeneralizedNewtypeDeriving</span><span>
</span><a name="line-966"></a><span>
</span><a name="line-967"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="ib_derived"><a href="TcEnv.html#ib_derived"><span class="hs-identifier">ib_derived</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-968"></a><span>           </span><span class="hs-comment">-- True &lt;=&gt; This code was generated by GHC from a deriving clause</span><span>
</span><a name="line-969"></a><span>           </span><span class="hs-comment">--          or standalone deriving declaration</span><span>
</span><a name="line-970"></a><span>           </span><span class="hs-comment">--          Used only to improve error messages</span><span>
</span><a name="line-971"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-972"></a><span>
</span><a name="line-973"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OutputableBndrId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621681761933"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-974"></a><span>       </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><span class="hs-special">(</span><a href="TcEnv.html#InstInfo"><span class="hs-identifier hs-type">InstInfo</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621681761933"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-975"></a><span>    </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#pprInstInfoDetails"><span class="hs-identifier hs-var">pprInstInfoDetails</span></a><span>
</span><a name="line-976"></a><span>
</span><a name="line-977"></a><span class="hs-identifier">pprInstInfoDetails</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OutputableBndrId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621681761939"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-978"></a><span>                   </span><span class="hs-glyph">=&gt;</span><span> </span><a href="TcEnv.html#InstInfo"><span class="hs-identifier hs-type">InstInfo</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621681761939"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-979"></a><a name="pprInstInfoDetails"><a href="TcEnv.html#pprInstInfoDetails"><span class="hs-identifier">pprInstInfoDetails</span></a></a><span> </span><a name="local-6989586621681762225"><a href="#local-6989586621681762225"><span class="hs-identifier">info</span></a></a><span>
</span><a name="line-980"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprInstanceHdr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">iSpec</span><span> </span><a href="#local-6989586621681762225"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;where&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-981"></a><span>        </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681762226"><span class="hs-identifier hs-var">details</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">iBinds</span><span> </span><a href="#local-6989586621681762225"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-982"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-983"></a><span>    </span><a name="local-6989586621681762226"><a href="#local-6989586621681762226"><span class="hs-identifier">details</span></a></a><span> </span><span class="hs-special">(</span><a href="TcEnv.html#InstBindings"><span class="hs-identifier hs-var">InstBindings</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ib_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681762227"><a href="#local-6989586621681762227"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprLHsBinds</span><span> </span><a href="#local-6989586621681762227"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-984"></a><span>
</span><a name="line-985"></a><span class="hs-identifier">simpleInstInfoClsTy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcEnv.html#InstInfo"><span class="hs-identifier hs-type">InstInfo</span></a><span> </span><a href="#local-6989586621681761938"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Class</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span>
</span><a name="line-986"></a><a name="simpleInstInfoClsTy"><a href="TcEnv.html#simpleInstInfoClsTy"><span class="hs-identifier">simpleInstInfoClsTy</span></a></a><span> </span><a name="local-6989586621681762228"><a href="#local-6989586621681762228"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">instanceHead</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">iSpec</span><span> </span><a href="#local-6989586621681762228"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-987"></a><span>                           </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681762229"><a href="#local-6989586621681762229"><span class="hs-identifier">cls</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a name="local-6989586621681762230"><a href="#local-6989586621681762230"><span class="hs-identifier">ty</span></a></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681762229"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681762230"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-988"></a><span>                           </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;simpleInstInfoClsTy&quot;</span><span>
</span><a name="line-989"></a><span>
</span><a name="line-990"></a><span class="hs-identifier">simpleInstInfoTy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcEnv.html#InstInfo"><span class="hs-identifier hs-type">InstInfo</span></a><span> </span><a href="#local-6989586621681761937"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-991"></a><a name="simpleInstInfoTy"><a href="TcEnv.html#simpleInstInfoTy"><span class="hs-identifier">simpleInstInfoTy</span></a></a><span> </span><a name="local-6989586621681762231"><a href="#local-6989586621681762231"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-special">(</span><a href="TcEnv.html#simpleInstInfoClsTy"><span class="hs-identifier hs-var">simpleInstInfoClsTy</span></a><span> </span><a href="#local-6989586621681762231"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span>
</span><a name="line-992"></a><span>
</span><a name="line-993"></a><span class="hs-identifier">simpleInstInfoTyCon</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcEnv.html#InstInfo"><span class="hs-identifier hs-type">InstInfo</span></a><span> </span><a href="#local-6989586621681761936"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span>
</span><a name="line-994"></a><span>  </span><span class="hs-comment">-- Gets the type constructor for a simple instance declaration,</span><span>
</span><a name="line-995"></a><span>  </span><span class="hs-comment">-- i.e. one of the form       instance (...) =&gt; C (T a b c) where ...</span><span>
</span><a name="line-996"></a><a name="simpleInstInfoTyCon"><a href="TcEnv.html#simpleInstInfoTyCon"><span class="hs-identifier">simpleInstInfoTyCon</span></a></a><span> </span><a name="local-6989586621681762232"><a href="#local-6989586621681762232"><span class="hs-identifier">inst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcTyConAppTyCon</span><span> </span><span class="hs-special">(</span><a href="TcEnv.html#simpleInstInfoTy"><span class="hs-identifier hs-var">simpleInstInfoTy</span></a><span> </span><a href="#local-6989586621681762232"><span class="hs-identifier hs-var">inst</span></a><span class="hs-special">)</span><span>
</span><a name="line-997"></a><span>
</span><a name="line-998"></a><span class="hs-comment">-- | Make a name for the dict fun for an instance decl.  It's an *external*</span><span>
</span><a name="line-999"></a><span class="hs-comment">-- name, like other top-level names, and hence must be made with</span><span>
</span><a name="line-1000"></a><span class="hs-comment">-- newGlobalBinder.</span><span>
</span><a name="line-1001"></a><span class="hs-identifier">newDFunName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1002"></a><a name="newDFunName"><a href="TcEnv.html#newDFunName"><span class="hs-identifier">newDFunName</span></a></a><span> </span><a name="local-6989586621681762233"><a href="#local-6989586621681762233"><span class="hs-identifier">clas</span></a></a><span> </span><a name="local-6989586621681762234"><a href="#local-6989586621681762234"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-6989586621681762235"><a href="#local-6989586621681762235"><span class="hs-identifier">loc</span></a></a><span>
</span><a name="line-1003"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681762236"><a href="#local-6989586621681762236"><span class="hs-identifier">is_boot</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#tcIsHsBootOrSig"><span class="hs-identifier hs-var">tcIsHsBootOrSig</span></a><span>
</span><a name="line-1004"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681762237"><a href="#local-6989586621681762237"><span class="hs-identifier">mod</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-1005"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681762238"><a href="#local-6989586621681762238"><span class="hs-identifier">info_string</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">occNameString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOccName</span><span> </span><a href="#local-6989586621681762233"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1006"></a><span>                            </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">occNameString</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">getDFunTyKey</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681762234"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1007"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681762239"><a href="#local-6989586621681762239"><span class="hs-identifier">dfun_occ</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#chooseUniqueOccTc"><span class="hs-identifier hs-var">chooseUniqueOccTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkDFunOcc</span><span> </span><a href="#local-6989586621681762238"><span class="hs-identifier hs-var">info_string</span></a><span> </span><a href="#local-6989586621681762236"><span class="hs-identifier hs-var">is_boot</span></a><span class="hs-special">)</span><span>
</span><a name="line-1008"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="IfaceEnv.html#newGlobalBinder"><span class="hs-identifier hs-var">newGlobalBinder</span></a><span> </span><a href="#local-6989586621681762237"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621681762239"><span class="hs-identifier hs-var">dfun_occ</span></a><span> </span><a href="#local-6989586621681762235"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1009"></a><span>
</span><a name="line-1010"></a><span class="hs-comment">-- | Special case of 'newDFunName' to generate dict fun name for a single TyCon.</span><span>
</span><a name="line-1011"></a><span class="hs-identifier">newDFunName'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1012"></a><a name="newDFunName%27"><a href="TcEnv.html#newDFunName%27"><span class="hs-identifier">newDFunName'</span></a></a><span> </span><a name="local-6989586621681762240"><a href="#local-6989586621681762240"><span class="hs-identifier">clas</span></a></a><span> </span><a name="local-6989586621681762241"><a href="#local-6989586621681762241"><span class="hs-identifier">tycon</span></a></a><span>        </span><span class="hs-comment">-- Just a simple wrapper</span><span>
</span><a name="line-1013"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681762242"><a href="#local-6989586621681762242"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span>     </span><span class="hs-comment">-- The location of the instance decl,</span><span>
</span><a name="line-1014"></a><span>                                </span><span class="hs-comment">-- not of the tycon</span><span>
</span><a name="line-1015"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcEnv.html#newDFunName"><span class="hs-identifier hs-var">newDFunName</span></a><span> </span><a href="#local-6989586621681762240"><span class="hs-identifier hs-var">clas</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621681762241"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621681762242"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1016"></a><span>       </span><span class="hs-comment">-- The type passed to newDFunName is only used to generate</span><span>
</span><a name="line-1017"></a><span>       </span><span class="hs-comment">-- a suitable string; hence the empty type arg list</span><span>
</span><a name="line-1018"></a><span>
</span><a name="line-1019"></a><span class="hs-comment">{-
Make a name for the representation tycon of a family instance.  It's an
*external* name, like other top-level names, and hence must be made with
newGlobalBinder.
-}</span><span>
</span><a name="line-1024"></a><span>
</span><a name="line-1025"></a><span class="hs-identifier">newFamInstTyConName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1026"></a><a name="newFamInstTyConName"><a href="TcEnv.html#newFamInstTyConName"><span class="hs-identifier">newFamInstTyConName</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621681762243"><a href="#local-6989586621681762243"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621681762244"><a href="#local-6989586621681762244"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681762245"><a href="#local-6989586621681762245"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#mk_fam_inst_name"><span class="hs-identifier hs-var">mk_fam_inst_name</span></a><span> </span><span class="hs-identifier hs-var">id</span><span> </span><a href="#local-6989586621681762243"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621681762244"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621681762245"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">]</span><span>
</span><a name="line-1027"></a><span>
</span><a name="line-1028"></a><span class="hs-identifier">newFamInstAxiomName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1029"></a><a name="newFamInstAxiomName"><a href="TcEnv.html#newFamInstAxiomName"><span class="hs-identifier">newFamInstAxiomName</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621681762246"><a href="#local-6989586621681762246"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621681762247"><a href="#local-6989586621681762247"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681762248"><a href="#local-6989586621681762248"><span class="hs-identifier">branches</span></a></a><span>
</span><a name="line-1030"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#mk_fam_inst_name"><span class="hs-identifier hs-var">mk_fam_inst_name</span></a><span> </span><span class="hs-identifier hs-var">mkInstTyCoOcc</span><span> </span><a href="#local-6989586621681762246"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621681762247"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621681762248"><span class="hs-identifier hs-var">branches</span></a><span>
</span><a name="line-1031"></a><span>
</span><a name="line-1032"></a><span class="hs-identifier">mk_fam_inst_name</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OccName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OccName</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1033"></a><a name="mk_fam_inst_name"><a href="TcEnv.html#mk_fam_inst_name"><span class="hs-identifier">mk_fam_inst_name</span></a></a><span> </span><a name="local-6989586621681762249"><a href="#local-6989586621681762249"><span class="hs-identifier">adaptOcc</span></a></a><span> </span><a name="local-6989586621681762250"><a href="#local-6989586621681762250"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621681762251"><a href="#local-6989586621681762251"><span class="hs-identifier">tc_name</span></a></a><span> </span><a name="local-6989586621681762252"><a href="#local-6989586621681762252"><span class="hs-identifier">tyss</span></a></a><span>
</span><a name="line-1034"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681762254"><a href="#local-6989586621681762254"><span class="hs-identifier">mod</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-1035"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681762255"><a href="#local-6989586621681762255"><span class="hs-identifier">info_string</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">occNameString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOccName</span><span> </span><a href="#local-6989586621681762251"><span class="hs-identifier hs-var">tc_name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1036"></a><span>                            </span><span class="hs-identifier hs-var">intercalate</span><span> </span><span class="hs-string">&quot;|&quot;</span><span> </span><a href="#local-6989586621681762253"><span class="hs-identifier hs-var">ty_strings</span></a><span>
</span><a name="line-1037"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681762256"><a href="#local-6989586621681762256"><span class="hs-identifier">occ</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#chooseUniqueOccTc"><span class="hs-identifier hs-var">chooseUniqueOccTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkInstTyTcOcc</span><span> </span><a href="#local-6989586621681762255"><span class="hs-identifier hs-var">info_string</span></a><span class="hs-special">)</span><span>
</span><a name="line-1038"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="IfaceEnv.html#newGlobalBinder"><span class="hs-identifier hs-var">newGlobalBinder</span></a><span> </span><a href="#local-6989586621681762254"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681762249"><span class="hs-identifier hs-var">adaptOcc</span></a><span> </span><a href="#local-6989586621681762256"><span class="hs-identifier hs-var">occ</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681762250"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1039"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1040"></a><span>    </span><a name="local-6989586621681762253"><a href="#local-6989586621681762253"><span class="hs-identifier">ty_strings</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">occNameString</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">getDFunTyKey</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681762252"><span class="hs-identifier hs-var">tyss</span></a><span>
</span><a name="line-1041"></a><span>
</span><a name="line-1042"></a><span class="hs-comment">{-
Stable names used for foreign exports and annotations.
For stable names, the name must be unique (see #1533).  If the
same thing has several stable Ids based on it, the
top-level bindings generated must not have the same name.
Hence we create an External name (doesn't change), and we
append a Unique to the string right here.
-}</span><span>
</span><a name="line-1050"></a><span>
</span><a name="line-1051"></a><span class="hs-identifier">mkStableIdFromString</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OccName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OccName</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcId</span><span>
</span><a name="line-1052"></a><a name="mkStableIdFromString"><a href="TcEnv.html#mkStableIdFromString"><span class="hs-identifier">mkStableIdFromString</span></a></a><span> </span><a name="local-6989586621681762257"><a href="#local-6989586621681762257"><span class="hs-identifier">str</span></a></a><span> </span><a name="local-6989586621681762258"><a href="#local-6989586621681762258"><span class="hs-identifier">sig_ty</span></a></a><span> </span><a name="local-6989586621681762259"><a href="#local-6989586621681762259"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621681762260"><a href="#local-6989586621681762260"><span class="hs-identifier">occ_wrapper</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1053"></a><span>    </span><a name="local-6989586621681762261"><a href="#local-6989586621681762261"><span class="hs-identifier">uniq</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a><span>
</span><a name="line-1054"></a><span>    </span><a name="local-6989586621681762262"><a href="#local-6989586621681762262"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-1055"></a><span>    </span><a name="local-6989586621681762263"><a href="#local-6989586621681762263"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#mkWrapperName"><span class="hs-identifier hs-var">mkWrapperName</span></a><span> </span><span class="hs-string">&quot;stable&quot;</span><span> </span><a href="#local-6989586621681762257"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-1056"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681762264"><a href="#local-6989586621681762264"><span class="hs-identifier">occ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkVarOccFS</span><span> </span><a href="#local-6989586621681762263"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OccName</span><span>
</span><a name="line-1057"></a><span>        </span><a name="local-6989586621681762265"><a href="#local-6989586621681762265"><span class="hs-identifier">gnm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkExternalName</span><span> </span><a href="#local-6989586621681762261"><span class="hs-identifier hs-var">uniq</span></a><span> </span><a href="#local-6989586621681762262"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681762260"><span class="hs-identifier hs-var">occ_wrapper</span></a><span> </span><a href="#local-6989586621681762264"><span class="hs-identifier hs-var">occ</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681762259"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1058"></a><span>        </span><a name="local-6989586621681762266"><a href="#local-6989586621681762266"><span class="hs-identifier">id</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkExportedVanillaId</span><span> </span><a href="#local-6989586621681762265"><span class="hs-identifier hs-var">gnm</span></a><span> </span><a href="#local-6989586621681762258"><span class="hs-identifier hs-var">sig_ty</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-1059"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681762266"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-1060"></a><span>
</span><a name="line-1061"></a><span class="hs-identifier">mkStableIdFromName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OccName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OccName</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcId</span><span>
</span><a name="line-1062"></a><a name="mkStableIdFromName"><a href="TcEnv.html#mkStableIdFromName"><span class="hs-identifier">mkStableIdFromName</span></a></a><span> </span><a name="local-6989586621681762267"><a href="#local-6989586621681762267"><span class="hs-identifier">nm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#mkStableIdFromString"><span class="hs-identifier hs-var">mkStableIdFromString</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOccString</span><span> </span><a href="#local-6989586621681762267"><span class="hs-identifier hs-var">nm</span></a><span class="hs-special">)</span><span>
</span><a name="line-1063"></a><span>
</span><a name="line-1064"></a><span class="hs-identifier">mkWrapperName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621681761935"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HasDynFlags</span><span> </span><a href="#local-6989586621681761935"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HasModule</span><span> </span><a href="#local-6989586621681761935"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-1065"></a><span>              </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681761935"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">FastString</span><span>
</span><a name="line-1066"></a><a name="mkWrapperName"><a href="TcEnv.html#mkWrapperName"><span class="hs-identifier">mkWrapperName</span></a></a><span> </span><a name="local-6989586621681762268"><a href="#local-6989586621681762268"><span class="hs-identifier">what</span></a></a><span> </span><a name="local-6989586621681762269"><a href="#local-6989586621681762269"><span class="hs-identifier">nameBase</span></a></a><span>
</span><a name="line-1067"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681762270"><a href="#local-6989586621681762270"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1068"></a><span>         </span><a name="local-6989586621681762271"><a href="#local-6989586621681762271"><span class="hs-identifier">thisMod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-1069"></a><span>         </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- Note [Generating fresh names for ccall wrapper]</span><span>
</span><a name="line-1070"></a><span>             </span><a name="local-6989586621681762272"><a href="#local-6989586621681762272"><span class="hs-identifier">wrapperRef</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">nextWrapperNum</span><span> </span><a href="#local-6989586621681762270"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1071"></a><span>             </span><a name="local-6989586621681762273"><a href="#local-6989586621681762273"><span class="hs-identifier">pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unitIdString</span><span>  </span><span class="hs-special">(</span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621681762271"><span class="hs-identifier hs-var">thisMod</span></a><span class="hs-special">)</span><span>
</span><a name="line-1072"></a><span>             </span><a name="local-6989586621681762274"><a href="#local-6989586621681762274"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">moduleNameString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span>      </span><a href="#local-6989586621681762271"><span class="hs-identifier hs-var">thisMod</span></a><span class="hs-special">)</span><span>
</span><a name="line-1073"></a><span>         </span><a name="local-6989586621681762278"><a href="#local-6989586621681762278"><span class="hs-identifier">wrapperNum</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">atomicModifyIORef'</span><span> </span><a href="#local-6989586621681762272"><span class="hs-identifier hs-var">wrapperRef</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681762275"><a href="#local-6989586621681762275"><span class="hs-identifier">mod_env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1074"></a><span>             </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681762276"><a href="#local-6989586621681762276"><span class="hs-identifier">num</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupWithDefaultModuleEnv</span><span> </span><a href="#local-6989586621681762275"><span class="hs-identifier hs-var">mod_env</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621681762271"><span class="hs-identifier hs-var">thisMod</span></a><span>
</span><a name="line-1075"></a><span>                 </span><a name="local-6989586621681762277"><a href="#local-6989586621681762277"><span class="hs-identifier">mod_env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendModuleEnv</span><span> </span><a href="#local-6989586621681762275"><span class="hs-identifier hs-var">mod_env</span></a><span> </span><a href="#local-6989586621681762271"><span class="hs-identifier hs-var">thisMod</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681762276"><span class="hs-identifier hs-var">num</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-1076"></a><span>             </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681762277"><span class="hs-identifier hs-var">mod_env'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681762276"><span class="hs-identifier hs-var">num</span></a><span class="hs-special">)</span><span>
</span><a name="line-1077"></a><span>         </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681762279"><a href="#local-6989586621681762279"><span class="hs-identifier">components</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621681762268"><span class="hs-identifier hs-var">what</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681762278"><span class="hs-identifier hs-var">wrapperNum</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681762273"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681762274"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681762269"><span class="hs-identifier hs-var">nameBase</span></a><span class="hs-special">]</span><span>
</span><a name="line-1078"></a><span>         </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkFastString</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">zEncodeString</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">intercalate</span><span> </span><span class="hs-string">&quot;:&quot;</span><span> </span><a href="#local-6989586621681762279"><span class="hs-identifier hs-var">components</span></a><span>
</span><a name="line-1079"></a><span>
</span><a name="line-1080"></a><span class="hs-comment">{-
Note [Generating fresh names for FFI wrappers]

We used to use a unique, rather than nextWrapperNum, to distinguish
between FFI wrapper functions. However, the wrapper names that we
generate are external names. This means that if a call to them ends up
in an unfolding, then we can't alpha-rename them, and thus if the
unique randomly changes from one compile to another then we get a
spurious ABI change (#4012).

The wrapper counter has to be per-module, not global, so that the number we end
up using is not dependent on the modules compiled before the current one.
-}</span><span>
</span><a name="line-1093"></a><span>
</span><a name="line-1094"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Errors}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1101"></a><span>
</span><a name="line-1102"></a><span class="hs-identifier">pprBinders</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1103"></a><span class="hs-comment">-- Used in error messages</span><span>
</span><a name="line-1104"></a><span class="hs-comment">-- Use quotes for a single one; they look a bit &quot;busy&quot; for several</span><span>
</span><a name="line-1105"></a><a name="pprBinders"><a href="TcEnv.html#pprBinders"><span class="hs-identifier">pprBinders</span></a></a><span> </span><span class="hs-special">[</span><a name="local-6989586621681762280"><a href="#local-6989586621681762280"><span class="hs-identifier">bndr</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681762280"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1106"></a><span class="hs-identifier">pprBinders</span><span> </span><a name="local-6989586621681762281"><a href="#local-6989586621681762281"><span class="hs-identifier">bndrs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprWithCommas</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681762281"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-1107"></a><span>
</span><a name="line-1108"></a><span class="hs-identifier">notFound</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TyThing</span><span>
</span><a name="line-1109"></a><a name="notFound"><a href="TcEnv.html#notFound"><span class="hs-identifier">notFound</span></a></a><span> </span><a name="local-6989586621681762282"><a href="#local-6989586621681762282"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-1110"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681762283"><a href="#local-6989586621681762283"><span class="hs-identifier">lcl_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span>
</span><a name="line-1111"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681762284"><a href="#local-6989586621681762284"><span class="hs-identifier">stage</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcl_th_ctxt</span><span> </span><a href="#local-6989586621681762283"><span class="hs-identifier hs-var">lcl_env</span></a><span>
</span><a name="line-1112"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681762284"><span class="hs-identifier hs-var">stage</span></a><span> </span><span class="hs-keyword">of</span><span>   </span><span class="hs-comment">-- See Note [Out of scope might be a staging error]</span><span>
</span><a name="line-1113"></a><span>           </span><span class="hs-identifier hs-var">Splice</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>
</span><a name="line-1114"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isUnboundName</span><span> </span><a href="#local-6989586621681762282"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">failM</span><span>  </span><span class="hs-comment">-- If the name really isn't in scope</span><span>
</span><a name="line-1115"></a><span>                                            </span><span class="hs-comment">-- don't report it again (Trac #11941)</span><span>
</span><a name="line-1116"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcEnv.html#stageRestrictionError"><span class="hs-identifier hs-var">stageRestrictionError</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681762282"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1117"></a><span>           </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1118"></a><span>                </span><span class="hs-identifier hs-var">vcat</span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;GHC internal error:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681762282"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1119"></a><span>                     </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is not in scope during type checking, but it passed the renamer&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-1120"></a><span>                     </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;tcl_env of environment:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcl_env</span><span> </span><a href="#local-6989586621681762283"><span class="hs-identifier hs-var">lcl_env</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1121"></a><span>                       </span><span class="hs-comment">-- Take care: printing the whole gbl env can</span><span>
</span><a name="line-1122"></a><span>                       </span><span class="hs-comment">-- cause an infinite loop, in the case where we</span><span>
</span><a name="line-1123"></a><span>                       </span><span class="hs-comment">-- are in the middle of a recursive TyCon/Class group;</span><span>
</span><a name="line-1124"></a><span>                       </span><span class="hs-comment">-- so let's just not print it!  Getting a loop here is</span><span>
</span><a name="line-1125"></a><span>                       </span><span class="hs-comment">-- very unhelpful, because it hides one compiler bug with another</span><span>
</span><a name="line-1126"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-1127"></a><span>
</span><a name="line-1128"></a><span class="hs-identifier">wrongThingErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcTyThing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681761934"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1129"></a><span class="hs-comment">-- It's important that this only calls pprTcTyThingCategory, which in</span><span>
</span><a name="line-1130"></a><span class="hs-comment">-- turn does not look at the details of the TcTyThing.</span><span>
</span><a name="line-1131"></a><span class="hs-comment">-- See Note [Placeholder PatSyn kinds] in TcBinds</span><span>
</span><a name="line-1132"></a><a name="wrongThingErr"><a href="TcEnv.html#wrongThingErr"><span class="hs-identifier">wrongThingErr</span></a></a><span> </span><a name="local-6989586621681762285"><a href="#local-6989586621681762285"><span class="hs-identifier">expected</span></a></a><span> </span><a name="local-6989586621681762286"><a href="#local-6989586621681762286"><span class="hs-identifier">thing</span></a></a><span> </span><a name="local-6989586621681762287"><a href="#local-6989586621681762287"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-1133"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprTcTyThingCategory</span><span> </span><a href="#local-6989586621681762286"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681762287"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1134"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;used as a&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621681762285"><span class="hs-identifier hs-var">expected</span></a><span class="hs-special">)</span><span>
</span><a name="line-1135"></a><span>
</span><a name="line-1136"></a><span class="hs-comment">{- Note [Out of scope might be a staging error]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
  x = 3
  data T = MkT $(foo x)

where 'foo' is imported from somewhere.

This is really a staging error, because we can't run code involving 'x'.
But in fact the type checker processes types first, so 'x' won't even be
in the type envt when we look for it in $(foo x).  So inside splices we
report something missing from the type env as a staging error.
See Trac #5752 and #5795.
-}</span><span>
</span><a name="line-1150"></a></pre></body></html>