<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow, 1994-2006


Core pass to saturate constructors and PrimOps
-}</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE BangPatterns, CPP, MultiWayIf #-}</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">CorePrep</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-11"></a><span>      </span><a href="CorePrep.html#corePrepPgm"><span class="hs-identifier hs-var">corePrepPgm</span></a><span class="hs-special">,</span><span> </span><a href="CorePrep.html#corePrepExpr"><span class="hs-identifier hs-var">corePrepExpr</span></a><span class="hs-special">,</span><span> </span><a href="CorePrep.html#cvtLitInteger"><span class="hs-identifier hs-var">cvtLitInteger</span></a><span class="hs-special">,</span><span> </span><a href="CorePrep.html#cvtLitNatural"><span class="hs-identifier hs-var">cvtLitNatural</span></a><span class="hs-special">,</span><span>
</span><a name="line-12"></a><span>      </span><a href="CorePrep.html#lookupMkIntegerName"><span class="hs-identifier hs-var">lookupMkIntegerName</span></a><span class="hs-special">,</span><span> </span><a href="CorePrep.html#lookupIntegerSDataConName"><span class="hs-identifier hs-var">lookupIntegerSDataConName</span></a><span class="hs-special">,</span><span>
</span><a name="line-13"></a><span>      </span><a href="CorePrep.html#lookupMkNaturalName"><span class="hs-identifier hs-var">lookupMkNaturalName</span></a><span class="hs-special">,</span><span> </span><a href="CorePrep.html#lookupNaturalSDataConName"><span class="hs-identifier hs-var">lookupNaturalSDataConName</span></a><span>
</span><a name="line-14"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">OccurAnal</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MkId</span><span>             </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">realWorldPrimId</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreUtils</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreArity</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreFVs</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreMonad</span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">CoreToDo</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="CoreLint.html"><span class="hs-identifier">CoreLint</span></a><span>         </span><span class="hs-special">(</span><span> </span><a href="CoreLint.html#endPassIO"><span class="hs-identifier hs-var">endPassIO</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreSyn</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreSubst</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MkCore</span><span> </span><span class="hs-keyword">hiding</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">FloatBind</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- We use our own FloatBind here</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Literal</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Coercion</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="TcEnv.html"><span class="hs-identifier">TcEnv</span></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Demand</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Var</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarSet</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarEnv</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">IdInfo</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysWiredIn</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSupply</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">OrdList</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Pair</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Platform</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Config</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>             </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">NamedThing</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nameSrcSpan</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>           </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">realSrcLocSpan</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkRealSrcLoc</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Bits</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MonadUtils</span><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mapAccumLM</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CostCentre</span><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">CostCentre</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ccFromThisModule</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">S</span><span>
</span><a name="line-67"></a><span>
</span><a name="line-68"></a><span class="hs-comment">{-
-- ---------------------------------------------------------------------------
-- Note [CorePrep Overview]
-- ---------------------------------------------------------------------------

The goal of this pass is to prepare for code generation.

1.  Saturate constructor and primop applications.

2.  Convert to A-normal form; that is, function arguments
    are always variables.

    * Use case for strict arguments:
        f E ==&gt; case E of x -&gt; f x
        (where f is strict)

    * Use let for non-trivial lazy arguments
        f E ==&gt; let x = E in f x
        (were f is lazy and x is non-trivial)

3.  Similarly, convert any unboxed lets into cases.
    [I'm experimenting with leaving 'ok-for-speculation'
     rhss in let-form right up to this point.]

4.  Ensure that *value* lambdas only occur as the RHS of a binding
    (The code generator can't deal with anything else.)
    Type lambdas are ok, however, because the code gen discards them.

5.  [Not any more; nuked Jun 2002] Do the seq/par munging.

6.  Clone all local Ids.
    This means that all such Ids are unique, rather than the
    weaker guarantee of no clashes which the simplifier provides.
    And that is what the code generator needs.

    We don't clone TyVars or CoVars. The code gen doesn't need that,
    and doing so would be tiresome because then we'd need
    to substitute in types and coercions.

7.  Give each dynamic CCall occurrence a fresh unique; this is
    rather like the cloning step above.

8.  Inject bindings for the &quot;implicit&quot; Ids:
        * Constructor wrappers
        * Constructor workers
    We want curried definitions for all of these in case they
    aren't inlined by some caller.

9.  Replace (lazy e) by e.  See Note [lazyId magic] in MkId.hs
    Also replace (noinline e) by e.

10. Convert (LitInteger i t) into the core representation
    for the Integer i. Normally this uses mkInteger, but if
    we are using the integer-gmp implementation then there is a
    special case where we use the S# constructor for Integers that
    are in the range of Int.

11. Same for LitNatural.

12. Uphold tick consistency while doing this: We move ticks out of
    (non-type) applications where we can, and make sure that we
    annotate according to scoping rules when floating.

13. Collect cost centres (including cost centres in unfoldings) if we're in
    profiling mode. We have to do this here beucase we won't have unfoldings
    after this pass (see `zapUnfolding` and Note [Drop unfoldings and rules].

This is all done modulo type applications and abstractions, so that
when type erasure is done for conversion to STG, we don't end up with
any trivial or useless bindings.


Note [CorePrep invariants]
~~~~~~~~~~~~~~~~~~~~~~~~~~
Here is the syntax of the Core produced by CorePrep:

    Trivial expressions
       arg ::= lit |  var
              | arg ty  |  /\a. arg
              | truv co  |  /\c. arg  |  arg |&gt; co

    Applications
       app ::= lit  |  var  |  app arg  |  app ty  | app co | app |&gt; co

    Expressions
       body ::= app
              | let(rec) x = rhs in body     -- Boxed only
              | case body of pat -&gt; body
              | /\a. body | /\c. body
              | body |&gt; co

    Right hand sides (only place where value lambdas can occur)
       rhs ::= /\a.rhs  |  \x.rhs  |  body

We define a synonym for each of these non-terminals.  Functions
with the corresponding name produce a result in that syntax.
-}</span><span>
</span><a name="line-165"></a><span>
</span><a name="line-166"></a><span class="hs-keyword">type</span><span> </span><a name="CpeArg"><a href="CorePrep.html#CpeArg"><span class="hs-identifier">CpeArg</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>    </span><span class="hs-comment">-- Non-terminal 'arg'</span><span>
</span><a name="line-167"></a><span class="hs-keyword">type</span><span> </span><a name="CpeApp"><a href="CorePrep.html#CpeApp"><span class="hs-identifier">CpeApp</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>    </span><span class="hs-comment">-- Non-terminal 'app'</span><span>
</span><a name="line-168"></a><span class="hs-keyword">type</span><span> </span><a name="CpeBody"><a href="CorePrep.html#CpeBody"><span class="hs-identifier">CpeBody</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>    </span><span class="hs-comment">-- Non-terminal 'body'</span><span>
</span><a name="line-169"></a><span class="hs-keyword">type</span><span> </span><a name="CpeRhs"><a href="CorePrep.html#CpeRhs"><span class="hs-identifier">CpeRhs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>    </span><span class="hs-comment">-- Non-terminal 'rhs'</span><span>
</span><a name="line-170"></a><span>
</span><a name="line-171"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Top level stuff
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-178"></a><span>
</span><a name="line-179"></a><span class="hs-identifier">corePrepPgm</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModLocation</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyCon</span><span class="hs-special">]</span><span>
</span><a name="line-180"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CoreProgram</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">S.Set</span><span> </span><span class="hs-identifier hs-type">CostCentre</span><span class="hs-special">)</span><span>
</span><a name="line-181"></a><a name="corePrepPgm"><a href="CorePrep.html#corePrepPgm"><span class="hs-identifier">corePrepPgm</span></a></a><span> </span><a name="local-6989586621682027185"><a href="#local-6989586621682027185"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682027186"><a href="#local-6989586621682027186"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621682027187"><a href="#local-6989586621682027187"><span class="hs-identifier">mod_loc</span></a></a><span> </span><a name="local-6989586621682027188"><a href="#local-6989586621682027188"><span class="hs-identifier">binds</span></a></a><span> </span><a name="local-6989586621682027189"><a href="#local-6989586621682027189"><span class="hs-identifier">data_tycons</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-182"></a><span>    </span><span class="hs-identifier hs-var">withTiming</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621682027190"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-183"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;CorePrep&quot;</span><span class="hs-operator hs-var">&lt;+&gt;</span><span class="hs-identifier hs-var">brackets</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682027186"><span class="hs-identifier hs-var">this_mod</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-184"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-185"></a><span>    </span><a name="local-6989586621682027191"><a href="#local-6989586621682027191"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mkSplitUniqSupply</span><span> </span><span class="hs-char">'s'</span><span>
</span><a name="line-186"></a><span>    </span><a name="local-6989586621682027192"><a href="#local-6989586621682027192"><span class="hs-identifier">initialCorePrepEnv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#mkInitialCorePrepEnv"><span class="hs-identifier hs-var">mkInitialCorePrepEnv</span></a><span> </span><a href="#local-6989586621682027190"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682027185"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682027193"><a href="#local-6989586621682027193"><span class="hs-identifier">cost_centres</span></a></a><span>
</span><a name="line-189"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">WayProf</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">ways</span><span> </span><a href="#local-6989586621682027190"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-190"></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#collectCostCentres"><span class="hs-identifier hs-var">collectCostCentres</span></a><span> </span><a href="#local-6989586621682027186"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621682027188"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-191"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-192"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S.empty</span><span>
</span><a name="line-193"></a><span>
</span><a name="line-194"></a><span>        </span><a name="local-6989586621682027194"><a href="#local-6989586621682027194"><span class="hs-identifier">implicit_binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#mkDataConWorkers"><span class="hs-identifier hs-var">mkDataConWorkers</span></a><span> </span><a href="#local-6989586621682027190"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682027187"><span class="hs-identifier hs-var">mod_loc</span></a><span> </span><a href="#local-6989586621682027189"><span class="hs-identifier hs-var">data_tycons</span></a><span>
</span><a name="line-195"></a><span>            </span><span class="hs-comment">-- NB: we must feed mkImplicitBinds through corePrep too</span><span>
</span><a name="line-196"></a><span>            </span><span class="hs-comment">-- so that they are suitably cloned and eta-expanded</span><span>
</span><a name="line-197"></a><span>
</span><a name="line-198"></a><span>        </span><a name="local-6989586621682027195"><a href="#local-6989586621682027195"><span class="hs-identifier">binds_out</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">initUs_</span><span> </span><a href="#local-6989586621682027191"><span class="hs-identifier hs-var">us</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-199"></a><span>                      </span><a name="local-6989586621682027196"><a href="#local-6989586621682027196"><span class="hs-identifier">floats1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#corePrepTopBinds"><span class="hs-identifier hs-var">corePrepTopBinds</span></a><span> </span><a href="#local-6989586621682027192"><span class="hs-identifier hs-var">initialCorePrepEnv</span></a><span> </span><a href="#local-6989586621682027188"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-200"></a><span>                      </span><a name="local-6989586621682027197"><a href="#local-6989586621682027197"><span class="hs-identifier">floats2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#corePrepTopBinds"><span class="hs-identifier hs-var">corePrepTopBinds</span></a><span> </span><a href="#local-6989586621682027192"><span class="hs-identifier hs-var">initialCorePrepEnv</span></a><span> </span><a href="#local-6989586621682027194"><span class="hs-identifier hs-var">implicit_binds</span></a><span>
</span><a name="line-201"></a><span>                      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#deFloatTop"><span class="hs-identifier hs-var">deFloatTop</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027196"><span class="hs-identifier hs-var">floats1</span></a><span> </span><span class="hs-special">`</span><a href="CorePrep.html#appendFloats"><span class="hs-identifier hs-var">appendFloats</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682027197"><span class="hs-identifier hs-var">floats2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-202"></a><span>
</span><a name="line-203"></a><span>    </span><a href="CoreLint.html#endPassIO"><span class="hs-identifier hs-var">endPassIO</span></a><span> </span><a href="#local-6989586621682027185"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-identifier hs-var">alwaysQualify</span><span> </span><span class="hs-identifier hs-var">CorePrep</span><span> </span><a href="#local-6989586621682027195"><span class="hs-identifier hs-var">binds_out</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-204"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027195"><span class="hs-identifier hs-var">binds_out</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027193"><span class="hs-identifier hs-var">cost_centres</span></a><span class="hs-special">)</span><span>
</span><a name="line-205"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-206"></a><span>    </span><a name="local-6989586621682027190"><a href="#local-6989586621682027190"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682027185"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-207"></a><span>
</span><a name="line-208"></a><span class="hs-identifier">corePrepExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-209"></a><a name="corePrepExpr"><a href="CorePrep.html#corePrepExpr"><span class="hs-identifier">corePrepExpr</span></a></a><span> </span><a name="local-6989586621682027198"><a href="#local-6989586621682027198"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682027199"><a href="#local-6989586621682027199"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682027200"><a href="#local-6989586621682027200"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-210"></a><span>    </span><span class="hs-identifier hs-var">withTiming</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621682027198"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;CorePrep [expr]&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-211"></a><span>    </span><a name="local-6989586621682027201"><a href="#local-6989586621682027201"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mkSplitUniqSupply</span><span> </span><span class="hs-char">'s'</span><span>
</span><a name="line-212"></a><span>    </span><a name="local-6989586621682027202"><a href="#local-6989586621682027202"><span class="hs-identifier">initialCorePrepEnv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#mkInitialCorePrepEnv"><span class="hs-identifier hs-var">mkInitialCorePrepEnv</span></a><span> </span><a href="#local-6989586621682027198"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682027199"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-213"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682027203"><a href="#local-6989586621682027203"><span class="hs-identifier">new_expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">initUs_</span><span> </span><a href="#local-6989586621682027201"><span class="hs-identifier hs-var">us</span></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#cpeBodyNF"><span class="hs-identifier hs-var">cpeBodyNF</span></a><span> </span><a href="#local-6989586621682027202"><span class="hs-identifier hs-var">initialCorePrepEnv</span></a><span> </span><a href="#local-6989586621682027200"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-214"></a><span>    </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621682027198"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_prep</span><span> </span><span class="hs-string">&quot;CorePrep&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682027203"><span class="hs-identifier hs-var">new_expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-215"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682027203"><span class="hs-identifier hs-var">new_expr</span></a><span>
</span><a name="line-216"></a><span>
</span><a name="line-217"></a><span class="hs-identifier">corePrepTopBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CorePrep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreBind</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span>
</span><a name="line-218"></a><span class="hs-comment">-- Note [Floating out of top level bindings]</span><span>
</span><a name="line-219"></a><a name="corePrepTopBinds"><a href="CorePrep.html#corePrepTopBinds"><span class="hs-identifier">corePrepTopBinds</span></a></a><span> </span><a name="local-6989586621682027204"><a href="#local-6989586621682027204"><span class="hs-identifier">initialCorePrepEnv</span></a></a><span> </span><a name="local-6989586621682027205"><a href="#local-6989586621682027205"><span class="hs-identifier">binds</span></a></a><span>
</span><a name="line-220"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027206"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682027204"><span class="hs-identifier hs-var">initialCorePrepEnv</span></a><span> </span><a href="#local-6989586621682027205"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-221"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-222"></a><span>    </span><a name="local-6989586621682027206"><a href="#local-6989586621682027206"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-special">[</span><span class="hs-special">]</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="CorePrep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a><span>
</span><a name="line-223"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682027207"><a href="#local-6989586621682027207"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682027208"><a href="#local-6989586621682027208"><span class="hs-identifier">bind</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682027209"><a href="#local-6989586621682027209"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027210"><a href="#local-6989586621682027210"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027211"><a href="#local-6989586621682027211"><span class="hs-identifier">floats</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027212"><a href="#local-6989586621682027212"><span class="hs-identifier">maybe_new_bind</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-224"></a><span>                                 </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#cpeBind"><span class="hs-identifier hs-var">cpeBind</span></a><span> </span><span class="hs-identifier hs-var">TopLevel</span><span> </span><a href="#local-6989586621682027207"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027208"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-225"></a><span>                               </span><span class="hs-identifier">MASSERT</span><span class="hs-special">(</span><span class="hs-identifier">isNothing</span><span> </span><span class="hs-identifier">maybe_new_bind</span><span class="hs-special">)</span><span>
</span><a name="line-226"></a><span>                                 </span><span class="hs-comment">-- Only join points get returned this way by</span><span>
</span><a name="line-227"></a><span>                                 </span><span class="hs-comment">-- cpeBind, and no join point may float to top</span><span>
</span><a name="line-228"></a><span>                               </span><a name="local-6989586621682027213"><a href="#local-6989586621682027213"><span class="hs-identifier">floatss</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682027206"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682027210"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621682027209"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-229"></a><span>                               </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027211"><span class="hs-identifier hs-var">floats</span></a><span> </span><span class="hs-special">`</span><a href="CorePrep.html#appendFloats"><span class="hs-identifier hs-var">appendFloats</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682027213"><span class="hs-identifier hs-var">floatss</span></a><span class="hs-special">)</span><span>
</span><a name="line-230"></a><span>
</span><a name="line-231"></a><span class="hs-identifier">mkDataConWorkers</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModLocation</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyCon</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreBind</span><span class="hs-special">]</span><span>
</span><a name="line-232"></a><span class="hs-comment">-- See Note [Data constructor workers]</span><span>
</span><a name="line-233"></a><span class="hs-comment">-- c.f. Note [Injecting implicit bindings] in TidyPgm</span><span>
</span><a name="line-234"></a><a name="mkDataConWorkers"><a href="CorePrep.html#mkDataConWorkers"><span class="hs-identifier">mkDataConWorkers</span></a></a><span> </span><a name="local-6989586621682027214"><a href="#local-6989586621682027214"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682027215"><a href="#local-6989586621682027215"><span class="hs-identifier">mod_loc</span></a></a><span> </span><a name="local-6989586621682027216"><a href="#local-6989586621682027216"><span class="hs-identifier">data_tycons</span></a></a><span>
</span><a name="line-235"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621682027227"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027217"><span class="hs-identifier hs-var">tick_it</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621682027226"><span class="hs-identifier hs-var">data_con</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621682027227"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-236"></a><span>                                </span><span class="hs-comment">-- The ice is thin here, but it works</span><span>
</span><a name="line-237"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621682027225"><a href="#local-6989586621682027225"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682027216"><span class="hs-identifier hs-var">data_tycons</span></a><span class="hs-special">,</span><span>     </span><span class="hs-comment">-- CorePrep will eta-expand it</span><span>
</span><a name="line-238"></a><span>      </span><a name="local-6989586621682027226"><a href="#local-6989586621682027226"><span class="hs-identifier">data_con</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tyConDataCons</span><span> </span><a href="#local-6989586621682027225"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">,</span><span>
</span><a name="line-239"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682027227"><a href="#local-6989586621682027227"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConWorkId</span><span> </span><a href="#local-6989586621682027226"><span class="hs-identifier hs-var">data_con</span></a><span>
</span><a name="line-240"></a><span>    </span><span class="hs-special">]</span><span>
</span><a name="line-241"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-242"></a><span>   </span><span class="hs-comment">-- If we want to generate debug info, we put a source note on the</span><span>
</span><a name="line-243"></a><span>   </span><span class="hs-comment">-- worker. This is useful, especially for heap profiling.</span><span>
</span><a name="line-244"></a><span>   </span><a name="local-6989586621682027217"><a href="#local-6989586621682027217"><span class="hs-identifier">tick_it</span></a></a><span> </span><a name="local-6989586621682027218"><a href="#local-6989586621682027218"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-245"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">debugLevel</span><span> </span><a href="#local-6989586621682027214"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-246"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">RealSrcSpan</span><span> </span><a name="local-6989586621682027223"><a href="#local-6989586621682027223"><span class="hs-identifier">span</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">nameSrcSpan</span><span> </span><a href="#local-6989586621682027218"><span class="hs-identifier hs-var">name</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027219"><span class="hs-identifier hs-var">tick</span></a><span> </span><a href="#local-6989586621682027223"><span class="hs-identifier hs-var">span</span></a><span>
</span><a name="line-247"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682027224"><a href="#local-6989586621682027224"><span class="hs-identifier">file</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">ml_hs_file</span><span> </span><a href="#local-6989586621682027215"><span class="hs-identifier hs-var">mod_loc</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027219"><span class="hs-identifier hs-var">tick</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027220"><span class="hs-identifier hs-var">span1</span></a><span> </span><a href="#local-6989586621682027224"><span class="hs-identifier hs-var">file</span></a><span class="hs-special">)</span><span>
</span><a name="line-248"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                             </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027219"><span class="hs-identifier hs-var">tick</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027220"><span class="hs-identifier hs-var">span1</span></a><span> </span><span class="hs-string">&quot;???&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-249"></a><span>     </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682027219"><a href="#local-6989586621682027219"><span class="hs-identifier">tick</span></a></a><span> </span><a name="local-6989586621682027221"><a href="#local-6989586621682027221"><span class="hs-identifier">span</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Tick</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SourceNote</span><span> </span><a href="#local-6989586621682027221"><span class="hs-identifier hs-var">span</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">showSDoc</span><span> </span><a href="#local-6989586621682027214"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682027218"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-250"></a><span>           </span><a name="local-6989586621682027220"><a href="#local-6989586621682027220"><span class="hs-identifier">span1</span></a></a><span> </span><a name="local-6989586621682027222"><a href="#local-6989586621682027222"><span class="hs-identifier">file</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">realSrcLocSpan</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkRealSrcLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkFastString</span><span> </span><a href="#local-6989586621682027222"><span class="hs-identifier hs-var">file</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-251"></a><span>
</span><a name="line-252"></a><span class="hs-comment">{-
Note [Floating out of top level bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
NB: we do need to float out of top-level bindings
Consider        x = length [True,False]
We want to get
                s1 = False : []
                s2 = True  : s1
                x  = length s2

We return a *list* of bindings, because we may start with
        x* = f (g y)
where x is demanded, in which case we want to finish with
        a = g y
        x* = f a
And then x will actually end up case-bound

Note [CafInfo and floating]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
What happens when we try to float bindings to the top level?  At this
point all the CafInfo is supposed to be correct, and we must make certain
that is true of the new top-level bindings.  There are two cases
to consider

a) The top-level binding is marked asCafRefs.  In that case we are
   basically fine.  The floated bindings had better all be lazy lets,
   so they can float to top level, but they'll all have HasCafRefs
   (the default) which is safe.

b) The top-level binding is marked NoCafRefs.  This really happens
   Example.  CoreTidy produces
      $fApplicativeSTM [NoCafRefs] = D:Alternative retry# ...blah...
   Now CorePrep has to eta-expand to
      $fApplicativeSTM = let sat = \xy. retry x y
                         in D:Alternative sat ...blah...
   So what we *want* is
      sat [NoCafRefs] = \xy. retry x y
      $fApplicativeSTM [NoCafRefs] = D:Alternative sat ...blah...

   So, gruesomely, we must set the NoCafRefs flag on the sat bindings,
   *and* substitute the modified 'sat' into the old RHS.

   It should be the case that 'sat' is itself [NoCafRefs] (a value, no
   cafs) else the original top-level binding would not itself have been
   marked [NoCafRefs].  The DEBUG check in CoreToStg for
   consistentCafInfo will find this.

This is all very gruesome and horrible. It would be better to figure
out CafInfo later, after CorePrep.  We'll do that in due course.
Meanwhile this horrible hack works.

Note [Join points and floating]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Join points can float out of other join points but not out of value bindings:

  let z =
    let  w = ... in -- can float
    join k = ... in -- can't float
    ... jump k ...
  join j x1 ... xn =
    let  y = ... in -- can float (but don't want to)
    join h = ... in -- can float (but not much point)
    ... jump h ...
  in ...

Here, the jump to h remains valid if h is floated outward, but the jump to k
does not.

We don't float *out* of join points. It would only be safe to float out of
nullary join points (or ones where the arguments are all either type arguments
or dead binders). Nullary join points aren't ever recursive, so they're always
effectively one-shot functions, which we don't float out of. We *could* float
join points from nullary join points, but there's no clear benefit at this
stage.

Note [Data constructor workers]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Create any necessary &quot;implicit&quot; bindings for data con workers.  We
create the rather strange (non-recursive!) binding

        $wC = \x y -&gt; $wC x y

i.e. a curried constructor that allocates.  This means that we can
treat the worker for a constructor like any other function in the rest
of the compiler.  The point here is that CoreToStg will generate a
StgConApp for the RHS, rather than a call to the worker (which would
give a loop).  As Lennart says: the ice is thin here, but it works.

Hmm.  Should we create bindings for dictionary constructors?  They are
always fully applied, and the bindings are just there to support
partial applications. But it's easier to let them through.


Note [Dead code in CorePrep]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Imagine that we got an input program like this (see Trac #4962):

  f :: Show b =&gt; Int -&gt; (Int, b -&gt; Maybe Int -&gt; Int)
  f x = (g True (Just x) + g () (Just x), g)
    where
      g :: Show a =&gt; a -&gt; Maybe Int -&gt; Int
      g _ Nothing = x
      g y (Just z) = if z &gt; 100 then g y (Just (z + length (show y))) else g y unknown

After specialisation and SpecConstr, we would get something like this:

  f :: Show b =&gt; Int -&gt; (Int, b -&gt; Maybe Int -&gt; Int)
  f x = (g$Bool_True_Just x + g$Unit_Unit_Just x, g)
    where
      {-# RULES g $dBool = g$Bool
                g $dUnit = g$Unit #-}
      g = ...
      {-# RULES forall x. g$Bool True (Just x) = g$Bool_True_Just x #-}
      g$Bool = ...
      {-# RULES forall x. g$Unit () (Just x) = g$Unit_Unit_Just x #-}
      g$Unit = ...
      g$Bool_True_Just = ...
      g$Unit_Unit_Just = ...

Note that the g$Bool and g$Unit functions are actually dead code: they
are only kept alive by the occurrence analyser because they are
referred to by the rules of g, which is being kept alive by the fact
that it is used (unspecialised) in the returned pair.

However, at the CorePrep stage there is no way that the rules for g
will ever fire, and it really seems like a shame to produce an output
program that goes to the trouble of allocating a closure for the
unreachable g$Bool and g$Unit functions.

The way we fix this is to:
 * In cloneBndr, drop all unfoldings/rules

 * In deFloatTop, run a simple dead code analyser on each top-level
   RHS to drop the dead local bindings. For that call to OccAnal, we
   disable the binder swap, else the occurrence analyser sometimes
   introduces new let bindings for cased binders, which lead to the bug
   in #5433.

The reason we don't just OccAnal the whole output of CorePrep is that
the tidier ensures that all top-level binders are GlobalIds, so they
don't show up in the free variables any longer. So if you run the
occurrence analyser on the output of CoreTidy (or later) you e.g. turn
this program:

  Rec {
  f = ... f ...
  }

Into this one:

  f = ... f ...

(Since f is not considered to be free in its own RHS.)


************************************************************************
*                                                                      *
                The main code
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-413"></a><span>
</span><a name="line-414"></a><span class="hs-identifier">cpeBind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreBind</span><span>
</span><a name="line-415"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-416"></a><span>                   </span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span class="hs-special">,</span><span>         </span><span class="hs-comment">-- Floating value bindings</span><span>
</span><a name="line-417"></a><span>                   </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">CoreBind</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Just bind' &lt;=&gt; returned new bind; no float</span><span>
</span><a name="line-418"></a><span>                                   </span><span class="hs-comment">-- Nothing &lt;=&gt; added bind' to floats instead</span><span>
</span><a name="line-419"></a><a name="cpeBind"><a href="CorePrep.html#cpeBind"><span class="hs-identifier">cpeBind</span></a></a><span> </span><a name="local-6989586621682027228"><a href="#local-6989586621682027228"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621682027229"><a href="#local-6989586621682027229"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a name="local-6989586621682027230"><a href="#local-6989586621682027230"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621682027231"><a href="#local-6989586621682027231"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-420"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isJoinId</span><span> </span><a href="#local-6989586621682027230"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-421"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682027232"><a href="#local-6989586621682027232"><span class="hs-identifier">bndr1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#cpCloneBndr"><span class="hs-identifier hs-var">cpCloneBndr</span></a><span> </span><a href="#local-6989586621682027229"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027230"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-422"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682027233"><a href="#local-6989586621682027233"><span class="hs-identifier">dmd</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idDemandInfo</span><span> </span><a href="#local-6989586621682027230"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-423"></a><span>             </span><a name="local-6989586621682027234"><a href="#local-6989586621682027234"><span class="hs-identifier">is_unlifted</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isUnliftedType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621682027230"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-424"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027235"><a href="#local-6989586621682027235"><span class="hs-identifier">floats</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027236"><a href="#local-6989586621682027236"><span class="hs-identifier">rhs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#cpePair"><span class="hs-identifier hs-var">cpePair</span></a><span> </span><a href="#local-6989586621682027228"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><span class="hs-identifier hs-var">NonRecursive</span><span>
</span><a name="line-425"></a><span>                                   </span><a href="#local-6989586621682027233"><span class="hs-identifier hs-var">dmd</span></a><span> </span><a href="#local-6989586621682027234"><span class="hs-identifier hs-var">is_unlifted</span></a><span>
</span><a name="line-426"></a><span>                                   </span><a href="#local-6989586621682027229"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027232"><span class="hs-identifier hs-var">bndr1</span></a><span> </span><a href="#local-6989586621682027231"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-427"></a><span>       </span><span class="hs-comment">-- See Note [Inlining in CorePrep]</span><span>
</span><a name="line-428"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">exprIsTrivial</span><span> </span><a href="#local-6989586621682027236"><span class="hs-identifier hs-var">rhs1</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isNotTopLevel</span><span> </span><a href="#local-6989586621682027228"><span class="hs-identifier hs-var">top_lvl</span></a><span>
</span><a name="line-429"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#extendCorePrepEnvExpr"><span class="hs-identifier hs-var">extendCorePrepEnvExpr</span></a><span> </span><a href="#local-6989586621682027229"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027230"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621682027236"><span class="hs-identifier hs-var">rhs1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027235"><span class="hs-identifier hs-var">floats</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-430"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-431"></a><span>
</span><a name="line-432"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682027237"><a href="#local-6989586621682027237"><span class="hs-identifier">new_float</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#mkFloat"><span class="hs-identifier hs-var">mkFloat</span></a><span> </span><a href="#local-6989586621682027233"><span class="hs-identifier hs-var">dmd</span></a><span> </span><a href="#local-6989586621682027234"><span class="hs-identifier hs-var">is_unlifted</span></a><span> </span><a href="#local-6989586621682027232"><span class="hs-identifier hs-var">bndr1</span></a><span> </span><a href="#local-6989586621682027236"><span class="hs-identifier hs-var">rhs1</span></a><span>
</span><a name="line-433"></a><span>
</span><a name="line-434"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#extendCorePrepEnv"><span class="hs-identifier hs-var">extendCorePrepEnv</span></a><span> </span><a href="#local-6989586621682027229"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027230"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621682027232"><span class="hs-identifier hs-var">bndr1</span></a><span class="hs-special">,</span><span>
</span><a name="line-435"></a><span>                 </span><a href="CorePrep.html#addFloat"><span class="hs-identifier hs-var">addFloat</span></a><span> </span><a href="#local-6989586621682027235"><span class="hs-identifier hs-var">floats</span></a><span> </span><a href="#local-6989586621682027237"><span class="hs-identifier hs-var">new_float</span></a><span class="hs-special">,</span><span>
</span><a name="line-436"></a><span>                 </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-437"></a><span>
</span><a name="line-438"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-comment">-- A join point; see Note [Join points and floating]</span><span>
</span><a name="line-439"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isTopLevel</span><span> </span><span class="hs-identifier">top_lvl</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- can't have top-level join point</span><span>
</span><a name="line-440"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682027238"><a href="#local-6989586621682027238"><span class="hs-identifier">bndr1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#cpCloneBndr"><span class="hs-identifier hs-var">cpCloneBndr</span></a><span> </span><a href="#local-6989586621682027229"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027230"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-441"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027239"><a href="#local-6989586621682027239"><span class="hs-identifier">bndr2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027240"><a href="#local-6989586621682027240"><span class="hs-identifier">rhs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#cpeJoinPair"><span class="hs-identifier hs-var">cpeJoinPair</span></a><span> </span><a href="#local-6989586621682027229"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027238"><span class="hs-identifier hs-var">bndr1</span></a><span> </span><a href="#local-6989586621682027231"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-442"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#extendCorePrepEnv"><span class="hs-identifier hs-var">extendCorePrepEnv</span></a><span> </span><a href="#local-6989586621682027229"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027230"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621682027239"><span class="hs-identifier hs-var">bndr2</span></a><span class="hs-special">,</span><span>
</span><a name="line-443"></a><span>                 </span><a href="CorePrep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a><span class="hs-special">,</span><span>
</span><a name="line-444"></a><span>                 </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621682027239"><span class="hs-identifier hs-var">bndr2</span></a><span> </span><a href="#local-6989586621682027240"><span class="hs-identifier hs-var">rhs1</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-445"></a><span>
</span><a name="line-446"></a><span class="hs-identifier">cpeBind</span><span> </span><a name="local-6989586621682027241"><a href="#local-6989586621682027241"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621682027242"><a href="#local-6989586621682027242"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><a name="local-6989586621682027243"><a href="#local-6989586621682027243"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-447"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isJoinId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621682027244"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-448"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027253"><a href="#local-6989586621682027253"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027254"><a href="#local-6989586621682027254"><span class="hs-identifier">bndrs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#cpCloneBndrs"><span class="hs-identifier hs-var">cpCloneBndrs</span></a><span> </span><a href="#local-6989586621682027242"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027244"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-449"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682027255"><a href="#local-6989586621682027255"><span class="hs-identifier">stuff</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zipWithM</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#cpePair"><span class="hs-identifier hs-var">cpePair</span></a><span> </span><a href="#local-6989586621682027241"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><span class="hs-identifier hs-var">Recursive</span><span> </span><span class="hs-identifier hs-var">topDmd</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621682027253"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">)</span><span>
</span><a name="line-450"></a><span>                           </span><a href="#local-6989586621682027254"><span class="hs-identifier hs-var">bndrs1</span></a><span> </span><a href="#local-6989586621682027245"><span class="hs-identifier hs-var">rhss</span></a><span>
</span><a name="line-451"></a><span>
</span><a name="line-452"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027256"><a href="#local-6989586621682027256"><span class="hs-identifier">floats_s</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027257"><a href="#local-6989586621682027257"><span class="hs-identifier">rhss1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621682027255"><span class="hs-identifier hs-var">stuff</span></a><span>
</span><a name="line-453"></a><span>             </span><a name="local-6989586621682027258"><a href="#local-6989586621682027258"><span class="hs-identifier">all_pairs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldrOL</span><span> </span><a href="#local-6989586621682027246"><span class="hs-identifier hs-var">add_float</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027254"><span class="hs-identifier hs-var">bndrs1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682027257"><span class="hs-identifier hs-var">rhss1</span></a><span class="hs-special">)</span><span>
</span><a name="line-454"></a><span>                                           </span><span class="hs-special">(</span><a href="CorePrep.html#concatFloats"><span class="hs-identifier hs-var">concatFloats</span></a><span> </span><a href="#local-6989586621682027256"><span class="hs-identifier hs-var">floats_s</span></a><span class="hs-special">)</span><span>
</span><a name="line-455"></a><span>
</span><a name="line-456"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#extendCorePrepEnvList"><span class="hs-identifier hs-var">extendCorePrepEnvList</span></a><span> </span><a href="#local-6989586621682027242"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027244"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682027254"><span class="hs-identifier hs-var">bndrs1</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-457"></a><span>                 </span><a href="CorePrep.html#unitFloat"><span class="hs-identifier hs-var">unitFloat</span></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#FloatLet"><span class="hs-identifier hs-var">FloatLet</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><a href="#local-6989586621682027258"><span class="hs-identifier hs-var">all_pairs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-458"></a><span>                 </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-459"></a><span>
</span><a name="line-460"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-comment">-- See Note [Join points and floating]</span><span>
</span><a name="line-461"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027259"><a href="#local-6989586621682027259"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027260"><a href="#local-6989586621682027260"><span class="hs-identifier">bndrs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#cpCloneBndrs"><span class="hs-identifier hs-var">cpCloneBndrs</span></a><span> </span><a href="#local-6989586621682027242"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027244"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-462"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682027261"><a href="#local-6989586621682027261"><span class="hs-identifier">pairs1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zipWithM</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#cpeJoinPair"><span class="hs-identifier hs-var">cpeJoinPair</span></a><span> </span><a href="#local-6989586621682027259"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027260"><span class="hs-identifier hs-var">bndrs1</span></a><span> </span><a href="#local-6989586621682027245"><span class="hs-identifier hs-var">rhss</span></a><span>
</span><a name="line-463"></a><span>
</span><a name="line-464"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682027262"><a href="#local-6989586621682027262"><span class="hs-identifier">bndrs2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621682027261"><span class="hs-identifier hs-var">pairs1</span></a><span>
</span><a name="line-465"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#extendCorePrepEnvList"><span class="hs-identifier hs-var">extendCorePrepEnvList</span></a><span> </span><a href="#local-6989586621682027259"><span class="hs-identifier hs-var">env'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027244"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682027262"><span class="hs-identifier hs-var">bndrs2</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-466"></a><span>                 </span><a href="CorePrep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a><span class="hs-special">,</span><span>
</span><a name="line-467"></a><span>                 </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><a href="#local-6989586621682027261"><span class="hs-identifier hs-var">pairs1</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-468"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-469"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682027244"><a href="#local-6989586621682027244"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027245"><a href="#local-6989586621682027245"><span class="hs-identifier">rhss</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621682027243"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-470"></a><span>
</span><a name="line-471"></a><span>        </span><span class="hs-comment">-- Flatten all the floats, and the current</span><span>
</span><a name="line-472"></a><span>        </span><span class="hs-comment">-- group into a single giant Rec</span><span>
</span><a name="line-473"></a><span>    </span><a name="local-6989586621682027246"><a href="#local-6989586621682027246"><span class="hs-identifier">add_float</span></a></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#FloatLet"><span class="hs-identifier hs-var">FloatLet</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a name="local-6989586621682027247"><a href="#local-6989586621682027247"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621682027248"><a href="#local-6989586621682027248"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682027249"><a href="#local-6989586621682027249"><span class="hs-identifier">prs2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027247"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><a href="#local-6989586621682027248"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682027249"><span class="hs-identifier hs-var">prs2</span></a><span>
</span><a name="line-474"></a><span>    </span><span class="hs-identifier">add_float</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#FloatLet"><span class="hs-identifier hs-var">FloatLet</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><a name="local-6989586621682027250"><a href="#local-6989586621682027250"><span class="hs-identifier">prs1</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>   </span><a name="local-6989586621682027251"><a href="#local-6989586621682027251"><span class="hs-identifier">prs2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027250"><span class="hs-identifier hs-var">prs1</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682027251"><span class="hs-identifier hs-var">prs2</span></a><span>
</span><a name="line-475"></a><span>    </span><span class="hs-identifier">add_float</span><span> </span><a name="local-6989586621682027252"><a href="#local-6989586621682027252"><span class="hs-identifier">b</span></a></a><span>                       </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;cpeBind&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682027252"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-476"></a><span>
</span><a name="line-477"></a><span class="hs-comment">---------------</span><span>
</span><a name="line-478"></a><span class="hs-identifier">cpePair</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RecFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Demand</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-479"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-480"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span class="hs-special">,</span><span> </span><a href="CorePrep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-481"></a><span class="hs-comment">-- Used for all bindings</span><span>
</span><a name="line-482"></a><span class="hs-comment">-- The binder is already cloned, hence an OutId</span><span>
</span><a name="line-483"></a><a name="cpePair"><a href="CorePrep.html#cpePair"><span class="hs-identifier">cpePair</span></a></a><span> </span><a name="local-6989586621682027263"><a href="#local-6989586621682027263"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621682027264"><a href="#local-6989586621682027264"><span class="hs-identifier">is_rec</span></a></a><span> </span><a name="local-6989586621682027265"><a href="#local-6989586621682027265"><span class="hs-identifier">dmd</span></a></a><span> </span><a name="local-6989586621682027266"><a href="#local-6989586621682027266"><span class="hs-identifier">is_unlifted</span></a></a><span> </span><a name="local-6989586621682027267"><a href="#local-6989586621682027267"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682027268"><a href="#local-6989586621682027268"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621682027269"><a href="#local-6989586621682027269"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-484"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isJoinId</span><span> </span><span class="hs-identifier">bndr</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- those should use cpeJoinPair</span><span>
</span><a name="line-485"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027283"><a href="#local-6989586621682027283"><span class="hs-identifier">floats1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027284"><a href="#local-6989586621682027284"><span class="hs-identifier">rhs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a><span> </span><a href="#local-6989586621682027267"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027269"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-486"></a><span>
</span><a name="line-487"></a><span>       </span><span class="hs-comment">-- See if we are allowed to float this stuff out of the RHS</span><span>
</span><a name="line-488"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027285"><a href="#local-6989586621682027285"><span class="hs-identifier">floats2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027286"><a href="#local-6989586621682027286"><span class="hs-identifier">rhs2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682027272"><span class="hs-identifier hs-var">float_from_rhs</span></a><span> </span><a href="#local-6989586621682027283"><span class="hs-identifier hs-var">floats1</span></a><span> </span><a href="#local-6989586621682027284"><span class="hs-identifier hs-var">rhs1</span></a><span>
</span><a name="line-489"></a><span>
</span><a name="line-490"></a><span>       </span><span class="hs-comment">-- Make the arity match up</span><span>
</span><a name="line-491"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027289"><a href="#local-6989586621682027289"><span class="hs-identifier">floats3</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027290"><a href="#local-6989586621682027290"><span class="hs-identifier">rhs3</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-492"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">manifestArity</span><span> </span><a href="#local-6989586621682027284"><span class="hs-identifier hs-var">rhs1</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><a href="#local-6989586621682027271"><span class="hs-identifier hs-var">arity</span></a><span>
</span><a name="line-493"></a><span>               </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027285"><span class="hs-identifier hs-var">floats2</span></a><span class="hs-special">,</span><span> </span><a href="CorePrep.html#cpeEtaExpand"><span class="hs-identifier hs-var">cpeEtaExpand</span></a><span> </span><a href="#local-6989586621682027271"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621682027286"><span class="hs-identifier hs-var">rhs2</span></a><span class="hs-special">)</span><span>
</span><a name="line-494"></a><span>               </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier">WARN</span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;CorePrep: silly extra arguments:&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">bndr</span><span class="hs-special">)</span><span>
</span><a name="line-495"></a><span>                               </span><span class="hs-comment">-- Note [Silly extra arguments]</span><span>
</span><a name="line-496"></a><span>                    </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682027287"><a href="#local-6989586621682027287"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#newVar"><span class="hs-identifier hs-var">newVar</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621682027268"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-497"></a><span>                        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682027288"><a href="#local-6989586621682027288"><span class="hs-identifier">float</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#mkFloat"><span class="hs-identifier hs-var">mkFloat</span></a><span> </span><span class="hs-identifier hs-var">topDmd</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621682027287"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621682027286"><span class="hs-identifier hs-var">rhs2</span></a><span>
</span><a name="line-498"></a><span>                        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><a href="CorePrep.html#addFloat"><span class="hs-identifier hs-var">addFloat</span></a><span> </span><a href="#local-6989586621682027285"><span class="hs-identifier hs-var">floats2</span></a><span> </span><a href="#local-6989586621682027288"><span class="hs-identifier hs-var">float</span></a><span>
</span><a name="line-499"></a><span>                                 </span><span class="hs-special">,</span><span> </span><a href="CorePrep.html#cpeEtaExpand"><span class="hs-identifier hs-var">cpeEtaExpand</span></a><span> </span><a href="#local-6989586621682027271"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621682027287"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-500"></a><span>
</span><a name="line-501"></a><span>        </span><span class="hs-comment">-- Wrap floating ticks</span><span>
</span><a name="line-502"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027291"><a href="#local-6989586621682027291"><span class="hs-identifier">floats4</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027292"><a href="#local-6989586621682027292"><span class="hs-identifier">rhs4</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#wrapTicks"><span class="hs-identifier hs-var">wrapTicks</span></a><span> </span><a href="#local-6989586621682027289"><span class="hs-identifier hs-var">floats3</span></a><span> </span><a href="#local-6989586621682027290"><span class="hs-identifier hs-var">rhs3</span></a><span>
</span><a name="line-503"></a><span>
</span><a name="line-504"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027291"><span class="hs-identifier hs-var">floats4</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027292"><span class="hs-identifier hs-var">rhs4</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-505"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-506"></a><span>    </span><a name="local-6989586621682027270"><a href="#local-6989586621682027270"><span class="hs-identifier">platform</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cpe_dynFlags</span><span> </span><a href="#local-6989586621682027267"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-507"></a><span>
</span><a name="line-508"></a><span>    </span><a name="local-6989586621682027271"><a href="#local-6989586621682027271"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idArity</span><span> </span><a href="#local-6989586621682027268"><span class="hs-identifier hs-var">bndr</span></a><span>        </span><span class="hs-comment">-- We must match this arity</span><span>
</span><a name="line-509"></a><span>
</span><a name="line-510"></a><span>    </span><span class="hs-comment">---------------------</span><span>
</span><a name="line-511"></a><span>    </span><a name="local-6989586621682027272"><a href="#local-6989586621682027272"><span class="hs-identifier">float_from_rhs</span></a></a><span> </span><a name="local-6989586621682027275"><a href="#local-6989586621682027275"><span class="hs-identifier">floats</span></a></a><span> </span><a name="local-6989586621682027276"><a href="#local-6989586621682027276"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-512"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="CorePrep.html#isEmptyFloats"><span class="hs-identifier hs-var">isEmptyFloats</span></a><span> </span><a href="#local-6989586621682027275"><span class="hs-identifier hs-var">floats</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027276"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-513"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTopLevel</span><span> </span><a href="#local-6989586621682027263"><span class="hs-identifier hs-var">top_lvl</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027274"><span class="hs-identifier hs-var">float_top</span></a><span>    </span><a href="#local-6989586621682027275"><span class="hs-identifier hs-var">floats</span></a><span> </span><a href="#local-6989586621682027276"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-514"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027273"><span class="hs-identifier hs-var">float_nested</span></a><span> </span><a href="#local-6989586621682027275"><span class="hs-identifier hs-var">floats</span></a><span> </span><a href="#local-6989586621682027276"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-515"></a><span>
</span><a name="line-516"></a><span>    </span><span class="hs-comment">---------------------</span><span>
</span><a name="line-517"></a><span>    </span><a name="local-6989586621682027273"><a href="#local-6989586621682027273"><span class="hs-identifier">float_nested</span></a></a><span> </span><a name="local-6989586621682027277"><a href="#local-6989586621682027277"><span class="hs-identifier">floats</span></a></a><span> </span><a name="local-6989586621682027278"><a href="#local-6989586621682027278"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-518"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="CorePrep.html#wantFloatNested"><span class="hs-identifier hs-var">wantFloatNested</span></a><span> </span><a href="#local-6989586621682027264"><span class="hs-identifier hs-var">is_rec</span></a><span> </span><a href="#local-6989586621682027265"><span class="hs-identifier hs-var">dmd</span></a><span> </span><a href="#local-6989586621682027266"><span class="hs-identifier hs-var">is_unlifted</span></a><span> </span><a href="#local-6989586621682027277"><span class="hs-identifier hs-var">floats</span></a><span> </span><a href="#local-6989586621682027278"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-519"></a><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027277"><span class="hs-identifier hs-var">floats</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027278"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-520"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#dontFloat"><span class="hs-identifier hs-var">dontFloat</span></a><span> </span><a href="#local-6989586621682027277"><span class="hs-identifier hs-var">floats</span></a><span> </span><a href="#local-6989586621682027278"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-521"></a><span>
</span><a name="line-522"></a><span>    </span><span class="hs-comment">---------------------</span><span>
</span><a name="line-523"></a><span>    </span><a name="local-6989586621682027274"><a href="#local-6989586621682027274"><span class="hs-identifier">float_top</span></a></a><span> </span><a name="local-6989586621682027279"><a href="#local-6989586621682027279"><span class="hs-identifier">floats</span></a></a><span> </span><a name="local-6989586621682027280"><a href="#local-6989586621682027280"><span class="hs-identifier">rhs</span></a></a><span>        </span><span class="hs-comment">-- Urhgh!  See Note [CafInfo and floating]</span><span>
</span><a name="line-524"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">mayHaveCafRefs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idCafInfo</span><span> </span><a href="#local-6989586621682027268"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-525"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="CorePrep.html#allLazyTop"><span class="hs-identifier hs-var">allLazyTop</span></a><span> </span><a href="#local-6989586621682027279"><span class="hs-identifier hs-var">floats</span></a><span>
</span><a name="line-526"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027279"><span class="hs-identifier hs-var">floats</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027280"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-527"></a><span>
</span><a name="line-528"></a><span>      </span><span class="hs-comment">-- So the top-level binding is marked NoCafRefs</span><span>
</span><a name="line-529"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027281"><a href="#local-6989586621682027281"><span class="hs-identifier">floats'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027282"><a href="#local-6989586621682027282"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#canFloatFromNoCaf"><span class="hs-identifier hs-var">canFloatFromNoCaf</span></a><span> </span><a href="#local-6989586621682027270"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621682027279"><span class="hs-identifier hs-var">floats</span></a><span> </span><a href="#local-6989586621682027280"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-530"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027281"><span class="hs-identifier hs-var">floats'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027282"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-531"></a><span>
</span><a name="line-532"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-533"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#dontFloat"><span class="hs-identifier hs-var">dontFloat</span></a><span> </span><a href="#local-6989586621682027279"><span class="hs-identifier hs-var">floats</span></a><span> </span><a href="#local-6989586621682027280"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-534"></a><span>
</span><a name="line-535"></a><span class="hs-identifier">dontFloat</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span class="hs-special">,</span><span> </span><a href="CorePrep.html#CpeBody"><span class="hs-identifier hs-type">CpeBody</span></a><span class="hs-special">)</span><span>
</span><a name="line-536"></a><span class="hs-comment">-- Non-empty floats, but do not want to float from rhs</span><span>
</span><a name="line-537"></a><span class="hs-comment">-- So wrap the rhs in the floats</span><span>
</span><a name="line-538"></a><span class="hs-comment">-- But: rhs1 might have lambdas, and we can't</span><span>
</span><a name="line-539"></a><span class="hs-comment">--      put them inside a wrapBinds</span><span>
</span><a name="line-540"></a><a name="dontFloat"><a href="CorePrep.html#dontFloat"><span class="hs-identifier">dontFloat</span></a></a><span> </span><a name="local-6989586621682027293"><a href="#local-6989586621682027293"><span class="hs-identifier">floats1</span></a></a><span> </span><a name="local-6989586621682027294"><a href="#local-6989586621682027294"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-541"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027295"><a href="#local-6989586621682027295"><span class="hs-identifier">floats2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027296"><a href="#local-6989586621682027296"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#rhsToBody"><span class="hs-identifier hs-var">rhsToBody</span></a><span> </span><a href="#local-6989586621682027294"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-542"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a><span class="hs-special">,</span><span> </span><a href="CorePrep.html#wrapBinds"><span class="hs-identifier hs-var">wrapBinds</span></a><span> </span><a href="#local-6989586621682027293"><span class="hs-identifier hs-var">floats1</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-543"></a><span>                               </span><a href="CorePrep.html#wrapBinds"><span class="hs-identifier hs-var">wrapBinds</span></a><span> </span><a href="#local-6989586621682027295"><span class="hs-identifier hs-var">floats2</span></a><span> </span><a href="#local-6989586621682027296"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-544"></a><span>
</span><a name="line-545"></a><span class="hs-comment">{- Note [Silly extra arguments]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we had this
        f{arity=1} = \x\y. e
We *must* match the arity on the Id, so we have to generate
        f' = \x\y. e
        f  = \x. f' x

It's a bizarre case: why is the arity on the Id wrong?  Reason
(in the days of __inline_me__):
        f{arity=0} = __inline_me__ (let v = expensive in \xy. e)
When InlineMe notes go away this won't happen any more.  But
it seems good for CorePrep to be robust.
-}</span><span>
</span><a name="line-559"></a><span>
</span><a name="line-560"></a><span class="hs-comment">---------------</span><span>
</span><a name="line-561"></a><span class="hs-identifier">cpeJoinPair</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CorePrep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">JoinId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-562"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">JoinId</span><span class="hs-special">,</span><span> </span><a href="CorePrep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-563"></a><span class="hs-comment">-- Used for all join bindings</span><span>
</span><a name="line-564"></a><a name="cpeJoinPair"><a href="CorePrep.html#cpeJoinPair"><span class="hs-identifier">cpeJoinPair</span></a></a><span> </span><a name="local-6989586621682027297"><a href="#local-6989586621682027297"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682027298"><a href="#local-6989586621682027298"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621682027299"><a href="#local-6989586621682027299"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-565"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier">isJoinId</span><span> </span><span class="hs-identifier">bndr</span><span class="hs-special">)</span><span>
</span><a name="line-566"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682027300"><a href="#local-6989586621682027300"><span class="hs-identifier">join_arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isJoinId_maybe</span><span> </span><a href="#local-6989586621682027298"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-567"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621682027301"><a href="#local-6989586621682027301"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027302"><a href="#local-6989586621682027302"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">collectNBinders</span><span> </span><a href="#local-6989586621682027300"><span class="hs-identifier hs-var">join_arity</span></a><span> </span><a href="#local-6989586621682027299"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-568"></a><span>
</span><a name="line-569"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027303"><a href="#local-6989586621682027303"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027304"><a href="#local-6989586621682027304"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#cpCloneBndrs"><span class="hs-identifier hs-var">cpCloneBndrs</span></a><span> </span><a href="#local-6989586621682027297"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027301"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-570"></a><span>
</span><a name="line-571"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682027305"><a href="#local-6989586621682027305"><span class="hs-identifier">body'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#cpeBodyNF"><span class="hs-identifier hs-var">cpeBodyNF</span></a><span> </span><a href="#local-6989586621682027303"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621682027302"><span class="hs-identifier hs-var">body</span></a><span> </span><span class="hs-comment">-- Will let-bind the body if it starts</span><span>
</span><a name="line-572"></a><span>                                      </span><span class="hs-comment">-- with a lambda</span><span>
</span><a name="line-573"></a><span>
</span><a name="line-574"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682027306"><a href="#local-6989586621682027306"><span class="hs-identifier">rhs'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkCoreLams</span><span> </span><a href="#local-6989586621682027304"><span class="hs-identifier hs-var">bndrs'</span></a><span> </span><a href="#local-6989586621682027305"><span class="hs-identifier hs-var">body'</span></a><span>
</span><a name="line-575"></a><span>             </span><a name="local-6989586621682027307"><a href="#local-6989586621682027307"><span class="hs-identifier">bndr'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027298"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setIdUnfolding</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">evaldUnfolding</span><span>
</span><a name="line-576"></a><span>                          </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setIdArity</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">count</span><span> </span><span class="hs-identifier hs-var">isId</span><span> </span><a href="#local-6989586621682027301"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-577"></a><span>                            </span><span class="hs-comment">-- See Note [Arity and join points]</span><span>
</span><a name="line-578"></a><span>
</span><a name="line-579"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027307"><span class="hs-identifier hs-var">bndr'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027306"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-580"></a><span>
</span><a name="line-581"></a><span class="hs-comment">{-
Note [Arity and join points]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Up to now, we've allowed a join point to have an arity greater than its join
arity (minus type arguments), since this is what's useful for eta expansion.
However, for code gen purposes, its arity must be exactly the number of value
arguments it will be called with, and it must have exactly that many value
lambdas. Hence if there are extra lambdas we must let-bind the body of the RHS:

  join j x y z = \w -&gt; ... in ...
    =&gt;
  join j x y z = (let f = \w -&gt; ... in f) in ...

This is also what happens with Note [Silly extra arguments]. Note that it's okay
for us to mess with the arity because a join point is never exported.
-}</span><span>
</span><a name="line-597"></a><span>
</span><a name="line-598"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-599"></a><span class="hs-comment">--              CpeRhs: produces a result satisfying CpeRhs</span><span>
</span><a name="line-600"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-601"></a><span>
</span><a name="line-602"></a><span class="hs-identifier">cpeRhsE</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CorePrep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span class="hs-special">,</span><span> </span><a href="CorePrep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-603"></a><span class="hs-comment">-- If</span><span>
</span><a name="line-604"></a><span class="hs-comment">--      e  ===&gt;  (bs, e')</span><span>
</span><a name="line-605"></a><span class="hs-comment">-- then</span><span>
</span><a name="line-606"></a><span class="hs-comment">--      e = let bs in e'        (semantically, that is!)</span><span>
</span><a name="line-607"></a><span class="hs-comment">--</span><span>
</span><a name="line-608"></a><span class="hs-comment">-- For example</span><span>
</span><a name="line-609"></a><span class="hs-comment">--      f (g x)   ===&gt;   ([v = g x], f v)</span><span>
</span><a name="line-610"></a><span>
</span><a name="line-611"></a><a name="cpeRhsE"><a href="CorePrep.html#cpeRhsE"><span class="hs-identifier">cpeRhsE</span></a></a><span> </span><a name="local-6989586621682027308"><a href="#local-6989586621682027308"><span class="hs-identifier">_env</span></a></a><span> </span><a name="local-6989586621682027309"><a href="#local-6989586621682027309"><span class="hs-identifier">expr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Type</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027309"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-612"></a><span class="hs-identifier">cpeRhsE</span><span> </span><a name="local-6989586621682027310"><a href="#local-6989586621682027310"><span class="hs-identifier">_env</span></a></a><span> </span><a name="local-6989586621682027311"><a href="#local-6989586621682027311"><span class="hs-identifier">expr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Coercion</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027311"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-613"></a><span class="hs-identifier">cpeRhsE</span><span> </span><a name="local-6989586621682027312"><a href="#local-6989586621682027312"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Lit</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitNumber</span><span> </span><span class="hs-identifier hs-var">LitNumInteger</span><span> </span><a name="local-6989586621682027313"><a href="#local-6989586621682027313"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-614"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a><span> </span><a href="#local-6989586621682027312"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#cvtLitInteger"><span class="hs-identifier hs-var">cvtLitInteger</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">cpe_dynFlags</span><span> </span><a href="#local-6989586621682027312"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#getMkIntegerId"><span class="hs-identifier hs-var">getMkIntegerId</span></a><span> </span><a href="#local-6989586621682027312"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-615"></a><span>                   </span><span class="hs-special">(</span><span class="hs-identifier">cpe_integerSDataCon</span><span> </span><a href="#local-6989586621682027312"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027313"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span>
</span><a name="line-616"></a><span class="hs-identifier">cpeRhsE</span><span> </span><a name="local-6989586621682027314"><a href="#local-6989586621682027314"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Lit</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitNumber</span><span> </span><span class="hs-identifier hs-var">LitNumNatural</span><span> </span><a name="local-6989586621682027315"><a href="#local-6989586621682027315"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-617"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a><span> </span><a href="#local-6989586621682027314"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#cvtLitNatural"><span class="hs-identifier hs-var">cvtLitNatural</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">cpe_dynFlags</span><span> </span><a href="#local-6989586621682027314"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#getMkNaturalId"><span class="hs-identifier hs-var">getMkNaturalId</span></a><span> </span><a href="#local-6989586621682027314"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-618"></a><span>                   </span><span class="hs-special">(</span><span class="hs-identifier">cpe_naturalSDataCon</span><span> </span><a href="#local-6989586621682027314"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027315"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span>
</span><a name="line-619"></a><span class="hs-identifier">cpeRhsE</span><span> </span><a name="local-6989586621682027316"><a href="#local-6989586621682027316"><span class="hs-identifier">_env</span></a></a><span> </span><a name="local-6989586621682027317"><a href="#local-6989586621682027317"><span class="hs-identifier">expr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Lit</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027317"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-620"></a><span class="hs-identifier">cpeRhsE</span><span> </span><a name="local-6989586621682027318"><a href="#local-6989586621682027318"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682027319"><a href="#local-6989586621682027319"><span class="hs-identifier">expr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#cpeApp"><span class="hs-identifier hs-var">cpeApp</span></a><span> </span><a href="#local-6989586621682027318"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027319"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-621"></a><span class="hs-identifier">cpeRhsE</span><span> </span><a name="local-6989586621682027320"><a href="#local-6989586621682027320"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682027321"><a href="#local-6989586621682027321"><span class="hs-identifier">expr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">App</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#cpeApp"><span class="hs-identifier hs-var">cpeApp</span></a><span> </span><a href="#local-6989586621682027320"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027321"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-622"></a><span>
</span><a name="line-623"></a><span class="hs-identifier">cpeRhsE</span><span> </span><a name="local-6989586621682027322"><a href="#local-6989586621682027322"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Let</span><span> </span><a name="local-6989586621682027323"><a href="#local-6989586621682027323"><span class="hs-identifier">bind</span></a></a><span> </span><a name="local-6989586621682027324"><a href="#local-6989586621682027324"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-624"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027325"><a href="#local-6989586621682027325"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027326"><a href="#local-6989586621682027326"><span class="hs-identifier">bind_floats</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027327"><a href="#local-6989586621682027327"><span class="hs-identifier">maybe_bind'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#cpeBind"><span class="hs-identifier hs-var">cpeBind</span></a><span> </span><span class="hs-identifier hs-var">NotTopLevel</span><span> </span><a href="#local-6989586621682027322"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027323"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-625"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027328"><a href="#local-6989586621682027328"><span class="hs-identifier">body_floats</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027329"><a href="#local-6989586621682027329"><span class="hs-identifier">body'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a><span> </span><a href="#local-6989586621682027325"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621682027324"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-626"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682027330"><a href="#local-6989586621682027330"><span class="hs-identifier">expr'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682027327"><span class="hs-identifier hs-var">maybe_bind'</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682027331"><a href="#local-6989586621682027331"><span class="hs-identifier">bind'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Let</span><span> </span><a href="#local-6989586621682027331"><span class="hs-identifier hs-var">bind'</span></a><span> </span><a href="#local-6989586621682027329"><span class="hs-identifier hs-var">body'</span></a><span>
</span><a name="line-627"></a><span>                                         </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682027329"><span class="hs-identifier hs-var">body'</span></a><span>
</span><a name="line-628"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027326"><span class="hs-identifier hs-var">bind_floats</span></a><span> </span><span class="hs-special">`</span><a href="CorePrep.html#appendFloats"><span class="hs-identifier hs-var">appendFloats</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682027328"><span class="hs-identifier hs-var">body_floats</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027330"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-629"></a><span>
</span><a name="line-630"></a><span class="hs-identifier">cpeRhsE</span><span> </span><a name="local-6989586621682027332"><a href="#local-6989586621682027332"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Tick</span><span> </span><a name="local-6989586621682027333"><a href="#local-6989586621682027333"><span class="hs-identifier">tickish</span></a></a><span> </span><a name="local-6989586621682027334"><a href="#local-6989586621682027334"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-631"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">tickishPlace</span><span> </span><a href="#local-6989586621682027333"><span class="hs-identifier hs-var">tickish</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">PlaceNonLam</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621682027333"><span class="hs-identifier hs-var">tickish</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">tickishScopesLike</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">SoftScope</span><span>
</span><a name="line-632"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027338"><a href="#local-6989586621682027338"><span class="hs-identifier">floats</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027339"><a href="#local-6989586621682027339"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a><span> </span><a href="#local-6989586621682027332"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027334"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-633"></a><span>         </span><span class="hs-comment">-- See [Floating Ticks in CorePrep]</span><span>
</span><a name="line-634"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#unitFloat"><span class="hs-identifier hs-var">unitFloat</span></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#FloatTick"><span class="hs-identifier hs-var">FloatTick</span></a><span> </span><a href="#local-6989586621682027333"><span class="hs-identifier hs-var">tickish</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="CorePrep.html#appendFloats"><span class="hs-identifier hs-var">appendFloats</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682027338"><span class="hs-identifier hs-var">floats</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027339"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-635"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-636"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682027340"><a href="#local-6989586621682027340"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#cpeBodyNF"><span class="hs-identifier hs-var">cpeBodyNF</span></a><span> </span><a href="#local-6989586621682027332"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027334"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-637"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkTick</span><span> </span><a href="#local-6989586621682027335"><span class="hs-identifier hs-var">tickish'</span></a><span> </span><a href="#local-6989586621682027340"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-638"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-639"></a><span>    </span><a name="local-6989586621682027335"><a href="#local-6989586621682027335"><span class="hs-identifier">tickish'</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Breakpoint</span><span> </span><a name="local-6989586621682027336"><a href="#local-6989586621682027336"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621682027337"><a href="#local-6989586621682027337"><span class="hs-identifier">fvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682027333"><span class="hs-identifier hs-var">tickish</span></a><span>
</span><a name="line-640"></a><span>             </span><span class="hs-comment">-- See also 'substTickish'</span><span>
</span><a name="line-641"></a><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Breakpoint</span><span> </span><a href="#local-6989586621682027336"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getIdFromTrivialExpr</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="CorePrep.html#lookupCorePrepEnv"><span class="hs-identifier hs-var">lookupCorePrepEnv</span></a><span> </span><a href="#local-6989586621682027332"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027337"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-642"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-643"></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027333"><span class="hs-identifier hs-var">tickish</span></a><span>
</span><a name="line-644"></a><span>
</span><a name="line-645"></a><span class="hs-identifier">cpeRhsE</span><span> </span><a name="local-6989586621682027341"><a href="#local-6989586621682027341"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Cast</span><span> </span><a name="local-6989586621682027342"><a href="#local-6989586621682027342"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621682027343"><a href="#local-6989586621682027343"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-646"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027344"><a href="#local-6989586621682027344"><span class="hs-identifier">floats</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027345"><a href="#local-6989586621682027345"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a><span> </span><a href="#local-6989586621682027341"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027342"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-647"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027344"><span class="hs-identifier hs-var">floats</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Cast</span><span> </span><a href="#local-6989586621682027345"><span class="hs-identifier hs-var">expr'</span></a><span> </span><a href="#local-6989586621682027343"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-648"></a><span>
</span><a name="line-649"></a><span class="hs-identifier">cpeRhsE</span><span> </span><a name="local-6989586621682027346"><a href="#local-6989586621682027346"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682027347"><a href="#local-6989586621682027347"><span class="hs-identifier">expr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Lam</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-650"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027348"><a href="#local-6989586621682027348"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><a name="local-6989586621682027349"><a href="#local-6989586621682027349"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">collectBinders</span><span> </span><a href="#local-6989586621682027347"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-651"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027350"><a href="#local-6989586621682027350"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027351"><a href="#local-6989586621682027351"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#cpCloneBndrs"><span class="hs-identifier hs-var">cpCloneBndrs</span></a><span> </span><a href="#local-6989586621682027346"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027348"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-652"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682027352"><a href="#local-6989586621682027352"><span class="hs-identifier">body'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#cpeBodyNF"><span class="hs-identifier hs-var">cpeBodyNF</span></a><span> </span><a href="#local-6989586621682027350"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621682027349"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-653"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkLams</span><span> </span><a href="#local-6989586621682027351"><span class="hs-identifier hs-var">bndrs'</span></a><span> </span><a href="#local-6989586621682027352"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-654"></a><span>
</span><a name="line-655"></a><span class="hs-identifier">cpeRhsE</span><span> </span><a name="local-6989586621682027353"><a href="#local-6989586621682027353"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Case</span><span> </span><a name="local-6989586621682027354"><a href="#local-6989586621682027354"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621682027355"><a href="#local-6989586621682027355"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621682027356"><a href="#local-6989586621682027356"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621682027357"><a href="#local-6989586621682027357"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-656"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027366"><a href="#local-6989586621682027366"><span class="hs-identifier">floats</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027367"><a href="#local-6989586621682027367"><span class="hs-identifier">scrut'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#cpeBody"><span class="hs-identifier hs-var">cpeBody</span></a><span> </span><a href="#local-6989586621682027353"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027354"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-657"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027368"><a href="#local-6989586621682027368"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027369"><a href="#local-6989586621682027369"><span class="hs-identifier">bndr2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#cpCloneBndr"><span class="hs-identifier hs-var">cpCloneBndr</span></a><span> </span><a href="#local-6989586621682027353"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027355"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-658"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682027370"><a href="#local-6989586621682027370"><span class="hs-identifier">alts'</span></a></a><span>
</span><a name="line-659"></a><span>                 </span><span class="hs-comment">-- This flag is intended to aid in debugging strictness</span><span>
</span><a name="line-660"></a><span>                 </span><span class="hs-comment">-- analysis bugs. These are particularly nasty to chase down as</span><span>
</span><a name="line-661"></a><span>                 </span><span class="hs-comment">-- they may manifest as segmentation faults. When this flag is</span><span>
</span><a name="line-662"></a><span>                 </span><span class="hs-comment">-- enabled we instead produce an 'error' expression to catch</span><span>
</span><a name="line-663"></a><span>                 </span><span class="hs-comment">-- the case where a function we think should bottom</span><span>
</span><a name="line-664"></a><span>                 </span><span class="hs-comment">-- unexpectedly returns.</span><span>
</span><a name="line-665"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_CatchBottoms</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cpe_dynFlags</span><span> </span><a href="#local-6989586621682027353"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-666"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">altsAreExhaustive</span><span> </span><a href="#local-6989586621682027357"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">)</span><span>
</span><a name="line-667"></a><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addDefault</span><span> </span><a href="#local-6989586621682027357"><span class="hs-identifier hs-var">alts</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682027371"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-668"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027357"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-669"></a><span>               </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682027371"><a href="#local-6989586621682027371"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkRuntimeErrorApp</span><span> </span><span class="hs-identifier hs-var">rUNTIME_ERROR_ID</span><span> </span><a href="#local-6989586621682027356"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-670"></a><span>                                             </span><span class="hs-string">&quot;Bottoming expression returned&quot;</span><span>
</span><a name="line-671"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682027372"><a href="#local-6989586621682027372"><span class="hs-identifier">alts''</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027358"><span class="hs-identifier hs-var">sat_alt</span></a><span> </span><a href="#local-6989586621682027368"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027370"><span class="hs-identifier hs-var">alts'</span></a><span>
</span><a name="line-672"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027366"><span class="hs-identifier hs-var">floats</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Case</span><span> </span><a href="#local-6989586621682027367"><span class="hs-identifier hs-var">scrut'</span></a><span> </span><a href="#local-6989586621682027369"><span class="hs-identifier hs-var">bndr2</span></a><span> </span><a href="#local-6989586621682027356"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621682027372"><span class="hs-identifier hs-var">alts''</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-673"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-674"></a><span>    </span><a name="local-6989586621682027358"><a href="#local-6989586621682027358"><span class="hs-identifier">sat_alt</span></a></a><span> </span><a name="local-6989586621682027359"><a href="#local-6989586621682027359"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682027360"><a href="#local-6989586621682027360"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027361"><a href="#local-6989586621682027361"><span class="hs-identifier">bs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027362"><a href="#local-6989586621682027362"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-675"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027363"><a href="#local-6989586621682027363"><span class="hs-identifier">env2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027364"><a href="#local-6989586621682027364"><span class="hs-identifier">bs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#cpCloneBndrs"><span class="hs-identifier hs-var">cpCloneBndrs</span></a><span> </span><a href="#local-6989586621682027359"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027361"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-676"></a><span>            </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682027365"><a href="#local-6989586621682027365"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#cpeBodyNF"><span class="hs-identifier hs-var">cpeBodyNF</span></a><span> </span><a href="#local-6989586621682027363"><span class="hs-identifier hs-var">env2</span></a><span> </span><a href="#local-6989586621682027362"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-677"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027360"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027364"><span class="hs-identifier hs-var">bs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027365"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-678"></a><span>
</span><a name="line-679"></a><span class="hs-identifier">cvtLitInteger</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Integer</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-680"></a><span class="hs-comment">-- Here we convert a literal Integer to the low-level</span><span>
</span><a name="line-681"></a><span class="hs-comment">-- representation. Exactly how we do this depends on the</span><span>
</span><a name="line-682"></a><span class="hs-comment">-- library that implements Integer.  If it's GMP we</span><span>
</span><a name="line-683"></a><span class="hs-comment">-- use the S# data constructor for small literals.</span><span>
</span><a name="line-684"></a><span class="hs-comment">-- See Note [Integer literals] in Literal</span><span>
</span><a name="line-685"></a><a name="cvtLitInteger"><a href="CorePrep.html#cvtLitInteger"><span class="hs-identifier">cvtLitInteger</span></a></a><span> </span><a name="local-6989586621682027373"><a href="#local-6989586621682027373"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682027374"><a href="#local-6989586621682027374"><span class="hs-identifier">sdatacon</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682027375"><a href="#local-6989586621682027375"><span class="hs-identifier">i</span></a></a><span>
</span><a name="line-686"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">inIntRange</span><span> </span><a href="#local-6989586621682027373"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682027375"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-comment">-- Special case for small integers</span><span>
</span><a name="line-687"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkConApp</span><span> </span><a href="#local-6989586621682027374"><span class="hs-identifier hs-var">sdatacon</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Lit</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLitInt</span><span> </span><a href="#local-6989586621682027373"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682027375"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-688"></a><span>
</span><a name="line-689"></a><span class="hs-identifier">cvtLitInteger</span><span> </span><a name="local-6989586621682027376"><a href="#local-6989586621682027376"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682027377"><a href="#local-6989586621682027377"><span class="hs-identifier">mk_integer</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682027378"><a href="#local-6989586621682027378"><span class="hs-identifier">i</span></a></a><span>
</span><a name="line-690"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkApps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621682027377"><span class="hs-identifier hs-var">mk_integer</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682027379"><span class="hs-identifier hs-var">isNonNegative</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027380"><span class="hs-identifier hs-var">ints</span></a><span class="hs-special">]</span><span>
</span><a name="line-691"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682027379"><a href="#local-6989586621682027379"><span class="hs-identifier">isNonNegative</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682027378"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">mkConApp</span><span> </span><span class="hs-identifier hs-var">falseDataCon</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-692"></a><span>                                 </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">mkConApp</span><span> </span><span class="hs-identifier hs-var">trueDataCon</span><span>  </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-693"></a><span>        </span><a name="local-6989586621682027380"><a href="#local-6989586621682027380"><span class="hs-identifier">ints</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkListExpr</span><span> </span><span class="hs-identifier hs-var">intTy</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027381"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">abs</span><span> </span><a href="#local-6989586621682027378"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-694"></a><span>        </span><a name="local-6989586621682027381"><a href="#local-6989586621682027381"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-695"></a><span>        </span><span class="hs-identifier">f</span><span> </span><a name="local-6989586621682027384"><a href="#local-6989586621682027384"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682027385"><a href="#local-6989586621682027385"><span class="hs-identifier">low</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027384"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">.&amp;.</span><span> </span><a href="#local-6989586621682027383"><span class="hs-identifier hs-var">mask</span></a><span>
</span><a name="line-696"></a><span>                  </span><a name="local-6989586621682027386"><a href="#local-6989586621682027386"><span class="hs-identifier">high</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027384"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">shiftR</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682027382"><span class="hs-identifier hs-var">bits</span></a><span>
</span><a name="line-697"></a><span>              </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">mkConApp</span><span> </span><span class="hs-identifier hs-var">intDataCon</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Lit</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLitInt</span><span> </span><a href="#local-6989586621682027376"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682027385"><span class="hs-identifier hs-var">low</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682027381"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621682027386"><span class="hs-identifier hs-var">high</span></a><span>
</span><a name="line-698"></a><span>        </span><a name="local-6989586621682027382"><a href="#local-6989586621682027382"><span class="hs-identifier">bits</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">31</span><span>
</span><a name="line-699"></a><span>        </span><a name="local-6989586621682027383"><a href="#local-6989586621682027383"><span class="hs-identifier">mask</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">^</span><span> </span><a href="#local-6989586621682027382"><span class="hs-identifier hs-var">bits</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-700"></a><span>
</span><a name="line-701"></a><span class="hs-identifier">cvtLitNatural</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Integer</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-702"></a><span class="hs-comment">-- Here we convert a literal Natural to the low-level</span><span>
</span><a name="line-703"></a><span class="hs-comment">-- representation.</span><span>
</span><a name="line-704"></a><span class="hs-comment">-- See Note [Natural literals] in Literal</span><span>
</span><a name="line-705"></a><a name="cvtLitNatural"><a href="CorePrep.html#cvtLitNatural"><span class="hs-identifier">cvtLitNatural</span></a></a><span> </span><a name="local-6989586621682027387"><a href="#local-6989586621682027387"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682027388"><a href="#local-6989586621682027388"><span class="hs-identifier">sdatacon</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682027389"><a href="#local-6989586621682027389"><span class="hs-identifier">i</span></a></a><span>
</span><a name="line-706"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">inWordRange</span><span> </span><a href="#local-6989586621682027387"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682027389"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-comment">-- Special case for small naturals</span><span>
</span><a name="line-707"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkConApp</span><span> </span><a href="#local-6989586621682027388"><span class="hs-identifier hs-var">sdatacon</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Lit</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLitWord</span><span> </span><a href="#local-6989586621682027387"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682027389"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-708"></a><span>
</span><a name="line-709"></a><span class="hs-identifier">cvtLitNatural</span><span> </span><a name="local-6989586621682027390"><a href="#local-6989586621682027390"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682027391"><a href="#local-6989586621682027391"><span class="hs-identifier">mk_natural</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682027392"><a href="#local-6989586621682027392"><span class="hs-identifier">i</span></a></a><span>
</span><a name="line-710"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkApps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621682027391"><span class="hs-identifier hs-var">mk_natural</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682027393"><span class="hs-identifier hs-var">words</span></a><span class="hs-special">]</span><span>
</span><a name="line-711"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682027393"><a href="#local-6989586621682027393"><span class="hs-identifier">words</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkListExpr</span><span> </span><span class="hs-identifier hs-var">wordTy</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027394"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621682027392"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span>
</span><a name="line-712"></a><span>        </span><a name="local-6989586621682027394"><a href="#local-6989586621682027394"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-713"></a><span>        </span><span class="hs-identifier">f</span><span> </span><a name="local-6989586621682027397"><a href="#local-6989586621682027397"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682027398"><a href="#local-6989586621682027398"><span class="hs-identifier">low</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027397"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">.&amp;.</span><span> </span><a href="#local-6989586621682027396"><span class="hs-identifier hs-var">mask</span></a><span>
</span><a name="line-714"></a><span>                  </span><a name="local-6989586621682027399"><a href="#local-6989586621682027399"><span class="hs-identifier">high</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027397"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">shiftR</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682027395"><span class="hs-identifier hs-var">bits</span></a><span>
</span><a name="line-715"></a><span>              </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">mkConApp</span><span> </span><span class="hs-identifier hs-var">wordDataCon</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Lit</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLitWord</span><span> </span><a href="#local-6989586621682027390"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682027398"><span class="hs-identifier hs-var">low</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682027394"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621682027399"><span class="hs-identifier hs-var">high</span></a><span>
</span><a name="line-716"></a><span>        </span><a name="local-6989586621682027395"><a href="#local-6989586621682027395"><span class="hs-identifier">bits</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">32</span><span>
</span><a name="line-717"></a><span>        </span><a name="local-6989586621682027396"><a href="#local-6989586621682027396"><span class="hs-identifier">mask</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">^</span><span> </span><a href="#local-6989586621682027395"><span class="hs-identifier hs-var">bits</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-718"></a><span>
</span><a name="line-719"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-720"></a><span class="hs-comment">--              CpeBody: produces a result satisfying CpeBody</span><span>
</span><a name="line-721"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-722"></a><span>
</span><a name="line-723"></a><span class="hs-comment">-- | Convert a 'CoreExpr' so it satisfies 'CpeBody', without</span><span>
</span><a name="line-724"></a><span class="hs-comment">-- producing any floats (any generated floats are immediately</span><span>
</span><a name="line-725"></a><span class="hs-comment">-- let-bound using 'wrapBinds').  Generally you want this, esp.</span><span>
</span><a name="line-726"></a><span class="hs-comment">-- when you've reached a binding form (e.g., a lambda) and</span><span>
</span><a name="line-727"></a><span class="hs-comment">-- floating any further would be incorrect.</span><span>
</span><a name="line-728"></a><span class="hs-identifier">cpeBodyNF</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CorePrep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><a href="CorePrep.html#CpeBody"><span class="hs-identifier hs-type">CpeBody</span></a><span>
</span><a name="line-729"></a><a name="cpeBodyNF"><a href="CorePrep.html#cpeBodyNF"><span class="hs-identifier">cpeBodyNF</span></a></a><span> </span><a name="local-6989586621682027400"><a href="#local-6989586621682027400"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682027401"><a href="#local-6989586621682027401"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-730"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027402"><a href="#local-6989586621682027402"><span class="hs-identifier">floats</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027403"><a href="#local-6989586621682027403"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#cpeBody"><span class="hs-identifier hs-var">cpeBody</span></a><span> </span><a href="#local-6989586621682027400"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027401"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-731"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#wrapBinds"><span class="hs-identifier hs-var">wrapBinds</span></a><span> </span><a href="#local-6989586621682027402"><span class="hs-identifier hs-var">floats</span></a><span> </span><a href="#local-6989586621682027403"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-732"></a><span>
</span><a name="line-733"></a><span class="hs-comment">-- | Convert a 'CoreExpr' so it satisfies 'CpeBody'; also produce</span><span>
</span><a name="line-734"></a><span class="hs-comment">-- a list of 'Floats' which are being propagated upwards.  In</span><span>
</span><a name="line-735"></a><span class="hs-comment">-- fact, this function is used in only two cases: to</span><span>
</span><a name="line-736"></a><span class="hs-comment">-- implement 'cpeBodyNF' (which is what you usually want),</span><span>
</span><a name="line-737"></a><span class="hs-comment">-- and in the case when a let-binding is in a case scrutinee--here,</span><span>
</span><a name="line-738"></a><span class="hs-comment">-- we can always float out:</span><span>
</span><a name="line-739"></a><span class="hs-comment">--</span><span>
</span><a name="line-740"></a><span class="hs-comment">--      case (let x = y in z) of ...</span><span>
</span><a name="line-741"></a><span class="hs-comment">--      ==&gt; let x = y in case z of ...</span><span>
</span><a name="line-742"></a><span class="hs-comment">--</span><span>
</span><a name="line-743"></a><span class="hs-identifier">cpeBody</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CorePrep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span class="hs-special">,</span><span> </span><a href="CorePrep.html#CpeBody"><span class="hs-identifier hs-type">CpeBody</span></a><span class="hs-special">)</span><span>
</span><a name="line-744"></a><a name="cpeBody"><a href="CorePrep.html#cpeBody"><span class="hs-identifier">cpeBody</span></a></a><span> </span><a name="local-6989586621682027404"><a href="#local-6989586621682027404"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682027405"><a href="#local-6989586621682027405"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-745"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027406"><a href="#local-6989586621682027406"><span class="hs-identifier">floats1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027407"><a href="#local-6989586621682027407"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a><span> </span><a href="#local-6989586621682027404"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027405"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-746"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027408"><a href="#local-6989586621682027408"><span class="hs-identifier">floats2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027409"><a href="#local-6989586621682027409"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#rhsToBody"><span class="hs-identifier hs-var">rhsToBody</span></a><span> </span><a href="#local-6989586621682027407"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-747"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027406"><span class="hs-identifier hs-var">floats1</span></a><span> </span><span class="hs-special">`</span><a href="CorePrep.html#appendFloats"><span class="hs-identifier hs-var">appendFloats</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682027408"><span class="hs-identifier hs-var">floats2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027409"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-748"></a><span>
</span><a name="line-749"></a><span class="hs-comment">--------</span><span>
</span><a name="line-750"></a><span class="hs-identifier">rhsToBody</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CorePrep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span class="hs-special">,</span><span> </span><a href="CorePrep.html#CpeBody"><span class="hs-identifier hs-type">CpeBody</span></a><span class="hs-special">)</span><span>
</span><a name="line-751"></a><span class="hs-comment">-- Remove top level lambdas by let-binding</span><span>
</span><a name="line-752"></a><span>
</span><a name="line-753"></a><a name="rhsToBody"><a href="CorePrep.html#rhsToBody"><span class="hs-identifier">rhsToBody</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Tick</span><span> </span><a name="local-6989586621682027410"><a href="#local-6989586621682027410"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621682027411"><a href="#local-6989586621682027411"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-754"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">tickishScoped</span><span> </span><a href="#local-6989586621682027410"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">NoScope</span><span>  </span><span class="hs-comment">-- only float out of non-scoped annotations</span><span>
</span><a name="line-755"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027412"><a href="#local-6989586621682027412"><span class="hs-identifier">floats</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027413"><a href="#local-6989586621682027413"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#rhsToBody"><span class="hs-identifier hs-var">rhsToBody</span></a><span> </span><a href="#local-6989586621682027411"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-756"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027412"><span class="hs-identifier hs-var">floats</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkTick</span><span> </span><a href="#local-6989586621682027410"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621682027413"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-757"></a><span>
</span><a name="line-758"></a><span class="hs-identifier">rhsToBody</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Cast</span><span> </span><a name="local-6989586621682027414"><a href="#local-6989586621682027414"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621682027415"><a href="#local-6989586621682027415"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-759"></a><span>        </span><span class="hs-comment">-- You can get things like</span><span>
</span><a name="line-760"></a><span>        </span><span class="hs-comment">--      case e of { p -&gt; coerce t (\s -&gt; ...) }</span><span>
</span><a name="line-761"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027416"><a href="#local-6989586621682027416"><span class="hs-identifier">floats</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027417"><a href="#local-6989586621682027417"><span class="hs-identifier">e'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#rhsToBody"><span class="hs-identifier hs-var">rhsToBody</span></a><span> </span><a href="#local-6989586621682027414"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-762"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027416"><span class="hs-identifier hs-var">floats</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Cast</span><span> </span><a href="#local-6989586621682027417"><span class="hs-identifier hs-var">e'</span></a><span> </span><a href="#local-6989586621682027415"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-763"></a><span>
</span><a name="line-764"></a><span class="hs-identifier">rhsToBody</span><span> </span><a name="local-6989586621682027418"><a href="#local-6989586621682027418"><span class="hs-identifier">expr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Lam</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-765"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682027421"><a href="#local-6989586621682027421"><span class="hs-identifier">no_lam_result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#tryEtaReducePrep"><span class="hs-identifier hs-var">tryEtaReducePrep</span></a><span> </span><a href="#local-6989586621682027419"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621682027420"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-766"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027421"><span class="hs-identifier hs-var">no_lam_result</span></a><span class="hs-special">)</span><span>
</span><a name="line-767"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-identifier hs-var">isTyVar</span><span> </span><a href="#local-6989586621682027419"><span class="hs-identifier hs-var">bndrs</span></a><span>           </span><span class="hs-comment">-- Type lambdas are ok</span><span>
</span><a name="line-768"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027418"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-769"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                   </span><span class="hs-comment">-- Some value lambdas</span><span>
</span><a name="line-770"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682027422"><a href="#local-6989586621682027422"><span class="hs-identifier">fn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#newVar"><span class="hs-identifier hs-var">newVar</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprType</span><span> </span><a href="#local-6989586621682027418"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-771"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682027423"><a href="#local-6989586621682027423"><span class="hs-identifier">rhs</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#cpeEtaExpand"><span class="hs-identifier hs-var">cpeEtaExpand</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprArity</span><span> </span><a href="#local-6989586621682027418"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027418"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-772"></a><span>             </span><a name="local-6989586621682027424"><a href="#local-6989586621682027424"><span class="hs-identifier">float</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#FloatLet"><span class="hs-identifier hs-var">FloatLet</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621682027422"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621682027423"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-773"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#unitFloat"><span class="hs-identifier hs-var">unitFloat</span></a><span> </span><a href="#local-6989586621682027424"><span class="hs-identifier hs-var">float</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621682027422"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-774"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-775"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682027419"><a href="#local-6989586621682027419"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><a name="local-6989586621682027420"><a href="#local-6989586621682027420"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">collectBinders</span><span> </span><a href="#local-6989586621682027418"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-776"></a><span>
</span><a name="line-777"></a><span class="hs-identifier">rhsToBody</span><span> </span><a name="local-6989586621682027425"><a href="#local-6989586621682027425"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027425"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-778"></a><span>
</span><a name="line-779"></a><span>
</span><a name="line-780"></a><span>
</span><a name="line-781"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-782"></a><span class="hs-comment">--              CpeApp: produces a result satisfying CpeApp</span><span>
</span><a name="line-783"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-784"></a><span>
</span><a name="line-785"></a><span class="hs-keyword">data</span><span> </span><a name="ArgInfo"><a href="CorePrep.html#ArgInfo"><span class="hs-identifier">ArgInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="CpeApp"><a href="CorePrep.html#CpeApp"><span class="hs-identifier">CpeApp</span></a></a><span>  </span><span class="hs-identifier hs-type">CoreArg</span><span>
</span><a name="line-786"></a><span>             </span><span class="hs-glyph">|</span><span> </span><a name="CpeCast"><a href="CorePrep.html#CpeCast"><span class="hs-identifier">CpeCast</span></a></a><span> </span><span class="hs-identifier hs-type">Coercion</span><span>
</span><a name="line-787"></a><span>             </span><span class="hs-glyph">|</span><span> </span><a name="CpeTick"><a href="CorePrep.html#CpeTick"><span class="hs-identifier">CpeTick</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Tickish</span><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">)</span><span>
</span><a name="line-788"></a><span>
</span><a name="line-789"></a><span class="hs-comment">{- Note [runRW arg]
~~~~~~~~~~~~~~~~~~~
If we got, say
   runRW# (case bot of {})
which happened in Trac #11291, we do /not/ want to turn it into
   (case bot of {}) realWorldPrimId#
because that gives a panic in CoreToStg.myCollectArgs, which expects
only variables in function position.  But if we are sure to make
runRW# strict (which we do in MkId), this can't happen
-}</span><span>
</span><a name="line-799"></a><span>
</span><a name="line-800"></a><span class="hs-identifier">cpeApp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CorePrep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span class="hs-special">,</span><span> </span><a href="CorePrep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-801"></a><span class="hs-comment">-- May return a CpeRhs because of saturating primops</span><span>
</span><a name="line-802"></a><a name="cpeApp"><a href="CorePrep.html#cpeApp"><span class="hs-identifier">cpeApp</span></a></a><span> </span><a name="local-6989586621682027426"><a href="#local-6989586621682027426"><span class="hs-identifier">top_env</span></a></a><span> </span><a name="local-6989586621682027427"><a href="#local-6989586621682027427"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-803"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027519"><a href="#local-6989586621682027519"><span class="hs-identifier">terminal</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027520"><a href="#local-6989586621682027520"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027521"><a href="#local-6989586621682027521"><span class="hs-identifier">depth</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027428"><span class="hs-identifier hs-var">collect_args</span></a><span> </span><a href="#local-6989586621682027427"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-804"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621682027429"><span class="hs-identifier hs-var">cpe_app</span></a><span> </span><a href="#local-6989586621682027426"><span class="hs-identifier hs-var">top_env</span></a><span> </span><a href="#local-6989586621682027519"><span class="hs-identifier hs-var">terminal</span></a><span> </span><a href="#local-6989586621682027520"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621682027521"><span class="hs-identifier hs-var">depth</span></a><span>
</span><a name="line-805"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-806"></a><span>
</span><a name="line-807"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-808"></a><span>    </span><span class="hs-comment">-- We have a nested data structure of the form</span><span>
</span><a name="line-809"></a><span>    </span><span class="hs-comment">-- e `App` a1 `App` a2 ... `App` an, convert it into</span><span>
</span><a name="line-810"></a><span>    </span><span class="hs-comment">-- (e, [CpeApp a1, CpeApp a2, ..., CpeApp an], depth)</span><span>
</span><a name="line-811"></a><span>    </span><span class="hs-comment">-- We use 'ArgInfo' because we may also need to</span><span>
</span><a name="line-812"></a><span>    </span><span class="hs-comment">-- record casts and ticks.  Depth counts the number</span><span>
</span><a name="line-813"></a><span>    </span><span class="hs-comment">-- of arguments that would consume strictness information</span><span>
</span><a name="line-814"></a><span>    </span><span class="hs-comment">-- (so, no type or coercion arguments.)</span><span>
</span><a name="line-815"></a><span>    </span><span class="hs-identifier">collect_args</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CorePrep.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-816"></a><span>    </span><a name="local-6989586621682027428"><a href="#local-6989586621682027428"><span class="hs-identifier">collect_args</span></a></a><span> </span><a name="local-6989586621682027432"><a href="#local-6989586621682027432"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027433"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682027432"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-817"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-818"></a><span>        </span><a name="local-6989586621682027433"><a href="#local-6989586621682027433"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">App</span><span> </span><a name="local-6989586621682027434"><a href="#local-6989586621682027434"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621682027435"><a href="#local-6989586621682027435"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-keyword">as</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621682027437"><a href="#local-6989586621682027437"><span class="hs-identifier">depth</span></a></a><span>
</span><a name="line-819"></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027433"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682027434"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#CpeApp"><span class="hs-identifier hs-var">CpeApp</span></a><span> </span><a href="#local-6989586621682027435"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-820"></a><span>                </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isTyCoArg</span><span> </span><a href="#local-6989586621682027435"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621682027437"><span class="hs-identifier hs-var">depth</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621682027437"><span class="hs-identifier hs-var">depth</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-821"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Cast</span><span> </span><a name="local-6989586621682027438"><a href="#local-6989586621682027438"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621682027439"><a href="#local-6989586621682027439"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-keyword">as</span><span> </span><a name="local-6989586621682027441"><a href="#local-6989586621682027441"><span class="hs-identifier">depth</span></a></a><span>
</span><a name="line-822"></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027433"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682027438"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#CpeCast"><span class="hs-identifier hs-var">CpeCast</span></a><span> </span><a href="#local-6989586621682027439"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027441"><span class="hs-identifier hs-var">depth</span></a><span>
</span><a name="line-823"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Tick</span><span> </span><a name="local-6989586621682027442"><a href="#local-6989586621682027442"><span class="hs-identifier">tickish</span></a></a><span> </span><a name="local-6989586621682027443"><a href="#local-6989586621682027443"><span class="hs-identifier">fun</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span> </span><a name="local-6989586621682027445"><a href="#local-6989586621682027445"><span class="hs-identifier">depth</span></a></a><span>
</span><a name="line-824"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">tickishPlace</span><span> </span><a href="#local-6989586621682027442"><span class="hs-identifier hs-var">tickish</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">PlaceNonLam</span><span>
</span><a name="line-825"></a><span>            </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621682027442"><span class="hs-identifier hs-var">tickish</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">tickishScopesLike</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">SoftScope</span><span>
</span><a name="line-826"></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027433"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682027443"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#CpeTick"><span class="hs-identifier hs-var">CpeTick</span></a><span> </span><a href="#local-6989586621682027442"><span class="hs-identifier hs-var">tickish</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027445"><span class="hs-identifier hs-var">depth</span></a><span>
</span><a name="line-827"></a><span>        </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682027446"><a href="#local-6989586621682027446"><span class="hs-identifier">terminal</span></a></a><span> </span><span class="hs-keyword">as</span><span> </span><a name="local-6989586621682027448"><a href="#local-6989586621682027448"><span class="hs-identifier">depth</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027446"><span class="hs-identifier hs-var">terminal</span></a><span class="hs-special">,</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027448"><span class="hs-identifier hs-var">depth</span></a><span class="hs-special">)</span><span>
</span><a name="line-828"></a><span>
</span><a name="line-829"></a><span>    </span><span class="hs-identifier">cpe_app</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CorePrep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a><span>
</span><a name="line-830"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-831"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CorePrep.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a><span class="hs-special">]</span><span>
</span><a name="line-832"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-833"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span class="hs-special">,</span><span> </span><a href="CorePrep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-834"></a><span>    </span><a name="local-6989586621682027429"><a href="#local-6989586621682027429"><span class="hs-identifier">cpe_app</span></a></a><span> </span><a name="local-6989586621682027449"><a href="#local-6989586621682027449"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a name="local-6989586621682027450"><a href="#local-6989586621682027450"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#CpeApp"><span class="hs-identifier hs-var">CpeApp</span></a><span> </span><span class="hs-identifier hs-var">Type</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="CorePrep.html#CpeApp"><span class="hs-identifier hs-var">CpeApp</span></a><span> </span><a name="local-6989586621682027451"><a href="#local-6989586621682027451"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682027452"><a href="#local-6989586621682027452"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682027453"><a href="#local-6989586621682027453"><span class="hs-identifier">depth</span></a></a><span>
</span><a name="line-835"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682027450"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">lazyIdKey</span><span>          </span><span class="hs-comment">-- Replace (lazy a) with a, and</span><span>
</span><a name="line-836"></a><span>       </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621682027450"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">noinlineIdKey</span><span>      </span><span class="hs-comment">-- Replace (noinline a) with a</span><span>
</span><a name="line-837"></a><span>        </span><span class="hs-comment">-- Consider the code:</span><span>
</span><a name="line-838"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-839"></a><span>        </span><span class="hs-comment">--      lazy (f x) y</span><span>
</span><a name="line-840"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-841"></a><span>        </span><span class="hs-comment">-- We need to make sure that we need to recursively collect arguments on</span><span>
</span><a name="line-842"></a><span>        </span><span class="hs-comment">-- &quot;f x&quot;, otherwise we'll float &quot;f x&quot; out (it's not a variable) and</span><span>
</span><a name="line-843"></a><span>        </span><span class="hs-comment">-- end up with this awful -ddump-prep:</span><span>
</span><a name="line-844"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-845"></a><span>        </span><span class="hs-comment">--      case f x of f_x {</span><span>
</span><a name="line-846"></a><span>        </span><span class="hs-comment">--        __DEFAULT -&gt; f_x y</span><span>
</span><a name="line-847"></a><span>        </span><span class="hs-comment">--      }</span><span>
</span><a name="line-848"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-849"></a><span>        </span><span class="hs-comment">-- rather than the far superior &quot;f x y&quot;.  Test case is par01.</span><span>
</span><a name="line-850"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027454"><a href="#local-6989586621682027454"><span class="hs-identifier">terminal</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027455"><a href="#local-6989586621682027455"><span class="hs-identifier">args'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027456"><a href="#local-6989586621682027456"><span class="hs-identifier">depth'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027428"><span class="hs-identifier hs-var">collect_args</span></a><span> </span><a href="#local-6989586621682027451"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-851"></a><span>          </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621682027429"><span class="hs-identifier hs-var">cpe_app</span></a><span> </span><a href="#local-6989586621682027449"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027454"><span class="hs-identifier hs-var">terminal</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027455"><span class="hs-identifier hs-var">args'</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682027452"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027453"><span class="hs-identifier hs-var">depth</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621682027456"><span class="hs-identifier hs-var">depth'</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-852"></a><span>    </span><span class="hs-identifier">cpe_app</span><span> </span><a name="local-6989586621682027457"><a href="#local-6989586621682027457"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a name="local-6989586621682027458"><a href="#local-6989586621682027458"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="CorePrep.html#CpeApp"><span class="hs-identifier hs-var">CpeApp</span></a><span> </span><a name="local-6989586621682027459"><a href="#local-6989586621682027459"><span class="hs-identifier">_runtimeRep</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">Type</span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="CorePrep.html#CpeApp"><span class="hs-identifier hs-var">CpeApp</span></a><span> </span><a name="local-6989586621682027460"><a href="#local-6989586621682027460"><span class="hs-identifier">_type</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">Type</span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="CorePrep.html#CpeApp"><span class="hs-identifier hs-var">CpeApp</span></a><span> </span><a name="local-6989586621682027461"><a href="#local-6989586621682027461"><span class="hs-identifier">arg</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-853"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682027458"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">runRWKey</span><span>
</span><a name="line-854"></a><span>        </span><span class="hs-comment">-- See Note [runRW magic]</span><span>
</span><a name="line-855"></a><span>        </span><span class="hs-comment">-- Replace (runRW# f) by (f realWorld#), beta reducing if possible (this</span><span>
</span><a name="line-856"></a><span>        </span><span class="hs-comment">-- is why we return a CorePrepEnv as well)</span><span>
</span><a name="line-857"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682027461"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-858"></a><span>            </span><span class="hs-identifier hs-var">Lam</span><span> </span><a name="local-6989586621682027462"><a href="#local-6989586621682027462"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621682027463"><a href="#local-6989586621682027463"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682027429"><span class="hs-identifier hs-var">cpe_app</span></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#extendCorePrepEnv"><span class="hs-identifier hs-var">extendCorePrepEnv</span></a><span> </span><a href="#local-6989586621682027457"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027462"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-identifier hs-var">realWorldPrimId</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027463"><span class="hs-identifier hs-var">body</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-859"></a><span>            </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682027429"><span class="hs-identifier hs-var">cpe_app</span></a><span> </span><a href="#local-6989586621682027457"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027461"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-special">[</span><a href="CorePrep.html#CpeApp"><span class="hs-identifier hs-var">CpeApp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><span class="hs-identifier hs-var">realWorldPrimId</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-860"></a><span>    </span><span class="hs-identifier">cpe_app</span><span> </span><a name="local-6989586621682027464"><a href="#local-6989586621682027464"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a name="local-6989586621682027465"><a href="#local-6989586621682027465"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682027466"><a href="#local-6989586621682027466"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621682027467"><a href="#local-6989586621682027467"><span class="hs-identifier">depth</span></a></a><span>
</span><a name="line-861"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682027470"><a href="#local-6989586621682027470"><span class="hs-identifier">v1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#fiddleCCall"><span class="hs-identifier hs-var">fiddleCCall</span></a><span> </span><a href="#local-6989586621682027465"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-862"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682027471"><a href="#local-6989586621682027471"><span class="hs-identifier">e2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#lookupCorePrepEnv"><span class="hs-identifier hs-var">lookupCorePrepEnv</span></a><span> </span><a href="#local-6989586621682027464"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027470"><span class="hs-identifier hs-var">v1</span></a><span>
</span><a name="line-863"></a><span>                 </span><a name="local-6989586621682027472"><a href="#local-6989586621682027472"><span class="hs-identifier">hd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getIdFromTrivialExpr_maybe</span><span> </span><a href="#local-6989586621682027471"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-864"></a><span>           </span><span class="hs-comment">-- NB: depth from collect_args is right, because e2 is a trivial expression</span><span>
</span><a name="line-865"></a><span>           </span><span class="hs-comment">-- and thus its embedded Id *must* be at the same depth as any</span><span>
</span><a name="line-866"></a><span>           </span><span class="hs-comment">-- Apps it is under are type applications only (c.f.</span><span>
</span><a name="line-867"></a><span>           </span><span class="hs-comment">-- exprIsTrivial).  But note that we need the type of the</span><span>
</span><a name="line-868"></a><span>           </span><span class="hs-comment">-- expression, not the id.</span><span>
</span><a name="line-869"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027473"><a href="#local-6989586621682027473"><span class="hs-identifier">app</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027474"><a href="#local-6989586621682027474"><span class="hs-identifier">floats</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682027431"><span class="hs-identifier hs-var">rebuild_app</span></a><span> </span><a href="#local-6989586621682027466"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621682027471"><span class="hs-identifier hs-var">e2</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprType</span><span> </span><a href="#local-6989586621682027471"><span class="hs-identifier hs-var">e2</span></a><span class="hs-special">)</span><span> </span><a href="CorePrep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a><span> </span><a href="#local-6989586621682027468"><span class="hs-identifier hs-var">stricts</span></a><span>
</span><a name="line-870"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621682027430"><span class="hs-identifier hs-var">mb_saturate</span></a><span> </span><a href="#local-6989586621682027472"><span class="hs-identifier hs-var">hd</span></a><span> </span><a href="#local-6989586621682027473"><span class="hs-identifier hs-var">app</span></a><span> </span><a href="#local-6989586621682027474"><span class="hs-identifier hs-var">floats</span></a><span> </span><a href="#local-6989586621682027467"><span class="hs-identifier hs-var">depth</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-871"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-872"></a><span>          </span><a name="local-6989586621682027468"><a href="#local-6989586621682027468"><span class="hs-identifier">stricts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">idStrictness</span><span> </span><a href="#local-6989586621682027465"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-873"></a><span>                            </span><span class="hs-identifier hs-var">StrictSig</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DmdType</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682027469"><a href="#local-6989586621682027469"><span class="hs-identifier">demands</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-874"></a><span>                              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">listLengthCmp</span><span> </span><a href="#local-6989586621682027469"><span class="hs-identifier hs-var">demands</span></a><span> </span><a href="#local-6989586621682027467"><span class="hs-identifier hs-var">depth</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">GT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682027469"><span class="hs-identifier hs-var">demands</span></a><span>
</span><a name="line-875"></a><span>                                    </span><span class="hs-comment">-- length demands &lt;= depth</span><span>
</span><a name="line-876"></a><span>                              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-877"></a><span>                </span><span class="hs-comment">-- If depth &lt; length demands, then we have too few args to</span><span>
</span><a name="line-878"></a><span>                </span><span class="hs-comment">-- satisfy strictness  info so we have to  ignore all the</span><span>
</span><a name="line-879"></a><span>                </span><span class="hs-comment">-- strictness info, e.g. + (error &quot;urk&quot;)</span><span>
</span><a name="line-880"></a><span>                </span><span class="hs-comment">-- Here, we can't evaluate the arg strictly, because this</span><span>
</span><a name="line-881"></a><span>                </span><span class="hs-comment">-- partial application might be seq'd</span><span>
</span><a name="line-882"></a><span>
</span><a name="line-883"></a><span>        </span><span class="hs-comment">-- We inlined into something that's not a var and has no args.</span><span>
</span><a name="line-884"></a><span>        </span><span class="hs-comment">-- Bounce it back up to cpeRhsE.</span><span>
</span><a name="line-885"></a><span>    </span><span class="hs-identifier">cpe_app</span><span> </span><a name="local-6989586621682027475"><a href="#local-6989586621682027475"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682027476"><a href="#local-6989586621682027476"><span class="hs-identifier">fun</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a><span> </span><a href="#local-6989586621682027475"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027476"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-886"></a><span>
</span><a name="line-887"></a><span>        </span><span class="hs-comment">-- N-variable fun, better let-bind it</span><span>
</span><a name="line-888"></a><span>    </span><span class="hs-identifier">cpe_app</span><span> </span><a name="local-6989586621682027477"><a href="#local-6989586621682027477"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682027478"><a href="#local-6989586621682027478"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621682027479"><a href="#local-6989586621682027479"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621682027480"><a href="#local-6989586621682027480"><span class="hs-identifier">depth</span></a></a><span>
</span><a name="line-889"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027482"><a href="#local-6989586621682027482"><span class="hs-identifier">fun_floats</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027483"><a href="#local-6989586621682027483"><span class="hs-identifier">fun'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#cpeArg"><span class="hs-identifier hs-var">cpeArg</span></a><span> </span><a href="#local-6989586621682027477"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-identifier hs-var">evalDmd</span><span> </span><a href="#local-6989586621682027478"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621682027481"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-890"></a><span>                          </span><span class="hs-comment">-- The evalDmd says that it's sure to be evaluated,</span><span>
</span><a name="line-891"></a><span>                          </span><span class="hs-comment">-- so we'll end up case-binding it</span><span>
</span><a name="line-892"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027484"><a href="#local-6989586621682027484"><span class="hs-identifier">app</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027485"><a href="#local-6989586621682027485"><span class="hs-identifier">floats</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682027431"><span class="hs-identifier hs-var">rebuild_app</span></a><span> </span><a href="#local-6989586621682027479"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621682027483"><span class="hs-identifier hs-var">fun'</span></a><span> </span><a href="#local-6989586621682027481"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621682027482"><span class="hs-identifier hs-var">fun_floats</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-893"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621682027430"><span class="hs-identifier hs-var">mb_saturate</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621682027484"><span class="hs-identifier hs-var">app</span></a><span> </span><a href="#local-6989586621682027485"><span class="hs-identifier hs-var">floats</span></a><span> </span><a href="#local-6989586621682027480"><span class="hs-identifier hs-var">depth</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-894"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-895"></a><span>          </span><a name="local-6989586621682027481"><a href="#local-6989586621682027481"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">exprType</span><span> </span><a href="#local-6989586621682027478"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-896"></a><span>
</span><a name="line-897"></a><span>    </span><span class="hs-comment">-- Saturate if necessary</span><span>
</span><a name="line-898"></a><span>    </span><a name="local-6989586621682027430"><a href="#local-6989586621682027430"><span class="hs-identifier">mb_saturate</span></a></a><span> </span><a name="local-6989586621682027486"><a href="#local-6989586621682027486"><span class="hs-identifier">head</span></a></a><span> </span><a name="local-6989586621682027487"><a href="#local-6989586621682027487"><span class="hs-identifier">app</span></a></a><span> </span><a name="local-6989586621682027488"><a href="#local-6989586621682027488"><span class="hs-identifier">floats</span></a></a><span> </span><a name="local-6989586621682027489"><a href="#local-6989586621682027489"><span class="hs-identifier">depth</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-899"></a><span>       </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682027486"><span class="hs-identifier hs-var">head</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-900"></a><span>         </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682027490"><a href="#local-6989586621682027490"><span class="hs-identifier">fn_id</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682027491"><a href="#local-6989586621682027491"><span class="hs-identifier">sat_app</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#maybeSaturate"><span class="hs-identifier hs-var">maybeSaturate</span></a><span> </span><a href="#local-6989586621682027490"><span class="hs-identifier hs-var">fn_id</span></a><span> </span><a href="#local-6989586621682027487"><span class="hs-identifier hs-var">app</span></a><span> </span><a href="#local-6989586621682027489"><span class="hs-identifier hs-var">depth</span></a><span>
</span><a name="line-901"></a><span>                          </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027488"><span class="hs-identifier hs-var">floats</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027491"><span class="hs-identifier hs-var">sat_app</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-902"></a><span>         </span><a name="local-6989586621682027492"><a href="#local-6989586621682027492"><span class="hs-identifier">_other</span></a></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027488"><span class="hs-identifier hs-var">floats</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027487"><span class="hs-identifier hs-var">app</span></a><span class="hs-special">)</span><span>
</span><a name="line-903"></a><span>
</span><a name="line-904"></a><span>    </span><span class="hs-comment">-- Deconstruct and rebuild the application, floating any non-atomic</span><span>
</span><a name="line-905"></a><span>    </span><span class="hs-comment">-- arguments to the outside.  We collect the type of the expression,</span><span>
</span><a name="line-906"></a><span>    </span><span class="hs-comment">-- the head of the application, and the number of actual value arguments,</span><span>
</span><a name="line-907"></a><span>    </span><span class="hs-comment">-- all of which are used to possibly saturate this application if it</span><span>
</span><a name="line-908"></a><span>    </span><span class="hs-comment">-- has a constructor or primop at the head.</span><span>
</span><a name="line-909"></a><span>    </span><span class="hs-identifier">rebuild_app</span><span>
</span><a name="line-910"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CorePrep.html#ArgInfo"><span class="hs-identifier hs-type">ArgInfo</span></a><span class="hs-special">]</span><span>                  </span><span class="hs-comment">-- The arguments (inner to outer)</span><span>
</span><a name="line-911"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#CpeApp"><span class="hs-identifier hs-type">CpeApp</span></a><span>
</span><a name="line-912"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-913"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span>
</span><a name="line-914"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Demand</span><span class="hs-special">]</span><span>
</span><a name="line-915"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#CpeApp"><span class="hs-identifier hs-type">CpeApp</span></a><span class="hs-special">,</span><span> </span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span class="hs-special">)</span><span>
</span><a name="line-916"></a><span>    </span><a name="local-6989586621682027431"><a href="#local-6989586621682027431"><span class="hs-identifier">rebuild_app</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621682027493"><a href="#local-6989586621682027493"><span class="hs-identifier">app</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682027494"><a href="#local-6989586621682027494"><span class="hs-identifier">floats</span></a></a><span> </span><a name="local-6989586621682027495"><a href="#local-6989586621682027495"><span class="hs-identifier">ss</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-917"></a><span>      </span><span class="hs-identifier">MASSERT</span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-identifier hs-var">ss</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- make sure we used all the strictness info</span><span>
</span><a name="line-918"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027493"><span class="hs-identifier hs-var">app</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027494"><span class="hs-identifier hs-var">floats</span></a><span class="hs-special">)</span><span>
</span><a name="line-919"></a><span>    </span><span class="hs-identifier">rebuild_app</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027496"><a href="#local-6989586621682027496"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682027498"><a href="#local-6989586621682027498"><span class="hs-identifier">fun'</span></a></a><span> </span><a name="local-6989586621682027499"><a href="#local-6989586621682027499"><span class="hs-identifier">fun_ty</span></a></a><span> </span><a name="local-6989586621682027500"><a href="#local-6989586621682027500"><span class="hs-identifier">floats</span></a></a><span> </span><a name="local-6989586621682027501"><a href="#local-6989586621682027501"><span class="hs-identifier">ss</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682027496"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-920"></a><span>      </span><a href="CorePrep.html#CpeApp"><span class="hs-identifier hs-var">CpeApp</span></a><span> </span><a name="local-6989586621682027502"><a href="#local-6989586621682027502"><span class="hs-identifier">arg</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Type</span><span> </span><a name="local-6989586621682027503"><a href="#local-6989586621682027503"><span class="hs-identifier">arg_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-921"></a><span>        </span><a href="#local-6989586621682027431"><span class="hs-identifier hs-var">rebuild_app</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">App</span><span> </span><a href="#local-6989586621682027498"><span class="hs-identifier hs-var">fun'</span></a><span> </span><a href="#local-6989586621682027502"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">piResultTy</span><span> </span><a href="#local-6989586621682027499"><span class="hs-identifier hs-var">fun_ty</span></a><span> </span><a href="#local-6989586621682027503"><span class="hs-identifier hs-var">arg_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027500"><span class="hs-identifier hs-var">floats</span></a><span> </span><a href="#local-6989586621682027501"><span class="hs-identifier hs-var">ss</span></a><span>
</span><a name="line-922"></a><span>      </span><a href="CorePrep.html#CpeApp"><span class="hs-identifier hs-var">CpeApp</span></a><span> </span><a name="local-6989586621682027504"><a href="#local-6989586621682027504"><span class="hs-identifier">arg</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Coercion</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-923"></a><span>        </span><a href="#local-6989586621682027431"><span class="hs-identifier hs-var">rebuild_app</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">App</span><span> </span><a href="#local-6989586621682027498"><span class="hs-identifier hs-var">fun'</span></a><span> </span><a href="#local-6989586621682027504"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">funResultTy</span><span> </span><a href="#local-6989586621682027499"><span class="hs-identifier hs-var">fun_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027500"><span class="hs-identifier hs-var">floats</span></a><span> </span><a href="#local-6989586621682027501"><span class="hs-identifier hs-var">ss</span></a><span>
</span><a name="line-924"></a><span>      </span><a href="CorePrep.html#CpeApp"><span class="hs-identifier hs-var">CpeApp</span></a><span> </span><a name="local-6989586621682027505"><a href="#local-6989586621682027505"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-925"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027506"><a href="#local-6989586621682027506"><span class="hs-identifier">ss1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027507"><a href="#local-6989586621682027507"><span class="hs-identifier">ss_rest</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- See Note [lazyId magic] in MkId</span><span>
</span><a name="line-926"></a><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027501"><span class="hs-identifier hs-var">ss</span></a><span class="hs-special">,</span><span> </span><a href="CorePrep.html#isLazyExpr"><span class="hs-identifier hs-var">isLazyExpr</span></a><span> </span><a href="#local-6989586621682027505"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-927"></a><span>                   </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682027510"><a href="#local-6989586621682027510"><span class="hs-identifier">ss_rest</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">topDmd</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027510"><span class="hs-identifier hs-var">ss_rest</span></a><span class="hs-special">)</span><span>
</span><a name="line-928"></a><span>                   </span><span class="hs-special">(</span><a name="local-6989586621682027511"><a href="#local-6989586621682027511"><span class="hs-identifier">ss1</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682027512"><a href="#local-6989586621682027512"><span class="hs-identifier">ss_rest</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027511"><span class="hs-identifier hs-var">ss1</span></a><span class="hs-special">,</span><span>    </span><a href="#local-6989586621682027512"><span class="hs-identifier hs-var">ss_rest</span></a><span class="hs-special">)</span><span>
</span><a name="line-929"></a><span>                   </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>            </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">topDmd</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-930"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621682027508"><a href="#local-6989586621682027508"><span class="hs-identifier">arg_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027509"><a href="#local-6989586621682027509"><span class="hs-identifier">res_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">expectJust</span><span> </span><span class="hs-string">&quot;cpeBody:collect_args&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-931"></a><span>                               </span><span class="hs-identifier hs-var">splitFunTy_maybe</span><span> </span><a href="#local-6989586621682027499"><span class="hs-identifier hs-var">fun_ty</span></a><span>
</span><a name="line-932"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621682027513"><a href="#local-6989586621682027513"><span class="hs-identifier">fs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027514"><a href="#local-6989586621682027514"><span class="hs-identifier">arg'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#cpeArg"><span class="hs-identifier hs-var">cpeArg</span></a><span> </span><a href="#local-6989586621682027426"><span class="hs-identifier hs-var">top_env</span></a><span> </span><a href="#local-6989586621682027506"><span class="hs-identifier hs-var">ss1</span></a><span> </span><a href="#local-6989586621682027505"><span class="hs-identifier hs-var">arg</span></a><span> </span><a href="#local-6989586621682027508"><span class="hs-identifier hs-var">arg_ty</span></a><span>
</span><a name="line-933"></a><span>        </span><a href="#local-6989586621682027431"><span class="hs-identifier hs-var">rebuild_app</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">App</span><span> </span><a href="#local-6989586621682027498"><span class="hs-identifier hs-var">fun'</span></a><span> </span><a href="#local-6989586621682027514"><span class="hs-identifier hs-var">arg'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027509"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027513"><span class="hs-identifier hs-var">fs</span></a><span> </span><span class="hs-special">`</span><a href="CorePrep.html#appendFloats"><span class="hs-identifier hs-var">appendFloats</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682027500"><span class="hs-identifier hs-var">floats</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027507"><span class="hs-identifier hs-var">ss_rest</span></a><span>
</span><a name="line-934"></a><span>      </span><a href="CorePrep.html#CpeCast"><span class="hs-identifier hs-var">CpeCast</span></a><span> </span><a name="local-6989586621682027515"><a href="#local-6989586621682027515"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-935"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier hs-var">Pair</span><span> </span><a name="local-6989586621682027516"><a href="#local-6989586621682027516"><span class="hs-identifier">_ty1</span></a></a><span> </span><a name="local-6989586621682027517"><a href="#local-6989586621682027517"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">coercionKind</span><span> </span><a href="#local-6989586621682027515"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-936"></a><span>        </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621682027431"><span class="hs-identifier hs-var">rebuild_app</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Cast</span><span> </span><a href="#local-6989586621682027498"><span class="hs-identifier hs-var">fun'</span></a><span> </span><a href="#local-6989586621682027515"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027517"><span class="hs-identifier hs-var">ty2</span></a><span> </span><a href="#local-6989586621682027500"><span class="hs-identifier hs-var">floats</span></a><span> </span><a href="#local-6989586621682027501"><span class="hs-identifier hs-var">ss</span></a><span>
</span><a name="line-937"></a><span>      </span><a href="CorePrep.html#CpeTick"><span class="hs-identifier hs-var">CpeTick</span></a><span> </span><a name="local-6989586621682027518"><a href="#local-6989586621682027518"><span class="hs-identifier">tickish</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-938"></a><span>        </span><span class="hs-comment">-- See [Floating Ticks in CorePrep]</span><span>
</span><a name="line-939"></a><span>        </span><a href="#local-6989586621682027431"><span class="hs-identifier hs-var">rebuild_app</span></a><span> </span><span class="hs-keyword">as</span><span> </span><a href="#local-6989586621682027498"><span class="hs-identifier hs-var">fun'</span></a><span> </span><a href="#local-6989586621682027499"><span class="hs-identifier hs-var">fun_ty</span></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#addFloat"><span class="hs-identifier hs-var">addFloat</span></a><span> </span><a href="#local-6989586621682027500"><span class="hs-identifier hs-var">floats</span></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#FloatTick"><span class="hs-identifier hs-var">FloatTick</span></a><span> </span><a href="#local-6989586621682027518"><span class="hs-identifier hs-var">tickish</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027501"><span class="hs-identifier hs-var">ss</span></a><span>
</span><a name="line-940"></a><span>
</span><a name="line-941"></a><span class="hs-identifier">isLazyExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-942"></a><span class="hs-comment">-- See Note [lazyId magic] in MkId</span><span>
</span><a name="line-943"></a><a name="isLazyExpr"><a href="CorePrep.html#isLazyExpr"><span class="hs-identifier">isLazyExpr</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Cast</span><span> </span><a name="local-6989586621682027522"><a href="#local-6989586621682027522"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#isLazyExpr"><span class="hs-identifier hs-var">isLazyExpr</span></a><span> </span><a href="#local-6989586621682027522"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-944"></a><span class="hs-identifier">isLazyExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Tick</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682027523"><a href="#local-6989586621682027523"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#isLazyExpr"><span class="hs-identifier hs-var">isLazyExpr</span></a><span> </span><a href="#local-6989586621682027523"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-945"></a><span class="hs-identifier">isLazyExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a name="local-6989586621682027524"><a href="#local-6989586621682027524"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">App</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">App</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027524"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">lazyIdKey</span><span>
</span><a name="line-946"></a><span class="hs-identifier">isLazyExpr</span><span> </span><span class="hs-identifier">_</span><span>                       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-947"></a><span>
</span><a name="line-948"></a><span class="hs-comment">{- Note [runRW magic]
~~~~~~~~~~~~~~~~~~~~~
Some definitions, for instance @runST@, must have careful control over float out
of the bindings in their body. Consider this use of @runST@,

    f x = runST ( \ s -&gt; let (a, s')  = newArray# 100 [] s
                             (_, s'') = fill_in_array_or_something a x s'
                         in freezeArray# a s'' )

If we inline @runST@, we'll get:

    f x = let (a, s')  = newArray# 100 [] realWorld#{-NB-}
              (_, s'') = fill_in_array_or_something a x s'
          in freezeArray# a s''

And now if we allow the @newArray#@ binding to float out to become a CAF,
we end up with a result that is totally and utterly wrong:

    f = let (a, s')  = newArray# 100 [] realWorld#{-NB-} -- YIKES!!!
        in \ x -&gt;
            let (_, s'') = fill_in_array_or_something a x s'
            in freezeArray# a s''

All calls to @f@ will share a {\em single} array! Clearly this is nonsense and
must be prevented.

This is what @runRW#@ gives us: by being inlined extremely late in the
optimization (right before lowering to STG, in CorePrep), we can ensure that
no further floating will occur. This allows us to safely inline things like
@runST@, which are otherwise needlessly expensive (see #10678 and #5916).

'runRW' is defined (for historical reasons) in GHC.Magic, with a NOINLINE
pragma.  It is levity-polymorphic.

    runRW# :: forall (r1 :: RuntimeRep). (o :: TYPE r)
           =&gt; (State# RealWorld -&gt; (# State# RealWorld, o #))
                              -&gt; (# State# RealWorld, o #)

It needs no special treatment in GHC except this special inlining here
in CorePrep (and in ByteCodeGen).

-- ---------------------------------------------------------------------------
--      CpeArg: produces a result satisfying CpeArg
-- ---------------------------------------------------------------------------

Note [ANF-ising literal string arguments]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Consider a program like,

    data Foo = Foo Addr#

    foo = Foo &quot;turtle&quot;#

When we go to ANFise this we might think that we want to float the string
literal like we do any other non-trivial argument. This would look like,

    foo = u\ [] case &quot;turtle&quot;# of s { __DEFAULT__ -&gt; Foo s }

However, this 1) isn't necessary since strings are in a sense &quot;trivial&quot;; and 2)
wreaks havoc on the CAF annotations that we produce here since we the result
above is caffy since it is updateable. Ideally at some point in the future we
would like to just float the literal to the top level as suggested in #11312,

    s = &quot;turtle&quot;#
    foo = Foo s

However, until then we simply add a special case excluding literals from the
floating done by cpeArg.
-}</span><span>
</span><a name="line-1018"></a><span>
</span><a name="line-1019"></a><span class="hs-comment">-- | Is an argument okay to CPE?</span><span>
</span><a name="line-1020"></a><span class="hs-identifier">okCpeArg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1021"></a><span class="hs-comment">-- Don't float literals. See Note [ANF-ising literal string arguments].</span><span>
</span><a name="line-1022"></a><a name="okCpeArg"><a href="CorePrep.html#okCpeArg"><span class="hs-identifier">okCpeArg</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Lit</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1023"></a><span class="hs-comment">-- Do not eta expand a trivial argument</span><span>
</span><a name="line-1024"></a><span class="hs-identifier">okCpeArg</span><span> </span><a name="local-6989586621682027525"><a href="#local-6989586621682027525"><span class="hs-identifier">expr</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprIsTrivial</span><span> </span><a href="#local-6989586621682027525"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1025"></a><span>
</span><a name="line-1026"></a><span class="hs-comment">-- This is where we arrange that a non-trivial argument is let-bound</span><span>
</span><a name="line-1027"></a><span class="hs-identifier">cpeArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CorePrep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Demand</span><span>
</span><a name="line-1028"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreArg</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span class="hs-special">,</span><span> </span><a href="CorePrep.html#CpeArg"><span class="hs-identifier hs-type">CpeArg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1029"></a><a name="cpeArg"><a href="CorePrep.html#cpeArg"><span class="hs-identifier">cpeArg</span></a></a><span> </span><a name="local-6989586621682027526"><a href="#local-6989586621682027526"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682027527"><a href="#local-6989586621682027527"><span class="hs-identifier">dmd</span></a></a><span> </span><a name="local-6989586621682027528"><a href="#local-6989586621682027528"><span class="hs-identifier">arg</span></a></a><span> </span><a name="local-6989586621682027529"><a href="#local-6989586621682027529"><span class="hs-identifier">arg_ty</span></a></a><span>
</span><a name="line-1030"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027532"><a href="#local-6989586621682027532"><span class="hs-identifier">floats1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027533"><a href="#local-6989586621682027533"><span class="hs-identifier">arg1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#cpeRhsE"><span class="hs-identifier hs-var">cpeRhsE</span></a><span> </span><a href="#local-6989586621682027526"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027528"><span class="hs-identifier hs-var">arg</span></a><span>     </span><span class="hs-comment">-- arg1 can be a lambda</span><span>
</span><a name="line-1031"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027534"><a href="#local-6989586621682027534"><span class="hs-identifier">floats2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027535"><a href="#local-6989586621682027535"><span class="hs-identifier">arg2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682027531"><span class="hs-identifier hs-var">want_float</span></a><span> </span><a href="#local-6989586621682027532"><span class="hs-identifier hs-var">floats1</span></a><span> </span><a href="#local-6989586621682027533"><span class="hs-identifier hs-var">arg1</span></a><span>
</span><a name="line-1032"></a><span>                            </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027532"><span class="hs-identifier hs-var">floats1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027533"><span class="hs-identifier hs-var">arg1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1033"></a><span>                            </span><span class="hs-keyword">else</span><span> </span><a href="CorePrep.html#dontFloat"><span class="hs-identifier hs-var">dontFloat</span></a><span> </span><a href="#local-6989586621682027532"><span class="hs-identifier hs-var">floats1</span></a><span> </span><a href="#local-6989586621682027533"><span class="hs-identifier hs-var">arg1</span></a><span>
</span><a name="line-1034"></a><span>                </span><span class="hs-comment">-- Else case: arg1 might have lambdas, and we can't</span><span>
</span><a name="line-1035"></a><span>                </span><span class="hs-comment">--            put them inside a wrapBinds</span><span>
</span><a name="line-1036"></a><span>
</span><a name="line-1037"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="CorePrep.html#okCpeArg"><span class="hs-identifier hs-var">okCpeArg</span></a><span> </span><a href="#local-6989586621682027535"><span class="hs-identifier hs-var">arg2</span></a><span>
</span><a name="line-1038"></a><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682027536"><a href="#local-6989586621682027536"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#newVar"><span class="hs-identifier hs-var">newVar</span></a><span> </span><a href="#local-6989586621682027529"><span class="hs-identifier hs-var">arg_ty</span></a><span>
</span><a name="line-1039"></a><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682027537"><a href="#local-6989586621682027537"><span class="hs-identifier">arg3</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#cpeEtaExpand"><span class="hs-identifier hs-var">cpeEtaExpand</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprArity</span><span> </span><a href="#local-6989586621682027535"><span class="hs-identifier hs-var">arg2</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027535"><span class="hs-identifier hs-var">arg2</span></a><span>
</span><a name="line-1040"></a><span>                       </span><a name="local-6989586621682027538"><a href="#local-6989586621682027538"><span class="hs-identifier">arg_float</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#mkFloat"><span class="hs-identifier hs-var">mkFloat</span></a><span> </span><a href="#local-6989586621682027527"><span class="hs-identifier hs-var">dmd</span></a><span> </span><a href="#local-6989586621682027530"><span class="hs-identifier hs-var">is_unlifted</span></a><span> </span><a href="#local-6989586621682027536"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621682027537"><span class="hs-identifier hs-var">arg3</span></a><span>
</span><a name="line-1041"></a><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#addFloat"><span class="hs-identifier hs-var">addFloat</span></a><span> </span><a href="#local-6989586621682027534"><span class="hs-identifier hs-var">floats2</span></a><span> </span><a href="#local-6989586621682027538"><span class="hs-identifier hs-var">arg_float</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">varToCoreExpr</span><span> </span><a href="#local-6989586621682027536"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1042"></a><span>         </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027534"><span class="hs-identifier hs-var">floats2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027535"><span class="hs-identifier hs-var">arg2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1043"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-1044"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1045"></a><span>    </span><a name="local-6989586621682027530"><a href="#local-6989586621682027530"><span class="hs-identifier">is_unlifted</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isUnliftedType</span><span> </span><a href="#local-6989586621682027529"><span class="hs-identifier hs-var">arg_ty</span></a><span>
</span><a name="line-1046"></a><span>    </span><a name="local-6989586621682027531"><a href="#local-6989586621682027531"><span class="hs-identifier">want_float</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#wantFloatNested"><span class="hs-identifier hs-var">wantFloatNested</span></a><span> </span><span class="hs-identifier hs-var">NonRecursive</span><span> </span><a href="#local-6989586621682027527"><span class="hs-identifier hs-var">dmd</span></a><span> </span><a href="#local-6989586621682027530"><span class="hs-identifier hs-var">is_unlifted</span></a><span>
</span><a name="line-1047"></a><span>
</span><a name="line-1048"></a><span class="hs-comment">{-
Note [Floating unlifted arguments]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider    C (let v* = expensive in v)

where the &quot;*&quot; indicates &quot;will be demanded&quot;.  Usually v will have been
inlined by now, but let's suppose it hasn't (see Trac #2756).  Then we
do *not* want to get

     let v* = expensive in C v

because that has different strictness.  Hence the use of 'allLazy'.
(NB: the let v* turns into a FloatCase, in mkLocalNonRec.)


------------------------------------------------------------------------------
-- Building the saturated syntax
-- ---------------------------------------------------------------------------

maybeSaturate deals with saturating primops and constructors
The type is the type of the entire application
-}</span><span>
</span><a name="line-1070"></a><span>
</span><a name="line-1071"></a><span class="hs-identifier">maybeSaturate</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#CpeApp"><span class="hs-identifier hs-type">CpeApp</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><a href="CorePrep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a><span>
</span><a name="line-1072"></a><a name="maybeSaturate"><a href="CorePrep.html#maybeSaturate"><span class="hs-identifier">maybeSaturate</span></a></a><span> </span><a name="local-6989586621682027539"><a href="#local-6989586621682027539"><span class="hs-identifier">fn</span></a></a><span> </span><a name="local-6989586621682027540"><a href="#local-6989586621682027540"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621682027541"><a href="#local-6989586621682027541"><span class="hs-identifier">n_args</span></a></a><span>
</span><a name="line-1073"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">hasNoBinding</span><span> </span><a href="#local-6989586621682027539"><span class="hs-identifier hs-var">fn</span></a><span>        </span><span class="hs-comment">-- There's no binding</span><span>
</span><a name="line-1074"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682027544"><span class="hs-identifier hs-var">sat_expr</span></a><span>
</span><a name="line-1075"></a><span>
</span><a name="line-1076"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1077"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682027540"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-1078"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1079"></a><span>    </span><a name="local-6989586621682027542"><a href="#local-6989586621682027542"><span class="hs-identifier">fn_arity</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idArity</span><span> </span><a href="#local-6989586621682027539"><span class="hs-identifier hs-var">fn</span></a><span>
</span><a name="line-1080"></a><span>    </span><a name="local-6989586621682027543"><a href="#local-6989586621682027543"><span class="hs-identifier">excess_arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027542"><span class="hs-identifier hs-var">fn_arity</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621682027541"><span class="hs-identifier hs-var">n_args</span></a><span>
</span><a name="line-1081"></a><span>    </span><a name="local-6989586621682027544"><a href="#local-6989586621682027544"><span class="hs-identifier">sat_expr</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#cpeEtaExpand"><span class="hs-identifier hs-var">cpeEtaExpand</span></a><span> </span><a href="#local-6989586621682027543"><span class="hs-identifier hs-var">excess_arity</span></a><span> </span><a href="#local-6989586621682027540"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-1082"></a><span>
</span><a name="line-1083"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Simple CoreSyn operations
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1090"></a><span>
</span><a name="line-1091"></a><span class="hs-comment">{-
-- -----------------------------------------------------------------------------
--      Eta reduction
-- -----------------------------------------------------------------------------

Note [Eta expansion]
~~~~~~~~~~~~~~~~~~~~~
Eta expand to match the arity claimed by the binder Remember,
CorePrep must not change arity

Eta expansion might not have happened already, because it is done by
the simplifier only when there at least one lambda already.

NB1:we could refrain when the RHS is trivial (which can happen
    for exported things).  This would reduce the amount of code
    generated (a little) and make things a little words for
    code compiled without -O.  The case in point is data constructor
    wrappers.

NB2: we have to be careful that the result of etaExpand doesn't
   invalidate any of the assumptions that CorePrep is attempting
   to establish.  One possible cause is eta expanding inside of
   an SCC note - we're now careful in etaExpand to make sure the
   SCC is pushed inside any new lambdas that are generated.

Note [Eta expansion and the CorePrep invariants]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It turns out to be much much easier to do eta expansion
*after* the main CorePrep stuff.  But that places constraints
on the eta expander: given a CpeRhs, it must return a CpeRhs.

For example here is what we do not want:
                f = /\a -&gt; g (h 3)      -- h has arity 2
After ANFing we get
                f = /\a -&gt; let s = h 3 in g s
and now we do NOT want eta expansion to give
                f = /\a -&gt; \ y -&gt; (let s = h 3 in g s) y

Instead CoreArity.etaExpand gives
                f = /\a -&gt; \y -&gt; let s = h 3 in g s y
-}</span><span>
</span><a name="line-1132"></a><span>
</span><a name="line-1133"></a><span class="hs-identifier">cpeEtaExpand</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Arity</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a><span>
</span><a name="line-1134"></a><a name="cpeEtaExpand"><a href="CorePrep.html#cpeEtaExpand"><span class="hs-identifier">cpeEtaExpand</span></a></a><span> </span><a name="local-6989586621682027545"><a href="#local-6989586621682027545"><span class="hs-identifier">arity</span></a></a><span> </span><a name="local-6989586621682027546"><a href="#local-6989586621682027546"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-1135"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682027545"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027546"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-1136"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">etaExpand</span><span> </span><a href="#local-6989586621682027545"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621682027546"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-1137"></a><span>
</span><a name="line-1138"></a><span class="hs-comment">{-
-- -----------------------------------------------------------------------------
--      Eta reduction
-- -----------------------------------------------------------------------------

Why try eta reduction?  Hasn't the simplifier already done eta?
But the simplifier only eta reduces if that leaves something
trivial (like f, or f Int).  But for deLam it would be enough to
get to a partial application:
        case x of { p -&gt; \xs. map f xs }
    ==&gt; case x of { p -&gt; map f }
-}</span><span>
</span><a name="line-1150"></a><span>
</span><a name="line-1151"></a><span class="hs-identifier">tryEtaReducePrep</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreBndr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-1152"></a><a name="tryEtaReducePrep"><a href="CorePrep.html#tryEtaReducePrep"><span class="hs-identifier">tryEtaReducePrep</span></a></a><span> </span><a name="local-6989586621682027547"><a href="#local-6989586621682027547"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-6989586621682027548"><a href="#local-6989586621682027548"><span class="hs-identifier">expr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">App</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1153"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682027557"><span class="hs-identifier hs-var">ok_to_eta_reduce</span></a><span> </span><a href="#local-6989586621682027549"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-1154"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027555"><span class="hs-identifier hs-var">n_remaining</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1155"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">and</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="#local-6989586621682027556"><span class="hs-identifier hs-var">ok</span></a><span> </span><a href="#local-6989586621682027547"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621682027554"><span class="hs-identifier hs-var">last_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1156"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682027552"><span class="hs-identifier hs-var">fvs_remaining</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027547"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1157"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">exprIsHNF</span><span> </span><a href="#local-6989586621682027551"><span class="hs-identifier hs-var">remaining_expr</span></a><span>   </span><span class="hs-comment">-- Don't turn value into a non-value</span><span>
</span><a name="line-1158"></a><span>                               </span><span class="hs-comment">-- else the behaviour with 'seq' changes</span><span>
</span><a name="line-1159"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682027551"><span class="hs-identifier hs-var">remaining_expr</span></a><span>
</span><a name="line-1160"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1161"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682027549"><a href="#local-6989586621682027549"><span class="hs-identifier">f</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027550"><a href="#local-6989586621682027550"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">collectArgs</span><span> </span><a href="#local-6989586621682027548"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-1162"></a><span>    </span><a name="local-6989586621682027551"><a href="#local-6989586621682027551"><span class="hs-identifier">remaining_expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkApps</span><span> </span><a href="#local-6989586621682027549"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621682027553"><span class="hs-identifier hs-var">remaining_args</span></a><span>
</span><a name="line-1163"></a><span>    </span><a name="local-6989586621682027552"><a href="#local-6989586621682027552"><span class="hs-identifier">fvs_remaining</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">exprFreeVars</span><span> </span><a href="#local-6989586621682027551"><span class="hs-identifier hs-var">remaining_expr</span></a><span>
</span><a name="line-1164"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682027553"><a href="#local-6989586621682027553"><span class="hs-identifier">remaining_args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027554"><a href="#local-6989586621682027554"><span class="hs-identifier">last_args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitAt</span><span> </span><a href="#local-6989586621682027555"><span class="hs-identifier hs-var">n_remaining</span></a><span> </span><a href="#local-6989586621682027550"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1165"></a><span>    </span><a name="local-6989586621682027555"><a href="#local-6989586621682027555"><span class="hs-identifier">n_remaining</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621682027550"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621682027547"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-1166"></a><span>
</span><a name="line-1167"></a><span>    </span><a name="local-6989586621682027556"><a href="#local-6989586621682027556"><span class="hs-identifier">ok</span></a></a><span> </span><a name="local-6989586621682027558"><a href="#local-6989586621682027558"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a name="local-6989586621682027559"><a href="#local-6989586621682027559"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027558"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682027559"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-1168"></a><span>    </span><span class="hs-identifier">ok</span><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1169"></a><span>
</span><a name="line-1170"></a><span>          </span><span class="hs-comment">-- We can't eta reduce something which must be saturated.</span><span>
</span><a name="line-1171"></a><span>    </span><a name="local-6989586621682027557"><a href="#local-6989586621682027557"><span class="hs-identifier">ok_to_eta_reduce</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a name="local-6989586621682027560"><a href="#local-6989586621682027560"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hasNoBinding</span><span> </span><a href="#local-6989586621682027560"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-1172"></a><span>    </span><span class="hs-identifier">ok_to_eta_reduce</span><span> </span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-comment">-- Safe. ToDo: generalise</span><span>
</span><a name="line-1173"></a><span>
</span><a name="line-1174"></a><span class="hs-identifier">tryEtaReducePrep</span><span> </span><a name="local-6989586621682027561"><a href="#local-6989586621682027561"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Let</span><span> </span><a name="local-6989586621682027562"><a href="#local-6989586621682027562"><span class="hs-identifier">bind</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682027563"><a href="#local-6989586621682027563"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682027564"><a href="#local-6989586621682027564"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1175"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682027565"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027561"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1176"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="CorePrep.html#tryEtaReducePrep"><span class="hs-identifier hs-var">tryEtaReducePrep</span></a><span> </span><a href="#local-6989586621682027561"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621682027564"><span class="hs-identifier hs-var">body</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1177"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682027566"><a href="#local-6989586621682027566"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Let</span><span> </span><a href="#local-6989586621682027562"><span class="hs-identifier hs-var">bind</span></a><span> </span><a href="#local-6989586621682027566"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-1178"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1179"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1180"></a><span>    </span><a name="local-6989586621682027565"><a href="#local-6989586621682027565"><span class="hs-identifier">fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">exprFreeVars</span><span> </span><a href="#local-6989586621682027563"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1181"></a><span>
</span><a name="line-1182"></a><span class="hs-comment">-- NB: do not attempt to eta-reduce across ticks</span><span>
</span><a name="line-1183"></a><span class="hs-comment">-- Otherwise we risk reducing</span><span>
</span><a name="line-1184"></a><span class="hs-comment">--       \x. (Tick (Breakpoint {x}) f x)</span><span>
</span><a name="line-1185"></a><span class="hs-comment">--   ==&gt; Tick (breakpoint {x}) f</span><span>
</span><a name="line-1186"></a><span class="hs-comment">-- which is bogus (Trac #17228)</span><span>
</span><a name="line-1187"></a><span class="hs-comment">-- tryEtaReducePrep bndrs (Tick tickish e)</span><span>
</span><a name="line-1188"></a><span class="hs-comment">--   = fmap (mkTick tickish) $ tryEtaReducePrep bndrs e</span><span>
</span><a name="line-1189"></a><span>
</span><a name="line-1190"></a><span class="hs-identifier">tryEtaReducePrep</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1191"></a><span>
</span><a name="line-1192"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Floats
*                                                                      *
************************************************************************

Note [Pin demand info on floats]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We pin demand info on floated lets, so that we can see the one-shot thunks.
-}</span><span>
</span><a name="line-1203"></a><span>
</span><a name="line-1204"></a><span class="hs-keyword">data</span><span> </span><a name="FloatingBind"><a href="CorePrep.html#FloatingBind"><span class="hs-identifier">FloatingBind</span></a></a><span>
</span><a name="line-1205"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="FloatLet"><a href="CorePrep.html#FloatLet"><span class="hs-identifier">FloatLet</span></a></a><span> </span><span class="hs-identifier hs-type">CoreBind</span><span>    </span><span class="hs-comment">-- Rhs of bindings are CpeRhss</span><span>
</span><a name="line-1206"></a><span>                         </span><span class="hs-comment">-- They are always of lifted type;</span><span>
</span><a name="line-1207"></a><span>                         </span><span class="hs-comment">-- unlifted ones are done with FloatCase</span><span>
</span><a name="line-1208"></a><span>
</span><a name="line-1209"></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="FloatCase"><a href="CorePrep.html#FloatCase"><span class="hs-identifier">FloatCase</span></a></a><span>
</span><a name="line-1210"></a><span>      </span><span class="hs-identifier hs-type">Id</span><span> </span><a href="CorePrep.html#CpeBody"><span class="hs-identifier hs-type">CpeBody</span></a><span>
</span><a name="line-1211"></a><span>      </span><span class="hs-identifier hs-type">Bool</span><span>              </span><span class="hs-comment">-- The bool indicates &quot;ok-for-speculation&quot;</span><span>
</span><a name="line-1212"></a><span>
</span><a name="line-1213"></a><span> </span><span class="hs-comment">-- | See Note [Floating Ticks in CorePrep]</span><span>
</span><a name="line-1214"></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="FloatTick"><a href="CorePrep.html#FloatTick"><span class="hs-identifier">FloatTick</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Tickish</span><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">)</span><span>
</span><a name="line-1215"></a><span>
</span><a name="line-1216"></a><span class="hs-keyword">data</span><span> </span><a name="Floats"><a href="CorePrep.html#Floats"><span class="hs-identifier">Floats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Floats"><a href="CorePrep.html#Floats"><span class="hs-identifier">Floats</span></a></a><span> </span><a href="CorePrep.html#OkToSpec"><span class="hs-identifier hs-type">OkToSpec</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OrdList</span><span> </span><a href="CorePrep.html#FloatingBind"><span class="hs-identifier hs-type">FloatingBind</span></a><span class="hs-special">)</span><span>
</span><a name="line-1217"></a><span>
</span><a name="line-1218"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="CorePrep.html#FloatingBind"><span class="hs-identifier hs-type">FloatingBind</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1219"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#FloatLet"><span class="hs-identifier hs-var">FloatLet</span></a><span> </span><a name="local-6989586621682027178"><a href="#local-6989586621682027178"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682027178"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-1220"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#FloatCase"><span class="hs-identifier hs-var">FloatCase</span></a><span> </span><a name="local-6989586621682027179"><a href="#local-6989586621682027179"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621682027180"><a href="#local-6989586621682027180"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682027181"><a href="#local-6989586621682027181"><span class="hs-identifier">ok</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">brackets</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682027181"><span class="hs-identifier hs-var">ok</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682027179"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">equals</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682027180"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1221"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#FloatTick"><span class="hs-identifier hs-var">FloatTick</span></a><span> </span><a name="local-6989586621682027182"><a href="#local-6989586621682027182"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682027182"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-1222"></a><span>
</span><a name="line-1223"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1224"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a><span> </span><a name="local-6989586621682027176"><a href="#local-6989586621682027176"><span class="hs-identifier">flag</span></a></a><span> </span><a name="local-6989586621682027177"><a href="#local-6989586621682027177"><span class="hs-identifier">fs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Floats&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">brackets</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682027176"><span class="hs-identifier hs-var">flag</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1225"></a><span>                         </span><span class="hs-identifier hs-var">braces</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromOL</span><span> </span><a href="#local-6989586621682027177"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1226"></a><span>
</span><a name="line-1227"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="CorePrep.html#OkToSpec"><span class="hs-identifier hs-type">OkToSpec</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1228"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><a href="CorePrep.html#OkToSpec"><span class="hs-identifier hs-var">OkToSpec</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;OkToSpec&quot;</span><span>
</span><a name="line-1229"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><a href="CorePrep.html#IfUnboxedOk"><span class="hs-identifier hs-var">IfUnboxedOk</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;IfUnboxedOk&quot;</span><span>
</span><a name="line-1230"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><a href="CorePrep.html#NotOkToSpec"><span class="hs-identifier hs-var">NotOkToSpec</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;NotOkToSpec&quot;</span><span>
</span><a name="line-1231"></a><span>
</span><a name="line-1232"></a><span class="hs-comment">-- Can we float these binds out of the rhs of a let?  We cache this decision</span><span>
</span><a name="line-1233"></a><span class="hs-comment">-- to avoid having to recompute it in a non-linear way when there are</span><span>
</span><a name="line-1234"></a><span class="hs-comment">-- deeply nested lets.</span><span>
</span><a name="line-1235"></a><span class="hs-keyword">data</span><span> </span><a name="OkToSpec"><a href="CorePrep.html#OkToSpec"><span class="hs-identifier">OkToSpec</span></a></a><span>
</span><a name="line-1236"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a name="OkToSpec"><a href="CorePrep.html#OkToSpec"><span class="hs-identifier">OkToSpec</span></a></a><span>           </span><span class="hs-comment">-- Lazy bindings of lifted type</span><span>
</span><a name="line-1237"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="IfUnboxedOk"><a href="CorePrep.html#IfUnboxedOk"><span class="hs-identifier">IfUnboxedOk</span></a></a><span>        </span><span class="hs-comment">-- A mixture of lazy lifted bindings and n</span><span>
</span><a name="line-1238"></a><span>                        </span><span class="hs-comment">-- ok-to-speculate unlifted bindings</span><span>
</span><a name="line-1239"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="NotOkToSpec"><a href="CorePrep.html#NotOkToSpec"><span class="hs-identifier">NotOkToSpec</span></a></a><span>        </span><span class="hs-comment">-- Some not-ok-to-speculate unlifted bindings</span><span>
</span><a name="line-1240"></a><span>
</span><a name="line-1241"></a><span class="hs-identifier">mkFloat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Demand</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#FloatingBind"><span class="hs-identifier hs-type">FloatingBind</span></a><span>
</span><a name="line-1242"></a><a name="mkFloat"><a href="CorePrep.html#mkFloat"><span class="hs-identifier">mkFloat</span></a></a><span> </span><a name="local-6989586621682027567"><a href="#local-6989586621682027567"><span class="hs-identifier">dmd</span></a></a><span> </span><a name="local-6989586621682027568"><a href="#local-6989586621682027568"><span class="hs-identifier">is_unlifted</span></a></a><span> </span><a name="local-6989586621682027569"><a href="#local-6989586621682027569"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621682027570"><a href="#local-6989586621682027570"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-1243"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682027573"><span class="hs-identifier hs-var">use_case</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#FloatCase"><span class="hs-identifier hs-var">FloatCase</span></a><span> </span><a href="#local-6989586621682027569"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621682027570"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprOkForSpeculation</span><span> </span><a href="#local-6989586621682027570"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1244"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682027571"><span class="hs-identifier hs-var">is_hnf</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#FloatLet"><span class="hs-identifier hs-var">FloatLet</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621682027569"><span class="hs-identifier hs-var">bndr</span></a><span>                       </span><a href="#local-6989586621682027570"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1245"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#FloatLet"><span class="hs-identifier hs-var">FloatLet</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">setIdDemandInfo</span><span> </span><a href="#local-6989586621682027569"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621682027567"><span class="hs-identifier hs-var">dmd</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027570"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1246"></a><span>                   </span><span class="hs-comment">-- See Note [Pin demand info on floats]</span><span>
</span><a name="line-1247"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1248"></a><span>    </span><a name="local-6989586621682027571"><a href="#local-6989586621682027571"><span class="hs-identifier">is_hnf</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">exprIsHNF</span><span> </span><a href="#local-6989586621682027570"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1249"></a><span>    </span><a name="local-6989586621682027572"><a href="#local-6989586621682027572"><span class="hs-identifier">is_strict</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isStrictDmd</span><span> </span><a href="#local-6989586621682027567"><span class="hs-identifier hs-var">dmd</span></a><span>
</span><a name="line-1250"></a><span>    </span><a name="local-6989586621682027573"><a href="#local-6989586621682027573"><span class="hs-identifier">use_case</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027568"><span class="hs-identifier hs-var">is_unlifted</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621682027572"><span class="hs-identifier hs-var">is_strict</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621682027571"><span class="hs-identifier hs-var">is_hnf</span></a><span>
</span><a name="line-1251"></a><span>                </span><span class="hs-comment">-- Don't make a case for a value binding,</span><span>
</span><a name="line-1252"></a><span>                </span><span class="hs-comment">-- even if it's strict.  Otherwise we get</span><span>
</span><a name="line-1253"></a><span>                </span><span class="hs-comment">--      case (\x -&gt; e) of ...!</span><span>
</span><a name="line-1254"></a><span>
</span><a name="line-1255"></a><span class="hs-identifier">emptyFloats</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span>
</span><a name="line-1256"></a><a name="emptyFloats"><a href="CorePrep.html#emptyFloats"><span class="hs-identifier">emptyFloats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a><span> </span><a href="CorePrep.html#OkToSpec"><span class="hs-identifier hs-var">OkToSpec</span></a><span> </span><span class="hs-identifier hs-var">nilOL</span><span>
</span><a name="line-1257"></a><span>
</span><a name="line-1258"></a><span class="hs-identifier">isEmptyFloats</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1259"></a><a name="isEmptyFloats"><a href="CorePrep.html#isEmptyFloats"><span class="hs-identifier">isEmptyFloats</span></a></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682027574"><a href="#local-6989586621682027574"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isNilOL</span><span> </span><a href="#local-6989586621682027574"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-1260"></a><span>
</span><a name="line-1261"></a><span class="hs-identifier">wrapBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#CpeBody"><span class="hs-identifier hs-type">CpeBody</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#CpeBody"><span class="hs-identifier hs-type">CpeBody</span></a><span>
</span><a name="line-1262"></a><a name="wrapBinds"><a href="CorePrep.html#wrapBinds"><span class="hs-identifier">wrapBinds</span></a></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682027575"><a href="#local-6989586621682027575"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682027576"><a href="#local-6989586621682027576"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-1263"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldrOL</span><span> </span><a href="#local-6989586621682027577"><span class="hs-identifier hs-var">mk_bind</span></a><span> </span><a href="#local-6989586621682027576"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621682027575"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-1264"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1265"></a><span>    </span><a name="local-6989586621682027577"><a href="#local-6989586621682027577"><span class="hs-identifier">mk_bind</span></a></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#FloatCase"><span class="hs-identifier hs-var">FloatCase</span></a><span> </span><a name="local-6989586621682027578"><a href="#local-6989586621682027578"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621682027579"><a href="#local-6989586621682027579"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682027580"><a href="#local-6989586621682027580"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Case</span><span> </span><a href="#local-6989586621682027579"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621682027578"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprType</span><span> </span><a href="#local-6989586621682027580"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DEFAULT</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027580"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1266"></a><span>    </span><span class="hs-identifier">mk_bind</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#FloatLet"><span class="hs-identifier hs-var">FloatLet</span></a><span> </span><a name="local-6989586621682027581"><a href="#local-6989586621682027581"><span class="hs-identifier">bind</span></a></a><span class="hs-special">)</span><span>        </span><a name="local-6989586621682027582"><a href="#local-6989586621682027582"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Let</span><span> </span><a href="#local-6989586621682027581"><span class="hs-identifier hs-var">bind</span></a><span> </span><a href="#local-6989586621682027582"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-1267"></a><span>    </span><span class="hs-identifier">mk_bind</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#FloatTick"><span class="hs-identifier hs-var">FloatTick</span></a><span> </span><a name="local-6989586621682027583"><a href="#local-6989586621682027583"><span class="hs-identifier">tickish</span></a></a><span class="hs-special">)</span><span>    </span><a name="local-6989586621682027584"><a href="#local-6989586621682027584"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTick</span><span> </span><a href="#local-6989586621682027583"><span class="hs-identifier hs-var">tickish</span></a><span> </span><a href="#local-6989586621682027584"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-1268"></a><span>
</span><a name="line-1269"></a><span class="hs-identifier">addFloat</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#FloatingBind"><span class="hs-identifier hs-type">FloatingBind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span>
</span><a name="line-1270"></a><a name="addFloat"><a href="CorePrep.html#addFloat"><span class="hs-identifier">addFloat</span></a></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a><span> </span><a name="local-6989586621682027585"><a href="#local-6989586621682027585"><span class="hs-identifier">ok_to_spec</span></a></a><span> </span><a name="local-6989586621682027586"><a href="#local-6989586621682027586"><span class="hs-identifier">floats</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682027587"><a href="#local-6989586621682027587"><span class="hs-identifier">new_float</span></a></a><span>
</span><a name="line-1271"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#combine"><span class="hs-identifier hs-var">combine</span></a><span> </span><a href="#local-6989586621682027585"><span class="hs-identifier hs-var">ok_to_spec</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027588"><span class="hs-identifier hs-var">check</span></a><span> </span><a href="#local-6989586621682027587"><span class="hs-identifier hs-var">new_float</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027586"><span class="hs-identifier hs-var">floats</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">snocOL</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682027587"><span class="hs-identifier hs-var">new_float</span></a><span class="hs-special">)</span><span>
</span><a name="line-1272"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1273"></a><span>    </span><a name="local-6989586621682027588"><a href="#local-6989586621682027588"><span class="hs-identifier">check</span></a></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#FloatLet"><span class="hs-identifier hs-var">FloatLet</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#OkToSpec"><span class="hs-identifier hs-var">OkToSpec</span></a><span>
</span><a name="line-1274"></a><span>    </span><span class="hs-identifier">check</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#FloatCase"><span class="hs-identifier hs-var">FloatCase</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682027589"><a href="#local-6989586621682027589"><span class="hs-identifier">ok_for_spec</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1275"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682027589"><span class="hs-identifier hs-var">ok_for_spec</span></a><span>  </span><span class="hs-glyph">=</span><span>  </span><a href="CorePrep.html#IfUnboxedOk"><span class="hs-identifier hs-var">IfUnboxedOk</span></a><span>
</span><a name="line-1276"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>    </span><span class="hs-glyph">=</span><span>  </span><a href="CorePrep.html#NotOkToSpec"><span class="hs-identifier hs-var">NotOkToSpec</span></a><span>
</span><a name="line-1277"></a><span>    </span><span class="hs-identifier">check</span><span> </span><a href="CorePrep.html#FloatTick"><span class="hs-identifier hs-var">FloatTick</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#OkToSpec"><span class="hs-identifier hs-var">OkToSpec</span></a><span>
</span><a name="line-1278"></a><span>        </span><span class="hs-comment">-- The ok-for-speculation flag says that it's safe to</span><span>
</span><a name="line-1279"></a><span>        </span><span class="hs-comment">-- float this Case out of a let, and thereby do it more eagerly</span><span>
</span><a name="line-1280"></a><span>        </span><span class="hs-comment">-- We need the top-level flag because it's never ok to float</span><span>
</span><a name="line-1281"></a><span>        </span><span class="hs-comment">-- an unboxed binding to the top level</span><span>
</span><a name="line-1282"></a><span>
</span><a name="line-1283"></a><span class="hs-identifier">unitFloat</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CorePrep.html#FloatingBind"><span class="hs-identifier hs-type">FloatingBind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span>
</span><a name="line-1284"></a><a name="unitFloat"><a href="CorePrep.html#unitFloat"><span class="hs-identifier">unitFloat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#addFloat"><span class="hs-identifier hs-var">addFloat</span></a><span> </span><a href="CorePrep.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a><span>
</span><a name="line-1285"></a><span>
</span><a name="line-1286"></a><span class="hs-identifier">appendFloats</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span>
</span><a name="line-1287"></a><a name="appendFloats"><a href="CorePrep.html#appendFloats"><span class="hs-identifier">appendFloats</span></a></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a><span> </span><a name="local-6989586621682027590"><a href="#local-6989586621682027590"><span class="hs-identifier">spec1</span></a></a><span> </span><a name="local-6989586621682027591"><a href="#local-6989586621682027591"><span class="hs-identifier">floats1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a><span> </span><a name="local-6989586621682027592"><a href="#local-6989586621682027592"><span class="hs-identifier">spec2</span></a></a><span> </span><a name="local-6989586621682027593"><a href="#local-6989586621682027593"><span class="hs-identifier">floats2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1288"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#combine"><span class="hs-identifier hs-var">combine</span></a><span> </span><a href="#local-6989586621682027590"><span class="hs-identifier hs-var">spec1</span></a><span> </span><a href="#local-6989586621682027592"><span class="hs-identifier hs-var">spec2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027591"><span class="hs-identifier hs-var">floats1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682027593"><span class="hs-identifier hs-var">floats2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1289"></a><span>
</span><a name="line-1290"></a><span class="hs-identifier">concatFloats</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OrdList</span><span> </span><a href="CorePrep.html#FloatingBind"><span class="hs-identifier hs-type">FloatingBind</span></a><span>
</span><a name="line-1291"></a><a name="concatFloats"><a href="CorePrep.html#concatFloats"><span class="hs-identifier">concatFloats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682027594"><a href="#local-6989586621682027594"><span class="hs-identifier">bs1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682027595"><a href="#local-6989586621682027595"><span class="hs-identifier">bs2</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">appOL</span><span> </span><a href="#local-6989586621682027594"><span class="hs-identifier hs-var">bs1</span></a><span> </span><a href="#local-6989586621682027595"><span class="hs-identifier hs-var">bs2</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">nilOL</span><span>
</span><a name="line-1292"></a><span>
</span><a name="line-1293"></a><span class="hs-identifier">combine</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CorePrep.html#OkToSpec"><span class="hs-identifier hs-type">OkToSpec</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#OkToSpec"><span class="hs-identifier hs-type">OkToSpec</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#OkToSpec"><span class="hs-identifier hs-type">OkToSpec</span></a><span>
</span><a name="line-1294"></a><a name="combine"><a href="CorePrep.html#combine"><span class="hs-identifier">combine</span></a></a><span> </span><a href="CorePrep.html#NotOkToSpec"><span class="hs-identifier hs-var">NotOkToSpec</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#NotOkToSpec"><span class="hs-identifier hs-var">NotOkToSpec</span></a><span>
</span><a name="line-1295"></a><span class="hs-identifier">combine</span><span> </span><span class="hs-identifier">_</span><span> </span><a href="CorePrep.html#NotOkToSpec"><span class="hs-identifier hs-var">NotOkToSpec</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#NotOkToSpec"><span class="hs-identifier hs-var">NotOkToSpec</span></a><span>
</span><a name="line-1296"></a><span class="hs-identifier">combine</span><span> </span><a href="CorePrep.html#IfUnboxedOk"><span class="hs-identifier hs-var">IfUnboxedOk</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#IfUnboxedOk"><span class="hs-identifier hs-var">IfUnboxedOk</span></a><span>
</span><a name="line-1297"></a><span class="hs-identifier">combine</span><span> </span><span class="hs-identifier">_</span><span> </span><a href="CorePrep.html#IfUnboxedOk"><span class="hs-identifier hs-var">IfUnboxedOk</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#IfUnboxedOk"><span class="hs-identifier hs-var">IfUnboxedOk</span></a><span>
</span><a name="line-1298"></a><span class="hs-identifier">combine</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#OkToSpec"><span class="hs-identifier hs-var">OkToSpec</span></a><span>
</span><a name="line-1299"></a><span>
</span><a name="line-1300"></a><span class="hs-identifier">deFloatTop</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreBind</span><span class="hs-special">]</span><span>
</span><a name="line-1301"></a><span class="hs-comment">-- For top level only; we don't expect any FloatCases</span><span>
</span><a name="line-1302"></a><a name="deFloatTop"><a href="CorePrep.html#deFloatTop"><span class="hs-identifier">deFloatTop</span></a></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682027596"><a href="#local-6989586621682027596"><span class="hs-identifier">floats</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1303"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldrOL</span><span> </span><a href="#local-6989586621682027597"><span class="hs-identifier hs-var">get</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621682027596"><span class="hs-identifier hs-var">floats</span></a><span>
</span><a name="line-1304"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1305"></a><span>    </span><a name="local-6989586621682027597"><a href="#local-6989586621682027597"><span class="hs-identifier">get</span></a></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#FloatLet"><span class="hs-identifier hs-var">FloatLet</span></a><span> </span><a name="local-6989586621682027599"><a href="#local-6989586621682027599"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682027600"><a href="#local-6989586621682027600"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027598"><span class="hs-identifier hs-var">occurAnalyseRHSs</span></a><span> </span><a href="#local-6989586621682027599"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682027600"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-1306"></a><span>    </span><span class="hs-identifier">get</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#FloatCase"><span class="hs-identifier hs-var">FloatCase</span></a><span> </span><a name="local-6989586621682027601"><a href="#local-6989586621682027601"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621682027602"><a href="#local-6989586621682027602"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682027603"><a href="#local-6989586621682027603"><span class="hs-identifier">bs</span></a></a><span>  </span><span class="hs-glyph">=</span><span>
</span><a name="line-1307"></a><span>      </span><a href="#local-6989586621682027598"><span class="hs-identifier hs-var">occurAnalyseRHSs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621682027601"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621682027602"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682027603"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-1308"></a><span>    </span><span class="hs-identifier">get</span><span> </span><a name="local-6989586621682027604"><a href="#local-6989586621682027604"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;corePrepPgm&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682027604"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-1309"></a><span>
</span><a name="line-1310"></a><span>    </span><span class="hs-comment">-- See Note [Dead code in CorePrep]</span><span>
</span><a name="line-1311"></a><span>    </span><a name="local-6989586621682027598"><a href="#local-6989586621682027598"><span class="hs-identifier">occurAnalyseRHSs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a name="local-6989586621682027605"><a href="#local-6989586621682027605"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682027606"><a href="#local-6989586621682027606"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621682027605"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">occurAnalyseExpr_NoBinderSwap</span><span> </span><a href="#local-6989586621682027606"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-1312"></a><span>    </span><span class="hs-identifier">occurAnalyseRHSs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><a name="local-6989586621682027607"><a href="#local-6989586621682027607"><span class="hs-identifier">xes</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Rec</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621682027608"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">occurAnalyseExpr_NoBinderSwap</span><span> </span><a href="#local-6989586621682027609"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027608"><a href="#local-6989586621682027608"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027609"><a href="#local-6989586621682027609"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682027607"><span class="hs-identifier hs-var">xes</span></a><span class="hs-special">]</span><span>
</span><a name="line-1313"></a><span>
</span><a name="line-1314"></a><span class="hs-comment">---------------------------------------------------------------------------</span><span>
</span><a name="line-1315"></a><span>
</span><a name="line-1316"></a><span class="hs-identifier">canFloatFromNoCaf</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Platform</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span class="hs-special">,</span><span> </span><a href="CorePrep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1317"></a><span>       </span><span class="hs-comment">-- Note [CafInfo and floating]</span><span>
</span><a name="line-1318"></a><a name="canFloatFromNoCaf"><a href="CorePrep.html#canFloatFromNoCaf"><span class="hs-identifier">canFloatFromNoCaf</span></a></a><span> </span><a name="local-6989586621682027610"><a href="#local-6989586621682027610"><span class="hs-identifier">platform</span></a></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a><span> </span><a name="local-6989586621682027611"><a href="#local-6989586621682027611"><span class="hs-identifier">ok_to_spec</span></a></a><span> </span><a name="local-6989586621682027612"><a href="#local-6989586621682027612"><span class="hs-identifier">fs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682027613"><a href="#local-6989586621682027613"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-1319"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CorePrep.html#OkToSpec"><span class="hs-identifier hs-var">OkToSpec</span></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682027611"><span class="hs-identifier hs-var">ok_to_spec</span></a><span>           </span><span class="hs-comment">-- Worth trying</span><span>
</span><a name="line-1320"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027647"><a href="#local-6989586621682027647"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027648"><a href="#local-6989586621682027648"><span class="hs-identifier">fs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682027615"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">emptySubst</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nilOL</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromOL</span><span> </span><a href="#local-6989586621682027612"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1321"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a><span> </span><a href="CorePrep.html#OkToSpec"><span class="hs-identifier hs-var">OkToSpec</span></a><span> </span><a href="#local-6989586621682027648"><span class="hs-identifier hs-var">fs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027614"><span class="hs-identifier hs-var">subst_expr</span></a><span> </span><a href="#local-6989586621682027647"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682027613"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1322"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1323"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1324"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1325"></a><span>    </span><a name="local-6989586621682027614"><a href="#local-6989586621682027614"><span class="hs-identifier">subst_expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;CorePrep&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1326"></a><span>
</span><a name="line-1327"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Subst</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">OrdList</span><span> </span><a href="CorePrep.html#FloatingBind"><span class="hs-identifier hs-type">FloatingBind</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CorePrep.html#FloatingBind"><span class="hs-identifier hs-type">FloatingBind</span></a><span class="hs-special">]</span><span>
</span><a name="line-1328"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Subst</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">OrdList</span><span> </span><a href="CorePrep.html#FloatingBind"><span class="hs-identifier hs-type">FloatingBind</span></a><span class="hs-special">)</span><span>
</span><a name="line-1329"></a><span>
</span><a name="line-1330"></a><span>    </span><a name="local-6989586621682027615"><a href="#local-6989586621682027615"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682027618"><a href="#local-6989586621682027618"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027619"><a href="#local-6989586621682027619"><span class="hs-identifier">fbs_out</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027618"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027619"><span class="hs-identifier hs-var">fbs_out</span></a><span class="hs-special">)</span><span>
</span><a name="line-1331"></a><span>
</span><a name="line-1332"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027620"><a href="#local-6989586621682027620"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027621"><a href="#local-6989586621682027621"><span class="hs-identifier">fbs_out</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#FloatLet"><span class="hs-identifier hs-var">FloatLet</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a name="local-6989586621682027622"><a href="#local-6989586621682027622"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621682027623"><a href="#local-6989586621682027623"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682027624"><a href="#local-6989586621682027624"><span class="hs-identifier">fbs_in</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1333"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682027617"><span class="hs-identifier hs-var">rhs_ok</span></a><span> </span><a href="#local-6989586621682027623"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1334"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027615"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027625"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027621"><span class="hs-identifier hs-var">fbs_out</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">snocOL</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682027627"><span class="hs-identifier hs-var">new_fb</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027624"><span class="hs-identifier hs-var">fbs_in</span></a><span>
</span><a name="line-1335"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1336"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621682027625"><a href="#local-6989586621682027625"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027626"><a href="#local-6989586621682027626"><span class="hs-identifier">b'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027616"><span class="hs-identifier hs-var">set_nocaf_bndr</span></a><span> </span><a href="#local-6989586621682027620"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682027622"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-1337"></a><span>        </span><a name="local-6989586621682027627"><a href="#local-6989586621682027627"><span class="hs-identifier">new_fb</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#FloatLet"><span class="hs-identifier hs-var">FloatLet</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621682027626"><span class="hs-identifier hs-var">b'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027614"><span class="hs-identifier hs-var">subst_expr</span></a><span> </span><a href="#local-6989586621682027620"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682027623"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1338"></a><span>
</span><a name="line-1339"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027628"><a href="#local-6989586621682027628"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027629"><a href="#local-6989586621682027629"><span class="hs-identifier">fbs_out</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#FloatLet"><span class="hs-identifier hs-var">FloatLet</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><a name="local-6989586621682027630"><a href="#local-6989586621682027630"><span class="hs-identifier">prs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682027631"><a href="#local-6989586621682027631"><span class="hs-identifier">fbs_in</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1340"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><a href="#local-6989586621682027617"><span class="hs-identifier hs-var">rhs_ok</span></a><span> </span><a href="#local-6989586621682027633"><span class="hs-identifier hs-var">rs</span></a><span>
</span><a name="line-1341"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027615"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027634"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027629"><span class="hs-identifier hs-var">fbs_out</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">snocOL</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682027637"><span class="hs-identifier hs-var">new_fb</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027631"><span class="hs-identifier hs-var">fbs_in</span></a><span>
</span><a name="line-1342"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1343"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621682027632"><a href="#local-6989586621682027632"><span class="hs-identifier">bs</span></a></a><span class="hs-special">,</span><a name="local-6989586621682027633"><a href="#local-6989586621682027633"><span class="hs-identifier">rs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621682027630"><span class="hs-identifier hs-var">prs</span></a><span>
</span><a name="line-1344"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621682027634"><a href="#local-6989586621682027634"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027635"><a href="#local-6989586621682027635"><span class="hs-identifier">bs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><a href="#local-6989586621682027616"><span class="hs-identifier hs-var">set_nocaf_bndr</span></a><span> </span><a href="#local-6989586621682027628"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682027632"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-1345"></a><span>        </span><a name="local-6989586621682027636"><a href="#local-6989586621682027636"><span class="hs-identifier">rs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027614"><span class="hs-identifier hs-var">subst_expr</span></a><span> </span><a href="#local-6989586621682027634"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027633"><span class="hs-identifier hs-var">rs</span></a><span>
</span><a name="line-1346"></a><span>        </span><a name="local-6989586621682027637"><a href="#local-6989586621682027637"><span class="hs-identifier">new_fb</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#FloatLet"><span class="hs-identifier hs-var">FloatLet</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027635"><span class="hs-identifier hs-var">bs'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682027636"><span class="hs-identifier hs-var">rs'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1347"></a><span>
</span><a name="line-1348"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027638"><a href="#local-6989586621682027638"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027639"><a href="#local-6989586621682027639"><span class="hs-identifier">fbs_out</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027640"><a href="#local-6989586621682027640"><span class="hs-identifier">ft</span></a></a><span class="hs-glyph">@</span><a href="CorePrep.html#FloatTick"><span class="hs-identifier hs-var">FloatTick</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682027641"><a href="#local-6989586621682027641"><span class="hs-identifier">fbs_in</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1349"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027615"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027638"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027639"><span class="hs-identifier hs-var">fbs_out</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">snocOL</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682027640"><span class="hs-identifier hs-var">ft</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027641"><span class="hs-identifier hs-var">fbs_in</span></a><span>
</span><a name="line-1350"></a><span>
</span><a name="line-1351"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>      </span><span class="hs-comment">-- Encountered a caffy binding</span><span>
</span><a name="line-1352"></a><span>
</span><a name="line-1353"></a><span>    </span><span class="hs-comment">------------</span><span>
</span><a name="line-1354"></a><span>    </span><a name="local-6989586621682027616"><a href="#local-6989586621682027616"><span class="hs-identifier">set_nocaf_bndr</span></a></a><span> </span><a name="local-6989586621682027642"><a href="#local-6989586621682027642"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621682027643"><a href="#local-6989586621682027643"><span class="hs-identifier">bndr</span></a></a><span>
</span><a name="line-1355"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">extendIdSubst</span><span> </span><a href="#local-6989586621682027642"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682027643"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621682027644"><span class="hs-identifier hs-var">bndr'</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027644"><span class="hs-identifier hs-var">bndr'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1356"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1357"></a><span>        </span><a name="local-6989586621682027644"><a href="#local-6989586621682027644"><span class="hs-identifier">bndr'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027643"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setIdCafInfo</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">NoCafRefs</span><span>
</span><a name="line-1358"></a><span>
</span><a name="line-1359"></a><span>    </span><span class="hs-comment">------------</span><span>
</span><a name="line-1360"></a><span>    </span><span class="hs-identifier">rhs_ok</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1361"></a><span>    </span><span class="hs-comment">-- We can only float to top level from a NoCaf thing if</span><span>
</span><a name="line-1362"></a><span>    </span><span class="hs-comment">-- the new binding is static. However it can't mention</span><span>
</span><a name="line-1363"></a><span>    </span><span class="hs-comment">-- any non-static things or it would *already* be Caffy</span><span>
</span><a name="line-1364"></a><span>    </span><a name="local-6989586621682027617"><a href="#local-6989586621682027617"><span class="hs-identifier">rhs_ok</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">rhsIsStatic</span><span> </span><a href="#local-6989586621682027610"><span class="hs-identifier hs-var">platform</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span>
</span><a name="line-1365"></a><span>                         </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682027645"><a href="#local-6989586621682027645"><span class="hs-identifier">_nt</span></a></a><span> </span><a name="local-6989586621682027646"><a href="#local-6989586621682027646"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;rhsIsStatic&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">integer</span><span> </span><a href="#local-6989586621682027646"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1366"></a><span>                         </span><span class="hs-comment">-- Integer or Natural literals should not show up</span><span>
</span><a name="line-1367"></a><span>
</span><a name="line-1368"></a><span class="hs-identifier">wantFloatNested</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RecFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Demand</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#CpeRhs"><span class="hs-identifier hs-type">CpeRhs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1369"></a><a name="wantFloatNested"><a href="CorePrep.html#wantFloatNested"><span class="hs-identifier">wantFloatNested</span></a></a><span> </span><a name="local-6989586621682027649"><a href="#local-6989586621682027649"><span class="hs-identifier">is_rec</span></a></a><span> </span><a name="local-6989586621682027650"><a href="#local-6989586621682027650"><span class="hs-identifier">dmd</span></a></a><span> </span><a name="local-6989586621682027651"><a href="#local-6989586621682027651"><span class="hs-identifier">is_unlifted</span></a></a><span> </span><a name="local-6989586621682027652"><a href="#local-6989586621682027652"><span class="hs-identifier">floats</span></a></a><span> </span><a name="local-6989586621682027653"><a href="#local-6989586621682027653"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-1370"></a><span>  </span><span class="hs-glyph">=</span><span>  </span><a href="CorePrep.html#isEmptyFloats"><span class="hs-identifier hs-var">isEmptyFloats</span></a><span> </span><a href="#local-6989586621682027652"><span class="hs-identifier hs-var">floats</span></a><span>
</span><a name="line-1371"></a><span>  </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">isStrictDmd</span><span> </span><a href="#local-6989586621682027650"><span class="hs-identifier hs-var">dmd</span></a><span>
</span><a name="line-1372"></a><span>  </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621682027651"><span class="hs-identifier hs-var">is_unlifted</span></a><span>
</span><a name="line-1373"></a><span>  </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#allLazyNested"><span class="hs-identifier hs-var">allLazyNested</span></a><span> </span><a href="#local-6989586621682027649"><span class="hs-identifier hs-var">is_rec</span></a><span> </span><a href="#local-6989586621682027652"><span class="hs-identifier hs-var">floats</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">exprIsHNF</span><span> </span><a href="#local-6989586621682027653"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1374"></a><span>        </span><span class="hs-comment">-- Why the test for allLazyNested?</span><span>
</span><a name="line-1375"></a><span>        </span><span class="hs-comment">--      v = f (x `divInt#` y)</span><span>
</span><a name="line-1376"></a><span>        </span><span class="hs-comment">-- we don't want to float the case, even if f has arity 2,</span><span>
</span><a name="line-1377"></a><span>        </span><span class="hs-comment">-- because floating the case would make it evaluated too early</span><span>
</span><a name="line-1378"></a><span>
</span><a name="line-1379"></a><span class="hs-identifier">allLazyTop</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1380"></a><a name="allLazyTop"><a href="CorePrep.html#allLazyTop"><span class="hs-identifier">allLazyTop</span></a></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a><span> </span><a href="CorePrep.html#OkToSpec"><span class="hs-identifier hs-var">OkToSpec</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1381"></a><span class="hs-identifier">allLazyTop</span><span> </span><span class="hs-identifier">_</span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1382"></a><span>
</span><a name="line-1383"></a><span class="hs-identifier">allLazyNested</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RecFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1384"></a><a name="allLazyNested"><a href="CorePrep.html#allLazyNested"><span class="hs-identifier">allLazyNested</span></a></a><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-special">(</span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a><span> </span><a href="CorePrep.html#OkToSpec"><span class="hs-identifier hs-var">OkToSpec</span></a><span>    </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1385"></a><span class="hs-identifier">allLazyNested</span><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-special">(</span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a><span> </span><a href="CorePrep.html#NotOkToSpec"><span class="hs-identifier hs-var">NotOkToSpec</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1386"></a><span class="hs-identifier">allLazyNested</span><span> </span><a name="local-6989586621682027654"><a href="#local-6989586621682027654"><span class="hs-identifier">is_rec</span></a></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a><span> </span><a href="CorePrep.html#IfUnboxedOk"><span class="hs-identifier hs-var">IfUnboxedOk</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isNonRec</span><span> </span><a href="#local-6989586621682027654"><span class="hs-identifier hs-var">is_rec</span></a><span>
</span><a name="line-1387"></a><span>
</span><a name="line-1388"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Cloning
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1395"></a><span>
</span><a name="line-1396"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-1397"></a><span class="hs-comment">--                      The environment</span><span>
</span><a name="line-1398"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-1399"></a><span>
</span><a name="line-1400"></a><span class="hs-comment">-- Note [Inlining in CorePrep]</span><span>
</span><a name="line-1401"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-1402"></a><span class="hs-comment">-- There is a subtle but important invariant that must be upheld in the output</span><span>
</span><a name="line-1403"></a><span class="hs-comment">-- of CorePrep: there are no &quot;trivial&quot; updatable thunks.  Thus, this Core</span><span>
</span><a name="line-1404"></a><span class="hs-comment">-- is impermissible:</span><span>
</span><a name="line-1405"></a><span class="hs-comment">--</span><span>
</span><a name="line-1406"></a><span class="hs-comment">--      let x :: ()</span><span>
</span><a name="line-1407"></a><span class="hs-comment">--          x = y</span><span>
</span><a name="line-1408"></a><span class="hs-comment">--</span><span>
</span><a name="line-1409"></a><span class="hs-comment">-- (where y is a reference to a GLOBAL variable).  Thunks like this are silly:</span><span>
</span><a name="line-1410"></a><span class="hs-comment">-- they can always be profitably replaced by inlining x with y. Consequently,</span><span>
</span><a name="line-1411"></a><span class="hs-comment">-- the code generator/runtime does not bother implementing this properly</span><span>
</span><a name="line-1412"></a><span class="hs-comment">-- (specifically, there is no implementation of stg_ap_0_upd_info, which is the</span><span>
</span><a name="line-1413"></a><span class="hs-comment">-- stack frame that would be used to update this thunk.  The &quot;0&quot; means it has</span><span>
</span><a name="line-1414"></a><span class="hs-comment">-- zero free variables.)</span><span>
</span><a name="line-1415"></a><span class="hs-comment">--</span><span>
</span><a name="line-1416"></a><span class="hs-comment">-- In general, the inliner is good at eliminating these let-bindings.  However,</span><span>
</span><a name="line-1417"></a><span class="hs-comment">-- there is one case where these trivial updatable thunks can arise: when</span><span>
</span><a name="line-1418"></a><span class="hs-comment">-- we are optimizing away 'lazy' (see Note [lazyId magic], and also</span><span>
</span><a name="line-1419"></a><span class="hs-comment">-- 'cpeRhsE'.)  Then, we could have started with:</span><span>
</span><a name="line-1420"></a><span class="hs-comment">--</span><span>
</span><a name="line-1421"></a><span class="hs-comment">--      let x :: ()</span><span>
</span><a name="line-1422"></a><span class="hs-comment">--          x = lazy @ () y</span><span>
</span><a name="line-1423"></a><span class="hs-comment">--</span><span>
</span><a name="line-1424"></a><span class="hs-comment">-- which is a perfectly fine, non-trivial thunk, but then CorePrep will</span><span>
</span><a name="line-1425"></a><span class="hs-comment">-- drop 'lazy', giving us 'x = y' which is trivial and impermissible.</span><span>
</span><a name="line-1426"></a><span class="hs-comment">-- The solution is CorePrep to have a miniature inlining pass which deals</span><span>
</span><a name="line-1427"></a><span class="hs-comment">-- with cases like this.  We can then drop the let-binding altogether.</span><span>
</span><a name="line-1428"></a><span class="hs-comment">--</span><span>
</span><a name="line-1429"></a><span class="hs-comment">-- Why does the removal of 'lazy' have to occur in CorePrep?</span><span>
</span><a name="line-1430"></a><span class="hs-comment">-- The gory details are in Note [lazyId magic] in MkId, but the</span><span>
</span><a name="line-1431"></a><span class="hs-comment">-- main reason is that lazy must appear in unfoldings (optimizer</span><span>
</span><a name="line-1432"></a><span class="hs-comment">-- output) and it must prevent call-by-value for catch# (which</span><span>
</span><a name="line-1433"></a><span class="hs-comment">-- is implemented by CorePrep.)</span><span>
</span><a name="line-1434"></a><span class="hs-comment">--</span><span>
</span><a name="line-1435"></a><span class="hs-comment">-- An alternate strategy for solving this problem is to have the</span><span>
</span><a name="line-1436"></a><span class="hs-comment">-- inliner treat 'lazy e' as a trivial expression if 'e' is trivial.</span><span>
</span><a name="line-1437"></a><span class="hs-comment">-- We decided not to adopt this solution to keep the definition</span><span>
</span><a name="line-1438"></a><span class="hs-comment">-- of 'exprIsTrivial' simple.</span><span>
</span><a name="line-1439"></a><span class="hs-comment">--</span><span>
</span><a name="line-1440"></a><span class="hs-comment">-- There is ONE caveat however: for top-level bindings we have</span><span>
</span><a name="line-1441"></a><span class="hs-comment">-- to preserve the binding so that we float the (hacky) non-recursive</span><span>
</span><a name="line-1442"></a><span class="hs-comment">-- binding for data constructors; see Note [Data constructor workers].</span><span>
</span><a name="line-1443"></a><span class="hs-comment">--</span><span>
</span><a name="line-1444"></a><span class="hs-comment">-- Note [CorePrep inlines trivial CoreExpr not Id]</span><span>
</span><a name="line-1445"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-1446"></a><span class="hs-comment">-- Why does cpe_env need to be an IdEnv CoreExpr, as opposed to an</span><span>
</span><a name="line-1447"></a><span class="hs-comment">-- IdEnv Id?  Naively, we might conjecture that trivial updatable thunks</span><span>
</span><a name="line-1448"></a><span class="hs-comment">-- as per Note [Inlining in CorePrep] always have the form</span><span>
</span><a name="line-1449"></a><span class="hs-comment">-- 'lazy @ SomeType gbl_id'.  But this is not true: the following is</span><span>
</span><a name="line-1450"></a><span class="hs-comment">-- perfectly reasonable Core:</span><span>
</span><a name="line-1451"></a><span class="hs-comment">--</span><span>
</span><a name="line-1452"></a><span class="hs-comment">--      let x :: ()</span><span>
</span><a name="line-1453"></a><span class="hs-comment">--          x = lazy @ (forall a. a) y @ Bool</span><span>
</span><a name="line-1454"></a><span class="hs-comment">--</span><span>
</span><a name="line-1455"></a><span class="hs-comment">-- When we inline 'x' after eliminating 'lazy', we need to replace</span><span>
</span><a name="line-1456"></a><span class="hs-comment">-- occurrences of 'x' with 'y @ bool', not just 'y'.  Situations like</span><span>
</span><a name="line-1457"></a><span class="hs-comment">-- this can easily arise with higher-rank types; thus, cpe_env must</span><span>
</span><a name="line-1458"></a><span class="hs-comment">-- map to CoreExprs, not Ids.</span><span>
</span><a name="line-1459"></a><span>
</span><a name="line-1460"></a><span class="hs-keyword">data</span><span> </span><a name="CorePrepEnv"><a href="CorePrep.html#CorePrepEnv"><span class="hs-identifier">CorePrepEnv</span></a></a><span>
</span><a name="line-1461"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="CPE"><a href="CorePrep.html#CPE"><span class="hs-identifier">CPE</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="cpe_dynFlags"><a href="CorePrep.html#cpe_dynFlags"><span class="hs-identifier">cpe_dynFlags</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-1462"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="cpe_env"><a href="CorePrep.html#cpe_env"><span class="hs-identifier">cpe_env</span></a></a><span>             </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IdEnv</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>   </span><span class="hs-comment">-- Clone local Ids</span><span>
</span><a name="line-1463"></a><span>        </span><span class="hs-comment">-- ^ This environment is used for three operations:</span><span>
</span><a name="line-1464"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-1465"></a><span>        </span><span class="hs-comment">--      1. To support cloning of local Ids so that they are</span><span>
</span><a name="line-1466"></a><span>        </span><span class="hs-comment">--      all unique (see item (6) of CorePrep overview).</span><span>
</span><a name="line-1467"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-1468"></a><span>        </span><span class="hs-comment">--      2. To support beta-reduction of runRW, see</span><span>
</span><a name="line-1469"></a><span>        </span><span class="hs-comment">--      Note [runRW magic] and Note [runRW arg].</span><span>
</span><a name="line-1470"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-1471"></a><span>        </span><span class="hs-comment">--      3. To let us inline trivial RHSs of non top-level let-bindings,</span><span>
</span><a name="line-1472"></a><span>        </span><span class="hs-comment">--      see Note [lazyId magic], Note [Inlining in CorePrep]</span><span>
</span><a name="line-1473"></a><span>        </span><span class="hs-comment">--      and Note [CorePrep inlines trivial CoreExpr not Id] (#12076)</span><span>
</span><a name="line-1474"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="cpe_mkIntegerId"><a href="CorePrep.html#cpe_mkIntegerId"><span class="hs-identifier">cpe_mkIntegerId</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-1475"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="cpe_mkNaturalId"><a href="CorePrep.html#cpe_mkNaturalId"><span class="hs-identifier">cpe_mkNaturalId</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-1476"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="cpe_integerSDataCon"><a href="CorePrep.html#cpe_integerSDataCon"><span class="hs-identifier">cpe_integerSDataCon</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span>
</span><a name="line-1477"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="cpe_naturalSDataCon"><a href="CorePrep.html#cpe_naturalSDataCon"><span class="hs-identifier">cpe_naturalSDataCon</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span>
</span><a name="line-1478"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-1479"></a><span>
</span><a name="line-1480"></a><span class="hs-identifier">lookupMkIntegerName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-1481"></a><a name="lookupMkIntegerName"><a href="CorePrep.html#lookupMkIntegerName"><span class="hs-identifier">lookupMkIntegerName</span></a></a><span> </span><a name="local-6989586621682027655"><a href="#local-6989586621682027655"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682027656"><a href="#local-6989586621682027656"><span class="hs-identifier">hsc_env</span></a></a><span>
</span><a name="line-1482"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#guardIntegerUse"><span class="hs-identifier hs-var">guardIntegerUse</span></a><span> </span><a href="#local-6989586621682027655"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-identifier hs-var">tyThingId</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1483"></a><span>      </span><a href="TcEnv.html#lookupGlobal"><span class="hs-identifier hs-var">lookupGlobal</span></a><span> </span><a href="#local-6989586621682027656"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-identifier hs-var">mkIntegerName</span><span>
</span><a name="line-1484"></a><span>
</span><a name="line-1485"></a><span class="hs-identifier">lookupMkNaturalName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-1486"></a><a name="lookupMkNaturalName"><a href="CorePrep.html#lookupMkNaturalName"><span class="hs-identifier">lookupMkNaturalName</span></a></a><span> </span><a name="local-6989586621682027657"><a href="#local-6989586621682027657"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682027658"><a href="#local-6989586621682027658"><span class="hs-identifier">hsc_env</span></a></a><span>
</span><a name="line-1487"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#guardNaturalUse"><span class="hs-identifier hs-var">guardNaturalUse</span></a><span> </span><a href="#local-6989586621682027657"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-identifier hs-var">tyThingId</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1488"></a><span>      </span><a href="TcEnv.html#lookupGlobal"><span class="hs-identifier hs-var">lookupGlobal</span></a><span> </span><a href="#local-6989586621682027658"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-identifier hs-var">mkNaturalName</span><span>
</span><a name="line-1489"></a><span>
</span><a name="line-1490"></a><span class="hs-comment">-- See Note [The integer library] in PrelNames</span><span>
</span><a name="line-1491"></a><span class="hs-identifier">lookupIntegerSDataConName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span class="hs-special">)</span><span>
</span><a name="line-1492"></a><a name="lookupIntegerSDataConName"><a href="CorePrep.html#lookupIntegerSDataConName"><span class="hs-identifier">lookupIntegerSDataConName</span></a></a><span> </span><a name="local-6989586621682027659"><a href="#local-6989586621682027659"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682027660"><a href="#local-6989586621682027660"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">integerLibrary</span><span> </span><a href="#local-6989586621682027659"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1493"></a><span>    </span><span class="hs-identifier hs-var">IntegerGMP</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#guardIntegerUse"><span class="hs-identifier hs-var">guardIntegerUse</span></a><span> </span><a href="#local-6989586621682027659"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">tyThingDataCon</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1494"></a><span>                  </span><a href="TcEnv.html#lookupGlobal"><span class="hs-identifier hs-var">lookupGlobal</span></a><span> </span><a href="#local-6989586621682027660"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-identifier hs-var">integerSDataConName</span><span>
</span><a name="line-1495"></a><span>    </span><span class="hs-identifier hs-var">IntegerSimple</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1496"></a><span>
</span><a name="line-1497"></a><span class="hs-identifier">lookupNaturalSDataConName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span class="hs-special">)</span><span>
</span><a name="line-1498"></a><a name="lookupNaturalSDataConName"><a href="CorePrep.html#lookupNaturalSDataConName"><span class="hs-identifier">lookupNaturalSDataConName</span></a></a><span> </span><a name="local-6989586621682027661"><a href="#local-6989586621682027661"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682027662"><a href="#local-6989586621682027662"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">integerLibrary</span><span> </span><a href="#local-6989586621682027661"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1499"></a><span>    </span><span class="hs-identifier hs-var">IntegerGMP</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#guardNaturalUse"><span class="hs-identifier hs-var">guardNaturalUse</span></a><span> </span><a href="#local-6989586621682027661"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">tyThingDataCon</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1500"></a><span>                  </span><a href="TcEnv.html#lookupGlobal"><span class="hs-identifier hs-var">lookupGlobal</span></a><span> </span><a href="#local-6989586621682027662"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-identifier hs-var">naturalSDataConName</span><span>
</span><a name="line-1501"></a><span>    </span><span class="hs-identifier hs-var">IntegerSimple</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1502"></a><span>
</span><a name="line-1503"></a><span class="hs-comment">-- | Helper for 'lookupMkIntegerName', 'lookupIntegerSDataConName'</span><span>
</span><a name="line-1504"></a><span class="hs-identifier">guardIntegerUse</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621682027184"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621682027184"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1505"></a><a name="guardIntegerUse"><a href="CorePrep.html#guardIntegerUse"><span class="hs-identifier">guardIntegerUse</span></a></a><span> </span><a name="local-6989586621682027663"><a href="#local-6989586621682027663"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682027664"><a href="#local-6989586621682027664"><span class="hs-identifier">act</span></a></a><span>
</span><a name="line-1506"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">thisPackage</span><span> </span><a href="#local-6989586621682027663"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">primUnitId</span><span>
</span><a name="line-1507"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;Can't use Integer in ghc-prim&quot;</span><span>
</span><a name="line-1508"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">thisPackage</span><span> </span><a href="#local-6989586621682027663"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">integerUnitId</span><span>
</span><a name="line-1509"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;Can't use Integer in integer-*&quot;</span><span>
</span><a name="line-1510"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027664"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-1511"></a><span>
</span><a name="line-1512"></a><span class="hs-comment">-- | Helper for 'lookupMkNaturalName', 'lookupNaturalSDataConName'</span><span>
</span><a name="line-1513"></a><span class="hs-comment">--</span><span>
</span><a name="line-1514"></a><span class="hs-comment">-- Just like we can't use Integer literals in `integer-*`, we can't use Natural</span><span>
</span><a name="line-1515"></a><span class="hs-comment">-- literals in `base`. If we do, we get interface loading error for GHC.Natural.</span><span>
</span><a name="line-1516"></a><span class="hs-identifier">guardNaturalUse</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621682027183"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621682027183"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1517"></a><a name="guardNaturalUse"><a href="CorePrep.html#guardNaturalUse"><span class="hs-identifier">guardNaturalUse</span></a></a><span> </span><a name="local-6989586621682027665"><a href="#local-6989586621682027665"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682027666"><a href="#local-6989586621682027666"><span class="hs-identifier">act</span></a></a><span>
</span><a name="line-1518"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">thisPackage</span><span> </span><a href="#local-6989586621682027665"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">primUnitId</span><span>
</span><a name="line-1519"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;Can't use Natural in ghc-prim&quot;</span><span>
</span><a name="line-1520"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">thisPackage</span><span> </span><a href="#local-6989586621682027665"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">integerUnitId</span><span>
</span><a name="line-1521"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;Can't use Natural in integer-*&quot;</span><span>
</span><a name="line-1522"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">thisPackage</span><span> </span><a href="#local-6989586621682027665"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">baseUnitId</span><span>
</span><a name="line-1523"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;Can't use Natural in base&quot;</span><span>
</span><a name="line-1524"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027666"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-1525"></a><span>
</span><a name="line-1526"></a><span class="hs-identifier">mkInitialCorePrepEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="CorePrep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a><span>
</span><a name="line-1527"></a><a name="mkInitialCorePrepEnv"><a href="CorePrep.html#mkInitialCorePrepEnv"><span class="hs-identifier">mkInitialCorePrepEnv</span></a></a><span> </span><a name="local-6989586621682027667"><a href="#local-6989586621682027667"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682027668"><a href="#local-6989586621682027668"><span class="hs-identifier">hsc_env</span></a></a><span>
</span><a name="line-1528"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621682027669"><a href="#local-6989586621682027669"><span class="hs-identifier">mkIntegerId</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#lookupMkIntegerName"><span class="hs-identifier hs-var">lookupMkIntegerName</span></a><span> </span><a href="#local-6989586621682027667"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682027668"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1529"></a><span>         </span><a name="local-6989586621682027670"><a href="#local-6989586621682027670"><span class="hs-identifier">mkNaturalId</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#lookupMkNaturalName"><span class="hs-identifier hs-var">lookupMkNaturalName</span></a><span> </span><a href="#local-6989586621682027667"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682027668"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1530"></a><span>         </span><a name="local-6989586621682027671"><a href="#local-6989586621682027671"><span class="hs-identifier">integerSDataCon</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#lookupIntegerSDataConName"><span class="hs-identifier hs-var">lookupIntegerSDataConName</span></a><span> </span><a href="#local-6989586621682027667"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682027668"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1531"></a><span>         </span><a name="local-6989586621682027672"><a href="#local-6989586621682027672"><span class="hs-identifier">naturalSDataCon</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#lookupNaturalSDataConName"><span class="hs-identifier hs-var">lookupNaturalSDataConName</span></a><span> </span><a href="#local-6989586621682027667"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682027668"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1532"></a><span>         </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CorePrep.html#CPE"><span class="hs-identifier hs-var">CPE</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1533"></a><span>                      </span><span class="hs-identifier">cpe_dynFlags</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027667"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">,</span><span>
</span><a name="line-1534"></a><span>                      </span><span class="hs-identifier">cpe_env</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyVarEnv</span><span class="hs-special">,</span><span>
</span><a name="line-1535"></a><span>                      </span><span class="hs-identifier">cpe_mkIntegerId</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027669"><span class="hs-identifier hs-var">mkIntegerId</span></a><span class="hs-special">,</span><span>
</span><a name="line-1536"></a><span>                      </span><span class="hs-identifier">cpe_mkNaturalId</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027670"><span class="hs-identifier hs-var">mkNaturalId</span></a><span class="hs-special">,</span><span>
</span><a name="line-1537"></a><span>                      </span><span class="hs-identifier">cpe_integerSDataCon</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027671"><span class="hs-identifier hs-var">integerSDataCon</span></a><span class="hs-special">,</span><span>
</span><a name="line-1538"></a><span>                      </span><span class="hs-identifier">cpe_naturalSDataCon</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027672"><span class="hs-identifier hs-var">naturalSDataCon</span></a><span>
</span><a name="line-1539"></a><span>                  </span><span class="hs-special">}</span><span>
</span><a name="line-1540"></a><span>
</span><a name="line-1541"></a><span class="hs-identifier">extendCorePrepEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CorePrep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a><span>
</span><a name="line-1542"></a><a name="extendCorePrepEnv"><a href="CorePrep.html#extendCorePrepEnv"><span class="hs-identifier">extendCorePrepEnv</span></a></a><span> </span><a name="local-6989586621682027673"><a href="#local-6989586621682027673"><span class="hs-identifier">cpe</span></a></a><span> </span><a name="local-6989586621682027674"><a href="#local-6989586621682027674"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621682027675"><a href="#local-6989586621682027675"><span class="hs-identifier">id'</span></a></a><span>
</span><a name="line-1543"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027673"><span class="hs-identifier hs-var">cpe</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cpe_env</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendVarEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cpe_env</span><span> </span><a href="#local-6989586621682027673"><span class="hs-identifier hs-var">cpe</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027674"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621682027675"><span class="hs-identifier hs-var">id'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1544"></a><span>
</span><a name="line-1545"></a><span class="hs-identifier">extendCorePrepEnvExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CorePrep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a><span>
</span><a name="line-1546"></a><a name="extendCorePrepEnvExpr"><a href="CorePrep.html#extendCorePrepEnvExpr"><span class="hs-identifier">extendCorePrepEnvExpr</span></a></a><span> </span><a name="local-6989586621682027676"><a href="#local-6989586621682027676"><span class="hs-identifier">cpe</span></a></a><span> </span><a name="local-6989586621682027677"><a href="#local-6989586621682027677"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621682027678"><a href="#local-6989586621682027678"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-1547"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027676"><span class="hs-identifier hs-var">cpe</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cpe_env</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendVarEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cpe_env</span><span> </span><a href="#local-6989586621682027676"><span class="hs-identifier hs-var">cpe</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027677"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621682027678"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1548"></a><span>
</span><a name="line-1549"></a><span class="hs-identifier">extendCorePrepEnvList</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CorePrep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CorePrep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a><span>
</span><a name="line-1550"></a><a name="extendCorePrepEnvList"><a href="CorePrep.html#extendCorePrepEnvList"><span class="hs-identifier">extendCorePrepEnvList</span></a></a><span> </span><a name="local-6989586621682027679"><a href="#local-6989586621682027679"><span class="hs-identifier">cpe</span></a></a><span> </span><a name="local-6989586621682027680"><a href="#local-6989586621682027680"><span class="hs-identifier">prs</span></a></a><span>
</span><a name="line-1551"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027679"><span class="hs-identifier hs-var">cpe</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cpe_env</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendVarEnvList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cpe_env</span><span> </span><a href="#local-6989586621682027679"><span class="hs-identifier hs-var">cpe</span></a><span class="hs-special">)</span><span>
</span><a name="line-1552"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621682027681"><a href="#local-6989586621682027681"><span class="hs-identifier">id</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027682"><a href="#local-6989586621682027682"><span class="hs-identifier">id'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027681"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621682027682"><span class="hs-identifier hs-var">id'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027680"><span class="hs-identifier hs-var">prs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1553"></a><span>
</span><a name="line-1554"></a><span class="hs-identifier">lookupCorePrepEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CorePrep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-1555"></a><a name="lookupCorePrepEnv"><a href="CorePrep.html#lookupCorePrepEnv"><span class="hs-identifier">lookupCorePrepEnv</span></a></a><span> </span><a name="local-6989586621682027683"><a href="#local-6989586621682027683"><span class="hs-identifier">cpe</span></a></a><span> </span><a name="local-6989586621682027684"><a href="#local-6989586621682027684"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-1556"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupVarEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cpe_env</span><span> </span><a href="#local-6989586621682027683"><span class="hs-identifier hs-var">cpe</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027684"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1557"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621682027684"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-1558"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682027685"><a href="#local-6989586621682027685"><span class="hs-identifier">exp</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682027685"><span class="hs-identifier hs-var">exp</span></a><span>
</span><a name="line-1559"></a><span>
</span><a name="line-1560"></a><span class="hs-identifier">getMkIntegerId</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CorePrep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-1561"></a><a name="getMkIntegerId"><a href="CorePrep.html#getMkIntegerId"><span class="hs-identifier">getMkIntegerId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cpe_mkIntegerId</span><span>
</span><a name="line-1562"></a><span>
</span><a name="line-1563"></a><span class="hs-identifier">getMkNaturalId</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CorePrep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-1564"></a><a name="getMkNaturalId"><a href="CorePrep.html#getMkNaturalId"><span class="hs-identifier">getMkNaturalId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cpe_mkNaturalId</span><span>
</span><a name="line-1565"></a><span>
</span><a name="line-1566"></a><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><a name="line-1567"></a><span class="hs-comment">-- Cloning binders</span><span>
</span><a name="line-1568"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-1569"></a><span>
</span><a name="line-1570"></a><span class="hs-identifier">cpCloneBndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CorePrep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">InVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">OutVar</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1571"></a><a name="cpCloneBndrs"><a href="CorePrep.html#cpCloneBndrs"><span class="hs-identifier">cpCloneBndrs</span></a></a><span> </span><a name="local-6989586621682027686"><a href="#local-6989586621682027686"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682027687"><a href="#local-6989586621682027687"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAccumLM</span><span> </span><a href="CorePrep.html#cpCloneBndr"><span class="hs-identifier hs-var">cpCloneBndr</span></a><span> </span><a href="#local-6989586621682027686"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027687"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-1572"></a><span>
</span><a name="line-1573"></a><span class="hs-identifier">cpCloneBndr</span><span>  </span><span class="hs-glyph">::</span><span> </span><a href="CorePrep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">InVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#CorePrepEnv"><span class="hs-identifier hs-type">CorePrepEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">OutVar</span><span class="hs-special">)</span><span>
</span><a name="line-1574"></a><a name="cpCloneBndr"><a href="CorePrep.html#cpCloneBndr"><span class="hs-identifier">cpCloneBndr</span></a></a><span> </span><a name="local-6989586621682027688"><a href="#local-6989586621682027688"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682027689"><a href="#local-6989586621682027689"><span class="hs-identifier">bndr</span></a></a><span>
</span><a name="line-1575"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isId</span><span> </span><a href="#local-6989586621682027689"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1576"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027688"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027689"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1577"></a><span>
</span><a name="line-1578"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1579"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682027693"><a href="#local-6989586621682027693"><span class="hs-identifier">bndr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682027690"><span class="hs-identifier hs-var">clone_it</span></a><span> </span><a href="#local-6989586621682027689"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1580"></a><span>
</span><a name="line-1581"></a><span>       </span><span class="hs-comment">-- Drop (now-useless) rules/unfoldings</span><span>
</span><a name="line-1582"></a><span>       </span><span class="hs-comment">-- See Note [Drop unfoldings and rules]</span><span>
</span><a name="line-1583"></a><span>       </span><span class="hs-comment">-- and Note [Preserve evaluatedness] in CoreTidy</span><span>
</span><a name="line-1584"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682027694"><a href="#local-6989586621682027694"><span class="hs-identifier">unfolding'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zapUnfolding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">realIdUnfolding</span><span> </span><a href="#local-6989586621682027689"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1585"></a><span>                          </span><span class="hs-comment">-- Simplifier will set the Id's unfolding</span><span>
</span><a name="line-1586"></a><span>
</span><a name="line-1587"></a><span>             </span><a name="local-6989586621682027695"><a href="#local-6989586621682027695"><span class="hs-identifier">bndr''</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682027693"><span class="hs-identifier hs-var">bndr'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setIdUnfolding</span><span class="hs-special">`</span><span>      </span><a href="#local-6989586621682027694"><span class="hs-identifier hs-var">unfolding'</span></a><span>
</span><a name="line-1588"></a><span>                            </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setIdSpecialisation</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">emptyRuleInfo</span><span>
</span><a name="line-1589"></a><span>
</span><a name="line-1590"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#extendCorePrepEnv"><span class="hs-identifier hs-var">extendCorePrepEnv</span></a><span> </span><a href="#local-6989586621682027688"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682027689"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621682027695"><span class="hs-identifier hs-var">bndr''</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027695"><span class="hs-identifier hs-var">bndr''</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1591"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1592"></a><span>    </span><a name="local-6989586621682027690"><a href="#local-6989586621682027690"><span class="hs-identifier">clone_it</span></a></a><span> </span><a name="local-6989586621682027691"><a href="#local-6989586621682027691"><span class="hs-identifier">bndr</span></a></a><span>
</span><a name="line-1593"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isLocalId</span><span> </span><a href="#local-6989586621682027691"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isCoVar</span><span> </span><a href="#local-6989586621682027691"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1594"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682027692"><a href="#local-6989586621682027692"><span class="hs-identifier">uniq</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getUniqueM</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">setVarUnique</span><span> </span><a href="#local-6989586621682027691"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621682027692"><span class="hs-identifier hs-var">uniq</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1595"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-comment">-- Top level things, which we don't want</span><span>
</span><a name="line-1596"></a><span>                    </span><span class="hs-comment">-- to clone, have become GlobalIds by now</span><span>
</span><a name="line-1597"></a><span>                    </span><span class="hs-comment">-- And we don't clone tyvars, or coercion variables</span><span>
</span><a name="line-1598"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682027691"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1599"></a><span>
</span><a name="line-1600"></a><span class="hs-comment">{- Note [Drop unfoldings and rules]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We want to drop the unfolding/rules on every Id:

  - We are now past interface-file generation, and in the
    codegen pipeline, so we really don't need full unfoldings/rules

  - The unfolding/rule may be keeping stuff alive that we'd like
    to discard.  See  Note [Dead code in CorePrep]

  - Getting rid of unnecessary unfoldings reduces heap usage

  - We are changing uniques, so if we didn't discard unfoldings/rules
    we'd have to substitute in them

HOWEVER, we want to preserve evaluated-ness;
see Note [Preserve evaluatedness] in CoreTidy.
-}</span><span>
</span><a name="line-1618"></a><span>
</span><a name="line-1619"></a><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><a name="line-1620"></a><span class="hs-comment">-- Cloning ccall Ids; each must have a unique name,</span><span>
</span><a name="line-1621"></a><span class="hs-comment">-- to give the code generator a handle to hang it on</span><span>
</span><a name="line-1622"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-1623"></a><span>
</span><a name="line-1624"></a><span class="hs-identifier">fiddleCCall</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-1625"></a><a name="fiddleCCall"><a href="CorePrep.html#fiddleCCall"><span class="hs-identifier">fiddleCCall</span></a></a><span> </span><a name="local-6989586621682027696"><a href="#local-6989586621682027696"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-1626"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isFCallId</span><span> </span><a href="#local-6989586621682027696"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027696"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setVarUnique</span><span class="hs-special">`</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">getUniqueM</span><span>
</span><a name="line-1627"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682027696"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-1628"></a><span>
</span><a name="line-1629"></a><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><a name="line-1630"></a><span class="hs-comment">-- Generating new binders</span><span>
</span><a name="line-1631"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-1632"></a><span>
</span><a name="line-1633"></a><span class="hs-identifier">newVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-1634"></a><a name="newVar"><a href="CorePrep.html#newVar"><span class="hs-identifier">newVar</span></a></a><span> </span><a name="local-6989586621682027697"><a href="#local-6989586621682027697"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1635"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">seqType</span><span> </span><a href="#local-6989586621682027697"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1636"></a><span>     </span><a name="local-6989586621682027698"><a href="#local-6989586621682027698"><span class="hs-identifier">uniq</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getUniqueM</span><span>
</span><a name="line-1637"></a><span>     </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkSysLocalOrCoVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;sat&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027698"><span class="hs-identifier hs-var">uniq</span></a><span> </span><a href="#local-6989586621682027697"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1638"></a><span>
</span><a name="line-1639"></a><span>
</span><a name="line-1640"></a><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><a name="line-1641"></a><span class="hs-comment">-- Floating ticks</span><span>
</span><a name="line-1642"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-1643"></a><span class="hs-comment">--</span><span>
</span><a name="line-1644"></a><span class="hs-comment">-- Note [Floating Ticks in CorePrep]</span><span>
</span><a name="line-1645"></a><span class="hs-comment">--</span><span>
</span><a name="line-1646"></a><span class="hs-comment">-- It might seem counter-intuitive to float ticks by default, given</span><span>
</span><a name="line-1647"></a><span class="hs-comment">-- that we don't actually want to move them if we can help it. On the</span><span>
</span><a name="line-1648"></a><span class="hs-comment">-- other hand, nothing gets very far in CorePrep anyway, and we want</span><span>
</span><a name="line-1649"></a><span class="hs-comment">-- to preserve the order of let bindings and tick annotations in</span><span>
</span><a name="line-1650"></a><span class="hs-comment">-- relation to each other. For example, if we just wrapped let floats</span><span>
</span><a name="line-1651"></a><span class="hs-comment">-- when they pass through ticks, we might end up performing the</span><span>
</span><a name="line-1652"></a><span class="hs-comment">-- following transformation:</span><span>
</span><a name="line-1653"></a><span class="hs-comment">--</span><span>
</span><a name="line-1654"></a><span class="hs-comment">--   src&lt;...&gt; let foo = bar in baz</span><span>
</span><a name="line-1655"></a><span class="hs-comment">--   ==&gt;  let foo = src&lt;...&gt; bar in src&lt;...&gt; baz</span><span>
</span><a name="line-1656"></a><span class="hs-comment">--</span><span>
</span><a name="line-1657"></a><span class="hs-comment">-- Because the let-binding would float through the tick, and then</span><span>
</span><a name="line-1658"></a><span class="hs-comment">-- immediately materialize, achieving nothing but decreasing tick</span><span>
</span><a name="line-1659"></a><span class="hs-comment">-- accuracy. The only special case is the following scenario:</span><span>
</span><a name="line-1660"></a><span class="hs-comment">--</span><span>
</span><a name="line-1661"></a><span class="hs-comment">--   let foo = src&lt;...&gt; (let a = b in bar) in baz</span><span>
</span><a name="line-1662"></a><span class="hs-comment">--   ==&gt;  let foo = src&lt;...&gt; bar; a = src&lt;...&gt; b in baz</span><span>
</span><a name="line-1663"></a><span class="hs-comment">--</span><span>
</span><a name="line-1664"></a><span class="hs-comment">-- Here we would not want the source tick to end up covering &quot;baz&quot; and</span><span>
</span><a name="line-1665"></a><span class="hs-comment">-- therefore refrain from pushing ticks outside. Instead, we copy them</span><span>
</span><a name="line-1666"></a><span class="hs-comment">-- into the floating binds (here &quot;a&quot;) in cpePair. Note that where &quot;b&quot;</span><span>
</span><a name="line-1667"></a><span class="hs-comment">-- or &quot;bar&quot; are (value) lambdas we have to push the annotations</span><span>
</span><a name="line-1668"></a><span class="hs-comment">-- further inside in order to uphold our rules.</span><span>
</span><a name="line-1669"></a><span class="hs-comment">--</span><span>
</span><a name="line-1670"></a><span class="hs-comment">-- All of this is implemented below in @wrapTicks@.</span><span>
</span><a name="line-1671"></a><span>
</span><a name="line-1672"></a><span class="hs-comment">-- | Like wrapFloats, but only wraps tick floats</span><span>
</span><a name="line-1673"></a><span class="hs-identifier">wrapTicks</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-type">Floats</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span>
</span><a name="line-1674"></a><a name="wrapTicks"><a href="CorePrep.html#wrapTicks"><span class="hs-identifier">wrapTicks</span></a></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a><span> </span><a name="local-6989586621682027699"><a href="#local-6989586621682027699"><span class="hs-identifier">flag</span></a></a><span> </span><a name="local-6989586621682027700"><a href="#local-6989586621682027700"><span class="hs-identifier">floats0</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682027701"><a href="#local-6989586621682027701"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1675"></a><span>    </span><span class="hs-special">(</span><a href="CorePrep.html#Floats"><span class="hs-identifier hs-var">Floats</span></a><span> </span><a href="#local-6989586621682027699"><span class="hs-identifier hs-var">flag</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toOL</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621682027702"><span class="hs-identifier hs-var">floats1</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-identifier hs-var">mkTick</span><span> </span><a href="#local-6989586621682027701"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621682027703"><span class="hs-identifier hs-var">ticks1</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1676"></a><span>  </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027702"><a href="#local-6989586621682027702"><span class="hs-identifier">floats1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027703"><a href="#local-6989586621682027703"><span class="hs-identifier">ticks1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldlOL</span><span> </span><a href="#local-6989586621682027704"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682027700"><span class="hs-identifier hs-var">floats0</span></a><span>
</span><a name="line-1677"></a><span>        </span><span class="hs-comment">-- Deeply nested constructors will produce long lists of</span><span>
</span><a name="line-1678"></a><span>        </span><span class="hs-comment">-- redundant source note floats here. We need to eliminate</span><span>
</span><a name="line-1679"></a><span>        </span><span class="hs-comment">-- those early, as relying on mkTick to spot it after the fact</span><span>
</span><a name="line-1680"></a><span>        </span><span class="hs-comment">-- can yield O(n^3) complexity [#11095]</span><span>
</span><a name="line-1681"></a><span>        </span><a name="local-6989586621682027704"><a href="#local-6989586621682027704"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682027707"><a href="#local-6989586621682027707"><span class="hs-identifier">floats</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027708"><a href="#local-6989586621682027708"><span class="hs-identifier">ticks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CorePrep.html#FloatTick"><span class="hs-identifier hs-var">FloatTick</span></a><span> </span><a name="local-6989586621682027709"><a href="#local-6989586621682027709"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1682"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier">tickishPlace</span><span> </span><span class="hs-identifier">t</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">PlaceNonLam</span><span class="hs-special">)</span><span>
</span><a name="line-1683"></a><span>            </span><span class="hs-special">(</span><a href="#local-6989586621682027707"><span class="hs-identifier hs-var">floats</span></a><span class="hs-special">,</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier hs-var">tickishContains</span><span> </span><a href="#local-6989586621682027709"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027708"><span class="hs-identifier hs-var">ticks</span></a><span>
</span><a name="line-1684"></a><span>                     </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621682027708"><span class="hs-identifier hs-var">ticks</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621682027709"><span class="hs-identifier hs-var">t</span></a><span class="hs-glyph">:</span><a href="#local-6989586621682027708"><span class="hs-identifier hs-var">ticks</span></a><span class="hs-special">)</span><span>
</span><a name="line-1685"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682027710"><a href="#local-6989586621682027710"><span class="hs-identifier">floats</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027711"><a href="#local-6989586621682027711"><span class="hs-identifier">ticks</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682027712"><a href="#local-6989586621682027712"><span class="hs-identifier">f</span></a></a><span>
</span><a name="line-1686"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621682027705"><span class="hs-identifier hs-var">wrap</span></a><span> </span><a href="#local-6989586621682027712"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621682027711"><span class="hs-identifier hs-var">ticks</span></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a href="#local-6989586621682027710"><span class="hs-identifier hs-var">floats</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682027711"><span class="hs-identifier hs-var">ticks</span></a><span class="hs-special">)</span><span>
</span><a name="line-1687"></a><span>
</span><a name="line-1688"></a><span>        </span><a name="local-6989586621682027705"><a href="#local-6989586621682027705"><span class="hs-identifier">wrap</span></a></a><span> </span><a name="local-6989586621682027713"><a href="#local-6989586621682027713"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#FloatLet"><span class="hs-identifier hs-var">FloatLet</span></a><span> </span><a name="local-6989586621682027714"><a href="#local-6989586621682027714"><span class="hs-identifier">bind</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#FloatLet"><span class="hs-identifier hs-var">FloatLet</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027706"><span class="hs-identifier hs-var">wrapBind</span></a><span> </span><a href="#local-6989586621682027713"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621682027714"><span class="hs-identifier hs-var">bind</span></a><span class="hs-special">)</span><span>
</span><a name="line-1689"></a><span>        </span><span class="hs-identifier">wrap</span><span> </span><a name="local-6989586621682027715"><a href="#local-6989586621682027715"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-special">(</span><a href="CorePrep.html#FloatCase"><span class="hs-identifier hs-var">FloatCase</span></a><span> </span><a name="local-6989586621682027716"><a href="#local-6989586621682027716"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621682027717"><a href="#local-6989586621682027717"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682027718"><a href="#local-6989586621682027718"><span class="hs-identifier">ok</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CorePrep.html#FloatCase"><span class="hs-identifier hs-var">FloatCase</span></a><span> </span><a href="#local-6989586621682027716"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTick</span><span> </span><a href="#local-6989586621682027715"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621682027717"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027718"><span class="hs-identifier hs-var">ok</span></a><span>
</span><a name="line-1690"></a><span>        </span><span class="hs-identifier">wrap</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682027719"><a href="#local-6989586621682027719"><span class="hs-identifier">other</span></a></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;wrapTicks: unexpected float!&quot;</span><span>
</span><a name="line-1691"></a><span>                                             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682027719"><span class="hs-identifier hs-var">other</span></a><span class="hs-special">)</span><span>
</span><a name="line-1692"></a><span>        </span><a name="local-6989586621682027706"><a href="#local-6989586621682027706"><span class="hs-identifier">wrapBind</span></a></a><span> </span><a name="local-6989586621682027720"><a href="#local-6989586621682027720"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a name="local-6989586621682027721"><a href="#local-6989586621682027721"><span class="hs-identifier">binder</span></a></a><span> </span><a name="local-6989586621682027722"><a href="#local-6989586621682027722"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621682027721"><span class="hs-identifier hs-var">binder</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTick</span><span> </span><a href="#local-6989586621682027720"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621682027722"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1693"></a><span>        </span><span class="hs-identifier">wrapBind</span><span> </span><a name="local-6989586621682027723"><a href="#local-6989586621682027723"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><a name="local-6989586621682027724"><a href="#local-6989586621682027724"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Rec</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapSnd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTick</span><span> </span><a href="#local-6989586621682027723"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027724"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1694"></a><span>
</span><a name="line-1695"></a><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><a name="line-1696"></a><span class="hs-comment">-- Collecting cost centres</span><span>
</span><a name="line-1697"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-1698"></a><span>
</span><a name="line-1699"></a><span class="hs-comment">-- | Collect cost centres defined in the current module, including those in</span><span>
</span><a name="line-1700"></a><span class="hs-comment">-- unfoldings.</span><span>
</span><a name="line-1701"></a><span class="hs-identifier">collectCostCentres</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">S.Set</span><span> </span><span class="hs-identifier hs-type">CostCentre</span><span>
</span><a name="line-1702"></a><a name="collectCostCentres"><a href="CorePrep.html#collectCostCentres"><span class="hs-identifier">collectCostCentres</span></a></a><span> </span><a name="local-6989586621682027725"><a href="#local-6989586621682027725"><span class="hs-identifier">mod_name</span></a></a><span>
</span><a name="line-1703"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="#local-6989586621682027728"><span class="hs-identifier hs-var">go_bind</span></a><span> </span><span class="hs-identifier hs-var">S.empty</span><span>
</span><a name="line-1704"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1705"></a><span>    </span><a name="local-6989586621682027726"><a href="#local-6989586621682027726"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621682027730"><a href="#local-6989586621682027730"><span class="hs-identifier">cs</span></a></a><span> </span><a name="local-6989586621682027731"><a href="#local-6989586621682027731"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682027731"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1706"></a><span>      </span><span class="hs-identifier hs-var">Var</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682027730"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-1707"></a><span>      </span><span class="hs-identifier hs-var">Lit</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682027730"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-1708"></a><span>      </span><span class="hs-identifier hs-var">App</span><span> </span><a name="local-6989586621682027732"><a href="#local-6989586621682027732"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-6989586621682027733"><a href="#local-6989586621682027733"><span class="hs-identifier">e2</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682027726"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027726"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682027730"><span class="hs-identifier hs-var">cs</span></a><span> </span><a href="#local-6989586621682027732"><span class="hs-identifier hs-var">e1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027733"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-1709"></a><span>      </span><span class="hs-identifier hs-var">Lam</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682027734"><a href="#local-6989586621682027734"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682027726"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682027730"><span class="hs-identifier hs-var">cs</span></a><span> </span><a href="#local-6989586621682027734"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1710"></a><span>      </span><span class="hs-identifier hs-var">Let</span><span> </span><a name="local-6989586621682027735"><a href="#local-6989586621682027735"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621682027736"><a href="#local-6989586621682027736"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682027726"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027728"><span class="hs-identifier hs-var">go_bind</span></a><span> </span><a href="#local-6989586621682027730"><span class="hs-identifier hs-var">cs</span></a><span> </span><a href="#local-6989586621682027735"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027736"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1711"></a><span>      </span><span class="hs-identifier hs-var">Case</span><span> </span><a name="local-6989586621682027737"><a href="#local-6989586621682027737"><span class="hs-identifier">scrt</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682027738"><a href="#local-6989586621682027738"><span class="hs-identifier">alts</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682027727"><span class="hs-identifier hs-var">go_alts</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027726"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682027730"><span class="hs-identifier hs-var">cs</span></a><span> </span><a href="#local-6989586621682027737"><span class="hs-identifier hs-var">scrt</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027738"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-1712"></a><span>      </span><span class="hs-identifier hs-var">Cast</span><span> </span><a name="local-6989586621682027739"><a href="#local-6989586621682027739"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682027726"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682027730"><span class="hs-identifier hs-var">cs</span></a><span> </span><a href="#local-6989586621682027739"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1713"></a><span>      </span><span class="hs-identifier hs-var">Tick</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ProfNote</span><span> </span><a name="local-6989586621682027740"><a href="#local-6989586621682027740"><span class="hs-identifier">cc</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682027741"><a href="#local-6989586621682027741"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1714"></a><span>        </span><a href="#local-6989586621682027726"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">ccFromThisModule</span><span> </span><a href="#local-6989586621682027740"><span class="hs-identifier hs-var">cc</span></a><span> </span><a href="#local-6989586621682027725"><span class="hs-identifier hs-var">mod_name</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">S.insert</span><span> </span><a href="#local-6989586621682027740"><span class="hs-identifier hs-var">cc</span></a><span> </span><a href="#local-6989586621682027730"><span class="hs-identifier hs-var">cs</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621682027730"><span class="hs-identifier hs-var">cs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027741"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1715"></a><span>      </span><span class="hs-identifier hs-var">Tick</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682027742"><a href="#local-6989586621682027742"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682027726"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682027730"><span class="hs-identifier hs-var">cs</span></a><span> </span><a href="#local-6989586621682027742"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1716"></a><span>      </span><span class="hs-identifier hs-var">Type</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682027730"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-1717"></a><span>      </span><span class="hs-identifier hs-var">Coercion</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682027730"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-1718"></a><span>
</span><a name="line-1719"></a><span>    </span><a name="local-6989586621682027727"><a href="#local-6989586621682027727"><span class="hs-identifier">go_alts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682027743"><a href="#local-6989586621682027743"><span class="hs-identifier">cs</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682027744"><a href="#local-6989586621682027744"><span class="hs-identifier">_con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027745"><a href="#local-6989586621682027745"><span class="hs-identifier">_bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027746"><a href="#local-6989586621682027746"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682027726"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682027743"><span class="hs-identifier hs-var">cs</span></a><span> </span><a href="#local-6989586621682027746"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-1720"></a><span>
</span><a name="line-1721"></a><span>    </span><span class="hs-identifier">go_bind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">S.Set</span><span> </span><span class="hs-identifier hs-type">CostCentre</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreBind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">S.Set</span><span> </span><span class="hs-identifier hs-type">CostCentre</span><span>
</span><a name="line-1722"></a><span>    </span><a name="local-6989586621682027728"><a href="#local-6989586621682027728"><span class="hs-identifier">go_bind</span></a></a><span> </span><a name="local-6989586621682027747"><a href="#local-6989586621682027747"><span class="hs-identifier">cs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a name="local-6989586621682027748"><a href="#local-6989586621682027748"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621682027749"><a href="#local-6989586621682027749"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1723"></a><span>      </span><a href="#local-6989586621682027726"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">maybe</span><span> </span><a href="#local-6989586621682027747"><span class="hs-identifier hs-var">cs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027726"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682027747"><span class="hs-identifier hs-var">cs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027729"><span class="hs-identifier hs-var">get_unf</span></a><span> </span><a href="#local-6989586621682027748"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027749"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1724"></a><span>    </span><span class="hs-identifier">go_bind</span><span> </span><a name="local-6989586621682027750"><a href="#local-6989586621682027750"><span class="hs-identifier">cs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><a name="local-6989586621682027751"><a href="#local-6989586621682027751"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1725"></a><span>      </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682027752"><a href="#local-6989586621682027752"><span class="hs-identifier">cs'</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682027753"><a href="#local-6989586621682027753"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682027754"><a href="#local-6989586621682027754"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682027726"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">maybe</span><span> </span><a href="#local-6989586621682027752"><span class="hs-identifier hs-var">cs'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027726"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682027752"><span class="hs-identifier hs-var">cs'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682027729"><span class="hs-identifier hs-var">get_unf</span></a><span> </span><a href="#local-6989586621682027753"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027754"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682027750"><span class="hs-identifier hs-var">cs</span></a><span> </span><a href="#local-6989586621682027751"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-1726"></a><span>
</span><a name="line-1727"></a><span>    </span><span class="hs-comment">-- Unfoldings may have cost centres that in the original definion are</span><span>
</span><a name="line-1728"></a><span>    </span><span class="hs-comment">-- optimized away, see #5889.</span><span>
</span><a name="line-1729"></a><span>    </span><a name="local-6989586621682027729"><a href="#local-6989586621682027729"><span class="hs-identifier">get_unf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybeUnfoldingTemplate</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">realIdUnfolding</span><span>
</span><a name="line-1730"></a></pre></body></html>