<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998


Desugaring list comprehensions, monad comprehensions and array comprehensions
-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE CPP, NamedFieldPuns #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE ViewPatterns #-}</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">DsListComp</span><span> </span><span class="hs-special">(</span><span> </span><a href="DsListComp.html#dsListComp"><span class="hs-identifier hs-var">dsListComp</span></a><span class="hs-special">,</span><span> </span><a href="DsListComp.html#dsMonadComp"><span class="hs-identifier hs-var">dsMonadComp</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE</span><span> </span><span class="hs-pragma">#-}</span><span> </span><a href="DsExpr.html"><span class="hs-identifier">DsExpr</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="DsExpr.html#dsExpr"><span class="hs-identifier hs-var">dsExpr</span></a><span class="hs-special">,</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span class="hs-special">,</span><span> </span><a href="DsExpr.html#dsLExprNoLP"><span class="hs-identifier hs-var">dsLExprNoLP</span></a><span class="hs-special">,</span><span> </span><a href="DsExpr.html#dsLocalBinds"><span class="hs-identifier hs-var">dsLocalBinds</span></a><span class="hs-special">,</span><span> </span><a href="DsExpr.html#dsSyntaxExpr"><span class="hs-identifier hs-var">dsSyntaxExpr</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="TcHsSyn.html"><span class="hs-identifier">TcHsSyn</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreSyn</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MkCore</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="DsMonad.html"><span class="hs-identifier">DsMonad</span></a><span>          </span><span class="hs-comment">-- the monadery used in the desugarer</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="DsUtils.html"><span class="hs-identifier">DsUtils</span></a><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreUtils</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysWiredIn</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="Match.html"><span class="hs-identifier">Match</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ListSetOps</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">getNth</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-41"></a><span>
</span><a name="line-42"></a><span class="hs-comment">{-
List comprehensions may be desugared in one of two ways: ``ordinary''
(as you would expect if you read SLPJ's book) and ``with foldr/build
turned on'' (if you read Gill {\em et al.}'s paper on the subject).

There will be at least one ``qualifier'' in the input.
-}</span><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span class="hs-identifier">dsListComp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ExprLStmt</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">]</span><span>
</span><a name="line-51"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>              </span><span class="hs-comment">-- Type of entire list</span><span>
</span><a name="line-52"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-53"></a><a name="dsListComp"><a href="DsListComp.html#dsListComp"><span class="hs-identifier">dsListComp</span></a></a><span> </span><a name="local-6989586621684090002"><a href="#local-6989586621684090002"><span class="hs-identifier">lquals</span></a></a><span> </span><a name="local-6989586621684090003"><a href="#local-6989586621684090003"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-54"></a><span>    </span><a name="local-6989586621684090006"><a href="#local-6989586621684090006"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-55"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684090007"><a href="#local-6989586621684090007"><span class="hs-identifier">quals</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621684090002"><span class="hs-identifier hs-var">lquals</span></a><span>
</span><a name="line-56"></a><span>        </span><a name="local-6989586621684090008"><a href="#local-6989586621684090008"><span class="hs-identifier">elt_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">tcTyConAppArgs</span><span> </span><a href="#local-6989586621684090003"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-57"></a><span>                   </span><span class="hs-special">[</span><a name="local-6989586621684090009"><a href="#local-6989586621684090009"><span class="hs-identifier">elt_ty</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684090009"><span class="hs-identifier hs-var">elt_ty</span></a><span>
</span><a name="line-58"></a><span>                   </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;dsListComp&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684090003"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684090002"><span class="hs-identifier hs-var">lquals</span></a><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_EnableRewriteRules</span><span> </span><a href="#local-6989586621684090006"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_IgnoreInterfacePragmas</span><span> </span><a href="#local-6989586621684090006"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-61"></a><span>       </span><span class="hs-comment">-- Either rules are switched off, or we are ignoring what there are;</span><span>
</span><a name="line-62"></a><span>       </span><span class="hs-comment">-- Either way foldr/build won't happen, so use the more efficient</span><span>
</span><a name="line-63"></a><span>       </span><span class="hs-comment">-- Wadler-style desugaring</span><span>
</span><a name="line-64"></a><span>       </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621684090004"><span class="hs-identifier hs-var">isParallelComp</span></a><span> </span><a href="#local-6989586621684090007"><span class="hs-identifier hs-var">quals</span></a><span>
</span><a name="line-65"></a><span>       </span><span class="hs-comment">-- Foldr-style desugaring can't handle parallel list comprehensions</span><span>
</span><a name="line-66"></a><span>        </span><span class="hs-keyword">then</span><span> </span><a href="DsListComp.html#deListComp"><span class="hs-identifier hs-var">deListComp</span></a><span> </span><a href="#local-6989586621684090007"><span class="hs-identifier hs-var">quals</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkNilExpr</span><span> </span><a href="#local-6989586621684090008"><span class="hs-identifier hs-var">elt_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">mkBuildExpr</span><span> </span><a href="#local-6989586621684090008"><span class="hs-identifier hs-var">elt_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621684090010"><a href="#local-6989586621684090010"><span class="hs-identifier">c</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684090011"><a href="#local-6989586621684090011"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsListComp.html#dfListComp"><span class="hs-identifier hs-var">dfListComp</span></a><span> </span><a href="#local-6989586621684090010"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-6989586621684090011"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621684090007"><span class="hs-identifier hs-var">quals</span></a><span class="hs-special">)</span><span>
</span><a name="line-68"></a><span>             </span><span class="hs-comment">-- Foldr/build should be enabled, so desugar</span><span>
</span><a name="line-69"></a><span>             </span><span class="hs-comment">-- into foldrs and builds</span><span>
</span><a name="line-70"></a><span>
</span><a name="line-71"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-72"></a><span>    </span><span class="hs-comment">-- We must test for ParStmt anywhere, not just at the head, because an extension</span><span>
</span><a name="line-73"></a><span>    </span><span class="hs-comment">-- to list comprehensions would be to add brackets to specify the associativity</span><span>
</span><a name="line-74"></a><span>    </span><span class="hs-comment">-- of qualifier lists. This is really easy to do by adding extra ParStmts into the</span><span>
</span><a name="line-75"></a><span>    </span><span class="hs-comment">-- mix of possibly a single element in length, so we do this to leave the possibility open</span><span>
</span><a name="line-76"></a><span>    </span><a name="local-6989586621684090004"><a href="#local-6989586621684090004"><span class="hs-identifier">isParallelComp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><a href="#local-6989586621684090005"><span class="hs-identifier hs-var">isParallelStmt</span></a><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span>    </span><a name="local-6989586621684090005"><a href="#local-6989586621684090005"><span class="hs-identifier">isParallelStmt</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-79"></a><span>    </span><span class="hs-identifier">isParallelStmt</span><span> </span><span class="hs-identifier">_</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span>
</span><a name="line-82"></a><span class="hs-comment">-- This function lets you desugar a inner list comprehension and a list of the binders</span><span>
</span><a name="line-83"></a><span class="hs-comment">-- of that comprehension that we need in the outer comprehension into such an expression</span><span>
</span><a name="line-84"></a><span class="hs-comment">-- and the type of the elements that it outputs (tuples of binders)</span><span>
</span><a name="line-85"></a><span class="hs-identifier">dsInnerListComp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ParStmtBlock</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span>
</span><a name="line-86"></a><a name="dsInnerListComp"><a href="DsListComp.html#dsInnerListComp"><span class="hs-identifier">dsInnerListComp</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParStmtBlock</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684090012"><a href="#local-6989586621684090012"><span class="hs-identifier">stmts</span></a></a><span> </span><a name="local-6989586621684090013"><a href="#local-6989586621684090013"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-87"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684090014"><a href="#local-6989586621684090014"><span class="hs-identifier">bndrs_tuple_type</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkBigCoreVarTupTy</span><span> </span><a href="#local-6989586621684090013"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-88"></a><span>             </span><a name="local-6989586621684090015"><a href="#local-6989586621684090015"><span class="hs-identifier">list_ty</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkListTy</span><span> </span><a href="#local-6989586621684090014"><span class="hs-identifier hs-var">bndrs_tuple_type</span></a><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span>             </span><span class="hs-comment">-- really use original bndrs below!</span><span>
</span><a name="line-91"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684090016"><a href="#local-6989586621684090016"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsListComp.html#dsListComp"><span class="hs-identifier hs-var">dsListComp</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684090012"><span class="hs-identifier hs-var">stmts</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkLastStmt</span><span> </span><span class="hs-special">(</span><a href="DsUtils.html#mkBigLHsVarTupId"><span class="hs-identifier hs-var">mkBigLHsVarTupId</span></a><span> </span><a href="#local-6989586621684090013"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684090015"><span class="hs-identifier hs-var">list_ty</span></a><span>
</span><a name="line-92"></a><span>
</span><a name="line-93"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684090016"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684090014"><span class="hs-identifier hs-var">bndrs_tuple_type</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-94"></a><span class="hs-identifier">dsInnerListComp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XParStmtBlock</span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsInnerListComp&quot;</span><span>
</span><a name="line-95"></a><span>
</span><a name="line-96"></a><span class="hs-comment">-- This function factors out commonality between the desugaring strategies for GroupStmt.</span><span>
</span><a name="line-97"></a><span class="hs-comment">-- Given such a statement it gives you back an expression representing how to compute the transformed</span><span>
</span><a name="line-98"></a><span class="hs-comment">-- list and the tuple that you need to bind from that list in order to proceed with your desugaring</span><span>
</span><a name="line-99"></a><span class="hs-identifier">dsTransStmt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ExprStmt</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span>
</span><a name="line-100"></a><a name="dsTransStmt"><a href="DsListComp.html#dsTransStmt"><span class="hs-identifier">dsTransStmt</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TransStmt</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">trS_form</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684090017"><a href="#local-6989586621684090017"><span class="hs-identifier">form</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_stmts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684090018"><a href="#local-6989586621684090018"><span class="hs-identifier">stmts</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684090019"><a href="#local-6989586621684090019"><span class="hs-identifier">binderMap</span></a></a><span>
</span><a name="line-101"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_by</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684090020"><a href="#local-6989586621684090020"><span class="hs-identifier">by</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_using</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684090021"><a href="#local-6989586621684090021"><span class="hs-identifier">using</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-102"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684090022"><a href="#local-6989586621684090022"><span class="hs-identifier">from_bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684090023"><a href="#local-6989586621684090023"><span class="hs-identifier">to_bndrs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621684090019"><span class="hs-identifier hs-var">binderMap</span></a><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684090024"><a href="#local-6989586621684090024"><span class="hs-identifier">from_bndrs_tys</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621684090022"><span class="hs-identifier hs-var">from_bndrs</span></a><span>
</span><a name="line-105"></a><span>        </span><a name="local-6989586621684090025"><a href="#local-6989586621684090025"><span class="hs-identifier">to_bndrs_tys</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621684090023"><span class="hs-identifier hs-var">to_bndrs</span></a><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span>        </span><a name="local-6989586621684090026"><a href="#local-6989586621684090026"><span class="hs-identifier">to_bndrs_tup_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkBigCoreTupTy</span><span> </span><a href="#local-6989586621684090025"><span class="hs-identifier hs-var">to_bndrs_tys</span></a><span>
</span><a name="line-108"></a><span>
</span><a name="line-109"></a><span>    </span><span class="hs-comment">-- Desugar an inner comprehension which outputs a list of tuples of the &quot;from&quot; binders</span><span>
</span><a name="line-110"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684090027"><a href="#local-6989586621684090027"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684090028"><a href="#local-6989586621684090028"><span class="hs-identifier">from_tup_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsListComp.html#dsInnerListComp"><span class="hs-identifier hs-var">dsInnerListComp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParStmtBlock</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621684090018"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-111"></a><span>                                                        </span><a href="#local-6989586621684090022"><span class="hs-identifier hs-var">from_bndrs</span></a><span> </span><span class="hs-identifier hs-var">noSyntaxExpr</span><span class="hs-special">)</span><span>
</span><a name="line-112"></a><span>
</span><a name="line-113"></a><span>    </span><span class="hs-comment">-- Work out what arguments should be supplied to that expression: i.e. is an extraction</span><span>
</span><a name="line-114"></a><span>    </span><span class="hs-comment">-- function required? If so, create that desugared function and add to arguments</span><span>
</span><a name="line-115"></a><span>    </span><a name="local-6989586621684090029"><a href="#local-6989586621684090029"><span class="hs-identifier">usingExpr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684090021"><span class="hs-identifier hs-var">using</span></a><span>
</span><a name="line-116"></a><span>    </span><a name="local-6989586621684090033"><a href="#local-6989586621684090033"><span class="hs-identifier">usingArgs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684090020"><span class="hs-identifier hs-var">by</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-117"></a><span>                    </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684090027"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">]</span><span>
</span><a name="line-118"></a><span>                    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684090030"><a href="#local-6989586621684090030"><span class="hs-identifier">by_e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684090031"><a href="#local-6989586621684090031"><span class="hs-identifier">by_e'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684090030"><span class="hs-identifier hs-var">by_e</span></a><span>
</span><a name="line-119"></a><span>                                    </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684090032"><a href="#local-6989586621684090032"><span class="hs-identifier">lam'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsListComp.html#matchTuple"><span class="hs-identifier hs-var">matchTuple</span></a><span> </span><a href="#local-6989586621684090022"><span class="hs-identifier hs-var">from_bndrs</span></a><span> </span><a href="#local-6989586621684090031"><span class="hs-identifier hs-var">by_e'</span></a><span>
</span><a name="line-120"></a><span>                                    </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684090032"><span class="hs-identifier hs-var">lam'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684090027"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-121"></a><span>
</span><a name="line-122"></a><span>    </span><span class="hs-comment">-- Create an unzip function for the appropriate arity and element types and find &quot;map&quot;</span><span>
</span><a name="line-123"></a><span>    </span><a name="local-6989586621684090034"><a href="#local-6989586621684090034"><span class="hs-identifier">unzip_stuff'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsListComp.html#mkUnzipBind"><span class="hs-identifier hs-var">mkUnzipBind</span></a><span> </span><a href="#local-6989586621684090017"><span class="hs-identifier hs-var">form</span></a><span> </span><a href="#local-6989586621684090024"><span class="hs-identifier hs-var">from_bndrs_tys</span></a><span>
</span><a name="line-124"></a><span>    </span><a name="local-6989586621684090035"><a href="#local-6989586621684090035"><span class="hs-identifier">map_id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#dsLookupGlobalId"><span class="hs-identifier hs-var">dsLookupGlobalId</span></a><span> </span><span class="hs-identifier hs-var">mapName</span><span>
</span><a name="line-125"></a><span>
</span><a name="line-126"></a><span>    </span><span class="hs-comment">-- Generate the expressions to build the grouped list</span><span>
</span><a name="line-127"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- First we apply the grouping function to the inner list</span><span>
</span><a name="line-128"></a><span>        </span><a name="local-6989586621684090036"><a href="#local-6989586621684090036"><span class="hs-identifier">inner_list_expr'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkApps</span><span> </span><a href="#local-6989586621684090029"><span class="hs-identifier hs-var">usingExpr'</span></a><span> </span><a href="#local-6989586621684090033"><span class="hs-identifier hs-var">usingArgs'</span></a><span>
</span><a name="line-129"></a><span>        </span><span class="hs-comment">-- Then we map our &quot;unzip&quot; across it to turn the lists of tuples into tuples of lists</span><span>
</span><a name="line-130"></a><span>        </span><span class="hs-comment">-- We make sure we instantiate the type variable &quot;a&quot; to be a list of &quot;from&quot; tuples and</span><span>
</span><a name="line-131"></a><span>        </span><span class="hs-comment">-- the &quot;b&quot; to be a tuple of &quot;to&quot; lists!</span><span>
</span><a name="line-132"></a><span>        </span><span class="hs-comment">-- Then finally we bind the unzip function around that expression</span><span>
</span><a name="line-133"></a><span>        </span><a name="local-6989586621684090037"><a href="#local-6989586621684090037"><span class="hs-identifier">bound_unzipped_inner_list_expr'</span></a></a><span>
</span><a name="line-134"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684090034"><span class="hs-identifier hs-var">unzip_stuff'</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-135"></a><span>              </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684090036"><span class="hs-identifier hs-var">inner_list_expr'</span></a><span>
</span><a name="line-136"></a><span>              </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684090038"><a href="#local-6989586621684090038"><span class="hs-identifier">unzip_fn'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684090039"><a href="#local-6989586621684090039"><span class="hs-identifier">unzip_rhs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-137"></a><span>                </span><span class="hs-identifier hs-var">Let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621684090038"><span class="hs-identifier hs-var">unzip_fn'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684090039"><span class="hs-identifier hs-var">unzip_rhs'</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-138"></a><span>                </span><span class="hs-identifier hs-var">mkApps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684090035"><span class="hs-identifier hs-var">map_id</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-139"></a><span>                </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">Type</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkListTy</span><span> </span><a href="#local-6989586621684090028"><span class="hs-identifier hs-var">from_tup_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-140"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Type</span><span> </span><a href="#local-6989586621684090026"><span class="hs-identifier hs-var">to_bndrs_tup_ty</span></a><span>
</span><a name="line-141"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684090038"><span class="hs-identifier hs-var">unzip_fn'</span></a><span>
</span><a name="line-142"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684090036"><span class="hs-identifier hs-var">inner_list_expr'</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-143"></a><span>
</span><a name="line-144"></a><span>    </span><a href="DsMonad.html#dsNoLevPoly"><span class="hs-identifier hs-var">dsNoLevPoly</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tcFunResultTyN</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621684090033"><span class="hs-identifier hs-var">usingArgs'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprType</span><span> </span><a href="#local-6989586621684090029"><span class="hs-identifier hs-var">usingExpr'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-145"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;In the result of a&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;using&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;function:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684090021"><span class="hs-identifier hs-var">using</span></a><span class="hs-special">)</span><span>
</span><a name="line-146"></a><span>
</span><a name="line-147"></a><span>    </span><span class="hs-comment">-- Build a pattern that ensures the consumer binds into the NEW binders,</span><span>
</span><a name="line-148"></a><span>    </span><span class="hs-comment">-- which hold lists rather than single values</span><span>
</span><a name="line-149"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684090040"><a href="#local-6989586621684090040"><span class="hs-identifier">pat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#mkBigLHsVarPatTupId"><span class="hs-identifier hs-var">mkBigLHsVarPatTupId</span></a><span> </span><a href="#local-6989586621684090023"><span class="hs-identifier hs-var">to_bndrs</span></a><span>  </span><span class="hs-comment">-- NB: no '!</span><span>
</span><a name="line-150"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684090037"><span class="hs-identifier hs-var">bound_unzipped_inner_list_expr'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684090040"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">)</span><span>
</span><a name="line-151"></a><span>
</span><a name="line-152"></a><span class="hs-identifier">dsTransStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsTransStmt: Not given a TransStmt&quot;</span><span>
</span><a name="line-153"></a><span>
</span><a name="line-154"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection[DsListComp-ordinary]{Ordinary desugaring of list comprehensions}
*                                                                      *
************************************************************************

Just as in Phil's chapter~7 in SLPJ, using the rules for
optimally-compiled list comprehensions.  This is what Kevin followed
as well, and I quite happily do the same.  The TQ translation scheme
transforms a list of qualifiers (either boolean expressions or
generators) into a single expression which implements the list
comprehension.  Because we are generating 2nd-order polymorphic
lambda-calculus, calls to NIL and CONS must be applied to a type
argument, as well as their usual value arguments.
\begin{verbatim}
TE &lt;&lt; [ e | qs ] &gt;&gt;  =  TQ &lt;&lt; [ e | qs ] ++ Nil (typeOf e) &gt;&gt;

(Rule C)
TQ &lt;&lt; [ e | ] ++ L &gt;&gt; = Cons (typeOf e) TE &lt;&lt;e&gt;&gt; TE &lt;&lt;L&gt;&gt;

(Rule B)
TQ &lt;&lt; [ e | b , qs ] ++ L &gt;&gt; =
    if TE &lt;&lt; b &gt;&gt; then TQ &lt;&lt; [ e | qs ] ++ L &gt;&gt; else TE &lt;&lt; L &gt;&gt;

(Rule A')
TQ &lt;&lt; [ e | p &lt;- L1, qs ]  ++  L2 &gt;&gt; =
  letrec
    h = \ u1 -&gt;
          case u1 of
            []        -&gt;  TE &lt;&lt; L2 &gt;&gt;
            (u2 : u3) -&gt;
                  (( \ TE &lt;&lt; p &gt;&gt; -&gt; ( TQ &lt;&lt; [e | qs]  ++  (h u3) &gt;&gt; )) u2)
                    [] (h u3)
  in
    h ( TE &lt;&lt; L1 &gt;&gt; )

&quot;h&quot;, &quot;u1&quot;, &quot;u2&quot;, and &quot;u3&quot; are new variables.
\end{verbatim}

@deListComp@ is the TQ translation scheme.  Roughly speaking, @dsExpr@
is the TE translation scheme.  Note that we carry around the @L@ list
already desugared.  @dsListComp@ does the top TE rule mentioned above.

To the above, we add an additional rule to deal with parallel list
comprehensions.  The translation goes roughly as follows:
     [ e | p1 &lt;- e11, let v1 = e12, p2 &lt;- e13
         | q1 &lt;- e21, let v2 = e22, q2 &lt;- e23]
     =&gt;
     [ e | ((x1, .., xn), (y1, ..., ym)) &lt;-
               zip [(x1,..,xn) | p1 &lt;- e11, let v1 = e12, p2 &lt;- e13]
                   [(y1,..,ym) | q1 &lt;- e21, let v2 = e22, q2 &lt;- e23]]
where (x1, .., xn) are the variables bound in p1, v1, p2
      (y1, .., ym) are the variables bound in q1, v2, q2

In the translation below, the ParStmt branch translates each parallel branch
into a sub-comprehension, and desugars each independently.  The resulting lists
are fed to a zip function, we create a binding for all the variables bound in all
the comprehensions, and then we hand things off the desugarer for bindings.
The zip function is generated here a) because it's small, and b) because then we
don't have to deal with arbitrary limits on the number of zip functions in the
prelude, nor which library the zip function came from.
The introduced tuples are Boxed, but only because I couldn't get it to work
with the Unboxed variety.
-}</span><span>
</span><a name="line-219"></a><span>
</span><a name="line-220"></a><span class="hs-identifier">deListComp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ExprStmt</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><a name="deListComp"><a href="DsListComp.html#deListComp"><span class="hs-identifier">deListComp</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;deListComp&quot;</span><span>
</span><a name="line-223"></a><span>
</span><a name="line-224"></a><span class="hs-identifier">deListComp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LastStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684090041"><a href="#local-6989586621684090041"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684090042"><a href="#local-6989586621684090042"><span class="hs-identifier">quals</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684090043"><a href="#local-6989586621684090043"><span class="hs-identifier">list</span></a></a><span>
</span><a name="line-225"></a><span>  </span><span class="hs-glyph">=</span><span>     </span><span class="hs-comment">-- Figure 7.4, SLPJ, p 135, rule C above</span><span>
</span><a name="line-226"></a><span>    </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-identifier">quals</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-227"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684090044"><a href="#local-6989586621684090044"><span class="hs-identifier">core_body</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684090041"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-228"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkConsExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprType</span><span> </span><a href="#local-6989586621684090044"><span class="hs-identifier hs-var">core_body</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684090044"><span class="hs-identifier hs-var">core_body</span></a><span> </span><a href="#local-6989586621684090043"><span class="hs-identifier hs-var">list</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-229"></a><span>
</span><a name="line-230"></a><span>        </span><span class="hs-comment">-- Non-last: must be a guard</span><span>
</span><a name="line-231"></a><span class="hs-identifier">deListComp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684090045"><a href="#local-6989586621684090045"><span class="hs-identifier">guard</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684090046"><a href="#local-6989586621684090046"><span class="hs-identifier">quals</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684090047"><a href="#local-6989586621684090047"><span class="hs-identifier">list</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-comment">-- rule B above</span><span>
</span><a name="line-232"></a><span>    </span><a name="local-6989586621684090048"><a href="#local-6989586621684090048"><span class="hs-identifier">core_guard</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684090045"><span class="hs-identifier hs-var">guard</span></a><span>
</span><a name="line-233"></a><span>    </span><a name="local-6989586621684090049"><a href="#local-6989586621684090049"><span class="hs-identifier">core_rest</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsListComp.html#deListComp"><span class="hs-identifier hs-var">deListComp</span></a><span> </span><a href="#local-6989586621684090046"><span class="hs-identifier hs-var">quals</span></a><span> </span><a href="#local-6989586621684090047"><span class="hs-identifier hs-var">list</span></a><span>
</span><a name="line-234"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkIfThenElse</span><span> </span><a href="#local-6989586621684090048"><span class="hs-identifier hs-var">core_guard</span></a><span> </span><a href="#local-6989586621684090049"><span class="hs-identifier hs-var">core_rest</span></a><span> </span><a href="#local-6989586621684090047"><span class="hs-identifier hs-var">list</span></a><span class="hs-special">)</span><span>
</span><a name="line-235"></a><span>
</span><a name="line-236"></a><span class="hs-comment">-- [e | let B, qs] = let B in [e | qs]</span><span>
</span><a name="line-237"></a><span class="hs-identifier">deListComp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LetStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684090050"><a href="#local-6989586621684090050"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684090051"><a href="#local-6989586621684090051"><span class="hs-identifier">quals</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684090052"><a href="#local-6989586621684090052"><span class="hs-identifier">list</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-238"></a><span>    </span><a name="local-6989586621684090053"><a href="#local-6989586621684090053"><span class="hs-identifier">core_rest</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsListComp.html#deListComp"><span class="hs-identifier hs-var">deListComp</span></a><span> </span><a href="#local-6989586621684090051"><span class="hs-identifier hs-var">quals</span></a><span> </span><a href="#local-6989586621684090052"><span class="hs-identifier hs-var">list</span></a><span>
</span><a name="line-239"></a><span>    </span><a href="DsExpr.html#dsLocalBinds"><span class="hs-identifier hs-var">dsLocalBinds</span></a><span> </span><a href="#local-6989586621684090050"><span class="hs-identifier hs-var">binds</span></a><span> </span><a href="#local-6989586621684090053"><span class="hs-identifier hs-var">core_rest</span></a><span>
</span><a name="line-240"></a><span>
</span><a name="line-241"></a><span class="hs-identifier">deListComp</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684090054"><a href="#local-6989586621684090054"><span class="hs-identifier">stmt</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">TransStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684090055"><a href="#local-6989586621684090055"><span class="hs-identifier">quals</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684090056"><a href="#local-6989586621684090056"><span class="hs-identifier">list</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-242"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684090057"><a href="#local-6989586621684090057"><span class="hs-identifier">inner_list_expr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684090058"><a href="#local-6989586621684090058"><span class="hs-identifier">pat</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsListComp.html#dsTransStmt"><span class="hs-identifier hs-var">dsTransStmt</span></a><span> </span><a href="#local-6989586621684090054"><span class="hs-identifier hs-var">stmt</span></a><span>
</span><a name="line-243"></a><span>    </span><a href="DsListComp.html#deBindComp"><span class="hs-identifier hs-var">deBindComp</span></a><span> </span><a href="#local-6989586621684090058"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621684090057"><span class="hs-identifier hs-var">inner_list_expr</span></a><span> </span><a href="#local-6989586621684090055"><span class="hs-identifier hs-var">quals</span></a><span> </span><a href="#local-6989586621684090056"><span class="hs-identifier hs-var">list</span></a><span>
</span><a name="line-244"></a><span>
</span><a name="line-245"></a><span class="hs-identifier">deListComp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BindStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684090059"><a href="#local-6989586621684090059"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621684090060"><a href="#local-6989586621684090060"><span class="hs-identifier">list1</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684090061"><a href="#local-6989586621684090061"><span class="hs-identifier">quals</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684090062"><a href="#local-6989586621684090062"><span class="hs-identifier">core_list2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- rule A' above</span><span>
</span><a name="line-246"></a><span>    </span><a name="local-6989586621684090063"><a href="#local-6989586621684090063"><span class="hs-identifier">core_list1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExprNoLP"><span class="hs-identifier hs-var">dsLExprNoLP</span></a><span> </span><a href="#local-6989586621684090060"><span class="hs-identifier hs-var">list1</span></a><span>
</span><a name="line-247"></a><span>    </span><a href="DsListComp.html#deBindComp"><span class="hs-identifier hs-var">deBindComp</span></a><span> </span><a href="#local-6989586621684090059"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621684090063"><span class="hs-identifier hs-var">core_list1</span></a><span> </span><a href="#local-6989586621684090061"><span class="hs-identifier hs-var">quals</span></a><span> </span><a href="#local-6989586621684090062"><span class="hs-identifier hs-var">core_list2</span></a><span>
</span><a name="line-248"></a><span>
</span><a name="line-249"></a><span class="hs-identifier">deListComp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684090064"><a href="#local-6989586621684090064"><span class="hs-identifier">stmtss_w_bndrs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684090065"><a href="#local-6989586621684090065"><span class="hs-identifier">quals</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684090066"><a href="#local-6989586621684090066"><span class="hs-identifier">list</span></a></a><span>
</span><a name="line-250"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684090071"><a href="#local-6989586621684090071"><span class="hs-identifier">exps_and_qual_tys</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="DsListComp.html#dsInnerListComp"><span class="hs-identifier hs-var">dsInnerListComp</span></a><span> </span><a href="#local-6989586621684090064"><span class="hs-identifier hs-var">stmtss_w_bndrs</span></a><span>
</span><a name="line-251"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684090072"><a href="#local-6989586621684090072"><span class="hs-identifier">exps</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684090073"><a href="#local-6989586621684090073"><span class="hs-identifier">qual_tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621684090071"><span class="hs-identifier hs-var">exps_and_qual_tys</span></a><span>
</span><a name="line-252"></a><span>
</span><a name="line-253"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684090074"><a href="#local-6989586621684090074"><span class="hs-identifier">zip_fn</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684090075"><a href="#local-6989586621684090075"><span class="hs-identifier">zip_rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsListComp.html#mkZipBind"><span class="hs-identifier hs-var">mkZipBind</span></a><span> </span><a href="#local-6989586621684090073"><span class="hs-identifier hs-var">qual_tys</span></a><span>
</span><a name="line-254"></a><span>
</span><a name="line-255"></a><span>        </span><span class="hs-comment">-- Deal with [e | pat &lt;- zip l1 .. ln] in example above</span><span>
</span><a name="line-256"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="DsListComp.html#deBindComp"><span class="hs-identifier hs-var">deBindComp</span></a><span> </span><a href="#local-6989586621684090068"><span class="hs-identifier hs-var">pat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621684090074"><span class="hs-identifier hs-var">zip_fn</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684090075"><span class="hs-identifier hs-var">zip_rhs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkApps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684090074"><span class="hs-identifier hs-var">zip_fn</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684090072"><span class="hs-identifier hs-var">exps</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-257"></a><span>                    </span><a href="#local-6989586621684090065"><span class="hs-identifier hs-var">quals</span></a><span> </span><a href="#local-6989586621684090066"><span class="hs-identifier hs-var">list</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-258"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-259"></a><span>        </span><a name="local-6989586621684090067"><a href="#local-6989586621684090067"><span class="hs-identifier">bndrs_s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684090070"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">ParStmtBlock</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684090070"><a href="#local-6989586621684090070"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684090064"><span class="hs-identifier hs-var">stmtss_w_bndrs</span></a><span class="hs-special">]</span><span>
</span><a name="line-260"></a><span>
</span><a name="line-261"></a><span>        </span><span class="hs-comment">-- pat is the pattern ((x1,..,xn), (y1,..,ym)) in the example above</span><span>
</span><a name="line-262"></a><span>        </span><a name="local-6989586621684090068"><a href="#local-6989586621684090068"><span class="hs-identifier">pat</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#mkBigLHsPatTupId"><span class="hs-identifier hs-var">mkBigLHsPatTupId</span></a><span> </span><a href="#local-6989586621684090069"><span class="hs-identifier hs-var">pats</span></a><span>
</span><a name="line-263"></a><span>        </span><a name="local-6989586621684090069"><a href="#local-6989586621684090069"><span class="hs-identifier">pats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="DsUtils.html#mkBigLHsVarPatTupId"><span class="hs-identifier hs-var">mkBigLHsVarPatTupId</span></a><span> </span><a href="#local-6989586621684090067"><span class="hs-identifier hs-var">bndrs_s</span></a><span>
</span><a name="line-264"></a><span>
</span><a name="line-265"></a><span class="hs-identifier">deListComp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;deListComp RecStmt&quot;</span><span>
</span><a name="line-266"></a><span>
</span><a name="line-267"></a><span class="hs-identifier">deListComp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ApplicativeStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-268"></a><span>  </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;deListComp ApplicativeStmt&quot;</span><span>
</span><a name="line-269"></a><span>
</span><a name="line-270"></a><span class="hs-identifier">deListComp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XStmtLR</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-271"></a><span>  </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;deListComp XStmtLR&quot;</span><span>
</span><a name="line-272"></a><span>
</span><a name="line-273"></a><span class="hs-identifier">deBindComp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OutPat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-274"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-275"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ExprStmt</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">]</span><span>
</span><a name="line-276"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-277"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Expr</span><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">)</span><span>
</span><a name="line-278"></a><a name="deBindComp"><a href="DsListComp.html#deBindComp"><span class="hs-identifier">deBindComp</span></a></a><span> </span><a name="local-6989586621684090076"><a href="#local-6989586621684090076"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621684090077"><a href="#local-6989586621684090077"><span class="hs-identifier">core_list1</span></a></a><span> </span><a name="local-6989586621684090078"><a href="#local-6989586621684090078"><span class="hs-identifier">quals</span></a></a><span> </span><a name="local-6989586621684090079"><a href="#local-6989586621684090079"><span class="hs-identifier">core_list2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-279"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684090080"><a href="#local-6989586621684090080"><span class="hs-identifier">u3_ty</span></a></a><span class="hs-glyph">@</span><a name="local-6989586621684090081"><a href="#local-6989586621684090081"><span class="hs-identifier">u1_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">exprType</span><span> </span><a href="#local-6989586621684090077"><span class="hs-identifier hs-var">core_list1</span></a><span>       </span><span class="hs-comment">-- two names, same thing</span><span>
</span><a name="line-280"></a><span>
</span><a name="line-281"></a><span>        </span><span class="hs-comment">-- u1_ty is a [alpha] type, and u2_ty = alpha</span><span>
</span><a name="line-282"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684090082"><a href="#local-6989586621684090082"><span class="hs-identifier">u2_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsSyn.html#hsLPatType"><span class="hs-identifier hs-var">hsLPatType</span></a><span> </span><a href="#local-6989586621684090076"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-283"></a><span>
</span><a name="line-284"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684090083"><a href="#local-6989586621684090083"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">exprType</span><span> </span><a href="#local-6989586621684090079"><span class="hs-identifier hs-var">core_list2</span></a><span>
</span><a name="line-285"></a><span>        </span><a name="local-6989586621684090084"><a href="#local-6989586621684090084"><span class="hs-identifier">h_ty</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684090081"><span class="hs-identifier hs-var">u1_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkFunTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684090083"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-286"></a><span>
</span><a name="line-287"></a><span>       </span><span class="hs-comment">-- no levity polymorphism here, as list comprehensions don't work</span><span>
</span><a name="line-288"></a><span>       </span><span class="hs-comment">-- with RebindableSyntax. NB: These are *not* monad comps.</span><span>
</span><a name="line-289"></a><span>    </span><span class="hs-special">[</span><a name="local-6989586621684090085"><a href="#local-6989586621684090085"><span class="hs-identifier">h</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684090086"><a href="#local-6989586621684090086"><span class="hs-identifier">u1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684090087"><a href="#local-6989586621684090087"><span class="hs-identifier">u2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684090088"><a href="#local-6989586621684090088"><span class="hs-identifier">u3</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#newSysLocalsDs"><span class="hs-identifier hs-var">newSysLocalsDs</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684090084"><span class="hs-identifier hs-var">h_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684090081"><span class="hs-identifier hs-var">u1_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684090082"><span class="hs-identifier hs-var">u2_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684090080"><span class="hs-identifier hs-var">u3_ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-290"></a><span>
</span><a name="line-291"></a><span>    </span><span class="hs-comment">-- the &quot;fail&quot; value ...</span><span>
</span><a name="line-292"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-293"></a><span>        </span><a name="local-6989586621684090089"><a href="#local-6989586621684090089"><span class="hs-identifier">core_fail</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">App</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684090085"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684090088"><span class="hs-identifier hs-var">u3</span></a><span class="hs-special">)</span><span>
</span><a name="line-294"></a><span>        </span><a name="local-6989586621684090090"><a href="#local-6989586621684090090"><span class="hs-identifier">letrec_body</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">App</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684090085"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684090077"><span class="hs-identifier hs-var">core_list1</span></a><span>
</span><a name="line-295"></a><span>
</span><a name="line-296"></a><span>    </span><a name="local-6989586621684090091"><a href="#local-6989586621684090091"><span class="hs-identifier">rest_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsListComp.html#deListComp"><span class="hs-identifier hs-var">deListComp</span></a><span> </span><a href="#local-6989586621684090078"><span class="hs-identifier hs-var">quals</span></a><span> </span><a href="#local-6989586621684090089"><span class="hs-identifier hs-var">core_fail</span></a><span>
</span><a name="line-297"></a><span>    </span><a name="local-6989586621684090092"><a href="#local-6989586621684090092"><span class="hs-identifier">core_match</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Match.html#matchSimply"><span class="hs-identifier hs-var">matchSimply</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684090087"><span class="hs-identifier hs-var">u2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">StmtCtxt</span><span> </span><span class="hs-identifier hs-var">ListComp</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684090076"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621684090091"><span class="hs-identifier hs-var">rest_expr</span></a><span> </span><a href="#local-6989586621684090089"><span class="hs-identifier hs-var">core_fail</span></a><span>
</span><a name="line-298"></a><span>
</span><a name="line-299"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-300"></a><span>        </span><a name="local-6989586621684090093"><a href="#local-6989586621684090093"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Lam</span><span> </span><a href="#local-6989586621684090086"><span class="hs-identifier hs-var">u1</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-301"></a><span>              </span><span class="hs-identifier hs-var">Case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684090086"><span class="hs-identifier hs-var">u1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684090086"><span class="hs-identifier hs-var">u1</span></a><span> </span><a href="#local-6989586621684090083"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-302"></a><span>                   </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataAlt</span><span> </span><span class="hs-identifier hs-var">nilDataCon</span><span class="hs-special">,</span><span>  </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>       </span><a href="#local-6989586621684090079"><span class="hs-identifier hs-var">core_list2</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-303"></a><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataAlt</span><span> </span><span class="hs-identifier hs-var">consDataCon</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684090087"><span class="hs-identifier hs-var">u2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684090088"><span class="hs-identifier hs-var">u3</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684090092"><span class="hs-identifier hs-var">core_match</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-304"></a><span>                        </span><span class="hs-comment">-- Increasing order of tag</span><span>
</span><a name="line-305"></a><span>
</span><a name="line-306"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621684090085"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684090093"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684090090"><span class="hs-identifier hs-var">letrec_body</span></a><span class="hs-special">)</span><span>
</span><a name="line-307"></a><span>
</span><a name="line-308"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection[DsListComp-foldr-build]{Foldr/Build desugaring of list comprehensions}
*                                                                      *
************************************************************************

@dfListComp@ are the rules used with foldr/build turned on:

\begin{verbatim}
TE[ e | ]            c n = c e n
TE[ e | b , q ]      c n = if b then TE[ e | q ] c n else n
TE[ e | p &lt;- l , q ] c n = let
                                f = \ x b -&gt; case x of
                                                  p -&gt; TE[ e | q ] c b
                                                  _ -&gt; b
                           in
                           foldr f n l
\end{verbatim}
-}</span><span>
</span><a name="line-328"></a><span>
</span><a name="line-329"></a><span class="hs-identifier">dfListComp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span>            </span><span class="hs-comment">-- 'c' and 'n'</span><span>
</span><a name="line-330"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ExprStmt</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- the rest of the qual's</span><span>
</span><a name="line-331"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-332"></a><span>
</span><a name="line-333"></a><a name="dfListComp"><a href="DsListComp.html#dfListComp"><span class="hs-identifier">dfListComp</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dfListComp&quot;</span><span>
</span><a name="line-334"></a><span>
</span><a name="line-335"></a><span class="hs-identifier">dfListComp</span><span> </span><a name="local-6989586621684090094"><a href="#local-6989586621684090094"><span class="hs-identifier">c_id</span></a></a><span> </span><a name="local-6989586621684090095"><a href="#local-6989586621684090095"><span class="hs-identifier">n_id</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LastStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684090096"><a href="#local-6989586621684090096"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684090097"><a href="#local-6989586621684090097"><span class="hs-identifier">quals</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-336"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-identifier">quals</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-337"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684090098"><a href="#local-6989586621684090098"><span class="hs-identifier">core_body</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExprNoLP"><span class="hs-identifier hs-var">dsLExprNoLP</span></a><span> </span><a href="#local-6989586621684090096"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-338"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkApps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684090094"><span class="hs-identifier hs-var">c_id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684090098"><span class="hs-identifier hs-var">core_body</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684090095"><span class="hs-identifier hs-var">n_id</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-339"></a><span>
</span><a name="line-340"></a><span>        </span><span class="hs-comment">-- Non-last: must be a guard</span><span>
</span><a name="line-341"></a><span class="hs-identifier">dfListComp</span><span> </span><a name="local-6989586621684090099"><a href="#local-6989586621684090099"><span class="hs-identifier">c_id</span></a></a><span> </span><a name="local-6989586621684090100"><a href="#local-6989586621684090100"><span class="hs-identifier">n_id</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684090101"><a href="#local-6989586621684090101"><span class="hs-identifier">guard</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684090102"><a href="#local-6989586621684090102"><span class="hs-identifier">quals</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-342"></a><span>    </span><a name="local-6989586621684090103"><a href="#local-6989586621684090103"><span class="hs-identifier">core_guard</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684090101"><span class="hs-identifier hs-var">guard</span></a><span>
</span><a name="line-343"></a><span>    </span><a name="local-6989586621684090104"><a href="#local-6989586621684090104"><span class="hs-identifier">core_rest</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsListComp.html#dfListComp"><span class="hs-identifier hs-var">dfListComp</span></a><span> </span><a href="#local-6989586621684090099"><span class="hs-identifier hs-var">c_id</span></a><span> </span><a href="#local-6989586621684090100"><span class="hs-identifier hs-var">n_id</span></a><span> </span><a href="#local-6989586621684090102"><span class="hs-identifier hs-var">quals</span></a><span>
</span><a name="line-344"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkIfThenElse</span><span> </span><a href="#local-6989586621684090103"><span class="hs-identifier hs-var">core_guard</span></a><span> </span><a href="#local-6989586621684090104"><span class="hs-identifier hs-var">core_rest</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684090100"><span class="hs-identifier hs-var">n_id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-345"></a><span>
</span><a name="line-346"></a><span class="hs-identifier">dfListComp</span><span> </span><a name="local-6989586621684090105"><a href="#local-6989586621684090105"><span class="hs-identifier">c_id</span></a></a><span> </span><a name="local-6989586621684090106"><a href="#local-6989586621684090106"><span class="hs-identifier">n_id</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LetStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684090107"><a href="#local-6989586621684090107"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684090108"><a href="#local-6989586621684090108"><span class="hs-identifier">quals</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-347"></a><span>    </span><span class="hs-comment">-- new in 1.3, local bindings</span><span>
</span><a name="line-348"></a><span>    </span><a name="local-6989586621684090109"><a href="#local-6989586621684090109"><span class="hs-identifier">core_rest</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsListComp.html#dfListComp"><span class="hs-identifier hs-var">dfListComp</span></a><span> </span><a href="#local-6989586621684090105"><span class="hs-identifier hs-var">c_id</span></a><span> </span><a href="#local-6989586621684090106"><span class="hs-identifier hs-var">n_id</span></a><span> </span><a href="#local-6989586621684090108"><span class="hs-identifier hs-var">quals</span></a><span>
</span><a name="line-349"></a><span>    </span><a href="DsExpr.html#dsLocalBinds"><span class="hs-identifier hs-var">dsLocalBinds</span></a><span> </span><a href="#local-6989586621684090107"><span class="hs-identifier hs-var">binds</span></a><span> </span><a href="#local-6989586621684090109"><span class="hs-identifier hs-var">core_rest</span></a><span>
</span><a name="line-350"></a><span>
</span><a name="line-351"></a><span class="hs-identifier">dfListComp</span><span> </span><a name="local-6989586621684090110"><a href="#local-6989586621684090110"><span class="hs-identifier">c_id</span></a></a><span> </span><a name="local-6989586621684090111"><a href="#local-6989586621684090111"><span class="hs-identifier">n_id</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684090112"><a href="#local-6989586621684090112"><span class="hs-identifier">stmt</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">TransStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684090113"><a href="#local-6989586621684090113"><span class="hs-identifier">quals</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-352"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684090114"><a href="#local-6989586621684090114"><span class="hs-identifier">inner_list_expr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684090115"><a href="#local-6989586621684090115"><span class="hs-identifier">pat</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsListComp.html#dsTransStmt"><span class="hs-identifier hs-var">dsTransStmt</span></a><span> </span><a href="#local-6989586621684090112"><span class="hs-identifier hs-var">stmt</span></a><span>
</span><a name="line-353"></a><span>    </span><span class="hs-comment">-- Anyway, we bind the newly grouped list via the generic binding function</span><span>
</span><a name="line-354"></a><span>    </span><a href="DsListComp.html#dfBindComp"><span class="hs-identifier hs-var">dfBindComp</span></a><span> </span><a href="#local-6989586621684090110"><span class="hs-identifier hs-var">c_id</span></a><span> </span><a href="#local-6989586621684090111"><span class="hs-identifier hs-var">n_id</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684090115"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684090114"><span class="hs-identifier hs-var">inner_list_expr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684090113"><span class="hs-identifier hs-var">quals</span></a><span>
</span><a name="line-355"></a><span>
</span><a name="line-356"></a><span class="hs-identifier">dfListComp</span><span> </span><a name="local-6989586621684090116"><a href="#local-6989586621684090116"><span class="hs-identifier">c_id</span></a></a><span> </span><a name="local-6989586621684090117"><a href="#local-6989586621684090117"><span class="hs-identifier">n_id</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BindStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684090118"><a href="#local-6989586621684090118"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621684090119"><a href="#local-6989586621684090119"><span class="hs-identifier">list1</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684090120"><a href="#local-6989586621684090120"><span class="hs-identifier">quals</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-357"></a><span>    </span><span class="hs-comment">-- evaluate the two lists</span><span>
</span><a name="line-358"></a><span>    </span><a name="local-6989586621684090121"><a href="#local-6989586621684090121"><span class="hs-identifier">core_list1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684090119"><span class="hs-identifier hs-var">list1</span></a><span>
</span><a name="line-359"></a><span>
</span><a name="line-360"></a><span>    </span><span class="hs-comment">-- Do the rest of the work in the generic binding builder</span><span>
</span><a name="line-361"></a><span>    </span><a href="DsListComp.html#dfBindComp"><span class="hs-identifier hs-var">dfBindComp</span></a><span> </span><a href="#local-6989586621684090116"><span class="hs-identifier hs-var">c_id</span></a><span> </span><a href="#local-6989586621684090117"><span class="hs-identifier hs-var">n_id</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684090118"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684090121"><span class="hs-identifier hs-var">core_list1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684090120"><span class="hs-identifier hs-var">quals</span></a><span>
</span><a name="line-362"></a><span>
</span><a name="line-363"></a><span class="hs-identifier">dfListComp</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dfListComp ParStmt&quot;</span><span>
</span><a name="line-364"></a><span class="hs-identifier">dfListComp</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dfListComp RecStmt&quot;</span><span>
</span><a name="line-365"></a><span class="hs-identifier">dfListComp</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ApplicativeStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-366"></a><span>  </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dfListComp ApplicativeStmt&quot;</span><span>
</span><a name="line-367"></a><span class="hs-identifier">dfListComp</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XStmtLR</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-368"></a><span>  </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dfListComp XStmtLR&quot;</span><span>
</span><a name="line-369"></a><span>
</span><a name="line-370"></a><span class="hs-identifier">dfBindComp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span>             </span><span class="hs-comment">-- 'c' and 'n'</span><span>
</span><a name="line-371"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span>
</span><a name="line-372"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ExprStmt</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- the rest of the qual's</span><span>
</span><a name="line-373"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-374"></a><a name="dfBindComp"><a href="DsListComp.html#dfBindComp"><span class="hs-identifier">dfBindComp</span></a></a><span> </span><a name="local-6989586621684090122"><a href="#local-6989586621684090122"><span class="hs-identifier">c_id</span></a></a><span> </span><a name="local-6989586621684090123"><a href="#local-6989586621684090123"><span class="hs-identifier">n_id</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684090124"><a href="#local-6989586621684090124"><span class="hs-identifier">pat</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684090125"><a href="#local-6989586621684090125"><span class="hs-identifier">core_list1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684090126"><a href="#local-6989586621684090126"><span class="hs-identifier">quals</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-375"></a><span>    </span><span class="hs-comment">-- find the required type</span><span>
</span><a name="line-376"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684090127"><a href="#local-6989586621684090127"><span class="hs-identifier">x_ty</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcHsSyn.html#hsLPatType"><span class="hs-identifier hs-var">hsLPatType</span></a><span> </span><a href="#local-6989586621684090124"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-377"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684090128"><a href="#local-6989586621684090128"><span class="hs-identifier">b_ty</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621684090123"><span class="hs-identifier hs-var">n_id</span></a><span>
</span><a name="line-378"></a><span>
</span><a name="line-379"></a><span>    </span><span class="hs-comment">-- create some new local id's</span><span>
</span><a name="line-380"></a><span>    </span><a name="local-6989586621684090129"><a href="#local-6989586621684090129"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#newSysLocalDs"><span class="hs-identifier hs-var">newSysLocalDs</span></a><span> </span><a href="#local-6989586621684090128"><span class="hs-identifier hs-var">b_ty</span></a><span>
</span><a name="line-381"></a><span>    </span><a name="local-6989586621684090130"><a href="#local-6989586621684090130"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#newSysLocalDs"><span class="hs-identifier hs-var">newSysLocalDs</span></a><span> </span><a href="#local-6989586621684090127"><span class="hs-identifier hs-var">x_ty</span></a><span>
</span><a name="line-382"></a><span>
</span><a name="line-383"></a><span>    </span><span class="hs-comment">-- build rest of the comprehesion</span><span>
</span><a name="line-384"></a><span>    </span><a name="local-6989586621684090131"><a href="#local-6989586621684090131"><span class="hs-identifier">core_rest</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsListComp.html#dfListComp"><span class="hs-identifier hs-var">dfListComp</span></a><span> </span><a href="#local-6989586621684090122"><span class="hs-identifier hs-var">c_id</span></a><span> </span><a href="#local-6989586621684090129"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621684090126"><span class="hs-identifier hs-var">quals</span></a><span>
</span><a name="line-385"></a><span>
</span><a name="line-386"></a><span>    </span><span class="hs-comment">-- build the pattern match</span><span>
</span><a name="line-387"></a><span>    </span><a name="local-6989586621684090132"><a href="#local-6989586621684090132"><span class="hs-identifier">core_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Match.html#matchSimply"><span class="hs-identifier hs-var">matchSimply</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684090130"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">StmtCtxt</span><span> </span><span class="hs-identifier hs-var">ListComp</span><span class="hs-special">)</span><span>
</span><a name="line-388"></a><span>                </span><a href="#local-6989586621684090124"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621684090131"><span class="hs-identifier hs-var">core_rest</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684090129"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-389"></a><span>
</span><a name="line-390"></a><span>    </span><span class="hs-comment">-- now build the outermost foldr, and return</span><span>
</span><a name="line-391"></a><span>    </span><span class="hs-identifier hs-var">mkFoldrExpr</span><span> </span><a href="#local-6989586621684090127"><span class="hs-identifier hs-var">x_ty</span></a><span> </span><a href="#local-6989586621684090128"><span class="hs-identifier hs-var">b_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLams</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684090130"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684090129"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621684090132"><span class="hs-identifier hs-var">core_expr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684090123"><span class="hs-identifier hs-var">n_id</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684090125"><span class="hs-identifier hs-var">core_list1</span></a><span>
</span><a name="line-392"></a><span>
</span><a name="line-393"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection[DsFunGeneration]{Generation of zip/unzip functions for use in desugaring}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-400"></a><span>
</span><a name="line-401"></a><span class="hs-identifier">mkZipBind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span>
</span><a name="line-402"></a><span class="hs-comment">-- mkZipBind [t1, t2]</span><span>
</span><a name="line-403"></a><span class="hs-comment">-- = (zip, \as1:[t1] as2:[t2]</span><span>
</span><a name="line-404"></a><span class="hs-comment">--         -&gt; case as1 of</span><span>
</span><a name="line-405"></a><span class="hs-comment">--              [] -&gt; []</span><span>
</span><a name="line-406"></a><span class="hs-comment">--              (a1:as'1) -&gt; case as2 of</span><span>
</span><a name="line-407"></a><span class="hs-comment">--                              [] -&gt; []</span><span>
</span><a name="line-408"></a><span class="hs-comment">--                              (a2:as'2) -&gt; (a1, a2) : zip as'1 as'2)]</span><span>
</span><a name="line-409"></a><span>
</span><a name="line-410"></a><a name="mkZipBind"><a href="DsListComp.html#mkZipBind"><span class="hs-identifier">mkZipBind</span></a></a><span> </span><a name="local-6989586621684090133"><a href="#local-6989586621684090133"><span class="hs-identifier">elt_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-411"></a><span>    </span><a name="local-6989586621684090143"><a href="#local-6989586621684090143"><span class="hs-identifier">ass</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="DsMonad.html#newSysLocalDs"><span class="hs-identifier hs-var">newSysLocalDs</span></a><span>  </span><a href="#local-6989586621684090134"><span class="hs-identifier hs-var">elt_list_tys</span></a><span>
</span><a name="line-412"></a><span>    </span><a name="local-6989586621684090144"><a href="#local-6989586621684090144"><span class="hs-identifier">as'</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="DsMonad.html#newSysLocalDs"><span class="hs-identifier hs-var">newSysLocalDs</span></a><span>  </span><a href="#local-6989586621684090133"><span class="hs-identifier hs-var">elt_tys</span></a><span>
</span><a name="line-413"></a><span>    </span><a name="local-6989586621684090145"><a href="#local-6989586621684090145"><span class="hs-identifier">as's</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="DsMonad.html#newSysLocalDs"><span class="hs-identifier hs-var">newSysLocalDs</span></a><span>  </span><a href="#local-6989586621684090134"><span class="hs-identifier hs-var">elt_list_tys</span></a><span>
</span><a name="line-414"></a><span>
</span><a name="line-415"></a><span>    </span><a name="local-6989586621684090146"><a href="#local-6989586621684090146"><span class="hs-identifier">zip_fn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#newSysLocalDs"><span class="hs-identifier hs-var">newSysLocalDs</span></a><span> </span><a href="#local-6989586621684090137"><span class="hs-identifier hs-var">zip_fn_ty</span></a><span>
</span><a name="line-416"></a><span>
</span><a name="line-417"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684090147"><a href="#local-6989586621684090147"><span class="hs-identifier">inner_rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkConsExpr</span><span> </span><a href="#local-6989586621684090135"><span class="hs-identifier hs-var">elt_tuple_ty</span></a><span>
</span><a name="line-418"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkBigCoreVarTup</span><span> </span><a href="#local-6989586621684090144"><span class="hs-identifier hs-var">as'</span></a><span class="hs-special">)</span><span>
</span><a name="line-419"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkVarApps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684090146"><span class="hs-identifier hs-var">zip_fn</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684090145"><span class="hs-identifier hs-var">as's</span></a><span class="hs-special">)</span><span>
</span><a name="line-420"></a><span>        </span><a name="local-6989586621684090148"><a href="#local-6989586621684090148"><span class="hs-identifier">zip_body</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621684090138"><span class="hs-identifier hs-var">mk_case</span></a><span> </span><a href="#local-6989586621684090147"><span class="hs-identifier hs-var">inner_rhs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip3</span><span> </span><a href="#local-6989586621684090143"><span class="hs-identifier hs-var">ass</span></a><span> </span><a href="#local-6989586621684090144"><span class="hs-identifier hs-var">as'</span></a><span> </span><a href="#local-6989586621684090145"><span class="hs-identifier hs-var">as's</span></a><span class="hs-special">)</span><span>
</span><a name="line-421"></a><span>
</span><a name="line-422"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684090146"><span class="hs-identifier hs-var">zip_fn</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkLams</span><span> </span><a href="#local-6989586621684090143"><span class="hs-identifier hs-var">ass</span></a><span> </span><a href="#local-6989586621684090148"><span class="hs-identifier hs-var">zip_body</span></a><span class="hs-special">)</span><span>
</span><a name="line-423"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-424"></a><span>    </span><a name="local-6989586621684090134"><a href="#local-6989586621684090134"><span class="hs-identifier">elt_list_tys</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">mkListTy</span><span> </span><a href="#local-6989586621684090133"><span class="hs-identifier hs-var">elt_tys</span></a><span>
</span><a name="line-425"></a><span>    </span><a name="local-6989586621684090135"><a href="#local-6989586621684090135"><span class="hs-identifier">elt_tuple_ty</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkBigCoreTupTy</span><span> </span><a href="#local-6989586621684090133"><span class="hs-identifier hs-var">elt_tys</span></a><span>
</span><a name="line-426"></a><span>    </span><a name="local-6989586621684090136"><a href="#local-6989586621684090136"><span class="hs-identifier">elt_tuple_list_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkListTy</span><span> </span><a href="#local-6989586621684090135"><span class="hs-identifier hs-var">elt_tuple_ty</span></a><span>
</span><a name="line-427"></a><span>
</span><a name="line-428"></a><span>    </span><a name="local-6989586621684090137"><a href="#local-6989586621684090137"><span class="hs-identifier">zip_fn_ty</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkFunTys</span><span> </span><a href="#local-6989586621684090134"><span class="hs-identifier hs-var">elt_list_tys</span></a><span> </span><a href="#local-6989586621684090136"><span class="hs-identifier hs-var">elt_tuple_list_ty</span></a><span>
</span><a name="line-429"></a><span>
</span><a name="line-430"></a><span>    </span><a name="local-6989586621684090138"><a href="#local-6989586621684090138"><span class="hs-identifier">mk_case</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-keyword">as</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684090140"><a href="#local-6989586621684090140"><span class="hs-identifier">a'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684090141"><a href="#local-6989586621684090141"><span class="hs-identifier">as'</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684090142"><a href="#local-6989586621684090142"><span class="hs-identifier">rest</span></a></a><span>
</span><a name="line-431"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span> </span><a href="#local-6989586621684090136"><span class="hs-identifier hs-var">elt_tuple_list_ty</span></a><span>
</span><a name="line-432"></a><span>                  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataAlt</span><span> </span><span class="hs-identifier hs-var">nilDataCon</span><span class="hs-special">,</span><span>  </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>        </span><span class="hs-identifier hs-var">mkNilExpr</span><span> </span><a href="#local-6989586621684090135"><span class="hs-identifier hs-var">elt_tuple_ty</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-433"></a><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataAlt</span><span> </span><span class="hs-identifier hs-var">consDataCon</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684090140"><span class="hs-identifier hs-var">a'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684090141"><span class="hs-identifier hs-var">as'</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684090142"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-434"></a><span>                        </span><span class="hs-comment">-- Increasing order of tag</span><span>
</span><a name="line-435"></a><span>
</span><a name="line-436"></a><span>
</span><a name="line-437"></a><span class="hs-identifier">mkUnzipBind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TransForm</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-438"></a><span class="hs-comment">-- mkUnzipBind [t1, t2]</span><span>
</span><a name="line-439"></a><span class="hs-comment">-- = (unzip, \ys :: [(t1, t2)] -&gt; foldr (\ax :: (t1, t2) axs :: ([t1], [t2])</span><span>
</span><a name="line-440"></a><span class="hs-comment">--     -&gt; case ax of</span><span>
</span><a name="line-441"></a><span class="hs-comment">--      (x1, x2) -&gt; case axs of</span><span>
</span><a name="line-442"></a><span class="hs-comment">--                (xs1, xs2) -&gt; (x1 : xs1, x2 : xs2))</span><span>
</span><a name="line-443"></a><span class="hs-comment">--      ([], [])</span><span>
</span><a name="line-444"></a><span class="hs-comment">--      ys)</span><span>
</span><a name="line-445"></a><span class="hs-comment">--</span><span>
</span><a name="line-446"></a><span class="hs-comment">-- We use foldr here in all cases, even if rules are turned off, because we may as well!</span><span>
</span><a name="line-447"></a><a name="mkUnzipBind"><a href="DsListComp.html#mkUnzipBind"><span class="hs-identifier">mkUnzipBind</span></a></a><span> </span><span class="hs-identifier hs-var">ThenForm</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-448"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-comment">-- No unzipping for ThenForm</span><span>
</span><a name="line-449"></a><span class="hs-identifier">mkUnzipBind</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684090149"><a href="#local-6989586621684090149"><span class="hs-identifier">elt_tys</span></a></a><span>
</span><a name="line-450"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684090159"><a href="#local-6989586621684090159"><span class="hs-identifier">ax</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#newSysLocalDs"><span class="hs-identifier hs-var">newSysLocalDs</span></a><span> </span><a href="#local-6989586621684090150"><span class="hs-identifier hs-var">elt_tuple_ty</span></a><span>
</span><a name="line-451"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684090160"><a href="#local-6989586621684090160"><span class="hs-identifier">axs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#newSysLocalDs"><span class="hs-identifier hs-var">newSysLocalDs</span></a><span> </span><a href="#local-6989586621684090153"><span class="hs-identifier hs-var">elt_list_tuple_ty</span></a><span>
</span><a name="line-452"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684090161"><a href="#local-6989586621684090161"><span class="hs-identifier">ys</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#newSysLocalDs"><span class="hs-identifier hs-var">newSysLocalDs</span></a><span> </span><a href="#local-6989586621684090151"><span class="hs-identifier hs-var">elt_tuple_list_ty</span></a><span>
</span><a name="line-453"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684090162"><a href="#local-6989586621684090162"><span class="hs-identifier">xs</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="DsMonad.html#newSysLocalDs"><span class="hs-identifier hs-var">newSysLocalDs</span></a><span> </span><a href="#local-6989586621684090149"><span class="hs-identifier hs-var">elt_tys</span></a><span>
</span><a name="line-454"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684090163"><a href="#local-6989586621684090163"><span class="hs-identifier">xss</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="DsMonad.html#newSysLocalDs"><span class="hs-identifier hs-var">newSysLocalDs</span></a><span> </span><a href="#local-6989586621684090152"><span class="hs-identifier hs-var">elt_list_tys</span></a><span>
</span><a name="line-455"></a><span>
</span><a name="line-456"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684090164"><a href="#local-6989586621684090164"><span class="hs-identifier">unzip_fn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#newSysLocalDs"><span class="hs-identifier hs-var">newSysLocalDs</span></a><span> </span><a href="#local-6989586621684090154"><span class="hs-identifier hs-var">unzip_fn_ty</span></a><span>
</span><a name="line-457"></a><span>
</span><a name="line-458"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">[</span><a name="local-6989586621684090165"><a href="#local-6989586621684090165"><span class="hs-identifier">us1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684090166"><a href="#local-6989586621684090166"><span class="hs-identifier">us2</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">sequence</span><span> </span><span class="hs-special">[</span><a href="TcRnMonad.html#newUniqueSupply"><span class="hs-identifier hs-var">newUniqueSupply</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#newUniqueSupply"><span class="hs-identifier hs-var">newUniqueSupply</span></a><span class="hs-special">]</span><span>
</span><a name="line-459"></a><span>
</span><a name="line-460"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684090167"><a href="#local-6989586621684090167"><span class="hs-identifier">nil_tuple</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkBigCoreTup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">mkNilExpr</span><span> </span><a href="#local-6989586621684090149"><span class="hs-identifier hs-var">elt_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-461"></a><span>             </span><a name="local-6989586621684090168"><a href="#local-6989586621684090168"><span class="hs-identifier">concat_expressions</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621684090155"><span class="hs-identifier hs-var">mkConcatExpression</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip3</span><span> </span><a href="#local-6989586621684090149"><span class="hs-identifier hs-var">elt_tys</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684090162"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684090163"><span class="hs-identifier hs-var">xss</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-462"></a><span>             </span><a name="local-6989586621684090169"><a href="#local-6989586621684090169"><span class="hs-identifier">tupled_concat_expression</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkBigCoreTup</span><span> </span><a href="#local-6989586621684090168"><span class="hs-identifier hs-var">concat_expressions</span></a><span>
</span><a name="line-463"></a><span>
</span><a name="line-464"></a><span>             </span><a name="local-6989586621684090170"><a href="#local-6989586621684090170"><span class="hs-identifier">folder_body_inner_case</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTupleCase</span><span> </span><a href="#local-6989586621684090165"><span class="hs-identifier hs-var">us1</span></a><span> </span><a href="#local-6989586621684090163"><span class="hs-identifier hs-var">xss</span></a><span> </span><a href="#local-6989586621684090169"><span class="hs-identifier hs-var">tupled_concat_expression</span></a><span> </span><a href="#local-6989586621684090160"><span class="hs-identifier hs-var">axs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684090160"><span class="hs-identifier hs-var">axs</span></a><span class="hs-special">)</span><span>
</span><a name="line-465"></a><span>             </span><a name="local-6989586621684090171"><a href="#local-6989586621684090171"><span class="hs-identifier">folder_body_outer_case</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTupleCase</span><span> </span><a href="#local-6989586621684090166"><span class="hs-identifier hs-var">us2</span></a><span> </span><a href="#local-6989586621684090162"><span class="hs-identifier hs-var">xs</span></a><span> </span><a href="#local-6989586621684090170"><span class="hs-identifier hs-var">folder_body_inner_case</span></a><span> </span><a href="#local-6989586621684090159"><span class="hs-identifier hs-var">ax</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684090159"><span class="hs-identifier hs-var">ax</span></a><span class="hs-special">)</span><span>
</span><a name="line-466"></a><span>             </span><a name="local-6989586621684090172"><a href="#local-6989586621684090172"><span class="hs-identifier">folder_body</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkLams</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684090159"><span class="hs-identifier hs-var">ax</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684090160"><span class="hs-identifier hs-var">axs</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621684090171"><span class="hs-identifier hs-var">folder_body_outer_case</span></a><span>
</span><a name="line-467"></a><span>
</span><a name="line-468"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684090173"><a href="#local-6989586621684090173"><span class="hs-identifier">unzip_body</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mkFoldrExpr</span><span> </span><a href="#local-6989586621684090150"><span class="hs-identifier hs-var">elt_tuple_ty</span></a><span> </span><a href="#local-6989586621684090153"><span class="hs-identifier hs-var">elt_list_tuple_ty</span></a><span> </span><a href="#local-6989586621684090172"><span class="hs-identifier hs-var">folder_body</span></a><span> </span><a href="#local-6989586621684090167"><span class="hs-identifier hs-var">nil_tuple</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684090161"><span class="hs-identifier hs-var">ys</span></a><span class="hs-special">)</span><span>
</span><a name="line-469"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684090164"><span class="hs-identifier hs-var">unzip_fn</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkLams</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684090161"><span class="hs-identifier hs-var">ys</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621684090173"><span class="hs-identifier hs-var">unzip_body</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-470"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-471"></a><span>    </span><a name="local-6989586621684090150"><a href="#local-6989586621684090150"><span class="hs-identifier">elt_tuple_ty</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkBigCoreTupTy</span><span> </span><a href="#local-6989586621684090149"><span class="hs-identifier hs-var">elt_tys</span></a><span>
</span><a name="line-472"></a><span>    </span><a name="local-6989586621684090151"><a href="#local-6989586621684090151"><span class="hs-identifier">elt_tuple_list_ty</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkListTy</span><span> </span><a href="#local-6989586621684090150"><span class="hs-identifier hs-var">elt_tuple_ty</span></a><span>
</span><a name="line-473"></a><span>    </span><a name="local-6989586621684090152"><a href="#local-6989586621684090152"><span class="hs-identifier">elt_list_tys</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">mkListTy</span><span> </span><a href="#local-6989586621684090149"><span class="hs-identifier hs-var">elt_tys</span></a><span>
</span><a name="line-474"></a><span>    </span><a name="local-6989586621684090153"><a href="#local-6989586621684090153"><span class="hs-identifier">elt_list_tuple_ty</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkBigCoreTupTy</span><span> </span><a href="#local-6989586621684090152"><span class="hs-identifier hs-var">elt_list_tys</span></a><span>
</span><a name="line-475"></a><span>
</span><a name="line-476"></a><span>    </span><a name="local-6989586621684090154"><a href="#local-6989586621684090154"><span class="hs-identifier">unzip_fn_ty</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684090151"><span class="hs-identifier hs-var">elt_tuple_list_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkFunTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684090153"><span class="hs-identifier hs-var">elt_list_tuple_ty</span></a><span>
</span><a name="line-477"></a><span>
</span><a name="line-478"></a><span>    </span><a name="local-6989586621684090155"><a href="#local-6989586621684090155"><span class="hs-identifier">mkConcatExpression</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684090156"><a href="#local-6989586621684090156"><span class="hs-identifier">list_element_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684090157"><a href="#local-6989586621684090157"><span class="hs-identifier">head</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684090158"><a href="#local-6989586621684090158"><span class="hs-identifier">tail</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkConsExpr</span><span> </span><a href="#local-6989586621684090156"><span class="hs-identifier hs-var">list_element_ty</span></a><span> </span><a href="#local-6989586621684090157"><span class="hs-identifier hs-var">head</span></a><span> </span><a href="#local-6989586621684090158"><span class="hs-identifier hs-var">tail</span></a><span>
</span><a name="line-479"></a><span>
</span><a name="line-480"></a><span class="hs-comment">-- Translation for monad comprehensions</span><span>
</span><a name="line-481"></a><span>
</span><a name="line-482"></a><span class="hs-comment">-- Entry point for monad comprehension desugaring</span><span>
</span><a name="line-483"></a><span class="hs-identifier">dsMonadComp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ExprLStmt</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-484"></a><a name="dsMonadComp"><a href="DsListComp.html#dsMonadComp"><span class="hs-identifier">dsMonadComp</span></a></a><span> </span><a name="local-6989586621684090174"><a href="#local-6989586621684090174"><span class="hs-identifier">stmts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsListComp.html#dsMcStmts"><span class="hs-identifier hs-var">dsMcStmts</span></a><span> </span><a href="#local-6989586621684090174"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-485"></a><span>
</span><a name="line-486"></a><span class="hs-identifier">dsMcStmts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ExprLStmt</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-487"></a><a name="dsMcStmts"><a href="DsListComp.html#dsMcStmts"><span class="hs-identifier">dsMcStmts</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>                          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsMcStmts&quot;</span><span>
</span><a name="line-488"></a><span class="hs-identifier">dsMcStmts</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621684090175"><a href="#local-6989586621684090175"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621684090176"><a href="#local-6989586621684090176"><span class="hs-identifier">stmt</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684090177"><a href="#local-6989586621684090177"><span class="hs-identifier">lstmts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#putSrcSpanDs"><span class="hs-identifier hs-var">putSrcSpanDs</span></a><span> </span><a href="#local-6989586621684090175"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><a href="DsListComp.html#dsMcStmt"><span class="hs-identifier hs-var">dsMcStmt</span></a><span> </span><a href="#local-6989586621684090176"><span class="hs-identifier hs-var">stmt</span></a><span> </span><a href="#local-6989586621684090177"><span class="hs-identifier hs-var">lstmts</span></a><span class="hs-special">)</span><span>
</span><a name="line-489"></a><span>
</span><a name="line-490"></a><span class="hs-comment">---------------</span><span>
</span><a name="line-491"></a><span class="hs-identifier">dsMcStmt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ExprStmt</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ExprLStmt</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-492"></a><span>
</span><a name="line-493"></a><a name="dsMcStmt"><a href="DsListComp.html#dsMcStmt"><span class="hs-identifier">dsMcStmt</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LastStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684090178"><a href="#local-6989586621684090178"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684090179"><a href="#local-6989586621684090179"><span class="hs-identifier">ret_op</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684090180"><a href="#local-6989586621684090180"><span class="hs-identifier">stmts</span></a></a><span>
</span><a name="line-494"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-identifier">stmts</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-495"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684090181"><a href="#local-6989586621684090181"><span class="hs-identifier">body'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684090178"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-496"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="DsExpr.html#dsSyntaxExpr"><span class="hs-identifier hs-var">dsSyntaxExpr</span></a><span> </span><a href="#local-6989586621684090179"><span class="hs-identifier hs-var">ret_op</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684090181"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-497"></a><span>
</span><a name="line-498"></a><span class="hs-comment">--   [ .. | let binds, stmts ]</span><span>
</span><a name="line-499"></a><span class="hs-identifier">dsMcStmt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LetStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684090182"><a href="#local-6989586621684090182"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684090183"><a href="#local-6989586621684090183"><span class="hs-identifier">stmts</span></a></a><span>
</span><a name="line-500"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684090184"><a href="#local-6989586621684090184"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsListComp.html#dsMcStmts"><span class="hs-identifier hs-var">dsMcStmts</span></a><span> </span><a href="#local-6989586621684090183"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-501"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="DsExpr.html#dsLocalBinds"><span class="hs-identifier hs-var">dsLocalBinds</span></a><span> </span><a href="#local-6989586621684090182"><span class="hs-identifier hs-var">binds</span></a><span> </span><a href="#local-6989586621684090184"><span class="hs-identifier hs-var">rest</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-502"></a><span>
</span><a name="line-503"></a><span class="hs-comment">--   [ .. | a &lt;- m, stmts ]</span><span>
</span><a name="line-504"></a><span class="hs-identifier">dsMcStmt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BindStmt</span><span> </span><a name="local-6989586621684090185"><a href="#local-6989586621684090185"><span class="hs-identifier">bind_ty</span></a></a><span> </span><a name="local-6989586621684090186"><a href="#local-6989586621684090186"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621684090187"><a href="#local-6989586621684090187"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621684090188"><a href="#local-6989586621684090188"><span class="hs-identifier">bind_op</span></a></a><span> </span><a name="local-6989586621684090189"><a href="#local-6989586621684090189"><span class="hs-identifier">fail_op</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684090190"><a href="#local-6989586621684090190"><span class="hs-identifier">stmts</span></a></a><span>
</span><a name="line-505"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684090191"><a href="#local-6989586621684090191"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684090187"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-506"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="DsListComp.html#dsMcBindStmt"><span class="hs-identifier hs-var">dsMcBindStmt</span></a><span> </span><a href="#local-6989586621684090186"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621684090191"><span class="hs-identifier hs-var">rhs'</span></a><span> </span><a href="#local-6989586621684090188"><span class="hs-identifier hs-var">bind_op</span></a><span> </span><a href="#local-6989586621684090189"><span class="hs-identifier hs-var">fail_op</span></a><span> </span><a href="#local-6989586621684090185"><span class="hs-identifier hs-var">bind_ty</span></a><span> </span><a href="#local-6989586621684090190"><span class="hs-identifier hs-var">stmts</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-507"></a><span>
</span><a name="line-508"></a><span class="hs-comment">-- Apply `guard` to the `exp` expression</span><span>
</span><a name="line-509"></a><span class="hs-comment">--</span><span>
</span><a name="line-510"></a><span class="hs-comment">--   [ .. | exp, stmts ]</span><span>
</span><a name="line-511"></a><span class="hs-comment">--</span><span>
</span><a name="line-512"></a><span class="hs-identifier">dsMcStmt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684090192"><a href="#local-6989586621684090192"><span class="hs-identifier">exp</span></a></a><span> </span><a name="local-6989586621684090193"><a href="#local-6989586621684090193"><span class="hs-identifier">then_exp</span></a></a><span> </span><a name="local-6989586621684090194"><a href="#local-6989586621684090194"><span class="hs-identifier">guard_exp</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684090195"><a href="#local-6989586621684090195"><span class="hs-identifier">stmts</span></a></a><span>
</span><a name="line-513"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684090196"><a href="#local-6989586621684090196"><span class="hs-identifier">exp'</span></a></a><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684090192"><span class="hs-identifier hs-var">exp</span></a><span>
</span><a name="line-514"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684090197"><a href="#local-6989586621684090197"><span class="hs-identifier">rest</span></a></a><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsListComp.html#dsMcStmts"><span class="hs-identifier hs-var">dsMcStmts</span></a><span> </span><a href="#local-6989586621684090195"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-515"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684090198"><a href="#local-6989586621684090198"><span class="hs-identifier">guard_exp'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsSyntaxExpr"><span class="hs-identifier hs-var">dsSyntaxExpr</span></a><span> </span><a href="#local-6989586621684090194"><span class="hs-identifier hs-var">guard_exp</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684090196"><span class="hs-identifier hs-var">exp'</span></a><span class="hs-special">]</span><span>
</span><a name="line-516"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="DsExpr.html#dsSyntaxExpr"><span class="hs-identifier hs-var">dsSyntaxExpr</span></a><span> </span><a href="#local-6989586621684090193"><span class="hs-identifier hs-var">then_exp</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684090198"><span class="hs-identifier hs-var">guard_exp'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684090197"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-517"></a><span>
</span><a name="line-518"></a><span class="hs-comment">-- Group statements desugar like this:</span><span>
</span><a name="line-519"></a><span class="hs-comment">--</span><span>
</span><a name="line-520"></a><span class="hs-comment">--   [| (q, then group by e using f); rest |]</span><span>
</span><a name="line-521"></a><span class="hs-comment">--   ---&gt;  f {qt} (\qv -&gt; e) [| q; return qv |] &gt;&gt;= \ n_tup -&gt;</span><span>
</span><a name="line-522"></a><span class="hs-comment">--         case unzip n_tup of qv' -&gt; [| rest |]</span><span>
</span><a name="line-523"></a><span class="hs-comment">--</span><span>
</span><a name="line-524"></a><span class="hs-comment">-- where   variables (v1:t1, ..., vk:tk) are bound by q</span><span>
</span><a name="line-525"></a><span class="hs-comment">--         qv = (v1, ..., vk)</span><span>
</span><a name="line-526"></a><span class="hs-comment">--         qt = (t1, ..., tk)</span><span>
</span><a name="line-527"></a><span class="hs-comment">--         (&gt;&gt;=) :: m2 a -&gt; (a -&gt; m3 b) -&gt; m3 b</span><span>
</span><a name="line-528"></a><span class="hs-comment">--         f :: forall a. (a -&gt; t) -&gt; m1 a -&gt; m2 (n a)</span><span>
</span><a name="line-529"></a><span class="hs-comment">--         n_tup :: n qt</span><span>
</span><a name="line-530"></a><span class="hs-comment">--         unzip :: n qt -&gt; (n t1, ..., n tk)    (needs Functor n)</span><span>
</span><a name="line-531"></a><span>
</span><a name="line-532"></a><span class="hs-identifier">dsMcStmt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TransStmt</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">trS_stmts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684090199"><a href="#local-6989586621684090199"><span class="hs-identifier">stmts</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684090200"><a href="#local-6989586621684090200"><span class="hs-identifier">bndrs</span></a></a><span>
</span><a name="line-533"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_by</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684090201"><a href="#local-6989586621684090201"><span class="hs-identifier">by</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_using</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684090202"><a href="#local-6989586621684090202"><span class="hs-identifier">using</span></a></a><span>
</span><a name="line-534"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_ret</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684090203"><a href="#local-6989586621684090203"><span class="hs-identifier">return_op</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_bind</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684090204"><a href="#local-6989586621684090204"><span class="hs-identifier">bind_op</span></a></a><span>
</span><a name="line-535"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684090205"><a href="#local-6989586621684090205"><span class="hs-identifier">n_tup_ty'</span></a></a><span>  </span><span class="hs-comment">-- n (a,b,c)</span><span>
</span><a name="line-536"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_fmap</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684090206"><a href="#local-6989586621684090206"><span class="hs-identifier">fmap_op</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">trS_form</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684090207"><a href="#local-6989586621684090207"><span class="hs-identifier">form</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684090208"><a href="#local-6989586621684090208"><span class="hs-identifier">stmts_rest</span></a></a><span>
</span><a name="line-537"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684090209"><a href="#local-6989586621684090209"><span class="hs-identifier">from_bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684090210"><a href="#local-6989586621684090210"><span class="hs-identifier">to_bndrs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621684090200"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-538"></a><span>
</span><a name="line-539"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684090211"><a href="#local-6989586621684090211"><span class="hs-identifier">from_bndr_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621684090209"><span class="hs-identifier hs-var">from_bndrs</span></a><span>     </span><span class="hs-comment">-- Types ty</span><span>
</span><a name="line-540"></a><span>
</span><a name="line-541"></a><span>
</span><a name="line-542"></a><span>       </span><span class="hs-comment">-- Desugar an inner comprehension which outputs a list of tuples of the &quot;from&quot; binders</span><span>
</span><a name="line-543"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684090212"><a href="#local-6989586621684090212"><span class="hs-identifier">expr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsListComp.html#dsInnerMonadComp"><span class="hs-identifier hs-var">dsInnerMonadComp</span></a><span> </span><a href="#local-6989586621684090199"><span class="hs-identifier hs-var">stmts</span></a><span> </span><a href="#local-6989586621684090209"><span class="hs-identifier hs-var">from_bndrs</span></a><span> </span><a href="#local-6989586621684090203"><span class="hs-identifier hs-var">return_op</span></a><span>
</span><a name="line-544"></a><span>
</span><a name="line-545"></a><span>       </span><span class="hs-comment">-- Work out what arguments should be supplied to that expression: i.e. is an extraction</span><span>
</span><a name="line-546"></a><span>       </span><span class="hs-comment">-- function required? If so, create that desugared function and add to arguments</span><span>
</span><a name="line-547"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684090213"><a href="#local-6989586621684090213"><span class="hs-identifier">usingExpr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684090202"><span class="hs-identifier hs-var">using</span></a><span>
</span><a name="line-548"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684090217"><a href="#local-6989586621684090217"><span class="hs-identifier">usingArgs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684090201"><span class="hs-identifier hs-var">by</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-549"></a><span>                         </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684090212"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">]</span><span>
</span><a name="line-550"></a><span>                         </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684090214"><a href="#local-6989586621684090214"><span class="hs-identifier">by_e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684090215"><a href="#local-6989586621684090215"><span class="hs-identifier">by_e'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684090214"><span class="hs-identifier hs-var">by_e</span></a><span>
</span><a name="line-551"></a><span>                                         </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684090216"><a href="#local-6989586621684090216"><span class="hs-identifier">lam'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsListComp.html#matchTuple"><span class="hs-identifier hs-var">matchTuple</span></a><span> </span><a href="#local-6989586621684090209"><span class="hs-identifier hs-var">from_bndrs</span></a><span> </span><a href="#local-6989586621684090215"><span class="hs-identifier hs-var">by_e'</span></a><span>
</span><a name="line-552"></a><span>                                         </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684090216"><span class="hs-identifier hs-var">lam'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684090212"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-553"></a><span>
</span><a name="line-554"></a><span>       </span><span class="hs-comment">-- Generate the expressions to build the grouped list</span><span>
</span><a name="line-555"></a><span>       </span><span class="hs-comment">-- Build a pattern that ensures the consumer binds into the NEW binders,</span><span>
</span><a name="line-556"></a><span>       </span><span class="hs-comment">-- which hold monads rather than single values</span><span>
</span><a name="line-557"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684090218"><a href="#local-6989586621684090218"><span class="hs-identifier">tup_n_ty'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkBigCoreVarTupTy</span><span> </span><a href="#local-6989586621684090210"><span class="hs-identifier hs-var">to_bndrs</span></a><span>
</span><a name="line-558"></a><span>
</span><a name="line-559"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684090219"><a href="#local-6989586621684090219"><span class="hs-identifier">body</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsListComp.html#dsMcStmts"><span class="hs-identifier hs-var">dsMcStmts</span></a><span> </span><a href="#local-6989586621684090208"><span class="hs-identifier hs-var">stmts_rest</span></a><span>
</span><a name="line-560"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684090220"><a href="#local-6989586621684090220"><span class="hs-identifier">n_tup_var'</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#newSysLocalDsNoLP"><span class="hs-identifier hs-var">newSysLocalDsNoLP</span></a><span> </span><a href="#local-6989586621684090205"><span class="hs-identifier hs-var">n_tup_ty'</span></a><span>
</span><a name="line-561"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684090221"><a href="#local-6989586621684090221"><span class="hs-identifier">tup_n_var'</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#newSysLocalDs"><span class="hs-identifier hs-var">newSysLocalDs</span></a><span> </span><a href="#local-6989586621684090218"><span class="hs-identifier hs-var">tup_n_ty'</span></a><span>
</span><a name="line-562"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684090222"><a href="#local-6989586621684090222"><span class="hs-identifier">tup_n_expr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsListComp.html#mkMcUnzipM"><span class="hs-identifier hs-var">mkMcUnzipM</span></a><span> </span><a href="#local-6989586621684090207"><span class="hs-identifier hs-var">form</span></a><span> </span><a href="#local-6989586621684090206"><span class="hs-identifier hs-var">fmap_op</span></a><span> </span><a href="#local-6989586621684090220"><span class="hs-identifier hs-var">n_tup_var'</span></a><span> </span><a href="#local-6989586621684090211"><span class="hs-identifier hs-var">from_bndr_tys</span></a><span>
</span><a name="line-563"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684090223"><a href="#local-6989586621684090223"><span class="hs-identifier">us</span></a></a><span>          </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newUniqueSupply"><span class="hs-identifier hs-var">newUniqueSupply</span></a><span>
</span><a name="line-564"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684090224"><a href="#local-6989586621684090224"><span class="hs-identifier">rhs'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkApps</span><span> </span><a href="#local-6989586621684090213"><span class="hs-identifier hs-var">usingExpr'</span></a><span> </span><a href="#local-6989586621684090217"><span class="hs-identifier hs-var">usingArgs'</span></a><span>
</span><a name="line-565"></a><span>             </span><a name="local-6989586621684090225"><a href="#local-6989586621684090225"><span class="hs-identifier">body'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTupleCase</span><span> </span><a href="#local-6989586621684090223"><span class="hs-identifier hs-var">us</span></a><span> </span><a href="#local-6989586621684090210"><span class="hs-identifier hs-var">to_bndrs</span></a><span> </span><a href="#local-6989586621684090219"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621684090221"><span class="hs-identifier hs-var">tup_n_var'</span></a><span> </span><a href="#local-6989586621684090222"><span class="hs-identifier hs-var">tup_n_expr'</span></a><span>
</span><a name="line-566"></a><span>
</span><a name="line-567"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="DsExpr.html#dsSyntaxExpr"><span class="hs-identifier hs-var">dsSyntaxExpr</span></a><span> </span><a href="#local-6989586621684090204"><span class="hs-identifier hs-var">bind_op</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684090224"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Lam</span><span> </span><a href="#local-6989586621684090220"><span class="hs-identifier hs-var">n_tup_var'</span></a><span> </span><a href="#local-6989586621684090225"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-568"></a><span>
</span><a name="line-569"></a><span class="hs-comment">-- Parallel statements. Use `Control.Monad.Zip.mzip` to zip parallel</span><span>
</span><a name="line-570"></a><span class="hs-comment">-- statements, for example:</span><span>
</span><a name="line-571"></a><span class="hs-comment">--</span><span>
</span><a name="line-572"></a><span class="hs-comment">--   [ body | qs1 | qs2 | qs3 ]</span><span>
</span><a name="line-573"></a><span class="hs-comment">--     -&gt;  [ body | (bndrs1, (bndrs2, bndrs3))</span><span>
</span><a name="line-574"></a><span class="hs-comment">--                     &lt;- [bndrs1 | qs1] `mzip` ([bndrs2 | qs2] `mzip` [bndrs3 | qs3]) ]</span><span>
</span><a name="line-575"></a><span class="hs-comment">--</span><span>
</span><a name="line-576"></a><span class="hs-comment">-- where `mzip` has type</span><span>
</span><a name="line-577"></a><span class="hs-comment">--   mzip :: forall a b. m a -&gt; m b -&gt; m (a,b)</span><span>
</span><a name="line-578"></a><span class="hs-comment">-- NB: we need a polymorphic mzip because we call it several times</span><span>
</span><a name="line-579"></a><span>
</span><a name="line-580"></a><span class="hs-identifier">dsMcStmt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParStmt</span><span> </span><a name="local-6989586621684090226"><a href="#local-6989586621684090226"><span class="hs-identifier">bind_ty</span></a></a><span> </span><a name="local-6989586621684090227"><a href="#local-6989586621684090227"><span class="hs-identifier">blocks</span></a></a><span> </span><a name="local-6989586621684090228"><a href="#local-6989586621684090228"><span class="hs-identifier">mzip_op</span></a></a><span> </span><a name="local-6989586621684090229"><a href="#local-6989586621684090229"><span class="hs-identifier">bind_op</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684090230"><a href="#local-6989586621684090230"><span class="hs-identifier">stmts_rest</span></a></a><span>
</span><a name="line-581"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684090236"><a href="#local-6989586621684090236"><span class="hs-identifier">exps_w_tys</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621684090231"><span class="hs-identifier hs-var">ds_inner</span></a><span> </span><a href="#local-6989586621684090227"><span class="hs-identifier hs-var">blocks</span></a><span>   </span><span class="hs-comment">-- Pairs (exp :: m ty, ty)</span><span>
</span><a name="line-582"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684090237"><a href="#local-6989586621684090237"><span class="hs-identifier">mzip_op'</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsExpr"><span class="hs-identifier hs-var">dsExpr</span></a><span> </span><a href="#local-6989586621684090228"><span class="hs-identifier hs-var">mzip_op</span></a><span>
</span><a name="line-583"></a><span>
</span><a name="line-584"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- The pattern variables</span><span>
</span><a name="line-585"></a><span>             </span><a name="local-6989586621684090238"><a href="#local-6989586621684090238"><span class="hs-identifier">pats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="DsUtils.html#mkBigLHsVarPatTupId"><span class="hs-identifier hs-var">mkBigLHsVarPatTupId</span></a><span> </span><a href="#local-6989586621684090241"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">ParStmtBlock</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684090241"><a href="#local-6989586621684090241"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684090227"><span class="hs-identifier hs-var">blocks</span></a><span class="hs-special">]</span><span>
</span><a name="line-586"></a><span>             </span><span class="hs-comment">-- Pattern with tuples of variables</span><span>
</span><a name="line-587"></a><span>             </span><span class="hs-comment">-- [v1,v2,v3]  =&gt;  (v1, (v2, v3))</span><span>
</span><a name="line-588"></a><span>             </span><a name="local-6989586621684090239"><a href="#local-6989586621684090239"><span class="hs-identifier">pat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr1</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684090242"><a href="#local-6989586621684090242"><span class="hs-identifier">p1</span></a></a><span> </span><a name="local-6989586621684090243"><a href="#local-6989586621684090243"><span class="hs-identifier">p2</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsUtils.html#mkLHsPatTup"><span class="hs-identifier hs-var">mkLHsPatTup</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684090242"><span class="hs-identifier hs-var">p1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684090243"><span class="hs-identifier hs-var">p2</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684090238"><span class="hs-identifier hs-var">pats</span></a><span>
</span><a name="line-589"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621684090240"><a href="#local-6989586621684090240"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr1</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621684090244"><a href="#local-6989586621684090244"><span class="hs-identifier">e1</span></a></a><span class="hs-special">,</span><a name="local-6989586621684090245"><a href="#local-6989586621684090245"><span class="hs-identifier">t1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684090246"><a href="#local-6989586621684090246"><span class="hs-identifier">e2</span></a></a><span class="hs-special">,</span><a name="local-6989586621684090247"><a href="#local-6989586621684090247"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-590"></a><span>                                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkApps</span><span> </span><a href="#local-6989586621684090237"><span class="hs-identifier hs-var">mzip_op'</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Type</span><span> </span><a href="#local-6989586621684090245"><span class="hs-identifier hs-var">t1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Type</span><span> </span><a href="#local-6989586621684090247"><span class="hs-identifier hs-var">t2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684090244"><span class="hs-identifier hs-var">e1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684090246"><span class="hs-identifier hs-var">e2</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-591"></a><span>                                  </span><span class="hs-identifier hs-var">mkBoxedTupleTy</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684090245"><span class="hs-identifier hs-var">t1</span></a><span class="hs-special">,</span><a href="#local-6989586621684090247"><span class="hs-identifier hs-var">t2</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-592"></a><span>                               </span><a href="#local-6989586621684090236"><span class="hs-identifier hs-var">exps_w_tys</span></a><span>
</span><a name="line-593"></a><span>
</span><a name="line-594"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="DsListComp.html#dsMcBindStmt"><span class="hs-identifier hs-var">dsMcBindStmt</span></a><span> </span><a href="#local-6989586621684090239"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621684090240"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621684090229"><span class="hs-identifier hs-var">bind_op</span></a><span> </span><span class="hs-identifier hs-var">noSyntaxExpr</span><span> </span><a href="#local-6989586621684090226"><span class="hs-identifier hs-var">bind_ty</span></a><span> </span><a href="#local-6989586621684090230"><span class="hs-identifier hs-var">stmts_rest</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-595"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-596"></a><span>    </span><a name="local-6989586621684090231"><a href="#local-6989586621684090231"><span class="hs-identifier">ds_inner</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParStmtBlock</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684090232"><a href="#local-6989586621684090232"><span class="hs-identifier">stmts</span></a></a><span> </span><a name="local-6989586621684090233"><a href="#local-6989586621684090233"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-6989586621684090234"><a href="#local-6989586621684090234"><span class="hs-identifier">return_op</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-597"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684090235"><a href="#local-6989586621684090235"><span class="hs-identifier">exp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsListComp.html#dsInnerMonadComp"><span class="hs-identifier hs-var">dsInnerMonadComp</span></a><span> </span><a href="#local-6989586621684090232"><span class="hs-identifier hs-var">stmts</span></a><span> </span><a href="#local-6989586621684090233"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621684090234"><span class="hs-identifier hs-var">return_op</span></a><span>
</span><a name="line-598"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684090235"><span class="hs-identifier hs-var">exp</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkBigCoreVarTupTy</span><span> </span><a href="#local-6989586621684090233"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-599"></a><span>    </span><span class="hs-identifier">ds_inner</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XParStmtBlock</span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsMcStmt&quot;</span><span>
</span><a name="line-600"></a><span>
</span><a name="line-601"></a><span class="hs-identifier">dsMcStmt</span><span> </span><a name="local-6989586621684090248"><a href="#local-6989586621684090248"><span class="hs-identifier">stmt</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;dsMcStmt: unexpected stmt&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684090248"><span class="hs-identifier hs-var">stmt</span></a><span class="hs-special">)</span><span>
</span><a name="line-602"></a><span>
</span><a name="line-603"></a><span>
</span><a name="line-604"></a><span class="hs-identifier">matchTuple</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-605"></a><span class="hs-comment">-- (matchTuple [a,b,c] body)</span><span>
</span><a name="line-606"></a><span class="hs-comment">--       returns the Core term</span><span>
</span><a name="line-607"></a><span class="hs-comment">--  \x. case x of (a,b,c) -&gt; body</span><span>
</span><a name="line-608"></a><a name="matchTuple"><a href="DsListComp.html#matchTuple"><span class="hs-identifier">matchTuple</span></a></a><span> </span><a name="local-6989586621684090249"><a href="#local-6989586621684090249"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-6989586621684090250"><a href="#local-6989586621684090250"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-609"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684090251"><a href="#local-6989586621684090251"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newUniqueSupply"><span class="hs-identifier hs-var">newUniqueSupply</span></a><span>
</span><a name="line-610"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684090252"><a href="#local-6989586621684090252"><span class="hs-identifier">tup_id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#newSysLocalDs"><span class="hs-identifier hs-var">newSysLocalDs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkBigCoreVarTupTy</span><span> </span><a href="#local-6989586621684090249"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">)</span><span>
</span><a name="line-611"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Lam</span><span> </span><a href="#local-6989586621684090252"><span class="hs-identifier hs-var">tup_id</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkTupleCase</span><span> </span><a href="#local-6989586621684090251"><span class="hs-identifier hs-var">us</span></a><span> </span><a href="#local-6989586621684090249"><span class="hs-identifier hs-var">ids</span></a><span> </span><a href="#local-6989586621684090250"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621684090252"><span class="hs-identifier hs-var">tup_id</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684090252"><span class="hs-identifier hs-var">tup_id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-612"></a><span>
</span><a name="line-613"></a><span class="hs-comment">-- general `rhs' &gt;&gt;= \pat -&gt; stmts` desugaring where `rhs'` is already a</span><span>
</span><a name="line-614"></a><span class="hs-comment">-- desugared `CoreExpr`</span><span>
</span><a name="line-615"></a><span class="hs-identifier">dsMcBindStmt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-616"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>        </span><span class="hs-comment">-- ^ the desugared rhs of the bind statement</span><span>
</span><a name="line-617"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SyntaxExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-618"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SyntaxExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-619"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>            </span><span class="hs-comment">-- ^ S in (&gt;&gt;=) :: Q -&gt; (R -&gt; S) -&gt; T</span><span>
</span><a name="line-620"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ExprLStmt</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">]</span><span>
</span><a name="line-621"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-622"></a><a name="dsMcBindStmt"><a href="DsListComp.html#dsMcBindStmt"><span class="hs-identifier">dsMcBindStmt</span></a></a><span> </span><a name="local-6989586621684090253"><a href="#local-6989586621684090253"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621684090254"><a href="#local-6989586621684090254"><span class="hs-identifier">rhs'</span></a></a><span> </span><a name="local-6989586621684090255"><a href="#local-6989586621684090255"><span class="hs-identifier">bind_op</span></a></a><span> </span><a name="local-6989586621684090256"><a href="#local-6989586621684090256"><span class="hs-identifier">fail_op</span></a></a><span> </span><a name="local-6989586621684090257"><a href="#local-6989586621684090257"><span class="hs-identifier">res1_ty</span></a></a><span> </span><a name="local-6989586621684090258"><a href="#local-6989586621684090258"><span class="hs-identifier">stmts</span></a></a><span>
</span><a name="line-623"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684090270"><a href="#local-6989586621684090270"><span class="hs-identifier">body</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsListComp.html#dsMcStmts"><span class="hs-identifier hs-var">dsMcStmts</span></a><span> </span><a href="#local-6989586621684090258"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-624"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684090271"><a href="#local-6989586621684090271"><span class="hs-identifier">var</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsUtils.html#selectSimpleMatchVarL"><span class="hs-identifier hs-var">selectSimpleMatchVarL</span></a><span> </span><a href="#local-6989586621684090253"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-625"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684090272"><a href="#local-6989586621684090272"><span class="hs-identifier">match</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Match.html#matchSinglePatVar"><span class="hs-identifier hs-var">matchSinglePatVar</span></a><span> </span><a href="#local-6989586621684090271"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">StmtCtxt</span><span> </span><span class="hs-identifier hs-var">DoExpr</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684090253"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-626"></a><span>                                  </span><a href="#local-6989586621684090257"><span class="hs-identifier hs-var">res1_ty</span></a><span> </span><span class="hs-special">(</span><a href="DsUtils.html#cantFailMatchResult"><span class="hs-identifier hs-var">cantFailMatchResult</span></a><span> </span><a href="#local-6989586621684090270"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-627"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684090273"><a href="#local-6989586621684090273"><span class="hs-identifier">match_code</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684090259"><span class="hs-identifier hs-var">handle_failure</span></a><span> </span><a href="#local-6989586621684090253"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621684090272"><span class="hs-identifier hs-var">match</span></a><span> </span><a href="#local-6989586621684090256"><span class="hs-identifier hs-var">fail_op</span></a><span>
</span><a name="line-628"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="DsExpr.html#dsSyntaxExpr"><span class="hs-identifier hs-var">dsSyntaxExpr</span></a><span> </span><a href="#local-6989586621684090255"><span class="hs-identifier hs-var">bind_op</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684090254"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Lam</span><span> </span><a href="#local-6989586621684090271"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621684090273"><span class="hs-identifier hs-var">match_code</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-629"></a><span>
</span><a name="line-630"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-631"></a><span>    </span><span class="hs-comment">-- In a monad comprehension expression, pattern-match failure just calls</span><span>
</span><a name="line-632"></a><span>    </span><span class="hs-comment">-- the monadic `fail` rather than throwing an exception</span><span>
</span><a name="line-633"></a><span>    </span><a name="local-6989586621684090259"><a href="#local-6989586621684090259"><span class="hs-identifier">handle_failure</span></a></a><span> </span><a name="local-6989586621684090262"><a href="#local-6989586621684090262"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621684090263"><a href="#local-6989586621684090263"><span class="hs-identifier">match</span></a></a><span> </span><a name="local-6989586621684090264"><a href="#local-6989586621684090264"><span class="hs-identifier">fail_op</span></a></a><span>
</span><a name="line-634"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="DsUtils.html#matchCanFail"><span class="hs-identifier hs-var">matchCanFail</span></a><span> </span><a href="#local-6989586621684090263"><span class="hs-identifier hs-var">match</span></a><span>
</span><a name="line-635"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684090265"><a href="#local-6989586621684090265"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-636"></a><span>             </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684090266"><a href="#local-6989586621684090266"><span class="hs-identifier">fail_msg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mkStringExpr</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684090260"><span class="hs-identifier hs-var">mk_fail_msg</span></a><span> </span><a href="#local-6989586621684090265"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684090262"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">)</span><span>
</span><a name="line-637"></a><span>             </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684090267"><a href="#local-6989586621684090267"><span class="hs-identifier">fail_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsSyntaxExpr"><span class="hs-identifier hs-var">dsSyntaxExpr</span></a><span> </span><a href="#local-6989586621684090264"><span class="hs-identifier hs-var">fail_op</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684090266"><span class="hs-identifier hs-var">fail_msg</span></a><span class="hs-special">]</span><span>
</span><a name="line-638"></a><span>             </span><span class="hs-special">;</span><span> </span><a href="DsUtils.html#extractMatchResult"><span class="hs-identifier hs-var">extractMatchResult</span></a><span> </span><a href="#local-6989586621684090263"><span class="hs-identifier hs-var">match</span></a><span> </span><a href="#local-6989586621684090267"><span class="hs-identifier hs-var">fail_expr</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-639"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-640"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#extractMatchResult"><span class="hs-identifier hs-var">extractMatchResult</span></a><span> </span><a href="#local-6989586621684090263"><span class="hs-identifier hs-var">match</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;It can't fail&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-641"></a><span>
</span><a name="line-642"></a><span>    </span><span class="hs-identifier">mk_fail_msg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HasSrcSpan</span><span> </span><a href="#local-6989586621684090261"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684090261"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-643"></a><span>    </span><a name="local-6989586621684090260"><a href="#local-6989586621684090260"><span class="hs-identifier">mk_fail_msg</span></a></a><span> </span><a name="local-6989586621684090268"><a href="#local-6989586621684090268"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684090269"><a href="#local-6989586621684090269"><span class="hs-identifier">pat</span></a></a><span>
</span><a name="line-644"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;Pattern match failure in monad comprehension at &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-645"></a><span>          </span><span class="hs-identifier hs-var">showPpr</span><span> </span><a href="#local-6989586621684090268"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getLoc</span><span> </span><a href="#local-6989586621684090269"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">)</span><span>
</span><a name="line-646"></a><span>
</span><a name="line-647"></a><span class="hs-comment">-- Desugar nested monad comprehensions, for example in `then..` constructs</span><span>
</span><a name="line-648"></a><span class="hs-comment">--    dsInnerMonadComp quals [a,b,c] ret_op</span><span>
</span><a name="line-649"></a><span class="hs-comment">-- returns the desugaring of</span><span>
</span><a name="line-650"></a><span class="hs-comment">--       [ (a,b,c) | quals ]</span><span>
</span><a name="line-651"></a><span>
</span><a name="line-652"></a><span class="hs-identifier">dsInnerMonadComp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ExprLStmt</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">]</span><span>
</span><a name="line-653"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>               </span><span class="hs-comment">-- Return a tuple of these variables</span><span>
</span><a name="line-654"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SyntaxExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>   </span><span class="hs-comment">-- The monomorphic &quot;return&quot; operator</span><span>
</span><a name="line-655"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-656"></a><a name="dsInnerMonadComp"><a href="DsListComp.html#dsInnerMonadComp"><span class="hs-identifier">dsInnerMonadComp</span></a></a><span> </span><a name="local-6989586621684090274"><a href="#local-6989586621684090274"><span class="hs-identifier">stmts</span></a></a><span> </span><a name="local-6989586621684090275"><a href="#local-6989586621684090275"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-6989586621684090276"><a href="#local-6989586621684090276"><span class="hs-identifier">ret_op</span></a></a><span>
</span><a name="line-657"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsListComp.html#dsMcStmts"><span class="hs-identifier hs-var">dsMcStmts</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684090274"><span class="hs-identifier hs-var">stmts</span></a><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-658"></a><span>                 </span><span class="hs-special">[</span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LastStmt</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><a href="DsUtils.html#mkBigLHsVarTupId"><span class="hs-identifier hs-var">mkBigLHsVarTupId</span></a><span> </span><a href="#local-6989586621684090275"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621684090276"><span class="hs-identifier hs-var">ret_op</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-659"></a><span>
</span><a name="line-660"></a><span>
</span><a name="line-661"></a><span class="hs-comment">-- The `unzip` function for `GroupStmt` in a monad comprehensions</span><span>
</span><a name="line-662"></a><span class="hs-comment">--</span><span>
</span><a name="line-663"></a><span class="hs-comment">--   unzip :: m (a,b,..) -&gt; (m a,m b,..)</span><span>
</span><a name="line-664"></a><span class="hs-comment">--   unzip m_tuple = ( liftM selN1 m_tuple</span><span>
</span><a name="line-665"></a><span class="hs-comment">--                   , liftM selN2 m_tuple</span><span>
</span><a name="line-666"></a><span class="hs-comment">--                   , .. )</span><span>
</span><a name="line-667"></a><span class="hs-comment">--</span><span>
</span><a name="line-668"></a><span class="hs-comment">--   mkMcUnzipM fmap ys [t1, t2]</span><span>
</span><a name="line-669"></a><span class="hs-comment">--     = ( fmap (selN1 :: (t1, t2) -&gt; t1) ys</span><span>
</span><a name="line-670"></a><span class="hs-comment">--       , fmap (selN2 :: (t1, t2) -&gt; t2) ys )</span><span>
</span><a name="line-671"></a><span>
</span><a name="line-672"></a><span class="hs-identifier">mkMcUnzipM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TransForm</span><span>
</span><a name="line-673"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span>    </span><span class="hs-comment">-- fmap</span><span>
</span><a name="line-674"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span>                </span><span class="hs-comment">-- Of type n (a,b,c)</span><span>
</span><a name="line-675"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>            </span><span class="hs-comment">-- [a,b,c]   (not levity-polymorphic)</span><span>
</span><a name="line-676"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>      </span><span class="hs-comment">-- Of type (n a, n b, n c)</span><span>
</span><a name="line-677"></a><a name="mkMcUnzipM"><a href="DsListComp.html#mkMcUnzipM"><span class="hs-identifier">mkMcUnzipM</span></a></a><span> </span><span class="hs-identifier hs-var">ThenForm</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684090277"><a href="#local-6989586621684090277"><span class="hs-identifier">ys</span></a></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-678"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684090277"><span class="hs-identifier hs-var">ys</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- No unzipping to do</span><span>
</span><a name="line-679"></a><span>
</span><a name="line-680"></a><span class="hs-identifier">mkMcUnzipM</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684090278"><a href="#local-6989586621684090278"><span class="hs-identifier">fmap_op</span></a></a><span> </span><a name="local-6989586621684090279"><a href="#local-6989586621684090279"><span class="hs-identifier">ys</span></a></a><span> </span><a name="local-6989586621684090280"><a href="#local-6989586621684090280"><span class="hs-identifier">elt_tys</span></a></a><span>
</span><a name="line-681"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684090281"><a href="#local-6989586621684090281"><span class="hs-identifier">fmap_op'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsExpr"><span class="hs-identifier hs-var">dsExpr</span></a><span> </span><a href="#local-6989586621684090278"><span class="hs-identifier hs-var">fmap_op</span></a><span>
</span><a name="line-682"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684090282"><a href="#local-6989586621684090282"><span class="hs-identifier">xs</span></a></a><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="DsMonad.html#newSysLocalDs"><span class="hs-identifier hs-var">newSysLocalDs</span></a><span> </span><a href="#local-6989586621684090280"><span class="hs-identifier hs-var">elt_tys</span></a><span>
</span><a name="line-683"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684090283"><a href="#local-6989586621684090283"><span class="hs-identifier">tup_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkBigCoreTupTy</span><span> </span><a href="#local-6989586621684090280"><span class="hs-identifier hs-var">elt_tys</span></a><span>
</span><a name="line-684"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684090284"><a href="#local-6989586621684090284"><span class="hs-identifier">tup_xs</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#newSysLocalDs"><span class="hs-identifier hs-var">newSysLocalDs</span></a><span> </span><a href="#local-6989586621684090283"><span class="hs-identifier hs-var">tup_ty</span></a><span>
</span><a name="line-685"></a><span>
</span><a name="line-686"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684090285"><a href="#local-6989586621684090285"><span class="hs-identifier">mk_elt</span></a></a><span> </span><a name="local-6989586621684090287"><a href="#local-6989586621684090287"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkApps</span><span> </span><a href="#local-6989586621684090281"><span class="hs-identifier hs-var">fmap_op'</span></a><span>  </span><span class="hs-comment">-- fmap :: forall a b. (a -&gt; b) -&gt; n a -&gt; n b</span><span>
</span><a name="line-687"></a><span>                           </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">Type</span><span> </span><a href="#local-6989586621684090283"><span class="hs-identifier hs-var">tup_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Type</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getNth</span><span> </span><a href="#local-6989586621684090280"><span class="hs-identifier hs-var">elt_tys</span></a><span> </span><a href="#local-6989586621684090287"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span>
</span><a name="line-688"></a><span>                           </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684090286"><span class="hs-identifier hs-var">mk_sel</span></a><span> </span><a href="#local-6989586621684090287"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684090279"><span class="hs-identifier hs-var">ys</span></a><span class="hs-special">]</span><span>
</span><a name="line-689"></a><span>
</span><a name="line-690"></a><span>             </span><a name="local-6989586621684090286"><a href="#local-6989586621684090286"><span class="hs-identifier">mk_sel</span></a></a><span> </span><a name="local-6989586621684090288"><a href="#local-6989586621684090288"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Lam</span><span> </span><a href="#local-6989586621684090284"><span class="hs-identifier hs-var">tup_xs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-691"></a><span>                        </span><span class="hs-identifier hs-var">mkTupleSelector</span><span> </span><a href="#local-6989586621684090282"><span class="hs-identifier hs-var">xs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getNth</span><span> </span><a href="#local-6989586621684090282"><span class="hs-identifier hs-var">xs</span></a><span> </span><a href="#local-6989586621684090288"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684090284"><span class="hs-identifier hs-var">tup_xs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684090284"><span class="hs-identifier hs-var">tup_xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-692"></a><span>
</span><a name="line-693"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkBigCoreTup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621684090285"><span class="hs-identifier hs-var">mk_elt</span></a><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621684090280"><span class="hs-identifier hs-var">elt_tys</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-694"></a></pre></body></html>