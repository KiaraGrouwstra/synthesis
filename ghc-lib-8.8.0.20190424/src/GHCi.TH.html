<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables, StandaloneDeriving, DeriveGeneric,
    TupleSections, RecordWildCards, InstanceSigs, CPP #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-name-shadowing #-}</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- Running TH splices</span><span>
</span><a name="line-7"></a><span class="hs-comment">--</span><span>
</span><a name="line-8"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHCi.TH</span><span>
</span><a name="line-9"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="GHCi.TH.html#startTH"><span class="hs-identifier hs-var">startTH</span></a><span>
</span><a name="line-10"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.TH.html#runModFinalizerRefs"><span class="hs-identifier hs-var">runModFinalizerRefs</span></a><span>
</span><a name="line-11"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.TH.html#runTH"><span class="hs-identifier hs-var">runTH</span></a><span>
</span><a name="line-12"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="GHCi.TH.html#GHCiQException"><span class="hs-identifier hs-type">GHCiQException</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-13"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-comment">{- Note [Remote Template Haskell]

Here is an overview of how TH works with -fexternal-interpreter.

Initialisation
~~~~~~~~~~~~~~

GHC sends a StartTH message to the server (see TcSplice.getTHState):

   StartTH :: Message (RemoteRef (IORef QState))

The server creates an initial QState object, makes an IORef to it, and
returns a RemoteRef to this to GHC. (see GHCi.TH.startTH below).

This happens once per module, the first time we need to run a TH
splice.  The reference that GHC gets back is kept in
tcg_th_remote_state in the TcGblEnv, and passed to each RunTH call
that follows.


For each splice
~~~~~~~~~~~~~~~

1. GHC compiles a splice to byte code, and sends it to the server: in
   a CreateBCOs message:

   CreateBCOs :: [LB.ByteString] -&gt; Message [HValueRef]

2. The server creates the real byte-code objects in its heap, and
   returns HValueRefs to GHC.  HValueRef is the same as RemoteRef
   HValue.

3. GHC sends a RunTH message to the server:

  RunTH
   :: RemoteRef (IORef QState)
        -- The state returned by StartTH in step1
   -&gt; HValueRef
        -- The HValueRef we got in step 4, points to the code for the splice
   -&gt; THResultType
        -- Tells us what kind of splice this is (decl, expr, type, etc.)
   -&gt; Maybe TH.Loc
        -- Source location
   -&gt; Message (QResult ByteString)
        -- Eventually it will return a QResult back to GHC.  The
        -- ByteString here is the (encoded) result of the splice.

4. The server runs the splice code.

5. Each time the splice code calls a method of the Quasi class, such
   as qReify, a message is sent from the server to GHC.  These
   messages are defined by the THMessage type.  GHC responds with the
   result of the request, e.g. in the case of qReify it would be the
   TH.Info for the requested entity.

6. When the splice has been fully evaluated, the server sends
   RunTHDone back to GHC.  This tells GHC that the server has finished
   sending THMessages and will send the QResult next.

8. The server then sends a QResult back to GHC, which is notionally
   the response to the original RunTH message.  The QResult indicates
   whether the splice succeeded, failed, or threw an exception.


After typechecking
~~~~~~~~~~~~~~~~~~

GHC sends a FinishTH message to the server (see TcSplice.finishTH).
The server runs any finalizers that were added by addModuleFinalizer.


Other Notes on TH / Remote GHCi

  * Note [Remote GHCi] in compiler/ghci/GHCi.hs
  * Note [External GHCi pointers] in compiler/ghci/GHCi.hs
  * Note [TH recover with -fexternal-interpreter] in
    compiler/typecheck/TcSplice.hs
-}</span><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Prelude</span><span> </span><span class="hs-comment">-- See note [Why do we import Prelude here?]</span><span>
</span><a name="line-95"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHCi.Message</span><span>
</span><a name="line-96"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHCi.RemoteTypes</span><span>
</span><a name="line-97"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.Serialized</span><span>
</span><a name="line-98"></a><span>
</span><a name="line-99"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Exception</span><span>
</span><a name="line-100"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Control.Monad.Fail</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Fail</span><span>
</span><a name="line-101"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.IO.Class</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-102"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Binary</span><span>
</span><a name="line-103"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Binary.Put</span><span>
</span><a name="line-104"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.ByteString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">)</span><span>
</span><a name="line-105"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">B</span><span>
</span><a name="line-106"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString.Lazy</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LB</span><span>
</span><a name="line-107"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Data</span><span>
</span><a name="line-108"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Dynamic</span><span>
</span><a name="line-109"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Either</span><span>
</span><a name="line-110"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.IORef</span><span>
</span><a name="line-111"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span class="hs-special">)</span><span>
</span><a name="line-112"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">M</span><span>
</span><a name="line-113"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span>
</span><a name="line-114"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.Desugar</span><span>
</span><a name="line-115"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language.Haskell.TH</span><span>        </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TH</span><span>
</span><a name="line-116"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language.Haskell.TH.Syntax</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TH</span><span>
</span><a name="line-117"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Unsafe.Coerce</span><span>
</span><a name="line-118"></a><span>
</span><a name="line-119"></a><span class="hs-comment">-- | Create a new instance of 'QState'</span><span>
</span><a name="line-120"></a><span class="hs-identifier">initQState</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Pipe</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">QState</span><span>
</span><a name="line-121"></a><a name="initQState"><a href="GHCi.TH.html#initQState"><span class="hs-identifier">initQState</span></a></a><span> </span><a name="local-6989586621679570163"><a href="#local-6989586621679570163"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">QState</span><span> </span><span class="hs-identifier hs-var">M.empty</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621679570163"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-122"></a><span>
</span><a name="line-123"></a><span class="hs-comment">-- | The monad in which we run TH computations on the server</span><span>
</span><a name="line-124"></a><span class="hs-keyword">newtype</span><span> </span><a name="GHCiQ"><a href="GHCi.TH.html#GHCiQ"><span class="hs-identifier">GHCiQ</span></a></a><span> </span><a name="local-6989586621679569780"><a href="#local-6989586621679569780"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="GHCiQ"><a href="GHCi.TH.html#GHCiQ"><span class="hs-identifier">GHCiQ</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="runGHCiQ"><a href="GHCi.TH.html#runGHCiQ"><span class="hs-identifier">runGHCiQ</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">QState</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679569780"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">QState</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-125"></a><span>
</span><a name="line-126"></a><span class="hs-comment">-- | The exception thrown by &quot;fail&quot; in the GHCiQ monad</span><span>
</span><a name="line-127"></a><span class="hs-keyword">data</span><span> </span><a name="GHCiQException"><a href="GHCi.TH.html#GHCiQException"><span class="hs-identifier">GHCiQException</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="GHCiQException"><a href="GHCi.TH.html#GHCiQException"><span class="hs-identifier">GHCiQException</span></a></a><span> </span><span class="hs-identifier hs-type">QState</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-128"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier hs-type">Show</span><span>
</span><a name="line-129"></a><span>
</span><a name="line-130"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Exception</span><span> </span><a href="GHCi.TH.html#GHCiQException"><span class="hs-identifier hs-type">GHCiQException</span></a><span>
</span><a name="line-131"></a><span>
</span><a name="line-132"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="GHCi.TH.html#GHCiQ"><span class="hs-identifier hs-type">GHCiQ</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-133"></a><span>  </span><a name="local-3458764513820541101"><span class="hs-identifier">fmap</span></a><span> </span><a name="local-6989586621679570157"><a href="#local-6989586621679570157"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="GHCi.TH.html#GHCiQ"><span class="hs-identifier hs-var">GHCiQ</span></a><span> </span><a name="local-6989586621679570158"><a href="#local-6989586621679570158"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.TH.html#GHCiQ"><span class="hs-identifier hs-var">GHCiQ</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679570159"><a href="#local-6989586621679570159"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><a name="local-6989586621679570160"><a href="#local-6989586621679570160"><span class="hs-identifier">s'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679570157"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679570159"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><a href="#local-6989586621679570160"><span class="hs-identifier hs-var">s'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679570158"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span> </span><a href="GHCi.TH.html#GHCiQ"><span class="hs-identifier hs-type">GHCiQ</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-136"></a><span>  </span><a name="local-6989586621679570148"><a href="#local-6989586621679570148"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-3458764513820541679"><span class="hs-operator">&lt;*&gt;</span></a><span> </span><a name="local-6989586621679570149"><a href="#local-6989586621679570149"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.TH.html#GHCiQ"><span class="hs-identifier hs-var">GHCiQ</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679570150"><a href="#local-6989586621679570150"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-137"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679570151"><a href="#local-6989586621679570151"><span class="hs-identifier">f'</span></a></a><span class="hs-special">,</span><a name="local-6989586621679570152"><a href="#local-6989586621679570152"><span class="hs-identifier">s'</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">runGHCiQ</span><span> </span><a href="#local-6989586621679570148"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679570150"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-138"></a><span>       </span><span class="hs-special">(</span><a name="local-6989586621679570153"><a href="#local-6989586621679570153"><span class="hs-identifier">a'</span></a></a><span class="hs-special">,</span><a name="local-6989586621679570154"><a href="#local-6989586621679570154"><span class="hs-identifier">s''</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">runGHCiQ</span><span> </span><a href="#local-6989586621679570149"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679570152"><span class="hs-identifier hs-var">s'</span></a><span>
</span><a name="line-139"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679570151"><span class="hs-identifier hs-var">f'</span></a><span> </span><a href="#local-6989586621679570153"><span class="hs-identifier hs-var">a'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679570154"><span class="hs-identifier hs-var">s''</span></a><span class="hs-special">)</span><span>
</span><a name="line-140"></a><span>  </span><a name="local-3458764513820541680"><span class="hs-identifier">pure</span></a><span> </span><a name="local-6989586621679570155"><a href="#local-6989586621679570155"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.TH.html#GHCiQ"><span class="hs-identifier hs-var">GHCiQ</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679570156"><a href="#local-6989586621679570156"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679570155"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><a href="#local-6989586621679570156"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="GHCi.TH.html#GHCiQ"><span class="hs-identifier hs-type">GHCiQ</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-143"></a><span>  </span><a name="local-6989586621679570141"><a href="#local-6989586621679570141"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-3458764513820541099"><span class="hs-operator">&gt;&gt;=</span></a><span> </span><a name="local-6989586621679570142"><a href="#local-6989586621679570142"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.TH.html#GHCiQ"><span class="hs-identifier hs-var">GHCiQ</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679570143"><a href="#local-6989586621679570143"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-144"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679570144"><a href="#local-6989586621679570144"><span class="hs-identifier">m'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679570145"><a href="#local-6989586621679570145"><span class="hs-identifier">s'</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">runGHCiQ</span><span> </span><a href="#local-6989586621679570141"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621679570143"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-145"></a><span>       </span><span class="hs-special">(</span><a name="local-6989586621679570146"><a href="#local-6989586621679570146"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><span>  </span><a name="local-6989586621679570147"><a href="#local-6989586621679570147"><span class="hs-identifier">s''</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">runGHCiQ</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679570142"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679570144"><span class="hs-identifier hs-var">m'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679570145"><span class="hs-identifier hs-var">s'</span></a><span>
</span><a name="line-146"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679570146"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679570147"><span class="hs-identifier hs-var">s''</span></a><span class="hs-special">)</span><span>
</span><a name="line-147"></a><span class="hs-cpp">#if !MIN_VERSION_base(4,13,0)
</span><span>  </span><a name="local-3458764513820541098"><span class="hs-identifier">fail</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Fail.fail</span><span>
</span><a name="line-149"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-151"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Fail.MonadFail</span><span> </span><a href="GHCi.TH.html#GHCiQ"><span class="hs-identifier hs-type">GHCiQ</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-152"></a><span>  </span><a name="local-3458764513820541104"><span class="hs-identifier">fail</span></a><span> </span><a name="local-6989586621679570139"><a href="#local-6989586621679570139"><span class="hs-identifier">err</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.TH.html#GHCiQ"><span class="hs-identifier hs-var">GHCiQ</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679570140"><a href="#local-6989586621679570140"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span> </span><span class="hs-special">(</span><a href="GHCi.TH.html#GHCiQException"><span class="hs-identifier hs-var">GHCiQException</span></a><span> </span><a href="#local-6989586621679570140"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621679570139"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-153"></a><span>
</span><a name="line-154"></a><span class="hs-identifier">getState</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="GHCi.TH.html#GHCiQ"><span class="hs-identifier hs-type">GHCiQ</span></a><span> </span><span class="hs-identifier hs-type">QState</span><span>
</span><a name="line-155"></a><a name="getState"><a href="GHCi.TH.html#getState"><span class="hs-identifier">getState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.TH.html#GHCiQ"><span class="hs-identifier hs-var">GHCiQ</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679570164"><a href="#local-6989586621679570164"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679570164"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">,</span><a href="#local-6989586621679570164"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-156"></a><span>
</span><a name="line-157"></a><span class="hs-identifier">noLoc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.Loc</span><span>
</span><a name="line-158"></a><a name="noLoc"><a href="GHCi.TH.html#noLoc"><span class="hs-identifier">noLoc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TH.Loc</span><span> </span><span class="hs-string">&quot;&lt;no file&gt;&quot;</span><span> </span><span class="hs-string">&quot;&lt;no package&gt;&quot;</span><span> </span><span class="hs-string">&quot;&lt;no module&gt;&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-159"></a><span>
</span><a name="line-160"></a><span class="hs-comment">-- | Send a 'THMessage' to GHC and return the result.</span><span>
</span><a name="line-161"></a><span class="hs-identifier">ghcCmd</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Binary</span><span> </span><a href="#local-6989586621679570162"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">THMessage</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">THResult</span><span> </span><a href="#local-6989586621679570162"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.TH.html#GHCiQ"><span class="hs-identifier hs-type">GHCiQ</span></a><span> </span><a href="#local-6989586621679570162"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-162"></a><a name="ghcCmd"><a href="GHCi.TH.html#ghcCmd"><span class="hs-identifier">ghcCmd</span></a></a><span> </span><a name="local-6989586621679570165"><a href="#local-6989586621679570165"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.TH.html#GHCiQ"><span class="hs-identifier hs-var">GHCiQ</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679570166"><a href="#local-6989586621679570166"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-163"></a><span>  </span><a name="local-6989586621679570167"><a href="#local-6989586621679570167"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">remoteTHCall</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">qsPipe</span><span> </span><a href="#local-6989586621679570166"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679570165"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-164"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679570167"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-165"></a><span>    </span><span class="hs-identifier hs-var">THException</span><span> </span><a name="local-6989586621679570168"><a href="#local-6989586621679570168"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span> </span><span class="hs-special">(</span><a href="GHCi.TH.html#GHCiQException"><span class="hs-identifier hs-var">GHCiQException</span></a><span> </span><a href="#local-6989586621679570166"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621679570168"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">)</span><span>
</span><a name="line-166"></a><span>    </span><span class="hs-identifier hs-var">THComplete</span><span> </span><a name="local-6989586621679570169"><a href="#local-6989586621679570169"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679570169"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679570166"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-167"></a><span>
</span><a name="line-168"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="GHCi.TH.html#GHCiQ"><span class="hs-identifier hs-type">GHCiQ</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-169"></a><span>  </span><a name="local-8214565720323787328"><span class="hs-identifier">liftIO</span></a><span> </span><a name="local-6989586621679570137"><a href="#local-6989586621679570137"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.TH.html#GHCiQ"><span class="hs-identifier hs-var">GHCiQ</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679570138"><a href="#local-6989586621679570138"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><a href="#local-6989586621679570138"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679570137"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-170"></a><span>
</span><a name="line-171"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">TH.Quasi</span><span> </span><a href="GHCi.TH.html#GHCiQ"><span class="hs-identifier hs-type">GHCiQ</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-172"></a><span>  </span><a name="local-8214565720323807939"><span class="hs-identifier">qNewName</span></a><span> </span><a name="local-6989586621679569782"><a href="#local-6989586621679569782"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.TH.html#ghcCmd"><span class="hs-identifier hs-var">ghcCmd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NewName</span><span> </span><a href="#local-6989586621679569782"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">)</span><span>
</span><a name="line-173"></a><span>  </span><a name="local-8214565720323807938"><span class="hs-identifier">qReport</span></a><span> </span><a name="local-6989586621679569783"><a href="#local-6989586621679569783"><span class="hs-identifier">isError</span></a></a><span> </span><a name="local-6989586621679569784"><a href="#local-6989586621679569784"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.TH.html#ghcCmd"><span class="hs-identifier hs-var">ghcCmd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Report</span><span> </span><a href="#local-6989586621679569783"><span class="hs-identifier hs-var">isError</span></a><span> </span><a href="#local-6989586621679569784"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-174"></a><span>
</span><a name="line-175"></a><span>  </span><span class="hs-comment">-- See Note [TH recover with -fexternal-interpreter] in TcSplice</span><span>
</span><a name="line-176"></a><span>  </span><a name="local-8214565720323807937"><span class="hs-identifier">qRecover</span></a><span> </span><span class="hs-special">(</span><a href="GHCi.TH.html#GHCiQ"><span class="hs-identifier hs-var">GHCiQ</span></a><span> </span><a name="local-6989586621679569785"><a href="#local-6989586621679569785"><span class="hs-identifier">h</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679569786"><a href="#local-6989586621679569786"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.TH.html#GHCiQ"><span class="hs-identifier hs-var">GHCiQ</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679569787"><a href="#local-6989586621679569787"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">mask</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679569788"><a href="#local-6989586621679569788"><span class="hs-identifier">unmask</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-177"></a><span>    </span><span class="hs-identifier hs-var">remoteTHCall</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">qsPipe</span><span> </span><a href="#local-6989586621679569787"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">StartRecover</span><span>
</span><a name="line-178"></a><span>    </span><a name="local-6989586621679570109"><a href="#local-6989586621679570109"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">try</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679569788"><span class="hs-identifier hs-var">unmask</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">runGHCiQ</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679569786"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">&lt;*</span><span> </span><a href="GHCi.TH.html#ghcCmd"><span class="hs-identifier hs-var">ghcCmd</span></a><span> </span><span class="hs-identifier hs-var">FailIfErrs</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679569787"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-179"></a><span>    </span><span class="hs-identifier hs-var">remoteTHCall</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">qsPipe</span><span> </span><a href="#local-6989586621679569787"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EndRecover</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isLeft</span><span> </span><a href="#local-6989586621679570109"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-180"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679570109"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-181"></a><span>      </span><span class="hs-identifier hs-var">Left</span><span> </span><a href="GHCi.TH.html#GHCiQException"><span class="hs-identifier hs-var">GHCiQException</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679569785"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621679569787"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-182"></a><span>      </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679570110"><a href="#local-6989586621679570110"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679570110"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-183"></a><span>  </span><a name="local-8214565720323807936"><span class="hs-identifier">qLookupName</span></a><span> </span><a name="local-6989586621679570111"><a href="#local-6989586621679570111"><span class="hs-identifier">isType</span></a></a><span> </span><a name="local-6989586621679570112"><a href="#local-6989586621679570112"><span class="hs-identifier">occ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.TH.html#ghcCmd"><span class="hs-identifier hs-var">ghcCmd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LookupName</span><span> </span><a href="#local-6989586621679570111"><span class="hs-identifier hs-var">isType</span></a><span> </span><a href="#local-6989586621679570112"><span class="hs-identifier hs-var">occ</span></a><span class="hs-special">)</span><span>
</span><a name="line-184"></a><span>  </span><a name="local-8214565720323807935"><span class="hs-identifier">qReify</span></a><span> </span><a name="local-6989586621679570113"><a href="#local-6989586621679570113"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.TH.html#ghcCmd"><span class="hs-identifier hs-var">ghcCmd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reify</span><span> </span><a href="#local-6989586621679570113"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-185"></a><span>  </span><a name="local-8214565720323807934"><span class="hs-identifier">qReifyFixity</span></a><span> </span><a name="local-6989586621679570114"><a href="#local-6989586621679570114"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.TH.html#ghcCmd"><span class="hs-identifier hs-var">ghcCmd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ReifyFixity</span><span> </span><a href="#local-6989586621679570114"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-186"></a><span>  </span><a name="local-8214565720323807933"><span class="hs-identifier">qReifyInstances</span></a><span> </span><a name="local-6989586621679570115"><a href="#local-6989586621679570115"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679570116"><a href="#local-6989586621679570116"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.TH.html#ghcCmd"><span class="hs-identifier hs-var">ghcCmd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ReifyInstances</span><span> </span><a href="#local-6989586621679570115"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679570116"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-187"></a><span>  </span><a name="local-8214565720323807932"><span class="hs-identifier">qReifyRoles</span></a><span> </span><a name="local-6989586621679570117"><a href="#local-6989586621679570117"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.TH.html#ghcCmd"><span class="hs-identifier hs-var">ghcCmd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ReifyRoles</span><span> </span><a href="#local-6989586621679570117"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-188"></a><span>
</span><a name="line-189"></a><span>  </span><span class="hs-comment">-- To reify annotations, we send GHC the AnnLookup and also the</span><span>
</span><a name="line-190"></a><span>  </span><span class="hs-comment">-- TypeRep of the thing we're looking for, to avoid needing to</span><span>
</span><a name="line-191"></a><span>  </span><span class="hs-comment">-- serialize irrelevant annotations.</span><span>
</span><a name="line-192"></a><span>  </span><span class="hs-identifier">qReifyAnnotations</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679569781"><a href="#local-6989586621679569781"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">Data</span><span> </span><a href="#local-6989586621679569781"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">TH.AnnLookup</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.TH.html#GHCiQ"><span class="hs-identifier hs-type">GHCiQ</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679569781"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-193"></a><span>  </span><a name="local-8214565720323807931"><span class="hs-identifier">qReifyAnnotations</span></a><span> </span><a name="local-6989586621679570118"><a href="#local-6989586621679570118"><span class="hs-identifier">lookup</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-194"></a><span>    </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">deserializeWithData</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">B.unpack</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span>
</span><a name="line-195"></a><span>      </span><a href="GHCi.TH.html#ghcCmd"><span class="hs-identifier hs-var">ghcCmd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ReifyAnnotations</span><span> </span><a href="#local-6989586621679570118"><span class="hs-identifier hs-var">lookup</span></a><span> </span><a href="#local-6989586621679570119"><span class="hs-identifier hs-var">typerep</span></a><span class="hs-special">)</span><span>
</span><a name="line-196"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679570119"><a href="#local-6989586621679570119"><span class="hs-identifier">typerep</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">typeOf</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">undefined</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679569781"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-197"></a><span>
</span><a name="line-198"></a><span>  </span><a name="local-8214565720323807930"><span class="hs-identifier">qReifyModule</span></a><span> </span><a name="local-6989586621679570120"><a href="#local-6989586621679570120"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.TH.html#ghcCmd"><span class="hs-identifier hs-var">ghcCmd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ReifyModule</span><span> </span><a href="#local-6989586621679570120"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-199"></a><span>  </span><a name="local-8214565720323807929"><span class="hs-identifier">qReifyConStrictness</span></a><span> </span><a name="local-6989586621679570121"><a href="#local-6989586621679570121"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.TH.html#ghcCmd"><span class="hs-identifier hs-var">ghcCmd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ReifyConStrictness</span><span> </span><a href="#local-6989586621679570121"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-200"></a><span>  </span><a name="local-8214565720323807928"><span class="hs-identifier">qLocation</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><a href="GHCi.TH.html#noLoc"><span class="hs-identifier hs-var">noLoc</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">qsLocation</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="GHCi.TH.html#getState"><span class="hs-identifier hs-var">getState</span></a><span>
</span><a name="line-201"></a><span>  </span><a name="local-8214565720323807926"><span class="hs-identifier">qAddDependentFile</span></a><span> </span><a name="local-6989586621679570122"><a href="#local-6989586621679570122"><span class="hs-identifier">file</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.TH.html#ghcCmd"><span class="hs-identifier hs-var">ghcCmd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AddDependentFile</span><span> </span><a href="#local-6989586621679570122"><span class="hs-identifier hs-var">file</span></a><span class="hs-special">)</span><span>
</span><a name="line-202"></a><span>  </span><a name="local-8214565720323807925"><span class="hs-identifier">qAddTempFile</span></a><span> </span><a name="local-6989586621679570123"><a href="#local-6989586621679570123"><span class="hs-identifier">suffix</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.TH.html#ghcCmd"><span class="hs-identifier hs-var">ghcCmd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AddTempFile</span><span> </span><a href="#local-6989586621679570123"><span class="hs-identifier hs-var">suffix</span></a><span class="hs-special">)</span><span>
</span><a name="line-203"></a><span>  </span><a name="local-8214565720323807924"><span class="hs-identifier">qAddTopDecls</span></a><span> </span><a name="local-6989586621679570124"><a href="#local-6989586621679570124"><span class="hs-identifier">decls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.TH.html#ghcCmd"><span class="hs-identifier hs-var">ghcCmd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AddTopDecls</span><span> </span><a href="#local-6989586621679570124"><span class="hs-identifier hs-var">decls</span></a><span class="hs-special">)</span><span>
</span><a name="line-204"></a><span>  </span><a name="local-8214565720323807923"><span class="hs-identifier">qAddForeignFilePath</span></a><span> </span><a name="local-6989586621679570125"><a href="#local-6989586621679570125"><span class="hs-identifier">lang</span></a></a><span> </span><a name="local-6989586621679570126"><a href="#local-6989586621679570126"><span class="hs-identifier">fp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.TH.html#ghcCmd"><span class="hs-identifier hs-var">ghcCmd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AddForeignFilePath</span><span> </span><a href="#local-6989586621679570125"><span class="hs-identifier hs-var">lang</span></a><span> </span><a href="#local-6989586621679570126"><span class="hs-identifier hs-var">fp</span></a><span class="hs-special">)</span><span>
</span><a name="line-205"></a><span>  </span><a name="local-8214565720323807922"><span class="hs-identifier">qAddModFinalizer</span></a><span> </span><a name="local-6989586621679570127"><a href="#local-6989586621679570127"><span class="hs-identifier">fin</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.TH.html#GHCiQ"><span class="hs-identifier hs-var">GHCiQ</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679570128"><a href="#local-6989586621679570128"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">mkRemoteRef</span><span> </span><a href="#local-6989586621679570127"><span class="hs-identifier hs-var">fin</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679570128"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span>
</span><a name="line-206"></a><span>                         </span><a href="GHCi.TH.html#ghcCmd"><span class="hs-identifier hs-var">ghcCmd</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">AddModFinalizer</span><span>
</span><a name="line-207"></a><span>  </span><a name="local-8214565720323807921"><span class="hs-identifier">qAddCorePlugin</span></a><span> </span><a name="local-6989586621679570129"><a href="#local-6989586621679570129"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.TH.html#ghcCmd"><span class="hs-identifier hs-var">ghcCmd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AddCorePlugin</span><span> </span><a href="#local-6989586621679570129"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">)</span><span>
</span><a name="line-208"></a><span>  </span><a name="local-8214565720323807920"><span class="hs-identifier">qGetQ</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.TH.html#GHCiQ"><span class="hs-identifier hs-var">GHCiQ</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679570130"><a href="#local-6989586621679570130"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-209"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">lookup</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679570132"><a href="#local-6989586621679570132"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span> </span><a href="#local-6989586621679570132"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">TypeRep</span><span> </span><span class="hs-identifier hs-type">Dynamic</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679570132"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-210"></a><span>        </span><a name="local-6989586621679570131"><a href="#local-6989586621679570131"><span class="hs-identifier">lookup</span></a></a><span> </span><a name="local-6989586621679570133"><a href="#local-6989586621679570133"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromDynamic</span><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><span class="hs-identifier hs-var">M.lookup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">typeOf</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">undefined</span><span class="hs-glyph">::</span><a href="#local-6989586621679570132"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679570133"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-211"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679570131"><span class="hs-identifier hs-var">lookup</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">qsMap</span><span> </span><a href="#local-6989586621679570130"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679570130"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-212"></a><span>  </span><a name="local-8214565720323807919"><span class="hs-identifier">qPutQ</span></a><span> </span><a name="local-6989586621679570134"><a href="#local-6989586621679570134"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.TH.html#GHCiQ"><span class="hs-identifier hs-var">GHCiQ</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679570135"><a href="#local-6989586621679570135"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-213"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679570135"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">qsMap</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">M.insert</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">typeOf</span><span> </span><a href="#local-6989586621679570134"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toDyn</span><span> </span><a href="#local-6989586621679570134"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">qsMap</span><span> </span><a href="#local-6989586621679570135"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-214"></a><span>  </span><a name="local-8214565720323807918"><span class="hs-identifier">qIsExtEnabled</span></a><span> </span><a name="local-6989586621679570136"><a href="#local-6989586621679570136"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.TH.html#ghcCmd"><span class="hs-identifier hs-var">ghcCmd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IsExtEnabled</span><span> </span><a href="#local-6989586621679570136"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-215"></a><span>  </span><a name="local-8214565720323807917"><span class="hs-identifier">qExtsEnabled</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="GHCi.TH.html#ghcCmd"><span class="hs-identifier hs-var">ghcCmd</span></a><span> </span><span class="hs-identifier hs-var">ExtsEnabled</span><span>
</span><a name="line-216"></a><span>
</span><a name="line-217"></a><span class="hs-comment">-- | The implementation of the 'StartTH' message: create</span><span>
</span><a name="line-218"></a><span class="hs-comment">-- a new IORef QState, and return a RemoteRef to it.</span><span>
</span><a name="line-219"></a><span class="hs-identifier">startTH</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">RemoteRef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IORef</span><span> </span><span class="hs-identifier hs-type">QState</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-220"></a><a name="startTH"><a href="GHCi.TH.html#startTH"><span class="hs-identifier">startTH</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-221"></a><span>  </span><a name="local-6989586621679570170"><a href="#local-6989586621679570170"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-special">(</span><a href="GHCi.TH.html#initQState"><span class="hs-identifier hs-var">initQState</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;startTH: no pipe&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-222"></a><span>  </span><span class="hs-identifier hs-var">mkRemoteRef</span><span> </span><a href="#local-6989586621679570170"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-223"></a><span>
</span><a name="line-224"></a><span class="hs-comment">-- | Runs the mod finalizers.</span><span>
</span><a name="line-225"></a><span class="hs-comment">--</span><span>
</span><a name="line-226"></a><span class="hs-comment">-- The references must be created on the caller process.</span><span>
</span><a name="line-227"></a><span class="hs-identifier">runModFinalizerRefs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Pipe</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RemoteRef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IORef</span><span> </span><span class="hs-identifier hs-type">QState</span><span class="hs-special">)</span><span>
</span><a name="line-228"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">RemoteRef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TH.Q</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-229"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-230"></a><a name="runModFinalizerRefs"><a href="GHCi.TH.html#runModFinalizerRefs"><span class="hs-identifier">runModFinalizerRefs</span></a></a><span> </span><a name="local-6989586621679570171"><a href="#local-6989586621679570171"><span class="hs-identifier">pipe</span></a></a><span> </span><a name="local-6989586621679570172"><a href="#local-6989586621679570172"><span class="hs-identifier">rstate</span></a></a><span> </span><a name="local-6989586621679570173"><a href="#local-6989586621679570173"><span class="hs-identifier">qrefs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-231"></a><span>  </span><a name="local-6989586621679570174"><a href="#local-6989586621679570174"><span class="hs-identifier">qs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-identifier hs-var">localRef</span><span> </span><a href="#local-6989586621679570173"><span class="hs-identifier hs-var">qrefs</span></a><span>
</span><a name="line-232"></a><span>  </span><a name="local-6989586621679570175"><a href="#local-6989586621679570175"><span class="hs-identifier">qstateref</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">localRef</span><span> </span><a href="#local-6989586621679570172"><span class="hs-identifier hs-var">rstate</span></a><span>
</span><a name="line-233"></a><span>  </span><a name="local-6989586621679570176"><a href="#local-6989586621679570176"><span class="hs-identifier">qstate</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="#local-6989586621679570175"><span class="hs-identifier hs-var">qstateref</span></a><span>
</span><a name="line-234"></a><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">runGHCiQ</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.runQ</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">sequence_</span><span> </span><a href="#local-6989586621679570174"><span class="hs-identifier hs-var">qs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679570176"><span class="hs-identifier hs-var">qstate</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">qsPipe</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679570171"><span class="hs-identifier hs-var">pipe</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-235"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-236"></a><span>
</span><a name="line-237"></a><span class="hs-comment">-- | The implementation of the 'RunTH' message</span><span>
</span><a name="line-238"></a><span class="hs-identifier">runTH</span><span>
</span><a name="line-239"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Pipe</span><span>
</span><a name="line-240"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RemoteRef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IORef</span><span> </span><span class="hs-identifier hs-type">QState</span><span class="hs-special">)</span><span>
</span><a name="line-241"></a><span>      </span><span class="hs-comment">-- ^ The TH state, created by 'startTH'</span><span>
</span><a name="line-242"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HValueRef</span><span>
</span><a name="line-243"></a><span>      </span><span class="hs-comment">-- ^ The splice to run</span><span>
</span><a name="line-244"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">THResultType</span><span>
</span><a name="line-245"></a><span>      </span><span class="hs-comment">-- ^ What kind of splice it is</span><span>
</span><a name="line-246"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TH.Loc</span><span>
</span><a name="line-247"></a><span>      </span><span class="hs-comment">-- ^ The source location</span><span>
</span><a name="line-248"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span>
</span><a name="line-249"></a><span>      </span><span class="hs-comment">-- ^ Returns an (encoded) result that depends on the THResultType</span><span>
</span><a name="line-250"></a><span>
</span><a name="line-251"></a><a name="runTH"><a href="GHCi.TH.html#runTH"><span class="hs-identifier">runTH</span></a></a><span> </span><a name="local-6989586621679570177"><a href="#local-6989586621679570177"><span class="hs-identifier">pipe</span></a></a><span> </span><a name="local-6989586621679570178"><a href="#local-6989586621679570178"><span class="hs-identifier">rstate</span></a></a><span> </span><a name="local-6989586621679570179"><a href="#local-6989586621679570179"><span class="hs-identifier">rhv</span></a></a><span> </span><a name="local-6989586621679570180"><a href="#local-6989586621679570180"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621679570181"><a href="#local-6989586621679570181"><span class="hs-identifier">mb_loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-252"></a><span>  </span><a name="local-6989586621679570182"><a href="#local-6989586621679570182"><span class="hs-identifier">hv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">localRef</span><span> </span><a href="#local-6989586621679570179"><span class="hs-identifier hs-var">rhv</span></a><span>
</span><a name="line-253"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679570180"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-254"></a><span>    </span><span class="hs-identifier hs-var">THExp</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.TH.html#runTHQ"><span class="hs-identifier hs-var">runTHQ</span></a><span> </span><a href="#local-6989586621679570177"><span class="hs-identifier hs-var">pipe</span></a><span> </span><a href="#local-6989586621679570178"><span class="hs-identifier hs-var">rstate</span></a><span> </span><a href="#local-6989586621679570181"><span class="hs-identifier hs-var">mb_loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unsafeCoerce</span><span> </span><a href="#local-6989586621679570182"><span class="hs-identifier hs-var">hv</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.Q</span><span> </span><span class="hs-identifier hs-type">TH.Exp</span><span class="hs-special">)</span><span>
</span><a name="line-255"></a><span>    </span><span class="hs-identifier hs-var">THPat</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.TH.html#runTHQ"><span class="hs-identifier hs-var">runTHQ</span></a><span> </span><a href="#local-6989586621679570177"><span class="hs-identifier hs-var">pipe</span></a><span> </span><a href="#local-6989586621679570178"><span class="hs-identifier hs-var">rstate</span></a><span> </span><a href="#local-6989586621679570181"><span class="hs-identifier hs-var">mb_loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unsafeCoerce</span><span> </span><a href="#local-6989586621679570182"><span class="hs-identifier hs-var">hv</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.Q</span><span> </span><span class="hs-identifier hs-type">TH.Pat</span><span class="hs-special">)</span><span>
</span><a name="line-256"></a><span>    </span><span class="hs-identifier hs-var">THType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.TH.html#runTHQ"><span class="hs-identifier hs-var">runTHQ</span></a><span> </span><a href="#local-6989586621679570177"><span class="hs-identifier hs-var">pipe</span></a><span> </span><a href="#local-6989586621679570178"><span class="hs-identifier hs-var">rstate</span></a><span> </span><a href="#local-6989586621679570181"><span class="hs-identifier hs-var">mb_loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unsafeCoerce</span><span> </span><a href="#local-6989586621679570182"><span class="hs-identifier hs-var">hv</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.Q</span><span> </span><span class="hs-identifier hs-type">TH.Type</span><span class="hs-special">)</span><span>
</span><a name="line-257"></a><span>    </span><span class="hs-identifier hs-var">THDec</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="GHCi.TH.html#runTHQ"><span class="hs-identifier hs-var">runTHQ</span></a><span> </span><a href="#local-6989586621679570177"><span class="hs-identifier hs-var">pipe</span></a><span> </span><a href="#local-6989586621679570178"><span class="hs-identifier hs-var">rstate</span></a><span> </span><a href="#local-6989586621679570181"><span class="hs-identifier hs-var">mb_loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unsafeCoerce</span><span> </span><a href="#local-6989586621679570182"><span class="hs-identifier hs-var">hv</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TH.Q</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TH.Dec</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-258"></a><span>    </span><span class="hs-identifier hs-var">THAnnWrapper</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-259"></a><span>      </span><a name="local-6989586621679570183"><a href="#local-6989586621679570183"><span class="hs-identifier">hv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">unsafeCoerce</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">localRef</span><span> </span><a href="#local-6989586621679570179"><span class="hs-identifier hs-var">rhv</span></a><span>
</span><a name="line-260"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679570183"><span class="hs-identifier hs-var">hv</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">AnnotationWrapper</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-261"></a><span>        </span><span class="hs-identifier hs-var">AnnotationWrapper</span><span> </span><a name="local-6989586621679570184"><a href="#local-6989586621679570184"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$!</span><span>
</span><a name="line-262"></a><span>          </span><span class="hs-identifier hs-var">LB.toStrict</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">runPut</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">put</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toSerialized</span><span> </span><span class="hs-identifier hs-var">serializeWithData</span><span> </span><a href="#local-6989586621679570184"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-263"></a><span>
</span><a name="line-264"></a><span class="hs-comment">-- | Run a Q computation.</span><span>
</span><a name="line-265"></a><span class="hs-identifier">runTHQ</span><span>
</span><a name="line-266"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Binary</span><span> </span><a href="#local-6989586621679570161"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Pipe</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RemoteRef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IORef</span><span> </span><span class="hs-identifier hs-type">QState</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TH.Loc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TH.Q</span><span> </span><a href="#local-6989586621679570161"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-267"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span>
</span><a name="line-268"></a><a name="runTHQ"><a href="GHCi.TH.html#runTHQ"><span class="hs-identifier">runTHQ</span></a></a><span> </span><a name="local-6989586621679570185"><a href="#local-6989586621679570185"><span class="hs-identifier">pipe</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">Pipe</span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><a name="local-6989586621679570193"><a href="#local-6989586621679570193"><span class="hs-identifier">rstate</span></a></a><span> </span><a name="local-6989586621679570194"><a href="#local-6989586621679570194"><span class="hs-identifier">mb_loc</span></a></a><span> </span><a name="local-6989586621679570195"><a href="#local-6989586621679570195"><span class="hs-identifier">ghciq</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-269"></a><span>  </span><a name="local-6989586621679570196"><a href="#local-6989586621679570196"><span class="hs-identifier">qstateref</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">localRef</span><span> </span><a href="#local-6989586621679570193"><span class="hs-identifier hs-var">rstate</span></a><span>
</span><a name="line-270"></a><span>  </span><a name="local-6989586621679570197"><a href="#local-6989586621679570197"><span class="hs-identifier">qstate</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="#local-6989586621679570196"><span class="hs-identifier hs-var">qstateref</span></a><span>
</span><a name="line-271"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679570198"><a href="#local-6989586621679570198"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679570197"><span class="hs-identifier hs-var">qstate</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">qsLocation</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679570194"><span class="hs-identifier hs-var">mb_loc</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">qsPipe</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679570185"><span class="hs-identifier hs-var">pipe</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-272"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679570199"><a href="#local-6989586621679570199"><span class="hs-identifier">r</span></a></a><span class="hs-special">,</span><a name="local-6989586621679570200"><a href="#local-6989586621679570200"><span class="hs-identifier">new_state</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">runGHCiQ</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TH.runQ</span><span> </span><a href="#local-6989586621679570195"><span class="hs-identifier hs-var">ghciq</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679570198"><span class="hs-identifier hs-var">st</span></a><span>
</span><a name="line-273"></a><span>  </span><span class="hs-identifier hs-var">writeIORef</span><span> </span><a href="#local-6989586621679570196"><span class="hs-identifier hs-var">qstateref</span></a><span> </span><a href="#local-6989586621679570200"><span class="hs-identifier hs-var">new_state</span></a><span>
</span><a name="line-274"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><span class="hs-identifier hs-var">LB.toStrict</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">runPut</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">put</span><span> </span><a href="#local-6989586621679570199"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-275"></a></pre></body></html>