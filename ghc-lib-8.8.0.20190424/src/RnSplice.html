<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE ViewPatterns #-}</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">RnSplice</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-6"></a><span>        </span><a href="RnSplice.html#rnTopSpliceDecls"><span class="hs-identifier hs-var">rnTopSpliceDecls</span></a><span class="hs-special">,</span><span>
</span><a name="line-7"></a><span>        </span><a href="RnSplice.html#rnSpliceType"><span class="hs-identifier hs-var">rnSpliceType</span></a><span class="hs-special">,</span><span> </span><a href="RnSplice.html#rnSpliceExpr"><span class="hs-identifier hs-var">rnSpliceExpr</span></a><span class="hs-special">,</span><span> </span><a href="RnSplice.html#rnSplicePat"><span class="hs-identifier hs-var">rnSplicePat</span></a><span class="hs-special">,</span><span> </span><a href="RnSplice.html#rnSpliceDecl"><span class="hs-identifier hs-var">rnSpliceDecl</span></a><span class="hs-special">,</span><span>
</span><a name="line-8"></a><span>        </span><a href="RnSplice.html#rnBracket"><span class="hs-identifier hs-var">rnBracket</span></a><span class="hs-special">,</span><span>
</span><a name="line-9"></a><span>        </span><a href="RnSplice.html#checkThLocalName"><span class="hs-identifier hs-var">checkThLocalName</span></a><span>
</span><a name="line-10"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="RnSplice.html#traceSplice"><span class="hs-identifier hs-var">traceSplice</span></a><span class="hs-special">,</span><span> </span><a href="RnSplice.html#SpliceInfo"><span class="hs-identifier hs-type">SpliceInfo</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-11"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameSet</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RdrName</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="RnEnv.html"><span class="hs-identifier">RnEnv</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="RnUtils.html"><span class="hs-identifier">RnUtils</span></a><span>          </span><span class="hs-special">(</span><span> </span><a href="RnUtils.html#HsDocContext"><span class="hs-identifier hs-type">HsDocContext</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="RnUtils.html#newLocalBndrRn"><span class="hs-identifier hs-var">newLocalBndrRn</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="RnUnbound.html"><span class="hs-identifier">RnUnbound</span></a><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">isUnboundName</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="RnSource.html"><span class="hs-identifier">RnSource</span></a><span>         </span><span class="hs-special">(</span><span> </span><a href="RnSource.html#rnSrcDecls"><span class="hs-identifier hs-var">rnSrcDecls</span></a><span class="hs-special">,</span><span> </span><a href="RnSource.html#findSplice"><span class="hs-identifier hs-var">findSplice</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="RnPat.html"><span class="hs-identifier">RnPat</span></a><span>            </span><span class="hs-special">(</span><span> </span><a href="RnPat.html#rnPat"><span class="hs-identifier hs-var">rnPat</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isTopLevel</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SourceText</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="RnTypes.html"><span class="hs-identifier">RnTypes</span></a><span>          </span><span class="hs-special">(</span><span> </span><a href="RnTypes.html#rnLHsType"><span class="hs-identifier hs-var">rnLHsType</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">unless</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE</span><span> </span><span class="hs-pragma">#-}</span><span> </span><a href="RnExpr.html"><span class="hs-identifier">RnExpr</span></a><span>   </span><span class="hs-special">(</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="TcEnv.html"><span class="hs-identifier">TcEnv</span></a><span>            </span><span class="hs-special">(</span><span> </span><a href="TcEnv.html#checkWellStaged"><span class="hs-identifier hs-var">checkWellStaged</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="THNames.html"><span class="hs-identifier">THNames</span></a><span>          </span><span class="hs-special">(</span><span> </span><a href="THNames.html#liftName"><span class="hs-identifier hs-var">liftName</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span>         </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">dumpIfSet_dyn_printer</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="TcEnv.html"><span class="hs-identifier">TcEnv</span></a><span>            </span><span class="hs-special">(</span><span> </span><a href="TcEnv.html#tcMetaTy"><span class="hs-identifier hs-var">tcMetaTy</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Hooks</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="THNames.html"><span class="hs-identifier">THNames</span></a><span>          </span><span class="hs-special">(</span><span> </span><a href="THNames.html#quoteExpName"><span class="hs-identifier hs-var">quoteExpName</span></a><span class="hs-special">,</span><span> </span><a href="THNames.html#quotePatName"><span class="hs-identifier hs-var">quotePatName</span></a><span class="hs-special">,</span><span> </span><a href="THNames.html#quoteDecName"><span class="hs-identifier hs-var">quoteDecName</span></a><span class="hs-special">,</span><span> </span><a href="THNames.html#quoteTypeName"><span class="hs-identifier hs-var">quoteTypeName</span></a><span>
</span><a name="line-47"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="THNames.html#decsQTyConName"><span class="hs-identifier hs-var">decsQTyConName</span></a><span class="hs-special">,</span><span> </span><a href="THNames.html#expQTyConName"><span class="hs-identifier hs-var">expQTyConName</span></a><span class="hs-special">,</span><span> </span><a href="THNames.html#patQTyConName"><span class="hs-identifier hs-var">patQTyConName</span></a><span class="hs-special">,</span><span> </span><a href="THNames.html#typeQTyConName"><span class="hs-identifier hs-var">typeQTyConName</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE</span><span> </span><span class="hs-pragma">#-}</span><span> </span><a href="TcExpr.html"><span class="hs-identifier">TcExpr</span></a><span>   </span><span class="hs-special">(</span><span> </span><a href="TcExpr.html#tcPolyExpr"><span class="hs-identifier hs-var">tcPolyExpr</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE</span><span> </span><span class="hs-pragma">#-}</span><span> </span><a href="TcSplice.html"><span class="hs-identifier">TcSplice</span></a><span>
</span><a name="line-51"></a><span>    </span><span class="hs-special">(</span><span> </span><a href="TcSplice.html#runMetaD"><span class="hs-identifier hs-var">runMetaD</span></a><span>
</span><a name="line-52"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="TcSplice.html#runMetaE"><span class="hs-identifier hs-var">runMetaE</span></a><span>
</span><a name="line-53"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="TcSplice.html#runMetaP"><span class="hs-identifier hs-var">runMetaP</span></a><span>
</span><a name="line-54"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="TcSplice.html#runMetaT"><span class="hs-identifier hs-var">runMetaT</span></a><span>
</span><a name="line-55"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="TcSplice.html#tcTopSpliceExpr"><span class="hs-identifier hs-var">tcTopSpliceExpr</span></a><span>
</span><a name="line-56"></a><span>    </span><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><a href="TcHsSyn.html"><span class="hs-identifier">TcHsSyn</span></a><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHCi.RemoteTypes</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">ForeignRef</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Language.Haskell.TH</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TH</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Q</span><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC.LanguageExtensions</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LangExt</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Template Haskell brackets
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-identifier">rnBracket</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsBracket</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-74"></a><a name="rnBracket"><a href="RnSplice.html#rnBracket"><span class="hs-identifier">rnBracket</span></a></a><span> </span><a name="local-6989586621682336780"><a href="#local-6989586621682336780"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621682336781"><a href="#local-6989586621682336781"><span class="hs-identifier">br_body</span></a></a><span>
</span><a name="line-75"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="RnSplice.html#quotationCtxtDoc"><span class="hs-identifier hs-var">quotationCtxtDoc</span></a><span> </span><a href="#local-6989586621682336781"><span class="hs-identifier hs-var">br_body</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-76"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Check that -XTemplateHaskellQuotes is enabled and available</span><span>
</span><a name="line-77"></a><span>         </span><a name="local-6989586621682336782"><a href="#local-6989586621682336782"><span class="hs-identifier">thQuotesEnabled</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.TemplateHaskellQuotes</span><span>
</span><a name="line-78"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><a href="#local-6989586621682336782"><span class="hs-identifier hs-var">thQuotesEnabled</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-79"></a><span>           </span><a href="TcRnMonad.html#failWith"><span class="hs-identifier hs-var">failWith</span></a><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">vcat</span><span>
</span><a name="line-80"></a><span>                      </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Syntax error on&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336780"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-81"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Perhaps you intended to use TemplateHaskell&quot;</span><span>
</span><a name="line-82"></a><span>                              </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; or TemplateHaskellQuotes&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-83"></a><span>
</span><a name="line-84"></a><span>         </span><span class="hs-comment">-- Check for nested brackets</span><span>
</span><a name="line-85"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682336783"><a href="#local-6989586621682336783"><span class="hs-identifier">cur_stage</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getStage"><span class="hs-identifier hs-var">getStage</span></a><span>
</span><a name="line-86"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682336783"><span class="hs-identifier hs-var">cur_stage</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-87"></a><span>           </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">Splice</span><span> </span><span class="hs-identifier hs-var">Typed</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isTypedBracket</span><span> </span><a href="#local-6989586621682336781"><span class="hs-identifier hs-var">br_body</span></a><span class="hs-special">)</span><span>
</span><a name="line-88"></a><span>                                       </span><a href="RnSplice.html#illegalUntypedBracket"><span class="hs-identifier hs-var">illegalUntypedBracket</span></a><span>
</span><a name="line-89"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">Splice</span><span> </span><span class="hs-identifier hs-var">Untyped</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isTypedBracket</span><span> </span><a href="#local-6989586621682336781"><span class="hs-identifier hs-var">br_body</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-90"></a><span>                                       </span><a href="RnSplice.html#illegalTypedBracket"><span class="hs-identifier hs-var">illegalTypedBracket</span></a><span>
</span><a name="line-91"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">RunSplice</span><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-92"></a><span>               </span><span class="hs-comment">-- See Note [RunSplice ThLevel] in &quot;TcRnTypes&quot;.</span><span>
</span><a name="line-93"></a><span>               </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;rnBracket: Renaming bracket when running a splice&quot;</span><span>
</span><a name="line-94"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336780"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-95"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">Comp</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-96"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">Brack</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><a href="RnSplice.html#illegalBracket"><span class="hs-identifier hs-var">illegalBracket</span></a><span>
</span><a name="line-97"></a><span>           </span><span class="hs-special">}</span><span>
</span><a name="line-98"></a><span>
</span><a name="line-99"></a><span>         </span><span class="hs-comment">-- Brackets are desugared to code that mentions the TH package</span><span>
</span><a name="line-100"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#recordThUse"><span class="hs-identifier hs-var">recordThUse</span></a><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">isTypedBracket</span><span> </span><a href="#local-6989586621682336781"><span class="hs-identifier hs-var">br_body</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-103"></a><span>            </span><span class="hs-identifier hs-var">True</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;Renaming typed TH bracket&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-104"></a><span>                        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682336784"><a href="#local-6989586621682336784"><span class="hs-identifier">body'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682336785"><a href="#local-6989586621682336785"><span class="hs-identifier">fvs_e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-105"></a><span>                          </span><a href="TcRnMonad.html#setStage"><span class="hs-identifier hs-var">setStage</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Brack</span><span> </span><a href="#local-6989586621682336783"><span class="hs-identifier hs-var">cur_stage</span></a><span> </span><span class="hs-identifier hs-var">RnPendingTyped</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-106"></a><span>                                   </span><a href="RnSplice.html#rn_bracket"><span class="hs-identifier hs-var">rn_bracket</span></a><span> </span><a href="#local-6989586621682336783"><span class="hs-identifier hs-var">cur_stage</span></a><span> </span><a href="#local-6989586621682336781"><span class="hs-identifier hs-var">br_body</span></a><span>
</span><a name="line-107"></a><span>                        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsBracket</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682336784"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682336785"><span class="hs-identifier hs-var">fvs_e</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-108"></a><span>
</span><a name="line-109"></a><span>            </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;Renaming untyped TH bracket&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-110"></a><span>                        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682336786"><a href="#local-6989586621682336786"><span class="hs-identifier">ps_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newMutVar</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-111"></a><span>                        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682336787"><a href="#local-6989586621682336787"><span class="hs-identifier">body'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682336788"><a href="#local-6989586621682336788"><span class="hs-identifier">fvs_e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-112"></a><span>                          </span><a href="TcRnMonad.html#setStage"><span class="hs-identifier hs-var">setStage</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Brack</span><span> </span><a href="#local-6989586621682336783"><span class="hs-identifier hs-var">cur_stage</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RnPendingUntyped</span><span> </span><a href="#local-6989586621682336786"><span class="hs-identifier hs-var">ps_var</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-113"></a><span>                                   </span><a href="RnSplice.html#rn_bracket"><span class="hs-identifier hs-var">rn_bracket</span></a><span> </span><a href="#local-6989586621682336783"><span class="hs-identifier hs-var">cur_stage</span></a><span> </span><a href="#local-6989586621682336781"><span class="hs-identifier hs-var">br_body</span></a><span>
</span><a name="line-114"></a><span>                        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682336789"><a href="#local-6989586621682336789"><span class="hs-identifier">pendings</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readMutVar</span><span> </span><a href="#local-6989586621682336786"><span class="hs-identifier hs-var">ps_var</span></a><span>
</span><a name="line-115"></a><span>                        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRnBracketOut</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682336787"><span class="hs-identifier hs-var">body'</span></a><span> </span><a href="#local-6989586621682336789"><span class="hs-identifier hs-var">pendings</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682336788"><span class="hs-identifier hs-var">fvs_e</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-116"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-117"></a><span>
</span><a name="line-118"></a><span class="hs-identifier">rn_bracket</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ThStage</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsBracket</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsBracket</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-119"></a><a name="rn_bracket"><a href="RnSplice.html#rn_bracket"><span class="hs-identifier">rn_bracket</span></a></a><span> </span><a name="local-6989586621682336790"><a href="#local-6989586621682336790"><span class="hs-identifier">outer_stage</span></a></a><span> </span><a name="local-6989586621682336791"><a href="#local-6989586621682336791"><span class="hs-identifier">br</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarBr</span><span> </span><a name="local-6989586621682336792"><a href="#local-6989586621682336792"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682336793"><a href="#local-6989586621682336793"><span class="hs-identifier">flg</span></a></a><span> </span><a name="local-6989586621682336794"><a href="#local-6989586621682336794"><span class="hs-identifier">rdr_name</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-120"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682336795"><a href="#local-6989586621682336795"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupOccRn"><span class="hs-identifier hs-var">lookupOccRn</span></a><span> </span><a href="#local-6989586621682336794"><span class="hs-identifier hs-var">rdr_name</span></a><span>
</span><a name="line-121"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682336796"><a href="#local-6989586621682336796"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-122"></a><span>
</span><a name="line-123"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682336793"><span class="hs-identifier hs-var">flg</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">nameIsLocalOrFrom</span><span> </span><a href="#local-6989586621682336796"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621682336795"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-124"></a><span>             </span><span class="hs-comment">-- Type variables can be quoted in TH. See #5721.</span><span>
</span><a name="line-125"></a><span>                 </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682336797"><a href="#local-6989586621682336797"><span class="hs-identifier">mb_bind_lvl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupLocalOccThLvl_maybe"><span class="hs-identifier hs-var">lookupLocalOccThLvl_maybe</span></a><span> </span><a href="#local-6989586621682336795"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-126"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682336797"><span class="hs-identifier hs-var">mb_bind_lvl</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-127"></a><span>                        </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- Can happen for data constructors,</span><span>
</span><a name="line-128"></a><span>                                                    </span><span class="hs-comment">-- but nothing needs to be done for them</span><span>
</span><a name="line-129"></a><span>
</span><a name="line-130"></a><span>                        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682336798"><a href="#local-6989586621682336798"><span class="hs-identifier">top_lvl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682336799"><a href="#local-6989586621682336799"><span class="hs-identifier">bind_lvl</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- See Note [Quoting names]</span><span>
</span><a name="line-131"></a><span>                             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTopLevel</span><span> </span><a href="#local-6989586621682336798"><span class="hs-identifier hs-var">top_lvl</span></a><span>
</span><a name="line-132"></a><span>                             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isExternalName</span><span> </span><a href="#local-6989586621682336795"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#keepAlive"><span class="hs-identifier hs-var">keepAlive</span></a><span> </span><a href="#local-6989586621682336795"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-133"></a><span>                             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-134"></a><span>                             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rn_bracket VarBr&quot;</span><span>
</span><a name="line-135"></a><span>                                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336795"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336799"><span class="hs-identifier hs-var">bind_lvl</span></a><span>
</span><a name="line-136"></a><span>                                                </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336790"><span class="hs-identifier hs-var">outer_stage</span></a><span class="hs-special">)</span><span>
</span><a name="line-137"></a><span>                                   </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">thLevel</span><span> </span><a href="#local-6989586621682336790"><span class="hs-identifier hs-var">outer_stage</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682336799"><span class="hs-identifier hs-var">bind_lvl</span></a><span class="hs-special">)</span><span>
</span><a name="line-138"></a><span>                                             </span><span class="hs-special">(</span><a href="RnSplice.html#quotedNameStageErr"><span class="hs-identifier hs-var">quotedNameStageErr</span></a><span> </span><a href="#local-6989586621682336791"><span class="hs-identifier hs-var">br</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-139"></a><span>                        </span><span class="hs-special">}</span><span>
</span><a name="line-140"></a><span>                    </span><span class="hs-special">}</span><span>
</span><a name="line-141"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarBr</span><span> </span><a href="#local-6989586621682336792"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682336793"><span class="hs-identifier hs-var">flg</span></a><span> </span><a href="#local-6989586621682336795"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unitFV</span><span> </span><a href="#local-6989586621682336795"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span class="hs-identifier">rn_bracket</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExpBr</span><span> </span><a name="local-6989586621682336800"><a href="#local-6989586621682336800"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682336801"><a href="#local-6989586621682336801"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682336802"><a href="#local-6989586621682336802"><span class="hs-identifier">e'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682336803"><a href="#local-6989586621682336803"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682336801"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-144"></a><span>                            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExpBr</span><span> </span><a href="#local-6989586621682336800"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682336802"><span class="hs-identifier hs-var">e'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682336803"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-145"></a><span>
</span><a name="line-146"></a><span class="hs-identifier">rn_bracket</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PatBr</span><span> </span><a name="local-6989586621682336804"><a href="#local-6989586621682336804"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682336805"><a href="#local-6989586621682336805"><span class="hs-identifier">p</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-147"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnPat.html#rnPat"><span class="hs-identifier hs-var">rnPat</span></a><span> </span><span class="hs-identifier hs-var">ThPatQuote</span><span> </span><a href="#local-6989586621682336805"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682336806"><a href="#local-6989586621682336806"><span class="hs-identifier">p'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PatBr</span><span> </span><a href="#local-6989586621682336804"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682336806"><span class="hs-identifier hs-var">p'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span>
</span><a name="line-148"></a><span>
</span><a name="line-149"></a><span class="hs-identifier">rn_bracket</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TypBr</span><span> </span><a name="local-6989586621682336807"><a href="#local-6989586621682336807"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682336808"><a href="#local-6989586621682336808"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682336809"><a href="#local-6989586621682336809"><span class="hs-identifier">t'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682336810"><a href="#local-6989586621682336810"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnTypes.html#rnLHsType"><span class="hs-identifier hs-var">rnLHsType</span></a><span> </span><a href="RnUtils.html#TypBrCtx"><span class="hs-identifier hs-var">TypBrCtx</span></a><span> </span><a href="#local-6989586621682336808"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-150"></a><span>                              </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TypBr</span><span> </span><a href="#local-6989586621682336807"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682336809"><span class="hs-identifier hs-var">t'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682336810"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-151"></a><span>
</span><a name="line-152"></a><span class="hs-identifier">rn_bracket</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DecBrL</span><span> </span><a name="local-6989586621682336811"><a href="#local-6989586621682336811"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682336812"><a href="#local-6989586621682336812"><span class="hs-identifier">decls</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-153"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682336821"><a href="#local-6989586621682336821"><span class="hs-identifier">group</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682336813"><span class="hs-identifier hs-var">groupDecls</span></a><span> </span><a href="#local-6989586621682336812"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-154"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682336822"><a href="#local-6989586621682336822"><span class="hs-identifier">gbl_env</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-155"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682336823"><a href="#local-6989586621682336823"><span class="hs-identifier">new_gbl_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682336822"><span class="hs-identifier hs-var">gbl_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_dus</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyDUs</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-156"></a><span>                          </span><span class="hs-comment">-- The emptyDUs is so that we just collect uses for this</span><span>
</span><a name="line-157"></a><span>                          </span><span class="hs-comment">-- group alone in the call to rnSrcDecls below</span><span>
</span><a name="line-158"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682336824"><a href="#local-6989586621682336824"><span class="hs-identifier">tcg_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682336825"><a href="#local-6989586621682336825"><span class="hs-identifier">group'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><a href="#local-6989586621682336823"><span class="hs-identifier hs-var">new_gbl_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-159"></a><span>                              </span><a href="RnSource.html#rnSrcDecls"><span class="hs-identifier hs-var">rnSrcDecls</span></a><span> </span><a href="#local-6989586621682336821"><span class="hs-identifier hs-var">group</span></a><span>
</span><a name="line-160"></a><span>
</span><a name="line-161"></a><span>              </span><span class="hs-comment">-- Discard the tcg_env; it contains only extra info about fixity</span><span>
</span><a name="line-162"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rn_bracket dec&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_dus</span><span> </span><a href="#local-6989586621682336824"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-163"></a><span>                   </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">duUses</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_dus</span><span> </span><a href="#local-6989586621682336824"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-164"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DecBrG</span><span> </span><a href="#local-6989586621682336811"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682336825"><span class="hs-identifier hs-var">group'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">duUses</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_dus</span><span> </span><a href="#local-6989586621682336824"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-165"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-166"></a><span>    </span><span class="hs-identifier">groupDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsGroup</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span>
</span><a name="line-167"></a><span>    </span><a name="local-6989586621682336813"><a href="#local-6989586621682336813"><span class="hs-identifier">groupDecls</span></a></a><span> </span><a name="local-6989586621682336814"><a href="#local-6989586621682336814"><span class="hs-identifier">decls</span></a></a><span>
</span><a name="line-168"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682336815"><a href="#local-6989586621682336815"><span class="hs-identifier">group</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682336816"><a href="#local-6989586621682336816"><span class="hs-identifier">mb_splice</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#findSplice"><span class="hs-identifier hs-var">findSplice</span></a><span> </span><a href="#local-6989586621682336814"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-169"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682336816"><span class="hs-identifier hs-var">mb_splice</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-170"></a><span>           </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682336815"><span class="hs-identifier hs-var">group</span></a><span>
</span><a name="line-171"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682336817"><a href="#local-6989586621682336817"><span class="hs-identifier">splice</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682336818"><a href="#local-6989586621682336818"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-172"></a><span>               </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682336819"><a href="#local-6989586621682336819"><span class="hs-identifier">group'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682336813"><span class="hs-identifier hs-var">groupDecls</span></a><span> </span><a href="#local-6989586621682336818"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-173"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682336820"><a href="#local-6989586621682336820"><span class="hs-identifier">group''</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">appendGroups</span><span> </span><a href="#local-6989586621682336815"><span class="hs-identifier hs-var">group</span></a><span> </span><a href="#local-6989586621682336819"><span class="hs-identifier hs-var">group'</span></a><span>
</span><a name="line-174"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682336820"><span class="hs-identifier hs-var">group''</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hs_splcds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621682336817"><span class="hs-identifier hs-var">splice</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">hs_splcds</span><span> </span><a href="#local-6989586621682336819"><span class="hs-identifier hs-var">group'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-175"></a><span>                  </span><span class="hs-special">}</span><span>
</span><a name="line-176"></a><span>           </span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-177"></a><span>
</span><a name="line-178"></a><span class="hs-identifier">rn_bracket</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DecBrG</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rn_bracket: unexpected DecBrG&quot;</span><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span class="hs-identifier">rn_bracket</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TExpBr</span><span> </span><a name="local-6989586621682336826"><a href="#local-6989586621682336826"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682336827"><a href="#local-6989586621682336827"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682336828"><a href="#local-6989586621682336828"><span class="hs-identifier">e'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682336829"><a href="#local-6989586621682336829"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682336827"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-181"></a><span>                               </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TExpBr</span><span> </span><a href="#local-6989586621682336826"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682336828"><span class="hs-identifier hs-var">e'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682336829"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-182"></a><span>
</span><a name="line-183"></a><span class="hs-identifier">rn_bracket</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XBracket</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rn_bracket: unexpected XBracket&quot;</span><span>
</span><a name="line-184"></a><span>
</span><a name="line-185"></a><span class="hs-identifier">quotationCtxtDoc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsBracket</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-186"></a><a name="quotationCtxtDoc"><a href="RnSplice.html#quotationCtxtDoc"><span class="hs-identifier">quotationCtxtDoc</span></a></a><span> </span><a name="local-6989586621682336830"><a href="#local-6989586621682336830"><span class="hs-identifier">br_body</span></a></a><span>
</span><a name="line-187"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;In the Template Haskell quotation&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-188"></a><span>         </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336830"><span class="hs-identifier hs-var">br_body</span></a><span class="hs-special">)</span><span>
</span><a name="line-189"></a><span>
</span><a name="line-190"></a><span class="hs-identifier">illegalBracket</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-191"></a><a name="illegalBracket"><a href="RnSplice.html#illegalBracket"><span class="hs-identifier">illegalBracket</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-192"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Template Haskell brackets cannot be nested&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-193"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;(without intervening splices)&quot;</span><span>
</span><a name="line-194"></a><span>
</span><a name="line-195"></a><span class="hs-identifier">illegalTypedBracket</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-196"></a><a name="illegalTypedBracket"><a href="RnSplice.html#illegalTypedBracket"><span class="hs-identifier">illegalTypedBracket</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-197"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Typed brackets may only appear in typed splices.&quot;</span><span>
</span><a name="line-198"></a><span>
</span><a name="line-199"></a><span class="hs-identifier">illegalUntypedBracket</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-200"></a><a name="illegalUntypedBracket"><a href="RnSplice.html#illegalUntypedBracket"><span class="hs-identifier">illegalUntypedBracket</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-201"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Untyped brackets may only appear in untyped splices.&quot;</span><span>
</span><a name="line-202"></a><span>
</span><a name="line-203"></a><span class="hs-identifier">quotedNameStageErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsBracket</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-204"></a><a name="quotedNameStageErr"><a href="RnSplice.html#quotedNameStageErr"><span class="hs-identifier">quotedNameStageErr</span></a></a><span> </span><a name="local-6989586621682336831"><a href="#local-6989586621682336831"><span class="hs-identifier">br</span></a></a><span>
</span><a name="line-205"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Stage error: the non-top-level quoted name&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336831"><span class="hs-identifier hs-var">br</span></a><span>
</span><a name="line-206"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;must be used at the same stage at which it is bound&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-207"></a><span>
</span><a name="line-208"></a><span>
</span><a name="line-209"></a><span class="hs-comment">{-
*********************************************************
*                                                      *
                Splices
*                                                      *
*********************************************************

Note [Free variables of typed splices]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider renaming this:
        f = ...
        h = ...$(thing &quot;f&quot;)...

where the splice is a *typed* splice.  The splice can expand into
literally anything, so when we do dependency analysis we must assume
that it might mention 'f'.  So we simply treat all locally-defined
names as mentioned by any splice.  This is terribly brutal, but I
don't see what else to do.  For example, it'll mean that every
locally-defined thing will appear to be used, so no unused-binding
warnings.  But if we miss the dependency, then we might typecheck 'h'
before 'f', and that will crash the type checker because 'f' isn't in
scope.

Currently, I'm not treating a splice as also mentioning every import,
which is a bit inconsistent -- but there are a lot of them.  We might
thereby get some bogus unused-import warnings, but we won't crash the
type checker.  Not very satisfactory really.

Note [Renamer errors]
~~~~~~~~~~~~~~~~~~~~~
It's important to wrap renamer calls in checkNoErrs, because the
renamer does not fail for out of scope variables etc. Instead it
returns a bogus term/type, so that it can report more than one error.
We don't want the type checker to see these bogus unbound variables.
-}</span><span>
</span><a name="line-244"></a><span>
</span><a name="line-245"></a><span class="hs-identifier">rnSpliceGen</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsSplice</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682336779"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-246"></a><span>                                            </span><span class="hs-comment">-- Outside brackets, run splice</span><span>
</span><a name="line-247"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsSplice</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">PendingRnSplice</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682336779"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-248"></a><span>                                            </span><span class="hs-comment">-- Inside brackets, make it pending</span><span>
</span><a name="line-249"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsSplice</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-250"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682336779"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-251"></a><a name="rnSpliceGen"><a href="RnSplice.html#rnSpliceGen"><span class="hs-identifier">rnSpliceGen</span></a></a><span> </span><a name="local-6989586621682336832"><a href="#local-6989586621682336832"><span class="hs-identifier">run_splice</span></a></a><span> </span><a name="local-6989586621682336833"><a href="#local-6989586621682336833"><span class="hs-identifier">pend_splice</span></a></a><span> </span><a name="local-6989586621682336834"><a href="#local-6989586621682336834"><span class="hs-identifier">splice</span></a></a><span>
</span><a name="line-252"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="RnSplice.html#spliceCtxt"><span class="hs-identifier hs-var">spliceCtxt</span></a><span> </span><a href="#local-6989586621682336834"><span class="hs-identifier hs-var">splice</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-253"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682336837"><a href="#local-6989586621682336837"><span class="hs-identifier">stage</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getStage"><span class="hs-identifier hs-var">getStage</span></a><span>
</span><a name="line-254"></a><span>    </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682336837"><span class="hs-identifier hs-var">stage</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-255"></a><span>        </span><span class="hs-identifier hs-var">Brack</span><span> </span><a name="local-6989586621682336838"><a href="#local-6989586621682336838"><span class="hs-identifier">pop_stage</span></a></a><span> </span><span class="hs-identifier hs-var">RnPendingTyped</span><span>
</span><a name="line-256"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><a href="#local-6989586621682336835"><span class="hs-identifier hs-var">is_typed_splice</span></a><span> </span><a href="RnSplice.html#illegalUntypedSplice"><span class="hs-identifier hs-var">illegalUntypedSplice</span></a><span>
</span><a name="line-257"></a><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682336839"><a href="#local-6989586621682336839"><span class="hs-identifier">splice'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682336840"><a href="#local-6989586621682336840"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setStage"><span class="hs-identifier hs-var">setStage</span></a><span> </span><a href="#local-6989586621682336838"><span class="hs-identifier hs-var">pop_stage</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-258"></a><span>                                    </span><a href="RnSplice.html#rnSplice"><span class="hs-identifier hs-var">rnSplice</span></a><span> </span><a href="#local-6989586621682336834"><span class="hs-identifier hs-var">splice</span></a><span>
</span><a name="line-259"></a><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682336841"><a href="#local-6989586621682336841"><span class="hs-identifier">_pending_splice</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682336842"><a href="#local-6989586621682336842"><span class="hs-identifier">result</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682336833"><span class="hs-identifier hs-var">pend_splice</span></a><span> </span><a href="#local-6989586621682336839"><span class="hs-identifier hs-var">splice'</span></a><span>
</span><a name="line-260"></a><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682336842"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682336840"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-261"></a><span>
</span><a name="line-262"></a><span>        </span><span class="hs-identifier hs-var">Brack</span><span> </span><a name="local-6989586621682336843"><a href="#local-6989586621682336843"><span class="hs-identifier">pop_stage</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RnPendingUntyped</span><span> </span><a name="local-6989586621682336844"><a href="#local-6989586621682336844"><span class="hs-identifier">ps_var</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-263"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621682336835"><span class="hs-identifier hs-var">is_typed_splice</span></a><span class="hs-special">)</span><span> </span><a href="RnSplice.html#illegalTypedSplice"><span class="hs-identifier hs-var">illegalTypedSplice</span></a><span>
</span><a name="line-264"></a><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682336845"><a href="#local-6989586621682336845"><span class="hs-identifier">splice'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682336846"><a href="#local-6989586621682336846"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setStage"><span class="hs-identifier hs-var">setStage</span></a><span> </span><a href="#local-6989586621682336843"><span class="hs-identifier hs-var">pop_stage</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-265"></a><span>                                    </span><a href="RnSplice.html#rnSplice"><span class="hs-identifier hs-var">rnSplice</span></a><span> </span><a href="#local-6989586621682336834"><span class="hs-identifier hs-var">splice</span></a><span>
</span><a name="line-266"></a><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682336847"><a href="#local-6989586621682336847"><span class="hs-identifier">pending_splice</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682336848"><a href="#local-6989586621682336848"><span class="hs-identifier">result</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682336833"><span class="hs-identifier hs-var">pend_splice</span></a><span> </span><a href="#local-6989586621682336845"><span class="hs-identifier hs-var">splice'</span></a><span>
</span><a name="line-267"></a><span>                </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682336849"><a href="#local-6989586621682336849"><span class="hs-identifier">ps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readMutVar</span><span> </span><a href="#local-6989586621682336844"><span class="hs-identifier hs-var">ps_var</span></a><span>
</span><a name="line-268"></a><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">writeMutVar</span><span> </span><a href="#local-6989586621682336844"><span class="hs-identifier hs-var">ps_var</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682336847"><span class="hs-identifier hs-var">pending_splice</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682336849"><span class="hs-identifier hs-var">ps</span></a><span class="hs-special">)</span><span>
</span><a name="line-269"></a><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682336848"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682336846"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-270"></a><span>
</span><a name="line-271"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682336850"><a href="#local-6989586621682336850"><span class="hs-identifier">splice'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682336851"><a href="#local-6989586621682336851"><span class="hs-identifier">fvs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-272"></a><span>                                      </span><a href="TcRnMonad.html#setStage"><span class="hs-identifier hs-var">setStage</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Splice</span><span> </span><a href="#local-6989586621682336836"><span class="hs-identifier hs-var">splice_type</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-273"></a><span>                                      </span><a href="RnSplice.html#rnSplice"><span class="hs-identifier hs-var">rnSplice</span></a><span> </span><a href="#local-6989586621682336834"><span class="hs-identifier hs-var">splice</span></a><span>
</span><a name="line-274"></a><span>                   </span><span class="hs-comment">-- checkNoErrs: don't attempt to run the splice if</span><span>
</span><a name="line-275"></a><span>                   </span><span class="hs-comment">-- renaming it failed; otherwise we get a cascade of</span><span>
</span><a name="line-276"></a><span>                   </span><span class="hs-comment">-- errors from e.g. unbound variables</span><span>
</span><a name="line-277"></a><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682336852"><a href="#local-6989586621682336852"><span class="hs-identifier">result</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682336853"><a href="#local-6989586621682336853"><span class="hs-identifier">fvs2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682336832"><span class="hs-identifier hs-var">run_splice</span></a><span> </span><a href="#local-6989586621682336850"><span class="hs-identifier hs-var">splice'</span></a><span>
</span><a name="line-278"></a><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682336852"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682336851"><span class="hs-identifier hs-var">fvs1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682336853"><span class="hs-identifier hs-var">fvs2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-279"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-280"></a><span>     </span><a name="local-6989586621682336835"><a href="#local-6989586621682336835"><span class="hs-identifier">is_typed_splice</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isTypedSplice</span><span> </span><a href="#local-6989586621682336834"><span class="hs-identifier hs-var">splice</span></a><span>
</span><a name="line-281"></a><span>     </span><a name="local-6989586621682336836"><a href="#local-6989586621682336836"><span class="hs-identifier">splice_type</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682336835"><span class="hs-identifier hs-var">is_typed_splice</span></a><span>
</span><a name="line-282"></a><span>                   </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Typed</span><span>
</span><a name="line-283"></a><span>                   </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Untyped</span><span>
</span><a name="line-284"></a><span>
</span><a name="line-285"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-286"></a><span>
</span><a name="line-287"></a><span class="hs-comment">-- | Returns the result of running a splice and the modFinalizers collected</span><span>
</span><a name="line-288"></a><span class="hs-comment">-- during the execution.</span><span>
</span><a name="line-289"></a><span class="hs-comment">--</span><span>
</span><a name="line-290"></a><span class="hs-comment">-- See Note [Delaying modFinalizers in untyped splices].</span><span>
</span><a name="line-291"></a><span class="hs-identifier">runRnSplice</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UntypedSpliceFlavour</span><span>
</span><a name="line-292"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621682336778"><span class="hs-identifier hs-type">res</span></a><span class="hs-special">)</span><span>
</span><a name="line-293"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682336778"><span class="hs-identifier hs-type">res</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- How to pretty-print res</span><span>
</span><a name="line-294"></a><span>                                </span><span class="hs-comment">-- Usually just ppr, but not for [Decl]</span><span>
</span><a name="line-295"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsSplice</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>   </span><span class="hs-comment">-- Always untyped</span><span>
</span><a name="line-296"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682336778"><span class="hs-identifier hs-type">res</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ForeignRef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TH.Q</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-297"></a><a name="runRnSplice"><a href="RnSplice.html#runRnSplice"><span class="hs-identifier">runRnSplice</span></a></a><span> </span><a name="local-6989586621682336854"><a href="#local-6989586621682336854"><span class="hs-identifier">flavour</span></a></a><span> </span><a name="local-6989586621682336855"><a href="#local-6989586621682336855"><span class="hs-identifier">run_meta</span></a></a><span> </span><a name="local-6989586621682336856"><a href="#local-6989586621682336856"><span class="hs-identifier">ppr_res</span></a></a><span> </span><a name="local-6989586621682336857"><a href="#local-6989586621682336857"><span class="hs-identifier">splice</span></a></a><span>
</span><a name="line-298"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682336861"><a href="#local-6989586621682336861"><span class="hs-identifier">splice'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getHooked</span><span> </span><span class="hs-identifier">runRnSpliceHook</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682336857"><span class="hs-identifier hs-var">splice</span></a><span class="hs-special">)</span><span>
</span><a name="line-299"></a><span>
</span><a name="line-300"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682336862"><a href="#local-6989586621682336862"><span class="hs-identifier">the_expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682336861"><span class="hs-identifier hs-var">splice'</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-301"></a><span>                </span><span class="hs-identifier hs-var">HsUntypedSplice</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682336863"><a href="#local-6989586621682336863"><span class="hs-identifier">e</span></a></a><span>   </span><span class="hs-glyph">-&gt;</span><span>  </span><a href="#local-6989586621682336863"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-302"></a><span>                </span><span class="hs-identifier hs-var">HsQuasiQuote</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682336864"><a href="#local-6989586621682336864"><span class="hs-identifier">q</span></a></a><span> </span><a name="local-6989586621682336865"><a href="#local-6989586621682336865"><span class="hs-identifier">qs</span></a></a><span> </span><a name="local-6989586621682336866"><a href="#local-6989586621682336866"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnSplice.html#mkQuasiQuoteExpr"><span class="hs-identifier hs-var">mkQuasiQuoteExpr</span></a><span> </span><a href="#local-6989586621682336854"><span class="hs-identifier hs-var">flavour</span></a><span> </span><a href="#local-6989586621682336864"><span class="hs-identifier hs-var">q</span></a><span> </span><a href="#local-6989586621682336865"><span class="hs-identifier hs-var">qs</span></a><span> </span><a href="#local-6989586621682336866"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-303"></a><span>                </span><span class="hs-identifier hs-var">HsTypedSplice</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;runRnSplice&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336857"><span class="hs-identifier hs-var">splice</span></a><span class="hs-special">)</span><span>
</span><a name="line-304"></a><span>                </span><span class="hs-identifier hs-var">HsSpliced</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;runRnSplice&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336857"><span class="hs-identifier hs-var">splice</span></a><span class="hs-special">)</span><span>
</span><a name="line-305"></a><span>                </span><span class="hs-identifier hs-var">HsSplicedT</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;runRnSplice&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336857"><span class="hs-identifier hs-var">splice</span></a><span class="hs-special">)</span><span>
</span><a name="line-306"></a><span>                </span><span class="hs-identifier hs-var">XSplice</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;runRnSplice&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336857"><span class="hs-identifier hs-var">splice</span></a><span class="hs-special">)</span><span>
</span><a name="line-307"></a><span>
</span><a name="line-308"></a><span>             </span><span class="hs-comment">-- Typecheck the expression</span><span>
</span><a name="line-309"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682336867"><a href="#local-6989586621682336867"><span class="hs-identifier">meta_exp_ty</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcMetaTy"><span class="hs-identifier hs-var">tcMetaTy</span></a><span> </span><a href="#local-6989586621682336858"><span class="hs-identifier hs-var">meta_ty_name</span></a><span>
</span><a name="line-310"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682336868"><a href="#local-6989586621682336868"><span class="hs-identifier">zonked_q_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTopLExpr"><span class="hs-identifier hs-var">zonkTopLExpr</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span>
</span><a name="line-311"></a><span>                            </span><a href="TcSplice.html#tcTopSpliceExpr"><span class="hs-identifier hs-var">tcTopSpliceExpr</span></a><span> </span><span class="hs-identifier hs-var">Untyped</span><span>
</span><a name="line-312"></a><span>                              </span><span class="hs-special">(</span><a href="TcExpr.html#tcPolyExpr"><span class="hs-identifier hs-var">tcPolyExpr</span></a><span> </span><a href="#local-6989586621682336862"><span class="hs-identifier hs-var">the_expr</span></a><span> </span><a href="#local-6989586621682336867"><span class="hs-identifier hs-var">meta_exp_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-313"></a><span>
</span><a name="line-314"></a><span>             </span><span class="hs-comment">-- Run the expression</span><span>
</span><a name="line-315"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682336869"><a href="#local-6989586621682336869"><span class="hs-identifier">mod_finalizers_ref</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newTcRef"><span class="hs-identifier hs-var">newTcRef</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-316"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682336870"><a href="#local-6989586621682336870"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setStage"><span class="hs-identifier hs-var">setStage</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RunSplice</span><span> </span><a href="#local-6989586621682336869"><span class="hs-identifier hs-var">mod_finalizers_ref</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-317"></a><span>                     </span><a href="#local-6989586621682336855"><span class="hs-identifier hs-var">run_meta</span></a><span> </span><a href="#local-6989586621682336868"><span class="hs-identifier hs-var">zonked_q_expr</span></a><span>
</span><a name="line-318"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682336871"><a href="#local-6989586621682336871"><span class="hs-identifier">mod_finalizers</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-6989586621682336869"><span class="hs-identifier hs-var">mod_finalizers_ref</span></a><span>
</span><a name="line-319"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="RnSplice.html#traceSplice"><span class="hs-identifier hs-var">traceSplice</span></a><span> </span><span class="hs-special">(</span><a href="RnSplice.html#SpliceInfo"><span class="hs-identifier hs-var">SpliceInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">spliceDescription</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682336859"><span class="hs-identifier hs-var">what</span></a><span>
</span><a name="line-320"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">spliceIsDecl</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682336860"><span class="hs-identifier hs-var">is_decl</span></a><span>
</span><a name="line-321"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">spliceSource</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682336862"><span class="hs-identifier hs-var">the_expr</span></a><span>
</span><a name="line-322"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">spliceGenerated</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682336856"><span class="hs-identifier hs-var">ppr_res</span></a><span> </span><a href="#local-6989586621682336870"><span class="hs-identifier hs-var">result</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-323"></a><span>
</span><a name="line-324"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682336870"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682336871"><span class="hs-identifier hs-var">mod_finalizers</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-325"></a><span>
</span><a name="line-326"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-327"></a><span>    </span><a name="local-6989586621682336858"><a href="#local-6989586621682336858"><span class="hs-identifier">meta_ty_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682336854"><span class="hs-identifier hs-var">flavour</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-328"></a><span>                       </span><span class="hs-identifier hs-var">UntypedExpSplice</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="THNames.html#expQTyConName"><span class="hs-identifier hs-var">expQTyConName</span></a><span>
</span><a name="line-329"></a><span>                       </span><span class="hs-identifier hs-var">UntypedPatSplice</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="THNames.html#patQTyConName"><span class="hs-identifier hs-var">patQTyConName</span></a><span>
</span><a name="line-330"></a><span>                       </span><span class="hs-identifier hs-var">UntypedTypeSplice</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="THNames.html#typeQTyConName"><span class="hs-identifier hs-var">typeQTyConName</span></a><span>
</span><a name="line-331"></a><span>                       </span><span class="hs-identifier hs-var">UntypedDeclSplice</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="THNames.html#decsQTyConName"><span class="hs-identifier hs-var">decsQTyConName</span></a><span>
</span><a name="line-332"></a><span>    </span><a name="local-6989586621682336859"><a href="#local-6989586621682336859"><span class="hs-identifier">what</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682336854"><span class="hs-identifier hs-var">flavour</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-333"></a><span>                  </span><span class="hs-identifier hs-var">UntypedExpSplice</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;expression&quot;</span><span>
</span><a name="line-334"></a><span>                  </span><span class="hs-identifier hs-var">UntypedPatSplice</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;pattern&quot;</span><span>
</span><a name="line-335"></a><span>                  </span><span class="hs-identifier hs-var">UntypedTypeSplice</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;type&quot;</span><span>
</span><a name="line-336"></a><span>                  </span><span class="hs-identifier hs-var">UntypedDeclSplice</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;declarations&quot;</span><span>
</span><a name="line-337"></a><span>    </span><a name="local-6989586621682336860"><a href="#local-6989586621682336860"><span class="hs-identifier">is_decl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682336854"><span class="hs-identifier hs-var">flavour</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-338"></a><span>                 </span><span class="hs-identifier hs-var">UntypedDeclSplice</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-339"></a><span>                 </span><span class="hs-identifier">_</span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-340"></a><span>
</span><a name="line-341"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-342"></a><span class="hs-identifier">makePending</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UntypedSpliceFlavour</span><span>
</span><a name="line-343"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsSplice</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>
</span><a name="line-344"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PendingRnSplice</span><span>
</span><a name="line-345"></a><a name="makePending"><a href="RnSplice.html#makePending"><span class="hs-identifier">makePending</span></a></a><span> </span><a name="local-6989586621682336872"><a href="#local-6989586621682336872"><span class="hs-identifier">flavour</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsUntypedSplice</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682336873"><a href="#local-6989586621682336873"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621682336874"><a href="#local-6989586621682336874"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-346"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">PendingRnSplice</span><span> </span><a href="#local-6989586621682336872"><span class="hs-identifier hs-var">flavour</span></a><span> </span><a href="#local-6989586621682336873"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621682336874"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-347"></a><span class="hs-identifier">makePending</span><span> </span><a name="local-6989586621682336875"><a href="#local-6989586621682336875"><span class="hs-identifier">flavour</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsQuasiQuote</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682336876"><a href="#local-6989586621682336876"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621682336877"><a href="#local-6989586621682336877"><span class="hs-identifier">quoter</span></a></a><span> </span><a name="local-6989586621682336878"><a href="#local-6989586621682336878"><span class="hs-identifier">q_span</span></a></a><span> </span><a name="local-6989586621682336879"><a href="#local-6989586621682336879"><span class="hs-identifier">quote</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-348"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">PendingRnSplice</span><span> </span><a href="#local-6989586621682336875"><span class="hs-identifier hs-var">flavour</span></a><span> </span><a href="#local-6989586621682336876"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="RnSplice.html#mkQuasiQuoteExpr"><span class="hs-identifier hs-var">mkQuasiQuoteExpr</span></a><span> </span><a href="#local-6989586621682336875"><span class="hs-identifier hs-var">flavour</span></a><span> </span><a href="#local-6989586621682336877"><span class="hs-identifier hs-var">quoter</span></a><span> </span><a href="#local-6989586621682336878"><span class="hs-identifier hs-var">q_span</span></a><span> </span><a href="#local-6989586621682336879"><span class="hs-identifier hs-var">quote</span></a><span class="hs-special">)</span><span>
</span><a name="line-349"></a><span class="hs-identifier">makePending</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682336880"><a href="#local-6989586621682336880"><span class="hs-identifier">splice</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTypedSplice</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-350"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;makePending&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336880"><span class="hs-identifier hs-var">splice</span></a><span class="hs-special">)</span><span>
</span><a name="line-351"></a><span class="hs-identifier">makePending</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682336881"><a href="#local-6989586621682336881"><span class="hs-identifier">splice</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSpliced</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-352"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;makePending&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336881"><span class="hs-identifier hs-var">splice</span></a><span class="hs-special">)</span><span>
</span><a name="line-353"></a><span class="hs-identifier">makePending</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682336882"><a href="#local-6989586621682336882"><span class="hs-identifier">splice</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSplicedT</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-354"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;makePending&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336882"><span class="hs-identifier hs-var">splice</span></a><span class="hs-special">)</span><span>
</span><a name="line-355"></a><span class="hs-identifier">makePending</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682336883"><a href="#local-6989586621682336883"><span class="hs-identifier">splice</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">XSplice</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-356"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;makePending&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336883"><span class="hs-identifier hs-var">splice</span></a><span class="hs-special">)</span><span>
</span><a name="line-357"></a><span>
</span><a name="line-358"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-359"></a><span class="hs-identifier">mkQuasiQuoteExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UntypedSpliceFlavour</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FastString</span><span>
</span><a name="line-360"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>
</span><a name="line-361"></a><span class="hs-comment">-- Return the expression (quoter &quot;...quote...&quot;)</span><span>
</span><a name="line-362"></a><span class="hs-comment">-- which is what we must run in a quasi-quote</span><span>
</span><a name="line-363"></a><a name="mkQuasiQuoteExpr"><a href="RnSplice.html#mkQuasiQuoteExpr"><span class="hs-identifier">mkQuasiQuoteExpr</span></a></a><span> </span><a name="local-6989586621682336884"><a href="#local-6989586621682336884"><span class="hs-identifier">flavour</span></a></a><span> </span><a name="local-6989586621682336885"><a href="#local-6989586621682336885"><span class="hs-identifier">quoter</span></a></a><span> </span><a name="local-6989586621682336886"><a href="#local-6989586621682336886"><span class="hs-identifier">q_span</span></a></a><span> </span><a name="local-6989586621682336887"><a href="#local-6989586621682336887"><span class="hs-identifier">quote</span></a></a><span>
</span><a name="line-364"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682336886"><span class="hs-identifier hs-var">q_span</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">HsApp</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682336886"><span class="hs-identifier hs-var">q_span</span></a><span>
</span><a name="line-365"></a><span>              </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">HsApp</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682336886"><span class="hs-identifier hs-var">q_span</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682336886"><span class="hs-identifier hs-var">q_span</span></a><span> </span><a href="#local-6989586621682336890"><span class="hs-identifier hs-var">quote_selector</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-366"></a><span>                            </span><a href="#local-6989586621682336888"><span class="hs-identifier hs-var">quoterExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-367"></a><span>                     </span><a href="#local-6989586621682336889"><span class="hs-identifier hs-var">quoteExpr</span></a><span>
</span><a name="line-368"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-369"></a><span>    </span><a name="local-6989586621682336888"><a href="#local-6989586621682336888"><span class="hs-identifier">quoterExpr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682336886"><span class="hs-identifier hs-var">q_span</span></a><span> </span><span class="hs-operator hs-var">$!</span><span> </span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682336886"><span class="hs-identifier hs-var">q_span</span></a><span> </span><a href="#local-6989586621682336885"><span class="hs-identifier hs-var">quoter</span></a><span class="hs-special">)</span><span>
</span><a name="line-370"></a><span>    </span><a name="local-6989586621682336889"><a href="#local-6989586621682336889"><span class="hs-identifier">quoteExpr</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682336886"><span class="hs-identifier hs-var">q_span</span></a><span> </span><span class="hs-operator hs-var">$!</span><span> </span><span class="hs-identifier hs-var">HsLit</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><span class="hs-identifier hs-var">HsString</span><span> </span><span class="hs-identifier hs-var">NoSourceText</span><span> </span><a href="#local-6989586621682336887"><span class="hs-identifier hs-var">quote</span></a><span>
</span><a name="line-371"></a><span>    </span><a name="local-6989586621682336890"><a href="#local-6989586621682336890"><span class="hs-identifier">quote_selector</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682336884"><span class="hs-identifier hs-var">flavour</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-372"></a><span>                       </span><span class="hs-identifier hs-var">UntypedExpSplice</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="THNames.html#quoteExpName"><span class="hs-identifier hs-var">quoteExpName</span></a><span>
</span><a name="line-373"></a><span>                       </span><span class="hs-identifier hs-var">UntypedPatSplice</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="THNames.html#quotePatName"><span class="hs-identifier hs-var">quotePatName</span></a><span>
</span><a name="line-374"></a><span>                       </span><span class="hs-identifier hs-var">UntypedTypeSplice</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="THNames.html#quoteTypeName"><span class="hs-identifier hs-var">quoteTypeName</span></a><span>
</span><a name="line-375"></a><span>                       </span><span class="hs-identifier hs-var">UntypedDeclSplice</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="THNames.html#quoteDecName"><span class="hs-identifier hs-var">quoteDecName</span></a><span>
</span><a name="line-376"></a><span>
</span><a name="line-377"></a><span class="hs-comment">---------------------</span><span>
</span><a name="line-378"></a><span class="hs-identifier">rnSplice</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsSplice</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsSplice</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-379"></a><span class="hs-comment">-- Not exported...used for all</span><span>
</span><a name="line-380"></a><a name="rnSplice"><a href="RnSplice.html#rnSplice"><span class="hs-identifier">rnSplice</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTypedSplice</span><span> </span><a name="local-6989586621682336891"><a href="#local-6989586621682336891"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682336892"><a href="#local-6989586621682336892"><span class="hs-identifier">hasParen</span></a></a><span> </span><a name="local-6989586621682336893"><a href="#local-6989586621682336893"><span class="hs-identifier">splice_name</span></a></a><span> </span><a name="local-6989586621682336894"><a href="#local-6989586621682336894"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-381"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#checkTH"><span class="hs-identifier hs-var">checkTH</span></a><span> </span><a href="#local-6989586621682336894"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-string">&quot;Template Haskell typed splice&quot;</span><span>
</span><a name="line-382"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682336895"><a href="#local-6989586621682336895"><span class="hs-identifier">loc</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span>
</span><a name="line-383"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682336896"><a href="#local-6989586621682336896"><span class="hs-identifier">n'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnUtils.html#newLocalBndrRn"><span class="hs-identifier hs-var">newLocalBndrRn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682336895"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621682336893"><span class="hs-identifier hs-var">splice_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-384"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682336897"><a href="#local-6989586621682336897"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682336898"><a href="#local-6989586621682336898"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682336894"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-385"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTypedSplice</span><span> </span><a href="#local-6989586621682336891"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682336892"><span class="hs-identifier hs-var">hasParen</span></a><span> </span><a href="#local-6989586621682336896"><span class="hs-identifier hs-var">n'</span></a><span> </span><a href="#local-6989586621682336897"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682336898"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-386"></a><span>
</span><a name="line-387"></a><span class="hs-identifier">rnSplice</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsUntypedSplice</span><span> </span><a name="local-6989586621682336899"><a href="#local-6989586621682336899"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682336900"><a href="#local-6989586621682336900"><span class="hs-identifier">hasParen</span></a></a><span> </span><a name="local-6989586621682336901"><a href="#local-6989586621682336901"><span class="hs-identifier">splice_name</span></a></a><span> </span><a name="local-6989586621682336902"><a href="#local-6989586621682336902"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-388"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#checkTH"><span class="hs-identifier hs-var">checkTH</span></a><span> </span><a href="#local-6989586621682336902"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-string">&quot;Template Haskell untyped splice&quot;</span><span>
</span><a name="line-389"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682336903"><a href="#local-6989586621682336903"><span class="hs-identifier">loc</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span>
</span><a name="line-390"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682336904"><a href="#local-6989586621682336904"><span class="hs-identifier">n'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnUtils.html#newLocalBndrRn"><span class="hs-identifier hs-var">newLocalBndrRn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682336903"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621682336901"><span class="hs-identifier hs-var">splice_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-391"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682336905"><a href="#local-6989586621682336905"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682336906"><a href="#local-6989586621682336906"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682336902"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-392"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsUntypedSplice</span><span> </span><a href="#local-6989586621682336899"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682336900"><span class="hs-identifier hs-var">hasParen</span></a><span> </span><a href="#local-6989586621682336904"><span class="hs-identifier hs-var">n'</span></a><span> </span><a href="#local-6989586621682336905"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682336906"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-393"></a><span>
</span><a name="line-394"></a><span class="hs-identifier">rnSplice</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsQuasiQuote</span><span> </span><a name="local-6989586621682336907"><a href="#local-6989586621682336907"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682336908"><a href="#local-6989586621682336908"><span class="hs-identifier">splice_name</span></a></a><span> </span><a name="local-6989586621682336909"><a href="#local-6989586621682336909"><span class="hs-identifier">quoter</span></a></a><span> </span><a name="local-6989586621682336910"><a href="#local-6989586621682336910"><span class="hs-identifier">q_loc</span></a></a><span> </span><a name="local-6989586621682336911"><a href="#local-6989586621682336911"><span class="hs-identifier">quote</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-395"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#checkTH"><span class="hs-identifier hs-var">checkTH</span></a><span> </span><a href="#local-6989586621682336909"><span class="hs-identifier hs-var">quoter</span></a><span> </span><span class="hs-string">&quot;Template Haskell quasi-quote&quot;</span><span>
</span><a name="line-396"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682336912"><a href="#local-6989586621682336912"><span class="hs-identifier">loc</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span>
</span><a name="line-397"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682336913"><a href="#local-6989586621682336913"><span class="hs-identifier">splice_name'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnUtils.html#newLocalBndrRn"><span class="hs-identifier hs-var">newLocalBndrRn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682336912"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621682336908"><span class="hs-identifier hs-var">splice_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-398"></a><span>
</span><a name="line-399"></a><span>          </span><span class="hs-comment">-- Rename the quoter; akin to the HsVar case of rnExpr</span><span>
</span><a name="line-400"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682336914"><a href="#local-6989586621682336914"><span class="hs-identifier">quoter'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupOccRn"><span class="hs-identifier hs-var">lookupOccRn</span></a><span> </span><a href="#local-6989586621682336909"><span class="hs-identifier hs-var">quoter</span></a><span>
</span><a name="line-401"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682336915"><a href="#local-6989586621682336915"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-402"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameIsLocalOrFrom</span><span> </span><a href="#local-6989586621682336915"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621682336914"><span class="hs-identifier hs-var">quoter'</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-403"></a><span>          </span><a href="RnSplice.html#checkThLocalName"><span class="hs-identifier hs-var">checkThLocalName</span></a><span> </span><a href="#local-6989586621682336914"><span class="hs-identifier hs-var">quoter'</span></a><span>
</span><a name="line-404"></a><span>
</span><a name="line-405"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsQuasiQuote</span><span> </span><a href="#local-6989586621682336907"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682336913"><span class="hs-identifier hs-var">splice_name'</span></a><span> </span><a href="#local-6989586621682336914"><span class="hs-identifier hs-var">quoter'</span></a><span> </span><a href="#local-6989586621682336910"><span class="hs-identifier hs-var">q_loc</span></a><span> </span><a href="#local-6989586621682336911"><span class="hs-identifier hs-var">quote</span></a><span>
</span><a name="line-406"></a><span>                                                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unitFV</span><span> </span><a href="#local-6989586621682336914"><span class="hs-identifier hs-var">quoter'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-407"></a><span>
</span><a name="line-408"></a><span class="hs-identifier">rnSplice</span><span> </span><a name="local-6989586621682336916"><a href="#local-6989586621682336916"><span class="hs-identifier">splice</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSpliced</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;rnSplice&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336916"><span class="hs-identifier hs-var">splice</span></a><span class="hs-special">)</span><span>
</span><a name="line-409"></a><span class="hs-identifier">rnSplice</span><span> </span><a name="local-6989586621682336917"><a href="#local-6989586621682336917"><span class="hs-identifier">splice</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSplicedT</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;rnSplice&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336917"><span class="hs-identifier hs-var">splice</span></a><span class="hs-special">)</span><span>
</span><a name="line-410"></a><span class="hs-identifier">rnSplice</span><span> </span><a name="local-6989586621682336918"><a href="#local-6989586621682336918"><span class="hs-identifier">splice</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">XSplice</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;rnSplice&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336918"><span class="hs-identifier hs-var">splice</span></a><span class="hs-special">)</span><span>
</span><a name="line-411"></a><span>
</span><a name="line-412"></a><span class="hs-comment">---------------------</span><span>
</span><a name="line-413"></a><span class="hs-identifier">rnSpliceExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsSplice</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-414"></a><a name="rnSpliceExpr"><a href="RnSplice.html#rnSpliceExpr"><span class="hs-identifier">rnSpliceExpr</span></a></a><span> </span><a name="local-6989586621682336919"><a href="#local-6989586621682336919"><span class="hs-identifier">splice</span></a></a><span>
</span><a name="line-415"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnSplice.html#rnSpliceGen"><span class="hs-identifier hs-var">rnSpliceGen</span></a><span> </span><a href="#local-6989586621682336921"><span class="hs-identifier hs-var">run_expr_splice</span></a><span> </span><a href="#local-6989586621682336920"><span class="hs-identifier hs-var">pend_expr_splice</span></a><span> </span><a href="#local-6989586621682336919"><span class="hs-identifier hs-var">splice</span></a><span>
</span><a name="line-416"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-417"></a><span>    </span><span class="hs-identifier">pend_expr_splice</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsSplice</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">PendingRnSplice</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span>
</span><a name="line-418"></a><span>    </span><a name="local-6989586621682336920"><a href="#local-6989586621682336920"><span class="hs-identifier">pend_expr_splice</span></a></a><span> </span><a name="local-6989586621682336922"><a href="#local-6989586621682336922"><span class="hs-identifier">rn_splice</span></a></a><span>
</span><a name="line-419"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="RnSplice.html#makePending"><span class="hs-identifier hs-var">makePending</span></a><span> </span><span class="hs-identifier hs-var">UntypedExpSplice</span><span> </span><a href="#local-6989586621682336922"><span class="hs-identifier hs-var">rn_splice</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HsSpliceE</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682336922"><span class="hs-identifier hs-var">rn_splice</span></a><span class="hs-special">)</span><span>
</span><a name="line-420"></a><span>
</span><a name="line-421"></a><span>    </span><span class="hs-identifier">run_expr_splice</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsSplice</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-422"></a><span>    </span><a name="local-6989586621682336921"><a href="#local-6989586621682336921"><span class="hs-identifier">run_expr_splice</span></a></a><span> </span><a name="local-6989586621682336923"><a href="#local-6989586621682336923"><span class="hs-identifier">rn_splice</span></a></a><span>
</span><a name="line-423"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTypedSplice</span><span> </span><a href="#local-6989586621682336923"><span class="hs-identifier hs-var">rn_splice</span></a><span>   </span><span class="hs-comment">-- Run it later, in the type checker</span><span>
</span><a name="line-424"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>  </span><span class="hs-comment">-- Ugh!  See Note [Splices] above</span><span>
</span><a name="line-425"></a><span>             </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rnSpliceExpr: typed expression splice&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-426"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682336924"><a href="#local-6989586621682336924"><span class="hs-identifier">lcl_rdr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLocalRdrEnv"><span class="hs-identifier hs-var">getLocalRdrEnv</span></a><span>
</span><a name="line-427"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682336925"><a href="#local-6989586621682336925"><span class="hs-identifier">gbl_rdr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGlobalRdrEnv"><span class="hs-identifier hs-var">getGlobalRdrEnv</span></a><span>
</span><a name="line-428"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682336926"><a href="#local-6989586621682336926"><span class="hs-identifier">gbl_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkNameSet</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">gre_name</span><span> </span><a href="#local-6989586621682336928"><span class="hs-identifier hs-var">gre</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621682336928"><a href="#local-6989586621682336928"><span class="hs-identifier">gre</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">globalRdrEnvElts</span><span> </span><a href="#local-6989586621682336925"><span class="hs-identifier hs-var">gbl_rdr</span></a><span>
</span><a name="line-429"></a><span>                                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isLocalGRE</span><span> </span><a href="#local-6989586621682336928"><span class="hs-identifier hs-var">gre</span></a><span class="hs-special">]</span><span>
</span><a name="line-430"></a><span>                 </span><a name="local-6989586621682336927"><a href="#local-6989586621682336927"><span class="hs-identifier">lcl_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkNameSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">localRdrEnvElts</span><span> </span><a href="#local-6989586621682336924"><span class="hs-identifier hs-var">lcl_rdr</span></a><span class="hs-special">)</span><span>
</span><a name="line-431"></a><span>
</span><a name="line-432"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSpliceE</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682336923"><span class="hs-identifier hs-var">rn_splice</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682336927"><span class="hs-identifier hs-var">lcl_names</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682336926"><span class="hs-identifier hs-var">gbl_names</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-433"></a><span>
</span><a name="line-434"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-comment">-- Run it here, see Note [Running splices in the Renamer]</span><span>
</span><a name="line-435"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rnSpliceExpr: untyped expression splice&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-436"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682336929"><a href="#local-6989586621682336929"><span class="hs-identifier">rn_expr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682336930"><a href="#local-6989586621682336930"><span class="hs-identifier">mod_finalizers</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-437"></a><span>                </span><a href="RnSplice.html#runRnSplice"><span class="hs-identifier hs-var">runRnSplice</span></a><span> </span><span class="hs-identifier hs-var">UntypedExpSplice</span><span> </span><a href="TcSplice.html#runMetaE"><span class="hs-identifier hs-var">runMetaE</span></a><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336923"><span class="hs-identifier hs-var">rn_splice</span></a><span>
</span><a name="line-438"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682336931"><a href="#local-6989586621682336931"><span class="hs-identifier">lexpr3</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682336932"><a href="#local-6989586621682336932"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span> </span><span class="hs-special">(</span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682336929"><span class="hs-identifier hs-var">rn_expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-439"></a><span>             </span><span class="hs-comment">-- See Note [Delaying modFinalizers in untyped splices].</span><span>
</span><a name="line-440"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">HsPar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">HsSpliceE</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-441"></a><span>                            </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">HsSpliced</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ThModFinalizers</span><span> </span><a href="#local-6989586621682336930"><span class="hs-identifier hs-var">mod_finalizers</span></a><span class="hs-special">)</span><span>
</span><a name="line-442"></a><span>                            </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">HsSplicedExpr</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span>
</span><a name="line-443"></a><span>                            </span><a href="#local-6989586621682336931"><span class="hs-identifier hs-var">lexpr3</span></a><span>
</span><a name="line-444"></a><span>                    </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682336932"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-445"></a><span>           </span><span class="hs-special">}</span><span>
</span><a name="line-446"></a><span>
</span><a name="line-447"></a><span class="hs-comment">{- Note [Running splices in the Renamer]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Splices used to be run in the typechecker, which led to (Trac #4364). Since the
renamer must decide which expressions depend on which others, and it cannot
reliably do this for arbitrary splices, we used to conservatively say that
splices depend on all other expressions in scope. Unfortunately, this led to
the problem of cyclic type declarations seen in (Trac #4364). Instead, by
running splices in the renamer, we side-step the problem of determining
dependencies: by the time the dependency analysis happens, any splices have
already been run, and expression dependencies can be determined as usual.

However, see (Trac #9813), for an example where we would like to run splices
*after* performing dependency analysis (that is, after renaming). It would be
desirable to typecheck &quot;non-splicy&quot; expressions (those expressions that do not
contain splices directly or via dependence on an expression that does) before
&quot;splicy&quot; expressions, such that types/expressions within the same declaration
group would be available to `reify` calls, for example consider the following:

&gt; module M where
&gt;   data D = C
&gt;   f = 1
&gt;   g = $(mapM reify ['f, 'D, ''C] ...)

Compilation of this example fails since D/C/f are not in the type environment
and thus cannot be reified as they have not been typechecked by the time the
splice is renamed and thus run.

These requirements are at odds: we do not want to run splices in the renamer as
we wish to first determine dependencies and typecheck certain expressions,
making them available to reify, but cannot accurately determine dependencies
without running splices in the renamer!

Indeed, the conclusion of (Trac #9813) was that it is not worth the complexity
to try and
 a) implement and maintain the code for renaming/typechecking non-splicy
    expressions before splicy expressions,
 b) explain to TH users which expressions are/not available to reify at any
    given point.

-}</span><span>
</span><a name="line-488"></a><span>
</span><a name="line-489"></a><span class="hs-comment">{- Note [Delaying modFinalizers in untyped splices]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

When splices run in the renamer, 'reify' does not have access to the local
type environment (Trac #11832, [1]).

For instance, in

&gt; let x = e in $(reify (mkName &quot;x&quot;) &gt;&gt;= runIO . print &gt;&gt; [| return () |])

'reify' cannot find @x@, because the local type environment is not yet
populated. To address this, we allow 'reify' execution to be deferred with
'addModFinalizer'.

&gt; let x = e in $(do addModFinalizer (reify (mkName &quot;x&quot;) &gt;&gt;= runIO . print)
                    [| return () |]
                )

The finalizer is run with the local type environment when type checking is
complete.

Since the local type environment is not available in the renamer, we annotate
the tree at the splice point [2] with @HsSpliceE (HsSpliced finalizers e)@ where
@e@ is the result of splicing and @finalizers@ are the finalizers that have been
collected during evaluation of the splice [3]. In our example,

&gt; HsLet
&gt;   (x = e)
&gt;   (HsSpliceE $ HsSpliced [reify (mkName &quot;x&quot;) &gt;&gt;= runIO . print]
&gt;                          (HsSplicedExpr $ return ())
&gt;   )

When the typechecker finds the annotation, it inserts the finalizers in the
global environment and exposes the current local environment to them [4, 5, 6].

&gt; addModFinalizersWithLclEnv [reify (mkName &quot;x&quot;) &gt;&gt;= runIO . print]

References:

[1] https://ghc.haskell.org/trac/ghc/wiki/TemplateHaskell/Reify
[2] 'rnSpliceExpr'
[3] 'TcSplice.qAddModFinalizer'
[4] 'TcExpr.tcExpr' ('HsSpliceE' ('HsSpliced' ...))
[5] 'TcHsType.tc_hs_type' ('HsSpliceTy' ('HsSpliced' ...))
[6] 'TcPat.tc_pat' ('SplicePat' ('HsSpliced' ...))

-}</span><span>
</span><a name="line-536"></a><span>
</span><a name="line-537"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-538"></a><span class="hs-identifier">rnSpliceType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsSplice</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-539"></a><a name="rnSpliceType"><a href="RnSplice.html#rnSpliceType"><span class="hs-identifier">rnSpliceType</span></a></a><span> </span><a name="local-6989586621682336933"><a href="#local-6989586621682336933"><span class="hs-identifier">splice</span></a></a><span>
</span><a name="line-540"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnSplice.html#rnSpliceGen"><span class="hs-identifier hs-var">rnSpliceGen</span></a><span> </span><a href="#local-6989586621682336935"><span class="hs-identifier hs-var">run_type_splice</span></a><span> </span><a href="#local-6989586621682336934"><span class="hs-identifier hs-var">pend_type_splice</span></a><span> </span><a href="#local-6989586621682336933"><span class="hs-identifier hs-var">splice</span></a><span>
</span><a name="line-541"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-542"></a><span>    </span><a name="local-6989586621682336934"><a href="#local-6989586621682336934"><span class="hs-identifier">pend_type_splice</span></a></a><span> </span><a name="local-6989586621682336936"><a href="#local-6989586621682336936"><span class="hs-identifier">rn_splice</span></a></a><span>
</span><a name="line-543"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="RnSplice.html#makePending"><span class="hs-identifier hs-var">makePending</span></a><span> </span><span class="hs-identifier hs-var">UntypedTypeSplice</span><span> </span><a href="#local-6989586621682336936"><span class="hs-identifier hs-var">rn_splice</span></a><span>
</span><a name="line-544"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HsSpliceTy</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682336936"><span class="hs-identifier hs-var">rn_splice</span></a><span class="hs-special">)</span><span>
</span><a name="line-545"></a><span>
</span><a name="line-546"></a><span>    </span><a name="local-6989586621682336935"><a href="#local-6989586621682336935"><span class="hs-identifier">run_type_splice</span></a></a><span> </span><a name="local-6989586621682336937"><a href="#local-6989586621682336937"><span class="hs-identifier">rn_splice</span></a></a><span>
</span><a name="line-547"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rnSpliceType: untyped type splice&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-548"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682336938"><a href="#local-6989586621682336938"><span class="hs-identifier">hs_ty2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682336939"><a href="#local-6989586621682336939"><span class="hs-identifier">mod_finalizers</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-549"></a><span>                </span><a href="RnSplice.html#runRnSplice"><span class="hs-identifier hs-var">runRnSplice</span></a><span> </span><span class="hs-identifier hs-var">UntypedTypeSplice</span><span> </span><a href="TcSplice.html#runMetaT"><span class="hs-identifier hs-var">runMetaT</span></a><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336937"><span class="hs-identifier hs-var">rn_splice</span></a><span>
</span><a name="line-550"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682336941"><a href="#local-6989586621682336941"><span class="hs-identifier">hs_ty3</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682336942"><a href="#local-6989586621682336942"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682336940"><a href="#local-6989586621682336940"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnUtils.html#SpliceTypeCtx"><span class="hs-identifier hs-var">SpliceTypeCtx</span></a><span> </span><a href="#local-6989586621682336938"><span class="hs-identifier hs-var">hs_ty2</span></a><span>
</span><a name="line-551"></a><span>                                 </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="RnTypes.html#rnLHsType"><span class="hs-identifier hs-var">rnLHsType</span></a><span> </span><a href="#local-6989586621682336940"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621682336938"><span class="hs-identifier hs-var">hs_ty2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-552"></a><span>                                    </span><span class="hs-comment">-- checkNoErrs: see Note [Renamer errors]</span><span>
</span><a name="line-553"></a><span>             </span><span class="hs-comment">-- See Note [Delaying modFinalizers in untyped splices].</span><span>
</span><a name="line-554"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">HsParTy</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">HsSpliceTy</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-555"></a><span>                              </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">HsSpliced</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ThModFinalizers</span><span> </span><a href="#local-6989586621682336939"><span class="hs-identifier hs-var">mod_finalizers</span></a><span class="hs-special">)</span><span>
</span><a name="line-556"></a><span>                              </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">HsSplicedTy</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span>
</span><a name="line-557"></a><span>                              </span><a href="#local-6989586621682336941"><span class="hs-identifier hs-var">hs_ty3</span></a><span>
</span><a name="line-558"></a><span>                    </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682336942"><span class="hs-identifier hs-var">fvs</span></a><span>
</span><a name="line-559"></a><span>                    </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-560"></a><span>              </span><span class="hs-comment">-- Wrap the result of the splice in parens so that we don't</span><span>
</span><a name="line-561"></a><span>              </span><span class="hs-comment">-- lose the outermost location set by runQuasiQuote (#7918)</span><span>
</span><a name="line-562"></a><span>
</span><a name="line-563"></a><span class="hs-comment">{- Note [Partial Type Splices]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Partial Type Signatures are partially supported in TH type splices: only
anonymous wild cards are allowed.

  -- ToDo: SLPJ says: I don't understand all this

Normally, named wild cards are collected before renaming a (partial) type
signature. However, TH type splices are run during renaming, i.e. after the
initial traversal, leading to out of scope errors for named wild cards. We
can't just extend the initial traversal to collect the named wild cards in TH
type splices, as we'd need to expand them, which is supposed to happen only
once, during renaming.

Similarly, the extra-constraints wild card is handled right before renaming
too, and is therefore also not supported in a TH type splice. Another reason
to forbid extra-constraints wild cards in TH type splices is that a single
signature can contain many TH type splices, whereas it mustn't contain more
than one extra-constraints wild card. Enforcing would this be hard the way
things are currently organised.

Anonymous wild cards pose no problem, because they start out without names and
are given names during renaming. These names are collected right after
renaming. The names generated for anonymous wild cards in TH type splices will
thus be collected as well.

For more details about renaming wild cards, see RnTypes.rnHsSigWcType

Note that partial type signatures are fully supported in TH declaration
splices, e.g.:

     [d| foo :: _ =&gt; _
         foo x y = x == y |]

This is because in this case, the partial type signature can be treated as a
whole signature, instead of as an arbitrary type.

-}</span><span>
</span><a name="line-601"></a><span>
</span><a name="line-602"></a><span>
</span><a name="line-603"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-604"></a><span class="hs-comment">-- | Rename a splice pattern. See Note [rnSplicePat]</span><span>
</span><a name="line-605"></a><span class="hs-identifier">rnSplicePat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsSplice</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Pat</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Pat</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span>
</span><a name="line-606"></a><span>                                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-607"></a><a name="rnSplicePat"><a href="RnSplice.html#rnSplicePat"><span class="hs-identifier">rnSplicePat</span></a></a><span> </span><a name="local-6989586621682336943"><a href="#local-6989586621682336943"><span class="hs-identifier">splice</span></a></a><span>
</span><a name="line-608"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnSplice.html#rnSpliceGen"><span class="hs-identifier hs-var">rnSpliceGen</span></a><span> </span><a href="#local-6989586621682336945"><span class="hs-identifier hs-var">run_pat_splice</span></a><span> </span><a href="#local-6989586621682336944"><span class="hs-identifier hs-var">pend_pat_splice</span></a><span> </span><a href="#local-6989586621682336943"><span class="hs-identifier hs-var">splice</span></a><span>
</span><a name="line-609"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-610"></a><span>    </span><span class="hs-identifier">pend_pat_splice</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsSplice</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-611"></a><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-type">PendingRnSplice</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><a href="#local-6989586621682336946"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Pat</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-612"></a><span>    </span><a name="local-6989586621682336944"><a href="#local-6989586621682336944"><span class="hs-identifier">pend_pat_splice</span></a></a><span> </span><a name="local-6989586621682336947"><a href="#local-6989586621682336947"><span class="hs-identifier">rn_splice</span></a></a><span>
</span><a name="line-613"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="RnSplice.html#makePending"><span class="hs-identifier hs-var">makePending</span></a><span> </span><span class="hs-identifier hs-var">UntypedPatSplice</span><span> </span><a href="#local-6989586621682336947"><span class="hs-identifier hs-var">rn_splice</span></a><span>
</span><a name="line-614"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SplicePat</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682336947"><span class="hs-identifier hs-var">rn_splice</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-615"></a><span>
</span><a name="line-616"></a><span>    </span><span class="hs-identifier">run_pat_splice</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsSplice</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-617"></a><span>                      </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Pat</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Pat</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-618"></a><span>    </span><a name="local-6989586621682336945"><a href="#local-6989586621682336945"><span class="hs-identifier">run_pat_splice</span></a></a><span> </span><a name="local-6989586621682336948"><a href="#local-6989586621682336948"><span class="hs-identifier">rn_splice</span></a></a><span>
</span><a name="line-619"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rnSplicePat: untyped pattern splice&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-620"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682336949"><a href="#local-6989586621682336949"><span class="hs-identifier">pat</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682336950"><a href="#local-6989586621682336950"><span class="hs-identifier">mod_finalizers</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-621"></a><span>                </span><a href="RnSplice.html#runRnSplice"><span class="hs-identifier hs-var">runRnSplice</span></a><span> </span><span class="hs-identifier hs-var">UntypedPatSplice</span><span> </span><a href="TcSplice.html#runMetaP"><span class="hs-identifier hs-var">runMetaP</span></a><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336948"><span class="hs-identifier hs-var">rn_splice</span></a><span>
</span><a name="line-622"></a><span>             </span><span class="hs-comment">-- See Note [Delaying modFinalizers in untyped splices].</span><span>
</span><a name="line-623"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ParPat</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">SplicePat</span><span> </span><span class="hs-identifier hs-var">noExt</span><span class="hs-special">)</span><span>
</span><a name="line-624"></a><span>                              </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">HsSpliced</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ThModFinalizers</span><span> </span><a href="#local-6989586621682336950"><span class="hs-identifier hs-var">mod_finalizers</span></a><span class="hs-special">)</span><span>
</span><a name="line-625"></a><span>                              </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">HsSplicedPat</span><span class="hs-special">)</span><span>  </span><span class="hs-special">`</span><span class="hs-identifier hs-var">onHasSrcSpan</span><span class="hs-special">`</span><span>
</span><a name="line-626"></a><span>                              </span><a href="#local-6989586621682336949"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-627"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span>
</span><a name="line-628"></a><span>                    </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-629"></a><span>              </span><span class="hs-comment">-- Wrap the result of the quasi-quoter in parens so that we don't</span><span>
</span><a name="line-630"></a><span>              </span><span class="hs-comment">-- lose the outermost location set by runQuasiQuote (#7918)</span><span>
</span><a name="line-631"></a><span>
</span><a name="line-632"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-633"></a><span class="hs-identifier">rnSpliceDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SpliceDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SpliceDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-634"></a><a name="rnSpliceDecl"><a href="RnSplice.html#rnSpliceDecl"><span class="hs-identifier">rnSpliceDecl</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SpliceDecl</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682336951"><a href="#local-6989586621682336951"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621682336952"><a href="#local-6989586621682336952"><span class="hs-identifier">splice</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682336953"><a href="#local-6989586621682336953"><span class="hs-identifier">flg</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-635"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnSplice.html#rnSpliceGen"><span class="hs-identifier hs-var">rnSpliceGen</span></a><span> </span><a href="#local-6989586621682336955"><span class="hs-identifier hs-var">run_decl_splice</span></a><span> </span><a href="#local-6989586621682336954"><span class="hs-identifier hs-var">pend_decl_splice</span></a><span> </span><a href="#local-6989586621682336952"><span class="hs-identifier hs-var">splice</span></a><span>
</span><a name="line-636"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-637"></a><span>    </span><a name="local-6989586621682336954"><a href="#local-6989586621682336954"><span class="hs-identifier">pend_decl_splice</span></a></a><span> </span><a name="local-6989586621682336956"><a href="#local-6989586621682336956"><span class="hs-identifier">rn_splice</span></a></a><span>
</span><a name="line-638"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="RnSplice.html#makePending"><span class="hs-identifier hs-var">makePending</span></a><span> </span><span class="hs-identifier hs-var">UntypedDeclSplice</span><span> </span><a href="#local-6989586621682336956"><span class="hs-identifier hs-var">rn_splice</span></a><span>
</span><a name="line-639"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SpliceDecl</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682336951"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621682336956"><span class="hs-identifier hs-var">rn_splice</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682336953"><span class="hs-identifier hs-var">flg</span></a><span class="hs-special">)</span><span>
</span><a name="line-640"></a><span>
</span><a name="line-641"></a><span>    </span><a name="local-6989586621682336955"><a href="#local-6989586621682336955"><span class="hs-identifier">run_decl_splice</span></a></a><span> </span><a name="local-6989586621682336957"><a href="#local-6989586621682336957"><span class="hs-identifier">rn_splice</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;rnSpliceDecl&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336957"><span class="hs-identifier hs-var">rn_splice</span></a><span class="hs-special">)</span><span>
</span><a name="line-642"></a><span class="hs-identifier">rnSpliceDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XSpliceDecl</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnSpliceDecl&quot;</span><span>
</span><a name="line-643"></a><span>
</span><a name="line-644"></a><span class="hs-identifier">rnTopSpliceDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsSplice</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-645"></a><span class="hs-comment">-- Declaration splice at the very top level of the module</span><span>
</span><a name="line-646"></a><a name="rnTopSpliceDecls"><a href="RnSplice.html#rnTopSpliceDecls"><span class="hs-identifier">rnTopSpliceDecls</span></a></a><span> </span><a name="local-6989586621682336958"><a href="#local-6989586621682336958"><span class="hs-identifier">splice</span></a></a><span>
</span><a name="line-647"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682336966"><a href="#local-6989586621682336966"><span class="hs-identifier">rn_splice</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682336967"><a href="#local-6989586621682336967"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-648"></a><span>                               </span><a href="TcRnMonad.html#setStage"><span class="hs-identifier hs-var">setStage</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Splice</span><span> </span><span class="hs-identifier hs-var">Untyped</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-649"></a><span>                               </span><a href="RnSplice.html#rnSplice"><span class="hs-identifier hs-var">rnSplice</span></a><span> </span><a href="#local-6989586621682336958"><span class="hs-identifier hs-var">splice</span></a><span>
</span><a name="line-650"></a><span>           </span><span class="hs-comment">-- As always, be sure to checkNoErrs above lest we end up with</span><span>
</span><a name="line-651"></a><span>           </span><span class="hs-comment">-- holes making it to typechecking, hence #12584.</span><span>
</span><a name="line-652"></a><span>           </span><span class="hs-comment">--</span><span>
</span><a name="line-653"></a><span>           </span><span class="hs-comment">-- Note that we cannot call checkNoErrs for the whole duration</span><span>
</span><a name="line-654"></a><span>           </span><span class="hs-comment">-- of rnTopSpliceDecls. The reason is that checkNoErrs changes</span><span>
</span><a name="line-655"></a><span>           </span><span class="hs-comment">-- the local environment to temporarily contain a new</span><span>
</span><a name="line-656"></a><span>           </span><span class="hs-comment">-- reference to store errors, and add_mod_finalizers would</span><span>
</span><a name="line-657"></a><span>           </span><span class="hs-comment">-- cause this reference to be stored after checkNoErrs finishes.</span><span>
</span><a name="line-658"></a><span>           </span><span class="hs-comment">-- This is checked by test TH_finalizer.</span><span>
</span><a name="line-659"></a><span>         </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rnTopSpliceDecls: untyped declaration splice&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-660"></a><span>         </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682336968"><a href="#local-6989586621682336968"><span class="hs-identifier">decls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682336969"><a href="#local-6989586621682336969"><span class="hs-identifier">mod_finalizers</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-661"></a><span>               </span><a href="RnSplice.html#runRnSplice"><span class="hs-identifier hs-var">runRnSplice</span></a><span> </span><span class="hs-identifier hs-var">UntypedDeclSplice</span><span> </span><a href="TcSplice.html#runMetaD"><span class="hs-identifier hs-var">runMetaD</span></a><span> </span><a href="#local-6989586621682336959"><span class="hs-identifier hs-var">ppr_decls</span></a><span> </span><a href="#local-6989586621682336966"><span class="hs-identifier hs-var">rn_splice</span></a><span>
</span><a name="line-662"></a><span>         </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621682336960"><span class="hs-identifier hs-var">add_mod_finalizers_now</span></a><span> </span><a href="#local-6989586621682336969"><span class="hs-identifier hs-var">mod_finalizers</span></a><span>
</span><a name="line-663"></a><span>         </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682336968"><span class="hs-identifier hs-var">decls</span></a><span class="hs-special">,</span><a href="#local-6989586621682336967"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-664"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-665"></a><span>     </span><span class="hs-identifier">ppr_decls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-666"></a><span>     </span><a name="local-6989586621682336959"><a href="#local-6989586621682336959"><span class="hs-identifier">ppr_decls</span></a></a><span> </span><a name="local-6989586621682336961"><a href="#local-6989586621682336961"><span class="hs-identifier">ds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336961"><span class="hs-identifier hs-var">ds</span></a><span class="hs-special">)</span><span>
</span><a name="line-667"></a><span>
</span><a name="line-668"></a><span>     </span><span class="hs-comment">-- Adds finalizers to the global environment instead of delaying them</span><span>
</span><a name="line-669"></a><span>     </span><span class="hs-comment">-- to the type checker.</span><span>
</span><a name="line-670"></a><span>     </span><span class="hs-comment">--</span><span>
</span><a name="line-671"></a><span>     </span><span class="hs-comment">-- Declaration splices do not have an interesting local environment so</span><span>
</span><a name="line-672"></a><span>     </span><span class="hs-comment">-- there is no point in delaying them.</span><span>
</span><a name="line-673"></a><span>     </span><span class="hs-comment">--</span><span>
</span><a name="line-674"></a><span>     </span><span class="hs-comment">-- See Note [Delaying modFinalizers in untyped splices].</span><span>
</span><a name="line-675"></a><span>     </span><span class="hs-identifier">add_mod_finalizers_now</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ForeignRef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TH.Q</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-676"></a><span>     </span><a name="local-6989586621682336960"><a href="#local-6989586621682336960"><span class="hs-identifier">add_mod_finalizers_now</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-677"></a><span>     </span><span class="hs-identifier">add_mod_finalizers_now</span><span> </span><a name="local-6989586621682336962"><a href="#local-6989586621682336962"><span class="hs-identifier">mod_finalizers</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-678"></a><span>       </span><a name="local-6989586621682336963"><a href="#local-6989586621682336963"><span class="hs-identifier">th_modfinalizers_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier">tcg_th_modfinalizers</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-679"></a><span>       </span><a name="local-6989586621682336964"><a href="#local-6989586621682336964"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span>
</span><a name="line-680"></a><span>       </span><a href="TcRnMonad.html#updTcRef"><span class="hs-identifier hs-var">updTcRef</span></a><span> </span><a href="#local-6989586621682336963"><span class="hs-identifier hs-var">th_modfinalizers_var</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682336965"><a href="#local-6989586621682336965"><span class="hs-identifier">fins</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-681"></a><span>         </span><span class="hs-special">(</span><a href="#local-6989586621682336964"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ThModFinalizers</span><span> </span><a href="#local-6989586621682336962"><span class="hs-identifier hs-var">mod_finalizers</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682336965"><span class="hs-identifier hs-var">fins</span></a><span>
</span><a name="line-682"></a><span>
</span><a name="line-683"></a><span>
</span><a name="line-684"></a><span class="hs-comment">{-
Note [rnSplicePat]
~~~~~~~~~~~~~~~~~~
Renaming a pattern splice is a bit tricky, because we need the variables
bound in the pattern to be in scope in the RHS of the pattern. This scope
management is effectively done by using continuation-passing style in
RnPat, through the CpsRn monad. We don't wish to be in that monad here
(it would create import cycles and generally conflict with renaming other
splices), so we really want to return a (Pat RdrName) -- the result of
running the splice -- which can then be further renamed in RnPat, in
the CpsRn monad.

The problem is that if we're renaming a splice within a bracket, we
*don't* want to run the splice now. We really do just want to rename
it to an HsSplice Name. Of course, then we can't know what variables
are bound within the splice. So we accept any unbound variables and
rename them again when the bracket is spliced in.  If a variable is brought
into scope by a pattern splice all is fine.  If it is not then an error is
reported.

In any case, when we're done in rnSplicePat, we'll either have a
Pat RdrName (the result of running a top-level splice) or a Pat Name
(the renamed nested splice). Thus, the awkward return type of
rnSplicePat.
-}</span><span>
</span><a name="line-709"></a><span>
</span><a name="line-710"></a><span class="hs-identifier">spliceCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsSplice</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-711"></a><a name="spliceCtxt"><a href="RnSplice.html#spliceCtxt"><span class="hs-identifier">spliceCtxt</span></a></a><span> </span><a name="local-6989586621682336970"><a href="#local-6989586621682336970"><span class="hs-identifier">splice</span></a></a><span>
</span><a name="line-712"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;In the&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621682336971"><span class="hs-identifier hs-var">what</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336970"><span class="hs-identifier hs-var">splice</span></a><span class="hs-special">)</span><span>
</span><a name="line-713"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-714"></a><span>    </span><a name="local-6989586621682336971"><a href="#local-6989586621682336971"><span class="hs-identifier">what</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682336970"><span class="hs-identifier hs-var">splice</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-715"></a><span>             </span><span class="hs-identifier hs-var">HsUntypedSplice</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;untyped splice:&quot;</span><span>
</span><a name="line-716"></a><span>             </span><span class="hs-identifier hs-var">HsTypedSplice</span><span>   </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;typed splice:&quot;</span><span>
</span><a name="line-717"></a><span>             </span><span class="hs-identifier hs-var">HsQuasiQuote</span><span>    </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;quasi-quotation:&quot;</span><span>
</span><a name="line-718"></a><span>             </span><span class="hs-identifier hs-var">HsSpliced</span><span>       </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;spliced expression:&quot;</span><span>
</span><a name="line-719"></a><span>             </span><span class="hs-identifier hs-var">HsSplicedT</span><span>      </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;spliced expression:&quot;</span><span>
</span><a name="line-720"></a><span>             </span><span class="hs-identifier hs-var">XSplice</span><span>         </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;spliced expression:&quot;</span><span>
</span><a name="line-721"></a><span>
</span><a name="line-722"></a><span class="hs-comment">-- | The splice data to be logged</span><span>
</span><a name="line-723"></a><span class="hs-keyword">data</span><span> </span><a name="SpliceInfo"><a href="RnSplice.html#SpliceInfo"><span class="hs-identifier">SpliceInfo</span></a></a><span>
</span><a name="line-724"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="SpliceInfo"><a href="RnSplice.html#SpliceInfo"><span class="hs-identifier">SpliceInfo</span></a></a><span>
</span><a name="line-725"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="spliceDescription"><a href="RnSplice.html#spliceDescription"><span class="hs-identifier">spliceDescription</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-726"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="spliceSource"><a href="RnSplice.html#spliceSource"><span class="hs-identifier">spliceSource</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Nothing &lt;=&gt; top-level decls</span><span>
</span><a name="line-727"></a><span>                                                  </span><span class="hs-comment">--        added by addTopDecls</span><span>
</span><a name="line-728"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="spliceIsDecl"><a href="RnSplice.html#spliceIsDecl"><span class="hs-identifier">spliceIsDecl</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>    </span><span class="hs-comment">-- True &lt;=&gt; put the generate code in a file</span><span>
</span><a name="line-729"></a><span>                                    </span><span class="hs-comment">--          when -dth-dec-file is on</span><span>
</span><a name="line-730"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="spliceGenerated"><a href="RnSplice.html#spliceGenerated"><span class="hs-identifier">spliceGenerated</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-731"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-732"></a><span>        </span><span class="hs-comment">-- Note that 'spliceSource' is *renamed* but not *typechecked*</span><span>
</span><a name="line-733"></a><span>        </span><span class="hs-comment">-- Reason (a) less typechecking crap</span><span>
</span><a name="line-734"></a><span>        </span><span class="hs-comment">--        (b) data constructors after type checking have been</span><span>
</span><a name="line-735"></a><span>        </span><span class="hs-comment">--            changed to their *wrappers*, and that makes them</span><span>
</span><a name="line-736"></a><span>        </span><span class="hs-comment">--            print always fully qualified</span><span>
</span><a name="line-737"></a><span>
</span><a name="line-738"></a><span class="hs-comment">-- | outputs splice information for 2 flags which have different output formats:</span><span>
</span><a name="line-739"></a><span class="hs-comment">-- `-ddump-splices` and `-dth-dec-file`</span><span>
</span><a name="line-740"></a><span class="hs-identifier">traceSplice</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RnSplice.html#SpliceInfo"><span class="hs-identifier hs-type">SpliceInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-741"></a><a name="traceSplice"><a href="RnSplice.html#traceSplice"><span class="hs-identifier">traceSplice</span></a></a><span> </span><span class="hs-special">(</span><a href="RnSplice.html#SpliceInfo"><span class="hs-identifier hs-var">SpliceInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">spliceDescription</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682336972"><a href="#local-6989586621682336972"><span class="hs-identifier">sd</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">spliceSource</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682336973"><a href="#local-6989586621682336973"><span class="hs-identifier">mb_src</span></a></a><span>
</span><a name="line-742"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">spliceGenerated</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682336974"><a href="#local-6989586621682336974"><span class="hs-identifier">gen</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">spliceIsDecl</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682336975"><a href="#local-6989586621682336975"><span class="hs-identifier">is_decl</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-743"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682336984"><a href="#local-6989586621682336984"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682336973"><span class="hs-identifier hs-var">mb_src</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-744"></a><span>                   </span><span class="hs-identifier hs-var">Nothing</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span>
</span><a name="line-745"></a><span>                   </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682336983"><a href="#local-6989586621682336983"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682336983"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-746"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceOptTcRn"><span class="hs-identifier hs-var">traceOptTcRn</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_splices</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682336976"><span class="hs-identifier hs-var">spliceDebugDoc</span></a><span> </span><a href="#local-6989586621682336984"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">)</span><span>
</span><a name="line-747"></a><span>
</span><a name="line-748"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621682336975"><span class="hs-identifier hs-var">is_decl</span></a><span> </span><span class="hs-operator hs-var">$</span><span>  </span><span class="hs-comment">-- Raw material for -dth-dec-file</span><span>
</span><a name="line-749"></a><span>         </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682336985"><a href="#local-6989586621682336985"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-750"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">dumpIfSet_dyn_printer</span><span> </span><span class="hs-identifier hs-var">alwaysQualify</span><span> </span><a href="#local-6989586621682336985"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_th_dec_file</span><span>
</span><a name="line-751"></a><span>                                             </span><span class="hs-special">(</span><a href="#local-6989586621682336977"><span class="hs-identifier hs-var">spliceCodeDoc</span></a><span> </span><a href="#local-6989586621682336984"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-752"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-753"></a><span>    </span><span class="hs-comment">-- `-ddump-splices`</span><span>
</span><a name="line-754"></a><span>    </span><span class="hs-identifier">spliceDebugDoc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-755"></a><span>    </span><a name="local-6989586621682336976"><a href="#local-6989586621682336976"><span class="hs-identifier">spliceDebugDoc</span></a></a><span> </span><a name="local-6989586621682336978"><a href="#local-6989586621682336978"><span class="hs-identifier">loc</span></a></a><span>
</span><a name="line-756"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682336979"><a href="#local-6989586621682336979"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682336973"><span class="hs-identifier hs-var">mb_src</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-757"></a><span>                     </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682336980"><span class="hs-identifier hs-var">ending</span></a><span>
</span><a name="line-758"></a><span>                     </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682336981"><a href="#local-6989586621682336981"><span class="hs-identifier">e</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336981"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682336980"><span class="hs-identifier hs-var">ending</span></a><span>
</span><a name="line-759"></a><span>            </span><a name="local-6989586621682336980"><a href="#local-6989586621682336980"><span class="hs-identifier">ending</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;======&gt;&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><a href="#local-6989586621682336974"><span class="hs-identifier hs-var">gen</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-760"></a><span>        </span><span class="hs-keyword">in</span><span>  </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336978"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">colon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Splicing&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621682336972"><span class="hs-identifier hs-var">sd</span></a><span class="hs-special">)</span><span>
</span><a name="line-761"></a><span>               </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sep</span><span> </span><a href="#local-6989586621682336979"><span class="hs-identifier hs-var">code</span></a><span class="hs-special">)</span><span>
</span><a name="line-762"></a><span>
</span><a name="line-763"></a><span>    </span><span class="hs-comment">-- `-dth-dec-file`</span><span>
</span><a name="line-764"></a><span>    </span><span class="hs-identifier">spliceCodeDoc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-765"></a><span>    </span><a name="local-6989586621682336977"><a href="#local-6989586621682336977"><span class="hs-identifier">spliceCodeDoc</span></a></a><span> </span><a name="local-6989586621682336982"><a href="#local-6989586621682336982"><span class="hs-identifier">loc</span></a></a><span>
</span><a name="line-766"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;--&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336982"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">colon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Splicing&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621682336972"><span class="hs-identifier hs-var">sd</span></a><span>
</span><a name="line-767"></a><span>             </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682336974"><span class="hs-identifier hs-var">gen</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-768"></a><span>
</span><a name="line-769"></a><span class="hs-identifier">illegalTypedSplice</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-770"></a><a name="illegalTypedSplice"><a href="RnSplice.html#illegalTypedSplice"><span class="hs-identifier">illegalTypedSplice</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Typed splices may not appear in untyped brackets&quot;</span><span>
</span><a name="line-771"></a><span>
</span><a name="line-772"></a><span class="hs-identifier">illegalUntypedSplice</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-773"></a><a name="illegalUntypedSplice"><a href="RnSplice.html#illegalUntypedSplice"><span class="hs-identifier">illegalUntypedSplice</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Untyped splices may not appear in typed brackets&quot;</span><span>
</span><a name="line-774"></a><span>
</span><a name="line-775"></a><span class="hs-identifier">checkThLocalName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-776"></a><a name="checkThLocalName"><a href="RnSplice.html#checkThLocalName"><span class="hs-identifier">checkThLocalName</span></a></a><span> </span><a name="local-6989586621682336986"><a href="#local-6989586621682336986"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-777"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isUnboundName</span><span> </span><a href="#local-6989586621682336986"><span class="hs-identifier hs-var">name</span></a><span>   </span><span class="hs-comment">-- Do not report two errors for</span><span>
</span><a name="line-778"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>            </span><span class="hs-comment">--   $(not_in_scope args)</span><span>
</span><a name="line-779"></a><span>
</span><a name="line-780"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-781"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;checkThLocalName&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336986"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-782"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682336987"><a href="#local-6989586621682336987"><span class="hs-identifier">mb_local_use</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getStageAndBindLevel"><span class="hs-identifier hs-var">getStageAndBindLevel</span></a><span> </span><a href="#local-6989586621682336986"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-783"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682336987"><span class="hs-identifier hs-var">mb_local_use</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-784"></a><span>             </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>  </span><span class="hs-comment">-- Not a locally-bound thing</span><span>
</span><a name="line-785"></a><span>             </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682336988"><a href="#local-6989586621682336988"><span class="hs-identifier">top_lvl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682336989"><a href="#local-6989586621682336989"><span class="hs-identifier">bind_lvl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682336990"><a href="#local-6989586621682336990"><span class="hs-identifier">use_stage</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-786"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682336991"><a href="#local-6989586621682336991"><span class="hs-identifier">use_lvl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">thLevel</span><span> </span><a href="#local-6989586621682336990"><span class="hs-identifier hs-var">use_stage</span></a><span>
</span><a name="line-787"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcEnv.html#checkWellStaged"><span class="hs-identifier hs-var">checkWellStaged</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336986"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682336989"><span class="hs-identifier hs-var">bind_lvl</span></a><span> </span><a href="#local-6989586621682336991"><span class="hs-identifier hs-var">use_lvl</span></a><span>
</span><a name="line-788"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;checkThLocalName&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336986"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336989"><span class="hs-identifier hs-var">bind_lvl</span></a><span>
</span><a name="line-789"></a><span>                                               </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336990"><span class="hs-identifier hs-var">use_stage</span></a><span>
</span><a name="line-790"></a><span>                                               </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336991"><span class="hs-identifier hs-var">use_lvl</span></a><span class="hs-special">)</span><span>
</span><a name="line-791"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="RnSplice.html#checkCrossStageLifting"><span class="hs-identifier hs-var">checkCrossStageLifting</span></a><span> </span><a href="#local-6989586621682336988"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621682336989"><span class="hs-identifier hs-var">bind_lvl</span></a><span> </span><a href="#local-6989586621682336990"><span class="hs-identifier hs-var">use_stage</span></a><span> </span><a href="#local-6989586621682336991"><span class="hs-identifier hs-var">use_lvl</span></a><span> </span><a href="#local-6989586621682336986"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-792"></a><span>
</span><a name="line-793"></a><span class="hs-comment">--------------------------------------</span><span>
</span><a name="line-794"></a><span class="hs-identifier">checkCrossStageLifting</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ThLevel</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ThStage</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ThLevel</span><span>
</span><a name="line-795"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-796"></a><span class="hs-comment">-- We are inside brackets, and (use_lvl &gt; bind_lvl)</span><span>
</span><a name="line-797"></a><span class="hs-comment">-- Now we must check whether there's a cross-stage lift to do</span><span>
</span><a name="line-798"></a><span class="hs-comment">-- Examples   \x -&gt; [| x |]</span><span>
</span><a name="line-799"></a><span class="hs-comment">--            [| map |]</span><span>
</span><a name="line-800"></a><span class="hs-comment">--</span><span>
</span><a name="line-801"></a><span class="hs-comment">-- This code is similar to checkCrossStageLifting in TcExpr, but</span><span>
</span><a name="line-802"></a><span class="hs-comment">-- this is only run on *untyped* brackets.</span><span>
</span><a name="line-803"></a><span>
</span><a name="line-804"></a><a name="checkCrossStageLifting"><a href="RnSplice.html#checkCrossStageLifting"><span class="hs-identifier">checkCrossStageLifting</span></a></a><span> </span><a name="local-6989586621682336992"><a href="#local-6989586621682336992"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621682336993"><a href="#local-6989586621682336993"><span class="hs-identifier">bind_lvl</span></a></a><span> </span><a name="local-6989586621682336994"><a href="#local-6989586621682336994"><span class="hs-identifier">use_stage</span></a></a><span> </span><a name="local-6989586621682336995"><a href="#local-6989586621682336995"><span class="hs-identifier">use_lvl</span></a></a><span> </span><a name="local-6989586621682336996"><a href="#local-6989586621682336996"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-805"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Brack</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RnPendingUntyped</span><span> </span><a name="local-6989586621682336997"><a href="#local-6989586621682336997"><span class="hs-identifier">ps_var</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682336994"><span class="hs-identifier hs-var">use_stage</span></a><span>   </span><span class="hs-comment">-- Only for untyped brackets</span><span>
</span><a name="line-806"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682336995"><span class="hs-identifier hs-var">use_lvl</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621682336993"><span class="hs-identifier hs-var">bind_lvl</span></a><span>                               </span><span class="hs-comment">-- Cross-stage condition</span><span>
</span><a name="line-807"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnSplice.html#check_cross_stage_lifting"><span class="hs-identifier hs-var">check_cross_stage_lifting</span></a><span> </span><a href="#local-6989586621682336992"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621682336996"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621682336997"><span class="hs-identifier hs-var">ps_var</span></a><span>
</span><a name="line-808"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-809"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-810"></a><span>
</span><a name="line-811"></a><span class="hs-identifier">check_cross_stage_lifting</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRef</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">PendingRnSplice</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-812"></a><a name="check_cross_stage_lifting"><a href="RnSplice.html#check_cross_stage_lifting"><span class="hs-identifier">check_cross_stage_lifting</span></a></a><span> </span><a name="local-6989586621682336998"><a href="#local-6989586621682336998"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621682336999"><a href="#local-6989586621682336999"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621682337000"><a href="#local-6989586621682337000"><span class="hs-identifier">ps_var</span></a></a><span>
</span><a name="line-813"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTopLevel</span><span> </span><a href="#local-6989586621682336998"><span class="hs-identifier hs-var">top_lvl</span></a><span>
</span><a name="line-814"></a><span>        </span><span class="hs-comment">-- Top-level identifiers in this module,</span><span>
</span><a name="line-815"></a><span>        </span><span class="hs-comment">-- (which have External Names)</span><span>
</span><a name="line-816"></a><span>        </span><span class="hs-comment">-- are just like the imported case:</span><span>
</span><a name="line-817"></a><span>        </span><span class="hs-comment">-- no need for the 'lifting' treatment</span><span>
</span><a name="line-818"></a><span>        </span><span class="hs-comment">-- E.g.  this is fine:</span><span>
</span><a name="line-819"></a><span>        </span><span class="hs-comment">--   f x = x</span><span>
</span><a name="line-820"></a><span>        </span><span class="hs-comment">--   g y = [| f 3 |]</span><span>
</span><a name="line-821"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isExternalName</span><span> </span><a href="#local-6989586621682336999"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#keepAlive"><span class="hs-identifier hs-var">keepAlive</span></a><span> </span><a href="#local-6989586621682336999"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-822"></a><span>    </span><span class="hs-comment">-- See Note [Keeping things alive for Template Haskell]</span><span>
</span><a name="line-823"></a><span>
</span><a name="line-824"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-825"></a><span>  </span><span class="hs-glyph">=</span><span>     </span><span class="hs-comment">-- Nested identifiers, such as 'x' in</span><span>
</span><a name="line-826"></a><span>        </span><span class="hs-comment">-- E.g. \x -&gt; [| h x |]</span><span>
</span><a name="line-827"></a><span>        </span><span class="hs-comment">-- We must behave as if the reference to x was</span><span>
</span><a name="line-828"></a><span>        </span><span class="hs-comment">--      h $(lift x)</span><span>
</span><a name="line-829"></a><span>        </span><span class="hs-comment">-- We use 'x' itself as the SplicePointName, used by</span><span>
</span><a name="line-830"></a><span>        </span><span class="hs-comment">-- the desugarer to stitch it all back together.</span><span>
</span><a name="line-831"></a><span>        </span><span class="hs-comment">-- If 'x' occurs many times we may get many identical</span><span>
</span><a name="line-832"></a><span>        </span><span class="hs-comment">-- bindings of the same SplicePointName, but that doesn't</span><span>
</span><a name="line-833"></a><span>        </span><span class="hs-comment">-- matter, although it's a mite untidy.</span><span>
</span><a name="line-834"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;checkCrossStageLifting&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682336999"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-835"></a><span>
</span><a name="line-836"></a><span>          </span><span class="hs-comment">-- Construct the (lift x) expression</span><span>
</span><a name="line-837"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682337001"><a href="#local-6989586621682337001"><span class="hs-identifier">lift_expr</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nlHsApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><a href="THNames.html#liftName"><span class="hs-identifier hs-var">liftName</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><a href="#local-6989586621682336999"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-838"></a><span>              </span><a name="local-6989586621682337002"><a href="#local-6989586621682337002"><span class="hs-identifier">pend_splice</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">PendingRnSplice</span><span> </span><span class="hs-identifier hs-var">UntypedExpSplice</span><span> </span><a href="#local-6989586621682336999"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621682337001"><span class="hs-identifier hs-var">lift_expr</span></a><span>
</span><a name="line-839"></a><span>
</span><a name="line-840"></a><span>          </span><span class="hs-comment">-- Update the pending splices</span><span>
</span><a name="line-841"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682337003"><a href="#local-6989586621682337003"><span class="hs-identifier">ps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readMutVar</span><span> </span><a href="#local-6989586621682337000"><span class="hs-identifier hs-var">ps_var</span></a><span>
</span><a name="line-842"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">writeMutVar</span><span> </span><a href="#local-6989586621682337000"><span class="hs-identifier hs-var">ps_var</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682337002"><span class="hs-identifier hs-var">pend_splice</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682337003"><span class="hs-identifier hs-var">ps</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-843"></a><span>
</span><a name="line-844"></a><span class="hs-comment">{-
Note [Keeping things alive for Template Haskell]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
  f x = x+1
  g y = [| f 3 |]

Here 'f' is referred to from inside the bracket, which turns into data
and mentions only f's *name*, not 'f' itself. So we need some other
way to keep 'f' alive, lest it get dropped as dead code.  That's what
keepAlive does. It puts it in the keep-alive set, which subsequently
ensures that 'f' stays as a top level binding.

This must be done by the renamer, not the type checker (as of old),
because the type checker doesn't typecheck the body of untyped
brackets (Trac #8540).

A thing can have a bind_lvl of outerLevel, but have an internal name:
   foo = [d| op = 3
             bop = op + 1 |]
Here the bind_lvl of 'op' is (bogusly) outerLevel, even though it is
bound inside a bracket.  That is because we don't even even record
binding levels for top-level things; the binding levels are in the
LocalRdrEnv.

So the occurrence of 'op' in the rhs of 'bop' looks a bit like a
cross-stage thing, but it isn't really.  And in fact we never need
to do anything here for top-level bound things, so all is fine, if
a bit hacky.

For these chaps (which have Internal Names) we don't want to put
them in the keep-alive set.

Note [Quoting names]
~~~~~~~~~~~~~~~~~~~~
A quoted name 'n is a bit like a quoted expression [| n |], except that we
have no cross-stage lifting (c.f. TcExpr.thBrackId).  So, after incrementing
the use-level to account for the brackets, the cases are:

        bind &gt; use                      Error
        bind = use+1                    OK
        bind &lt; use
                Imported things         OK
                Top-level things        OK
                Non-top-level           Error

where 'use' is the binding level of the 'n quote. (So inside the implied
bracket the level would be use+1.)

Examples:

  f 'map        -- OK; also for top-level defns of this module

  \x. f 'x      -- Not ok (bind = 1, use = 1)
                -- (whereas \x. f [| x |] might have been ok, by
                --                               cross-stage lifting

  \y. [| \x. $(f 'y) |] -- Not ok (bind =1, use = 1)

  [| \x. $(f 'x) |]     -- OK (bind = 2, use = 1)
-}</span><span>
</span><a name="line-905"></a></pre></body></html>