<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">TcCanonical</span><span class="hs-special">(</span><span>
</span><a name="line-4"></a><span>     </span><a href="TcCanonical.html#canonicalize"><span class="hs-identifier hs-var">canonicalize</span></a><span class="hs-special">,</span><span>
</span><a name="line-5"></a><span>     </span><a href="TcCanonical.html#unifyDerived"><span class="hs-identifier hs-var">unifyDerived</span></a><span class="hs-special">,</span><span>
</span><a name="line-6"></a><span>     </span><a href="TcCanonical.html#makeSuperClasses"><span class="hs-identifier hs-var">makeSuperClasses</span></a><span class="hs-special">,</span><span> </span><a href="TcCanonical.html#maybeSym"><span class="hs-identifier hs-var">maybeSym</span></a><span class="hs-special">,</span><span>
</span><a name="line-7"></a><span>     </span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="TcCanonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a><span class="hs-special">,</span><span> </span><a href="TcCanonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a><span class="hs-special">,</span><span>
</span><a name="line-8"></a><span>     </span><a href="TcCanonical.html#solveCallStack"><span class="hs-identifier hs-var">solveCallStack</span></a><span>    </span><span class="hs-comment">-- For TcSimplify</span><span>
</span><a name="line-9"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcRnTypes</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><a href="TcUnify.html"><span class="hs-identifier">TcUnify</span></a><span class="hs-special">(</span><span> </span><a href="TcUnify.html#swapOverTyVars"><span class="hs-identifier hs-var">swapOverTyVars</span></a><span class="hs-special">,</span><span> </span><a href="TcUnify.html#metaTyVarUpdateOK"><span class="hs-identifier hs-var">metaTyVarUpdateOK</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="TcFlatten.html"><span class="hs-identifier">TcFlatten</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="TcSMonad.html"><span class="hs-identifier">TcSMonad</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcEvidence</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="TcEvTerm.html"><span class="hs-identifier">TcEvTerm</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Class</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCoRep</span><span>   </span><span class="hs-comment">-- cleverly decomposes types, good for completeness checking</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Coercion</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreSyn</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">idType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkTemplateLocals</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FamInstEnv</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">FamInstEnvs</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="FamInst.html"><span class="hs-identifier">FamInst</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="FamInst.html#tcTopNormaliseNewTypeTF_maybe"><span class="hs-identifier hs-var">tcTopNormaliseNewTypeTF_maybe</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Var</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarEnv</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkInScopeSet</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarSet</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">delVarSetList</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameSet</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RdrName</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsTypes</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">HsIPName</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Pair</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Bag</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MonadUtils</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">zip4</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Bifunctor</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">bimap</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
*                      The Canonicaliser                               *
*                                                                      *
************************************************************************

Note [Canonicalization]
~~~~~~~~~~~~~~~~~~~~~~~

Canonicalization converts a simple constraint to a canonical form. It is
unary (i.e. treats individual constraints one at a time).

Constraints originating from user-written code come into being as
CNonCanonicals (except for CHoleCans, arising from holes). We know nothing
about these constraints. So, first:

     Classify CNonCanoncal constraints, depending on whether they
     are equalities, class predicates, or other.

Then proceed depending on the shape of the constraint. Generally speaking,
each constraint gets flattened and then decomposed into one of several forms
(see type Ct in TcRnTypes).

When an already-canonicalized constraint gets kicked out of the inert set,
it must be recanonicalized. But we know a bit about its shape from the
last time through, so we can skip the classification step.

-}</span><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span class="hs-comment">-- Top-level canonicalization</span><span>
</span><a name="line-82"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-83"></a><span>
</span><a name="line-84"></a><span class="hs-identifier">canonicalize</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span>
</span><a name="line-85"></a><a name="canonicalize"><a href="TcCanonical.html#canonicalize"><span class="hs-identifier">canonicalize</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CNonCanonical</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682864916"><a href="#local-6989586621682864916"><span class="hs-identifier">ev</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-86"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;canNC&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-87"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">classifyPredType</span><span> </span><a href="#local-6989586621682864917"><span class="hs-identifier hs-var">pred</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-88"></a><span>      </span><span class="hs-identifier hs-var">ClassPred</span><span> </span><a name="local-6989586621682864918"><a href="#local-6989586621682864918"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621682864919"><a href="#local-6989586621682864919"><span class="hs-identifier">tys</span></a></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;canEvNC:cls&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682864918"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682864919"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-89"></a><span>                                  </span><a href="TcCanonical.html#canClassNC"><span class="hs-identifier hs-var">canClassNC</span></a><span> </span><a href="#local-6989586621682864916"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682864918"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682864919"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-90"></a><span>      </span><span class="hs-identifier hs-var">EqPred</span><span> </span><a name="local-6989586621682864920"><a href="#local-6989586621682864920"><span class="hs-identifier">eq_rel</span></a></a><span> </span><a name="local-6989586621682864921"><a href="#local-6989586621682864921"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682864922"><a href="#local-6989586621682864922"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;canEvNC:eq&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682864921"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682864922"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">)</span><span>
</span><a name="line-91"></a><span>                                  </span><a href="TcCanonical.html#canEqNC"><span class="hs-identifier hs-var">canEqNC</span></a><span>    </span><a href="#local-6989586621682864916"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682864920"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><a href="#local-6989586621682864921"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682864922"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-92"></a><span>      </span><span class="hs-identifier hs-var">IrredPred</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;canEvNC:irred&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682864917"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span>
</span><a name="line-93"></a><span>                                  </span><a href="TcCanonical.html#canIrred"><span class="hs-identifier hs-var">canIrred</span></a><span> </span><a href="#local-6989586621682864916"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-94"></a><span>      </span><span class="hs-identifier hs-var">ForAllPred</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682864923"><a href="#local-6989586621682864923"><span class="hs-identifier">pred</span></a></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;canEvNC:forall&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682864923"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span>
</span><a name="line-95"></a><span>                                  </span><a href="TcCanonical.html#canForAll"><span class="hs-identifier hs-var">canForAll</span></a><span> </span><a href="#local-6989586621682864916"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isClassPred</span><span> </span><a href="#local-6989586621682864923"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span>
</span><a name="line-96"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-97"></a><span>    </span><a name="local-6989586621682864917"><a href="#local-6989586621682864917"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ctEvPred</span><span> </span><a href="#local-6989586621682864916"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-98"></a><span>
</span><a name="line-99"></a><span class="hs-identifier">canonicalize</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CQuantCan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">QCI</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">qci_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682864924"><a href="#local-6989586621682864924"><span class="hs-identifier">ev</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">qci_pend_sc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682864925"><a href="#local-6989586621682864925"><span class="hs-identifier">pend_sc</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-100"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#canForAll"><span class="hs-identifier hs-var">canForAll</span></a><span> </span><a href="#local-6989586621682864924"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682864925"><span class="hs-identifier hs-var">pend_sc</span></a><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span class="hs-identifier">canonicalize</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CIrredCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682864926"><a href="#local-6989586621682864926"><span class="hs-identifier">ev</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-103"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">EqPred</span><span> </span><a name="local-6989586621682864927"><a href="#local-6989586621682864927"><span class="hs-identifier">eq_rel</span></a></a><span> </span><a name="local-6989586621682864928"><a href="#local-6989586621682864928"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682864929"><a href="#local-6989586621682864929"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">classifyPredType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvPred</span><span> </span><a href="#local-6989586621682864926"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span>
</span><a name="line-104"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- For insolubles (all of which are equalities, do /not/ flatten the arguments</span><span>
</span><a name="line-105"></a><span>    </span><span class="hs-comment">-- In Trac #14350 doing so led entire-unnecessary and ridiculously large</span><span>
</span><a name="line-106"></a><span>    </span><span class="hs-comment">-- type function expansion.  Instead, canEqNC just applies</span><span>
</span><a name="line-107"></a><span>    </span><span class="hs-comment">-- the substitution to the predicate, and may do decomposition;</span><span>
</span><a name="line-108"></a><span>    </span><span class="hs-comment">--    e.g. a ~ [a], where [G] a ~ [Int], can decompose</span><span>
</span><a name="line-109"></a><span>    </span><a href="TcCanonical.html#canEqNC"><span class="hs-identifier hs-var">canEqNC</span></a><span> </span><a href="#local-6989586621682864926"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682864927"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><a href="#local-6989586621682864928"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682864929"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-110"></a><span>
</span><a name="line-111"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-112"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#canIrred"><span class="hs-identifier hs-var">canIrred</span></a><span> </span><a href="#local-6989586621682864926"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-113"></a><span>
</span><a name="line-114"></a><span class="hs-identifier">canonicalize</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CDictCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682864930"><a href="#local-6989586621682864930"><span class="hs-identifier">ev</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_class</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682864931"><a href="#local-6989586621682864931"><span class="hs-identifier">cls</span></a></a><span>
</span><a name="line-115"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682864932"><a href="#local-6989586621682864932"><span class="hs-identifier">xis</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_pend_sc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682864933"><a href="#local-6989586621682864933"><span class="hs-identifier">pend_sc</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-116"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;canClass&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-117"></a><span>    </span><a href="TcCanonical.html#canClass"><span class="hs-identifier hs-var">canClass</span></a><span> </span><a href="#local-6989586621682864930"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682864931"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682864932"><span class="hs-identifier hs-var">xis</span></a><span> </span><a href="#local-6989586621682864933"><span class="hs-identifier hs-var">pend_sc</span></a><span>
</span><a name="line-118"></a><span>
</span><a name="line-119"></a><span class="hs-identifier">canonicalize</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CTyEqCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682864934"><a href="#local-6989586621682864934"><span class="hs-identifier">ev</span></a></a><span>
</span><a name="line-120"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_tyvar</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682864935"><a href="#local-6989586621682864935"><span class="hs-identifier">tv</span></a></a><span>
</span><a name="line-121"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_rhs</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682864936"><a href="#local-6989586621682864936"><span class="hs-identifier">xi</span></a></a><span>
</span><a name="line-122"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_eq_rel</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682864937"><a href="#local-6989586621682864937"><span class="hs-identifier">eq_rel</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-123"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;canEqLeafTyVarEq&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-124"></a><span>    </span><a href="TcCanonical.html#canEqNC"><span class="hs-identifier hs-var">canEqNC</span></a><span> </span><a href="#local-6989586621682864934"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682864937"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621682864935"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682864936"><span class="hs-identifier hs-var">xi</span></a><span>
</span><a name="line-125"></a><span>      </span><span class="hs-comment">-- NB: Don't use canEqTyVar because that expects flattened types,</span><span>
</span><a name="line-126"></a><span>      </span><span class="hs-comment">-- and tv and xi may not be flat w.r.t. an updated inert set</span><span>
</span><a name="line-127"></a><span>
</span><a name="line-128"></a><span class="hs-identifier">canonicalize</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CFunEqCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682864938"><a href="#local-6989586621682864938"><span class="hs-identifier">ev</span></a></a><span>
</span><a name="line-129"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_fun</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682864939"><a href="#local-6989586621682864939"><span class="hs-identifier">fn</span></a></a><span>
</span><a name="line-130"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682864940"><a href="#local-6989586621682864940"><span class="hs-identifier">xis1</span></a></a><span>
</span><a name="line-131"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_fsk</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682864941"><a href="#local-6989586621682864941"><span class="hs-identifier">fsk</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-132"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;canEqLeafFunEq&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-133"></a><span>    </span><a href="TcCanonical.html#canCFunEqCan"><span class="hs-identifier hs-var">canCFunEqCan</span></a><span> </span><a href="#local-6989586621682864938"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682864939"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621682864940"><span class="hs-identifier hs-var">xis1</span></a><span> </span><a href="#local-6989586621682864941"><span class="hs-identifier hs-var">fsk</span></a><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span class="hs-identifier">canonicalize</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CHoleCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682864942"><a href="#local-6989586621682864942"><span class="hs-identifier">ev</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_hole</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682864943"><a href="#local-6989586621682864943"><span class="hs-identifier">hole</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-136"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#canHole"><span class="hs-identifier hs-var">canHole</span></a><span> </span><a href="#local-6989586621682864942"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682864943"><span class="hs-identifier hs-var">hole</span></a><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
*                      Class Canonicalization
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-145"></a><span>
</span><a name="line-146"></a><span class="hs-identifier">canClassNC</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span>
</span><a name="line-147"></a><span class="hs-comment">-- &quot;NC&quot; means &quot;non-canonical&quot;; that is, we have got here</span><span>
</span><a name="line-148"></a><span class="hs-comment">-- from a NonCanonical constraint, not from a CDictCan</span><span>
</span><a name="line-149"></a><span class="hs-comment">-- Precondition: EvVar is class evidence</span><span>
</span><a name="line-150"></a><a name="canClassNC"><a href="TcCanonical.html#canClassNC"><span class="hs-identifier">canClassNC</span></a></a><span> </span><a name="local-6989586621682864944"><a href="#local-6989586621682864944"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682864945"><a href="#local-6989586621682864945"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621682864946"><a href="#local-6989586621682864946"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-151"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isGiven</span><span> </span><a href="#local-6989586621682864944"><span class="hs-identifier hs-var">ev</span></a><span>  </span><span class="hs-comment">-- See Note [Eagerly expand given superclasses]</span><span>
</span><a name="line-152"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682864951"><a href="#local-6989586621682864951"><span class="hs-identifier">sc_cts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcCanonical.html#mkStrictSuperClasses"><span class="hs-identifier hs-var">mkStrictSuperClasses</span></a><span> </span><a href="#local-6989586621682864944"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621682864945"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682864946"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-153"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#emitWork"><span class="hs-identifier hs-var">emitWork</span></a><span> </span><a href="#local-6989586621682864951"><span class="hs-identifier hs-var">sc_cts</span></a><span>
</span><a name="line-154"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#canClass"><span class="hs-identifier hs-var">canClass</span></a><span> </span><a href="#local-6989586621682864944"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682864945"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682864946"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-155"></a><span>
</span><a name="line-156"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isWanted</span><span> </span><a href="#local-6989586621682864944"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-157"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682864952"><a href="#local-6989586621682864952"><span class="hs-identifier">ip_name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">isCallStackPred</span><span> </span><a href="#local-6989586621682864945"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682864946"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-158"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">OccurrenceOf</span><span> </span><a name="local-6989586621682864953"><a href="#local-6989586621682864953"><span class="hs-identifier">func</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ctLocOrigin</span><span> </span><a href="#local-6989586621682864948"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-159"></a><span>  </span><span class="hs-comment">-- If we're given a CallStack constraint that arose from a function</span><span>
</span><a name="line-160"></a><span>  </span><span class="hs-comment">-- call, we need to push the current call-site onto the stack instead</span><span>
</span><a name="line-161"></a><span>  </span><span class="hs-comment">-- of solving it directly from a given.</span><span>
</span><a name="line-162"></a><span>  </span><span class="hs-comment">-- See Note [Overview of implicit CallStacks] in TcEvidence</span><span>
</span><a name="line-163"></a><span>  </span><span class="hs-comment">-- and Note [Solving CallStack constraints] in TcSMonad</span><span>
</span><a name="line-164"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- First we emit a new constraint that will capture the</span><span>
</span><a name="line-165"></a><span>         </span><span class="hs-comment">-- given CallStack.</span><span>
</span><a name="line-166"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682864954"><a href="#local-6989586621682864954"><span class="hs-identifier">new_loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">setCtLocOrigin</span><span> </span><a href="#local-6989586621682864948"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IPOccOrigin</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIPName</span><span> </span><a href="#local-6989586621682864952"><span class="hs-identifier hs-var">ip_name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-167"></a><span>                            </span><span class="hs-comment">-- We change the origin to IPOccOrigin so</span><span>
</span><a name="line-168"></a><span>                            </span><span class="hs-comment">-- this rule does not fire again.</span><span>
</span><a name="line-169"></a><span>                            </span><span class="hs-comment">-- See Note [Overview of implicit CallStacks]</span><span>
</span><a name="line-170"></a><span>
</span><a name="line-171"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682864955"><a href="#local-6989586621682864955"><span class="hs-identifier">new_ev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#newWantedEvVarNC"><span class="hs-identifier hs-var">newWantedEvVarNC</span></a><span> </span><a href="#local-6989586621682864954"><span class="hs-identifier hs-var">new_loc</span></a><span> </span><a href="#local-6989586621682864949"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-172"></a><span>
</span><a name="line-173"></a><span>         </span><span class="hs-comment">-- Then we solve the wanted by pushing the call-site</span><span>
</span><a name="line-174"></a><span>         </span><span class="hs-comment">-- onto the newly emitted CallStack</span><span>
</span><a name="line-175"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682864956"><a href="#local-6989586621682864956"><span class="hs-identifier">ev_cs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">EvCsPushCall</span><span> </span><a href="#local-6989586621682864953"><span class="hs-identifier hs-var">func</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctLocSpan</span><span> </span><a href="#local-6989586621682864948"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvExpr</span><span> </span><a href="#local-6989586621682864955"><span class="hs-identifier hs-var">new_ev</span></a><span class="hs-special">)</span><span>
</span><a name="line-176"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#solveCallStack"><span class="hs-identifier hs-var">solveCallStack</span></a><span> </span><a href="#local-6989586621682864944"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682864956"><span class="hs-identifier hs-var">ev_cs</span></a><span>
</span><a name="line-177"></a><span>
</span><a name="line-178"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#canClass"><span class="hs-identifier hs-var">canClass</span></a><span> </span><a href="#local-6989586621682864955"><span class="hs-identifier hs-var">new_ev</span></a><span> </span><a href="#local-6989586621682864945"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682864946"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-181"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#canClass"><span class="hs-identifier hs-var">canClass</span></a><span> </span><a href="#local-6989586621682864944"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682864945"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682864946"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682864947"><span class="hs-identifier hs-var">has_scs</span></a><span> </span><a href="#local-6989586621682864945"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-182"></a><span>
</span><a name="line-183"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-184"></a><span>    </span><a name="local-6989586621682864947"><a href="#local-6989586621682864947"><span class="hs-identifier">has_scs</span></a></a><span> </span><a name="local-6989586621682864950"><a href="#local-6989586621682864950"><span class="hs-identifier">cls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">classSCTheta</span><span> </span><a href="#local-6989586621682864950"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-185"></a><span>    </span><a name="local-6989586621682864948"><a href="#local-6989586621682864948"><span class="hs-identifier">loc</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ctEvLoc</span><span> </span><a href="#local-6989586621682864944"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-186"></a><span>    </span><a name="local-6989586621682864949"><a href="#local-6989586621682864949"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ctEvPred</span><span> </span><a href="#local-6989586621682864944"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span class="hs-identifier">solveCallStack</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">EvCallStack</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-189"></a><span class="hs-comment">-- Also called from TcSimplify when defaulting call stacks</span><span>
</span><a name="line-190"></a><a name="solveCallStack"><a href="TcCanonical.html#solveCallStack"><span class="hs-identifier">solveCallStack</span></a></a><span> </span><a name="local-6989586621682864957"><a href="#local-6989586621682864957"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682864958"><a href="#local-6989586621682864958"><span class="hs-identifier">ev_cs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-191"></a><span>  </span><span class="hs-comment">-- We're given ev_cs :: CallStack, but the evidence term should be a</span><span>
</span><a name="line-192"></a><span>  </span><span class="hs-comment">-- dictionary, so we have to coerce ev_cs to a dictionary for</span><span>
</span><a name="line-193"></a><span>  </span><span class="hs-comment">-- `IP ip CallStack`. See Note [Overview of implicit CallStacks]</span><span>
</span><a name="line-194"></a><span>  </span><a name="local-6989586621682864959"><a href="#local-6989586621682864959"><span class="hs-identifier">cs_tm</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEvTerm.html#evCallStack"><span class="hs-identifier hs-var">evCallStack</span></a><span> </span><a href="#local-6989586621682864958"><span class="hs-identifier hs-var">ev_cs</span></a><span>
</span><a name="line-195"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682864960"><a href="#local-6989586621682864960"><span class="hs-identifier">ev_tm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkEvCast</span><span> </span><a href="#local-6989586621682864959"><span class="hs-identifier hs-var">cs_tm</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wrapIP</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvPred</span><span> </span><a href="#local-6989586621682864957"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-196"></a><span>  </span><a href="TcSMonad.html#setEvBindIfWanted"><span class="hs-identifier hs-var">setEvBindIfWanted</span></a><span> </span><a href="#local-6989586621682864957"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682864960"><span class="hs-identifier hs-var">ev_tm</span></a><span>
</span><a name="line-197"></a><span>
</span><a name="line-198"></a><span class="hs-identifier">canClass</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span>
</span><a name="line-199"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-200"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>            </span><span class="hs-comment">-- True &lt;=&gt; un-explored superclasses</span><span>
</span><a name="line-201"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span>
</span><a name="line-202"></a><span class="hs-comment">-- Precondition: EvVar is class evidence</span><span>
</span><a name="line-203"></a><span>
</span><a name="line-204"></a><a name="canClass"><a href="TcCanonical.html#canClass"><span class="hs-identifier">canClass</span></a></a><span> </span><a name="local-6989586621682864961"><a href="#local-6989586621682864961"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682864962"><a href="#local-6989586621682864962"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621682864963"><a href="#local-6989586621682864963"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-6989586621682864964"><a href="#local-6989586621682864964"><span class="hs-identifier">pend_sc</span></a></a><span>
</span><a name="line-205"></a><span>  </span><span class="hs-glyph">=</span><span>   </span><span class="hs-comment">-- all classes do *nominal* matching</span><span>
</span><a name="line-206"></a><span>    </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">ctEvRole</span><span> </span><span class="hs-identifier">ev</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">Nominal</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier hs-var">ev</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">cls</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-identifier hs-var">tys</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-207"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682864966"><a href="#local-6989586621682864966"><span class="hs-identifier">xis</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682864967"><a href="#local-6989586621682864967"><span class="hs-identifier">cos</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682864968"><a href="#local-6989586621682864968"><span class="hs-identifier">_kind_co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcFlatten.html#flattenArgsNom"><span class="hs-identifier hs-var">flattenArgsNom</span></a><span> </span><a href="#local-6989586621682864961"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682864965"><span class="hs-identifier hs-var">cls_tc</span></a><span> </span><a href="#local-6989586621682864963"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-208"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">MASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isTcReflCo</span><span> </span><span class="hs-identifier">_kind_co</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-209"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682864969"><a href="#local-6989586621682864969"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcTyConAppCo</span><span> </span><span class="hs-identifier hs-var">Nominal</span><span> </span><a href="#local-6989586621682864965"><span class="hs-identifier hs-var">cls_tc</span></a><span> </span><a href="#local-6989586621682864967"><span class="hs-identifier hs-var">cos</span></a><span>
</span><a name="line-210"></a><span>             </span><a name="local-6989586621682864970"><a href="#local-6989586621682864970"><span class="hs-identifier">xi</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkClassPred</span><span> </span><a href="#local-6989586621682864962"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682864966"><span class="hs-identifier hs-var">xis</span></a><span>
</span><a name="line-211"></a><span>             </span><a name="local-6989586621682864971"><a href="#local-6989586621682864971"><span class="hs-identifier">mk_ct</span></a></a><span> </span><a name="local-6989586621682864972"><a href="#local-6989586621682864972"><span class="hs-identifier">new_ev</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CDictCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682864972"><span class="hs-identifier hs-var">new_ev</span></a><span>
</span><a name="line-212"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682864966"><span class="hs-identifier hs-var">xis</span></a><span>
</span><a name="line-213"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_class</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682864962"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-214"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_pend_sc</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682864964"><span class="hs-identifier hs-var">pend_sc</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-215"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682864973"><a href="#local-6989586621682864973"><span class="hs-identifier">mb</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcCanonical.html#rewriteEvidence"><span class="hs-identifier hs-var">rewriteEvidence</span></a><span> </span><a href="#local-6989586621682864961"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682864970"><span class="hs-identifier hs-var">xi</span></a><span> </span><a href="#local-6989586621682864969"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-216"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;canClass&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682864961"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-217"></a><span>                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682864970"><span class="hs-identifier hs-var">xi</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682864973"><span class="hs-identifier hs-var">mb</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-218"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621682864971"><span class="hs-identifier hs-var">mk_ct</span></a><span> </span><a href="#local-6989586621682864973"><span class="hs-identifier hs-var">mb</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-219"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-220"></a><span>    </span><a name="local-6989586621682864965"><a href="#local-6989586621682864965"><span class="hs-identifier">cls_tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">classTyCon</span><span> </span><a href="#local-6989586621682864962"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span class="hs-comment">{- Note [The superclass story]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We need to add superclass constraints for two reasons:

* For givens [G], they give us a route to proof.  E.g.
    f :: Ord a =&gt; a -&gt; Bool
    f x = x == x
  We get a Wanted (Eq a), which can only be solved from the superclass
  of the Given (Ord a).

* For wanteds [W], and deriveds [WD], [D], they may give useful
  functional dependencies.  E.g.
     class C a b | a -&gt; b where ...
     class C a b =&gt; D a b where ...
  Now a [W] constraint (D Int beta) has (C Int beta) as a superclass
  and that might tell us about beta, via C's fundeps.  We can get this
  by generating a [D] (C Int beta) constraint.  It's derived because
  we don't actually have to cough up any evidence for it; it's only there
  to generate fundep equalities.

See Note [Why adding superclasses can help].

For these reasons we want to generate superclass constraints for both
Givens and Wanteds. But:

* (Minor) they are often not needed, so generating them aggressively
  is a waste of time.

* (Major) if we want recursive superclasses, there would be an infinite
  number of them.  Here is a real-life example (Trac #10318);

     class (Frac (Frac a) ~ Frac a,
            Fractional (Frac a),
            IntegralDomain (Frac a))
         =&gt; IntegralDomain a where
      type Frac a :: *

  Notice that IntegralDomain has an associated type Frac, and one
  of IntegralDomain's superclasses is another IntegralDomain constraint.

So here's the plan:

1. Eagerly generate superclasses for given (but not wanted)
   constraints; see Note [Eagerly expand given superclasses].
   This is done using mkStrictSuperClasses in canClassNC, when
   we take a non-canonical Given constraint and cannonicalise it.

   However stop if you encounter the same class twice.  That is,
   mkStrictSuperClasses expands eagerly, but has a conservative
   termination condition: see Note [Expanding superclasses] in TcType.

2. Solve the wanteds as usual, but do no further expansion of
   superclasses for canonical CDictCans in solveSimpleGivens or
   solveSimpleWanteds; Note [Danger of adding superclasses during solving]

   However, /do/ continue to eagerly expand superlasses for new /given/
   /non-canonical/ constraints (canClassNC does this).  As Trac #12175
   showed, a type-family application can expand to a class constraint,
   and we want to see its superclasses for just the same reason as
   Note [Eagerly expand given superclasses].

3. If we have any remaining unsolved wanteds
        (see Note [When superclasses help] in TcRnTypes)
   try harder: take both the Givens and Wanteds, and expand
   superclasses again.  See the calls to expandSuperClasses in
   TcSimplify.simpl_loop and solveWanteds.

   This may succeed in generating (a finite number of) extra Givens,
   and extra Deriveds. Both may help the proof.

3a An important wrinkle: only expand Givens from the current level.
   Two reasons:
      - We only want to expand it once, and that is best done at
        the level it is bound, rather than repeatedly at the leaves
        of the implication tree
      - We may be inside a type where we can't create term-level
        evidence anyway, so we can't superclass-expand, say,
        (a ~ b) to get (a ~# b).  This happened in Trac #15290.

4. Go round to (2) again.  This loop (2,3,4) is implemented
   in TcSimplify.simpl_loop.

The cc_pend_sc flag in a CDictCan records whether the superclasses of
this constraint have been expanded.  Specifically, in Step 3 we only
expand superclasses for constraints with cc_pend_sc set to true (i.e.
isPendingScDict holds).

Why do we do this?  Two reasons:

* To avoid repeated work, by repeatedly expanding the superclasses of
  same constraint,

* To terminate the above loop, at least in the -XNoRecursiveSuperClasses
  case.  If there are recursive superclasses we could, in principle,
  expand forever, always encountering new constraints.

When we take a CNonCanonical or CIrredCan, but end up classifying it
as a CDictCan, we set the cc_pend_sc flag to False.

Note [Superclass loops]
~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have
  class C a =&gt; D a
  class D a =&gt; C a

Then, when we expand superclasses, we'll get back to the self-same
predicate, so we have reached a fixpoint in expansion and there is no
point in fruitlessly expanding further.  This case just falls out from
our strategy.  Consider
  f :: C a =&gt; a -&gt; Bool
  f x = x==x
Then canClassNC gets the [G] d1: C a constraint, and eager emits superclasses
G] d2: D a, [G] d3: C a (psc).  (The &quot;psc&quot; means it has its sc_pend flag set.)
When processing d3 we find a match with d1 in the inert set, and we always
keep the inert item (d1) if possible: see Note [Replacement vs keeping] in
TcInteract.  So d3 dies a quick, happy death.

Note [Eagerly expand given superclasses]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In step (1) of Note [The superclass story], why do we eagerly expand
Given superclasses by one layer?  (By &quot;one layer&quot; we mean expand transitively
until you meet the same class again -- the conservative criterion embodied
in expandSuperClasses.  So a &quot;layer&quot; might be a whole stack of superclasses.)
We do this eagerly for Givens mainly because of some very obscure
cases like this:

   instance Bad a =&gt; Eq (T a)

   f :: (Ord (T a)) =&gt; blah
   f x = ....needs Eq (T a), Ord (T a)....

Here if we can't satisfy (Eq (T a)) from the givens we'll use the
instance declaration; but then we are stuck with (Bad a).  Sigh.
This is really a case of non-confluent proofs, but to stop our users
complaining we expand one layer in advance.

Note [Instance and Given overlap] in TcInteract.

We also want to do this if we have

   f :: F (T a) =&gt; blah

where
   type instance F (T a) = Ord (T a)

So we may need to do a little work on the givens to expose the
class that has the superclasses.  That's why the superclass
expansion for Givens happens in canClassNC.

Note [Why adding superclasses can help]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Examples of how adding superclasses can help:

    --- Example 1
        class C a b | a -&gt; b
    Suppose we want to solve
         [G] C a b
         [W] C a beta
    Then adding [D] beta~b will let us solve it.

    -- Example 2 (similar but using a type-equality superclass)
        class (F a ~ b) =&gt; C a b
    And try to sllve:
         [G] C a b
         [W] C a beta
    Follow the superclass rules to add
         [G] F a ~ b
         [D] F a ~ beta
    Now we get [D] beta ~ b, and can solve that.

    -- Example (tcfail138)
      class L a b | a -&gt; b
      class (G a, L a b) =&gt; C a b

      instance C a b' =&gt; G (Maybe a)
      instance C a b  =&gt; C (Maybe a) a
      instance L (Maybe a) a

    When solving the superclasses of the (C (Maybe a) a) instance, we get
      [G] C a b, and hance by superclasses, [G] G a, [G] L a b
      [W] G (Maybe a)
    Use the instance decl to get
      [W] C a beta
    Generate its derived superclass
      [D] L a beta.  Now using fundeps, combine with [G] L a b to get
      [D] beta ~ b
    which is what we want.

Note [Danger of adding superclasses during solving]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Here's a serious, but now out-dated example, from Trac #4497:

   class Num (RealOf t) =&gt; Normed t
   type family RealOf x

Assume the generated wanted constraint is:
   [W] RealOf e ~ e
   [W] Normed e

If we were to be adding the superclasses during simplification we'd get:
   [W] RealOf e ~ e
   [W] Normed e
   [D] RealOf e ~ fuv
   [D] Num fuv
==&gt;
   e := fuv, Num fuv, Normed fuv, RealOf fuv ~ fuv

While looks exactly like our original constraint. If we add the
superclass of (Normed fuv) again we'd loop.  By adding superclasses
definitely only once, during canonicalisation, this situation can't
happen.

Mind you, now that Wanteds cannot rewrite Derived, I think this particular
situation can't happen.
  -}</span><span>
</span><a name="line-437"></a><span>
</span><a name="line-438"></a><span class="hs-identifier">makeSuperClasses</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">]</span><span>
</span><a name="line-439"></a><span class="hs-comment">-- Returns strict superclasses, transitively, see Note [The superclasses story]</span><span>
</span><a name="line-440"></a><span class="hs-comment">-- See Note [The superclass story]</span><span>
</span><a name="line-441"></a><span class="hs-comment">-- The loop-breaking here follows Note [Expanding superclasses] in TcType</span><span>
</span><a name="line-442"></a><span class="hs-comment">-- Specifically, for an incoming (C t) constraint, we return all of (C t)'s</span><span>
</span><a name="line-443"></a><span class="hs-comment">--    superclasses, up to /and including/ the first repetition of C</span><span>
</span><a name="line-444"></a><span class="hs-comment">--</span><span>
</span><a name="line-445"></a><span class="hs-comment">-- Example:  class D a =&gt; C a</span><span>
</span><a name="line-446"></a><span class="hs-comment">--           class C [a] =&gt; D a</span><span>
</span><a name="line-447"></a><span class="hs-comment">-- makeSuperClasses (C x) will return (D x, C [x])</span><span>
</span><a name="line-448"></a><span class="hs-comment">--</span><span>
</span><a name="line-449"></a><span class="hs-comment">-- NB: the incoming constraints have had their cc_pend_sc flag already</span><span>
</span><a name="line-450"></a><span class="hs-comment">--     flipped to False, by isPendingScDict, so we are /obliged/ to at</span><span>
</span><a name="line-451"></a><span class="hs-comment">--     least produce the immediate superclasses</span><span>
</span><a name="line-452"></a><a name="makeSuperClasses"><a href="TcCanonical.html#makeSuperClasses"><span class="hs-identifier">makeSuperClasses</span></a></a><span> </span><a name="local-6989586621682864974"><a href="#local-6989586621682864974"><span class="hs-identifier">cts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMapM</span><span> </span><a href="#local-6989586621682864975"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682864974"><span class="hs-identifier hs-var">cts</span></a><span>
</span><a name="line-453"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-454"></a><span>    </span><a name="local-6989586621682864975"><a href="#local-6989586621682864975"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CDictCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682864976"><a href="#local-6989586621682864976"><span class="hs-identifier">ev</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_class</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682864977"><a href="#local-6989586621682864977"><span class="hs-identifier">cls</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682864978"><a href="#local-6989586621682864978"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-455"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#mkStrictSuperClasses"><span class="hs-identifier hs-var">mkStrictSuperClasses</span></a><span> </span><a href="#local-6989586621682864976"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621682864977"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682864978"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-456"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CQuantCan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">QCI</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">qci_pred</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682864979"><a href="#local-6989586621682864979"><span class="hs-identifier">pred</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">qci_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682864980"><a href="#local-6989586621682864980"><span class="hs-identifier">ev</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-457"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isClassPred</span><span> </span><span class="hs-identifier">pred</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-identifier">pred</span><span> </span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- The cts should all have</span><span>
</span><a name="line-458"></a><span>                                               </span><span class="hs-comment">-- class pred heads</span><span>
</span><a name="line-459"></a><span>        </span><a href="TcCanonical.html#mkStrictSuperClasses"><span class="hs-identifier hs-var">mkStrictSuperClasses</span></a><span> </span><a href="#local-6989586621682864980"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682864981"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621682864982"><span class="hs-identifier hs-var">theta</span></a><span> </span><a href="#local-6989586621682864983"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682864984"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-460"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-461"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621682864981"><a href="#local-6989586621682864981"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682864982"><a href="#local-6989586621682864982"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682864983"><a href="#local-6989586621682864983"><span class="hs-identifier">cls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682864984"><a href="#local-6989586621682864984"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitDFunTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvPred</span><span> </span><a href="#local-6989586621682864980"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span>
</span><a name="line-462"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682864985"><a href="#local-6989586621682864985"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;makeSuperClasses&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682864985"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-463"></a><span>
</span><a name="line-464"></a><span class="hs-identifier">mkStrictSuperClasses</span><span>
</span><a name="line-465"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span>
</span><a name="line-466"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ThetaType</span><span>  </span><span class="hs-comment">-- These two args are non-empty only when taking</span><span>
</span><a name="line-467"></a><span>                             </span><span class="hs-comment">-- superclasses of a /quantified/ constraint</span><span>
</span><a name="line-468"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">]</span><span>
</span><a name="line-469"></a><span class="hs-comment">-- Return constraints for the strict superclasses of</span><span>
</span><a name="line-470"></a><span class="hs-comment">--   ev :: forall as. theta =&gt; cls tys</span><span>
</span><a name="line-471"></a><a name="mkStrictSuperClasses"><a href="TcCanonical.html#mkStrictSuperClasses"><span class="hs-identifier">mkStrictSuperClasses</span></a></a><span> </span><a name="local-6989586621682864986"><a href="#local-6989586621682864986"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682864987"><a href="#local-6989586621682864987"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621682864988"><a href="#local-6989586621682864988"><span class="hs-identifier">theta</span></a></a><span> </span><a name="local-6989586621682864989"><a href="#local-6989586621682864989"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621682864990"><a href="#local-6989586621682864990"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-472"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#mk_strict_superclasses"><span class="hs-identifier hs-var">mk_strict_superclasses</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitNameSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">className</span><span> </span><a href="#local-6989586621682864989"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-473"></a><span>                           </span><a href="#local-6989586621682864986"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682864987"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621682864988"><span class="hs-identifier hs-var">theta</span></a><span> </span><a href="#local-6989586621682864989"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682864990"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-474"></a><span>
</span><a name="line-475"></a><span class="hs-identifier">mk_strict_superclasses</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span>
</span><a name="line-476"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ThetaType</span><span>
</span><a name="line-477"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">]</span><span>
</span><a name="line-478"></a><span class="hs-comment">-- Always return the immediate superclasses of (cls tys);</span><span>
</span><a name="line-479"></a><span class="hs-comment">-- and expand their superclasses, provided none of them are in rec_clss</span><span>
</span><a name="line-480"></a><span class="hs-comment">-- nor are repeated</span><span>
</span><a name="line-481"></a><a name="mk_strict_superclasses"><a href="TcCanonical.html#mk_strict_superclasses"><span class="hs-identifier">mk_strict_superclasses</span></a></a><span> </span><a name="local-6989586621682864991"><a href="#local-6989586621682864991"><span class="hs-identifier">rec_clss</span></a></a><span> </span><a name="local-6989586621682864992"><a href="#local-6989586621682864992"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682864993"><a href="#local-6989586621682864993"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621682864994"><a href="#local-6989586621682864994"><span class="hs-identifier">theta</span></a></a><span> </span><a name="local-6989586621682864995"><a href="#local-6989586621682864995"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621682864996"><a href="#local-6989586621682864996"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-482"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">CtGiven</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_evar</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682865013"><a href="#local-6989586621682865013"><span class="hs-identifier">evar</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ctev_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682865014"><a href="#local-6989586621682865014"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682864992"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-483"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMapM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682864999"><span class="hs-identifier hs-var">do_one_given</span></a><span> </span><a href="#local-6989586621682865013"><span class="hs-identifier hs-var">evar</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682865001"><span class="hs-identifier hs-var">mk_given_loc</span></a><span> </span><a href="#local-6989586621682865014"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-484"></a><span>    </span><span class="hs-identifier hs-var">classSCSelIds</span><span> </span><a href="#local-6989586621682864995"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-485"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-486"></a><span>    </span><a name="local-6989586621682864997"><a href="#local-6989586621682864997"><span class="hs-identifier">dict_ids</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTemplateLocals</span><span> </span><a href="#local-6989586621682864994"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-487"></a><span>    </span><a name="local-6989586621682864998"><a href="#local-6989586621682864998"><span class="hs-identifier">size</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sizeTypes</span><span> </span><a href="#local-6989586621682864996"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-488"></a><span>
</span><a name="line-489"></a><span>    </span><a name="local-6989586621682864999"><a href="#local-6989586621682864999"><span class="hs-identifier">do_one_given</span></a></a><span> </span><a name="local-6989586621682865002"><a href="#local-6989586621682865002"><span class="hs-identifier">evar</span></a></a><span> </span><a name="local-6989586621682865003"><a href="#local-6989586621682865003"><span class="hs-identifier">given_loc</span></a></a><span> </span><a name="local-6989586621682865004"><a href="#local-6989586621682865004"><span class="hs-identifier">sel_id</span></a></a><span>
</span><a name="line-490"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isUnliftedType</span><span> </span><a href="#local-6989586621682865005"><span class="hs-identifier hs-var">sc_pred</span></a><span>
</span><a name="line-491"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682864993"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682864994"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">)</span><span>
</span><a name="line-492"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- See Note [Equality superclasses in quantified constraints]</span><span>
</span><a name="line-493"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-494"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-495"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682865007"><a href="#local-6989586621682865007"><span class="hs-identifier">given_ev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#newGivenEvVar"><span class="hs-identifier hs-var">newGivenEvVar</span></a><span> </span><a href="#local-6989586621682865003"><span class="hs-identifier hs-var">given_loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-496"></a><span>                         </span><span class="hs-special">(</span><a href="#local-6989586621682865006"><span class="hs-identifier hs-var">given_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682865000"><span class="hs-identifier hs-var">mk_sc_sel</span></a><span> </span><a href="#local-6989586621682865002"><span class="hs-identifier hs-var">evar</span></a><span> </span><a href="#local-6989586621682865004"><span class="hs-identifier hs-var">sel_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-497"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#mk_superclasses"><span class="hs-identifier hs-var">mk_superclasses</span></a><span> </span><a href="#local-6989586621682864991"><span class="hs-identifier hs-var">rec_clss</span></a><span> </span><a href="#local-6989586621682865007"><span class="hs-identifier hs-var">given_ev</span></a><span> </span><a href="#local-6989586621682864993"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621682864994"><span class="hs-identifier hs-var">theta</span></a><span> </span><a href="#local-6989586621682865005"><span class="hs-identifier hs-var">sc_pred</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-498"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-499"></a><span>        </span><a name="local-6989586621682865005"><a href="#local-6989586621682865005"><span class="hs-identifier">sc_pred</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">funResultTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">piResultTys</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621682865004"><span class="hs-identifier hs-var">sel_id</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682864996"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-500"></a><span>        </span><a name="local-6989586621682865006"><a href="#local-6989586621682865006"><span class="hs-identifier">given_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkInfSigmaTy</span><span> </span><a href="#local-6989586621682864993"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621682864994"><span class="hs-identifier hs-var">theta</span></a><span> </span><a href="#local-6989586621682865005"><span class="hs-identifier hs-var">sc_pred</span></a><span>
</span><a name="line-501"></a><span>
</span><a name="line-502"></a><span>    </span><a name="local-6989586621682865000"><a href="#local-6989586621682865000"><span class="hs-identifier">mk_sc_sel</span></a></a><span> </span><a name="local-6989586621682865008"><a href="#local-6989586621682865008"><span class="hs-identifier">evar</span></a></a><span> </span><a name="local-6989586621682865009"><a href="#local-6989586621682865009"><span class="hs-identifier">sel_id</span></a></a><span>
</span><a name="line-503"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">EvExpr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkLams</span><span> </span><a href="#local-6989586621682864993"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkLams</span><span> </span><a href="#local-6989586621682864997"><span class="hs-identifier hs-var">dict_ids</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-504"></a><span>        </span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621682865009"><span class="hs-identifier hs-var">sel_id</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkTyApps</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682864996"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">App</span><span class="hs-special">`</span><span>
</span><a name="line-505"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">evId</span><span> </span><a href="#local-6989586621682865008"><span class="hs-identifier hs-var">evar</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkTyApps</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">mkTyVarTys</span><span> </span><a href="#local-6989586621682864993"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkVarApps</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682864997"><span class="hs-identifier hs-var">dict_ids</span></a><span class="hs-special">)</span><span>
</span><a name="line-506"></a><span>
</span><a name="line-507"></a><span>    </span><a name="local-6989586621682865001"><a href="#local-6989586621682865001"><span class="hs-identifier">mk_given_loc</span></a></a><span> </span><a name="local-6989586621682865010"><a href="#local-6989586621682865010"><span class="hs-identifier">loc</span></a></a><span>
</span><a name="line-508"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isCTupleClass</span><span> </span><a href="#local-6989586621682864995"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-509"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865010"><span class="hs-identifier hs-var">loc</span></a><span>   </span><span class="hs-comment">-- For tuple predicates, just take them apart, without</span><span>
</span><a name="line-510"></a><span>               </span><span class="hs-comment">-- adding their (large) size into the chain.  When we</span><span>
</span><a name="line-511"></a><span>               </span><span class="hs-comment">-- get down to a base predicate, we'll include its size.</span><span>
</span><a name="line-512"></a><span>               </span><span class="hs-comment">-- Trac #10335</span><span>
</span><a name="line-513"></a><span>
</span><a name="line-514"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">GivenOrigin</span><span> </span><a name="local-6989586621682865011"><a href="#local-6989586621682865011"><span class="hs-identifier">skol_info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ctLocOrigin</span><span> </span><a href="#local-6989586621682865010"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-515"></a><span>         </span><span class="hs-comment">-- See Note [Solving superclass constraints] in TcInstDcls</span><span>
</span><a name="line-516"></a><span>         </span><span class="hs-comment">-- for explantation of this transformation for givens</span><span>
</span><a name="line-517"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682865011"><span class="hs-identifier hs-var">skol_info</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-518"></a><span>            </span><span class="hs-identifier hs-var">InstSkol</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682865010"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctl_origin</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">GivenOrigin</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">InstSC</span><span> </span><a href="#local-6989586621682864998"><span class="hs-identifier hs-var">size</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-519"></a><span>            </span><span class="hs-identifier hs-var">InstSC</span><span> </span><a name="local-6989586621682865012"><a href="#local-6989586621682865012"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682865010"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctl_origin</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">GivenOrigin</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">InstSC</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682865012"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">max</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682864998"><span class="hs-identifier hs-var">size</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-520"></a><span>            </span><span class="hs-identifier">_</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682865010"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-521"></a><span>
</span><a name="line-522"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-comment">-- Probably doesn't happen, since this function</span><span>
</span><a name="line-523"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865010"><span class="hs-identifier hs-var">loc</span></a><span>        </span><span class="hs-comment">-- is only used for Givens, but does no harm</span><span>
</span><a name="line-524"></a><span>
</span><a name="line-525"></a><span class="hs-identifier">mk_strict_superclasses</span><span> </span><a name="local-6989586621682865015"><a href="#local-6989586621682865015"><span class="hs-identifier">rec_clss</span></a></a><span> </span><a name="local-6989586621682865016"><a href="#local-6989586621682865016"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865017"><a href="#local-6989586621682865017"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621682865018"><a href="#local-6989586621682865018"><span class="hs-identifier">theta</span></a></a><span> </span><a name="local-6989586621682865019"><a href="#local-6989586621682865019"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621682865020"><a href="#local-6989586621682865020"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-526"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-identifier hs-var">noFreeVarsOfType</span><span> </span><a href="#local-6989586621682865020"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-527"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- Wanteds with no variables yield no deriveds.</span><span>
</span><a name="line-528"></a><span>              </span><span class="hs-comment">-- See Note [Improvement from Ground Wanteds]</span><span>
</span><a name="line-529"></a><span>
</span><a name="line-530"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-comment">-- Wanted/Derived case, just add Derived superclasses</span><span>
</span><a name="line-531"></a><span>              </span><span class="hs-comment">-- that can lead to improvement.</span><span>
</span><a name="line-532"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">null</span><span> </span><span class="hs-identifier">tvs</span><span> </span><span class="hs-operator">&amp;&amp;</span><span> </span><span class="hs-identifier">null</span><span> </span><span class="hs-identifier">theta</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">tvs</span><span> </span><a href="#local-6989586621682865018"><span class="hs-operator hs-var">$$</span></a><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">theta</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-533"></a><span>    </span><span class="hs-identifier hs-var">concatMapM</span><span> </span><a href="#local-6989586621682865022"><span class="hs-identifier hs-var">do_one_derived</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">immSuperClasses</span><span> </span><a href="#local-6989586621682865019"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682865020"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-534"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-535"></a><span>    </span><a name="local-6989586621682865021"><a href="#local-6989586621682865021"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ctEvLoc</span><span> </span><a href="#local-6989586621682865016"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-536"></a><span>
</span><a name="line-537"></a><span>    </span><a name="local-6989586621682865022"><a href="#local-6989586621682865022"><span class="hs-identifier">do_one_derived</span></a></a><span> </span><a name="local-6989586621682865023"><a href="#local-6989586621682865023"><span class="hs-identifier">sc_pred</span></a></a><span>
</span><a name="line-538"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682865024"><a href="#local-6989586621682865024"><span class="hs-identifier">sc_ev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#newDerivedNC"><span class="hs-identifier hs-var">newDerivedNC</span></a><span> </span><a href="#local-6989586621682865021"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621682865023"><span class="hs-identifier hs-var">sc_pred</span></a><span>
</span><a name="line-539"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#mk_superclasses"><span class="hs-identifier hs-var">mk_superclasses</span></a><span> </span><a href="#local-6989586621682865015"><span class="hs-identifier hs-var">rec_clss</span></a><span> </span><a href="#local-6989586621682865024"><span class="hs-identifier hs-var">sc_ev</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621682865023"><span class="hs-identifier hs-var">sc_pred</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-540"></a><span>
</span><a name="line-541"></a><span class="hs-identifier">mk_superclasses</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span>
</span><a name="line-542"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ThetaType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PredType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">]</span><span>
</span><a name="line-543"></a><span class="hs-comment">-- Return this constraint, plus its superclasses, if any</span><span>
</span><a name="line-544"></a><a name="mk_superclasses"><a href="TcCanonical.html#mk_superclasses"><span class="hs-identifier">mk_superclasses</span></a></a><span> </span><a name="local-6989586621682865025"><a href="#local-6989586621682865025"><span class="hs-identifier">rec_clss</span></a></a><span> </span><a name="local-6989586621682865026"><a href="#local-6989586621682865026"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865027"><a href="#local-6989586621682865027"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621682865028"><a href="#local-6989586621682865028"><span class="hs-identifier">theta</span></a></a><span> </span><a name="local-6989586621682865029"><a href="#local-6989586621682865029"><span class="hs-identifier">pred</span></a></a><span>
</span><a name="line-545"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">ClassPred</span><span> </span><a name="local-6989586621682865030"><a href="#local-6989586621682865030"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621682865031"><a href="#local-6989586621682865031"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">classifyPredType</span><span> </span><a href="#local-6989586621682865029"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-546"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#mk_superclasses_of"><span class="hs-identifier hs-var">mk_superclasses_of</span></a><span> </span><a href="#local-6989586621682865025"><span class="hs-identifier hs-var">rec_clss</span></a><span> </span><a href="#local-6989586621682865026"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865027"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621682865028"><span class="hs-identifier hs-var">theta</span></a><span> </span><a href="#local-6989586621682865030"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682865031"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-547"></a><span>
</span><a name="line-548"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-comment">-- Superclass is not a class predicate</span><span>
</span><a name="line-549"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">mkNonCanonical</span><span> </span><a href="#local-6989586621682865026"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">]</span><span>
</span><a name="line-550"></a><span>
</span><a name="line-551"></a><span class="hs-identifier">mk_superclasses_of</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span>
</span><a name="line-552"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ThetaType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-553"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">]</span><span>
</span><a name="line-554"></a><span class="hs-comment">-- Always return this class constraint,</span><span>
</span><a name="line-555"></a><span class="hs-comment">-- and expand its superclasses</span><span>
</span><a name="line-556"></a><a name="mk_superclasses_of"><a href="TcCanonical.html#mk_superclasses_of"><span class="hs-identifier">mk_superclasses_of</span></a></a><span> </span><a name="local-6989586621682865032"><a href="#local-6989586621682865032"><span class="hs-identifier">rec_clss</span></a></a><span> </span><a name="local-6989586621682865033"><a href="#local-6989586621682865033"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865034"><a href="#local-6989586621682865034"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621682865035"><a href="#local-6989586621682865035"><span class="hs-identifier">theta</span></a></a><span> </span><a name="local-6989586621682865036"><a href="#local-6989586621682865036"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621682865037"><a href="#local-6989586621682865037"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-557"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682865039"><span class="hs-identifier hs-var">loop_found</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;mk_superclasses_of: loop&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865036"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865037"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-558"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682865041"><span class="hs-identifier hs-var">this_ct</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>  </span><span class="hs-comment">-- cc_pend_sc of this_ct = True</span><span>
</span><a name="line-559"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;mk_superclasses_of&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865036"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865037"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-560"></a><span>                                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isCTupleClass</span><span> </span><a href="#local-6989586621682865036"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-561"></a><span>                                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865032"><span class="hs-identifier hs-var">rec_clss</span></a><span>
</span><a name="line-562"></a><span>                                                          </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-563"></a><span>                    </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682865042"><a href="#local-6989586621682865042"><span class="hs-identifier">sc_cts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcCanonical.html#mk_strict_superclasses"><span class="hs-identifier hs-var">mk_strict_superclasses</span></a><span> </span><a href="#local-6989586621682865040"><span class="hs-identifier hs-var">rec_clss'</span></a><span> </span><a href="#local-6989586621682865033"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865034"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621682865035"><span class="hs-identifier hs-var">theta</span></a><span> </span><a href="#local-6989586621682865036"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682865037"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-564"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682865041"><span class="hs-identifier hs-var">this_ct</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682865042"><span class="hs-identifier hs-var">sc_cts</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-565"></a><span>                                   </span><span class="hs-comment">-- cc_pend_sc of this_ct = False</span><span>
</span><a name="line-566"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-567"></a><span>    </span><a name="local-6989586621682865038"><a href="#local-6989586621682865038"><span class="hs-identifier">cls_nm</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">className</span><span> </span><a href="#local-6989586621682865036"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-568"></a><span>    </span><a name="local-6989586621682865039"><a href="#local-6989586621682865039"><span class="hs-identifier">loop_found</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isCTupleClass</span><span> </span><a href="#local-6989586621682865036"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621682865038"><span class="hs-identifier hs-var">cls_nm</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865032"><span class="hs-identifier hs-var">rec_clss</span></a><span>
</span><a name="line-569"></a><span>                 </span><span class="hs-comment">-- Tuples never contribute to recursion, and can be nested</span><span>
</span><a name="line-570"></a><span>    </span><a name="local-6989586621682865040"><a href="#local-6989586621682865040"><span class="hs-identifier">rec_clss'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865032"><span class="hs-identifier hs-var">rec_clss</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">extendNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865038"><span class="hs-identifier hs-var">cls_nm</span></a><span>
</span><a name="line-571"></a><span>
</span><a name="line-572"></a><span>    </span><a name="local-6989586621682865041"><a href="#local-6989586621682865041"><span class="hs-identifier">this_ct</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682865034"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682865035"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-573"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CDictCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865033"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_class</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865036"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865037"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-574"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_pend_sc</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865039"><span class="hs-identifier hs-var">loop_found</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-575"></a><span>                 </span><span class="hs-comment">-- NB: If there is a loop, we cut off, so we have not</span><span>
</span><a name="line-576"></a><span>                 </span><span class="hs-comment">--     added the superclasses, hence cc_pend_sc = True</span><span>
</span><a name="line-577"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-578"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CQuantCan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">QCI</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">qci_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865034"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">qci_pred</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkClassPred</span><span> </span><a href="#local-6989586621682865036"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682865037"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-579"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">qci_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865033"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-580"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">qci_pend_sc</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865039"><span class="hs-identifier hs-var">loop_found</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-581"></a><span>
</span><a name="line-582"></a><span>
</span><a name="line-583"></a><span class="hs-comment">{- Note [Equality superclasses in quantified constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider (Trac #15359, #15593, #15625)
  f :: (forall a. theta =&gt; a ~ b) =&gt; stuff

It's a bit odd to have a local, quantified constraint for `(a~b)`,
but some people want such a thing (see the tickets). And for
Coercible it is definitely useful
  f :: forall m. (forall p q. Coercible p q =&gt; Coercible (m p) (m q)))
                 =&gt; stuff

Moreover it's not hard to arrange; we just need to look up /equality/
constraints in the quantified-constraint environment, which we do in
TcInteract.doTopReactOther.

There is a wrinkle though, in the case where 'theta' is empty, so
we have
  f :: (forall a. a~b) =&gt; stuff

Now, potentially, the superclass machinery kicks in, in
makeSuperClasses, giving us a a second quantified constrait
       (forall a. a ~# b)
BUT this is an unboxed value!  And nothing has prepared us for
dictionary &quot;functions&quot; that are unboxed.  Actually it does just
about work, but the simplier ends up with stuff like
   case (/\a. eq_sel d) of df -&gt; ...(df @Int)...
and fails to simplify that any further.  And it doesn't satisfy
isPredTy any more.

So for now we simply decline to take superclasses in the quantified
case.  Instead we have a special case in TcInteract.doTopReactOther,
which looks for primitive equalities specially in the quantified
constraints.

See also Note [Evidence for quantified constraints] in Type.


************************************************************************
*                                                                      *
*                      Irreducibles canonicalization
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-626"></a><span>
</span><a name="line-627"></a><span class="hs-identifier">canIrred</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span>
</span><a name="line-628"></a><span class="hs-comment">-- Precondition: ty not a tuple and no other evidence form</span><span>
</span><a name="line-629"></a><a name="canIrred"><a href="TcCanonical.html#canIrred"><span class="hs-identifier">canIrred</span></a></a><span> </span><a name="local-6989586621682865043"><a href="#local-6989586621682865043"><span class="hs-identifier">ev</span></a></a><span>
</span><a name="line-630"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682865044"><a href="#local-6989586621682865044"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ctEvPred</span><span> </span><a href="#local-6989586621682865043"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-631"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;can_pred&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;IrredPred = &quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865044"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span>
</span><a name="line-632"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865045"><a href="#local-6989586621682865045"><span class="hs-identifier">xi</span></a></a><span class="hs-special">,</span><a name="local-6989586621682865046"><a href="#local-6989586621682865046"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcFlatten.html#flatten"><span class="hs-identifier hs-var">flatten</span></a><span> </span><a href="TcFlatten.html#FM_FlattenAll"><span class="hs-identifier hs-var">FM_FlattenAll</span></a><span> </span><a href="#local-6989586621682865043"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865044"><span class="hs-identifier hs-var">pred</span></a><span> </span><span class="hs-comment">-- co :: xi ~ pred</span><span>
</span><a name="line-633"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#rewriteEvidence"><span class="hs-identifier hs-var">rewriteEvidence</span></a><span> </span><a href="#local-6989586621682865043"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865045"><span class="hs-identifier hs-var">xi</span></a><span> </span><a href="#local-6989586621682865046"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">`</span><a href="TcCanonical.html#andWhenContinue"><span class="hs-identifier hs-var">andWhenContinue</span></a><span class="hs-special">`</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682865047"><a href="#local-6989586621682865047"><span class="hs-identifier">new_ev</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-634"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Re-classify, in case flattening has improved its shape</span><span>
</span><a name="line-635"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">classifyPredType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvPred</span><span> </span><a href="#local-6989586621682865047"><span class="hs-identifier hs-var">new_ev</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-636"></a><span>           </span><span class="hs-identifier hs-var">ClassPred</span><span> </span><a name="local-6989586621682865048"><a href="#local-6989586621682865048"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621682865049"><a href="#local-6989586621682865049"><span class="hs-identifier">tys</span></a></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcCanonical.html#canClassNC"><span class="hs-identifier hs-var">canClassNC</span></a><span> </span><a href="#local-6989586621682865047"><span class="hs-identifier hs-var">new_ev</span></a><span> </span><a href="#local-6989586621682865048"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682865049"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-637"></a><span>           </span><span class="hs-identifier hs-var">EqPred</span><span> </span><a name="local-6989586621682865050"><a href="#local-6989586621682865050"><span class="hs-identifier">eq_rel</span></a></a><span> </span><a name="local-6989586621682865051"><a href="#local-6989586621682865051"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865052"><a href="#local-6989586621682865052"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcCanonical.html#canEqNC"><span class="hs-identifier hs-var">canEqNC</span></a><span> </span><a href="#local-6989586621682865047"><span class="hs-identifier hs-var">new_ev</span></a><span> </span><a href="#local-6989586621682865050"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><a href="#local-6989586621682865051"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865052"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-638"></a><span>           </span><span class="hs-identifier">_</span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcCanonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-639"></a><span>                                    </span><span class="hs-identifier hs-var">mkIrredCt</span><span> </span><a href="#local-6989586621682865047"><span class="hs-identifier hs-var">new_ev</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-640"></a><span>
</span><a name="line-641"></a><span class="hs-identifier">canHole</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hole</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span>
</span><a name="line-642"></a><a name="canHole"><a href="TcCanonical.html#canHole"><span class="hs-identifier">canHole</span></a></a><span> </span><a name="local-6989586621682865053"><a href="#local-6989586621682865053"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865054"><a href="#local-6989586621682865054"><span class="hs-identifier">hole</span></a></a><span>
</span><a name="line-643"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682865055"><a href="#local-6989586621682865055"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ctEvPred</span><span> </span><a href="#local-6989586621682865053"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-644"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865056"><a href="#local-6989586621682865056"><span class="hs-identifier">xi</span></a></a><span class="hs-special">,</span><a name="local-6989586621682865057"><a href="#local-6989586621682865057"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcFlatten.html#flatten"><span class="hs-identifier hs-var">flatten</span></a><span> </span><a href="TcFlatten.html#FM_SubstOnly"><span class="hs-identifier hs-var">FM_SubstOnly</span></a><span> </span><a href="#local-6989586621682865053"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865055"><span class="hs-identifier hs-var">pred</span></a><span> </span><span class="hs-comment">-- co :: xi ~ pred</span><span>
</span><a name="line-645"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#rewriteEvidence"><span class="hs-identifier hs-var">rewriteEvidence</span></a><span> </span><a href="#local-6989586621682865053"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865056"><span class="hs-identifier hs-var">xi</span></a><span> </span><a href="#local-6989586621682865057"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">`</span><a href="TcCanonical.html#andWhenContinue"><span class="hs-identifier hs-var">andWhenContinue</span></a><span class="hs-special">`</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682865058"><a href="#local-6989586621682865058"><span class="hs-identifier">new_ev</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-646"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#updInertIrreds"><span class="hs-identifier hs-var">updInertIrreds</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">snocCts</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CHoleCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865058"><span class="hs-identifier hs-var">new_ev</span></a><span>
</span><a name="line-647"></a><span>                                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_hole</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865054"><span class="hs-identifier hs-var">hole</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-648"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a><span> </span><a href="#local-6989586621682865058"><span class="hs-identifier hs-var">new_ev</span></a><span> </span><span class="hs-string">&quot;Emit insoluble hole&quot;</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-649"></a><span>
</span><a name="line-650"></a><span>
</span><a name="line-651"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
*                      Quantified predicates
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-656"></a><span>
</span><a name="line-657"></a><span class="hs-comment">{- Note [Quantified constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The -XQuantifiedConstraints extension allows type-class contexts like this:

  data Rose f x = Rose x (f (Rose f x))

  instance (Eq a, forall b. Eq b =&gt; Eq (f b))
        =&gt; Eq (Rose f a)  where
    (Rose x1 rs1) == (Rose x2 rs2) = x1==x2 &amp;&amp; rs1 == rs2

Note the (forall b. Eq b =&gt; Eq (f b)) in the instance contexts.
This quantified constraint is needed to solve the
 [W] (Eq (f (Rose f x)))
constraint which arises form the (==) definition.

The wiki page is
  https://ghc.haskell.org/trac/ghc/wiki/QuantifiedConstraints
which in turn contains a link to the GHC Proposal where the change
is specified, and a Haskell Symposium paper about it.

We implement two main extensions to the design in the paper:

 1. We allow a variable in the instance head, e.g.
      f :: forall m a. (forall b. m b) =&gt; D (m a)
    Notice the 'm' in the head of the quantified constraint, not
    a class.

 2. We suport superclasses to quantified constraints.
    For example (contrived):
      f :: (Ord b, forall b. Ord b =&gt; Ord (m b)) =&gt; m a -&gt; m a -&gt; Bool
      f x y = x==y
    Here we need (Eq (m a)); but the quantifed constraint deals only
    with Ord.  But we can make it work by using its superclass.

Here are the moving parts
  * Language extension {-# LANGUAGE QuantifiedConstraints #-}
    and add it to ghc-boot-th:GHC.LanguageExtensions.Type.Extension

  * A new form of evidence, EvDFun, that is used to discharge
    such wanted constraints

  * checkValidType gets some changes to accept forall-constraints
    only in the right places.

  * Type.PredTree gets a new constructor ForAllPred, and
    and classifyPredType analyses a PredType to decompose
    the new forall-constraints

  * TcSMonad.InertCans gets an extra field, inert_insts,
    which holds all the Given forall-constraints.  In effect,
    such Given constraints are like local instance decls.

  * When trying to solve a class constraint, via
    TcInteract.matchInstEnv, use the InstEnv from inert_insts
    so that we include the local Given forall-constraints
    in the lookup.  (See TcSMonad.getInstEnvs.)

  * TcCanonical.canForAll deals with solving a
    forall-constraint.  See
       Note [Solving a Wanted forall-constraint]

  * We augment the kick-out code to kick out an inert
    forall constraint if it can be rewritten by a new
    type equality; see TcSMonad.kick_out_rewritable

Note that a quantified constraint is never /inferred/
(by TcSimplify.simplifyInfer).  A function can only have a
quantified constraint in its type if it is given an explicit
type signature.

Note that we implement
-}</span><span>
</span><a name="line-729"></a><span>
</span><a name="line-730"></a><span class="hs-identifier">canForAll</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span>
</span><a name="line-731"></a><span class="hs-comment">-- We have a constraint (forall as. blah =&gt; C tys)</span><span>
</span><a name="line-732"></a><a name="canForAll"><a href="TcCanonical.html#canForAll"><span class="hs-identifier">canForAll</span></a></a><span> </span><a name="local-6989586621682865059"><a href="#local-6989586621682865059"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865060"><a href="#local-6989586621682865060"><span class="hs-identifier">pend_sc</span></a></a><span>
</span><a name="line-733"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- First rewrite it to apply the current substitution</span><span>
</span><a name="line-734"></a><span>         </span><span class="hs-comment">-- Do not bother with type-family reductions; we can't</span><span>
</span><a name="line-735"></a><span>         </span><span class="hs-comment">-- do them under a forall anyway (c.f. Flatten.flatten_one</span><span>
</span><a name="line-736"></a><span>         </span><span class="hs-comment">-- on a forall type)</span><span>
</span><a name="line-737"></a><span>         </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682865061"><a href="#local-6989586621682865061"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ctEvPred</span><span> </span><a href="#local-6989586621682865059"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-738"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865062"><a href="#local-6989586621682865062"><span class="hs-identifier">xi</span></a></a><span class="hs-special">,</span><a name="local-6989586621682865063"><a href="#local-6989586621682865063"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcFlatten.html#flatten"><span class="hs-identifier hs-var">flatten</span></a><span> </span><a href="TcFlatten.html#FM_SubstOnly"><span class="hs-identifier hs-var">FM_SubstOnly</span></a><span> </span><a href="#local-6989586621682865059"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865061"><span class="hs-identifier hs-var">pred</span></a><span> </span><span class="hs-comment">-- co :: xi ~ pred</span><span>
</span><a name="line-739"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#rewriteEvidence"><span class="hs-identifier hs-var">rewriteEvidence</span></a><span> </span><a href="#local-6989586621682865059"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865062"><span class="hs-identifier hs-var">xi</span></a><span> </span><a href="#local-6989586621682865063"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">`</span><a href="TcCanonical.html#andWhenContinue"><span class="hs-identifier hs-var">andWhenContinue</span></a><span class="hs-special">`</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682865064"><a href="#local-6989586621682865064"><span class="hs-identifier">new_ev</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-740"></a><span>
</span><a name="line-741"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Now decompose into its pieces and solve it</span><span>
</span><a name="line-742"></a><span>         </span><span class="hs-comment">-- (It takes a lot less code to flatten before decomposing.)</span><span>
</span><a name="line-743"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">classifyPredType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvPred</span><span> </span><a href="#local-6989586621682865064"><span class="hs-identifier hs-var">new_ev</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-744"></a><span>           </span><span class="hs-identifier hs-var">ForAllPred</span><span> </span><a name="local-6989586621682865065"><a href="#local-6989586621682865065"><span class="hs-identifier">tv_bndrs</span></a></a><span> </span><a name="local-6989586621682865066"><a href="#local-6989586621682865066"><span class="hs-identifier">theta</span></a></a><span> </span><a name="local-6989586621682865067"><a href="#local-6989586621682865067"><span class="hs-identifier">pred</span></a></a><span>
</span><a name="line-745"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcCanonical.html#solveForAll"><span class="hs-identifier hs-var">solveForAll</span></a><span> </span><a href="#local-6989586621682865064"><span class="hs-identifier hs-var">new_ev</span></a><span> </span><a href="#local-6989586621682865065"><span class="hs-identifier hs-var">tv_bndrs</span></a><span> </span><a href="#local-6989586621682865066"><span class="hs-identifier hs-var">theta</span></a><span> </span><a href="#local-6989586621682865067"><span class="hs-identifier hs-var">pred</span></a><span> </span><a href="#local-6989586621682865060"><span class="hs-identifier hs-var">pend_sc</span></a><span>
</span><a name="line-746"></a><span>           </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;canForAll&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865064"><span class="hs-identifier hs-var">new_ev</span></a><span class="hs-special">)</span><span>
</span><a name="line-747"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-748"></a><span>
</span><a name="line-749"></a><span class="hs-identifier">solveForAll</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVarBinder</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcThetaType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PredType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-750"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span>
</span><a name="line-751"></a><a name="solveForAll"><a href="TcCanonical.html#solveForAll"><span class="hs-identifier">solveForAll</span></a></a><span> </span><a name="local-6989586621682865068"><a href="#local-6989586621682865068"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865069"><a href="#local-6989586621682865069"><span class="hs-identifier">tv_bndrs</span></a></a><span> </span><a name="local-6989586621682865070"><a href="#local-6989586621682865070"><span class="hs-identifier">theta</span></a></a><span> </span><a name="local-6989586621682865071"><a href="#local-6989586621682865071"><span class="hs-identifier">pred</span></a></a><span> </span><a name="local-6989586621682865072"><a href="#local-6989586621682865072"><span class="hs-identifier">pend_sc</span></a></a><span>
</span><a name="line-752"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">CtWanted</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_dest</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682865076"><a href="#local-6989586621682865076"><span class="hs-identifier">dest</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682865068"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-753"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- See Note [Solving a Wanted forall-constraint]</span><span>
</span><a name="line-754"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682865077"><a href="#local-6989586621682865077"><span class="hs-identifier">skol_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">QuantCtxtSkol</span><span>
</span><a name="line-755"></a><span>             </span><a name="local-6989586621682865078"><a href="#local-6989586621682865078"><span class="hs-identifier">empty_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkEmptyTCvSubst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkInScopeSet</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-756"></a><span>                           </span><span class="hs-identifier hs-var">tyCoVarsOfTypes</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682865071"><span class="hs-identifier hs-var">pred</span></a><span class="hs-glyph">:</span><a href="#local-6989586621682865070"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">delVarSetList</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865074"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-757"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865079"><a href="#local-6989586621682865079"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865080"><a href="#local-6989586621682865080"><span class="hs-identifier">skol_tvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#tcInstSkolTyVarsX"><span class="hs-identifier hs-var">tcInstSkolTyVarsX</span></a><span> </span><a href="#local-6989586621682865078"><span class="hs-identifier hs-var">empty_subst</span></a><span> </span><a href="#local-6989586621682865074"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-758"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682865081"><a href="#local-6989586621682865081"><span class="hs-identifier">given_ev_vars</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="TcSMonad.html#newEvVar"><span class="hs-identifier hs-var">newEvVar</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">substTheta</span><span> </span><a href="#local-6989586621682865079"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682865070"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">)</span><span>
</span><a name="line-759"></a><span>
</span><a name="line-760"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865083"><a href="#local-6989586621682865083"><span class="hs-identifier">w_id</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865084"><a href="#local-6989586621682865084"><span class="hs-identifier">ev_binds</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-761"></a><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#checkConstraintsTcS"><span class="hs-identifier hs-var">checkConstraintsTcS</span></a><span> </span><a href="#local-6989586621682865077"><span class="hs-identifier hs-var">skol_info</span></a><span> </span><a href="#local-6989586621682865080"><span class="hs-identifier hs-var">skol_tvs</span></a><span> </span><a href="#local-6989586621682865081"><span class="hs-identifier hs-var">given_ev_vars</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-762"></a><span>                </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682865082"><a href="#local-6989586621682865082"><span class="hs-identifier">wanted_ev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#newWantedEvVarNC"><span class="hs-identifier hs-var">newWantedEvVarNC</span></a><span> </span><a href="#local-6989586621682865073"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-763"></a><span>                                  </span><span class="hs-identifier hs-var">substTy</span><span> </span><a href="#local-6989586621682865079"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682865071"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-764"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">ctEvEvId</span><span> </span><a href="#local-6989586621682865082"><span class="hs-identifier hs-var">wanted_ev</span></a><span>
</span><a name="line-765"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unitBag</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkNonCanonical</span><span> </span><a href="#local-6989586621682865082"><span class="hs-identifier hs-var">wanted_ev</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-766"></a><span>
</span><a name="line-767"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#setWantedEvTerm"><span class="hs-identifier hs-var">setWantedEvTerm</span></a><span> </span><a href="#local-6989586621682865076"><span class="hs-identifier hs-var">dest</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-768"></a><span>        </span><span class="hs-identifier hs-var">EvFun</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">et_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865080"><span class="hs-identifier hs-var">skol_tvs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">et_given</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865081"><span class="hs-identifier hs-var">given_ev_vars</span></a><span>
</span><a name="line-769"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">et_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865084"><span class="hs-identifier hs-var">ev_binds</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">et_body</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865083"><span class="hs-identifier hs-var">w_id</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-770"></a><span>
</span><a name="line-771"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a><span> </span><a href="#local-6989586621682865068"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-string">&quot;Wanted forall-constraint&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-772"></a><span>
</span><a name="line-773"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isGiven</span><span> </span><a href="#local-6989586621682865068"><span class="hs-identifier hs-var">ev</span></a><span>   </span><span class="hs-comment">-- See Note [Solving a Given forall-constraint]</span><span>
</span><a name="line-774"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#addInertForAll"><span class="hs-identifier hs-var">addInertForAll</span></a><span> </span><a href="#local-6989586621682865075"><span class="hs-identifier hs-var">qci</span></a><span>
</span><a name="line-775"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a><span> </span><a href="#local-6989586621682865068"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-string">&quot;Given forall-constraint&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-776"></a><span>
</span><a name="line-777"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-778"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a><span> </span><a href="#local-6989586621682865068"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-string">&quot;Derived forall-constraint&quot;</span><span>
</span><a name="line-779"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-780"></a><span>    </span><a name="local-6989586621682865073"><a href="#local-6989586621682865073"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ctEvLoc</span><span> </span><a href="#local-6989586621682865068"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-781"></a><span>    </span><a name="local-6989586621682865074"><a href="#local-6989586621682865074"><span class="hs-identifier">tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">binderVars</span><span> </span><a href="#local-6989586621682865069"><span class="hs-identifier hs-var">tv_bndrs</span></a><span>
</span><a name="line-782"></a><span>    </span><a name="local-6989586621682865075"><a href="#local-6989586621682865075"><span class="hs-identifier">qci</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">QCI</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">qci_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865068"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">qci_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865074"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-783"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">qci_pred</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865071"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">qci_pend_sc</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865072"><span class="hs-identifier hs-var">pend_sc</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-784"></a><span>
</span><a name="line-785"></a><span class="hs-comment">{- Note [Solving a Wanted forall-constraint]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Solving a wanted forall (quantified) constraint
  [W] df :: forall ab. (Eq a, Ord b) =&gt; C x a b
is delightfully easy.   Just build an implication constraint
    forall ab. (g1::Eq a, g2::Ord b) =&gt; [W] d :: C x a
and discharge df thus:
    df = /\ab. \g1 g2. let &lt;binds&gt; in d
where &lt;binds&gt; is filled in by solving the implication constraint.
All the machinery is to hand; there is little to do.

Note [Solving a Given forall-constraint]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For a Given constraint
  [G] df :: forall ab. (Eq a, Ord b) =&gt; C x a b
we just add it to TcS's local InstEnv of known instances,
via addInertForall.  Then, if we look up (C x Int Bool), say,
we'll find a match in the InstEnv.


************************************************************************
*                                                                      *
*        Equalities
*                                                                      *
************************************************************************

Note [Canonicalising equalities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In order to canonicalise an equality, we look at the structure of the
two types at hand, looking for similarities. A difficulty is that the
types may look dissimilar before flattening but similar after flattening.
However, we don't just want to jump in and flatten right away, because
this might be wasted effort. So, after looking for similarities and failing,
we flatten and then try again. Of course, we don't want to loop, so we
track whether or not we've already flattened.

It is conceivable to do a better job at tracking whether or not a type
is flattened, but this is left as future work. (Mar '15)


Note [FunTy and decomposing tycon applications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

When can_eq_nc' attempts to decompose a tycon application we haven't yet zonked.
This means that we may very well have a FunTy containing a type of some unknown
kind. For instance, we may have,

    FunTy (a :: k) Int

Where k is a unification variable. tcRepSplitTyConApp_maybe panics in the event
that it sees such a type as it cannot determine the RuntimeReps which the (-&gt;)
is applied to. Consequently, it is vital that we instead use
tcRepSplitTyConApp_maybe', which simply returns Nothing in such a case.

When this happens can_eq_nc' will fail to decompose, zonk, and try again.
Zonking should fill the variable k, meaning that decomposition will succeed the
second time around.
-}</span><span>
</span><a name="line-843"></a><span>
</span><a name="line-844"></a><span class="hs-identifier">canEqNC</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">EqRel</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span>
</span><a name="line-845"></a><a name="canEqNC"><a href="TcCanonical.html#canEqNC"><span class="hs-identifier">canEqNC</span></a></a><span> </span><a name="local-6989586621682865085"><a href="#local-6989586621682865085"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865086"><a href="#local-6989586621682865086"><span class="hs-identifier">eq_rel</span></a></a><span> </span><a name="local-6989586621682865087"><a href="#local-6989586621682865087"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865088"><a href="#local-6989586621682865088"><span class="hs-identifier">ty2</span></a></a><span>
</span><a name="line-846"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682865089"><a href="#local-6989586621682865089"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcCanonical.html#zonk_eq_types"><span class="hs-identifier hs-var">zonk_eq_types</span></a><span> </span><a href="#local-6989586621682865087"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865088"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-847"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682865089"><span class="hs-identifier hs-var">result</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-848"></a><span>           </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Pair</span><span> </span><a name="local-6989586621682865090"><a href="#local-6989586621682865090"><span class="hs-identifier">ty1'</span></a></a><span> </span><a name="local-6989586621682865091"><a href="#local-6989586621682865091"><span class="hs-identifier">ty2'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcCanonical.html#can_eq_nc"><span class="hs-identifier hs-var">can_eq_nc</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621682865085"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865086"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><a href="#local-6989586621682865090"><span class="hs-identifier hs-var">ty1'</span></a><span> </span><a href="#local-6989586621682865087"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865091"><span class="hs-identifier hs-var">ty2'</span></a><span> </span><a href="#local-6989586621682865088"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-849"></a><span>           </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621682865092"><a href="#local-6989586621682865092"><span class="hs-identifier">ty</span></a></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcCanonical.html#canEqReflexive"><span class="hs-identifier hs-var">canEqReflexive</span></a><span> </span><a href="#local-6989586621682865085"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865086"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><a href="#local-6989586621682865092"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-850"></a><span>
</span><a name="line-851"></a><span class="hs-identifier">can_eq_nc</span><span>
</span><a name="line-852"></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>            </span><span class="hs-comment">-- True =&gt; both types are flat</span><span>
</span><a name="line-853"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span>
</span><a name="line-854"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">EqRel</span><span>
</span><a name="line-855"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>    </span><span class="hs-comment">-- LHS, after and before type-synonym expansion, resp</span><span>
</span><a name="line-856"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>    </span><span class="hs-comment">-- RHS, after and before type-synonym expansion, resp</span><span>
</span><a name="line-857"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span>
</span><a name="line-858"></a><a name="can_eq_nc"><a href="TcCanonical.html#can_eq_nc"><span class="hs-identifier">can_eq_nc</span></a></a><span> </span><a name="local-6989586621682865093"><a href="#local-6989586621682865093"><span class="hs-identifier">flat</span></a></a><span> </span><a name="local-6989586621682865094"><a href="#local-6989586621682865094"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865095"><a href="#local-6989586621682865095"><span class="hs-identifier">eq_rel</span></a></a><span> </span><a name="local-6989586621682865096"><a href="#local-6989586621682865096"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865097"><a href="#local-6989586621682865097"><span class="hs-identifier">ps_ty1</span></a></a><span> </span><a name="local-6989586621682865098"><a href="#local-6989586621682865098"><span class="hs-identifier">ty2</span></a></a><span> </span><a name="local-6989586621682865099"><a href="#local-6989586621682865099"><span class="hs-identifier">ps_ty2</span></a></a><span>
</span><a name="line-859"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;can_eq_nc&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-860"></a><span>         </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865093"><span class="hs-identifier hs-var">flat</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865094"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865095"><span class="hs-identifier hs-var">eq_rel</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865096"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865097"><span class="hs-identifier hs-var">ps_ty1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865098"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865099"><span class="hs-identifier hs-var">ps_ty2</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-861"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682865100"><a href="#local-6989586621682865100"><span class="hs-identifier">rdr_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getGlobalRdrEnvTcS"><span class="hs-identifier hs-var">getGlobalRdrEnvTcS</span></a><span>
</span><a name="line-862"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682865101"><a href="#local-6989586621682865101"><span class="hs-identifier">fam_insts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getFamInstEnvs"><span class="hs-identifier hs-var">getFamInstEnvs</span></a><span>
</span><a name="line-863"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#can_eq_nc%27"><span class="hs-identifier hs-var">can_eq_nc'</span></a><span> </span><a href="#local-6989586621682865093"><span class="hs-identifier hs-var">flat</span></a><span> </span><a href="#local-6989586621682865100"><span class="hs-identifier hs-var">rdr_env</span></a><span> </span><a href="#local-6989586621682865101"><span class="hs-identifier hs-var">fam_insts</span></a><span> </span><a href="#local-6989586621682865094"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865095"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><a href="#local-6989586621682865096"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865097"><span class="hs-identifier hs-var">ps_ty1</span></a><span> </span><a href="#local-6989586621682865098"><span class="hs-identifier hs-var">ty2</span></a><span> </span><a href="#local-6989586621682865099"><span class="hs-identifier hs-var">ps_ty2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-864"></a><span>
</span><a name="line-865"></a><span class="hs-identifier">can_eq_nc'</span><span>
</span><a name="line-866"></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>           </span><span class="hs-comment">-- True =&gt; both input types are flattened</span><span>
</span><a name="line-867"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">GlobalRdrEnv</span><span>   </span><span class="hs-comment">-- needed to see which newtypes are in scope</span><span>
</span><a name="line-868"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FamInstEnvs</span><span>    </span><span class="hs-comment">-- needed to unwrap data instances</span><span>
</span><a name="line-869"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span>
</span><a name="line-870"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">EqRel</span><span>
</span><a name="line-871"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>    </span><span class="hs-comment">-- LHS, after and before type-synonym expansion, resp</span><span>
</span><a name="line-872"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>    </span><span class="hs-comment">-- RHS, after and before type-synonym expansion, resp</span><span>
</span><a name="line-873"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span>
</span><a name="line-874"></a><span>
</span><a name="line-875"></a><span class="hs-comment">-- Expand synonyms first; see Note [Type synonyms and canonicalization]</span><span>
</span><a name="line-876"></a><a name="can_eq_nc%27"><a href="TcCanonical.html#can_eq_nc%27"><span class="hs-identifier">can_eq_nc'</span></a></a><span> </span><a name="local-6989586621682865102"><a href="#local-6989586621682865102"><span class="hs-identifier">flat</span></a></a><span> </span><a name="local-6989586621682865103"><a href="#local-6989586621682865103"><span class="hs-identifier">_rdr_env</span></a></a><span> </span><a name="local-6989586621682865104"><a href="#local-6989586621682865104"><span class="hs-identifier">_envs</span></a></a><span> </span><a name="local-6989586621682865105"><a href="#local-6989586621682865105"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865106"><a href="#local-6989586621682865106"><span class="hs-identifier">eq_rel</span></a></a><span> </span><a name="local-6989586621682865107"><a href="#local-6989586621682865107"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865108"><a href="#local-6989586621682865108"><span class="hs-identifier">ps_ty1</span></a></a><span> </span><a name="local-6989586621682865109"><a href="#local-6989586621682865109"><span class="hs-identifier">ty2</span></a></a><span> </span><a name="local-6989586621682865110"><a href="#local-6989586621682865110"><span class="hs-identifier">ps_ty2</span></a></a><span>
</span><a name="line-877"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682865111"><a href="#local-6989586621682865111"><span class="hs-identifier">ty1'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcView</span><span> </span><a href="#local-6989586621682865107"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#can_eq_nc"><span class="hs-identifier hs-var">can_eq_nc</span></a><span> </span><a href="#local-6989586621682865102"><span class="hs-identifier hs-var">flat</span></a><span> </span><a href="#local-6989586621682865105"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865106"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><a href="#local-6989586621682865111"><span class="hs-identifier hs-var">ty1'</span></a><span> </span><a href="#local-6989586621682865108"><span class="hs-identifier hs-var">ps_ty1</span></a><span> </span><a href="#local-6989586621682865109"><span class="hs-identifier hs-var">ty2</span></a><span>  </span><a href="#local-6989586621682865110"><span class="hs-identifier hs-var">ps_ty2</span></a><span>
</span><a name="line-878"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682865112"><a href="#local-6989586621682865112"><span class="hs-identifier">ty2'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcView</span><span> </span><a href="#local-6989586621682865109"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#can_eq_nc"><span class="hs-identifier hs-var">can_eq_nc</span></a><span> </span><a href="#local-6989586621682865102"><span class="hs-identifier hs-var">flat</span></a><span> </span><a href="#local-6989586621682865105"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865106"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><a href="#local-6989586621682865107"><span class="hs-identifier hs-var">ty1</span></a><span>  </span><a href="#local-6989586621682865108"><span class="hs-identifier hs-var">ps_ty1</span></a><span> </span><a href="#local-6989586621682865112"><span class="hs-identifier hs-var">ty2'</span></a><span> </span><a href="#local-6989586621682865110"><span class="hs-identifier hs-var">ps_ty2</span></a><span>
</span><a name="line-879"></a><span>
</span><a name="line-880"></a><span class="hs-comment">-- need to check for reflexivity in the ReprEq case.</span><span>
</span><a name="line-881"></a><span class="hs-comment">-- See Note [Eager reflexivity check]</span><span>
</span><a name="line-882"></a><span class="hs-comment">-- Check only when flat because the zonk_eq_types check in canEqNC takes</span><span>
</span><a name="line-883"></a><span class="hs-comment">-- care of the non-flat case.</span><span>
</span><a name="line-884"></a><span class="hs-identifier">can_eq_nc'</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a name="local-6989586621682865113"><a href="#local-6989586621682865113"><span class="hs-identifier">_rdr_env</span></a></a><span> </span><a name="local-6989586621682865114"><a href="#local-6989586621682865114"><span class="hs-identifier">_envs</span></a></a><span> </span><a name="local-6989586621682865115"><a href="#local-6989586621682865115"><span class="hs-identifier">ev</span></a></a><span> </span><span class="hs-identifier hs-var">ReprEq</span><span> </span><a name="local-6989586621682865116"><a href="#local-6989586621682865116"><span class="hs-identifier">ty1</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682865117"><a href="#local-6989586621682865117"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-885"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682865116"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">tcEqType</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865117"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-886"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#canEqReflexive"><span class="hs-identifier hs-var">canEqReflexive</span></a><span> </span><a href="#local-6989586621682865115"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-identifier hs-var">ReprEq</span><span> </span><a href="#local-6989586621682865116"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-887"></a><span>
</span><a name="line-888"></a><span class="hs-comment">-- When working with ReprEq, unwrap newtypes.</span><span>
</span><a name="line-889"></a><span class="hs-comment">-- See Note [Unwrap newtypes first]</span><span>
</span><a name="line-890"></a><span class="hs-identifier">can_eq_nc'</span><span> </span><a name="local-6989586621682865118"><a href="#local-6989586621682865118"><span class="hs-identifier">_flat</span></a></a><span> </span><a name="local-6989586621682865119"><a href="#local-6989586621682865119"><span class="hs-identifier">rdr_env</span></a></a><span> </span><a name="local-6989586621682865120"><a href="#local-6989586621682865120"><span class="hs-identifier">envs</span></a></a><span> </span><a name="local-6989586621682865121"><a href="#local-6989586621682865121"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865122"><a href="#local-6989586621682865122"><span class="hs-identifier">eq_rel</span></a></a><span> </span><a name="local-6989586621682865123"><a href="#local-6989586621682865123"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865124"><a href="#local-6989586621682865124"><span class="hs-identifier">ps_ty1</span></a></a><span> </span><a name="local-6989586621682865125"><a href="#local-6989586621682865125"><span class="hs-identifier">ty2</span></a></a><span> </span><a name="local-6989586621682865126"><a href="#local-6989586621682865126"><span class="hs-identifier">ps_ty2</span></a></a><span>
</span><a name="line-891"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">ReprEq</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682865122"><span class="hs-identifier hs-var">eq_rel</span></a><span>
</span><a name="line-892"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682865127"><a href="#local-6989586621682865127"><span class="hs-identifier">stuff1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#tcTopNormaliseNewTypeTF_maybe"><span class="hs-identifier hs-var">tcTopNormaliseNewTypeTF_maybe</span></a><span> </span><a href="#local-6989586621682865120"><span class="hs-identifier hs-var">envs</span></a><span> </span><a href="#local-6989586621682865119"><span class="hs-identifier hs-var">rdr_env</span></a><span> </span><a href="#local-6989586621682865123"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-893"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#can_eq_newtype_nc"><span class="hs-identifier hs-var">can_eq_newtype_nc</span></a><span> </span><a href="#local-6989586621682865121"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-identifier hs-var">NotSwapped</span><span> </span><a href="#local-6989586621682865123"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865127"><span class="hs-identifier hs-var">stuff1</span></a><span> </span><a href="#local-6989586621682865125"><span class="hs-identifier hs-var">ty2</span></a><span> </span><a href="#local-6989586621682865126"><span class="hs-identifier hs-var">ps_ty2</span></a><span>
</span><a name="line-894"></a><span>
</span><a name="line-895"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">ReprEq</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682865122"><span class="hs-identifier hs-var">eq_rel</span></a><span>
</span><a name="line-896"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682865128"><a href="#local-6989586621682865128"><span class="hs-identifier">stuff2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#tcTopNormaliseNewTypeTF_maybe"><span class="hs-identifier hs-var">tcTopNormaliseNewTypeTF_maybe</span></a><span> </span><a href="#local-6989586621682865120"><span class="hs-identifier hs-var">envs</span></a><span> </span><a href="#local-6989586621682865119"><span class="hs-identifier hs-var">rdr_env</span></a><span> </span><a href="#local-6989586621682865125"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-897"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#can_eq_newtype_nc"><span class="hs-identifier hs-var">can_eq_newtype_nc</span></a><span> </span><a href="#local-6989586621682865121"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-identifier hs-var">IsSwapped</span><span>  </span><a href="#local-6989586621682865125"><span class="hs-identifier hs-var">ty2</span></a><span> </span><a href="#local-6989586621682865128"><span class="hs-identifier hs-var">stuff2</span></a><span> </span><a href="#local-6989586621682865123"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865124"><span class="hs-identifier hs-var">ps_ty1</span></a><span>
</span><a name="line-898"></a><span>
</span><a name="line-899"></a><span class="hs-comment">-- Then, get rid of casts</span><span>
</span><a name="line-900"></a><span class="hs-identifier">can_eq_nc'</span><span> </span><a name="local-6989586621682865129"><a href="#local-6989586621682865129"><span class="hs-identifier">flat</span></a></a><span> </span><a name="local-6989586621682865130"><a href="#local-6989586621682865130"><span class="hs-identifier">_rdr_env</span></a></a><span> </span><a name="local-6989586621682865131"><a href="#local-6989586621682865131"><span class="hs-identifier">_envs</span></a></a><span> </span><a name="local-6989586621682865132"><a href="#local-6989586621682865132"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865133"><a href="#local-6989586621682865133"><span class="hs-identifier">eq_rel</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CastTy</span><span> </span><a name="local-6989586621682865134"><a href="#local-6989586621682865134"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865135"><a href="#local-6989586621682865135"><span class="hs-identifier">co1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682865136"><a href="#local-6989586621682865136"><span class="hs-identifier">ty2</span></a></a><span> </span><a name="local-6989586621682865137"><a href="#local-6989586621682865137"><span class="hs-identifier">ps_ty2</span></a></a><span>
</span><a name="line-901"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#canEqCast"><span class="hs-identifier hs-var">canEqCast</span></a><span> </span><a href="#local-6989586621682865129"><span class="hs-identifier hs-var">flat</span></a><span> </span><a href="#local-6989586621682865132"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865133"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><span class="hs-identifier hs-var">NotSwapped</span><span> </span><a href="#local-6989586621682865134"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865135"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-6989586621682865136"><span class="hs-identifier hs-var">ty2</span></a><span> </span><a href="#local-6989586621682865137"><span class="hs-identifier hs-var">ps_ty2</span></a><span>
</span><a name="line-902"></a><span class="hs-identifier">can_eq_nc'</span><span> </span><a name="local-6989586621682865138"><a href="#local-6989586621682865138"><span class="hs-identifier">flat</span></a></a><span> </span><a name="local-6989586621682865139"><a href="#local-6989586621682865139"><span class="hs-identifier">_rdr_env</span></a></a><span> </span><a name="local-6989586621682865140"><a href="#local-6989586621682865140"><span class="hs-identifier">_envs</span></a></a><span> </span><a name="local-6989586621682865141"><a href="#local-6989586621682865141"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865142"><a href="#local-6989586621682865142"><span class="hs-identifier">eq_rel</span></a></a><span> </span><a name="local-6989586621682865143"><a href="#local-6989586621682865143"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865144"><a href="#local-6989586621682865144"><span class="hs-identifier">ps_ty1</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CastTy</span><span> </span><a name="local-6989586621682865145"><a href="#local-6989586621682865145"><span class="hs-identifier">ty2</span></a></a><span> </span><a name="local-6989586621682865146"><a href="#local-6989586621682865146"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-903"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#canEqCast"><span class="hs-identifier hs-var">canEqCast</span></a><span> </span><a href="#local-6989586621682865138"><span class="hs-identifier hs-var">flat</span></a><span> </span><a href="#local-6989586621682865141"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865142"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><span class="hs-identifier hs-var">IsSwapped</span><span> </span><a href="#local-6989586621682865145"><span class="hs-identifier hs-var">ty2</span></a><span> </span><a href="#local-6989586621682865146"><span class="hs-identifier hs-var">co2</span></a><span> </span><a href="#local-6989586621682865143"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865144"><span class="hs-identifier hs-var">ps_ty1</span></a><span>
</span><a name="line-904"></a><span>
</span><a name="line-905"></a><span class="hs-comment">-- NB: pattern match on True: we want only flat types sent to canEqTyVar.</span><span>
</span><a name="line-906"></a><span class="hs-comment">-- See also Note [No top-level newtypes on RHS of representational equalities]</span><span>
</span><a name="line-907"></a><span class="hs-identifier">can_eq_nc'</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a name="local-6989586621682865147"><a href="#local-6989586621682865147"><span class="hs-identifier">_rdr_env</span></a></a><span> </span><a name="local-6989586621682865148"><a href="#local-6989586621682865148"><span class="hs-identifier">_envs</span></a></a><span> </span><a name="local-6989586621682865149"><a href="#local-6989586621682865149"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865150"><a href="#local-6989586621682865150"><span class="hs-identifier">eq_rel</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyVarTy</span><span> </span><a name="local-6989586621682865151"><a href="#local-6989586621682865151"><span class="hs-identifier">tv1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682865152"><a href="#local-6989586621682865152"><span class="hs-identifier">ps_ty1</span></a></a><span> </span><a name="local-6989586621682865153"><a href="#local-6989586621682865153"><span class="hs-identifier">ty2</span></a></a><span> </span><a name="local-6989586621682865154"><a href="#local-6989586621682865154"><span class="hs-identifier">ps_ty2</span></a></a><span>
</span><a name="line-908"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#canEqTyVar"><span class="hs-identifier hs-var">canEqTyVar</span></a><span> </span><a href="#local-6989586621682865149"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865150"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><span class="hs-identifier hs-var">NotSwapped</span><span> </span><a href="#local-6989586621682865151"><span class="hs-identifier hs-var">tv1</span></a><span> </span><a href="#local-6989586621682865152"><span class="hs-identifier hs-var">ps_ty1</span></a><span> </span><a href="#local-6989586621682865153"><span class="hs-identifier hs-var">ty2</span></a><span> </span><a href="#local-6989586621682865154"><span class="hs-identifier hs-var">ps_ty2</span></a><span>
</span><a name="line-909"></a><span class="hs-identifier">can_eq_nc'</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a name="local-6989586621682865155"><a href="#local-6989586621682865155"><span class="hs-identifier">_rdr_env</span></a></a><span> </span><a name="local-6989586621682865156"><a href="#local-6989586621682865156"><span class="hs-identifier">_envs</span></a></a><span> </span><a name="local-6989586621682865157"><a href="#local-6989586621682865157"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865158"><a href="#local-6989586621682865158"><span class="hs-identifier">eq_rel</span></a></a><span> </span><a name="local-6989586621682865159"><a href="#local-6989586621682865159"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865160"><a href="#local-6989586621682865160"><span class="hs-identifier">ps_ty1</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyVarTy</span><span> </span><a name="local-6989586621682865161"><a href="#local-6989586621682865161"><span class="hs-identifier">tv2</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682865162"><a href="#local-6989586621682865162"><span class="hs-identifier">ps_ty2</span></a></a><span>
</span><a name="line-910"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#canEqTyVar"><span class="hs-identifier hs-var">canEqTyVar</span></a><span> </span><a href="#local-6989586621682865157"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865158"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><span class="hs-identifier hs-var">IsSwapped</span><span> </span><a href="#local-6989586621682865161"><span class="hs-identifier hs-var">tv2</span></a><span> </span><a href="#local-6989586621682865162"><span class="hs-identifier hs-var">ps_ty2</span></a><span> </span><a href="#local-6989586621682865159"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865160"><span class="hs-identifier hs-var">ps_ty1</span></a><span>
</span><a name="line-911"></a><span>
</span><a name="line-912"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-913"></a><span class="hs-comment">-- Otherwise try to decompose</span><span>
</span><a name="line-914"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-915"></a><span>
</span><a name="line-916"></a><span class="hs-comment">-- Literals</span><span>
</span><a name="line-917"></a><span class="hs-identifier">can_eq_nc'</span><span> </span><a name="local-6989586621682865163"><a href="#local-6989586621682865163"><span class="hs-identifier">_flat</span></a></a><span> </span><a name="local-6989586621682865164"><a href="#local-6989586621682865164"><span class="hs-identifier">_rdr_env</span></a></a><span> </span><a name="local-6989586621682865165"><a href="#local-6989586621682865165"><span class="hs-identifier">_envs</span></a></a><span> </span><a name="local-6989586621682865166"><a href="#local-6989586621682865166"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865167"><a href="#local-6989586621682865167"><span class="hs-identifier">eq_rel</span></a></a><span> </span><a name="local-6989586621682865168"><a href="#local-6989586621682865168"><span class="hs-identifier">ty1</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitTy</span><span> </span><a name="local-6989586621682865169"><a href="#local-6989586621682865169"><span class="hs-identifier">l1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitTy</span><span> </span><a name="local-6989586621682865170"><a href="#local-6989586621682865170"><span class="hs-identifier">l2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-918"></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682865169"><span class="hs-identifier hs-var">l1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682865170"><span class="hs-identifier hs-var">l2</span></a><span>
</span><a name="line-919"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#setEvBindIfWanted"><span class="hs-identifier hs-var">setEvBindIfWanted</span></a><span> </span><a href="#local-6989586621682865166"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">evCoercion</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkReflCo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">eqRelRole</span><span> </span><a href="#local-6989586621682865167"><span class="hs-identifier hs-var">eq_rel</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682865168"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">)</span><span>
</span><a name="line-920"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a><span> </span><a href="#local-6989586621682865166"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-string">&quot;Equal LitTy&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-921"></a><span>
</span><a name="line-922"></a><span class="hs-comment">-- Try to decompose type constructor applications</span><span>
</span><a name="line-923"></a><span class="hs-comment">-- Including FunTy (s -&gt; t)</span><span>
</span><a name="line-924"></a><span class="hs-identifier">can_eq_nc'</span><span> </span><a name="local-6989586621682865171"><a href="#local-6989586621682865171"><span class="hs-identifier">_flat</span></a></a><span> </span><a name="local-6989586621682865172"><a href="#local-6989586621682865172"><span class="hs-identifier">_rdr_env</span></a></a><span> </span><a name="local-6989586621682865173"><a href="#local-6989586621682865173"><span class="hs-identifier">_envs</span></a></a><span> </span><a name="local-6989586621682865174"><a href="#local-6989586621682865174"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865175"><a href="#local-6989586621682865175"><span class="hs-identifier">eq_rel</span></a></a><span> </span><a name="local-6989586621682865176"><a href="#local-6989586621682865176"><span class="hs-identifier">ty1</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682865177"><a href="#local-6989586621682865177"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-925"></a><span>    </span><span class="hs-comment">--- See Note [FunTy and decomposing type constructor applications].</span><span>
</span><a name="line-926"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865178"><a href="#local-6989586621682865178"><span class="hs-identifier">tc1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865179"><a href="#local-6989586621682865179"><span class="hs-identifier">tys1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcRepSplitTyConApp_maybe'</span><span> </span><a href="#local-6989586621682865176"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-927"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865180"><a href="#local-6989586621682865180"><span class="hs-identifier">tc2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865181"><a href="#local-6989586621682865181"><span class="hs-identifier">tys2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcRepSplitTyConApp_maybe'</span><span> </span><a href="#local-6989586621682865177"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-928"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isTypeFamilyTyCon</span><span> </span><a href="#local-6989586621682865178"><span class="hs-identifier hs-var">tc1</span></a><span class="hs-special">)</span><span>
</span><a name="line-929"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isTypeFamilyTyCon</span><span> </span><a href="#local-6989586621682865180"><span class="hs-identifier hs-var">tc2</span></a><span class="hs-special">)</span><span>
</span><a name="line-930"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#canTyConApp"><span class="hs-identifier hs-var">canTyConApp</span></a><span> </span><a href="#local-6989586621682865174"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865175"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><a href="#local-6989586621682865178"><span class="hs-identifier hs-var">tc1</span></a><span> </span><a href="#local-6989586621682865179"><span class="hs-identifier hs-var">tys1</span></a><span> </span><a href="#local-6989586621682865180"><span class="hs-identifier hs-var">tc2</span></a><span> </span><a href="#local-6989586621682865181"><span class="hs-identifier hs-var">tys2</span></a><span>
</span><a name="line-931"></a><span>
</span><a name="line-932"></a><span class="hs-identifier">can_eq_nc'</span><span> </span><a name="local-6989586621682865182"><a href="#local-6989586621682865182"><span class="hs-identifier">_flat</span></a></a><span> </span><a name="local-6989586621682865183"><a href="#local-6989586621682865183"><span class="hs-identifier">_rdr_env</span></a></a><span> </span><a name="local-6989586621682865184"><a href="#local-6989586621682865184"><span class="hs-identifier">_envs</span></a></a><span> </span><a name="local-6989586621682865185"><a href="#local-6989586621682865185"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865186"><a href="#local-6989586621682865186"><span class="hs-identifier">eq_rel</span></a></a><span>
</span><a name="line-933"></a><span>           </span><a name="local-6989586621682865187"><a href="#local-6989586621682865187"><span class="hs-identifier">s1</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">ForAllTy</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682865188"><a href="#local-6989586621682865188"><span class="hs-identifier">s2</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">ForAllTy</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-934"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#can_eq_nc_forall"><span class="hs-identifier hs-var">can_eq_nc_forall</span></a><span> </span><a href="#local-6989586621682865185"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865186"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><a href="#local-6989586621682865187"><span class="hs-identifier hs-var">s1</span></a><span> </span><a href="#local-6989586621682865188"><span class="hs-identifier hs-var">s2</span></a><span>
</span><a name="line-935"></a><span>
</span><a name="line-936"></a><span class="hs-comment">-- See Note [Canonicalising type applications] about why we require flat types</span><span>
</span><a name="line-937"></a><span class="hs-identifier">can_eq_nc'</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a name="local-6989586621682865189"><a href="#local-6989586621682865189"><span class="hs-identifier">_rdr_env</span></a></a><span> </span><a name="local-6989586621682865190"><a href="#local-6989586621682865190"><span class="hs-identifier">_envs</span></a></a><span> </span><a name="local-6989586621682865191"><a href="#local-6989586621682865191"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865192"><a href="#local-6989586621682865192"><span class="hs-identifier">eq_rel</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AppTy</span><span> </span><a name="local-6989586621682865193"><a href="#local-6989586621682865193"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-6989586621682865194"><a href="#local-6989586621682865194"><span class="hs-identifier">s1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682865195"><a href="#local-6989586621682865195"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-938"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">NomEq</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682865192"><span class="hs-identifier hs-var">eq_rel</span></a><span>
</span><a name="line-939"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865196"><a href="#local-6989586621682865196"><span class="hs-identifier">t2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865197"><a href="#local-6989586621682865197"><span class="hs-identifier">s2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcSplitAppTy_maybe</span><span> </span><a href="#local-6989586621682865195"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-940"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#can_eq_app"><span class="hs-identifier hs-var">can_eq_app</span></a><span> </span><a href="#local-6989586621682865191"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865193"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-6989586621682865194"><span class="hs-identifier hs-var">s1</span></a><span> </span><a href="#local-6989586621682865196"><span class="hs-identifier hs-var">t2</span></a><span> </span><a href="#local-6989586621682865197"><span class="hs-identifier hs-var">s2</span></a><span>
</span><a name="line-941"></a><span class="hs-identifier">can_eq_nc'</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a name="local-6989586621682865198"><a href="#local-6989586621682865198"><span class="hs-identifier">_rdr_env</span></a></a><span> </span><a name="local-6989586621682865199"><a href="#local-6989586621682865199"><span class="hs-identifier">_envs</span></a></a><span> </span><a name="local-6989586621682865200"><a href="#local-6989586621682865200"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865201"><a href="#local-6989586621682865201"><span class="hs-identifier">eq_rel</span></a></a><span> </span><a name="local-6989586621682865202"><a href="#local-6989586621682865202"><span class="hs-identifier">ty1</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AppTy</span><span> </span><a name="local-6989586621682865203"><a href="#local-6989586621682865203"><span class="hs-identifier">t2</span></a></a><span> </span><a name="local-6989586621682865204"><a href="#local-6989586621682865204"><span class="hs-identifier">s2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-942"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">NomEq</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682865201"><span class="hs-identifier hs-var">eq_rel</span></a><span>
</span><a name="line-943"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865205"><a href="#local-6989586621682865205"><span class="hs-identifier">t1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865206"><a href="#local-6989586621682865206"><span class="hs-identifier">s1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcSplitAppTy_maybe</span><span> </span><a href="#local-6989586621682865202"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-944"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#can_eq_app"><span class="hs-identifier hs-var">can_eq_app</span></a><span> </span><a href="#local-6989586621682865200"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865205"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-6989586621682865206"><span class="hs-identifier hs-var">s1</span></a><span> </span><a href="#local-6989586621682865203"><span class="hs-identifier hs-var">t2</span></a><span> </span><a href="#local-6989586621682865204"><span class="hs-identifier hs-var">s2</span></a><span>
</span><a name="line-945"></a><span>
</span><a name="line-946"></a><span class="hs-comment">-- No similarity in type structure detected. Flatten and try again.</span><span>
</span><a name="line-947"></a><span class="hs-identifier">can_eq_nc'</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a name="local-6989586621682865207"><a href="#local-6989586621682865207"><span class="hs-identifier">rdr_env</span></a></a><span> </span><a name="local-6989586621682865208"><a href="#local-6989586621682865208"><span class="hs-identifier">envs</span></a></a><span> </span><a name="local-6989586621682865209"><a href="#local-6989586621682865209"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865210"><a href="#local-6989586621682865210"><span class="hs-identifier">eq_rel</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682865211"><a href="#local-6989586621682865211"><span class="hs-identifier">ps_ty1</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682865212"><a href="#local-6989586621682865212"><span class="hs-identifier">ps_ty2</span></a></a><span>
</span><a name="line-948"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865213"><a href="#local-6989586621682865213"><span class="hs-identifier">xi1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865214"><a href="#local-6989586621682865214"><span class="hs-identifier">co1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcFlatten.html#flatten"><span class="hs-identifier hs-var">flatten</span></a><span> </span><a href="TcFlatten.html#FM_FlattenAll"><span class="hs-identifier hs-var">FM_FlattenAll</span></a><span> </span><a href="#local-6989586621682865209"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865211"><span class="hs-identifier hs-var">ps_ty1</span></a><span>
</span><a name="line-949"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865215"><a href="#local-6989586621682865215"><span class="hs-identifier">xi2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865216"><a href="#local-6989586621682865216"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcFlatten.html#flatten"><span class="hs-identifier hs-var">flatten</span></a><span> </span><a href="TcFlatten.html#FM_FlattenAll"><span class="hs-identifier hs-var">FM_FlattenAll</span></a><span> </span><a href="#local-6989586621682865209"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865212"><span class="hs-identifier hs-var">ps_ty2</span></a><span>
</span><a name="line-950"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682865217"><a href="#local-6989586621682865217"><span class="hs-identifier">new_ev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcCanonical.html#rewriteEqEvidence"><span class="hs-identifier hs-var">rewriteEqEvidence</span></a><span> </span><a href="#local-6989586621682865209"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-identifier hs-var">NotSwapped</span><span> </span><a href="#local-6989586621682865213"><span class="hs-identifier hs-var">xi1</span></a><span> </span><a href="#local-6989586621682865215"><span class="hs-identifier hs-var">xi2</span></a><span> </span><a href="#local-6989586621682865214"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-6989586621682865216"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-951"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#can_eq_nc%27"><span class="hs-identifier hs-var">can_eq_nc'</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621682865207"><span class="hs-identifier hs-var">rdr_env</span></a><span> </span><a href="#local-6989586621682865208"><span class="hs-identifier hs-var">envs</span></a><span> </span><a href="#local-6989586621682865217"><span class="hs-identifier hs-var">new_ev</span></a><span> </span><a href="#local-6989586621682865210"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><a href="#local-6989586621682865213"><span class="hs-identifier hs-var">xi1</span></a><span> </span><a href="#local-6989586621682865213"><span class="hs-identifier hs-var">xi1</span></a><span> </span><a href="#local-6989586621682865215"><span class="hs-identifier hs-var">xi2</span></a><span> </span><a href="#local-6989586621682865215"><span class="hs-identifier hs-var">xi2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-952"></a><span>
</span><a name="line-953"></a><span class="hs-comment">-- We've flattened and the types don't match. Give up.</span><span>
</span><a name="line-954"></a><span class="hs-identifier">can_eq_nc'</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a name="local-6989586621682865218"><a href="#local-6989586621682865218"><span class="hs-identifier">_rdr_env</span></a></a><span> </span><a name="local-6989586621682865219"><a href="#local-6989586621682865219"><span class="hs-identifier">_envs</span></a></a><span> </span><a name="local-6989586621682865220"><a href="#local-6989586621682865220"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865221"><a href="#local-6989586621682865221"><span class="hs-identifier">eq_rel</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682865222"><a href="#local-6989586621682865222"><span class="hs-identifier">ps_ty1</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682865223"><a href="#local-6989586621682865223"><span class="hs-identifier">ps_ty2</span></a></a><span>
</span><a name="line-955"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;can_eq_nc' catch-all case&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865222"><span class="hs-identifier hs-var">ps_ty1</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865223"><span class="hs-identifier hs-var">ps_ty2</span></a><span class="hs-special">)</span><span>
</span><a name="line-956"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682865221"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-comment">-- See Note [Unsolved equalities]</span><span>
</span><a name="line-957"></a><span>            </span><span class="hs-identifier hs-var">ReprEq</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcCanonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkIrredCt</span><span> </span><a href="#local-6989586621682865220"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span>
</span><a name="line-958"></a><span>            </span><span class="hs-identifier hs-var">NomEq</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcCanonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkInsolubleCt</span><span> </span><a href="#local-6989586621682865220"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-959"></a><span>          </span><span class="hs-comment">-- No need to call canEqFailure/canEqHardFailure because they</span><span>
</span><a name="line-960"></a><span>          </span><span class="hs-comment">-- flatten, and the types involved here are already flat</span><span>
</span><a name="line-961"></a><span>
</span><a name="line-962"></a><span class="hs-comment">{- Note [Unsolved equalities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we have an unsolved equality like
  (a b ~R# Int)
that is not necessarily insoluble!  Maybe 'a' will turn out to be a newtype.
So we want to make it a potentially-soluble Irred not an insoluble one.
Missing this point is what caused Trac #15431
-}</span><span>
</span><a name="line-970"></a><span>
</span><a name="line-971"></a><span class="hs-comment">---------------------------------</span><span>
</span><a name="line-972"></a><span class="hs-identifier">can_eq_nc_forall</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">EqRel</span><span>
</span><a name="line-973"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>    </span><span class="hs-comment">-- LHS and RHS</span><span>
</span><a name="line-974"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span>
</span><a name="line-975"></a><span class="hs-comment">-- (forall as. phi1) ~ (forall bs. phi2)</span><span>
</span><a name="line-976"></a><span class="hs-comment">-- Check for length match of as, bs</span><span>
</span><a name="line-977"></a><span class="hs-comment">-- Then build an implication constraint: forall as. phi1 ~ phi2[as/bs]</span><span>
</span><a name="line-978"></a><span class="hs-comment">-- But remember also to unify the kinds of as and bs</span><span>
</span><a name="line-979"></a><span class="hs-comment">--  (this is the 'go' loop), and actually substitute phi2[as |&gt; cos / bs]</span><span>
</span><a name="line-980"></a><span class="hs-comment">-- Remember also that we might have forall z (a:z). blah</span><span>
</span><a name="line-981"></a><span class="hs-comment">--  so we must proceed one binder at a time (Trac #13879)</span><span>
</span><a name="line-982"></a><span>
</span><a name="line-983"></a><a name="can_eq_nc_forall"><a href="TcCanonical.html#can_eq_nc_forall"><span class="hs-identifier">can_eq_nc_forall</span></a></a><span> </span><a name="local-6989586621682865224"><a href="#local-6989586621682865224"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865225"><a href="#local-6989586621682865225"><span class="hs-identifier">eq_rel</span></a></a><span> </span><a name="local-6989586621682865226"><a href="#local-6989586621682865226"><span class="hs-identifier">s1</span></a></a><span> </span><a name="local-6989586621682865227"><a href="#local-6989586621682865227"><span class="hs-identifier">s2</span></a></a><span>
</span><a name="line-984"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">CtWanted</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682865235"><a href="#local-6989586621682865235"><span class="hs-identifier">loc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ctev_dest</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682865236"><a href="#local-6989586621682865236"><span class="hs-identifier">orig_dest</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682865224"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-985"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682865237"><a href="#local-6989586621682865237"><span class="hs-identifier">free_tvs</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyCoVarsOfTypes</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682865226"><span class="hs-identifier hs-var">s1</span></a><span class="hs-special">,</span><a href="#local-6989586621682865227"><span class="hs-identifier hs-var">s2</span></a><span class="hs-special">]</span><span>
</span><a name="line-986"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621682865238"><a href="#local-6989586621682865238"><span class="hs-identifier">bndrs1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865239"><a href="#local-6989586621682865239"><span class="hs-identifier">phi1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitForAllVarBndrs</span><span> </span><a href="#local-6989586621682865226"><span class="hs-identifier hs-var">s1</span></a><span>
</span><a name="line-987"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621682865240"><a href="#local-6989586621682865240"><span class="hs-identifier">bndrs2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865241"><a href="#local-6989586621682865241"><span class="hs-identifier">phi2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitForAllVarBndrs</span><span> </span><a href="#local-6989586621682865227"><span class="hs-identifier hs-var">s2</span></a><span>
</span><a name="line-988"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">equalLength</span><span> </span><a href="#local-6989586621682865238"><span class="hs-identifier hs-var">bndrs1</span></a><span> </span><a href="#local-6989586621682865240"><span class="hs-identifier hs-var">bndrs2</span></a><span class="hs-special">)</span><span>
</span><a name="line-989"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;Forall failure&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-990"></a><span>                     </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865226"><span class="hs-identifier hs-var">s1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865227"><span class="hs-identifier hs-var">s2</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865238"><span class="hs-identifier hs-var">bndrs1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865240"><span class="hs-identifier hs-var">bndrs2</span></a><span>
</span><a name="line-991"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">binderArgFlag</span><span> </span><a href="#local-6989586621682865238"><span class="hs-identifier hs-var">bndrs1</span></a><span class="hs-special">)</span><span>
</span><a name="line-992"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">binderArgFlag</span><span> </span><a href="#local-6989586621682865240"><span class="hs-identifier hs-var">bndrs2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-993"></a><span>                </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#canEqHardFailure"><span class="hs-identifier hs-var">canEqHardFailure</span></a><span> </span><a href="#local-6989586621682865224"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865226"><span class="hs-identifier hs-var">s1</span></a><span> </span><a href="#local-6989586621682865227"><span class="hs-identifier hs-var">s2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-994"></a><span>        </span><span class="hs-keyword">else</span><span>
</span><a name="line-995"></a><span>   </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;Creating implication for polytype equality&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865224"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-996"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682865242"><a href="#local-6989586621682865242"><span class="hs-identifier">empty_subst1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkEmptyTCvSubst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkInScopeSet</span><span> </span><a href="#local-6989586621682865237"><span class="hs-identifier hs-var">free_tvs</span></a><span>
</span><a name="line-997"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865243"><a href="#local-6989586621682865243"><span class="hs-identifier">subst1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865244"><a href="#local-6989586621682865244"><span class="hs-identifier">skol_tvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#tcInstSkolTyVarsX"><span class="hs-identifier hs-var">tcInstSkolTyVarsX</span></a><span> </span><a href="#local-6989586621682865242"><span class="hs-identifier hs-var">empty_subst1</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-998"></a><span>                              </span><span class="hs-identifier hs-var">binderVars</span><span> </span><a href="#local-6989586621682865238"><span class="hs-identifier hs-var">bndrs1</span></a><span>
</span><a name="line-999"></a><span>
</span><a name="line-1000"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682865245"><a href="#local-6989586621682865245"><span class="hs-identifier">skol_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">UnifyForAllSkol</span><span> </span><a href="#local-6989586621682865239"><span class="hs-identifier hs-var">phi1</span></a><span>
</span><a name="line-1001"></a><span>            </span><a name="local-6989586621682865246"><a href="#local-6989586621682865246"><span class="hs-identifier">phi1'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTy</span><span> </span><a href="#local-6989586621682865243"><span class="hs-identifier hs-var">subst1</span></a><span> </span><a href="#local-6989586621682865239"><span class="hs-identifier hs-var">phi1</span></a><span>
</span><a name="line-1002"></a><span>
</span><a name="line-1003"></a><span>            </span><span class="hs-comment">-- Unify the kinds, extend the substitution</span><span>
</span><a name="line-1004"></a><span>            </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TCvSubst</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVarBinder</span><span class="hs-special">]</span><span>
</span><a name="line-1005"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcCoercion</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Cts</span><span class="hs-special">)</span><span>
</span><a name="line-1006"></a><span>            </span><a name="local-6989586621682865247"><a href="#local-6989586621682865247"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682865249"><a href="#local-6989586621682865249"><span class="hs-identifier">skol_tv</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682865250"><a href="#local-6989586621682865250"><span class="hs-identifier">skol_tvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682865251"><a href="#local-6989586621682865251"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682865252"><a href="#local-6989586621682865252"><span class="hs-identifier">bndr2</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682865253"><a href="#local-6989586621682865253"><span class="hs-identifier">bndrs2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1007"></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682865254"><a href="#local-6989586621682865254"><span class="hs-identifier">tv2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">binderVar</span><span> </span><a href="#local-6989586621682865252"><span class="hs-identifier hs-var">bndr2</span></a><span>
</span><a name="line-1008"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865255"><a href="#local-6989586621682865255"><span class="hs-identifier">kind_co</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865256"><a href="#local-6989586621682865256"><span class="hs-identifier">wanteds1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682865228"><span class="hs-identifier hs-var">unify</span></a><span> </span><a href="#local-6989586621682865235"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-identifier hs-var">Nominal</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyVarKind</span><span> </span><a href="#local-6989586621682865249"><span class="hs-identifier hs-var">skol_tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-1009"></a><span>                                                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">substTy</span><span> </span><a href="#local-6989586621682865251"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyVarKind</span><span> </span><a href="#local-6989586621682865254"><span class="hs-identifier hs-var">tv2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1010"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682865257"><a href="#local-6989586621682865257"><span class="hs-identifier">subst'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendTvSubst</span><span> </span><a href="#local-6989586621682865251"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682865254"><span class="hs-identifier hs-var">tv2</span></a><span>
</span><a name="line-1011"></a><span>                                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCastTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621682865249"><span class="hs-identifier hs-var">skol_tv</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682865255"><span class="hs-identifier hs-var">kind_co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1012"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865258"><a href="#local-6989586621682865258"><span class="hs-identifier">co</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865259"><a href="#local-6989586621682865259"><span class="hs-identifier">wanteds2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682865247"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682865250"><span class="hs-identifier hs-var">skol_tvs</span></a><span> </span><a href="#local-6989586621682865257"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-6989586621682865253"><span class="hs-identifier hs-var">bndrs2</span></a><span>
</span><a name="line-1013"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkTcForAllCo</span><span> </span><a href="#local-6989586621682865249"><span class="hs-identifier hs-var">skol_tv</span></a><span> </span><a href="#local-6989586621682865255"><span class="hs-identifier hs-var">kind_co</span></a><span> </span><a href="#local-6989586621682865258"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1014"></a><span>                            </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682865256"><span class="hs-identifier hs-var">wanteds1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionBags</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865259"><span class="hs-identifier hs-var">wanteds2</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1015"></a><span>
</span><a name="line-1016"></a><span>            </span><span class="hs-comment">-- Done: unify phi1 ~ phi2</span><span>
</span><a name="line-1017"></a><span>            </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621682865260"><a href="#local-6989586621682865260"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621682865261"><a href="#local-6989586621682865261"><span class="hs-identifier">bndrs2</span></a></a><span>
</span><a name="line-1018"></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-identifier">bndrs2</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1019"></a><span>                </span><a href="#local-6989586621682865228"><span class="hs-identifier hs-var">unify</span></a><span> </span><a href="#local-6989586621682865235"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">eqRelRole</span><span> </span><a href="#local-6989586621682865225"><span class="hs-identifier hs-var">eq_rel</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682865246"><span class="hs-identifier hs-var">phi1'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">substTy</span><span> </span><a href="#local-6989586621682865260"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682865241"><span class="hs-identifier hs-var">phi2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1020"></a><span>
</span><a name="line-1021"></a><span>            </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;cna_eq_nc_forall&quot;</span><span>  </span><span class="hs-comment">-- case (s:ss) []</span><span>
</span><a name="line-1022"></a><span>
</span><a name="line-1023"></a><span>            </span><a name="local-6989586621682865248"><a href="#local-6989586621682865248"><span class="hs-identifier">empty_subst2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkEmptyTCvSubst</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getTCvInScope</span><span> </span><a href="#local-6989586621682865243"><span class="hs-identifier hs-var">subst1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1024"></a><span>
</span><a name="line-1025"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682865262"><a href="#local-6989586621682865262"><span class="hs-identifier">all_co</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#checkTvConstraintsTcS"><span class="hs-identifier hs-var">checkTvConstraintsTcS</span></a><span> </span><a href="#local-6989586621682865245"><span class="hs-identifier hs-var">skol_info</span></a><span> </span><a href="#local-6989586621682865244"><span class="hs-identifier hs-var">skol_tvs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1026"></a><span>                  </span><a href="#local-6989586621682865247"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682865244"><span class="hs-identifier hs-var">skol_tvs</span></a><span> </span><a href="#local-6989586621682865248"><span class="hs-identifier hs-var">empty_subst2</span></a><span> </span><a href="#local-6989586621682865240"><span class="hs-identifier hs-var">bndrs2</span></a><span>
</span><a name="line-1027"></a><span>
</span><a name="line-1028"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#setWantedEq"><span class="hs-identifier hs-var">setWantedEq</span></a><span> </span><a href="#local-6989586621682865236"><span class="hs-identifier hs-var">orig_dest</span></a><span> </span><a href="#local-6989586621682865262"><span class="hs-identifier hs-var">all_co</span></a><span>
</span><a name="line-1029"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a><span> </span><a href="#local-6989586621682865224"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-string">&quot;Deferred polytype equality&quot;</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1030"></a><span>
</span><a name="line-1031"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1032"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;Omitting decomposition of given polytype equality&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1033"></a><span>        </span><a href="TcSMonad.html#pprEq"><span class="hs-identifier hs-var">pprEq</span></a><span> </span><a href="#local-6989586621682865226"><span class="hs-identifier hs-var">s1</span></a><span> </span><a href="#local-6989586621682865227"><span class="hs-identifier hs-var">s2</span></a><span>    </span><span class="hs-comment">-- See Note [Do not decompose given polytype equalities]</span><span>
</span><a name="line-1034"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a><span> </span><a href="#local-6989586621682865224"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-string">&quot;Discard given polytype equality&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1035"></a><span>
</span><a name="line-1036"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1037"></a><span>    </span><span class="hs-identifier">unify</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtLoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Role</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcCoercion</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Cts</span><span class="hs-special">)</span><span>
</span><a name="line-1038"></a><span>    </span><span class="hs-comment">-- This version returns the wanted constraint rather</span><span>
</span><a name="line-1039"></a><span>    </span><span class="hs-comment">-- than putting it in the work list</span><span>
</span><a name="line-1040"></a><span>    </span><a name="local-6989586621682865228"><a href="#local-6989586621682865228"><span class="hs-identifier">unify</span></a></a><span> </span><a name="local-6989586621682865229"><a href="#local-6989586621682865229"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-keyword">role</span><span> </span><a name="local-6989586621682865231"><a href="#local-6989586621682865231"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865232"><a href="#local-6989586621682865232"><span class="hs-identifier">ty2</span></a></a><span>
</span><a name="line-1041"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682865231"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">tcEqType</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865232"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1042"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTcReflCo</span><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865231"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyBag</span><span class="hs-special">)</span><span>
</span><a name="line-1043"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1044"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865233"><a href="#local-6989586621682865233"><span class="hs-identifier">wanted</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865234"><a href="#local-6989586621682865234"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#newWantedEq"><span class="hs-identifier hs-var">newWantedEq</span></a><span> </span><a href="#local-6989586621682865229"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865231"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865232"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1045"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682865234"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unitBag</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkNonCanonical</span><span> </span><a href="#local-6989586621682865233"><span class="hs-identifier hs-var">wanted</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1046"></a><span>
</span><a name="line-1047"></a><span class="hs-comment">---------------------------------</span><span>
</span><a name="line-1048"></a><span class="hs-comment">-- | Compare types for equality, while zonking as necessary. Gives up</span><span>
</span><a name="line-1049"></a><span class="hs-comment">-- as soon as it finds that two types are not equal.</span><span>
</span><a name="line-1050"></a><span class="hs-comment">-- This is quite handy when some unification has made two</span><span>
</span><a name="line-1051"></a><span class="hs-comment">-- types in an inert wanted to be equal. We can discover the equality without</span><span>
</span><a name="line-1052"></a><span class="hs-comment">-- flattening, which is sometimes very expensive (in the case of type functions).</span><span>
</span><a name="line-1053"></a><span class="hs-comment">-- In particular, this function makes a ~20% improvement in test case</span><span>
</span><a name="line-1054"></a><span class="hs-comment">-- perf/compiler/T5030.</span><span>
</span><a name="line-1055"></a><span class="hs-comment">--</span><span>
</span><a name="line-1056"></a><span class="hs-comment">-- Returns either the (partially zonked) types in the case of</span><span>
</span><a name="line-1057"></a><span class="hs-comment">-- inequality, or the one type in the case of equality. canEqReflexive is</span><span>
</span><a name="line-1058"></a><span class="hs-comment">-- a good next step in the 'Right' case. Returning 'Left' is always safe.</span><span>
</span><a name="line-1059"></a><span class="hs-comment">--</span><span>
</span><a name="line-1060"></a><span class="hs-comment">-- NB: This does *not* look through type synonyms. In fact, it treats type</span><span>
</span><a name="line-1061"></a><span class="hs-comment">-- synonyms as rigid constructors. In the future, it might be convenient</span><span>
</span><a name="line-1062"></a><span class="hs-comment">-- to look at only those arguments of type synonyms that actually appear</span><span>
</span><a name="line-1063"></a><span class="hs-comment">-- in the synonym RHS. But we're not there yet.</span><span>
</span><a name="line-1064"></a><span class="hs-identifier">zonk_eq_types</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Pair</span><span> </span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">)</span><span>
</span><a name="line-1065"></a><a name="zonk_eq_types"><a href="TcCanonical.html#zonk_eq_types"><span class="hs-identifier">zonk_eq_types</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865263"><span class="hs-identifier hs-var">go</span></a><span>
</span><a name="line-1066"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1067"></a><span>    </span><a name="local-6989586621682865263"><a href="#local-6989586621682865263"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyVarTy</span><span> </span><a name="local-6989586621682865275"><a href="#local-6989586621682865275"><span class="hs-identifier">tv1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyVarTy</span><span> </span><a name="local-6989586621682865276"><a href="#local-6989586621682865276"><span class="hs-identifier">tv2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865266"><span class="hs-identifier hs-var">tyvar_tyvar</span></a><span> </span><a href="#local-6989586621682865275"><span class="hs-identifier hs-var">tv1</span></a><span> </span><a href="#local-6989586621682865276"><span class="hs-identifier hs-var">tv2</span></a><span>
</span><a name="line-1068"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyVarTy</span><span> </span><a name="local-6989586621682865277"><a href="#local-6989586621682865277"><span class="hs-identifier">tv1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682865278"><a href="#local-6989586621682865278"><span class="hs-identifier">ty2</span></a></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865265"><span class="hs-identifier hs-var">tyvar</span></a><span> </span><span class="hs-identifier hs-var">NotSwapped</span><span> </span><a href="#local-6989586621682865277"><span class="hs-identifier hs-var">tv1</span></a><span> </span><a href="#local-6989586621682865278"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1069"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682865279"><a href="#local-6989586621682865279"><span class="hs-identifier">ty1</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyVarTy</span><span> </span><a name="local-6989586621682865280"><a href="#local-6989586621682865280"><span class="hs-identifier">tv2</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865265"><span class="hs-identifier hs-var">tyvar</span></a><span> </span><span class="hs-identifier hs-var">IsSwapped</span><span>  </span><a href="#local-6989586621682865280"><span class="hs-identifier hs-var">tv2</span></a><span> </span><a href="#local-6989586621682865279"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-1070"></a><span>
</span><a name="line-1071"></a><span>    </span><span class="hs-comment">-- We handle FunTys explicitly here despite the fact that they could also be</span><span>
</span><a name="line-1072"></a><span>    </span><span class="hs-comment">-- treated as an application. Why? Well, for one it's cheaper to just look</span><span>
</span><a name="line-1073"></a><span>    </span><span class="hs-comment">-- at two types (the argument and result types) than four (the argument,</span><span>
</span><a name="line-1074"></a><span>    </span><span class="hs-comment">-- result, and their RuntimeReps). Also, we haven't completely zonked yet,</span><span>
</span><a name="line-1075"></a><span>    </span><span class="hs-comment">-- so we may run into an unzonked type variable while trying to compute the</span><span>
</span><a name="line-1076"></a><span>    </span><span class="hs-comment">-- RuntimeReps of the argument and result types. This can be observed in</span><span>
</span><a name="line-1077"></a><span>    </span><span class="hs-comment">-- testcase tc269.</span><span>
</span><a name="line-1078"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682865281"><a href="#local-6989586621682865281"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865282"><a href="#local-6989586621682865282"><span class="hs-identifier">ty2</span></a></a><span>
</span><a name="line-1079"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865285"><a href="#local-6989586621682865285"><span class="hs-identifier">arg1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865286"><a href="#local-6989586621682865286"><span class="hs-identifier">res1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682865283"><span class="hs-identifier hs-var">split1</span></a><span>
</span><a name="line-1080"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865287"><a href="#local-6989586621682865287"><span class="hs-identifier">arg2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865288"><a href="#local-6989586621682865288"><span class="hs-identifier">res2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682865284"><span class="hs-identifier hs-var">split2</span></a><span>
</span><a name="line-1081"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682865289"><a href="#local-6989586621682865289"><span class="hs-identifier">res_a</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682865263"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682865285"><span class="hs-identifier hs-var">arg1</span></a><span> </span><a href="#local-6989586621682865287"><span class="hs-identifier hs-var">arg2</span></a><span>
</span><a name="line-1082"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682865290"><a href="#local-6989586621682865290"><span class="hs-identifier">res_b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682865263"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682865286"><span class="hs-identifier hs-var">res1</span></a><span> </span><a href="#local-6989586621682865288"><span class="hs-identifier hs-var">res2</span></a><span>
</span><a name="line-1083"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682865271"><span class="hs-identifier hs-var">combine_rev</span></a><span> </span><span class="hs-identifier hs-var">mkFunTy</span><span> </span><a href="#local-6989586621682865290"><span class="hs-identifier hs-var">res_b</span></a><span> </span><a href="#local-6989586621682865289"><span class="hs-identifier hs-var">res_a</span></a><span>
</span><a name="line-1084"></a><span>           </span><span class="hs-special">}</span><span>
</span><a name="line-1085"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><a href="#local-6989586621682865283"><span class="hs-identifier hs-var">split1</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><a href="#local-6989586621682865284"><span class="hs-identifier hs-var">split2</span></a><span>
</span><a name="line-1086"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865264"><span class="hs-identifier hs-var">bale_out</span></a><span> </span><a href="#local-6989586621682865281"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865282"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1087"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1088"></a><span>        </span><a name="local-6989586621682865283"><a href="#local-6989586621682865283"><span class="hs-identifier">split1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitFunTy_maybe</span><span> </span><a href="#local-6989586621682865281"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-1089"></a><span>        </span><a name="local-6989586621682865284"><a href="#local-6989586621682865284"><span class="hs-identifier">split2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitFunTy_maybe</span><span> </span><a href="#local-6989586621682865282"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1090"></a><span>
</span><a name="line-1091"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682865291"><a href="#local-6989586621682865291"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865292"><a href="#local-6989586621682865292"><span class="hs-identifier">ty2</span></a></a><span>
</span><a name="line-1092"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865293"><a href="#local-6989586621682865293"><span class="hs-identifier">tc1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865294"><a href="#local-6989586621682865294"><span class="hs-identifier">tys1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcRepSplitTyConApp_maybe</span><span> </span><a href="#local-6989586621682865291"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-1093"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865295"><a href="#local-6989586621682865295"><span class="hs-identifier">tc2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865296"><a href="#local-6989586621682865296"><span class="hs-identifier">tys2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcRepSplitTyConApp_maybe</span><span> </span><a href="#local-6989586621682865292"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1094"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682865293"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682865295"><span class="hs-identifier hs-var">tc2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621682865294"><span class="hs-identifier hs-var">tys1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">equalLength</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865296"><span class="hs-identifier hs-var">tys2</span></a><span>
</span><a name="line-1095"></a><span>          </span><span class="hs-comment">-- Crucial to check for equal-length args, because</span><span>
</span><a name="line-1096"></a><span>          </span><span class="hs-comment">-- we cannot assume that the two args to 'go' have</span><span>
</span><a name="line-1097"></a><span>          </span><span class="hs-comment">-- the same kind.  E.g go (Proxy *      (Maybe Int))</span><span>
</span><a name="line-1098"></a><span>          </span><span class="hs-comment">--                        (Proxy (*-&gt;*) Maybe)</span><span>
</span><a name="line-1099"></a><span>          </span><span class="hs-comment">-- We'll call (go (Maybe Int) Maybe)</span><span>
</span><a name="line-1100"></a><span>          </span><span class="hs-comment">-- See Trac #13083</span><span>
</span><a name="line-1101"></a><span>        </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621682865269"><span class="hs-identifier hs-var">tycon</span></a><span> </span><a href="#local-6989586621682865293"><span class="hs-identifier hs-var">tc1</span></a><span> </span><a href="#local-6989586621682865294"><span class="hs-identifier hs-var">tys1</span></a><span> </span><a href="#local-6989586621682865296"><span class="hs-identifier hs-var">tys2</span></a><span>
</span><a name="line-1102"></a><span>        </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621682865264"><span class="hs-identifier hs-var">bale_out</span></a><span> </span><a href="#local-6989586621682865291"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865292"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1103"></a><span>
</span><a name="line-1104"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682865297"><a href="#local-6989586621682865297"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865298"><a href="#local-6989586621682865298"><span class="hs-identifier">ty2</span></a></a><span>
</span><a name="line-1105"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865299"><a href="#local-6989586621682865299"><span class="hs-identifier">ty1a</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865300"><a href="#local-6989586621682865300"><span class="hs-identifier">ty1b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcRepSplitAppTy_maybe</span><span> </span><a href="#local-6989586621682865297"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-1106"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865301"><a href="#local-6989586621682865301"><span class="hs-identifier">ty2a</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865302"><a href="#local-6989586621682865302"><span class="hs-identifier">ty2b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcRepSplitAppTy_maybe</span><span> </span><a href="#local-6989586621682865298"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1107"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682865303"><a href="#local-6989586621682865303"><span class="hs-identifier">res_a</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682865263"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682865299"><span class="hs-identifier hs-var">ty1a</span></a><span> </span><a href="#local-6989586621682865301"><span class="hs-identifier hs-var">ty2a</span></a><span>
</span><a name="line-1108"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682865304"><a href="#local-6989586621682865304"><span class="hs-identifier">res_b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682865263"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682865300"><span class="hs-identifier hs-var">ty1b</span></a><span> </span><a href="#local-6989586621682865302"><span class="hs-identifier hs-var">ty2b</span></a><span>
</span><a name="line-1109"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682865271"><span class="hs-identifier hs-var">combine_rev</span></a><span> </span><span class="hs-identifier hs-var">mkAppTy</span><span> </span><a href="#local-6989586621682865304"><span class="hs-identifier hs-var">res_b</span></a><span> </span><a href="#local-6989586621682865303"><span class="hs-identifier hs-var">res_a</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1110"></a><span>
</span><a name="line-1111"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682865305"><a href="#local-6989586621682865305"><span class="hs-identifier">ty1</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitTy</span><span> </span><a name="local-6989586621682865306"><a href="#local-6989586621682865306"><span class="hs-identifier">lit1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitTy</span><span> </span><a name="local-6989586621682865307"><a href="#local-6989586621682865307"><span class="hs-identifier">lit2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1112"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682865306"><span class="hs-identifier hs-var">lit1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682865307"><span class="hs-identifier hs-var">lit2</span></a><span>
</span><a name="line-1113"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621682865305"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1114"></a><span>
</span><a name="line-1115"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682865308"><a href="#local-6989586621682865308"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865309"><a href="#local-6989586621682865309"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865264"><span class="hs-identifier hs-var">bale_out</span></a><span> </span><a href="#local-6989586621682865308"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865309"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1116"></a><span>      </span><span class="hs-comment">-- We don't handle more complex forms here</span><span>
</span><a name="line-1117"></a><span>
</span><a name="line-1118"></a><span>    </span><a name="local-6989586621682865264"><a href="#local-6989586621682865264"><span class="hs-identifier">bale_out</span></a></a><span> </span><a name="local-6989586621682865310"><a href="#local-6989586621682865310"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865311"><a href="#local-6989586621682865311"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Pair</span><span> </span><a href="#local-6989586621682865310"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865311"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1119"></a><span>
</span><a name="line-1120"></a><span>    </span><span class="hs-identifier">tyvar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SwapFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>
</span><a name="line-1121"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Pair</span><span> </span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">)</span><span>
</span><a name="line-1122"></a><span>      </span><span class="hs-comment">-- Try to do as little as possible, as anything we do here is redundant</span><span>
</span><a name="line-1123"></a><span>      </span><span class="hs-comment">-- with flattening. In particular, no need to zonk kinds. That's why</span><span>
</span><a name="line-1124"></a><span>      </span><span class="hs-comment">-- we don't use the already-defined zonking functions</span><span>
</span><a name="line-1125"></a><span>    </span><a name="local-6989586621682865265"><a href="#local-6989586621682865265"><span class="hs-identifier">tyvar</span></a></a><span> </span><a name="local-6989586621682865312"><a href="#local-6989586621682865312"><span class="hs-identifier">swapped</span></a></a><span> </span><a name="local-6989586621682865313"><a href="#local-6989586621682865313"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-6989586621682865314"><a href="#local-6989586621682865314"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1126"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">tcTyVarDetails</span><span> </span><a href="#local-6989586621682865313"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1127"></a><span>          </span><span class="hs-identifier hs-var">MetaTv</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mtv_ref</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682865316"><a href="#local-6989586621682865316"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1128"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682865317"><a href="#local-6989586621682865317"><span class="hs-identifier">cts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-6989586621682865316"><span class="hs-identifier hs-var">ref</span></a><span>
</span><a name="line-1129"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682865317"><span class="hs-identifier hs-var">cts</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1130"></a><span>                      </span><span class="hs-identifier hs-var">Flexi</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682865315"><span class="hs-identifier hs-var">give_up</span></a><span>
</span><a name="line-1131"></a><span>                      </span><span class="hs-identifier hs-var">Indirect</span><span> </span><a name="local-6989586621682865318"><a href="#local-6989586621682865318"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="#local-6989586621682865267"><span class="hs-identifier hs-var">trace_indirect</span></a><span> </span><a href="#local-6989586621682865313"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-6989586621682865318"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-1132"></a><span>                                         </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">unSwap</span><span> </span><a href="#local-6989586621682865312"><span class="hs-identifier hs-var">swapped</span></a><span> </span><a href="#local-6989586621682865263"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682865318"><span class="hs-identifier hs-var">ty'</span></a><span> </span><a href="#local-6989586621682865314"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1133"></a><span>          </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682865315"><span class="hs-identifier hs-var">give_up</span></a><span>
</span><a name="line-1134"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1135"></a><span>        </span><a name="local-6989586621682865315"><a href="#local-6989586621682865315"><span class="hs-identifier">give_up</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unSwap</span><span> </span><a href="#local-6989586621682865312"><span class="hs-identifier hs-var">swapped</span></a><span> </span><span class="hs-identifier hs-var">Pair</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621682865313"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682865314"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1136"></a><span>
</span><a name="line-1137"></a><span>    </span><a name="local-6989586621682865266"><a href="#local-6989586621682865266"><span class="hs-identifier">tyvar_tyvar</span></a></a><span> </span><a name="local-6989586621682865319"><a href="#local-6989586621682865319"><span class="hs-identifier">tv1</span></a></a><span> </span><a name="local-6989586621682865320"><a href="#local-6989586621682865320"><span class="hs-identifier">tv2</span></a></a><span>
</span><a name="line-1138"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682865319"><span class="hs-identifier hs-var">tv1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682865320"><span class="hs-identifier hs-var">tv2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621682865319"><span class="hs-identifier hs-var">tv1</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1139"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865321"><a href="#local-6989586621682865321"><span class="hs-identifier">ty1'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865322"><a href="#local-6989586621682865322"><span class="hs-identifier">progress1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682865268"><span class="hs-identifier hs-var">quick_zonk</span></a><span> </span><a href="#local-6989586621682865319"><span class="hs-identifier hs-var">tv1</span></a><span>
</span><a name="line-1140"></a><span>                        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865323"><a href="#local-6989586621682865323"><span class="hs-identifier">ty2'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865324"><a href="#local-6989586621682865324"><span class="hs-identifier">progress2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682865268"><span class="hs-identifier hs-var">quick_zonk</span></a><span> </span><a href="#local-6989586621682865320"><span class="hs-identifier hs-var">tv2</span></a><span>
</span><a name="line-1141"></a><span>                        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682865322"><span class="hs-identifier hs-var">progress1</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621682865324"><span class="hs-identifier hs-var">progress2</span></a><span>
</span><a name="line-1142"></a><span>                          </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621682865263"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682865321"><span class="hs-identifier hs-var">ty1'</span></a><span> </span><a href="#local-6989586621682865323"><span class="hs-identifier hs-var">ty2'</span></a><span>
</span><a name="line-1143"></a><span>                          </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Pair</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyVarTy</span><span> </span><a href="#local-6989586621682865319"><span class="hs-identifier hs-var">tv1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyVarTy</span><span> </span><a href="#local-6989586621682865320"><span class="hs-identifier hs-var">tv2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1144"></a><span>
</span><a name="line-1145"></a><span>    </span><a name="local-6989586621682865267"><a href="#local-6989586621682865267"><span class="hs-identifier">trace_indirect</span></a></a><span> </span><a name="local-6989586621682865325"><a href="#local-6989586621682865325"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-6989586621682865326"><a href="#local-6989586621682865326"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1146"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;Following filled tyvar (zonk_eq_types)&quot;</span><span>
</span><a name="line-1147"></a><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865325"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">equals</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865326"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1148"></a><span>
</span><a name="line-1149"></a><span>    </span><a name="local-6989586621682865268"><a href="#local-6989586621682865268"><span class="hs-identifier">quick_zonk</span></a></a><span> </span><a name="local-6989586621682865327"><a href="#local-6989586621682865327"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">tcTyVarDetails</span><span> </span><a href="#local-6989586621682865327"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1150"></a><span>      </span><span class="hs-identifier hs-var">MetaTv</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mtv_ref</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682865328"><a href="#local-6989586621682865328"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1151"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682865329"><a href="#local-6989586621682865329"><span class="hs-identifier">cts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-6989586621682865328"><span class="hs-identifier hs-var">ref</span></a><span>
</span><a name="line-1152"></a><span>              </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682865329"><span class="hs-identifier hs-var">cts</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1153"></a><span>                  </span><span class="hs-identifier hs-var">Flexi</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyVarTy</span><span> </span><a href="#local-6989586621682865327"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span>
</span><a name="line-1154"></a><span>                  </span><span class="hs-identifier hs-var">Indirect</span><span> </span><a name="local-6989586621682865330"><a href="#local-6989586621682865330"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="#local-6989586621682865267"><span class="hs-identifier hs-var">trace_indirect</span></a><span> </span><a href="#local-6989586621682865327"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-6989586621682865330"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-1155"></a><span>                                     </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682865330"><span class="hs-identifier hs-var">ty'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1156"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyVarTy</span><span> </span><a href="#local-6989586621682865327"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span>
</span><a name="line-1157"></a><span>
</span><a name="line-1158"></a><span>      </span><span class="hs-comment">-- This happens for type families, too. But recall that failure</span><span>
</span><a name="line-1159"></a><span>      </span><span class="hs-comment">-- here just means to try harder, so it's OK if the type function</span><span>
</span><a name="line-1160"></a><span>      </span><span class="hs-comment">-- isn't injective.</span><span>
</span><a name="line-1161"></a><span>    </span><span class="hs-identifier">tycon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span>
</span><a name="line-1162"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Pair</span><span> </span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">)</span><span>
</span><a name="line-1163"></a><span>    </span><a name="local-6989586621682865269"><a href="#local-6989586621682865269"><span class="hs-identifier">tycon</span></a></a><span> </span><a name="local-6989586621682865331"><a href="#local-6989586621682865331"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682865332"><a href="#local-6989586621682865332"><span class="hs-identifier">tys1</span></a></a><span> </span><a name="local-6989586621682865333"><a href="#local-6989586621682865333"><span class="hs-identifier">tys2</span></a></a><span>
</span><a name="line-1164"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682865334"><a href="#local-6989586621682865334"><span class="hs-identifier">results</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zipWithM</span><span> </span><a href="#local-6989586621682865263"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682865332"><span class="hs-identifier hs-var">tys1</span></a><span> </span><a href="#local-6989586621682865333"><span class="hs-identifier hs-var">tys2</span></a><span>
</span><a name="line-1165"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682865270"><span class="hs-identifier hs-var">combine_results</span></a><span> </span><a href="#local-6989586621682865334"><span class="hs-identifier hs-var">results</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1166"></a><span>               </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621682865335"><a href="#local-6989586621682865335"><span class="hs-identifier">tys</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621682865331"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621682865335"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-1167"></a><span>               </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621682865336"><a href="#local-6989586621682865336"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621682865331"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682865336"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1168"></a><span>
</span><a name="line-1169"></a><span>    </span><span class="hs-identifier">combine_results</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Pair</span><span> </span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span>
</span><a name="line-1170"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Pair</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span>
</span><a name="line-1171"></a><span>    </span><a name="local-6989586621682865270"><a href="#local-6989586621682865270"><span class="hs-identifier">combine_results</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bimap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">reverse</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-1172"></a><span>                      </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682865271"><span class="hs-identifier hs-var">combine_rev</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1173"></a><span>
</span><a name="line-1174"></a><span>      </span><span class="hs-comment">-- combine (in reverse) a new result onto an already-combined result</span><span>
</span><a name="line-1175"></a><span>    </span><span class="hs-identifier">combine_rev</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682865272"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682865273"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682865274"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span>
</span><a name="line-1176"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Pair</span><span> </span><a href="#local-6989586621682865273"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682865273"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1177"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Pair</span><span> </span><a href="#local-6989586621682865272"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682865272"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1178"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Pair</span><span> </span><a href="#local-6989586621682865274"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682865274"><span class="hs-identifier hs-type">c</span></a><span>
</span><a name="line-1179"></a><span>    </span><a name="local-6989586621682865271"><a href="#local-6989586621682865271"><span class="hs-identifier">combine_rev</span></a></a><span> </span><a name="local-6989586621682865337"><a href="#local-6989586621682865337"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621682865338"><a href="#local-6989586621682865338"><span class="hs-identifier">list</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621682865339"><a href="#local-6989586621682865339"><span class="hs-identifier">elt</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682865337"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621682865339"><span class="hs-identifier hs-var">elt</span></a><span>     </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="#local-6989586621682865338"><span class="hs-identifier hs-var">list</span></a><span class="hs-special">)</span><span>
</span><a name="line-1180"></a><span>    </span><span class="hs-identifier">combine_rev</span><span> </span><a name="local-6989586621682865340"><a href="#local-6989586621682865340"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621682865341"><a href="#local-6989586621682865341"><span class="hs-identifier">list</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621682865342"><a href="#local-6989586621682865342"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682865340"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621682865342"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="#local-6989586621682865341"><span class="hs-identifier hs-var">list</span></a><span class="hs-special">)</span><span>
</span><a name="line-1181"></a><span>    </span><span class="hs-identifier">combine_rev</span><span> </span><a name="local-6989586621682865343"><a href="#local-6989586621682865343"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621682865344"><a href="#local-6989586621682865344"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621682865345"><a href="#local-6989586621682865345"><span class="hs-identifier">elt</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682865343"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621682865345"><span class="hs-identifier hs-var">elt</span></a><span>     </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621682865344"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-1182"></a><span>    </span><span class="hs-identifier">combine_rev</span><span> </span><a name="local-6989586621682865346"><a href="#local-6989586621682865346"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621682865347"><a href="#local-6989586621682865347"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621682865348"><a href="#local-6989586621682865348"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682865346"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621682865348"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621682865347"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-1183"></a><span>
</span><a name="line-1184"></a><span class="hs-comment">{- See Note [Unwrap newtypes first]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
  newtype N m a = MkN (m a)
Then N will get a conservative, Nominal role for its second parameter 'a',
because it appears as an argument to the unknown 'm'. Now consider
  [W] N Maybe a  ~R#  N Maybe b

If we decompose, we'll get
  [W] a ~N# b

But if instead we unwrap we'll get
  [W] Maybe a ~R# Maybe b
which in turn gives us
  [W] a ~R# b
which is easier to satisfy.

Bottom line: unwrap newtypes before decomposing them!
c.f. Trac #9123 comment:52,53 for a compelling example.

Note [Newtypes can blow the stack]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have

  newtype X = MkX (Int -&gt; X)
  newtype Y = MkY (Int -&gt; Y)

and now wish to prove

  [W] X ~R Y

This Wanted will loop, expanding out the newtypes ever deeper looking
for a solid match or a solid discrepancy. Indeed, there is something
appropriate to this looping, because X and Y *do* have the same representation,
in the limit -- they're both (Fix ((-&gt;) Int)). However, no finitely-sized
coercion will ever witness it. This loop won't actually cause GHC to hang,
though, because we check our depth when unwrapping newtypes.

Note [Eager reflexivity check]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have

  newtype X = MkX (Int -&gt; X)

and

  [W] X ~R X

Naively, we would start unwrapping X and end up in a loop. Instead,
we do this eager reflexivity check. This is necessary only for representational
equality because the flattener technology deals with the similar case
(recursive type families) for nominal equality.

Note that this check does not catch all cases, but it will catch the cases
we're most worried about, types like X above that are actually inhabited.

Here's another place where this reflexivity check is key:
Consider trying to prove (f a) ~R (f a). The AppTys in there can't
be decomposed, because representational equality isn't congruent with respect
to AppTy. So, when canonicalising the equality above, we get stuck and
would normally produce a CIrredCan. However, we really do want to
be able to solve (f a) ~R (f a). So, in the representational case only,
we do a reflexivity check.

(This would be sound in the nominal case, but unnecessary, and I [Richard
E.] am worried that it would slow down the common case.)
-}</span><span>
</span><a name="line-1251"></a><span>
</span><a name="line-1252"></a><span class="hs-comment">------------------------</span><span>
</span><a name="line-1253"></a><span class="hs-comment">-- | We're able to unwrap a newtype. Update the bits accordingly.</span><span>
</span><a name="line-1254"></a><span class="hs-identifier">can_eq_newtype_nc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span>           </span><span class="hs-comment">-- ^ :: ty1 ~ ty2</span><span>
</span><a name="line-1255"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SwapFlag</span><span>
</span><a name="line-1256"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>                                    </span><span class="hs-comment">-- ^ ty1</span><span>
</span><a name="line-1257"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bag</span><span> </span><span class="hs-identifier hs-type">GlobalRdrElt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcCoercion</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ :: ty1 ~ ty1'</span><span>
</span><a name="line-1258"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>               </span><span class="hs-comment">-- ^ ty2</span><span>
</span><a name="line-1259"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>               </span><span class="hs-comment">-- ^ ty2, with type synonyms</span><span>
</span><a name="line-1260"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span>
</span><a name="line-1261"></a><a name="can_eq_newtype_nc"><a href="TcCanonical.html#can_eq_newtype_nc"><span class="hs-identifier">can_eq_newtype_nc</span></a></a><span> </span><a name="local-6989586621682865349"><a href="#local-6989586621682865349"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865350"><a href="#local-6989586621682865350"><span class="hs-identifier">swapped</span></a></a><span> </span><a name="local-6989586621682865351"><a href="#local-6989586621682865351"><span class="hs-identifier">ty1</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621682865352"><a href="#local-6989586621682865352"><span class="hs-identifier">gres</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865353"><a href="#local-6989586621682865353"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682865354"><a href="#local-6989586621682865354"><span class="hs-identifier">ty1'</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682865355"><a href="#local-6989586621682865355"><span class="hs-identifier">ty2</span></a></a><span> </span><a name="local-6989586621682865356"><a href="#local-6989586621682865356"><span class="hs-identifier">ps_ty2</span></a></a><span>
</span><a name="line-1262"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;can_eq_newtype_nc&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1263"></a><span>         </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865349"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865350"><span class="hs-identifier hs-var">swapped</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865353"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865352"><span class="hs-identifier hs-var">gres</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865354"><span class="hs-identifier hs-var">ty1'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865355"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1264"></a><span>
</span><a name="line-1265"></a><span>         </span><span class="hs-comment">-- check for blowing our stack:</span><span>
</span><a name="line-1266"></a><span>         </span><span class="hs-comment">-- See Note [Newtypes can blow the stack]</span><span>
</span><a name="line-1267"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#checkReductionDepth"><span class="hs-identifier hs-var">checkReductionDepth</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvLoc</span><span> </span><a href="#local-6989586621682865349"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682865351"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-1268"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#addUsedGREs"><span class="hs-identifier hs-var">addUsedGREs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bagToList</span><span> </span><a href="#local-6989586621682865352"><span class="hs-identifier hs-var">gres</span></a><span class="hs-special">)</span><span>
</span><a name="line-1269"></a><span>           </span><span class="hs-comment">-- we have actually used the newtype constructor here, so</span><span>
</span><a name="line-1270"></a><span>           </span><span class="hs-comment">-- make sure we don't warn about importing it!</span><span>
</span><a name="line-1271"></a><span>
</span><a name="line-1272"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682865357"><a href="#local-6989586621682865357"><span class="hs-identifier">new_ev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcCanonical.html#rewriteEqEvidence"><span class="hs-identifier hs-var">rewriteEqEvidence</span></a><span> </span><a href="#local-6989586621682865349"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865350"><span class="hs-identifier hs-var">swapped</span></a><span> </span><a href="#local-6989586621682865354"><span class="hs-identifier hs-var">ty1'</span></a><span> </span><a href="#local-6989586621682865356"><span class="hs-identifier hs-var">ps_ty2</span></a><span>
</span><a name="line-1273"></a><span>                                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTcSymCo</span><span> </span><a href="#local-6989586621682865353"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTcReflCo</span><span> </span><span class="hs-identifier hs-var">Representational</span><span> </span><a href="#local-6989586621682865356"><span class="hs-identifier hs-var">ps_ty2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1274"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#can_eq_nc"><span class="hs-identifier hs-var">can_eq_nc</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621682865357"><span class="hs-identifier hs-var">new_ev</span></a><span> </span><span class="hs-identifier hs-var">ReprEq</span><span> </span><a href="#local-6989586621682865354"><span class="hs-identifier hs-var">ty1'</span></a><span> </span><a href="#local-6989586621682865354"><span class="hs-identifier hs-var">ty1'</span></a><span> </span><a href="#local-6989586621682865355"><span class="hs-identifier hs-var">ty2</span></a><span> </span><a href="#local-6989586621682865356"><span class="hs-identifier hs-var">ps_ty2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1275"></a><span>
</span><a name="line-1276"></a><span class="hs-comment">---------</span><span>
</span><a name="line-1277"></a><span class="hs-comment">-- ^ Decompose a type application.</span><span>
</span><a name="line-1278"></a><span class="hs-comment">-- All input types must be flat. See Note [Canonicalising type applications]</span><span>
</span><a name="line-1279"></a><span class="hs-comment">-- Nominal equality only!</span><span>
</span><a name="line-1280"></a><span class="hs-identifier">can_eq_app</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span>       </span><span class="hs-comment">-- :: s1 t1 ~N s2 t2</span><span>
</span><a name="line-1281"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Xi</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Xi</span><span>         </span><span class="hs-comment">-- s1 t1</span><span>
</span><a name="line-1282"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Xi</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Xi</span><span>         </span><span class="hs-comment">-- s2 t2</span><span>
</span><a name="line-1283"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span>
</span><a name="line-1284"></a><span>
</span><a name="line-1285"></a><span class="hs-comment">-- AppTys only decompose for nominal equality, so this case just leads</span><span>
</span><a name="line-1286"></a><span class="hs-comment">-- to an irreducible constraint; see typecheck/should_compile/T10494</span><span>
</span><a name="line-1287"></a><span class="hs-comment">-- See Note [Decomposing equality], note {4}</span><span>
</span><a name="line-1288"></a><a name="can_eq_app"><a href="TcCanonical.html#can_eq_app"><span class="hs-identifier">can_eq_app</span></a></a><span> </span><a name="local-6989586621682865358"><a href="#local-6989586621682865358"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865359"><a href="#local-6989586621682865359"><span class="hs-identifier">s1</span></a></a><span> </span><a name="local-6989586621682865360"><a href="#local-6989586621682865360"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-6989586621682865361"><a href="#local-6989586621682865361"><span class="hs-identifier">s2</span></a></a><span> </span><a name="local-6989586621682865362"><a href="#local-6989586621682865362"><span class="hs-identifier">t2</span></a></a><span>
</span><a name="line-1289"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">CtDerived</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682865368"><a href="#local-6989586621682865368"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682865358"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-1290"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcCanonical.html#unifyDeriveds"><span class="hs-identifier hs-var">unifyDeriveds</span></a><span> </span><a href="#local-6989586621682865368"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Nominal</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nominal</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682865359"><span class="hs-identifier hs-var">s1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682865360"><span class="hs-identifier hs-var">t1</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682865361"><span class="hs-identifier hs-var">s2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682865362"><span class="hs-identifier hs-var">t2</span></a><span class="hs-special">]</span><span>
</span><a name="line-1291"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a><span> </span><a href="#local-6989586621682865358"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-string">&quot;Decomposed [D] AppTy&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1292"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">CtWanted</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_dest</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682865369"><a href="#local-6989586621682865369"><span class="hs-identifier">dest</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ctev_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682865370"><a href="#local-6989586621682865370"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682865358"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-1293"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682865371"><a href="#local-6989586621682865371"><span class="hs-identifier">co_s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcCanonical.html#unifyWanted"><span class="hs-identifier hs-var">unifyWanted</span></a><span> </span><a href="#local-6989586621682865370"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-identifier hs-var">Nominal</span><span> </span><a href="#local-6989586621682865359"><span class="hs-identifier hs-var">s1</span></a><span> </span><a href="#local-6989586621682865361"><span class="hs-identifier hs-var">s2</span></a><span>
</span><a name="line-1294"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682865372"><a href="#local-6989586621682865372"><span class="hs-identifier">arg_loc</span></a></a><span>
</span><a name="line-1295"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isNextArgVisible</span><span> </span><a href="#local-6989586621682865359"><span class="hs-identifier hs-var">s1</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865370"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-1296"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">updateCtLocOrigin</span><span> </span><a href="#local-6989586621682865370"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-identifier hs-var">toInvisibleOrigin</span><span>
</span><a name="line-1297"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682865373"><a href="#local-6989586621682865373"><span class="hs-identifier">co_t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcCanonical.html#unifyWanted"><span class="hs-identifier hs-var">unifyWanted</span></a><span> </span><a href="#local-6989586621682865372"><span class="hs-identifier hs-var">arg_loc</span></a><span> </span><span class="hs-identifier hs-var">Nominal</span><span> </span><a href="#local-6989586621682865360"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-6989586621682865362"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-1298"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682865374"><a href="#local-6989586621682865374"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkAppCo</span><span> </span><a href="#local-6989586621682865371"><span class="hs-identifier hs-var">co_s</span></a><span> </span><a href="#local-6989586621682865373"><span class="hs-identifier hs-var">co_t</span></a><span>
</span><a name="line-1299"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#setWantedEq"><span class="hs-identifier hs-var">setWantedEq</span></a><span> </span><a href="#local-6989586621682865369"><span class="hs-identifier hs-var">dest</span></a><span> </span><a href="#local-6989586621682865374"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1300"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a><span> </span><a href="#local-6989586621682865358"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-string">&quot;Decomposed [W] AppTy&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1301"></a><span>
</span><a name="line-1302"></a><span>    </span><span class="hs-comment">-- If there is a ForAll/(-&gt;) mismatch, the use of the Left coercion</span><span>
</span><a name="line-1303"></a><span>    </span><span class="hs-comment">-- below is ill-typed, potentially leading to a panic in splitTyConApp</span><span>
</span><a name="line-1304"></a><span>    </span><span class="hs-comment">-- Test case: typecheck/should_run/Typeable1</span><span>
</span><a name="line-1305"></a><span>    </span><span class="hs-comment">-- We could also include this mismatch check above (for W and D), but it's slow</span><span>
</span><a name="line-1306"></a><span>    </span><span class="hs-comment">-- and we'll get a better error message not doing it</span><span>
</span><a name="line-1307"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682865363"><span class="hs-identifier hs-var">s1k</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621682865365"><span class="hs-identifier hs-var">mismatches</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865364"><span class="hs-identifier hs-var">s2k</span></a><span>
</span><a name="line-1308"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#canEqHardFailure"><span class="hs-identifier hs-var">canEqHardFailure</span></a><span> </span><a href="#local-6989586621682865358"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682865359"><span class="hs-identifier hs-var">s1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkAppTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865360"><span class="hs-identifier hs-var">t1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682865361"><span class="hs-identifier hs-var">s2</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkAppTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865362"><span class="hs-identifier hs-var">t2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1309"></a><span>
</span><a name="line-1310"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">CtGiven</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_evar</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682865375"><a href="#local-6989586621682865375"><span class="hs-identifier">evar</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ctev_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682865376"><a href="#local-6989586621682865376"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682865358"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-1311"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682865377"><a href="#local-6989586621682865377"><span class="hs-identifier">co</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcCoVarCo</span><span> </span><a href="#local-6989586621682865375"><span class="hs-identifier hs-var">evar</span></a><span>
</span><a name="line-1312"></a><span>             </span><a name="local-6989586621682865378"><a href="#local-6989586621682865378"><span class="hs-identifier">co_s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcLRCo</span><span> </span><span class="hs-identifier hs-var">CLeft</span><span>  </span><a href="#local-6989586621682865377"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1313"></a><span>             </span><a name="local-6989586621682865379"><a href="#local-6989586621682865379"><span class="hs-identifier">co_t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcLRCo</span><span> </span><span class="hs-identifier hs-var">CRight</span><span> </span><a href="#local-6989586621682865377"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1314"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682865380"><a href="#local-6989586621682865380"><span class="hs-identifier">evar_s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#newGivenEvVar"><span class="hs-identifier hs-var">newGivenEvVar</span></a><span> </span><a href="#local-6989586621682865376"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkTcEqPredLikeEv</span><span> </span><a href="#local-6989586621682865358"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865359"><span class="hs-identifier hs-var">s1</span></a><span> </span><a href="#local-6989586621682865361"><span class="hs-identifier hs-var">s2</span></a><span>
</span><a name="line-1315"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">evCoercion</span><span> </span><a href="#local-6989586621682865378"><span class="hs-identifier hs-var">co_s</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1316"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682865381"><a href="#local-6989586621682865381"><span class="hs-identifier">evar_t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#newGivenEvVar"><span class="hs-identifier hs-var">newGivenEvVar</span></a><span> </span><a href="#local-6989586621682865376"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkTcEqPredLikeEv</span><span> </span><a href="#local-6989586621682865358"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865360"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-6989586621682865362"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-1317"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">evCoercion</span><span> </span><a href="#local-6989586621682865379"><span class="hs-identifier hs-var">co_t</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1318"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#emitWorkNC"><span class="hs-identifier hs-var">emitWorkNC</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621682865381"><span class="hs-identifier hs-var">evar_t</span></a><span class="hs-special">]</span><span>
</span><a name="line-1319"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#canEqNC"><span class="hs-identifier hs-var">canEqNC</span></a><span> </span><a href="#local-6989586621682865380"><span class="hs-identifier hs-var">evar_s</span></a><span> </span><span class="hs-identifier hs-var">NomEq</span><span> </span><a href="#local-6989586621682865359"><span class="hs-identifier hs-var">s1</span></a><span> </span><a href="#local-6989586621682865361"><span class="hs-identifier hs-var">s2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1320"></a><span>
</span><a name="line-1321"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1322"></a><span>    </span><a name="local-6989586621682865363"><a href="#local-6989586621682865363"><span class="hs-identifier">s1k</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcTypeKind</span><span> </span><a href="#local-6989586621682865359"><span class="hs-identifier hs-var">s1</span></a><span>
</span><a name="line-1323"></a><span>    </span><a name="local-6989586621682865364"><a href="#local-6989586621682865364"><span class="hs-identifier">s2k</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcTypeKind</span><span> </span><a href="#local-6989586621682865361"><span class="hs-identifier hs-var">s2</span></a><span>
</span><a name="line-1324"></a><span>
</span><a name="line-1325"></a><span>    </span><a name="local-6989586621682865366"><a href="#local-6989586621682865366"><span class="hs-identifier">k1</span></a></a><span> </span><span class="hs-special">`</span><a name="local-6989586621682865365"><a href="#local-6989586621682865365"><span class="hs-identifier">mismatches</span></a></a><span class="hs-special">`</span><span> </span><a name="local-6989586621682865367"><a href="#local-6989586621682865367"><span class="hs-identifier">k2</span></a></a><span>
</span><a name="line-1326"></a><span>      </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">isForAllTy</span><span> </span><a href="#local-6989586621682865366"><span class="hs-identifier hs-var">k1</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isForAllTy</span><span> </span><a href="#local-6989586621682865367"><span class="hs-identifier hs-var">k2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1327"></a><span>      </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isForAllTy</span><span> </span><a href="#local-6989586621682865366"><span class="hs-identifier hs-var">k1</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isForAllTy</span><span> </span><a href="#local-6989586621682865367"><span class="hs-identifier hs-var">k2</span></a><span>
</span><a name="line-1328"></a><span>
</span><a name="line-1329"></a><span class="hs-comment">-----------------------</span><span>
</span><a name="line-1330"></a><span class="hs-comment">-- | Break apart an equality over a casted type</span><span>
</span><a name="line-1331"></a><span class="hs-comment">-- looking like   (ty1 |&gt; co1) ~ ty2   (modulo a swap-flag)</span><span>
</span><a name="line-1332"></a><span class="hs-identifier">canEqCast</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>         </span><span class="hs-comment">-- are both types flat?</span><span>
</span><a name="line-1333"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span>
</span><a name="line-1334"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">EqRel</span><span>
</span><a name="line-1335"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SwapFlag</span><span>
</span><a name="line-1336"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Coercion</span><span>   </span><span class="hs-comment">-- LHS (res. RHS), ty1 |&gt; co1</span><span>
</span><a name="line-1337"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>     </span><span class="hs-comment">-- RHS (res. LHS), ty2 both normal and pretty</span><span>
</span><a name="line-1338"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span>
</span><a name="line-1339"></a><a name="canEqCast"><a href="TcCanonical.html#canEqCast"><span class="hs-identifier">canEqCast</span></a></a><span> </span><a name="local-6989586621682865382"><a href="#local-6989586621682865382"><span class="hs-identifier">flat</span></a></a><span> </span><a name="local-6989586621682865383"><a href="#local-6989586621682865383"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865384"><a href="#local-6989586621682865384"><span class="hs-identifier">eq_rel</span></a></a><span> </span><a name="local-6989586621682865385"><a href="#local-6989586621682865385"><span class="hs-identifier">swapped</span></a></a><span> </span><a name="local-6989586621682865386"><a href="#local-6989586621682865386"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865387"><a href="#local-6989586621682865387"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-6989586621682865388"><a href="#local-6989586621682865388"><span class="hs-identifier">ty2</span></a></a><span> </span><a name="local-6989586621682865389"><a href="#local-6989586621682865389"><span class="hs-identifier">ps_ty2</span></a></a><span>
</span><a name="line-1340"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;Decomposing cast&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865383"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-1341"></a><span>                                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865386"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;|&gt;&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865387"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-1342"></a><span>                                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865389"><span class="hs-identifier hs-var">ps_ty2</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1343"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682865391"><a href="#local-6989586621682865391"><span class="hs-identifier">new_ev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcCanonical.html#rewriteEqEvidence"><span class="hs-identifier hs-var">rewriteEqEvidence</span></a><span> </span><a href="#local-6989586621682865383"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865385"><span class="hs-identifier hs-var">swapped</span></a><span> </span><a href="#local-6989586621682865386"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865389"><span class="hs-identifier hs-var">ps_ty2</span></a><span>
</span><a name="line-1344"></a><span>                                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTcGReflRightCo</span><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865386"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865387"><span class="hs-identifier hs-var">co1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1345"></a><span>                                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTcReflCo</span><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865389"><span class="hs-identifier hs-var">ps_ty2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1346"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#can_eq_nc"><span class="hs-identifier hs-var">can_eq_nc</span></a><span> </span><a href="#local-6989586621682865382"><span class="hs-identifier hs-var">flat</span></a><span> </span><a href="#local-6989586621682865391"><span class="hs-identifier hs-var">new_ev</span></a><span> </span><a href="#local-6989586621682865384"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><a href="#local-6989586621682865386"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865386"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865388"><span class="hs-identifier hs-var">ty2</span></a><span> </span><a href="#local-6989586621682865389"><span class="hs-identifier hs-var">ps_ty2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1347"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1348"></a><span>    </span><span class="hs-keyword">role</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">eqRelRole</span><span> </span><a href="#local-6989586621682865384"><span class="hs-identifier hs-var">eq_rel</span></a><span>
</span><a name="line-1349"></a><span>
</span><a name="line-1350"></a><span class="hs-comment">------------------------</span><span>
</span><a name="line-1351"></a><span class="hs-identifier">canTyConApp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">EqRel</span><span>
</span><a name="line-1352"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span>
</span><a name="line-1353"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span>
</span><a name="line-1354"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span>
</span><a name="line-1355"></a><span class="hs-comment">-- See Note [Decomposing TyConApps]</span><span>
</span><a name="line-1356"></a><a name="canTyConApp"><a href="TcCanonical.html#canTyConApp"><span class="hs-identifier">canTyConApp</span></a></a><span> </span><a name="local-6989586621682865392"><a href="#local-6989586621682865392"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865393"><a href="#local-6989586621682865393"><span class="hs-identifier">eq_rel</span></a></a><span> </span><a name="local-6989586621682865394"><a href="#local-6989586621682865394"><span class="hs-identifier">tc1</span></a></a><span> </span><a name="local-6989586621682865395"><a href="#local-6989586621682865395"><span class="hs-identifier">tys1</span></a></a><span> </span><a name="local-6989586621682865396"><a href="#local-6989586621682865396"><span class="hs-identifier">tc2</span></a></a><span> </span><a name="local-6989586621682865397"><a href="#local-6989586621682865397"><span class="hs-identifier">tys2</span></a></a><span>
</span><a name="line-1357"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682865394"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682865396"><span class="hs-identifier hs-var">tc2</span></a><span>
</span><a name="line-1358"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682865395"><span class="hs-identifier hs-var">tys1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">equalLength</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865397"><span class="hs-identifier hs-var">tys2</span></a><span>
</span><a name="line-1359"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682865404"><a href="#local-6989586621682865404"><span class="hs-identifier">inerts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getTcSInerts"><span class="hs-identifier hs-var">getTcSInerts</span></a><span>
</span><a name="line-1360"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682865402"><span class="hs-identifier hs-var">can_decompose</span></a><span> </span><a href="#local-6989586621682865404"><span class="hs-identifier hs-var">inerts</span></a><span>
</span><a name="line-1361"></a><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;canTyConApp&quot;</span><span>
</span><a name="line-1362"></a><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865392"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865393"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865394"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865395"><span class="hs-identifier hs-var">tys1</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865397"><span class="hs-identifier hs-var">tys2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1363"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#canDecomposableTyConAppOK"><span class="hs-identifier hs-var">canDecomposableTyConAppOK</span></a><span> </span><a href="#local-6989586621682865392"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865393"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><a href="#local-6989586621682865394"><span class="hs-identifier hs-var">tc1</span></a><span> </span><a href="#local-6989586621682865395"><span class="hs-identifier hs-var">tys1</span></a><span> </span><a href="#local-6989586621682865397"><span class="hs-identifier hs-var">tys2</span></a><span>
</span><a name="line-1364"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a><span> </span><a href="#local-6989586621682865392"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-string">&quot;Decomposed TyConApp&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1365"></a><span>         </span><span class="hs-keyword">else</span><span> </span><a href="TcCanonical.html#canEqFailure"><span class="hs-identifier hs-var">canEqFailure</span></a><span> </span><a href="#local-6989586621682865392"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865393"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><a href="#local-6989586621682865398"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865399"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1366"></a><span>
</span><a name="line-1367"></a><span>  </span><span class="hs-comment">-- See Note [Skolem abstract data] (at tyConSkolem)</span><span>
</span><a name="line-1368"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">tyConSkolem</span><span> </span><a href="#local-6989586621682865394"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">tyConSkolem</span><span> </span><a href="#local-6989586621682865396"><span class="hs-identifier hs-var">tc2</span></a><span>
</span><a name="line-1369"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;canTyConApp: skolem abstract&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865394"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865396"><span class="hs-identifier hs-var">tc2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1370"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkIrredCt</span><span> </span><a href="#local-6989586621682865392"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1371"></a><span>
</span><a name="line-1372"></a><span>  </span><span class="hs-comment">-- Fail straight away for better error messages</span><span>
</span><a name="line-1373"></a><span>  </span><span class="hs-comment">-- See Note [Use canEqFailure in canDecomposableTyConApp]</span><span>
</span><a name="line-1374"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682865393"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">ReprEq</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isGenerativeTyCon</span><span> </span><a href="#local-6989586621682865394"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-identifier hs-var">Representational</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-1375"></a><span>                             </span><span class="hs-identifier hs-var">isGenerativeTyCon</span><span> </span><a href="#local-6989586621682865396"><span class="hs-identifier hs-var">tc2</span></a><span> </span><span class="hs-identifier hs-var">Representational</span><span class="hs-special">)</span><span>
</span><a name="line-1376"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#canEqFailure"><span class="hs-identifier hs-var">canEqFailure</span></a><span> </span><a href="#local-6989586621682865392"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865393"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><a href="#local-6989586621682865398"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865399"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1377"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1378"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#canEqHardFailure"><span class="hs-identifier hs-var">canEqHardFailure</span></a><span> </span><a href="#local-6989586621682865392"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865398"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865399"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1379"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1380"></a><span>    </span><a name="local-6989586621682865398"><a href="#local-6989586621682865398"><span class="hs-identifier">ty1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621682865394"><span class="hs-identifier hs-var">tc1</span></a><span> </span><a href="#local-6989586621682865395"><span class="hs-identifier hs-var">tys1</span></a><span>
</span><a name="line-1381"></a><span>    </span><a name="local-6989586621682865399"><a href="#local-6989586621682865399"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621682865396"><span class="hs-identifier hs-var">tc2</span></a><span> </span><a href="#local-6989586621682865397"><span class="hs-identifier hs-var">tys2</span></a><span>
</span><a name="line-1382"></a><span>
</span><a name="line-1383"></a><span>    </span><a name="local-6989586621682865400"><a href="#local-6989586621682865400"><span class="hs-identifier">loc</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ctEvLoc</span><span> </span><a href="#local-6989586621682865392"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-1384"></a><span>    </span><a name="local-6989586621682865401"><a href="#local-6989586621682865401"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ctEvPred</span><span> </span><a href="#local-6989586621682865392"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-1385"></a><span>
</span><a name="line-1386"></a><span>     </span><span class="hs-comment">-- See Note [Decomposing equality]</span><span>
</span><a name="line-1387"></a><span>    </span><a name="local-6989586621682865402"><a href="#local-6989586621682865402"><span class="hs-identifier">can_decompose</span></a></a><span> </span><a name="local-6989586621682865403"><a href="#local-6989586621682865403"><span class="hs-identifier">inerts</span></a></a><span>
</span><a name="line-1388"></a><span>      </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">isInjectiveTyCon</span><span> </span><a href="#local-6989586621682865394"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">eqRelRole</span><span> </span><a href="#local-6989586621682865393"><span class="hs-identifier hs-var">eq_rel</span></a><span class="hs-special">)</span><span>
</span><a name="line-1389"></a><span>      </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvFlavour</span><span> </span><a href="#local-6989586621682865392"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">Given</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isEmptyBag</span><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#matchableGivens"><span class="hs-identifier hs-var">matchableGivens</span></a><span> </span><a href="#local-6989586621682865400"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621682865401"><span class="hs-identifier hs-var">pred</span></a><span> </span><a href="#local-6989586621682865403"><span class="hs-identifier hs-var">inerts</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1390"></a><span>
</span><a name="line-1391"></a><span class="hs-comment">{-
Note [Use canEqFailure in canDecomposableTyConApp]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We must use canEqFailure, not canEqHardFailure here, because there is
the possibility of success if working with a representational equality.
Here is one case:

  type family TF a where TF Char = Bool
  data family DF a
  newtype instance DF Bool = MkDF Int

Suppose we are canonicalising (Int ~R DF (TF a)), where we don't yet
know `a`. This is *not* a hard failure, because we might soon learn
that `a` is, in fact, Char, and then the equality succeeds.

Here is another case:

  [G] Age ~R Int

where Age's constructor is not in scope. We don't want to report
an &quot;inaccessible code&quot; error in the context of this Given!

For example, see typecheck/should_compile/T10493, repeated here:

  import Data.Ord (Down)  -- no constructor

  foo :: Coercible (Down Int) Int =&gt; Down Int -&gt; Int
  foo = coerce

That should compile, but only because we use canEqFailure and not
canEqHardFailure.

Note [Decomposing equality]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we have a constraint (of any flavour and role) that looks like
T tys1 ~ T tys2, what can we conclude about tys1 and tys2? The answer,
of course, is &quot;it depends&quot;. This Note spells it all out.

In this Note, &quot;decomposition&quot; refers to taking the constraint
  [fl] (T tys1 ~X T tys2)
(for some flavour fl and some role X) and replacing it with
  [fls'] (tys1 ~Xs' tys2)
where that notation indicates a list of new constraints, where the
new constraints may have different flavours and different roles.

The key property to consider is injectivity. When decomposing a Given the
decomposition is sound if and only if T is injective in all of its type
arguments. When decomposing a Wanted, the decomposition is sound (assuming the
correct roles in the produced equality constraints), but it may be a guess --
that is, an unforced decision by the constraint solver. Decomposing Wanteds
over injective TyCons does not entail guessing. But sometimes we want to
decompose a Wanted even when the TyCon involved is not injective! (See below.)

So, in broad strokes, we want this rule:

(*) Decompose a constraint (T tys1 ~X T tys2) if and only if T is injective
at role X.

Pursuing the details requires exploring three axes:
* Flavour: Given vs. Derived vs. Wanted
* Role: Nominal vs. Representational
* TyCon species: datatype vs. newtype vs. data family vs. type family vs. type variable

(So a type variable isn't a TyCon, but it's convenient to put the AppTy case
in the same table.)

Right away, we can say that Derived behaves just as Wanted for the purposes
of decomposition. The difference between Derived and Wanted is the handling of
evidence. Since decomposition in these cases isn't a matter of soundness but of
guessing, we want the same behavior regardless of evidence.

Here is a table (discussion following) detailing where decomposition of
   (T s1 ... sn) ~r (T t1 .. tn)
is allowed.  The first four lines (Data types ... type family) refer
to TyConApps with various TyCons T; the last line is for AppTy, where
there is presumably a type variable at the head, so it's actually
   (s s1 ... sn) ~r (t t1 .. tn)

NOMINAL               GIVEN                       WANTED

Datatype               YES                         YES
Newtype                YES                         YES
Data family            YES                         YES
Type family            YES, in injective args{1}   YES, in injective args{1}
Type variable          YES                         YES

REPRESENTATIONAL      GIVEN                       WANTED

Datatype               YES                         YES
Newtype                NO{2}                      MAYBE{2}
Data family            NO{3}                      MAYBE{3}
Type family             NO                          NO
Type variable          NO{4}                       NO{4}

{1}: Type families can be injective in some, but not all, of their arguments,
so we want to do partial decomposition. This is quite different than the way
other decomposition is done, where the decomposed equalities replace the original
one. We thus proceed much like we do with superclasses: emitting new Givens
when &quot;decomposing&quot; a partially-injective type family Given and new Deriveds
when &quot;decomposing&quot; a partially-injective type family Wanted. (As of the time of
writing, 13 June 2015, the implementation of injective type families has not
been merged, but it should be soon. Please delete this parenthetical if the
implementation is indeed merged.)

{2}: See Note [Decomposing newtypes at representational role]

{3}: Because of the possibility of newtype instances, we must treat
data families like newtypes. See also Note [Decomposing newtypes at
representational role]. See #10534 and test case
typecheck/should_fail/T10534.

{4}: Because type variables can stand in for newtypes, we conservatively do not
decompose AppTys over representational equality.

In the implementation of can_eq_nc and friends, we don't directly pattern
match using lines like in the tables above, as those tables don't cover
all cases (what about PrimTyCon? tuples?). Instead we just ask about injectivity,
boiling the tables above down to rule (*). The exceptions to rule (*) are for
injective type families, which are handled separately from other decompositions,
and the MAYBE entries above.

Note [Decomposing newtypes at representational role]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
This note discusses the 'newtype' line in the REPRESENTATIONAL table
in Note [Decomposing equality]. (At nominal role, newtypes are fully
decomposable.)

Here is a representative example of why representational equality over
newtypes is tricky:

  newtype Nt a = Mk Bool         -- NB: a is not used in the RHS,
  type role Nt representational  -- but the user gives it an R role anyway

If we have [W] Nt alpha ~R Nt beta, we *don't* want to decompose to
[W] alpha ~R beta, because it's possible that alpha and beta aren't
representationally equal. Here's another example.

  newtype Nt a = MkNt (Id a)
  type family Id a where Id a = a

  [W] Nt Int ~R Nt Age

Because of its use of a type family, Nt's parameter will get inferred to have
a nominal role. Thus, decomposing the wanted will yield [W] Int ~N Age, which
is unsatisfiable. Unwrapping, though, leads to a solution.

Conclusion:
 * Unwrap newtypes before attempting to decompose them.
   This is done in can_eq_nc'.

It all comes from the fact that newtypes aren't necessarily injective
w.r.t. representational equality.

Furthermore, as explained in Note [NthCo and newtypes] in TyCoRep, we can't use
NthCo on representational coercions over newtypes. NthCo comes into play
only when decomposing givens.

Conclusion:
 * Do not decompose [G] N s ~R N t

Is it sensible to decompose *Wanted* constraints over newtypes?  Yes!
It's the only way we could ever prove (IO Int ~R IO Age), recalling
that IO is a newtype.

However we must be careful.  Consider

  type role Nt representational

  [G] Nt a ~R Nt b       (1)
  [W] NT alpha ~R Nt b   (2)
  [W] alpha ~ a          (3)

If we focus on (3) first, we'll substitute in (2), and now it's
identical to the given (1), so we succeed.  But if we focus on (2)
first, and decompose it, we'll get (alpha ~R b), which is not soluble.
This is exactly like the question of overlapping Givens for class
constraints: see Note [Instance and Given overlap] in TcInteract.

Conclusion:
  * Decompose [W] N s ~R N t  iff there no given constraint that could
    later solve it.
-}</span><span>
</span><a name="line-1573"></a><span>
</span><a name="line-1574"></a><span class="hs-identifier">canDecomposableTyConAppOK</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">EqRel</span><span>
</span><a name="line-1575"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span>
</span><a name="line-1576"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1577"></a><span class="hs-comment">-- Precondition: tys1 and tys2 are the same length, hence &quot;OK&quot;</span><span>
</span><a name="line-1578"></a><a name="canDecomposableTyConAppOK"><a href="TcCanonical.html#canDecomposableTyConAppOK"><span class="hs-identifier">canDecomposableTyConAppOK</span></a></a><span> </span><a name="local-6989586621682865405"><a href="#local-6989586621682865405"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865406"><a href="#local-6989586621682865406"><span class="hs-identifier">eq_rel</span></a></a><span> </span><a name="local-6989586621682865407"><a href="#local-6989586621682865407"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682865408"><a href="#local-6989586621682865408"><span class="hs-identifier">tys1</span></a></a><span> </span><a name="local-6989586621682865409"><a href="#local-6989586621682865409"><span class="hs-identifier">tys2</span></a></a><span>
</span><a name="line-1579"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">tys1</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">equalLength</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">tys2</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1580"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682865405"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1581"></a><span>     </span><span class="hs-identifier hs-var">CtDerived</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>
</span><a name="line-1582"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcCanonical.html#unifyDeriveds"><span class="hs-identifier hs-var">unifyDeriveds</span></a><span> </span><a href="#local-6989586621682865410"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621682865412"><span class="hs-identifier hs-var">tc_roles</span></a><span> </span><a href="#local-6989586621682865408"><span class="hs-identifier hs-var">tys1</span></a><span> </span><a href="#local-6989586621682865409"><span class="hs-identifier hs-var">tys2</span></a><span>
</span><a name="line-1583"></a><span>
</span><a name="line-1584"></a><span>     </span><span class="hs-identifier hs-var">CtWanted</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_dest</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682865417"><a href="#local-6989586621682865417"><span class="hs-identifier">dest</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1585"></a><span>                   </span><span class="hs-comment">-- new_locs and tc_roles are both infinite, so</span><span>
</span><a name="line-1586"></a><span>                   </span><span class="hs-comment">-- we are guaranteed that cos has the same length</span><span>
</span><a name="line-1587"></a><span>                   </span><span class="hs-comment">-- as tys1 and tys2</span><span>
</span><a name="line-1588"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682865418"><a href="#local-6989586621682865418"><span class="hs-identifier">cos</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zipWith4M</span><span> </span><a href="TcCanonical.html#unifyWanted"><span class="hs-identifier hs-var">unifyWanted</span></a><span> </span><a href="#local-6989586621682865413"><span class="hs-identifier hs-var">new_locs</span></a><span> </span><a href="#local-6989586621682865412"><span class="hs-identifier hs-var">tc_roles</span></a><span> </span><a href="#local-6989586621682865408"><span class="hs-identifier hs-var">tys1</span></a><span> </span><a href="#local-6989586621682865409"><span class="hs-identifier hs-var">tys2</span></a><span>
</span><a name="line-1589"></a><span>              </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#setWantedEq"><span class="hs-identifier hs-var">setWantedEq</span></a><span> </span><a href="#local-6989586621682865417"><span class="hs-identifier hs-var">dest</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConAppCo</span><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865407"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682865418"><span class="hs-identifier hs-var">cos</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1590"></a><span>
</span><a name="line-1591"></a><span>     </span><span class="hs-identifier hs-var">CtGiven</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_evar</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682865419"><a href="#local-6989586621682865419"><span class="hs-identifier">evar</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1592"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682865420"><a href="#local-6989586621682865420"><span class="hs-identifier">ev_co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkCoVarCo</span><span> </span><a href="#local-6989586621682865419"><span class="hs-identifier hs-var">evar</span></a><span>
</span><a name="line-1593"></a><span>              </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682865425"><a href="#local-6989586621682865425"><span class="hs-identifier">given_evs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#newGivenEvVars"><span class="hs-identifier hs-var">newGivenEvVars</span></a><span> </span><a href="#local-6989586621682865410"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1594"></a><span>                             </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkPrimEqPredRole</span><span> </span><a href="#local-6989586621682865421"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682865422"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865423"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1595"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">evCoercion</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkNthCo</span><span> </span><a href="#local-6989586621682865421"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682865424"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621682865420"><span class="hs-identifier hs-var">ev_co</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1596"></a><span>                             </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865421"><a href="#local-6989586621682865421"><span class="hs-identifier">r</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865422"><a href="#local-6989586621682865422"><span class="hs-identifier">ty1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865423"><a href="#local-6989586621682865423"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865424"><a href="#local-6989586621682865424"><span class="hs-identifier">i</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zip4</span><span> </span><a href="#local-6989586621682865412"><span class="hs-identifier hs-var">tc_roles</span></a><span> </span><a href="#local-6989586621682865408"><span class="hs-identifier hs-var">tys1</span></a><span> </span><a href="#local-6989586621682865409"><span class="hs-identifier hs-var">tys2</span></a><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><a name="line-1597"></a><span>                             </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682865421"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">Phantom</span><span>
</span><a name="line-1598"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isCoercionTy</span><span> </span><a href="#local-6989586621682865422"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isCoercionTy</span><span> </span><a href="#local-6989586621682865423"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1599"></a><span>              </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#emitWorkNC"><span class="hs-identifier hs-var">emitWorkNC</span></a><span> </span><a href="#local-6989586621682865425"><span class="hs-identifier hs-var">given_evs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1600"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1601"></a><span>    </span><a name="local-6989586621682865410"><a href="#local-6989586621682865410"><span class="hs-identifier">loc</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ctEvLoc</span><span> </span><a href="#local-6989586621682865405"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-1602"></a><span>    </span><span class="hs-keyword">role</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">eqRelRole</span><span> </span><a href="#local-6989586621682865406"><span class="hs-identifier hs-var">eq_rel</span></a><span>
</span><a name="line-1603"></a><span>
</span><a name="line-1604"></a><span>      </span><span class="hs-comment">-- infinite, as tyConRolesX returns an infinite tail of Nominal</span><span>
</span><a name="line-1605"></a><span>    </span><a name="local-6989586621682865412"><a href="#local-6989586621682865412"><span class="hs-identifier">tc_roles</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConRolesX</span><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865407"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1606"></a><span>
</span><a name="line-1607"></a><span>      </span><span class="hs-comment">-- Add nuances to the location during decomposition:</span><span>
</span><a name="line-1608"></a><span>      </span><span class="hs-comment">--  * if the argument is a kind argument, remember this, so that error</span><span>
</span><a name="line-1609"></a><span>      </span><span class="hs-comment">--    messages say &quot;kind&quot;, not &quot;type&quot;. This is determined based on whether</span><span>
</span><a name="line-1610"></a><span>      </span><span class="hs-comment">--    the corresponding tyConBinder is named (that is, dependent)</span><span>
</span><a name="line-1611"></a><span>      </span><span class="hs-comment">--  * if the argument is invisible, note this as well, again by</span><span>
</span><a name="line-1612"></a><span>      </span><span class="hs-comment">--    looking at the corresponding binder</span><span>
</span><a name="line-1613"></a><span>      </span><span class="hs-comment">-- For oversaturated tycons, we need the (repeat loc) tail, which doesn't</span><span>
</span><a name="line-1614"></a><span>      </span><span class="hs-comment">-- do either of these changes. (Forgetting to do so led to #16188)</span><span>
</span><a name="line-1615"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-1616"></a><span>      </span><span class="hs-comment">-- NB: infinite in length</span><span>
</span><a name="line-1617"></a><span>    </span><a name="local-6989586621682865413"><a href="#local-6989586621682865413"><span class="hs-identifier">new_locs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621682865416"><span class="hs-identifier hs-var">new_loc</span></a><span>
</span><a name="line-1618"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621682865414"><a href="#local-6989586621682865414"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">tyConBinders</span><span> </span><a href="#local-6989586621682865407"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1619"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682865415"><a href="#local-6989586621682865415"><span class="hs-identifier">new_loc0</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isNamedTyConBinder</span><span> </span><a href="#local-6989586621682865414"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toKindLoc</span><span> </span><a href="#local-6989586621682865410"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-1620"></a><span>                              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>               </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865410"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-1621"></a><span>                     </span><a name="local-6989586621682865416"><a href="#local-6989586621682865416"><span class="hs-identifier">new_loc</span></a></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isVisibleTyConBinder</span><span> </span><a href="#local-6989586621682865414"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1622"></a><span>                              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">updateCtLocOrigin</span><span> </span><a href="#local-6989586621682865415"><span class="hs-identifier hs-var">new_loc0</span></a><span> </span><span class="hs-identifier hs-var">toInvisibleOrigin</span><span>
</span><a name="line-1623"></a><span>                              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1624"></a><span>                              </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865415"><span class="hs-identifier hs-var">new_loc0</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1625"></a><span>               </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">repeat</span><span> </span><a href="#local-6989586621682865410"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-1626"></a><span>
</span><a name="line-1627"></a><span class="hs-comment">-- | Call when canonicalizing an equality fails, but if the equality is</span><span>
</span><a name="line-1628"></a><span class="hs-comment">-- representational, there is some hope for the future.</span><span>
</span><a name="line-1629"></a><span class="hs-comment">-- Examples in Note [Use canEqFailure in canDecomposableTyConApp]</span><span>
</span><a name="line-1630"></a><span class="hs-identifier">canEqFailure</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">EqRel</span><span>
</span><a name="line-1631"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span>
</span><a name="line-1632"></a><a name="canEqFailure"><a href="TcCanonical.html#canEqFailure"><span class="hs-identifier">canEqFailure</span></a></a><span> </span><a name="local-6989586621682865426"><a href="#local-6989586621682865426"><span class="hs-identifier">ev</span></a></a><span> </span><span class="hs-identifier hs-var">NomEq</span><span> </span><a name="local-6989586621682865427"><a href="#local-6989586621682865427"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865428"><a href="#local-6989586621682865428"><span class="hs-identifier">ty2</span></a></a><span>
</span><a name="line-1633"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#canEqHardFailure"><span class="hs-identifier hs-var">canEqHardFailure</span></a><span> </span><a href="#local-6989586621682865426"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865427"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865428"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1634"></a><span class="hs-identifier">canEqFailure</span><span> </span><a name="local-6989586621682865429"><a href="#local-6989586621682865429"><span class="hs-identifier">ev</span></a></a><span> </span><span class="hs-identifier hs-var">ReprEq</span><span> </span><a name="local-6989586621682865430"><a href="#local-6989586621682865430"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865431"><a href="#local-6989586621682865431"><span class="hs-identifier">ty2</span></a></a><span>
</span><a name="line-1635"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865432"><a href="#local-6989586621682865432"><span class="hs-identifier">xi1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865433"><a href="#local-6989586621682865433"><span class="hs-identifier">co1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcFlatten.html#flatten"><span class="hs-identifier hs-var">flatten</span></a><span> </span><a href="TcFlatten.html#FM_FlattenAll"><span class="hs-identifier hs-var">FM_FlattenAll</span></a><span> </span><a href="#local-6989586621682865429"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865430"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-1636"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865434"><a href="#local-6989586621682865434"><span class="hs-identifier">xi2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865435"><a href="#local-6989586621682865435"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcFlatten.html#flatten"><span class="hs-identifier hs-var">flatten</span></a><span> </span><a href="TcFlatten.html#FM_FlattenAll"><span class="hs-identifier hs-var">FM_FlattenAll</span></a><span> </span><a href="#local-6989586621682865429"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865431"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1637"></a><span>            </span><span class="hs-comment">-- We must flatten the types before putting them in the</span><span>
</span><a name="line-1638"></a><span>            </span><span class="hs-comment">-- inert set, so that we are sure to kick them out when</span><span>
</span><a name="line-1639"></a><span>            </span><span class="hs-comment">-- new equalities become available</span><span>
</span><a name="line-1640"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;canEqFailure with ReprEq&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1641"></a><span>         </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865429"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865430"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865431"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865432"><span class="hs-identifier hs-var">xi1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865434"><span class="hs-identifier hs-var">xi2</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1642"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682865436"><a href="#local-6989586621682865436"><span class="hs-identifier">new_ev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcCanonical.html#rewriteEqEvidence"><span class="hs-identifier hs-var">rewriteEqEvidence</span></a><span> </span><a href="#local-6989586621682865429"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-identifier hs-var">NotSwapped</span><span> </span><a href="#local-6989586621682865432"><span class="hs-identifier hs-var">xi1</span></a><span> </span><a href="#local-6989586621682865434"><span class="hs-identifier hs-var">xi2</span></a><span> </span><a href="#local-6989586621682865433"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-6989586621682865435"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-1643"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkIrredCt</span><span> </span><a href="#local-6989586621682865436"><span class="hs-identifier hs-var">new_ev</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1644"></a><span>
</span><a name="line-1645"></a><span class="hs-comment">-- | Call when canonicalizing an equality fails with utterly no hope.</span><span>
</span><a name="line-1646"></a><span class="hs-identifier">canEqHardFailure</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span>
</span><a name="line-1647"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span>
</span><a name="line-1648"></a><span class="hs-comment">-- See Note [Make sure that insolubles are fully rewritten]</span><span>
</span><a name="line-1649"></a><a name="canEqHardFailure"><a href="TcCanonical.html#canEqHardFailure"><span class="hs-identifier">canEqHardFailure</span></a></a><span> </span><a name="local-6989586621682865437"><a href="#local-6989586621682865437"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865438"><a href="#local-6989586621682865438"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865439"><a href="#local-6989586621682865439"><span class="hs-identifier">ty2</span></a></a><span>
</span><a name="line-1650"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865440"><a href="#local-6989586621682865440"><span class="hs-identifier">s1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865441"><a href="#local-6989586621682865441"><span class="hs-identifier">co1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcFlatten.html#flatten"><span class="hs-identifier hs-var">flatten</span></a><span> </span><a href="TcFlatten.html#FM_SubstOnly"><span class="hs-identifier hs-var">FM_SubstOnly</span></a><span> </span><a href="#local-6989586621682865437"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865438"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-1651"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865442"><a href="#local-6989586621682865442"><span class="hs-identifier">s2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865443"><a href="#local-6989586621682865443"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcFlatten.html#flatten"><span class="hs-identifier hs-var">flatten</span></a><span> </span><a href="TcFlatten.html#FM_SubstOnly"><span class="hs-identifier hs-var">FM_SubstOnly</span></a><span> </span><a href="#local-6989586621682865437"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865439"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1652"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682865444"><a href="#local-6989586621682865444"><span class="hs-identifier">new_ev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcCanonical.html#rewriteEqEvidence"><span class="hs-identifier hs-var">rewriteEqEvidence</span></a><span> </span><a href="#local-6989586621682865437"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-identifier hs-var">NotSwapped</span><span> </span><a href="#local-6989586621682865440"><span class="hs-identifier hs-var">s1</span></a><span> </span><a href="#local-6989586621682865442"><span class="hs-identifier hs-var">s2</span></a><span> </span><a href="#local-6989586621682865441"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-6989586621682865443"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-1653"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkInsolubleCt</span><span> </span><a href="#local-6989586621682865444"><span class="hs-identifier hs-var">new_ev</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1654"></a><span>
</span><a name="line-1655"></a><span class="hs-comment">{-
Note [Decomposing TyConApps]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we see (T s1 t1 ~ T s2 t2), then we can just decompose to
  (s1 ~ s2, t1 ~ t2)
and push those back into the work list.  But if
  s1 = K k1    s2 = K k2
then we will just decomopose s1~s2, and it might be better to
do so on the spot.  An important special case is where s1=s2,
and we get just Refl.

So canDecomposableTyCon is a fast-path decomposition that uses
unifyWanted etc to short-cut that work.

Note [Canonicalising type applications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Given (s1 t1) ~ ty2, how should we proceed?
The simple things is to see if ty2 is of form (s2 t2), and
decompose.  By this time s1 and s2 can't be saturated type
function applications, because those have been dealt with
by an earlier equation in can_eq_nc, so it is always sound to
decompose.

However, over-eager decomposition gives bad error messages
for things like
   a b ~ Maybe c
   e f ~ p -&gt; q
Suppose (in the first example) we already know a~Array.  Then if we
decompose the application eagerly, yielding
   a ~ Maybe
   b ~ c
we get an error        &quot;Can't match Array ~ Maybe&quot;,
but we'd prefer to get &quot;Can't match Array b ~ Maybe c&quot;.

So instead can_eq_wanted_app flattens the LHS and RHS, in the hope of
replacing (a b) by (Array b), before using try_decompose_app to
decompose it.

Note [Make sure that insolubles are fully rewritten]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When an equality fails, we still want to rewrite the equality
all the way down, so that it accurately reflects
 (a) the mutable reference substitution in force at start of solving
 (b) any ty-binds in force at this point in solving
See Note [Rewrite insolubles] in TcSMonad.
And if we don't do this there is a bad danger that
TcSimplify.applyTyVarDefaulting will find a variable
that has in fact been substituted.

Note [Do not decompose Given polytype equalities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider [G] (forall a. t1 ~ forall a. t2).  Can we decompose this?
No -- what would the evidence look like?  So instead we simply discard
this given evidence.


Note [Combining insoluble constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
As this point we have an insoluble constraint, like Int~Bool.

 * If it is Wanted, delete it from the cache, so that subsequent
   Int~Bool constraints give rise to separate error messages

 * But if it is Derived, DO NOT delete from cache.  A class constraint
   may get kicked out of the inert set, and then have its functional
   dependency Derived constraints generated a second time. In that
   case we don't want to get two (or more) error messages by
   generating two (or more) insoluble fundep constraints from the same
   class constraint.

Note [No top-level newtypes on RHS of representational equalities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we're in this situation:

 work item:  [W] c1 : a ~R b
     inert:  [G] c2 : b ~R Id a

where
  newtype Id a = Id a

We want to make sure canEqTyVar sees [W] a ~R a, after b is flattened
and the Id newtype is unwrapped. This is assured by requiring only flat
types in canEqTyVar *and* having the newtype-unwrapping check above
the tyvar check in can_eq_nc.

Note [Occurs check error]
~~~~~~~~~~~~~~~~~~~~~~~~~
If we have an occurs check error, are we necessarily hosed? Say our
tyvar is tv1 and the type it appears in is xi2. Because xi2 is function
free, then if we're computing w.r.t. nominal equality, then, yes, we're
hosed. Nothing good can come from (a ~ [a]). If we're computing w.r.t.
representational equality, this is a little subtler. Once again, (a ~R [a])
is a bad thing, but (a ~R N a) for a newtype N might be just fine. This
means also that (a ~ b a) might be fine, because `b` might become a newtype.

So, we must check: does tv1 appear in xi2 under any type constructor
that is generative w.r.t. representational equality? That's what
isInsolubleOccursCheck does.

See also #10715, which induced this addition.

Note [canCFunEqCan]
~~~~~~~~~~~~~~~~~~~
Flattening the arguments to a type family can change the kind of the type
family application. As an easy example, consider (Any k) where (k ~ Type)
is in the inert set. The original (Any k :: k) becomes (Any Type :: Type).
The problem here is that the fsk in the CFunEqCan will have the old kind.

The solution is to come up with a new fsk/fmv of the right kind. For
givens, this is easy: just introduce a new fsk and update the flat-cache
with the new one. For wanteds, we want to solve the old one if favor of
the new one, so we use dischargeFmv. This also kicks out constraints
from the inert set; this behavior is correct, as the kind-change may
allow more constraints to be solved.

We use `isTcReflexiveCo`, to ensure that we only use the hetero-kinded case
if we really need to.  Of course `flattenArgsNom` should return `Refl`
whenever possible, but Trac #15577 was an infinite loop because even
though the coercion was homo-kinded, `kind_co` was not `Refl`, so we
made a new (identical) CFunEqCan, and then the entire process repeated.
-}</span><span>
</span><a name="line-1776"></a><span>
</span><a name="line-1777"></a><span class="hs-identifier">canCFunEqCan</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span>
</span><a name="line-1778"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- LHS</span><span>
</span><a name="line-1779"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span>             </span><span class="hs-comment">-- RHS</span><span>
</span><a name="line-1780"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span>
</span><a name="line-1781"></a><span class="hs-comment">-- ^ Canonicalise a CFunEqCan.  We know that</span><span>
</span><a name="line-1782"></a><span class="hs-comment">--     the arg types are already flat,</span><span>
</span><a name="line-1783"></a><span class="hs-comment">-- and the RHS is a fsk, which we must *not* substitute.</span><span>
</span><a name="line-1784"></a><span class="hs-comment">-- So just substitute in the LHS</span><span>
</span><a name="line-1785"></a><a name="canCFunEqCan"><a href="TcCanonical.html#canCFunEqCan"><span class="hs-identifier">canCFunEqCan</span></a></a><span> </span><a name="local-6989586621682865445"><a href="#local-6989586621682865445"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865446"><a href="#local-6989586621682865446"><span class="hs-identifier">fn</span></a></a><span> </span><a name="local-6989586621682865447"><a href="#local-6989586621682865447"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-6989586621682865448"><a href="#local-6989586621682865448"><span class="hs-identifier">fsk</span></a></a><span>
</span><a name="line-1786"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865449"><a href="#local-6989586621682865449"><span class="hs-identifier">tys'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865450"><a href="#local-6989586621682865450"><span class="hs-identifier">cos</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865451"><a href="#local-6989586621682865451"><span class="hs-identifier">kind_co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcFlatten.html#flattenArgsNom"><span class="hs-identifier hs-var">flattenArgsNom</span></a><span> </span><a href="#local-6989586621682865445"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865446"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621682865447"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1787"></a><span>                        </span><span class="hs-comment">-- cos :: tys' ~ tys</span><span>
</span><a name="line-1788"></a><span>
</span><a name="line-1789"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682865452"><a href="#local-6989586621682865452"><span class="hs-identifier">lhs_co</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcTyConAppCo</span><span> </span><span class="hs-identifier hs-var">Nominal</span><span> </span><a href="#local-6989586621682865446"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621682865450"><span class="hs-identifier hs-var">cos</span></a><span>
</span><a name="line-1790"></a><span>                        </span><span class="hs-comment">-- :: F tys' ~ F tys</span><span>
</span><a name="line-1791"></a><span>             </span><a name="local-6989586621682865453"><a href="#local-6989586621682865453"><span class="hs-identifier">new_lhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621682865446"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621682865449"><span class="hs-identifier hs-var">tys'</span></a><span>
</span><a name="line-1792"></a><span>
</span><a name="line-1793"></a><span>             </span><a name="local-6989586621682865454"><a href="#local-6989586621682865454"><span class="hs-identifier">flav</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ctEvFlavour</span><span> </span><a href="#local-6989586621682865445"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-1794"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865462"><a href="#local-6989586621682865462"><span class="hs-identifier">ev'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865463"><a href="#local-6989586621682865463"><span class="hs-identifier">fsk'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1795"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isTcReflexiveCo</span><span> </span><a href="#local-6989586621682865451"><span class="hs-identifier hs-var">kind_co</span></a><span>   </span><span class="hs-comment">-- See Note [canCFunEqCan]</span><span>
</span><a name="line-1796"></a><span>              </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;canCFunEqCan: refl&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865453"><span class="hs-identifier hs-var">new_lhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1797"></a><span>                      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682865455"><a href="#local-6989586621682865455"><span class="hs-identifier">fsk_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621682865448"><span class="hs-identifier hs-var">fsk</span></a><span>
</span><a name="line-1798"></a><span>                      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682865456"><a href="#local-6989586621682865456"><span class="hs-identifier">ev'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcCanonical.html#rewriteEqEvidence"><span class="hs-identifier hs-var">rewriteEqEvidence</span></a><span> </span><a href="#local-6989586621682865445"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-identifier hs-var">NotSwapped</span><span> </span><a href="#local-6989586621682865453"><span class="hs-identifier hs-var">new_lhs</span></a><span> </span><a href="#local-6989586621682865455"><span class="hs-identifier hs-var">fsk_ty</span></a><span>
</span><a name="line-1799"></a><span>                                                 </span><a href="#local-6989586621682865452"><span class="hs-identifier hs-var">lhs_co</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTcNomReflCo</span><span> </span><a href="#local-6989586621682865455"><span class="hs-identifier hs-var">fsk_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1800"></a><span>                      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682865456"><span class="hs-identifier hs-var">ev'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682865448"><span class="hs-identifier hs-var">fsk</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1801"></a><span>              </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;canCFunEqCan: non-refl&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1802"></a><span>                        </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Kind co:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865451"><span class="hs-identifier hs-var">kind_co</span></a><span>
</span><a name="line-1803"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;RHS:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865448"><span class="hs-identifier hs-var">fsk</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyVarKind</span><span> </span><a href="#local-6989586621682865448"><span class="hs-identifier hs-var">fsk</span></a><span class="hs-special">)</span><span>
</span><a name="line-1804"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;LHS:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621682865446"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621682865447"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1805"></a><span>                                                  </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tcTypeKind</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621682865446"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621682865447"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1806"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;New LHS&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865453"><span class="hs-identifier hs-var">new_lhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1807"></a><span>                                                     </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tcTypeKind</span><span> </span><a href="#local-6989586621682865453"><span class="hs-identifier hs-var">new_lhs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1808"></a><span>                      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865457"><a href="#local-6989586621682865457"><span class="hs-identifier">ev'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865458"><a href="#local-6989586621682865458"><span class="hs-identifier">new_co</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865459"><a href="#local-6989586621682865459"><span class="hs-identifier">new_fsk</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1809"></a><span>                          </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#newFlattenSkolem"><span class="hs-identifier hs-var">newFlattenSkolem</span></a><span> </span><a href="#local-6989586621682865454"><span class="hs-identifier hs-var">flav</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvLoc</span><span> </span><a href="#local-6989586621682865445"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682865446"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621682865449"><span class="hs-identifier hs-var">tys'</span></a><span>
</span><a name="line-1810"></a><span>                      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682865460"><a href="#local-6989586621682865460"><span class="hs-identifier">xi</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621682865459"><span class="hs-identifier hs-var">new_fsk</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkCastTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865451"><span class="hs-identifier hs-var">kind_co</span></a><span>
</span><a name="line-1811"></a><span>                               </span><span class="hs-comment">-- sym lhs_co :: F tys ~ F tys'</span><span>
</span><a name="line-1812"></a><span>                               </span><span class="hs-comment">-- new_co     :: F tys' ~ new_fsk</span><span>
</span><a name="line-1813"></a><span>                               </span><span class="hs-comment">-- co         :: F tys ~ (new_fsk |&gt; kind_co)</span><span>
</span><a name="line-1814"></a><span>                            </span><a name="local-6989586621682865461"><a href="#local-6989586621682865461"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcSymCo</span><span> </span><a href="#local-6989586621682865452"><span class="hs-identifier hs-var">lhs_co</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkTcTransCo</span><span class="hs-special">`</span><span>
</span><a name="line-1815"></a><span>                                 </span><span class="hs-identifier hs-var">mkTcCoherenceRightCo</span><span> </span><span class="hs-identifier hs-var">Nominal</span><span>
</span><a name="line-1816"></a><span>                                                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621682865459"><span class="hs-identifier hs-var">new_fsk</span></a><span class="hs-special">)</span><span>
</span><a name="line-1817"></a><span>                                                      </span><a href="#local-6989586621682865451"><span class="hs-identifier hs-var">kind_co</span></a><span>
</span><a name="line-1818"></a><span>                                                      </span><a href="#local-6989586621682865458"><span class="hs-identifier hs-var">new_co</span></a><span>
</span><a name="line-1819"></a><span>
</span><a name="line-1820"></a><span>                      </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;Discharging fmv/fsk due to hetero flattening&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865445"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span>
</span><a name="line-1821"></a><span>                      </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#dischargeFunEq"><span class="hs-identifier hs-var">dischargeFunEq</span></a><span> </span><a href="#local-6989586621682865445"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865448"><span class="hs-identifier hs-var">fsk</span></a><span> </span><a href="#local-6989586621682865461"><span class="hs-identifier hs-var">co</span></a><span> </span><a href="#local-6989586621682865460"><span class="hs-identifier hs-var">xi</span></a><span>
</span><a name="line-1822"></a><span>                      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682865457"><span class="hs-identifier hs-var">ev'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682865459"><span class="hs-identifier hs-var">new_fsk</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1823"></a><span>
</span><a name="line-1824"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#extendFlatCache"><span class="hs-identifier hs-var">extendFlatCache</span></a><span> </span><a href="#local-6989586621682865446"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621682865449"><span class="hs-identifier hs-var">tys'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvCoercion</span><span> </span><a href="#local-6989586621682865462"><span class="hs-identifier hs-var">ev'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621682865463"><span class="hs-identifier hs-var">fsk'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ctEvFlavour</span><span> </span><a href="#local-6989586621682865462"><span class="hs-identifier hs-var">ev'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1825"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CFunEqCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865462"><span class="hs-identifier hs-var">ev'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_fun</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865446"><span class="hs-identifier hs-var">fn</span></a><span>
</span><a name="line-1826"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865449"><span class="hs-identifier hs-var">tys'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_fsk</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865463"><span class="hs-identifier hs-var">fsk'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1827"></a><span>
</span><a name="line-1828"></a><span class="hs-comment">---------------------</span><span>
</span><a name="line-1829"></a><span class="hs-identifier">canEqTyVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span>          </span><span class="hs-comment">-- ev :: lhs ~ rhs</span><span>
</span><a name="line-1830"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">EqRel</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SwapFlag</span><span>
</span><a name="line-1831"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span>               </span><span class="hs-comment">-- tv1</span><span>
</span><a name="line-1832"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>                </span><span class="hs-comment">-- lhs: pretty lhs, already flat</span><span>
</span><a name="line-1833"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>      </span><span class="hs-comment">-- rhs: already flat</span><span>
</span><a name="line-1834"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span>
</span><a name="line-1835"></a><a name="canEqTyVar"><a href="TcCanonical.html#canEqTyVar"><span class="hs-identifier">canEqTyVar</span></a></a><span> </span><a name="local-6989586621682865464"><a href="#local-6989586621682865464"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865465"><a href="#local-6989586621682865465"><span class="hs-identifier">eq_rel</span></a></a><span> </span><a name="local-6989586621682865466"><a href="#local-6989586621682865466"><span class="hs-identifier">swapped</span></a></a><span> </span><a name="local-6989586621682865467"><a href="#local-6989586621682865467"><span class="hs-identifier">tv1</span></a></a><span> </span><a name="local-6989586621682865468"><a href="#local-6989586621682865468"><span class="hs-identifier">ps_ty1</span></a></a><span> </span><a name="local-6989586621682865469"><a href="#local-6989586621682865469"><span class="hs-identifier">xi2</span></a></a><span> </span><a name="local-6989586621682865470"><a href="#local-6989586621682865470"><span class="hs-identifier">ps_xi2</span></a></a><span>
</span><a name="line-1836"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682865472"><span class="hs-identifier hs-var">k1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">tcEqType</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865473"><span class="hs-identifier hs-var">k2</span></a><span>
</span><a name="line-1837"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#canEqTyVarHomo"><span class="hs-identifier hs-var">canEqTyVarHomo</span></a><span> </span><a href="#local-6989586621682865464"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865465"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><a href="#local-6989586621682865466"><span class="hs-identifier hs-var">swapped</span></a><span> </span><a href="#local-6989586621682865467"><span class="hs-identifier hs-var">tv1</span></a><span> </span><a href="#local-6989586621682865468"><span class="hs-identifier hs-var">ps_ty1</span></a><span> </span><a href="#local-6989586621682865469"><span class="hs-identifier hs-var">xi2</span></a><span> </span><a href="#local-6989586621682865470"><span class="hs-identifier hs-var">ps_xi2</span></a><span>
</span><a name="line-1838"></a><span>
</span><a name="line-1839"></a><span>         </span><span class="hs-comment">-- Note [Flattening] in TcFlatten gives us (F2), which says that</span><span>
</span><a name="line-1840"></a><span>         </span><span class="hs-comment">-- flattening is always homogeneous (doesn't change kinds). But</span><span>
</span><a name="line-1841"></a><span>         </span><span class="hs-comment">-- perhaps by flattening the kinds of the two sides of the equality</span><span>
</span><a name="line-1842"></a><span>         </span><span class="hs-comment">-- at hand makes them equal. So let's try that.</span><span>
</span><a name="line-1843"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1844"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865476"><a href="#local-6989586621682865476"><span class="hs-identifier">flat_k1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865477"><a href="#local-6989586621682865477"><span class="hs-identifier">k1_co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcFlatten.html#flattenKind"><span class="hs-identifier hs-var">flattenKind</span></a><span> </span><a href="#local-6989586621682865474"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621682865475"><span class="hs-identifier hs-var">flav</span></a><span> </span><a href="#local-6989586621682865472"><span class="hs-identifier hs-var">k1</span></a><span>  </span><span class="hs-comment">-- k1_co :: flat_k1 ~N kind(xi1)</span><span>
</span><a name="line-1845"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865478"><a href="#local-6989586621682865478"><span class="hs-identifier">flat_k2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865479"><a href="#local-6989586621682865479"><span class="hs-identifier">k2_co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcFlatten.html#flattenKind"><span class="hs-identifier hs-var">flattenKind</span></a><span> </span><a href="#local-6989586621682865474"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621682865475"><span class="hs-identifier hs-var">flav</span></a><span> </span><a href="#local-6989586621682865473"><span class="hs-identifier hs-var">k2</span></a><span>  </span><span class="hs-comment">-- k2_co :: flat_k2 ~N kind(xi2)</span><span>
</span><a name="line-1846"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;canEqTyVar tried flattening kinds&quot;</span><span>
</span><a name="line-1847"></a><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865467"><span class="hs-identifier hs-var">tv1</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865472"><span class="hs-identifier hs-var">k1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1848"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;~&quot;</span><span>
</span><a name="line-1849"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865469"><span class="hs-identifier hs-var">xi2</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865473"><span class="hs-identifier hs-var">k2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1850"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865476"><span class="hs-identifier hs-var">flat_k1</span></a><span>
</span><a name="line-1851"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865477"><span class="hs-identifier hs-var">k1_co</span></a><span>
</span><a name="line-1852"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865478"><span class="hs-identifier hs-var">flat_k2</span></a><span>
</span><a name="line-1853"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865479"><span class="hs-identifier hs-var">k2_co</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1854"></a><span>
</span><a name="line-1855"></a><span>         </span><span class="hs-comment">-- we know the LHS is a tyvar. So let's dump all the coercions on the RHS</span><span>
</span><a name="line-1856"></a><span>         </span><span class="hs-comment">-- If flat_k1 == flat_k2, let's dump all the coercions on the RHS and</span><span>
</span><a name="line-1857"></a><span>         </span><span class="hs-comment">-- then call canEqTyVarHomo. If they don't equal, just rewriteEqEvidence</span><span>
</span><a name="line-1858"></a><span>         </span><span class="hs-comment">-- (as an optimization, so that we don't have to flatten the kinds again)</span><span>
</span><a name="line-1859"></a><span>         </span><span class="hs-comment">-- and then emit a kind equality in canEqTyVarHetero.</span><span>
</span><a name="line-1860"></a><span>         </span><span class="hs-comment">-- See Note [Equalities with incompatible kinds]</span><span>
</span><a name="line-1861"></a><span>
</span><a name="line-1862"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-keyword">role</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">eqRelRole</span><span> </span><a href="#local-6989586621682865465"><span class="hs-identifier hs-var">eq_rel</span></a><span>
</span><a name="line-1863"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682865476"><span class="hs-identifier hs-var">flat_k1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">tcEqType</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865478"><span class="hs-identifier hs-var">flat_k2</span></a><span>
</span><a name="line-1864"></a><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682865481"><a href="#local-6989586621682865481"><span class="hs-identifier">rhs_kind_co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcSymCo</span><span> </span><a href="#local-6989586621682865479"><span class="hs-identifier hs-var">k2_co</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkTcTransCo</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865477"><span class="hs-identifier hs-var">k1_co</span></a><span>
</span><a name="line-1865"></a><span>                         </span><span class="hs-comment">-- :: kind(xi2) ~N kind(xi1)</span><span>
</span><a name="line-1866"></a><span>
</span><a name="line-1867"></a><span>                       </span><a name="local-6989586621682865482"><a href="#local-6989586621682865482"><span class="hs-identifier">new_rhs</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865469"><span class="hs-identifier hs-var">xi2</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkCastTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865481"><span class="hs-identifier hs-var">rhs_kind_co</span></a><span>
</span><a name="line-1868"></a><span>                       </span><a name="local-6989586621682865483"><a href="#local-6989586621682865483"><span class="hs-identifier">ps_rhs</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865470"><span class="hs-identifier hs-var">ps_xi2</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkCastTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865481"><span class="hs-identifier hs-var">rhs_kind_co</span></a><span>
</span><a name="line-1869"></a><span>                       </span><a name="local-6989586621682865484"><a href="#local-6989586621682865484"><span class="hs-identifier">rhs_co</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcGReflLeftCo</span><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865469"><span class="hs-identifier hs-var">xi2</span></a><span> </span><a href="#local-6989586621682865481"><span class="hs-identifier hs-var">rhs_kind_co</span></a><span>
</span><a name="line-1870"></a><span>
</span><a name="line-1871"></a><span>                 </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682865485"><a href="#local-6989586621682865485"><span class="hs-identifier">new_ev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcCanonical.html#rewriteEqEvidence"><span class="hs-identifier hs-var">rewriteEqEvidence</span></a><span> </span><a href="#local-6989586621682865464"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865466"><span class="hs-identifier hs-var">swapped</span></a><span> </span><a href="#local-6989586621682865471"><span class="hs-identifier hs-var">xi1</span></a><span> </span><a href="#local-6989586621682865482"><span class="hs-identifier hs-var">new_rhs</span></a><span>
</span><a name="line-1872"></a><span>                                               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTcReflCo</span><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865471"><span class="hs-identifier hs-var">xi1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682865484"><span class="hs-identifier hs-var">rhs_co</span></a><span>
</span><a name="line-1873"></a><span>                       </span><span class="hs-comment">-- NB: rewriteEqEvidence executes a swap, if any, so we're</span><span>
</span><a name="line-1874"></a><span>                       </span><span class="hs-comment">-- NotSwapped now.</span><span>
</span><a name="line-1875"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#canEqTyVarHomo"><span class="hs-identifier hs-var">canEqTyVarHomo</span></a><span> </span><a href="#local-6989586621682865485"><span class="hs-identifier hs-var">new_ev</span></a><span> </span><a href="#local-6989586621682865465"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><span class="hs-identifier hs-var">NotSwapped</span><span> </span><a href="#local-6989586621682865467"><span class="hs-identifier hs-var">tv1</span></a><span> </span><a href="#local-6989586621682865468"><span class="hs-identifier hs-var">ps_ty1</span></a><span> </span><a href="#local-6989586621682865482"><span class="hs-identifier hs-var">new_rhs</span></a><span> </span><a href="#local-6989586621682865483"><span class="hs-identifier hs-var">ps_rhs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1876"></a><span>         </span><span class="hs-keyword">else</span><span>
</span><a name="line-1877"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682865486"><a href="#local-6989586621682865486"><span class="hs-identifier">sym_k1_co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcSymCo</span><span> </span><a href="#local-6989586621682865477"><span class="hs-identifier hs-var">k1_co</span></a><span>  </span><span class="hs-comment">-- :: kind(xi1) ~N flat_k1</span><span>
</span><a name="line-1878"></a><span>             </span><a name="local-6989586621682865487"><a href="#local-6989586621682865487"><span class="hs-identifier">sym_k2_co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcSymCo</span><span> </span><a href="#local-6989586621682865479"><span class="hs-identifier hs-var">k2_co</span></a><span>  </span><span class="hs-comment">-- :: kind(xi2) ~N flat_k2</span><span>
</span><a name="line-1879"></a><span>
</span><a name="line-1880"></a><span>             </span><a name="local-6989586621682865488"><a href="#local-6989586621682865488"><span class="hs-identifier">new_lhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865471"><span class="hs-identifier hs-var">xi1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkCastTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865486"><span class="hs-identifier hs-var">sym_k1_co</span></a><span>  </span><span class="hs-comment">-- :: flat_k1</span><span>
</span><a name="line-1881"></a><span>             </span><a name="local-6989586621682865489"><a href="#local-6989586621682865489"><span class="hs-identifier">new_rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865469"><span class="hs-identifier hs-var">xi2</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkCastTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865487"><span class="hs-identifier hs-var">sym_k2_co</span></a><span>  </span><span class="hs-comment">-- :: flat_k2</span><span>
</span><a name="line-1882"></a><span>             </span><a name="local-6989586621682865490"><a href="#local-6989586621682865490"><span class="hs-identifier">ps_rhs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865470"><span class="hs-identifier hs-var">ps_xi2</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkCastTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865487"><span class="hs-identifier hs-var">sym_k2_co</span></a><span>
</span><a name="line-1883"></a><span>
</span><a name="line-1884"></a><span>             </span><a name="local-6989586621682865491"><a href="#local-6989586621682865491"><span class="hs-identifier">lhs_co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcGReflLeftCo</span><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865471"><span class="hs-identifier hs-var">xi1</span></a><span> </span><a href="#local-6989586621682865486"><span class="hs-identifier hs-var">sym_k1_co</span></a><span>
</span><a name="line-1885"></a><span>             </span><a name="local-6989586621682865492"><a href="#local-6989586621682865492"><span class="hs-identifier">rhs_co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcGReflLeftCo</span><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865469"><span class="hs-identifier hs-var">xi2</span></a><span> </span><a href="#local-6989586621682865487"><span class="hs-identifier hs-var">sym_k2_co</span></a><span>
</span><a name="line-1886"></a><span>               </span><span class="hs-comment">-- lhs_co :: (xi1 |&gt; sym k1_co) ~ xi1</span><span>
</span><a name="line-1887"></a><span>               </span><span class="hs-comment">-- rhs_co :: (xi2 |&gt; sym k2_co) ~ xi2</span><span>
</span><a name="line-1888"></a><span>
</span><a name="line-1889"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682865493"><a href="#local-6989586621682865493"><span class="hs-identifier">new_ev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcCanonical.html#rewriteEqEvidence"><span class="hs-identifier hs-var">rewriteEqEvidence</span></a><span> </span><a href="#local-6989586621682865464"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865466"><span class="hs-identifier hs-var">swapped</span></a><span> </span><a href="#local-6989586621682865488"><span class="hs-identifier hs-var">new_lhs</span></a><span> </span><a href="#local-6989586621682865489"><span class="hs-identifier hs-var">new_rhs</span></a><span> </span><a href="#local-6989586621682865491"><span class="hs-identifier hs-var">lhs_co</span></a><span> </span><a href="#local-6989586621682865492"><span class="hs-identifier hs-var">rhs_co</span></a><span>
</span><a name="line-1890"></a><span>         </span><span class="hs-comment">-- no longer swapped, due to rewriteEqEvidence</span><span>
</span><a name="line-1891"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#canEqTyVarHetero"><span class="hs-identifier hs-var">canEqTyVarHetero</span></a><span> </span><a href="#local-6989586621682865493"><span class="hs-identifier hs-var">new_ev</span></a><span> </span><a href="#local-6989586621682865465"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><a href="#local-6989586621682865467"><span class="hs-identifier hs-var">tv1</span></a><span> </span><a href="#local-6989586621682865486"><span class="hs-identifier hs-var">sym_k1_co</span></a><span> </span><a href="#local-6989586621682865476"><span class="hs-identifier hs-var">flat_k1</span></a><span> </span><a href="#local-6989586621682865468"><span class="hs-identifier hs-var">ps_ty1</span></a><span>
</span><a name="line-1892"></a><span>                                        </span><a href="#local-6989586621682865489"><span class="hs-identifier hs-var">new_rhs</span></a><span> </span><a href="#local-6989586621682865478"><span class="hs-identifier hs-var">flat_k2</span></a><span> </span><a href="#local-6989586621682865490"><span class="hs-identifier hs-var">ps_rhs</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1893"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1894"></a><span>    </span><a name="local-6989586621682865471"><a href="#local-6989586621682865471"><span class="hs-identifier">xi1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621682865467"><span class="hs-identifier hs-var">tv1</span></a><span>
</span><a name="line-1895"></a><span>
</span><a name="line-1896"></a><span>    </span><a name="local-6989586621682865472"><a href="#local-6989586621682865472"><span class="hs-identifier">k1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyVarKind</span><span> </span><a href="#local-6989586621682865467"><span class="hs-identifier hs-var">tv1</span></a><span>
</span><a name="line-1897"></a><span>    </span><a name="local-6989586621682865473"><a href="#local-6989586621682865473"><span class="hs-identifier">k2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcTypeKind</span><span> </span><a href="#local-6989586621682865469"><span class="hs-identifier hs-var">xi2</span></a><span>
</span><a name="line-1898"></a><span>
</span><a name="line-1899"></a><span>    </span><a name="local-6989586621682865474"><a href="#local-6989586621682865474"><span class="hs-identifier">loc</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ctEvLoc</span><span> </span><a href="#local-6989586621682865464"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-1900"></a><span>    </span><a name="local-6989586621682865475"><a href="#local-6989586621682865475"><span class="hs-identifier">flav</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ctEvFlavour</span><span> </span><a href="#local-6989586621682865464"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-1901"></a><span>
</span><a name="line-1902"></a><span class="hs-identifier">canEqTyVarHetero</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span>   </span><span class="hs-comment">-- :: (tv1 |&gt; co1 :: ki1) ~ (xi2 :: ki2)</span><span>
</span><a name="line-1903"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">EqRel</span><span>
</span><a name="line-1904"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcCoercionN</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span>  </span><span class="hs-comment">-- tv1 |&gt; co1 :: ki1</span><span>
</span><a name="line-1905"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>            </span><span class="hs-comment">-- pretty tv1 (*without* the coercion)</span><span>
</span><a name="line-1906"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span>  </span><span class="hs-comment">-- xi2 :: ki2</span><span>
</span><a name="line-1907"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>            </span><span class="hs-comment">-- pretty xi2</span><span>
</span><a name="line-1908"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span>
</span><a name="line-1909"></a><a name="canEqTyVarHetero"><a href="TcCanonical.html#canEqTyVarHetero"><span class="hs-identifier">canEqTyVarHetero</span></a></a><span> </span><a name="local-6989586621682865494"><a href="#local-6989586621682865494"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865495"><a href="#local-6989586621682865495"><span class="hs-identifier">eq_rel</span></a></a><span> </span><a name="local-6989586621682865496"><a href="#local-6989586621682865496"><span class="hs-identifier">tv1</span></a></a><span> </span><a name="local-6989586621682865497"><a href="#local-6989586621682865497"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-6989586621682865498"><a href="#local-6989586621682865498"><span class="hs-identifier">ki1</span></a></a><span> </span><a name="local-6989586621682865499"><a href="#local-6989586621682865499"><span class="hs-identifier">ps_tv1</span></a></a><span> </span><a name="local-6989586621682865500"><a href="#local-6989586621682865500"><span class="hs-identifier">xi2</span></a></a><span> </span><a name="local-6989586621682865501"><a href="#local-6989586621682865501"><span class="hs-identifier">ki2</span></a></a><span> </span><a name="local-6989586621682865502"><a href="#local-6989586621682865502"><span class="hs-identifier">ps_xi2</span></a></a><span>
</span><a name="line-1910"></a><span>  </span><span class="hs-comment">-- See Note [Equalities with incompatible kinds]</span><span>
</span><a name="line-1911"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">CtGiven</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_evar</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682865507"><a href="#local-6989586621682865507"><span class="hs-identifier">evar</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682865494"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-1912"></a><span>    </span><span class="hs-comment">-- unswapped: tm :: (lhs :: ki1) ~ (rhs :: ki2)</span><span>
</span><a name="line-1913"></a><span>    </span><span class="hs-comment">-- swapped  : tm :: (rhs :: ki2) ~ (lhs :: ki1)</span><span>
</span><a name="line-1914"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682865508"><a href="#local-6989586621682865508"><span class="hs-identifier">kind_co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcKindCo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTcCoVarCo</span><span> </span><a href="#local-6989586621682865507"><span class="hs-identifier hs-var">evar</span></a><span class="hs-special">)</span><span>
</span><a name="line-1915"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682865509"><a href="#local-6989586621682865509"><span class="hs-identifier">kind_ev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#newGivenEvVar"><span class="hs-identifier hs-var">newGivenEvVar</span></a><span> </span><a href="#local-6989586621682865504"><span class="hs-identifier hs-var">kind_loc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682865503"><span class="hs-identifier hs-var">kind_pty</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">evCoercion</span><span> </span><a href="#local-6989586621682865508"><span class="hs-identifier hs-var">kind_co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1916"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span>  </span><span class="hs-comment">-- kind_ev :: (ki1 :: *) ~ (ki2 :: *)   (whether swapped or not)</span><span>
</span><a name="line-1917"></a><span>              </span><span class="hs-comment">-- co1     :: kind(tv1) ~N ki1</span><span>
</span><a name="line-1918"></a><span>              </span><span class="hs-comment">-- homo_co :: ki2 ~N kind(tv1)</span><span>
</span><a name="line-1919"></a><span>             </span><a name="local-6989586621682865510"><a href="#local-6989586621682865510"><span class="hs-identifier">homo_co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcSymCo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvCoercion</span><span> </span><a href="#local-6989586621682865509"><span class="hs-identifier hs-var">kind_ev</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkTcTransCo</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">mkTcSymCo</span><span> </span><a href="#local-6989586621682865497"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-1920"></a><span>             </span><a name="local-6989586621682865511"><a href="#local-6989586621682865511"><span class="hs-identifier">rhs'</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkCastTy</span><span> </span><a href="#local-6989586621682865500"><span class="hs-identifier hs-var">xi2</span></a><span> </span><a href="#local-6989586621682865510"><span class="hs-identifier hs-var">homo_co</span></a><span>     </span><span class="hs-comment">-- :: kind(tv1)</span><span>
</span><a name="line-1921"></a><span>             </span><a name="local-6989586621682865512"><a href="#local-6989586621682865512"><span class="hs-identifier">ps_rhs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkCastTy</span><span> </span><a href="#local-6989586621682865502"><span class="hs-identifier hs-var">ps_xi2</span></a><span> </span><a href="#local-6989586621682865510"><span class="hs-identifier hs-var">homo_co</span></a><span>  </span><span class="hs-comment">-- :: kind(tv1)</span><span>
</span><a name="line-1922"></a><span>             </span><a name="local-6989586621682865513"><a href="#local-6989586621682865513"><span class="hs-identifier">rhs_co</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcGReflLeftCo</span><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865500"><span class="hs-identifier hs-var">xi2</span></a><span> </span><a href="#local-6989586621682865510"><span class="hs-identifier hs-var">homo_co</span></a><span>
</span><a name="line-1923"></a><span>               </span><span class="hs-comment">-- rhs_co :: (xi2 |&gt; homo_co :: kind(tv1)) ~ xi2</span><span>
</span><a name="line-1924"></a><span>
</span><a name="line-1925"></a><span>             </span><a name="local-6989586621682865514"><a href="#local-6989586621682865514"><span class="hs-identifier">lhs'</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621682865496"><span class="hs-identifier hs-var">tv1</span></a><span>       </span><span class="hs-comment">-- :: kind(tv1)</span><span>
</span><a name="line-1926"></a><span>             </span><a name="local-6989586621682865515"><a href="#local-6989586621682865515"><span class="hs-identifier">lhs_co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcGReflRightCo</span><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865514"><span class="hs-identifier hs-var">lhs'</span></a><span> </span><a href="#local-6989586621682865497"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-1927"></a><span>               </span><span class="hs-comment">-- lhs_co :: (tv1 :: kind(tv1)) ~ (tv1 |&gt; co1 :: ki1)</span><span>
</span><a name="line-1928"></a><span>
</span><a name="line-1929"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;Hetero equality gives rise to given kind equality&quot;</span><span>
</span><a name="line-1930"></a><span>           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865509"><span class="hs-identifier hs-var">kind_ev</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865503"><span class="hs-identifier hs-var">kind_pty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1931"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#emitWorkNC"><span class="hs-identifier hs-var">emitWorkNC</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621682865509"><span class="hs-identifier hs-var">kind_ev</span></a><span class="hs-special">]</span><span>
</span><a name="line-1932"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682865516"><a href="#local-6989586621682865516"><span class="hs-identifier">type_ev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcCanonical.html#rewriteEqEvidence"><span class="hs-identifier hs-var">rewriteEqEvidence</span></a><span> </span><a href="#local-6989586621682865494"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-identifier hs-var">NotSwapped</span><span> </span><a href="#local-6989586621682865514"><span class="hs-identifier hs-var">lhs'</span></a><span> </span><a href="#local-6989586621682865511"><span class="hs-identifier hs-var">rhs'</span></a><span> </span><a href="#local-6989586621682865515"><span class="hs-identifier hs-var">lhs_co</span></a><span> </span><a href="#local-6989586621682865513"><span class="hs-identifier hs-var">rhs_co</span></a><span>
</span><a name="line-1933"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#canEqTyVarHomo"><span class="hs-identifier hs-var">canEqTyVarHomo</span></a><span> </span><a href="#local-6989586621682865516"><span class="hs-identifier hs-var">type_ev</span></a><span> </span><a href="#local-6989586621682865495"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><span class="hs-identifier hs-var">NotSwapped</span><span> </span><a href="#local-6989586621682865496"><span class="hs-identifier hs-var">tv1</span></a><span> </span><a href="#local-6989586621682865499"><span class="hs-identifier hs-var">ps_tv1</span></a><span> </span><a href="#local-6989586621682865511"><span class="hs-identifier hs-var">rhs'</span></a><span> </span><a href="#local-6989586621682865512"><span class="hs-identifier hs-var">ps_rhs'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1934"></a><span>
</span><a name="line-1935"></a><span>  </span><span class="hs-comment">-- See Note [Equalities with incompatible kinds]</span><span>
</span><a name="line-1936"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-comment">-- Wanted and Derived</span><span>
</span><a name="line-1937"></a><span>                  </span><span class="hs-comment">-- NB: all kind equalities are Nominal</span><span>
</span><a name="line-1938"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#emitNewDerivedEq"><span class="hs-identifier hs-var">emitNewDerivedEq</span></a><span> </span><a href="#local-6989586621682865504"><span class="hs-identifier hs-var">kind_loc</span></a><span> </span><span class="hs-identifier hs-var">Nominal</span><span> </span><a href="#local-6989586621682865498"><span class="hs-identifier hs-var">ki1</span></a><span> </span><a href="#local-6989586621682865501"><span class="hs-identifier hs-var">ki2</span></a><span>
</span><a name="line-1939"></a><span>             </span><span class="hs-comment">-- kind_ev :: (ki1 :: *) ~ (ki2 :: *)</span><span>
</span><a name="line-1940"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;Hetero equality gives rise to derived kind equality&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1941"></a><span>           </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865494"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-1942"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkIrredCt</span><span> </span><a href="#local-6989586621682865494"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1943"></a><span>
</span><a name="line-1944"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1945"></a><span>    </span><a name="local-6989586621682865503"><a href="#local-6989586621682865503"><span class="hs-identifier">kind_pty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkHeteroPrimEqPred</span><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span> </span><a href="#local-6989586621682865498"><span class="hs-identifier hs-var">ki1</span></a><span> </span><a href="#local-6989586621682865501"><span class="hs-identifier hs-var">ki2</span></a><span>
</span><a name="line-1946"></a><span>    </span><a name="local-6989586621682865504"><a href="#local-6989586621682865504"><span class="hs-identifier">kind_loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkKindLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621682865496"><span class="hs-identifier hs-var">tv1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkCastTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865497"><span class="hs-identifier hs-var">co1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682865500"><span class="hs-identifier hs-var">xi2</span></a><span> </span><a href="#local-6989586621682865505"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-1947"></a><span>
</span><a name="line-1948"></a><span>    </span><a name="local-6989586621682865505"><a href="#local-6989586621682865505"><span class="hs-identifier">loc</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ctev_loc</span><span> </span><a href="#local-6989586621682865494"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-1949"></a><span>    </span><span class="hs-keyword">role</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">eqRelRole</span><span> </span><a href="#local-6989586621682865495"><span class="hs-identifier hs-var">eq_rel</span></a><span>
</span><a name="line-1950"></a><span>
</span><a name="line-1951"></a><span class="hs-comment">-- guaranteed that tcTypeKind lhs == tcTypeKind rhs</span><span>
</span><a name="line-1952"></a><span class="hs-identifier">canEqTyVarHomo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span>
</span><a name="line-1953"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">EqRel</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SwapFlag</span><span>
</span><a name="line-1954"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span>                </span><span class="hs-comment">-- lhs: tv1</span><span>
</span><a name="line-1955"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>                 </span><span class="hs-comment">-- pretty lhs</span><span>
</span><a name="line-1956"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>       </span><span class="hs-comment">-- rhs (might not be flat)</span><span>
</span><a name="line-1957"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span>
</span><a name="line-1958"></a><a name="canEqTyVarHomo"><a href="TcCanonical.html#canEqTyVarHomo"><span class="hs-identifier">canEqTyVarHomo</span></a></a><span> </span><a name="local-6989586621682865517"><a href="#local-6989586621682865517"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865518"><a href="#local-6989586621682865518"><span class="hs-identifier">eq_rel</span></a></a><span> </span><a name="local-6989586621682865519"><a href="#local-6989586621682865519"><span class="hs-identifier">swapped</span></a></a><span> </span><a name="local-6989586621682865520"><a href="#local-6989586621682865520"><span class="hs-identifier">tv1</span></a></a><span> </span><a name="local-6989586621682865521"><a href="#local-6989586621682865521"><span class="hs-identifier">ps_ty1</span></a></a><span> </span><a name="local-6989586621682865522"><a href="#local-6989586621682865522"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-1959"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865523"><a href="#local-6989586621682865523"><span class="hs-identifier">tv2</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcGetCastedTyVar_maybe</span><span> </span><a href="#local-6989586621682865522"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1960"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682865520"><span class="hs-identifier hs-var">tv1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682865523"><span class="hs-identifier hs-var">tv2</span></a><span>
</span><a name="line-1961"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#canEqReflexive"><span class="hs-identifier hs-var">canEqReflexive</span></a><span> </span><a href="#local-6989586621682865517"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865518"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621682865520"><span class="hs-identifier hs-var">tv1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1962"></a><span>    </span><span class="hs-comment">-- we don't need to check co because it must be reflexive</span><span>
</span><a name="line-1963"></a><span>
</span><a name="line-1964"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865524"><a href="#local-6989586621682865524"><span class="hs-identifier">tv2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865525"><a href="#local-6989586621682865525"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcGetCastedTyVar_maybe</span><span> </span><a href="#local-6989586621682865522"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1965"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="TcUnify.html#swapOverTyVars"><span class="hs-identifier hs-var">swapOverTyVars</span></a><span> </span><a href="#local-6989586621682865520"><span class="hs-identifier hs-var">tv1</span></a><span> </span><a href="#local-6989586621682865524"><span class="hs-identifier hs-var">tv2</span></a><span>
</span><a name="line-1966"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;canEqTyVar swapOver&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865520"><span class="hs-identifier hs-var">tv1</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865524"><span class="hs-identifier hs-var">tv2</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865519"><span class="hs-identifier hs-var">swapped</span></a><span class="hs-special">)</span><span>
</span><a name="line-1967"></a><span>         </span><span class="hs-comment">-- FM_Avoid commented out: see Note [Lazy flattening] in TcFlatten</span><span>
</span><a name="line-1968"></a><span>         </span><span class="hs-comment">-- let fmode = FE { fe_ev = ev, fe_mode = FM_Avoid tv1' True }</span><span>
</span><a name="line-1969"></a><span>         </span><span class="hs-comment">-- Flatten the RHS less vigorously, to avoid gratuitous flattening</span><span>
</span><a name="line-1970"></a><span>         </span><span class="hs-comment">-- True &lt;=&gt; xi2 should not itself be a type-function application</span><span>
</span><a name="line-1971"></a><span>
</span><a name="line-1972"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-keyword">role</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">eqRelRole</span><span> </span><a href="#local-6989586621682865518"><span class="hs-identifier hs-var">eq_rel</span></a><span>
</span><a name="line-1973"></a><span>             </span><a name="local-6989586621682865527"><a href="#local-6989586621682865527"><span class="hs-identifier">sym_co2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcSymCo</span><span> </span><a href="#local-6989586621682865525"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-1974"></a><span>             </span><a name="local-6989586621682865528"><a href="#local-6989586621682865528"><span class="hs-identifier">ty1</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621682865520"><span class="hs-identifier hs-var">tv1</span></a><span>
</span><a name="line-1975"></a><span>             </span><a name="local-6989586621682865529"><a href="#local-6989586621682865529"><span class="hs-identifier">new_lhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865528"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkCastTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865527"><span class="hs-identifier hs-var">sym_co2</span></a><span>
</span><a name="line-1976"></a><span>             </span><a name="local-6989586621682865530"><a href="#local-6989586621682865530"><span class="hs-identifier">lhs_co</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcGReflLeftCo</span><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865528"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865527"><span class="hs-identifier hs-var">sym_co2</span></a><span>
</span><a name="line-1977"></a><span>
</span><a name="line-1978"></a><span>             </span><a name="local-6989586621682865531"><a href="#local-6989586621682865531"><span class="hs-identifier">new_rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621682865524"><span class="hs-identifier hs-var">tv2</span></a><span>
</span><a name="line-1979"></a><span>             </span><a name="local-6989586621682865532"><a href="#local-6989586621682865532"><span class="hs-identifier">rhs_co</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcGReflRightCo</span><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865531"><span class="hs-identifier hs-var">new_rhs</span></a><span> </span><a href="#local-6989586621682865525"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-1980"></a><span>
</span><a name="line-1981"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682865533"><a href="#local-6989586621682865533"><span class="hs-identifier">new_ev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcCanonical.html#rewriteEqEvidence"><span class="hs-identifier hs-var">rewriteEqEvidence</span></a><span> </span><a href="#local-6989586621682865517"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865519"><span class="hs-identifier hs-var">swapped</span></a><span> </span><a href="#local-6989586621682865529"><span class="hs-identifier hs-var">new_lhs</span></a><span> </span><a href="#local-6989586621682865531"><span class="hs-identifier hs-var">new_rhs</span></a><span> </span><a href="#local-6989586621682865530"><span class="hs-identifier hs-var">lhs_co</span></a><span> </span><a href="#local-6989586621682865532"><span class="hs-identifier hs-var">rhs_co</span></a><span>
</span><a name="line-1982"></a><span>
</span><a name="line-1983"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682865534"><a href="#local-6989586621682865534"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1984"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#canEqTyVar2"><span class="hs-identifier hs-var">canEqTyVar2</span></a><span> </span><a href="#local-6989586621682865534"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682865533"><span class="hs-identifier hs-var">new_ev</span></a><span> </span><a href="#local-6989586621682865518"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><span class="hs-identifier hs-var">IsSwapped</span><span> </span><a href="#local-6989586621682865524"><span class="hs-identifier hs-var">tv2</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682865521"><span class="hs-identifier hs-var">ps_ty1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkCastTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865527"><span class="hs-identifier hs-var">sym_co2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1985"></a><span>
</span><a name="line-1986"></a><span class="hs-identifier">canEqTyVarHomo</span><span> </span><a name="local-6989586621682865535"><a href="#local-6989586621682865535"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865536"><a href="#local-6989586621682865536"><span class="hs-identifier">eq_rel</span></a></a><span> </span><a name="local-6989586621682865537"><a href="#local-6989586621682865537"><span class="hs-identifier">swapped</span></a></a><span> </span><a name="local-6989586621682865538"><a href="#local-6989586621682865538"><span class="hs-identifier">tv1</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682865539"><a href="#local-6989586621682865539"><span class="hs-identifier">ps_ty2</span></a></a><span>
</span><a name="line-1987"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682865540"><a href="#local-6989586621682865540"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1988"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#canEqTyVar2"><span class="hs-identifier hs-var">canEqTyVar2</span></a><span> </span><a href="#local-6989586621682865540"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682865535"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865536"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><a href="#local-6989586621682865537"><span class="hs-identifier hs-var">swapped</span></a><span> </span><a href="#local-6989586621682865538"><span class="hs-identifier hs-var">tv1</span></a><span> </span><a href="#local-6989586621682865539"><span class="hs-identifier hs-var">ps_ty2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1989"></a><span>
</span><a name="line-1990"></a><span class="hs-comment">-- The RHS here is either not a casted tyvar, or it's a tyvar but we want</span><span>
</span><a name="line-1991"></a><span class="hs-comment">-- to rewrite the LHS to the RHS (as per swapOverTyVars)</span><span>
</span><a name="line-1992"></a><span class="hs-identifier">canEqTyVar2</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-1993"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span>   </span><span class="hs-comment">-- lhs ~ rhs (or, if swapped, orhs ~ olhs)</span><span>
</span><a name="line-1994"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">EqRel</span><span>
</span><a name="line-1995"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SwapFlag</span><span>
</span><a name="line-1996"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span>                  </span><span class="hs-comment">-- lhs = tv, flat</span><span>
</span><a name="line-1997"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>                   </span><span class="hs-comment">-- rhs</span><span>
</span><a name="line-1998"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span>
</span><a name="line-1999"></a><span class="hs-comment">-- LHS is an inert type variable,</span><span>
</span><a name="line-2000"></a><span class="hs-comment">-- and RHS is fully rewritten, but with type synonyms</span><span>
</span><a name="line-2001"></a><span class="hs-comment">-- preserved as much as possible</span><span>
</span><a name="line-2002"></a><a name="canEqTyVar2"><a href="TcCanonical.html#canEqTyVar2"><span class="hs-identifier">canEqTyVar2</span></a></a><span> </span><a name="local-6989586621682865541"><a href="#local-6989586621682865541"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682865542"><a href="#local-6989586621682865542"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865543"><a href="#local-6989586621682865543"><span class="hs-identifier">eq_rel</span></a></a><span> </span><a name="local-6989586621682865544"><a href="#local-6989586621682865544"><span class="hs-identifier">swapped</span></a></a><span> </span><a name="local-6989586621682865545"><a href="#local-6989586621682865545"><span class="hs-identifier">tv1</span></a></a><span> </span><a name="local-6989586621682865546"><a href="#local-6989586621682865546"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-2003"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682865551"><a href="#local-6989586621682865551"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#metaTyVarUpdateOK"><span class="hs-identifier hs-var">metaTyVarUpdateOK</span></a><span> </span><a href="#local-6989586621682865541"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682865545"><span class="hs-identifier hs-var">tv1</span></a><span> </span><a href="#local-6989586621682865546"><span class="hs-identifier hs-var">rhs</span></a><span>  </span><span class="hs-comment">-- No occurs check</span><span>
</span><a name="line-2004"></a><span>     </span><span class="hs-comment">-- Must do the occurs check even on tyvar/tyvar</span><span>
</span><a name="line-2005"></a><span>     </span><span class="hs-comment">-- equalities, in case have  x ~ (y :: ..x...)</span><span>
</span><a name="line-2006"></a><span>     </span><span class="hs-comment">-- Trac #12593</span><span>
</span><a name="line-2007"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682865552"><a href="#local-6989586621682865552"><span class="hs-identifier">new_ev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcCanonical.html#rewriteEqEvidence"><span class="hs-identifier hs-var">rewriteEqEvidence</span></a><span> </span><a href="#local-6989586621682865542"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865544"><span class="hs-identifier hs-var">swapped</span></a><span> </span><a href="#local-6989586621682865548"><span class="hs-identifier hs-var">lhs</span></a><span> </span><a href="#local-6989586621682865551"><span class="hs-identifier hs-var">rhs'</span></a><span> </span><a href="#local-6989586621682865549"><span class="hs-identifier hs-var">rewrite_co1</span></a><span> </span><a href="#local-6989586621682865550"><span class="hs-identifier hs-var">rewrite_co2</span></a><span>
</span><a name="line-2008"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CTyEqCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865552"><span class="hs-identifier hs-var">new_ev</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_tyvar</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865545"><span class="hs-identifier hs-var">tv1</span></a><span>
</span><a name="line-2009"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865551"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_eq_rel</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865543"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2010"></a><span>
</span><a name="line-2011"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-comment">-- For some reason (occurs check, or forall) we can't unify</span><span>
</span><a name="line-2012"></a><span>               </span><span class="hs-comment">-- We must not use it for further rewriting!</span><span>
</span><a name="line-2013"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;canEqTyVar2 can't unify&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865545"><span class="hs-identifier hs-var">tv1</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865546"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2014"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682865553"><a href="#local-6989586621682865553"><span class="hs-identifier">new_ev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcCanonical.html#rewriteEqEvidence"><span class="hs-identifier hs-var">rewriteEqEvidence</span></a><span> </span><a href="#local-6989586621682865542"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865544"><span class="hs-identifier hs-var">swapped</span></a><span> </span><a href="#local-6989586621682865548"><span class="hs-identifier hs-var">lhs</span></a><span> </span><a href="#local-6989586621682865546"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621682865549"><span class="hs-identifier hs-var">rewrite_co1</span></a><span> </span><a href="#local-6989586621682865550"><span class="hs-identifier hs-var">rewrite_co2</span></a><span>
</span><a name="line-2015"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isInsolubleOccursCheck</span><span> </span><a href="#local-6989586621682865543"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><a href="#local-6989586621682865545"><span class="hs-identifier hs-var">tv1</span></a><span> </span><a href="#local-6989586621682865546"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-2016"></a><span>         </span><span class="hs-keyword">then</span><span> </span><a href="TcCanonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkInsolubleCt</span><span> </span><a href="#local-6989586621682865553"><span class="hs-identifier hs-var">new_ev</span></a><span class="hs-special">)</span><span>
</span><a name="line-2017"></a><span>             </span><span class="hs-comment">-- If we have a ~ [a], it is not canonical, and in particular</span><span>
</span><a name="line-2018"></a><span>             </span><span class="hs-comment">-- we don't want to rewrite existing inerts with it, otherwise</span><span>
</span><a name="line-2019"></a><span>             </span><span class="hs-comment">-- we'd risk divergence in the constraint solver</span><span>
</span><a name="line-2020"></a><span>
</span><a name="line-2021"></a><span>         </span><span class="hs-keyword">else</span><span> </span><a href="TcCanonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkIrredCt</span><span> </span><a href="#local-6989586621682865553"><span class="hs-identifier hs-var">new_ev</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2022"></a><span>             </span><span class="hs-comment">-- A representational equality with an occurs-check problem isn't</span><span>
</span><a name="line-2023"></a><span>             </span><span class="hs-comment">-- insoluble! For example:</span><span>
</span><a name="line-2024"></a><span>             </span><span class="hs-comment">--   a ~R b a</span><span>
</span><a name="line-2025"></a><span>             </span><span class="hs-comment">-- We might learn that b is the newtype Id.</span><span>
</span><a name="line-2026"></a><span>             </span><span class="hs-comment">-- But, the occurs-check certainly prevents the equality from being</span><span>
</span><a name="line-2027"></a><span>             </span><span class="hs-comment">-- canonical, and we might loop if we were to use it in rewriting.</span><span>
</span><a name="line-2028"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2029"></a><span>    </span><span class="hs-keyword">role</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">eqRelRole</span><span> </span><a href="#local-6989586621682865543"><span class="hs-identifier hs-var">eq_rel</span></a><span>
</span><a name="line-2030"></a><span>
</span><a name="line-2031"></a><span>    </span><a name="local-6989586621682865548"><a href="#local-6989586621682865548"><span class="hs-identifier">lhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621682865545"><span class="hs-identifier hs-var">tv1</span></a><span>
</span><a name="line-2032"></a><span>
</span><a name="line-2033"></a><span>    </span><a name="local-6989586621682865549"><a href="#local-6989586621682865549"><span class="hs-identifier">rewrite_co1</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcReflCo</span><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865548"><span class="hs-identifier hs-var">lhs</span></a><span>
</span><a name="line-2034"></a><span>    </span><a name="local-6989586621682865550"><a href="#local-6989586621682865550"><span class="hs-identifier">rewrite_co2</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcReflCo</span><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865546"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-2035"></a><span>
</span><a name="line-2036"></a><span class="hs-comment">-- | Solve a reflexive equality constraint</span><span>
</span><a name="line-2037"></a><span class="hs-identifier">canEqReflexive</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span>    </span><span class="hs-comment">-- ty ~ ty</span><span>
</span><a name="line-2038"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">EqRel</span><span>
</span><a name="line-2039"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>        </span><span class="hs-comment">-- ty</span><span>
</span><a name="line-2040"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- always Stop</span><span>
</span><a name="line-2041"></a><a name="canEqReflexive"><a href="TcCanonical.html#canEqReflexive"><span class="hs-identifier">canEqReflexive</span></a></a><span> </span><a name="local-6989586621682865554"><a href="#local-6989586621682865554"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865555"><a href="#local-6989586621682865555"><span class="hs-identifier">eq_rel</span></a></a><span> </span><a name="local-6989586621682865556"><a href="#local-6989586621682865556"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-2042"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#setEvBindIfWanted"><span class="hs-identifier hs-var">setEvBindIfWanted</span></a><span> </span><a href="#local-6989586621682865554"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">evCoercion</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2043"></a><span>                               </span><span class="hs-identifier hs-var">mkTcReflCo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">eqRelRole</span><span> </span><a href="#local-6989586621682865555"><span class="hs-identifier hs-var">eq_rel</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682865556"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-2044"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a><span> </span><a href="#local-6989586621682865554"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-string">&quot;Solved by reflexivity&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2045"></a><span>
</span><a name="line-2046"></a><span class="hs-comment">{-
Note [Canonical orientation for tyvar/tyvar equality constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we have a ~ b where both 'a' and 'b' are TcTyVars, which way
round should be oriented in the CTyEqCan?  The rules, implemented by
canEqTyVarTyVar, are these

 * If either is a flatten-meta-variables, it goes on the left.

 * Put a meta-tyvar on the left if possible
       alpha[3] ~ r

 * If both are meta-tyvars, put the more touchable one (deepest level
   number) on the left, so there is the best chance of unifying it
        alpha[3] ~ beta[2]

 * If both are meta-tyvars and both at the same level, put a TyVarTv
   on the right if possible
        alpha[2] ~ beta[2](sig-tv)
   That way, when we unify alpha := beta, we don't lose the TyVarTv flag.

 * Put a meta-tv with a System Name on the left if possible so it
   gets eliminated (improves error messages)

 * If one is a flatten-skolem, put it on the left so that it is
   substituted out  Note [Eliminate flat-skols] in TcUinfy
        fsk ~ a

Note [Equalities with incompatible kinds]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
What do we do when we have an equality

  (tv :: k1) ~ (rhs :: k2)

where k1 and k2 differ? This Note explores this treacherous area.

First off, the question above is slightly the wrong question. Flattening
a tyvar will flatten its kind (Note [Flattening] in TcFlatten); flattening
the kind might introduce a cast. So we might have a casted tyvar on the
left. We thus revise our test case to

  (tv |&gt; co :: k1) ~ (rhs :: k2)

We must proceed differently here depending on whether we have a Wanted
or a Given. Consider this:

 [W] w :: (alpha :: k) ~ (Int :: Type)

where k is a skolem. One possible way forward is this:

 [W] co :: k ~ Type
 [W] w :: (alpha :: k) ~ (Int |&gt; sym co :: k)

The next step will be to unify

  alpha := Int |&gt; sym co

Now, consider what error we'll report if we can't solve the &quot;co&quot;
wanted. Its CtOrigin is the w wanted... which now reads (after zonking)
Int ~ Int. The user thus sees that GHC can't solve Int ~ Int, which
is embarrassing. See #11198 for more tales of destruction.

The reason for this odd behavior is much the same as
Note [Wanteds do not rewrite Wanteds] in TcRnTypes: note that the
new `co` is a Wanted.

   The solution is then not to use `co` to &quot;rewrite&quot; -- that is, cast
   -- `w`, but instead to keep `w` heterogeneous and
   irreducible. Given that we're not using `co`, there is no reason to
   collect evidence for it, so `co` is born a Derived, with a CtOrigin
   of KindEqOrigin.

When the Derived is solved (by unification), the original wanted (`w`)
will get kicked out.

Note that, if we had [G] co1 :: k ~ Type available, then none of this code would
trigger, because flattening would have rewritten k to Type. That is,
`w` would look like [W] (alpha |&gt; co1 :: Type) ~ (Int :: Type), and the tyvar
case will trigger, correctly rewriting alpha to (Int |&gt; sym co1).

Successive canonicalizations of the same Wanted may produce
duplicate Deriveds. Similar duplications can happen with fundeps, and there
seems to be no easy way to avoid. I expect this case to be rare.

For Givens, this problem doesn't bite, so a heterogeneous Given gives
rise to a Given kind equality. No Deriveds here. We thus homogenise
the Given (see the &quot;homo_co&quot; in the Given case in canEqTyVar) and
carry on with a homogeneous equality constraint.

Separately, I (Richard E) spent some time pondering what to do in the case
that we have [W] (tv |&gt; co1 :: k1) ~ (tv |&gt; co2 :: k2) where k1 and k2
differ. Note that the tv is the same. (This case is handled as the first
case in canEqTyVarHomo.) At one point, I thought we could solve this limited
form of heterogeneous Wanted, but I then reconsidered and now treat this case
just like any other heterogeneous Wanted.

Note [Type synonyms and canonicalization]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We treat type synonym applications as xi types, that is, they do not
count as type function applications.  However, we do need to be a bit
careful with type synonyms: like type functions they may not be
generative or injective.  However, unlike type functions, they are
parametric, so there is no problem in expanding them whenever we see
them, since we do not need to know anything about their arguments in
order to expand them; this is what justifies not having to treat them
as specially as type function applications.  The thing that causes
some subtleties is that we prefer to leave type synonym applications
*unexpanded* whenever possible, in order to generate better error
messages.

If we encounter an equality constraint with type synonym applications
on both sides, or a type synonym application on one side and some sort
of type application on the other, we simply must expand out the type
synonyms in order to continue decomposing the equality constraint into
primitive equality constraints.  For example, suppose we have

  type F a = [Int]

and we encounter the equality

  F a ~ [b]

In order to continue we must expand F a into [Int], giving us the
equality

  [Int] ~ [b]

which we can then decompose into the more primitive equality
constraint

  Int ~ b.

However, if we encounter an equality constraint with a type synonym
application on one side and a variable on the other side, we should
NOT (necessarily) expand the type synonym, since for the purpose of
good error messages we want to leave type synonyms unexpanded as much
as possible.  Hence the ps_ty1, ps_ty2 argument passed to canEqTyVar.

-}</span><span>
</span><a name="line-2185"></a><span>
</span><a name="line-2186"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                  Evidence transformation
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-2193"></a><span>
</span><a name="line-2194"></a><span class="hs-keyword">data</span><span> </span><a name="StopOrContinue"><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier">StopOrContinue</span></a></a><span> </span><a name="local-6989586621682864903"><a href="#local-6989586621682864903"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-2195"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="ContinueWith"><a href="TcCanonical.html#ContinueWith"><span class="hs-identifier">ContinueWith</span></a></a><span> </span><a href="#local-6989586621682864903"><span class="hs-identifier hs-type">a</span></a><span>    </span><span class="hs-comment">-- The constraint was not solved, although it may have</span><span>
</span><a name="line-2196"></a><span>                      </span><span class="hs-comment">--   been rewritten</span><span>
</span><a name="line-2197"></a><span>
</span><a name="line-2198"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Stop"><a href="TcCanonical.html#Stop"><span class="hs-identifier">Stop</span></a></a><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span>   </span><span class="hs-comment">-- The (rewritten) constraint was solved</span><span>
</span><a name="line-2199"></a><span>         </span><span class="hs-identifier hs-type">SDoc</span><span>         </span><span class="hs-comment">-- Tells how it was solved</span><span>
</span><a name="line-2200"></a><span>                      </span><span class="hs-comment">-- Any new sub-goals have been put on the work list</span><span>
</span><a name="line-2201"></a><span>
</span><a name="line-2202"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2203"></a><span>  </span><a name="local-3458764513820541101"><span class="hs-identifier">fmap</span></a><span> </span><a name="local-6989586621682864908"><a href="#local-6989586621682864908"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#ContinueWith"><span class="hs-identifier hs-var">ContinueWith</span></a><span> </span><a name="local-6989586621682864909"><a href="#local-6989586621682864909"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#ContinueWith"><span class="hs-identifier hs-var">ContinueWith</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682864908"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621682864909"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-2204"></a><span>  </span><span class="hs-identifier">fmap</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a name="local-6989586621682864910"><a href="#local-6989586621682864910"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682864911"><a href="#local-6989586621682864911"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a href="#local-6989586621682864910"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682864911"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-2205"></a><span>
</span><a name="line-2206"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621682864904"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><a href="#local-6989586621682864904"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2207"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a name="local-6989586621682864905"><a href="#local-6989586621682864905"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682864906"><a href="#local-6989586621682864906"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Stop&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><a href="#local-6989586621682864906"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682864905"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-2208"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#ContinueWith"><span class="hs-identifier hs-var">ContinueWith</span></a><span> </span><a name="local-6989586621682864907"><a href="#local-6989586621682864907"><span class="hs-identifier">w</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;ContinueWith&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682864907"><span class="hs-identifier hs-var">w</span></a><span>
</span><a name="line-2209"></a><span>
</span><a name="line-2210"></a><span class="hs-identifier">continueWith</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621682864915"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><a href="#local-6989586621682864915"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-2211"></a><a name="continueWith"><a href="TcCanonical.html#continueWith"><span class="hs-identifier">continueWith</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="TcCanonical.html#ContinueWith"><span class="hs-identifier hs-var">ContinueWith</span></a><span>
</span><a name="line-2212"></a><span>
</span><a name="line-2213"></a><span class="hs-identifier">stopWith</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><a href="#local-6989586621682864914"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-2214"></a><a name="stopWith"><a href="TcCanonical.html#stopWith"><span class="hs-identifier">stopWith</span></a></a><span> </span><a name="local-6989586621682865557"><a href="#local-6989586621682865557"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865558"><a href="#local-6989586621682865558"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a href="#local-6989586621682865557"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621682865558"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2215"></a><span>
</span><a name="line-2216"></a><span class="hs-identifier">andWhenContinue</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><a href="#local-6989586621682864912"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-2217"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682864912"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><a href="#local-6989586621682864913"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2218"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><a href="#local-6989586621682864913"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-2219"></a><a name="andWhenContinue"><a href="TcCanonical.html#andWhenContinue"><span class="hs-identifier">andWhenContinue</span></a></a><span> </span><a name="local-6989586621682865559"><a href="#local-6989586621682865559"><span class="hs-identifier">tcs1</span></a></a><span> </span><a name="local-6989586621682865560"><a href="#local-6989586621682865560"><span class="hs-identifier">tcs2</span></a></a><span>
</span><a name="line-2220"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682865561"><a href="#local-6989586621682865561"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682865559"><span class="hs-identifier hs-var">tcs1</span></a><span>
</span><a name="line-2221"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682865561"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2222"></a><span>           </span><a href="TcCanonical.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a name="local-6989586621682865562"><a href="#local-6989586621682865562"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682865563"><a href="#local-6989586621682865563"><span class="hs-identifier">s</span></a></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#Stop"><span class="hs-identifier hs-var">Stop</span></a><span> </span><a href="#local-6989586621682865562"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682865563"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-2223"></a><span>           </span><a href="TcCanonical.html#ContinueWith"><span class="hs-identifier hs-var">ContinueWith</span></a><span> </span><a name="local-6989586621682865564"><a href="#local-6989586621682865564"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682865560"><span class="hs-identifier hs-var">tcs2</span></a><span> </span><a href="#local-6989586621682865564"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2224"></a><span class="hs-keyword">infixr</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">`</span><a href="TcCanonical.html#andWhenContinue"><span class="hs-identifier hs-var">andWhenContinue</span></a><span class="hs-special">`</span><span>    </span><span class="hs-comment">-- allow chaining with ($)</span><span>
</span><a name="line-2225"></a><span>
</span><a name="line-2226"></a><span class="hs-identifier">rewriteEvidence</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span>   </span><span class="hs-comment">-- old evidence</span><span>
</span><a name="line-2227"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcPredType</span><span>   </span><span class="hs-comment">-- new predicate</span><span>
</span><a name="line-2228"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcCoercion</span><span>   </span><span class="hs-comment">-- Of type :: new predicate ~ &lt;type of old evidence&gt;</span><span>
</span><a name="line-2229"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#StopOrContinue"><span class="hs-identifier hs-type">StopOrContinue</span></a><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span class="hs-special">)</span><span>
</span><a name="line-2230"></a><span class="hs-comment">-- Returns Just new_ev iff either (i)  'co' is reflexivity</span><span>
</span><a name="line-2231"></a><span class="hs-comment">--                             or (ii) 'co' is not reflexivity, and 'new_pred' not cached</span><span>
</span><a name="line-2232"></a><span class="hs-comment">-- In either case, there is nothing new to do with new_ev</span><span>
</span><a name="line-2233"></a><span class="hs-comment">{-
     rewriteEvidence old_ev new_pred co
Main purpose: create new evidence for new_pred;
              unless new_pred is cached already
* Returns a new_ev : new_pred, with same wanted/given/derived flag as old_ev
* If old_ev was wanted, create a binding for old_ev, in terms of new_ev
* If old_ev was given, AND not cached, create a binding for new_ev, in terms of old_ev
* Returns Nothing if new_ev is already cached

        Old evidence    New predicate is               Return new evidence
        flavour                                        of same flavor
        -------------------------------------------------------------------
        Wanted          Already solved or in inert     Nothing
        or Derived      Not                            Just new_evidence

        Given           Already in inert               Nothing
                        Not                            Just new_evidence

Note [Rewriting with Refl]
~~~~~~~~~~~~~~~~~~~~~~~~~~
If the coercion is just reflexivity then you may re-use the same
variable.  But be careful!  Although the coercion is Refl, new_pred
may reflect the result of unification alpha := ty, so new_pred might
not _look_ the same as old_pred, and it's vital to proceed from now on
using new_pred.

qThe flattener preserves type synonyms, so they should appear in new_pred
as well as in old_pred; that is important for good error messages.
 -}</span><span>
</span><a name="line-2262"></a><span>
</span><a name="line-2263"></a><span>
</span><a name="line-2264"></a><a name="rewriteEvidence"><a href="TcCanonical.html#rewriteEvidence"><span class="hs-identifier">rewriteEvidence</span></a></a><span> </span><a name="local-6989586621682865565"><a href="#local-6989586621682865565"><span class="hs-identifier">old_ev</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">CtDerived</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682865566"><a href="#local-6989586621682865566"><span class="hs-identifier">new_pred</span></a></a><span> </span><a name="local-6989586621682865567"><a href="#local-6989586621682865567"><span class="hs-identifier">_co</span></a></a><span>
</span><a name="line-2265"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- If derived, don't even look at the coercion.</span><span>
</span><a name="line-2266"></a><span>    </span><span class="hs-comment">-- This is very important, DO NOT re-order the equations for</span><span>
</span><a name="line-2267"></a><span>    </span><span class="hs-comment">-- rewriteEvidence to put the isTcReflCo test first!</span><span>
</span><a name="line-2268"></a><span>    </span><span class="hs-comment">-- Why?  Because for *Derived* constraints, c, the coercion, which</span><span>
</span><a name="line-2269"></a><span>    </span><span class="hs-comment">-- was produced by flattening, may contain suspended calls to</span><span>
</span><a name="line-2270"></a><span>    </span><span class="hs-comment">-- (ctEvExpr c), which fails for Derived constraints.</span><span>
</span><a name="line-2271"></a><span>    </span><span class="hs-comment">-- (Getting this wrong caused Trac #7384.)</span><span>
</span><a name="line-2272"></a><span>    </span><a href="TcCanonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682865565"><span class="hs-identifier hs-var">old_ev</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_pred</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865566"><span class="hs-identifier hs-var">new_pred</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2273"></a><span>
</span><a name="line-2274"></a><span class="hs-identifier">rewriteEvidence</span><span> </span><a name="local-6989586621682865568"><a href="#local-6989586621682865568"><span class="hs-identifier">old_ev</span></a></a><span> </span><a name="local-6989586621682865569"><a href="#local-6989586621682865569"><span class="hs-identifier">new_pred</span></a></a><span> </span><a name="local-6989586621682865570"><a href="#local-6989586621682865570"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-2275"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTcReflCo</span><span> </span><a href="#local-6989586621682865570"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-comment">-- See Note [Rewriting with Refl]</span><span>
</span><a name="line-2276"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682865568"><span class="hs-identifier hs-var">old_ev</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_pred</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865569"><span class="hs-identifier hs-var">new_pred</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2277"></a><span>
</span><a name="line-2278"></a><span class="hs-identifier">rewriteEvidence</span><span> </span><a name="local-6989586621682865571"><a href="#local-6989586621682865571"><span class="hs-identifier">ev</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">CtGiven</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_evar</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682865572"><a href="#local-6989586621682865572"><span class="hs-identifier">old_evar</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ctev_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682865573"><a href="#local-6989586621682865573"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682865574"><a href="#local-6989586621682865574"><span class="hs-identifier">new_pred</span></a></a><span> </span><a name="local-6989586621682865575"><a href="#local-6989586621682865575"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-2279"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682865577"><a href="#local-6989586621682865577"><span class="hs-identifier">new_ev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#newGivenEvVar"><span class="hs-identifier hs-var">newGivenEvVar</span></a><span> </span><a href="#local-6989586621682865573"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682865574"><span class="hs-identifier hs-var">new_pred</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682865576"><span class="hs-identifier hs-var">new_tm</span></a><span class="hs-special">)</span><span>
</span><a name="line-2280"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a><span> </span><a href="#local-6989586621682865577"><span class="hs-identifier hs-var">new_ev</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2281"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2282"></a><span>    </span><span class="hs-comment">-- mkEvCast optimises ReflCo</span><span>
</span><a name="line-2283"></a><span>    </span><a name="local-6989586621682865576"><a href="#local-6989586621682865576"><span class="hs-identifier">new_tm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkEvCast</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">evId</span><span> </span><a href="#local-6989586621682865572"><span class="hs-identifier hs-var">old_evar</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tcDowngradeRole</span><span> </span><span class="hs-identifier hs-var">Representational</span><span>
</span><a name="line-2284"></a><span>                                                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvRole</span><span> </span><a href="#local-6989586621682865571"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span>
</span><a name="line-2285"></a><span>                                                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTcSymCo</span><span> </span><a href="#local-6989586621682865575"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2286"></a><span>
</span><a name="line-2287"></a><span class="hs-identifier">rewriteEvidence</span><span> </span><a name="local-6989586621682865578"><a href="#local-6989586621682865578"><span class="hs-identifier">ev</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">CtWanted</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_dest</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682865579"><a href="#local-6989586621682865579"><span class="hs-identifier">dest</span></a></a><span>
</span><a name="line-2288"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ctev_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682865580"><a href="#local-6989586621682865580"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682865581"><a href="#local-6989586621682865581"><span class="hs-identifier">new_pred</span></a></a><span> </span><a name="local-6989586621682865582"><a href="#local-6989586621682865582"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-2289"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682865583"><a href="#local-6989586621682865583"><span class="hs-identifier">mb_new_ev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#newWanted"><span class="hs-identifier hs-var">newWanted</span></a><span> </span><a href="#local-6989586621682865580"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621682865581"><span class="hs-identifier hs-var">new_pred</span></a><span>
</span><a name="line-2290"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">MASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">tcCoercionRole</span><span> </span><span class="hs-identifier hs-var">co</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">ctEvRole</span><span> </span><span class="hs-identifier">ev</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2291"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#setWantedEvTerm"><span class="hs-identifier hs-var">setWantedEvTerm</span></a><span> </span><a href="#local-6989586621682865579"><span class="hs-identifier hs-var">dest</span></a><span>
</span><a name="line-2292"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkEvCast</span><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#getEvExpr"><span class="hs-identifier hs-var">getEvExpr</span></a><span> </span><a href="#local-6989586621682865583"><span class="hs-identifier hs-var">mb_new_ev</span></a><span class="hs-special">)</span><span>
</span><a name="line-2293"></a><span>                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tcDowngradeRole</span><span> </span><span class="hs-identifier hs-var">Representational</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvRole</span><span> </span><a href="#local-6989586621682865578"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682865582"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2294"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682865583"><span class="hs-identifier hs-var">mb_new_ev</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2295"></a><span>            </span><a href="TcSMonad.html#Fresh"><span class="hs-identifier hs-var">Fresh</span></a><span>  </span><a name="local-6989586621682865584"><a href="#local-6989586621682865584"><span class="hs-identifier">new_ev</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcCanonical.html#continueWith"><span class="hs-identifier hs-var">continueWith</span></a><span> </span><a href="#local-6989586621682865584"><span class="hs-identifier hs-var">new_ev</span></a><span>
</span><a name="line-2296"></a><span>            </span><a href="TcSMonad.html#Cached"><span class="hs-identifier hs-var">Cached</span></a><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcCanonical.html#stopWith"><span class="hs-identifier hs-var">stopWith</span></a><span> </span><a href="#local-6989586621682865578"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-string">&quot;Cached wanted&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2297"></a><span>
</span><a name="line-2298"></a><span>
</span><a name="line-2299"></a><span class="hs-identifier">rewriteEqEvidence</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span>         </span><span class="hs-comment">-- Old evidence :: olhs ~ orhs (not swapped)</span><span>
</span><a name="line-2300"></a><span>                                        </span><span class="hs-comment">--              or orhs ~ olhs (swapped)</span><span>
</span><a name="line-2301"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SwapFlag</span><span>
</span><a name="line-2302"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>   </span><span class="hs-comment">-- New predicate  nlhs ~ nrhs</span><span>
</span><a name="line-2303"></a><span>                                        </span><span class="hs-comment">-- Should be zonked, because we use tcTypeKind on nlhs/nrhs</span><span>
</span><a name="line-2304"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcCoercion</span><span>         </span><span class="hs-comment">-- lhs_co, of type :: nlhs ~ olhs</span><span>
</span><a name="line-2305"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcCoercion</span><span>         </span><span class="hs-comment">-- rhs_co, of type :: nrhs ~ orhs</span><span>
</span><a name="line-2306"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span>     </span><span class="hs-comment">-- Of type nlhs ~ nrhs</span><span>
</span><a name="line-2307"></a><span class="hs-comment">-- For (rewriteEqEvidence (Given g olhs orhs) False nlhs nrhs lhs_co rhs_co)</span><span>
</span><a name="line-2308"></a><span class="hs-comment">-- we generate</span><span>
</span><a name="line-2309"></a><span class="hs-comment">-- If not swapped</span><span>
</span><a name="line-2310"></a><span class="hs-comment">--      g1 : nlhs ~ nrhs = lhs_co ; g ; sym rhs_co</span><span>
</span><a name="line-2311"></a><span class="hs-comment">-- If 'swapped'</span><span>
</span><a name="line-2312"></a><span class="hs-comment">--      g1 : nlhs ~ nrhs = lhs_co ; Sym g ; sym rhs_co</span><span>
</span><a name="line-2313"></a><span class="hs-comment">--</span><span>
</span><a name="line-2314"></a><span class="hs-comment">-- For (Wanted w) we do the dual thing.</span><span>
</span><a name="line-2315"></a><span class="hs-comment">-- New  w1 : nlhs ~ nrhs</span><span>
</span><a name="line-2316"></a><span class="hs-comment">-- If not swapped</span><span>
</span><a name="line-2317"></a><span class="hs-comment">--      w : olhs ~ orhs = sym lhs_co ; w1 ; rhs_co</span><span>
</span><a name="line-2318"></a><span class="hs-comment">-- If swapped</span><span>
</span><a name="line-2319"></a><span class="hs-comment">--      w : orhs ~ olhs = sym rhs_co ; sym w1 ; lhs_co</span><span>
</span><a name="line-2320"></a><span class="hs-comment">--</span><span>
</span><a name="line-2321"></a><span class="hs-comment">-- It's all a form of rewwriteEvidence, specialised for equalities</span><span>
</span><a name="line-2322"></a><a name="rewriteEqEvidence"><a href="TcCanonical.html#rewriteEqEvidence"><span class="hs-identifier">rewriteEqEvidence</span></a></a><span> </span><a name="local-6989586621682865585"><a href="#local-6989586621682865585"><span class="hs-identifier">old_ev</span></a></a><span> </span><a name="local-6989586621682865586"><a href="#local-6989586621682865586"><span class="hs-identifier">swapped</span></a></a><span> </span><a name="local-6989586621682865587"><a href="#local-6989586621682865587"><span class="hs-identifier">nlhs</span></a></a><span> </span><a name="local-6989586621682865588"><a href="#local-6989586621682865588"><span class="hs-identifier">nrhs</span></a></a><span> </span><a name="local-6989586621682865589"><a href="#local-6989586621682865589"><span class="hs-identifier">lhs_co</span></a></a><span> </span><a name="local-6989586621682865590"><a href="#local-6989586621682865590"><span class="hs-identifier">rhs_co</span></a></a><span>
</span><a name="line-2323"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">CtDerived</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682865585"><span class="hs-identifier hs-var">old_ev</span></a><span>  </span><span class="hs-comment">-- Don't force the evidence for a Derived</span><span>
</span><a name="line-2324"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682865585"><span class="hs-identifier hs-var">old_ev</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_pred</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865591"><span class="hs-identifier hs-var">new_pred</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2325"></a><span>
</span><a name="line-2326"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">NotSwapped</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682865586"><span class="hs-identifier hs-var">swapped</span></a><span>
</span><a name="line-2327"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isTcReflCo</span><span> </span><a href="#local-6989586621682865589"><span class="hs-identifier hs-var">lhs_co</span></a><span>      </span><span class="hs-comment">-- See Note [Rewriting with Refl]</span><span>
</span><a name="line-2328"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isTcReflCo</span><span> </span><a href="#local-6989586621682865590"><span class="hs-identifier hs-var">rhs_co</span></a><span>
</span><a name="line-2329"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682865585"><span class="hs-identifier hs-var">old_ev</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_pred</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865591"><span class="hs-identifier hs-var">new_pred</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2330"></a><span>
</span><a name="line-2331"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">CtGiven</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_evar</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682865594"><a href="#local-6989586621682865594"><span class="hs-identifier">old_evar</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682865585"><span class="hs-identifier hs-var">old_ev</span></a><span>
</span><a name="line-2332"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682865595"><a href="#local-6989586621682865595"><span class="hs-identifier">new_tm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">evCoercion</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682865589"><span class="hs-identifier hs-var">lhs_co</span></a><span>
</span><a name="line-2333"></a><span>                                  </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkTcTransCo</span><span class="hs-special">`</span><span> </span><a href="TcCanonical.html#maybeSym"><span class="hs-identifier hs-var">maybeSym</span></a><span> </span><a href="#local-6989586621682865586"><span class="hs-identifier hs-var">swapped</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTcCoVarCo</span><span> </span><a href="#local-6989586621682865594"><span class="hs-identifier hs-var">old_evar</span></a><span class="hs-special">)</span><span>
</span><a name="line-2334"></a><span>                                  </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkTcTransCo</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">mkTcSymCo</span><span> </span><a href="#local-6989586621682865590"><span class="hs-identifier hs-var">rhs_co</span></a><span class="hs-special">)</span><span>
</span><a name="line-2335"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#newGivenEvVar"><span class="hs-identifier hs-var">newGivenEvVar</span></a><span> </span><a href="#local-6989586621682865593"><span class="hs-identifier hs-var">loc'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682865591"><span class="hs-identifier hs-var">new_pred</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682865595"><span class="hs-identifier hs-var">new_tm</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2336"></a><span>
</span><a name="line-2337"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">CtWanted</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_dest</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682865596"><a href="#local-6989586621682865596"><span class="hs-identifier">dest</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682865585"><span class="hs-identifier hs-var">old_ev</span></a><span>
</span><a name="line-2338"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682865597"><a href="#local-6989586621682865597"><span class="hs-identifier">new_ev</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682865598"><a href="#local-6989586621682865598"><span class="hs-identifier">hole_co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#newWantedEq"><span class="hs-identifier hs-var">newWantedEq</span></a><span> </span><a href="#local-6989586621682865593"><span class="hs-identifier hs-var">loc'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvRole</span><span> </span><a href="#local-6989586621682865585"><span class="hs-identifier hs-var">old_ev</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682865587"><span class="hs-identifier hs-var">nlhs</span></a><span> </span><a href="#local-6989586621682865588"><span class="hs-identifier hs-var">nrhs</span></a><span>
</span><a name="line-2339"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682865599"><a href="#local-6989586621682865599"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#maybeSym"><span class="hs-identifier hs-var">maybeSym</span></a><span> </span><a href="#local-6989586621682865586"><span class="hs-identifier hs-var">swapped</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2340"></a><span>                  </span><span class="hs-identifier hs-var">mkSymCo</span><span> </span><a href="#local-6989586621682865589"><span class="hs-identifier hs-var">lhs_co</span></a><span>
</span><a name="line-2341"></a><span>                  </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkTransCo</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865598"><span class="hs-identifier hs-var">hole_co</span></a><span>
</span><a name="line-2342"></a><span>                  </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkTransCo</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865590"><span class="hs-identifier hs-var">rhs_co</span></a><span>
</span><a name="line-2343"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#setWantedEq"><span class="hs-identifier hs-var">setWantedEq</span></a><span> </span><a href="#local-6989586621682865596"><span class="hs-identifier hs-var">dest</span></a><span> </span><a href="#local-6989586621682865599"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2344"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;rewriteEqEvidence&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865585"><span class="hs-identifier hs-var">old_ev</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865587"><span class="hs-identifier hs-var">nlhs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865588"><span class="hs-identifier hs-var">nrhs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682865599"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2345"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682865597"><span class="hs-identifier hs-var">new_ev</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2346"></a><span>
</span><a name="line-2347"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2348"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rewriteEvidence&quot;</span><span>
</span><a name="line-2349"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2350"></a><span>    </span><a name="local-6989586621682865591"><a href="#local-6989586621682865591"><span class="hs-identifier">new_pred</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcEqPredLikeEv</span><span> </span><a href="#local-6989586621682865585"><span class="hs-identifier hs-var">old_ev</span></a><span> </span><a href="#local-6989586621682865587"><span class="hs-identifier hs-var">nlhs</span></a><span> </span><a href="#local-6989586621682865588"><span class="hs-identifier hs-var">nrhs</span></a><span>
</span><a name="line-2351"></a><span>
</span><a name="line-2352"></a><span>      </span><span class="hs-comment">-- equality is like a type class. Bumping the depth is necessary because</span><span>
</span><a name="line-2353"></a><span>      </span><span class="hs-comment">-- of recursive newtypes, where &quot;reducing&quot; a newtype can actually make</span><span>
</span><a name="line-2354"></a><span>      </span><span class="hs-comment">-- it bigger. See Note [Newtypes can blow the stack].</span><span>
</span><a name="line-2355"></a><span>    </span><a name="local-6989586621682865592"><a href="#local-6989586621682865592"><span class="hs-identifier">loc</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ctEvLoc</span><span> </span><a href="#local-6989586621682865585"><span class="hs-identifier hs-var">old_ev</span></a><span>
</span><a name="line-2356"></a><span>    </span><a name="local-6989586621682865593"><a href="#local-6989586621682865593"><span class="hs-identifier">loc'</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bumpCtLocDepth</span><span> </span><a href="#local-6989586621682865592"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-2357"></a><span>
</span><a name="line-2358"></a><span class="hs-comment">{- Note [unifyWanted and unifyDerived]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When decomposing equalities we often create new wanted constraints for
(s ~ t).  But what if s=t?  Then it'd be faster to return Refl right away.
Similar remarks apply for Derived.

Rather than making an equality test (which traverses the structure of the
type, perhaps fruitlessly), unifyWanted traverses the common structure, and
bales out when it finds a difference by creating a new Wanted constraint.
But where it succeeds in finding common structure, it just builds a coercion
to reflect it.
-}</span><span>
</span><a name="line-2370"></a><span>
</span><a name="line-2371"></a><span class="hs-identifier">unifyWanted</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtLoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Role</span><span>
</span><a name="line-2372"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-identifier hs-type">Coercion</span><span>
</span><a name="line-2373"></a><span class="hs-comment">-- Return coercion witnessing the equality of the two types,</span><span>
</span><a name="line-2374"></a><span class="hs-comment">-- emitting new work equalities where necessary to achieve that</span><span>
</span><a name="line-2375"></a><span class="hs-comment">-- Very good short-cut when the two types are equal, or nearly so</span><span>
</span><a name="line-2376"></a><span class="hs-comment">-- See Note [unifyWanted and unifyDerived]</span><span>
</span><a name="line-2377"></a><span class="hs-comment">-- The returned coercion's role matches the input parameter</span><span>
</span><a name="line-2378"></a><a name="unifyWanted"><a href="TcCanonical.html#unifyWanted"><span class="hs-identifier">unifyWanted</span></a></a><span> </span><a name="local-6989586621682865600"><a href="#local-6989586621682865600"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-identifier hs-var">Phantom</span><span> </span><a name="local-6989586621682865601"><a href="#local-6989586621682865601"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865602"><a href="#local-6989586621682865602"><span class="hs-identifier">ty2</span></a></a><span>
</span><a name="line-2379"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682865603"><a href="#local-6989586621682865603"><span class="hs-identifier">kind_co</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcCanonical.html#unifyWanted"><span class="hs-identifier hs-var">unifyWanted</span></a><span> </span><a href="#local-6989586621682865600"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-identifier hs-var">Nominal</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tcTypeKind</span><span> </span><a href="#local-6989586621682865601"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tcTypeKind</span><span> </span><a href="#local-6989586621682865602"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">)</span><span>
</span><a name="line-2380"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkPhantomCo</span><span> </span><a href="#local-6989586621682865603"><span class="hs-identifier hs-var">kind_co</span></a><span> </span><a href="#local-6989586621682865601"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865602"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2381"></a><span>
</span><a name="line-2382"></a><span class="hs-identifier">unifyWanted</span><span> </span><a name="local-6989586621682865604"><a href="#local-6989586621682865604"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-keyword">role</span><span> </span><a name="local-6989586621682865606"><a href="#local-6989586621682865606"><span class="hs-identifier">orig_ty1</span></a></a><span> </span><a name="local-6989586621682865607"><a href="#local-6989586621682865607"><span class="hs-identifier">orig_ty2</span></a></a><span>
</span><a name="line-2383"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865608"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682865606"><span class="hs-identifier hs-var">orig_ty1</span></a><span> </span><a href="#local-6989586621682865607"><span class="hs-identifier hs-var">orig_ty2</span></a><span>
</span><a name="line-2384"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2385"></a><span>    </span><a name="local-6989586621682865608"><a href="#local-6989586621682865608"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621682865610"><a href="#local-6989586621682865610"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865611"><a href="#local-6989586621682865611"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682865612"><a href="#local-6989586621682865612"><span class="hs-identifier">ty1'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcView</span><span> </span><a href="#local-6989586621682865610"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865608"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682865612"><span class="hs-identifier hs-var">ty1'</span></a><span> </span><a href="#local-6989586621682865611"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-2386"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682865613"><a href="#local-6989586621682865613"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865614"><a href="#local-6989586621682865614"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682865615"><a href="#local-6989586621682865615"><span class="hs-identifier">ty2'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcView</span><span> </span><a href="#local-6989586621682865614"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865608"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682865613"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865615"><span class="hs-identifier hs-var">ty2'</span></a><span>
</span><a name="line-2387"></a><span>
</span><a name="line-2388"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunTy</span><span> </span><a name="local-6989586621682865616"><a href="#local-6989586621682865616"><span class="hs-identifier">s1</span></a></a><span> </span><a name="local-6989586621682865617"><a href="#local-6989586621682865617"><span class="hs-identifier">t1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunTy</span><span> </span><a name="local-6989586621682865618"><a href="#local-6989586621682865618"><span class="hs-identifier">s2</span></a></a><span> </span><a name="local-6989586621682865619"><a href="#local-6989586621682865619"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2389"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682865620"><a href="#local-6989586621682865620"><span class="hs-identifier">co_s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcCanonical.html#unifyWanted"><span class="hs-identifier hs-var">unifyWanted</span></a><span> </span><a href="#local-6989586621682865604"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865616"><span class="hs-identifier hs-var">s1</span></a><span> </span><a href="#local-6989586621682865618"><span class="hs-identifier hs-var">s2</span></a><span>
</span><a name="line-2390"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682865621"><a href="#local-6989586621682865621"><span class="hs-identifier">co_t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcCanonical.html#unifyWanted"><span class="hs-identifier hs-var">unifyWanted</span></a><span> </span><a href="#local-6989586621682865604"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865617"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-6989586621682865619"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-2391"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkFunCo</span><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865620"><span class="hs-identifier hs-var">co_s</span></a><span> </span><a href="#local-6989586621682865621"><span class="hs-identifier hs-var">co_t</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2392"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyConApp</span><span> </span><a name="local-6989586621682865622"><a href="#local-6989586621682865622"><span class="hs-identifier">tc1</span></a></a><span> </span><a name="local-6989586621682865623"><a href="#local-6989586621682865623"><span class="hs-identifier">tys1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyConApp</span><span> </span><a name="local-6989586621682865624"><a href="#local-6989586621682865624"><span class="hs-identifier">tc2</span></a></a><span> </span><a name="local-6989586621682865625"><a href="#local-6989586621682865625"><span class="hs-identifier">tys2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2393"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682865622"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682865624"><span class="hs-identifier hs-var">tc2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682865623"><span class="hs-identifier hs-var">tys1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">equalLength</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865625"><span class="hs-identifier hs-var">tys2</span></a><span>
</span><a name="line-2394"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isInjectiveTyCon</span><span> </span><a href="#local-6989586621682865622"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-keyword">role</span><span> </span><span class="hs-comment">-- don't look under newtypes at Rep equality</span><span>
</span><a name="line-2395"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682865626"><a href="#local-6989586621682865626"><span class="hs-identifier">cos</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zipWith3M</span><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#unifyWanted"><span class="hs-identifier hs-var">unifyWanted</span></a><span> </span><a href="#local-6989586621682865604"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">)</span><span>
</span><a name="line-2396"></a><span>                              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConRolesX</span><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865622"><span class="hs-identifier hs-var">tc1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682865623"><span class="hs-identifier hs-var">tys1</span></a><span> </span><a href="#local-6989586621682865625"><span class="hs-identifier hs-var">tys2</span></a><span>
</span><a name="line-2397"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConAppCo</span><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865622"><span class="hs-identifier hs-var">tc1</span></a><span> </span><a href="#local-6989586621682865626"><span class="hs-identifier hs-var">cos</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2398"></a><span>
</span><a name="line-2399"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682865627"><a href="#local-6989586621682865627"><span class="hs-identifier">ty1</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyVarTy</span><span> </span><a name="local-6989586621682865628"><a href="#local-6989586621682865628"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682865629"><a href="#local-6989586621682865629"><span class="hs-identifier">ty2</span></a></a><span>
</span><a name="line-2400"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682865630"><a href="#local-6989586621682865630"><span class="hs-identifier">mb_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#isFilledMetaTyVar_maybe"><span class="hs-identifier hs-var">isFilledMetaTyVar_maybe</span></a><span> </span><a href="#local-6989586621682865628"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-2401"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682865630"><span class="hs-identifier hs-var">mb_ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2402"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682865631"><a href="#local-6989586621682865631"><span class="hs-identifier">ty1'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682865608"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682865631"><span class="hs-identifier hs-var">ty1'</span></a><span> </span><a href="#local-6989586621682865629"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-2403"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682865609"><span class="hs-identifier hs-var">bale_out</span></a><span> </span><a href="#local-6989586621682865627"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865629"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">}</span><span>
</span><a name="line-2404"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682865632"><a href="#local-6989586621682865632"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865633"><a href="#local-6989586621682865633"><span class="hs-identifier">ty2</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyVarTy</span><span> </span><a name="local-6989586621682865634"><a href="#local-6989586621682865634"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2405"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682865635"><a href="#local-6989586621682865635"><span class="hs-identifier">mb_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#isFilledMetaTyVar_maybe"><span class="hs-identifier hs-var">isFilledMetaTyVar_maybe</span></a><span> </span><a href="#local-6989586621682865634"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-2406"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682865635"><span class="hs-identifier hs-var">mb_ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2407"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682865636"><a href="#local-6989586621682865636"><span class="hs-identifier">ty2'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682865608"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682865632"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865636"><span class="hs-identifier hs-var">ty2'</span></a><span>
</span><a name="line-2408"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682865609"><span class="hs-identifier hs-var">bale_out</span></a><span> </span><a href="#local-6989586621682865632"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865633"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2409"></a><span>
</span><a name="line-2410"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682865637"><a href="#local-6989586621682865637"><span class="hs-identifier">ty1</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoercionTy</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoercionTy</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2411"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkReflCo</span><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865637"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- we just don't care about coercions!</span><span>
</span><a name="line-2412"></a><span>
</span><a name="line-2413"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682865638"><a href="#local-6989586621682865638"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865639"><a href="#local-6989586621682865639"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865609"><span class="hs-identifier hs-var">bale_out</span></a><span> </span><a href="#local-6989586621682865638"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865639"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-2414"></a><span>
</span><a name="line-2415"></a><span>    </span><a name="local-6989586621682865609"><a href="#local-6989586621682865609"><span class="hs-identifier">bale_out</span></a></a><span> </span><a name="local-6989586621682865640"><a href="#local-6989586621682865640"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865641"><a href="#local-6989586621682865641"><span class="hs-identifier">ty2</span></a></a><span>
</span><a name="line-2416"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682865640"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">tcEqType</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865641"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTcReflCo</span><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865640"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">)</span><span>
</span><a name="line-2417"></a><span>        </span><span class="hs-comment">-- Check for equality; e.g. a ~ a, or (m a) ~ (m a)</span><span>
</span><a name="line-2418"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#emitNewWantedEq"><span class="hs-identifier hs-var">emitNewWantedEq</span></a><span> </span><a href="#local-6989586621682865604"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865606"><span class="hs-identifier hs-var">orig_ty1</span></a><span> </span><a href="#local-6989586621682865607"><span class="hs-identifier hs-var">orig_ty2</span></a><span>
</span><a name="line-2419"></a><span>
</span><a name="line-2420"></a><span class="hs-identifier">unifyDeriveds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtLoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Role</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2421"></a><span class="hs-comment">-- See Note [unifyWanted and unifyDerived]</span><span>
</span><a name="line-2422"></a><a name="unifyDeriveds"><a href="TcCanonical.html#unifyDeriveds"><span class="hs-identifier">unifyDeriveds</span></a></a><span> </span><a name="local-6989586621682865642"><a href="#local-6989586621682865642"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621682865643"><a href="#local-6989586621682865643"><span class="hs-identifier">roles</span></a></a><span> </span><a name="local-6989586621682865644"><a href="#local-6989586621682865644"><span class="hs-identifier">tys1</span></a></a><span> </span><a name="local-6989586621682865645"><a href="#local-6989586621682865645"><span class="hs-identifier">tys2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipWith3M_</span><span> </span><span class="hs-special">(</span><a href="TcCanonical.html#unify_derived"><span class="hs-identifier hs-var">unify_derived</span></a><span> </span><a href="#local-6989586621682865642"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682865643"><span class="hs-identifier hs-var">roles</span></a><span> </span><a href="#local-6989586621682865644"><span class="hs-identifier hs-var">tys1</span></a><span> </span><a href="#local-6989586621682865645"><span class="hs-identifier hs-var">tys2</span></a><span>
</span><a name="line-2423"></a><span>
</span><a name="line-2424"></a><span class="hs-identifier">unifyDerived</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtLoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Role</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Pair</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2425"></a><span class="hs-comment">-- See Note [unifyWanted and unifyDerived]</span><span>
</span><a name="line-2426"></a><a name="unifyDerived"><a href="TcCanonical.html#unifyDerived"><span class="hs-identifier">unifyDerived</span></a></a><span> </span><a name="local-6989586621682865646"><a href="#local-6989586621682865646"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-keyword">role</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Pair</span><span> </span><a name="local-6989586621682865648"><a href="#local-6989586621682865648"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865649"><a href="#local-6989586621682865649"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#unify_derived"><span class="hs-identifier hs-var">unify_derived</span></a><span> </span><a href="#local-6989586621682865646"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865648"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865649"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-2427"></a><span>
</span><a name="line-2428"></a><span class="hs-identifier">unify_derived</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtLoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Role</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2429"></a><span class="hs-comment">-- Create new Derived and put it in the work list</span><span>
</span><a name="line-2430"></a><span class="hs-comment">-- Should do nothing if the two types are equal</span><span>
</span><a name="line-2431"></a><span class="hs-comment">-- See Note [unifyWanted and unifyDerived]</span><span>
</span><a name="line-2432"></a><a name="unify_derived"><a href="TcCanonical.html#unify_derived"><span class="hs-identifier">unify_derived</span></a></a><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-identifier hs-var">Phantom</span><span> </span><span class="hs-identifier">_</span><span>        </span><span class="hs-identifier">_</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2433"></a><span class="hs-identifier">unify_derived</span><span> </span><a name="local-6989586621682865650"><a href="#local-6989586621682865650"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-keyword">role</span><span>    </span><a name="local-6989586621682865652"><a href="#local-6989586621682865652"><span class="hs-identifier">orig_ty1</span></a></a><span> </span><a name="local-6989586621682865653"><a href="#local-6989586621682865653"><span class="hs-identifier">orig_ty2</span></a></a><span>
</span><a name="line-2434"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865654"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682865652"><span class="hs-identifier hs-var">orig_ty1</span></a><span> </span><a href="#local-6989586621682865653"><span class="hs-identifier hs-var">orig_ty2</span></a><span>
</span><a name="line-2435"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2436"></a><span>    </span><a name="local-6989586621682865654"><a href="#local-6989586621682865654"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621682865656"><a href="#local-6989586621682865656"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865657"><a href="#local-6989586621682865657"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682865658"><a href="#local-6989586621682865658"><span class="hs-identifier">ty1'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcView</span><span> </span><a href="#local-6989586621682865656"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865654"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682865658"><span class="hs-identifier hs-var">ty1'</span></a><span> </span><a href="#local-6989586621682865657"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-2437"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682865659"><a href="#local-6989586621682865659"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865660"><a href="#local-6989586621682865660"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682865661"><a href="#local-6989586621682865661"><span class="hs-identifier">ty2'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcView</span><span> </span><a href="#local-6989586621682865660"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865654"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682865659"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865661"><span class="hs-identifier hs-var">ty2'</span></a><span>
</span><a name="line-2438"></a><span>
</span><a name="line-2439"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunTy</span><span> </span><a name="local-6989586621682865662"><a href="#local-6989586621682865662"><span class="hs-identifier">s1</span></a></a><span> </span><a name="local-6989586621682865663"><a href="#local-6989586621682865663"><span class="hs-identifier">t1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunTy</span><span> </span><a name="local-6989586621682865664"><a href="#local-6989586621682865664"><span class="hs-identifier">s2</span></a></a><span> </span><a name="local-6989586621682865665"><a href="#local-6989586621682865665"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2440"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcCanonical.html#unify_derived"><span class="hs-identifier hs-var">unify_derived</span></a><span> </span><a href="#local-6989586621682865650"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865662"><span class="hs-identifier hs-var">s1</span></a><span> </span><a href="#local-6989586621682865664"><span class="hs-identifier hs-var">s2</span></a><span>
</span><a name="line-2441"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="TcCanonical.html#unify_derived"><span class="hs-identifier hs-var">unify_derived</span></a><span> </span><a href="#local-6989586621682865650"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865663"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-6989586621682865665"><span class="hs-identifier hs-var">t2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2442"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyConApp</span><span> </span><a name="local-6989586621682865666"><a href="#local-6989586621682865666"><span class="hs-identifier">tc1</span></a></a><span> </span><a name="local-6989586621682865667"><a href="#local-6989586621682865667"><span class="hs-identifier">tys1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyConApp</span><span> </span><a name="local-6989586621682865668"><a href="#local-6989586621682865668"><span class="hs-identifier">tc2</span></a></a><span> </span><a name="local-6989586621682865669"><a href="#local-6989586621682865669"><span class="hs-identifier">tys2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2443"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682865666"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682865668"><span class="hs-identifier hs-var">tc2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682865667"><span class="hs-identifier hs-var">tys1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">equalLength</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865669"><span class="hs-identifier hs-var">tys2</span></a><span>
</span><a name="line-2444"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isInjectiveTyCon</span><span> </span><a href="#local-6989586621682865666"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-keyword">role</span><span>
</span><a name="line-2445"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcCanonical.html#unifyDeriveds"><span class="hs-identifier hs-var">unifyDeriveds</span></a><span> </span><a href="#local-6989586621682865650"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConRolesX</span><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865666"><span class="hs-identifier hs-var">tc1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682865667"><span class="hs-identifier hs-var">tys1</span></a><span> </span><a href="#local-6989586621682865669"><span class="hs-identifier hs-var">tys2</span></a><span>
</span><a name="line-2446"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682865670"><a href="#local-6989586621682865670"><span class="hs-identifier">ty1</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyVarTy</span><span> </span><a name="local-6989586621682865671"><a href="#local-6989586621682865671"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682865672"><a href="#local-6989586621682865672"><span class="hs-identifier">ty2</span></a></a><span>
</span><a name="line-2447"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682865673"><a href="#local-6989586621682865673"><span class="hs-identifier">mb_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#isFilledMetaTyVar_maybe"><span class="hs-identifier hs-var">isFilledMetaTyVar_maybe</span></a><span> </span><a href="#local-6989586621682865671"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-2448"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682865673"><span class="hs-identifier hs-var">mb_ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2449"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682865674"><a href="#local-6989586621682865674"><span class="hs-identifier">ty1'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682865654"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682865674"><span class="hs-identifier hs-var">ty1'</span></a><span> </span><a href="#local-6989586621682865672"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-2450"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682865655"><span class="hs-identifier hs-var">bale_out</span></a><span> </span><a href="#local-6989586621682865670"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865672"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2451"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682865675"><a href="#local-6989586621682865675"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865676"><a href="#local-6989586621682865676"><span class="hs-identifier">ty2</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyVarTy</span><span> </span><a name="local-6989586621682865677"><a href="#local-6989586621682865677"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2452"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682865678"><a href="#local-6989586621682865678"><span class="hs-identifier">mb_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#isFilledMetaTyVar_maybe"><span class="hs-identifier hs-var">isFilledMetaTyVar_maybe</span></a><span> </span><a href="#local-6989586621682865677"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-2453"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682865678"><span class="hs-identifier hs-var">mb_ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2454"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682865679"><a href="#local-6989586621682865679"><span class="hs-identifier">ty2'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682865654"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682865675"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865679"><span class="hs-identifier hs-var">ty2'</span></a><span>
</span><a name="line-2455"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682865655"><span class="hs-identifier hs-var">bale_out</span></a><span> </span><a href="#local-6989586621682865675"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865676"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2456"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682865680"><a href="#local-6989586621682865680"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865681"><a href="#local-6989586621682865681"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865655"><span class="hs-identifier hs-var">bale_out</span></a><span> </span><a href="#local-6989586621682865680"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682865681"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-2457"></a><span>
</span><a name="line-2458"></a><span>    </span><a name="local-6989586621682865655"><a href="#local-6989586621682865655"><span class="hs-identifier">bale_out</span></a></a><span> </span><a name="local-6989586621682865682"><a href="#local-6989586621682865682"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682865683"><a href="#local-6989586621682865683"><span class="hs-identifier">ty2</span></a></a><span>
</span><a name="line-2459"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682865682"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">tcEqType</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682865683"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2460"></a><span>        </span><span class="hs-comment">-- Check for equality; e.g. a ~ a, or (m a) ~ (m a)</span><span>
</span><a name="line-2461"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#emitNewDerivedEq"><span class="hs-identifier hs-var">emitNewDerivedEq</span></a><span> </span><a href="#local-6989586621682865650"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682865652"><span class="hs-identifier hs-var">orig_ty1</span></a><span> </span><a href="#local-6989586621682865653"><span class="hs-identifier hs-var">orig_ty2</span></a><span>
</span><a name="line-2462"></a><span>
</span><a name="line-2463"></a><span class="hs-identifier">maybeSym</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SwapFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcCoercion</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcCoercion</span><span>
</span><a name="line-2464"></a><a name="maybeSym"><a href="TcCanonical.html#maybeSym"><span class="hs-identifier">maybeSym</span></a></a><span> </span><span class="hs-identifier hs-var">IsSwapped</span><span>  </span><a name="local-6989586621682865684"><a href="#local-6989586621682865684"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcSymCo</span><span> </span><a href="#local-6989586621682865684"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2465"></a><span class="hs-identifier">maybeSym</span><span> </span><span class="hs-identifier hs-var">NotSwapped</span><span> </span><a name="local-6989586621682865685"><a href="#local-6989586621682865685"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682865685"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2466"></a></pre></body></html>