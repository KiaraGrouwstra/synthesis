<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns, CPP, MagicHash, NondecreasingIndentation #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# OPTIONS_GHC -fprof-auto-top #-}</span><span>
</span><a name="line-3"></a><span>
</span><a name="line-4"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-5"></a><span class="hs-comment">--</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- | Main API for compiling plain Haskell source code.</span><span>
</span><a name="line-7"></a><span class="hs-comment">--</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- This module implements compilation of a Haskell source. It is</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- /not/ concerned with preprocessing of source files; this is handled</span><span>
</span><a name="line-10"></a><span class="hs-comment">-- in &quot;DriverPipeline&quot;.</span><span>
</span><a name="line-11"></a><span class="hs-comment">--</span><span>
</span><a name="line-12"></a><span class="hs-comment">-- There are various entry points depending on what mode we're in:</span><span>
</span><a name="line-13"></a><span class="hs-comment">-- &quot;batch&quot; mode (@--make@), &quot;one-shot&quot; mode (@-c@, @-S@ etc.), and</span><span>
</span><a name="line-14"></a><span class="hs-comment">-- &quot;interactive&quot; mode (GHCi). There are also entry points for</span><span>
</span><a name="line-15"></a><span class="hs-comment">-- individual passes: parsing, typechecking/renaming, desugaring, and</span><span>
</span><a name="line-16"></a><span class="hs-comment">-- simplification.</span><span>
</span><a name="line-17"></a><span class="hs-comment">--</span><span>
</span><a name="line-18"></a><span class="hs-comment">-- All the functions here take an 'HscEnv' as a parameter, but none of</span><span>
</span><a name="line-19"></a><span class="hs-comment">-- them return a new one: 'HscEnv' is treated as an immutable value</span><span>
</span><a name="line-20"></a><span class="hs-comment">-- from here on in (although it has mutable components, for the</span><span>
</span><a name="line-21"></a><span class="hs-comment">-- caches).</span><span>
</span><a name="line-22"></a><span class="hs-comment">--</span><span>
</span><a name="line-23"></a><span class="hs-comment">-- We use the Hsc monad to deal with warning messages consistently:</span><span>
</span><a name="line-24"></a><span class="hs-comment">-- specifically, while executing within an Hsc monad, warnings are</span><span>
</span><a name="line-25"></a><span class="hs-comment">-- collected. When a Hsc monad returns to an IO monad, the</span><span>
</span><a name="line-26"></a><span class="hs-comment">-- warnings are printed, or compilation aborts if the @-Werror@</span><span>
</span><a name="line-27"></a><span class="hs-comment">-- flag is enabled.</span><span>
</span><a name="line-28"></a><span class="hs-comment">--</span><span>
</span><a name="line-29"></a><span class="hs-comment">-- (c) The GRASP/AQUA Project, Glasgow University, 1993-2000</span><span>
</span><a name="line-30"></a><span class="hs-comment">--</span><span>
</span><a name="line-31"></a><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">HscMain</span><span>
</span><a name="line-34"></a><span>    </span><span class="hs-special">(</span><span>
</span><a name="line-35"></a><span>    </span><span class="hs-comment">-- * Making an HscEnv</span><span>
</span><a name="line-36"></a><span>      </span><a href="HscMain.html#newHscEnv"><span class="hs-identifier hs-var">newHscEnv</span></a><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span>    </span><span class="hs-comment">-- * Compiling complete source files</span><span>
</span><a name="line-39"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#Messager"><span class="hs-identifier hs-type">Messager</span></a><span class="hs-special">,</span><span> </span><a href="HscMain.html#batchMsg"><span class="hs-identifier hs-var">batchMsg</span></a><span>
</span><a name="line-40"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HscStatus</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscIncrementalCompile"><span class="hs-identifier hs-var">hscIncrementalCompile</span></a><span>
</span><a name="line-42"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscCompileCmmFile"><span class="hs-identifier hs-var">hscCompileCmmFile</span></a><span>
</span><a name="line-43"></a><span>
</span><a name="line-44"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscGenHardCode"><span class="hs-identifier hs-var">hscGenHardCode</span></a><span>
</span><a name="line-45"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscInteractive"><span class="hs-identifier hs-var">hscInteractive</span></a><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span>    </span><span class="hs-comment">-- * Running passes separately</span><span>
</span><a name="line-48"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscParse"><span class="hs-identifier hs-var">hscParse</span></a><span>
</span><a name="line-49"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscTypecheckRename"><span class="hs-identifier hs-var">hscTypecheckRename</span></a><span>
</span><a name="line-50"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscDesugar"><span class="hs-identifier hs-var">hscDesugar</span></a><span>
</span><a name="line-51"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#makeSimpleDetails"><span class="hs-identifier hs-var">makeSimpleDetails</span></a><span>
</span><a name="line-52"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscSimplify"><span class="hs-identifier hs-var">hscSimplify</span></a><span> </span><span class="hs-comment">-- ToDo, shouldn't really export this</span><span>
</span><a name="line-53"></a><span>
</span><a name="line-54"></a><span>    </span><span class="hs-comment">-- * Safe Haskell</span><span>
</span><a name="line-55"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscCheckSafe"><span class="hs-identifier hs-var">hscCheckSafe</span></a><span>
</span><a name="line-56"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscGetSafe"><span class="hs-identifier hs-var">hscGetSafe</span></a><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span>    </span><span class="hs-comment">-- * Support for interactive evaluation</span><span>
</span><a name="line-59"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscParseIdentifier"><span class="hs-identifier hs-var">hscParseIdentifier</span></a><span>
</span><a name="line-60"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscTcRcLookupName"><span class="hs-identifier hs-var">hscTcRcLookupName</span></a><span>
</span><a name="line-61"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscTcRnGetInfo"><span class="hs-identifier hs-var">hscTcRnGetInfo</span></a><span>
</span><a name="line-62"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscIsGHCiMonad"><span class="hs-identifier hs-var">hscIsGHCiMonad</span></a><span>
</span><a name="line-63"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscGetModuleInterface"><span class="hs-identifier hs-var">hscGetModuleInterface</span></a><span>
</span><a name="line-64"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscRnImportDecls"><span class="hs-identifier hs-var">hscRnImportDecls</span></a><span>
</span><a name="line-65"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscTcRnLookupRdrName"><span class="hs-identifier hs-var">hscTcRnLookupRdrName</span></a><span>
</span><a name="line-66"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscStmt"><span class="hs-identifier hs-var">hscStmt</span></a><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscParseStmtWithLocation"><span class="hs-identifier hs-var">hscParseStmtWithLocation</span></a><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscStmtWithLocation"><span class="hs-identifier hs-var">hscStmtWithLocation</span></a><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscParsedStmt"><span class="hs-identifier hs-var">hscParsedStmt</span></a><span>
</span><a name="line-67"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscDecls"><span class="hs-identifier hs-var">hscDecls</span></a><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscParseDeclsWithLocation"><span class="hs-identifier hs-var">hscParseDeclsWithLocation</span></a><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscDeclsWithLocation"><span class="hs-identifier hs-var">hscDeclsWithLocation</span></a><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscParsedDecls"><span class="hs-identifier hs-var">hscParsedDecls</span></a><span>
</span><a name="line-68"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscTcExpr"><span class="hs-identifier hs-var">hscTcExpr</span></a><span class="hs-special">,</span><span> </span><a href="TcRnDriver.html#TcRnExprMode"><span class="hs-identifier hs-type">TcRnExprMode</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscImport"><span class="hs-identifier hs-var">hscImport</span></a><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscKcType"><span class="hs-identifier hs-var">hscKcType</span></a><span>
</span><a name="line-69"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscParseExpr"><span class="hs-identifier hs-var">hscParseExpr</span></a><span>
</span><a name="line-70"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscCompileCoreExpr"><span class="hs-identifier hs-var">hscCompileCoreExpr</span></a><span>
</span><a name="line-71"></a><span>    </span><span class="hs-comment">-- * Low-level exports for hooks</span><span>
</span><a name="line-72"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscCompileCoreExpr%27"><span class="hs-identifier hs-var">hscCompileCoreExpr'</span></a><span>
</span><a name="line-73"></a><span>      </span><span class="hs-comment">-- We want to make sure that we export enough to be able to redefine</span><span>
</span><a name="line-74"></a><span>      </span><span class="hs-comment">-- hscFileFrontEnd in client code</span><span>
</span><a name="line-75"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscParse%27"><span class="hs-identifier hs-var">hscParse'</span></a><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscSimplify%27"><span class="hs-identifier hs-var">hscSimplify'</span></a><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscDesugar%27"><span class="hs-identifier hs-var">hscDesugar'</span></a><span class="hs-special">,</span><span> </span><a href="HscMain.html#tcRnModule%27"><span class="hs-identifier hs-var">tcRnModule'</span></a><span>
</span><a name="line-76"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#getHscEnv"><span class="hs-identifier hs-var">getHscEnv</span></a><span>
</span><a name="line-77"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscSimpleIface%27"><span class="hs-identifier hs-var">hscSimpleIface'</span></a><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscNormalIface%27"><span class="hs-identifier hs-var">hscNormalIface'</span></a><span>
</span><a name="line-78"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#oneShotMsg"><span class="hs-identifier hs-var">oneShotMsg</span></a><span>
</span><a name="line-79"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscFileFrontEnd"><span class="hs-identifier hs-var">hscFileFrontEnd</span></a><span class="hs-special">,</span><span> </span><a href="HscMain.html#genericHscFrontend"><span class="hs-identifier hs-var">genericHscFrontend</span></a><span class="hs-special">,</span><span> </span><a href="HscMain.html#dumpIfaceStats"><span class="hs-identifier hs-var">dumpIfaceStats</span></a><span>
</span><a name="line-80"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#ioMsgMaybe"><span class="hs-identifier hs-var">ioMsgMaybe</span></a><span>
</span><a name="line-81"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#showModuleIndex"><span class="hs-identifier hs-var">showModuleIndex</span></a><span>
</span><a name="line-82"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="HscMain.html#hscAddSptEntries"><span class="hs-identifier hs-var">hscAddSptEntries</span></a><span>
</span><a name="line-83"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-84"></a><span>
</span><a name="line-85"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Data</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Fixity</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span class="hs-special">)</span><span>
</span><a name="line-88"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">fromJust</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-89"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-90"></a><span class="hs-keyword">import</span><span> </span><a href="GHCi.html"><span class="hs-identifier">GHCi</span></a><span>             </span><span class="hs-special">(</span><span> </span><a href="GHCi.html#addSptEntry"><span class="hs-identifier hs-var">addSptEntry</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-91"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHCi.RemoteTypes</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-92"></a><span class="hs-keyword">import</span><span> </span><a href="ByteCodeGen.html"><span class="hs-identifier">ByteCodeGen</span></a><span>      </span><span class="hs-special">(</span><span> </span><a href="ByteCodeGen.html#byteCodeGen"><span class="hs-identifier hs-var">byteCodeGen</span></a><span class="hs-special">,</span><span> </span><a href="ByteCodeGen.html#coreExprToBCOs"><span class="hs-identifier hs-var">coreExprToBCOs</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-93"></a><span class="hs-keyword">import</span><span> </span><a href="Linker.html"><span class="hs-identifier">Linker</span></a><span>
</span><a name="line-94"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreTidy</span><span>         </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">tidyExpr</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-95"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>             </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-96"></a><span class="hs-keyword">import</span><span> </span><span class="hs-comment">{- Kind parts of -}</span><span> </span><span class="hs-identifier">Type</span><span>         </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Kind</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-97"></a><span class="hs-keyword">import</span><span> </span><a href="CoreLint.html"><span class="hs-identifier">CoreLint</span></a><span>         </span><span class="hs-special">(</span><span> </span><a href="CoreLint.html#lintInteractiveExpr"><span class="hs-identifier hs-var">lintInteractiveExpr</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-98"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarEnv</span><span>           </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">emptyTidyEnv</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-99"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Panic</span><span>
</span><a name="line-100"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ConLike</span><span>
</span><a name="line-101"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Concurrent</span><span>
</span><a name="line-102"></a><span>
</span><a name="line-103"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-104"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Packages</span><span>
</span><a name="line-105"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RdrName</span><span>
</span><a name="line-106"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span>
</span><a name="line-107"></a><span class="hs-keyword">import</span><span> </span><a href="HsDumpAst.html"><span class="hs-identifier">HsDumpAst</span></a><span>
</span><a name="line-108"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreSyn</span><span>
</span><a name="line-109"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">StringBuffer</span><span>
</span><a name="line-110"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Parser</span><span>
</span><a name="line-111"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Lexer</span><span>
</span><a name="line-112"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-113"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnDriver.html"><span class="hs-identifier">TcRnDriver</span></a><span>
</span><a name="line-114"></a><span class="hs-keyword">import</span><span> </span><a href="TcIface.html"><span class="hs-identifier">TcIface</span></a><span>          </span><span class="hs-special">(</span><span> </span><a href="TcIface.html#typecheckIface"><span class="hs-identifier hs-var">typecheckIface</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-115"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-116"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameCache</span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">initNameCache</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-117"></a><span class="hs-keyword">import</span><span> </span><a href="LoadIface.html"><span class="hs-identifier">LoadIface</span></a><span>        </span><span class="hs-special">(</span><span> </span><a href="LoadIface.html#ifaceStats"><span class="hs-identifier hs-var">ifaceStats</span></a><span class="hs-special">,</span><span> </span><a href="LoadIface.html#initExternalPackageState"><span class="hs-identifier hs-var">initExternalPackageState</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-118"></a><span class="hs-keyword">import</span><span> </span><a href="PrelInfo.html"><span class="hs-identifier">PrelInfo</span></a><span>
</span><a name="line-119"></a><span class="hs-keyword">import</span><span> </span><a href="MkIface.html"><span class="hs-identifier">MkIface</span></a><span>
</span><a name="line-120"></a><span class="hs-keyword">import</span><span> </span><a href="Desugar.html"><span class="hs-identifier">Desugar</span></a><span>
</span><a name="line-121"></a><span class="hs-keyword">import</span><span> </span><a href="SimplCore.html"><span class="hs-identifier">SimplCore</span></a><span>
</span><a name="line-122"></a><span class="hs-keyword">import</span><span> </span><a href="TidyPgm.html"><span class="hs-identifier">TidyPgm</span></a><span>
</span><a name="line-123"></a><span class="hs-keyword">import</span><span> </span><a href="CorePrep.html"><span class="hs-identifier">CorePrep</span></a><span>
</span><a name="line-124"></a><span class="hs-keyword">import</span><span> </span><a href="CoreToStg.html"><span class="hs-identifier">CoreToStg</span></a><span>        </span><span class="hs-special">(</span><span> </span><a href="CoreToStg.html#coreToStg"><span class="hs-identifier hs-var">coreToStg</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-125"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="StgCmm.html"><span class="hs-identifier">StgCmm</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="StgCmm.html#codeGen"><span class="hs-identifier hs-var">codeGen</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-126"></a><span class="hs-keyword">import</span><span> </span><a href="StgSyn.html"><span class="hs-identifier">StgSyn</span></a><span>
</span><a name="line-127"></a><span class="hs-keyword">import</span><span> </span><a href="StgFVs.html"><span class="hs-identifier">StgFVs</span></a><span>           </span><span class="hs-special">(</span><span> </span><a href="StgFVs.html#annTopBindingsFreeVars"><span class="hs-identifier hs-var">annTopBindingsFreeVars</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-128"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CostCentre</span><span>
</span><a name="line-129"></a><span class="hs-keyword">import</span><span> </span><a href="ProfInit.html"><span class="hs-identifier">ProfInit</span></a><span>
</span><a name="line-130"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-131"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-132"></a><span class="hs-keyword">import</span><span> </span><a href="SimplStg.html"><span class="hs-identifier">SimplStg</span></a><span>         </span><span class="hs-special">(</span><span> </span><a href="SimplStg.html#stg2stg"><span class="hs-identifier hs-var">stg2stg</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-133"></a><span class="hs-keyword">import</span><span> </span><a href="Cmm.html"><span class="hs-identifier">Cmm</span></a><span>
</span><a name="line-134"></a><span class="hs-keyword">import</span><span> </span><a href="CmmParse.html"><span class="hs-identifier">CmmParse</span></a><span>         </span><span class="hs-special">(</span><span> </span><a href="CmmParse.html#parseCmmFile"><span class="hs-identifier hs-var">parseCmmFile</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-135"></a><span class="hs-keyword">import</span><span> </span><a href="CmmBuildInfoTables.html"><span class="hs-identifier">CmmBuildInfoTables</span></a><span>
</span><a name="line-136"></a><span class="hs-keyword">import</span><span> </span><a href="CmmPipeline.html"><span class="hs-identifier">CmmPipeline</span></a><span>
</span><a name="line-137"></a><span class="hs-keyword">import</span><span> </span><a href="CmmInfo.html"><span class="hs-identifier">CmmInfo</span></a><span>
</span><a name="line-138"></a><span class="hs-keyword">import</span><span> </span><a href="CodeOutput.html"><span class="hs-identifier">CodeOutput</span></a><span>
</span><a name="line-139"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">InstEnv</span><span>
</span><a name="line-140"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FamInstEnv</span><span>
</span><a name="line-141"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Fingerprint</span><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Fingerprint</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-142"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Hooks</span><span>
</span><a name="line-143"></a><span class="hs-keyword">import</span><span> </span><a href="TcEnv.html"><span class="hs-identifier">TcEnv</span></a><span>
</span><a name="line-144"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span>
</span><a name="line-145"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Plugins</span><span>
</span><a name="line-146"></a><span class="hs-keyword">import</span><span> </span><a href="DynamicLoading.html"><span class="hs-identifier">DynamicLoading</span></a><span>   </span><span class="hs-special">(</span><span> </span><a href="DynamicLoading.html#initializePlugins"><span class="hs-identifier hs-var">initializePlugins</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-147"></a><span>
</span><a name="line-148"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-149"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span>
</span><a name="line-150"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Platform</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">platformOS</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">osSubsectionsViaSymbols</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-151"></a><span>
</span><a name="line-152"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-153"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameEnv</span><span>
</span><a name="line-154"></a><span class="hs-keyword">import</span><span> </span><a href="HscStats.html"><span class="hs-identifier">HscStats</span></a><span>         </span><span class="hs-special">(</span><span> </span><a href="HscStats.html#ppSourceStats"><span class="hs-identifier hs-var">ppSourceStats</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-155"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>
</span><a name="line-156"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-157"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSupply</span><span>
</span><a name="line-158"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Bag</span><span>
</span><a name="line-159"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Exception</span><span>
</span><a name="line-160"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Stream.html"><span class="hs-identifier">Stream</span></a><span>
</span><a name="line-161"></a><span class="hs-keyword">import</span><span> </span><a href="Stream.html"><span class="hs-identifier">Stream</span></a><span> </span><span class="hs-special">(</span><a href="Stream.html#Stream"><span class="hs-identifier hs-type">Stream</span></a><span class="hs-special">)</span><span>
</span><a name="line-162"></a><span>
</span><a name="line-163"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-164"></a><span>
</span><a name="line-165"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-166"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-167"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.IORef</span><span>
</span><a name="line-168"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.FilePath</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">FilePath</span><span>
</span><a name="line-169"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Directory</span><span>
</span><a name="line-170"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fixIO</span><span class="hs-special">)</span><span>
</span><a name="line-171"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">M</span><span>
</span><a name="line-172"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">S</span><span>
</span><a name="line-173"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span class="hs-special">)</span><span>
</span><a name="line-174"></a><span>
</span><a name="line-175"></a><span class="hs-keyword">import</span><span> </span><a href="HieAst.html"><span class="hs-identifier">HieAst</span></a><span>           </span><span class="hs-special">(</span><span> </span><a href="HieAst.html#mkHieFile"><span class="hs-identifier hs-var">mkHieFile</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-176"></a><span class="hs-keyword">import</span><span> </span><a href="HieTypes.html"><span class="hs-identifier">HieTypes</span></a><span>         </span><span class="hs-special">(</span><span> </span><a href="HieTypes.html#getAsts"><span class="hs-identifier hs-var">getAsts</span></a><span class="hs-special">,</span><span> </span><a href="HieTypes.html#hie_asts"><span class="hs-identifier hs-var">hie_asts</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-177"></a><span class="hs-keyword">import</span><span> </span><a href="HieBin.html"><span class="hs-identifier">HieBin</span></a><span>           </span><span class="hs-special">(</span><span> </span><a href="HieBin.html#readHieFile"><span class="hs-identifier hs-var">readHieFile</span></a><span class="hs-special">,</span><span> </span><a href="HieBin.html#writeHieFile"><span class="hs-identifier hs-var">writeHieFile</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-178"></a><span class="hs-keyword">import</span><span> </span><a href="HieDebug.html"><span class="hs-identifier">HieDebug</span></a><span>         </span><span class="hs-special">(</span><span> </span><a href="HieDebug.html#diffFile"><span class="hs-identifier hs-var">diffFile</span></a><span class="hs-special">,</span><span> </span><a href="HieDebug.html#validateScopes"><span class="hs-identifier hs-var">validateScopes</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-182"></a><span>
</span><a name="line-183"></a><span class="hs-comment">{- **********************************************************************
%*                                                                      *
                Initialisation
%*                                                                      *
%********************************************************************* -}</span><span>
</span><a name="line-188"></a><span>
</span><a name="line-189"></a><span class="hs-identifier">newHscEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-190"></a><a name="newHscEnv"><a href="HscMain.html#newHscEnv"><span class="hs-identifier">newHscEnv</span></a></a><span> </span><a name="local-6989586621684993808"><a href="#local-6989586621684993808"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-191"></a><span>    </span><a name="local-6989586621684993809"><a href="#local-6989586621684993809"><span class="hs-identifier">eps_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><a href="LoadIface.html#initExternalPackageState"><span class="hs-identifier hs-var">initExternalPackageState</span></a><span>
</span><a name="line-192"></a><span>    </span><a name="local-6989586621684993810"><a href="#local-6989586621684993810"><span class="hs-identifier">us</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mkSplitUniqSupply</span><span> </span><span class="hs-char">'r'</span><span>
</span><a name="line-193"></a><span>    </span><a name="local-6989586621684993811"><a href="#local-6989586621684993811"><span class="hs-identifier">nc_var</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">initNameCache</span><span> </span><a href="#local-6989586621684993810"><span class="hs-identifier hs-var">us</span></a><span> </span><a href="PrelInfo.html#knownKeyNames"><span class="hs-identifier hs-var">knownKeyNames</span></a><span class="hs-special">)</span><span>
</span><a name="line-194"></a><span>    </span><a name="local-6989586621684993812"><a href="#local-6989586621684993812"><span class="hs-identifier">fc_var</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">emptyInstalledModuleEnv</span><span>
</span><a name="line-195"></a><span>    </span><a name="local-6989586621684993813"><a href="#local-6989586621684993813"><span class="hs-identifier">iserv_mvar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newMVar</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-196"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">HscEnv</span><span> </span><span class="hs-special">{</span><span>  </span><span class="hs-identifier">hsc_dflags</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684993808"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-197"></a><span>                  </span><span class="hs-special">,</span><span>  </span><span class="hs-identifier">hsc_targets</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-198"></a><span>                  </span><span class="hs-special">,</span><span>  </span><span class="hs-identifier">hsc_mod_graph</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyMG</span><span>
</span><a name="line-199"></a><span>                  </span><span class="hs-special">,</span><span>  </span><span class="hs-identifier">hsc_IC</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyInteractiveContext</span><span> </span><a href="#local-6989586621684993808"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-200"></a><span>                  </span><span class="hs-special">,</span><span>  </span><span class="hs-identifier">hsc_HPT</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyHomePackageTable</span><span>
</span><a name="line-201"></a><span>                  </span><span class="hs-special">,</span><span>  </span><span class="hs-identifier">hsc_EPS</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684993809"><span class="hs-identifier hs-var">eps_var</span></a><span>
</span><a name="line-202"></a><span>                  </span><span class="hs-special">,</span><span>  </span><span class="hs-identifier">hsc_NC</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684993811"><span class="hs-identifier hs-var">nc_var</span></a><span>
</span><a name="line-203"></a><span>                  </span><span class="hs-special">,</span><span>  </span><span class="hs-identifier">hsc_FC</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684993812"><span class="hs-identifier hs-var">fc_var</span></a><span>
</span><a name="line-204"></a><span>                  </span><span class="hs-special">,</span><span>  </span><span class="hs-identifier">hsc_type_env_var</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-205"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsc_iserv</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684993813"><span class="hs-identifier hs-var">iserv_mvar</span></a><span>
</span><a name="line-206"></a><span>                  </span><span class="hs-special">}</span><span>
</span><a name="line-207"></a><span>
</span><a name="line-208"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-209"></a><span>
</span><a name="line-210"></a><span class="hs-identifier">getWarnings</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-identifier hs-type">WarningMessages</span><span>
</span><a name="line-211"></a><a name="getWarnings"><a href="HscMain.html#getWarnings"><span class="hs-identifier">getWarnings</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Hsc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684993814"><a href="#local-6989586621684993814"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684993814"><span class="hs-identifier hs-var">w</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684993814"><span class="hs-identifier hs-var">w</span></a><span class="hs-special">)</span><span>
</span><a name="line-212"></a><span>
</span><a name="line-213"></a><span class="hs-identifier">clearWarnings</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-214"></a><a name="clearWarnings"><a href="HscMain.html#clearWarnings"><span class="hs-identifier">clearWarnings</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Hsc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyBag</span><span class="hs-special">)</span><span>
</span><a name="line-215"></a><span>
</span><a name="line-216"></a><span class="hs-identifier">logWarnings</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WarningMessages</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-217"></a><a name="logWarnings"><a href="HscMain.html#logWarnings"><span class="hs-identifier">logWarnings</span></a></a><span> </span><a name="local-6989586621684993815"><a href="#local-6989586621684993815"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Hsc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684993816"><a href="#local-6989586621684993816"><span class="hs-identifier">w0</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684993816"><span class="hs-identifier hs-var">w0</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionBags</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684993815"><span class="hs-identifier hs-var">w</span></a><span class="hs-special">)</span><span>
</span><a name="line-218"></a><span>
</span><a name="line-219"></a><span class="hs-identifier">getHscEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-220"></a><a name="getHscEnv"><a href="HscMain.html#getHscEnv"><span class="hs-identifier">getHscEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Hsc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621684993817"><a href="#local-6989586621684993817"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621684993818"><a href="#local-6989586621684993818"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684993817"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684993818"><span class="hs-identifier hs-var">w</span></a><span class="hs-special">)</span><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span class="hs-identifier">handleWarnings</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-223"></a><a name="handleWarnings"><a href="HscMain.html#handleWarnings"><span class="hs-identifier">handleWarnings</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-224"></a><span>    </span><a name="local-6989586621684993819"><a href="#local-6989586621684993819"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-225"></a><span>    </span><a name="local-6989586621684993820"><a href="#local-6989586621684993820"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#getWarnings"><span class="hs-identifier hs-var">getWarnings</span></a><span>
</span><a name="line-226"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">printOrThrowWarnings</span><span> </span><a href="#local-6989586621684993819"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684993820"><span class="hs-identifier hs-var">w</span></a><span>
</span><a name="line-227"></a><span>    </span><a href="HscMain.html#clearWarnings"><span class="hs-identifier hs-var">clearWarnings</span></a><span>
</span><a name="line-228"></a><span>
</span><a name="line-229"></a><span class="hs-comment">-- | log warning in the monad, and if there are errors then</span><span>
</span><a name="line-230"></a><span class="hs-comment">-- throw a SourceError exception.</span><span>
</span><a name="line-231"></a><span class="hs-identifier">logWarningsReportErrors</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Messages</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-232"></a><a name="logWarningsReportErrors"><a href="HscMain.html#logWarningsReportErrors"><span class="hs-identifier">logWarningsReportErrors</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684993821"><a href="#local-6989586621684993821"><span class="hs-identifier">warns</span></a></a><span class="hs-special">,</span><a name="local-6989586621684993822"><a href="#local-6989586621684993822"><span class="hs-identifier">errs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-233"></a><span>    </span><a href="HscMain.html#logWarnings"><span class="hs-identifier hs-var">logWarnings</span></a><span> </span><a href="#local-6989586621684993821"><span class="hs-identifier hs-var">warns</span></a><span>
</span><a name="line-234"></a><span>    </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">isEmptyBag</span><span> </span><a href="#local-6989586621684993822"><span class="hs-identifier hs-var">errs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#throwErrors"><span class="hs-identifier hs-var">throwErrors</span></a><span> </span><a href="#local-6989586621684993822"><span class="hs-identifier hs-var">errs</span></a><span>
</span><a name="line-235"></a><span>
</span><a name="line-236"></a><span class="hs-comment">-- | Throw some errors.</span><span>
</span><a name="line-237"></a><span class="hs-identifier">throwErrors</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ErrorMessages</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><a href="#local-6989586621684993807"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-238"></a><a name="throwErrors"><a href="HscMain.html#throwErrors"><span class="hs-identifier">throwErrors</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">mkSrcErr</span><span>
</span><a name="line-239"></a><span>
</span><a name="line-240"></a><span class="hs-comment">-- | Deal with errors and warnings returned by a compilation step</span><span>
</span><a name="line-241"></a><span class="hs-comment">--</span><span>
</span><a name="line-242"></a><span class="hs-comment">-- In order to reduce dependencies to other parts of the compiler, functions</span><span>
</span><a name="line-243"></a><span class="hs-comment">-- outside the &quot;main&quot; parts of GHC return warnings and errors as a parameter</span><span>
</span><a name="line-244"></a><span class="hs-comment">-- and signal success via by wrapping the result in a 'Maybe' type. This</span><span>
</span><a name="line-245"></a><span class="hs-comment">-- function logs the returned warnings and propagates errors as exceptions</span><span>
</span><a name="line-246"></a><span class="hs-comment">-- (of type 'SourceError').</span><span>
</span><a name="line-247"></a><span class="hs-comment">--</span><span>
</span><a name="line-248"></a><span class="hs-comment">-- This function assumes the following invariants:</span><span>
</span><a name="line-249"></a><span class="hs-comment">--</span><span>
</span><a name="line-250"></a><span class="hs-comment">--  1. If the second result indicates success (is of the form 'Just x'),</span><span>
</span><a name="line-251"></a><span class="hs-comment">--     there must be no error messages in the first result.</span><span>
</span><a name="line-252"></a><span class="hs-comment">--</span><span>
</span><a name="line-253"></a><span class="hs-comment">--  2. If there are no error messages, but the second result indicates failure</span><span>
</span><a name="line-254"></a><span class="hs-comment">--     there should be warnings in the first result. That is, if the action</span><span>
</span><a name="line-255"></a><span class="hs-comment">--     failed, it must have been due to the warnings (i.e., @-Werror@).</span><span>
</span><a name="line-256"></a><span class="hs-identifier">ioMsgMaybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Messages</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621684993806"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><a href="#local-6989586621684993806"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-257"></a><a name="ioMsgMaybe"><a href="HscMain.html#ioMsgMaybe"><span class="hs-identifier">ioMsgMaybe</span></a></a><span> </span><a name="local-6989586621684993823"><a href="#local-6989586621684993823"><span class="hs-identifier">ioA</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-258"></a><span>    </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621684993824"><a href="#local-6989586621684993824"><span class="hs-identifier">warns</span></a></a><span class="hs-special">,</span><a name="local-6989586621684993825"><a href="#local-6989586621684993825"><span class="hs-identifier">errs</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684993826"><a href="#local-6989586621684993826"><span class="hs-identifier">mb_r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><a href="#local-6989586621684993823"><span class="hs-identifier hs-var">ioA</span></a><span>
</span><a name="line-259"></a><span>    </span><a href="HscMain.html#logWarnings"><span class="hs-identifier hs-var">logWarnings</span></a><span> </span><a href="#local-6989586621684993824"><span class="hs-identifier hs-var">warns</span></a><span>
</span><a name="line-260"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684993826"><span class="hs-identifier hs-var">mb_r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-261"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HscMain.html#throwErrors"><span class="hs-identifier hs-var">throwErrors</span></a><span> </span><a href="#local-6989586621684993825"><span class="hs-identifier hs-var">errs</span></a><span>
</span><a name="line-262"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684993827"><a href="#local-6989586621684993827"><span class="hs-identifier">r</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isEmptyBag</span><span> </span><span class="hs-identifier">errs</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684993825"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-263"></a><span>
</span><a name="line-264"></a><span class="hs-comment">-- | like ioMsgMaybe, except that we ignore error messages and return</span><span>
</span><a name="line-265"></a><span class="hs-comment">-- 'Nothing' instead.</span><span>
</span><a name="line-266"></a><span class="hs-identifier">ioMsgMaybe'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Messages</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621684993805"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621684993805"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-267"></a><a name="ioMsgMaybe%27"><a href="HscMain.html#ioMsgMaybe%27"><span class="hs-identifier">ioMsgMaybe'</span></a></a><span> </span><a name="local-6989586621684993828"><a href="#local-6989586621684993828"><span class="hs-identifier">ioA</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-268"></a><span>    </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621684993829"><a href="#local-6989586621684993829"><span class="hs-identifier">warns</span></a></a><span class="hs-special">,</span><a name="local-6989586621684993830"><a href="#local-6989586621684993830"><span class="hs-identifier">_errs</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684993831"><a href="#local-6989586621684993831"><span class="hs-identifier">mb_r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684993828"><span class="hs-identifier hs-var">ioA</span></a><span>
</span><a name="line-269"></a><span>    </span><a href="HscMain.html#logWarnings"><span class="hs-identifier hs-var">logWarnings</span></a><span> </span><a href="#local-6989586621684993829"><span class="hs-identifier hs-var">warns</span></a><span>
</span><a name="line-270"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684993831"><span class="hs-identifier hs-var">mb_r</span></a><span>
</span><a name="line-271"></a><span>
</span><a name="line-272"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-273"></a><span class="hs-comment">-- | Lookup things in the compiler's environment</span><span>
</span><a name="line-274"></a><span>
</span><a name="line-275"></a><span class="hs-identifier">hscTcRnLookupRdrName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-276"></a><a name="hscTcRnLookupRdrName"><a href="HscMain.html#hscTcRnLookupRdrName"><span class="hs-identifier">hscTcRnLookupRdrName</span></a></a><span> </span><a name="local-6989586621684993832"><a href="#local-6989586621684993832"><span class="hs-identifier">hsc_env0</span></a></a><span> </span><a name="local-6989586621684993833"><a href="#local-6989586621684993833"><span class="hs-identifier">rdr_name</span></a></a><span>
</span><a name="line-277"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runInteractiveHsc</span><span> </span><a href="#local-6989586621684993832"><span class="hs-identifier hs-var">hsc_env0</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-278"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684993834"><a href="#local-6989586621684993834"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#getHscEnv"><span class="hs-identifier hs-var">getHscEnv</span></a><span>
</span><a name="line-279"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="HscMain.html#ioMsgMaybe"><span class="hs-identifier hs-var">ioMsgMaybe</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnDriver.html#tcRnLookupRdrName"><span class="hs-identifier hs-var">tcRnLookupRdrName</span></a><span> </span><a href="#local-6989586621684993834"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684993833"><span class="hs-identifier hs-var">rdr_name</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-280"></a><span>
</span><a name="line-281"></a><span class="hs-identifier">hscTcRcLookupName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TyThing</span><span class="hs-special">)</span><span>
</span><a name="line-282"></a><a name="hscTcRcLookupName"><a href="HscMain.html#hscTcRcLookupName"><span class="hs-identifier">hscTcRcLookupName</span></a></a><span> </span><a name="local-6989586621684993835"><a href="#local-6989586621684993835"><span class="hs-identifier">hsc_env0</span></a></a><span> </span><a name="local-6989586621684993836"><a href="#local-6989586621684993836"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runInteractiveHsc</span><span> </span><a href="#local-6989586621684993835"><span class="hs-identifier hs-var">hsc_env0</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-283"></a><span>  </span><a name="local-6989586621684993837"><a href="#local-6989586621684993837"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#getHscEnv"><span class="hs-identifier hs-var">getHscEnv</span></a><span>
</span><a name="line-284"></a><span>  </span><a href="HscMain.html#ioMsgMaybe%27"><span class="hs-identifier hs-var">ioMsgMaybe'</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnDriver.html#tcRnLookupName"><span class="hs-identifier hs-var">tcRnLookupName</span></a><span> </span><a href="#local-6989586621684993837"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684993836"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-285"></a><span>      </span><span class="hs-comment">-- ignore errors: the only error we're likely to get is</span><span>
</span><a name="line-286"></a><span>      </span><span class="hs-comment">-- &quot;name not found&quot;, and the Maybe in the return type</span><span>
</span><a name="line-287"></a><span>      </span><span class="hs-comment">-- is used to indicate that.</span><span>
</span><a name="line-288"></a><span>
</span><a name="line-289"></a><span class="hs-identifier">hscTcRnGetInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-290"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TyThing</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Fixity</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ClsInst</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FamInst</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-291"></a><a name="hscTcRnGetInfo"><a href="HscMain.html#hscTcRnGetInfo"><span class="hs-identifier">hscTcRnGetInfo</span></a></a><span> </span><a name="local-6989586621684993838"><a href="#local-6989586621684993838"><span class="hs-identifier">hsc_env0</span></a></a><span> </span><a name="local-6989586621684993839"><a href="#local-6989586621684993839"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-292"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runInteractiveHsc</span><span> </span><a href="#local-6989586621684993838"><span class="hs-identifier hs-var">hsc_env0</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-293"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684993840"><a href="#local-6989586621684993840"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#getHscEnv"><span class="hs-identifier hs-var">getHscEnv</span></a><span>
</span><a name="line-294"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="HscMain.html#ioMsgMaybe%27"><span class="hs-identifier hs-var">ioMsgMaybe'</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnDriver.html#tcRnGetInfo"><span class="hs-identifier hs-var">tcRnGetInfo</span></a><span> </span><a href="#local-6989586621684993840"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684993839"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-295"></a><span>
</span><a name="line-296"></a><span class="hs-identifier">hscIsGHCiMonad</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-297"></a><a name="hscIsGHCiMonad"><a href="HscMain.html#hscIsGHCiMonad"><span class="hs-identifier">hscIsGHCiMonad</span></a></a><span> </span><a name="local-6989586621684993841"><a href="#local-6989586621684993841"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684993842"><a href="#local-6989586621684993842"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-298"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runHsc</span><span> </span><a href="#local-6989586621684993841"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#ioMsgMaybe"><span class="hs-identifier hs-var">ioMsgMaybe</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnDriver.html#isGHCiMonad"><span class="hs-identifier hs-var">isGHCiMonad</span></a><span> </span><a href="#local-6989586621684993841"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684993842"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-299"></a><span>
</span><a name="line-300"></a><span class="hs-identifier">hscGetModuleInterface</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span>
</span><a name="line-301"></a><a name="hscGetModuleInterface"><a href="HscMain.html#hscGetModuleInterface"><span class="hs-identifier">hscGetModuleInterface</span></a></a><span> </span><a name="local-6989586621684993843"><a href="#local-6989586621684993843"><span class="hs-identifier">hsc_env0</span></a></a><span> </span><a name="local-6989586621684993844"><a href="#local-6989586621684993844"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runInteractiveHsc</span><span> </span><a href="#local-6989586621684993843"><span class="hs-identifier hs-var">hsc_env0</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-302"></a><span>  </span><a name="local-6989586621684993845"><a href="#local-6989586621684993845"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#getHscEnv"><span class="hs-identifier hs-var">getHscEnv</span></a><span>
</span><a name="line-303"></a><span>  </span><a href="HscMain.html#ioMsgMaybe"><span class="hs-identifier hs-var">ioMsgMaybe</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnDriver.html#getModuleInterface"><span class="hs-identifier hs-var">getModuleInterface</span></a><span> </span><a href="#local-6989586621684993845"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684993844"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-304"></a><span>
</span><a name="line-305"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-306"></a><span class="hs-comment">-- | Rename some import declarations</span><span>
</span><a name="line-307"></a><span class="hs-identifier">hscRnImportDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LImportDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">GlobalRdrEnv</span><span>
</span><a name="line-308"></a><a name="hscRnImportDecls"><a href="HscMain.html#hscRnImportDecls"><span class="hs-identifier">hscRnImportDecls</span></a></a><span> </span><a name="local-6989586621684993846"><a href="#local-6989586621684993846"><span class="hs-identifier">hsc_env0</span></a></a><span> </span><a name="local-6989586621684993847"><a href="#local-6989586621684993847"><span class="hs-identifier">import_decls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runInteractiveHsc</span><span> </span><a href="#local-6989586621684993846"><span class="hs-identifier hs-var">hsc_env0</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-309"></a><span>  </span><a name="local-6989586621684993848"><a href="#local-6989586621684993848"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#getHscEnv"><span class="hs-identifier hs-var">getHscEnv</span></a><span>
</span><a name="line-310"></a><span>  </span><a href="HscMain.html#ioMsgMaybe"><span class="hs-identifier hs-var">ioMsgMaybe</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnDriver.html#tcRnImportDecls"><span class="hs-identifier hs-var">tcRnImportDecls</span></a><span> </span><a href="#local-6989586621684993848"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684993847"><span class="hs-identifier hs-var">import_decls</span></a><span>
</span><a name="line-311"></a><span>
</span><a name="line-312"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-313"></a><span class="hs-comment">-- | parse a file, returning the abstract syntax</span><span>
</span><a name="line-314"></a><span>
</span><a name="line-315"></a><span class="hs-identifier">hscParse</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">HsParsedModule</span><span>
</span><a name="line-316"></a><a name="hscParse"><a href="HscMain.html#hscParse"><span class="hs-identifier">hscParse</span></a></a><span> </span><a name="local-6989586621684993849"><a href="#local-6989586621684993849"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684993850"><a href="#local-6989586621684993850"><span class="hs-identifier">mod_summary</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runHsc</span><span> </span><a href="#local-6989586621684993849"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#hscParse%27"><span class="hs-identifier hs-var">hscParse'</span></a><span> </span><a href="#local-6989586621684993850"><span class="hs-identifier hs-var">mod_summary</span></a><span>
</span><a name="line-317"></a><span>
</span><a name="line-318"></a><span class="hs-comment">-- internal version, that doesn't fail due to -Werror</span><span>
</span><a name="line-319"></a><span class="hs-identifier">hscParse'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-identifier hs-type">HsParsedModule</span><span>
</span><a name="line-320"></a><a name="hscParse%27"><a href="HscMain.html#hscParse%27"><span class="hs-identifier">hscParse'</span></a></a><span> </span><a name="local-6989586621684993851"><a href="#local-6989586621684993851"><span class="hs-identifier">mod_summary</span></a></a><span>
</span><a name="line-321"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684993852"><a href="#local-6989586621684993852"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">ms_parsed_mod</span><span> </span><a href="#local-6989586621684993851"><span class="hs-identifier hs-var">mod_summary</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684993852"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-322"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;Parser&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-323"></a><span>    </span><span class="hs-identifier hs-var">withTiming</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-324"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Parser&quot;</span><span class="hs-operator hs-var">&lt;+&gt;</span><span class="hs-identifier hs-var">brackets</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">ms_mod</span><span> </span><a href="#local-6989586621684993851"><span class="hs-identifier hs-var">mod_summary</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-325"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-326"></a><span>    </span><a name="local-6989586621684993853"><a href="#local-6989586621684993853"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-327"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684993854"><a href="#local-6989586621684993854"><span class="hs-identifier">src_filename</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_hspp_file</span><span> </span><a href="#local-6989586621684993851"><span class="hs-identifier hs-var">mod_summary</span></a><span>
</span><a name="line-328"></a><span>        </span><a name="local-6989586621684993855"><a href="#local-6989586621684993855"><span class="hs-identifier">maybe_src_buf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_hspp_buf</span><span>  </span><a href="#local-6989586621684993851"><span class="hs-identifier hs-var">mod_summary</span></a><span>
</span><a name="line-329"></a><span>
</span><a name="line-330"></a><span>    </span><span class="hs-comment">--------------------------  Parser  ----------------</span><span>
</span><a name="line-331"></a><span>    </span><span class="hs-comment">-- sometimes we already have the buffer in memory, perhaps</span><span>
</span><a name="line-332"></a><span>    </span><span class="hs-comment">-- because we needed to parse the imports out of it, or get the</span><span>
</span><a name="line-333"></a><span>    </span><span class="hs-comment">-- module name.</span><span>
</span><a name="line-334"></a><span>    </span><a name="local-6989586621684993857"><a href="#local-6989586621684993857"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684993855"><span class="hs-identifier hs-var">maybe_src_buf</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-335"></a><span>               </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684993856"><a href="#local-6989586621684993856"><span class="hs-identifier">b</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684993856"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-336"></a><span>               </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">hGetStringBuffer</span><span> </span><a href="#local-6989586621684993854"><span class="hs-identifier hs-var">src_filename</span></a><span>
</span><a name="line-337"></a><span>
</span><a name="line-338"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684993858"><a href="#local-6989586621684993858"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkRealSrcLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkFastString</span><span> </span><a href="#local-6989586621684993854"><span class="hs-identifier hs-var">src_filename</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-339"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684993859"><a href="#local-6989586621684993859"><span class="hs-identifier">parseMod</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">HsigFile</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">ms_hsc_src</span><span> </span><a href="#local-6989586621684993851"><span class="hs-identifier hs-var">mod_summary</span></a><span>
</span><a name="line-340"></a><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">parseSignature</span><span>
</span><a name="line-341"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">parseModule</span><span>
</span><a name="line-342"></a><span>
</span><a name="line-343"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">unP</span><span> </span><a href="#local-6989586621684993859"><span class="hs-identifier hs-var">parseMod</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkPState</span><span> </span><a href="#local-6989586621684993853"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684993857"><span class="hs-identifier hs-var">buf</span></a><span> </span><a href="#local-6989586621684993858"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-344"></a><span>        </span><span class="hs-identifier hs-var">PFailed</span><span> </span><a name="local-6989586621684993860"><a href="#local-6989586621684993860"><span class="hs-identifier">warnFn</span></a></a><span> </span><a name="local-6989586621684993861"><a href="#local-6989586621684993861"><span class="hs-identifier">span</span></a></a><span> </span><a name="local-6989586621684993862"><a href="#local-6989586621684993862"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-345"></a><span>            </span><a href="HscMain.html#logWarningsReportErrors"><span class="hs-identifier hs-var">logWarningsReportErrors</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684993860"><span class="hs-identifier hs-var">warnFn</span></a><span> </span><a href="#local-6989586621684993853"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-346"></a><span>            </span><a href="HscMain.html#handleWarnings"><span class="hs-identifier hs-var">handleWarnings</span></a><span>
</span><a name="line-347"></a><span>            </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">throwOneError</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkPlainErrMsg</span><span> </span><a href="#local-6989586621684993853"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684993861"><span class="hs-identifier hs-var">span</span></a><span> </span><a href="#local-6989586621684993862"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-348"></a><span>
</span><a name="line-349"></a><span>        </span><span class="hs-identifier hs-var">POk</span><span> </span><a name="local-6989586621684993863"><a href="#local-6989586621684993863"><span class="hs-identifier">pst</span></a></a><span> </span><a name="local-6989586621684993864"><a href="#local-6989586621684993864"><span class="hs-identifier">rdr_module</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-350"></a><span>            </span><a href="HscMain.html#logWarningsReportErrors"><span class="hs-identifier hs-var">logWarningsReportErrors</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getMessages</span><span> </span><a href="#local-6989586621684993863"><span class="hs-identifier hs-var">pst</span></a><span> </span><a href="#local-6989586621684993853"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-351"></a><span>            </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621684993853"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_parsed</span><span> </span><span class="hs-string">&quot;Parser&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-352"></a><span>                                   </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684993864"><span class="hs-identifier hs-var">rdr_module</span></a><span>
</span><a name="line-353"></a><span>            </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621684993853"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_parsed_ast</span><span> </span><span class="hs-string">&quot;Parser AST&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-354"></a><span>                                   </span><a href="HsDumpAst.html#showAstData"><span class="hs-identifier hs-var">showAstData</span></a><span> </span><a href="HsDumpAst.html#NoBlankSrcSpan"><span class="hs-identifier hs-var">NoBlankSrcSpan</span></a><span> </span><a href="#local-6989586621684993864"><span class="hs-identifier hs-var">rdr_module</span></a><span>
</span><a name="line-355"></a><span>            </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621684993853"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_source_stats</span><span> </span><span class="hs-string">&quot;Source Statistics&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-356"></a><span>                                   </span><a href="HscStats.html#ppSourceStats"><span class="hs-identifier hs-var">ppSourceStats</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621684993864"><span class="hs-identifier hs-var">rdr_module</span></a><span>
</span><a name="line-357"></a><span>
</span><a name="line-358"></a><span>            </span><span class="hs-comment">-- To get the list of extra source files, we take the list</span><span>
</span><a name="line-359"></a><span>            </span><span class="hs-comment">-- that the parser gave us,</span><span>
</span><a name="line-360"></a><span>            </span><span class="hs-comment">--   - eliminate files beginning with '&lt;'.  gcc likes to use</span><span>
</span><a name="line-361"></a><span>            </span><span class="hs-comment">--     pseudo-filenames like &quot;&lt;built-in&gt;&quot; and &quot;&lt;command-line&gt;&quot;</span><span>
</span><a name="line-362"></a><span>            </span><span class="hs-comment">--   - normalise them (eliminate differences between ./f and f)</span><span>
</span><a name="line-363"></a><span>            </span><span class="hs-comment">--   - filter out the preprocessed source file</span><span>
</span><a name="line-364"></a><span>            </span><span class="hs-comment">--   - filter out anything beginning with tmpdir</span><span>
</span><a name="line-365"></a><span>            </span><span class="hs-comment">--   - remove duplicates</span><span>
</span><a name="line-366"></a><span>            </span><span class="hs-comment">--   - filter out the .hs/.lhs source filename if we have one</span><span>
</span><a name="line-367"></a><span>            </span><span class="hs-comment">--</span><span>
</span><a name="line-368"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684993865"><a href="#local-6989586621684993865"><span class="hs-identifier">n_hspp</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">FilePath.normalise</span><span> </span><a href="#local-6989586621684993854"><span class="hs-identifier hs-var">src_filename</span></a><span>
</span><a name="line-369"></a><span>                </span><a name="local-6989586621684993866"><a href="#local-6989586621684993866"><span class="hs-identifier">srcs0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nub</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tmpDir</span><span> </span><a href="#local-6989586621684993853"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">isPrefixOf</span><span class="hs-special">`</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-370"></a><span>                            </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684993865"><span class="hs-identifier hs-var">n_hspp</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-371"></a><span>                            </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">FilePath.normalise</span><span>
</span><a name="line-372"></a><span>                            </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">isPrefixOf</span><span> </span><span class="hs-string">&quot;&lt;&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-373"></a><span>                            </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">unpackFS</span><span>
</span><a name="line-374"></a><span>                            </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">srcfiles</span><span> </span><a href="#local-6989586621684993863"><span class="hs-identifier hs-var">pst</span></a><span>
</span><a name="line-375"></a><span>                </span><a name="local-6989586621684993867"><a href="#local-6989586621684993867"><span class="hs-identifier">srcs1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">ml_hs_file</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ms_location</span><span> </span><a href="#local-6989586621684993851"><span class="hs-identifier hs-var">mod_summary</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-376"></a><span>                          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684993868"><a href="#local-6989586621684993868"><span class="hs-identifier">f</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">FilePath.normalise</span><span> </span><a href="#local-6989586621684993868"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684993866"><span class="hs-identifier hs-var">srcs0</span></a><span>
</span><a name="line-377"></a><span>                          </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684993866"><span class="hs-identifier hs-var">srcs0</span></a><span>
</span><a name="line-378"></a><span>
</span><a name="line-379"></a><span>            </span><span class="hs-comment">-- sometimes we see source files from earlier</span><span>
</span><a name="line-380"></a><span>            </span><span class="hs-comment">-- preprocessing stages that cannot be found, so just</span><span>
</span><a name="line-381"></a><span>            </span><span class="hs-comment">-- filter them out:</span><span>
</span><a name="line-382"></a><span>            </span><a name="local-6989586621684993869"><a href="#local-6989586621684993869"><span class="hs-identifier">srcs2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">filterM</span><span> </span><span class="hs-identifier hs-var">doesFileExist</span><span> </span><a href="#local-6989586621684993867"><span class="hs-identifier hs-var">srcs1</span></a><span>
</span><a name="line-383"></a><span>
</span><a name="line-384"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684993870"><a href="#local-6989586621684993870"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HsParsedModule</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-385"></a><span>                      </span><span class="hs-identifier">hpm_module</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684993864"><span class="hs-identifier hs-var">rdr_module</span></a><span class="hs-special">,</span><span>
</span><a name="line-386"></a><span>                      </span><span class="hs-identifier">hpm_src_files</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684993869"><span class="hs-identifier hs-var">srcs2</span></a><span class="hs-special">,</span><span>
</span><a name="line-387"></a><span>                      </span><span class="hs-identifier">hpm_annotations</span><span>
</span><a name="line-388"></a><span>                              </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">M.fromListWith</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">annotations</span><span> </span><a href="#local-6989586621684993863"><span class="hs-identifier hs-var">pst</span></a><span class="hs-special">,</span><span>
</span><a name="line-389"></a><span>                                 </span><span class="hs-identifier hs-var">M.fromList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">noSrcSpan</span><span class="hs-special">,</span><span class="hs-identifier">comment_q</span><span> </span><a href="#local-6989586621684993863"><span class="hs-identifier hs-var">pst</span></a><span class="hs-special">)</span><span>
</span><a name="line-390"></a><span>                                                 </span><span class="hs-glyph">:</span><span class="hs-special">(</span><span class="hs-identifier">annotations_comments</span><span> </span><a href="#local-6989586621684993863"><span class="hs-identifier hs-var">pst</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-391"></a><span>                   </span><span class="hs-special">}</span><span>
</span><a name="line-392"></a><span>
</span><a name="line-393"></a><span>            </span><span class="hs-comment">-- apply parse transformation of plugins</span><span>
</span><a name="line-394"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684993871"><a href="#local-6989586621684993871"><span class="hs-identifier">applyPluginAction</span></a></a><span> </span><a name="local-6989586621684993872"><a href="#local-6989586621684993872"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621684993873"><a href="#local-6989586621684993873"><span class="hs-identifier">opts</span></a></a><span>
</span><a name="line-395"></a><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">parsedResultAction</span><span> </span><a href="#local-6989586621684993872"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621684993873"><span class="hs-identifier hs-var">opts</span></a><span> </span><a href="#local-6989586621684993851"><span class="hs-identifier hs-var">mod_summary</span></a><span>
</span><a name="line-396"></a><span>            </span><span class="hs-identifier hs-var">withPlugins</span><span> </span><a href="#local-6989586621684993853"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684993871"><span class="hs-identifier hs-var">applyPluginAction</span></a><span> </span><a href="#local-6989586621684993870"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-397"></a><span>
</span><a name="line-398"></a><span>
</span><a name="line-399"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-400"></a><span class="hs-comment">-- | If the renamed source has been kept, extract it. Dump it if requested.</span><span>
</span><a name="line-401"></a><span class="hs-identifier">extract_renamed_stuff</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><a href="TcRnDriver.html#RenamedStuff"><span class="hs-identifier hs-type">RenamedStuff</span></a><span>
</span><a name="line-402"></a><a name="extract_renamed_stuff"><a href="HscMain.html#extract_renamed_stuff"><span class="hs-identifier">extract_renamed_stuff</span></a></a><span> </span><a name="local-6989586621684993874"><a href="#local-6989586621684993874"><span class="hs-identifier">mod_summary</span></a></a><span> </span><a name="local-6989586621684993875"><a href="#local-6989586621684993875"><span class="hs-identifier">tc_result</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-403"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684993876"><a href="#local-6989586621684993876"><span class="hs-identifier">rn_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnDriver.html#getRenamedStuff"><span class="hs-identifier hs-var">getRenamedStuff</span></a><span> </span><a href="#local-6989586621684993875"><span class="hs-identifier hs-var">tc_result</span></a><span>
</span><a name="line-404"></a><span>
</span><a name="line-405"></a><span>    </span><a name="local-6989586621684993877"><a href="#local-6989586621684993877"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-406"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621684993877"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_rn_ast</span><span> </span><span class="hs-string">&quot;Renamer&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-407"></a><span>                           </span><a href="HsDumpAst.html#showAstData"><span class="hs-identifier hs-var">showAstData</span></a><span> </span><a href="HsDumpAst.html#NoBlankSrcSpan"><span class="hs-identifier hs-var">NoBlankSrcSpan</span></a><span> </span><a href="#local-6989586621684993876"><span class="hs-identifier hs-var">rn_info</span></a><span>
</span><a name="line-408"></a><span>
</span><a name="line-409"></a><span>    </span><span class="hs-comment">-- Create HIE files</span><span>
</span><a name="line-410"></a><span>    </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_WriteHie</span><span> </span><a href="#local-6989586621684993877"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-411"></a><span>        </span><span class="hs-comment">-- I assume this fromJust is safe because `-fwrite-hie-file`</span><span>
</span><a name="line-412"></a><span>        </span><span class="hs-comment">-- enables the option which keeps the renamed source.</span><span>
</span><a name="line-413"></a><span>        </span><a name="local-6989586621684993878"><a href="#local-6989586621684993878"><span class="hs-identifier">hieFile</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HieAst.html#mkHieFile"><span class="hs-identifier hs-var">mkHieFile</span></a><span> </span><a href="#local-6989586621684993874"><span class="hs-identifier hs-var">mod_summary</span></a><span> </span><a href="#local-6989586621684993875"><span class="hs-identifier hs-var">tc_result</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromJust</span><span> </span><a href="#local-6989586621684993876"><span class="hs-identifier hs-var">rn_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-414"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684993879"><a href="#local-6989586621684993879"><span class="hs-identifier">out_file</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ml_hie_file</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">ms_location</span><span> </span><a href="#local-6989586621684993874"><span class="hs-identifier hs-var">mod_summary</span></a><span>
</span><a name="line-415"></a><span>        </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HieBin.html#writeHieFile"><span class="hs-identifier hs-var">writeHieFile</span></a><span> </span><a href="#local-6989586621684993879"><span class="hs-identifier hs-var">out_file</span></a><span> </span><a href="#local-6989586621684993878"><span class="hs-identifier hs-var">hieFile</span></a><span>
</span><a name="line-416"></a><span>
</span><a name="line-417"></a><span>        </span><span class="hs-comment">-- Validate HIE files</span><span>
</span><a name="line-418"></a><span>        </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_ValidateHie</span><span> </span><a href="#local-6989586621684993877"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-419"></a><span>            </span><a name="local-6989586621684993882"><a href="#local-6989586621684993882"><span class="hs-identifier">hs_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Hsc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621684993880"><a href="#local-6989586621684993880"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621684993881"><a href="#local-6989586621684993881"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684993880"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684993881"><span class="hs-identifier hs-var">w</span></a><span class="hs-special">)</span><span>
</span><a name="line-420"></a><span>            </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-421"></a><span>              </span><span class="hs-comment">-- Validate Scopes</span><span>
</span><a name="line-422"></a><span>              </span><span class="hs-keyword">case</span><span> </span><a href="HieDebug.html#validateScopes"><span class="hs-identifier hs-var">validateScopes</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">getAsts</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">hie_asts</span><span> </span><a href="#local-6989586621684993878"><span class="hs-identifier hs-var">hieFile</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-423"></a><span>                  </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">putMsg</span><span> </span><a href="#local-6989586621684993877"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Got valid scopes&quot;</span><span>
</span><a name="line-424"></a><span>                  </span><a name="local-6989586621684993883"><a href="#local-6989586621684993883"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-425"></a><span>                    </span><span class="hs-identifier hs-var">putMsg</span><span> </span><a href="#local-6989586621684993877"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Got invalid scopes&quot;</span><span>
</span><a name="line-426"></a><span>                    </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">putMsg</span><span> </span><a href="#local-6989586621684993877"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684993883"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-427"></a><span>              </span><span class="hs-comment">-- Roundtrip testing</span><span>
</span><a name="line-428"></a><span>              </span><a name="local-6989586621684993884"><a href="#local-6989586621684993884"><span class="hs-identifier">nc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">hsc_NC</span><span> </span><a href="#local-6989586621684993882"><span class="hs-identifier hs-var">hs_env</span></a><span>
</span><a name="line-429"></a><span>              </span><span class="hs-special">(</span><a name="local-6989586621684993885"><a href="#local-6989586621684993885"><span class="hs-identifier">file'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HieBin.html#readHieFile"><span class="hs-identifier hs-var">readHieFile</span></a><span> </span><a href="#local-6989586621684993884"><span class="hs-identifier hs-var">nc</span></a><span> </span><a href="#local-6989586621684993879"><span class="hs-identifier hs-var">out_file</span></a><span>
</span><a name="line-430"></a><span>              </span><span class="hs-keyword">case</span><span> </span><a href="HieDebug.html#diffFile"><span class="hs-identifier hs-var">diffFile</span></a><span> </span><a href="#local-6989586621684993878"><span class="hs-identifier hs-var">hieFile</span></a><span> </span><a href="#local-6989586621684993885"><span class="hs-identifier hs-var">file'</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-431"></a><span>                </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-432"></a><span>                  </span><span class="hs-identifier hs-var">putMsg</span><span> </span><a href="#local-6989586621684993877"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Got no roundtrip errors&quot;</span><span>
</span><a name="line-433"></a><span>                </span><a name="local-6989586621684993886"><a href="#local-6989586621684993886"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-434"></a><span>                  </span><span class="hs-identifier hs-var">putMsg</span><span> </span><a href="#local-6989586621684993877"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Got roundtrip errors&quot;</span><span>
</span><a name="line-435"></a><span>                  </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">putMsg</span><span> </span><a href="#local-6989586621684993877"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684993886"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-436"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684993876"><span class="hs-identifier hs-var">rn_info</span></a><span>
</span><a name="line-437"></a><span>
</span><a name="line-438"></a><span>
</span><a name="line-439"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-440"></a><span class="hs-comment">-- | Rename and typecheck a module, additionally returning the renamed syntax</span><span>
</span><a name="line-441"></a><span class="hs-identifier">hscTypecheckRename</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsParsedModule</span><span>
</span><a name="line-442"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcGblEnv</span><span class="hs-special">,</span><span> </span><a href="TcRnDriver.html#RenamedStuff"><span class="hs-identifier hs-type">RenamedStuff</span></a><span class="hs-special">)</span><span>
</span><a name="line-443"></a><a name="hscTypecheckRename"><a href="HscMain.html#hscTypecheckRename"><span class="hs-identifier">hscTypecheckRename</span></a></a><span> </span><a name="local-6989586621684993887"><a href="#local-6989586621684993887"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684993888"><a href="#local-6989586621684993888"><span class="hs-identifier">mod_summary</span></a></a><span> </span><a name="local-6989586621684993889"><a href="#local-6989586621684993889"><span class="hs-identifier">rdr_module</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runHsc</span><span> </span><a href="#local-6989586621684993887"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-444"></a><span>    </span><a name="local-6989586621684993890"><a href="#local-6989586621684993890"><span class="hs-identifier">tc_result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#hsc_typecheck"><span class="hs-identifier hs-var">hsc_typecheck</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621684993888"><span class="hs-identifier hs-var">mod_summary</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621684993889"><span class="hs-identifier hs-var">rdr_module</span></a><span class="hs-special">)</span><span>
</span><a name="line-445"></a><span>    </span><a name="local-6989586621684993891"><a href="#local-6989586621684993891"><span class="hs-identifier">rn_info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#extract_renamed_stuff"><span class="hs-identifier hs-var">extract_renamed_stuff</span></a><span> </span><a href="#local-6989586621684993888"><span class="hs-identifier hs-var">mod_summary</span></a><span> </span><a href="#local-6989586621684993890"><span class="hs-identifier hs-var">tc_result</span></a><span>
</span><a name="line-446"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684993890"><span class="hs-identifier hs-var">tc_result</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684993891"><span class="hs-identifier hs-var">rn_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-447"></a><span>
</span><a name="line-448"></a><span class="hs-comment">-- | Rename and typecheck a module, but don't return the renamed syntax</span><span>
</span><a name="line-449"></a><span class="hs-identifier">hscTypecheck</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-comment">-- ^ Keep renamed source?</span><span>
</span><a name="line-450"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">HsParsedModule</span><span>
</span><a name="line-451"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-452"></a><a name="hscTypecheck"><a href="HscMain.html#hscTypecheck"><span class="hs-identifier">hscTypecheck</span></a></a><span> </span><a name="local-6989586621684993892"><a href="#local-6989586621684993892"><span class="hs-identifier">keep_rn</span></a></a><span> </span><a name="local-6989586621684993893"><a href="#local-6989586621684993893"><span class="hs-identifier">mod_summary</span></a></a><span> </span><a name="local-6989586621684993894"><a href="#local-6989586621684993894"><span class="hs-identifier">mb_rdr_module</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-453"></a><span>    </span><a name="local-6989586621684993895"><a href="#local-6989586621684993895"><span class="hs-identifier">tc_result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#hsc_typecheck"><span class="hs-identifier hs-var">hsc_typecheck</span></a><span> </span><a href="#local-6989586621684993892"><span class="hs-identifier hs-var">keep_rn</span></a><span> </span><a href="#local-6989586621684993893"><span class="hs-identifier hs-var">mod_summary</span></a><span> </span><a href="#local-6989586621684993894"><span class="hs-identifier hs-var">mb_rdr_module</span></a><span>
</span><a name="line-454"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#extract_renamed_stuff"><span class="hs-identifier hs-var">extract_renamed_stuff</span></a><span> </span><a href="#local-6989586621684993893"><span class="hs-identifier hs-var">mod_summary</span></a><span> </span><a href="#local-6989586621684993895"><span class="hs-identifier hs-var">tc_result</span></a><span>
</span><a name="line-455"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684993895"><span class="hs-identifier hs-var">tc_result</span></a><span>
</span><a name="line-456"></a><span>
</span><a name="line-457"></a><span class="hs-identifier">hsc_typecheck</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-comment">-- ^ Keep renamed source?</span><span>
</span><a name="line-458"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">HsParsedModule</span><span>
</span><a name="line-459"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-460"></a><a name="hsc_typecheck"><a href="HscMain.html#hsc_typecheck"><span class="hs-identifier">hsc_typecheck</span></a></a><span> </span><a name="local-6989586621684993896"><a href="#local-6989586621684993896"><span class="hs-identifier">keep_rn</span></a></a><span> </span><a name="local-6989586621684993897"><a href="#local-6989586621684993897"><span class="hs-identifier">mod_summary</span></a></a><span> </span><a name="local-6989586621684993898"><a href="#local-6989586621684993898"><span class="hs-identifier">mb_rdr_module</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-461"></a><span>    </span><a name="local-6989586621684993899"><a href="#local-6989586621684993899"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#getHscEnv"><span class="hs-identifier hs-var">getHscEnv</span></a><span>
</span><a name="line-462"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684993900"><a href="#local-6989586621684993900"><span class="hs-identifier">hsc_src</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_hsc_src</span><span> </span><a href="#local-6989586621684993897"><span class="hs-identifier hs-var">mod_summary</span></a><span>
</span><a name="line-463"></a><span>        </span><a name="local-6989586621684993901"><a href="#local-6989586621684993901"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621684993899"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-464"></a><span>        </span><a name="local-6989586621684993902"><a href="#local-6989586621684993902"><span class="hs-identifier">outer_mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_mod</span><span> </span><a href="#local-6989586621684993897"><span class="hs-identifier hs-var">mod_summary</span></a><span>
</span><a name="line-465"></a><span>        </span><a name="local-6989586621684993903"><a href="#local-6989586621684993903"><span class="hs-identifier">mod_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621684993902"><span class="hs-identifier hs-var">outer_mod</span></a><span>
</span><a name="line-466"></a><span>        </span><a name="local-6989586621684993904"><a href="#local-6989586621684993904"><span class="hs-identifier">outer_mod'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkModule</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">thisPackage</span><span> </span><a href="#local-6989586621684993901"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684993903"><span class="hs-identifier hs-var">mod_name</span></a><span>
</span><a name="line-467"></a><span>        </span><a name="local-6989586621684993905"><a href="#local-6989586621684993905"><span class="hs-identifier">inner_mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">canonicalizeHomeModule</span><span> </span><a href="#local-6989586621684993901"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684993903"><span class="hs-identifier hs-var">mod_name</span></a><span>
</span><a name="line-468"></a><span>        </span><a name="local-6989586621684993906"><a href="#local-6989586621684993906"><span class="hs-identifier">src_filename</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_hspp_file</span><span> </span><a href="#local-6989586621684993897"><span class="hs-identifier hs-var">mod_summary</span></a><span>
</span><a name="line-469"></a><span>        </span><a name="local-6989586621684993907"><a href="#local-6989586621684993907"><span class="hs-identifier">real_loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">realSrcLocSpan</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkRealSrcLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkFastString</span><span> </span><a href="#local-6989586621684993906"><span class="hs-identifier hs-var">src_filename</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-470"></a><span>        </span><a name="local-6989586621684993908"><a href="#local-6989586621684993908"><span class="hs-identifier">keep_rn'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_WriteHie</span><span> </span><a href="#local-6989586621684993901"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621684993896"><span class="hs-identifier hs-var">keep_rn</span></a><span>
</span><a name="line-471"></a><span>    </span><span class="hs-identifier">MASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">moduleUnitId</span><span> </span><span class="hs-identifier">outer_mod</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">thisPackage</span><span> </span><span class="hs-identifier">dflags</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-472"></a><span>    </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621684993900"><span class="hs-identifier hs-var">hsc_src</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">HsigFile</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isHoleModule</span><span> </span><a href="#local-6989586621684993905"><span class="hs-identifier hs-var">inner_mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-473"></a><span>        </span><span class="hs-keyword">then</span><span> </span><a href="HscMain.html#ioMsgMaybe"><span class="hs-identifier hs-var">ioMsgMaybe</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcBackpack.html#tcRnInstantiateSignature"><span class="hs-identifier hs-var">tcRnInstantiateSignature</span></a><span> </span><a href="#local-6989586621684993899"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684993904"><span class="hs-identifier hs-var">outer_mod'</span></a><span> </span><a href="#local-6989586621684993907"><span class="hs-identifier hs-var">real_loc</span></a><span>
</span><a name="line-474"></a><span>        </span><span class="hs-keyword">else</span><span>
</span><a name="line-475"></a><span>         </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621684993910"><a href="#local-6989586621684993910"><span class="hs-identifier">hpm</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684993898"><span class="hs-identifier hs-var">mb_rdr_module</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-476"></a><span>                    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684993909"><a href="#local-6989586621684993909"><span class="hs-identifier">hpm</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684993909"><span class="hs-identifier hs-var">hpm</span></a><span>
</span><a name="line-477"></a><span>                    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HscMain.html#hscParse%27"><span class="hs-identifier hs-var">hscParse'</span></a><span> </span><a href="#local-6989586621684993897"><span class="hs-identifier hs-var">mod_summary</span></a><span>
</span><a name="line-478"></a><span>            </span><a name="local-6989586621684993911"><a href="#local-6989586621684993911"><span class="hs-identifier">tc_result0</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#tcRnModule%27"><span class="hs-identifier hs-var">tcRnModule'</span></a><span> </span><a href="#local-6989586621684993897"><span class="hs-identifier hs-var">mod_summary</span></a><span> </span><a href="#local-6989586621684993908"><span class="hs-identifier hs-var">keep_rn'</span></a><span> </span><a href="#local-6989586621684993910"><span class="hs-identifier hs-var">hpm</span></a><span>
</span><a name="line-479"></a><span>            </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621684993900"><span class="hs-identifier hs-var">hsc_src</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">HsigFile</span><span>
</span><a name="line-480"></a><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684993912"><a href="#local-6989586621684993912"><span class="hs-identifier">iface</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#hscSimpleIface"><span class="hs-identifier hs-var">hscSimpleIface</span></a><span> </span><a href="#local-6989586621684993899"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684993911"><span class="hs-identifier hs-var">tc_result0</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-481"></a><span>                        </span><a href="HscMain.html#ioMsgMaybe"><span class="hs-identifier hs-var">ioMsgMaybe</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-482"></a><span>                            </span><a href="TcBackpack.html#tcRnMergeSignatures"><span class="hs-identifier hs-var">tcRnMergeSignatures</span></a><span> </span><a href="#local-6989586621684993899"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684993910"><span class="hs-identifier hs-var">hpm</span></a><span> </span><a href="#local-6989586621684993911"><span class="hs-identifier hs-var">tc_result0</span></a><span> </span><a href="#local-6989586621684993912"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-483"></a><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684993911"><span class="hs-identifier hs-var">tc_result0</span></a><span>
</span><a name="line-484"></a><span>
</span><a name="line-485"></a><span class="hs-comment">-- wrapper around tcRnModule to handle safe haskell extras</span><span>
</span><a name="line-486"></a><span class="hs-identifier">tcRnModule'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsParsedModule</span><span>
</span><a name="line-487"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-488"></a><a name="tcRnModule%27"><a href="HscMain.html#tcRnModule%27"><span class="hs-identifier">tcRnModule'</span></a></a><span> </span><a name="local-6989586621684993913"><a href="#local-6989586621684993913"><span class="hs-identifier">sum</span></a></a><span> </span><a name="local-6989586621684993914"><a href="#local-6989586621684993914"><span class="hs-identifier">save_rn_syntax</span></a></a><span> </span><a name="local-6989586621684993915"><a href="#local-6989586621684993915"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-489"></a><span>    </span><a name="local-6989586621684993922"><a href="#local-6989586621684993922"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#getHscEnv"><span class="hs-identifier hs-var">getHscEnv</span></a><span>
</span><a name="line-490"></a><span>    </span><a name="local-6989586621684993923"><a href="#local-6989586621684993923"><span class="hs-identifier">dflags</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-491"></a><span>
</span><a name="line-492"></a><span>    </span><a name="local-6989586621684993924"><a href="#local-6989586621684993924"><span class="hs-identifier">tcg_res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;Typecheck-Rename&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-493"></a><span>               </span><a href="HscMain.html#ioMsgMaybe"><span class="hs-identifier hs-var">ioMsgMaybe</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-494"></a><span>                   </span><a href="TcRnDriver.html#tcRnModule"><span class="hs-identifier hs-var">tcRnModule</span></a><span> </span><a href="#local-6989586621684993922"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684993913"><span class="hs-identifier hs-var">sum</span></a><span>
</span><a name="line-495"></a><span>                     </span><a href="#local-6989586621684993914"><span class="hs-identifier hs-var">save_rn_syntax</span></a><span> </span><a href="#local-6989586621684993915"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-496"></a><span>
</span><a name="line-497"></a><span>    </span><span class="hs-comment">-- See Note [Safe Haskell Overlapping Instances Implementation]</span><span>
</span><a name="line-498"></a><span>    </span><span class="hs-comment">-- although this is used for more than just that failure case.</span><span>
</span><a name="line-499"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684993925"><a href="#local-6989586621684993925"><span class="hs-identifier">tcSafeOK</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684993926"><a href="#local-6989586621684993926"><span class="hs-identifier">whyUnsafe</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_safeInfer</span><span> </span><a href="#local-6989586621684993924"><span class="hs-identifier hs-var">tcg_res</span></a><span class="hs-special">)</span><span>
</span><a name="line-500"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684993927"><a href="#local-6989586621684993927"><span class="hs-identifier">allSafeOK</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">safeInferred</span><span> </span><a href="#local-6989586621684993923"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684993925"><span class="hs-identifier hs-var">tcSafeOK</span></a><span>
</span><a name="line-501"></a><span>
</span><a name="line-502"></a><span>    </span><span class="hs-comment">-- end of the safe haskell line, how to respond to user?</span><span>
</span><a name="line-503"></a><span>    </span><a name="local-6989586621684993930"><a href="#local-6989586621684993930"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">safeHaskellOn</span><span> </span><a href="#local-6989586621684993923"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-504"></a><span>                </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">safeInferOn</span><span> </span><a href="#local-6989586621684993923"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621684993927"><span class="hs-identifier hs-var">allSafeOK</span></a><span class="hs-special">)</span><span>
</span><a name="line-505"></a><span>             </span><span class="hs-comment">-- if safe Haskell off or safe infer failed, mark unsafe</span><span>
</span><a name="line-506"></a><span>             </span><span class="hs-keyword">then</span><span> </span><a href="HscMain.html#markUnsafeInfer"><span class="hs-identifier hs-var">markUnsafeInfer</span></a><span> </span><a href="#local-6989586621684993924"><span class="hs-identifier hs-var">tcg_res</span></a><span> </span><a href="#local-6989586621684993926"><span class="hs-identifier hs-var">whyUnsafe</span></a><span>
</span><a name="line-507"></a><span>
</span><a name="line-508"></a><span>             </span><span class="hs-comment">-- module (could be) safe, throw warning if needed</span><span>
</span><a name="line-509"></a><span>             </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-510"></a><span>                 </span><a name="local-6989586621684993928"><a href="#local-6989586621684993928"><span class="hs-identifier">tcg_res'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#hscCheckSafeImports"><span class="hs-identifier hs-var">hscCheckSafeImports</span></a><span> </span><a href="#local-6989586621684993924"><span class="hs-identifier hs-var">tcg_res</span></a><span>
</span><a name="line-511"></a><span>                 </span><span class="hs-keyword">safe</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_safeInfer</span><span> </span><a href="#local-6989586621684993928"><span class="hs-identifier hs-var">tcg_res'</span></a><span class="hs-special">)</span><span>
</span><a name="line-512"></a><span>                 </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-keyword">safe</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-513"></a><span>                   </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">wopt</span><span> </span><span class="hs-identifier hs-var">Opt_WarnSafe</span><span> </span><a href="#local-6989586621684993923"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-514"></a><span>                     </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="HscMain.html#logWarnings"><span class="hs-identifier hs-var">logWarnings</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unitBag</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-515"></a><span>                              </span><span class="hs-identifier hs-var">makeIntoWarning</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><span class="hs-identifier hs-var">Opt_WarnSafe</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-516"></a><span>                              </span><span class="hs-identifier hs-var">mkPlainWarnMsg</span><span> </span><a href="#local-6989586621684993923"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">warnSafeOnLoc</span><span> </span><a href="#local-6989586621684993923"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-517"></a><span>                              </span><a href="#local-6989586621684993917"><span class="hs-identifier hs-var">errSafe</span></a><span> </span><a href="#local-6989586621684993928"><span class="hs-identifier hs-var">tcg_res'</span></a><span class="hs-special">)</span><span>
</span><a name="line-518"></a><span>                     </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">safeHaskell</span><span> </span><a href="#local-6989586621684993923"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">Sf_Trustworthy</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-519"></a><span>                             </span><span class="hs-identifier hs-var">wopt</span><span> </span><span class="hs-identifier hs-var">Opt_WarnTrustworthySafe</span><span> </span><a href="#local-6989586621684993923"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-520"></a><span>                             </span><span class="hs-special">(</span><a href="HscMain.html#logWarnings"><span class="hs-identifier hs-var">logWarnings</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unitBag</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-521"></a><span>                              </span><span class="hs-identifier hs-var">makeIntoWarning</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><span class="hs-identifier hs-var">Opt_WarnTrustworthySafe</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-522"></a><span>                              </span><span class="hs-identifier hs-var">mkPlainWarnMsg</span><span> </span><a href="#local-6989586621684993923"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">trustworthyOnLoc</span><span> </span><a href="#local-6989586621684993923"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-523"></a><span>                              </span><a href="#local-6989586621684993918"><span class="hs-identifier hs-var">errTwthySafe</span></a><span> </span><a href="#local-6989586621684993928"><span class="hs-identifier hs-var">tcg_res'</span></a><span class="hs-special">)</span><span>
</span><a name="line-524"></a><span>                     </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-525"></a><span>                 </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684993928"><span class="hs-identifier hs-var">tcg_res'</span></a><span>
</span><a name="line-526"></a><span>
</span><a name="line-527"></a><span>    </span><span class="hs-comment">-- apply plugins to the type checking result</span><span>
</span><a name="line-528"></a><span>
</span><a name="line-529"></a><span>
</span><a name="line-530"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684993930"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-531"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-532"></a><span>    </span><a name="local-6989586621684993916"><a href="#local-6989586621684993916"><span class="hs-identifier">pprMod</span></a></a><span> </span><a name="local-6989586621684993919"><a href="#local-6989586621684993919"><span class="hs-identifier">t</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">moduleName</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">tcg_mod</span><span> </span><a href="#local-6989586621684993919"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-533"></a><span>    </span><a name="local-6989586621684993917"><a href="#local-6989586621684993917"><span class="hs-identifier">errSafe</span></a></a><span> </span><a name="local-6989586621684993920"><a href="#local-6989586621684993920"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684993916"><span class="hs-identifier hs-var">pprMod</span></a><span> </span><a href="#local-6989586621684993920"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;has been inferred as safe!&quot;</span><span>
</span><a name="line-534"></a><span>    </span><a name="local-6989586621684993918"><a href="#local-6989586621684993918"><span class="hs-identifier">errTwthySafe</span></a></a><span> </span><a name="local-6989586621684993921"><a href="#local-6989586621684993921"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684993916"><span class="hs-identifier hs-var">pprMod</span></a><span> </span><a href="#local-6989586621684993921"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-535"></a><span>      </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is marked as Trustworthy but has been inferred as safe!&quot;</span><span>
</span><a name="line-536"></a><span>
</span><a name="line-537"></a><span class="hs-comment">-- | Convert a typechecked module to Core</span><span>
</span><a name="line-538"></a><span class="hs-identifier">hscDesugar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span>
</span><a name="line-539"></a><a name="hscDesugar"><a href="HscMain.html#hscDesugar"><span class="hs-identifier">hscDesugar</span></a></a><span> </span><a name="local-6989586621684993931"><a href="#local-6989586621684993931"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684993932"><a href="#local-6989586621684993932"><span class="hs-identifier">mod_summary</span></a></a><span> </span><a name="local-6989586621684993933"><a href="#local-6989586621684993933"><span class="hs-identifier">tc_result</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-540"></a><span>    </span><span class="hs-identifier hs-var">runHsc</span><span> </span><a href="#local-6989586621684993931"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#hscDesugar%27"><span class="hs-identifier hs-var">hscDesugar'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ms_location</span><span> </span><a href="#local-6989586621684993932"><span class="hs-identifier hs-var">mod_summary</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684993933"><span class="hs-identifier hs-var">tc_result</span></a><span>
</span><a name="line-541"></a><span>
</span><a name="line-542"></a><span class="hs-identifier">hscDesugar'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModLocation</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span>
</span><a name="line-543"></a><a name="hscDesugar%27"><a href="HscMain.html#hscDesugar%27"><span class="hs-identifier">hscDesugar'</span></a></a><span> </span><a name="local-6989586621684993934"><a href="#local-6989586621684993934"><span class="hs-identifier">mod_location</span></a></a><span> </span><a name="local-6989586621684993935"><a href="#local-6989586621684993935"><span class="hs-identifier">tc_result</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-544"></a><span>    </span><a name="local-6989586621684993936"><a href="#local-6989586621684993936"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#getHscEnv"><span class="hs-identifier hs-var">getHscEnv</span></a><span>
</span><a name="line-545"></a><span>    </span><a name="local-6989586621684993937"><a href="#local-6989586621684993937"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#ioMsgMaybe"><span class="hs-identifier hs-var">ioMsgMaybe</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-546"></a><span>      </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;deSugar&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-547"></a><span>      </span><a href="Desugar.html#deSugar"><span class="hs-identifier hs-var">deSugar</span></a><span> </span><a href="#local-6989586621684993936"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684993934"><span class="hs-identifier hs-var">mod_location</span></a><span> </span><a href="#local-6989586621684993935"><span class="hs-identifier hs-var">tc_result</span></a><span>
</span><a name="line-548"></a><span>
</span><a name="line-549"></a><span>    </span><span class="hs-comment">-- always check -Werror after desugaring, this is the last opportunity for</span><span>
</span><a name="line-550"></a><span>    </span><span class="hs-comment">-- warnings to arise before the backend.</span><span>
</span><a name="line-551"></a><span>    </span><a href="HscMain.html#handleWarnings"><span class="hs-identifier hs-var">handleWarnings</span></a><span>
</span><a name="line-552"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684993937"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-553"></a><span>
</span><a name="line-554"></a><span class="hs-comment">-- | Make a 'ModDetails' from the results of typechecking. Used when</span><span>
</span><a name="line-555"></a><span class="hs-comment">-- typechecking only, as opposed to full compilation.</span><span>
</span><a name="line-556"></a><span class="hs-identifier">makeSimpleDetails</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">ModDetails</span><span>
</span><a name="line-557"></a><a name="makeSimpleDetails"><a href="HscMain.html#makeSimpleDetails"><span class="hs-identifier">makeSimpleDetails</span></a></a><span> </span><a name="local-6989586621684993938"><a href="#local-6989586621684993938"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684993939"><a href="#local-6989586621684993939"><span class="hs-identifier">tc_result</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TidyPgm.html#mkBootModDetailsTc"><span class="hs-identifier hs-var">mkBootModDetailsTc</span></a><span> </span><a href="#local-6989586621684993938"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684993939"><span class="hs-identifier hs-var">tc_result</span></a><span>
</span><a name="line-558"></a><span>
</span><a name="line-559"></a><span>
</span><a name="line-560"></a><span class="hs-comment">{- **********************************************************************
%*                                                                      *
                The main compiler pipeline
%*                                                                      *
%********************************************************************* -}</span><span>
</span><a name="line-565"></a><span>
</span><a name="line-566"></a><span class="hs-comment">{-
                   --------------------------------
                        The compilation proper
                   --------------------------------

It's the task of the compilation proper to compile Haskell, hs-boot and core
files to either byte-code, hard-code (C, asm, LLVM, etc.) or to nothing at all
(the module is still parsed and type-checked. This feature is mostly used by
IDE's and the likes). Compilation can happen in either 'one-shot', 'batch',
'nothing', or 'interactive' mode. 'One-shot' mode targets hard-code, 'batch'
mode targets hard-code, 'nothing' mode targets nothing and 'interactive' mode
targets byte-code.

The modes are kept separate because of their different types and meanings:

 * In 'one-shot' mode, we're only compiling a single file and can therefore
 discard the new ModIface and ModDetails. This is also the reason it only
 targets hard-code; compiling to byte-code or nothing doesn't make sense when
 we discard the result.

 * 'Batch' mode is like 'one-shot' except that we keep the resulting ModIface
 and ModDetails. 'Batch' mode doesn't target byte-code since that require us to
 return the newly compiled byte-code.

 * 'Nothing' mode has exactly the same type as 'batch' mode but they're still
 kept separate. This is because compiling to nothing is fairly special: We
 don't output any interface files, we don't run the simplifier and we don't
 generate any code.

 * 'Interactive' mode is similar to 'batch' mode except that we return the
 compiled byte-code together with the ModIface and ModDetails.

Trying to compile a hs-boot file to byte-code will result in a run-time error.
This is the only thing that isn't caught by the type-system.
-}</span><span>
</span><a name="line-601"></a><span>
</span><a name="line-602"></a><span>
</span><a name="line-603"></a><span class="hs-keyword">type</span><span> </span><a name="Messager"><a href="HscMain.html#Messager"><span class="hs-identifier">Messager</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-604"></a><span>
</span><a name="line-605"></a><span class="hs-comment">-- | This function runs GHC's frontend with recompilation</span><span>
</span><a name="line-606"></a><span class="hs-comment">-- avoidance. Specifically, it checks if recompilation is needed,</span><span>
</span><a name="line-607"></a><span class="hs-comment">-- and if it is, it parses and typechecks the input module.</span><span>
</span><a name="line-608"></a><span class="hs-comment">-- It does not write out the results of typechecking (See</span><span>
</span><a name="line-609"></a><span class="hs-comment">-- compileOne and hscIncrementalCompile).</span><span>
</span><a name="line-610"></a><span class="hs-identifier">hscIncrementalFrontend</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-comment">-- always do basic recompilation check?</span><span>
</span><a name="line-611"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-612"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="HscMain.html#Messager"><span class="hs-identifier hs-type">Messager</span></a><span>
</span><a name="line-613"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span>
</span><a name="line-614"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SourceModified</span><span>
</span><a name="line-615"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span>  </span><span class="hs-comment">-- Old interface, if available</span><span>
</span><a name="line-616"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>       </span><span class="hs-comment">-- (i,n) = module i of n (for msgs)</span><span>
</span><a name="line-617"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">FrontendResult</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Fingerprint</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-618"></a><span>
</span><a name="line-619"></a><a name="hscIncrementalFrontend"><a href="HscMain.html#hscIncrementalFrontend"><span class="hs-identifier">hscIncrementalFrontend</span></a></a><span>
</span><a name="line-620"></a><span>  </span><a name="local-6989586621684993940"><a href="#local-6989586621684993940"><span class="hs-identifier">always_do_basic_recompilation_check</span></a></a><span> </span><a name="local-6989586621684993941"><a href="#local-6989586621684993941"><span class="hs-identifier">m_tc_result</span></a></a><span>
</span><a name="line-621"></a><span>  </span><a name="local-6989586621684993942"><a href="#local-6989586621684993942"><span class="hs-identifier">mHscMessage</span></a></a><span> </span><a name="local-6989586621684993943"><a href="#local-6989586621684993943"><span class="hs-identifier">mod_summary</span></a></a><span> </span><a name="local-6989586621684993944"><a href="#local-6989586621684993944"><span class="hs-identifier">source_modified</span></a></a><span> </span><a name="local-6989586621684993945"><a href="#local-6989586621684993945"><span class="hs-identifier">mb_old_iface</span></a></a><span> </span><a name="local-6989586621684993946"><a href="#local-6989586621684993946"><span class="hs-identifier">mod_index</span></a></a><span>
</span><a name="line-622"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-623"></a><span>    </span><a name="local-6989586621684993947"><a href="#local-6989586621684993947"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#getHscEnv"><span class="hs-identifier hs-var">getHscEnv</span></a><span>
</span><a name="line-624"></a><span>
</span><a name="line-625"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684993948"><a href="#local-6989586621684993948"><span class="hs-identifier">msg</span></a></a><span> </span><a name="local-6989586621684993952"><a href="#local-6989586621684993952"><span class="hs-identifier">what</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684993942"><span class="hs-identifier hs-var">mHscMessage</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-626"></a><span>                   </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684993953"><a href="#local-6989586621684993953"><span class="hs-identifier">hscMessage</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684993953"><span class="hs-identifier hs-var">hscMessage</span></a><span> </span><a href="#local-6989586621684993947"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684993946"><span class="hs-identifier hs-var">mod_index</span></a><span> </span><a href="#local-6989586621684993952"><span class="hs-identifier hs-var">what</span></a><span> </span><a href="#local-6989586621684993943"><span class="hs-identifier hs-var">mod_summary</span></a><span>
</span><a name="line-627"></a><span>                   </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-628"></a><span>
</span><a name="line-629"></a><span>        </span><a name="local-6989586621684993949"><a href="#local-6989586621684993949"><span class="hs-identifier">skip</span></a></a><span> </span><a name="local-6989586621684993954"><a href="#local-6989586621684993954"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-630"></a><span>            </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684993948"><span class="hs-identifier hs-var">msg</span></a><span> </span><a href="MkIface.html#UpToDate"><span class="hs-identifier hs-var">UpToDate</span></a><span>
</span><a name="line-631"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621684993954"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-632"></a><span>
</span><a name="line-633"></a><span>        </span><a name="local-6989586621684993950"><a href="#local-6989586621684993950"><span class="hs-identifier">compile</span></a></a><span> </span><a name="local-6989586621684993955"><a href="#local-6989586621684993955"><span class="hs-identifier">mb_old_hash</span></a></a><span> </span><a name="local-6989586621684993956"><a href="#local-6989586621684993956"><span class="hs-identifier">reason</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-634"></a><span>            </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684993948"><span class="hs-identifier hs-var">msg</span></a><span> </span><a href="#local-6989586621684993956"><span class="hs-identifier hs-var">reason</span></a><span>
</span><a name="line-635"></a><span>            </span><a name="local-6989586621684993957"><a href="#local-6989586621684993957"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#genericHscFrontend"><span class="hs-identifier hs-var">genericHscFrontend</span></a><span> </span><a href="#local-6989586621684993943"><span class="hs-identifier hs-var">mod_summary</span></a><span>
</span><a name="line-636"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684993957"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684993955"><span class="hs-identifier hs-var">mb_old_hash</span></a><span class="hs-special">)</span><span>
</span><a name="line-637"></a><span>
</span><a name="line-638"></a><span>        </span><a name="local-6989586621684993951"><a href="#local-6989586621684993951"><span class="hs-identifier">stable</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684993944"><span class="hs-identifier hs-var">source_modified</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-639"></a><span>                     </span><span class="hs-identifier hs-var">SourceUnmodifiedAndStable</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-640"></a><span>                     </span><span class="hs-identifier">_</span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-641"></a><span>
</span><a name="line-642"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684993941"><span class="hs-identifier hs-var">m_tc_result</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-643"></a><span>         </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684993958"><a href="#local-6989586621684993958"><span class="hs-identifier">tc_result</span></a></a><span>
</span><a name="line-644"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621684993940"><span class="hs-identifier hs-var">always_do_basic_recompilation_check</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-645"></a><span>             </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FrontendTypecheck</span><span> </span><a href="#local-6989586621684993958"><span class="hs-identifier hs-var">tc_result</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-646"></a><span>         </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-647"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621684993959"><a href="#local-6989586621684993959"><span class="hs-identifier">recomp_reqd</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684993960"><a href="#local-6989586621684993960"><span class="hs-identifier">mb_checked_iface</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-648"></a><span>                </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;checkOldIface&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-649"></a><span>                   </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="MkIface.html#checkOldIface"><span class="hs-identifier hs-var">checkOldIface</span></a><span> </span><a href="#local-6989586621684993947"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684993943"><span class="hs-identifier hs-var">mod_summary</span></a><span>
</span><a name="line-650"></a><span>                                </span><a href="#local-6989586621684993944"><span class="hs-identifier hs-var">source_modified</span></a><span> </span><a href="#local-6989586621684993945"><span class="hs-identifier hs-var">mb_old_iface</span></a><span>
</span><a name="line-651"></a><span>            </span><span class="hs-comment">-- save the interface that comes back from checkOldIface.</span><span>
</span><a name="line-652"></a><span>            </span><span class="hs-comment">-- In one-shot mode we don't have the old iface until this</span><span>
</span><a name="line-653"></a><span>            </span><span class="hs-comment">-- point, when checkOldIface reads it from the disk.</span><span>
</span><a name="line-654"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684993961"><a href="#local-6989586621684993961"><span class="hs-identifier">mb_old_hash</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier">mi_iface_hash</span><span> </span><a href="#local-6989586621684993960"><span class="hs-identifier hs-var">mb_checked_iface</span></a><span>
</span><a name="line-655"></a><span>
</span><a name="line-656"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684993960"><span class="hs-identifier hs-var">mb_checked_iface</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-657"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684993962"><a href="#local-6989586621684993962"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#recompileRequired"><span class="hs-identifier hs-var">recompileRequired</span></a><span> </span><a href="#local-6989586621684993959"><span class="hs-identifier hs-var">recomp_reqd</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-658"></a><span>                    </span><span class="hs-comment">-- If the module used TH splices when it was last</span><span>
</span><a name="line-659"></a><span>                    </span><span class="hs-comment">-- compiled, then the recompilation check is not</span><span>
</span><a name="line-660"></a><span>                    </span><span class="hs-comment">-- accurate enough (#481) and we must ignore</span><span>
</span><a name="line-661"></a><span>                    </span><span class="hs-comment">-- it.  However, if the module is stable (none of</span><span>
</span><a name="line-662"></a><span>                    </span><span class="hs-comment">-- the modules it depends on, directly or</span><span>
</span><a name="line-663"></a><span>                    </span><span class="hs-comment">-- indirectly, changed), then we *can* skip</span><span>
</span><a name="line-664"></a><span>                    </span><span class="hs-comment">-- recompilation. This is why the SourceModified</span><span>
</span><a name="line-665"></a><span>                    </span><span class="hs-comment">-- type contains SourceUnmodifiedAndStable, and</span><span>
</span><a name="line-666"></a><span>                    </span><span class="hs-comment">-- it's pretty important: otherwise ghc --make</span><span>
</span><a name="line-667"></a><span>                    </span><span class="hs-comment">-- would always recompile TH modules, even if</span><span>
</span><a name="line-668"></a><span>                    </span><span class="hs-comment">-- nothing at all has changed. Stability is just</span><span>
</span><a name="line-669"></a><span>                    </span><span class="hs-comment">-- the same check that make is doing for us in</span><span>
</span><a name="line-670"></a><span>                    </span><span class="hs-comment">-- one-shot mode.</span><span>
</span><a name="line-671"></a><span>                    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684993941"><span class="hs-identifier hs-var">m_tc_result</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-672"></a><span>                    </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-673"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">mi_used_th</span><span> </span><a href="#local-6989586621684993962"><span class="hs-identifier hs-var">iface</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621684993951"><span class="hs-identifier hs-var">stable</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-674"></a><span>                        </span><a href="#local-6989586621684993950"><span class="hs-identifier hs-var">compile</span></a><span> </span><a href="#local-6989586621684993961"><span class="hs-identifier hs-var">mb_old_hash</span></a><span> </span><span class="hs-special">(</span><a href="MkIface.html#RecompBecause"><span class="hs-identifier hs-var">RecompBecause</span></a><span> </span><span class="hs-string">&quot;TH&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-675"></a><span>                    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-676"></a><span>                        </span><a href="#local-6989586621684993949"><span class="hs-identifier hs-var">skip</span></a><span> </span><a href="#local-6989586621684993962"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-677"></a><span>                </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-678"></a><span>                    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684993941"><span class="hs-identifier hs-var">m_tc_result</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-679"></a><span>                    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684993950"><span class="hs-identifier hs-var">compile</span></a><span> </span><a href="#local-6989586621684993961"><span class="hs-identifier hs-var">mb_old_hash</span></a><span> </span><a href="#local-6989586621684993959"><span class="hs-identifier hs-var">recomp_reqd</span></a><span>
</span><a name="line-680"></a><span>                    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684993963"><a href="#local-6989586621684993963"><span class="hs-identifier">tc_result</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-681"></a><span>                        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FrontendTypecheck</span><span> </span><a href="#local-6989586621684993963"><span class="hs-identifier hs-var">tc_result</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684993961"><span class="hs-identifier hs-var">mb_old_hash</span></a><span class="hs-special">)</span><span>
</span><a name="line-682"></a><span>
</span><a name="line-683"></a><span class="hs-identifier">genericHscFrontend</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-identifier hs-type">FrontendResult</span><span>
</span><a name="line-684"></a><a name="genericHscFrontend"><a href="HscMain.html#genericHscFrontend"><span class="hs-identifier">genericHscFrontend</span></a></a><span> </span><a name="local-6989586621684993964"><a href="#local-6989586621684993964"><span class="hs-identifier">mod_summary</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-685"></a><span>  </span><span class="hs-identifier hs-var">getHooked</span><span> </span><span class="hs-identifier">hscFrontendHook</span><span> </span><a href="HscMain.html#genericHscFrontend%27"><span class="hs-identifier hs-var">genericHscFrontend'</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684993964"><span class="hs-identifier hs-var">mod_summary</span></a><span class="hs-special">)</span><span>
</span><a name="line-686"></a><span>
</span><a name="line-687"></a><span class="hs-identifier">genericHscFrontend'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-identifier hs-type">FrontendResult</span><span>
</span><a name="line-688"></a><a name="genericHscFrontend%27"><a href="HscMain.html#genericHscFrontend%27"><span class="hs-identifier">genericHscFrontend'</span></a></a><span> </span><a name="local-6989586621684993965"><a href="#local-6989586621684993965"><span class="hs-identifier">mod_summary</span></a></a><span>
</span><a name="line-689"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">FrontendTypecheck</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><a href="HscMain.html#hscFileFrontEnd"><span class="hs-identifier hs-var">hscFileFrontEnd</span></a><span> </span><a href="#local-6989586621684993965"><span class="hs-identifier hs-var">mod_summary</span></a><span>
</span><a name="line-690"></a><span>
</span><a name="line-691"></a><span class="hs-comment">--------------------------------------------------------------</span><span>
</span><a name="line-692"></a><span class="hs-comment">-- Compilers</span><span>
</span><a name="line-693"></a><span class="hs-comment">--------------------------------------------------------------</span><span>
</span><a name="line-694"></a><span>
</span><a name="line-695"></a><span class="hs-comment">-- Compile Haskell/boot in OneShot mode.</span><span>
</span><a name="line-696"></a><span class="hs-identifier">hscIncrementalCompile</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-697"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-698"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="HscMain.html#Messager"><span class="hs-identifier hs-type">Messager</span></a><span>
</span><a name="line-699"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-700"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span>
</span><a name="line-701"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SourceModified</span><span>
</span><a name="line-702"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span>
</span><a name="line-703"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-704"></a><span>                      </span><span class="hs-comment">-- HomeModInfo does not contain linkable, since we haven't</span><span>
</span><a name="line-705"></a><span>                      </span><span class="hs-comment">-- code-genned yet</span><span>
</span><a name="line-706"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HscStatus</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HomeModInfo</span><span class="hs-special">)</span><span>
</span><a name="line-707"></a><a name="hscIncrementalCompile"><a href="HscMain.html#hscIncrementalCompile"><span class="hs-identifier">hscIncrementalCompile</span></a></a><span> </span><a name="local-6989586621684993966"><a href="#local-6989586621684993966"><span class="hs-identifier">always_do_basic_recompilation_check</span></a></a><span> </span><a name="local-6989586621684993967"><a href="#local-6989586621684993967"><span class="hs-identifier">m_tc_result</span></a></a><span>
</span><a name="line-708"></a><span>    </span><a name="local-6989586621684993968"><a href="#local-6989586621684993968"><span class="hs-identifier">mHscMessage</span></a></a><span> </span><a name="local-6989586621684993969"><a href="#local-6989586621684993969"><span class="hs-identifier">hsc_env'</span></a></a><span> </span><a name="local-6989586621684993970"><a href="#local-6989586621684993970"><span class="hs-identifier">mod_summary</span></a></a><span> </span><a name="local-6989586621684993971"><a href="#local-6989586621684993971"><span class="hs-identifier">source_modified</span></a></a><span> </span><a name="local-6989586621684993972"><a href="#local-6989586621684993972"><span class="hs-identifier">mb_old_iface</span></a></a><span> </span><a name="local-6989586621684993973"><a href="#local-6989586621684993973"><span class="hs-identifier">mod_index</span></a></a><span>
</span><a name="line-709"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-710"></a><span>    </span><a name="local-6989586621684993974"><a href="#local-6989586621684993974"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynamicLoading.html#initializePlugins"><span class="hs-identifier hs-var">initializePlugins</span></a><span> </span><a href="#local-6989586621684993969"><span class="hs-identifier hs-var">hsc_env'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621684993969"><span class="hs-identifier hs-var">hsc_env'</span></a><span class="hs-special">)</span><span>
</span><a name="line-711"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684993975"><a href="#local-6989586621684993975"><span class="hs-identifier">hsc_env''</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684993969"><span class="hs-identifier hs-var">hsc_env'</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684993974"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-712"></a><span>
</span><a name="line-713"></a><span>    </span><span class="hs-comment">-- One-shot mode needs a knot-tying mutable variable for interface</span><span>
</span><a name="line-714"></a><span>    </span><span class="hs-comment">-- files. See TcRnTypes.TcGblEnv.tcg_type_env_var.</span><span>
</span><a name="line-715"></a><span>    </span><span class="hs-comment">-- See also Note [hsc_type_env_var hack]</span><span>
</span><a name="line-716"></a><span>    </span><a name="local-6989586621684993976"><a href="#local-6989586621684993976"><span class="hs-identifier">type_env_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">emptyNameEnv</span><span>
</span><a name="line-717"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684993977"><a href="#local-6989586621684993977"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_mod</span><span> </span><a href="#local-6989586621684993970"><span class="hs-identifier hs-var">mod_summary</span></a><span>
</span><a name="line-718"></a><span>        </span><a name="local-6989586621684993978"><a href="#local-6989586621684993978"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isOneShot</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ghcMode</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621684993975"><span class="hs-identifier hs-var">hsc_env''</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-719"></a><span>                </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684993975"><span class="hs-identifier hs-var">hsc_env''</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_type_env_var</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684993977"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684993976"><span class="hs-identifier hs-var">type_env_var</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-720"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-721"></a><span>                </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684993975"><span class="hs-identifier hs-var">hsc_env''</span></a><span>
</span><a name="line-722"></a><span>
</span><a name="line-723"></a><span>    </span><span class="hs-comment">-- NB: enter Hsc monad here so that we don't bail out early with</span><span>
</span><a name="line-724"></a><span>    </span><span class="hs-comment">-- -Werror on typechecker warnings; we also want to run the desugarer</span><span>
</span><a name="line-725"></a><span>    </span><span class="hs-comment">-- to get those warnings too. (But we'll always exit at that point</span><span>
</span><a name="line-726"></a><span>    </span><span class="hs-comment">-- because the desugarer runs ioMsgMaybe.)</span><span>
</span><a name="line-727"></a><span>    </span><span class="hs-identifier hs-var">runHsc</span><span> </span><a href="#local-6989586621684993978"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-728"></a><span>    </span><a name="local-6989586621684993979"><a href="#local-6989586621684993979"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#hscIncrementalFrontend"><span class="hs-identifier hs-var">hscIncrementalFrontend</span></a><span> </span><a href="#local-6989586621684993966"><span class="hs-identifier hs-var">always_do_basic_recompilation_check</span></a><span> </span><a href="#local-6989586621684993967"><span class="hs-identifier hs-var">m_tc_result</span></a><span> </span><a href="#local-6989586621684993968"><span class="hs-identifier hs-var">mHscMessage</span></a><span>
</span><a name="line-729"></a><span>            </span><a href="#local-6989586621684993970"><span class="hs-identifier hs-var">mod_summary</span></a><span> </span><a href="#local-6989586621684993971"><span class="hs-identifier hs-var">source_modified</span></a><span> </span><a href="#local-6989586621684993972"><span class="hs-identifier hs-var">mb_old_iface</span></a><span> </span><a href="#local-6989586621684993973"><span class="hs-identifier hs-var">mod_index</span></a><span>
</span><a name="line-730"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684993979"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-731"></a><span>        </span><span class="hs-comment">-- We didn't need to do any typechecking; the old interface</span><span>
</span><a name="line-732"></a><span>        </span><span class="hs-comment">-- file on disk was good enough.</span><span>
</span><a name="line-733"></a><span>        </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621684993980"><a href="#local-6989586621684993980"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-734"></a><span>            </span><span class="hs-comment">-- Knot tying!  See Note [Knot-tying typecheckIface]</span><span>
</span><a name="line-735"></a><span>            </span><a name="local-6989586621684993984"><a href="#local-6989586621684993984"><span class="hs-identifier">hmi</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fixIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621684993981"><a href="#local-6989586621684993981"><span class="hs-identifier">hmi'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-736"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684993982"><a href="#local-6989586621684993982"><span class="hs-identifier">hsc_env'</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-737"></a><span>                        </span><a href="#local-6989586621684993978"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-738"></a><span>                            </span><span class="hs-identifier">hsc_HPT</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addToHpt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_HPT</span><span> </span><a href="#local-6989586621684993978"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-739"></a><span>                                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ms_mod_name</span><span> </span><a href="#local-6989586621684993970"><span class="hs-identifier hs-var">mod_summary</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684993981"><span class="hs-identifier hs-var">hmi'</span></a><span>
</span><a name="line-740"></a><span>                        </span><span class="hs-special">}</span><span>
</span><a name="line-741"></a><span>                </span><span class="hs-comment">-- NB: This result is actually not that useful</span><span>
</span><a name="line-742"></a><span>                </span><span class="hs-comment">-- in one-shot mode, since we're not going to do</span><span>
</span><a name="line-743"></a><span>                </span><span class="hs-comment">-- any further typechecking.  It's much more useful</span><span>
</span><a name="line-744"></a><span>                </span><span class="hs-comment">-- in make mode, since this HMI will go into the HPT.</span><span>
</span><a name="line-745"></a><span>                </span><a name="local-6989586621684993983"><a href="#local-6989586621684993983"><span class="hs-identifier">details</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#genModDetails"><span class="hs-identifier hs-var">genModDetails</span></a><span> </span><a href="#local-6989586621684993982"><span class="hs-identifier hs-var">hsc_env'</span></a><span> </span><a href="#local-6989586621684993980"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-746"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">HomeModInfo</span><span class="hs-special">{</span><span>
</span><a name="line-747"></a><span>                    </span><span class="hs-identifier">hm_details</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684993983"><span class="hs-identifier hs-var">details</span></a><span class="hs-special">,</span><span>
</span><a name="line-748"></a><span>                    </span><span class="hs-identifier">hm_iface</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684993980"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">,</span><span>
</span><a name="line-749"></a><span>                    </span><span class="hs-identifier">hm_linkable</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-750"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HscUpToDate</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684993984"><span class="hs-identifier hs-var">hmi</span></a><span class="hs-special">)</span><span>
</span><a name="line-751"></a><span>        </span><span class="hs-comment">-- We finished type checking.  (mb_old_hash is the hash of</span><span>
</span><a name="line-752"></a><span>        </span><span class="hs-comment">-- the interface that existed on disk; it's possible we had</span><span>
</span><a name="line-753"></a><span>        </span><span class="hs-comment">-- to retypecheck but the resulting interface is exactly</span><span>
</span><a name="line-754"></a><span>        </span><span class="hs-comment">-- the same.)</span><span>
</span><a name="line-755"></a><span>        </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FrontendTypecheck</span><span> </span><a name="local-6989586621684993985"><a href="#local-6989586621684993985"><span class="hs-identifier">tc_result</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684993986"><a href="#local-6989586621684993986"><span class="hs-identifier">mb_old_hash</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-756"></a><span>            </span><a href="HscMain.html#finish"><span class="hs-identifier hs-var">finish</span></a><span> </span><a href="#local-6989586621684993970"><span class="hs-identifier hs-var">mod_summary</span></a><span> </span><a href="#local-6989586621684993985"><span class="hs-identifier hs-var">tc_result</span></a><span> </span><a href="#local-6989586621684993986"><span class="hs-identifier hs-var">mb_old_hash</span></a><span>
</span><a name="line-757"></a><span>
</span><a name="line-758"></a><span class="hs-comment">-- Runs the post-typechecking frontend (desugar and simplify),</span><span>
</span><a name="line-759"></a><span class="hs-comment">-- and then generates and writes out the final interface. We want</span><span>
</span><a name="line-760"></a><span class="hs-comment">-- to write the interface AFTER simplification so we can get</span><span>
</span><a name="line-761"></a><span class="hs-comment">-- as up-to-date and good unfoldings and other info as possible</span><span>
</span><a name="line-762"></a><span class="hs-comment">-- in the interface file.</span><span>
</span><a name="line-763"></a><span class="hs-identifier">finish</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span>
</span><a name="line-764"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-765"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Fingerprint</span><span>
</span><a name="line-766"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HscStatus</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HomeModInfo</span><span class="hs-special">)</span><span>
</span><a name="line-767"></a><a name="finish"><a href="HscMain.html#finish"><span class="hs-identifier">finish</span></a></a><span> </span><a name="local-6989586621684993987"><a href="#local-6989586621684993987"><span class="hs-identifier">summary</span></a></a><span> </span><a name="local-6989586621684993988"><a href="#local-6989586621684993988"><span class="hs-identifier">tc_result</span></a></a><span> </span><a name="local-6989586621684993989"><a href="#local-6989586621684993989"><span class="hs-identifier">mb_old_hash</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-768"></a><span>  </span><a name="local-6989586621684993990"><a href="#local-6989586621684993990"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#getHscEnv"><span class="hs-identifier hs-var">getHscEnv</span></a><span>
</span><a name="line-769"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684993991"><a href="#local-6989586621684993991"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621684993990"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-770"></a><span>      </span><a name="local-6989586621684993992"><a href="#local-6989586621684993992"><span class="hs-identifier">target</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hscTarget</span><span> </span><a href="#local-6989586621684993991"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-771"></a><span>      </span><a name="local-6989586621684993993"><a href="#local-6989586621684993993"><span class="hs-identifier">hsc_src</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_hsc_src</span><span> </span><a href="#local-6989586621684993987"><span class="hs-identifier hs-var">summary</span></a><span>
</span><a name="line-772"></a><span>      </span><a name="local-6989586621684993994"><a href="#local-6989586621684993994"><span class="hs-identifier">should_desugar</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-773"></a><span>        </span><span class="hs-identifier">ms_mod</span><span> </span><a href="#local-6989586621684993987"><span class="hs-identifier hs-var">summary</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">gHC_PRIM</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684993993"><span class="hs-identifier hs-var">hsc_src</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">HsSrcFile</span><span>
</span><a name="line-774"></a><span>      </span><a name="local-6989586621684993995"><a href="#local-6989586621684993995"><span class="hs-identifier">mk_simple_iface</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-775"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684993996"><a href="#local-6989586621684993996"><span class="hs-identifier">hsc_status</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-776"></a><span>              </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684993992"><span class="hs-identifier hs-var">target</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684993993"><span class="hs-identifier hs-var">hsc_src</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-777"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HscNothing</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">HscNotGeneratingCode</span><span>
</span><a name="line-778"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HsBootFile</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">HscUpdateBoot</span><span>
</span><a name="line-779"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HsigFile</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">HscUpdateSig</span><span>
</span><a name="line-780"></a><span>                </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;finish&quot;</span><span>
</span><a name="line-781"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684993997"><a href="#local-6989586621684993997"><span class="hs-identifier">iface</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684993998"><a href="#local-6989586621684993998"><span class="hs-identifier">no_change</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684993999"><a href="#local-6989586621684993999"><span class="hs-identifier">details</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-782"></a><span>          </span><a href="HscMain.html#hscSimpleIface"><span class="hs-identifier hs-var">hscSimpleIface</span></a><span> </span><a href="#local-6989586621684993990"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684993988"><span class="hs-identifier hs-var">tc_result</span></a><span> </span><a href="#local-6989586621684993989"><span class="hs-identifier hs-var">mb_old_hash</span></a><span>
</span><a name="line-783"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684993997"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684993998"><span class="hs-identifier hs-var">no_change</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684993999"><span class="hs-identifier hs-var">details</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684993996"><span class="hs-identifier hs-var">hsc_status</span></a><span class="hs-special">)</span><span>
</span><a name="line-784"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621684994007"><a href="#local-6989586621684994007"><span class="hs-identifier">iface</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684994008"><a href="#local-6989586621684994008"><span class="hs-identifier">no_change</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684994009"><a href="#local-6989586621684994009"><span class="hs-identifier">details</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684994010"><a href="#local-6989586621684994010"><span class="hs-identifier">hsc_status</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-785"></a><span>    </span><span class="hs-comment">-- we usually desugar even when we are not generating code, otherwise</span><span>
</span><a name="line-786"></a><span>    </span><span class="hs-comment">-- we would miss errors thrown by the desugaring (see #10600). The only</span><span>
</span><a name="line-787"></a><span>    </span><span class="hs-comment">-- exceptions are when the Module is Ghc.Prim or when</span><span>
</span><a name="line-788"></a><span>    </span><span class="hs-comment">-- it is not a HsSrcFile Module.</span><span>
</span><a name="line-789"></a><span>    </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621684993994"><span class="hs-identifier hs-var">should_desugar</span></a><span>
</span><a name="line-790"></a><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-791"></a><span>        </span><a name="local-6989586621684994000"><a href="#local-6989586621684994000"><span class="hs-identifier">desugared_guts0</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#hscDesugar%27"><span class="hs-identifier hs-var">hscDesugar'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ms_location</span><span> </span><a href="#local-6989586621684993987"><span class="hs-identifier hs-var">summary</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684993988"><span class="hs-identifier hs-var">tc_result</span></a><span>
</span><a name="line-792"></a><span>        </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621684993992"><span class="hs-identifier hs-var">target</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">HscNothing</span><span>
</span><a name="line-793"></a><span>          </span><span class="hs-comment">-- We are not generating code, so we can skip simplification</span><span>
</span><a name="line-794"></a><span>          </span><span class="hs-comment">-- and generate a simple interface.</span><span>
</span><a name="line-795"></a><span>          </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621684993995"><span class="hs-identifier hs-var">mk_simple_iface</span></a><span>
</span><a name="line-796"></a><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-797"></a><span>            </span><a name="local-6989586621684994001"><a href="#local-6989586621684994001"><span class="hs-identifier">plugins</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_th_coreplugins</span><span> </span><a href="#local-6989586621684993988"><span class="hs-identifier hs-var">tc_result</span></a><span class="hs-special">)</span><span>
</span><a name="line-798"></a><span>            </span><a name="local-6989586621684994002"><a href="#local-6989586621684994002"><span class="hs-identifier">desugared_guts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#hscSimplify%27"><span class="hs-identifier hs-var">hscSimplify'</span></a><span> </span><a href="#local-6989586621684994001"><span class="hs-identifier hs-var">plugins</span></a><span> </span><a href="#local-6989586621684994000"><span class="hs-identifier hs-var">desugared_guts0</span></a><span>
</span><a name="line-799"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621684994003"><a href="#local-6989586621684994003"><span class="hs-identifier">iface</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684994004"><a href="#local-6989586621684994004"><span class="hs-identifier">no_change</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684994005"><a href="#local-6989586621684994005"><span class="hs-identifier">details</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684994006"><a href="#local-6989586621684994006"><span class="hs-identifier">cgguts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-800"></a><span>              </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#hscNormalIface"><span class="hs-identifier hs-var">hscNormalIface</span></a><span> </span><a href="#local-6989586621684993990"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994002"><span class="hs-identifier hs-var">desugared_guts</span></a><span> </span><a href="#local-6989586621684993989"><span class="hs-identifier hs-var">mb_old_hash</span></a><span>
</span><a name="line-801"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684994003"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684994004"><span class="hs-identifier hs-var">no_change</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684994005"><span class="hs-identifier hs-var">details</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HscRecomp</span><span> </span><a href="#local-6989586621684994006"><span class="hs-identifier hs-var">cgguts</span></a><span> </span><a href="#local-6989586621684993987"><span class="hs-identifier hs-var">summary</span></a><span class="hs-special">)</span><span>
</span><a name="line-802"></a><span>      </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621684993995"><span class="hs-identifier hs-var">mk_simple_iface</span></a><span>
</span><a name="line-803"></a><span>  </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#hscMaybeWriteIface"><span class="hs-identifier hs-var">hscMaybeWriteIface</span></a><span> </span><a href="#local-6989586621684993991"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684994007"><span class="hs-identifier hs-var">iface</span></a><span> </span><a href="#local-6989586621684994008"><span class="hs-identifier hs-var">no_change</span></a><span> </span><a href="#local-6989586621684993987"><span class="hs-identifier hs-var">summary</span></a><span>
</span><a name="line-804"></a><span>  </span><span class="hs-identifier hs-var">return</span><span>
</span><a name="line-805"></a><span>    </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621684994010"><span class="hs-identifier hs-var">hsc_status</span></a><span>
</span><a name="line-806"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HomeModInfo</span><span>
</span><a name="line-807"></a><span>      </span><span class="hs-special">{</span><span class="hs-identifier">hm_details</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684994009"><span class="hs-identifier hs-var">details</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">hm_iface</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684994007"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">hm_linkable</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-808"></a><span>
</span><a name="line-809"></a><span class="hs-identifier">hscMaybeWriteIface</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-810"></a><a name="hscMaybeWriteIface"><a href="HscMain.html#hscMaybeWriteIface"><span class="hs-identifier">hscMaybeWriteIface</span></a></a><span> </span><a name="local-6989586621684994011"><a href="#local-6989586621684994011"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684994012"><a href="#local-6989586621684994012"><span class="hs-identifier">iface</span></a></a><span> </span><a name="local-6989586621684994013"><a href="#local-6989586621684994013"><span class="hs-identifier">no_change</span></a></a><span> </span><a name="local-6989586621684994014"><a href="#local-6989586621684994014"><span class="hs-identifier">summary</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-811"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684994015"><a href="#local-6989586621684994015"><span class="hs-identifier">force_write_interface</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_WriteInterface</span><span> </span><a href="#local-6989586621684994011"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-812"></a><span>        </span><a name="local-6989586621684994016"><a href="#local-6989586621684994016"><span class="hs-identifier">write_interface</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">hscTarget</span><span> </span><a href="#local-6989586621684994011"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-813"></a><span>                            </span><span class="hs-identifier hs-var">HscNothing</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-814"></a><span>                            </span><span class="hs-identifier hs-var">HscInterpreted</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-815"></a><span>                            </span><span class="hs-identifier">_</span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-816"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684994016"><span class="hs-identifier hs-var">write_interface</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621684994015"><span class="hs-identifier hs-var">force_write_interface</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-817"></a><span>            </span><a href="HscMain.html#hscWriteIface"><span class="hs-identifier hs-var">hscWriteIface</span></a><span> </span><a href="#local-6989586621684994011"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684994012"><span class="hs-identifier hs-var">iface</span></a><span> </span><a href="#local-6989586621684994013"><span class="hs-identifier hs-var">no_change</span></a><span> </span><a href="#local-6989586621684994014"><span class="hs-identifier hs-var">summary</span></a><span>
</span><a name="line-818"></a><span>
</span><a name="line-819"></a><span class="hs-comment">--------------------------------------------------------------</span><span>
</span><a name="line-820"></a><span class="hs-comment">-- NoRecomp handlers</span><span>
</span><a name="line-821"></a><span class="hs-comment">--------------------------------------------------------------</span><span>
</span><a name="line-822"></a><span>
</span><a name="line-823"></a><span class="hs-comment">-- NB: this must be knot-tied appropriately, see hscIncrementalCompile</span><span>
</span><a name="line-824"></a><span class="hs-identifier">genModDetails</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">ModDetails</span><span>
</span><a name="line-825"></a><a name="genModDetails"><a href="HscMain.html#genModDetails"><span class="hs-identifier">genModDetails</span></a></a><span> </span><a name="local-6989586621684994017"><a href="#local-6989586621684994017"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684994018"><a href="#local-6989586621684994018"><span class="hs-identifier">old_iface</span></a></a><span>
</span><a name="line-826"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-827"></a><span>    </span><a name="local-6989586621684994019"><a href="#local-6989586621684994019"><span class="hs-identifier">new_details</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;tcRnIface&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-828"></a><span>                   </span><a href="TcRnMonad.html#initIfaceLoad"><span class="hs-identifier hs-var">initIfaceLoad</span></a><span> </span><a href="#local-6989586621684994017"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><a href="TcIface.html#typecheckIface"><span class="hs-identifier hs-var">typecheckIface</span></a><span> </span><a href="#local-6989586621684994018"><span class="hs-identifier hs-var">old_iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-829"></a><span>    </span><a href="HscMain.html#dumpIfaceStats"><span class="hs-identifier hs-var">dumpIfaceStats</span></a><span> </span><a href="#local-6989586621684994017"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-830"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684994019"><span class="hs-identifier hs-var">new_details</span></a><span>
</span><a name="line-831"></a><span>
</span><a name="line-832"></a><span class="hs-comment">--------------------------------------------------------------</span><span>
</span><a name="line-833"></a><span class="hs-comment">-- Progress displayers.</span><span>
</span><a name="line-834"></a><span class="hs-comment">--------------------------------------------------------------</span><span>
</span><a name="line-835"></a><span>
</span><a name="line-836"></a><span class="hs-identifier">oneShotMsg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-837"></a><a name="oneShotMsg"><a href="HscMain.html#oneShotMsg"><span class="hs-identifier">oneShotMsg</span></a></a><span> </span><a name="local-6989586621684994020"><a href="#local-6989586621684994020"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684994021"><a href="#local-6989586621684994021"><span class="hs-identifier">recomp</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-838"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684994021"><span class="hs-identifier hs-var">recomp</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-839"></a><span>        </span><a href="MkIface.html#UpToDate"><span class="hs-identifier hs-var">UpToDate</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-840"></a><span>            </span><span class="hs-identifier hs-var">compilationProgressMsg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621684994020"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-841"></a><span>                   </span><span class="hs-string">&quot;compilation IS NOT required&quot;</span><span>
</span><a name="line-842"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-843"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-844"></a><span>
</span><a name="line-845"></a><span class="hs-identifier">batchMsg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HscMain.html#Messager"><span class="hs-identifier hs-type">Messager</span></a><span>
</span><a name="line-846"></a><a name="batchMsg"><a href="HscMain.html#batchMsg"><span class="hs-identifier">batchMsg</span></a></a><span> </span><a name="local-6989586621684994022"><a href="#local-6989586621684994022"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684994023"><a href="#local-6989586621684994023"><span class="hs-identifier">mod_index</span></a></a><span> </span><a name="local-6989586621684994024"><a href="#local-6989586621684994024"><span class="hs-identifier">recomp</span></a></a><span> </span><a name="local-6989586621684994025"><a href="#local-6989586621684994025"><span class="hs-identifier">mod_summary</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-847"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684994024"><span class="hs-identifier hs-var">recomp</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-848"></a><span>        </span><a href="MkIface.html#MustCompile"><span class="hs-identifier hs-var">MustCompile</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684994027"><span class="hs-identifier hs-var">showMsg</span></a><span> </span><span class="hs-string">&quot;Compiling &quot;</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-849"></a><span>        </span><a href="MkIface.html#UpToDate"><span class="hs-identifier hs-var">UpToDate</span></a><span>
</span><a name="line-850"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">verbosity</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621684994022"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684994027"><span class="hs-identifier hs-var">showMsg</span></a><span> </span><span class="hs-string">&quot;Skipping  &quot;</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-851"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-852"></a><span>        </span><a href="MkIface.html#RecompBecause"><span class="hs-identifier hs-var">RecompBecause</span></a><span> </span><a name="local-6989586621684994030"><a href="#local-6989586621684994030"><span class="hs-identifier">reason</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684994027"><span class="hs-identifier hs-var">showMsg</span></a><span> </span><span class="hs-string">&quot;Compiling &quot;</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot; [&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684994030"><span class="hs-identifier hs-var">reason</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;]&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-853"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-854"></a><span>        </span><a name="local-6989586621684994026"><a href="#local-6989586621684994026"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621684994022"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-855"></a><span>        </span><a name="local-6989586621684994027"><a href="#local-6989586621684994027"><span class="hs-identifier">showMsg</span></a></a><span> </span><a name="local-6989586621684994028"><a href="#local-6989586621684994028"><span class="hs-identifier">msg</span></a></a><span> </span><a name="local-6989586621684994029"><a href="#local-6989586621684994029"><span class="hs-identifier">reason</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-856"></a><span>            </span><span class="hs-identifier hs-var">compilationProgressMsg</span><span> </span><a href="#local-6989586621684994026"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-857"></a><span>            </span><span class="hs-special">(</span><a href="HscMain.html#showModuleIndex"><span class="hs-identifier hs-var">showModuleIndex</span></a><span> </span><a href="#local-6989586621684994023"><span class="hs-identifier hs-var">mod_index</span></a><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-858"></a><span>            </span><a href="#local-6989586621684994028"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">showModMsg</span><span> </span><a href="#local-6989586621684994026"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">hscTarget</span><span> </span><a href="#local-6989586621684994026"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-859"></a><span>                              </span><span class="hs-special">(</span><a href="MkIface.html#recompileRequired"><span class="hs-identifier hs-var">recompileRequired</span></a><span> </span><a href="#local-6989586621684994024"><span class="hs-identifier hs-var">recomp</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684994025"><span class="hs-identifier hs-var">mod_summary</span></a><span class="hs-special">)</span><span>
</span><a name="line-860"></a><span>                </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684994029"><span class="hs-identifier hs-var">reason</span></a><span>
</span><a name="line-861"></a><span>
</span><a name="line-862"></a><span class="hs-comment">--------------------------------------------------------------</span><span>
</span><a name="line-863"></a><span class="hs-comment">-- FrontEnds</span><span>
</span><a name="line-864"></a><span class="hs-comment">--------------------------------------------------------------</span><span>
</span><a name="line-865"></a><span>
</span><a name="line-866"></a><span class="hs-comment">-- | Given a 'ModSummary', parses and typechecks it, returning the</span><span>
</span><a name="line-867"></a><span class="hs-comment">-- 'TcGblEnv' resulting from type-checking.</span><span>
</span><a name="line-868"></a><span class="hs-identifier">hscFileFrontEnd</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-869"></a><a name="hscFileFrontEnd"><a href="HscMain.html#hscFileFrontEnd"><span class="hs-identifier">hscFileFrontEnd</span></a></a><span> </span><a name="local-6989586621684994031"><a href="#local-6989586621684994031"><span class="hs-identifier">mod_summary</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HscMain.html#hscTypecheck"><span class="hs-identifier hs-var">hscTypecheck</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621684994031"><span class="hs-identifier hs-var">mod_summary</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-870"></a><span>
</span><a name="line-871"></a><span class="hs-comment">--------------------------------------------------------------</span><span>
</span><a name="line-872"></a><span class="hs-comment">-- Safe Haskell</span><span>
</span><a name="line-873"></a><span class="hs-comment">--------------------------------------------------------------</span><span>
</span><a name="line-874"></a><span>
</span><a name="line-875"></a><span class="hs-comment">-- Note [Safe Haskell Trust Check]</span><span>
</span><a name="line-876"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-877"></a><span class="hs-comment">-- Safe Haskell checks that an import is trusted according to the following</span><span>
</span><a name="line-878"></a><span class="hs-comment">-- rules for an import of module M that resides in Package P:</span><span>
</span><a name="line-879"></a><span class="hs-comment">--</span><span>
</span><a name="line-880"></a><span class="hs-comment">--   * If M is recorded as Safe and all its trust dependencies are OK</span><span>
</span><a name="line-881"></a><span class="hs-comment">--     then M is considered safe.</span><span>
</span><a name="line-882"></a><span class="hs-comment">--   * If M is recorded as Trustworthy and P is considered trusted and</span><span>
</span><a name="line-883"></a><span class="hs-comment">--     all M's trust dependencies are OK then M is considered safe.</span><span>
</span><a name="line-884"></a><span class="hs-comment">--</span><span>
</span><a name="line-885"></a><span class="hs-comment">-- By trust dependencies we mean that the check is transitive. So if</span><span>
</span><a name="line-886"></a><span class="hs-comment">-- a module M that is Safe relies on a module N that is trustworthy,</span><span>
</span><a name="line-887"></a><span class="hs-comment">-- importing module M will first check (according to the second case)</span><span>
</span><a name="line-888"></a><span class="hs-comment">-- that N is trusted before checking M is trusted.</span><span>
</span><a name="line-889"></a><span class="hs-comment">--</span><span>
</span><a name="line-890"></a><span class="hs-comment">-- This is a minimal description, so please refer to the user guide</span><span>
</span><a name="line-891"></a><span class="hs-comment">-- for more details. The user guide is also considered the authoritative</span><span>
</span><a name="line-892"></a><span class="hs-comment">-- source in this matter, not the comments or code.</span><span>
</span><a name="line-893"></a><span>
</span><a name="line-894"></a><span>
</span><a name="line-895"></a><span class="hs-comment">-- Note [Safe Haskell Inference]</span><span>
</span><a name="line-896"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-897"></a><span class="hs-comment">-- Safe Haskell does Safe inference on modules that don't have any specific</span><span>
</span><a name="line-898"></a><span class="hs-comment">-- safe haskell mode flag. The basic approach to this is:</span><span>
</span><a name="line-899"></a><span class="hs-comment">--   * When deciding if we need to do a Safe language check, treat</span><span>
</span><a name="line-900"></a><span class="hs-comment">--     an unmarked module as having -XSafe mode specified.</span><span>
</span><a name="line-901"></a><span class="hs-comment">--   * For checks, don't throw errors but return them to the caller.</span><span>
</span><a name="line-902"></a><span class="hs-comment">--   * Caller checks if there are errors:</span><span>
</span><a name="line-903"></a><span class="hs-comment">--     * For modules explicitly marked -XSafe, we throw the errors.</span><span>
</span><a name="line-904"></a><span class="hs-comment">--     * For unmarked modules (inference mode), we drop the errors</span><span>
</span><a name="line-905"></a><span class="hs-comment">--       and mark the module as being Unsafe.</span><span>
</span><a name="line-906"></a><span class="hs-comment">--</span><span>
</span><a name="line-907"></a><span class="hs-comment">-- It used to be that we only did safe inference on modules that had no Safe</span><span>
</span><a name="line-908"></a><span class="hs-comment">-- Haskell flags, but now we perform safe inference on all modules as we want</span><span>
</span><a name="line-909"></a><span class="hs-comment">-- to allow users to set the `-Wsafe`, `-Wunsafe` and</span><span>
</span><a name="line-910"></a><span class="hs-comment">-- `-Wtrustworthy-safe` flags on Trustworthy and Unsafe modules so that a</span><span>
</span><a name="line-911"></a><span class="hs-comment">-- user can ensure their assumptions are correct and see reasons for why a</span><span>
</span><a name="line-912"></a><span class="hs-comment">-- module is safe or unsafe.</span><span>
</span><a name="line-913"></a><span class="hs-comment">--</span><span>
</span><a name="line-914"></a><span class="hs-comment">-- This is tricky as we must be careful when we should throw an error compared</span><span>
</span><a name="line-915"></a><span class="hs-comment">-- to just warnings. For checking safe imports we manage it as two steps. First</span><span>
</span><a name="line-916"></a><span class="hs-comment">-- we check any imports that are required to be safe, then we check all other</span><span>
</span><a name="line-917"></a><span class="hs-comment">-- imports to see if we can infer them to be safe.</span><span>
</span><a name="line-918"></a><span>
</span><a name="line-919"></a><span>
</span><a name="line-920"></a><span class="hs-comment">-- | Check that the safe imports of the module being compiled are valid.</span><span>
</span><a name="line-921"></a><span class="hs-comment">-- If not we either issue a compilation error if the module is explicitly</span><span>
</span><a name="line-922"></a><span class="hs-comment">-- using Safe Haskell, or mark the module as unsafe if we're in safe</span><span>
</span><a name="line-923"></a><span class="hs-comment">-- inference mode.</span><span>
</span><a name="line-924"></a><span class="hs-identifier">hscCheckSafeImports</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-925"></a><a name="hscCheckSafeImports"><a href="HscMain.html#hscCheckSafeImports"><span class="hs-identifier">hscCheckSafeImports</span></a></a><span> </span><a name="local-6989586621684994032"><a href="#local-6989586621684994032"><span class="hs-identifier">tcg_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-926"></a><span>    </span><a name="local-6989586621684994043"><a href="#local-6989586621684994043"><span class="hs-identifier">dflags</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-927"></a><span>    </span><a name="local-6989586621684994044"><a href="#local-6989586621684994044"><span class="hs-identifier">tcg_env'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#checkSafeImports"><span class="hs-identifier hs-var">checkSafeImports</span></a><span> </span><a href="#local-6989586621684994032"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-928"></a><span>    </span><a href="#local-6989586621684994033"><span class="hs-identifier hs-var">checkRULES</span></a><span> </span><a href="#local-6989586621684994043"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684994044"><span class="hs-identifier hs-var">tcg_env'</span></a><span>
</span><a name="line-929"></a><span>
</span><a name="line-930"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-931"></a><span>    </span><a name="local-6989586621684994033"><a href="#local-6989586621684994033"><span class="hs-identifier">checkRULES</span></a></a><span> </span><a name="local-6989586621684994036"><a href="#local-6989586621684994036"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684994037"><a href="#local-6989586621684994037"><span class="hs-identifier">tcg_env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-932"></a><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">safeLanguageOn</span><span> </span><a href="#local-6989586621684994036"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-933"></a><span>          </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-934"></a><span>              </span><span class="hs-comment">-- XSafe: we nuke user written RULES</span><span>
</span><a name="line-935"></a><span>              </span><a href="HscMain.html#logWarnings"><span class="hs-identifier hs-var">logWarnings</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684994034"><span class="hs-identifier hs-var">warns</span></a><span> </span><a href="#local-6989586621684994036"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_rules</span><span> </span><a href="#local-6989586621684994037"><span class="hs-identifier hs-var">tcg_env'</span></a><span class="hs-special">)</span><span>
</span><a name="line-936"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684994037"><span class="hs-identifier hs-var">tcg_env'</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_rules</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-937"></a><span>          </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-938"></a><span>                </span><span class="hs-comment">-- SafeInferred: user defined RULES, so not safe</span><span>
</span><a name="line-939"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">safeInferOn</span><span> </span><a href="#local-6989586621684994036"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">tcg_rules</span><span> </span><a href="#local-6989586621684994037"><span class="hs-identifier hs-var">tcg_env'</span></a><span class="hs-special">)</span><span>
</span><a name="line-940"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HscMain.html#markUnsafeInfer"><span class="hs-identifier hs-var">markUnsafeInfer</span></a><span> </span><a href="#local-6989586621684994037"><span class="hs-identifier hs-var">tcg_env'</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684994034"><span class="hs-identifier hs-var">warns</span></a><span> </span><a href="#local-6989586621684994036"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_rules</span><span> </span><a href="#local-6989586621684994037"><span class="hs-identifier hs-var">tcg_env'</span></a><span class="hs-special">)</span><span>
</span><a name="line-941"></a><span>
</span><a name="line-942"></a><span>                </span><span class="hs-comment">-- Trustworthy OR SafeInferred: with no RULES</span><span>
</span><a name="line-943"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-944"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684994037"><span class="hs-identifier hs-var">tcg_env'</span></a><span>
</span><a name="line-945"></a><span>
</span><a name="line-946"></a><span>    </span><a name="local-6989586621684994034"><a href="#local-6989586621684994034"><span class="hs-identifier">warns</span></a></a><span> </span><a name="local-6989586621684994038"><a href="#local-6989586621684994038"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684994039"><a href="#local-6989586621684994039"><span class="hs-identifier">rules</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">listToBag</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684994035"><span class="hs-identifier hs-var">warnRules</span></a><span> </span><a href="#local-6989586621684994038"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684994039"><span class="hs-identifier hs-var">rules</span></a><span>
</span><a name="line-947"></a><span>    </span><a name="local-6989586621684994035"><a href="#local-6989586621684994035"><span class="hs-identifier">warnRules</span></a></a><span> </span><a name="local-6989586621684994040"><a href="#local-6989586621684994040"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621684994041"><a href="#local-6989586621684994041"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRule</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rd_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684994042"><a href="#local-6989586621684994042"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-948"></a><span>        </span><span class="hs-identifier hs-var">mkPlainWarnMsg</span><span> </span><a href="#local-6989586621684994040"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684994041"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-949"></a><span>            </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Rule \&quot;&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ftext</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621684994042"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\&quot; ignored&quot;</span><span> </span><span class="hs-operator hs-var">$+$</span><span>
</span><a name="line-950"></a><span>            </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;User defined rules are disabled under Safe Haskell&quot;</span><span>
</span><a name="line-951"></a><span>    </span><span class="hs-identifier">warnRules</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XRuleDecl</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;hscCheckSafeImports&quot;</span><span>
</span><a name="line-952"></a><span>
</span><a name="line-953"></a><span class="hs-comment">-- | Validate that safe imported modules are actually safe.  For modules in the</span><span>
</span><a name="line-954"></a><span class="hs-comment">-- HomePackage (the package the module we are compiling in resides) this just</span><span>
</span><a name="line-955"></a><span class="hs-comment">-- involves checking its trust type is 'Safe' or 'Trustworthy'. For modules</span><span>
</span><a name="line-956"></a><span class="hs-comment">-- that reside in another package we also must check that the external package</span><span>
</span><a name="line-957"></a><span class="hs-comment">-- is trusted. See the Note [Safe Haskell Trust Check] above for more</span><span>
</span><a name="line-958"></a><span class="hs-comment">-- information.</span><span>
</span><a name="line-959"></a><span class="hs-comment">--</span><span>
</span><a name="line-960"></a><span class="hs-comment">-- The code for this is quite tricky as the whole algorithm is done in a few</span><span>
</span><a name="line-961"></a><span class="hs-comment">-- distinct phases in different parts of the code base. See</span><span>
</span><a name="line-962"></a><span class="hs-comment">-- RnNames.rnImportDecl for where package trust dependencies for a module are</span><span>
</span><a name="line-963"></a><span class="hs-comment">-- collected and unioned.  Specifically see the Note [RnNames . Tracking Trust</span><span>
</span><a name="line-964"></a><span class="hs-comment">-- Transitively] and the Note [RnNames . Trust Own Package].</span><span>
</span><a name="line-965"></a><span class="hs-identifier">checkSafeImports</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-966"></a><a name="checkSafeImports"><a href="HscMain.html#checkSafeImports"><span class="hs-identifier">checkSafeImports</span></a></a><span> </span><a name="local-6989586621684994045"><a href="#local-6989586621684994045"><span class="hs-identifier">tcg_env</span></a></a><span>
</span><a name="line-967"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-968"></a><span>        </span><a name="local-6989586621684994071"><a href="#local-6989586621684994071"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-969"></a><span>        </span><a name="local-6989586621684994072"><a href="#local-6989586621684994072"><span class="hs-identifier">imps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621684994051"><span class="hs-identifier hs-var">condense</span></a><span> </span><a href="#local-6989586621684994049"><span class="hs-identifier hs-var">imports'</span></a><span>
</span><a name="line-970"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684994073"><a href="#local-6989586621684994073"><span class="hs-identifier">safeImps</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684994074"><a href="#local-6989586621684994074"><span class="hs-identifier">regImps</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partition</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621684994075"><a href="#local-6989586621684994075"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684994075"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684994072"><span class="hs-identifier hs-var">imps</span></a><span>
</span><a name="line-971"></a><span>
</span><a name="line-972"></a><span>        </span><span class="hs-comment">-- We want to use the warning state specifically for detecting if safe</span><span>
</span><a name="line-973"></a><span>        </span><span class="hs-comment">-- inference has failed, so store and clear any existing warnings.</span><span>
</span><a name="line-974"></a><span>        </span><a name="local-6989586621684994076"><a href="#local-6989586621684994076"><span class="hs-identifier">oldErrs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#getWarnings"><span class="hs-identifier hs-var">getWarnings</span></a><span>
</span><a name="line-975"></a><span>        </span><a href="HscMain.html#clearWarnings"><span class="hs-identifier hs-var">clearWarnings</span></a><span>
</span><a name="line-976"></a><span>
</span><a name="line-977"></a><span>        </span><span class="hs-comment">-- Check safe imports are correct</span><span>
</span><a name="line-978"></a><span>        </span><a name="local-6989586621684994077"><a href="#local-6989586621684994077"><span class="hs-identifier">safePkgs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">S.fromList</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">mapMaybeM</span><span> </span><a href="#local-6989586621684994053"><span class="hs-identifier hs-var">checkSafe</span></a><span> </span><a href="#local-6989586621684994073"><span class="hs-identifier hs-var">safeImps</span></a><span>
</span><a name="line-979"></a><span>        </span><a name="local-6989586621684994078"><a href="#local-6989586621684994078"><span class="hs-identifier">safeErrs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#getWarnings"><span class="hs-identifier hs-var">getWarnings</span></a><span>
</span><a name="line-980"></a><span>        </span><a href="HscMain.html#clearWarnings"><span class="hs-identifier hs-var">clearWarnings</span></a><span>
</span><a name="line-981"></a><span>
</span><a name="line-982"></a><span>        </span><span class="hs-comment">-- Check non-safe imports are correct if inferring safety</span><span>
</span><a name="line-983"></a><span>        </span><span class="hs-comment">-- See the Note [Safe Haskell Inference]</span><span>
</span><a name="line-984"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684994081"><a href="#local-6989586621684994081"><span class="hs-identifier">infErrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684994082"><a href="#local-6989586621684994082"><span class="hs-identifier">infPkgs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">safeInferOn</span><span> </span><a href="#local-6989586621684994071"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-985"></a><span>          </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">emptyBag</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">S.empty</span><span class="hs-special">)</span><span>
</span><a name="line-986"></a><span>          </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621684994079"><a href="#local-6989586621684994079"><span class="hs-identifier">infPkgs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">S.fromList</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">mapMaybeM</span><span> </span><a href="#local-6989586621684994053"><span class="hs-identifier hs-var">checkSafe</span></a><span> </span><a href="#local-6989586621684994074"><span class="hs-identifier hs-var">regImps</span></a><span>
</span><a name="line-987"></a><span>                     </span><a name="local-6989586621684994080"><a href="#local-6989586621684994080"><span class="hs-identifier">infErrs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#getWarnings"><span class="hs-identifier hs-var">getWarnings</span></a><span>
</span><a name="line-988"></a><span>                     </span><a href="HscMain.html#clearWarnings"><span class="hs-identifier hs-var">clearWarnings</span></a><span>
</span><a name="line-989"></a><span>                     </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684994080"><span class="hs-identifier hs-var">infErrs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684994079"><span class="hs-identifier hs-var">infPkgs</span></a><span class="hs-special">)</span><span>
</span><a name="line-990"></a><span>
</span><a name="line-991"></a><span>        </span><span class="hs-comment">-- restore old errors</span><span>
</span><a name="line-992"></a><span>        </span><a href="HscMain.html#logWarnings"><span class="hs-identifier hs-var">logWarnings</span></a><span> </span><a href="#local-6989586621684994076"><span class="hs-identifier hs-var">oldErrs</span></a><span>
</span><a name="line-993"></a><span>
</span><a name="line-994"></a><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isEmptyBag</span><span> </span><a href="#local-6989586621684994078"><span class="hs-identifier hs-var">safeErrs</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-995"></a><span>          </span><span class="hs-comment">-- Failed safe check</span><span>
</span><a name="line-996"></a><span>          </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">mkSrcErr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684994078"><span class="hs-identifier hs-var">safeErrs</span></a><span>
</span><a name="line-997"></a><span>
</span><a name="line-998"></a><span>          </span><span class="hs-comment">-- Passed safe check</span><span>
</span><a name="line-999"></a><span>          </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1000"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684994083"><a href="#local-6989586621684994083"><span class="hs-identifier">infPassed</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isEmptyBag</span><span> </span><a href="#local-6989586621684994081"><span class="hs-identifier hs-var">infErrs</span></a><span>
</span><a name="line-1001"></a><span>            </span><a name="local-6989586621684994084"><a href="#local-6989586621684994084"><span class="hs-identifier">tcg_env'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621684994083"><span class="hs-identifier hs-var">infPassed</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1002"></a><span>              </span><span class="hs-identifier hs-var">True</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HscMain.html#markUnsafeInfer"><span class="hs-identifier hs-var">markUnsafeInfer</span></a><span> </span><a href="#local-6989586621684994045"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><a href="#local-6989586621684994081"><span class="hs-identifier hs-var">infErrs</span></a><span>
</span><a name="line-1003"></a><span>              </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684994045"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-1004"></a><span>            </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">packageTrustOn</span><span> </span><a href="#local-6989586621684994071"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#checkPkgTrust"><span class="hs-identifier hs-var">checkPkgTrust</span></a><span> </span><a href="#local-6989586621684994050"><span class="hs-identifier hs-var">pkgReqs</span></a><span>
</span><a name="line-1005"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684994085"><a href="#local-6989586621684994085"><span class="hs-identifier">newTrust</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684994054"><span class="hs-identifier hs-var">pkgTrustReqs</span></a><span> </span><a href="#local-6989586621684994071"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684994077"><span class="hs-identifier hs-var">safePkgs</span></a><span> </span><a href="#local-6989586621684994082"><span class="hs-identifier hs-var">infPkgs</span></a><span> </span><a href="#local-6989586621684994083"><span class="hs-identifier hs-var">infPassed</span></a><span>
</span><a name="line-1006"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684994084"><span class="hs-identifier hs-var">tcg_env'</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_imports</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684994046"><span class="hs-identifier hs-var">impInfo</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusImportAvails</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684994085"><span class="hs-identifier hs-var">newTrust</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1007"></a><span>
</span><a name="line-1008"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1009"></a><span>    </span><a name="local-6989586621684994046"><a href="#local-6989586621684994046"><span class="hs-identifier">impInfo</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_imports</span><span> </span><a href="#local-6989586621684994045"><span class="hs-identifier hs-var">tcg_env</span></a><span>     </span><span class="hs-comment">-- ImportAvails</span><span>
</span><a name="line-1010"></a><span>    </span><a name="local-6989586621684994047"><a href="#local-6989586621684994047"><span class="hs-identifier">imports</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">imp_mods</span><span> </span><a href="#local-6989586621684994046"><span class="hs-identifier hs-var">impInfo</span></a><span>        </span><span class="hs-comment">-- ImportedMods</span><span>
</span><a name="line-1011"></a><span>    </span><a name="local-6989586621684994048"><a href="#local-6989586621684994048"><span class="hs-identifier">imports1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">moduleEnvToList</span><span> </span><a href="#local-6989586621684994047"><span class="hs-identifier hs-var">imports</span></a><span> </span><span class="hs-comment">-- (Module, [ImportedBy])</span><span>
</span><a name="line-1012"></a><span>    </span><a name="local-6989586621684994049"><a href="#local-6989586621684994049"><span class="hs-identifier">imports'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">importedByUser</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684994048"><span class="hs-identifier hs-var">imports1</span></a><span> </span><span class="hs-comment">-- (Module, [ImportedModsVal])</span><span>
</span><a name="line-1013"></a><span>    </span><a name="local-6989586621684994050"><a href="#local-6989586621684994050"><span class="hs-identifier">pkgReqs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">imp_trust_pkgs</span><span> </span><a href="#local-6989586621684994046"><span class="hs-identifier hs-var">impInfo</span></a><span>  </span><span class="hs-comment">-- [UnitId]</span><span>
</span><a name="line-1014"></a><span>
</span><a name="line-1015"></a><span>    </span><span class="hs-identifier">condense</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Module</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ImportedModsVal</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Module</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">IsSafeImport</span><span class="hs-special">)</span><span>
</span><a name="line-1016"></a><span>    </span><a name="local-6989586621684994051"><a href="#local-6989586621684994051"><span class="hs-identifier">condense</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;HscMain.condense: Pattern match failure!&quot;</span><span>
</span><a name="line-1017"></a><span>    </span><span class="hs-identifier">condense</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684994056"><a href="#local-6989586621684994056"><span class="hs-identifier">m</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684994057"><a href="#local-6989586621684994057"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684994058"><a href="#local-6989586621684994058"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621684994059"><a href="#local-6989586621684994059"><span class="hs-identifier">imv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">foldlM</span><span> </span><a href="#local-6989586621684994052"><span class="hs-identifier hs-var">cond'</span></a><span> </span><a href="#local-6989586621684994057"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621684994058"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-1018"></a><span>                            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684994056"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">imv_span</span><span> </span><a href="#local-6989586621684994059"><span class="hs-identifier hs-var">imv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">imv_is_safe</span><span> </span><a href="#local-6989586621684994059"><span class="hs-identifier hs-var">imv</span></a><span class="hs-special">)</span><span>
</span><a name="line-1019"></a><span>
</span><a name="line-1020"></a><span>    </span><span class="hs-comment">-- ImportedModsVal = (ModuleName, Bool, SrcSpan, IsSafeImport)</span><span>
</span><a name="line-1021"></a><span>    </span><span class="hs-identifier">cond'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ImportedModsVal</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ImportedModsVal</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-identifier hs-type">ImportedModsVal</span><span>
</span><a name="line-1022"></a><span>    </span><a name="local-6989586621684994052"><a href="#local-6989586621684994052"><span class="hs-identifier">cond'</span></a></a><span> </span><a name="local-6989586621684994060"><a href="#local-6989586621684994060"><span class="hs-identifier">v1</span></a></a><span> </span><a name="local-6989586621684994061"><a href="#local-6989586621684994061"><span class="hs-identifier">v2</span></a></a><span>
</span><a name="line-1023"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">imv_is_safe</span><span> </span><a href="#local-6989586621684994060"><span class="hs-identifier hs-var">v1</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier">imv_is_safe</span><span> </span><a href="#local-6989586621684994061"><span class="hs-identifier hs-var">v2</span></a><span>
</span><a name="line-1024"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1025"></a><span>            </span><a name="local-6989586621684994062"><a href="#local-6989586621684994062"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1026"></a><span>            </span><a href="HscMain.html#throwErrors"><span class="hs-identifier hs-var">throwErrors</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unitBag</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkPlainErrMsg</span><span> </span><a href="#local-6989586621684994062"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">imv_span</span><span> </span><a href="#local-6989586621684994060"><span class="hs-identifier hs-var">v1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1027"></a><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Module&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">imv_name</span><span> </span><a href="#local-6989586621684994060"><span class="hs-identifier hs-var">v1</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1028"></a><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;is imported both as a safe and unsafe import!&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1029"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1030"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684994060"><span class="hs-identifier hs-var">v1</span></a><span>
</span><a name="line-1031"></a><span>
</span><a name="line-1032"></a><span>    </span><span class="hs-comment">-- easier interface to work with</span><span>
</span><a name="line-1033"></a><span>    </span><span class="hs-identifier">checkSafe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Module</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684994055"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">InstalledUnitId</span><span class="hs-special">)</span><span>
</span><a name="line-1034"></a><span>    </span><a name="local-6989586621684994053"><a href="#local-6989586621684994053"><span class="hs-identifier">checkSafe</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684994063"><a href="#local-6989586621684994063"><span class="hs-identifier">m</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684994064"><a href="#local-6989586621684994064"><span class="hs-identifier">l</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><a href="HscMain.html#hscCheckSafe%27"><span class="hs-identifier hs-var">hscCheckSafe'</span></a><span> </span><a href="#local-6989586621684994063"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621684994064"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-1035"></a><span>
</span><a name="line-1036"></a><span>    </span><span class="hs-comment">-- what pkg's to add to our trust requirements</span><span>
</span><a name="line-1037"></a><span>    </span><span class="hs-identifier">pkgTrustReqs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-identifier hs-type">InstalledUnitId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-identifier hs-type">InstalledUnitId</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1038"></a><span>          </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ImportAvails</span><span>
</span><a name="line-1039"></a><span>    </span><a name="local-6989586621684994054"><a href="#local-6989586621684994054"><span class="hs-identifier">pkgTrustReqs</span></a></a><span> </span><a name="local-6989586621684994065"><a href="#local-6989586621684994065"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684994066"><a href="#local-6989586621684994066"><span class="hs-identifier">req</span></a></a><span> </span><a name="local-6989586621684994067"><a href="#local-6989586621684994067"><span class="hs-identifier">inf</span></a></a><span> </span><a name="local-6989586621684994068"><a href="#local-6989586621684994068"><span class="hs-identifier">infPassed</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">safeInferOn</span><span> </span><a href="#local-6989586621684994065"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1040"></a><span>                                  </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">safeHaskellModeEnabled</span><span> </span><a href="#local-6989586621684994065"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684994068"><span class="hs-identifier hs-var">infPassed</span></a><span>
</span><a name="line-1041"></a><span>                                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyImportAvails</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1042"></a><span>                                       </span><span class="hs-identifier">imp_trust_pkgs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684994066"><span class="hs-identifier hs-var">req</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">S.union</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684994067"><span class="hs-identifier hs-var">inf</span></a><span>
</span><a name="line-1043"></a><span>                                   </span><span class="hs-special">}</span><span>
</span><a name="line-1044"></a><span>    </span><span class="hs-identifier">pkgTrustReqs</span><span> </span><a name="local-6989586621684994069"><a href="#local-6989586621684994069"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">safeHaskell</span><span> </span><a href="#local-6989586621684994069"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">Sf_Unsafe</span><span>
</span><a name="line-1045"></a><span>                         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyImportAvails</span><span>
</span><a name="line-1046"></a><span>    </span><span class="hs-identifier">pkgTrustReqs</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684994070"><a href="#local-6989586621684994070"><span class="hs-identifier">req</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyImportAvails</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">imp_trust_pkgs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684994070"><span class="hs-identifier hs-var">req</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1047"></a><span>
</span><a name="line-1048"></a><span class="hs-comment">-- | Check that a module is safe to import.</span><span>
</span><a name="line-1049"></a><span class="hs-comment">--</span><span>
</span><a name="line-1050"></a><span class="hs-comment">-- We return True to indicate the import is safe and False otherwise</span><span>
</span><a name="line-1051"></a><span class="hs-comment">-- although in the False case an exception may be thrown first.</span><span>
</span><a name="line-1052"></a><span class="hs-identifier">hscCheckSafe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1053"></a><a name="hscCheckSafe"><a href="HscMain.html#hscCheckSafe"><span class="hs-identifier">hscCheckSafe</span></a></a><span> </span><a name="local-6989586621684994086"><a href="#local-6989586621684994086"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684994087"><a href="#local-6989586621684994087"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621684994088"><a href="#local-6989586621684994088"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runHsc</span><span> </span><a href="#local-6989586621684994086"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1054"></a><span>    </span><a name="local-6989586621684994089"><a href="#local-6989586621684994089"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1055"></a><span>    </span><a name="local-6989586621684994090"><a href="#local-6989586621684994090"><span class="hs-identifier">pkgs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><a href="HscMain.html#hscCheckSafe%27"><span class="hs-identifier hs-var">hscCheckSafe'</span></a><span> </span><a href="#local-6989586621684994087"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621684994088"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-1056"></a><span>    </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">packageTrustOn</span><span> </span><a href="#local-6989586621684994089"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#checkPkgTrust"><span class="hs-identifier hs-var">checkPkgTrust</span></a><span> </span><a href="#local-6989586621684994090"><span class="hs-identifier hs-var">pkgs</span></a><span>
</span><a name="line-1057"></a><span>    </span><a name="local-6989586621684994091"><a href="#local-6989586621684994091"><span class="hs-identifier">errs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#getWarnings"><span class="hs-identifier hs-var">getWarnings</span></a><span>
</span><a name="line-1058"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">isEmptyBag</span><span> </span><a href="#local-6989586621684994091"><span class="hs-identifier hs-var">errs</span></a><span>
</span><a name="line-1059"></a><span>
</span><a name="line-1060"></a><span class="hs-comment">-- | Return if a module is trusted and the pkgs it depends on to be trusted.</span><span>
</span><a name="line-1061"></a><span class="hs-identifier">hscGetSafe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-identifier hs-type">InstalledUnitId</span><span class="hs-special">)</span><span>
</span><a name="line-1062"></a><a name="hscGetSafe"><a href="HscMain.html#hscGetSafe"><span class="hs-identifier">hscGetSafe</span></a></a><span> </span><a name="local-6989586621684994092"><a href="#local-6989586621684994092"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684994093"><a href="#local-6989586621684994093"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621684994094"><a href="#local-6989586621684994094"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runHsc</span><span> </span><a href="#local-6989586621684994092"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1063"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684994095"><a href="#local-6989586621684994095"><span class="hs-identifier">self</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684994096"><a href="#local-6989586621684994096"><span class="hs-identifier">pkgs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#hscCheckSafe%27"><span class="hs-identifier hs-var">hscCheckSafe'</span></a><span> </span><a href="#local-6989586621684994093"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621684994094"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-1064"></a><span>    </span><a name="local-6989586621684994097"><a href="#local-6989586621684994097"><span class="hs-identifier">good</span></a></a><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">isEmptyBag</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><a href="HscMain.html#getWarnings"><span class="hs-identifier hs-var">getWarnings</span></a><span>
</span><a name="line-1065"></a><span>    </span><a href="HscMain.html#clearWarnings"><span class="hs-identifier hs-var">clearWarnings</span></a><span> </span><span class="hs-comment">-- don't want them printed...</span><span>
</span><a name="line-1066"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684994098"><a href="#local-6989586621684994098"><span class="hs-identifier">pkgs'</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684994099"><a href="#local-6989586621684994099"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684994095"><span class="hs-identifier hs-var">self</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S.insert</span><span> </span><a href="#local-6989586621684994099"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621684994096"><span class="hs-identifier hs-var">pkgs</span></a><span>
</span><a name="line-1067"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684994096"><span class="hs-identifier hs-var">pkgs</span></a><span>
</span><a name="line-1068"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684994097"><span class="hs-identifier hs-var">good</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684994098"><span class="hs-identifier hs-var">pkgs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1069"></a><span>
</span><a name="line-1070"></a><span class="hs-comment">-- | Is a module trusted? If not, throw or log errors depending on the type.</span><span>
</span><a name="line-1071"></a><span class="hs-comment">-- Return (regardless of trusted or not) if the trust type requires the modules</span><span>
</span><a name="line-1072"></a><span class="hs-comment">-- own package be trusted and a list of other packages required to be trusted</span><span>
</span><a name="line-1073"></a><span class="hs-comment">-- (these later ones haven't been checked) but the own package trust has been.</span><span>
</span><a name="line-1074"></a><span class="hs-identifier">hscCheckSafe'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span>
</span><a name="line-1075"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">InstalledUnitId</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-identifier hs-type">InstalledUnitId</span><span class="hs-special">)</span><span>
</span><a name="line-1076"></a><a name="hscCheckSafe%27"><a href="HscMain.html#hscCheckSafe%27"><span class="hs-identifier">hscCheckSafe'</span></a></a><span> </span><a name="local-6989586621684994100"><a href="#local-6989586621684994100"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621684994101"><a href="#local-6989586621684994101"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1077"></a><span>    </span><a name="local-6989586621684994132"><a href="#local-6989586621684994132"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1078"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684994133"><a href="#local-6989586621684994133"><span class="hs-identifier">tw</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684994134"><a href="#local-6989586621684994134"><span class="hs-identifier">pkgs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684994102"><span class="hs-identifier hs-var">isModSafe</span></a><span> </span><a href="#local-6989586621684994100"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621684994101"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-1079"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684994133"><span class="hs-identifier hs-var">tw</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1080"></a><span>        </span><span class="hs-identifier hs-var">False</span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684994134"><span class="hs-identifier hs-var">pkgs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1081"></a><span>        </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684994105"><span class="hs-identifier hs-var">isHomePkg</span></a><span> </span><a href="#local-6989586621684994132"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684994100"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684994134"><span class="hs-identifier hs-var">pkgs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1082"></a><span>             </span><span class="hs-comment">-- TODO: do we also have to check the trust of the instantiation?</span><span>
</span><a name="line-1083"></a><span>             </span><span class="hs-comment">-- Not necessary if that is reflected in dependencies</span><span>
</span><a name="line-1084"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">toInstalledUnitId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621684994100"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684994134"><span class="hs-identifier hs-var">pkgs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1085"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1086"></a><span>    </span><span class="hs-identifier">isModSafe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-identifier hs-type">InstalledUnitId</span><span class="hs-special">)</span><span>
</span><a name="line-1087"></a><span>    </span><a name="local-6989586621684994102"><a href="#local-6989586621684994102"><span class="hs-identifier">isModSafe</span></a></a><span> </span><a name="local-6989586621684994106"><a href="#local-6989586621684994106"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621684994107"><a href="#local-6989586621684994107"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1088"></a><span>        </span><a name="local-6989586621684994108"><a href="#local-6989586621684994108"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1089"></a><span>        </span><a name="local-6989586621684994109"><a href="#local-6989586621684994109"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684994104"><span class="hs-identifier hs-var">lookup'</span></a><span> </span><a href="#local-6989586621684994106"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-1090"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684994109"><span class="hs-identifier hs-var">iface</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1091"></a><span>            </span><span class="hs-comment">-- can't load iface to check trust!</span><span>
</span><a name="line-1092"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HscMain.html#throwErrors"><span class="hs-identifier hs-var">throwErrors</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unitBag</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkPlainErrMsg</span><span> </span><a href="#local-6989586621684994108"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684994107"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-1093"></a><span>                         </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Can't load the interface file for&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684994106"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-1094"></a><span>                           </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;, to check that it can be safely imported&quot;</span><span>
</span><a name="line-1095"></a><span>
</span><a name="line-1096"></a><span>            </span><span class="hs-comment">-- got iface, check trust</span><span>
</span><a name="line-1097"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684994110"><a href="#local-6989586621684994110"><span class="hs-identifier">iface'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1098"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684994113"><a href="#local-6989586621684994113"><span class="hs-identifier">trust</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getSafeMode</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">mi_trust</span><span> </span><a href="#local-6989586621684994110"><span class="hs-identifier hs-var">iface'</span></a><span>
</span><a name="line-1099"></a><span>                    </span><a name="local-6989586621684994114"><a href="#local-6989586621684994114"><span class="hs-identifier">trust_own_pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_trust_pkg</span><span> </span><a href="#local-6989586621684994110"><span class="hs-identifier hs-var">iface'</span></a><span>
</span><a name="line-1100"></a><span>                    </span><span class="hs-comment">-- check module is trusted</span><span>
</span><a name="line-1101"></a><span>                    </span><a name="local-6989586621684994115"><a href="#local-6989586621684994115"><span class="hs-identifier">safeM</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684994113"><span class="hs-identifier hs-var">trust</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Sf_Safe</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Sf_Trustworthy</span><span class="hs-special">]</span><span>
</span><a name="line-1102"></a><span>                    </span><span class="hs-comment">-- check package is trusted</span><span>
</span><a name="line-1103"></a><span>                    </span><a name="local-6989586621684994116"><a href="#local-6989586621684994116"><span class="hs-identifier">safeP</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684994103"><span class="hs-identifier hs-var">packageTrusted</span></a><span> </span><a href="#local-6989586621684994108"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684994113"><span class="hs-identifier hs-var">trust</span></a><span> </span><a href="#local-6989586621684994114"><span class="hs-identifier hs-var">trust_own_pkg</span></a><span> </span><a href="#local-6989586621684994106"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-1104"></a><span>                    </span><span class="hs-comment">-- pkg trust reqs</span><span>
</span><a name="line-1105"></a><span>                    </span><a name="local-6989586621684994117"><a href="#local-6989586621684994117"><span class="hs-identifier">pkgRs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S.fromList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">dep_pkgs</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">mi_deps</span><span> </span><a href="#local-6989586621684994110"><span class="hs-identifier hs-var">iface'</span></a><span>
</span><a name="line-1106"></a><span>                    </span><span class="hs-comment">-- General errors we throw but Safe errors we log</span><span>
</span><a name="line-1107"></a><span>                    </span><a name="local-6989586621684994118"><a href="#local-6989586621684994118"><span class="hs-identifier">errs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684994115"><span class="hs-identifier hs-var">safeM</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684994116"><span class="hs-identifier hs-var">safeP</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1108"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">emptyBag</span><span>
</span><a name="line-1109"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684994111"><span class="hs-identifier hs-var">pkgTrustErr</span></a><span>
</span><a name="line-1110"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684994112"><span class="hs-identifier hs-var">modTrustErr</span></a><span>
</span><a name="line-1111"></a><span>                </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1112"></a><span>                    </span><a href="HscMain.html#logWarnings"><span class="hs-identifier hs-var">logWarnings</span></a><span> </span><a href="#local-6989586621684994118"><span class="hs-identifier hs-var">errs</span></a><span>
</span><a name="line-1113"></a><span>                    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684994113"><span class="hs-identifier hs-var">trust</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">Sf_Trustworthy</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684994117"><span class="hs-identifier hs-var">pkgRs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1114"></a><span>
</span><a name="line-1115"></a><span>                </span><span class="hs-keyword">where</span><span>
</span><a name="line-1116"></a><span>                    </span><a name="local-6989586621684994111"><a href="#local-6989586621684994111"><span class="hs-identifier">pkgTrustErr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unitBag</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkErrMsg</span><span> </span><a href="#local-6989586621684994108"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684994107"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pkgQual</span><span> </span><a href="#local-6989586621684994108"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1117"></a><span>                        </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621684994106"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-1118"></a><span>                                </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;: Can't be safely imported!&quot;</span><span>
</span><a name="line-1119"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The package (&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621684994106"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-1120"></a><span>                                </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;) the module resides in isn't trusted.&quot;</span><span>
</span><a name="line-1121"></a><span>                            </span><span class="hs-special">]</span><span>
</span><a name="line-1122"></a><span>                    </span><a name="local-6989586621684994112"><a href="#local-6989586621684994112"><span class="hs-identifier">modTrustErr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unitBag</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkErrMsg</span><span> </span><a href="#local-6989586621684994108"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684994107"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pkgQual</span><span> </span><a href="#local-6989586621684994108"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1123"></a><span>                        </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621684994106"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-1124"></a><span>                                </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;: Can't be safely imported!&quot;</span><span>
</span><a name="line-1125"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The module itself isn't safe.&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1126"></a><span>
</span><a name="line-1127"></a><span>    </span><span class="hs-comment">-- | Check the package a module resides in is trusted. Safe compiled</span><span>
</span><a name="line-1128"></a><span>    </span><span class="hs-comment">-- modules are trusted without requiring that their package is trusted. For</span><span>
</span><a name="line-1129"></a><span>    </span><span class="hs-comment">-- trustworthy modules, modules in the home package are trusted but</span><span>
</span><a name="line-1130"></a><span>    </span><span class="hs-comment">-- otherwise we check the package trust flag.</span><span>
</span><a name="line-1131"></a><span>    </span><span class="hs-identifier">packageTrusted</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SafeHaskellMode</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1132"></a><span>    </span><a name="local-6989586621684994103"><a href="#local-6989586621684994103"><span class="hs-identifier">packageTrusted</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">Sf_None</span><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-comment">-- shouldn't hit these cases</span><span>
</span><a name="line-1133"></a><span>    </span><span class="hs-identifier">packageTrusted</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">Sf_Ignore</span><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-comment">-- shouldn't hit these cases</span><span>
</span><a name="line-1134"></a><span>    </span><span class="hs-identifier">packageTrusted</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">Sf_Unsafe</span><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-comment">-- prefer for completeness.</span><span>
</span><a name="line-1135"></a><span>    </span><span class="hs-identifier">packageTrusted</span><span> </span><a name="local-6989586621684994119"><a href="#local-6989586621684994119"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-1136"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">packageTrustOn</span><span> </span><a href="#local-6989586621684994119"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1137"></a><span>    </span><span class="hs-identifier">packageTrusted</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">Sf_Safe</span><span>  </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1138"></a><span>    </span><span class="hs-identifier">packageTrusted</span><span> </span><a name="local-6989586621684994120"><a href="#local-6989586621684994120"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684994121"><a href="#local-6989586621684994121"><span class="hs-identifier">m</span></a></a><span>
</span><a name="line-1139"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684994105"><span class="hs-identifier hs-var">isHomePkg</span></a><span> </span><a href="#local-6989586621684994120"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684994121"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1140"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">trusted</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">getPackageDetails</span><span> </span><a href="#local-6989586621684994120"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621684994121"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-1141"></a><span>
</span><a name="line-1142"></a><span>    </span><span class="hs-identifier">lookup'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span class="hs-special">)</span><span>
</span><a name="line-1143"></a><span>    </span><a name="local-6989586621684994104"><a href="#local-6989586621684994104"><span class="hs-identifier">lookup'</span></a></a><span> </span><a name="local-6989586621684994122"><a href="#local-6989586621684994122"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1144"></a><span>        </span><a name="local-6989586621684994123"><a href="#local-6989586621684994123"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1145"></a><span>        </span><a name="local-6989586621684994124"><a href="#local-6989586621684994124"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#getHscEnv"><span class="hs-identifier hs-var">getHscEnv</span></a><span>
</span><a name="line-1146"></a><span>        </span><a name="local-6989586621684994125"><a href="#local-6989586621684994125"><span class="hs-identifier">hsc_eps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">hscEPS</span><span> </span><a href="#local-6989586621684994124"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1147"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684994126"><a href="#local-6989586621684994126"><span class="hs-identifier">pkgIfaceT</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">eps_PIT</span><span> </span><a href="#local-6989586621684994125"><span class="hs-identifier hs-var">hsc_eps</span></a><span>
</span><a name="line-1148"></a><span>            </span><a name="local-6989586621684994127"><a href="#local-6989586621684994127"><span class="hs-identifier">homePkgT</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_HPT</span><span> </span><a href="#local-6989586621684994124"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1149"></a><span>            </span><a name="local-6989586621684994128"><a href="#local-6989586621684994128"><span class="hs-identifier">iface</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupIfaceByModule</span><span> </span><a href="#local-6989586621684994123"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684994127"><span class="hs-identifier hs-var">homePkgT</span></a><span> </span><a href="#local-6989586621684994126"><span class="hs-identifier hs-var">pkgIfaceT</span></a><span> </span><a href="#local-6989586621684994122"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-1150"></a><span>        </span><span class="hs-comment">-- the 'lookupIfaceByModule' method will always fail when calling from GHCi</span><span>
</span><a name="line-1151"></a><span>        </span><span class="hs-comment">-- as the compiler hasn't filled in the various module tables</span><span>
</span><a name="line-1152"></a><span>        </span><span class="hs-comment">-- so we need to call 'getModuleInterface' to load from disk</span><span>
</span><a name="line-1153"></a><span>        </span><a name="local-6989586621684994129"><a href="#local-6989586621684994129"><span class="hs-identifier">iface'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684994128"><span class="hs-identifier hs-var">iface</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1154"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684994128"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-1155"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnDriver.html#getModuleInterface"><span class="hs-identifier hs-var">getModuleInterface</span></a><span> </span><a href="#local-6989586621684994124"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994122"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-1156"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684994129"><span class="hs-identifier hs-var">iface'</span></a><span>
</span><a name="line-1157"></a><span>
</span><a name="line-1158"></a><span>
</span><a name="line-1159"></a><span>    </span><span class="hs-identifier">isHomePkg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1160"></a><span>    </span><a name="local-6989586621684994105"><a href="#local-6989586621684994105"><span class="hs-identifier">isHomePkg</span></a></a><span> </span><a name="local-6989586621684994130"><a href="#local-6989586621684994130"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684994131"><a href="#local-6989586621684994131"><span class="hs-identifier">m</span></a></a><span>
</span><a name="line-1161"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">thisPackage</span><span> </span><a href="#local-6989586621684994130"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621684994131"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1162"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1163"></a><span>
</span><a name="line-1164"></a><span class="hs-comment">-- | Check the list of packages are trusted.</span><span>
</span><a name="line-1165"></a><span class="hs-identifier">checkPkgTrust</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-identifier hs-type">InstalledUnitId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1166"></a><a name="checkPkgTrust"><a href="HscMain.html#checkPkgTrust"><span class="hs-identifier">checkPkgTrust</span></a></a><span> </span><a name="local-6989586621684994135"><a href="#local-6989586621684994135"><span class="hs-identifier">pkgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1167"></a><span>    </span><a name="local-6989586621684994136"><a href="#local-6989586621684994136"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1168"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684994137"><a href="#local-6989586621684994137"><span class="hs-identifier">errors</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S.foldr</span><span> </span><a href="#local-6989586621684994138"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621684994135"><span class="hs-identifier hs-var">pkgs</span></a><span>
</span><a name="line-1169"></a><span>        </span><a name="local-6989586621684994138"><a href="#local-6989586621684994138"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621684994139"><a href="#local-6989586621684994139"><span class="hs-identifier">pkg</span></a></a><span> </span><a name="local-6989586621684994140"><a href="#local-6989586621684994140"><span class="hs-identifier">acc</span></a></a><span>
</span><a name="line-1170"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">trusted</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">getInstalledPackageDetails</span><span> </span><a href="#local-6989586621684994136"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684994139"><span class="hs-identifier hs-var">pkg</span></a><span>
</span><a name="line-1171"></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684994140"><span class="hs-identifier hs-var">acc</span></a><span>
</span><a name="line-1172"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1173"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><a href="#local-6989586621684994140"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkErrMsg</span><span> </span><a href="#local-6989586621684994136"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">noSrcSpan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pkgQual</span><span> </span><a href="#local-6989586621684994136"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1174"></a><span>                     </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The package (&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684994139"><span class="hs-identifier hs-var">pkg</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;) is required&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-1175"></a><span>                       </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot; to be trusted but it isn't!&quot;</span><span>
</span><a name="line-1176"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684994137"><span class="hs-identifier hs-var">errors</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1177"></a><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1178"></a><span>        </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">throwIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">mkSrcErr</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">listToBag</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684994137"><span class="hs-identifier hs-var">errors</span></a><span>
</span><a name="line-1179"></a><span>
</span><a name="line-1180"></a><span class="hs-comment">-- | Set module to unsafe and (potentially) wipe trust information.</span><span>
</span><a name="line-1181"></a><span class="hs-comment">--</span><span>
</span><a name="line-1182"></a><span class="hs-comment">-- Make sure to call this method to set a module to inferred unsafe, it should</span><span>
</span><a name="line-1183"></a><span class="hs-comment">-- be a central and single failure method. We only wipe the trust information</span><span>
</span><a name="line-1184"></a><span class="hs-comment">-- when we aren't in a specific Safe Haskell mode.</span><span>
</span><a name="line-1185"></a><span class="hs-comment">--</span><span>
</span><a name="line-1186"></a><span class="hs-comment">-- While we only use this for recording that a module was inferred unsafe, we</span><span>
</span><a name="line-1187"></a><span class="hs-comment">-- may call it on modules using Trustworthy or Unsafe flags so as to allow</span><span>
</span><a name="line-1188"></a><span class="hs-comment">-- warning flags for safety to function correctly. See Note [Safe Haskell</span><span>
</span><a name="line-1189"></a><span class="hs-comment">-- Inference].</span><span>
</span><a name="line-1190"></a><span class="hs-identifier">markUnsafeInfer</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">WarningMessages</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-1191"></a><a name="markUnsafeInfer"><a href="HscMain.html#markUnsafeInfer"><span class="hs-identifier">markUnsafeInfer</span></a></a><span> </span><a name="local-6989586621684994141"><a href="#local-6989586621684994141"><span class="hs-identifier">tcg_env</span></a></a><span> </span><a name="local-6989586621684994142"><a href="#local-6989586621684994142"><span class="hs-identifier">whyUnsafe</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1192"></a><span>    </span><a name="local-6989586621684994159"><a href="#local-6989586621684994159"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1193"></a><span>
</span><a name="line-1194"></a><span>    </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wopt</span><span> </span><span class="hs-identifier hs-var">Opt_WarnUnsafe</span><span> </span><a href="#local-6989586621684994159"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1195"></a><span>         </span><span class="hs-special">(</span><a href="HscMain.html#logWarnings"><span class="hs-identifier hs-var">logWarnings</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unitBag</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">makeIntoWarning</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><span class="hs-identifier hs-var">Opt_WarnUnsafe</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1196"></a><span>             </span><span class="hs-identifier hs-var">mkPlainWarnMsg</span><span> </span><a href="#local-6989586621684994159"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">warnUnsafeOnLoc</span><span> </span><a href="#local-6989586621684994159"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684994145"><span class="hs-identifier hs-var">whyUnsafe'</span></a><span> </span><a href="#local-6989586621684994159"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1197"></a><span>
</span><a name="line-1198"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">writeIORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_safeInfer</span><span> </span><a href="#local-6989586621684994141"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684994142"><span class="hs-identifier hs-var">whyUnsafe</span></a><span class="hs-special">)</span><span>
</span><a name="line-1199"></a><span>    </span><span class="hs-comment">-- NOTE: Only wipe trust when not in an explicitly safe haskell mode. Other</span><span>
</span><a name="line-1200"></a><span>    </span><span class="hs-comment">-- times inference may be on but we are in Trustworthy mode -- so we want</span><span>
</span><a name="line-1201"></a><span>    </span><span class="hs-comment">-- to record safe-inference failed but not wipe the trust dependencies.</span><span>
</span><a name="line-1202"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">safeHaskellModeEnabled</span><span> </span><a href="#local-6989586621684994159"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1203"></a><span>      </span><span class="hs-identifier hs-var">True</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684994141"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_imports</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684994143"><span class="hs-identifier hs-var">wiped_trust</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1204"></a><span>      </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684994141"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-1205"></a><span>
</span><a name="line-1206"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1207"></a><span>    </span><a name="local-6989586621684994143"><a href="#local-6989586621684994143"><span class="hs-identifier">wiped_trust</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_imports</span><span> </span><a href="#local-6989586621684994141"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">imp_trust_pkgs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">S.empty</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1208"></a><span>    </span><a name="local-6989586621684994144"><a href="#local-6989586621684994144"><span class="hs-identifier">pprMod</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">moduleName</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">tcg_mod</span><span> </span><a href="#local-6989586621684994141"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-1209"></a><span>    </span><a name="local-6989586621684994145"><a href="#local-6989586621684994145"><span class="hs-identifier">whyUnsafe'</span></a></a><span> </span><a name="local-6989586621684994151"><a href="#local-6989586621684994151"><span class="hs-identifier">df</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><a href="#local-6989586621684994144"><span class="hs-identifier hs-var">pprMod</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;has been inferred as unsafe!&quot;</span><span>
</span><a name="line-1210"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Reason:&quot;</span><span>
</span><a name="line-1211"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684994146"><span class="hs-identifier hs-var">badFlags</span></a><span> </span><a href="#local-6989586621684994151"><span class="hs-identifier hs-var">df</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$+$</span><span>
</span><a name="line-1212"></a><span>                                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">pprErrMsgBagWithLoc</span><span> </span><a href="#local-6989586621684994142"><span class="hs-identifier hs-var">whyUnsafe</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$+$</span><span>
</span><a name="line-1213"></a><span>                                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684994148"><span class="hs-identifier hs-var">badInsts</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">tcg_insts</span><span> </span><a href="#local-6989586621684994141"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1214"></a><span>                         </span><span class="hs-special">]</span><span>
</span><a name="line-1215"></a><span>    </span><a name="local-6989586621684994146"><a href="#local-6989586621684994146"><span class="hs-identifier">badFlags</span></a></a><span> </span><a name="local-6989586621684994152"><a href="#local-6989586621684994152"><span class="hs-identifier">df</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684994147"><span class="hs-identifier hs-var">badFlag</span></a><span> </span><a href="#local-6989586621684994152"><span class="hs-identifier hs-var">df</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">unsafeFlagsForInfer</span><span>
</span><a name="line-1216"></a><span>    </span><a name="local-6989586621684994147"><a href="#local-6989586621684994147"><span class="hs-identifier">badFlag</span></a></a><span> </span><a name="local-6989586621684994153"><a href="#local-6989586621684994153"><span class="hs-identifier">df</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684994154"><a href="#local-6989586621684994154"><span class="hs-identifier">str</span></a></a><span class="hs-special">,</span><a name="local-6989586621684994155"><a href="#local-6989586621684994155"><span class="hs-identifier">loc</span></a></a><span class="hs-special">,</span><a name="local-6989586621684994156"><a href="#local-6989586621684994156"><span class="hs-identifier">on</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1217"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684994156"><span class="hs-identifier hs-var">on</span></a><span> </span><a href="#local-6989586621684994153"><span class="hs-identifier hs-var">df</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">mkLocMessage</span><span> </span><span class="hs-identifier hs-var">SevOutput</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684994155"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621684994153"><span class="hs-identifier hs-var">df</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1218"></a><span>                            </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621684994154"><span class="hs-identifier hs-var">str</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is not allowed in Safe Haskell&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-1219"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1220"></a><span>    </span><a name="local-6989586621684994148"><a href="#local-6989586621684994148"><span class="hs-identifier">badInsts</span></a></a><span> </span><a name="local-6989586621684994157"><a href="#local-6989586621684994157"><span class="hs-identifier">insts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621684994150"><span class="hs-identifier hs-var">badInst</span></a><span> </span><a href="#local-6989586621684994157"><span class="hs-identifier hs-var">insts</span></a><span>
</span><a name="line-1221"></a><span>
</span><a name="line-1222"></a><span>    </span><a name="local-6989586621684994149"><a href="#local-6989586621684994149"><span class="hs-identifier">checkOverlap</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NoOverlap</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1223"></a><span>    </span><span class="hs-identifier">checkOverlap</span><span> </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1224"></a><span>
</span><a name="line-1225"></a><span>    </span><a name="local-6989586621684994150"><a href="#local-6989586621684994150"><span class="hs-identifier">badInst</span></a></a><span> </span><a name="local-6989586621684994158"><a href="#local-6989586621684994158"><span class="hs-identifier">ins</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684994149"><span class="hs-identifier hs-var">checkOverlap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">overlapMode</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">is_flag</span><span> </span><a href="#local-6989586621684994158"><span class="hs-identifier hs-var">ins</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1226"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">mkLocMessage</span><span> </span><span class="hs-identifier hs-var">SevOutput</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameSrcSpan</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">getName</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">is_dfun</span><span> </span><a href="#local-6989586621684994158"><span class="hs-identifier hs-var">ins</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1227"></a><span>                      </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">overlapMode</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">is_flag</span><span> </span><a href="#local-6989586621684994158"><span class="hs-identifier hs-var">ins</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1228"></a><span>                      </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;overlap mode isn't allowed in Safe Haskell&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-1229"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1230"></a><span>
</span><a name="line-1231"></a><span>
</span><a name="line-1232"></a><span class="hs-comment">-- | Figure out the final correct safe haskell mode</span><span>
</span><a name="line-1233"></a><span class="hs-identifier">hscGetSafeMode</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-identifier hs-type">SafeHaskellMode</span><span>
</span><a name="line-1234"></a><a name="hscGetSafeMode"><a href="HscMain.html#hscGetSafeMode"><span class="hs-identifier">hscGetSafeMode</span></a></a><span> </span><a name="local-6989586621684994160"><a href="#local-6989586621684994160"><span class="hs-identifier">tcg_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1235"></a><span>    </span><a name="local-6989586621684994161"><a href="#local-6989586621684994161"><span class="hs-identifier">dflags</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1236"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnMonad.html#finalSafeMode"><span class="hs-identifier hs-var">finalSafeMode</span></a><span> </span><a href="#local-6989586621684994161"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684994160"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-1237"></a><span>
</span><a name="line-1238"></a><span class="hs-comment">--------------------------------------------------------------</span><span>
</span><a name="line-1239"></a><span class="hs-comment">-- Simplifiers</span><span>
</span><a name="line-1240"></a><span class="hs-comment">--------------------------------------------------------------</span><span>
</span><a name="line-1241"></a><span>
</span><a name="line-1242"></a><span class="hs-identifier">hscSimplify</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span>
</span><a name="line-1243"></a><a name="hscSimplify"><a href="HscMain.html#hscSimplify"><span class="hs-identifier">hscSimplify</span></a></a><span> </span><a name="local-6989586621684994162"><a href="#local-6989586621684994162"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684994163"><a href="#local-6989586621684994163"><span class="hs-identifier">plugins</span></a></a><span> </span><a name="local-6989586621684994164"><a href="#local-6989586621684994164"><span class="hs-identifier">modguts</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1244"></a><span>    </span><span class="hs-identifier hs-var">runHsc</span><span> </span><a href="#local-6989586621684994162"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#hscSimplify%27"><span class="hs-identifier hs-var">hscSimplify'</span></a><span> </span><a href="#local-6989586621684994163"><span class="hs-identifier hs-var">plugins</span></a><span> </span><a href="#local-6989586621684994164"><span class="hs-identifier hs-var">modguts</span></a><span>
</span><a name="line-1245"></a><span>
</span><a name="line-1246"></a><span class="hs-identifier">hscSimplify'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span>
</span><a name="line-1247"></a><a name="hscSimplify%27"><a href="HscMain.html#hscSimplify%27"><span class="hs-identifier">hscSimplify'</span></a></a><span> </span><a name="local-6989586621684994165"><a href="#local-6989586621684994165"><span class="hs-identifier">plugins</span></a></a><span> </span><a name="local-6989586621684994166"><a href="#local-6989586621684994166"><span class="hs-identifier">ds_result</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1248"></a><span>    </span><a name="local-6989586621684994167"><a href="#local-6989586621684994167"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#getHscEnv"><span class="hs-identifier hs-var">getHscEnv</span></a><span>
</span><a name="line-1249"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684994168"><a href="#local-6989586621684994168"><span class="hs-identifier">hsc_env_with_plugins</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684994167"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1250"></a><span>          </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-identifier hs-var">addPluginModuleName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621684994167"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684994165"><span class="hs-identifier hs-var">plugins</span></a><span>
</span><a name="line-1251"></a><span>          </span><span class="hs-special">}</span><span>
</span><a name="line-1252"></a><span>    </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;Core2Core&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-1253"></a><span>      </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="SimplCore.html#core2core"><span class="hs-identifier hs-var">core2core</span></a><span> </span><a href="#local-6989586621684994168"><span class="hs-identifier hs-var">hsc_env_with_plugins</span></a><span> </span><a href="#local-6989586621684994166"><span class="hs-identifier hs-var">ds_result</span></a><span>
</span><a name="line-1254"></a><span>
</span><a name="line-1255"></a><span class="hs-comment">--------------------------------------------------------------</span><span>
</span><a name="line-1256"></a><span class="hs-comment">-- Interface generators</span><span>
</span><a name="line-1257"></a><span class="hs-comment">--------------------------------------------------------------</span><span>
</span><a name="line-1258"></a><span>
</span><a name="line-1259"></a><span class="hs-identifier">hscSimpleIface</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-1260"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-1261"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Fingerprint</span><span>
</span><a name="line-1262"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ModIface</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ModDetails</span><span class="hs-special">)</span><span>
</span><a name="line-1263"></a><a name="hscSimpleIface"><a href="HscMain.html#hscSimpleIface"><span class="hs-identifier">hscSimpleIface</span></a></a><span> </span><a name="local-6989586621684994169"><a href="#local-6989586621684994169"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684994170"><a href="#local-6989586621684994170"><span class="hs-identifier">tc_result</span></a></a><span> </span><a name="local-6989586621684994171"><a href="#local-6989586621684994171"><span class="hs-identifier">mb_old_iface</span></a></a><span>
</span><a name="line-1264"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runHsc</span><span> </span><a href="#local-6989586621684994169"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#hscSimpleIface%27"><span class="hs-identifier hs-var">hscSimpleIface'</span></a><span> </span><a href="#local-6989586621684994170"><span class="hs-identifier hs-var">tc_result</span></a><span> </span><a href="#local-6989586621684994171"><span class="hs-identifier hs-var">mb_old_iface</span></a><span>
</span><a name="line-1265"></a><span>
</span><a name="line-1266"></a><span class="hs-identifier">hscSimpleIface'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-1267"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Fingerprint</span><span>
</span><a name="line-1268"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ModIface</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ModDetails</span><span class="hs-special">)</span><span>
</span><a name="line-1269"></a><a name="hscSimpleIface%27"><a href="HscMain.html#hscSimpleIface%27"><span class="hs-identifier">hscSimpleIface'</span></a></a><span> </span><a name="local-6989586621684994172"><a href="#local-6989586621684994172"><span class="hs-identifier">tc_result</span></a></a><span> </span><a name="local-6989586621684994173"><a href="#local-6989586621684994173"><span class="hs-identifier">mb_old_iface</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1270"></a><span>    </span><a name="local-6989586621684994174"><a href="#local-6989586621684994174"><span class="hs-identifier">hsc_env</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#getHscEnv"><span class="hs-identifier hs-var">getHscEnv</span></a><span>
</span><a name="line-1271"></a><span>    </span><a name="local-6989586621684994175"><a href="#local-6989586621684994175"><span class="hs-identifier">details</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TidyPgm.html#mkBootModDetailsTc"><span class="hs-identifier hs-var">mkBootModDetailsTc</span></a><span> </span><a href="#local-6989586621684994174"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994172"><span class="hs-identifier hs-var">tc_result</span></a><span>
</span><a name="line-1272"></a><span>    </span><a name="local-6989586621684994176"><a href="#local-6989586621684994176"><span class="hs-identifier">safe_mode</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#hscGetSafeMode"><span class="hs-identifier hs-var">hscGetSafeMode</span></a><span> </span><a href="#local-6989586621684994172"><span class="hs-identifier hs-var">tc_result</span></a><span>
</span><a name="line-1273"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684994177"><a href="#local-6989586621684994177"><span class="hs-identifier">new_iface</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684994178"><a href="#local-6989586621684994178"><span class="hs-identifier">no_change</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1274"></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;MkFinalIface&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-1275"></a><span>           </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1276"></a><span>               </span><a href="MkIface.html#mkIfaceTc"><span class="hs-identifier hs-var">mkIfaceTc</span></a><span> </span><a href="#local-6989586621684994174"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994173"><span class="hs-identifier hs-var">mb_old_iface</span></a><span> </span><a href="#local-6989586621684994176"><span class="hs-identifier hs-var">safe_mode</span></a><span> </span><a href="#local-6989586621684994175"><span class="hs-identifier hs-var">details</span></a><span> </span><a href="#local-6989586621684994172"><span class="hs-identifier hs-var">tc_result</span></a><span>
</span><a name="line-1277"></a><span>    </span><span class="hs-comment">-- And the answer is ...</span><span>
</span><a name="line-1278"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#dumpIfaceStats"><span class="hs-identifier hs-var">dumpIfaceStats</span></a><span> </span><a href="#local-6989586621684994174"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1279"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684994177"><span class="hs-identifier hs-var">new_iface</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684994178"><span class="hs-identifier hs-var">no_change</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684994175"><span class="hs-identifier hs-var">details</span></a><span class="hs-special">)</span><span>
</span><a name="line-1280"></a><span>
</span><a name="line-1281"></a><span class="hs-identifier">hscNormalIface</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-1282"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span>
</span><a name="line-1283"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Fingerprint</span><span>
</span><a name="line-1284"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ModIface</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ModDetails</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CgGuts</span><span class="hs-special">)</span><span>
</span><a name="line-1285"></a><a name="hscNormalIface"><a href="HscMain.html#hscNormalIface"><span class="hs-identifier">hscNormalIface</span></a></a><span> </span><a name="local-6989586621684994179"><a href="#local-6989586621684994179"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684994180"><a href="#local-6989586621684994180"><span class="hs-identifier">simpl_result</span></a></a><span> </span><a name="local-6989586621684994181"><a href="#local-6989586621684994181"><span class="hs-identifier">mb_old_iface</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1286"></a><span>    </span><span class="hs-identifier hs-var">runHsc</span><span> </span><a href="#local-6989586621684994179"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#hscNormalIface%27"><span class="hs-identifier hs-var">hscNormalIface'</span></a><span> </span><a href="#local-6989586621684994180"><span class="hs-identifier hs-var">simpl_result</span></a><span> </span><a href="#local-6989586621684994181"><span class="hs-identifier hs-var">mb_old_iface</span></a><span>
</span><a name="line-1287"></a><span>
</span><a name="line-1288"></a><span class="hs-identifier">hscNormalIface'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span>
</span><a name="line-1289"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Fingerprint</span><span>
</span><a name="line-1290"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ModIface</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ModDetails</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CgGuts</span><span class="hs-special">)</span><span>
</span><a name="line-1291"></a><a name="hscNormalIface%27"><a href="HscMain.html#hscNormalIface%27"><span class="hs-identifier">hscNormalIface'</span></a></a><span> </span><a name="local-6989586621684994182"><a href="#local-6989586621684994182"><span class="hs-identifier">simpl_result</span></a></a><span> </span><a name="local-6989586621684994183"><a href="#local-6989586621684994183"><span class="hs-identifier">mb_old_iface</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1292"></a><span>    </span><a name="local-6989586621684994184"><a href="#local-6989586621684994184"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#getHscEnv"><span class="hs-identifier hs-var">getHscEnv</span></a><span>
</span><a name="line-1293"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684994185"><a href="#local-6989586621684994185"><span class="hs-identifier">cg_guts</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684994186"><a href="#local-6989586621684994186"><span class="hs-identifier">details</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;CoreTidy&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-1294"></a><span>                          </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TidyPgm.html#tidyProgram"><span class="hs-identifier hs-var">tidyProgram</span></a><span> </span><a href="#local-6989586621684994184"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994182"><span class="hs-identifier hs-var">simpl_result</span></a><span>
</span><a name="line-1295"></a><span>
</span><a name="line-1296"></a><span>    </span><span class="hs-comment">-- BUILD THE NEW ModIface and ModDetails</span><span>
</span><a name="line-1297"></a><span>    </span><span class="hs-comment">--  and emit external core if necessary</span><span>
</span><a name="line-1298"></a><span>    </span><span class="hs-comment">-- This has to happen *after* code gen so that the back-end</span><span>
</span><a name="line-1299"></a><span>    </span><span class="hs-comment">-- info has been set. Not yet clear if it matters waiting</span><span>
</span><a name="line-1300"></a><span>    </span><span class="hs-comment">-- until after code output</span><span>
</span><a name="line-1301"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684994187"><a href="#local-6989586621684994187"><span class="hs-identifier">new_iface</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684994188"><a href="#local-6989586621684994188"><span class="hs-identifier">no_change</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1302"></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;MkFinalIface&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-1303"></a><span>           </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1304"></a><span>               </span><a href="MkIface.html#mkIface"><span class="hs-identifier hs-var">mkIface</span></a><span> </span><a href="#local-6989586621684994184"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994183"><span class="hs-identifier hs-var">mb_old_iface</span></a><span> </span><a href="#local-6989586621684994186"><span class="hs-identifier hs-var">details</span></a><span> </span><a href="#local-6989586621684994182"><span class="hs-identifier hs-var">simpl_result</span></a><span>
</span><a name="line-1305"></a><span>
</span><a name="line-1306"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#dumpIfaceStats"><span class="hs-identifier hs-var">dumpIfaceStats</span></a><span> </span><a href="#local-6989586621684994184"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1307"></a><span>
</span><a name="line-1308"></a><span>    </span><span class="hs-comment">-- Return the prepared code.</span><span>
</span><a name="line-1309"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684994187"><span class="hs-identifier hs-var">new_iface</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684994188"><span class="hs-identifier hs-var">no_change</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684994186"><span class="hs-identifier hs-var">details</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684994185"><span class="hs-identifier hs-var">cg_guts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1310"></a><span>
</span><a name="line-1311"></a><span class="hs-comment">--------------------------------------------------------------</span><span>
</span><a name="line-1312"></a><span class="hs-comment">-- BackEnd combinators</span><span>
</span><a name="line-1313"></a><span class="hs-comment">--------------------------------------------------------------</span><span>
</span><a name="line-1314"></a><span>
</span><a name="line-1315"></a><span class="hs-identifier">hscWriteIface</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1316"></a><a name="hscWriteIface"><a href="HscMain.html#hscWriteIface"><span class="hs-identifier">hscWriteIface</span></a></a><span> </span><a name="local-6989586621684994189"><a href="#local-6989586621684994189"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684994190"><a href="#local-6989586621684994190"><span class="hs-identifier">iface</span></a></a><span> </span><a name="local-6989586621684994191"><a href="#local-6989586621684994191"><span class="hs-identifier">no_change</span></a></a><span> </span><a name="local-6989586621684994192"><a href="#local-6989586621684994192"><span class="hs-identifier">mod_summary</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1317"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684994193"><a href="#local-6989586621684994193"><span class="hs-identifier">ifaceFile</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ml_hi_file</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ms_location</span><span> </span><a href="#local-6989586621684994192"><span class="hs-identifier hs-var">mod_summary</span></a><span class="hs-special">)</span><span>
</span><a name="line-1318"></a><span>    </span><span class="hs-identifier hs-var">unless</span><span> </span><a href="#local-6989586621684994191"><span class="hs-identifier hs-var">no_change</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1319"></a><span>        </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;writeIface&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-1320"></a><span>        </span><a href="MkIface.html#writeIfaceFile"><span class="hs-identifier hs-var">writeIfaceFile</span></a><span> </span><a href="#local-6989586621684994189"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684994193"><span class="hs-identifier hs-var">ifaceFile</span></a><span> </span><a href="#local-6989586621684994190"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-1321"></a><span>    </span><span class="hs-identifier hs-var">whenGeneratingDynamicToo</span><span> </span><a href="#local-6989586621684994189"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1322"></a><span>        </span><span class="hs-comment">-- TODO: We should do a no_change check for the dynamic</span><span>
</span><a name="line-1323"></a><span>        </span><span class="hs-comment">--       interface file too</span><span>
</span><a name="line-1324"></a><span>        </span><span class="hs-comment">-- TODO: Should handle the dynamic hi filename properly</span><span>
</span><a name="line-1325"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684994194"><a href="#local-6989586621684994194"><span class="hs-identifier">dynIfaceFile</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">replaceExtension</span><span> </span><a href="#local-6989586621684994193"><span class="hs-identifier hs-var">ifaceFile</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">dynHiSuf</span><span> </span><a href="#local-6989586621684994189"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1326"></a><span>            </span><a name="local-6989586621684994195"><a href="#local-6989586621684994195"><span class="hs-identifier">dynIfaceFile'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addBootSuffix_maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mi_boot</span><span> </span><a href="#local-6989586621684994190"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684994194"><span class="hs-identifier hs-var">dynIfaceFile</span></a><span>
</span><a name="line-1327"></a><span>            </span><a name="local-6989586621684994196"><a href="#local-6989586621684994196"><span class="hs-identifier">dynDflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dynamicTooMkDynamicDynFlags</span><span> </span><a href="#local-6989586621684994189"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1328"></a><span>        </span><a href="MkIface.html#writeIfaceFile"><span class="hs-identifier hs-var">writeIfaceFile</span></a><span> </span><a href="#local-6989586621684994196"><span class="hs-identifier hs-var">dynDflags</span></a><span> </span><a href="#local-6989586621684994195"><span class="hs-identifier hs-var">dynIfaceFile'</span></a><span> </span><a href="#local-6989586621684994190"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-1329"></a><span>
</span><a name="line-1330"></a><span class="hs-comment">-- | Compile to hard-code.</span><span>
</span><a name="line-1331"></a><span class="hs-identifier">hscGenHardCode</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CgGuts</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-1332"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">ForeignSrcLang</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1333"></a><span>               </span><span class="hs-comment">-- ^ @Just f@ &lt;=&gt; _stub.c is f</span><span>
</span><a name="line-1334"></a><a name="hscGenHardCode"><a href="HscMain.html#hscGenHardCode"><span class="hs-identifier">hscGenHardCode</span></a></a><span> </span><a name="local-6989586621684994197"><a href="#local-6989586621684994197"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684994198"><a href="#local-6989586621684994198"><span class="hs-identifier">cgguts</span></a></a><span> </span><a name="local-6989586621684994199"><a href="#local-6989586621684994199"><span class="hs-identifier">mod_summary</span></a></a><span> </span><a name="local-6989586621684994200"><a href="#local-6989586621684994200"><span class="hs-identifier">output_filename</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1335"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier hs-var">CgGuts</span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- This is the last use of the ModGuts in a compilation.</span><span>
</span><a name="line-1336"></a><span>                    </span><span class="hs-comment">-- From now on, we just use the bits we need.</span><span>
</span><a name="line-1337"></a><span>                    </span><span class="hs-identifier">cg_module</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684994201"><a href="#local-6989586621684994201"><span class="hs-identifier">this_mod</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1338"></a><span>                    </span><span class="hs-identifier">cg_binds</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684994202"><a href="#local-6989586621684994202"><span class="hs-identifier">core_binds</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1339"></a><span>                    </span><span class="hs-identifier">cg_tycons</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684994203"><a href="#local-6989586621684994203"><span class="hs-identifier">tycons</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1340"></a><span>                    </span><span class="hs-identifier">cg_foreign</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684994204"><a href="#local-6989586621684994204"><span class="hs-identifier">foreign_stubs0</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1341"></a><span>                    </span><span class="hs-identifier">cg_foreign_files</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684994205"><a href="#local-6989586621684994205"><span class="hs-identifier">foreign_files</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1342"></a><span>                    </span><span class="hs-identifier">cg_dep_pkgs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684994206"><a href="#local-6989586621684994206"><span class="hs-identifier">dependencies</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1343"></a><span>                    </span><span class="hs-identifier">cg_hpc_info</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684994207"><a href="#local-6989586621684994207"><span class="hs-identifier">hpc_info</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684994198"><span class="hs-identifier hs-var">cgguts</span></a><span>
</span><a name="line-1344"></a><span>            </span><a name="local-6989586621684994208"><a href="#local-6989586621684994208"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621684994197"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1345"></a><span>            </span><a name="local-6989586621684994209"><a href="#local-6989586621684994209"><span class="hs-identifier">location</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_location</span><span> </span><a href="#local-6989586621684994199"><span class="hs-identifier hs-var">mod_summary</span></a><span>
</span><a name="line-1346"></a><span>            </span><a name="local-6989586621684994210"><a href="#local-6989586621684994210"><span class="hs-identifier">data_tycons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-identifier hs-var">isDataTyCon</span><span> </span><a href="#local-6989586621684994203"><span class="hs-identifier hs-var">tycons</span></a><span>
</span><a name="line-1347"></a><span>            </span><span class="hs-comment">-- cg_tycons includes newtypes, for the benefit of External Core,</span><span>
</span><a name="line-1348"></a><span>            </span><span class="hs-comment">-- but we don't generate any code for newtypes</span><span>
</span><a name="line-1349"></a><span>
</span><a name="line-1350"></a><span>        </span><span class="hs-comment">-------------------</span><span>
</span><a name="line-1351"></a><span>        </span><span class="hs-comment">-- PREPARE FOR CODE GENERATION</span><span>
</span><a name="line-1352"></a><span>        </span><span class="hs-comment">-- Do saturation and convert to A-normal form</span><span>
</span><a name="line-1353"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684994211"><a href="#local-6989586621684994211"><span class="hs-identifier">prepd_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684994212"><a href="#local-6989586621684994212"><span class="hs-identifier">local_ccs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;CorePrep&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-1354"></a><span>                       </span><a href="CorePrep.html#corePrepPgm"><span class="hs-identifier hs-var">corePrepPgm</span></a><span> </span><a href="#local-6989586621684994197"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994201"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684994209"><span class="hs-identifier hs-var">location</span></a><span>
</span><a name="line-1355"></a><span>                                   </span><a href="#local-6989586621684994202"><span class="hs-identifier hs-var">core_binds</span></a><span> </span><a href="#local-6989586621684994210"><span class="hs-identifier hs-var">data_tycons</span></a><span>
</span><a name="line-1356"></a><span>        </span><span class="hs-comment">-----------------  Convert to STG ------------------</span><span>
</span><a name="line-1357"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684994213"><a href="#local-6989586621684994213"><span class="hs-identifier">stg_binds</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684994214"><a href="#local-6989586621684994214"><span class="hs-identifier">caf_ccs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684994215"><a href="#local-6989586621684994215"><span class="hs-identifier">caf_cc_stacks</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1358"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;CoreToStg&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-1359"></a><span>               </span><a href="HscMain.html#myCoreToStg"><span class="hs-identifier hs-var">myCoreToStg</span></a><span> </span><a href="#local-6989586621684994208"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684994201"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684994211"><span class="hs-identifier hs-var">prepd_binds</span></a><span>
</span><a name="line-1360"></a><span>
</span><a name="line-1361"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684994216"><a href="#local-6989586621684994216"><span class="hs-identifier">cost_centre_info</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1362"></a><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">S.toList</span><span> </span><a href="#local-6989586621684994212"><span class="hs-identifier hs-var">local_ccs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684994214"><span class="hs-identifier hs-var">caf_ccs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684994215"><span class="hs-identifier hs-var">caf_cc_stacks</span></a><span class="hs-special">)</span><span>
</span><a name="line-1363"></a><span>            </span><a name="local-6989586621684994217"><a href="#local-6989586621684994217"><span class="hs-identifier">prof_init</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ProfInit.html#profilingInitCode"><span class="hs-identifier hs-var">profilingInitCode</span></a><span> </span><a href="#local-6989586621684994201"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684994216"><span class="hs-identifier hs-var">cost_centre_info</span></a><span>
</span><a name="line-1364"></a><span>            </span><a name="local-6989586621684994218"><a href="#local-6989586621684994218"><span class="hs-identifier">foreign_stubs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684994204"><span class="hs-identifier hs-var">foreign_stubs0</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appendStubC</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684994217"><span class="hs-identifier hs-var">prof_init</span></a><span>
</span><a name="line-1365"></a><span>
</span><a name="line-1366"></a><span>        </span><span class="hs-comment">------------------  Code generation ------------------</span><span>
</span><a name="line-1367"></a><span>
</span><a name="line-1368"></a><span>        </span><span class="hs-comment">-- The back-end is streamed: each top-level function goes</span><span>
</span><a name="line-1369"></a><span>        </span><span class="hs-comment">-- from Stg all the way to asm before dealing with the next</span><span>
</span><a name="line-1370"></a><span>        </span><span class="hs-comment">-- top-level function, so showPass isn't very useful here.</span><span>
</span><a name="line-1371"></a><span>        </span><span class="hs-comment">-- Hence we have one showPass for the whole backend, the</span><span>
</span><a name="line-1372"></a><span>        </span><span class="hs-comment">-- next showPass after this will be &quot;Assembler&quot;.</span><span>
</span><a name="line-1373"></a><span>        </span><span class="hs-identifier hs-var">withTiming</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621684994208"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1374"></a><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;CodeGen&quot;</span><span class="hs-operator hs-var">&lt;+&gt;</span><span class="hs-identifier hs-var">brackets</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684994201"><span class="hs-identifier hs-var">this_mod</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1375"></a><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1376"></a><span>            </span><a name="local-6989586621684994219"><a href="#local-6989586621684994219"><span class="hs-identifier">cmms</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;StgCmm&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-1377"></a><span>                            </span><a href="HscMain.html#doCodeGen"><span class="hs-identifier hs-var">doCodeGen</span></a><span> </span><a href="#local-6989586621684994197"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994201"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684994210"><span class="hs-identifier hs-var">data_tycons</span></a><span>
</span><a name="line-1378"></a><span>                                </span><a href="#local-6989586621684994216"><span class="hs-identifier hs-var">cost_centre_info</span></a><span>
</span><a name="line-1379"></a><span>                                </span><a href="#local-6989586621684994213"><span class="hs-identifier hs-var">stg_binds</span></a><span> </span><a href="#local-6989586621684994207"><span class="hs-identifier hs-var">hpc_info</span></a><span>
</span><a name="line-1380"></a><span>
</span><a name="line-1381"></a><span>            </span><span class="hs-comment">------------------  Code output -----------------------</span><span>
</span><a name="line-1382"></a><span>            </span><a name="local-6989586621684994220"><a href="#local-6989586621684994220"><span class="hs-identifier">rawcmms0</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;cmmToRawCmm&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-1383"></a><span>                      </span><a href="CmmInfo.html#cmmToRawCmm"><span class="hs-identifier hs-var">cmmToRawCmm</span></a><span> </span><a href="#local-6989586621684994208"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684994219"><span class="hs-identifier hs-var">cmms</span></a><span>
</span><a name="line-1384"></a><span>
</span><a name="line-1385"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684994221"><a href="#local-6989586621684994221"><span class="hs-identifier">dump</span></a></a><span> </span><a name="local-6989586621684994223"><a href="#local-6989586621684994223"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621684994208"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_cmm_raw</span><span> </span><span class="hs-string">&quot;Raw Cmm&quot;</span><span>
</span><a name="line-1386"></a><span>                              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684994223"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1387"></a><span>                            </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684994223"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-1388"></a><span>                </span><a name="local-6989586621684994222"><a href="#local-6989586621684994222"><span class="hs-identifier">rawcmms1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Stream.html#mapM"><span class="hs-identifier hs-var">Stream.mapM</span></a><span> </span><a href="#local-6989586621684994221"><span class="hs-identifier hs-var">dump</span></a><span> </span><a href="#local-6989586621684994220"><span class="hs-identifier hs-var">rawcmms0</span></a><span>
</span><a name="line-1389"></a><span>
</span><a name="line-1390"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621684994224"><a href="#local-6989586621684994224"><span class="hs-identifier">output_filename</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684994225"><a href="#local-6989586621684994225"><span class="hs-identifier">_stub_h_exists</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684994226"><a href="#local-6989586621684994226"><span class="hs-identifier">stub_c_exists</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684994227"><a href="#local-6989586621684994227"><span class="hs-identifier">foreign_fps</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1391"></a><span>                </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;codeOutput&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-1392"></a><span>                  </span><a href="CodeOutput.html#codeOutput"><span class="hs-identifier hs-var">codeOutput</span></a><span> </span><a href="#local-6989586621684994208"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684994201"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684994200"><span class="hs-identifier hs-var">output_filename</span></a><span> </span><a href="#local-6989586621684994209"><span class="hs-identifier hs-var">location</span></a><span>
</span><a name="line-1393"></a><span>                  </span><a href="#local-6989586621684994218"><span class="hs-identifier hs-var">foreign_stubs</span></a><span> </span><a href="#local-6989586621684994205"><span class="hs-identifier hs-var">foreign_files</span></a><span> </span><a href="#local-6989586621684994206"><span class="hs-identifier hs-var">dependencies</span></a><span> </span><a href="#local-6989586621684994222"><span class="hs-identifier hs-var">rawcmms1</span></a><span>
</span><a name="line-1394"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684994224"><span class="hs-identifier hs-var">output_filename</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684994226"><span class="hs-identifier hs-var">stub_c_exists</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684994227"><span class="hs-identifier hs-var">foreign_fps</span></a><span class="hs-special">)</span><span>
</span><a name="line-1395"></a><span>
</span><a name="line-1396"></a><span>
</span><a name="line-1397"></a><span class="hs-identifier">hscInteractive</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-1398"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CgGuts</span><span>
</span><a name="line-1399"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span>
</span><a name="line-1400"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CompiledByteCode</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SptEntry</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1401"></a><a name="hscInteractive"><a href="HscMain.html#hscInteractive"><span class="hs-identifier">hscInteractive</span></a></a><span> </span><a name="local-6989586621684994228"><a href="#local-6989586621684994228"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684994229"><a href="#local-6989586621684994229"><span class="hs-identifier">cgguts</span></a></a><span> </span><a name="local-6989586621684994230"><a href="#local-6989586621684994230"><span class="hs-identifier">mod_summary</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1402"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684994231"><a href="#local-6989586621684994231"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621684994228"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1403"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier hs-var">CgGuts</span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- This is the last use of the ModGuts in a compilation.</span><span>
</span><a name="line-1404"></a><span>                </span><span class="hs-comment">-- From now on, we just use the bits we need.</span><span>
</span><a name="line-1405"></a><span>               </span><span class="hs-identifier">cg_module</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684994232"><a href="#local-6989586621684994232"><span class="hs-identifier">this_mod</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1406"></a><span>               </span><span class="hs-identifier">cg_binds</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684994233"><a href="#local-6989586621684994233"><span class="hs-identifier">core_binds</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1407"></a><span>               </span><span class="hs-identifier">cg_tycons</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684994234"><a href="#local-6989586621684994234"><span class="hs-identifier">tycons</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1408"></a><span>               </span><span class="hs-identifier">cg_foreign</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684994235"><a href="#local-6989586621684994235"><span class="hs-identifier">foreign_stubs</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1409"></a><span>               </span><span class="hs-identifier">cg_modBreaks</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684994236"><a href="#local-6989586621684994236"><span class="hs-identifier">mod_breaks</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1410"></a><span>               </span><span class="hs-identifier">cg_spt_entries</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684994237"><a href="#local-6989586621684994237"><span class="hs-identifier">spt_entries</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684994229"><span class="hs-identifier hs-var">cgguts</span></a><span>
</span><a name="line-1411"></a><span>
</span><a name="line-1412"></a><span>        </span><a name="local-6989586621684994238"><a href="#local-6989586621684994238"><span class="hs-identifier">location</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_location</span><span> </span><a href="#local-6989586621684994230"><span class="hs-identifier hs-var">mod_summary</span></a><span>
</span><a name="line-1413"></a><span>        </span><a name="local-6989586621684994239"><a href="#local-6989586621684994239"><span class="hs-identifier">data_tycons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-identifier hs-var">isDataTyCon</span><span> </span><a href="#local-6989586621684994234"><span class="hs-identifier hs-var">tycons</span></a><span>
</span><a name="line-1414"></a><span>        </span><span class="hs-comment">-- cg_tycons includes newtypes, for the benefit of External Core,</span><span>
</span><a name="line-1415"></a><span>        </span><span class="hs-comment">-- but we don't generate any code for newtypes</span><span>
</span><a name="line-1416"></a><span>
</span><a name="line-1417"></a><span>    </span><span class="hs-comment">-------------------</span><span>
</span><a name="line-1418"></a><span>    </span><span class="hs-comment">-- PREPARE FOR CODE GENERATION</span><span>
</span><a name="line-1419"></a><span>    </span><span class="hs-comment">-- Do saturation and convert to A-normal form</span><span>
</span><a name="line-1420"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684994240"><a href="#local-6989586621684994240"><span class="hs-identifier">prepd_binds</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;CorePrep&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-1421"></a><span>                   </span><a href="CorePrep.html#corePrepPgm"><span class="hs-identifier hs-var">corePrepPgm</span></a><span> </span><a href="#local-6989586621684994228"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994232"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684994238"><span class="hs-identifier hs-var">location</span></a><span> </span><a href="#local-6989586621684994233"><span class="hs-identifier hs-var">core_binds</span></a><span> </span><a href="#local-6989586621684994239"><span class="hs-identifier hs-var">data_tycons</span></a><span>
</span><a name="line-1422"></a><span>    </span><span class="hs-comment">-----------------  Generate byte code ------------------</span><span>
</span><a name="line-1423"></a><span>    </span><a name="local-6989586621684994241"><a href="#local-6989586621684994241"><span class="hs-identifier">comp_bc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#byteCodeGen"><span class="hs-identifier hs-var">byteCodeGen</span></a><span> </span><a href="#local-6989586621684994228"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994232"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684994240"><span class="hs-identifier hs-var">prepd_binds</span></a><span> </span><a href="#local-6989586621684994239"><span class="hs-identifier hs-var">data_tycons</span></a><span> </span><a href="#local-6989586621684994236"><span class="hs-identifier hs-var">mod_breaks</span></a><span>
</span><a name="line-1424"></a><span>    </span><span class="hs-comment">------------------ Create f-x-dynamic C-side stuff -----</span><span>
</span><a name="line-1425"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684994242"><a href="#local-6989586621684994242"><span class="hs-identifier">_istub_h_exists</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684994243"><a href="#local-6989586621684994243"><span class="hs-identifier">istub_c_exists</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1426"></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CodeOutput.html#outputForeignStubs"><span class="hs-identifier hs-var">outputForeignStubs</span></a><span> </span><a href="#local-6989586621684994231"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684994232"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684994238"><span class="hs-identifier hs-var">location</span></a><span> </span><a href="#local-6989586621684994235"><span class="hs-identifier hs-var">foreign_stubs</span></a><span>
</span><a name="line-1427"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684994243"><span class="hs-identifier hs-var">istub_c_exists</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684994241"><span class="hs-identifier hs-var">comp_bc</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684994237"><span class="hs-identifier hs-var">spt_entries</span></a><span class="hs-special">)</span><span>
</span><a name="line-1428"></a><span>
</span><a name="line-1429"></a><span class="hs-comment">------------------------------</span><span>
</span><a name="line-1430"></a><span>
</span><a name="line-1431"></a><span class="hs-identifier">hscCompileCmmFile</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1432"></a><a name="hscCompileCmmFile"><a href="HscMain.html#hscCompileCmmFile"><span class="hs-identifier">hscCompileCmmFile</span></a></a><span> </span><a name="local-6989586621684994244"><a href="#local-6989586621684994244"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684994245"><a href="#local-6989586621684994245"><span class="hs-identifier">filename</span></a></a><span> </span><a name="local-6989586621684994246"><a href="#local-6989586621684994246"><span class="hs-identifier">output_filename</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runHsc</span><span> </span><a href="#local-6989586621684994244"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1433"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684994248"><a href="#local-6989586621684994248"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621684994244"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1434"></a><span>    </span><a name="local-6989586621684994249"><a href="#local-6989586621684994249"><span class="hs-identifier">cmm</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#ioMsgMaybe"><span class="hs-identifier hs-var">ioMsgMaybe</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmParse.html#parseCmmFile"><span class="hs-identifier hs-var">parseCmmFile</span></a><span> </span><a href="#local-6989586621684994248"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684994245"><span class="hs-identifier hs-var">filename</span></a><span>
</span><a name="line-1435"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1436"></a><span>        </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621684994248"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_cmm_verbose</span><span> </span><span class="hs-string">&quot;Parsed Cmm&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684994249"><span class="hs-identifier hs-var">cmm</span></a><span class="hs-special">)</span><span>
</span><a name="line-1437"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- Make up a module name to give the NCG. We can't pass bottom here</span><span>
</span><a name="line-1438"></a><span>            </span><span class="hs-comment">-- lest we reproduce #11784.</span><span>
</span><a name="line-1439"></a><span>            </span><a name="local-6989586621684994250"><a href="#local-6989586621684994250"><span class="hs-identifier">mod_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkModuleName</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Cmm$&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">FilePath.takeFileName</span><span> </span><a href="#local-6989586621684994245"><span class="hs-identifier hs-var">filename</span></a><span>
</span><a name="line-1440"></a><span>            </span><a name="local-6989586621684994251"><a href="#local-6989586621684994251"><span class="hs-identifier">cmm_mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkModule</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">thisPackage</span><span> </span><a href="#local-6989586621684994248"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684994250"><span class="hs-identifier hs-var">mod_name</span></a><span>
</span><a name="line-1441"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684994252"><a href="#local-6989586621684994252"><span class="hs-identifier">cmmgroup</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CmmPipeline.html#cmmPipeline"><span class="hs-identifier hs-var">cmmPipeline</span></a><span> </span><a href="#local-6989586621684994244"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#emptySRT"><span class="hs-identifier hs-var">emptySRT</span></a><span> </span><a href="#local-6989586621684994251"><span class="hs-identifier hs-var">cmm_mod</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684994249"><span class="hs-identifier hs-var">cmm</span></a><span>
</span><a name="line-1442"></a><span>        </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621684994248"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_cmm</span><span> </span><span class="hs-string">&quot;Output Cmm&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684994252"><span class="hs-identifier hs-var">cmmgroup</span></a><span class="hs-special">)</span><span>
</span><a name="line-1443"></a><span>        </span><a name="local-6989586621684994253"><a href="#local-6989586621684994253"><span class="hs-identifier">rawCmms</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CmmInfo.html#cmmToRawCmm"><span class="hs-identifier hs-var">cmmToRawCmm</span></a><span> </span><a href="#local-6989586621684994248"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="Stream.html#yield"><span class="hs-identifier hs-var">Stream.yield</span></a><span> </span><a href="#local-6989586621684994252"><span class="hs-identifier hs-var">cmmgroup</span></a><span class="hs-special">)</span><span>
</span><a name="line-1444"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CodeOutput.html#codeOutput"><span class="hs-identifier hs-var">codeOutput</span></a><span> </span><a href="#local-6989586621684994248"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684994251"><span class="hs-identifier hs-var">cmm_mod</span></a><span> </span><a href="#local-6989586621684994246"><span class="hs-identifier hs-var">output_filename</span></a><span> </span><a href="#local-6989586621684994247"><span class="hs-identifier hs-var">no_loc</span></a><span> </span><span class="hs-identifier hs-var">NoStubs</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1445"></a><span>             </span><a href="#local-6989586621684994253"><span class="hs-identifier hs-var">rawCmms</span></a><span>
</span><a name="line-1446"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1447"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1448"></a><span>    </span><a name="local-6989586621684994247"><a href="#local-6989586621684994247"><span class="hs-identifier">no_loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ModLocation</span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ml_hs_file</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621684994245"><span class="hs-identifier hs-var">filename</span></a><span class="hs-special">,</span><span>
</span><a name="line-1449"></a><span>                          </span><span class="hs-identifier">ml_hi_file</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;hscCompileCmmFile: no hi file&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-1450"></a><span>                          </span><span class="hs-identifier">ml_obj_file</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;hscCompileCmmFile: no obj file&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-1451"></a><span>                          </span><span class="hs-identifier">ml_hie_file</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;hscCompileCmmFile: no hie file&quot;</span><span class="hs-special">}</span><span>
</span><a name="line-1452"></a><span>
</span><a name="line-1453"></a><span class="hs-comment">-------------------- Stuff for new code gen ---------------------</span><span>
</span><a name="line-1454"></a><span>
</span><a name="line-1455"></a><span class="hs-identifier">doCodeGen</span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyCon</span><span class="hs-special">]</span><span>
</span><a name="line-1456"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CollectedCCs</span><span>
</span><a name="line-1457"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgTopBinding"><span class="hs-identifier hs-type">StgTopBinding</span></a><span class="hs-special">]</span><span>
</span><a name="line-1458"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HpcInfo</span><span>
</span><a name="line-1459"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="Stream.html#Stream"><span class="hs-identifier hs-type">Stream</span></a><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Cmm.html#CmmGroup"><span class="hs-identifier hs-type">CmmGroup</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1460"></a><span>         </span><span class="hs-comment">-- Note we produce a 'Stream' of CmmGroups, so that the</span><span>
</span><a name="line-1461"></a><span>         </span><span class="hs-comment">-- backend can be run incrementally.  Otherwise it generates all</span><span>
</span><a name="line-1462"></a><span>         </span><span class="hs-comment">-- the C-- up front, which has a significant space cost.</span><span>
</span><a name="line-1463"></a><a name="doCodeGen"><a href="HscMain.html#doCodeGen"><span class="hs-identifier">doCodeGen</span></a></a><span> </span><a name="local-6989586621684994254"><a href="#local-6989586621684994254"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684994255"><a href="#local-6989586621684994255"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621684994256"><a href="#local-6989586621684994256"><span class="hs-identifier">data_tycons</span></a></a><span>
</span><a name="line-1464"></a><span>              </span><a name="local-6989586621684994257"><a href="#local-6989586621684994257"><span class="hs-identifier">cost_centre_info</span></a></a><span> </span><a name="local-6989586621684994258"><a href="#local-6989586621684994258"><span class="hs-identifier">stg_binds</span></a></a><span> </span><a name="local-6989586621684994259"><a href="#local-6989586621684994259"><span class="hs-identifier">hpc_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1465"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684994260"><a href="#local-6989586621684994260"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621684994254"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1466"></a><span>
</span><a name="line-1467"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684994261"><a href="#local-6989586621684994261"><span class="hs-identifier">stg_binds_w_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgFVs.html#annTopBindingsFreeVars"><span class="hs-identifier hs-var">annTopBindingsFreeVars</span></a><span> </span><a href="#local-6989586621684994258"><span class="hs-identifier hs-var">stg_binds</span></a><span>
</span><a name="line-1468"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">cmm_stream</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Stream.html#Stream"><span class="hs-identifier hs-type">Stream</span></a><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Cmm.html#CmmGroup"><span class="hs-identifier hs-type">CmmGroup</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1469"></a><span>        </span><a name="local-6989586621684994262"><a href="#local-6989586621684994262"><span class="hs-identifier">cmm_stream</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;StgCmm&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-1470"></a><span>            </span><a href="StgCmm.html#codeGen"><span class="hs-identifier hs-var">StgCmm.codeGen</span></a><span> </span><a href="#local-6989586621684994260"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684994255"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684994256"><span class="hs-identifier hs-var">data_tycons</span></a><span>
</span><a name="line-1471"></a><span>                           </span><a href="#local-6989586621684994257"><span class="hs-identifier hs-var">cost_centre_info</span></a><span> </span><a href="#local-6989586621684994261"><span class="hs-identifier hs-var">stg_binds_w_fvs</span></a><span> </span><a href="#local-6989586621684994259"><span class="hs-identifier hs-var">hpc_info</span></a><span>
</span><a name="line-1472"></a><span>
</span><a name="line-1473"></a><span>        </span><span class="hs-comment">-- codegen consumes a stream of CmmGroup, and produces a new</span><span>
</span><a name="line-1474"></a><span>        </span><span class="hs-comment">-- stream of CmmGroup (not necessarily synchronised: one</span><span>
</span><a name="line-1475"></a><span>        </span><span class="hs-comment">-- CmmGroup on input may produce many CmmGroups on output due</span><span>
</span><a name="line-1476"></a><span>        </span><span class="hs-comment">-- to proc-point splitting).</span><span>
</span><a name="line-1477"></a><span>
</span><a name="line-1478"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684994263"><a href="#local-6989586621684994263"><span class="hs-identifier">dump1</span></a></a><span> </span><a name="local-6989586621684994265"><a href="#local-6989586621684994265"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621684994260"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_cmm_from_stg</span><span>
</span><a name="line-1479"></a><span>                       </span><span class="hs-string">&quot;Cmm produced by codegen&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684994265"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1480"></a><span>                     </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684994265"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-1481"></a><span>
</span><a name="line-1482"></a><span>        </span><a name="local-6989586621684994264"><a href="#local-6989586621684994264"><span class="hs-identifier">ppr_stream1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Stream.html#mapM"><span class="hs-identifier hs-var">Stream.mapM</span></a><span> </span><a href="#local-6989586621684994263"><span class="hs-identifier hs-var">dump1</span></a><span> </span><a href="#local-6989586621684994262"><span class="hs-identifier hs-var">cmm_stream</span></a><span>
</span><a name="line-1483"></a><span>
</span><a name="line-1484"></a><span>    </span><span class="hs-comment">-- We are building a single SRT for the entire module, so</span><span>
</span><a name="line-1485"></a><span>    </span><span class="hs-comment">-- we must thread it through all the procedures as we cps-convert them.</span><span>
</span><a name="line-1486"></a><span>    </span><a name="local-6989586621684994266"><a href="#local-6989586621684994266"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mkSplitUniqSupply</span><span> </span><span class="hs-char">'S'</span><span>
</span><a name="line-1487"></a><span>
</span><a name="line-1488"></a><span>    </span><span class="hs-comment">-- When splitting, we generate one SRT per split chunk, otherwise</span><span>
</span><a name="line-1489"></a><span>    </span><span class="hs-comment">-- we generate one SRT for the whole module.</span><span>
</span><a name="line-1490"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-1491"></a><span>     </span><a name="local-6989586621684994267"><a href="#local-6989586621684994267"><span class="hs-identifier">pipeline_stream</span></a></a><span>
</span><a name="line-1492"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_SplitObjs</span><span> </span><a href="#local-6989586621684994260"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_SplitSections</span><span> </span><a href="#local-6989586621684994260"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-1493"></a><span>        </span><span class="hs-identifier hs-var">osSubsectionsViaSymbols</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">platformOS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621684994260"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1494"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;cmmPipeline&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-1495"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684994268"><a href="#local-6989586621684994268"><span class="hs-identifier">run_pipeline</span></a></a><span> </span><a name="local-6989586621684994269"><a href="#local-6989586621684994269"><span class="hs-identifier">us</span></a></a><span> </span><a name="local-6989586621684994270"><a href="#local-6989586621684994270"><span class="hs-identifier">cmmgroup</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1496"></a><span>                </span><span class="hs-special">(</span><a name="local-6989586621684994271"><a href="#local-6989586621684994271"><span class="hs-identifier">_topSRT</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684994272"><a href="#local-6989586621684994272"><span class="hs-identifier">cmmgroup</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-1497"></a><span>                  </span><a href="CmmPipeline.html#cmmPipeline"><span class="hs-identifier hs-var">cmmPipeline</span></a><span> </span><a href="#local-6989586621684994254"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#emptySRT"><span class="hs-identifier hs-var">emptySRT</span></a><span> </span><a href="#local-6989586621684994255"><span class="hs-identifier hs-var">this_mod</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684994270"><span class="hs-identifier hs-var">cmmgroup</span></a><span>
</span><a name="line-1498"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684994269"><span class="hs-identifier hs-var">us</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684994272"><span class="hs-identifier hs-var">cmmgroup</span></a><span class="hs-special">)</span><span>
</span><a name="line-1499"></a><span>
</span><a name="line-1500"></a><span>          </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Stream.html#mapAccumL"><span class="hs-identifier hs-var">Stream.mapAccumL</span></a><span> </span><a href="#local-6989586621684994268"><span class="hs-identifier hs-var">run_pipeline</span></a><span> </span><a href="#local-6989586621684994266"><span class="hs-identifier hs-var">us</span></a><span> </span><a href="#local-6989586621684994264"><span class="hs-identifier hs-var">ppr_stream1</span></a><span>
</span><a name="line-1501"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1502"></a><span>
</span><a name="line-1503"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1504"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;cmmPipeline&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-1505"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684994273"><a href="#local-6989586621684994273"><span class="hs-identifier">run_pipeline</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmPipeline.html#cmmPipeline"><span class="hs-identifier hs-var">cmmPipeline</span></a><span> </span><a href="#local-6989586621684994254"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1506"></a><span>          </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Stream.html#mapAccumL"><span class="hs-identifier hs-var">Stream.mapAccumL</span></a><span> </span><a href="#local-6989586621684994273"><span class="hs-identifier hs-var">run_pipeline</span></a><span> </span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#emptySRT"><span class="hs-identifier hs-var">emptySRT</span></a><span> </span><a href="#local-6989586621684994255"><span class="hs-identifier hs-var">this_mod</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684994264"><span class="hs-identifier hs-var">ppr_stream1</span></a><span>
</span><a name="line-1507"></a><span>
</span><a name="line-1508"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-1509"></a><span>        </span><a name="local-6989586621684994274"><a href="#local-6989586621684994274"><span class="hs-identifier">dump2</span></a></a><span> </span><a name="local-6989586621684994276"><a href="#local-6989586621684994276"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621684994260"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_cmm</span><span>
</span><a name="line-1510"></a><span>                        </span><span class="hs-string">&quot;Output Cmm&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684994276"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1511"></a><span>                     </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684994276"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-1512"></a><span>
</span><a name="line-1513"></a><span>        </span><a name="local-6989586621684994275"><a href="#local-6989586621684994275"><span class="hs-identifier">ppr_stream2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Stream.html#mapM"><span class="hs-identifier hs-var">Stream.mapM</span></a><span> </span><a href="#local-6989586621684994274"><span class="hs-identifier hs-var">dump2</span></a><span> </span><a href="#local-6989586621684994267"><span class="hs-identifier hs-var">pipeline_stream</span></a><span>
</span><a name="line-1514"></a><span>
</span><a name="line-1515"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684994275"><span class="hs-identifier hs-var">ppr_stream2</span></a><span>
</span><a name="line-1516"></a><span>
</span><a name="line-1517"></a><span>
</span><a name="line-1518"></a><span>
</span><a name="line-1519"></a><span class="hs-identifier">myCoreToStg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span>
</span><a name="line-1520"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgTopBinding"><span class="hs-identifier hs-type">StgTopBinding</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- output program</span><span>
</span><a name="line-1521"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CollectedCCs</span><span> </span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- CAF cost centre info (declared and used)</span><span>
</span><a name="line-1522"></a><a name="myCoreToStg"><a href="HscMain.html#myCoreToStg"><span class="hs-identifier">myCoreToStg</span></a></a><span> </span><a name="local-6989586621684994277"><a href="#local-6989586621684994277"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684994278"><a href="#local-6989586621684994278"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621684994279"><a href="#local-6989586621684994279"><span class="hs-identifier">prepd_binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1523"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684994280"><a href="#local-6989586621684994280"><span class="hs-identifier">stg_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684994281"><a href="#local-6989586621684994281"><span class="hs-identifier">cost_centre_info</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1524"></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;Core2Stg&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-1525"></a><span>           </span><a href="CoreToStg.html#coreToStg"><span class="hs-identifier hs-var">coreToStg</span></a><span> </span><a href="#local-6989586621684994277"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684994278"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684994279"><span class="hs-identifier hs-var">prepd_binds</span></a><span>
</span><a name="line-1526"></a><span>
</span><a name="line-1527"></a><span>    </span><a name="local-6989586621684994282"><a href="#local-6989586621684994282"><span class="hs-identifier">stg_binds2</span></a></a><span>
</span><a name="line-1528"></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;Stg2Stg&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-1529"></a><span>           </span><a href="SimplStg.html#stg2stg"><span class="hs-identifier hs-var">stg2stg</span></a><span> </span><a href="#local-6989586621684994277"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684994278"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684994280"><span class="hs-identifier hs-var">stg_binds</span></a><span>
</span><a name="line-1530"></a><span>
</span><a name="line-1531"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684994282"><span class="hs-identifier hs-var">stg_binds2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684994281"><span class="hs-identifier hs-var">cost_centre_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-1532"></a><span>
</span><a name="line-1533"></a><span>
</span><a name="line-1534"></a><span class="hs-comment">{- **********************************************************************
%*                                                                      *
\subsection{Compiling a do-statement}
%*                                                                      *
%********************************************************************* -}</span><span>
</span><a name="line-1539"></a><span>
</span><a name="line-1540"></a><span class="hs-comment">{-
When the UnlinkedBCOExpr is linked you get an HValue of type *IO [HValue]* When
you run it you get a list of HValues that should be the same length as the list
of names; add them to the ClosureEnv.

A naked expression returns a singleton Name [it]. The stmt is lifted into the
IO monad as explained in Note [Interactively-bound Ids in GHCi] in HscTypes
-}</span><span>
</span><a name="line-1548"></a><span>
</span><a name="line-1549"></a><span class="hs-comment">-- | Compile a stmt all the way to an HValue, but don't run it</span><span>
</span><a name="line-1550"></a><span class="hs-comment">--</span><span>
</span><a name="line-1551"></a><span class="hs-comment">-- We return Nothing to indicate an empty statement (or comment only), not a</span><span>
</span><a name="line-1552"></a><span class="hs-comment">-- parse error.</span><span>
</span><a name="line-1553"></a><span class="hs-identifier">hscStmt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FixityEnv</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1554"></a><a name="hscStmt"><a href="HscMain.html#hscStmt"><span class="hs-identifier">hscStmt</span></a></a><span> </span><a name="local-6989586621684994283"><a href="#local-6989586621684994283"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684994284"><a href="#local-6989586621684994284"><span class="hs-identifier">stmt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HscMain.html#hscStmtWithLocation"><span class="hs-identifier hs-var">hscStmtWithLocation</span></a><span> </span><a href="#local-6989586621684994283"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994284"><span class="hs-identifier hs-var">stmt</span></a><span> </span><span class="hs-string">&quot;&lt;interactive&gt;&quot;</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-1555"></a><span>
</span><a name="line-1556"></a><span class="hs-comment">-- | Compile a stmt all the way to an HValue, but don't run it</span><span>
</span><a name="line-1557"></a><span class="hs-comment">--</span><span>
</span><a name="line-1558"></a><span class="hs-comment">-- We return Nothing to indicate an empty statement (or comment only), not a</span><span>
</span><a name="line-1559"></a><span class="hs-comment">-- parse error.</span><span>
</span><a name="line-1560"></a><span class="hs-identifier">hscStmtWithLocation</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-1561"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-comment">-- ^ The statement</span><span>
</span><a name="line-1562"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-comment">-- ^ The source</span><span>
</span><a name="line-1563"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>    </span><span class="hs-comment">-- ^ Starting line</span><span>
</span><a name="line-1564"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>
</span><a name="line-1565"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span> </span><span class="hs-comment">{- IO [HValue] -}</span><span>
</span><a name="line-1566"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FixityEnv</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1567"></a><a name="hscStmtWithLocation"><a href="HscMain.html#hscStmtWithLocation"><span class="hs-identifier">hscStmtWithLocation</span></a></a><span> </span><a name="local-6989586621684994285"><a href="#local-6989586621684994285"><span class="hs-identifier">hsc_env0</span></a></a><span> </span><a name="local-6989586621684994286"><a href="#local-6989586621684994286"><span class="hs-identifier">stmt</span></a></a><span> </span><a name="local-6989586621684994287"><a href="#local-6989586621684994287"><span class="hs-identifier">source</span></a></a><span> </span><a name="local-6989586621684994288"><a href="#local-6989586621684994288"><span class="hs-identifier">linenumber</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1568"></a><span>  </span><span class="hs-identifier hs-var">runInteractiveHsc</span><span> </span><a href="#local-6989586621684994285"><span class="hs-identifier hs-var">hsc_env0</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1569"></a><span>    </span><a name="local-6989586621684994289"><a href="#local-6989586621684994289"><span class="hs-identifier">maybe_stmt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#hscParseStmtWithLocation"><span class="hs-identifier hs-var">hscParseStmtWithLocation</span></a><span> </span><a href="#local-6989586621684994287"><span class="hs-identifier hs-var">source</span></a><span> </span><a href="#local-6989586621684994288"><span class="hs-identifier hs-var">linenumber</span></a><span> </span><a href="#local-6989586621684994286"><span class="hs-identifier hs-var">stmt</span></a><span>
</span><a name="line-1570"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684994289"><span class="hs-identifier hs-var">maybe_stmt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1571"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1572"></a><span>
</span><a name="line-1573"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684994290"><a href="#local-6989586621684994290"><span class="hs-identifier">parsed_stmt</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1574"></a><span>        </span><a name="local-6989586621684994291"><a href="#local-6989586621684994291"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#getHscEnv"><span class="hs-identifier hs-var">getHscEnv</span></a><span>
</span><a name="line-1575"></a><span>        </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#hscParsedStmt"><span class="hs-identifier hs-var">hscParsedStmt</span></a><span> </span><a href="#local-6989586621684994291"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994290"><span class="hs-identifier hs-var">parsed_stmt</span></a><span>
</span><a name="line-1576"></a><span>
</span><a name="line-1577"></a><span class="hs-identifier">hscParsedStmt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-1578"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">GhciLStmt</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>  </span><span class="hs-comment">-- ^ The parsed statement</span><span>
</span><a name="line-1579"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>
</span><a name="line-1580"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span> </span><span class="hs-comment">{- IO [HValue] -}</span><span>
</span><a name="line-1581"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FixityEnv</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1582"></a><a name="hscParsedStmt"><a href="HscMain.html#hscParsedStmt"><span class="hs-identifier">hscParsedStmt</span></a></a><span> </span><a name="local-6989586621684994292"><a href="#local-6989586621684994292"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684994293"><a href="#local-6989586621684994293"><span class="hs-identifier">stmt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runInteractiveHsc</span><span> </span><a href="#local-6989586621684994292"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1583"></a><span>  </span><span class="hs-comment">-- Rename and typecheck it</span><span>
</span><a name="line-1584"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621684994294"><a href="#local-6989586621684994294"><span class="hs-identifier">ids</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684994295"><a href="#local-6989586621684994295"><span class="hs-identifier">tc_expr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684994296"><a href="#local-6989586621684994296"><span class="hs-identifier">fix_env</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#ioMsgMaybe"><span class="hs-identifier hs-var">ioMsgMaybe</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnDriver.html#tcRnStmt"><span class="hs-identifier hs-var">tcRnStmt</span></a><span> </span><a href="#local-6989586621684994292"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994293"><span class="hs-identifier hs-var">stmt</span></a><span>
</span><a name="line-1585"></a><span>
</span><a name="line-1586"></a><span>  </span><span class="hs-comment">-- Desugar it</span><span>
</span><a name="line-1587"></a><span>  </span><a name="local-6989586621684994297"><a href="#local-6989586621684994297"><span class="hs-identifier">ds_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#ioMsgMaybe"><span class="hs-identifier hs-var">ioMsgMaybe</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Desugar.html#deSugarExpr"><span class="hs-identifier hs-var">deSugarExpr</span></a><span> </span><a href="#local-6989586621684994292"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994295"><span class="hs-identifier hs-var">tc_expr</span></a><span>
</span><a name="line-1588"></a><span>  </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><a href="CoreLint.html#lintInteractiveExpr"><span class="hs-identifier hs-var">lintInteractiveExpr</span></a><span> </span><span class="hs-string">&quot;desugar expression&quot;</span><span> </span><a href="#local-6989586621684994292"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994297"><span class="hs-identifier hs-var">ds_expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1589"></a><span>  </span><a href="HscMain.html#handleWarnings"><span class="hs-identifier hs-var">handleWarnings</span></a><span>
</span><a name="line-1590"></a><span>
</span><a name="line-1591"></a><span>  </span><span class="hs-comment">-- Then code-gen, and link it</span><span>
</span><a name="line-1592"></a><span>  </span><span class="hs-comment">-- It's important NOT to have package 'interactive' as thisUnitId</span><span>
</span><a name="line-1593"></a><span>  </span><span class="hs-comment">-- for linking, else we try to link 'main' and can't find it.</span><span>
</span><a name="line-1594"></a><span>  </span><span class="hs-comment">-- Whereas the linker already knows to ignore 'interactive'</span><span>
</span><a name="line-1595"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684994298"><a href="#local-6989586621684994298"><span class="hs-identifier">src_span</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">srcLocSpan</span><span> </span><span class="hs-identifier hs-var">interactiveSrcLoc</span><span>
</span><a name="line-1596"></a><span>  </span><a name="local-6989586621684994299"><a href="#local-6989586621684994299"><span class="hs-identifier">hval</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#hscCompileCoreExpr"><span class="hs-identifier hs-var">hscCompileCoreExpr</span></a><span> </span><a href="#local-6989586621684994292"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994298"><span class="hs-identifier hs-var">src_span</span></a><span> </span><a href="#local-6989586621684994297"><span class="hs-identifier hs-var">ds_expr</span></a><span>
</span><a name="line-1597"></a><span>
</span><a name="line-1598"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684994294"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684994299"><span class="hs-identifier hs-var">hval</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684994296"><span class="hs-identifier hs-var">fix_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1599"></a><span>
</span><a name="line-1600"></a><span class="hs-comment">-- | Compile a decls</span><span>
</span><a name="line-1601"></a><span class="hs-identifier">hscDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-1602"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-comment">-- ^ The statement</span><span>
</span><a name="line-1603"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyThing</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">InteractiveContext</span><span class="hs-special">)</span><span>
</span><a name="line-1604"></a><a name="hscDecls"><a href="HscMain.html#hscDecls"><span class="hs-identifier">hscDecls</span></a></a><span> </span><a name="local-6989586621684994300"><a href="#local-6989586621684994300"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684994301"><a href="#local-6989586621684994301"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HscMain.html#hscDeclsWithLocation"><span class="hs-identifier hs-var">hscDeclsWithLocation</span></a><span> </span><a href="#local-6989586621684994300"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994301"><span class="hs-identifier hs-var">str</span></a><span> </span><span class="hs-string">&quot;&lt;interactive&gt;&quot;</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-1605"></a><span>
</span><a name="line-1606"></a><span class="hs-identifier">hscParseDeclsWithLocation</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span>
</span><a name="line-1607"></a><a name="hscParseDeclsWithLocation"><a href="HscMain.html#hscParseDeclsWithLocation"><span class="hs-identifier">hscParseDeclsWithLocation</span></a></a><span> </span><a name="local-6989586621684994302"><a href="#local-6989586621684994302"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684994303"><a href="#local-6989586621684994303"><span class="hs-identifier">source</span></a></a><span> </span><a name="local-6989586621684994304"><a href="#local-6989586621684994304"><span class="hs-identifier">line_num</span></a></a><span> </span><a name="local-6989586621684994305"><a href="#local-6989586621684994305"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1608"></a><span>    </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsModule</span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsmodDecls</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684994306"><a href="#local-6989586621684994306"><span class="hs-identifier">decls</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-1609"></a><span>      </span><span class="hs-identifier hs-var">runInteractiveHsc</span><span> </span><a href="#local-6989586621684994302"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1610"></a><span>        </span><a href="HscMain.html#hscParseThingWithLocation"><span class="hs-identifier hs-var">hscParseThingWithLocation</span></a><span> </span><a href="#local-6989586621684994303"><span class="hs-identifier hs-var">source</span></a><span> </span><a href="#local-6989586621684994304"><span class="hs-identifier hs-var">line_num</span></a><span> </span><span class="hs-identifier hs-var">parseModule</span><span> </span><a href="#local-6989586621684994305"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-1611"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684994306"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-1612"></a><span>
</span><a name="line-1613"></a><span class="hs-comment">-- | Compile a decls</span><span>
</span><a name="line-1614"></a><span class="hs-identifier">hscDeclsWithLocation</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-1615"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-comment">-- ^ The statement</span><span>
</span><a name="line-1616"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-comment">-- ^ The source</span><span>
</span><a name="line-1617"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>    </span><span class="hs-comment">-- ^ Starting line</span><span>
</span><a name="line-1618"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyThing</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">InteractiveContext</span><span class="hs-special">)</span><span>
</span><a name="line-1619"></a><a name="hscDeclsWithLocation"><a href="HscMain.html#hscDeclsWithLocation"><span class="hs-identifier">hscDeclsWithLocation</span></a></a><span> </span><a name="local-6989586621684994307"><a href="#local-6989586621684994307"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684994308"><a href="#local-6989586621684994308"><span class="hs-identifier">str</span></a></a><span> </span><a name="local-6989586621684994309"><a href="#local-6989586621684994309"><span class="hs-identifier">source</span></a></a><span> </span><a name="local-6989586621684994310"><a href="#local-6989586621684994310"><span class="hs-identifier">linenumber</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1620"></a><span>    </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsModule</span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsmodDecls</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684994311"><a href="#local-6989586621684994311"><span class="hs-identifier">decls</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-1621"></a><span>      </span><span class="hs-identifier hs-var">runInteractiveHsc</span><span> </span><a href="#local-6989586621684994307"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1622"></a><span>        </span><a href="HscMain.html#hscParseThingWithLocation"><span class="hs-identifier hs-var">hscParseThingWithLocation</span></a><span> </span><a href="#local-6989586621684994309"><span class="hs-identifier hs-var">source</span></a><span> </span><a href="#local-6989586621684994310"><span class="hs-identifier hs-var">linenumber</span></a><span> </span><span class="hs-identifier hs-var">parseModule</span><span> </span><a href="#local-6989586621684994308"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-1623"></a><span>    </span><a href="HscMain.html#hscParsedDecls"><span class="hs-identifier hs-var">hscParsedDecls</span></a><span> </span><a href="#local-6989586621684994307"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994311"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-1624"></a><span>
</span><a name="line-1625"></a><span class="hs-identifier">hscParsedDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyThing</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">InteractiveContext</span><span class="hs-special">)</span><span>
</span><a name="line-1626"></a><a name="hscParsedDecls"><a href="HscMain.html#hscParsedDecls"><span class="hs-identifier">hscParsedDecls</span></a></a><span> </span><a name="local-6989586621684994312"><a href="#local-6989586621684994312"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684994313"><a href="#local-6989586621684994313"><span class="hs-identifier">decls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runInteractiveHsc</span><span> </span><a href="#local-6989586621684994312"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1627"></a><span>    </span><span class="hs-comment">{- Rename and typecheck it -}</span><span>
</span><a name="line-1628"></a><span>    </span><a name="local-6989586621684994314"><a href="#local-6989586621684994314"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#getHscEnv"><span class="hs-identifier hs-var">getHscEnv</span></a><span>
</span><a name="line-1629"></a><span>    </span><a name="local-6989586621684994315"><a href="#local-6989586621684994315"><span class="hs-identifier">tc_gblenv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#ioMsgMaybe"><span class="hs-identifier hs-var">ioMsgMaybe</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnDriver.html#tcRnDeclsi"><span class="hs-identifier hs-var">tcRnDeclsi</span></a><span> </span><a href="#local-6989586621684994314"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994313"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-1630"></a><span>
</span><a name="line-1631"></a><span>    </span><span class="hs-comment">{- Grab the new instances -}</span><span>
</span><a name="line-1632"></a><span>    </span><span class="hs-comment">-- We grab the whole environment because of the overlapping that may have</span><span>
</span><a name="line-1633"></a><span>    </span><span class="hs-comment">-- been done. See the notes at the definition of InteractiveContext</span><span>
</span><a name="line-1634"></a><span>    </span><span class="hs-comment">-- (ic_instances) for more details.</span><span>
</span><a name="line-1635"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684994316"><a href="#local-6989586621684994316"><span class="hs-identifier">defaults</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_default</span><span> </span><a href="#local-6989586621684994315"><span class="hs-identifier hs-var">tc_gblenv</span></a><span>
</span><a name="line-1636"></a><span>
</span><a name="line-1637"></a><span>    </span><span class="hs-comment">{- Desugar it -}</span><span>
</span><a name="line-1638"></a><span>    </span><span class="hs-comment">-- We use a basically null location for iNTERACTIVE</span><span>
</span><a name="line-1639"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684994317"><a href="#local-6989586621684994317"><span class="hs-identifier">iNTERACTIVELoc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ModLocation</span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ml_hs_file</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span>
</span><a name="line-1640"></a><span>                                      </span><span class="hs-identifier">ml_hi_file</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;hsDeclsWithLocation:ml_hi_file&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-1641"></a><span>                                      </span><span class="hs-identifier">ml_obj_file</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;hsDeclsWithLocation:ml_obj_file&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-1642"></a><span>                                      </span><span class="hs-identifier">ml_hie_file</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;hsDeclsWithLocation:ml_hie_file&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1643"></a><span>    </span><a name="local-6989586621684994318"><a href="#local-6989586621684994318"><span class="hs-identifier">ds_result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#hscDesugar%27"><span class="hs-identifier hs-var">hscDesugar'</span></a><span> </span><a href="#local-6989586621684994317"><span class="hs-identifier hs-var">iNTERACTIVELoc</span></a><span> </span><a href="#local-6989586621684994315"><span class="hs-identifier hs-var">tc_gblenv</span></a><span>
</span><a name="line-1644"></a><span>
</span><a name="line-1645"></a><span>    </span><span class="hs-comment">{- Simplify -}</span><span>
</span><a name="line-1646"></a><span>    </span><a name="local-6989586621684994320"><a href="#local-6989586621684994320"><span class="hs-identifier">simpl_mg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1647"></a><span>      </span><a name="local-6989586621684994319"><a href="#local-6989586621684994319"><span class="hs-identifier">plugins</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_th_coreplugins</span><span> </span><a href="#local-6989586621684994315"><span class="hs-identifier hs-var">tc_gblenv</span></a><span class="hs-special">)</span><span>
</span><a name="line-1648"></a><span>      </span><a href="HscMain.html#hscSimplify"><span class="hs-identifier hs-var">hscSimplify</span></a><span> </span><a href="#local-6989586621684994314"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994319"><span class="hs-identifier hs-var">plugins</span></a><span> </span><a href="#local-6989586621684994318"><span class="hs-identifier hs-var">ds_result</span></a><span>
</span><a name="line-1649"></a><span>
</span><a name="line-1650"></a><span>    </span><span class="hs-comment">{- Tidy -}</span><span>
</span><a name="line-1651"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684994321"><a href="#local-6989586621684994321"><span class="hs-identifier">tidy_cg</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684994322"><a href="#local-6989586621684994322"><span class="hs-identifier">mod_details</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TidyPgm.html#tidyProgram"><span class="hs-identifier hs-var">tidyProgram</span></a><span> </span><a href="#local-6989586621684994314"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994320"><span class="hs-identifier hs-var">simpl_mg</span></a><span>
</span><a name="line-1652"></a><span>
</span><a name="line-1653"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-var">CgGuts</span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cg_module</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684994323"><a href="#local-6989586621684994323"><span class="hs-identifier">this_mod</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1654"></a><span>                 </span><span class="hs-identifier">cg_binds</span><span>     </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684994324"><a href="#local-6989586621684994324"><span class="hs-identifier">core_binds</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1655"></a><span>                 </span><span class="hs-identifier">cg_tycons</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684994325"><a href="#local-6989586621684994325"><span class="hs-identifier">tycons</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1656"></a><span>                 </span><span class="hs-identifier">cg_modBreaks</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684994326"><a href="#local-6989586621684994326"><span class="hs-identifier">mod_breaks</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684994321"><span class="hs-identifier hs-var">tidy_cg</span></a><span>
</span><a name="line-1657"></a><span>
</span><a name="line-1658"></a><span>        </span><span class="hs-glyph">!</span><span class="hs-identifier hs-var">ModDetails</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">md_insts</span><span>     </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684994327"><a href="#local-6989586621684994327"><span class="hs-identifier">cls_insts</span></a></a><span>
</span><a name="line-1659"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">md_fam_insts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684994328"><a href="#local-6989586621684994328"><span class="hs-identifier">fam_insts</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684994322"><span class="hs-identifier hs-var">mod_details</span></a><span>
</span><a name="line-1660"></a><span>            </span><span class="hs-comment">-- Get the *tidied* cls_insts and fam_insts</span><span>
</span><a name="line-1661"></a><span>
</span><a name="line-1662"></a><span>        </span><a name="local-6989586621684994329"><a href="#local-6989586621684994329"><span class="hs-identifier">data_tycons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-identifier hs-var">isDataTyCon</span><span> </span><a href="#local-6989586621684994325"><span class="hs-identifier hs-var">tycons</span></a><span>
</span><a name="line-1663"></a><span>
</span><a name="line-1664"></a><span>    </span><span class="hs-comment">{- Prepare For Code Generation -}</span><span>
</span><a name="line-1665"></a><span>    </span><span class="hs-comment">-- Do saturation and convert to A-normal form</span><span>
</span><a name="line-1666"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684994330"><a href="#local-6989586621684994330"><span class="hs-identifier">prepd_binds</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;CorePrep&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-1667"></a><span>      </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CorePrep.html#corePrepPgm"><span class="hs-identifier hs-var">corePrepPgm</span></a><span> </span><a href="#local-6989586621684994314"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994323"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684994317"><span class="hs-identifier hs-var">iNTERACTIVELoc</span></a><span> </span><a href="#local-6989586621684994324"><span class="hs-identifier hs-var">core_binds</span></a><span> </span><a href="#local-6989586621684994329"><span class="hs-identifier hs-var">data_tycons</span></a><span>
</span><a name="line-1668"></a><span>
</span><a name="line-1669"></a><span>    </span><span class="hs-comment">{- Generate byte code -}</span><span>
</span><a name="line-1670"></a><span>    </span><a name="local-6989586621684994331"><a href="#local-6989586621684994331"><span class="hs-identifier">cbc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="ByteCodeGen.html#byteCodeGen"><span class="hs-identifier hs-var">byteCodeGen</span></a><span> </span><a href="#local-6989586621684994314"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994323"><span class="hs-identifier hs-var">this_mod</span></a><span>
</span><a name="line-1671"></a><span>                                </span><a href="#local-6989586621684994330"><span class="hs-identifier hs-var">prepd_binds</span></a><span> </span><a href="#local-6989586621684994329"><span class="hs-identifier hs-var">data_tycons</span></a><span> </span><a href="#local-6989586621684994326"><span class="hs-identifier hs-var">mod_breaks</span></a><span>
</span><a name="line-1672"></a><span>
</span><a name="line-1673"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684994332"><a href="#local-6989586621684994332"><span class="hs-identifier">src_span</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">srcLocSpan</span><span> </span><span class="hs-identifier hs-var">interactiveSrcLoc</span><span>
</span><a name="line-1674"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Linker.html#linkDecls"><span class="hs-identifier hs-var">linkDecls</span></a><span> </span><a href="#local-6989586621684994314"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994332"><span class="hs-identifier hs-var">src_span</span></a><span> </span><a href="#local-6989586621684994331"><span class="hs-identifier hs-var">cbc</span></a><span>
</span><a name="line-1675"></a><span>
</span><a name="line-1676"></a><span>    </span><span class="hs-comment">{- Load static pointer table entries -}</span><span>
</span><a name="line-1677"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#hscAddSptEntries"><span class="hs-identifier hs-var">hscAddSptEntries</span></a><span> </span><a href="#local-6989586621684994314"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">cg_spt_entries</span><span> </span><a href="#local-6989586621684994321"><span class="hs-identifier hs-var">tidy_cg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1678"></a><span>
</span><a name="line-1679"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684994333"><a href="#local-6989586621684994333"><span class="hs-identifier">tcs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filterOut</span><span> </span><span class="hs-identifier hs-var">isImplicitTyCon</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mg_tcs</span><span> </span><a href="#local-6989586621684994320"><span class="hs-identifier hs-var">simpl_mg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1680"></a><span>        </span><a name="local-6989586621684994334"><a href="#local-6989586621684994334"><span class="hs-identifier">patsyns</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mg_patsyns</span><span> </span><a href="#local-6989586621684994320"><span class="hs-identifier hs-var">simpl_mg</span></a><span>
</span><a name="line-1681"></a><span>
</span><a name="line-1682"></a><span>        </span><a name="local-6989586621684994335"><a href="#local-6989586621684994335"><span class="hs-identifier">ext_ids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621684994340"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621684994340"><a href="#local-6989586621684994340"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">bindersOfBinds</span><span> </span><a href="#local-6989586621684994324"><span class="hs-identifier hs-var">core_binds</span></a><span>
</span><a name="line-1683"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isExternalName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621684994340"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-1684"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isDFunId</span><span> </span><a href="#local-6989586621684994340"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">isImplicitId</span><span> </span><a href="#local-6989586621684994340"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1685"></a><span>            </span><span class="hs-comment">-- We only need to keep around the external bindings</span><span>
</span><a name="line-1686"></a><span>            </span><span class="hs-comment">-- (as decided by TidyPgm), since those are the only ones</span><span>
</span><a name="line-1687"></a><span>            </span><span class="hs-comment">-- that might later be looked up by name.  But we can exclude</span><span>
</span><a name="line-1688"></a><span>            </span><span class="hs-comment">--    - DFunIds, which are in 'cls_insts' (see Note [ic_tythings] in HscTypes</span><span>
</span><a name="line-1689"></a><span>            </span><span class="hs-comment">--    - Implicit Ids, which are implicit in tcs</span><span>
</span><a name="line-1690"></a><span>            </span><span class="hs-comment">-- c.f. TcRnDriver.runTcInteractive, which reconstructs the TypeEnv</span><span>
</span><a name="line-1691"></a><span>
</span><a name="line-1692"></a><span>        </span><a name="local-6989586621684994336"><a href="#local-6989586621684994336"><span class="hs-identifier">new_tythings</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">AnId</span><span> </span><a href="#local-6989586621684994335"><span class="hs-identifier hs-var">ext_ids</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ATyCon</span><span> </span><a href="#local-6989586621684994333"><span class="hs-identifier hs-var">tcs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AConLike</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">PatSynCon</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684994334"><span class="hs-identifier hs-var">patsyns</span></a><span>
</span><a name="line-1693"></a><span>        </span><a name="local-6989586621684994337"><a href="#local-6989586621684994337"><span class="hs-identifier">ictxt</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><a href="#local-6989586621684994314"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1694"></a><span>        </span><span class="hs-comment">-- See Note [Fixity declarations in GHCi]</span><span>
</span><a name="line-1695"></a><span>        </span><a name="local-6989586621684994338"><a href="#local-6989586621684994338"><span class="hs-identifier">fix_env</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_fix_env</span><span> </span><a href="#local-6989586621684994315"><span class="hs-identifier hs-var">tc_gblenv</span></a><span>
</span><a name="line-1696"></a><span>        </span><a name="local-6989586621684994339"><a href="#local-6989586621684994339"><span class="hs-identifier">new_ictxt</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendInteractiveContext</span><span> </span><a href="#local-6989586621684994337"><span class="hs-identifier hs-var">ictxt</span></a><span> </span><a href="#local-6989586621684994336"><span class="hs-identifier hs-var">new_tythings</span></a><span> </span><a href="#local-6989586621684994327"><span class="hs-identifier hs-var">cls_insts</span></a><span>
</span><a name="line-1697"></a><span>                                                </span><a href="#local-6989586621684994328"><span class="hs-identifier hs-var">fam_insts</span></a><span> </span><a href="#local-6989586621684994316"><span class="hs-identifier hs-var">defaults</span></a><span> </span><a href="#local-6989586621684994338"><span class="hs-identifier hs-var">fix_env</span></a><span>
</span><a name="line-1698"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684994336"><span class="hs-identifier hs-var">new_tythings</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684994339"><span class="hs-identifier hs-var">new_ictxt</span></a><span class="hs-special">)</span><span>
</span><a name="line-1699"></a><span>
</span><a name="line-1700"></a><span class="hs-comment">-- | Load the given static-pointer table entries into the interpreter.</span><span>
</span><a name="line-1701"></a><span class="hs-comment">-- See Note [Grand plan for static forms] in StaticPtrTable.</span><span>
</span><a name="line-1702"></a><span class="hs-identifier">hscAddSptEntries</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SptEntry</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1703"></a><a name="hscAddSptEntries"><a href="HscMain.html#hscAddSptEntries"><span class="hs-identifier">hscAddSptEntries</span></a></a><span> </span><a name="local-6989586621684994341"><a href="#local-6989586621684994341"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684994342"><a href="#local-6989586621684994342"><span class="hs-identifier">entries</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1704"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">add_spt_entry</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SptEntry</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1705"></a><span>        </span><a name="local-6989586621684994343"><a href="#local-6989586621684994343"><span class="hs-identifier">add_spt_entry</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SptEntry</span><span> </span><a name="local-6989586621684994344"><a href="#local-6989586621684994344"><span class="hs-identifier">i</span></a></a><span> </span><a name="local-6989586621684994345"><a href="#local-6989586621684994345"><span class="hs-identifier">fpr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1706"></a><span>            </span><a name="local-6989586621684994346"><a href="#local-6989586621684994346"><span class="hs-identifier">val</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#getHValue"><span class="hs-identifier hs-var">getHValue</span></a><span> </span><a href="#local-6989586621684994341"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621684994344"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span>
</span><a name="line-1707"></a><span>            </span><a href="GHCi.html#addSptEntry"><span class="hs-identifier hs-var">addSptEntry</span></a><span> </span><a href="#local-6989586621684994341"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994345"><span class="hs-identifier hs-var">fpr</span></a><span> </span><a href="#local-6989586621684994346"><span class="hs-identifier hs-var">val</span></a><span>
</span><a name="line-1708"></a><span>    </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="#local-6989586621684994343"><span class="hs-identifier hs-var">add_spt_entry</span></a><span> </span><a href="#local-6989586621684994342"><span class="hs-identifier hs-var">entries</span></a><span>
</span><a name="line-1709"></a><span>
</span><a name="line-1710"></a><span class="hs-comment">{-
  Note [Fixity declarations in GHCi]
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

  To support fixity declarations on types defined within GHCi (as requested
  in #10018) we record the fixity environment in InteractiveContext.
  When we want to evaluate something TcRnDriver.runTcInteractive pulls out this
  fixity environment and uses it to initialize the global typechecker environment.
  After the typechecker has finished its business, an updated fixity environment
  (reflecting whatever fixity declarations were present in the statements we
  passed it) will be returned from hscParsedStmt. This is passed to
  updateFixityEnv, which will stuff it back into InteractiveContext, to be
  used in evaluating the next statement.

-}</span><span>
</span><a name="line-1725"></a><span>
</span><a name="line-1726"></a><span class="hs-identifier">hscImport</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ImportDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span>
</span><a name="line-1727"></a><a name="hscImport"><a href="HscMain.html#hscImport"><span class="hs-identifier">hscImport</span></a></a><span> </span><a name="local-6989586621684994347"><a href="#local-6989586621684994347"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684994348"><a href="#local-6989586621684994348"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runInteractiveHsc</span><span> </span><a href="#local-6989586621684994347"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1728"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsModule</span><span class="hs-special">{</span><span class="hs-identifier">hsmodImports</span><span class="hs-glyph">=</span><a name="local-6989586621684994349"><a href="#local-6989586621684994349"><span class="hs-identifier">is</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-1729"></a><span>       </span><a href="HscMain.html#hscParseThing"><span class="hs-identifier hs-var">hscParseThing</span></a><span> </span><span class="hs-identifier hs-var">parseModule</span><span> </span><a href="#local-6989586621684994348"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-1730"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684994349"><span class="hs-identifier hs-var">is</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1731"></a><span>        </span><span class="hs-special">[</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684994350"><a href="#local-6989586621684994350"><span class="hs-identifier">i</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684994350"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-1732"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">throwOneError</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1733"></a><span>                 </span><span class="hs-identifier hs-var">mkPlainErrMsg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621684994347"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">noSrcSpan</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1734"></a><span>                     </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;parse error in import declaration&quot;</span><span>
</span><a name="line-1735"></a><span>
</span><a name="line-1736"></a><span class="hs-comment">-- | Typecheck an expression (but don't run it)</span><span>
</span><a name="line-1737"></a><span class="hs-identifier">hscTcExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-1738"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnDriver.html#TcRnExprMode"><span class="hs-identifier hs-type">TcRnExprMode</span></a><span>
</span><a name="line-1739"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-comment">-- ^ The expression</span><span>
</span><a name="line-1740"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-1741"></a><a name="hscTcExpr"><a href="HscMain.html#hscTcExpr"><span class="hs-identifier">hscTcExpr</span></a></a><span> </span><a name="local-6989586621684994351"><a href="#local-6989586621684994351"><span class="hs-identifier">hsc_env0</span></a></a><span> </span><a name="local-6989586621684994352"><a href="#local-6989586621684994352"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621684994353"><a href="#local-6989586621684994353"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runInteractiveHsc</span><span> </span><a href="#local-6989586621684994351"><span class="hs-identifier hs-var">hsc_env0</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1742"></a><span>  </span><a name="local-6989586621684994354"><a href="#local-6989586621684994354"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#getHscEnv"><span class="hs-identifier hs-var">getHscEnv</span></a><span>
</span><a name="line-1743"></a><span>  </span><a name="local-6989586621684994355"><a href="#local-6989586621684994355"><span class="hs-identifier">parsed_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#hscParseExpr"><span class="hs-identifier hs-var">hscParseExpr</span></a><span> </span><a href="#local-6989586621684994353"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-1744"></a><span>  </span><a href="HscMain.html#ioMsgMaybe"><span class="hs-identifier hs-var">ioMsgMaybe</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnDriver.html#tcRnExpr"><span class="hs-identifier hs-var">tcRnExpr</span></a><span> </span><a href="#local-6989586621684994354"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994352"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621684994355"><span class="hs-identifier hs-var">parsed_expr</span></a><span>
</span><a name="line-1745"></a><span>
</span><a name="line-1746"></a><span class="hs-comment">-- | Find the kind of a type, after generalisation</span><span>
</span><a name="line-1747"></a><span class="hs-identifier">hscKcType</span><span>
</span><a name="line-1748"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-1749"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>            </span><span class="hs-comment">-- ^ Normalise the type</span><span>
</span><a name="line-1750"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>          </span><span class="hs-comment">-- ^ The type as a string</span><span>
</span><a name="line-1751"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Kind</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ Resulting type (possibly normalised) and kind</span><span>
</span><a name="line-1752"></a><a name="hscKcType"><a href="HscMain.html#hscKcType"><span class="hs-identifier">hscKcType</span></a></a><span> </span><a name="local-6989586621684994356"><a href="#local-6989586621684994356"><span class="hs-identifier">hsc_env0</span></a></a><span> </span><a name="local-6989586621684994357"><a href="#local-6989586621684994357"><span class="hs-identifier">normalise</span></a></a><span> </span><a name="local-6989586621684994358"><a href="#local-6989586621684994358"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runInteractiveHsc</span><span> </span><a href="#local-6989586621684994356"><span class="hs-identifier hs-var">hsc_env0</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1753"></a><span>    </span><a name="local-6989586621684994359"><a href="#local-6989586621684994359"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#getHscEnv"><span class="hs-identifier hs-var">getHscEnv</span></a><span>
</span><a name="line-1754"></a><span>    </span><a name="local-6989586621684994360"><a href="#local-6989586621684994360"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#hscParseType"><span class="hs-identifier hs-var">hscParseType</span></a><span> </span><a href="#local-6989586621684994358"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-1755"></a><span>    </span><a href="HscMain.html#ioMsgMaybe"><span class="hs-identifier hs-var">ioMsgMaybe</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnDriver.html#tcRnType"><span class="hs-identifier hs-var">tcRnType</span></a><span> </span><a href="#local-6989586621684994359"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994357"><span class="hs-identifier hs-var">normalise</span></a><span> </span><a href="#local-6989586621684994360"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1756"></a><span>
</span><a name="line-1757"></a><span class="hs-identifier">hscParseExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span>
</span><a name="line-1758"></a><a name="hscParseExpr"><a href="HscMain.html#hscParseExpr"><span class="hs-identifier">hscParseExpr</span></a></a><span> </span><a name="local-6989586621684994361"><a href="#local-6989586621684994361"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1759"></a><span>  </span><a name="local-6989586621684994362"><a href="#local-6989586621684994362"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#getHscEnv"><span class="hs-identifier hs-var">getHscEnv</span></a><span>
</span><a name="line-1760"></a><span>  </span><a name="local-6989586621684994363"><a href="#local-6989586621684994363"><span class="hs-identifier">maybe_stmt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HscMain.html#hscParseStmt"><span class="hs-identifier hs-var">hscParseStmt</span></a><span> </span><a href="#local-6989586621684994361"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-1761"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684994363"><span class="hs-identifier hs-var">maybe_stmt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1762"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684994364"><a href="#local-6989586621684994364"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684994364"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-1763"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HscMain.html#throwErrors"><span class="hs-identifier hs-var">throwErrors</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unitBag</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkPlainErrMsg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621684994362"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">noSrcSpan</span><span>
</span><a name="line-1764"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;not an expression:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621684994361"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1765"></a><span>
</span><a name="line-1766"></a><span class="hs-identifier">hscParseStmt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhciLStmt</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1767"></a><a name="hscParseStmt"><a href="HscMain.html#hscParseStmt"><span class="hs-identifier">hscParseStmt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HscMain.html#hscParseThing"><span class="hs-identifier hs-var">hscParseThing</span></a><span> </span><span class="hs-identifier hs-var">parseStmt</span><span>
</span><a name="line-1768"></a><span>
</span><a name="line-1769"></a><span class="hs-identifier">hscParseStmtWithLocation</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-1770"></a><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhciLStmt</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1771"></a><a name="hscParseStmtWithLocation"><a href="HscMain.html#hscParseStmtWithLocation"><span class="hs-identifier">hscParseStmtWithLocation</span></a></a><span> </span><a name="local-6989586621684994365"><a href="#local-6989586621684994365"><span class="hs-identifier">source</span></a></a><span> </span><a name="local-6989586621684994366"><a href="#local-6989586621684994366"><span class="hs-identifier">linenumber</span></a></a><span> </span><a name="local-6989586621684994367"><a href="#local-6989586621684994367"><span class="hs-identifier">stmt</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1772"></a><span>    </span><a href="HscMain.html#hscParseThingWithLocation"><span class="hs-identifier hs-var">hscParseThingWithLocation</span></a><span> </span><a href="#local-6989586621684994365"><span class="hs-identifier hs-var">source</span></a><span> </span><a href="#local-6989586621684994366"><span class="hs-identifier hs-var">linenumber</span></a><span> </span><span class="hs-identifier hs-var">parseStmt</span><span> </span><a href="#local-6989586621684994367"><span class="hs-identifier hs-var">stmt</span></a><span>
</span><a name="line-1773"></a><span>
</span><a name="line-1774"></a><span class="hs-identifier">hscParseType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsType</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span>
</span><a name="line-1775"></a><a name="hscParseType"><a href="HscMain.html#hscParseType"><span class="hs-identifier">hscParseType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HscMain.html#hscParseThing"><span class="hs-identifier hs-var">hscParseThing</span></a><span> </span><span class="hs-identifier hs-var">parseType</span><span>
</span><a name="line-1776"></a><span>
</span><a name="line-1777"></a><span class="hs-identifier">hscParseIdentifier</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span class="hs-special">)</span><span>
</span><a name="line-1778"></a><a name="hscParseIdentifier"><a href="HscMain.html#hscParseIdentifier"><span class="hs-identifier">hscParseIdentifier</span></a></a><span> </span><a name="local-6989586621684994368"><a href="#local-6989586621684994368"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684994369"><a href="#local-6989586621684994369"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1779"></a><span>    </span><span class="hs-identifier hs-var">runInteractiveHsc</span><span> </span><a href="#local-6989586621684994368"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="HscMain.html#hscParseThing"><span class="hs-identifier hs-var">hscParseThing</span></a><span> </span><span class="hs-identifier hs-var">parseIdentifier</span><span> </span><a href="#local-6989586621684994369"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-1780"></a><span>
</span><a name="line-1781"></a><span class="hs-identifier">hscParseThing</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684993804"><span class="hs-identifier hs-type">thing</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Data</span><span> </span><a href="#local-6989586621684993804"><span class="hs-identifier hs-type">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-1782"></a><span>              </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Lexer.P</span><span> </span><a href="#local-6989586621684993804"><span class="hs-identifier hs-type">thing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><a href="#local-6989586621684993804"><span class="hs-identifier hs-type">thing</span></a><span>
</span><a name="line-1783"></a><a name="hscParseThing"><a href="HscMain.html#hscParseThing"><span class="hs-identifier">hscParseThing</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HscMain.html#hscParseThingWithLocation"><span class="hs-identifier hs-var">hscParseThingWithLocation</span></a><span> </span><span class="hs-string">&quot;&lt;interactive&gt;&quot;</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-1784"></a><span>
</span><a name="line-1785"></a><span class="hs-identifier">hscParseThingWithLocation</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684993803"><span class="hs-identifier hs-type">thing</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Data</span><span> </span><a href="#local-6989586621684993803"><span class="hs-identifier hs-type">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1786"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Lexer.P</span><span> </span><a href="#local-6989586621684993803"><span class="hs-identifier hs-type">thing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Hsc</span><span> </span><a href="#local-6989586621684993803"><span class="hs-identifier hs-type">thing</span></a><span>
</span><a name="line-1787"></a><a name="hscParseThingWithLocation"><a href="HscMain.html#hscParseThingWithLocation"><span class="hs-identifier">hscParseThingWithLocation</span></a></a><span> </span><a name="local-6989586621684994370"><a href="#local-6989586621684994370"><span class="hs-identifier">source</span></a></a><span> </span><a name="local-6989586621684994371"><a href="#local-6989586621684994371"><span class="hs-identifier">linenumber</span></a></a><span> </span><a name="local-6989586621684994372"><a href="#local-6989586621684994372"><span class="hs-identifier">parser</span></a></a><span> </span><a name="local-6989586621684994373"><a href="#local-6989586621684994373"><span class="hs-identifier">str</span></a></a><span>
</span><a name="line-1788"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withTiming</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1789"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Parser [source]&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1790"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;Parser&quot;</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1791"></a><span>    </span><a name="local-6989586621684994374"><a href="#local-6989586621684994374"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1792"></a><span>
</span><a name="line-1793"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684994375"><a href="#local-6989586621684994375"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">stringToStringBuffer</span><span> </span><a href="#local-6989586621684994373"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-1794"></a><span>        </span><a name="local-6989586621684994376"><a href="#local-6989586621684994376"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkRealSrcLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><a href="#local-6989586621684994370"><span class="hs-identifier hs-var">source</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684994371"><span class="hs-identifier hs-var">linenumber</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-1795"></a><span>
</span><a name="line-1796"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">unP</span><span> </span><a href="#local-6989586621684994372"><span class="hs-identifier hs-var">parser</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkPState</span><span> </span><a href="#local-6989586621684994374"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684994375"><span class="hs-identifier hs-var">buf</span></a><span> </span><a href="#local-6989586621684994376"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1797"></a><span>        </span><span class="hs-identifier hs-var">PFailed</span><span> </span><a name="local-6989586621684994377"><a href="#local-6989586621684994377"><span class="hs-identifier">warnFn</span></a></a><span> </span><a name="local-6989586621684994378"><a href="#local-6989586621684994378"><span class="hs-identifier">span</span></a></a><span> </span><a name="local-6989586621684994379"><a href="#local-6989586621684994379"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1798"></a><span>            </span><a href="HscMain.html#logWarningsReportErrors"><span class="hs-identifier hs-var">logWarningsReportErrors</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684994377"><span class="hs-identifier hs-var">warnFn</span></a><span> </span><a href="#local-6989586621684994374"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1799"></a><span>            </span><a href="HscMain.html#handleWarnings"><span class="hs-identifier hs-var">handleWarnings</span></a><span>
</span><a name="line-1800"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684994380"><a href="#local-6989586621684994380"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkPlainErrMsg</span><span> </span><a href="#local-6989586621684994374"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684994378"><span class="hs-identifier hs-var">span</span></a><span> </span><a href="#local-6989586621684994379"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-1801"></a><span>            </span><a href="HscMain.html#throwErrors"><span class="hs-identifier hs-var">throwErrors</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unitBag</span><span> </span><a href="#local-6989586621684994380"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-1802"></a><span>
</span><a name="line-1803"></a><span>        </span><span class="hs-identifier hs-var">POk</span><span> </span><a name="local-6989586621684994381"><a href="#local-6989586621684994381"><span class="hs-identifier">pst</span></a></a><span> </span><a name="local-6989586621684994382"><a href="#local-6989586621684994382"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1804"></a><span>            </span><a href="HscMain.html#logWarningsReportErrors"><span class="hs-identifier hs-var">logWarningsReportErrors</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getMessages</span><span> </span><a href="#local-6989586621684994381"><span class="hs-identifier hs-var">pst</span></a><span> </span><a href="#local-6989586621684994374"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1805"></a><span>            </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621684994374"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_parsed</span><span> </span><span class="hs-string">&quot;Parser&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684994382"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-1806"></a><span>            </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621684994374"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_parsed_ast</span><span> </span><span class="hs-string">&quot;Parser AST&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1807"></a><span>                                   </span><a href="HsDumpAst.html#showAstData"><span class="hs-identifier hs-var">showAstData</span></a><span> </span><a href="HsDumpAst.html#NoBlankSrcSpan"><span class="hs-identifier hs-var">NoBlankSrcSpan</span></a><span> </span><a href="#local-6989586621684994382"><span class="hs-identifier hs-var">thing</span></a><span>
</span><a name="line-1808"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684994382"><span class="hs-identifier hs-var">thing</span></a><span>
</span><a name="line-1809"></a><span>
</span><a name="line-1810"></a><span>
</span><a name="line-1811"></a><span class="hs-comment">{- **********************************************************************
%*                                                                      *
        Desugar, simplify, convert to bytecode, and link an expression
%*                                                                      *
%********************************************************************* -}</span><span>
</span><a name="line-1816"></a><span>
</span><a name="line-1817"></a><span class="hs-identifier">hscCompileCoreExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span>
</span><a name="line-1818"></a><a name="hscCompileCoreExpr"><a href="HscMain.html#hscCompileCoreExpr"><span class="hs-identifier">hscCompileCoreExpr</span></a></a><span> </span><a name="local-6989586621684994383"><a href="#local-6989586621684994383"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1819"></a><span>  </span><span class="hs-identifier hs-var">lookupHook</span><span> </span><span class="hs-identifier">hscCompileCoreExprHook</span><span> </span><a href="HscMain.html#hscCompileCoreExpr%27"><span class="hs-identifier hs-var">hscCompileCoreExpr'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621684994383"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684994383"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1820"></a><span>
</span><a name="line-1821"></a><span class="hs-identifier">hscCompileCoreExpr'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">ForeignHValue</span><span>
</span><a name="line-1822"></a><a name="hscCompileCoreExpr%27"><a href="HscMain.html#hscCompileCoreExpr%27"><span class="hs-identifier">hscCompileCoreExpr'</span></a></a><span> </span><a name="local-6989586621684994384"><a href="#local-6989586621684994384"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621684994385"><a href="#local-6989586621684994385"><span class="hs-identifier">srcspan</span></a></a><span> </span><a name="local-6989586621684994386"><a href="#local-6989586621684994386"><span class="hs-identifier">ds_expr</span></a></a><span>
</span><a name="line-1823"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684994387"><a href="#local-6989586621684994387"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621684994384"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1824"></a><span>
</span><a name="line-1825"></a><span>           </span><span class="hs-comment">{- Simplify it -}</span><span>
</span><a name="line-1826"></a><span>         </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684994388"><a href="#local-6989586621684994388"><span class="hs-identifier">simpl_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SimplCore.html#simplifyExpr"><span class="hs-identifier hs-var">simplifyExpr</span></a><span> </span><a href="#local-6989586621684994387"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684994386"><span class="hs-identifier hs-var">ds_expr</span></a><span>
</span><a name="line-1827"></a><span>
</span><a name="line-1828"></a><span>           </span><span class="hs-comment">{- Tidy it (temporary, until coreSat does cloning) -}</span><span>
</span><a name="line-1829"></a><span>         </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684994389"><a href="#local-6989586621684994389"><span class="hs-identifier">tidy_expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tidyExpr</span><span> </span><span class="hs-identifier hs-var">emptyTidyEnv</span><span> </span><a href="#local-6989586621684994388"><span class="hs-identifier hs-var">simpl_expr</span></a><span>
</span><a name="line-1830"></a><span>
</span><a name="line-1831"></a><span>           </span><span class="hs-comment">{- Prepare for codegen -}</span><span>
</span><a name="line-1832"></a><span>         </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684994390"><a href="#local-6989586621684994390"><span class="hs-identifier">prepd_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CorePrep.html#corePrepExpr"><span class="hs-identifier hs-var">corePrepExpr</span></a><span> </span><a href="#local-6989586621684994387"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684994384"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994389"><span class="hs-identifier hs-var">tidy_expr</span></a><span>
</span><a name="line-1833"></a><span>
</span><a name="line-1834"></a><span>           </span><span class="hs-comment">{- Lint if necessary -}</span><span>
</span><a name="line-1835"></a><span>         </span><span class="hs-special">;</span><span> </span><a href="CoreLint.html#lintInteractiveExpr"><span class="hs-identifier hs-var">lintInteractiveExpr</span></a><span> </span><span class="hs-string">&quot;hscCompileExpr&quot;</span><span> </span><a href="#local-6989586621684994384"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994390"><span class="hs-identifier hs-var">prepd_expr</span></a><span>
</span><a name="line-1836"></a><span>
</span><a name="line-1837"></a><span>           </span><span class="hs-comment">{- Convert to BCOs -}</span><span>
</span><a name="line-1838"></a><span>         </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684994391"><a href="#local-6989586621684994391"><span class="hs-identifier">bcos</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="ByteCodeGen.html#coreExprToBCOs"><span class="hs-identifier hs-var">coreExprToBCOs</span></a><span> </span><a href="#local-6989586621684994384"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1839"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">icInteractiveModule</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_IC</span><span> </span><a href="#local-6989586621684994384"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684994390"><span class="hs-identifier hs-var">prepd_expr</span></a><span>
</span><a name="line-1840"></a><span>
</span><a name="line-1841"></a><span>           </span><span class="hs-comment">{- link it -}</span><span>
</span><a name="line-1842"></a><span>         </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684994392"><a href="#local-6989586621684994392"><span class="hs-identifier">hval</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Linker.html#linkExpr"><span class="hs-identifier hs-var">linkExpr</span></a><span> </span><a href="#local-6989586621684994384"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621684994385"><span class="hs-identifier hs-var">srcspan</span></a><span> </span><a href="#local-6989586621684994391"><span class="hs-identifier hs-var">bcos</span></a><span>
</span><a name="line-1843"></a><span>
</span><a name="line-1844"></a><span>         </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684994392"><span class="hs-identifier hs-var">hval</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1845"></a><span>
</span><a name="line-1846"></a><span>
</span><a name="line-1847"></a><span class="hs-comment">{- **********************************************************************
%*                                                                      *
        Statistics on reading interfaces
%*                                                                      *
%********************************************************************* -}</span><span>
</span><a name="line-1852"></a><span>
</span><a name="line-1853"></a><span class="hs-identifier">dumpIfaceStats</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1854"></a><a name="dumpIfaceStats"><a href="HscMain.html#dumpIfaceStats"><span class="hs-identifier">dumpIfaceStats</span></a></a><span> </span><a name="local-6989586621684994393"><a href="#local-6989586621684994393"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1855"></a><span>    </span><a name="local-6989586621684994397"><a href="#local-6989586621684994397"><span class="hs-identifier">eps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_EPS</span><span> </span><a href="#local-6989586621684994393"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1856"></a><span>    </span><span class="hs-identifier hs-var">dumpIfSet</span><span> </span><a href="#local-6989586621684994394"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684994396"><span class="hs-identifier hs-var">dump_if_trace</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621684994395"><span class="hs-identifier hs-var">dump_rn_stats</span></a><span class="hs-special">)</span><span>
</span><a name="line-1857"></a><span>              </span><span class="hs-string">&quot;Interface statistics&quot;</span><span>
</span><a name="line-1858"></a><span>              </span><span class="hs-special">(</span><a href="LoadIface.html#ifaceStats"><span class="hs-identifier hs-var">ifaceStats</span></a><span> </span><a href="#local-6989586621684994397"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">)</span><span>
</span><a name="line-1859"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1860"></a><span>    </span><a name="local-6989586621684994394"><a href="#local-6989586621684994394"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621684994393"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1861"></a><span>    </span><a name="local-6989586621684994395"><a href="#local-6989586621684994395"><span class="hs-identifier">dump_rn_stats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dopt</span><span> </span><span class="hs-identifier hs-var">Opt_D_dump_rn_stats</span><span> </span><a href="#local-6989586621684994394"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1862"></a><span>    </span><a name="local-6989586621684994396"><a href="#local-6989586621684994396"><span class="hs-identifier">dump_if_trace</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dopt</span><span> </span><span class="hs-identifier hs-var">Opt_D_dump_if_trace</span><span> </span><a href="#local-6989586621684994394"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1863"></a><span>
</span><a name="line-1864"></a><span>
</span><a name="line-1865"></a><span class="hs-comment">{- **********************************************************************
%*                                                                      *
        Progress Messages: Module i of n
%*                                                                      *
%********************************************************************* -}</span><span>
</span><a name="line-1870"></a><span>
</span><a name="line-1871"></a><span class="hs-identifier">showModuleIndex</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-1872"></a><a name="showModuleIndex"><a href="HscMain.html#showModuleIndex"><span class="hs-identifier">showModuleIndex</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684994398"><a href="#local-6989586621684994398"><span class="hs-identifier">i</span></a></a><span class="hs-special">,</span><a name="local-6989586621684994399"><a href="#local-6989586621684994399"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;[&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684994402"><span class="hs-identifier hs-var">padded</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; of &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684994400"><span class="hs-identifier hs-var">n_str</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;] &quot;</span><span>
</span><a name="line-1873"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1874"></a><span>    </span><a name="local-6989586621684994400"><a href="#local-6989586621684994400"><span class="hs-identifier">n_str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621684994399"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1875"></a><span>    </span><a name="local-6989586621684994401"><a href="#local-6989586621684994401"><span class="hs-identifier">i_str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621684994398"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-1876"></a><span>    </span><a name="local-6989586621684994402"><a href="#local-6989586621684994402"><span class="hs-identifier">padded</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">replicate</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621684994400"><span class="hs-identifier hs-var">n_str</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621684994401"><span class="hs-identifier hs-var">i_str</span></a><span class="hs-special">)</span><span> </span><span class="hs-char">' '</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684994401"><span class="hs-identifier hs-var">i_str</span></a><span>
</span><a name="line-1877"></a></pre></body></html>