<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998


Pattern-matching bindings (HsBinds and MonoBinds)

Handles @HsBinds@; those at the top level require different handling,
in that the @Rec@/@NonRec@/etc structure is thrown away (whereas at
lower levels it is preserved with @let@/@letrec@s).
-}</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-14"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-15"></a><span class="hs-pragma">{-# LANGUAGE ViewPatterns #-}</span><span>
</span><a name="line-16"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">DsBinds</span><span> </span><span class="hs-special">(</span><span> </span><a href="DsBinds.html#dsTopLHsBinds"><span class="hs-identifier hs-var">dsTopLHsBinds</span></a><span class="hs-special">,</span><span> </span><a href="DsBinds.html#dsLHsBinds"><span class="hs-identifier hs-var">dsLHsBinds</span></a><span class="hs-special">,</span><span> </span><a href="DsBinds.html#decomposeRuleLhs"><span class="hs-identifier hs-var">decomposeRuleLhs</span></a><span class="hs-special">,</span><span> </span><a href="DsBinds.html#dsSpec"><span class="hs-identifier hs-var">dsSpec</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>                 </span><a href="DsBinds.html#dsHsWrapper"><span class="hs-identifier hs-var">dsHsWrapper</span></a><span class="hs-special">,</span><span> </span><a href="DsBinds.html#dsTcEvBinds"><span class="hs-identifier hs-var">dsTcEvBinds</span></a><span class="hs-special">,</span><span> </span><a href="DsBinds.html#dsTcEvBinds_s"><span class="hs-identifier hs-var">dsTcEvBinds_s</span></a><span class="hs-special">,</span><span> </span><a href="DsBinds.html#dsEvBinds"><span class="hs-identifier hs-var">dsEvBinds</span></a><span class="hs-special">,</span><span> </span><a href="DsBinds.html#dsMkUserRule"><span class="hs-identifier hs-var">dsMkUserRule</span></a><span>
</span><a name="line-20"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE</span><span> </span><span class="hs-pragma">#-}</span><span>   </span><a href="DsExpr.html"><span class="hs-identifier">DsExpr</span></a><span class="hs-special">(</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE</span><span> </span><span class="hs-pragma">#-}</span><span>   </span><a href="Match.html"><span class="hs-identifier">Match</span></a><span class="hs-special">(</span><span> </span><a href="Match.html#matchWrapper"><span class="hs-identifier hs-var">matchWrapper</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="DsMonad.html"><span class="hs-identifier">DsMonad</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="DsGRHSs.html"><span class="hs-identifier">DsGRHSs</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="DsUtils.html"><span class="hs-identifier">DsUtils</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="Check.html"><span class="hs-identifier">Check</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="Check.html#checkGuardMatches"><span class="hs-identifier hs-var">checkGuardMatches</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span>            </span><span class="hs-comment">-- lots of things</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreSyn</span><span>          </span><span class="hs-comment">-- lots of things</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreOpt</span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">simpleOptExpr</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">OccurAnal</span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">occurAnalyseExpr</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MkCore</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreUtils</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreArity</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">etaExpand</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreUnfold</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreFVs</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Digraph</span><span>
</span><a name="line-44"></a><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcEvidence</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Coercion</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysWiredIn</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">typeNatKind</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">typeSymbolKind</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MkId</span><span class="hs-special">(</span><span class="hs-identifier hs-var">proxyHashId</span><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarSet</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Rules</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarEnv</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Var</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">EvVar</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">OrdList</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Bag</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSet</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">nonDetEltsUniqSet</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MonadUtils</span><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC.LanguageExtensions</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LangExt</span><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-73"></a><span>
</span><a name="line-74"></a><span class="hs-comment">{-**********************************************************************
*                                                                      *
           Desugaring a MonoBinds
*                                                                      *
**********************************************************************-}</span><span>
</span><a name="line-79"></a><span>
</span><a name="line-80"></a><span class="hs-comment">-- | Desugar top level binds, strict binds are treated like normal</span><span>
</span><a name="line-81"></a><span class="hs-comment">-- binds since there is no good time to force before first usage.</span><span>
</span><a name="line-82"></a><span class="hs-identifier">dsTopLHsBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OrdList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-83"></a><a name="dsTopLHsBinds"><a href="DsBinds.html#dsTopLHsBinds"><span class="hs-identifier">dsTopLHsBinds</span></a></a><span> </span><a name="local-6989586621684031763"><a href="#local-6989586621684031763"><span class="hs-identifier">binds</span></a></a><span>
</span><a name="line-84"></a><span>     </span><span class="hs-comment">-- see Note [Strict binds checks]</span><span>
</span><a name="line-85"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isEmptyBag</span><span> </span><a href="#local-6989586621684031764"><span class="hs-identifier hs-var">unlifted_binds</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isEmptyBag</span><span> </span><a href="#local-6989586621684031765"><span class="hs-identifier hs-var">bang_binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-86"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">mapBagM_</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031766"><span class="hs-identifier hs-var">top_level_err</span></a><span> </span><span class="hs-string">&quot;bindings for unlifted types&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684031764"><span class="hs-identifier hs-var">unlifted_binds</span></a><span>
</span><a name="line-87"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mapBagM_</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031766"><span class="hs-identifier hs-var">top_level_err</span></a><span> </span><span class="hs-string">&quot;strict bindings&quot;</span><span class="hs-special">)</span><span>             </span><a href="#local-6989586621684031765"><span class="hs-identifier hs-var">bang_binds</span></a><span>
</span><a name="line-88"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">nilOL</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-91"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684031770"><a href="#local-6989586621684031770"><span class="hs-identifier">force_vars</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684031771"><a href="#local-6989586621684031771"><span class="hs-identifier">prs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#dsLHsBinds"><span class="hs-identifier hs-var">dsLHsBinds</span></a><span> </span><a href="#local-6989586621684031763"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-92"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-identifier hs-var">debugIsOn</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-93"></a><span>         </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684031772"><a href="#local-6989586621684031772"><span class="hs-identifier">xstrict</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.Strict</span><span>
</span><a name="line-94"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">MASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">null</span><span> </span><span class="hs-identifier">force_vars</span><span> </span><span class="hs-operator">||</span><span> </span><a href="#local-6989586621684031770"><span class="hs-identifier hs-var">xstrict</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><a href="#local-6989586621684031772"><span class="hs-identifier hs-var">binds</span></a><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">force_vars</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-95"></a><span>              </span><span class="hs-comment">-- with -XStrict, even top-level vars are listed as force vars.</span><span>
</span><a name="line-96"></a><span>
</span><a name="line-97"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toOL</span><span> </span><a href="#local-6989586621684031771"><span class="hs-identifier hs-var">prs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-98"></a><span>
</span><a name="line-99"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-100"></a><span>    </span><a name="local-6989586621684031764"><a href="#local-6989586621684031764"><span class="hs-identifier">unlifted_binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filterBag</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isUnliftedHsBind</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684031763"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-101"></a><span>    </span><a name="local-6989586621684031765"><a href="#local-6989586621684031765"><span class="hs-identifier">bang_binds</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filterBag</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isBangedHsBind</span><span>   </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684031763"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-102"></a><span>
</span><a name="line-103"></a><span>    </span><a name="local-6989586621684031766"><a href="#local-6989586621684031766"><span class="hs-identifier">top_level_err</span></a></a><span> </span><a name="local-6989586621684031767"><a href="#local-6989586621684031767"><span class="hs-identifier">desc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621684031768"><a href="#local-6989586621684031768"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621684031769"><a href="#local-6989586621684031769"><span class="hs-identifier">bind</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-104"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#putSrcSpanDs"><span class="hs-identifier hs-var">putSrcSpanDs</span></a><span> </span><a href="#local-6989586621684031768"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-105"></a><span>        </span><a href="DsMonad.html#errDs"><span class="hs-identifier hs-var">errDs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Top-level&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621684031767"><span class="hs-identifier hs-var">desc</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;aren't allowed:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-106"></a><span>                  </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684031769"><span class="hs-identifier hs-var">bind</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-107"></a><span>
</span><a name="line-108"></a><span>
</span><a name="line-109"></a><span class="hs-comment">-- | Desugar all other kind of bindings, Ids of strict binds are returned to</span><span>
</span><a name="line-110"></a><span class="hs-comment">-- later be forced in the binding group body, see Note [Desugar Strict binds]</span><span>
</span><a name="line-111"></a><span class="hs-identifier">dsLHsBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-112"></a><a name="dsLHsBinds"><a href="DsBinds.html#dsLHsBinds"><span class="hs-identifier">dsLHsBinds</span></a></a><span> </span><a name="local-6989586621684031773"><a href="#local-6989586621684031773"><span class="hs-identifier">binds</span></a></a><span>
</span><a name="line-113"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684031774"><a href="#local-6989586621684031774"><span class="hs-identifier">ds_bs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapBagM</span><span> </span><a href="DsBinds.html#dsLHsBind"><span class="hs-identifier hs-var">dsLHsBind</span></a><span> </span><a href="#local-6989586621684031773"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-114"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldBag</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621684031775"><a href="#local-6989586621684031775"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684031776"><a href="#local-6989586621684031776"><span class="hs-identifier">a'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684031777"><a href="#local-6989586621684031777"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684031778"><a href="#local-6989586621684031778"><span class="hs-identifier">b'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031775"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684031777"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684031776"><span class="hs-identifier hs-var">a'</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684031778"><span class="hs-identifier hs-var">b'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-115"></a><span>                         </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684031774"><span class="hs-identifier hs-var">ds_bs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-116"></a><span>
</span><a name="line-117"></a><span class="hs-comment">------------------------</span><span>
</span><a name="line-118"></a><span class="hs-identifier">dsLHsBind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsBind</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-119"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-120"></a><a name="dsLHsBind"><a href="DsBinds.html#dsLHsBind"><span class="hs-identifier">dsLHsBind</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621684031779"><a href="#local-6989586621684031779"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621684031780"><a href="#local-6989586621684031780"><span class="hs-identifier">bind</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621684031781"><a href="#local-6989586621684031781"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-121"></a><span>                                </span><a href="DsMonad.html#putSrcSpanDs"><span class="hs-identifier hs-var">putSrcSpanDs</span></a><span> </span><a href="#local-6989586621684031779"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="DsBinds.html#dsHsBind"><span class="hs-identifier hs-var">dsHsBind</span></a><span> </span><a href="#local-6989586621684031781"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684031780"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-122"></a><span>
</span><a name="line-123"></a><span class="hs-comment">-- | Desugar a single binding (or group of recursive binds).</span><span>
</span><a name="line-124"></a><span class="hs-identifier">dsHsBind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-125"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsBind</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-126"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-127"></a><span>         </span><span class="hs-comment">-- ^ The Ids of strict binds, to be forced in the body of the</span><span>
</span><a name="line-128"></a><span>         </span><span class="hs-comment">-- binding group see Note [Desugar Strict binds] and all</span><span>
</span><a name="line-129"></a><span>         </span><span class="hs-comment">-- bindings and their desugared right hand sides.</span><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><a name="dsHsBind"><a href="DsBinds.html#dsHsBind"><span class="hs-identifier">dsHsBind</span></a></a><span> </span><a name="local-6989586621684031782"><a href="#local-6989586621684031782"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarBind</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">var_id</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031783"><a href="#local-6989586621684031783"><span class="hs-identifier">var</span></a></a><span>
</span><a name="line-132"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">var_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031784"><a href="#local-6989586621684031784"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-133"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">var_inline</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031785"><a href="#local-6989586621684031785"><span class="hs-identifier">inline_regardless</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-134"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684031786"><a href="#local-6989586621684031786"><span class="hs-identifier">core_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684031784"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-135"></a><span>                </span><span class="hs-comment">-- Dictionary bindings are always VarBinds,</span><span>
</span><a name="line-136"></a><span>                </span><span class="hs-comment">-- so we only need do this here</span><span>
</span><a name="line-137"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684031787"><a href="#local-6989586621684031787"><span class="hs-identifier">var'</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684031785"><span class="hs-identifier hs-var">inline_regardless</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684031783"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setIdUnfolding</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">mkCompulsoryUnfolding</span><span> </span><a href="#local-6989586621684031786"><span class="hs-identifier hs-var">core_expr</span></a><span>
</span><a name="line-138"></a><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684031783"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-139"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684031788"><a href="#local-6989586621684031788"><span class="hs-identifier">core_bind</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621684031789"><a href="#local-6989586621684031789"><span class="hs-identifier">id</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsBinds.html#makeCorePair"><span class="hs-identifier hs-var">makeCorePair</span></a><span> </span><a href="#local-6989586621684031782"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684031787"><span class="hs-identifier hs-var">var'</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621684031786"><span class="hs-identifier hs-var">core_expr</span></a><span>
</span><a name="line-140"></a><span>              </span><a name="local-6989586621684031790"><a href="#local-6989586621684031790"><span class="hs-identifier">force_var</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">xopt</span><span> </span><span class="hs-identifier hs-var">LangExt.Strict</span><span> </span><a href="#local-6989586621684031782"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-141"></a><span>                          </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684031789"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">]</span><span>
</span><a name="line-142"></a><span>                          </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-143"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031790"><span class="hs-identifier hs-var">force_var</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684031788"><span class="hs-identifier hs-var">core_bind</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-144"></a><span>
</span><a name="line-145"></a><span class="hs-identifier">dsHsBind</span><span> </span><a name="local-6989586621684031791"><a href="#local-6989586621684031791"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684031792"><a href="#local-6989586621684031792"><span class="hs-identifier">b</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunBind</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fun_id</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684031793"><a href="#local-6989586621684031793"><span class="hs-identifier">fun</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-146"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fun_matches</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031794"><a href="#local-6989586621684031794"><span class="hs-identifier">matches</span></a></a><span>
</span><a name="line-147"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fun_co_fn</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031795"><a href="#local-6989586621684031795"><span class="hs-identifier">co_fn</span></a></a><span>
</span><a name="line-148"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fun_tick</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031796"><a href="#local-6989586621684031796"><span class="hs-identifier">tick</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-149"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>   </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684031797"><a href="#local-6989586621684031797"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684031798"><a href="#local-6989586621684031798"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Match.html#matchWrapper"><span class="hs-identifier hs-var">matchWrapper</span></a><span>
</span><a name="line-150"></a><span>                           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkPrefixFunRhs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621684031793"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-151"></a><span>                           </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621684031794"><span class="hs-identifier hs-var">matches</span></a><span>
</span><a name="line-152"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684031799"><a href="#local-6989586621684031799"><span class="hs-identifier">core_wrap</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#dsHsWrapper"><span class="hs-identifier hs-var">dsHsWrapper</span></a><span> </span><a href="#local-6989586621684031795"><span class="hs-identifier hs-var">co_fn</span></a><span>
</span><a name="line-153"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684031800"><a href="#local-6989586621684031800"><span class="hs-identifier">body'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#mkOptTickBox"><span class="hs-identifier hs-var">mkOptTickBox</span></a><span> </span><a href="#local-6989586621684031796"><span class="hs-identifier hs-var">tick</span></a><span> </span><a href="#local-6989586621684031798"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-154"></a><span>              </span><a name="local-6989586621684031801"><a href="#local-6989586621684031801"><span class="hs-identifier">rhs</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684031799"><span class="hs-identifier hs-var">core_wrap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLams</span><span> </span><a href="#local-6989586621684031797"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621684031800"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">)</span><span>
</span><a name="line-155"></a><span>              </span><a name="local-6989586621684031802"><a href="#local-6989586621684031802"><span class="hs-identifier">core_binds</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621684031803"><a href="#local-6989586621684031803"><span class="hs-identifier">id</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsBinds.html#makeCorePair"><span class="hs-identifier hs-var">makeCorePair</span></a><span> </span><a href="#local-6989586621684031791"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684031793"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621684031801"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-156"></a><span>              </span><a name="local-6989586621684031804"><a href="#local-6989586621684031804"><span class="hs-identifier">force_var</span></a></a><span>
</span><a name="line-157"></a><span>                  </span><span class="hs-comment">-- Bindings are strict when -XStrict is enabled</span><span>
</span><a name="line-158"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">xopt</span><span> </span><span class="hs-identifier hs-var">LangExt.Strict</span><span> </span><a href="#local-6989586621684031791"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-159"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">matchGroupArity</span><span> </span><a href="#local-6989586621684031794"><span class="hs-identifier hs-var">matches</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-comment">-- no need to force lambdas</span><span>
</span><a name="line-160"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684031803"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">]</span><span>
</span><a name="line-161"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isBangedHsBind</span><span> </span><a href="#local-6989586621684031792"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-162"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684031803"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">]</span><span>
</span><a name="line-163"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-164"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-165"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-comment">--pprTrace &quot;dsHsBind&quot; (vcat [ ppr fun &lt;+&gt; ppr (idInlinePragma fun)</span><span>
</span><a name="line-166"></a><span>          </span><span class="hs-comment">--                          , ppr (mg_alts matches)</span><span>
</span><a name="line-167"></a><span>          </span><span class="hs-comment">--                          , ppr args, ppr core_binds]) $</span><span>
</span><a name="line-168"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031804"><span class="hs-identifier hs-var">force_var</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684031802"><span class="hs-identifier hs-var">core_binds</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-169"></a><span>
</span><a name="line-170"></a><span class="hs-identifier">dsHsBind</span><span> </span><a name="local-6989586621684031805"><a href="#local-6989586621684031805"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PatBind</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pat_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031806"><a href="#local-6989586621684031806"><span class="hs-identifier">pat</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">pat_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031807"><a href="#local-6989586621684031807"><span class="hs-identifier">grhss</span></a></a><span>
</span><a name="line-171"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pat_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NPatBindTc</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684031808"><a href="#local-6989586621684031808"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-172"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pat_ticks</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684031809"><a href="#local-6989586621684031809"><span class="hs-identifier">rhs_tick</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684031810"><a href="#local-6989586621684031810"><span class="hs-identifier">var_ticks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-173"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684031811"><a href="#local-6989586621684031811"><span class="hs-identifier">body_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsGRHSs.html#dsGuarded"><span class="hs-identifier hs-var">dsGuarded</span></a><span> </span><a href="#local-6989586621684031807"><span class="hs-identifier hs-var">grhss</span></a><span> </span><a href="#local-6989586621684031808"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-174"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="Check.html#checkGuardMatches"><span class="hs-identifier hs-var">checkGuardMatches</span></a><span> </span><span class="hs-identifier hs-var">PatBindGuards</span><span> </span><a href="#local-6989586621684031807"><span class="hs-identifier hs-var">grhss</span></a><span>
</span><a name="line-175"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684031812"><a href="#local-6989586621684031812"><span class="hs-identifier">body'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#mkOptTickBox"><span class="hs-identifier hs-var">mkOptTickBox</span></a><span> </span><a href="#local-6989586621684031809"><span class="hs-identifier hs-var">rhs_tick</span></a><span> </span><a href="#local-6989586621684031811"><span class="hs-identifier hs-var">body_expr</span></a><span>
</span><a name="line-176"></a><span>              </span><a name="local-6989586621684031813"><a href="#local-6989586621684031813"><span class="hs-identifier">pat'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#decideBangHood"><span class="hs-identifier hs-var">decideBangHood</span></a><span> </span><a href="#local-6989586621684031805"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684031806"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-177"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684031814"><a href="#local-6989586621684031814"><span class="hs-identifier">force_var</span></a></a><span class="hs-special">,</span><a name="local-6989586621684031815"><a href="#local-6989586621684031815"><span class="hs-identifier">sel_binds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsUtils.html#mkSelectorBinds"><span class="hs-identifier hs-var">mkSelectorBinds</span></a><span> </span><a href="#local-6989586621684031810"><span class="hs-identifier hs-var">var_ticks</span></a><span> </span><a href="#local-6989586621684031806"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621684031812"><span class="hs-identifier hs-var">body'</span></a><span>
</span><a name="line-178"></a><span>          </span><span class="hs-comment">-- We silently ignore inline pragmas; no makeCorePair</span><span>
</span><a name="line-179"></a><span>          </span><span class="hs-comment">-- Not so cool, but really doesn't matter</span><span>
</span><a name="line-180"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684031816"><a href="#local-6989586621684031816"><span class="hs-identifier">force_var'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isBangedLPat</span><span> </span><a href="#local-6989586621684031813"><span class="hs-identifier hs-var">pat'</span></a><span>
</span><a name="line-181"></a><span>                           </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684031814"><span class="hs-identifier hs-var">force_var</span></a><span class="hs-special">]</span><span>
</span><a name="line-182"></a><span>                           </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-183"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031816"><span class="hs-identifier hs-var">force_var'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684031815"><span class="hs-identifier hs-var">sel_binds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-184"></a><span>
</span><a name="line-185"></a><span class="hs-identifier">dsHsBind</span><span> </span><a name="local-6989586621684031817"><a href="#local-6989586621684031817"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AbsBinds</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">abs_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031818"><a href="#local-6989586621684031818"><span class="hs-identifier">tyvars</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">abs_ev_vars</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031819"><a href="#local-6989586621684031819"><span class="hs-identifier">dicts</span></a></a><span>
</span><a name="line-186"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abs_exports</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031820"><a href="#local-6989586621684031820"><span class="hs-identifier">exports</span></a></a><span>
</span><a name="line-187"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abs_ev_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031821"><a href="#local-6989586621684031821"><span class="hs-identifier">ev_binds</span></a></a><span>
</span><a name="line-188"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abs_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031822"><a href="#local-6989586621684031822"><span class="hs-identifier">binds</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">abs_sig</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031823"><a href="#local-6989586621684031823"><span class="hs-identifier">has_sig</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-189"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684031824"><a href="#local-6989586621684031824"><span class="hs-identifier">ds_binds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#addDictsDs"><span class="hs-identifier hs-var">addDictsDs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">listToBag</span><span> </span><a href="#local-6989586621684031819"><span class="hs-identifier hs-var">dicts</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-190"></a><span>                     </span><a href="DsBinds.html#dsLHsBinds"><span class="hs-identifier hs-var">dsLHsBinds</span></a><span> </span><a href="#local-6989586621684031822"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-191"></a><span>                         </span><span class="hs-comment">-- addDictsDs: push type constraints deeper</span><span>
</span><a name="line-192"></a><span>                         </span><span class="hs-comment">--             for inner pattern match check</span><span>
</span><a name="line-193"></a><span>                         </span><span class="hs-comment">-- See Check, Note [Type and Term Equality Propagation]</span><span>
</span><a name="line-194"></a><span>
</span><a name="line-195"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684031825"><a href="#local-6989586621684031825"><span class="hs-identifier">ds_ev_binds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#dsTcEvBinds_s"><span class="hs-identifier hs-var">dsTcEvBinds_s</span></a><span> </span><a href="#local-6989586621684031821"><span class="hs-identifier hs-var">ev_binds</span></a><span>
</span><a name="line-196"></a><span>
</span><a name="line-197"></a><span>       </span><span class="hs-comment">-- dsAbsBinds does the hard work</span><span>
</span><a name="line-198"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="DsBinds.html#dsAbsBinds"><span class="hs-identifier hs-var">dsAbsBinds</span></a><span> </span><a href="#local-6989586621684031817"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684031818"><span class="hs-identifier hs-var">tyvars</span></a><span> </span><a href="#local-6989586621684031819"><span class="hs-identifier hs-var">dicts</span></a><span> </span><a href="#local-6989586621684031820"><span class="hs-identifier hs-var">exports</span></a><span> </span><a href="#local-6989586621684031825"><span class="hs-identifier hs-var">ds_ev_binds</span></a><span> </span><a href="#local-6989586621684031824"><span class="hs-identifier hs-var">ds_binds</span></a><span> </span><a href="#local-6989586621684031823"><span class="hs-identifier hs-var">has_sig</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-199"></a><span>
</span><a name="line-200"></a><span class="hs-identifier">dsHsBind</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PatSynBind</span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsHsBind: PatSynBind&quot;</span><span>
</span><a name="line-201"></a><span class="hs-identifier">dsHsBind</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsBindsLR</span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsHsBind: XHsBindsLR&quot;</span><span>
</span><a name="line-202"></a><span>
</span><a name="line-203"></a><span>
</span><a name="line-204"></a><span class="hs-comment">-----------------------</span><span>
</span><a name="line-205"></a><span class="hs-identifier">dsAbsBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-206"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">EvVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ABExport</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">]</span><span>
</span><a name="line-207"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreBind</span><span class="hs-special">]</span><span>                </span><span class="hs-comment">-- Desugared evidence bindings</span><span>
</span><a name="line-208"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Desugared value bindings</span><span>
</span><a name="line-209"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>                      </span><span class="hs-comment">-- Single binding with signature</span><span>
</span><a name="line-210"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-211"></a><span>
</span><a name="line-212"></a><a name="dsAbsBinds"><a href="DsBinds.html#dsAbsBinds"><span class="hs-identifier">dsAbsBinds</span></a></a><span> </span><a name="local-6989586621684031826"><a href="#local-6989586621684031826"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684031827"><a href="#local-6989586621684031827"><span class="hs-identifier">tyvars</span></a></a><span> </span><a name="local-6989586621684031828"><a href="#local-6989586621684031828"><span class="hs-identifier">dicts</span></a></a><span> </span><a name="local-6989586621684031829"><a href="#local-6989586621684031829"><span class="hs-identifier">exports</span></a></a><span>
</span><a name="line-213"></a><span>           </span><a name="local-6989586621684031830"><a href="#local-6989586621684031830"><span class="hs-identifier">ds_ev_binds</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684031831"><a href="#local-6989586621684031831"><span class="hs-identifier">force_vars</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684031832"><a href="#local-6989586621684031832"><span class="hs-identifier">bind_prs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684031833"><a href="#local-6989586621684031833"><span class="hs-identifier">has_sig</span></a></a><span>
</span><a name="line-214"></a><span>
</span><a name="line-215"></a><span>    </span><span class="hs-comment">-- A very important common case: one exported variable</span><span>
</span><a name="line-216"></a><span>    </span><span class="hs-comment">-- Non-recursive bindings come through this way</span><span>
</span><a name="line-217"></a><span>    </span><span class="hs-comment">-- So do self-recursive bindings</span><span>
</span><a name="line-218"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">[</span><span class="hs-keyword">export</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684031829"><span class="hs-identifier hs-var">exports</span></a><span>
</span><a name="line-219"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ABE</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">abe_poly</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031859"><a href="#local-6989586621684031859"><span class="hs-identifier">global_id</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">abe_mono</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031860"><a href="#local-6989586621684031860"><span class="hs-identifier">local_id</span></a></a><span>
</span><a name="line-220"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abe_wrap</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031861"><a href="#local-6989586621684031861"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">abe_prags</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031862"><a href="#local-6989586621684031862"><span class="hs-identifier">prags</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">export</span><span>
</span><a name="line-221"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684031864"><a href="#local-6989586621684031864"><span class="hs-identifier">force_vars'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684031831"><span class="hs-identifier hs-var">force_vars</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-222"></a><span>                           </span><span class="hs-special">[</span><span class="hs-special">]</span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-223"></a><span>                           </span><span class="hs-special">[</span><a name="local-6989586621684031863"><a href="#local-6989586621684031863"><span class="hs-identifier">v</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684031863"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684031860"><span class="hs-identifier hs-var">local_id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684031859"><span class="hs-identifier hs-var">global_id</span></a><span class="hs-special">]</span><span>
</span><a name="line-224"></a><span>                           </span><span class="hs-identifier">_</span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-225"></a><span>       </span><span class="hs-comment">-- If there is a variable to force, it's just the</span><span>
</span><a name="line-226"></a><span>       </span><span class="hs-comment">-- single variable we are binding here</span><span>
</span><a name="line-227"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684031865"><a href="#local-6989586621684031865"><span class="hs-identifier">core_wrap</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#dsHsWrapper"><span class="hs-identifier hs-var">dsHsWrapper</span></a><span> </span><a href="#local-6989586621684031861"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-comment">-- Usually the identity</span><span>
</span><a name="line-228"></a><span>
</span><a name="line-229"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684031866"><a href="#local-6989586621684031866"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684031865"><span class="hs-identifier hs-var">core_wrap</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-230"></a><span>                   </span><span class="hs-identifier hs-var">mkLams</span><span> </span><a href="#local-6989586621684031827"><span class="hs-identifier hs-var">tyvars</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkLams</span><span> </span><a href="#local-6989586621684031828"><span class="hs-identifier hs-var">dicts</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-231"></a><span>                   </span><span class="hs-identifier hs-var">mkCoreLets</span><span> </span><a href="#local-6989586621684031830"><span class="hs-identifier hs-var">ds_ev_binds</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-232"></a><span>                   </span><a href="#local-6989586621684031867"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-233"></a><span>
</span><a name="line-234"></a><span>             </span><a name="local-6989586621684031867"><a href="#local-6989586621684031867"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684031833"><span class="hs-identifier hs-var">has_sig</span></a><span>
</span><a name="line-235"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684031868"><a href="#local-6989586621684031868"><span class="hs-identifier">lrhs</span></a></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684031832"><span class="hs-identifier hs-var">bind_prs</span></a><span>
</span><a name="line-236"></a><span>                  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684031868"><span class="hs-identifier hs-var">lrhs</span></a><span>
</span><a name="line-237"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-238"></a><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkLetRec</span><span> </span><a href="#local-6989586621684031832"><span class="hs-identifier hs-var">bind_prs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684031860"><span class="hs-identifier hs-var">local_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-239"></a><span>
</span><a name="line-240"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684031869"><a href="#local-6989586621684031869"><span class="hs-identifier">spec_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684031870"><a href="#local-6989586621684031870"><span class="hs-identifier">rules</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#dsSpecs"><span class="hs-identifier hs-var">dsSpecs</span></a><span> </span><a href="#local-6989586621684031866"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621684031862"><span class="hs-identifier hs-var">prags</span></a><span>
</span><a name="line-241"></a><span>
</span><a name="line-242"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684031871"><a href="#local-6989586621684031871"><span class="hs-identifier">global_id'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addIdSpecialisations</span><span> </span><a href="#local-6989586621684031859"><span class="hs-identifier hs-var">global_id</span></a><span> </span><a href="#local-6989586621684031870"><span class="hs-identifier hs-var">rules</span></a><span>
</span><a name="line-243"></a><span>             </span><a name="local-6989586621684031872"><a href="#local-6989586621684031872"><span class="hs-identifier">main_bind</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsBinds.html#makeCorePair"><span class="hs-identifier hs-var">makeCorePair</span></a><span> </span><a href="#local-6989586621684031826"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684031871"><span class="hs-identifier hs-var">global_id'</span></a><span>
</span><a name="line-244"></a><span>                                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isDefaultMethod</span><span> </span><a href="#local-6989586621684031862"><span class="hs-identifier hs-var">prags</span></a><span class="hs-special">)</span><span>
</span><a name="line-245"></a><span>                                       </span><span class="hs-special">(</span><a href="DsBinds.html#dictArity"><span class="hs-identifier hs-var">dictArity</span></a><span> </span><a href="#local-6989586621684031828"><span class="hs-identifier hs-var">dicts</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684031866"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-246"></a><span>
</span><a name="line-247"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031864"><span class="hs-identifier hs-var">force_vars'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684031872"><span class="hs-identifier hs-var">main_bind</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">fromOL</span><span> </span><a href="#local-6989586621684031869"><span class="hs-identifier hs-var">spec_binds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-248"></a><span>
</span><a name="line-249"></a><span>    </span><span class="hs-comment">-- Another common case: no tyvars, no dicts</span><span>
</span><a name="line-250"></a><span>    </span><span class="hs-comment">-- In this case we can have a much simpler desugaring</span><span>
</span><a name="line-251"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621684031827"><span class="hs-identifier hs-var">tyvars</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621684031828"><span class="hs-identifier hs-var">dicts</span></a><span>
</span><a name="line-252"></a><span>
</span><a name="line-253"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684031873"><a href="#local-6989586621684031873"><span class="hs-identifier">mk_bind</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ABE</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">abe_wrap</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031874"><a href="#local-6989586621684031874"><span class="hs-identifier">wrap</span></a></a><span>
</span><a name="line-254"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abe_poly</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031875"><a href="#local-6989586621684031875"><span class="hs-identifier">global</span></a></a><span>
</span><a name="line-255"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abe_mono</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031876"><a href="#local-6989586621684031876"><span class="hs-identifier">local</span></a></a><span>
</span><a name="line-256"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abe_prags</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031877"><a href="#local-6989586621684031877"><span class="hs-identifier">prags</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-257"></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684031878"><a href="#local-6989586621684031878"><span class="hs-identifier">core_wrap</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#dsHsWrapper"><span class="hs-identifier hs-var">dsHsWrapper</span></a><span> </span><a href="#local-6989586621684031874"><span class="hs-identifier hs-var">wrap</span></a><span>
</span><a name="line-258"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="DsBinds.html#makeCorePair"><span class="hs-identifier hs-var">makeCorePair</span></a><span> </span><a href="#local-6989586621684031826"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684031875"><span class="hs-identifier hs-var">global</span></a><span>
</span><a name="line-259"></a><span>                                          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isDefaultMethod</span><span> </span><a href="#local-6989586621684031877"><span class="hs-identifier hs-var">prags</span></a><span class="hs-special">)</span><span>
</span><a name="line-260"></a><span>                                          </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031878"><span class="hs-identifier hs-var">core_wrap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684031876"><span class="hs-identifier hs-var">local</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-261"></a><span>             </span><span class="hs-identifier">mk_bind</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XABExport</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsAbsBinds&quot;</span><span>
</span><a name="line-262"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684031879"><a href="#local-6989586621684031879"><span class="hs-identifier">main_binds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621684031873"><span class="hs-identifier hs-var">mk_bind</span></a><span> </span><a href="#local-6989586621684031829"><span class="hs-identifier hs-var">exports</span></a><span>
</span><a name="line-263"></a><span>
</span><a name="line-264"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031831"><span class="hs-identifier hs-var">force_vars</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">flattenBinds</span><span> </span><a href="#local-6989586621684031830"><span class="hs-identifier hs-var">ds_ev_binds</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684031832"><span class="hs-identifier hs-var">bind_prs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684031879"><span class="hs-identifier hs-var">main_binds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-265"></a><span>
</span><a name="line-266"></a><span>    </span><span class="hs-comment">-- The general case</span><span>
</span><a name="line-267"></a><span>    </span><span class="hs-comment">-- See Note [Desugaring AbsBinds]</span><span>
</span><a name="line-268"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-269"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684031880"><a href="#local-6989586621684031880"><span class="hs-identifier">core_bind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Rec</span><span> </span><span class="hs-special">[</span><span> </span><a href="DsBinds.html#makeCorePair"><span class="hs-identifier hs-var">makeCorePair</span></a><span> </span><a href="#local-6989586621684031826"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031835"><span class="hs-identifier hs-var">add_inline</span></a><span> </span><a href="#local-6989586621684031886"><span class="hs-identifier hs-var">lcl_id</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621684031887"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-270"></a><span>                              </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684031886"><a href="#local-6989586621684031886"><span class="hs-identifier">lcl_id</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684031887"><a href="#local-6989586621684031887"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684031832"><span class="hs-identifier hs-var">bind_prs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-271"></a><span>                </span><span class="hs-comment">-- Monomorphic recursion possible, hence Rec</span><span>
</span><a name="line-272"></a><span>             </span><a name="local-6989586621684031881"><a href="#local-6989586621684031881"><span class="hs-identifier">new_force_vars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684031837"><span class="hs-identifier hs-var">get_new_force_vars</span></a><span> </span><a href="#local-6989586621684031831"><span class="hs-identifier hs-var">force_vars</span></a><span>
</span><a name="line-273"></a><span>             </span><a name="local-6989586621684031882"><a href="#local-6989586621684031882"><span class="hs-identifier">locals</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">abe_mono</span><span> </span><a href="#local-6989586621684031829"><span class="hs-identifier hs-var">exports</span></a><span>
</span><a name="line-274"></a><span>             </span><a name="local-6989586621684031883"><a href="#local-6989586621684031883"><span class="hs-identifier">all_locals</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684031882"><span class="hs-identifier hs-var">locals</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684031881"><span class="hs-identifier hs-var">new_force_vars</span></a><span>
</span><a name="line-275"></a><span>             </span><a name="local-6989586621684031884"><a href="#local-6989586621684031884"><span class="hs-identifier">tup_expr</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkBigCoreVarTup</span><span> </span><a href="#local-6989586621684031883"><span class="hs-identifier hs-var">all_locals</span></a><span>
</span><a name="line-276"></a><span>             </span><a name="local-6989586621684031885"><a href="#local-6989586621684031885"><span class="hs-identifier">tup_ty</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">exprType</span><span> </span><a href="#local-6989586621684031884"><span class="hs-identifier hs-var">tup_expr</span></a><span>
</span><a name="line-277"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684031888"><a href="#local-6989586621684031888"><span class="hs-identifier">poly_tup_rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkLams</span><span> </span><a href="#local-6989586621684031827"><span class="hs-identifier hs-var">tyvars</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkLams</span><span> </span><a href="#local-6989586621684031828"><span class="hs-identifier hs-var">dicts</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-278"></a><span>                            </span><span class="hs-identifier hs-var">mkCoreLets</span><span> </span><a href="#local-6989586621684031830"><span class="hs-identifier hs-var">ds_ev_binds</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-279"></a><span>                            </span><span class="hs-identifier hs-var">mkLet</span><span> </span><a href="#local-6989586621684031880"><span class="hs-identifier hs-var">core_bind</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-280"></a><span>                            </span><a href="#local-6989586621684031884"><span class="hs-identifier hs-var">tup_expr</span></a><span>
</span><a name="line-281"></a><span>
</span><a name="line-282"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684031889"><a href="#local-6989586621684031889"><span class="hs-identifier">poly_tup_id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#newSysLocalDs"><span class="hs-identifier hs-var">newSysLocalDs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprType</span><span> </span><a href="#local-6989586621684031888"><span class="hs-identifier hs-var">poly_tup_rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-283"></a><span>
</span><a name="line-284"></a><span>        </span><span class="hs-comment">-- Find corresponding global or make up a new one: sometimes</span><span>
</span><a name="line-285"></a><span>        </span><span class="hs-comment">-- we need to make new export to desugar strict binds, see</span><span>
</span><a name="line-286"></a><span>        </span><span class="hs-comment">-- Note [Desugar Strict binds]</span><span>
</span><a name="line-287"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684031890"><a href="#local-6989586621684031890"><span class="hs-identifier">exported_force_vars</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684031891"><a href="#local-6989586621684031891"><span class="hs-identifier">extra_exports</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684031838"><span class="hs-identifier hs-var">get_exports</span></a><span> </span><a href="#local-6989586621684031831"><span class="hs-identifier hs-var">force_vars</span></a><span>
</span><a name="line-288"></a><span>
</span><a name="line-289"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684031892"><a href="#local-6989586621684031892"><span class="hs-identifier">mk_bind</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ABE</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">abe_wrap</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031893"><a href="#local-6989586621684031893"><span class="hs-identifier">wrap</span></a></a><span>
</span><a name="line-290"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abe_poly</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031894"><a href="#local-6989586621684031894"><span class="hs-identifier">global</span></a></a><span>
</span><a name="line-291"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abe_mono</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031895"><a href="#local-6989586621684031895"><span class="hs-identifier">local</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">abe_prags</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031896"><a href="#local-6989586621684031896"><span class="hs-identifier">spec_prags</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-292"></a><span>                          </span><span class="hs-comment">-- See Note [AbsBinds wrappers] in HsBinds</span><span>
</span><a name="line-293"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684031897"><a href="#local-6989586621684031897"><span class="hs-identifier">tup_id</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#newSysLocalDs"><span class="hs-identifier hs-var">newSysLocalDs</span></a><span> </span><a href="#local-6989586621684031885"><span class="hs-identifier hs-var">tup_ty</span></a><span>
</span><a name="line-294"></a><span>                     </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684031898"><a href="#local-6989586621684031898"><span class="hs-identifier">core_wrap</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#dsHsWrapper"><span class="hs-identifier hs-var">dsHsWrapper</span></a><span> </span><a href="#local-6989586621684031893"><span class="hs-identifier hs-var">wrap</span></a><span>
</span><a name="line-295"></a><span>                     </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684031899"><a href="#local-6989586621684031899"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684031898"><span class="hs-identifier hs-var">core_wrap</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkLams</span><span> </span><a href="#local-6989586621684031827"><span class="hs-identifier hs-var">tyvars</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkLams</span><span> </span><a href="#local-6989586621684031828"><span class="hs-identifier hs-var">dicts</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-296"></a><span>                                 </span><span class="hs-identifier hs-var">mkTupleSelector</span><span> </span><a href="#local-6989586621684031883"><span class="hs-identifier hs-var">all_locals</span></a><span> </span><a href="#local-6989586621684031895"><span class="hs-identifier hs-var">local</span></a><span> </span><a href="#local-6989586621684031897"><span class="hs-identifier hs-var">tup_id</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-297"></a><span>                                 </span><span class="hs-identifier hs-var">mkVarApps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684031889"><span class="hs-identifier hs-var">poly_tup_id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031827"><span class="hs-identifier hs-var">tyvars</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684031828"><span class="hs-identifier hs-var">dicts</span></a><span class="hs-special">)</span><span>
</span><a name="line-298"></a><span>                           </span><a name="local-6989586621684031900"><a href="#local-6989586621684031900"><span class="hs-identifier">rhs_for_spec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621684031889"><span class="hs-identifier hs-var">poly_tup_id</span></a><span> </span><a href="#local-6989586621684031888"><span class="hs-identifier hs-var">poly_tup_rhs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684031899"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-299"></a><span>                     </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684031901"><a href="#local-6989586621684031901"><span class="hs-identifier">spec_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684031902"><a href="#local-6989586621684031902"><span class="hs-identifier">rules</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#dsSpecs"><span class="hs-identifier hs-var">dsSpecs</span></a><span> </span><a href="#local-6989586621684031900"><span class="hs-identifier hs-var">rhs_for_spec</span></a><span> </span><a href="#local-6989586621684031896"><span class="hs-identifier hs-var">spec_prags</span></a><span>
</span><a name="line-300"></a><span>                     </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684031903"><a href="#local-6989586621684031903"><span class="hs-identifier">global'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031894"><span class="hs-identifier hs-var">global</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setInlinePragma</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">defaultInlinePragma</span><span class="hs-special">)</span><span>
</span><a name="line-301"></a><span>                                             </span><span class="hs-special">`</span><span class="hs-identifier hs-var">addIdSpecialisations</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684031902"><span class="hs-identifier hs-var">rules</span></a><span>
</span><a name="line-302"></a><span>                           </span><span class="hs-comment">-- Kill the INLINE pragma because it applies to</span><span>
</span><a name="line-303"></a><span>                           </span><span class="hs-comment">-- the user written (local) function.  The global</span><span>
</span><a name="line-304"></a><span>                           </span><span class="hs-comment">-- Id is just the selector.  Hmm.</span><span>
</span><a name="line-305"></a><span>                     </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621684031903"><span class="hs-identifier hs-var">global'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684031899"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">fromOL</span><span> </span><a href="#local-6989586621684031901"><span class="hs-identifier hs-var">spec_binds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-306"></a><span>             </span><span class="hs-identifier">mk_bind</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XABExport</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsAbsBinds&quot;</span><span>
</span><a name="line-307"></a><span>
</span><a name="line-308"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684031904"><a href="#local-6989586621684031904"><span class="hs-identifier">export_binds_s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621684031892"><span class="hs-identifier hs-var">mk_bind</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031829"><span class="hs-identifier hs-var">exports</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684031891"><span class="hs-identifier hs-var">extra_exports</span></a><span class="hs-special">)</span><span>
</span><a name="line-309"></a><span>
</span><a name="line-310"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621684031890"><span class="hs-identifier hs-var">exported_force_vars</span></a><span>
</span><a name="line-311"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031889"><span class="hs-identifier hs-var">poly_tup_id</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684031888"><span class="hs-identifier hs-var">poly_tup_rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span>
</span><a name="line-312"></a><span>                   </span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-6989586621684031904"><span class="hs-identifier hs-var">export_binds_s</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-313"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-314"></a><span>    </span><span class="hs-identifier">inline_env</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IdEnv</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-comment">-- Maps a monomorphic local Id to one with</span><span>
</span><a name="line-315"></a><span>                             </span><span class="hs-comment">-- the inline pragma from the source</span><span>
</span><a name="line-316"></a><span>                             </span><span class="hs-comment">-- The type checker put the inline pragma</span><span>
</span><a name="line-317"></a><span>                             </span><span class="hs-comment">-- on the *global* Id, so we need to transfer it</span><span>
</span><a name="line-318"></a><span>    </span><a name="local-6989586621684031834"><a href="#local-6989586621684031834"><span class="hs-identifier">inline_env</span></a></a><span>
</span><a name="line-319"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkVarEnv</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031840"><span class="hs-identifier hs-var">lcl_id</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">setInlinePragma</span><span> </span><a href="#local-6989586621684031840"><span class="hs-identifier hs-var">lcl_id</span></a><span> </span><a href="#local-6989586621684031842"><span class="hs-identifier hs-var">prag</span></a><span class="hs-special">)</span><span>
</span><a name="line-320"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">ABE</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">abe_mono</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031840"><a href="#local-6989586621684031840"><span class="hs-identifier">lcl_id</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">abe_poly</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031841"><a href="#local-6989586621684031841"><span class="hs-identifier">gbl_id</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684031829"><span class="hs-identifier hs-var">exports</span></a><span>
</span><a name="line-321"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684031842"><a href="#local-6989586621684031842"><span class="hs-identifier">prag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idInlinePragma</span><span> </span><a href="#local-6989586621684031841"><span class="hs-identifier hs-var">gbl_id</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-322"></a><span>
</span><a name="line-323"></a><span>    </span><span class="hs-identifier">add_inline</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span>    </span><span class="hs-comment">-- tran</span><span>
</span><a name="line-324"></a><span>    </span><a name="local-6989586621684031835"><a href="#local-6989586621684031835"><span class="hs-identifier">add_inline</span></a></a><span> </span><a name="local-6989586621684031843"><a href="#local-6989586621684031843"><span class="hs-identifier">lcl_id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupVarEnv</span><span> </span><a href="#local-6989586621684031834"><span class="hs-identifier hs-var">inline_env</span></a><span> </span><a href="#local-6989586621684031843"><span class="hs-identifier hs-var">lcl_id</span></a><span>
</span><a name="line-325"></a><span>                        </span><span class="hs-special">`</span><span class="hs-identifier hs-var">orElse</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684031843"><span class="hs-identifier hs-var">lcl_id</span></a><span>
</span><a name="line-326"></a><span>
</span><a name="line-327"></a><span>    </span><span class="hs-identifier">global_env</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IdEnv</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-comment">-- Maps local Id to its global exported Id</span><span>
</span><a name="line-328"></a><span>    </span><a name="local-6989586621684031836"><a href="#local-6989586621684031836"><span class="hs-identifier">global_env</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-329"></a><span>      </span><span class="hs-identifier hs-var">mkVarEnv</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031844"><span class="hs-identifier hs-var">local</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684031845"><span class="hs-identifier hs-var">global</span></a><span class="hs-special">)</span><span>
</span><a name="line-330"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">ABE</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">abe_mono</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031844"><a href="#local-6989586621684031844"><span class="hs-identifier">local</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">abe_poly</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684031845"><a href="#local-6989586621684031845"><span class="hs-identifier">global</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684031829"><span class="hs-identifier hs-var">exports</span></a><span>
</span><a name="line-331"></a><span>               </span><span class="hs-special">]</span><span>
</span><a name="line-332"></a><span>
</span><a name="line-333"></a><span>    </span><span class="hs-comment">-- find variables that are not exported</span><span>
</span><a name="line-334"></a><span>    </span><a name="local-6989586621684031837"><a href="#local-6989586621684031837"><span class="hs-identifier">get_new_force_vars</span></a></a><span> </span><a name="local-6989586621684031846"><a href="#local-6989586621684031846"><span class="hs-identifier">lcls</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-335"></a><span>      </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684031847"><a href="#local-6989586621684031847"><span class="hs-identifier">lcl</span></a></a><span> </span><a name="local-6989586621684031848"><a href="#local-6989586621684031848"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupVarEnv</span><span> </span><a href="#local-6989586621684031836"><span class="hs-identifier hs-var">global_env</span></a><span> </span><a href="#local-6989586621684031847"><span class="hs-identifier hs-var">lcl</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-336"></a><span>                           </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684031848"><span class="hs-identifier hs-var">acc</span></a><span>
</span><a name="line-337"></a><span>                           </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684031847"><span class="hs-identifier hs-var">lcl</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684031848"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">)</span><span>
</span><a name="line-338"></a><span>            </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621684031846"><span class="hs-identifier hs-var">lcls</span></a><span>
</span><a name="line-339"></a><span>
</span><a name="line-340"></a><span>    </span><span class="hs-comment">-- find exports or make up new exports for force variables</span><span>
</span><a name="line-341"></a><span>    </span><span class="hs-identifier">get_exports</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ABExport</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-342"></a><span>    </span><a name="local-6989586621684031838"><a href="#local-6989586621684031838"><span class="hs-identifier">get_exports</span></a></a><span> </span><a name="local-6989586621684031849"><a href="#local-6989586621684031849"><span class="hs-identifier">lcls</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-343"></a><span>      </span><span class="hs-identifier hs-var">foldM</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621684031850"><a href="#local-6989586621684031850"><span class="hs-identifier">glbls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684031851"><a href="#local-6989586621684031851"><span class="hs-identifier">exports</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684031852"><a href="#local-6989586621684031852"><span class="hs-identifier">lcl</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-344"></a><span>              </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupVarEnv</span><span> </span><a href="#local-6989586621684031836"><span class="hs-identifier hs-var">global_env</span></a><span> </span><a href="#local-6989586621684031852"><span class="hs-identifier hs-var">lcl</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-345"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684031853"><a href="#local-6989586621684031853"><span class="hs-identifier">glbl</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031853"><span class="hs-identifier hs-var">glbl</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684031850"><span class="hs-identifier hs-var">glbls</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684031851"><span class="hs-identifier hs-var">exports</span></a><span class="hs-special">)</span><span>
</span><a name="line-346"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">export</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684031839"><span class="hs-identifier hs-var">mk_export</span></a><span> </span><a href="#local-6989586621684031852"><span class="hs-identifier hs-var">lcl</span></a><span>
</span><a name="line-347"></a><span>                                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684031855"><a href="#local-6989586621684031855"><span class="hs-identifier">glbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">abe_poly</span><span> </span><span class="hs-keyword">export</span><span>
</span><a name="line-348"></a><span>                                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031855"><span class="hs-identifier hs-var">glbl</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684031850"><span class="hs-identifier hs-var">glbls</span></a><span class="hs-special">,</span><span> </span><span class="hs-keyword">export</span><span class="hs-glyph">:</span><a href="#local-6989586621684031851"><span class="hs-identifier hs-var">exports</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-349"></a><span>            </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684031849"><span class="hs-identifier hs-var">lcls</span></a><span>
</span><a name="line-350"></a><span>
</span><a name="line-351"></a><span>    </span><a name="local-6989586621684031839"><a href="#local-6989586621684031839"><span class="hs-identifier">mk_export</span></a></a><span> </span><a name="local-6989586621684031856"><a href="#local-6989586621684031856"><span class="hs-identifier">local</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-352"></a><span>      </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621684031857"><a href="#local-6989586621684031857"><span class="hs-identifier">global</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#newSysLocalDs"><span class="hs-identifier hs-var">newSysLocalDs</span></a><span>
</span><a name="line-353"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLams</span><span> </span><a href="#local-6989586621684031827"><span class="hs-identifier hs-var">tyvars</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLams</span><span> </span><a href="#local-6989586621684031828"><span class="hs-identifier hs-var">dicts</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684031856"><span class="hs-identifier hs-var">local</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-354"></a><span>         </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ABE</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">abe_ext</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-355"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abe_poly</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684031857"><span class="hs-identifier hs-var">global</span></a><span>
</span><a name="line-356"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abe_mono</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684031856"><span class="hs-identifier hs-var">local</span></a><span>
</span><a name="line-357"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abe_wrap</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">WpHole</span><span>
</span><a name="line-358"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abe_prags</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">SpecPrags</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-359"></a><span>
</span><a name="line-360"></a><span class="hs-comment">-- | This is where we apply INLINE and INLINABLE pragmas. All we need to</span><span>
</span><a name="line-361"></a><span class="hs-comment">-- do is to attach the unfolding information to the Id.</span><span>
</span><a name="line-362"></a><span class="hs-comment">--</span><span>
</span><a name="line-363"></a><span class="hs-comment">-- Other decisions about whether to inline are made in</span><span>
</span><a name="line-364"></a><span class="hs-comment">-- `calcUnfoldingGuidance` but the decision about whether to then expose</span><span>
</span><a name="line-365"></a><span class="hs-comment">-- the unfolding in the interface file is made in `TidyPgm.addExternal`</span><span>
</span><a name="line-366"></a><span class="hs-comment">-- using this information.</span><span>
</span><a name="line-367"></a><span class="hs-comment">------------------------</span><span>
</span><a name="line-368"></a><span class="hs-identifier">makeCorePair</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Arity</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-369"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span>
</span><a name="line-370"></a><a name="makeCorePair"><a href="DsBinds.html#makeCorePair"><span class="hs-identifier">makeCorePair</span></a></a><span> </span><a name="local-6989586621684031905"><a href="#local-6989586621684031905"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684031906"><a href="#local-6989586621684031906"><span class="hs-identifier">gbl_id</span></a></a><span> </span><a name="local-6989586621684031907"><a href="#local-6989586621684031907"><span class="hs-identifier">is_default_method</span></a></a><span> </span><a name="local-6989586621684031908"><a href="#local-6989586621684031908"><span class="hs-identifier">dict_arity</span></a></a><span> </span><a name="local-6989586621684031909"><a href="#local-6989586621684031909"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-371"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684031907"><span class="hs-identifier hs-var">is_default_method</span></a><span>    </span><span class="hs-comment">-- Default methods are *always* inlined</span><span>
</span><a name="line-372"></a><span>                         </span><span class="hs-comment">-- See Note [INLINE and default methods] in TcInstDcls</span><span>
</span><a name="line-373"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031906"><span class="hs-identifier hs-var">gbl_id</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setIdUnfolding</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">mkCompulsoryUnfolding</span><span> </span><a href="#local-6989586621684031909"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684031909"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-374"></a><span>
</span><a name="line-375"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-376"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">inlinePragmaSpec</span><span> </span><a href="#local-6989586621684031910"><span class="hs-identifier hs-var">inline_prag</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-377"></a><span>          </span><span class="hs-identifier hs-var">NoUserInline</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031906"><span class="hs-identifier hs-var">gbl_id</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684031909"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-378"></a><span>          </span><span class="hs-identifier hs-var">NoInline</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031906"><span class="hs-identifier hs-var">gbl_id</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684031909"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-379"></a><span>          </span><span class="hs-identifier hs-var">Inlinable</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031906"><span class="hs-identifier hs-var">gbl_id</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setIdUnfolding</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684031911"><span class="hs-identifier hs-var">inlinable_unf</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684031909"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-380"></a><span>          </span><span class="hs-identifier hs-var">Inline</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684031912"><span class="hs-identifier hs-var">inline_pair</span></a><span>
</span><a name="line-381"></a><span>
</span><a name="line-382"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-383"></a><span>    </span><a name="local-6989586621684031910"><a href="#local-6989586621684031910"><span class="hs-identifier">inline_prag</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idInlinePragma</span><span> </span><a href="#local-6989586621684031906"><span class="hs-identifier hs-var">gbl_id</span></a><span>
</span><a name="line-384"></a><span>    </span><a name="local-6989586621684031911"><a href="#local-6989586621684031911"><span class="hs-identifier">inlinable_unf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkInlinableUnfolding</span><span> </span><a href="#local-6989586621684031905"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684031909"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-385"></a><span>    </span><a name="local-6989586621684031912"><a href="#local-6989586621684031912"><span class="hs-identifier">inline_pair</span></a></a><span>
</span><a name="line-386"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684031913"><a href="#local-6989586621684031913"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">inlinePragmaSat</span><span> </span><a href="#local-6989586621684031910"><span class="hs-identifier hs-var">inline_prag</span></a><span>
</span><a name="line-387"></a><span>        </span><span class="hs-comment">-- Add an Unfolding for an INLINE (but not for NOINLINE)</span><span>
</span><a name="line-388"></a><span>        </span><span class="hs-comment">-- And eta-expand the RHS; see Note [Eta-expanding INLINE things]</span><span>
</span><a name="line-389"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684031914"><a href="#local-6989586621684031914"><span class="hs-identifier">real_arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684031908"><span class="hs-identifier hs-var">dict_arity</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621684031913"><span class="hs-identifier hs-var">arity</span></a><span>
</span><a name="line-390"></a><span>        </span><span class="hs-comment">-- NB: The arity in the InlineRule takes account of the dictionaries</span><span>
</span><a name="line-391"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621684031906"><span class="hs-identifier hs-var">gbl_id</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setIdUnfolding</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">mkInlineUnfoldingWithArity</span><span> </span><a href="#local-6989586621684031914"><span class="hs-identifier hs-var">real_arity</span></a><span> </span><a href="#local-6989586621684031909"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-392"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">etaExpand</span><span> </span><a href="#local-6989586621684031914"><span class="hs-identifier hs-var">real_arity</span></a><span> </span><a href="#local-6989586621684031909"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-393"></a><span>
</span><a name="line-394"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-395"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprTrace</span><span> </span><span class="hs-string">&quot;makeCorePair: arity missing&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684031906"><span class="hs-identifier hs-var">gbl_id</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-396"></a><span>         </span><span class="hs-special">(</span><a href="#local-6989586621684031906"><span class="hs-identifier hs-var">gbl_id</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setIdUnfolding</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">mkInlineUnfolding</span><span> </span><a href="#local-6989586621684031909"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684031909"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-397"></a><span>
</span><a name="line-398"></a><span class="hs-identifier">dictArity</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Var</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Arity</span><span>
</span><a name="line-399"></a><span class="hs-comment">-- Don't count coercion variables in arity</span><span>
</span><a name="line-400"></a><a name="dictArity"><a href="DsBinds.html#dictArity"><span class="hs-identifier">dictArity</span></a></a><span> </span><a name="local-6989586621684031915"><a href="#local-6989586621684031915"><span class="hs-identifier">dicts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">count</span><span> </span><span class="hs-identifier hs-var">isId</span><span> </span><a href="#local-6989586621684031915"><span class="hs-identifier hs-var">dicts</span></a><span>
</span><a name="line-401"></a><span>
</span><a name="line-402"></a><span class="hs-comment">{-
Note [Desugaring AbsBinds]
~~~~~~~~~~~~~~~~~~~~~~~~~~
In the general AbsBinds case we desugar the binding to this:

       tup a (d:Num a) = let fm = ...gm...
                             gm = ...fm...
                         in (fm,gm)
       f a d = case tup a d of { (fm,gm) -&gt; fm }
       g a d = case tup a d of { (fm,gm) -&gt; fm }

Note [Rules and inlining]
~~~~~~~~~~~~~~~~~~~~~~~~~
Common special case: no type or dictionary abstraction
This is a bit less trivial than you might suppose
The naive way would be to desugar to something like
        f_lcl = ...f_lcl...     -- The &quot;binds&quot; from AbsBinds
        M.f = f_lcl             -- Generated from &quot;exports&quot;
But we don't want that, because if M.f isn't exported,
it'll be inlined unconditionally at every call site (its rhs is
trivial).  That would be ok unless it has RULES, which would
thereby be completely lost.  Bad, bad, bad.

Instead we want to generate
        M.f = ...f_lcl...
        f_lcl = M.f
Now all is cool. The RULES are attached to M.f (by SimplCore),
and f_lcl is rapidly inlined away.

This does not happen in the same way to polymorphic binds,
because they desugar to
        M.f = /\a. let f_lcl = ...f_lcl... in f_lcl
Although I'm a bit worried about whether full laziness might
float the f_lcl binding out and then inline M.f at its call site

Note [Specialising in no-dict case]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Even if there are no tyvars or dicts, we may have specialisation pragmas.
Class methods can generate
      AbsBinds [] [] [( ... spec-prag]
         { AbsBinds [tvs] [dicts] ...blah }
So the overloading is in the nested AbsBinds. A good example is in GHC.Float:

  class  (Real a, Fractional a) =&gt; RealFrac a  where
    round :: (Integral b) =&gt; a -&gt; b

  instance  RealFrac Float  where
    {-# SPECIALIZE round :: Float -&gt; Int #-}

The top-level AbsBinds for $cround has no tyvars or dicts (because the
instance does not).  But the method is locally overloaded!

Note [Abstracting over tyvars only]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When abstracting over type variable only (not dictionaries), we don't really need to
built a tuple and select from it, as we do in the general case. Instead we can take

        AbsBinds [a,b] [ ([a,b], fg, fl, _),
                         ([b],   gg, gl, _) ]
                { fl = e1
                  gl = e2
                   h = e3 }

and desugar it to

        fg = /\ab. let B in e1
        gg = /\b. let a = () in let B in S(e2)
        h  = /\ab. let B in e3

where B is the *non-recursive* binding
        fl = fg a b
        gl = gg b
        h  = h a b    -- See (b); note shadowing!

Notice (a) g has a different number of type variables to f, so we must
             use the mkArbitraryType thing to fill in the gaps.
             We use a type-let to do that.

         (b) The local variable h isn't in the exports, and rather than
             clone a fresh copy we simply replace h by (h a b), where
             the two h's have different types!  Shadowing happens here,
             which looks confusing but works fine.

         (c) The result is *still* quadratic-sized if there are a lot of
             small bindings.  So if there are more than some small
             number (10), we filter the binding set B by the free
             variables of the particular RHS.  Tiresome.

Why got to this trouble?  It's a common case, and it removes the
quadratic-sized tuple desugaring.  Less clutter, hopefully faster
compilation, especially in a case where there are a *lot* of
bindings.


Note [Eta-expanding INLINE things]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   foo :: Eq a =&gt; a -&gt; a
   {-# INLINE foo #-}
   foo x = ...

If (foo d) ever gets floated out as a common sub-expression (which can
happen as a result of method sharing), there's a danger that we never
get to do the inlining, which is a Terribly Bad thing given that the
user said &quot;inline&quot;!

To avoid this we pre-emptively eta-expand the definition, so that foo
has the arity with which it is declared in the source code.  In this
example it has arity 2 (one for the Eq and one for x). Doing this
should mean that (foo d) is a PAP and we don't share it.

Note [Nested arities]
~~~~~~~~~~~~~~~~~~~~~
For reasons that are not entirely clear, method bindings come out looking like
this:

  AbsBinds [] [] [$cfromT &lt;= [] fromT]
    $cfromT [InlPrag=INLINE] :: T Bool -&gt; Bool
    { AbsBinds [] [] [fromT &lt;= [] fromT_1]
        fromT :: T Bool -&gt; Bool
        { fromT_1 ((TBool b)) = not b } } }

Note the nested AbsBind.  The arity for the InlineRule on $cfromT should be
gotten from the binding for fromT_1.

It might be better to have just one level of AbsBinds, but that requires more
thought!


Note [Desugar Strict binds]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
See https://ghc.haskell.org/trac/ghc/wiki/StrictPragma

Desugaring strict variable bindings looks as follows (core below ==&gt;)

  let !x = rhs
  in  body
==&gt;
  let x = rhs
  in x `seq` body -- seq the variable

and if it is a pattern binding the desugaring looks like

  let !pat = rhs
  in body
==&gt;
  let x = rhs -- bind the rhs to a new variable
      pat = x
  in x `seq` body -- seq the new variable

if there is no variable in the pattern desugaring looks like

  let False = rhs
  in body
==&gt;
  let x = case rhs of {False -&gt; (); _ -&gt; error &quot;Match failed&quot;}
  in x `seq` body

In order to force the Ids in the binding group they are passed around
in the dsHsBind family of functions, and later seq'ed in DsExpr.ds_val_bind.

Consider a recursive group like this

  letrec
     f : g = rhs[f,g]
  in &lt;body&gt;

Without `Strict`, we get a translation like this:

  let t = /\a. letrec tm = rhs[fm,gm]
                      fm = case t of fm:_ -&gt; fm
                      gm = case t of _:gm -&gt; gm
                in
                (fm,gm)

  in let f = /\a. case t a of (fm,_) -&gt; fm
  in let g = /\a. case t a of (_,gm) -&gt; gm
  in &lt;body&gt;

Here `tm` is the monomorphic binding for `rhs`.

With `Strict`, we want to force `tm`, but NOT `fm` or `gm`.
Alas, `tm` isn't in scope in the `in &lt;body&gt;` part.

The simplest thing is to return it in the polymorphic
tuple `t`, thus:

  let t = /\a. letrec tm = rhs[fm,gm]
                      fm = case t of fm:_ -&gt; fm
                      gm = case t of _:gm -&gt; gm
                in
                (tm, fm, gm)

  in let f = /\a. case t a of (_,fm,_) -&gt; fm
  in let g = /\a. case t a of (_,_,gm) -&gt; gm
  in let tm = /\a. case t a of (tm,_,_) -&gt; tm
  in tm `seq` &lt;body&gt;


See https://ghc.haskell.org/trac/ghc/wiki/StrictPragma for a more
detailed explanation of the desugaring of strict bindings.

Note [Strict binds checks]
~~~~~~~~~~~~~~~~~~~~~~~~~~
There are several checks around properly formed strict bindings. They
all link to this Note. These checks must be here in the desugarer because
we cannot know whether or not a type is unlifted until after zonking, due
to levity polymorphism. These checks all used to be handled in the typechecker
in checkStrictBinds (before Jan '17).

We define an &quot;unlifted bind&quot; to be any bind that binds an unlifted id. Note that

  x :: Char
  (# True, x #) = blah

is *not* an unlifted bind. Unlifted binds are detected by HsUtils.isUnliftedHsBind.

Define a &quot;banged bind&quot; to have a top-level bang. Detected by HsPat.isBangedHsBind.
Define a &quot;strict bind&quot; to be either an unlifted bind or a banged bind.

The restrictions are:
  1. Strict binds may not be top-level. Checked in dsTopLHsBinds.

  2. Unlifted binds must also be banged. (There is no trouble to compile an unbanged
     unlifted bind, but an unbanged bind looks lazy, and we don't want users to be
     surprised by the strictness of an unlifted bind.) Checked in first clause
     of DsExpr.ds_val_bind.

  3. Unlifted binds may not have polymorphism (#6078). (That is, no quantified type
     variables or constraints.) Checked in first clause
     of DsExpr.ds_val_bind.

  4. Unlifted binds may not be recursive. Checked in second clause of ds_val_bind.

-}</span><span>
</span><a name="line-637"></a><span>
</span><a name="line-638"></a><span class="hs-comment">------------------------</span><span>
</span><a name="line-639"></a><span class="hs-identifier">dsSpecs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>     </span><span class="hs-comment">-- Its rhs</span><span>
</span><a name="line-640"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcSpecPrags</span><span>
</span><a name="line-641"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">OrdList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Binding for specialised Ids</span><span>
</span><a name="line-642"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreRule</span><span class="hs-special">]</span><span> </span><span class="hs-special">)</span><span>           </span><span class="hs-comment">-- Rules for the Global Ids</span><span>
</span><a name="line-643"></a><span class="hs-comment">-- See Note [Handling SPECIALISE pragmas] in TcBinds</span><span>
</span><a name="line-644"></a><a name="dsSpecs"><a href="DsBinds.html#dsSpecs"><span class="hs-identifier">dsSpecs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">IsDefaultMethod</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nilOL</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-645"></a><span class="hs-identifier">dsSpecs</span><span> </span><a name="local-6989586621684031916"><a href="#local-6989586621684031916"><span class="hs-identifier">poly_rhs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SpecPrags</span><span> </span><a name="local-6989586621684031917"><a href="#local-6989586621684031917"><span class="hs-identifier">sps</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-646"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684031918"><a href="#local-6989586621684031918"><span class="hs-identifier">pairs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapMaybeM</span><span> </span><span class="hs-special">(</span><a href="DsBinds.html#dsSpec"><span class="hs-identifier hs-var">dsSpec</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621684031916"><span class="hs-identifier hs-var">poly_rhs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684031917"><span class="hs-identifier hs-var">sps</span></a><span>
</span><a name="line-647"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684031919"><a href="#local-6989586621684031919"><span class="hs-identifier">spec_binds_s</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684031920"><a href="#local-6989586621684031920"><span class="hs-identifier">rules</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621684031918"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-648"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concatOL</span><span> </span><a href="#local-6989586621684031919"><span class="hs-identifier hs-var">spec_binds_s</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684031920"><span class="hs-identifier hs-var">rules</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-649"></a><span>
</span><a name="line-650"></a><span class="hs-identifier">dsSpec</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>        </span><span class="hs-comment">-- Just rhs =&gt; RULE is for a local binding</span><span>
</span><a name="line-651"></a><span>                                </span><span class="hs-comment">-- Nothing =&gt; RULE is for an imported Id</span><span>
</span><a name="line-652"></a><span>                                </span><span class="hs-comment">--            rhs is in the Id's unfolding</span><span>
</span><a name="line-653"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">TcSpecPrag</span><span>
</span><a name="line-654"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OrdList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CoreRule</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-655"></a><a name="dsSpec"><a href="DsBinds.html#dsSpec"><span class="hs-identifier">dsSpec</span></a></a><span> </span><a name="local-6989586621684031921"><a href="#local-6989586621684031921"><span class="hs-identifier">mb_poly_rhs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621684031922"><a href="#local-6989586621684031922"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SpecPrag</span><span> </span><a name="local-6989586621684031923"><a href="#local-6989586621684031923"><span class="hs-identifier">poly_id</span></a></a><span> </span><a name="local-6989586621684031924"><a href="#local-6989586621684031924"><span class="hs-identifier">spec_co</span></a></a><span> </span><a name="local-6989586621684031925"><a href="#local-6989586621684031925"><span class="hs-identifier">spec_inl</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-656"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isClassOpId_maybe</span><span> </span><a href="#local-6989586621684031923"><span class="hs-identifier hs-var">poly_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-657"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#putSrcSpanDs"><span class="hs-identifier hs-var">putSrcSpanDs</span></a><span> </span><a href="#local-6989586621684031922"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-658"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="DsMonad.html#warnDs"><span class="hs-identifier hs-var">warnDs</span></a><span> </span><span class="hs-identifier hs-var">NoReason</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Ignoring useless SPECIALISE pragma for class method selector&quot;</span><span>
</span><a name="line-659"></a><span>                          </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684031923"><span class="hs-identifier hs-var">poly_id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-660"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-special">}</span><span>  </span><span class="hs-comment">-- There is no point in trying to specialise a class op</span><span>
</span><a name="line-661"></a><span>                            </span><span class="hs-comment">-- Moreover, classops don't (currently) have an inl_sat arity set</span><span>
</span><a name="line-662"></a><span>                            </span><span class="hs-comment">-- (it would be Just 0) and that in turn makes makeCorePair bleat</span><span>
</span><a name="line-663"></a><span>
</span><a name="line-664"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684031931"><span class="hs-identifier hs-var">no_act_spec</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isNeverActive</span><span> </span><a href="#local-6989586621684031932"><span class="hs-identifier hs-var">rule_act</span></a><span>
</span><a name="line-665"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#putSrcSpanDs"><span class="hs-identifier hs-var">putSrcSpanDs</span></a><span> </span><a href="#local-6989586621684031922"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-666"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="DsMonad.html#warnDs"><span class="hs-identifier hs-var">warnDs</span></a><span> </span><span class="hs-identifier hs-var">NoReason</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Ignoring useless SPECIALISE pragma for NOINLINE function:&quot;</span><span>
</span><a name="line-667"></a><span>                          </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684031923"><span class="hs-identifier hs-var">poly_id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-668"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-special">}</span><span>  </span><span class="hs-comment">-- Function is NOINLINE, and the specialisation inherits that</span><span>
</span><a name="line-669"></a><span>                            </span><span class="hs-comment">-- See Note [Activation pragmas for SPECIALISE]</span><span>
</span><a name="line-670"></a><span>
</span><a name="line-671"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-672"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#putSrcSpanDs"><span class="hs-identifier hs-var">putSrcSpanDs</span></a><span> </span><a href="#local-6989586621684031922"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-673"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684031935"><a href="#local-6989586621684031935"><span class="hs-identifier">uniq</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a><span>
</span><a name="line-674"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684031936"><a href="#local-6989586621684031936"><span class="hs-identifier">poly_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621684031923"><span class="hs-identifier hs-var">poly_id</span></a><span>
</span><a name="line-675"></a><span>             </span><a name="local-6989586621684031937"><a href="#local-6989586621684031937"><span class="hs-identifier">spec_occ</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkSpecOcc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOccName</span><span> </span><a href="#local-6989586621684031936"><span class="hs-identifier hs-var">poly_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-676"></a><span>             </span><a name="local-6989586621684031938"><a href="#local-6989586621684031938"><span class="hs-identifier">spec_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkInternalName</span><span> </span><a href="#local-6989586621684031935"><span class="hs-identifier hs-var">uniq</span></a><span> </span><a href="#local-6989586621684031937"><span class="hs-identifier hs-var">spec_occ</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getSrcSpan</span><span> </span><a href="#local-6989586621684031936"><span class="hs-identifier hs-var">poly_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-677"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621684031939"><a href="#local-6989586621684031939"><span class="hs-identifier">spec_bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684031940"><a href="#local-6989586621684031940"><span class="hs-identifier">spec_app</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">collectHsWrapBinders</span><span> </span><a href="#local-6989586621684031924"><span class="hs-identifier hs-var">spec_co</span></a><span>
</span><a name="line-678"></a><span>               </span><span class="hs-comment">-- spec_co looks like</span><span>
</span><a name="line-679"></a><span>               </span><span class="hs-comment">--         \spec_bndrs. [] spec_args</span><span>
</span><a name="line-680"></a><span>               </span><span class="hs-comment">-- perhaps with the body of the lambda wrapped in some WpLets</span><span>
</span><a name="line-681"></a><span>               </span><span class="hs-comment">-- E.g. /\a \(d:Eq a). let d2 = $df d in [] (Maybe a) d2</span><span>
</span><a name="line-682"></a><span>
</span><a name="line-683"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684031941"><a href="#local-6989586621684031941"><span class="hs-identifier">core_app</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#dsHsWrapper"><span class="hs-identifier hs-var">dsHsWrapper</span></a><span> </span><a href="#local-6989586621684031940"><span class="hs-identifier hs-var">spec_app</span></a><span>
</span><a name="line-684"></a><span>
</span><a name="line-685"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684031942"><a href="#local-6989586621684031942"><span class="hs-identifier">ds_lhs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684031941"><span class="hs-identifier hs-var">core_app</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684031923"><span class="hs-identifier hs-var">poly_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-686"></a><span>             </span><a name="local-6989586621684031943"><a href="#local-6989586621684031943"><span class="hs-identifier">spec_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkLamTypes</span><span> </span><a href="#local-6989586621684031939"><span class="hs-identifier hs-var">spec_bndrs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprType</span><span> </span><a href="#local-6989586621684031942"><span class="hs-identifier hs-var">ds_lhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-687"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-comment">-- pprTrace &quot;dsRule&quot; (vcat [ text &quot;Id:&quot; &lt;+&gt; ppr poly_id</span><span>
</span><a name="line-688"></a><span>         </span><span class="hs-comment">--                         , text &quot;spec_co:&quot; &lt;+&gt; ppr spec_co</span><span>
</span><a name="line-689"></a><span>         </span><span class="hs-comment">--                         , text &quot;ds_rhs:&quot; &lt;+&gt; ppr ds_lhs ]) $</span><span>
</span><a name="line-690"></a><span>         </span><a name="local-6989586621684031944"><a href="#local-6989586621684031944"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-691"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="DsBinds.html#decomposeRuleLhs"><span class="hs-identifier hs-var">decomposeRuleLhs</span></a><span> </span><a href="#local-6989586621684031944"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684031939"><span class="hs-identifier hs-var">spec_bndrs</span></a><span> </span><a href="#local-6989586621684031942"><span class="hs-identifier hs-var">ds_lhs</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-692"></a><span>           </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621684031945"><a href="#local-6989586621684031945"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="DsMonad.html#warnDs"><span class="hs-identifier hs-var">warnDs</span></a><span> </span><span class="hs-identifier hs-var">NoReason</span><span> </span><a href="#local-6989586621684031945"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-693"></a><span>           </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684031946"><a href="#local-6989586621684031946"><span class="hs-identifier">rule_bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684031947"><a href="#local-6989586621684031947"><span class="hs-identifier">_fn</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684031948"><a href="#local-6989586621684031948"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-694"></a><span>
</span><a name="line-695"></a><span>       </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684031949"><a href="#local-6989586621684031949"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-696"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684031950"><a href="#local-6989586621684031950"><span class="hs-identifier">fn_unf</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">realIdUnfolding</span><span> </span><a href="#local-6989586621684031923"><span class="hs-identifier hs-var">poly_id</span></a><span>
</span><a name="line-697"></a><span>             </span><a name="local-6989586621684031951"><a href="#local-6989586621684031951"><span class="hs-identifier">spec_unf</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">specUnfolding</span><span> </span><a href="#local-6989586621684031944"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684031939"><span class="hs-identifier hs-var">spec_bndrs</span></a><span> </span><a href="#local-6989586621684031941"><span class="hs-identifier hs-var">core_app</span></a><span> </span><a href="#local-6989586621684031953"><span class="hs-identifier hs-var">arity_decrease</span></a><span> </span><a href="#local-6989586621684031950"><span class="hs-identifier hs-var">fn_unf</span></a><span>
</span><a name="line-698"></a><span>             </span><a name="local-6989586621684031952"><a href="#local-6989586621684031952"><span class="hs-identifier">spec_id</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkLocalId</span><span> </span><a href="#local-6989586621684031938"><span class="hs-identifier hs-var">spec_name</span></a><span> </span><a href="#local-6989586621684031943"><span class="hs-identifier hs-var">spec_ty</span></a><span>
</span><a name="line-699"></a><span>                            </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setInlinePragma</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684031929"><span class="hs-identifier hs-var">inl_prag</span></a><span>
</span><a name="line-700"></a><span>                            </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setIdUnfolding</span><span class="hs-special">`</span><span>  </span><a href="#local-6989586621684031951"><span class="hs-identifier hs-var">spec_unf</span></a><span>
</span><a name="line-701"></a><span>             </span><a name="local-6989586621684031953"><a href="#local-6989586621684031953"><span class="hs-identifier">arity_decrease</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">count</span><span> </span><span class="hs-identifier hs-var">isValArg</span><span> </span><a href="#local-6989586621684031948"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">count</span><span> </span><span class="hs-identifier hs-var">isId</span><span> </span><a href="#local-6989586621684031939"><span class="hs-identifier hs-var">spec_bndrs</span></a><span>
</span><a name="line-702"></a><span>
</span><a name="line-703"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684031954"><a href="#local-6989586621684031954"><span class="hs-identifier">rule</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#dsMkUserRule"><span class="hs-identifier hs-var">dsMkUserRule</span></a><span> </span><a href="#local-6989586621684031949"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684031926"><span class="hs-identifier hs-var">is_local_id</span></a><span>
</span><a name="line-704"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkFastString</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;SPEC &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">showPpr</span><span> </span><a href="#local-6989586621684031944"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684031936"><span class="hs-identifier hs-var">poly_name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-705"></a><span>                        </span><a href="#local-6989586621684031932"><span class="hs-identifier hs-var">rule_act</span></a><span> </span><a href="#local-6989586621684031936"><span class="hs-identifier hs-var">poly_name</span></a><span>
</span><a name="line-706"></a><span>                        </span><a href="#local-6989586621684031946"><span class="hs-identifier hs-var">rule_bndrs</span></a><span> </span><a href="#local-6989586621684031948"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-707"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkVarApps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684031952"><span class="hs-identifier hs-var">spec_id</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684031939"><span class="hs-identifier hs-var">spec_bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-708"></a><span>
</span><a name="line-709"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684031955"><a href="#local-6989586621684031955"><span class="hs-identifier">spec_rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkLams</span><span> </span><a href="#local-6989586621684031939"><span class="hs-identifier hs-var">spec_bndrs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031941"><span class="hs-identifier hs-var">core_app</span></a><span> </span><a href="#local-6989586621684031927"><span class="hs-identifier hs-var">poly_rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-710"></a><span>
</span><a name="line-711"></a><span class="hs-comment">-- Commented out: see Note [SPECIALISE on INLINE functions]</span><span>
</span><a name="line-712"></a><span class="hs-comment">--       ; when (isInlinePragma id_inl)</span><span>
</span><a name="line-713"></a><span class="hs-comment">--              (warnDs $ text &quot;SPECIALISE pragma on INLINE function probably won't fire:&quot;</span><span>
</span><a name="line-714"></a><span class="hs-comment">--                        &lt;+&gt; quotes (ppr poly_name))</span><span>
</span><a name="line-715"></a><span>
</span><a name="line-716"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitOL</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031952"><span class="hs-identifier hs-var">spec_id</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684031955"><span class="hs-identifier hs-var">spec_rhs</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684031954"><span class="hs-identifier hs-var">rule</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-717"></a><span>            </span><span class="hs-comment">-- NB: do *not* use makeCorePair on (spec_id,spec_rhs), because</span><span>
</span><a name="line-718"></a><span>            </span><span class="hs-comment">--     makeCorePair overwrites the unfolding, which we have</span><span>
</span><a name="line-719"></a><span>            </span><span class="hs-comment">--     just created using specUnfolding</span><span>
</span><a name="line-720"></a><span>       </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-721"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-722"></a><span>    </span><a name="local-6989586621684031926"><a href="#local-6989586621684031926"><span class="hs-identifier">is_local_id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><a href="#local-6989586621684031921"><span class="hs-identifier hs-var">mb_poly_rhs</span></a><span>
</span><a name="line-723"></a><span>    </span><a name="local-6989586621684031927"><a href="#local-6989586621684031927"><span class="hs-identifier">poly_rhs</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684031933"><a href="#local-6989586621684031933"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>  </span><a href="#local-6989586621684031921"><span class="hs-identifier hs-var">mb_poly_rhs</span></a><span>
</span><a name="line-724"></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684031933"><span class="hs-identifier hs-var">rhs</span></a><span>          </span><span class="hs-comment">-- Local Id; this is its rhs</span><span>
</span><a name="line-725"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684031934"><a href="#local-6989586621684031934"><span class="hs-identifier">unfolding</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">maybeUnfoldingTemplate</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">realIdUnfolding</span><span> </span><a href="#local-6989586621684031923"><span class="hs-identifier hs-var">poly_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-726"></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684031934"><span class="hs-identifier hs-var">unfolding</span></a><span>    </span><span class="hs-comment">-- Imported Id; this is its unfolding</span><span>
</span><a name="line-727"></a><span>                            </span><span class="hs-comment">-- Use realIdUnfolding so we get the unfolding</span><span>
</span><a name="line-728"></a><span>                            </span><span class="hs-comment">-- even when it is a loop breaker.</span><span>
</span><a name="line-729"></a><span>                            </span><span class="hs-comment">-- We want to specialise recursive functions!</span><span>
</span><a name="line-730"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;dsImpSpecs&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684031923"><span class="hs-identifier hs-var">poly_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-731"></a><span>                            </span><span class="hs-comment">-- The type checker has checked that it *has* an unfolding</span><span>
</span><a name="line-732"></a><span>
</span><a name="line-733"></a><span>    </span><a name="local-6989586621684031928"><a href="#local-6989586621684031928"><span class="hs-identifier">id_inl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idInlinePragma</span><span> </span><a href="#local-6989586621684031923"><span class="hs-identifier hs-var">poly_id</span></a><span>
</span><a name="line-734"></a><span>
</span><a name="line-735"></a><span>    </span><span class="hs-comment">-- See Note [Activation pragmas for SPECIALISE]</span><span>
</span><a name="line-736"></a><span>    </span><a name="local-6989586621684031929"><a href="#local-6989586621684031929"><span class="hs-identifier">inl_prag</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isDefaultInlinePragma</span><span> </span><a href="#local-6989586621684031925"><span class="hs-identifier hs-var">spec_inl</span></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684031925"><span class="hs-identifier hs-var">spec_inl</span></a><span>
</span><a name="line-737"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621684031926"><span class="hs-identifier hs-var">is_local_id</span></a><span>  </span><span class="hs-comment">-- See Note [Specialising imported functions]</span><span>
</span><a name="line-738"></a><span>                                 </span><span class="hs-comment">-- in OccurAnal</span><span>
</span><a name="line-739"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isStrongLoopBreaker</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idOccInfo</span><span> </span><a href="#local-6989586621684031923"><span class="hs-identifier hs-var">poly_id</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">neverInlinePragma</span><span>
</span><a name="line-740"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                               </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684031928"><span class="hs-identifier hs-var">id_inl</span></a><span>
</span><a name="line-741"></a><span>     </span><span class="hs-comment">-- Get the INLINE pragma from SPECIALISE declaration, or,</span><span>
</span><a name="line-742"></a><span>     </span><span class="hs-comment">-- failing that, from the original Id</span><span>
</span><a name="line-743"></a><span>
</span><a name="line-744"></a><span>    </span><a name="local-6989586621684031930"><a href="#local-6989586621684031930"><span class="hs-identifier">spec_prag_act</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">inlinePragmaActivation</span><span> </span><a href="#local-6989586621684031925"><span class="hs-identifier hs-var">spec_inl</span></a><span>
</span><a name="line-745"></a><span>
</span><a name="line-746"></a><span>    </span><span class="hs-comment">-- See Note [Activation pragmas for SPECIALISE]</span><span>
</span><a name="line-747"></a><span>    </span><span class="hs-comment">-- no_act_spec is True if the user didn't write an explicit</span><span>
</span><a name="line-748"></a><span>    </span><span class="hs-comment">-- phase specification in the SPECIALISE pragma</span><span>
</span><a name="line-749"></a><span>    </span><a name="local-6989586621684031931"><a href="#local-6989586621684031931"><span class="hs-identifier">no_act_spec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">inlinePragmaSpec</span><span> </span><a href="#local-6989586621684031925"><span class="hs-identifier hs-var">spec_inl</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-750"></a><span>                    </span><span class="hs-identifier hs-var">NoInline</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">isNeverActive</span><span>  </span><a href="#local-6989586621684031930"><span class="hs-identifier hs-var">spec_prag_act</span></a><span>
</span><a name="line-751"></a><span>                    </span><span class="hs-identifier">_</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">isAlwaysActive</span><span> </span><a href="#local-6989586621684031930"><span class="hs-identifier hs-var">spec_prag_act</span></a><span>
</span><a name="line-752"></a><span>    </span><a name="local-6989586621684031932"><a href="#local-6989586621684031932"><span class="hs-identifier">rule_act</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684031931"><span class="hs-identifier hs-var">no_act_spec</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">inlinePragmaActivation</span><span> </span><a href="#local-6989586621684031928"><span class="hs-identifier hs-var">id_inl</span></a><span>   </span><span class="hs-comment">-- Inherit</span><span>
</span><a name="line-753"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684031930"><span class="hs-identifier hs-var">spec_prag_act</span></a><span>                   </span><span class="hs-comment">-- Specified by user</span><span>
</span><a name="line-754"></a><span>
</span><a name="line-755"></a><span>
</span><a name="line-756"></a><span class="hs-identifier">dsMkUserRule</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RuleName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Activation</span><span>
</span><a name="line-757"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreBndr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreRule</span><span>
</span><a name="line-758"></a><a name="dsMkUserRule"><a href="DsBinds.html#dsMkUserRule"><span class="hs-identifier">dsMkUserRule</span></a></a><span> </span><a name="local-6989586621684031956"><a href="#local-6989586621684031956"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621684031957"><a href="#local-6989586621684031957"><span class="hs-identifier">is_local</span></a></a><span> </span><a name="local-6989586621684031958"><a href="#local-6989586621684031958"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621684031959"><a href="#local-6989586621684031959"><span class="hs-identifier">act</span></a></a><span> </span><a name="local-6989586621684031960"><a href="#local-6989586621684031960"><span class="hs-identifier">fn</span></a></a><span> </span><a name="local-6989586621684031961"><a href="#local-6989586621684031961"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-6989586621684031962"><a href="#local-6989586621684031962"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621684031963"><a href="#local-6989586621684031963"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-759"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684031964"><a href="#local-6989586621684031964"><span class="hs-identifier">rule</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkRule</span><span> </span><a href="#local-6989586621684031956"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621684031957"><span class="hs-identifier hs-var">is_local</span></a><span> </span><a href="#local-6989586621684031958"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621684031959"><span class="hs-identifier hs-var">act</span></a><span> </span><a href="#local-6989586621684031960"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621684031961"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621684031962"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621684031963"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-760"></a><span>    </span><a name="local-6989586621684031965"><a href="#local-6989586621684031965"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-761"></a><span>    </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isOrphan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ru_orphan</span><span> </span><a href="#local-6989586621684031964"><span class="hs-identifier hs-var">rule</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">wopt</span><span> </span><span class="hs-identifier hs-var">Opt_WarnOrphans</span><span> </span><a href="#local-6989586621684031965"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-762"></a><span>        </span><a href="DsMonad.html#warnDs"><span class="hs-identifier hs-var">warnDs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><span class="hs-identifier hs-var">Opt_WarnOrphans</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="DsBinds.html#ruleOrphWarn"><span class="hs-identifier hs-var">ruleOrphWarn</span></a><span> </span><a href="#local-6989586621684031964"><span class="hs-identifier hs-var">rule</span></a><span class="hs-special">)</span><span>
</span><a name="line-763"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684031964"><span class="hs-identifier hs-var">rule</span></a><span>
</span><a name="line-764"></a><span>
</span><a name="line-765"></a><span class="hs-identifier">ruleOrphWarn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreRule</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-766"></a><a name="ruleOrphWarn"><a href="DsBinds.html#ruleOrphWarn"><span class="hs-identifier">ruleOrphWarn</span></a></a><span> </span><a name="local-6989586621684031966"><a href="#local-6989586621684031966"><span class="hs-identifier">rule</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Orphan rule:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684031966"><span class="hs-identifier hs-var">rule</span></a><span>
</span><a name="line-767"></a><span>
</span><a name="line-768"></a><span class="hs-comment">{- Note [SPECIALISE on INLINE functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We used to warn that using SPECIALISE for a function marked INLINE
would be a no-op; but it isn't!  Especially with worker/wrapper split
we might have
   {-# INLINE f #-}
   f :: Ord a =&gt; Int -&gt; a -&gt; ...
   f d x y = case x of I# x' -&gt; $wf d x' y

We might want to specialise 'f' so that we in turn specialise '$wf'.
We can't even /name/ '$wf' in the source code, so we can't specialise
it even if we wanted to.  Trac #10721 is a case in point.

Note [Activation pragmas for SPECIALISE]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
From a user SPECIALISE pragma for f, we generate
  a) A top-level binding    spec_fn = rhs
  b) A RULE                 f dOrd = spec_fn

We need two pragma-like things:

* spec_fn's inline pragma: inherited from f's inline pragma (ignoring
                           activation on SPEC), unless overriden by SPEC INLINE

* Activation of RULE: from SPECIALISE pragma (if activation given)
                      otherwise from f's inline pragma

This is not obvious (see Trac #5237)!

Examples      Rule activation   Inline prag on spec'd fn
---------------------------------------------------------------------
SPEC [n] f :: ty            [n]   Always, or NOINLINE [n]
                                  copy f's prag

NOINLINE f
SPEC [n] f :: ty            [n]   NOINLINE
                                  copy f's prag

NOINLINE [k] f
SPEC [n] f :: ty            [n]   NOINLINE [k]
                                  copy f's prag

INLINE [k] f
SPEC [n] f :: ty            [n]   INLINE [k]
                                  copy f's prag

SPEC INLINE [n] f :: ty     [n]   INLINE [n]
                                  (ignore INLINE prag on f,
                                  same activation for rule and spec'd fn)

NOINLINE [k] f
SPEC f :: ty                [n]   INLINE [k]


************************************************************************
*                                                                      *
\subsection{Adding inline pragmas}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-828"></a><span>
</span><a name="line-829"></a><span class="hs-identifier">decomposeRuleLhs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Var</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-830"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Var</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-831"></a><span class="hs-comment">-- (decomposeRuleLhs bndrs lhs) takes apart the LHS of a RULE,</span><span>
</span><a name="line-832"></a><span class="hs-comment">-- The 'bndrs' are the quantified binders of the rules, but decomposeRuleLhs</span><span>
</span><a name="line-833"></a><span class="hs-comment">-- may add some extra dictionary binders (see Note [Free dictionaries])</span><span>
</span><a name="line-834"></a><span class="hs-comment">--</span><span>
</span><a name="line-835"></a><span class="hs-comment">-- Returns an error message if the LHS isn't of the expected shape</span><span>
</span><a name="line-836"></a><span class="hs-comment">-- Note [Decomposing the left-hand side of a RULE]</span><span>
</span><a name="line-837"></a><a name="decomposeRuleLhs"><a href="DsBinds.html#decomposeRuleLhs"><span class="hs-identifier">decomposeRuleLhs</span></a></a><span> </span><a name="local-6989586621684031967"><a href="#local-6989586621684031967"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684031968"><a href="#local-6989586621684031968"><span class="hs-identifier">orig_bndrs</span></a></a><span> </span><a name="local-6989586621684031969"><a href="#local-6989586621684031969"><span class="hs-identifier">orig_lhs</span></a></a><span>
</span><a name="line-838"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621684031975"><span class="hs-identifier hs-var">unbound</span></a><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- Check for things unbound on LHS</span><span>
</span><a name="line-839"></a><span>                          </span><span class="hs-comment">-- See Note [Unused spec binders]</span><span>
</span><a name="line-840"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621684031980"><span class="hs-identifier hs-var">dead_msg</span></a><span> </span><a href="#local-6989586621684031975"><span class="hs-identifier hs-var">unbound</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-841"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Var</span><span> </span><a name="local-6989586621684032022"><a href="#local-6989586621684032022"><span class="hs-identifier">funId</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684031972"><span class="hs-identifier hs-var">fun2</span></a><span>
</span><a name="line-842"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684032023"><a href="#local-6989586621684032023"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">isDataConId_maybe</span><span> </span><a href="#local-6989586621684032022"><span class="hs-identifier hs-var">funId</span></a><span>
</span><a name="line-843"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031982"><span class="hs-identifier hs-var">constructor_msg</span></a><span> </span><a href="#local-6989586621684032023"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- See Note [No RULES on datacons]</span><span>
</span><a name="line-844"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684032024"><a href="#local-6989586621684032024"><span class="hs-identifier">fn_id</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684032025"><a href="#local-6989586621684032025"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684031978"><span class="hs-identifier hs-var">decompose</span></a><span> </span><a href="#local-6989586621684031972"><span class="hs-identifier hs-var">fun2</span></a><span> </span><a href="#local-6989586621684031973"><span class="hs-identifier hs-var">args2</span></a><span>
</span><a name="line-845"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684032026"><a href="#local-6989586621684032026"><span class="hs-identifier">extra_bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684031977"><span class="hs-identifier hs-var">mk_extra_bndrs</span></a><span> </span><a href="#local-6989586621684032024"><span class="hs-identifier hs-var">fn_id</span></a><span> </span><a href="#local-6989586621684032025"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-846"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;decmposeRuleLhs&quot; (vcat [ text &quot;orig_bndrs:&quot; &lt;+&gt; ppr orig_bndrs</span><span>
</span><a name="line-847"></a><span>    </span><span class="hs-comment">--                                  , text &quot;orig_lhs:&quot; &lt;+&gt; ppr orig_lhs</span><span>
</span><a name="line-848"></a><span>    </span><span class="hs-comment">--                                  , text &quot;lhs1:&quot;     &lt;+&gt; ppr lhs1</span><span>
</span><a name="line-849"></a><span>    </span><span class="hs-comment">--                                  , text &quot;extra_dict_bndrs:&quot; &lt;+&gt; ppr extra_dict_bndrs</span><span>
</span><a name="line-850"></a><span>    </span><span class="hs-comment">--                                  , text &quot;fn_id:&quot; &lt;+&gt; ppr fn_id</span><span>
</span><a name="line-851"></a><span>    </span><span class="hs-comment">--                                  , text &quot;args:&quot;   &lt;+&gt; ppr args]) $</span><span>
</span><a name="line-852"></a><span>    </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031968"><span class="hs-identifier hs-var">orig_bndrs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684032026"><span class="hs-identifier hs-var">extra_bndrs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684032024"><span class="hs-identifier hs-var">fn_id</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684032025"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-853"></a><span>
</span><a name="line-854"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-855"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621684031979"><span class="hs-identifier hs-var">bad_shape_msg</span></a><span>
</span><a name="line-856"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-857"></a><span>   </span><a name="local-6989586621684031970"><a href="#local-6989586621684031970"><span class="hs-identifier">lhs1</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684031983"><span class="hs-identifier hs-var">drop_dicts</span></a><span> </span><a href="#local-6989586621684031969"><span class="hs-identifier hs-var">orig_lhs</span></a><span>
</span><a name="line-858"></a><span>   </span><a name="local-6989586621684031971"><a href="#local-6989586621684031971"><span class="hs-identifier">lhs2</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">simpleOptExpr</span><span> </span><a href="#local-6989586621684031967"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684031970"><span class="hs-identifier hs-var">lhs1</span></a><span>  </span><span class="hs-comment">-- See Note [Simplify rule LHS]</span><span>
</span><a name="line-859"></a><span>   </span><span class="hs-special">(</span><a name="local-6989586621684031972"><a href="#local-6989586621684031972"><span class="hs-identifier">fun2</span></a></a><span class="hs-special">,</span><a name="local-6989586621684031973"><a href="#local-6989586621684031973"><span class="hs-identifier">args2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">collectArgs</span><span> </span><a href="#local-6989586621684031971"><span class="hs-identifier hs-var">lhs2</span></a><span>
</span><a name="line-860"></a><span>
</span><a name="line-861"></a><span>   </span><a name="local-6989586621684031974"><a href="#local-6989586621684031974"><span class="hs-identifier">lhs_fvs</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">exprFreeVars</span><span> </span><a href="#local-6989586621684031971"><span class="hs-identifier hs-var">lhs2</span></a><span>
</span><a name="line-862"></a><span>   </span><a name="local-6989586621684031975"><a href="#local-6989586621684031975"><span class="hs-identifier">unbound</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filterOut</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684031974"><span class="hs-identifier hs-var">lhs_fvs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684031968"><span class="hs-identifier hs-var">orig_bndrs</span></a><span>
</span><a name="line-863"></a><span>
</span><a name="line-864"></a><span>   </span><a name="local-6989586621684031976"><a href="#local-6989586621684031976"><span class="hs-identifier">orig_bndr_set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkVarSet</span><span> </span><a href="#local-6989586621684031968"><span class="hs-identifier hs-var">orig_bndrs</span></a><span>
</span><a name="line-865"></a><span>
</span><a name="line-866"></a><span>        </span><span class="hs-comment">-- Add extra tyvar binders: Note [Free tyvars in rule LHS]</span><span>
</span><a name="line-867"></a><span>        </span><span class="hs-comment">-- and extra dict binders: Note [Free dictionaries in rule LHS]</span><span>
</span><a name="line-868"></a><span>   </span><a name="local-6989586621684031977"><a href="#local-6989586621684031977"><span class="hs-identifier">mk_extra_bndrs</span></a></a><span> </span><a name="local-6989586621684031986"><a href="#local-6989586621684031986"><span class="hs-identifier">fn_id</span></a></a><span> </span><a name="local-6989586621684031987"><a href="#local-6989586621684031987"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-869"></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">scopedSort</span><span> </span><a href="#local-6989586621684031988"><span class="hs-identifier hs-var">unbound_tvs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684031989"><span class="hs-identifier hs-var">unbound_dicts</span></a><span>
</span><a name="line-870"></a><span>     </span><span class="hs-keyword">where</span><span>
</span><a name="line-871"></a><span>       </span><a name="local-6989586621684031988"><a href="#local-6989586621684031988"><span class="hs-identifier">unbound_tvs</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621684031991"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621684031991"><a href="#local-6989586621684031991"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684031990"><span class="hs-identifier hs-var">unbound_vars</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isTyVar</span><span> </span><a href="#local-6989586621684031991"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-872"></a><span>       </span><a name="local-6989586621684031989"><a href="#local-6989586621684031989"><span class="hs-identifier">unbound_dicts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">mkLocalId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">localiseName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621684031992"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621684031992"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span>
</span><a name="line-873"></a><span>                       </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621684031992"><a href="#local-6989586621684031992"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684031990"><span class="hs-identifier hs-var">unbound_vars</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isDictId</span><span> </span><a href="#local-6989586621684031992"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-874"></a><span>       </span><a name="local-6989586621684031990"><a href="#local-6989586621684031990"><span class="hs-identifier">unbound_vars</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621684031993"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621684031993"><a href="#local-6989586621684031993"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">exprsFreeVarsList</span><span> </span><a href="#local-6989586621684031987"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-875"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031993"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684031976"><span class="hs-identifier hs-var">orig_bndr_set</span></a><span class="hs-special">)</span><span>
</span><a name="line-876"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031993"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684031986"><span class="hs-identifier hs-var">fn_id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-877"></a><span>         </span><span class="hs-comment">-- fn_id: do not quantify over the function itself, which may</span><span>
</span><a name="line-878"></a><span>         </span><span class="hs-comment">-- itself be a dictionary (in pathological cases, Trac #10251)</span><span>
</span><a name="line-879"></a><span>
</span><a name="line-880"></a><span>   </span><a name="local-6989586621684031978"><a href="#local-6989586621684031978"><span class="hs-identifier">decompose</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a name="local-6989586621684031994"><a href="#local-6989586621684031994"><span class="hs-identifier">fn_id</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684031995"><a href="#local-6989586621684031995"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-881"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031994"><span class="hs-identifier hs-var">fn_id</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684031976"><span class="hs-identifier hs-var">orig_bndr_set</span></a><span class="hs-special">)</span><span>
</span><a name="line-882"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031994"><span class="hs-identifier hs-var">fn_id</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684031995"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-883"></a><span>
</span><a name="line-884"></a><span>   </span><span class="hs-identifier">decompose</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-885"></a><span>
</span><a name="line-886"></a><span>   </span><a name="local-6989586621684031979"><a href="#local-6989586621684031979"><span class="hs-identifier">bad_shape_msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;RULE left-hand side too complicated to desugar&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-887"></a><span>                      </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Optimised lhs:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684031971"><span class="hs-identifier hs-var">lhs2</span></a><span>
</span><a name="line-888"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Orig lhs:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684031969"><span class="hs-identifier hs-var">orig_lhs</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-889"></a><span>   </span><a name="local-6989586621684031980"><a href="#local-6989586621684031980"><span class="hs-identifier">dead_msg</span></a></a><span> </span><a name="local-6989586621684031996"><a href="#local-6989586621684031996"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Forall'd&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621684031981"><span class="hs-identifier hs-var">pp_bndr</span></a><span> </span><a href="#local-6989586621684031996"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-890"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is not bound in RULE lhs&quot;</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-891"></a><span>                      </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Orig bndrs:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684031968"><span class="hs-identifier hs-var">orig_bndrs</span></a><span>
</span><a name="line-892"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Orig lhs:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684031969"><span class="hs-identifier hs-var">orig_lhs</span></a><span>
</span><a name="line-893"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;optimised lhs:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684031971"><span class="hs-identifier hs-var">lhs2</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-894"></a><span>   </span><a name="local-6989586621684031981"><a href="#local-6989586621684031981"><span class="hs-identifier">pp_bndr</span></a></a><span> </span><a name="local-6989586621684031997"><a href="#local-6989586621684031997"><span class="hs-identifier">bndr</span></a></a><span>
</span><a name="line-895"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTyVar</span><span> </span><a href="#local-6989586621684031997"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;type variable&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684031997"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-896"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isEvVar</span><span> </span><a href="#local-6989586621684031997"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;constraint&quot;</span><span>    </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">varType</span><span> </span><a href="#local-6989586621684031997"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-897"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;variable&quot;</span><span>      </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684031997"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-898"></a><span>
</span><a name="line-899"></a><span>   </span><a name="local-6989586621684031982"><a href="#local-6989586621684031982"><span class="hs-identifier">constructor_msg</span></a></a><span> </span><a name="local-6989586621684031998"><a href="#local-6989586621684031998"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span>
</span><a name="line-900"></a><span>     </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;A constructor,&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684031998"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-901"></a><span>         </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;, appears as outermost match in RULE lhs.&quot;</span><span>
</span><a name="line-902"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;This rule will be ignored.&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-903"></a><span>
</span><a name="line-904"></a><span>   </span><span class="hs-identifier">drop_dicts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-905"></a><span>   </span><a name="local-6989586621684031983"><a href="#local-6989586621684031983"><span class="hs-identifier">drop_dicts</span></a></a><span> </span><a name="local-6989586621684031999"><a href="#local-6989586621684031999"><span class="hs-identifier">e</span></a></a><span>
</span><a name="line-906"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684031985"><span class="hs-identifier hs-var">wrap_lets</span></a><span> </span><a href="#local-6989586621684032000"><span class="hs-identifier hs-var">needed</span></a><span> </span><a href="#local-6989586621684032001"><span class="hs-identifier hs-var">bnds</span></a><span> </span><a href="#local-6989586621684032002"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-907"></a><span>     </span><span class="hs-keyword">where</span><span>
</span><a name="line-908"></a><span>       </span><a name="local-6989586621684032000"><a href="#local-6989586621684032000"><span class="hs-identifier">needed</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684031976"><span class="hs-identifier hs-var">orig_bndr_set</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">minusVarSet</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">exprFreeVars</span><span> </span><a href="#local-6989586621684032002"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-909"></a><span>       </span><span class="hs-special">(</span><a name="local-6989586621684032001"><a href="#local-6989586621684032001"><span class="hs-identifier">bnds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684032002"><a href="#local-6989586621684032002"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684031984"><span class="hs-identifier hs-var">split_lets</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">occurAnalyseExpr</span><span> </span><a href="#local-6989586621684031999"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-910"></a><span>           </span><span class="hs-comment">-- The occurAnalyseExpr drops dead bindings which is</span><span>
</span><a name="line-911"></a><span>           </span><span class="hs-comment">-- crucial to ensure that every binding is used later;</span><span>
</span><a name="line-912"></a><span>           </span><span class="hs-comment">-- which in turn makes wrap_lets work right</span><span>
</span><a name="line-913"></a><span>
</span><a name="line-914"></a><span>   </span><span class="hs-identifier">split_lets</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">DictId</span><span class="hs-special">,</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span>
</span><a name="line-915"></a><span>   </span><a name="local-6989586621684031984"><a href="#local-6989586621684031984"><span class="hs-identifier">split_lets</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a name="local-6989586621684032003"><a href="#local-6989586621684032003"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621684032004"><a href="#local-6989586621684032004"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684032005"><a href="#local-6989586621684032005"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-916"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isDictId</span><span> </span><a href="#local-6989586621684032003"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-917"></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621684032003"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">,</span><a href="#local-6989586621684032004"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a href="#local-6989586621684032006"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684032007"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">)</span><span>
</span><a name="line-918"></a><span>     </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684032006"><a href="#local-6989586621684032006"><span class="hs-identifier">bs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684032007"><a href="#local-6989586621684032007"><span class="hs-identifier">body'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684031984"><span class="hs-identifier hs-var">split_lets</span></a><span> </span><a href="#local-6989586621684032005"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-919"></a><span>
</span><a name="line-920"></a><span>    </span><span class="hs-comment">-- handle &quot;unlifted lets&quot; too, needed for &quot;map/coerce&quot;</span><span>
</span><a name="line-921"></a><span>   </span><span class="hs-identifier">split_lets</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Case</span><span> </span><a name="local-6989586621684032008"><a href="#local-6989586621684032008"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621684032009"><a href="#local-6989586621684032009"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DEFAULT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684032010"><a href="#local-6989586621684032010"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-922"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isCoVar</span><span> </span><a href="#local-6989586621684032009"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-923"></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621684032009"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">,</span><a href="#local-6989586621684032008"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a href="#local-6989586621684032011"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684032012"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">)</span><span>
</span><a name="line-924"></a><span>     </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684032011"><a href="#local-6989586621684032011"><span class="hs-identifier">bs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684032012"><a href="#local-6989586621684032012"><span class="hs-identifier">body'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684031984"><span class="hs-identifier hs-var">split_lets</span></a><span> </span><a href="#local-6989586621684032010"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-925"></a><span>
</span><a name="line-926"></a><span>   </span><span class="hs-identifier">split_lets</span><span> </span><a name="local-6989586621684032013"><a href="#local-6989586621684032013"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684032013"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-927"></a><span>
</span><a name="line-928"></a><span>   </span><span class="hs-identifier">wrap_lets</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">VarSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">DictId</span><span class="hs-special">,</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-929"></a><span>   </span><a name="local-6989586621684031985"><a href="#local-6989586621684031985"><span class="hs-identifier">wrap_lets</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621684032014"><a href="#local-6989586621684032014"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684032014"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-930"></a><span>   </span><span class="hs-identifier">wrap_lets</span><span> </span><a name="local-6989586621684032015"><a href="#local-6989586621684032015"><span class="hs-identifier">needed</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621684032016"><a href="#local-6989586621684032016"><span class="hs-identifier">d</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684032017"><a href="#local-6989586621684032017"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684032018"><a href="#local-6989586621684032018"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684032019"><a href="#local-6989586621684032019"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-931"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684032020"><span class="hs-identifier hs-var">rhs_fvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">intersectsVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684032015"><span class="hs-identifier hs-var">needed</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkCoreLet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621684032016"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621684032017"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684031985"><span class="hs-identifier hs-var">wrap_lets</span></a><span> </span><a href="#local-6989586621684032021"><span class="hs-identifier hs-var">needed'</span></a><span> </span><a href="#local-6989586621684032018"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-6989586621684032019"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-932"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684031985"><span class="hs-identifier hs-var">wrap_lets</span></a><span> </span><a href="#local-6989586621684032015"><span class="hs-identifier hs-var">needed</span></a><span> </span><a href="#local-6989586621684032018"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-6989586621684032019"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-933"></a><span>     </span><span class="hs-keyword">where</span><span>
</span><a name="line-934"></a><span>       </span><a name="local-6989586621684032020"><a href="#local-6989586621684032020"><span class="hs-identifier">rhs_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">exprFreeVars</span><span> </span><a href="#local-6989586621684032017"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-935"></a><span>       </span><a name="local-6989586621684032021"><a href="#local-6989586621684032021"><span class="hs-identifier">needed'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684032015"><span class="hs-identifier hs-var">needed</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">minusVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684032020"><span class="hs-identifier hs-var">rhs_fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">extendVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684032016"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-936"></a><span>
</span><a name="line-937"></a><span class="hs-comment">{-
Note [Decomposing the left-hand side of a RULE]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
There are several things going on here.
* drop_dicts: see Note [Drop dictionary bindings on rule LHS]
* simpleOptExpr: see Note [Simplify rule LHS]
* extra_dict_bndrs: see Note [Free dictionaries]

Note [Free tyvars on rule LHS]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
  data T a = C

  foo :: T a -&gt; Int
  foo C = 1

  {-# RULES &quot;myrule&quot;  foo C = 1 #-}

After type checking the LHS becomes (foo alpha (C alpha)), where alpha
is an unbound meta-tyvar.  The zonker in TcHsSyn is careful not to
turn the free alpha into Any (as it usually does).  Instead it turns it
into a TyVar 'a'.  See TcHsSyn Note [Zonking the LHS of a RULE].

Now we must quantify over that 'a'.  It's /really/ inconvenient to do that
in the zonker, because the HsExpr data type is very large.  But it's /easy/
to do it here in the desugarer.

Moreover, we have to do something rather similar for dictionaries;
see Note [Free dictionaries on rule LHS].   So that's why we look for
type variables free on the LHS, and quantify over them.

Note [Free dictionaries on rule LHS]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When the LHS of a specialisation rule, (/\as\ds. f es) has a free dict,
which is presumably in scope at the function definition site, we can quantify
over it too.  *Any* dict with that type will do.

So for example when you have
        f :: Eq a =&gt; a -&gt; a
        f = &lt;rhs&gt;
        ... SPECIALISE f :: Int -&gt; Int ...

Then we get the SpecPrag
        SpecPrag (f Int dInt)

And from that we want the rule

        RULE forall dInt. f Int dInt = f_spec
        f_spec = let f = &lt;rhs&gt; in f Int dInt

But be careful!  That dInt might be GHC.Base.$fOrdInt, which is an External
Name, and you can't bind them in a lambda or forall without getting things
confused.   Likewise it might have an InlineRule or something, which would be
utterly bogus. So we really make a fresh Id, with the same unique and type
as the old one, but with an Internal name and no IdInfo.

Note [Drop dictionary bindings on rule LHS]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
drop_dicts drops dictionary bindings on the LHS where possible.
   E.g.  let d:Eq [Int] = $fEqList $fEqInt in f d
     --&gt; f d
   Reasoning here is that there is only one d:Eq [Int], and so we can
   quantify over it. That makes 'd' free in the LHS, but that is later
   picked up by extra_dict_bndrs (Note [Dead spec binders]).

   NB 1: We can only drop the binding if the RHS doesn't bind
         one of the orig_bndrs, which we assume occur on RHS.
         Example
            f :: (Eq a) =&gt; b -&gt; a -&gt; a
            {-# SPECIALISE f :: Eq a =&gt; b -&gt; [a] -&gt; [a] #-}
         Here we want to end up with
            RULE forall d:Eq a.  f ($dfEqList d) = f_spec d
         Of course, the ($dfEqlist d) in the pattern makes it less likely
         to match, but there is no other way to get d:Eq a

   NB 2: We do drop_dicts *before* simplOptEpxr, so that we expect all
         the evidence bindings to be wrapped around the outside of the
         LHS.  (After simplOptExpr they'll usually have been inlined.)
         dsHsWrapper does dependency analysis, so that civilised ones
         will be simple NonRec bindings.  We don't handle recursive
         dictionaries!

    NB3: In the common case of a non-overloaded, but perhaps-polymorphic
         specialisation, we don't need to bind *any* dictionaries for use
         in the RHS. For example (Trac #8331)
             {-# SPECIALIZE INLINE useAbstractMonad :: ReaderST s Int #-}
             useAbstractMonad :: MonadAbstractIOST m =&gt; m Int
         Here, deriving (MonadAbstractIOST (ReaderST s)) is a lot of code
         but the RHS uses no dictionaries, so we want to end up with
             RULE forall s (d :: MonadAbstractIOST (ReaderT s)).
                useAbstractMonad (ReaderT s) d = $suseAbstractMonad s

   Trac #8848 is a good example of where there are some interesting
   dictionary bindings to discard.

The drop_dicts algorithm is based on these observations:

  * Given (let d = rhs in e) where d is a DictId,
    matching 'e' will bind e's free variables.

  * So we want to keep the binding if one of the needed variables (for
    which we need a binding) is in fv(rhs) but not already in fv(e).

  * The &quot;needed variables&quot; are simply the orig_bndrs.  Consider
       f :: (Eq a, Show b) =&gt; a -&gt; b -&gt; String
       ... SPECIALISE f :: (Show b) =&gt; Int -&gt; b -&gt; String ...
    Then orig_bndrs includes the *quantified* dictionaries of the type
    namely (dsb::Show b), but not the one for Eq Int

So we work inside out, applying the above criterion at each step.


Note [Simplify rule LHS]
~~~~~~~~~~~~~~~~~~~~~~~~
simplOptExpr occurrence-analyses and simplifies the LHS:

   (a) Inline any remaining dictionary bindings (which hopefully
       occur just once)

   (b) Substitute trivial lets, so that they don't get in the way.
       Note that we substitute the function too; we might
       have this as a LHS:  let f71 = M.f Int in f71

   (c) Do eta reduction.  To see why, consider the fold/build rule,
       which without simplification looked like:
          fold k z (build (/\a. g a))  ==&gt;  ...
       This doesn't match unless you do eta reduction on the build argument.
       Similarly for a LHS like
         augment g (build h)
       we do not want to get
         augment (\a. g a) (build h)
       otherwise we don't match when given an argument like
          augment (\a. h a a) (build h)

Note [Matching seqId]
~~~~~~~~~~~~~~~~~~~
The desugarer turns (seq e r) into (case e of _ -&gt; r), via a special-case hack
and this code turns it back into an application of seq!
See Note [Rules for seq] in MkId for the details.

Note [Unused spec binders]
~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
        f :: a -&gt; a
        ... SPECIALISE f :: Eq a =&gt; a -&gt; a ...
It's true that this *is* a more specialised type, but the rule
we get is something like this:
        f_spec d = f
        RULE: f = f_spec d
Note that the rule is bogus, because it mentions a 'd' that is
not bound on the LHS!  But it's a silly specialisation anyway, because
the constraint is unused.  We could bind 'd' to (error &quot;unused&quot;)
but it seems better to reject the program because it's almost certainly
a mistake.  That's what the isDeadBinder call detects.

Note [No RULES on datacons]
~~~~~~~~~~~~~~~~~~~~~~~~~~~

Previously, `RULES` like

    &quot;JustNothing&quot; forall x . Just x = Nothing

were allowed. Simon Peyton Jones says this seems to have been a
mistake, that such rules have never been supported intentionally,
and that he doesn't know if they can break in horrible ways.
Furthermore, Ben Gamari and Reid Barton are considering trying to
detect the presence of &quot;static data&quot; that the simplifier doesn't
need to traverse at all. Such rules do not play well with that.
So for now, we ban them altogether as requested by #13290. See also #7398.


************************************************************************
*                                                                      *
                Desugaring evidence
*                                                                      *
************************************************************************

-}</span><span>
</span><a name="line-1115"></a><span>
</span><a name="line-1116"></a><span class="hs-identifier">dsHsWrapper</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsWrapper</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span>
</span><a name="line-1117"></a><a name="dsHsWrapper"><a href="DsBinds.html#dsHsWrapper"><span class="hs-identifier">dsHsWrapper</span></a></a><span> </span><span class="hs-identifier hs-var">WpHole</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621684032027"><a href="#local-6989586621684032027"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684032027"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1118"></a><span class="hs-identifier">dsHsWrapper</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WpTyApp</span><span> </span><a name="local-6989586621684032028"><a href="#local-6989586621684032028"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621684032029"><a href="#local-6989586621684032029"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">App</span><span> </span><a href="#local-6989586621684032029"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Type</span><span> </span><a href="#local-6989586621684032028"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1119"></a><span class="hs-identifier">dsHsWrapper</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WpEvLam</span><span> </span><a name="local-6989586621684032030"><a href="#local-6989586621684032030"><span class="hs-identifier">ev</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Lam</span><span> </span><a href="#local-6989586621684032030"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-1120"></a><span class="hs-identifier">dsHsWrapper</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WpTyLam</span><span> </span><a name="local-6989586621684032031"><a href="#local-6989586621684032031"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Lam</span><span> </span><a href="#local-6989586621684032031"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1121"></a><span class="hs-identifier">dsHsWrapper</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WpLet</span><span> </span><a name="local-6989586621684032032"><a href="#local-6989586621684032032"><span class="hs-identifier">ev_binds</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684032033"><a href="#local-6989586621684032033"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#dsTcEvBinds"><span class="hs-identifier hs-var">dsTcEvBinds</span></a><span> </span><a href="#local-6989586621684032032"><span class="hs-identifier hs-var">ev_binds</span></a><span>
</span><a name="line-1122"></a><span>                                   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCoreLets</span><span> </span><a href="#local-6989586621684032033"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1123"></a><span class="hs-identifier">dsHsWrapper</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WpCompose</span><span> </span><a name="local-6989586621684032034"><a href="#local-6989586621684032034"><span class="hs-identifier">c1</span></a></a><span> </span><a name="local-6989586621684032035"><a href="#local-6989586621684032035"><span class="hs-identifier">c2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684032036"><a href="#local-6989586621684032036"><span class="hs-identifier">w1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#dsHsWrapper"><span class="hs-identifier hs-var">dsHsWrapper</span></a><span> </span><a href="#local-6989586621684032034"><span class="hs-identifier hs-var">c1</span></a><span>
</span><a name="line-1124"></a><span>                                   </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684032037"><a href="#local-6989586621684032037"><span class="hs-identifier">w2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#dsHsWrapper"><span class="hs-identifier hs-var">dsHsWrapper</span></a><span> </span><a href="#local-6989586621684032035"><span class="hs-identifier hs-var">c2</span></a><span>
</span><a name="line-1125"></a><span>                                   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684032036"><span class="hs-identifier hs-var">w1</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621684032037"><span class="hs-identifier hs-var">w2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1126"></a><span> </span><span class="hs-comment">-- See comments on WpFun in TcEvidence for an explanation of what</span><span>
</span><a name="line-1127"></a><span> </span><span class="hs-comment">-- the specification of this clause is</span><span>
</span><a name="line-1128"></a><span class="hs-identifier">dsHsWrapper</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WpFun</span><span> </span><a name="local-6989586621684032038"><a href="#local-6989586621684032038"><span class="hs-identifier">c1</span></a></a><span> </span><a name="local-6989586621684032039"><a href="#local-6989586621684032039"><span class="hs-identifier">c2</span></a></a><span> </span><a name="local-6989586621684032040"><a href="#local-6989586621684032040"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-6989586621684032041"><a href="#local-6989586621684032041"><span class="hs-identifier">doc</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1129"></a><span>                              </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684032042"><a href="#local-6989586621684032042"><span class="hs-identifier">x</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#newSysLocalDsNoLP"><span class="hs-identifier hs-var">newSysLocalDsNoLP</span></a><span> </span><a href="#local-6989586621684032040"><span class="hs-identifier hs-var">t1</span></a><span>
</span><a name="line-1130"></a><span>                                   </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684032043"><a href="#local-6989586621684032043"><span class="hs-identifier">w1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#dsHsWrapper"><span class="hs-identifier hs-var">dsHsWrapper</span></a><span> </span><a href="#local-6989586621684032038"><span class="hs-identifier hs-var">c1</span></a><span>
</span><a name="line-1131"></a><span>                                   </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684032044"><a href="#local-6989586621684032044"><span class="hs-identifier">w2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#dsHsWrapper"><span class="hs-identifier hs-var">dsHsWrapper</span></a><span> </span><a href="#local-6989586621684032039"><span class="hs-identifier hs-var">c2</span></a><span>
</span><a name="line-1132"></a><span>                                   </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684032045"><a href="#local-6989586621684032045"><span class="hs-identifier">app</span></a></a><span> </span><a name="local-6989586621684032047"><a href="#local-6989586621684032047"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621684032048"><a href="#local-6989586621684032048"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#mkCoreAppDs"><span class="hs-identifier hs-var">mkCoreAppDs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;dsHsWrapper&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684032047"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621684032048"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-1133"></a><span>                                         </span><a name="local-6989586621684032046"><a href="#local-6989586621684032046"><span class="hs-identifier">arg</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684032043"><span class="hs-identifier hs-var">w1</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684032042"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-1134"></a><span>                                   </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684032049"><a href="#local-6989586621684032049"><span class="hs-identifier">ok</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#askNoErrsDs"><span class="hs-identifier hs-var">askNoErrsDs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="DsMonad.html#dsNoLevPolyExpr"><span class="hs-identifier hs-var">dsNoLevPolyExpr</span></a><span> </span><a href="#local-6989586621684032046"><span class="hs-identifier hs-var">arg</span></a><span> </span><a href="#local-6989586621684032041"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-1135"></a><span>                                   </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621684032049"><span class="hs-identifier hs-var">ok</span></a><span>
</span><a name="line-1136"></a><span>                                     </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684032050"><a href="#local-6989586621684032050"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Lam</span><span> </span><a href="#local-6989586621684032042"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684032044"><span class="hs-identifier hs-var">w2</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684032045"><span class="hs-identifier hs-var">app</span></a><span> </span><a href="#local-6989586621684032050"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621684032046"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1137"></a><span>                                     </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-special">}</span><span>  </span><span class="hs-comment">-- this return is irrelevant</span><span>
</span><a name="line-1138"></a><span class="hs-identifier">dsHsWrapper</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WpCast</span><span> </span><a name="local-6989586621684032051"><a href="#local-6989586621684032051"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier">coercionRole</span><span> </span><span class="hs-identifier">co</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">Representational</span><span class="hs-special">)</span><span>
</span><a name="line-1139"></a><span>                                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621684032052"><a href="#local-6989586621684032052"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsUtils.html#mkCastDs"><span class="hs-identifier hs-var">mkCastDs</span></a><span> </span><a href="#local-6989586621684032052"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621684032051"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1140"></a><span class="hs-identifier">dsHsWrapper</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WpEvApp</span><span> </span><a name="local-6989586621684032053"><a href="#local-6989586621684032053"><span class="hs-identifier">tm</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684032054"><a href="#local-6989586621684032054"><span class="hs-identifier">core_tm</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#dsEvTerm"><span class="hs-identifier hs-var">dsEvTerm</span></a><span> </span><a href="#local-6989586621684032053"><span class="hs-identifier hs-var">tm</span></a><span>
</span><a name="line-1141"></a><span>                                   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684032055"><a href="#local-6989586621684032055"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">App</span><span> </span><a href="#local-6989586621684032055"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621684032054"><span class="hs-identifier hs-var">core_tm</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1142"></a><span>
</span><a name="line-1143"></a><span class="hs-comment">--------------------------------------</span><span>
</span><a name="line-1144"></a><span class="hs-identifier">dsTcEvBinds_s</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcEvBinds</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreBind</span><span class="hs-special">]</span><span>
</span><a name="line-1145"></a><a name="dsTcEvBinds_s"><a href="DsBinds.html#dsTcEvBinds_s"><span class="hs-identifier">dsTcEvBinds_s</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1146"></a><span class="hs-identifier">dsTcEvBinds_s</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684032056"><a href="#local-6989586621684032056"><span class="hs-identifier">b</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684032057"><a href="#local-6989586621684032057"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-identifier">rest</span><span> </span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Zonker ensures null</span><span>
</span><a name="line-1147"></a><span>                         </span><a href="DsBinds.html#dsTcEvBinds"><span class="hs-identifier hs-var">dsTcEvBinds</span></a><span> </span><a href="#local-6989586621684032056"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-1148"></a><span>
</span><a name="line-1149"></a><span class="hs-identifier">dsTcEvBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcEvBinds</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreBind</span><span class="hs-special">]</span><span>
</span><a name="line-1150"></a><a name="dsTcEvBinds"><a href="DsBinds.html#dsTcEvBinds"><span class="hs-identifier">dsTcEvBinds</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TcEvBinds</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsEvBinds&quot;</span><span>    </span><span class="hs-comment">-- Zonker has got rid of this</span><span>
</span><a name="line-1151"></a><span class="hs-identifier">dsTcEvBinds</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvBinds</span><span> </span><a name="local-6989586621684032058"><a href="#local-6989586621684032058"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="DsBinds.html#dsEvBinds"><span class="hs-identifier hs-var">dsEvBinds</span></a><span> </span><a href="#local-6989586621684032058"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-1152"></a><span>
</span><a name="line-1153"></a><span class="hs-identifier">dsEvBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bag</span><span> </span><span class="hs-identifier hs-type">EvBind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreBind</span><span class="hs-special">]</span><span>
</span><a name="line-1154"></a><a name="dsEvBinds"><a href="DsBinds.html#dsEvBinds"><span class="hs-identifier">dsEvBinds</span></a></a><span> </span><a name="local-6989586621684032059"><a href="#local-6989586621684032059"><span class="hs-identifier">bs</span></a></a><span>
</span><a name="line-1155"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684032060"><a href="#local-6989586621684032060"><span class="hs-identifier">ds_bs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapBagM</span><span> </span><a href="DsBinds.html#dsEvBind"><span class="hs-identifier hs-var">dsEvBind</span></a><span> </span><a href="#local-6989586621684032059"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-1156"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="DsBinds.html#mk_ev_binds"><span class="hs-identifier hs-var">mk_ev_binds</span></a><span> </span><a href="#local-6989586621684032060"><span class="hs-identifier hs-var">ds_bs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1157"></a><span>
</span><a name="line-1158"></a><span class="hs-identifier">mk_ev_binds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bag</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreBind</span><span class="hs-special">]</span><span>
</span><a name="line-1159"></a><span class="hs-comment">-- We do SCC analysis of the evidence bindings, /after/ desugaring</span><span>
</span><a name="line-1160"></a><span class="hs-comment">-- them. This is convenient: it means we can use the CoreSyn</span><span>
</span><a name="line-1161"></a><span class="hs-comment">-- free-variable functions rather than having to do accurate free vars</span><span>
</span><a name="line-1162"></a><span class="hs-comment">-- for EvTerm.</span><span>
</span><a name="line-1163"></a><a name="mk_ev_binds"><a href="DsBinds.html#mk_ev_binds"><span class="hs-identifier">mk_ev_binds</span></a></a><span> </span><a name="local-6989586621684032061"><a href="#local-6989586621684032061"><span class="hs-identifier">ds_binds</span></a></a><span>
</span><a name="line-1164"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621684032064"><span class="hs-identifier hs-var">ds_scc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">stronglyConnCompFromEdgedVerticesUniq</span><span> </span><a href="#local-6989586621684032062"><span class="hs-identifier hs-var">edges</span></a><span class="hs-special">)</span><span>
</span><a name="line-1165"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1166"></a><span>    </span><span class="hs-identifier">edges</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-type">Node</span><span> </span><span class="hs-identifier hs-type">EvVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">EvVar</span><span class="hs-special">,</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1167"></a><span>    </span><a name="local-6989586621684032062"><a href="#local-6989586621684032062"><span class="hs-identifier">edges</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldrBag</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621684032063"><span class="hs-identifier hs-var">mk_node</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621684032061"><span class="hs-identifier hs-var">ds_binds</span></a><span>
</span><a name="line-1168"></a><span>
</span><a name="line-1169"></a><span>    </span><span class="hs-identifier">mk_node</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Node</span><span> </span><span class="hs-identifier hs-type">EvVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">EvVar</span><span class="hs-special">,</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span>
</span><a name="line-1170"></a><span>    </span><a name="local-6989586621684032063"><a href="#local-6989586621684032063"><span class="hs-identifier">mk_node</span></a></a><span> </span><a name="local-6989586621684032065"><a href="#local-6989586621684032065"><span class="hs-identifier">b</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621684032066"><a href="#local-6989586621684032066"><span class="hs-identifier">var</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684032067"><a href="#local-6989586621684032067"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1171"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DigraphNode</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">node_payload</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684032065"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-1172"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">node_key</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684032066"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-1173"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">node_dependencies</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nonDetEltsUniqSet</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1174"></a><span>                                          </span><span class="hs-identifier hs-var">exprFreeVars</span><span> </span><a href="#local-6989586621684032067"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionVarSet</span><span class="hs-special">`</span><span>
</span><a name="line-1175"></a><span>                                          </span><span class="hs-identifier hs-var">coVarsOfType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">varType</span><span> </span><a href="#local-6989586621684032066"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1176"></a><span>      </span><span class="hs-comment">-- It's OK to use nonDetEltsUniqSet here as stronglyConnCompFromEdgedVertices</span><span>
</span><a name="line-1177"></a><span>      </span><span class="hs-comment">-- is still deterministic even if the edges are in nondeterministic order</span><span>
</span><a name="line-1178"></a><span>      </span><span class="hs-comment">-- as explained in Note [Deterministic SCC] in Digraph.</span><span>
</span><a name="line-1179"></a><span>
</span><a name="line-1180"></a><span>    </span><a name="local-6989586621684032064"><a href="#local-6989586621684032064"><span class="hs-identifier">ds_scc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AcyclicSCC</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684032068"><a href="#local-6989586621684032068"><span class="hs-identifier">v</span></a></a><span class="hs-special">,</span><a name="local-6989586621684032069"><a href="#local-6989586621684032069"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621684032068"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621684032069"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1181"></a><span>    </span><span class="hs-identifier">ds_scc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CyclicSCC</span><span> </span><a name="local-6989586621684032070"><a href="#local-6989586621684032070"><span class="hs-identifier">prs</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Rec</span><span> </span><a href="#local-6989586621684032070"><span class="hs-identifier hs-var">prs</span></a><span>
</span><a name="line-1182"></a><span>
</span><a name="line-1183"></a><span class="hs-identifier">dsEvBind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">EvBind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span>
</span><a name="line-1184"></a><a name="dsEvBind"><a href="DsBinds.html#dsEvBind"><span class="hs-identifier">dsEvBind</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvBind</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">eb_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684032071"><a href="#local-6989586621684032071"><span class="hs-identifier">v</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">eb_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684032072"><a href="#local-6989586621684032072"><span class="hs-identifier">r</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684032071"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="DsBinds.html#dsEvTerm"><span class="hs-identifier hs-var">dsEvTerm</span></a><span> </span><a href="#local-6989586621684032072"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-1185"></a><span>
</span><a name="line-1186"></a><span>
</span><a name="line-1187"></a><span class="hs-comment">{-**********************************************************************
*                                                                      *
           Desugaring EvTerms
*                                                                      *
**********************************************************************-}</span><span>
</span><a name="line-1192"></a><span>
</span><a name="line-1193"></a><span class="hs-identifier">dsEvTerm</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">EvTerm</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-1194"></a><a name="dsEvTerm"><a href="DsBinds.html#dsEvTerm"><span class="hs-identifier">dsEvTerm</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvExpr</span><span> </span><a name="local-6989586621684032073"><a href="#local-6989586621684032073"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684032073"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1195"></a><span class="hs-identifier">dsEvTerm</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvTypeable</span><span> </span><a name="local-6989586621684032074"><a href="#local-6989586621684032074"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621684032075"><a href="#local-6989586621684032075"><span class="hs-identifier">ev</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsBinds.html#dsEvTypeable"><span class="hs-identifier hs-var">dsEvTypeable</span></a><span> </span><a href="#local-6989586621684032074"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621684032075"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-1196"></a><span class="hs-identifier">dsEvTerm</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvFun</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">et_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684032076"><a href="#local-6989586621684032076"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">et_given</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684032077"><a href="#local-6989586621684032077"><span class="hs-identifier">given</span></a></a><span>
</span><a name="line-1197"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">et_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684032078"><a href="#local-6989586621684032078"><span class="hs-identifier">ev_binds</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">et_body</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684032079"><a href="#local-6989586621684032079"><span class="hs-identifier">wanted_id</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1198"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684032080"><a href="#local-6989586621684032080"><span class="hs-identifier">ds_ev_binds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#dsTcEvBinds"><span class="hs-identifier hs-var">dsTcEvBinds</span></a><span> </span><a href="#local-6989586621684032078"><span class="hs-identifier hs-var">ev_binds</span></a><span>
</span><a name="line-1199"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLams</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684032076"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684032077"><span class="hs-identifier hs-var">given</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1200"></a><span>                   </span><span class="hs-identifier hs-var">mkCoreLets</span><span> </span><a href="#local-6989586621684032080"><span class="hs-identifier hs-var">ds_ev_binds</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1201"></a><span>                   </span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684032079"><span class="hs-identifier hs-var">wanted_id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1202"></a><span>
</span><a name="line-1203"></a><span>
</span><a name="line-1204"></a><span class="hs-comment">{-**********************************************************************
*                                                                      *
           Desugaring Typeable dictionaries
*                                                                      *
**********************************************************************-}</span><span>
</span><a name="line-1209"></a><span>
</span><a name="line-1210"></a><span class="hs-identifier">dsEvTypeable</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">EvTypeable</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-1211"></a><span class="hs-comment">-- Return a CoreExpr :: Typeable ty</span><span>
</span><a name="line-1212"></a><span class="hs-comment">-- This code is tightly coupled to the representation</span><span>
</span><a name="line-1213"></a><span class="hs-comment">-- of TypeRep, in base library Data.Typeable.Internals</span><span>
</span><a name="line-1214"></a><a name="dsEvTypeable"><a href="DsBinds.html#dsEvTypeable"><span class="hs-identifier">dsEvTypeable</span></a></a><span> </span><a name="local-6989586621684032081"><a href="#local-6989586621684032081"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621684032082"><a href="#local-6989586621684032082"><span class="hs-identifier">ev</span></a></a><span>
</span><a name="line-1215"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684032083"><a href="#local-6989586621684032083"><span class="hs-identifier">tyCl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#dsLookupTyCon"><span class="hs-identifier hs-var">dsLookupTyCon</span></a><span> </span><span class="hs-identifier hs-var">typeableClassName</span><span>    </span><span class="hs-comment">-- Typeable</span><span>
</span><a name="line-1216"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684032084"><a href="#local-6989586621684032084"><span class="hs-identifier">kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">typeKind</span><span> </span><a href="#local-6989586621684032081"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1217"></a><span>             </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684032085"><a href="#local-6989586621684032085"><span class="hs-identifier">typeable_data_con</span></a></a><span>
</span><a name="line-1218"></a><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConSingleDataCon_maybe</span><span> </span><a href="#local-6989586621684032083"><span class="hs-identifier hs-var">tyCl</span></a><span>    </span><span class="hs-comment">-- &quot;Data constructor&quot;</span><span>
</span><a name="line-1219"></a><span>                                                    </span><span class="hs-comment">-- for Typeable</span><span>
</span><a name="line-1220"></a><span>
</span><a name="line-1221"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684032086"><a href="#local-6989586621684032086"><span class="hs-identifier">rep_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#ds_ev_typeable"><span class="hs-identifier hs-var">ds_ev_typeable</span></a><span> </span><a href="#local-6989586621684032081"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621684032082"><span class="hs-identifier hs-var">ev</span></a><span>           </span><span class="hs-comment">-- :: TypeRep a</span><span>
</span><a name="line-1222"></a><span>
</span><a name="line-1223"></a><span>       </span><span class="hs-comment">-- Package up the method as `Typeable` dictionary</span><span>
</span><a name="line-1224"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkConApp</span><span> </span><a href="#local-6989586621684032085"><span class="hs-identifier hs-var">typeable_data_con</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Type</span><span> </span><a href="#local-6989586621684032084"><span class="hs-identifier hs-var">kind</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Type</span><span> </span><a href="#local-6989586621684032081"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684032086"><span class="hs-identifier hs-var">rep_expr</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1225"></a><span>
</span><a name="line-1226"></a><span class="hs-keyword">type</span><span> </span><a name="TypeRepExpr"><a href="DsBinds.html#TypeRepExpr"><span class="hs-identifier">TypeRepExpr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-1227"></a><span>
</span><a name="line-1228"></a><span class="hs-comment">-- | Returns a @CoreExpr :: TypeRep ty@</span><span>
</span><a name="line-1229"></a><span class="hs-identifier">ds_ev_typeable</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">EvTypeable</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-1230"></a><a name="ds_ev_typeable"><a href="DsBinds.html#ds_ev_typeable"><span class="hs-identifier">ds_ev_typeable</span></a></a><span> </span><a name="local-6989586621684032087"><a href="#local-6989586621684032087"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvTypeableTyCon</span><span> </span><a name="local-6989586621684032088"><a href="#local-6989586621684032088"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621684032089"><a href="#local-6989586621684032089"><span class="hs-identifier">kind_ev</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1231"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684032090"><a href="#local-6989586621684032090"><span class="hs-identifier">mkTrCon</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#dsLookupGlobalId"><span class="hs-identifier hs-var">dsLookupGlobalId</span></a><span> </span><span class="hs-identifier hs-var">mkTrConName</span><span>
</span><a name="line-1232"></a><span>                    </span><span class="hs-comment">-- mkTrCon :: forall k (a :: k). TyCon -&gt; TypeRep k -&gt; TypeRep a</span><span>
</span><a name="line-1233"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684032091"><a href="#local-6989586621684032091"><span class="hs-identifier">someTypeRepTyCon</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#dsLookupTyCon"><span class="hs-identifier hs-var">dsLookupTyCon</span></a><span> </span><span class="hs-identifier hs-var">someTypeRepTyConName</span><span>
</span><a name="line-1234"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684032092"><a href="#local-6989586621684032092"><span class="hs-identifier">someTypeRepDataCon</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#dsLookupDataCon"><span class="hs-identifier hs-var">dsLookupDataCon</span></a><span> </span><span class="hs-identifier hs-var">someTypeRepDataConName</span><span>
</span><a name="line-1235"></a><span>                    </span><span class="hs-comment">-- SomeTypeRep :: forall k (a :: k). TypeRep a -&gt; SomeTypeRep</span><span>
</span><a name="line-1236"></a><span>
</span><a name="line-1237"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684032093"><a href="#local-6989586621684032093"><span class="hs-identifier">tc_rep</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#tyConRep"><span class="hs-identifier hs-var">tyConRep</span></a><span> </span><a href="#local-6989586621684032088"><span class="hs-identifier hs-var">tc</span></a><span>                      </span><span class="hs-comment">-- :: TyCon</span><span>
</span><a name="line-1238"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684032094"><a href="#local-6989586621684032094"><span class="hs-identifier">ks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConAppArgs</span><span> </span><a href="#local-6989586621684032087"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1239"></a><span>             </span><span class="hs-comment">-- Construct a SomeTypeRep</span><span>
</span><a name="line-1240"></a><span>             </span><span class="hs-identifier">toSomeTypeRep</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">EvTerm</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-1241"></a><span>             </span><a name="local-6989586621684032095"><a href="#local-6989586621684032095"><span class="hs-identifier">toSomeTypeRep</span></a></a><span> </span><a name="local-6989586621684032096"><a href="#local-6989586621684032096"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621684032097"><a href="#local-6989586621684032097"><span class="hs-identifier">ev</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1242"></a><span>                 </span><a name="local-6989586621684032098"><a href="#local-6989586621684032098"><span class="hs-identifier">rep</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#getRep"><span class="hs-identifier hs-var">getRep</span></a><span> </span><a href="#local-6989586621684032097"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621684032096"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-1243"></a><span>                 </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkCoreConApps</span><span> </span><a href="#local-6989586621684032092"><span class="hs-identifier hs-var">someTypeRepDataCon</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Type</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">typeKind</span><span> </span><a href="#local-6989586621684032096"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Type</span><span> </span><a href="#local-6989586621684032096"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684032098"><span class="hs-identifier hs-var">rep</span></a><span class="hs-special">]</span><span>
</span><a name="line-1244"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684032099"><a href="#local-6989586621684032099"><span class="hs-identifier">kind_arg_reps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">sequence</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="#local-6989586621684032095"><span class="hs-identifier hs-var">toSomeTypeRep</span></a><span> </span><a href="#local-6989586621684032094"><span class="hs-identifier hs-var">ks</span></a><span> </span><a href="#local-6989586621684032089"><span class="hs-identifier hs-var">kind_ev</span></a><span>   </span><span class="hs-comment">-- :: TypeRep t</span><span>
</span><a name="line-1245"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- :: [SomeTypeRep]</span><span>
</span><a name="line-1246"></a><span>             </span><a name="local-6989586621684032100"><a href="#local-6989586621684032100"><span class="hs-identifier">kind_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkListExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConTy</span><span> </span><a href="#local-6989586621684032091"><span class="hs-identifier hs-var">someTypeRepTyCon</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684032099"><span class="hs-identifier hs-var">kind_arg_reps</span></a><span>
</span><a name="line-1247"></a><span>
</span><a name="line-1248"></a><span>         </span><span class="hs-comment">-- Note that we use the kind of the type, not the TyCon from which it</span><span>
</span><a name="line-1249"></a><span>         </span><span class="hs-comment">-- is constructed since the latter may be kind polymorphic whereas the</span><span>
</span><a name="line-1250"></a><span>         </span><span class="hs-comment">-- former we know is not (we checked in the solver).</span><span>
</span><a name="line-1251"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684032101"><a href="#local-6989586621684032101"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkApps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684032090"><span class="hs-identifier hs-var">mkTrCon</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">Type</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">typeKind</span><span> </span><a href="#local-6989586621684032087"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1252"></a><span>                                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Type</span><span> </span><a href="#local-6989586621684032087"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1253"></a><span>                                         </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684032093"><span class="hs-identifier hs-var">tc_rep</span></a><span>
</span><a name="line-1254"></a><span>                                         </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684032100"><span class="hs-identifier hs-var">kind_args</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1255"></a><span>       </span><span class="hs-comment">-- ; pprRuntimeTrace &quot;Trace mkTrTyCon&quot; (ppr expr) expr</span><span>
</span><a name="line-1256"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684032101"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-1257"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-1258"></a><span>
</span><a name="line-1259"></a><span class="hs-identifier">ds_ev_typeable</span><span> </span><a name="local-6989586621684032102"><a href="#local-6989586621684032102"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvTypeableTyApp</span><span> </span><a name="local-6989586621684032103"><a href="#local-6989586621684032103"><span class="hs-identifier">ev1</span></a></a><span> </span><a name="local-6989586621684032104"><a href="#local-6989586621684032104"><span class="hs-identifier">ev2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1260"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684032105"><a href="#local-6989586621684032105"><span class="hs-identifier">t1</span></a></a><span class="hs-special">,</span><a name="local-6989586621684032106"><a href="#local-6989586621684032106"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">splitAppTy_maybe</span><span> </span><a href="#local-6989586621684032102"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1261"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684032107"><a href="#local-6989586621684032107"><span class="hs-identifier">e1</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#getRep"><span class="hs-identifier hs-var">getRep</span></a><span> </span><a href="#local-6989586621684032103"><span class="hs-identifier hs-var">ev1</span></a><span> </span><a href="#local-6989586621684032105"><span class="hs-identifier hs-var">t1</span></a><span>
</span><a name="line-1262"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684032108"><a href="#local-6989586621684032108"><span class="hs-identifier">e2</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#getRep"><span class="hs-identifier hs-var">getRep</span></a><span> </span><a href="#local-6989586621684032104"><span class="hs-identifier hs-var">ev2</span></a><span> </span><a href="#local-6989586621684032106"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-1263"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684032109"><a href="#local-6989586621684032109"><span class="hs-identifier">mkTrApp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#dsLookupGlobalId"><span class="hs-identifier hs-var">dsLookupGlobalId</span></a><span> </span><span class="hs-identifier hs-var">mkTrAppName</span><span>
</span><a name="line-1264"></a><span>                    </span><span class="hs-comment">-- mkTrApp :: forall k1 k2 (a :: k1 -&gt; k2) (b :: k1).</span><span>
</span><a name="line-1265"></a><span>                    </span><span class="hs-comment">--            TypeRep a -&gt; TypeRep b -&gt; TypeRep (a b)</span><span>
</span><a name="line-1266"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684032110"><a href="#local-6989586621684032110"><span class="hs-identifier">k1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684032111"><a href="#local-6989586621684032111"><span class="hs-identifier">k2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitFunTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">typeKind</span><span> </span><a href="#local-6989586621684032105"><span class="hs-identifier hs-var">t1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1267"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684032112"><a href="#local-6989586621684032112"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">mkApps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyApps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684032109"><span class="hs-identifier hs-var">mkTrApp</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621684032110"><span class="hs-identifier hs-var">k1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684032111"><span class="hs-identifier hs-var">k2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684032105"><span class="hs-identifier hs-var">t1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684032106"><span class="hs-identifier hs-var">t2</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1268"></a><span>                            </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621684032107"><span class="hs-identifier hs-var">e1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684032108"><span class="hs-identifier hs-var">e2</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1269"></a><span>       </span><span class="hs-comment">-- ; pprRuntimeTrace &quot;Trace mkTrApp&quot; (ppr expr) expr</span><span>
</span><a name="line-1270"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684032112"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-1271"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-1272"></a><span>
</span><a name="line-1273"></a><span class="hs-identifier">ds_ev_typeable</span><span> </span><a name="local-6989586621684032113"><a href="#local-6989586621684032113"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvTypeableTrFun</span><span> </span><a name="local-6989586621684032114"><a href="#local-6989586621684032114"><span class="hs-identifier">ev1</span></a></a><span> </span><a name="local-6989586621684032115"><a href="#local-6989586621684032115"><span class="hs-identifier">ev2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1274"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684032116"><a href="#local-6989586621684032116"><span class="hs-identifier">t1</span></a></a><span class="hs-special">,</span><a name="local-6989586621684032117"><a href="#local-6989586621684032117"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">splitFunTy_maybe</span><span> </span><a href="#local-6989586621684032113"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1275"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684032118"><a href="#local-6989586621684032118"><span class="hs-identifier">e1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#getRep"><span class="hs-identifier hs-var">getRep</span></a><span> </span><a href="#local-6989586621684032114"><span class="hs-identifier hs-var">ev1</span></a><span> </span><a href="#local-6989586621684032116"><span class="hs-identifier hs-var">t1</span></a><span>
</span><a name="line-1276"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684032119"><a href="#local-6989586621684032119"><span class="hs-identifier">e2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#getRep"><span class="hs-identifier hs-var">getRep</span></a><span> </span><a href="#local-6989586621684032115"><span class="hs-identifier hs-var">ev2</span></a><span> </span><a href="#local-6989586621684032117"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-1277"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684032120"><a href="#local-6989586621684032120"><span class="hs-identifier">mkTrFun</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#dsLookupGlobalId"><span class="hs-identifier hs-var">dsLookupGlobalId</span></a><span> </span><span class="hs-identifier hs-var">mkTrFunName</span><span>
</span><a name="line-1278"></a><span>                    </span><span class="hs-comment">-- mkTrFun :: forall r1 r2 (a :: TYPE r1) (b :: TYPE r2).</span><span>
</span><a name="line-1279"></a><span>                    </span><span class="hs-comment">--            TypeRep a -&gt; TypeRep b -&gt; TypeRep (a -&gt; b)</span><span>
</span><a name="line-1280"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684032121"><a href="#local-6989586621684032121"><span class="hs-identifier">r1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getRuntimeRep</span><span> </span><a href="#local-6989586621684032116"><span class="hs-identifier hs-var">t1</span></a><span>
</span><a name="line-1281"></a><span>             </span><a name="local-6989586621684032122"><a href="#local-6989586621684032122"><span class="hs-identifier">r2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getRuntimeRep</span><span> </span><a href="#local-6989586621684032117"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-1282"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkApps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyApps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684032120"><span class="hs-identifier hs-var">mkTrFun</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684032121"><span class="hs-identifier hs-var">r1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684032122"><span class="hs-identifier hs-var">r2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684032116"><span class="hs-identifier hs-var">t1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684032117"><span class="hs-identifier hs-var">t2</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1283"></a><span>                         </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621684032118"><span class="hs-identifier hs-var">e1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684032119"><span class="hs-identifier hs-var">e2</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1284"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-1285"></a><span>
</span><a name="line-1286"></a><span class="hs-identifier">ds_ev_typeable</span><span> </span><a name="local-6989586621684032123"><a href="#local-6989586621684032123"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvTypeableTyLit</span><span> </span><a name="local-6989586621684032124"><a href="#local-6989586621684032124"><span class="hs-identifier">ev</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1287"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- See Note [Typeable for Nat and Symbol] in TcInteract</span><span>
</span><a name="line-1288"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684032127"><a href="#local-6989586621684032127"><span class="hs-identifier">fun</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#dsLookupGlobalId"><span class="hs-identifier hs-var">dsLookupGlobalId</span></a><span> </span><a href="#local-6989586621684032126"><span class="hs-identifier hs-var">tr_fun</span></a><span>
</span><a name="line-1289"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684032128"><a href="#local-6989586621684032128"><span class="hs-identifier">dict</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#dsEvTerm"><span class="hs-identifier hs-var">dsEvTerm</span></a><span> </span><a href="#local-6989586621684032124"><span class="hs-identifier hs-var">ev</span></a><span>       </span><span class="hs-comment">-- Of type KnownNat/KnownSymbol</span><span>
</span><a name="line-1290"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684032129"><a href="#local-6989586621684032129"><span class="hs-identifier">proxy</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyApps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><span class="hs-identifier hs-var">proxyHashId</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684032125"><span class="hs-identifier hs-var">ty_kind</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684032123"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-1291"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkApps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyApps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684032127"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684032123"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621684032128"><span class="hs-identifier hs-var">dict</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684032129"><span class="hs-identifier hs-var">proxy</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1292"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1293"></a><span>    </span><a name="local-6989586621684032125"><a href="#local-6989586621684032125"><span class="hs-identifier">ty_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">typeKind</span><span> </span><a href="#local-6989586621684032123"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1294"></a><span>
</span><a name="line-1295"></a><span>    </span><span class="hs-comment">-- tr_fun is the Name of</span><span>
</span><a name="line-1296"></a><span>    </span><span class="hs-comment">--       typeNatTypeRep    :: KnownNat    a =&gt; Proxy# a -&gt; TypeRep a</span><span>
</span><a name="line-1297"></a><span>    </span><span class="hs-comment">-- of    typeSymbolTypeRep :: KnownSymbol a =&gt; Proxy# a -&gt; TypeRep a</span><span>
</span><a name="line-1298"></a><span>    </span><a name="local-6989586621684032126"><a href="#local-6989586621684032126"><span class="hs-identifier">tr_fun</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684032125"><span class="hs-identifier hs-var">ty_kind</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">typeNatKind</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">typeNatTypeRepName</span><span>
</span><a name="line-1299"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684032125"><span class="hs-identifier hs-var">ty_kind</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">typeSymbolKind</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">typeSymbolTypeRepName</span><span>
</span><a name="line-1300"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsEvTypeable: unknown type lit kind&quot;</span><span>
</span><a name="line-1301"></a><span>
</span><a name="line-1302"></a><span class="hs-identifier">ds_ev_typeable</span><span> </span><a name="local-6989586621684032130"><a href="#local-6989586621684032130"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621684032131"><a href="#local-6989586621684032131"><span class="hs-identifier">ev</span></a></a><span>
</span><a name="line-1303"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;dsEvTypeable&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684032130"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684032131"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span>
</span><a name="line-1304"></a><span>
</span><a name="line-1305"></a><span class="hs-identifier">getRep</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">EvTerm</span><span>          </span><span class="hs-comment">-- ^ EvTerm for @Typeable ty@</span><span>
</span><a name="line-1306"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>            </span><span class="hs-comment">-- ^ The type @ty@</span><span>
</span><a name="line-1307"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><a href="DsBinds.html#TypeRepExpr"><span class="hs-identifier hs-type">TypeRepExpr</span></a><span> </span><span class="hs-comment">-- ^ Return @CoreExpr :: TypeRep ty@</span><span>
</span><a name="line-1308"></a><span>                          </span><span class="hs-comment">-- namely @typeRep# dict@</span><span>
</span><a name="line-1309"></a><span class="hs-comment">-- Remember that</span><span>
</span><a name="line-1310"></a><span class="hs-comment">--   typeRep# :: forall k (a::k). Typeable k a -&gt; TypeRep a</span><span>
</span><a name="line-1311"></a><a name="getRep"><a href="DsBinds.html#getRep"><span class="hs-identifier">getRep</span></a></a><span> </span><a name="local-6989586621684032132"><a href="#local-6989586621684032132"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621684032133"><a href="#local-6989586621684032133"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1312"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684032134"><a href="#local-6989586621684032134"><span class="hs-identifier">typeable_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#dsEvTerm"><span class="hs-identifier hs-var">dsEvTerm</span></a><span> </span><a href="#local-6989586621684032132"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-1313"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684032135"><a href="#local-6989586621684032135"><span class="hs-identifier">typeRepId</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#dsLookupGlobalId"><span class="hs-identifier hs-var">dsLookupGlobalId</span></a><span> </span><span class="hs-identifier hs-var">typeRepIdName</span><span>
</span><a name="line-1314"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684032136"><a href="#local-6989586621684032136"><span class="hs-identifier">ty_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">typeKind</span><span> </span><a href="#local-6989586621684032133"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684032133"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-1315"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkApps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyApps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684032135"><span class="hs-identifier hs-var">typeRepId</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684032136"><span class="hs-identifier hs-var">ty_args</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621684032134"><span class="hs-identifier hs-var">typeable_expr</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1316"></a><span>
</span><a name="line-1317"></a><span class="hs-identifier">tyConRep</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-1318"></a><span class="hs-comment">-- Returns CoreExpr :: TyCon</span><span>
</span><a name="line-1319"></a><a name="tyConRep"><a href="DsBinds.html#tyConRep"><span class="hs-identifier">tyConRep</span></a></a><span> </span><a name="local-6989586621684032137"><a href="#local-6989586621684032137"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-1320"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684032138"><a href="#local-6989586621684032138"><span class="hs-identifier">tc_rep_nm</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tyConRepName_maybe</span><span> </span><a href="#local-6989586621684032137"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1321"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684032139"><a href="#local-6989586621684032139"><span class="hs-identifier">tc_rep_id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#dsLookupGlobalId"><span class="hs-identifier hs-var">dsLookupGlobalId</span></a><span> </span><a href="#local-6989586621684032138"><span class="hs-identifier hs-var">tc_rep_nm</span></a><span>
</span><a name="line-1322"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684032139"><span class="hs-identifier hs-var">tc_rep_id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1323"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1324"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;tyConRep&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684032137"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1325"></a></pre></body></html>