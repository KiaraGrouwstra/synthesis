<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998


Utilities for desugaring

This module exports some utility functions of no great interest.
-}</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-12"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><a name="line-13"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-14"></a><span class="hs-pragma">{-# LANGUAGE ViewPatterns #-}</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span class="hs-comment">-- | Utility functions for constructing Core syntax, principally for desugaring</span><span>
</span><a name="line-17"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">DsUtils</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-18"></a><span>        </span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>        </span><a href="DsUtils.html#firstPat"><span class="hs-identifier hs-var">firstPat</span></a><span class="hs-special">,</span><span> </span><a href="DsUtils.html#shiftEqns"><span class="hs-identifier hs-var">shiftEqns</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span>        </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="DsMonad.html#CanItFail"><span class="hs-identifier hs-type">CanItFail</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="DsUtils.html#CaseAlt"><span class="hs-identifier hs-type">CaseAlt</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>        </span><a href="DsUtils.html#cantFailMatchResult"><span class="hs-identifier hs-var">cantFailMatchResult</span></a><span class="hs-special">,</span><span> </span><a href="DsUtils.html#alwaysFailMatchResult"><span class="hs-identifier hs-var">alwaysFailMatchResult</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>        </span><a href="DsUtils.html#extractMatchResult"><span class="hs-identifier hs-var">extractMatchResult</span></a><span class="hs-special">,</span><span> </span><a href="DsUtils.html#combineMatchResults"><span class="hs-identifier hs-var">combineMatchResults</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>        </span><a href="DsUtils.html#adjustMatchResult"><span class="hs-identifier hs-var">adjustMatchResult</span></a><span class="hs-special">,</span><span>  </span><a href="DsUtils.html#adjustMatchResultDs"><span class="hs-identifier hs-var">adjustMatchResultDs</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>        </span><a href="DsUtils.html#mkCoLetMatchResult"><span class="hs-identifier hs-var">mkCoLetMatchResult</span></a><span class="hs-special">,</span><span> </span><a href="DsUtils.html#mkViewMatchResult"><span class="hs-identifier hs-var">mkViewMatchResult</span></a><span class="hs-special">,</span><span> </span><a href="DsUtils.html#mkGuardedMatchResult"><span class="hs-identifier hs-var">mkGuardedMatchResult</span></a><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>        </span><a href="DsUtils.html#matchCanFail"><span class="hs-identifier hs-var">matchCanFail</span></a><span class="hs-special">,</span><span> </span><a href="DsUtils.html#mkEvalMatchResult"><span class="hs-identifier hs-var">mkEvalMatchResult</span></a><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>        </span><a href="DsUtils.html#mkCoPrimCaseMatchResult"><span class="hs-identifier hs-var">mkCoPrimCaseMatchResult</span></a><span class="hs-special">,</span><span> </span><a href="DsUtils.html#mkCoAlgCaseMatchResult"><span class="hs-identifier hs-var">mkCoAlgCaseMatchResult</span></a><span class="hs-special">,</span><span> </span><a href="DsUtils.html#mkCoSynCaseMatchResult"><span class="hs-identifier hs-var">mkCoSynCaseMatchResult</span></a><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>        </span><a href="DsUtils.html#wrapBind"><span class="hs-identifier hs-var">wrapBind</span></a><span class="hs-special">,</span><span> </span><a href="DsUtils.html#wrapBinds"><span class="hs-identifier hs-var">wrapBinds</span></a><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span>        </span><a href="DsUtils.html#mkErrorAppDs"><span class="hs-identifier hs-var">mkErrorAppDs</span></a><span class="hs-special">,</span><span> </span><a href="DsUtils.html#mkCoreAppDs"><span class="hs-identifier hs-var">mkCoreAppDs</span></a><span class="hs-special">,</span><span> </span><a href="DsUtils.html#mkCoreAppsDs"><span class="hs-identifier hs-var">mkCoreAppsDs</span></a><span class="hs-special">,</span><span> </span><a href="DsUtils.html#mkCastDs"><span class="hs-identifier hs-var">mkCastDs</span></a><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span>        </span><a href="DsUtils.html#seqVar"><span class="hs-identifier hs-var">seqVar</span></a><span class="hs-special">,</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span>        </span><span class="hs-comment">-- LHs tuples</span><span>
</span><a name="line-35"></a><span>        </span><a href="DsUtils.html#mkLHsVarPatTup"><span class="hs-identifier hs-var">mkLHsVarPatTup</span></a><span class="hs-special">,</span><span> </span><a href="DsUtils.html#mkLHsPatTup"><span class="hs-identifier hs-var">mkLHsPatTup</span></a><span class="hs-special">,</span><span> </span><a href="DsUtils.html#mkVanillaTuplePat"><span class="hs-identifier hs-var">mkVanillaTuplePat</span></a><span class="hs-special">,</span><span>
</span><a name="line-36"></a><span>        </span><a href="DsUtils.html#mkBigLHsVarTupId"><span class="hs-identifier hs-var">mkBigLHsVarTupId</span></a><span class="hs-special">,</span><span> </span><a href="DsUtils.html#mkBigLHsTupId"><span class="hs-identifier hs-var">mkBigLHsTupId</span></a><span class="hs-special">,</span><span> </span><a href="DsUtils.html#mkBigLHsVarPatTupId"><span class="hs-identifier hs-var">mkBigLHsVarPatTupId</span></a><span class="hs-special">,</span><span> </span><a href="DsUtils.html#mkBigLHsPatTupId"><span class="hs-identifier hs-var">mkBigLHsPatTupId</span></a><span class="hs-special">,</span><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span>        </span><a href="DsUtils.html#mkSelectorBinds"><span class="hs-identifier hs-var">mkSelectorBinds</span></a><span class="hs-special">,</span><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span>        </span><a href="DsUtils.html#selectSimpleMatchVarL"><span class="hs-identifier hs-var">selectSimpleMatchVarL</span></a><span class="hs-special">,</span><span> </span><a href="DsUtils.html#selectMatchVars"><span class="hs-identifier hs-var">selectMatchVars</span></a><span class="hs-special">,</span><span> </span><a href="DsUtils.html#selectMatchVar"><span class="hs-identifier hs-var">selectMatchVar</span></a><span class="hs-special">,</span><span>
</span><a name="line-41"></a><span>        </span><a href="DsUtils.html#mkOptTickBox"><span class="hs-identifier hs-var">mkOptTickBox</span></a><span class="hs-special">,</span><span> </span><a href="DsUtils.html#mkBinaryTickBox"><span class="hs-identifier hs-var">mkBinaryTickBox</span></a><span class="hs-special">,</span><span> </span><a href="DsUtils.html#decideBangHood"><span class="hs-identifier hs-var">decideBangHood</span></a><span class="hs-special">,</span><span> </span><a href="DsUtils.html#addBang"><span class="hs-identifier hs-var">addBang</span></a><span class="hs-special">,</span><span>
</span><a name="line-42"></a><span>        </span><a href="DsUtils.html#isTrueLHsExpr"><span class="hs-identifier hs-var">isTrueLHsExpr</span></a><span>
</span><a name="line-43"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-44"></a><span>
</span><a name="line-45"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE</span><span> </span><span class="hs-pragma">#-}</span><span> </span><a href="Match.html"><span class="hs-identifier">Match</span></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Match.html#matchSimply"><span class="hs-identifier hs-var">matchSimply</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE</span><span> </span><span class="hs-pragma">#-}</span><span> </span><a href="DsExpr.html"><span class="hs-identifier">DsExpr</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><a href="TcHsSyn.html"><span class="hs-identifier">TcHsSyn</span></a><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">tcSplitTyConApp</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreSyn</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><a href="DsMonad.html"><span class="hs-identifier">DsMonad</span></a><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreUtils</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MkCore</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MkId</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Literal</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PatSyn</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Coercion</span><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysPrim</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysWiredIn</span><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ConLike</span><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSet</span><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSupply</span><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">isInternalName</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-79"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-80"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-81"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-82"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC.LanguageExtensions</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LangExt</span><span>
</span><a name="line-83"></a><span>
</span><a name="line-84"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcEvidence</span><span>
</span><a name="line-85"></a><span>
</span><a name="line-86"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">zipWithM</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{ Selecting match variables}
*                                                                      *
************************************************************************

We're about to match against some patterns.  We want to make some
@Ids@ to use as match variables.  If a pattern has an @Id@ readily at
hand, which should indeed be bound to the pattern as a whole, then use it;
otherwise, make one up.
-}</span><span>
</span><a name="line-100"></a><span>
</span><a name="line-101"></a><span class="hs-identifier">selectSimpleMatchVarL</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-102"></a><span class="hs-comment">-- Postcondition: the returned Id has an Internal Name</span><span>
</span><a name="line-103"></a><a name="selectSimpleMatchVarL"><a href="DsUtils.html#selectSimpleMatchVarL"><span class="hs-identifier">selectSimpleMatchVarL</span></a></a><span> </span><a name="local-6989586621681850033"><a href="#local-6989586621681850033"><span class="hs-identifier">pat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#selectMatchVar"><span class="hs-identifier hs-var">selectMatchVar</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621681850033"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">)</span><span>
</span><a name="line-104"></a><span>
</span><a name="line-105"></a><span class="hs-comment">-- (selectMatchVars ps tys) chooses variables of type tys</span><span>
</span><a name="line-106"></a><span class="hs-comment">-- to use for matching ps against.  If the pattern is a variable,</span><span>
</span><a name="line-107"></a><span class="hs-comment">-- we try to use that, to save inventing lots of fresh variables.</span><span>
</span><a name="line-108"></a><span class="hs-comment">--</span><span>
</span><a name="line-109"></a><span class="hs-comment">-- OLD, but interesting note:</span><span>
</span><a name="line-110"></a><span class="hs-comment">--    But even if it is a variable, its type might not match.  Consider</span><span>
</span><a name="line-111"></a><span class="hs-comment">--      data T a where</span><span>
</span><a name="line-112"></a><span class="hs-comment">--        T1 :: Int -&gt; T Int</span><span>
</span><a name="line-113"></a><span class="hs-comment">--        T2 :: a   -&gt; T a</span><span>
</span><a name="line-114"></a><span class="hs-comment">--</span><span>
</span><a name="line-115"></a><span class="hs-comment">--      f :: T a -&gt; a -&gt; Int</span><span>
</span><a name="line-116"></a><span class="hs-comment">--      f (T1 i) (x::Int) = x</span><span>
</span><a name="line-117"></a><span class="hs-comment">--      f (T2 i) (y::a)   = 0</span><span>
</span><a name="line-118"></a><span class="hs-comment">--    Then we must not choose (x::Int) as the matching variable!</span><span>
</span><a name="line-119"></a><span class="hs-comment">-- And nowadays we won't, because the (x::Int) will be wrapped in a CoPat</span><span>
</span><a name="line-120"></a><span>
</span><a name="line-121"></a><span class="hs-identifier">selectMatchVars</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Pat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>
</span><a name="line-122"></a><span class="hs-comment">-- Postcondition: the returned Ids have Internal Names</span><span>
</span><a name="line-123"></a><a name="selectMatchVars"><a href="DsUtils.html#selectMatchVars"><span class="hs-identifier">selectMatchVars</span></a></a><span> </span><a name="local-6989586621681850034"><a href="#local-6989586621681850034"><span class="hs-identifier">ps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="DsUtils.html#selectMatchVar"><span class="hs-identifier hs-var">selectMatchVar</span></a><span> </span><a href="#local-6989586621681850034"><span class="hs-identifier hs-var">ps</span></a><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a><span class="hs-identifier">selectMatchVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Pat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-126"></a><span class="hs-comment">-- Postcondition: the returned Id has an Internal Name</span><span>
</span><a name="line-127"></a><a name="selectMatchVar"><a href="DsUtils.html#selectMatchVar"><span class="hs-identifier">selectMatchVar</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BangPat</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681850035"><a href="#local-6989586621681850035"><span class="hs-identifier">pat</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#selectMatchVar"><span class="hs-identifier hs-var">selectMatchVar</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621681850035"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">)</span><span>
</span><a name="line-128"></a><span class="hs-identifier">selectMatchVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LazyPat</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681850036"><a href="#local-6989586621681850036"><span class="hs-identifier">pat</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#selectMatchVar"><span class="hs-identifier hs-var">selectMatchVar</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621681850036"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">)</span><span>
</span><a name="line-129"></a><span class="hs-identifier">selectMatchVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParPat</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681850037"><a href="#local-6989586621681850037"><span class="hs-identifier">pat</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#selectMatchVar"><span class="hs-identifier hs-var">selectMatchVar</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621681850037"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">)</span><span>
</span><a name="line-130"></a><span class="hs-identifier">selectMatchVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarPat</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681850038"><a href="#local-6989586621681850038"><span class="hs-identifier">var</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">localiseId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621681850038"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-131"></a><span>                                  </span><span class="hs-comment">-- Note [Localise pattern binders]</span><span>
</span><a name="line-132"></a><span class="hs-identifier">selectMatchVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AsPat</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681850039"><a href="#local-6989586621681850039"><span class="hs-identifier">var</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621681850039"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span>
</span><a name="line-133"></a><span class="hs-identifier">selectMatchVar</span><span> </span><a name="local-6989586621681850040"><a href="#local-6989586621681850040"><span class="hs-identifier">other_pat</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#newSysLocalDsNoLP"><span class="hs-identifier hs-var">newSysLocalDsNoLP</span></a><span> </span><span class="hs-special">(</span><a href="TcHsSyn.html#hsPatType"><span class="hs-identifier hs-var">hsPatType</span></a><span> </span><a href="#local-6989586621681850040"><span class="hs-identifier hs-var">other_pat</span></a><span class="hs-special">)</span><span>
</span><a name="line-134"></a><span>                                  </span><span class="hs-comment">-- OK, better make up one...</span><span>
</span><a name="line-135"></a><span>
</span><a name="line-136"></a><span class="hs-comment">{- Note [Localise pattern binders]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider     module M where
               [Just a] = e
After renaming it looks like
             module M where
               [Just M.a] = e

We don't generalise, since it's a pattern binding, monomorphic, etc,
so after desugaring we may get something like
             M.a = case e of (v:_) -&gt;
                   case v of Just M.a -&gt; M.a
Notice the &quot;M.a&quot; in the pattern; after all, it was in the original
pattern.  However, after optimisation those pattern binders can become
let-binders, and then end up floated to top level.  They have a
different *unique* by then (the simplifier is good about maintaining
proper scoping), but it's BAD to have two top-level bindings with the
External Name M.a, because that turns into two linker symbols for M.a.
It's quite rare for this to actually *happen* -- the only case I know
of is tc003 compiled with the 'hpc' way -- but that only makes it
all the more annoying.

To avoid this, we craftily call 'localiseId' in the desugarer, which
simply turns the External Name for the Id into an Internal one, but
doesn't change the unique.  So the desugarer produces this:
             M.a{r8} = case e of (v:_) -&gt;
                       case v of Just a{r8} -&gt; M.a{r8}
The unique is still 'r8', but the binding site in the pattern
is now an Internal Name.  Now the simplifier's usual mechanisms
will propagate that Name to all the occurrence sites, as well as
un-shadowing it, so we'll get
             M.a{r8} = case e of (v:_) -&gt;
                       case v of Just a{s77} -&gt; a{s77}
In fact, even CoreSubst.simplOptExpr will do this, and simpleOptExpr
runs on the output of the desugarer, so all is well by the end of
the desugaring pass.

See also Note [MatchIds] in Match.hs

************************************************************************
*                                                                      *
* type synonym EquationInfo and access functions for its pieces        *
*                                                                      *
************************************************************************
\subsection[EquationInfo-synonym]{@EquationInfo@: a useful synonym}

The ``equation info'' used by @match@ is relatively complicated and
worthy of a type synonym and a few handy functions.
-}</span><span>
</span><a name="line-185"></a><span>
</span><a name="line-186"></a><span class="hs-identifier">firstPat</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Pat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-187"></a><a name="firstPat"><a href="DsUtils.html#firstPat"><span class="hs-identifier">firstPat</span></a></a><span> </span><a name="local-6989586621681850041"><a href="#local-6989586621681850041"><span class="hs-identifier">eqn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">notNull</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">eqn_pats</span><span> </span><span class="hs-identifier hs-var">eqn</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">head</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">eqn_pats</span><span> </span><span class="hs-identifier">eqn</span><span class="hs-special">)</span><span>
</span><a name="line-188"></a><span>
</span><a name="line-189"></a><span class="hs-identifier">shiftEqns</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="DsMonad.html#EquationInfo"><span class="hs-identifier hs-type">EquationInfo</span></a><span class="hs-special">]</span><span>
</span><a name="line-190"></a><span class="hs-comment">-- Drop the first pattern in each equation</span><span>
</span><a name="line-191"></a><a name="shiftEqns"><a href="DsUtils.html#shiftEqns"><span class="hs-identifier">shiftEqns</span></a></a><span> </span><a name="local-6989586621681850042"><a href="#local-6989586621681850042"><span class="hs-identifier">eqns</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621681850043"><span class="hs-identifier hs-var">eqn</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">eqn_pats</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tail</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">eqn_pats</span><span> </span><a href="#local-6989586621681850043"><span class="hs-identifier hs-var">eqn</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681850043"><a href="#local-6989586621681850043"><span class="hs-identifier">eqn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681850042"><span class="hs-identifier hs-var">eqns</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span class="hs-comment">-- Functions on MatchResults</span><span>
</span><a name="line-194"></a><span>
</span><a name="line-195"></a><span class="hs-identifier">matchCanFail</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-196"></a><a name="matchCanFail"><a href="DsUtils.html#matchCanFail"><span class="hs-identifier">matchCanFail</span></a></a><span> </span><span class="hs-special">(</span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-var">MatchResult</span></a><span> </span><a href="DsMonad.html#CanFail"><span class="hs-identifier hs-var">CanFail</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-197"></a><span class="hs-identifier">matchCanFail</span><span> </span><span class="hs-special">(</span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-var">MatchResult</span></a><span> </span><a href="DsMonad.html#CantFail"><span class="hs-identifier hs-var">CantFail</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-198"></a><span>
</span><a name="line-199"></a><span class="hs-identifier">alwaysFailMatchResult</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span>
</span><a name="line-200"></a><a name="alwaysFailMatchResult"><a href="DsUtils.html#alwaysFailMatchResult"><span class="hs-identifier">alwaysFailMatchResult</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-var">MatchResult</span></a><span> </span><a href="DsMonad.html#CanFail"><span class="hs-identifier hs-var">CanFail</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681850044"><a href="#local-6989586621681850044"><span class="hs-identifier">fail</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681850044"><span class="hs-identifier hs-var">fail</span></a><span class="hs-special">)</span><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span class="hs-identifier">cantFailMatchResult</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span>
</span><a name="line-203"></a><a name="cantFailMatchResult"><a href="DsUtils.html#cantFailMatchResult"><span class="hs-identifier">cantFailMatchResult</span></a></a><span> </span><a name="local-6989586621681850045"><a href="#local-6989586621681850045"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-var">MatchResult</span></a><span> </span><a href="DsMonad.html#CantFail"><span class="hs-identifier hs-var">CantFail</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681850045"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-204"></a><span>
</span><a name="line-205"></a><span class="hs-identifier">extractMatchResult</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-206"></a><a name="extractMatchResult"><a href="DsUtils.html#extractMatchResult"><span class="hs-identifier">extractMatchResult</span></a></a><span> </span><span class="hs-special">(</span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-var">MatchResult</span></a><span> </span><a href="DsMonad.html#CantFail"><span class="hs-identifier hs-var">CantFail</span></a><span> </span><a name="local-6989586621681850046"><a href="#local-6989586621681850046"><span class="hs-identifier">match_fn</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-207"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681850046"><span class="hs-identifier hs-var">match_fn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;It can't fail!&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-208"></a><span>
</span><a name="line-209"></a><span class="hs-identifier">extractMatchResult</span><span> </span><span class="hs-special">(</span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-var">MatchResult</span></a><span> </span><a href="DsMonad.html#CanFail"><span class="hs-identifier hs-var">CanFail</span></a><span> </span><a name="local-6989586621681850047"><a href="#local-6989586621681850047"><span class="hs-identifier">match_fn</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681850048"><a href="#local-6989586621681850048"><span class="hs-identifier">fail_expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-210"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621681850049"><a href="#local-6989586621681850049"><span class="hs-identifier">fail_bind</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681850050"><a href="#local-6989586621681850050"><span class="hs-identifier">if_it_fails</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsUtils.html#mkFailurePair"><span class="hs-identifier hs-var">mkFailurePair</span></a><span> </span><a href="#local-6989586621681850048"><span class="hs-identifier hs-var">fail_expr</span></a><span>
</span><a name="line-211"></a><span>    </span><a name="local-6989586621681850051"><a href="#local-6989586621681850051"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681850047"><span class="hs-identifier hs-var">match_fn</span></a><span> </span><a href="#local-6989586621681850050"><span class="hs-identifier hs-var">if_it_fails</span></a><span>
</span><a name="line-212"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCoreLet</span><span> </span><a href="#local-6989586621681850049"><span class="hs-identifier hs-var">fail_bind</span></a><span> </span><a href="#local-6989586621681850051"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-213"></a><span>
</span><a name="line-214"></a><span>
</span><a name="line-215"></a><span class="hs-identifier">combineMatchResults</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span>
</span><a name="line-216"></a><a name="combineMatchResults"><a href="DsUtils.html#combineMatchResults"><span class="hs-identifier">combineMatchResults</span></a></a><span> </span><span class="hs-special">(</span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-var">MatchResult</span></a><span> </span><a href="DsMonad.html#CanFail"><span class="hs-identifier hs-var">CanFail</span></a><span>      </span><a name="local-6989586621681850052"><a href="#local-6989586621681850052"><span class="hs-identifier">body_fn1</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-217"></a><span>                    </span><span class="hs-special">(</span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-var">MatchResult</span></a><span> </span><a name="local-6989586621681850053"><a href="#local-6989586621681850053"><span class="hs-identifier">can_it_fail2</span></a></a><span> </span><a name="local-6989586621681850054"><a href="#local-6989586621681850054"><span class="hs-identifier">body_fn2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-218"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-var">MatchResult</span></a><span> </span><a href="#local-6989586621681850053"><span class="hs-identifier hs-var">can_it_fail2</span></a><span> </span><a href="#local-6989586621681850055"><span class="hs-identifier hs-var">body_fn</span></a><span>
</span><a name="line-219"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-220"></a><span>    </span><a name="local-6989586621681850055"><a href="#local-6989586621681850055"><span class="hs-identifier">body_fn</span></a></a><span> </span><a name="local-6989586621681850056"><a href="#local-6989586621681850056"><span class="hs-identifier">fail</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681850057"><a href="#local-6989586621681850057"><span class="hs-identifier">body2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681850054"><span class="hs-identifier hs-var">body_fn2</span></a><span> </span><a href="#local-6989586621681850056"><span class="hs-identifier hs-var">fail</span></a><span>
</span><a name="line-221"></a><span>                      </span><span class="hs-special">(</span><a name="local-6989586621681850058"><a href="#local-6989586621681850058"><span class="hs-identifier">fail_bind</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681850059"><a href="#local-6989586621681850059"><span class="hs-identifier">duplicatable_expr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsUtils.html#mkFailurePair"><span class="hs-identifier hs-var">mkFailurePair</span></a><span> </span><a href="#local-6989586621681850057"><span class="hs-identifier hs-var">body2</span></a><span>
</span><a name="line-222"></a><span>                      </span><a name="local-6989586621681850060"><a href="#local-6989586621681850060"><span class="hs-identifier">body1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681850052"><span class="hs-identifier hs-var">body_fn1</span></a><span> </span><a href="#local-6989586621681850059"><span class="hs-identifier hs-var">duplicatable_expr</span></a><span>
</span><a name="line-223"></a><span>                      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Let</span><span> </span><a href="#local-6989586621681850058"><span class="hs-identifier hs-var">fail_bind</span></a><span> </span><a href="#local-6989586621681850060"><span class="hs-identifier hs-var">body1</span></a><span class="hs-special">)</span><span>
</span><a name="line-224"></a><span>
</span><a name="line-225"></a><span class="hs-identifier">combineMatchResults</span><span> </span><a name="local-6989586621681850061"><a href="#local-6989586621681850061"><span class="hs-identifier">match_result1</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-var">MatchResult</span></a><span> </span><a href="DsMonad.html#CantFail"><span class="hs-identifier hs-var">CantFail</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-226"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681850061"><span class="hs-identifier hs-var">match_result1</span></a><span>
</span><a name="line-227"></a><span>
</span><a name="line-228"></a><span class="hs-identifier">adjustMatchResult</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DsMonad.html#DsWrapper"><span class="hs-identifier hs-type">DsWrapper</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span>
</span><a name="line-229"></a><a name="adjustMatchResult"><a href="DsUtils.html#adjustMatchResult"><span class="hs-identifier">adjustMatchResult</span></a></a><span> </span><a name="local-6989586621681850062"><a href="#local-6989586621681850062"><span class="hs-identifier">encl_fn</span></a></a><span> </span><span class="hs-special">(</span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-var">MatchResult</span></a><span> </span><a name="local-6989586621681850063"><a href="#local-6989586621681850063"><span class="hs-identifier">can_it_fail</span></a></a><span> </span><a name="local-6989586621681850064"><a href="#local-6989586621681850064"><span class="hs-identifier">body_fn</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-230"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-var">MatchResult</span></a><span> </span><a href="#local-6989586621681850063"><span class="hs-identifier hs-var">can_it_fail</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681850065"><a href="#local-6989586621681850065"><span class="hs-identifier">fail</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681850062"><span class="hs-identifier hs-var">encl_fn</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621681850064"><span class="hs-identifier hs-var">body_fn</span></a><span> </span><a href="#local-6989586621681850065"><span class="hs-identifier hs-var">fail</span></a><span class="hs-special">)</span><span>
</span><a name="line-231"></a><span>
</span><a name="line-232"></a><span class="hs-identifier">adjustMatchResultDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span>
</span><a name="line-233"></a><a name="adjustMatchResultDs"><a href="DsUtils.html#adjustMatchResultDs"><span class="hs-identifier">adjustMatchResultDs</span></a></a><span> </span><a name="local-6989586621681850066"><a href="#local-6989586621681850066"><span class="hs-identifier">encl_fn</span></a></a><span> </span><span class="hs-special">(</span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-var">MatchResult</span></a><span> </span><a name="local-6989586621681850067"><a href="#local-6989586621681850067"><span class="hs-identifier">can_it_fail</span></a></a><span> </span><a name="local-6989586621681850068"><a href="#local-6989586621681850068"><span class="hs-identifier">body_fn</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-234"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-var">MatchResult</span></a><span> </span><a href="#local-6989586621681850067"><span class="hs-identifier hs-var">can_it_fail</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681850069"><a href="#local-6989586621681850069"><span class="hs-identifier">fail</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681850066"><span class="hs-identifier hs-var">encl_fn</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="#local-6989586621681850068"><span class="hs-identifier hs-var">body_fn</span></a><span> </span><a href="#local-6989586621681850069"><span class="hs-identifier hs-var">fail</span></a><span class="hs-special">)</span><span>
</span><a name="line-235"></a><span>
</span><a name="line-236"></a><span class="hs-identifier">wrapBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Var</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Var</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-237"></a><a name="wrapBinds"><a href="DsUtils.html#wrapBinds"><span class="hs-identifier">wrapBinds</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621681850070"><a href="#local-6989586621681850070"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681850070"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-238"></a><span class="hs-identifier">wrapBinds</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621681850071"><a href="#local-6989586621681850071"><span class="hs-identifier">new</span></a></a><span class="hs-special">,</span><a name="local-6989586621681850072"><a href="#local-6989586621681850072"><span class="hs-identifier">old</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621681850073"><a href="#local-6989586621681850073"><span class="hs-identifier">prs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681850074"><a href="#local-6989586621681850074"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#wrapBind"><span class="hs-identifier hs-var">wrapBind</span></a><span> </span><a href="#local-6989586621681850071"><span class="hs-identifier hs-var">new</span></a><span> </span><a href="#local-6989586621681850072"><span class="hs-identifier hs-var">old</span></a><span> </span><span class="hs-special">(</span><a href="DsUtils.html#wrapBinds"><span class="hs-identifier hs-var">wrapBinds</span></a><span> </span><a href="#local-6989586621681850073"><span class="hs-identifier hs-var">prs</span></a><span> </span><a href="#local-6989586621681850074"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-239"></a><span>
</span><a name="line-240"></a><span class="hs-identifier">wrapBind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Var</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Var</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-241"></a><a name="wrapBind"><a href="DsUtils.html#wrapBind"><span class="hs-identifier">wrapBind</span></a></a><span> </span><a name="local-6989586621681850075"><a href="#local-6989586621681850075"><span class="hs-identifier">new</span></a></a><span> </span><a name="local-6989586621681850076"><a href="#local-6989586621681850076"><span class="hs-identifier">old</span></a></a><span> </span><a name="local-6989586621681850077"><a href="#local-6989586621681850077"><span class="hs-identifier">body</span></a></a><span>   </span><span class="hs-comment">-- NB: this function must deal with term</span><span>
</span><a name="line-242"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681850075"><span class="hs-identifier hs-var">new</span></a><span class="hs-operator hs-var">==</span><a href="#local-6989586621681850076"><span class="hs-identifier hs-var">old</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681850077"><span class="hs-identifier hs-var">body</span></a><span>  </span><span class="hs-comment">-- variables, type variables or coercion variables</span><span>
</span><a name="line-243"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621681850075"><span class="hs-identifier hs-var">new</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varToCoreExpr</span><span> </span><a href="#local-6989586621681850076"><span class="hs-identifier hs-var">old</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681850077"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-244"></a><span>
</span><a name="line-245"></a><span class="hs-identifier">seqVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Var</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-246"></a><a name="seqVar"><a href="DsUtils.html#seqVar"><span class="hs-identifier">seqVar</span></a></a><span> </span><a name="local-6989586621681850078"><a href="#local-6989586621681850078"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621681850079"><a href="#local-6989586621681850079"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621681850078"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681850078"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprType</span><span> </span><a href="#local-6989586621681850079"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-247"></a><span>                        </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DEFAULT</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681850079"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-248"></a><span>
</span><a name="line-249"></a><span class="hs-identifier">mkCoLetMatchResult</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreBind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span>
</span><a name="line-250"></a><a name="mkCoLetMatchResult"><a href="DsUtils.html#mkCoLetMatchResult"><span class="hs-identifier">mkCoLetMatchResult</span></a></a><span> </span><a name="local-6989586621681850080"><a href="#local-6989586621681850080"><span class="hs-identifier">bind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#adjustMatchResult"><span class="hs-identifier hs-var">adjustMatchResult</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCoreLet</span><span> </span><a href="#local-6989586621681850080"><span class="hs-identifier hs-var">bind</span></a><span class="hs-special">)</span><span>
</span><a name="line-251"></a><span>
</span><a name="line-252"></a><span class="hs-comment">-- (mkViewMatchResult var' viewExpr mr) makes the expression</span><span>
</span><a name="line-253"></a><span class="hs-comment">-- let var' = viewExpr in mr</span><span>
</span><a name="line-254"></a><span class="hs-identifier">mkViewMatchResult</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span>
</span><a name="line-255"></a><a name="mkViewMatchResult"><a href="DsUtils.html#mkViewMatchResult"><span class="hs-identifier">mkViewMatchResult</span></a></a><span> </span><a name="local-6989586621681850081"><a href="#local-6989586621681850081"><span class="hs-identifier">var'</span></a></a><span> </span><a name="local-6989586621681850082"><a href="#local-6989586621681850082"><span class="hs-identifier">viewExpr</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-256"></a><span>    </span><a href="DsUtils.html#adjustMatchResult"><span class="hs-identifier hs-var">adjustMatchResult</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCoreLet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621681850081"><span class="hs-identifier hs-var">var'</span></a><span> </span><a href="#local-6989586621681850082"><span class="hs-identifier hs-var">viewExpr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-257"></a><span>
</span><a name="line-258"></a><span class="hs-identifier">mkEvalMatchResult</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span>
</span><a name="line-259"></a><a name="mkEvalMatchResult"><a href="DsUtils.html#mkEvalMatchResult"><span class="hs-identifier">mkEvalMatchResult</span></a></a><span> </span><a name="local-6989586621681850083"><a href="#local-6989586621681850083"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621681850084"><a href="#local-6989586621681850084"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-260"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#adjustMatchResult"><span class="hs-identifier hs-var">adjustMatchResult</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681850085"><a href="#local-6989586621681850085"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621681850083"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681850083"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621681850084"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DEFAULT</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681850085"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-261"></a><span>
</span><a name="line-262"></a><span class="hs-identifier">mkGuardedMatchResult</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span>
</span><a name="line-263"></a><a name="mkGuardedMatchResult"><a href="DsUtils.html#mkGuardedMatchResult"><span class="hs-identifier">mkGuardedMatchResult</span></a></a><span> </span><a name="local-6989586621681850086"><a href="#local-6989586621681850086"><span class="hs-identifier">pred_expr</span></a></a><span> </span><span class="hs-special">(</span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-var">MatchResult</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681850087"><a href="#local-6989586621681850087"><span class="hs-identifier">body_fn</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-264"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-var">MatchResult</span></a><span> </span><a href="DsMonad.html#CanFail"><span class="hs-identifier hs-var">CanFail</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681850088"><a href="#local-6989586621681850088"><span class="hs-identifier">fail</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681850089"><a href="#local-6989586621681850089"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681850087"><span class="hs-identifier hs-var">body_fn</span></a><span> </span><a href="#local-6989586621681850088"><span class="hs-identifier hs-var">fail</span></a><span>
</span><a name="line-265"></a><span>                                     </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkIfThenElse</span><span> </span><a href="#local-6989586621681850086"><span class="hs-identifier hs-var">pred_expr</span></a><span> </span><a href="#local-6989586621681850089"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621681850088"><span class="hs-identifier hs-var">fail</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-266"></a><span>
</span><a name="line-267"></a><span class="hs-identifier">mkCoPrimCaseMatchResult</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span>                  </span><span class="hs-comment">-- Scrutinee</span><span>
</span><a name="line-268"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>                      </span><span class="hs-comment">-- Type of the case</span><span>
</span><a name="line-269"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Literal</span><span class="hs-special">,</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Alternatives</span><span>
</span><a name="line-270"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span>               </span><span class="hs-comment">-- Literals are all unlifted</span><span>
</span><a name="line-271"></a><a name="mkCoPrimCaseMatchResult"><a href="DsUtils.html#mkCoPrimCaseMatchResult"><span class="hs-identifier">mkCoPrimCaseMatchResult</span></a></a><span> </span><a name="local-6989586621681850090"><a href="#local-6989586621681850090"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621681850091"><a href="#local-6989586621681850091"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621681850092"><a href="#local-6989586621681850092"><span class="hs-identifier">match_alts</span></a></a><span>
</span><a name="line-272"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-var">MatchResult</span></a><span> </span><a href="DsMonad.html#CanFail"><span class="hs-identifier hs-var">CanFail</span></a><span> </span><a href="#local-6989586621681850093"><span class="hs-identifier hs-var">mk_case</span></a><span>
</span><a name="line-273"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-274"></a><span>    </span><a name="local-6989586621681850093"><a href="#local-6989586621681850093"><span class="hs-identifier">mk_case</span></a></a><span> </span><a name="local-6989586621681850096"><a href="#local-6989586621681850096"><span class="hs-identifier">fail</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-275"></a><span>        </span><a name="local-6989586621681850097"><a href="#local-6989586621681850097"><span class="hs-identifier">alts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681850095"><span class="hs-identifier hs-var">mk_alt</span></a><span> </span><a href="#local-6989586621681850096"><span class="hs-identifier hs-var">fail</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681850094"><span class="hs-identifier hs-var">sorted_alts</span></a><span>
</span><a name="line-276"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621681850090"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681850090"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621681850091"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DEFAULT</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681850096"><span class="hs-identifier hs-var">fail</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621681850097"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-277"></a><span>
</span><a name="line-278"></a><span>    </span><a name="local-6989586621681850094"><a href="#local-6989586621681850094"><span class="hs-identifier">sorted_alts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortWith</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621681850092"><span class="hs-identifier hs-var">match_alts</span></a><span>       </span><span class="hs-comment">-- Right order for a Case</span><span>
</span><a name="line-279"></a><span>    </span><a name="local-6989586621681850095"><a href="#local-6989586621681850095"><span class="hs-identifier">mk_alt</span></a></a><span> </span><a name="local-6989586621681850098"><a href="#local-6989586621681850098"><span class="hs-identifier">fail</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681850099"><a href="#local-6989586621681850099"><span class="hs-identifier">lit</span></a></a><span class="hs-special">,</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-var">MatchResult</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681850100"><a href="#local-6989586621681850100"><span class="hs-identifier">body_fn</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-280"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">litIsLifted</span><span> </span><span class="hs-identifier">lit</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-281"></a><span>         </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681850101"><a href="#local-6989586621681850101"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681850100"><span class="hs-identifier hs-var">body_fn</span></a><span> </span><a href="#local-6989586621681850098"><span class="hs-identifier hs-var">fail</span></a><span>
</span><a name="line-282"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitAlt</span><span> </span><a href="#local-6989586621681850099"><span class="hs-identifier hs-var">lit</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681850101"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-283"></a><span>
</span><a name="line-284"></a><span class="hs-keyword">data</span><span> </span><a name="CaseAlt"><a href="DsUtils.html#CaseAlt"><span class="hs-identifier">CaseAlt</span></a></a><span> </span><a name="local-6989586621681850027"><a href="#local-6989586621681850027"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="MkCaseAlt"><a href="DsUtils.html#MkCaseAlt"><span class="hs-identifier">MkCaseAlt</span></a></a><span class="hs-special">{</span><span> </span><a name="alt_pat"><a href="DsUtils.html#alt_pat"><span class="hs-identifier">alt_pat</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621681850027"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span>
</span><a name="line-285"></a><span>                            </span><a name="alt_bndrs"><a href="DsUtils.html#alt_bndrs"><span class="hs-identifier">alt_bndrs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Var</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-286"></a><span>                            </span><a name="alt_wrapper"><a href="DsUtils.html#alt_wrapper"><span class="hs-identifier">alt_wrapper</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsWrapper</span><span class="hs-special">,</span><span>
</span><a name="line-287"></a><span>                            </span><a name="alt_result"><a href="DsUtils.html#alt_result"><span class="hs-identifier">alt_result</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-288"></a><span>
</span><a name="line-289"></a><span class="hs-identifier">mkCoAlgCaseMatchResult</span><span>
</span><a name="line-290"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span>                 </span><span class="hs-comment">-- Scrutinee</span><span>
</span><a name="line-291"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>               </span><span class="hs-comment">-- Type of exp</span><span>
</span><a name="line-292"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="DsUtils.html#CaseAlt"><span class="hs-identifier hs-type">CaseAlt</span></a><span> </span><span class="hs-identifier hs-type">DataCon</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Alternatives (bndrs *include* tyvars, dicts)</span><span>
</span><a name="line-293"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span>
</span><a name="line-294"></a><a name="mkCoAlgCaseMatchResult"><a href="DsUtils.html#mkCoAlgCaseMatchResult"><span class="hs-identifier">mkCoAlgCaseMatchResult</span></a></a><span> </span><a name="local-6989586621681850102"><a href="#local-6989586621681850102"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621681850103"><a href="#local-6989586621681850103"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621681850104"><a href="#local-6989586621681850104"><span class="hs-identifier">match_alts</span></a></a><span>
</span><a name="line-295"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681850105"><span class="hs-identifier hs-var">isNewtype</span></a><span>  </span><span class="hs-comment">-- Newtype case; use a let</span><span>
</span><a name="line-296"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tail</span><span> </span><span class="hs-identifier">match_alts</span><span class="hs-special">)</span><span> </span><span class="hs-operator">&amp;&amp;</span><span> </span><a href="#local-6989586621681850104"><span class="hs-identifier hs-var">null</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tail</span><span> </span><span class="hs-identifier">arg_ids1</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-297"></a><span>    </span><a href="DsUtils.html#mkCoLetMatchResult"><span class="hs-identifier hs-var">mkCoLetMatchResult</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621681850109"><span class="hs-identifier hs-var">arg_id1</span></a><span> </span><a href="#local-6989586621681850113"><span class="hs-identifier hs-var">newtype_rhs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681850108"><span class="hs-identifier hs-var">match_result1</span></a><span>
</span><a name="line-298"></a><span>
</span><a name="line-299"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-300"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#mkDataConCase"><span class="hs-identifier hs-var">mkDataConCase</span></a><span> </span><a href="#local-6989586621681850102"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621681850103"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621681850104"><span class="hs-identifier hs-var">match_alts</span></a><span>
</span><a name="line-301"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-302"></a><span>    </span><a name="local-6989586621681850105"><a href="#local-6989586621681850105"><span class="hs-identifier">isNewtype</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isNewTyCon</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConTyCon</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">alt_pat</span><span> </span><a href="#local-6989586621681850106"><span class="hs-identifier hs-var">alt1</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-303"></a><span>
</span><a name="line-304"></a><span>        </span><span class="hs-comment">-- [Interesting: because of GADTs, we can't rely on the type of</span><span>
</span><a name="line-305"></a><span>        </span><span class="hs-comment">--  the scrutinised Id to be sufficiently refined to have a TyCon in it]</span><span>
</span><a name="line-306"></a><span>
</span><a name="line-307"></a><span>    </span><a name="local-6989586621681850106"><a href="#local-6989586621681850106"><span class="hs-identifier">alt1</span></a></a><span class="hs-glyph">@</span><a href="DsUtils.html#MkCaseAlt"><span class="hs-identifier hs-var">MkCaseAlt</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">alt_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681850107"><a href="#local-6989586621681850107"><span class="hs-identifier">arg_ids1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">alt_result</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681850108"><a href="#local-6989586621681850108"><span class="hs-identifier">match_result1</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-308"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">notNull</span><span> </span><span class="hs-identifier">match_alts</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">head</span><span> </span><span class="hs-identifier">match_alts</span><span>
</span><a name="line-309"></a><span>    </span><span class="hs-comment">-- Stuff for newtype</span><span>
</span><a name="line-310"></a><span>    </span><a name="local-6989586621681850109"><a href="#local-6989586621681850109"><span class="hs-identifier">arg_id1</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">notNull</span><span> </span><span class="hs-identifier">arg_ids1</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">head</span><span> </span><span class="hs-identifier">arg_ids1</span><span>
</span><a name="line-311"></a><span>    </span><a name="local-6989586621681850110"><a href="#local-6989586621681850110"><span class="hs-identifier">var_ty</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621681850102"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-312"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621681850111"><a href="#local-6989586621681850111"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681850112"><a href="#local-6989586621681850112"><span class="hs-identifier">ty_args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitTyConApp</span><span> </span><a href="#local-6989586621681850110"><span class="hs-identifier hs-var">var_ty</span></a><span>      </span><span class="hs-comment">-- Don't look through newtypes</span><span>
</span><a name="line-313"></a><span>                                                </span><span class="hs-comment">-- (not that splitTyConApp does, these days)</span><span>
</span><a name="line-314"></a><span>    </span><a name="local-6989586621681850113"><a href="#local-6989586621681850113"><span class="hs-identifier">newtype_rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unwrapNewTypeBody</span><span> </span><a href="#local-6989586621681850111"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621681850112"><span class="hs-identifier hs-var">ty_args</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621681850102"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span>
</span><a name="line-315"></a><span>
</span><a name="line-316"></a><span class="hs-identifier">mkCoSynCaseMatchResult</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsUtils.html#CaseAlt"><span class="hs-identifier hs-type">CaseAlt</span></a><span> </span><span class="hs-identifier hs-type">PatSyn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span>
</span><a name="line-317"></a><a name="mkCoSynCaseMatchResult"><a href="DsUtils.html#mkCoSynCaseMatchResult"><span class="hs-identifier">mkCoSynCaseMatchResult</span></a></a><span> </span><a name="local-6989586621681850114"><a href="#local-6989586621681850114"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621681850115"><a href="#local-6989586621681850115"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621681850116"><a href="#local-6989586621681850116"><span class="hs-identifier">alt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-var">MatchResult</span></a><span> </span><a href="DsMonad.html#CanFail"><span class="hs-identifier hs-var">CanFail</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="DsUtils.html#mkPatSynCase"><span class="hs-identifier hs-var">mkPatSynCase</span></a><span> </span><a href="#local-6989586621681850114"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621681850115"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621681850116"><span class="hs-identifier hs-var">alt</span></a><span>
</span><a name="line-318"></a><span>
</span><a name="line-319"></a><span class="hs-identifier">sort_alts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="DsUtils.html#CaseAlt"><span class="hs-identifier hs-type">CaseAlt</span></a><span> </span><span class="hs-identifier hs-type">DataCon</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="DsUtils.html#CaseAlt"><span class="hs-identifier hs-type">CaseAlt</span></a><span> </span><span class="hs-identifier hs-type">DataCon</span><span class="hs-special">]</span><span>
</span><a name="line-320"></a><a name="sort_alts"><a href="DsUtils.html#sort_alts"><span class="hs-identifier">sort_alts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortWith</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConTag</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">alt_pat</span><span class="hs-special">)</span><span>
</span><a name="line-321"></a><span>
</span><a name="line-322"></a><span class="hs-identifier">mkPatSynCase</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsUtils.html#CaseAlt"><span class="hs-identifier hs-type">CaseAlt</span></a><span> </span><span class="hs-identifier hs-type">PatSyn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-323"></a><a name="mkPatSynCase"><a href="DsUtils.html#mkPatSynCase"><span class="hs-identifier">mkPatSynCase</span></a></a><span> </span><a name="local-6989586621681850117"><a href="#local-6989586621681850117"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621681850118"><a href="#local-6989586621681850118"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621681850119"><a href="#local-6989586621681850119"><span class="hs-identifier">alt</span></a></a><span> </span><a name="local-6989586621681850120"><a href="#local-6989586621681850120"><span class="hs-identifier">fail</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-324"></a><span>    </span><a name="local-6989586621681850129"><a href="#local-6989586621681850129"><span class="hs-identifier">matcher</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkLHsWrap</span><span> </span><a href="#local-6989586621681850123"><span class="hs-identifier hs-var">wrapper</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-325"></a><span>                         </span><span class="hs-identifier hs-var">nlHsTyApp</span><span> </span><a href="#local-6989586621681850125"><span class="hs-identifier hs-var">matcher</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">getRuntimeRep</span><span> </span><a href="#local-6989586621681850118"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681850118"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-326"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-var">MatchResult</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681850130"><a href="#local-6989586621681850130"><span class="hs-identifier">mkCont</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681850124"><span class="hs-identifier hs-var">match_result</span></a><span>
</span><a name="line-327"></a><span>    </span><a name="local-6989586621681850131"><a href="#local-6989586621681850131"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mkCoreLams</span><span> </span><a href="#local-6989586621681850122"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621681850130"><span class="hs-identifier hs-var">mkCont</span></a><span> </span><a href="#local-6989586621681850120"><span class="hs-identifier hs-var">fail</span></a><span>
</span><a name="line-328"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="DsUtils.html#mkCoreAppsDs"><span class="hs-identifier hs-var">mkCoreAppsDs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;patsyn&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681850117"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681850129"><span class="hs-identifier hs-var">matcher</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621681850117"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681850127"><span class="hs-identifier hs-var">ensure_unstrict</span></a><span> </span><a href="#local-6989586621681850131"><span class="hs-identifier hs-var">cont</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Lam</span><span> </span><span class="hs-identifier hs-var">voidArgId</span><span> </span><a href="#local-6989586621681850120"><span class="hs-identifier hs-var">fail</span></a><span class="hs-special">]</span><span>
</span><a name="line-329"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-330"></a><span>    </span><a href="DsUtils.html#MkCaseAlt"><span class="hs-identifier hs-var">MkCaseAlt</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">alt_pat</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681850121"><a href="#local-6989586621681850121"><span class="hs-identifier">psyn</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-331"></a><span>               </span><span class="hs-identifier">alt_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681850122"><a href="#local-6989586621681850122"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-332"></a><span>               </span><span class="hs-identifier">alt_wrapper</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681850123"><a href="#local-6989586621681850123"><span class="hs-identifier">wrapper</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-333"></a><span>               </span><span class="hs-identifier">alt_result</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681850124"><a href="#local-6989586621681850124"><span class="hs-identifier">match_result</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681850119"><span class="hs-identifier hs-var">alt</span></a><span>
</span><a name="line-334"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621681850125"><a href="#local-6989586621681850125"><span class="hs-identifier">matcher</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681850126"><a href="#local-6989586621681850126"><span class="hs-identifier">needs_void_lam</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">patSynMatcher</span><span> </span><a href="#local-6989586621681850121"><span class="hs-identifier hs-var">psyn</span></a><span>
</span><a name="line-335"></a><span>
</span><a name="line-336"></a><span>    </span><span class="hs-comment">-- See Note [Matchers and builders for pattern synonyms] in PatSyns</span><span>
</span><a name="line-337"></a><span>    </span><span class="hs-comment">-- on these extra Void# arguments</span><span>
</span><a name="line-338"></a><span>    </span><a name="local-6989586621681850127"><a href="#local-6989586621681850127"><span class="hs-identifier">ensure_unstrict</span></a></a><span> </span><a name="local-6989586621681850128"><a href="#local-6989586621681850128"><span class="hs-identifier">cont</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681850126"><span class="hs-identifier hs-var">needs_void_lam</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Lam</span><span> </span><span class="hs-identifier hs-var">voidArgId</span><span> </span><a href="#local-6989586621681850128"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-339"></a><span>                         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681850128"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-340"></a><span>
</span><a name="line-341"></a><span class="hs-identifier">mkDataConCase</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="DsUtils.html#CaseAlt"><span class="hs-identifier hs-type">CaseAlt</span></a><span> </span><span class="hs-identifier hs-type">DataCon</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span>
</span><a name="line-342"></a><a name="mkDataConCase"><a href="DsUtils.html#mkDataConCase"><span class="hs-identifier">mkDataConCase</span></a></a><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-identifier">_</span><span>  </span><span class="hs-special">[</span><span class="hs-special">]</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;mkDataConCase: no alternatives&quot;</span><span>
</span><a name="line-343"></a><span class="hs-identifier">mkDataConCase</span><span> </span><a name="local-6989586621681850132"><a href="#local-6989586621681850132"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621681850133"><a href="#local-6989586621681850133"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621681850134"><a href="#local-6989586621681850134"><span class="hs-identifier">alts</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621681850135"><a href="#local-6989586621681850135"><span class="hs-identifier">alt1</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-var">MatchResult</span></a><span> </span><a href="#local-6989586621681850146"><span class="hs-identifier hs-var">fail_flag</span></a><span> </span><a href="#local-6989586621681850143"><span class="hs-identifier hs-var">mk_case</span></a><span>
</span><a name="line-344"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-345"></a><span>    </span><a name="local-6989586621681850136"><a href="#local-6989586621681850136"><span class="hs-identifier">con1</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">alt_pat</span><span> </span><a href="#local-6989586621681850135"><span class="hs-identifier hs-var">alt1</span></a><span>
</span><a name="line-346"></a><span>    </span><a name="local-6989586621681850137"><a href="#local-6989586621681850137"><span class="hs-identifier">tycon</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConTyCon</span><span> </span><a href="#local-6989586621681850136"><span class="hs-identifier hs-var">con1</span></a><span>
</span><a name="line-347"></a><span>    </span><a name="local-6989586621681850138"><a href="#local-6989586621681850138"><span class="hs-identifier">data_cons</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConDataCons</span><span> </span><a href="#local-6989586621681850137"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-348"></a><span>    </span><a name="local-6989586621681850139"><a href="#local-6989586621681850139"><span class="hs-identifier">match_results</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">alt_result</span><span> </span><a href="#local-6989586621681850134"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-349"></a><span>
</span><a name="line-350"></a><span>    </span><span class="hs-identifier">sorted_alts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="DsUtils.html#CaseAlt"><span class="hs-identifier hs-type">CaseAlt</span></a><span> </span><span class="hs-identifier hs-type">DataCon</span><span class="hs-special">]</span><span>
</span><a name="line-351"></a><span>    </span><a name="local-6989586621681850140"><a href="#local-6989586621681850140"><span class="hs-identifier">sorted_alts</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#sort_alts"><span class="hs-identifier hs-var">sort_alts</span></a><span> </span><a href="#local-6989586621681850134"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-352"></a><span>
</span><a name="line-353"></a><span>    </span><a name="local-6989586621681850141"><a href="#local-6989586621681850141"><span class="hs-identifier">var_ty</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621681850132"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-354"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681850142"><a href="#local-6989586621681850142"><span class="hs-identifier">ty_args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitTyConApp</span><span> </span><a href="#local-6989586621681850141"><span class="hs-identifier hs-var">var_ty</span></a><span> </span><span class="hs-comment">-- Don't look through newtypes</span><span>
</span><a name="line-355"></a><span>                                          </span><span class="hs-comment">-- (not that splitTyConApp does, these days)</span><span>
</span><a name="line-356"></a><span>
</span><a name="line-357"></a><span>    </span><span class="hs-identifier">mk_case</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-358"></a><span>    </span><a name="local-6989586621681850143"><a href="#local-6989586621681850143"><span class="hs-identifier">mk_case</span></a></a><span> </span><a name="local-6989586621681850150"><a href="#local-6989586621681850150"><span class="hs-identifier">fail</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-359"></a><span>        </span><a name="local-6989586621681850151"><a href="#local-6989586621681850151"><span class="hs-identifier">alts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681850144"><span class="hs-identifier hs-var">mk_alt</span></a><span> </span><a href="#local-6989586621681850150"><span class="hs-identifier hs-var">fail</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681850140"><span class="hs-identifier hs-var">sorted_alts</span></a><span>
</span><a name="line-360"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkWildCase</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621681850132"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621681850132"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681850133"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681850145"><span class="hs-identifier hs-var">mk_default</span></a><span> </span><a href="#local-6989586621681850150"><span class="hs-identifier hs-var">fail</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681850151"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">)</span><span>
</span><a name="line-361"></a><span>
</span><a name="line-362"></a><span>    </span><span class="hs-identifier">mk_alt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsUtils.html#CaseAlt"><span class="hs-identifier hs-type">CaseAlt</span></a><span> </span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreAlt</span><span>
</span><a name="line-363"></a><span>    </span><a name="local-6989586621681850144"><a href="#local-6989586621681850144"><span class="hs-identifier">mk_alt</span></a></a><span> </span><a name="local-6989586621681850152"><a href="#local-6989586621681850152"><span class="hs-identifier">fail</span></a></a><span> </span><a href="DsUtils.html#MkCaseAlt"><span class="hs-identifier hs-var">MkCaseAlt</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">alt_pat</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681850153"><a href="#local-6989586621681850153"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-364"></a><span>                           </span><span class="hs-identifier">alt_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681850154"><a href="#local-6989586621681850154"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-365"></a><span>                           </span><span class="hs-identifier">alt_result</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-var">MatchResult</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681850155"><a href="#local-6989586621681850155"><span class="hs-identifier">body_fn</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-366"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681850156"><a href="#local-6989586621681850156"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681850155"><span class="hs-identifier hs-var">body_fn</span></a><span> </span><a href="#local-6989586621681850152"><span class="hs-identifier hs-var">fail</span></a><span>
</span><a name="line-367"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">dataConBoxer</span><span> </span><a href="#local-6989586621681850153"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-368"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataAlt</span><span> </span><a href="#local-6989586621681850153"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681850154"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681850156"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-369"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DCB</span><span> </span><a name="local-6989586621681850157"><a href="#local-6989586621681850157"><span class="hs-identifier">boxer</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-370"></a><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681850158"><a href="#local-6989586621681850158"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newUniqueSupply"><span class="hs-identifier hs-var">newUniqueSupply</span></a><span>
</span><a name="line-371"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681850159"><a href="#local-6989586621681850159"><span class="hs-identifier">rep_ids</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681850160"><a href="#local-6989586621681850160"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">initUs_</span><span> </span><a href="#local-6989586621681850158"><span class="hs-identifier hs-var">us</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681850157"><span class="hs-identifier hs-var">boxer</span></a><span> </span><a href="#local-6989586621681850142"><span class="hs-identifier hs-var">ty_args</span></a><span> </span><a href="#local-6989586621681850154"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-372"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataAlt</span><span> </span><a href="#local-6989586621681850153"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681850159"><span class="hs-identifier hs-var">rep_ids</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkLets</span><span> </span><a href="#local-6989586621681850160"><span class="hs-identifier hs-var">binds</span></a><span> </span><a href="#local-6989586621681850156"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-373"></a><span>
</span><a name="line-374"></a><span>    </span><span class="hs-identifier">mk_default</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreAlt</span><span class="hs-special">]</span><span>
</span><a name="line-375"></a><span>    </span><a name="local-6989586621681850145"><a href="#local-6989586621681850145"><span class="hs-identifier">mk_default</span></a></a><span> </span><a name="local-6989586621681850161"><a href="#local-6989586621681850161"><span class="hs-identifier">fail</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681850149"><span class="hs-identifier hs-var">exhaustive_case</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-376"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DEFAULT</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681850161"><span class="hs-identifier hs-var">fail</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-377"></a><span>
</span><a name="line-378"></a><span>    </span><span class="hs-identifier">fail_flag</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DsMonad.html#CanItFail"><span class="hs-identifier hs-type">CanItFail</span></a><span>
</span><a name="line-379"></a><span>    </span><a name="local-6989586621681850146"><a href="#local-6989586621681850146"><span class="hs-identifier">fail_flag</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681850149"><span class="hs-identifier hs-var">exhaustive_case</span></a><span>
</span><a name="line-380"></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="DsMonad.html#orFail"><span class="hs-identifier hs-var">orFail</span></a><span> </span><a href="DsMonad.html#CantFail"><span class="hs-identifier hs-var">CantFail</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621681850162"><span class="hs-identifier hs-var">can_it_fail</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-var">MatchResult</span></a><span> </span><a name="local-6989586621681850162"><a href="#local-6989586621681850162"><span class="hs-identifier">can_it_fail</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681850139"><span class="hs-identifier hs-var">match_results</span></a><span class="hs-special">]</span><span>
</span><a name="line-381"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-382"></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#CanFail"><span class="hs-identifier hs-var">CanFail</span></a><span>
</span><a name="line-383"></a><span>
</span><a name="line-384"></a><span>    </span><a name="local-6989586621681850147"><a href="#local-6989586621681850147"><span class="hs-identifier">mentioned_constructors</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkUniqSet</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">alt_pat</span><span> </span><a href="#local-6989586621681850134"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-385"></a><span>    </span><a name="local-6989586621681850148"><a href="#local-6989586621681850148"><span class="hs-identifier">un_mentioned_constructors</span></a></a><span>
</span><a name="line-386"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkUniqSet</span><span> </span><a href="#local-6989586621681850138"><span class="hs-identifier hs-var">data_cons</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">minusUniqSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681850147"><span class="hs-identifier hs-var">mentioned_constructors</span></a><span>
</span><a name="line-387"></a><span>    </span><a name="local-6989586621681850149"><a href="#local-6989586621681850149"><span class="hs-identifier">exhaustive_case</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isEmptyUniqSet</span><span> </span><a href="#local-6989586621681850148"><span class="hs-identifier hs-var">un_mentioned_constructors</span></a><span>
</span><a name="line-388"></a><span>
</span><a name="line-389"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Desugarer's versions of some Core functions}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-396"></a><span>
</span><a name="line-397"></a><span class="hs-identifier">mkErrorAppDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span>              </span><span class="hs-comment">-- The error function</span><span>
</span><a name="line-398"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>            </span><span class="hs-comment">-- Type to which it should be applied</span><span>
</span><a name="line-399"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>            </span><span class="hs-comment">-- The error message string to pass</span><span>
</span><a name="line-400"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-401"></a><span>
</span><a name="line-402"></a><a name="mkErrorAppDs"><a href="DsUtils.html#mkErrorAppDs"><span class="hs-identifier">mkErrorAppDs</span></a></a><span> </span><a name="local-6989586621681850163"><a href="#local-6989586621681850163"><span class="hs-identifier">err_id</span></a></a><span> </span><a name="local-6989586621681850164"><a href="#local-6989586621681850164"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621681850165"><a href="#local-6989586621681850165"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-403"></a><span>    </span><a name="local-6989586621681850166"><a href="#local-6989586621681850166"><span class="hs-identifier">src_loc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#getSrcSpanDs"><span class="hs-identifier hs-var">getSrcSpanDs</span></a><span>
</span><a name="line-404"></a><span>    </span><a name="local-6989586621681850167"><a href="#local-6989586621681850167"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-405"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-406"></a><span>        </span><a name="local-6989586621681850168"><a href="#local-6989586621681850168"><span class="hs-identifier">full_msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">showSDoc</span><span> </span><a href="#local-6989586621681850167"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681850166"><span class="hs-identifier hs-var">src_loc</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">vbar</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681850165"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-407"></a><span>        </span><a name="local-6989586621681850169"><a href="#local-6989586621681850169"><span class="hs-identifier">core_msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Lit</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLitString</span><span> </span><a href="#local-6989586621681850168"><span class="hs-identifier hs-var">full_msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-408"></a><span>        </span><span class="hs-comment">-- mkLitString returns a result of type String#</span><span>
</span><a name="line-409"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkApps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621681850163"><span class="hs-identifier hs-var">err_id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Type</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getRuntimeRep</span><span> </span><a href="#local-6989586621681850164"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Type</span><span> </span><a href="#local-6989586621681850164"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681850169"><span class="hs-identifier hs-var">core_msg</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-410"></a><span>
</span><a name="line-411"></a><span class="hs-comment">{-
'mkCoreAppDs' and 'mkCoreAppsDs' hand the special-case desugaring of 'seq'.

Note [Desugaring seq (1)]  cf Trac #1031
~~~~~~~~~~~~~~~~~~~~~~~~~
   f x y = x `seq` (y `seq` (# x,y #))

The [CoreSyn let/app invariant] means that, other things being equal, because
the argument to the outer 'seq' has an unlifted type, we'll use call-by-value thus:

   f x y = case (y `seq` (# x,y #)) of v -&gt; x `seq` v

But that is bad for two reasons:
  (a) we now evaluate y before x, and
  (b) we can't bind v to an unboxed pair

Seq is very, very special!  So we recognise it right here, and desugar to
        case x of _ -&gt; case y of _ -&gt; (# x,y #)

Note [Desugaring seq (2)]  cf Trac #2273
~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   let chp = case b of { True -&gt; fst x; False -&gt; 0 }
   in chp `seq` ...chp...
Here the seq is designed to plug the space leak of retaining (snd x)
for too long.

If we rely on the ordinary inlining of seq, we'll get
   let chp = case b of { True -&gt; fst x; False -&gt; 0 }
   case chp of _ { I# -&gt; ...chp... }

But since chp is cheap, and the case is an alluring contet, we'll
inline chp into the case scrutinee.  Now there is only one use of chp,
so we'll inline a second copy.  Alas, we've now ruined the purpose of
the seq, by re-introducing the space leak:
    case (case b of {True -&gt; fst x; False -&gt; 0}) of
      I# _ -&gt; ...case b of {True -&gt; fst x; False -&gt; 0}...

We can try to avoid doing this by ensuring that the binder-swap in the
case happens, so we get his at an early stage:
   case chp of chp2 { I# -&gt; ...chp2... }
But this is fragile.  The real culprit is the source program.  Perhaps we
should have said explicitly
   let !chp2 = chp in ...chp2...

But that's painful.  So the code here does a little hack to make seq
more robust: a saturated application of 'seq' is turned *directly* into
the case expression, thus:
   x  `seq` e2 ==&gt; case x of x -&gt; e2    -- Note shadowing!
   e1 `seq` e2 ==&gt; case x of _ -&gt; e2

So we desugar our example to:
   let chp = case b of { True -&gt; fst x; False -&gt; 0 }
   case chp of chp { I# -&gt; ...chp... }
And now all is well.

The reason it's a hack is because if you define mySeq=seq, the hack
won't work on mySeq.

Note [Desugaring seq (3)] cf Trac #2409
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The isLocalId ensures that we don't turn
        True `seq` e
into
        case True of True { ... }
which stupidly tries to bind the datacon 'True'.
-}</span><span>
</span><a name="line-478"></a><span>
</span><a name="line-479"></a><span class="hs-comment">-- NB: Make sure the argument is not levity polymorphic</span><span>
</span><a name="line-480"></a><span class="hs-identifier">mkCoreAppDs</span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-481"></a><a name="mkCoreAppDs"><a href="DsUtils.html#mkCoreAppDs"><span class="hs-identifier">mkCoreAppDs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a name="local-6989586621681850170"><a href="#local-6989586621681850170"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">App</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">Type</span><span> </span><a name="local-6989586621681850171"><a href="#local-6989586621681850171"><span class="hs-identifier">ty1</span></a></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">App</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">Type</span><span> </span><a name="local-6989586621681850172"><a href="#local-6989586621681850172"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">App</span><span class="hs-special">`</span><span> </span><a name="local-6989586621681850173"><a href="#local-6989586621681850173"><span class="hs-identifier">arg1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681850174"><a href="#local-6989586621681850174"><span class="hs-identifier">arg2</span></a></a><span>
</span><a name="line-482"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681850170"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">seqIdKey</span><span>            </span><span class="hs-comment">-- Note [Desugaring seq (1), (2)]</span><span>
</span><a name="line-483"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Case</span><span> </span><a href="#local-6989586621681850173"><span class="hs-identifier hs-var">arg1</span></a><span> </span><a href="#local-6989586621681850175"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><a href="#local-6989586621681850172"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DEFAULT</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><a href="#local-6989586621681850174"><span class="hs-identifier hs-var">arg2</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-484"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-485"></a><span>    </span><a name="local-6989586621681850175"><a href="#local-6989586621681850175"><span class="hs-identifier">case_bndr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681850173"><span class="hs-identifier hs-var">arg1</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-486"></a><span>                   </span><span class="hs-identifier hs-var">Var</span><span> </span><a name="local-6989586621681850176"><a href="#local-6989586621681850176"><span class="hs-identifier">v1</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isInternalName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621681850176"><span class="hs-identifier hs-var">v1</span></a><span class="hs-special">)</span><span>
</span><a name="line-487"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681850176"><span class="hs-identifier hs-var">v1</span></a><span>        </span><span class="hs-comment">-- Note [Desugaring seq (2) and (3)]</span><span>
</span><a name="line-488"></a><span>                   </span><span class="hs-identifier">_</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">mkWildValBinder</span><span> </span><a href="#local-6989586621681850171"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-489"></a><span>
</span><a name="line-490"></a><span class="hs-identifier">mkCoreAppDs</span><span> </span><a name="local-6989586621681850177"><a href="#local-6989586621681850177"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621681850178"><a href="#local-6989586621681850178"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621681850179"><a href="#local-6989586621681850179"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkCoreApp</span><span> </span><a href="#local-6989586621681850177"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621681850178"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621681850179"><span class="hs-identifier hs-var">arg</span></a><span>  </span><span class="hs-comment">-- The rest is done in MkCore</span><span>
</span><a name="line-491"></a><span>
</span><a name="line-492"></a><span class="hs-comment">-- NB: No argument can be levity polymorphic</span><span>
</span><a name="line-493"></a><span class="hs-identifier">mkCoreAppsDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-494"></a><a name="mkCoreAppsDs"><a href="DsUtils.html#mkCoreAppsDs"><span class="hs-identifier">mkCoreAppsDs</span></a></a><span> </span><a name="local-6989586621681850180"><a href="#local-6989586621681850180"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621681850181"><a href="#local-6989586621681850181"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621681850182"><a href="#local-6989586621681850182"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><a href="DsUtils.html#mkCoreAppDs"><span class="hs-identifier hs-var">mkCoreAppDs</span></a><span> </span><a href="#local-6989586621681850180"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681850181"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621681850182"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-495"></a><span>
</span><a name="line-496"></a><span class="hs-identifier">mkCastDs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Coercion</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-497"></a><span class="hs-comment">-- We define a desugarer-specific version of CoreUtils.mkCast,</span><span>
</span><a name="line-498"></a><span class="hs-comment">-- because in the immediate output of the desugarer, we can have</span><span>
</span><a name="line-499"></a><span class="hs-comment">-- apparently-mis-matched coercions:  E.g.</span><span>
</span><a name="line-500"></a><span class="hs-comment">--     let a = b</span><span>
</span><a name="line-501"></a><span class="hs-comment">--     in (x :: a) |&gt; (co :: b ~ Int)</span><span>
</span><a name="line-502"></a><span class="hs-comment">-- Lint know about type-bindings for let and does not complain</span><span>
</span><a name="line-503"></a><span class="hs-comment">-- So here we do not make the assertion checks that we make in</span><span>
</span><a name="line-504"></a><span class="hs-comment">-- CoreUtils.mkCast; and we do less peephole optimisation too</span><span>
</span><a name="line-505"></a><a name="mkCastDs"><a href="DsUtils.html#mkCastDs"><span class="hs-identifier">mkCastDs</span></a></a><span> </span><a name="local-6989586621681850183"><a href="#local-6989586621681850183"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621681850184"><a href="#local-6989586621681850184"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isReflCo</span><span> </span><a href="#local-6989586621681850184"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681850183"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-506"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Cast</span><span> </span><a href="#local-6989586621681850183"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621681850184"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-507"></a><span>
</span><a name="line-508"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
               Tuples and selector bindings
*                                                                      *
************************************************************************

This is used in various places to do with lazy patterns.
For each binder $b$ in the pattern, we create a binding:
\begin{verbatim}
    b = case v of pat' -&gt; b'
\end{verbatim}
where @pat'@ is @pat@ with each binder @b@ cloned into @b'@.

ToDo: making these bindings should really depend on whether there's
much work to be done per binding.  If the pattern is complex, it
should be de-mangled once, into a tuple (and then selected from).
Otherwise the demangling can be in-line in the bindings (as here).

Boring!  Boring!  One error message per binder.  The above ToDo is
even more helpful.  Something very similar happens for pattern-bound
expressions.

Note [mkSelectorBinds]
~~~~~~~~~~~~~~~~~~~~~~
mkSelectorBinds is used to desugar a pattern binding {p = e},
in a binding group:
  let { ...; p = e; ... } in body
where p binds x,y (this list of binders can be empty).
There are two cases.

------ Special case (A) -------
  For a pattern that is just a variable,
     let !x = e in body
  ==&gt;
     let x = e in x `seq` body
  So we return the binding, with 'x' as the variable to seq.

------ Special case (B) -------
  For a pattern that is essentially just a tuple:
      * A product type, so cannot fail
      * Only one level, so that
          - generating multiple matches is fine
          - seq'ing it evaluates the same as matching it
  Then instead we generate
       { v = e
       ; x = case v of p -&gt; x
       ; y = case v of p -&gt; y }
  with 'v' as the variable to force

------ General case (C) -------
  In the general case we generate these bindings:
       let { ...; p = e; ... } in body
  ==&gt;
       let { t = case e of p -&gt; (x,y)
           ; x = case t of (x,y) -&gt; x
           ; y = case t of (x,y) -&gt; y }
       in t `seq` body

  Note that we return 't' as the variable to force if the pattern
  is strict (i.e. with -XStrict or an outermost-bang-pattern)

  Note that (A) /includes/ the situation where

   * The pattern binds exactly one variable
        let !(Just (Just x) = e in body
     ==&gt;
       let { t = case e of Just (Just v) -&gt; Unit v
           ; v = case t of Unit v -&gt; v }
       in t `seq` body
    The 'Unit' is a one-tuple; see Note [One-tuples] in TysWiredIn
    Note that forcing 't' makes the pattern match happen,
    but does not force 'v'.

  * The pattern binds no variables
        let !(True,False) = e in body
    ==&gt;
        let t = case e of (True,False) -&gt; ()
        in t `seq` body


------ Examples ----------
  *   !(_, (_, a)) = e
    ==&gt;
      t = case e of (_, (_, a)) -&gt; Unit a
      a = case t of Unit a -&gt; a

    Note that
     - Forcing 't' will force the pattern to match fully;
       e.g. will diverge if (snd e) is bottom
     - But 'a' itself is not forced; it is wrapped in a one-tuple
       (see Note [One-tuples] in TysWiredIn)

  *   !(Just x) = e
    ==&gt;
      t = case e of Just x -&gt; Unit x
      x = case t of Unit x -&gt; x

    Again, forcing 't' will fail if 'e' yields Nothing.

Note that even though this is rather general, the special cases
work out well:

* One binder, not -XStrict:

    let Just (Just v) = e in body
  ==&gt;
    let t = case e of Just (Just v) -&gt; Unit v
        v = case t of Unit v -&gt; v
    in body
  ==&gt;
    let v = case (case e of Just (Just v) -&gt; Unit v) of
              Unit v -&gt; v
    in body
  ==&gt;
    let v = case e of Just (Just v) -&gt; v
    in body

* Non-recursive, -XStrict
     let p = e in body
  ==&gt;
     let { t = case e of p -&gt; (x,y)
         ; x = case t of (x,y) -&gt; x
         ; y = case t of (x,y) -&gt; x }
     in t `seq` body
  ==&gt; {inline seq, float x,y bindings inwards}
     let t = case e of p -&gt; (x,y) in
     case t of t' -&gt;
     let { x = case t' of (x,y) -&gt; x
         ; y = case t' of (x,y) -&gt; x } in
     body
  ==&gt; {inline t, do case of case}
     case e of p -&gt;
     let t = (x,y) in
     let { x = case t' of (x,y) -&gt; x
         ; y = case t' of (x,y) -&gt; x } in
     body
  ==&gt; {case-cancellation, drop dead code}
     case e of p -&gt; body

* Special case (B) is there to avoid fruitlessly taking the tuple
  apart and rebuilding it. For example, consider
     { K x y = e }
  where K is a product constructor.  Then general case (A) does:
     { t = case e of K x y -&gt; (x,y)
     ; x = case t of (x,y) -&gt; x
     ; y = case t of (x,y) -&gt; y }
  In the lazy case we can't optimise out this fruitless taking apart
  and rebuilding.  Instead (B) builds
     { v = e
     ; x = case v of K x y -&gt; x
     ; y = case v of K x y -&gt; y }
  which is better.
-}</span><span>
</span><a name="line-662"></a><span>
</span><a name="line-663"></a><span class="hs-identifier">mkSelectorBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Tickish</span><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- ^ ticks to add, possibly</span><span>
</span><a name="line-664"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>     </span><span class="hs-comment">-- ^ The pattern</span><span>
</span><a name="line-665"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>       </span><span class="hs-comment">-- ^ Expression to which the pattern is bound</span><span>
</span><a name="line-666"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-667"></a><span>                </span><span class="hs-comment">-- ^ Id the rhs is bound to, for desugaring strict</span><span>
</span><a name="line-668"></a><span>                </span><span class="hs-comment">-- binds (see Note [Desugar Strict binds] in DsBinds)</span><span>
</span><a name="line-669"></a><span>                </span><span class="hs-comment">-- and all the desugared binds</span><span>
</span><a name="line-670"></a><span>
</span><a name="line-671"></a><a name="mkSelectorBinds"><a href="DsUtils.html#mkSelectorBinds"><span class="hs-identifier">mkSelectorBinds</span></a></a><span> </span><a name="local-6989586621681850185"><a href="#local-6989586621681850185"><span class="hs-identifier">ticks</span></a></a><span> </span><a name="local-6989586621681850186"><a href="#local-6989586621681850186"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621681850187"><a href="#local-6989586621681850187"><span class="hs-identifier">val_expr</span></a></a><span>
</span><a name="line-672"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarPat</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681850194"><a href="#local-6989586621681850194"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681850188"><span class="hs-identifier hs-var">pat'</span></a><span>     </span><span class="hs-comment">-- Special case (A)</span><span>
</span><a name="line-673"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681850194"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621681850194"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681850187"><span class="hs-identifier hs-var">val_expr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-674"></a><span>
</span><a name="line-675"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="DsUtils.html#is_flat_prod_lpat"><span class="hs-identifier hs-var">is_flat_prod_lpat</span></a><span> </span><a href="#local-6989586621681850188"><span class="hs-identifier hs-var">pat'</span></a><span>           </span><span class="hs-comment">-- Special case (B)</span><span>
</span><a name="line-676"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681850195"><a href="#local-6989586621681850195"><span class="hs-identifier">pat_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsSyn.html#hsLPatType"><span class="hs-identifier hs-var">hsLPatType</span></a><span> </span><a href="#local-6989586621681850188"><span class="hs-identifier hs-var">pat'</span></a><span>
</span><a name="line-677"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681850196"><a href="#local-6989586621681850196"><span class="hs-identifier">val_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#newSysLocalDsNoLP"><span class="hs-identifier hs-var">newSysLocalDsNoLP</span></a><span> </span><a href="#local-6989586621681850195"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-678"></a><span>
</span><a name="line-679"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681850197"><a href="#local-6989586621681850197"><span class="hs-identifier">mk_bind</span></a></a><span> </span><a name="local-6989586621681850198"><a href="#local-6989586621681850198"><span class="hs-identifier">tick</span></a></a><span> </span><a name="local-6989586621681850199"><a href="#local-6989586621681850199"><span class="hs-identifier">bndr_var</span></a></a><span>
</span><a name="line-680"></a><span>               </span><span class="hs-comment">-- (mk_bind sv bv)  generates  bv = case sv of { pat -&gt; bv }</span><span>
</span><a name="line-681"></a><span>               </span><span class="hs-comment">-- Remember, 'pat' binds 'bv'</span><span>
</span><a name="line-682"></a><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681850200"><a href="#local-6989586621681850200"><span class="hs-identifier">rhs_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Match.html#matchSimply"><span class="hs-identifier hs-var">matchSimply</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621681850196"><span class="hs-identifier hs-var">val_var</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">PatBindRhs</span><span> </span><a href="#local-6989586621681850188"><span class="hs-identifier hs-var">pat'</span></a><span>
</span><a name="line-683"></a><span>                                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621681850199"><span class="hs-identifier hs-var">bndr_var</span></a><span class="hs-special">)</span><span>
</span><a name="line-684"></a><span>                                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621681850199"><span class="hs-identifier hs-var">bndr_var</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Neat hack</span><span>
</span><a name="line-685"></a><span>                      </span><span class="hs-comment">-- Neat hack: since 'pat' can't fail, the</span><span>
</span><a name="line-686"></a><span>                      </span><span class="hs-comment">-- &quot;fail-expr&quot; passed to matchSimply is not</span><span>
</span><a name="line-687"></a><span>                      </span><span class="hs-comment">-- used. But it /is/ used for its type, and for</span><span>
</span><a name="line-688"></a><span>                      </span><span class="hs-comment">-- that bndr_var is just the ticket.</span><span>
</span><a name="line-689"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681850199"><span class="hs-identifier hs-var">bndr_var</span></a><span class="hs-special">,</span><span> </span><a href="DsUtils.html#mkOptTickBox"><span class="hs-identifier hs-var">mkOptTickBox</span></a><span> </span><a href="#local-6989586621681850198"><span class="hs-identifier hs-var">tick</span></a><span> </span><a href="#local-6989586621681850200"><span class="hs-identifier hs-var">rhs_expr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-690"></a><span>
</span><a name="line-691"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681850201"><a href="#local-6989586621681850201"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zipWithM</span><span> </span><a href="#local-6989586621681850197"><span class="hs-identifier hs-var">mk_bind</span></a><span> </span><a href="#local-6989586621681850190"><span class="hs-identifier hs-var">ticks'</span></a><span> </span><a href="#local-6989586621681850189"><span class="hs-identifier hs-var">binders</span></a><span>
</span><a name="line-692"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621681850196"><span class="hs-identifier hs-var">val_var</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681850196"><span class="hs-identifier hs-var">val_var</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681850187"><span class="hs-identifier hs-var">val_expr</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621681850201"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-693"></a><span>
</span><a name="line-694"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                          </span><span class="hs-comment">-- General case (C)</span><span>
</span><a name="line-695"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681850202"><a href="#local-6989586621681850202"><span class="hs-identifier">tuple_var</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#newSysLocalDs"><span class="hs-identifier hs-var">newSysLocalDs</span></a><span> </span><a href="#local-6989586621681850193"><span class="hs-identifier hs-var">tuple_ty</span></a><span>
</span><a name="line-696"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681850203"><a href="#local-6989586621681850203"><span class="hs-identifier">error_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsUtils.html#mkErrorAppDs"><span class="hs-identifier hs-var">mkErrorAppDs</span></a><span> </span><span class="hs-identifier hs-var">pAT_ERROR_ID</span><span> </span><a href="#local-6989586621681850193"><span class="hs-identifier hs-var">tuple_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681850188"><span class="hs-identifier hs-var">pat'</span></a><span class="hs-special">)</span><span>
</span><a name="line-697"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681850204"><a href="#local-6989586621681850204"><span class="hs-identifier">tuple_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Match.html#matchSimply"><span class="hs-identifier hs-var">matchSimply</span></a><span> </span><a href="#local-6989586621681850187"><span class="hs-identifier hs-var">val_expr</span></a><span> </span><span class="hs-identifier hs-var">PatBindRhs</span><span> </span><a href="#local-6989586621681850186"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-698"></a><span>                                   </span><a href="#local-6989586621681850192"><span class="hs-identifier hs-var">local_tuple</span></a><span> </span><a href="#local-6989586621681850203"><span class="hs-identifier hs-var">error_expr</span></a><span>
</span><a name="line-699"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681850205"><a href="#local-6989586621681850205"><span class="hs-identifier">mk_tup_bind</span></a></a><span> </span><a name="local-6989586621681850207"><a href="#local-6989586621681850207"><span class="hs-identifier">tick</span></a></a><span> </span><a name="local-6989586621681850208"><a href="#local-6989586621681850208"><span class="hs-identifier">binder</span></a></a><span>
</span><a name="line-700"></a><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681850208"><span class="hs-identifier hs-var">binder</span></a><span class="hs-special">,</span><span> </span><a href="DsUtils.html#mkOptTickBox"><span class="hs-identifier hs-var">mkOptTickBox</span></a><span> </span><a href="#local-6989586621681850207"><span class="hs-identifier hs-var">tick</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-701"></a><span>                          </span><span class="hs-identifier hs-var">mkTupleSelector1</span><span> </span><a href="#local-6989586621681850191"><span class="hs-identifier hs-var">local_binders</span></a><span> </span><a href="#local-6989586621681850208"><span class="hs-identifier hs-var">binder</span></a><span>
</span><a name="line-702"></a><span>                                           </span><a href="#local-6989586621681850202"><span class="hs-identifier hs-var">tuple_var</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621681850202"><span class="hs-identifier hs-var">tuple_var</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-703"></a><span>             </span><a name="local-6989586621681850206"><a href="#local-6989586621681850206"><span class="hs-identifier">tup_binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="#local-6989586621681850205"><span class="hs-identifier hs-var">mk_tup_bind</span></a><span> </span><a href="#local-6989586621681850190"><span class="hs-identifier hs-var">ticks'</span></a><span> </span><a href="#local-6989586621681850189"><span class="hs-identifier hs-var">binders</span></a><span>
</span><a name="line-704"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681850202"><span class="hs-identifier hs-var">tuple_var</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681850202"><span class="hs-identifier hs-var">tuple_var</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681850204"><span class="hs-identifier hs-var">tuple_expr</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621681850206"><span class="hs-identifier hs-var">tup_binds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-705"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-706"></a><span>    </span><a name="local-6989586621681850188"><a href="#local-6989586621681850188"><span class="hs-identifier">pat'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#strip_bangs"><span class="hs-identifier hs-var">strip_bangs</span></a><span> </span><a href="#local-6989586621681850186"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-707"></a><span>           </span><span class="hs-comment">-- Strip the bangs before looking for case (A) or (B)</span><span>
</span><a name="line-708"></a><span>           </span><span class="hs-comment">-- The incoming pattern may well have a bang on it</span><span>
</span><a name="line-709"></a><span>
</span><a name="line-710"></a><span>    </span><a name="local-6989586621681850189"><a href="#local-6989586621681850189"><span class="hs-identifier">binders</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">collectPatBinders</span><span> </span><a href="#local-6989586621681850188"><span class="hs-identifier hs-var">pat'</span></a><span>
</span><a name="line-711"></a><span>    </span><a name="local-6989586621681850190"><a href="#local-6989586621681850190"><span class="hs-identifier">ticks'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681850185"><span class="hs-identifier hs-var">ticks</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">repeat</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-712"></a><span>
</span><a name="line-713"></a><span>    </span><a name="local-6989586621681850191"><a href="#local-6989586621681850191"><span class="hs-identifier">local_binders</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">localiseId</span><span> </span><a href="#local-6989586621681850189"><span class="hs-identifier hs-var">binders</span></a><span>      </span><span class="hs-comment">-- See Note [Localise pattern binders]</span><span>
</span><a name="line-714"></a><span>    </span><a name="local-6989586621681850192"><a href="#local-6989586621681850192"><span class="hs-identifier">local_tuple</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkBigCoreVarTup1</span><span> </span><a href="#local-6989586621681850189"><span class="hs-identifier hs-var">binders</span></a><span>
</span><a name="line-715"></a><span>    </span><a name="local-6989586621681850193"><a href="#local-6989586621681850193"><span class="hs-identifier">tuple_ty</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">exprType</span><span> </span><a href="#local-6989586621681850192"><span class="hs-identifier hs-var">local_tuple</span></a><span>
</span><a name="line-716"></a><span>
</span><a name="line-717"></a><span class="hs-identifier">strip_bangs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621681850032"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621681850032"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-718"></a><span class="hs-comment">-- Remove outermost bangs and parens</span><span>
</span><a name="line-719"></a><a name="strip_bangs"><a href="DsUtils.html#strip_bangs"><span class="hs-identifier">strip_bangs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParPat</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681850209"><a href="#local-6989586621681850209"><span class="hs-identifier">p</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#strip_bangs"><span class="hs-identifier hs-var">strip_bangs</span></a><span> </span><a href="#local-6989586621681850209"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-720"></a><span class="hs-identifier">strip_bangs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BangPat</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681850210"><a href="#local-6989586621681850210"><span class="hs-identifier">p</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#strip_bangs"><span class="hs-identifier hs-var">strip_bangs</span></a><span> </span><a href="#local-6989586621681850210"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-721"></a><span class="hs-identifier">strip_bangs</span><span> </span><a name="local-6989586621681850211"><a href="#local-6989586621681850211"><span class="hs-identifier">lp</span></a></a><span>                      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681850211"><span class="hs-identifier hs-var">lp</span></a><span>
</span><a name="line-722"></a><span>
</span><a name="line-723"></a><span class="hs-identifier">is_flat_prod_lpat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621681850031"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-724"></a><a name="is_flat_prod_lpat"><a href="DsUtils.html#is_flat_prod_lpat"><span class="hs-identifier">is_flat_prod_lpat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#is_flat_prod_pat"><span class="hs-identifier hs-var">is_flat_prod_pat</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span>
</span><a name="line-725"></a><span>
</span><a name="line-726"></a><span class="hs-identifier">is_flat_prod_pat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Pat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621681850030"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-727"></a><a name="is_flat_prod_pat"><a href="DsUtils.html#is_flat_prod_pat"><span class="hs-identifier">is_flat_prod_pat</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParPat</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681850212"><a href="#local-6989586621681850212"><span class="hs-identifier">p</span></a></a><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#is_flat_prod_lpat"><span class="hs-identifier hs-var">is_flat_prod_lpat</span></a><span> </span><a href="#local-6989586621681850212"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-728"></a><span class="hs-identifier">is_flat_prod_pat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TuplePat</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681850213"><a href="#local-6989586621681850213"><span class="hs-identifier">ps</span></a></a><span> </span><span class="hs-identifier hs-var">Boxed</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><a href="DsUtils.html#is_triv_lpat"><span class="hs-identifier hs-var">is_triv_lpat</span></a><span> </span><a href="#local-6989586621681850213"><span class="hs-identifier hs-var">ps</span></a><span>
</span><a name="line-729"></a><span class="hs-identifier">is_flat_prod_pat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ConPatOut</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pat_con</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681850214"><a href="#local-6989586621681850214"><span class="hs-identifier">pcon</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-730"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pat_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681850215"><a href="#local-6989586621681850215"><span class="hs-identifier">ps</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-731"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">RealDataCon</span><span> </span><a name="local-6989586621681850216"><a href="#local-6989586621681850216"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681850214"><span class="hs-identifier hs-var">pcon</span></a><span>
</span><a name="line-732"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isProductTyCon</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConTyCon</span><span> </span><a href="#local-6989586621681850216"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-733"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><a href="DsUtils.html#is_triv_lpat"><span class="hs-identifier hs-var">is_triv_lpat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hsConPatArgs</span><span> </span><a href="#local-6989586621681850215"><span class="hs-identifier hs-var">ps</span></a><span class="hs-special">)</span><span>
</span><a name="line-734"></a><span class="hs-identifier">is_flat_prod_pat</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-735"></a><span>
</span><a name="line-736"></a><span class="hs-identifier">is_triv_lpat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621681850029"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-737"></a><a name="is_triv_lpat"><a href="DsUtils.html#is_triv_lpat"><span class="hs-identifier">is_triv_lpat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#is_triv_pat"><span class="hs-identifier hs-var">is_triv_pat</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span>
</span><a name="line-738"></a><span>
</span><a name="line-739"></a><span class="hs-identifier">is_triv_pat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Pat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621681850028"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-740"></a><a name="is_triv_pat"><a href="DsUtils.html#is_triv_pat"><span class="hs-identifier">is_triv_pat</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarPat</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-741"></a><span class="hs-identifier">is_triv_pat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WildPat</span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-742"></a><span class="hs-identifier">is_triv_pat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParPat</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681850217"><a href="#local-6989586621681850217"><span class="hs-identifier">p</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#is_triv_lpat"><span class="hs-identifier hs-var">is_triv_lpat</span></a><span> </span><a href="#local-6989586621681850217"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-743"></a><span class="hs-identifier">is_triv_pat</span><span> </span><span class="hs-identifier">_</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-744"></a><span>
</span><a name="line-745"></a><span>
</span><a name="line-746"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
  Creating big tuples and their types for full Haskell expressions.
  They work over *Ids*, and create tuples replete with their types,
  which is whey they are not in HsUtils.
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-753"></a><span>
</span><a name="line-754"></a><span class="hs-identifier">mkLHsPatTup</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-755"></a><a name="mkLHsPatTup"><a href="DsUtils.html#mkLHsPatTup"><span class="hs-identifier">mkLHsPatTup</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="DsUtils.html#mkVanillaTuplePat"><span class="hs-identifier hs-var">mkVanillaTuplePat</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">Boxed</span><span>
</span><a name="line-756"></a><span class="hs-identifier">mkLHsPatTup</span><span> </span><span class="hs-special">[</span><a name="local-6989586621681850218"><a href="#local-6989586621681850218"><span class="hs-identifier">lpat</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681850218"><span class="hs-identifier hs-var">lpat</span></a><span>
</span><a name="line-757"></a><span class="hs-identifier">mkLHsPatTup</span><span> </span><a name="local-6989586621681850219"><a href="#local-6989586621681850219"><span class="hs-identifier">lpats</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621681850219"><span class="hs-identifier hs-var">lpats</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-758"></a><span>                     </span><a href="DsUtils.html#mkVanillaTuplePat"><span class="hs-identifier hs-var">mkVanillaTuplePat</span></a><span> </span><a href="#local-6989586621681850219"><span class="hs-identifier hs-var">lpats</span></a><span> </span><span class="hs-identifier hs-var">Boxed</span><span>
</span><a name="line-759"></a><span>
</span><a name="line-760"></a><span class="hs-identifier">mkLHsVarPatTup</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-761"></a><a name="mkLHsVarPatTup"><a href="DsUtils.html#mkLHsVarPatTup"><span class="hs-identifier">mkLHsVarPatTup</span></a></a><span> </span><a name="local-6989586621681850220"><a href="#local-6989586621681850220"><span class="hs-identifier">bs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#mkLHsPatTup"><span class="hs-identifier hs-var">mkLHsPatTup</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">nlVarPat</span><span> </span><a href="#local-6989586621681850220"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span>
</span><a name="line-762"></a><span>
</span><a name="line-763"></a><span class="hs-identifier">mkVanillaTuplePat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">OutPat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Boxity</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Pat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-764"></a><span class="hs-comment">-- A vanilla tuple pattern simply gets its type from its sub-patterns</span><span>
</span><a name="line-765"></a><a name="mkVanillaTuplePat"><a href="DsUtils.html#mkVanillaTuplePat"><span class="hs-identifier">mkVanillaTuplePat</span></a></a><span> </span><a name="local-6989586621681850221"><a href="#local-6989586621681850221"><span class="hs-identifier">pats</span></a></a><span> </span><a name="local-6989586621681850222"><a href="#local-6989586621681850222"><span class="hs-identifier">box</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TuplePat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="TcHsSyn.html#hsLPatType"><span class="hs-identifier hs-var">hsLPatType</span></a><span> </span><a href="#local-6989586621681850221"><span class="hs-identifier hs-var">pats</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681850221"><span class="hs-identifier hs-var">pats</span></a><span> </span><a href="#local-6989586621681850222"><span class="hs-identifier hs-var">box</span></a><span>
</span><a name="line-766"></a><span>
</span><a name="line-767"></a><span class="hs-comment">-- The Big equivalents for the source tuple expressions</span><span>
</span><a name="line-768"></a><span class="hs-identifier">mkBigLHsVarTupId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-769"></a><a name="mkBigLHsVarTupId"><a href="DsUtils.html#mkBigLHsVarTupId"><span class="hs-identifier">mkBigLHsVarTupId</span></a></a><span> </span><a name="local-6989586621681850223"><a href="#local-6989586621681850223"><span class="hs-identifier">ids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#mkBigLHsTupId"><span class="hs-identifier hs-var">mkBigLHsTupId</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><a href="#local-6989586621681850223"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">)</span><span>
</span><a name="line-770"></a><span>
</span><a name="line-771"></a><span class="hs-identifier">mkBigLHsTupId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-772"></a><a name="mkBigLHsTupId"><a href="DsUtils.html#mkBigLHsTupId"><span class="hs-identifier">mkBigLHsTupId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkChunkified</span><span> </span><span class="hs-identifier hs-var">mkLHsTupleExpr</span><span>
</span><a name="line-773"></a><span>
</span><a name="line-774"></a><span class="hs-comment">-- The Big equivalents for the source tuple patterns</span><span>
</span><a name="line-775"></a><span class="hs-identifier">mkBigLHsVarPatTupId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-776"></a><a name="mkBigLHsVarPatTupId"><a href="DsUtils.html#mkBigLHsVarPatTupId"><span class="hs-identifier">mkBigLHsVarPatTupId</span></a></a><span> </span><a name="local-6989586621681850224"><a href="#local-6989586621681850224"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#mkBigLHsPatTupId"><span class="hs-identifier hs-var">mkBigLHsPatTupId</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">nlVarPat</span><span> </span><a href="#local-6989586621681850224"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span>
</span><a name="line-777"></a><span>
</span><a name="line-778"></a><span class="hs-identifier">mkBigLHsPatTupId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-779"></a><a name="mkBigLHsPatTupId"><a href="DsUtils.html#mkBigLHsPatTupId"><span class="hs-identifier">mkBigLHsPatTupId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkChunkified</span><span> </span><a href="DsUtils.html#mkLHsPatTup"><span class="hs-identifier hs-var">mkLHsPatTup</span></a><span>
</span><a name="line-780"></a><span>
</span><a name="line-781"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Code for pattern-matching and other failures
*                                                                      *
************************************************************************

Generally, we handle pattern matching failure like this: let-bind a
fail-variable, and use that variable if the thing fails:
\begin{verbatim}
        let fail.33 = error &quot;Help&quot;
        in
        case x of
                p1 -&gt; ...
                p2 -&gt; fail.33
                p3 -&gt; fail.33
                p4 -&gt; ...
\end{verbatim}
Then
\begin{itemize}
\item
If the case can't fail, then there'll be no mention of @fail.33@, and the
simplifier will later discard it.

\item
If it can fail in only one way, then the simplifier will inline it.

\item
Only if it is used more than once will the let-binding remain.
\end{itemize}

There's a problem when the result of the case expression is of
unboxed type.  Then the type of @fail.33@ is unboxed too, and
there is every chance that someone will change the let into a case:
\begin{verbatim}
        case error &quot;Help&quot; of
          fail.33 -&gt; case ....
\end{verbatim}

which is of course utterly wrong.  Rather than drop the condition that
only boxed types can be let-bound, we just turn the fail into a function
for the primitive case:
\begin{verbatim}
        let fail.33 :: Void -&gt; Int#
            fail.33 = \_ -&gt; error &quot;Help&quot;
        in
        case x of
                p1 -&gt; ...
                p2 -&gt; fail.33 void
                p3 -&gt; fail.33 void
                p4 -&gt; ...
\end{verbatim}

Now @fail.33@ is a function, so it can be let-bound.

We would *like* to use join points here; in fact, these &quot;fail variables&quot; are
paradigmatic join points! Sadly, this breaks pattern synonyms, which desugar as
CPS functions - i.e. they take &quot;join points&quot; as parameters. It's not impossible
to imagine extending our type system to allow passing join points around (very
carefully), but we certainly don't support it now.

99.99% of the time, the fail variables wind up as join points in short order
anyway, and the Void# doesn't do much harm.
-}</span><span>
</span><a name="line-845"></a><span>
</span><a name="line-846"></a><span class="hs-identifier">mkFailurePair</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>       </span><span class="hs-comment">-- Result type of the whole case expression</span><span>
</span><a name="line-847"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CoreBind</span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- Binds the newly-created fail variable</span><span>
</span><a name="line-848"></a><span>                                </span><span class="hs-comment">-- to \ _ -&gt; expression</span><span>
</span><a name="line-849"></a><span>                      </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Fail variable applied to realWorld#</span><span>
</span><a name="line-850"></a><span class="hs-comment">-- See Note [Failure thunks and CPR]</span><span>
</span><a name="line-851"></a><a name="mkFailurePair"><a href="DsUtils.html#mkFailurePair"><span class="hs-identifier">mkFailurePair</span></a></a><span> </span><a name="local-6989586621681850225"><a href="#local-6989586621681850225"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-852"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681850227"><a href="#local-6989586621681850227"><span class="hs-identifier">fail_fun_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#newFailLocalDs"><span class="hs-identifier hs-var">newFailLocalDs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">voidPrimTy</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkFunTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681850226"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-853"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681850228"><a href="#local-6989586621681850228"><span class="hs-identifier">fail_fun_arg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#newSysLocalDs"><span class="hs-identifier hs-var">newSysLocalDs</span></a><span> </span><span class="hs-identifier hs-var">voidPrimTy</span><span>
</span><a name="line-854"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681850229"><a href="#local-6989586621681850229"><span class="hs-identifier">real_arg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">setOneShotLambda</span><span> </span><a href="#local-6989586621681850228"><span class="hs-identifier hs-var">fail_fun_arg</span></a><span>
</span><a name="line-855"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621681850227"><span class="hs-identifier hs-var">fail_fun_var</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Lam</span><span> </span><a href="#local-6989586621681850229"><span class="hs-identifier hs-var">real_arg</span></a><span> </span><a href="#local-6989586621681850225"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-856"></a><span>                 </span><span class="hs-identifier hs-var">App</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621681850227"><span class="hs-identifier hs-var">fail_fun_var</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><span class="hs-identifier hs-var">voidPrimId</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-857"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-858"></a><span>    </span><a name="local-6989586621681850226"><a href="#local-6989586621681850226"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">exprType</span><span> </span><a href="#local-6989586621681850225"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-859"></a><span>
</span><a name="line-860"></a><span class="hs-comment">{-
Note [Failure thunks and CPR]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
(This note predates join points as formal entities (hence the quotation marks).
We can't use actual join points here (see above); if we did, this would also
solve the CPR problem, since join points don't get CPR'd. See Note [Don't CPR
join points] in WorkWrap.)

When we make a failure point we ensure that it
does not look like a thunk. Example:

   let fail = \rw -&gt; error &quot;urk&quot;
   in case x of
        [] -&gt; fail realWorld#
        (y:ys) -&gt; case ys of
                    [] -&gt; fail realWorld#
                    (z:zs) -&gt; (y,z)

Reason: we know that a failure point is always a &quot;join point&quot; and is
entered at most once.  Adding a dummy 'realWorld' token argument makes
it clear that sharing is not an issue.  And that in turn makes it more
CPR-friendly.  This matters a lot: if you don't get it right, you lose
the tail call property.  For example, see Trac #3403.


************************************************************************
*                                                                      *
              Ticks
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-890"></a><span>
</span><a name="line-891"></a><span class="hs-identifier">mkOptTickBox</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Tickish</span><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-892"></a><a name="mkOptTickBox"><a href="DsUtils.html#mkOptTickBox"><span class="hs-identifier">mkOptTickBox</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-identifier hs-var">Tick</span><span class="hs-special">)</span><span>
</span><a name="line-893"></a><span>
</span><a name="line-894"></a><span class="hs-identifier">mkBinaryTickBox</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-895"></a><a name="mkBinaryTickBox"><a href="DsUtils.html#mkBinaryTickBox"><span class="hs-identifier">mkBinaryTickBox</span></a></a><span> </span><a name="local-6989586621681850230"><a href="#local-6989586621681850230"><span class="hs-identifier">ixT</span></a></a><span> </span><a name="local-6989586621681850231"><a href="#local-6989586621681850231"><span class="hs-identifier">ixF</span></a></a><span> </span><a name="local-6989586621681850232"><a href="#local-6989586621681850232"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-896"></a><span>       </span><a name="local-6989586621681850233"><a href="#local-6989586621681850233"><span class="hs-identifier">uq</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a><span>
</span><a name="line-897"></a><span>       </span><a name="local-6989586621681850234"><a href="#local-6989586621681850234"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-898"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681850235"><a href="#local-6989586621681850235"><span class="hs-identifier">bndr1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkSysLocal</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;t1&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681850233"><span class="hs-identifier hs-var">uq</span></a><span> </span><span class="hs-identifier hs-var">boolTy</span><span>
</span><a name="line-899"></a><span>       </span><span class="hs-keyword">let</span><span>
</span><a name="line-900"></a><span>           </span><a name="local-6989586621681850236"><a href="#local-6989586621681850236"><span class="hs-identifier">falseBox</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Tick</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HpcTick</span><span> </span><a href="#local-6989586621681850234"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621681850231"><span class="hs-identifier hs-var">ixF</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><span class="hs-identifier hs-var">falseDataConId</span><span class="hs-special">)</span><span>
</span><a name="line-901"></a><span>           </span><a name="local-6989586621681850237"><a href="#local-6989586621681850237"><span class="hs-identifier">trueBox</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Tick</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HpcTick</span><span> </span><a href="#local-6989586621681850234"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621681850230"><span class="hs-identifier hs-var">ixT</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><span class="hs-identifier hs-var">trueDataConId</span><span class="hs-special">)</span><span>
</span><a name="line-902"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-903"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Case</span><span> </span><a href="#local-6989586621681850232"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621681850235"><span class="hs-identifier hs-var">bndr1</span></a><span> </span><span class="hs-identifier hs-var">boolTy</span><span>
</span><a name="line-904"></a><span>                       </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataAlt</span><span> </span><span class="hs-identifier hs-var">falseDataCon</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681850236"><span class="hs-identifier hs-var">falseBox</span></a><span class="hs-special">)</span><span>
</span><a name="line-905"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataAlt</span><span> </span><span class="hs-identifier hs-var">trueDataCon</span><span class="hs-special">,</span><span>  </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681850237"><span class="hs-identifier hs-var">trueBox</span></a><span class="hs-special">)</span><span>
</span><a name="line-906"></a><span>                       </span><span class="hs-special">]</span><span>
</span><a name="line-907"></a><span>
</span><a name="line-908"></a><span>
</span><a name="line-909"></a><span>
</span><a name="line-910"></a><span class="hs-comment">-- *******************************************************************</span><span>
</span><a name="line-911"></a><span>
</span><a name="line-912"></a><span class="hs-comment">{- Note [decideBangHood]
~~~~~~~~~~~~~~~~~~~~~~~~
With -XStrict we may make /outermost/ patterns more strict.
E.g.
       let (Just x) = e in ...
          ==&gt;
       let !(Just x) = e in ...
and
       f x = e
          ==&gt;
       f !x = e

This adjustment is done by decideBangHood,

  * Just before constructing an EqnInfo, in Match
      (matchWrapper and matchSinglePat)

  * When desugaring a pattern-binding in DsBinds.dsHsBind

Note that it is /not/ done recursively.  See the -XStrict
spec in the user manual.

Specifically:
   ~pat    =&gt; pat    -- when -XStrict (even if pat = ~pat')
   !pat    =&gt; !pat   -- always
   pat     =&gt; !pat   -- when -XStrict
   pat     =&gt; pat    -- otherwise
-}</span><span>
</span><a name="line-940"></a><span>
</span><a name="line-941"></a><span>
</span><a name="line-942"></a><span class="hs-comment">-- | Use -XStrict to add a ! or remove a ~</span><span>
</span><a name="line-943"></a><span class="hs-comment">-- See Note [decideBangHood]</span><span>
</span><a name="line-944"></a><span class="hs-identifier">decideBangHood</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-945"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>  </span><span class="hs-comment">-- ^ Original pattern</span><span>
</span><a name="line-946"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>  </span><span class="hs-comment">-- Pattern with bang if necessary</span><span>
</span><a name="line-947"></a><a name="decideBangHood"><a href="DsUtils.html#decideBangHood"><span class="hs-identifier">decideBangHood</span></a></a><span> </span><a name="local-6989586621681850238"><a href="#local-6989586621681850238"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681850239"><a href="#local-6989586621681850239"><span class="hs-identifier">lpat</span></a></a><span>
</span><a name="line-948"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">xopt</span><span> </span><span class="hs-identifier hs-var">LangExt.Strict</span><span> </span><a href="#local-6989586621681850238"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-949"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681850239"><span class="hs-identifier hs-var">lpat</span></a><span>
</span><a name="line-950"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-comment">--  -XStrict</span><span>
</span><a name="line-951"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681850240"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681850239"><span class="hs-identifier hs-var">lpat</span></a><span>
</span><a name="line-952"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-953"></a><span>    </span><a name="local-6989586621681850240"><a href="#local-6989586621681850240"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621681850241"><a href="#local-6989586621681850241"><span class="hs-identifier">lp</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621681850242"><a href="#local-6989586621681850242"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621681850243"><a href="#local-6989586621681850243"><span class="hs-identifier">p</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-954"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681850243"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-955"></a><span>           </span><span class="hs-identifier hs-var">ParPat</span><span> </span><a name="local-6989586621681850244"><a href="#local-6989586621681850244"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621681850245"><a href="#local-6989586621681850245"><span class="hs-identifier">p</span></a></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621681850242"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParPat</span><span> </span><a href="#local-6989586621681850244"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681850240"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681850245"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-956"></a><span>           </span><span class="hs-identifier hs-var">LazyPat</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681850246"><a href="#local-6989586621681850246"><span class="hs-identifier">lp'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681850246"><span class="hs-identifier hs-var">lp'</span></a><span>
</span><a name="line-957"></a><span>           </span><span class="hs-identifier hs-var">BangPat</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681850241"><span class="hs-identifier hs-var">lp</span></a><span>
</span><a name="line-958"></a><span>           </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621681850242"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BangPat</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621681850241"><span class="hs-identifier hs-var">lp</span></a><span class="hs-special">)</span><span>
</span><a name="line-959"></a><span>
</span><a name="line-960"></a><span class="hs-comment">-- | Unconditionally make a 'Pat' strict.</span><span>
</span><a name="line-961"></a><span class="hs-identifier">addBang</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-comment">-- ^ Original pattern</span><span>
</span><a name="line-962"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-comment">-- ^ Banged pattern</span><span>
</span><a name="line-963"></a><a name="addBang"><a href="DsUtils.html#addBang"><span class="hs-identifier">addBang</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681850247"><span class="hs-identifier hs-var">go</span></a><span>
</span><a name="line-964"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-965"></a><span>    </span><a name="local-6989586621681850247"><a href="#local-6989586621681850247"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621681850248"><a href="#local-6989586621681850248"><span class="hs-identifier">lp</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621681850249"><a href="#local-6989586621681850249"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621681850250"><a href="#local-6989586621681850250"><span class="hs-identifier">p</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-966"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681850250"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-967"></a><span>           </span><span class="hs-identifier hs-var">ParPat</span><span> </span><a name="local-6989586621681850251"><a href="#local-6989586621681850251"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621681850252"><a href="#local-6989586621681850252"><span class="hs-identifier">p</span></a></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621681850249"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParPat</span><span> </span><a href="#local-6989586621681850251"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681850247"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681850252"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-968"></a><span>           </span><span class="hs-identifier hs-var">LazyPat</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681850253"><a href="#local-6989586621681850253"><span class="hs-identifier">lp'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621681850249"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BangPat</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621681850253"><span class="hs-identifier hs-var">lp'</span></a><span class="hs-special">)</span><span>
</span><a name="line-969"></a><span>                                  </span><span class="hs-comment">-- Should we bring the extension value over?</span><span>
</span><a name="line-970"></a><span>           </span><span class="hs-identifier hs-var">BangPat</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681850248"><span class="hs-identifier hs-var">lp</span></a><span>
</span><a name="line-971"></a><span>           </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621681850249"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BangPat</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621681850248"><span class="hs-identifier hs-var">lp</span></a><span class="hs-special">)</span><span>
</span><a name="line-972"></a><span>
</span><a name="line-973"></a><span class="hs-identifier">isTrueLHsExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span>
</span><a name="line-974"></a><span>
</span><a name="line-975"></a><span class="hs-comment">-- Returns Just {..} if we're sure that the expression is True</span><span>
</span><a name="line-976"></a><span class="hs-comment">-- I.e.   * 'True' datacon</span><span>
</span><a name="line-977"></a><span class="hs-comment">--        * 'otherwise' Id</span><span>
</span><a name="line-978"></a><span class="hs-comment">--        * Trivial wappings of these</span><span>
</span><a name="line-979"></a><span class="hs-comment">-- The arguments to Just are any HsTicks that we have found,</span><span>
</span><a name="line-980"></a><span class="hs-comment">-- because we still want to tick then, even it they are always evaluated.</span><span>
</span><a name="line-981"></a><a name="isTrueLHsExpr"><a href="DsUtils.html#isTrueLHsExpr"><span class="hs-identifier">isTrueLHsExpr</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681850254"><a href="#local-6989586621681850254"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-982"></a><span>  </span><span class="hs-glyph">|</span><span>  </span><a href="#local-6989586621681850254"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">otherwiseIdKey</span><span>
</span><a name="line-983"></a><span>     </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621681850254"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">getUnique</span><span> </span><span class="hs-identifier hs-var">trueDataConId</span><span>
</span><a name="line-984"></a><span>                                              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">return</span><span>
</span><a name="line-985"></a><span>        </span><span class="hs-comment">-- trueDataConId doesn't have the same unique as trueDataCon</span><span>
</span><a name="line-986"></a><span class="hs-identifier">isTrueLHsExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsConLikeOut</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681850255"><a href="#local-6989586621681850255"><span class="hs-identifier">con</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-987"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681850255"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">getUnique</span><span> </span><span class="hs-identifier hs-var">trueDataCon</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">return</span><span>
</span><a name="line-988"></a><span class="hs-identifier">isTrueLHsExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTick</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681850256"><a href="#local-6989586621681850256"><span class="hs-identifier">tickish</span></a></a><span> </span><a name="local-6989586621681850257"><a href="#local-6989586621681850257"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-989"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681850258"><a href="#local-6989586621681850258"><span class="hs-identifier">ticks</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsUtils.html#isTrueLHsExpr"><span class="hs-identifier hs-var">isTrueLHsExpr</span></a><span> </span><a href="#local-6989586621681850257"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-990"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681850259"><a href="#local-6989586621681850259"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681850260"><a href="#local-6989586621681850260"><span class="hs-identifier">wrapped</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681850258"><span class="hs-identifier hs-var">ticks</span></a><span> </span><a href="#local-6989586621681850259"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-991"></a><span>                     </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Tick</span><span> </span><a href="#local-6989586621681850256"><span class="hs-identifier hs-var">tickish</span></a><span> </span><a href="#local-6989586621681850260"><span class="hs-identifier hs-var">wrapped</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-992"></a><span>   </span><span class="hs-comment">-- This encodes that the result is constant True for Hpc tick purposes;</span><span>
</span><a name="line-993"></a><span>   </span><span class="hs-comment">-- which is specifically what isTrueLHsExpr is trying to find out.</span><span>
</span><a name="line-994"></a><span class="hs-identifier">isTrueLHsExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsBinTick</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681850261"><a href="#local-6989586621681850261"><span class="hs-identifier">ixT</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681850262"><a href="#local-6989586621681850262"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-995"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681850263"><a href="#local-6989586621681850263"><span class="hs-identifier">ticks</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsUtils.html#isTrueLHsExpr"><span class="hs-identifier hs-var">isTrueLHsExpr</span></a><span> </span><a href="#local-6989586621681850262"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-996"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681850264"><a href="#local-6989586621681850264"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681850265"><a href="#local-6989586621681850265"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681850263"><span class="hs-identifier hs-var">ticks</span></a><span> </span><a href="#local-6989586621681850264"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-997"></a><span>                     </span><a name="local-6989586621681850266"><a href="#local-6989586621681850266"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-998"></a><span>                     </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Tick</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HpcTick</span><span> </span><a href="#local-6989586621681850266"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621681850261"><span class="hs-identifier hs-var">ixT</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681850265"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-999"></a><span>
</span><a name="line-1000"></a><span class="hs-identifier">isTrueLHsExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsPar</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681850267"><a href="#local-6989586621681850267"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#isTrueLHsExpr"><span class="hs-identifier hs-var">isTrueLHsExpr</span></a><span> </span><a href="#local-6989586621681850267"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1001"></a><span class="hs-identifier">isTrueLHsExpr</span><span> </span><span class="hs-identifier">_</span><span>                       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1002"></a></pre></body></html>