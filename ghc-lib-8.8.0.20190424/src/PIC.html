<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
  This module handles generation of position independent code and
  dynamic-linking related issues for the native code generator.

  This depends both the architecture and OS, so we define it here
  instead of in one of the architecture specific modules.

  Things outside this module which are related to this:

  + module CLabel
    - PIC base label (pretty printed as local label 1)
    - DynamicLinkerLabels - several kinds:
        CodeStub, SymbolPtr, GotSymbolPtr, GotSymbolOffset
    - labelDynamic predicate
  + module Cmm
    - The GlobalReg datatype has a PicBaseReg constructor
    - The CmmLit datatype has a CmmLabelDiffOff constructor
  + codeGen &amp; RTS
    - When tablesNextToCode, no absolute addresses are stored in info tables
      any more. Instead, offsets from the info label are used.
    - For Win32 only, SRTs might contain addresses of __imp_ symbol pointers
      because Win32 doesn't support external references in data sections.
      TODO: make sure this still works, it might be bitrotted
  + NCG
    - The cmmToCmm pass in AsmCodeGen calls cmmMakeDynamicReference for all
      labels.
    - nativeCodeGen calls pprImportedSymbol and pprGotDeclaration to output
      all the necessary stuff for imported symbols.
    - The NCG monad keeps track of a list of imported symbols.
    - MachCodeGen invokes initializePicBase to generate code to initialize
      the PIC base register when needed.
    - MachCodeGen calls cmmMakeDynamicReference whenever it uses a CLabel
      that wasn't in the original Cmm code (e.g. floating point literals).
-}</span><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">PIC</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-37"></a><span>        </span><a href="PIC.html#cmmMakeDynamicReference"><span class="hs-identifier hs-var">cmmMakeDynamicReference</span></a><span class="hs-special">,</span><span>
</span><a name="line-38"></a><span>        </span><a href="PIC.html#CmmMakeDynamicReferenceM"><span class="hs-identifier hs-type">CmmMakeDynamicReferenceM</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-39"></a><span>        </span><a href="PIC.html#ReferenceKind"><span class="hs-identifier hs-type">ReferenceKind</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>        </span><a href="PIC.html#needImportedSymbols"><span class="hs-identifier hs-var">needImportedSymbols</span></a><span class="hs-special">,</span><span>
</span><a name="line-41"></a><span>        </span><a href="PIC.html#pprImportedSymbol"><span class="hs-identifier hs-var">pprImportedSymbol</span></a><span class="hs-special">,</span><span>
</span><a name="line-42"></a><span>        </span><a href="PIC.html#pprGotDeclaration"><span class="hs-identifier hs-var">pprGotDeclaration</span></a><span class="hs-special">,</span><span>
</span><a name="line-43"></a><span>
</span><a name="line-44"></a><span>        </span><a href="PIC.html#initializePicBase_ppc"><span class="hs-identifier hs-var">initializePicBase_ppc</span></a><span class="hs-special">,</span><span>
</span><a name="line-45"></a><span>        </span><a href="PIC.html#initializePicBase_x86"><span class="hs-identifier hs-var">initializePicBase_x86</span></a><span>
</span><a name="line-46"></a><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span class="hs-keyword">where</span><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="PPC.Instr.html"><span class="hs-identifier">PPC.Instr</span></a><span>      </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">PPC</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="PPC.Regs.html"><span class="hs-identifier">PPC.Regs</span></a><span>       </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">PPC</span><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="X86.Instr.html"><span class="hs-identifier">X86.Instr</span></a><span>      </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">X86</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Platform</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><a href="Instruction.html"><span class="hs-identifier">Instruction</span></a><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><a href="Reg.html"><span class="hs-identifier">Reg</span></a><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><a href="NCGMonad.html"><span class="hs-identifier">NCGMonad</span></a><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Collections.html"><span class="hs-identifier">Hoopl.Collections</span></a><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><a href="Cmm.html"><span class="hs-identifier">Cmm</span></a><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><a href="CLabel.html"><span class="hs-identifier">CLabel</span></a><span>           </span><span class="hs-special">(</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span class="hs-special">,</span><span> </span><a href="CLabel.html#ForeignLabelSource"><span class="hs-identifier hs-type">ForeignLabelSource</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="CLabel.html#pprCLabel"><span class="hs-identifier hs-var">pprCLabel</span></a><span class="hs-special">,</span><span>
</span><a name="line-66"></a><span>                          </span><a href="CLabel.html#mkDynamicLinkerLabel"><span class="hs-identifier hs-var">mkDynamicLinkerLabel</span></a><span class="hs-special">,</span><span> </span><a href="CLabel.html#DynamicLinkerLabelInfo"><span class="hs-identifier hs-type">DynamicLinkerLabelInfo</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-67"></a><span>                          </span><a href="CLabel.html#dynamicLinkerLabelInfo"><span class="hs-identifier hs-var">dynamicLinkerLabelInfo</span></a><span class="hs-special">,</span><span> </span><a href="CLabel.html#mkPicBaseLabel"><span class="hs-identifier hs-var">mkPicBaseLabel</span></a><span class="hs-special">,</span><span>
</span><a name="line-68"></a><span>                          </span><a href="CLabel.html#labelDynamic"><span class="hs-identifier hs-var">labelDynamic</span></a><span class="hs-special">,</span><span> </span><a href="CLabel.html#externallyVisibleCLabel"><span class="hs-identifier hs-var">externallyVisibleCLabel</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-69"></a><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><a href="CLabel.html"><span class="hs-identifier">CLabel</span></a><span>           </span><span class="hs-special">(</span><span> </span><a href="CLabel.html#mkForeignLabel"><span class="hs-identifier hs-var">mkForeignLabel</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-75"></a><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-79"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-84"></a><span class="hs-comment">-- It gets called by the cmmToCmm pass for every CmmLabel in the Cmm</span><span>
</span><a name="line-85"></a><span class="hs-comment">-- code. It does The Right Thing(tm) to convert the CmmLabel into a</span><span>
</span><a name="line-86"></a><span class="hs-comment">-- position-independent, dynamic-linking-aware reference to the thing</span><span>
</span><a name="line-87"></a><span class="hs-comment">-- in question.</span><span>
</span><a name="line-88"></a><span class="hs-comment">-- Note that this also has to be called from MachCodeGen in order to</span><span>
</span><a name="line-89"></a><span class="hs-comment">-- access static data like floating point literals (labels that were</span><span>
</span><a name="line-90"></a><span class="hs-comment">-- created after the cmmToCmm pass).</span><span>
</span><a name="line-91"></a><span class="hs-comment">-- The function must run in a monad that can keep track of imported symbols</span><span>
</span><a name="line-92"></a><span class="hs-comment">-- A function for recording an imported symbol must be passed in:</span><span>
</span><a name="line-93"></a><span class="hs-comment">-- - addImportCmmOpt for the CmmOptM monad</span><span>
</span><a name="line-94"></a><span class="hs-comment">-- - addImportNat for the NatM monad.</span><span>
</span><a name="line-95"></a><span>
</span><a name="line-96"></a><span class="hs-keyword">data</span><span> </span><a name="ReferenceKind"><a href="PIC.html#ReferenceKind"><span class="hs-identifier">ReferenceKind</span></a></a><span>
</span><a name="line-97"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a name="DataReference"><a href="PIC.html#DataReference"><span class="hs-identifier">DataReference</span></a></a><span>
</span><a name="line-98"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a name="CallReference"><a href="PIC.html#CallReference"><span class="hs-identifier">CallReference</span></a></a><span>
</span><a name="line-99"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a name="JumpReference"><a href="PIC.html#JumpReference"><span class="hs-identifier">JumpReference</span></a></a><span>
</span><a name="line-100"></a><span>        </span><span class="hs-keyword">deriving</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span class="hs-keyword">class</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621684642945"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a name="CmmMakeDynamicReferenceM"><a href="PIC.html#CmmMakeDynamicReferenceM"><span class="hs-identifier">CmmMakeDynamicReferenceM</span></a></a><span> </span><a name="local-6989586621684642945"><a href="#local-6989586621684642945"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-103"></a><span>    </span><a name="addImport"><a href="PIC.html#addImport"><span class="hs-identifier">addImport</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684642945"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-104"></a><span>    </span><a name="getThisModule"><a href="PIC.html#getThisModule"><span class="hs-identifier">getThisModule</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621684642945"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">Module</span><span>
</span><a name="line-105"></a><span>
</span><a name="line-106"></a><span class="hs-keyword">instance</span><span> </span><a href="PIC.html#CmmMakeDynamicReferenceM"><span class="hs-identifier hs-type">CmmMakeDynamicReferenceM</span></a><span> </span><a href="NCGMonad.html#NatM"><span class="hs-identifier hs-type">NatM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-107"></a><span>    </span><a name="local-8214565720329417839"><a href="PIC.html#addImport"><span class="hs-identifier">addImport</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="NCGMonad.html#addImportNat"><span class="hs-identifier hs-var">addImportNat</span></a><span>
</span><a name="line-108"></a><span>    </span><a name="local-8214565720329417840"><a href="PIC.html#getThisModule"><span class="hs-identifier">getThisModule</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="NCGMonad.html#getThisModuleNat"><span class="hs-identifier hs-var">getThisModuleNat</span></a><span>
</span><a name="line-109"></a><span>
</span><a name="line-110"></a><span class="hs-identifier">cmmMakeDynamicReference</span><span>
</span><a name="line-111"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="PIC.html#CmmMakeDynamicReferenceM"><span class="hs-identifier hs-type">CmmMakeDynamicReferenceM</span></a><span> </span><a href="#local-6989586621684642946"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-112"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-113"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PIC.html#ReferenceKind"><span class="hs-identifier hs-type">ReferenceKind</span></a><span>     </span><span class="hs-comment">-- whether this is the target of a jump</span><span>
</span><a name="line-114"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span>            </span><span class="hs-comment">-- the label</span><span>
</span><a name="line-115"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684642946"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>
</span><a name="line-116"></a><span>
</span><a name="line-117"></a><a name="cmmMakeDynamicReference"><a href="PIC.html#cmmMakeDynamicReference"><span class="hs-identifier">cmmMakeDynamicReference</span></a></a><span> </span><a name="local-6989586621684642947"><a href="#local-6989586621684642947"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684642948"><a href="#local-6989586621684642948"><span class="hs-identifier">referenceKind</span></a></a><span> </span><a name="local-6989586621684642949"><a href="#local-6989586621684642949"><span class="hs-identifier">lbl</span></a></a><span>
</span><a name="line-118"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CLabel.html#dynamicLinkerLabelInfo"><span class="hs-identifier hs-var">dynamicLinkerLabelInfo</span></a><span> </span><a href="#local-6989586621684642949"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-119"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmExpr.html#CmmLabel"><span class="hs-identifier hs-var">CmmLabel</span></a><span> </span><a href="#local-6989586621684642949"><span class="hs-identifier hs-var">lbl</span></a><span>   </span><span class="hs-comment">-- already processed it, pass through</span><span>
</span><a name="line-120"></a><span>
</span><a name="line-121"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-122"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621684642950"><a href="#local-6989586621684642950"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="PIC.html#getThisModule"><span class="hs-identifier hs-var">getThisModule</span></a><span>
</span><a name="line-123"></a><span>       </span><span class="hs-keyword">case</span><span> </span><a href="PIC.html#howToAccessLabel"><span class="hs-identifier hs-var">howToAccessLabel</span></a><span>
</span><a name="line-124"></a><span>                </span><a href="#local-6989586621684642947"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-125"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier">platformArch</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621684642947"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-126"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier">platformOS</span><span>   </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621684642947"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-127"></a><span>                </span><a href="#local-6989586621684642950"><span class="hs-identifier hs-var">this_mod</span></a><span>
</span><a name="line-128"></a><span>                </span><a href="#local-6989586621684642948"><span class="hs-identifier hs-var">referenceKind</span></a><span> </span><a href="#local-6989586621684642949"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-129"></a><span>
</span><a name="line-130"></a><span>        </span><a href="PIC.html#AccessViaStub"><span class="hs-identifier hs-var">AccessViaStub</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-131"></a><span>              </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684642951"><a href="#local-6989586621684642951"><span class="hs-identifier">stub</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkDynamicLinkerLabel"><span class="hs-identifier hs-var">mkDynamicLinkerLabel</span></a><span> </span><a href="CLabel.html#CodeStub"><span class="hs-identifier hs-var">CodeStub</span></a><span> </span><a href="#local-6989586621684642949"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-132"></a><span>              </span><a href="PIC.html#addImport"><span class="hs-identifier hs-var">addImport</span></a><span> </span><a href="#local-6989586621684642951"><span class="hs-identifier hs-var">stub</span></a><span>
</span><a name="line-133"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmExpr.html#CmmLabel"><span class="hs-identifier hs-var">CmmLabel</span></a><span> </span><a href="#local-6989586621684642951"><span class="hs-identifier hs-var">stub</span></a><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span>        </span><a href="PIC.html#AccessViaSymbolPtr"><span class="hs-identifier hs-var">AccessViaSymbolPtr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-136"></a><span>              </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684642952"><a href="#local-6989586621684642952"><span class="hs-identifier">symbolPtr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkDynamicLinkerLabel"><span class="hs-identifier hs-var">mkDynamicLinkerLabel</span></a><span> </span><a href="CLabel.html#SymbolPtr"><span class="hs-identifier hs-var">SymbolPtr</span></a><span> </span><a href="#local-6989586621684642949"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-137"></a><span>              </span><a href="PIC.html#addImport"><span class="hs-identifier hs-var">addImport</span></a><span> </span><a href="#local-6989586621684642952"><span class="hs-identifier hs-var">symbolPtr</span></a><span>
</span><a name="line-138"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmExpr.html#CmmLoad"><span class="hs-identifier hs-var">CmmLoad</span></a><span> </span><span class="hs-special">(</span><a href="PIC.html#cmmMakePicReference"><span class="hs-identifier hs-var">cmmMakePicReference</span></a><span> </span><a href="#local-6989586621684642947"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684642952"><span class="hs-identifier hs-var">symbolPtr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bWord</span><span> </span><a href="#local-6989586621684642947"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-139"></a><span>
</span><a name="line-140"></a><span>        </span><a href="PIC.html#AccessDirectly"><span class="hs-identifier hs-var">AccessDirectly</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684642948"><span class="hs-identifier hs-var">referenceKind</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-141"></a><span>                </span><span class="hs-comment">-- for data, we might have to make some calculations:</span><span>
</span><a name="line-142"></a><span>              </span><a href="PIC.html#DataReference"><span class="hs-identifier hs-var">DataReference</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="PIC.html#cmmMakePicReference"><span class="hs-identifier hs-var">cmmMakePicReference</span></a><span> </span><a href="#local-6989586621684642947"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684642949"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-143"></a><span>                </span><span class="hs-comment">-- all currently supported processors support</span><span>
</span><a name="line-144"></a><span>                </span><span class="hs-comment">-- PC-relative branch and call instructions,</span><span>
</span><a name="line-145"></a><span>                </span><span class="hs-comment">-- so just jump there if it's a call or a jump</span><span>
</span><a name="line-146"></a><span>              </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmExpr.html#CmmLabel"><span class="hs-identifier hs-var">CmmLabel</span></a><span> </span><a href="#local-6989586621684642949"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-147"></a><span>
</span><a name="line-148"></a><span>
</span><a name="line-149"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-150"></a><span class="hs-comment">-- Create a position independent reference to a label.</span><span>
</span><a name="line-151"></a><span class="hs-comment">-- (but do not bother with dynamic linking).</span><span>
</span><a name="line-152"></a><span class="hs-comment">-- We calculate the label's address by adding some (platform-dependent)</span><span>
</span><a name="line-153"></a><span class="hs-comment">-- offset to our base register; this offset is calculated by</span><span>
</span><a name="line-154"></a><span class="hs-comment">-- the function picRelative in the platform-dependent part below.</span><span>
</span><a name="line-155"></a><span>
</span><a name="line-156"></a><span class="hs-identifier">cmmMakePicReference</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>
</span><a name="line-157"></a><a name="cmmMakePicReference"><a href="PIC.html#cmmMakePicReference"><span class="hs-identifier">cmmMakePicReference</span></a></a><span> </span><a name="local-6989586621684642953"><a href="#local-6989586621684642953"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684642954"><a href="#local-6989586621684642954"><span class="hs-identifier">lbl</span></a></a><span>
</span><a name="line-158"></a><span>
</span><a name="line-159"></a><span>        </span><span class="hs-comment">-- Windows doesn't need PIC,</span><span>
</span><a name="line-160"></a><span>        </span><span class="hs-comment">-- everything gets relocated at runtime</span><span>
</span><a name="line-161"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">OSMinGW32</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">platformOS</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621684642953"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-162"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmExpr.html#CmmLabel"><span class="hs-identifier hs-var">CmmLabel</span></a><span> </span><a href="#local-6989586621684642954"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-163"></a><span>
</span><a name="line-164"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">OSAIX</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">platformOS</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621684642953"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-165"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#CmmMachOp"><span class="hs-identifier hs-var">CmmMachOp</span></a><span> </span><span class="hs-special">(</span><a href="CmmMachOp.html#MO_Add"><span class="hs-identifier hs-var">MO_Add</span></a><span> </span><span class="hs-identifier hs-var">W32</span><span class="hs-special">)</span><span>
</span><a name="line-166"></a><span>                </span><span class="hs-special">[</span><span> </span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmGlobal"><span class="hs-identifier hs-var">CmmGlobal</span></a><span> </span><a href="CmmExpr.html#PicBaseReg"><span class="hs-identifier hs-var">PicBaseReg</span></a><span class="hs-special">)</span><span>
</span><a name="line-167"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="PIC.html#picRelative"><span class="hs-identifier hs-var">picRelative</span></a><span> </span><a href="#local-6989586621684642953"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-168"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier">platformArch</span><span>   </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621684642953"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-169"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier">platformOS</span><span>     </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621684642953"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-170"></a><span>                                </span><a href="#local-6989586621684642954"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-171"></a><span>
</span><a name="line-172"></a><span>        </span><span class="hs-comment">-- both ABI versions default to medium code model</span><span>
</span><a name="line-173"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">ArchPPC_64</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">platformArch</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621684642953"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-174"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#CmmMachOp"><span class="hs-identifier hs-var">CmmMachOp</span></a><span> </span><span class="hs-special">(</span><a href="CmmMachOp.html#MO_Add"><span class="hs-identifier hs-var">MO_Add</span></a><span> </span><span class="hs-identifier hs-var">W32</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- code model medium</span><span>
</span><a name="line-175"></a><span>                </span><span class="hs-special">[</span><span> </span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmGlobal"><span class="hs-identifier hs-var">CmmGlobal</span></a><span> </span><a href="CmmExpr.html#PicBaseReg"><span class="hs-identifier hs-var">PicBaseReg</span></a><span class="hs-special">)</span><span>
</span><a name="line-176"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="PIC.html#picRelative"><span class="hs-identifier hs-var">picRelative</span></a><span> </span><a href="#local-6989586621684642953"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-177"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier">platformArch</span><span>   </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621684642953"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-178"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier">platformOS</span><span>     </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621684642953"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-179"></a><span>                                </span><a href="#local-6989586621684642954"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-180"></a><span>
</span><a name="line-181"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">positionIndependent</span><span> </span><a href="#local-6989586621684642953"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_ExternalDynamicRefs</span><span> </span><a href="#local-6989586621684642953"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-182"></a><span>            </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="PIC.html#absoluteLabel"><span class="hs-identifier hs-var">absoluteLabel</span></a><span> </span><a href="#local-6989586621684642954"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-183"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#CmmMachOp"><span class="hs-identifier hs-var">CmmMachOp</span></a><span> </span><span class="hs-special">(</span><a href="CmmMachOp.html#MO_Add"><span class="hs-identifier hs-var">MO_Add</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wordWidth</span><span> </span><a href="#local-6989586621684642953"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-184"></a><span>                </span><span class="hs-special">[</span><span> </span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmGlobal"><span class="hs-identifier hs-var">CmmGlobal</span></a><span> </span><a href="CmmExpr.html#PicBaseReg"><span class="hs-identifier hs-var">PicBaseReg</span></a><span class="hs-special">)</span><span>
</span><a name="line-185"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="PIC.html#picRelative"><span class="hs-identifier hs-var">picRelative</span></a><span> </span><a href="#local-6989586621684642953"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-186"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier">platformArch</span><span>   </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621684642953"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-187"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier">platformOS</span><span>     </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621684642953"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-188"></a><span>                                </span><a href="#local-6989586621684642954"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-189"></a><span>
</span><a name="line-190"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-191"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmExpr.html#CmmLabel"><span class="hs-identifier hs-var">CmmLabel</span></a><span> </span><a href="#local-6989586621684642954"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span>
</span><a name="line-194"></a><span class="hs-identifier">absoluteLabel</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-195"></a><a name="absoluteLabel"><a href="PIC.html#absoluteLabel"><span class="hs-identifier">absoluteLabel</span></a></a><span> </span><a name="local-6989586621684642955"><a href="#local-6989586621684642955"><span class="hs-identifier">lbl</span></a></a><span>
</span><a name="line-196"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="CLabel.html#dynamicLinkerLabelInfo"><span class="hs-identifier hs-var">dynamicLinkerLabelInfo</span></a><span> </span><a href="#local-6989586621684642955"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-197"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="CLabel.html#GotSymbolPtr"><span class="hs-identifier hs-var">GotSymbolPtr</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-198"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="CLabel.html#GotSymbolOffset"><span class="hs-identifier hs-var">GotSymbolOffset</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-199"></a><span>        </span><span class="hs-identifier">_</span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-200"></a><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-203"></a><span class="hs-comment">-- Knowledge about how special dynamic linker labels like symbol</span><span>
</span><a name="line-204"></a><span class="hs-comment">-- pointers, code stubs and GOT offsets look like is located in the</span><span>
</span><a name="line-205"></a><span class="hs-comment">-- module CLabel.</span><span>
</span><a name="line-206"></a><span>
</span><a name="line-207"></a><span class="hs-comment">-- We have to decide which labels need to be accessed</span><span>
</span><a name="line-208"></a><span class="hs-comment">-- indirectly or via a piece of stub code.</span><span>
</span><a name="line-209"></a><span class="hs-keyword">data</span><span> </span><a name="LabelAccessStyle"><a href="PIC.html#LabelAccessStyle"><span class="hs-identifier">LabelAccessStyle</span></a></a><span>
</span><a name="line-210"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a name="AccessViaStub"><a href="PIC.html#AccessViaStub"><span class="hs-identifier">AccessViaStub</span></a></a><span>
</span><a name="line-211"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a name="AccessViaSymbolPtr"><a href="PIC.html#AccessViaSymbolPtr"><span class="hs-identifier">AccessViaSymbolPtr</span></a></a><span>
</span><a name="line-212"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a name="AccessDirectly"><a href="PIC.html#AccessDirectly"><span class="hs-identifier">AccessDirectly</span></a></a><span>
</span><a name="line-213"></a><span>
</span><a name="line-214"></a><span class="hs-identifier">howToAccessLabel</span><span>
</span><a name="line-215"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Arch</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OS</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PIC.html#ReferenceKind"><span class="hs-identifier hs-type">ReferenceKind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PIC.html#LabelAccessStyle"><span class="hs-identifier hs-type">LabelAccessStyle</span></a><span>
</span><a name="line-216"></a><span>
</span><a name="line-217"></a><span>
</span><a name="line-218"></a><span class="hs-comment">-- Windows</span><span>
</span><a name="line-219"></a><span class="hs-comment">-- In Windows speak, a &quot;module&quot; is a set of objects linked into the</span><span>
</span><a name="line-220"></a><span class="hs-comment">-- same Portable Exectuable (PE) file. (both .exe and .dll files are PEs).</span><span>
</span><a name="line-221"></a><span class="hs-comment">--</span><span>
</span><a name="line-222"></a><span class="hs-comment">-- If we're compiling a multi-module program then symbols from other modules</span><span>
</span><a name="line-223"></a><span class="hs-comment">-- are accessed by a symbol pointer named __imp_SYMBOL. At runtime we have the</span><span>
</span><a name="line-224"></a><span class="hs-comment">-- following.</span><span>
</span><a name="line-225"></a><span class="hs-comment">--</span><span>
</span><a name="line-226"></a><span class="hs-comment">--   (in the local module)</span><span>
</span><a name="line-227"></a><span class="hs-comment">--     __imp_SYMBOL: addr of SYMBOL</span><span>
</span><a name="line-228"></a><span class="hs-comment">--</span><span>
</span><a name="line-229"></a><span class="hs-comment">--   (in the other module)</span><span>
</span><a name="line-230"></a><span class="hs-comment">--     SYMBOL: the real function / data.</span><span>
</span><a name="line-231"></a><span class="hs-comment">--</span><span>
</span><a name="line-232"></a><span class="hs-comment">-- To access the function at SYMBOL from our local module, we just need to</span><span>
</span><a name="line-233"></a><span class="hs-comment">-- dereference the local __imp_SYMBOL.</span><span>
</span><a name="line-234"></a><span class="hs-comment">--</span><span>
</span><a name="line-235"></a><span class="hs-comment">-- If not compiling with -dynamic we assume that all our code will be linked</span><span>
</span><a name="line-236"></a><span class="hs-comment">-- into the same .exe file. In this case we always access symbols directly,</span><span>
</span><a name="line-237"></a><span class="hs-comment">-- and never use __imp_SYMBOL.</span><span>
</span><a name="line-238"></a><span class="hs-comment">--</span><span>
</span><a name="line-239"></a><a name="howToAccessLabel"><a href="PIC.html#howToAccessLabel"><span class="hs-identifier">howToAccessLabel</span></a></a><span> </span><a name="local-6989586621684642956"><a href="#local-6989586621684642956"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">OSMinGW32</span><span> </span><a name="local-6989586621684642957"><a href="#local-6989586621684642957"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684642958"><a href="#local-6989586621684642958"><span class="hs-identifier">lbl</span></a></a><span>
</span><a name="line-240"></a><span>
</span><a name="line-241"></a><span>        </span><span class="hs-comment">-- Assume all symbols will be in the same PE, so just access them directly.</span><span>
</span><a name="line-242"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_ExternalDynamicRefs</span><span> </span><a href="#local-6989586621684642956"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-243"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="PIC.html#AccessDirectly"><span class="hs-identifier hs-var">AccessDirectly</span></a><span>
</span><a name="line-244"></a><span>
</span><a name="line-245"></a><span>        </span><span class="hs-comment">-- If the target symbol is in another PE we need to access it via the</span><span>
</span><a name="line-246"></a><span>        </span><span class="hs-comment">--      appropriate __imp_SYMBOL pointer.</span><span>
</span><a name="line-247"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="CLabel.html#labelDynamic"><span class="hs-identifier hs-var">labelDynamic</span></a><span> </span><a href="#local-6989586621684642956"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684642957"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684642958"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-248"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="PIC.html#AccessViaSymbolPtr"><span class="hs-identifier hs-var">AccessViaSymbolPtr</span></a><span>
</span><a name="line-249"></a><span>
</span><a name="line-250"></a><span>        </span><span class="hs-comment">-- Target symbol is in the same PE as the caller, so just access it directly.</span><span>
</span><a name="line-251"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-252"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="PIC.html#AccessDirectly"><span class="hs-identifier hs-var">AccessDirectly</span></a><span>
</span><a name="line-253"></a><span>
</span><a name="line-254"></a><span>
</span><a name="line-255"></a><span class="hs-comment">-- Mach-O (Darwin, Mac OS X)</span><span>
</span><a name="line-256"></a><span class="hs-comment">--</span><span>
</span><a name="line-257"></a><span class="hs-comment">-- Indirect access is required in the following cases:</span><span>
</span><a name="line-258"></a><span class="hs-comment">--  * things imported from a dynamic library</span><span>
</span><a name="line-259"></a><span class="hs-comment">--  * (not on x86_64) data from a different module, if we're generating PIC code</span><span>
</span><a name="line-260"></a><span class="hs-comment">-- It is always possible to access something indirectly,</span><span>
</span><a name="line-261"></a><span class="hs-comment">-- even when it's not necessary.</span><span>
</span><a name="line-262"></a><span class="hs-comment">--</span><span>
</span><a name="line-263"></a><span class="hs-identifier">howToAccessLabel</span><span> </span><a name="local-6989586621684642959"><a href="#local-6989586621684642959"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684642960"><a href="#local-6989586621684642960"><span class="hs-identifier">arch</span></a></a><span> </span><span class="hs-identifier hs-var">OSDarwin</span><span> </span><a name="local-6989586621684642961"><a href="#local-6989586621684642961"><span class="hs-identifier">this_mod</span></a></a><span> </span><a href="PIC.html#DataReference"><span class="hs-identifier hs-var">DataReference</span></a><span> </span><a name="local-6989586621684642962"><a href="#local-6989586621684642962"><span class="hs-identifier">lbl</span></a></a><span>
</span><a name="line-264"></a><span>        </span><span class="hs-comment">-- data access to a dynamic library goes via a symbol pointer</span><span>
</span><a name="line-265"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="CLabel.html#labelDynamic"><span class="hs-identifier hs-var">labelDynamic</span></a><span> </span><a href="#local-6989586621684642959"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684642961"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684642962"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-266"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="PIC.html#AccessViaSymbolPtr"><span class="hs-identifier hs-var">AccessViaSymbolPtr</span></a><span>
</span><a name="line-267"></a><span>
</span><a name="line-268"></a><span>        </span><span class="hs-comment">-- when generating PIC code, all cross-module data references must</span><span>
</span><a name="line-269"></a><span>        </span><span class="hs-comment">-- must go via a symbol pointer, too, because the assembler</span><span>
</span><a name="line-270"></a><span>        </span><span class="hs-comment">-- cannot generate code for a label difference where one</span><span>
</span><a name="line-271"></a><span>        </span><span class="hs-comment">-- label is undefined. Doesn't apply t x86_64.</span><span>
</span><a name="line-272"></a><span>        </span><span class="hs-comment">-- Unfortunately, we don't know whether it's cross-module,</span><span>
</span><a name="line-273"></a><span>        </span><span class="hs-comment">-- so we do it for all externally visible labels.</span><span>
</span><a name="line-274"></a><span>        </span><span class="hs-comment">-- This is a slight waste of time and space, but otherwise</span><span>
</span><a name="line-275"></a><span>        </span><span class="hs-comment">-- we'd need to pass the current Module all the way in to</span><span>
</span><a name="line-276"></a><span>        </span><span class="hs-comment">-- this function.</span><span>
</span><a name="line-277"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684642960"><span class="hs-identifier hs-var">arch</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">ArchX86_64</span><span>
</span><a name="line-278"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">positionIndependent</span><span> </span><a href="#local-6989586621684642959"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="CLabel.html#externallyVisibleCLabel"><span class="hs-identifier hs-var">externallyVisibleCLabel</span></a><span> </span><a href="#local-6989586621684642962"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-279"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="PIC.html#AccessViaSymbolPtr"><span class="hs-identifier hs-var">AccessViaSymbolPtr</span></a><span>
</span><a name="line-280"></a><span>
</span><a name="line-281"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-282"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="PIC.html#AccessDirectly"><span class="hs-identifier hs-var">AccessDirectly</span></a><span>
</span><a name="line-283"></a><span>
</span><a name="line-284"></a><span class="hs-identifier">howToAccessLabel</span><span> </span><a name="local-6989586621684642963"><a href="#local-6989586621684642963"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684642964"><a href="#local-6989586621684642964"><span class="hs-identifier">arch</span></a></a><span> </span><span class="hs-identifier hs-var">OSDarwin</span><span> </span><a name="local-6989586621684642965"><a href="#local-6989586621684642965"><span class="hs-identifier">this_mod</span></a></a><span> </span><a href="PIC.html#JumpReference"><span class="hs-identifier hs-var">JumpReference</span></a><span> </span><a name="local-6989586621684642966"><a href="#local-6989586621684642966"><span class="hs-identifier">lbl</span></a></a><span>
</span><a name="line-285"></a><span>        </span><span class="hs-comment">-- dyld code stubs don't work for tailcalls because the</span><span>
</span><a name="line-286"></a><span>        </span><span class="hs-comment">-- stack alignment is only right for regular calls.</span><span>
</span><a name="line-287"></a><span>        </span><span class="hs-comment">-- Therefore, we have to go via a symbol pointer:</span><span>
</span><a name="line-288"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684642964"><span class="hs-identifier hs-var">arch</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">ArchX86</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621684642964"><span class="hs-identifier hs-var">arch</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">ArchX86_64</span><span>
</span><a name="line-289"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="CLabel.html#labelDynamic"><span class="hs-identifier hs-var">labelDynamic</span></a><span> </span><a href="#local-6989586621684642963"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684642965"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684642966"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-290"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="PIC.html#AccessViaSymbolPtr"><span class="hs-identifier hs-var">AccessViaSymbolPtr</span></a><span>
</span><a name="line-291"></a><span>
</span><a name="line-292"></a><span>
</span><a name="line-293"></a><span class="hs-identifier">howToAccessLabel</span><span> </span><a name="local-6989586621684642967"><a href="#local-6989586621684642967"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684642968"><a href="#local-6989586621684642968"><span class="hs-identifier">arch</span></a></a><span> </span><span class="hs-identifier hs-var">OSDarwin</span><span> </span><a name="local-6989586621684642969"><a href="#local-6989586621684642969"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684642970"><a href="#local-6989586621684642970"><span class="hs-identifier">lbl</span></a></a><span>
</span><a name="line-294"></a><span>        </span><span class="hs-comment">-- Code stubs are the usual method of choice for imported code;</span><span>
</span><a name="line-295"></a><span>        </span><span class="hs-comment">-- not needed on x86_64 because Apple's new linker, ld64, generates</span><span>
</span><a name="line-296"></a><span>        </span><span class="hs-comment">-- them automatically.</span><span>
</span><a name="line-297"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684642968"><span class="hs-identifier hs-var">arch</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">ArchX86_64</span><span>
</span><a name="line-298"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="CLabel.html#labelDynamic"><span class="hs-identifier hs-var">labelDynamic</span></a><span> </span><a href="#local-6989586621684642967"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684642969"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684642970"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-299"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="PIC.html#AccessViaStub"><span class="hs-identifier hs-var">AccessViaStub</span></a><span>
</span><a name="line-300"></a><span>
</span><a name="line-301"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-302"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="PIC.html#AccessDirectly"><span class="hs-identifier hs-var">AccessDirectly</span></a><span>
</span><a name="line-303"></a><span>
</span><a name="line-304"></a><span>
</span><a name="line-305"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-306"></a><span class="hs-comment">-- AIX</span><span>
</span><a name="line-307"></a><span>
</span><a name="line-308"></a><span class="hs-comment">-- quite simple (for now)</span><span>
</span><a name="line-309"></a><span class="hs-identifier">howToAccessLabel</span><span> </span><a name="local-6989586621684642971"><a href="#local-6989586621684642971"><span class="hs-identifier">_dflags</span></a></a><span> </span><a name="local-6989586621684642972"><a href="#local-6989586621684642972"><span class="hs-identifier">_arch</span></a></a><span> </span><span class="hs-identifier hs-var">OSAIX</span><span> </span><a name="local-6989586621684642973"><a href="#local-6989586621684642973"><span class="hs-identifier">_this_mod</span></a></a><span> </span><a name="local-6989586621684642974"><a href="#local-6989586621684642974"><span class="hs-identifier">kind</span></a></a><span> </span><a name="local-6989586621684642975"><a href="#local-6989586621684642975"><span class="hs-identifier">_lbl</span></a></a><span>
</span><a name="line-310"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684642974"><span class="hs-identifier hs-var">kind</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-311"></a><span>            </span><a href="PIC.html#DataReference"><span class="hs-identifier hs-var">DataReference</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PIC.html#AccessViaSymbolPtr"><span class="hs-identifier hs-var">AccessViaSymbolPtr</span></a><span>
</span><a name="line-312"></a><span>            </span><a href="PIC.html#CallReference"><span class="hs-identifier hs-var">CallReference</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PIC.html#AccessDirectly"><span class="hs-identifier hs-var">AccessDirectly</span></a><span>
</span><a name="line-313"></a><span>            </span><a href="PIC.html#JumpReference"><span class="hs-identifier hs-var">JumpReference</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PIC.html#AccessDirectly"><span class="hs-identifier hs-var">AccessDirectly</span></a><span>
</span><a name="line-314"></a><span>
</span><a name="line-315"></a><span class="hs-comment">-- ELF (Linux)</span><span>
</span><a name="line-316"></a><span class="hs-comment">--</span><span>
</span><a name="line-317"></a><span class="hs-comment">-- ELF tries to pretend to the main application code that dynamic linking does</span><span>
</span><a name="line-318"></a><span class="hs-comment">-- not exist. While this may sound convenient, it tends to mess things up in</span><span>
</span><a name="line-319"></a><span class="hs-comment">-- very bad ways, so we have to be careful when we generate code for a non-PIE</span><span>
</span><a name="line-320"></a><span class="hs-comment">-- main program (-dynamic but no -fPIC).</span><span>
</span><a name="line-321"></a><span class="hs-comment">--</span><span>
</span><a name="line-322"></a><span class="hs-comment">-- Indirect access is required for references to imported symbols</span><span>
</span><a name="line-323"></a><span class="hs-comment">-- from position independent code. It is also required from the main program</span><span>
</span><a name="line-324"></a><span class="hs-comment">-- when dynamic libraries containing Haskell code are used.</span><span>
</span><a name="line-325"></a><span>
</span><a name="line-326"></a><span class="hs-identifier">howToAccessLabel</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ArchPPC_64</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684642976"><a href="#local-6989586621684642976"><span class="hs-identifier">os</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684642977"><a href="#local-6989586621684642977"><span class="hs-identifier">kind</span></a></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-327"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">osElfTarget</span><span> </span><a href="#local-6989586621684642976"><span class="hs-identifier hs-var">os</span></a><span>
</span><a name="line-328"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684642977"><span class="hs-identifier hs-var">kind</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-329"></a><span>          </span><span class="hs-comment">-- ELF PPC64 (powerpc64-linux), AIX, MacOS 9, BeOS/PPC</span><span>
</span><a name="line-330"></a><span>          </span><a href="PIC.html#DataReference"><span class="hs-identifier hs-var">DataReference</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PIC.html#AccessViaSymbolPtr"><span class="hs-identifier hs-var">AccessViaSymbolPtr</span></a><span>
</span><a name="line-331"></a><span>          </span><span class="hs-comment">-- RTLD does not generate stubs for function descriptors</span><span>
</span><a name="line-332"></a><span>          </span><span class="hs-comment">-- in tail calls. Create a symbol pointer and generate</span><span>
</span><a name="line-333"></a><span>          </span><span class="hs-comment">-- the code to load the function descriptor at the call site.</span><span>
</span><a name="line-334"></a><span>          </span><a href="PIC.html#JumpReference"><span class="hs-identifier hs-var">JumpReference</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PIC.html#AccessViaSymbolPtr"><span class="hs-identifier hs-var">AccessViaSymbolPtr</span></a><span>
</span><a name="line-335"></a><span>          </span><span class="hs-comment">-- regular calls are handled by the runtime linker</span><span>
</span><a name="line-336"></a><span>          </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PIC.html#AccessDirectly"><span class="hs-identifier hs-var">AccessDirectly</span></a><span>
</span><a name="line-337"></a><span>
</span><a name="line-338"></a><span class="hs-identifier">howToAccessLabel</span><span> </span><a name="local-6989586621684642978"><a href="#local-6989586621684642978"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684642979"><a href="#local-6989586621684642979"><span class="hs-identifier">os</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-339"></a><span>        </span><span class="hs-comment">-- no PIC -&gt; the dynamic linker does everything for us;</span><span>
</span><a name="line-340"></a><span>        </span><span class="hs-comment">--           if we don't dynamically link to Haskell code,</span><span>
</span><a name="line-341"></a><span>        </span><span class="hs-comment">--           it actually manages to do so without messing things up.</span><span>
</span><a name="line-342"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">osElfTarget</span><span> </span><a href="#local-6989586621684642979"><span class="hs-identifier hs-var">os</span></a><span>
</span><a name="line-343"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">positionIndependent</span><span> </span><a href="#local-6989586621684642978"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-344"></a><span>          </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_ExternalDynamicRefs</span><span> </span><a href="#local-6989586621684642978"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-345"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="PIC.html#AccessDirectly"><span class="hs-identifier hs-var">AccessDirectly</span></a><span>
</span><a name="line-346"></a><span>
</span><a name="line-347"></a><span class="hs-identifier">howToAccessLabel</span><span> </span><a name="local-6989586621684642980"><a href="#local-6989586621684642980"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684642981"><a href="#local-6989586621684642981"><span class="hs-identifier">arch</span></a></a><span> </span><a name="local-6989586621684642982"><a href="#local-6989586621684642982"><span class="hs-identifier">os</span></a></a><span> </span><a name="local-6989586621684642983"><a href="#local-6989586621684642983"><span class="hs-identifier">this_mod</span></a></a><span> </span><a href="PIC.html#DataReference"><span class="hs-identifier hs-var">DataReference</span></a><span> </span><a name="local-6989586621684642984"><a href="#local-6989586621684642984"><span class="hs-identifier">lbl</span></a></a><span>
</span><a name="line-348"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">osElfTarget</span><span> </span><a href="#local-6989586621684642982"><span class="hs-identifier hs-var">os</span></a><span>
</span><a name="line-349"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-350"></a><span>            </span><span class="hs-comment">-- A dynamic label needs to be accessed via a symbol pointer.</span><span>
</span><a name="line-351"></a><span>          </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="CLabel.html#labelDynamic"><span class="hs-identifier hs-var">labelDynamic</span></a><span> </span><a href="#local-6989586621684642980"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684642983"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684642984"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-352"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PIC.html#AccessViaSymbolPtr"><span class="hs-identifier hs-var">AccessViaSymbolPtr</span></a><span>
</span><a name="line-353"></a><span>
</span><a name="line-354"></a><span>            </span><span class="hs-comment">-- For PowerPC32 -fPIC, we have to access even static data</span><span>
</span><a name="line-355"></a><span>            </span><span class="hs-comment">-- via a symbol pointer (see below for an explanation why</span><span>
</span><a name="line-356"></a><span>            </span><span class="hs-comment">-- PowerPC32 Linux is especially broken).</span><span>
</span><a name="line-357"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684642981"><span class="hs-identifier hs-var">arch</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">ArchPPC</span><span>
</span><a name="line-358"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">positionIndependent</span><span> </span><a href="#local-6989586621684642980"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-359"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PIC.html#AccessViaSymbolPtr"><span class="hs-identifier hs-var">AccessViaSymbolPtr</span></a><span>
</span><a name="line-360"></a><span>
</span><a name="line-361"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-362"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PIC.html#AccessDirectly"><span class="hs-identifier hs-var">AccessDirectly</span></a><span>
</span><a name="line-363"></a><span>
</span><a name="line-364"></a><span>
</span><a name="line-365"></a><span>        </span><span class="hs-comment">-- In most cases, we have to avoid symbol stubs on ELF, for the following reasons:</span><span>
</span><a name="line-366"></a><span>        </span><span class="hs-comment">--   on i386, the position-independent symbol stubs in the Procedure Linkage Table</span><span>
</span><a name="line-367"></a><span>        </span><span class="hs-comment">--   require the address of the GOT to be loaded into register %ebx on entry.</span><span>
</span><a name="line-368"></a><span>        </span><span class="hs-comment">--   The linker will take any reference to the symbol stub as a hint that</span><span>
</span><a name="line-369"></a><span>        </span><span class="hs-comment">--   the label in question is a code label. When linking executables, this</span><span>
</span><a name="line-370"></a><span>        </span><span class="hs-comment">--   will cause the linker to replace even data references to the label with</span><span>
</span><a name="line-371"></a><span>        </span><span class="hs-comment">--   references to the symbol stub.</span><span>
</span><a name="line-372"></a><span>
</span><a name="line-373"></a><span>        </span><span class="hs-comment">-- This leaves calling a (foreign) function from non-PIC code</span><span>
</span><a name="line-374"></a><span>        </span><span class="hs-comment">-- (AccessDirectly, because we get an implicit symbol stub)</span><span>
</span><a name="line-375"></a><span>        </span><span class="hs-comment">-- and calling functions from PIC code on non-i386 platforms (via a symbol stub)</span><span>
</span><a name="line-376"></a><span>
</span><a name="line-377"></a><span class="hs-identifier">howToAccessLabel</span><span> </span><a name="local-6989586621684642985"><a href="#local-6989586621684642985"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684642986"><a href="#local-6989586621684642986"><span class="hs-identifier">arch</span></a></a><span> </span><a name="local-6989586621684642987"><a href="#local-6989586621684642987"><span class="hs-identifier">os</span></a></a><span> </span><a name="local-6989586621684642988"><a href="#local-6989586621684642988"><span class="hs-identifier">this_mod</span></a></a><span> </span><a href="PIC.html#CallReference"><span class="hs-identifier hs-var">CallReference</span></a><span> </span><a name="local-6989586621684642989"><a href="#local-6989586621684642989"><span class="hs-identifier">lbl</span></a></a><span>
</span><a name="line-378"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">osElfTarget</span><span> </span><a href="#local-6989586621684642987"><span class="hs-identifier hs-var">os</span></a><span>
</span><a name="line-379"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="CLabel.html#labelDynamic"><span class="hs-identifier hs-var">labelDynamic</span></a><span> </span><a href="#local-6989586621684642985"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684642988"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684642989"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">positionIndependent</span><span> </span><a href="#local-6989586621684642985"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-380"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="PIC.html#AccessDirectly"><span class="hs-identifier hs-var">AccessDirectly</span></a><span>
</span><a name="line-381"></a><span>
</span><a name="line-382"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">osElfTarget</span><span> </span><a href="#local-6989586621684642987"><span class="hs-identifier hs-var">os</span></a><span>
</span><a name="line-383"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684642986"><span class="hs-identifier hs-var">arch</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">ArchX86</span><span>
</span><a name="line-384"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="CLabel.html#labelDynamic"><span class="hs-identifier hs-var">labelDynamic</span></a><span> </span><a href="#local-6989586621684642985"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684642988"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684642989"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-385"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">positionIndependent</span><span> </span><a href="#local-6989586621684642985"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-386"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="PIC.html#AccessViaStub"><span class="hs-identifier hs-var">AccessViaStub</span></a><span>
</span><a name="line-387"></a><span>
</span><a name="line-388"></a><span class="hs-identifier">howToAccessLabel</span><span> </span><a name="local-6989586621684642990"><a href="#local-6989586621684642990"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684642991"><a href="#local-6989586621684642991"><span class="hs-identifier">os</span></a></a><span> </span><a name="local-6989586621684642992"><a href="#local-6989586621684642992"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684642993"><a href="#local-6989586621684642993"><span class="hs-identifier">lbl</span></a></a><span>
</span><a name="line-389"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">osElfTarget</span><span> </span><a href="#local-6989586621684642991"><span class="hs-identifier hs-var">os</span></a><span>
</span><a name="line-390"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="CLabel.html#labelDynamic"><span class="hs-identifier hs-var">labelDynamic</span></a><span> </span><a href="#local-6989586621684642990"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684642992"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684642993"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-391"></a><span>            </span><span class="hs-keyword">then</span><span> </span><a href="PIC.html#AccessViaSymbolPtr"><span class="hs-identifier hs-var">AccessViaSymbolPtr</span></a><span>
</span><a name="line-392"></a><span>            </span><span class="hs-keyword">else</span><span> </span><a href="PIC.html#AccessDirectly"><span class="hs-identifier hs-var">AccessDirectly</span></a><span>
</span><a name="line-393"></a><span>
</span><a name="line-394"></a><span class="hs-comment">-- all other platforms</span><span>
</span><a name="line-395"></a><span class="hs-identifier">howToAccessLabel</span><span> </span><a name="local-6989586621684642994"><a href="#local-6989586621684642994"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-396"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">positionIndependent</span><span> </span><a href="#local-6989586621684642994"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-397"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="PIC.html#AccessDirectly"><span class="hs-identifier hs-var">AccessDirectly</span></a><span>
</span><a name="line-398"></a><span>
</span><a name="line-399"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-400"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;howToAccessLabel: PIC not defined for this platform&quot;</span><span>
</span><a name="line-401"></a><span>
</span><a name="line-402"></a><span>
</span><a name="line-403"></a><span>
</span><a name="line-404"></a><span class="hs-comment">-- -------------------------------------------------------------------</span><span>
</span><a name="line-405"></a><span class="hs-comment">-- | Says what we have to add to our 'PIC base register' in order to</span><span>
</span><a name="line-406"></a><span class="hs-comment">--      get the address of a label.</span><span>
</span><a name="line-407"></a><span>
</span><a name="line-408"></a><span class="hs-identifier">picRelative</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Arch</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OS</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-type">CmmLit</span></a><span>
</span><a name="line-409"></a><span>
</span><a name="line-410"></a><span class="hs-comment">-- Darwin, but not x86_64:</span><span>
</span><a name="line-411"></a><span class="hs-comment">-- The PIC base register points to the PIC base label at the beginning</span><span>
</span><a name="line-412"></a><span class="hs-comment">-- of the current CmmDecl. We just have to use a label difference to</span><span>
</span><a name="line-413"></a><span class="hs-comment">-- get the offset.</span><span>
</span><a name="line-414"></a><span class="hs-comment">-- We have already made sure that all labels that are not from the current</span><span>
</span><a name="line-415"></a><span class="hs-comment">-- module are accessed indirectly ('as' can't calculate differences between</span><span>
</span><a name="line-416"></a><span class="hs-comment">-- undefined labels).</span><span>
</span><a name="line-417"></a><a name="picRelative"><a href="PIC.html#picRelative"><span class="hs-identifier">picRelative</span></a></a><span> </span><a name="local-6989586621684642995"><a href="#local-6989586621684642995"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684642996"><a href="#local-6989586621684642996"><span class="hs-identifier">arch</span></a></a><span> </span><span class="hs-identifier hs-var">OSDarwin</span><span> </span><a name="local-6989586621684642997"><a href="#local-6989586621684642997"><span class="hs-identifier">lbl</span></a></a><span>
</span><a name="line-418"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684642996"><span class="hs-identifier hs-var">arch</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">ArchX86_64</span><span>
</span><a name="line-419"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#CmmLabelDiffOff"><span class="hs-identifier hs-var">CmmLabelDiffOff</span></a><span> </span><a href="#local-6989586621684642997"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="CLabel.html#mkPicBaseLabel"><span class="hs-identifier hs-var">mkPicBaseLabel</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wordWidth</span><span> </span><a href="#local-6989586621684642995"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-420"></a><span>
</span><a name="line-421"></a><span class="hs-comment">-- On AIX we use an indirect local TOC anchored by 'gotLabel'.</span><span>
</span><a name="line-422"></a><span class="hs-comment">-- This way we use up only one global TOC entry per compilation-unit</span><span>
</span><a name="line-423"></a><span class="hs-comment">-- (this is quite similiar to GCC's @-mminimal-toc@ compilation mode)</span><span>
</span><a name="line-424"></a><span class="hs-identifier">picRelative</span><span> </span><a name="local-6989586621684642998"><a href="#local-6989586621684642998"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">OSAIX</span><span> </span><a name="local-6989586621684642999"><a href="#local-6989586621684642999"><span class="hs-identifier">lbl</span></a></a><span>
</span><a name="line-425"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#CmmLabelDiffOff"><span class="hs-identifier hs-var">CmmLabelDiffOff</span></a><span> </span><a href="#local-6989586621684642999"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="PIC.html#gotLabel"><span class="hs-identifier hs-var">gotLabel</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wordWidth</span><span> </span><a href="#local-6989586621684642998"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-426"></a><span>
</span><a name="line-427"></a><span class="hs-comment">-- PowerPC Linux:</span><span>
</span><a name="line-428"></a><span class="hs-comment">-- The PIC base register points to our fake GOT. Use a label difference</span><span>
</span><a name="line-429"></a><span class="hs-comment">-- to get the offset.</span><span>
</span><a name="line-430"></a><span class="hs-comment">-- We have made sure that *everything* is accessed indirectly, so this</span><span>
</span><a name="line-431"></a><span class="hs-comment">-- is only used for offsets from the GOT to symbol pointers inside the</span><span>
</span><a name="line-432"></a><span class="hs-comment">-- GOT.</span><span>
</span><a name="line-433"></a><span class="hs-identifier">picRelative</span><span> </span><a name="local-6989586621684643000"><a href="#local-6989586621684643000"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-identifier hs-var">ArchPPC</span><span> </span><a name="local-6989586621684643001"><a href="#local-6989586621684643001"><span class="hs-identifier">os</span></a></a><span> </span><a name="local-6989586621684643002"><a href="#local-6989586621684643002"><span class="hs-identifier">lbl</span></a></a><span>
</span><a name="line-434"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">osElfTarget</span><span> </span><a href="#local-6989586621684643001"><span class="hs-identifier hs-var">os</span></a><span>
</span><a name="line-435"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#CmmLabelDiffOff"><span class="hs-identifier hs-var">CmmLabelDiffOff</span></a><span> </span><a href="#local-6989586621684643002"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="PIC.html#gotLabel"><span class="hs-identifier hs-var">gotLabel</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wordWidth</span><span> </span><a href="#local-6989586621684643000"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-436"></a><span>
</span><a name="line-437"></a><span>
</span><a name="line-438"></a><span class="hs-comment">-- Most Linux versions:</span><span>
</span><a name="line-439"></a><span class="hs-comment">-- The PIC base register points to the GOT. Use foo@got for symbol</span><span>
</span><a name="line-440"></a><span class="hs-comment">-- pointers, and foo@gotoff for everything else.</span><span>
</span><a name="line-441"></a><span class="hs-comment">-- Linux and Darwin on x86_64:</span><span>
</span><a name="line-442"></a><span class="hs-comment">-- The PIC base register is %rip, we use foo@gotpcrel for symbol pointers,</span><span>
</span><a name="line-443"></a><span class="hs-comment">-- and a GotSymbolOffset label for other things.</span><span>
</span><a name="line-444"></a><span class="hs-comment">-- For reasons of tradition, the symbol offset label is written as a plain label.</span><span>
</span><a name="line-445"></a><span class="hs-identifier">picRelative</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684643003"><a href="#local-6989586621684643003"><span class="hs-identifier">arch</span></a></a><span> </span><a name="local-6989586621684643004"><a href="#local-6989586621684643004"><span class="hs-identifier">os</span></a></a><span> </span><a name="local-6989586621684643005"><a href="#local-6989586621684643005"><span class="hs-identifier">lbl</span></a></a><span>
</span><a name="line-446"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">osElfTarget</span><span> </span><a href="#local-6989586621684643004"><span class="hs-identifier hs-var">os</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684643004"><span class="hs-identifier hs-var">os</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">OSDarwin</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684643003"><span class="hs-identifier hs-var">arch</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">ArchX86_64</span><span class="hs-special">)</span><span>
</span><a name="line-447"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>   </span><a name="local-6989586621684643006"><a href="#local-6989586621684643006"><span class="hs-identifier">result</span></a></a><span>
</span><a name="line-448"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="CLabel.html#SymbolPtr"><span class="hs-identifier hs-var">SymbolPtr</span></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684643007"><a href="#local-6989586621684643007"><span class="hs-identifier">lbl'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CLabel.html#dynamicLinkerLabelInfo"><span class="hs-identifier hs-var">dynamicLinkerLabelInfo</span></a><span> </span><a href="#local-6989586621684643005"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-449"></a><span>                        </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#CmmLabel"><span class="hs-identifier hs-var">CmmLabel</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CLabel.html#mkDynamicLinkerLabel"><span class="hs-identifier hs-var">mkDynamicLinkerLabel</span></a><span> </span><a href="CLabel.html#GotSymbolPtr"><span class="hs-identifier hs-var">GotSymbolPtr</span></a><span> </span><a href="#local-6989586621684643007"><span class="hs-identifier hs-var">lbl'</span></a><span>
</span><a name="line-450"></a><span>
</span><a name="line-451"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-452"></a><span>                        </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#CmmLabel"><span class="hs-identifier hs-var">CmmLabel</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CLabel.html#mkDynamicLinkerLabel"><span class="hs-identifier hs-var">mkDynamicLinkerLabel</span></a><span> </span><a href="CLabel.html#GotSymbolOffset"><span class="hs-identifier hs-var">GotSymbolOffset</span></a><span> </span><a href="#local-6989586621684643005"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-453"></a><span>
</span><a name="line-454"></a><span>          </span><span class="hs-keyword">in</span><span>    </span><a href="#local-6989586621684643006"><span class="hs-identifier hs-var">result</span></a><span>
</span><a name="line-455"></a><span>
</span><a name="line-456"></a><span class="hs-identifier">picRelative</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-457"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;PositionIndependentCode.picRelative undefined for this platform&quot;</span><span>
</span><a name="line-458"></a><span>
</span><a name="line-459"></a><span>
</span><a name="line-460"></a><span>
</span><a name="line-461"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-462"></a><span>
</span><a name="line-463"></a><span class="hs-identifier">needImportedSymbols</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Arch</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OS</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-464"></a><a name="needImportedSymbols"><a href="PIC.html#needImportedSymbols"><span class="hs-identifier">needImportedSymbols</span></a></a><span> </span><a name="local-6989586621684643008"><a href="#local-6989586621684643008"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684643009"><a href="#local-6989586621684643009"><span class="hs-identifier">arch</span></a></a><span> </span><a name="local-6989586621684643010"><a href="#local-6989586621684643010"><span class="hs-identifier">os</span></a></a><span>
</span><a name="line-465"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684643010"><span class="hs-identifier hs-var">os</span></a><span>    </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">OSDarwin</span><span>
</span><a name="line-466"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684643009"><span class="hs-identifier hs-var">arch</span></a><span>  </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">ArchX86_64</span><span>
</span><a name="line-467"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-468"></a><span>
</span><a name="line-469"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684643010"><span class="hs-identifier hs-var">os</span></a><span>    </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">OSAIX</span><span>
</span><a name="line-470"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-471"></a><span>
</span><a name="line-472"></a><span>        </span><span class="hs-comment">-- PowerPC Linux: -fPIC or -dynamic</span><span>
</span><a name="line-473"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">osElfTarget</span><span> </span><a href="#local-6989586621684643010"><span class="hs-identifier hs-var">os</span></a><span>
</span><a name="line-474"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684643009"><span class="hs-identifier hs-var">arch</span></a><span>  </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">ArchPPC</span><span>
</span><a name="line-475"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">positionIndependent</span><span> </span><a href="#local-6989586621684643008"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_ExternalDynamicRefs</span><span> </span><a href="#local-6989586621684643008"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-476"></a><span>
</span><a name="line-477"></a><span>        </span><span class="hs-comment">-- PowerPC 64 Linux: always</span><span>
</span><a name="line-478"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">osElfTarget</span><span> </span><a href="#local-6989586621684643010"><span class="hs-identifier hs-var">os</span></a><span>
</span><a name="line-479"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684643009"><span class="hs-identifier hs-var">arch</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">ArchPPC_64</span><span> </span><span class="hs-identifier hs-var">ELF_V1</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621684643009"><span class="hs-identifier hs-var">arch</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">ArchPPC_64</span><span> </span><span class="hs-identifier hs-var">ELF_V2</span><span>
</span><a name="line-480"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-481"></a><span>
</span><a name="line-482"></a><span>        </span><span class="hs-comment">-- i386 (and others?): -dynamic but not -fPIC</span><span>
</span><a name="line-483"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">osElfTarget</span><span> </span><a href="#local-6989586621684643010"><span class="hs-identifier hs-var">os</span></a><span>
</span><a name="line-484"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684643009"><span class="hs-identifier hs-var">arch</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">ArchPPC_64</span><span> </span><span class="hs-identifier hs-var">ELF_V1</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684643009"><span class="hs-identifier hs-var">arch</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">ArchPPC_64</span><span> </span><span class="hs-identifier hs-var">ELF_V2</span><span>
</span><a name="line-485"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_ExternalDynamicRefs</span><span> </span><a href="#local-6989586621684643008"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-486"></a><span>          </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">positionIndependent</span><span> </span><a href="#local-6989586621684643008"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-487"></a><span>
</span><a name="line-488"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-489"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-490"></a><span>
</span><a name="line-491"></a><span class="hs-comment">-- gotLabel</span><span>
</span><a name="line-492"></a><span class="hs-comment">-- The label used to refer to our &quot;fake GOT&quot; from</span><span>
</span><a name="line-493"></a><span class="hs-comment">-- position-independent code.</span><span>
</span><a name="line-494"></a><span class="hs-identifier">gotLabel</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span>
</span><a name="line-495"></a><a name="gotLabel"><a href="PIC.html#gotLabel"><span class="hs-identifier">gotLabel</span></a></a><span>
</span><a name="line-496"></a><span>        </span><span class="hs-comment">-- HACK: this label isn't really foreign</span><span>
</span><a name="line-497"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkForeignLabel"><span class="hs-identifier hs-var">mkForeignLabel</span></a><span>
</span><a name="line-498"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;.LCTOC1&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-499"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="CLabel.html#ForeignLabelInThisPackage"><span class="hs-identifier hs-var">ForeignLabelInThisPackage</span></a><span> </span><span class="hs-identifier hs-var">IsData</span><span>
</span><a name="line-500"></a><span>
</span><a name="line-501"></a><span>
</span><a name="line-502"></a><span>
</span><a name="line-503"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-504"></a><span class="hs-comment">-- We don't need to declare any offset tables.</span><span>
</span><a name="line-505"></a><span class="hs-comment">-- However, for PIC on x86, we need a small helper function.</span><span>
</span><a name="line-506"></a><span class="hs-identifier">pprGotDeclaration</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Arch</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OS</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-507"></a><a name="pprGotDeclaration"><a href="PIC.html#pprGotDeclaration"><span class="hs-identifier">pprGotDeclaration</span></a></a><span> </span><a name="local-6989586621684643011"><a href="#local-6989586621684643011"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-identifier hs-var">ArchX86</span><span> </span><span class="hs-identifier hs-var">OSDarwin</span><span>
</span><a name="line-508"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">positionIndependent</span><span> </span><a href="#local-6989586621684643011"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-509"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-510"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;.section __TEXT,__textcoal_nt,coalesced,no_toc&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-511"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;.weak_definition ___i686.get_pc_thunk.ax&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-512"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;.private_extern ___i686.get_pc_thunk.ax&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-513"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;___i686.get_pc_thunk.ax:&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-514"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\tmovl (%esp), %eax&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-515"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\tret&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-516"></a><span>
</span><a name="line-517"></a><span class="hs-identifier">pprGotDeclaration</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">OSDarwin</span><span>
</span><a name="line-518"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-519"></a><span>
</span><a name="line-520"></a><span class="hs-comment">-- Emit XCOFF TOC section</span><span>
</span><a name="line-521"></a><span class="hs-identifier">pprGotDeclaration</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">OSAIX</span><span>
</span><a name="line-522"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;.toc&quot;</span><span>
</span><a name="line-523"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;.tc ghc_toc_table[TC],.LCTOC1&quot;</span><span>
</span><a name="line-524"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;.csect ghc_toc_table[RW]&quot;</span><span>
</span><a name="line-525"></a><span>                   </span><span class="hs-comment">-- See Note [.LCTOC1 in PPC PIC code]</span><span>
</span><a name="line-526"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;.set .LCTOC1,$+0x8000&quot;</span><span>
</span><a name="line-527"></a><span>                 </span><span class="hs-special">]</span><span>
</span><a name="line-528"></a><span>
</span><a name="line-529"></a><span>
</span><a name="line-530"></a><span class="hs-comment">-- PPC 64 ELF v1 needs a Table Of Contents (TOC)</span><span>
</span><a name="line-531"></a><span class="hs-identifier">pprGotDeclaration</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ArchPPC_64</span><span> </span><span class="hs-identifier hs-var">ELF_V1</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-532"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;.section \&quot;.toc\&quot;,\&quot;aw\&quot;&quot;</span><span>
</span><a name="line-533"></a><span class="hs-comment">-- In ELF v2 we also need to tell the assembler that we want ABI</span><span>
</span><a name="line-534"></a><span class="hs-comment">-- version 2. This would normally be done at the top of the file</span><span>
</span><a name="line-535"></a><span class="hs-comment">-- right after a file directive, but I could not figure out how</span><span>
</span><a name="line-536"></a><span class="hs-comment">-- to do that.</span><span>
</span><a name="line-537"></a><span class="hs-identifier">pprGotDeclaration</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ArchPPC_64</span><span> </span><span class="hs-identifier hs-var">ELF_V2</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-538"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;.abiversion 2&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-539"></a><span>                 </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;.section \&quot;.toc\&quot;,\&quot;aw\&quot;&quot;</span><span>
</span><a name="line-540"></a><span>               </span><span class="hs-special">]</span><span>
</span><a name="line-541"></a><span>
</span><a name="line-542"></a><span class="hs-comment">-- Emit GOT declaration</span><span>
</span><a name="line-543"></a><span class="hs-comment">-- Output whatever needs to be output once per .s file.</span><span>
</span><a name="line-544"></a><span class="hs-identifier">pprGotDeclaration</span><span> </span><a name="local-6989586621684643012"><a href="#local-6989586621684643012"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684643013"><a href="#local-6989586621684643013"><span class="hs-identifier">arch</span></a></a><span> </span><a name="local-6989586621684643014"><a href="#local-6989586621684643014"><span class="hs-identifier">os</span></a></a><span>
</span><a name="line-545"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">osElfTarget</span><span> </span><a href="#local-6989586621684643014"><span class="hs-identifier hs-var">os</span></a><span>
</span><a name="line-546"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684643013"><span class="hs-identifier hs-var">arch</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">ArchPPC_64</span><span> </span><span class="hs-identifier hs-var">ELF_V1</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684643013"><span class="hs-identifier hs-var">arch</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">ArchPPC_64</span><span> </span><span class="hs-identifier hs-var">ELF_V2</span><span>
</span><a name="line-547"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">positionIndependent</span><span> </span><a href="#local-6989586621684643012"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-548"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-549"></a><span>
</span><a name="line-550"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">osElfTarget</span><span> </span><a href="#local-6989586621684643014"><span class="hs-identifier hs-var">os</span></a><span>
</span><a name="line-551"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684643013"><span class="hs-identifier hs-var">arch</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">ArchPPC_64</span><span> </span><span class="hs-identifier hs-var">ELF_V1</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684643013"><span class="hs-identifier hs-var">arch</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">ArchPPC_64</span><span> </span><span class="hs-identifier hs-var">ELF_V2</span><span>
</span><a name="line-552"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-553"></a><span>                </span><span class="hs-comment">-- See Note [.LCTOC1 in PPC PIC code]</span><span>
</span><a name="line-554"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;.section \&quot;.got2\&quot;,\&quot;aw\&quot;&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-555"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;.LCTOC1 = .+32768&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-556"></a><span>
</span><a name="line-557"></a><span class="hs-identifier">pprGotDeclaration</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-558"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;pprGotDeclaration: no match&quot;</span><span>
</span><a name="line-559"></a><span>
</span><a name="line-560"></a><span>
</span><a name="line-561"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-562"></a><span class="hs-comment">-- On Darwin, we have to generate our own stub code for lazy binding..</span><span>
</span><a name="line-563"></a><span class="hs-comment">-- For each processor architecture, there are two versions, one for PIC</span><span>
</span><a name="line-564"></a><span class="hs-comment">-- and one for non-PIC.</span><span>
</span><a name="line-565"></a><span class="hs-comment">--</span><span>
</span><a name="line-566"></a><span class="hs-comment">-- Whenever you change something in this assembler output, make sure</span><span>
</span><a name="line-567"></a><span class="hs-comment">-- the splitter in driver/split/ghc-split.pl recognizes the new output</span><span>
</span><a name="line-568"></a><span>
</span><a name="line-569"></a><span class="hs-identifier">pprImportedSymbol</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Platform</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-570"></a><a name="pprImportedSymbol"><a href="PIC.html#pprImportedSymbol"><span class="hs-identifier">pprImportedSymbol</span></a></a><span> </span><a name="local-6989586621684643015"><a href="#local-6989586621684643015"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684643016"><a href="#local-6989586621684643016"><span class="hs-identifier">platform</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Platform</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">platformArch</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ArchX86</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">platformOS</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">OSDarwin</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684643017"><a href="#local-6989586621684643017"><span class="hs-identifier">importedLbl</span></a></a><span>
</span><a name="line-571"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="CLabel.html#CodeStub"><span class="hs-identifier hs-var">CodeStub</span></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684643018"><a href="#local-6989586621684643018"><span class="hs-identifier">lbl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CLabel.html#dynamicLinkerLabelInfo"><span class="hs-identifier hs-var">dynamicLinkerLabelInfo</span></a><span> </span><a href="#local-6989586621684643017"><span class="hs-identifier hs-var">importedLbl</span></a><span>
</span><a name="line-572"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">positionIndependent</span><span> </span><a href="#local-6989586621684643015"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-573"></a><span>           </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-574"></a><span>            </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-575"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;.symbol_stub&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-576"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;L&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="CLabel.html#pprCLabel"><span class="hs-identifier hs-var">pprCLabel</span></a><span> </span><a href="#local-6989586621684643016"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684643018"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ptext</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sLit</span><span> </span><span class="hs-string">&quot;$stub:&quot;</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-577"></a><span>                    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\t.indirect_symbol&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="CLabel.html#pprCLabel"><span class="hs-identifier hs-var">pprCLabel</span></a><span> </span><a href="#local-6989586621684643016"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684643018"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">,</span><span>
</span><a name="line-578"></a><span>                    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\tjmp *L&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="CLabel.html#pprCLabel"><span class="hs-identifier hs-var">pprCLabel</span></a><span> </span><a href="#local-6989586621684643016"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684643018"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-579"></a><span>                        </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;$lazy_ptr&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-580"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;L&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="CLabel.html#pprCLabel"><span class="hs-identifier hs-var">pprCLabel</span></a><span> </span><a href="#local-6989586621684643016"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684643018"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-581"></a><span>                    </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;$stub_binder:&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-582"></a><span>                    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\tpushl $L&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="CLabel.html#pprCLabel"><span class="hs-identifier hs-var">pprCLabel</span></a><span> </span><a href="#local-6989586621684643016"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684643018"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-583"></a><span>                        </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;$lazy_ptr&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-584"></a><span>                    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\tjmp dyld_stub_binding_helper&quot;</span><span>
</span><a name="line-585"></a><span>            </span><span class="hs-special">]</span><span>
</span><a name="line-586"></a><span>           </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-587"></a><span>            </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-588"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;.section __TEXT,__picsymbolstub2,&quot;</span><span>
</span><a name="line-589"></a><span>                    </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;symbol_stubs,pure_instructions,25&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-590"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;L&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="CLabel.html#pprCLabel"><span class="hs-identifier hs-var">pprCLabel</span></a><span> </span><a href="#local-6989586621684643016"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684643018"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ptext</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sLit</span><span> </span><span class="hs-string">&quot;$stub:&quot;</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-591"></a><span>                    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\t.indirect_symbol&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="CLabel.html#pprCLabel"><span class="hs-identifier hs-var">pprCLabel</span></a><span> </span><a href="#local-6989586621684643016"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684643018"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">,</span><span>
</span><a name="line-592"></a><span>                    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\tcall ___i686.get_pc_thunk.ax&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-593"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;1:&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-594"></a><span>                    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\tmovl L&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="CLabel.html#pprCLabel"><span class="hs-identifier hs-var">pprCLabel</span></a><span> </span><a href="#local-6989586621684643016"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684643018"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-595"></a><span>                        </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;$lazy_ptr-1b(%eax),%edx&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-596"></a><span>                    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\tjmp *%edx&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-597"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;L&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="CLabel.html#pprCLabel"><span class="hs-identifier hs-var">pprCLabel</span></a><span> </span><a href="#local-6989586621684643016"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684643018"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-598"></a><span>                    </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;$stub_binder:&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-599"></a><span>                    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\tlea L&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="CLabel.html#pprCLabel"><span class="hs-identifier hs-var">pprCLabel</span></a><span> </span><a href="#local-6989586621684643016"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684643018"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-600"></a><span>                        </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;$lazy_ptr-1b(%eax),%eax&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-601"></a><span>                    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\tpushl %eax&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-602"></a><span>                    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\tjmp dyld_stub_binding_helper&quot;</span><span>
</span><a name="line-603"></a><span>            </span><span class="hs-special">]</span><span>
</span><a name="line-604"></a><span>          </span><span class="hs-operator hs-var">$+$</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;.section __DATA, __la_sym_ptr&quot;</span><span>
</span><a name="line-605"></a><span>                    </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">positionIndependent</span><span> </span><a href="#local-6989586621684643015"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">int</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">int</span><span> </span><span class="hs-number">3</span><span class="hs-special">)</span><span>
</span><a name="line-606"></a><span>                    </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;,lazy_symbol_pointers&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-607"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;L&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="CLabel.html#pprCLabel"><span class="hs-identifier hs-var">pprCLabel</span></a><span> </span><a href="#local-6989586621684643016"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684643018"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ptext</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sLit</span><span> </span><span class="hs-string">&quot;$lazy_ptr:&quot;</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-608"></a><span>                    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\t.indirect_symbol&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="CLabel.html#pprCLabel"><span class="hs-identifier hs-var">pprCLabel</span></a><span> </span><a href="#local-6989586621684643016"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684643018"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">,</span><span>
</span><a name="line-609"></a><span>                    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\t.long L&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="CLabel.html#pprCLabel"><span class="hs-identifier hs-var">pprCLabel</span></a><span> </span><a href="#local-6989586621684643016"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684643018"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-610"></a><span>                    </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;$stub_binder&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-611"></a><span>
</span><a name="line-612"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="CLabel.html#SymbolPtr"><span class="hs-identifier hs-var">SymbolPtr</span></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684643019"><a href="#local-6989586621684643019"><span class="hs-identifier">lbl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CLabel.html#dynamicLinkerLabelInfo"><span class="hs-identifier hs-var">dynamicLinkerLabelInfo</span></a><span> </span><a href="#local-6989586621684643017"><span class="hs-identifier hs-var">importedLbl</span></a><span>
</span><a name="line-613"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-614"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;.non_lazy_symbol_pointer&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-615"></a><span>                </span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">'L'</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="CLabel.html#pprCLabel"><span class="hs-identifier hs-var">pprCLabel</span></a><span> </span><a href="#local-6989586621684643016"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684643019"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;$non_lazy_ptr:&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-616"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\t.indirect_symbol&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="CLabel.html#pprCLabel"><span class="hs-identifier hs-var">pprCLabel</span></a><span> </span><a href="#local-6989586621684643016"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684643019"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">,</span><span>
</span><a name="line-617"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\t.long\t0&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-618"></a><span>
</span><a name="line-619"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-620"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-621"></a><span>
</span><a name="line-622"></a><span>
</span><a name="line-623"></a><span class="hs-identifier">pprImportedSymbol</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Platform</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">platformOS</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">OSDarwin</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-624"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-625"></a><span>
</span><a name="line-626"></a><span class="hs-comment">-- XCOFF / AIX</span><span>
</span><a name="line-627"></a><span class="hs-comment">--</span><span>
</span><a name="line-628"></a><span class="hs-comment">-- Similiar to PPC64 ELF v1, there's dedicated TOC register (r2). To</span><span>
</span><a name="line-629"></a><span class="hs-comment">-- workaround the limitation of a global TOC we use an indirect TOC</span><span>
</span><a name="line-630"></a><span class="hs-comment">-- with the label `ghc_toc_table`.</span><span>
</span><a name="line-631"></a><span class="hs-comment">--</span><span>
</span><a name="line-632"></a><span class="hs-comment">-- See also GCC's `-mminimal-toc` compilation mode or</span><span>
</span><a name="line-633"></a><span class="hs-comment">-- http://www.ibm.com/developerworks/rational/library/overview-toc-aix/</span><span>
</span><a name="line-634"></a><span class="hs-comment">--</span><span>
</span><a name="line-635"></a><span class="hs-comment">-- NB: No DSO-support yet</span><span>
</span><a name="line-636"></a><span>
</span><a name="line-637"></a><span class="hs-identifier">pprImportedSymbol</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684643020"><a href="#local-6989586621684643020"><span class="hs-identifier">platform</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Platform</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">platformOS</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">OSAIX</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684643021"><a href="#local-6989586621684643021"><span class="hs-identifier">importedLbl</span></a></a><span>
</span><a name="line-638"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="CLabel.html#dynamicLinkerLabelInfo"><span class="hs-identifier hs-var">dynamicLinkerLabelInfo</span></a><span> </span><a href="#local-6989586621684643021"><span class="hs-identifier hs-var">importedLbl</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-639"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="CLabel.html#SymbolPtr"><span class="hs-identifier hs-var">SymbolPtr</span></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684643022"><a href="#local-6989586621684643022"><span class="hs-identifier">lbl</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-640"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-641"></a><span>                   </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;LC..&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="CLabel.html#pprCLabel"><span class="hs-identifier hs-var">pprCLabel</span></a><span> </span><a href="#local-6989586621684643020"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684643022"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">':'</span><span class="hs-special">,</span><span>
</span><a name="line-642"></a><span>                   </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\t.long&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="CLabel.html#pprCLabel"><span class="hs-identifier hs-var">pprCLabel</span></a><span> </span><a href="#local-6989586621684643020"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684643022"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-643"></a><span>            </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-644"></a><span>
</span><a name="line-645"></a><span class="hs-comment">-- ELF / Linux</span><span>
</span><a name="line-646"></a><span class="hs-comment">--</span><span>
</span><a name="line-647"></a><span class="hs-comment">-- In theory, we don't need to generate any stubs or symbol pointers</span><span>
</span><a name="line-648"></a><span class="hs-comment">-- by hand for Linux.</span><span>
</span><a name="line-649"></a><span class="hs-comment">--</span><span>
</span><a name="line-650"></a><span class="hs-comment">-- Reality differs from this in two areas.</span><span>
</span><a name="line-651"></a><span class="hs-comment">--</span><span>
</span><a name="line-652"></a><span class="hs-comment">-- 1) If we just use a dynamically imported symbol directly in a read-only</span><span>
</span><a name="line-653"></a><span class="hs-comment">--    section of the main executable (as GCC does), ld generates R_*_COPY</span><span>
</span><a name="line-654"></a><span class="hs-comment">--    relocations, which are fundamentally incompatible with reversed info</span><span>
</span><a name="line-655"></a><span class="hs-comment">--    tables. Therefore, we need a table of imported addresses in a writable</span><span>
</span><a name="line-656"></a><span class="hs-comment">--    section.</span><span>
</span><a name="line-657"></a><span class="hs-comment">--    The &quot;official&quot; GOT mechanism (label@got) isn't intended to be used</span><span>
</span><a name="line-658"></a><span class="hs-comment">--    in position dependent code, so we have to create our own &quot;fake GOT&quot;</span><span>
</span><a name="line-659"></a><span class="hs-comment">--    when not Opt_PIC &amp;&amp; WayDyn `elem` ways dflags.</span><span>
</span><a name="line-660"></a><span class="hs-comment">--</span><span>
</span><a name="line-661"></a><span class="hs-comment">-- 2) PowerPC Linux is just plain broken.</span><span>
</span><a name="line-662"></a><span class="hs-comment">--    While it's theoretically possible to use GOT offsets larger</span><span>
</span><a name="line-663"></a><span class="hs-comment">--    than 16 bit, the standard crt*.o files don't, which leads to</span><span>
</span><a name="line-664"></a><span class="hs-comment">--    linker errors as soon as the GOT size exceeds 16 bit.</span><span>
</span><a name="line-665"></a><span class="hs-comment">--    Also, the assembler doesn't support @gotoff labels.</span><span>
</span><a name="line-666"></a><span class="hs-comment">--    In order to be able to use a larger GOT, we have to circumvent the</span><span>
</span><a name="line-667"></a><span class="hs-comment">--    entire GOT mechanism and do it ourselves (this is also what GCC does).</span><span>
</span><a name="line-668"></a><span>
</span><a name="line-669"></a><span>
</span><a name="line-670"></a><span class="hs-comment">-- When needImportedSymbols is defined,</span><span>
</span><a name="line-671"></a><span class="hs-comment">-- the NCG will keep track of all DynamicLinkerLabels it uses</span><span>
</span><a name="line-672"></a><span class="hs-comment">-- and output each of them using pprImportedSymbol.</span><span>
</span><a name="line-673"></a><span>
</span><a name="line-674"></a><span class="hs-identifier">pprImportedSymbol</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684643023"><a href="#local-6989586621684643023"><span class="hs-identifier">platform</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Platform</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">platformArch</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ArchPPC_64</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-675"></a><span>                  </span><a name="local-6989586621684643024"><a href="#local-6989586621684643024"><span class="hs-identifier">importedLbl</span></a></a><span>
</span><a name="line-676"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">osElfTarget</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">platformOS</span><span> </span><a href="#local-6989586621684643023"><span class="hs-identifier hs-var">platform</span></a><span class="hs-special">)</span><span>
</span><a name="line-677"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="CLabel.html#dynamicLinkerLabelInfo"><span class="hs-identifier hs-var">dynamicLinkerLabelInfo</span></a><span> </span><a href="#local-6989586621684643024"><span class="hs-identifier hs-var">importedLbl</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-678"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="CLabel.html#SymbolPtr"><span class="hs-identifier hs-var">SymbolPtr</span></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684643025"><a href="#local-6989586621684643025"><span class="hs-identifier">lbl</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-679"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-680"></a><span>                   </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;.section \&quot;.toc\&quot;, \&quot;aw\&quot;&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-681"></a><span>                   </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;.LC_&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="CLabel.html#pprCLabel"><span class="hs-identifier hs-var">pprCLabel</span></a><span> </span><a href="#local-6989586621684643023"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684643025"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">':'</span><span class="hs-special">,</span><span>
</span><a name="line-682"></a><span>                   </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\t.quad&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="CLabel.html#pprCLabel"><span class="hs-identifier hs-var">pprCLabel</span></a><span> </span><a href="#local-6989586621684643023"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684643025"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-683"></a><span>            </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-684"></a><span>
</span><a name="line-685"></a><span class="hs-identifier">pprImportedSymbol</span><span> </span><a name="local-6989586621684643026"><a href="#local-6989586621684643026"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684643027"><a href="#local-6989586621684643027"><span class="hs-identifier">platform</span></a></a><span> </span><a name="local-6989586621684643028"><a href="#local-6989586621684643028"><span class="hs-identifier">importedLbl</span></a></a><span>
</span><a name="line-686"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">osElfTarget</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">platformOS</span><span> </span><a href="#local-6989586621684643027"><span class="hs-identifier hs-var">platform</span></a><span class="hs-special">)</span><span>
</span><a name="line-687"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="CLabel.html#dynamicLinkerLabelInfo"><span class="hs-identifier hs-var">dynamicLinkerLabelInfo</span></a><span> </span><a href="#local-6989586621684643028"><span class="hs-identifier hs-var">importedLbl</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-688"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="CLabel.html#SymbolPtr"><span class="hs-identifier hs-var">SymbolPtr</span></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684643029"><a href="#local-6989586621684643029"><span class="hs-identifier">lbl</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-689"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684643030"><a href="#local-6989586621684643030"><span class="hs-identifier">symbolSize</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">wordWidth</span><span> </span><a href="#local-6989586621684643026"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-690"></a><span>                         </span><span class="hs-identifier hs-var">W32</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">sLit</span><span> </span><span class="hs-string">&quot;\t.long&quot;</span><span>
</span><a name="line-691"></a><span>                         </span><span class="hs-identifier hs-var">W64</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">sLit</span><span> </span><span class="hs-string">&quot;\t.quad&quot;</span><span>
</span><a name="line-692"></a><span>                         </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;Unknown wordRep in pprImportedSymbol&quot;</span><span>
</span><a name="line-693"></a><span>
</span><a name="line-694"></a><span>                 </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-695"></a><span>                      </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;.section \&quot;.got2\&quot;, \&quot;aw\&quot;&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-696"></a><span>                      </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;.LC_&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="CLabel.html#pprCLabel"><span class="hs-identifier hs-var">pprCLabel</span></a><span> </span><a href="#local-6989586621684643027"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684643029"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">':'</span><span class="hs-special">,</span><span>
</span><a name="line-697"></a><span>                      </span><span class="hs-identifier hs-var">ptext</span><span> </span><a href="#local-6989586621684643030"><span class="hs-identifier hs-var">symbolSize</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="CLabel.html#pprCLabel"><span class="hs-identifier hs-var">pprCLabel</span></a><span> </span><a href="#local-6989586621684643027"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684643029"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-698"></a><span>
</span><a name="line-699"></a><span>            </span><span class="hs-comment">-- PLT code stubs are generated automatically by the dynamic linker.</span><span>
</span><a name="line-700"></a><span>            </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-701"></a><span>
</span><a name="line-702"></a><span class="hs-identifier">pprImportedSymbol</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-703"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;PIC.pprImportedSymbol: no match&quot;</span><span>
</span><a name="line-704"></a><span>
</span><a name="line-705"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-706"></a><span class="hs-comment">-- Generate code to calculate the address that should be put in the</span><span>
</span><a name="line-707"></a><span class="hs-comment">-- PIC base register.</span><span>
</span><a name="line-708"></a><span class="hs-comment">-- This is called by MachCodeGen for every CmmProc that accessed the</span><span>
</span><a name="line-709"></a><span class="hs-comment">-- PIC base register. It adds the appropriate instructions to the</span><span>
</span><a name="line-710"></a><span class="hs-comment">-- top of the CmmProc.</span><span>
</span><a name="line-711"></a><span>
</span><a name="line-712"></a><span class="hs-comment">-- It is assumed that the first NatCmmDecl in the input list is a Proc</span><span>
</span><a name="line-713"></a><span class="hs-comment">-- and the rest are CmmDatas.</span><span>
</span><a name="line-714"></a><span>
</span><a name="line-715"></a><span class="hs-comment">-- Darwin is simple: just fetch the address of a local label.</span><span>
</span><a name="line-716"></a><span class="hs-comment">-- The FETCHPC pseudo-instruction is expanded to multiple instructions</span><span>
</span><a name="line-717"></a><span class="hs-comment">-- during pretty-printing so that we don't have to deal with the</span><span>
</span><a name="line-718"></a><span class="hs-comment">-- local label:</span><span>
</span><a name="line-719"></a><span>
</span><a name="line-720"></a><span class="hs-comment">-- PowerPC version:</span><span>
</span><a name="line-721"></a><span class="hs-comment">--          bcl 20,31,1f.</span><span>
</span><a name="line-722"></a><span class="hs-comment">--      1:  mflr picReg</span><span>
</span><a name="line-723"></a><span>
</span><a name="line-724"></a><span class="hs-comment">-- i386 version:</span><span>
</span><a name="line-725"></a><span class="hs-comment">--          call 1f</span><span>
</span><a name="line-726"></a><span class="hs-comment">--      1:  popl %picReg</span><span>
</span><a name="line-727"></a><span>
</span><a name="line-728"></a><span>
</span><a name="line-729"></a><span>
</span><a name="line-730"></a><span class="hs-comment">-- Get a pointer to our own fake GOT, which is defined on a per-module basis.</span><span>
</span><a name="line-731"></a><span class="hs-comment">-- This is exactly how GCC does it in linux.</span><span>
</span><a name="line-732"></a><span>
</span><a name="line-733"></a><span class="hs-identifier">initializePicBase_ppc</span><span>
</span><a name="line-734"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Arch</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OS</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reg.html#Reg"><span class="hs-identifier hs-type">Reg</span></a><span>
</span><a name="line-735"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Instruction.html#NatCmmDecl"><span class="hs-identifier hs-type">NatCmmDecl</span></a><span> </span><a href="Cmm.html#CmmStatics"><span class="hs-identifier hs-type">CmmStatics</span></a><span> </span><a href="PPC.Instr.html#Instr"><span class="hs-identifier hs-type">PPC.Instr</span></a><span class="hs-special">]</span><span>
</span><a name="line-736"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NCGMonad.html#NatM"><span class="hs-identifier hs-type">NatM</span></a><span> </span><span class="hs-special">[</span><a href="Instruction.html#NatCmmDecl"><span class="hs-identifier hs-type">NatCmmDecl</span></a><span> </span><a href="Cmm.html#CmmStatics"><span class="hs-identifier hs-type">CmmStatics</span></a><span> </span><a href="PPC.Instr.html#Instr"><span class="hs-identifier hs-type">PPC.Instr</span></a><span class="hs-special">]</span><span>
</span><a name="line-737"></a><span>
</span><a name="line-738"></a><a name="initializePicBase_ppc"><a href="PIC.html#initializePicBase_ppc"><span class="hs-identifier">initializePicBase_ppc</span></a></a><span> </span><span class="hs-identifier hs-var">ArchPPC</span><span> </span><a name="local-6989586621684643031"><a href="#local-6989586621684643031"><span class="hs-identifier">os</span></a></a><span> </span><a name="local-6989586621684643032"><a href="#local-6989586621684643032"><span class="hs-identifier">picReg</span></a></a><span>
</span><a name="line-739"></a><span>    </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a name="local-6989586621684643033"><a href="#local-6989586621684643033"><span class="hs-identifier">info</span></a></a><span> </span><a name="local-6989586621684643034"><a href="#local-6989586621684643034"><span class="hs-identifier">lab</span></a></a><span> </span><a name="local-6989586621684643035"><a href="#local-6989586621684643035"><span class="hs-identifier">live</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-var">ListGraph</span></a><span> </span><a name="local-6989586621684643036"><a href="#local-6989586621684643036"><span class="hs-identifier">blocks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684643037"><a href="#local-6989586621684643037"><span class="hs-identifier">statics</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-740"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">osElfTarget</span><span> </span><a href="#local-6989586621684643031"><span class="hs-identifier hs-var">os</span></a><span>
</span><a name="line-741"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-742"></a><span>        </span><span class="hs-keyword">let</span><span>
</span><a name="line-743"></a><span>            </span><a name="local-6989586621684643038"><a href="#local-6989586621684643038"><span class="hs-identifier">gotOffset</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="PPC.Regs.html#ImmConstantDiff"><span class="hs-identifier hs-var">PPC.ImmConstantDiff</span></a><span>
</span><a name="line-744"></a><span>                                </span><span class="hs-special">(</span><a href="PPC.Regs.html#ImmCLbl"><span class="hs-identifier hs-var">PPC.ImmCLbl</span></a><span> </span><a href="PIC.html#gotLabel"><span class="hs-identifier hs-var">gotLabel</span></a><span class="hs-special">)</span><span>
</span><a name="line-745"></a><span>                                </span><span class="hs-special">(</span><a href="PPC.Regs.html#ImmCLbl"><span class="hs-identifier hs-var">PPC.ImmCLbl</span></a><span> </span><a href="CLabel.html#mkPicBaseLabel"><span class="hs-identifier hs-var">mkPicBaseLabel</span></a><span class="hs-special">)</span><span>
</span><a name="line-746"></a><span>
</span><a name="line-747"></a><span>            </span><a name="local-6989586621684643039"><a href="#local-6989586621684643039"><span class="hs-identifier">blocks'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684643036"><span class="hs-identifier hs-var">blocks</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-748"></a><span>                       </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-749"></a><span>                       </span><span class="hs-special">(</span><a name="local-6989586621684643042"><a href="#local-6989586621684643042"><span class="hs-identifier">b</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684643043"><a href="#local-6989586621684643043"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684643041"><span class="hs-identifier hs-var">fetchPC</span></a><span> </span><a href="#local-6989586621684643042"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621684643040"><span class="hs-identifier hs-var">maybeFetchPC</span></a><span> </span><a href="#local-6989586621684643043"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-750"></a><span>
</span><a name="line-751"></a><span>            </span><a name="local-6989586621684643040"><a href="#local-6989586621684643040"><span class="hs-identifier">maybeFetchPC</span></a></a><span> </span><a name="local-6989586621684643044"><a href="#local-6989586621684643044"><span class="hs-identifier">b</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Cmm.html#BasicBlock"><span class="hs-identifier hs-var">BasicBlock</span></a><span> </span><a name="local-6989586621684643045"><a href="#local-6989586621684643045"><span class="hs-identifier">bID</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-752"></a><span>              </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684643045"><span class="hs-identifier hs-var">bID</span></a><span> </span><span class="hs-special">`</span><a href="Hoopl.Collections.html#mapMember"><span class="hs-identifier hs-var">mapMember</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684643033"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684643041"><span class="hs-identifier hs-var">fetchPC</span></a><span> </span><a href="#local-6989586621684643044"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-753"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684643044"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-754"></a><span>
</span><a name="line-755"></a><span>            </span><span class="hs-comment">-- GCC does PIC prologs thusly:</span><span>
</span><a name="line-756"></a><span>            </span><span class="hs-comment">--     bcl 20,31,.L1</span><span>
</span><a name="line-757"></a><span>            </span><span class="hs-comment">-- .L1:</span><span>
</span><a name="line-758"></a><span>            </span><span class="hs-comment">--     mflr 30</span><span>
</span><a name="line-759"></a><span>            </span><span class="hs-comment">--     addis 30,30,.LCTOC1-.L1@ha</span><span>
</span><a name="line-760"></a><span>            </span><span class="hs-comment">--     addi 30,30,.LCTOC1-.L1@l</span><span>
</span><a name="line-761"></a><span>            </span><span class="hs-comment">-- TODO: below we use it over temporary register,</span><span>
</span><a name="line-762"></a><span>            </span><span class="hs-comment">-- it can and should be optimised by picking</span><span>
</span><a name="line-763"></a><span>            </span><span class="hs-comment">-- correct PIC reg.</span><span>
</span><a name="line-764"></a><span>            </span><a name="local-6989586621684643041"><a href="#local-6989586621684643041"><span class="hs-identifier">fetchPC</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#BasicBlock"><span class="hs-identifier hs-var">BasicBlock</span></a><span> </span><a name="local-6989586621684643046"><a href="#local-6989586621684643046"><span class="hs-identifier">bID</span></a></a><span> </span><a name="local-6989586621684643047"><a href="#local-6989586621684643047"><span class="hs-identifier">insns</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-765"></a><span>              </span><a href="Cmm.html#BasicBlock"><span class="hs-identifier hs-var">BasicBlock</span></a><span> </span><a href="#local-6989586621684643046"><span class="hs-identifier hs-var">bID</span></a><span> </span><span class="hs-special">(</span><a href="PPC.Instr.html#FETCHPC"><span class="hs-identifier hs-var">PPC.FETCHPC</span></a><span> </span><a href="#local-6989586621684643032"><span class="hs-identifier hs-var">picReg</span></a><span>
</span><a name="line-766"></a><span>                              </span><span class="hs-glyph">:</span><span> </span><a href="PPC.Instr.html#ADDIS"><span class="hs-identifier hs-var">PPC.ADDIS</span></a><span> </span><a href="#local-6989586621684643032"><span class="hs-identifier hs-var">picReg</span></a><span> </span><a href="#local-6989586621684643032"><span class="hs-identifier hs-var">picReg</span></a><span> </span><span class="hs-special">(</span><a href="PPC.Regs.html#HA"><span class="hs-identifier hs-var">PPC.HA</span></a><span> </span><a href="#local-6989586621684643038"><span class="hs-identifier hs-var">gotOffset</span></a><span class="hs-special">)</span><span>
</span><a name="line-767"></a><span>                              </span><span class="hs-glyph">:</span><span> </span><a href="PPC.Instr.html#ADD"><span class="hs-identifier hs-var">PPC.ADD</span></a><span> </span><a href="#local-6989586621684643032"><span class="hs-identifier hs-var">picReg</span></a><span> </span><a href="#local-6989586621684643032"><span class="hs-identifier hs-var">picReg</span></a><span>
</span><a name="line-768"></a><span>                                        </span><span class="hs-special">(</span><a href="PPC.Instr.html#RIImm"><span class="hs-identifier hs-var">PPC.RIImm</span></a><span> </span><span class="hs-special">(</span><a href="PPC.Regs.html#LO"><span class="hs-identifier hs-var">PPC.LO</span></a><span> </span><a href="#local-6989586621684643038"><span class="hs-identifier hs-var">gotOffset</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-769"></a><span>                              </span><span class="hs-glyph">:</span><span> </span><a href="PPC.Instr.html#MR"><span class="hs-identifier hs-var">PPC.MR</span></a><span> </span><a href="PPC.Regs.html#r30"><span class="hs-identifier hs-var">PPC.r30</span></a><span> </span><a href="#local-6989586621684643032"><span class="hs-identifier hs-var">picReg</span></a><span>
</span><a name="line-770"></a><span>                              </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684643047"><span class="hs-identifier hs-var">insns</span></a><span class="hs-special">)</span><span>
</span><a name="line-771"></a><span>
</span><a name="line-772"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a href="#local-6989586621684643033"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621684643034"><span class="hs-identifier hs-var">lab</span></a><span> </span><a href="#local-6989586621684643035"><span class="hs-identifier hs-var">live</span></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-var">ListGraph</span></a><span> </span><a href="#local-6989586621684643039"><span class="hs-identifier hs-var">blocks'</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684643037"><span class="hs-identifier hs-var">statics</span></a><span class="hs-special">)</span><span>
</span><a name="line-773"></a><span>
</span><a name="line-774"></a><span class="hs-comment">-------------------------------------------------------------------------</span><span>
</span><a name="line-775"></a><span class="hs-comment">-- Load TOC into register 2</span><span>
</span><a name="line-776"></a><span class="hs-comment">-- PowerPC 64-bit ELF ABI 2.0 requires the address of the callee</span><span>
</span><a name="line-777"></a><span class="hs-comment">-- in register 12.</span><span>
</span><a name="line-778"></a><span class="hs-comment">-- We pass the label to FETCHTOC and create a .localentry too.</span><span>
</span><a name="line-779"></a><span class="hs-comment">-- TODO: Explain this better and refer to ABI spec!</span><span>
</span><a name="line-780"></a><span class="hs-comment">{-
We would like to do approximately this, but spill slot allocation
might be added before the first BasicBlock. That violates the ABI.

For now we will emit the prologue code in the pretty printer,
which is also what we do for ELF v1.
initializePicBase_ppc (ArchPPC_64 ELF_V2) OSLinux picReg
        (CmmProc info lab live (ListGraph (entry:blocks)) : statics)
        = do
           bID &lt;-getUniqueM
           return (CmmProc info lab live (ListGraph (b':entry:blocks))
                                         : statics)
        where   BasicBlock entryID _ = entry
                b' = BasicBlock bID [PPC.FETCHTOC picReg lab,
                                     PPC.BCC PPC.ALWAYS entryID]
-}</span><span>
</span><a name="line-796"></a><span>
</span><a name="line-797"></a><span class="hs-identifier">initializePicBase_ppc</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-798"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;initializePicBase_ppc: not needed&quot;</span><span>
</span><a name="line-799"></a><span>
</span><a name="line-800"></a><span>
</span><a name="line-801"></a><span class="hs-comment">-- We cheat a bit here by defining a pseudo-instruction named FETCHGOT</span><span>
</span><a name="line-802"></a><span class="hs-comment">-- which pretty-prints as:</span><span>
</span><a name="line-803"></a><span class="hs-comment">--              call 1f</span><span>
</span><a name="line-804"></a><span class="hs-comment">-- 1:           popl %picReg</span><span>
</span><a name="line-805"></a><span class="hs-comment">--              addl __GLOBAL_OFFSET_TABLE__+.-1b, %picReg</span><span>
</span><a name="line-806"></a><span class="hs-comment">-- (See PprMach.hs)</span><span>
</span><a name="line-807"></a><span>
</span><a name="line-808"></a><span class="hs-identifier">initializePicBase_x86</span><span>
</span><a name="line-809"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Arch</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OS</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reg.html#Reg"><span class="hs-identifier hs-type">Reg</span></a><span>
</span><a name="line-810"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Instruction.html#NatCmmDecl"><span class="hs-identifier hs-type">NatCmmDecl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Alignment</span><span class="hs-special">,</span><span> </span><a href="Cmm.html#CmmStatics"><span class="hs-identifier hs-type">CmmStatics</span></a><span class="hs-special">)</span><span> </span><a href="X86.Instr.html#Instr"><span class="hs-identifier hs-type">X86.Instr</span></a><span class="hs-special">]</span><span>
</span><a name="line-811"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NCGMonad.html#NatM"><span class="hs-identifier hs-type">NatM</span></a><span> </span><span class="hs-special">[</span><a href="Instruction.html#NatCmmDecl"><span class="hs-identifier hs-type">NatCmmDecl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Alignment</span><span class="hs-special">,</span><span> </span><a href="Cmm.html#CmmStatics"><span class="hs-identifier hs-type">CmmStatics</span></a><span class="hs-special">)</span><span> </span><a href="X86.Instr.html#Instr"><span class="hs-identifier hs-type">X86.Instr</span></a><span class="hs-special">]</span><span>
</span><a name="line-812"></a><span>
</span><a name="line-813"></a><a name="initializePicBase_x86"><a href="PIC.html#initializePicBase_x86"><span class="hs-identifier">initializePicBase_x86</span></a></a><span> </span><span class="hs-identifier hs-var">ArchX86</span><span> </span><a name="local-6989586621684643048"><a href="#local-6989586621684643048"><span class="hs-identifier">os</span></a></a><span> </span><a name="local-6989586621684643049"><a href="#local-6989586621684643049"><span class="hs-identifier">picReg</span></a></a><span>
</span><a name="line-814"></a><span>        </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a name="local-6989586621684643050"><a href="#local-6989586621684643050"><span class="hs-identifier">info</span></a></a><span> </span><a name="local-6989586621684643051"><a href="#local-6989586621684643051"><span class="hs-identifier">lab</span></a></a><span> </span><a name="local-6989586621684643052"><a href="#local-6989586621684643052"><span class="hs-identifier">live</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-var">ListGraph</span></a><span> </span><a name="local-6989586621684643053"><a href="#local-6989586621684643053"><span class="hs-identifier">blocks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684643054"><a href="#local-6989586621684643054"><span class="hs-identifier">statics</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-815"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">osElfTarget</span><span> </span><a href="#local-6989586621684643048"><span class="hs-identifier hs-var">os</span></a><span>
</span><a name="line-816"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a href="#local-6989586621684643050"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621684643051"><span class="hs-identifier hs-var">lab</span></a><span> </span><a href="#local-6989586621684643052"><span class="hs-identifier hs-var">live</span></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-var">ListGraph</span></a><span> </span><a href="#local-6989586621684643055"><span class="hs-identifier hs-var">blocks'</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684643054"><span class="hs-identifier hs-var">statics</span></a><span class="hs-special">)</span><span>
</span><a name="line-817"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621684643055"><a href="#local-6989586621684643055"><span class="hs-identifier">blocks'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684643053"><span class="hs-identifier hs-var">blocks</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-818"></a><span>                     </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-819"></a><span>                     </span><span class="hs-special">(</span><a name="local-6989586621684643058"><a href="#local-6989586621684643058"><span class="hs-identifier">b</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684643059"><a href="#local-6989586621684643059"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684643057"><span class="hs-identifier hs-var">fetchGOT</span></a><span> </span><a href="#local-6989586621684643058"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621684643056"><span class="hs-identifier hs-var">maybeFetchGOT</span></a><span> </span><a href="#local-6989586621684643059"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-820"></a><span>
</span><a name="line-821"></a><span>          </span><span class="hs-comment">-- we want to add a FETCHGOT instruction to the beginning of</span><span>
</span><a name="line-822"></a><span>          </span><span class="hs-comment">-- every block that is an entry point, which corresponds to</span><span>
</span><a name="line-823"></a><span>          </span><span class="hs-comment">-- the blocks that have entries in the info-table mapping.</span><span>
</span><a name="line-824"></a><span>          </span><a name="local-6989586621684643056"><a href="#local-6989586621684643056"><span class="hs-identifier">maybeFetchGOT</span></a></a><span> </span><a name="local-6989586621684643060"><a href="#local-6989586621684643060"><span class="hs-identifier">b</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Cmm.html#BasicBlock"><span class="hs-identifier hs-var">BasicBlock</span></a><span> </span><a name="local-6989586621684643061"><a href="#local-6989586621684643061"><span class="hs-identifier">bID</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-825"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684643061"><span class="hs-identifier hs-var">bID</span></a><span> </span><span class="hs-special">`</span><a href="Hoopl.Collections.html#mapMember"><span class="hs-identifier hs-var">mapMember</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684643050"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684643057"><span class="hs-identifier hs-var">fetchGOT</span></a><span> </span><a href="#local-6989586621684643060"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-826"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684643060"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-827"></a><span>
</span><a name="line-828"></a><span>          </span><a name="local-6989586621684643057"><a href="#local-6989586621684643057"><span class="hs-identifier">fetchGOT</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#BasicBlock"><span class="hs-identifier hs-var">BasicBlock</span></a><span> </span><a name="local-6989586621684643062"><a href="#local-6989586621684643062"><span class="hs-identifier">bID</span></a></a><span> </span><a name="local-6989586621684643063"><a href="#local-6989586621684643063"><span class="hs-identifier">insns</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-829"></a><span>             </span><a href="Cmm.html#BasicBlock"><span class="hs-identifier hs-var">BasicBlock</span></a><span> </span><a href="#local-6989586621684643062"><span class="hs-identifier hs-var">bID</span></a><span> </span><span class="hs-special">(</span><a href="X86.Instr.html#FETCHGOT"><span class="hs-identifier hs-var">X86.FETCHGOT</span></a><span> </span><a href="#local-6989586621684643049"><span class="hs-identifier hs-var">picReg</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684643063"><span class="hs-identifier hs-var">insns</span></a><span class="hs-special">)</span><span>
</span><a name="line-830"></a><span>
</span><a name="line-831"></a><span class="hs-identifier">initializePicBase_x86</span><span> </span><span class="hs-identifier hs-var">ArchX86</span><span> </span><span class="hs-identifier hs-var">OSDarwin</span><span> </span><a name="local-6989586621684643064"><a href="#local-6989586621684643064"><span class="hs-identifier">picReg</span></a></a><span>
</span><a name="line-832"></a><span>        </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a name="local-6989586621684643065"><a href="#local-6989586621684643065"><span class="hs-identifier">info</span></a></a><span> </span><a name="local-6989586621684643066"><a href="#local-6989586621684643066"><span class="hs-identifier">lab</span></a></a><span> </span><a name="local-6989586621684643067"><a href="#local-6989586621684643067"><span class="hs-identifier">live</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-var">ListGraph</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684643068"><a href="#local-6989586621684643068"><span class="hs-identifier">entry</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684643069"><a href="#local-6989586621684643069"><span class="hs-identifier">blocks</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684643070"><a href="#local-6989586621684643070"><span class="hs-identifier">statics</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-833"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a href="#local-6989586621684643065"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621684643066"><span class="hs-identifier hs-var">lab</span></a><span> </span><a href="#local-6989586621684643067"><span class="hs-identifier hs-var">live</span></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-var">ListGraph</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684643073"><span class="hs-identifier hs-var">block'</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684643069"><span class="hs-identifier hs-var">blocks</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684643070"><span class="hs-identifier hs-var">statics</span></a><span class="hs-special">)</span><span>
</span><a name="line-834"></a><span>
</span><a name="line-835"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a href="Cmm.html#BasicBlock"><span class="hs-identifier hs-var">BasicBlock</span></a><span> </span><a name="local-6989586621684643071"><a href="#local-6989586621684643071"><span class="hs-identifier">bID</span></a></a><span> </span><a name="local-6989586621684643072"><a href="#local-6989586621684643072"><span class="hs-identifier">insns</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684643068"><span class="hs-identifier hs-var">entry</span></a><span>
</span><a name="line-836"></a><span>          </span><a name="local-6989586621684643073"><a href="#local-6989586621684643073"><span class="hs-identifier">block'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#BasicBlock"><span class="hs-identifier hs-var">BasicBlock</span></a><span> </span><a href="#local-6989586621684643071"><span class="hs-identifier hs-var">bID</span></a><span> </span><span class="hs-special">(</span><a href="X86.Instr.html#FETCHPC"><span class="hs-identifier hs-var">X86.FETCHPC</span></a><span> </span><a href="#local-6989586621684643064"><span class="hs-identifier hs-var">picReg</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684643072"><span class="hs-identifier hs-var">insns</span></a><span class="hs-special">)</span><span>
</span><a name="line-837"></a><span>
</span><a name="line-838"></a><span class="hs-identifier">initializePicBase_x86</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-839"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;initializePicBase_x86: not needed&quot;</span><span>
</span><a name="line-840"></a><span>
</span><a name="line-841"></a></pre></body></html>