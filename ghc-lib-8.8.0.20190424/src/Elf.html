<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
-----------------------------------------------------------------------------
--
-- (c) The University of Glasgow 2015
--
-- ELF format tools
--
-----------------------------------------------------------------------------
-}</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Elf</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-12"></a><span>    </span><a href="Elf.html#readElfSectionByName"><span class="hs-identifier hs-var">readElfSectionByName</span></a><span class="hs-special">,</span><span>
</span><a name="line-13"></a><span>    </span><a href="Elf.html#readElfNoteAsString"><span class="hs-identifier hs-var">readElfNoteAsString</span></a><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>    </span><a href="Elf.html#makeElfNote"><span class="hs-identifier hs-var">makeElfNote</span></a><span>
</span><a name="line-15"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="AsmUtils.html"><span class="hs-identifier">AsmUtils</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Exception</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MaybeT</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-identifier hs-var">runMaybeT</span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">charToC</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span class="hs-special">,</span><span class="hs-identifier hs-var">hcat</span><span class="hs-special">,</span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">when</span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Binary.Get</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Word</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Char</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ord</span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.ByteString.Lazy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString.Lazy</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LBS</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString.Lazy.Char8</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">B8</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-comment">{- Note [ELF specification]
   ~~~~~~~~~~~~~~~~~~~~~~~~

   ELF (Executable and Linking Format) is described in the System V Application
   Binary Interface (or ABI). The latter is composed of two parts: a generic
   part and a processor specific part. The generic ABI describes the parts of
   the interface that remain constant across all hardware implementations of
   System V.

   The latest release of the specification of the generic ABI is the version
   4.1 from March 18, 1997:

     - http://www.sco.com/developers/devspecs/gabi41.pdf

   Since 1997, snapshots of the draft for the &quot;next&quot; version are published:

     - http://www.sco.com/developers/gabi/

   Quoting the notice on the website: &quot;There is more than one instance of these
   chapters to permit references to older instances to remain valid. All
   modifications to these chapters are forward-compatible, so that correct use
   of an older specification will not be invalidated by a newer instance.
   Approximately on a yearly basis, a new instance will be saved, as it reaches
   what appears to be a stable state.&quot;

   Nevertheless we will see that since 1998 it is not true for Note sections.

   Many ELF sections
   -----------------

   ELF-4.1: the normal section number fields in ELF are limited to 16 bits,
   which runs out of bits when you try to cram in more sections than that. Two
   fields are concerned: the one containing the number of the sections and the
   one containing the index of the section that contains section's names. (The
   same thing applies to the field containing the number of segments, but we
   don't care about it here).

   ELF-next: to solve this, theses fields in the ELF header have an escape
   value (different for each case), and the actual section number is stashed
   into unused fields in the first section header.

   We support this extension as it is forward-compatible with ELF-4.1.
   Moreover, GHC may generate objects with a lot of sections with the
   &quot;function-sections&quot; feature (one section per function).

   Note sections
   -------------

   Sections with type &quot;note&quot; (SHT_NOTE in the specification) are used to add
   arbitrary data into an ELF file. An entry in a note section is composed of a
   name, a type and a value.

   ELF-4.1: &quot;The note information in sections and program header elements holds
   any number of entries, each of which is an array of 4-byte words in the
   format of the target processor.&quot; Each entry has the following format:
         | namesz |   Word32: size of the name string (including the ending \0)
         | descsz |   Word32: size of the value
         |  type  |   Word32: type of the note
         |  name  |   Name string (with \0 padding to ensure 4-byte alignment)
         |  ...   |
         |  desc  |   Value (with \0 padding to ensure 4-byte alignment)
         |  ...   |

   ELF-next: &quot;The note information in sections and program header elements
   holds a variable amount of entries. In 64-bit objects (files with
   e_ident[EI_CLASS] equal to ELFCLASS64), each entry is an array of 8-byte
   words in the format of the target processor. In 32-bit objects (files with
   e_ident[EI_CLASS] equal to ELFCLASS32), each entry is an array of 4-byte
   words in the format of the target processor.&quot; (from 1998-2015 snapshots)

   This is not forward-compatible with ELF-4.1. In practice, for almost all
   platforms namesz, descz and type fields are 4-byte words for both 32-bit and
   64-bit objects (see elf.h and readelf source code).

   The only exception in readelf source code is for IA_64 machines with OpenVMS
   OS: &quot;This OS has so many departures from the ELF standard that we test it at
   many places&quot; (comment for is_ia64_vms() in readelf.c). In this case, namesz,
   descsz and type fields are 8-byte words and name and value fields are padded
   to ensure 8-byte alignment.

   We don't support this platform in the following code. Reading a note section
   could be done easily (by testing Machine and OS fields in the ELF header).
   Writing a note section, however, requires that we generate a different
   assembly code for GAS depending on the target platform and this is a little
   bit more involved.

-}</span><span>
</span><a name="line-122"></a><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-comment">-- | ELF header</span><span>
</span><a name="line-125"></a><span class="hs-comment">--</span><span>
</span><a name="line-126"></a><span class="hs-comment">-- The ELF header indicates the native word size (32-bit or 64-bit) and the</span><span>
</span><a name="line-127"></a><span class="hs-comment">-- endianness of the target machine. We directly store getters for words of</span><span>
</span><a name="line-128"></a><span class="hs-comment">-- different sizes as it is more convenient to use. We also store the word size</span><span>
</span><a name="line-129"></a><span class="hs-comment">-- as it is useful to skip some uninteresting fields.</span><span>
</span><a name="line-130"></a><span class="hs-comment">--</span><span>
</span><a name="line-131"></a><span class="hs-comment">-- Other information such as the target machine and OS are left out as we don't</span><span>
</span><a name="line-132"></a><span class="hs-comment">-- use them yet. We could add them in the future if we ever need them.</span><span>
</span><a name="line-133"></a><span class="hs-keyword">data</span><span> </span><a name="ElfHeader"><a href="Elf.html#ElfHeader"><span class="hs-identifier">ElfHeader</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="ElfHeader"><a href="Elf.html#ElfHeader"><span class="hs-identifier">ElfHeader</span></a></a><span>
</span><a name="line-134"></a><span>   </span><span class="hs-special">{</span><span> </span><a name="gw16"><a href="Elf.html#gw16"><span class="hs-identifier">gw16</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Get</span><span> </span><span class="hs-identifier hs-type">Word16</span><span>   </span><span class="hs-comment">-- ^ Get a Word16 with the correct endianness</span><span>
</span><a name="line-135"></a><span>   </span><span class="hs-special">,</span><span> </span><a name="gw32"><a href="Elf.html#gw32"><span class="hs-identifier">gw32</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Get</span><span> </span><span class="hs-identifier hs-type">Word32</span><span>   </span><span class="hs-comment">-- ^ Get a Word32 with the correct endianness</span><span>
</span><a name="line-136"></a><span>   </span><span class="hs-special">,</span><span> </span><a name="gwN"><a href="Elf.html#gwN"><span class="hs-identifier">gwN</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Get</span><span> </span><span class="hs-identifier hs-type">Word64</span><span>   </span><span class="hs-comment">-- ^ Get a Word with the correct word size</span><span>
</span><a name="line-137"></a><span>                              </span><span class="hs-comment">--   and endianness</span><span>
</span><a name="line-138"></a><span>   </span><span class="hs-special">,</span><span> </span><a name="wordSize"><a href="Elf.html#wordSize"><span class="hs-identifier">wordSize</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>          </span><span class="hs-comment">-- ^ Word size in bytes</span><span>
</span><a name="line-139"></a><span>   </span><span class="hs-special">}</span><span>
</span><a name="line-140"></a><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span class="hs-comment">-- | Read the ELF header</span><span>
</span><a name="line-143"></a><span class="hs-identifier">readElfHeader</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Elf.html#ElfHeader"><span class="hs-identifier hs-type">ElfHeader</span></a><span class="hs-special">)</span><span>
</span><a name="line-144"></a><a name="readElfHeader"><a href="Elf.html#readElfHeader"><span class="hs-identifier">readElfHeader</span></a></a><span> </span><a name="local-6989586621679444775"><a href="#local-6989586621679444775"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621679444776"><a href="#local-6989586621679444776"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Elf.html#runGetOrThrow"><span class="hs-identifier hs-var">runGetOrThrow</span></a><span> </span><a href="#local-6989586621679444777"><span class="hs-identifier hs-var">getHeader</span></a><span> </span><a href="#local-6989586621679444776"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">catchIO</span><span class="hs-special">`</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-145"></a><span>    </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><a href="#local-6989586621679444775"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">3</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-146"></a><span>      </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Unable to read ELF header&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-147"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-148"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-149"></a><span>    </span><a name="local-6989586621679444777"><a href="#local-6989586621679444777"><span class="hs-identifier">getHeader</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-150"></a><span>      </span><a name="local-6989586621679444778"><a href="#local-6989586621679444778"><span class="hs-identifier">magic</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getWord32be</span><span>
</span><a name="line-151"></a><span>      </span><a name="local-6989586621679444779"><a href="#local-6989586621679444779"><span class="hs-identifier">ws</span></a></a><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getWord8</span><span>
</span><a name="line-152"></a><span>      </span><a name="local-6989586621679444780"><a href="#local-6989586621679444780"><span class="hs-identifier">endian</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getWord8</span><span>
</span><a name="line-153"></a><span>      </span><a name="local-6989586621679444781"><a href="#local-6989586621679444781"><span class="hs-identifier">version</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getWord8</span><span>
</span><a name="line-154"></a><span>      </span><span class="hs-identifier hs-var">skip</span><span> </span><span class="hs-number">9</span><span>  </span><span class="hs-comment">-- skip OSABI, ABI version and padding</span><span>
</span><a name="line-155"></a><span>      </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679444778"><span class="hs-identifier hs-var">magic</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-number">0x7F454C46</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621679444781"><span class="hs-identifier hs-var">version</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Invalid ELF header&quot;</span><span>
</span><a name="line-156"></a><span>
</span><a name="line-157"></a><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679444779"><span class="hs-identifier hs-var">ws</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679444780"><span class="hs-identifier hs-var">endian</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-158"></a><span>          </span><span class="hs-comment">-- ELF 32, little endian</span><span>
</span><a name="line-159"></a><span>          </span><span class="hs-special">(</span><span class="hs-number">1</span><span class="hs-special">,</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Elf.html#ElfHeader"><span class="hs-identifier hs-var">ElfHeader</span></a><span>
</span><a name="line-160"></a><span>                           </span><span class="hs-identifier hs-var">getWord16le</span><span>
</span><a name="line-161"></a><span>                           </span><span class="hs-identifier hs-var">getWord32le</span><span>
</span><a name="line-162"></a><span>                           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-identifier hs-var">getWord32le</span><span class="hs-special">)</span><span> </span><span class="hs-number">4</span><span>
</span><a name="line-163"></a><span>          </span><span class="hs-comment">-- ELF 32, big endian</span><span>
</span><a name="line-164"></a><span>          </span><span class="hs-special">(</span><span class="hs-number">1</span><span class="hs-special">,</span><span class="hs-number">2</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Elf.html#ElfHeader"><span class="hs-identifier hs-var">ElfHeader</span></a><span>
</span><a name="line-165"></a><span>                           </span><span class="hs-identifier hs-var">getWord16be</span><span>
</span><a name="line-166"></a><span>                           </span><span class="hs-identifier hs-var">getWord32be</span><span>
</span><a name="line-167"></a><span>                           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-identifier hs-var">getWord32be</span><span class="hs-special">)</span><span> </span><span class="hs-number">4</span><span>
</span><a name="line-168"></a><span>          </span><span class="hs-comment">-- ELF 64, little endian</span><span>
</span><a name="line-169"></a><span>          </span><span class="hs-special">(</span><span class="hs-number">2</span><span class="hs-special">,</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Elf.html#ElfHeader"><span class="hs-identifier hs-var">ElfHeader</span></a><span>
</span><a name="line-170"></a><span>                           </span><span class="hs-identifier hs-var">getWord16le</span><span>
</span><a name="line-171"></a><span>                           </span><span class="hs-identifier hs-var">getWord32le</span><span>
</span><a name="line-172"></a><span>                           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-identifier hs-var">getWord64le</span><span class="hs-special">)</span><span> </span><span class="hs-number">8</span><span>
</span><a name="line-173"></a><span>          </span><span class="hs-comment">-- ELF 64, big endian</span><span>
</span><a name="line-174"></a><span>          </span><span class="hs-special">(</span><span class="hs-number">2</span><span class="hs-special">,</span><span class="hs-number">2</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Elf.html#ElfHeader"><span class="hs-identifier hs-var">ElfHeader</span></a><span>
</span><a name="line-175"></a><span>                           </span><span class="hs-identifier hs-var">getWord16be</span><span>
</span><a name="line-176"></a><span>                           </span><span class="hs-identifier hs-var">getWord32be</span><span>
</span><a name="line-177"></a><span>                           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-identifier hs-var">getWord64be</span><span class="hs-special">)</span><span> </span><span class="hs-number">8</span><span>
</span><a name="line-178"></a><span>          </span><span class="hs-identifier">_</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Invalid ELF header&quot;</span><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span>
</span><a name="line-181"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-182"></a><span class="hs-comment">-- SECTIONS</span><span>
</span><a name="line-183"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-184"></a><span>
</span><a name="line-185"></a><span>
</span><a name="line-186"></a><span class="hs-comment">-- | Description of the section table</span><span>
</span><a name="line-187"></a><span class="hs-keyword">data</span><span> </span><a name="SectionTable"><a href="Elf.html#SectionTable"><span class="hs-identifier">SectionTable</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="SectionTable"><a href="Elf.html#SectionTable"><span class="hs-identifier">SectionTable</span></a></a><span>
</span><a name="line-188"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="sectionTableOffset"><a href="Elf.html#sectionTableOffset"><span class="hs-identifier">sectionTableOffset</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word64</span><span>  </span><span class="hs-comment">-- ^ offset of the table describing sections</span><span>
</span><a name="line-189"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="sectionEntrySize"><a href="Elf.html#sectionEntrySize"><span class="hs-identifier">sectionEntrySize</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word16</span><span>  </span><span class="hs-comment">-- ^ size of an entry in the section table</span><span>
</span><a name="line-190"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="sectionEntryCount"><a href="Elf.html#sectionEntryCount"><span class="hs-identifier">sectionEntryCount</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word64</span><span>  </span><span class="hs-comment">-- ^ number of sections</span><span>
</span><a name="line-191"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="sectionNameIndex"><a href="Elf.html#sectionNameIndex"><span class="hs-identifier">sectionNameIndex</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word32</span><span>  </span><span class="hs-comment">-- ^ index of a special section which</span><span>
</span><a name="line-192"></a><span>                                  </span><span class="hs-comment">--   contains section's names</span><span>
</span><a name="line-193"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-194"></a><span>
</span><a name="line-195"></a><span class="hs-comment">-- | Read the ELF section table</span><span>
</span><a name="line-196"></a><span class="hs-identifier">readElfSectionTable</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-197"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Elf.html#ElfHeader"><span class="hs-identifier hs-type">ElfHeader</span></a><span>
</span><a name="line-198"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span>
</span><a name="line-199"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Elf.html#SectionTable"><span class="hs-identifier hs-type">SectionTable</span></a><span class="hs-special">)</span><span>
</span><a name="line-200"></a><span>
</span><a name="line-201"></a><a name="readElfSectionTable"><a href="Elf.html#readElfSectionTable"><span class="hs-identifier">readElfSectionTable</span></a></a><span> </span><a name="local-6989586621679444782"><a href="#local-6989586621679444782"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621679444783"><a href="#local-6989586621679444783"><span class="hs-identifier">hdr</span></a></a><span> </span><a name="local-6989586621679444784"><a href="#local-6989586621679444784"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679444786"><span class="hs-identifier hs-var">action</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">catchIO</span><span class="hs-special">`</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-202"></a><span>    </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><a href="#local-6989586621679444782"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">3</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-203"></a><span>      </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Unable to read ELF section table&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-204"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-205"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-206"></a><span>    </span><span class="hs-identifier">getSectionTable</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Get</span><span> </span><a href="Elf.html#SectionTable"><span class="hs-identifier hs-type">SectionTable</span></a><span>
</span><a name="line-207"></a><span>    </span><a name="local-6989586621679444785"><a href="#local-6989586621679444785"><span class="hs-identifier">getSectionTable</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-208"></a><span>      </span><span class="hs-identifier hs-var">skip</span><span> </span><span class="hs-special">(</span><span class="hs-number">24</span><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">2</span><span class="hs-operator hs-var">*</span><span class="hs-identifier">wordSize</span><span> </span><a href="#local-6989586621679444783"><span class="hs-identifier hs-var">hdr</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- skip header and some other fields</span><span>
</span><a name="line-209"></a><span>      </span><a name="local-6989586621679444787"><a href="#local-6989586621679444787"><span class="hs-identifier">secTableOffset</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">gwN</span><span> </span><a href="#local-6989586621679444783"><span class="hs-identifier hs-var">hdr</span></a><span>
</span><a name="line-210"></a><span>      </span><span class="hs-identifier hs-var">skip</span><span> </span><span class="hs-number">10</span><span>
</span><a name="line-211"></a><span>      </span><a name="local-6989586621679444788"><a href="#local-6989586621679444788"><span class="hs-identifier">entrySize</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">gw16</span><span> </span><a href="#local-6989586621679444783"><span class="hs-identifier hs-var">hdr</span></a><span>
</span><a name="line-212"></a><span>      </span><a name="local-6989586621679444789"><a href="#local-6989586621679444789"><span class="hs-identifier">entryCount</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">gw16</span><span> </span><a href="#local-6989586621679444783"><span class="hs-identifier hs-var">hdr</span></a><span>
</span><a name="line-213"></a><span>      </span><a name="local-6989586621679444790"><a href="#local-6989586621679444790"><span class="hs-identifier">secNameIndex</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">gw16</span><span> </span><a href="#local-6989586621679444783"><span class="hs-identifier hs-var">hdr</span></a><span>
</span><a name="line-214"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Elf.html#SectionTable"><span class="hs-identifier hs-var">SectionTable</span></a><span> </span><a href="#local-6989586621679444787"><span class="hs-identifier hs-var">secTableOffset</span></a><span> </span><a href="#local-6989586621679444788"><span class="hs-identifier hs-var">entrySize</span></a><span>
</span><a name="line-215"></a><span>                           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679444789"><span class="hs-identifier hs-var">entryCount</span></a><span class="hs-special">)</span><span>
</span><a name="line-216"></a><span>                           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679444790"><span class="hs-identifier hs-var">secNameIndex</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-217"></a><span>
</span><a name="line-218"></a><span>    </span><a name="local-6989586621679444786"><a href="#local-6989586621679444786"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-219"></a><span>      </span><a name="local-6989586621679444791"><a href="#local-6989586621679444791"><span class="hs-identifier">secTable</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Elf.html#runGetOrThrow"><span class="hs-identifier hs-var">runGetOrThrow</span></a><span> </span><a href="#local-6989586621679444785"><span class="hs-identifier hs-var">getSectionTable</span></a><span> </span><a href="#local-6989586621679444784"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-220"></a><span>      </span><span class="hs-comment">-- In some cases, the number of entries and the index of the section</span><span>
</span><a name="line-221"></a><span>      </span><span class="hs-comment">-- containing section's names must be found in unused fields of the first</span><span>
</span><a name="line-222"></a><span>      </span><span class="hs-comment">-- section entry (see Note [ELF specification])</span><span>
</span><a name="line-223"></a><span>      </span><span class="hs-keyword">let</span><span>
</span><a name="line-224"></a><span>        </span><a name="local-6989586621679444792"><a href="#local-6989586621679444792"><span class="hs-identifier">offSize0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">sectionTableOffset</span><span> </span><a href="#local-6989586621679444791"><span class="hs-identifier hs-var">secTable</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">8</span><span>
</span><a name="line-225"></a><span>                                  </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">3</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">wordSize</span><span> </span><a href="#local-6989586621679444783"><span class="hs-identifier hs-var">hdr</span></a><span class="hs-special">)</span><span>
</span><a name="line-226"></a><span>        </span><a name="local-6989586621679444793"><a href="#local-6989586621679444793"><span class="hs-identifier">offLink0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679444792"><span class="hs-identifier hs-var">offSize0</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">wordSize</span><span> </span><a href="#local-6989586621679444783"><span class="hs-identifier hs-var">hdr</span></a><span class="hs-special">)</span><span>
</span><a name="line-227"></a><span>
</span><a name="line-228"></a><span>      </span><a name="local-6989586621679444794"><a href="#local-6989586621679444794"><span class="hs-identifier">entryCount'</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">sectionEntryCount</span><span> </span><a href="#local-6989586621679444791"><span class="hs-identifier hs-var">secTable</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-229"></a><span>                          </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sectionEntryCount</span><span> </span><a href="#local-6989586621679444791"><span class="hs-identifier hs-var">secTable</span></a><span class="hs-special">)</span><span>
</span><a name="line-230"></a><span>                          </span><span class="hs-keyword">else</span><span> </span><a href="Elf.html#runGetOrThrow"><span class="hs-identifier hs-var">runGetOrThrow</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">gwN</span><span> </span><a href="#local-6989586621679444783"><span class="hs-identifier hs-var">hdr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LBS.drop</span><span> </span><a href="#local-6989586621679444792"><span class="hs-identifier hs-var">offSize0</span></a><span> </span><a href="#local-6989586621679444784"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span>
</span><a name="line-231"></a><span>      </span><a name="local-6989586621679444795"><a href="#local-6989586621679444795"><span class="hs-identifier">entryNameIndex'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">sectionNameIndex</span><span> </span><a href="#local-6989586621679444791"><span class="hs-identifier hs-var">secTable</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-number">0xffff</span><span>
</span><a name="line-232"></a><span>                          </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sectionNameIndex</span><span> </span><a href="#local-6989586621679444791"><span class="hs-identifier hs-var">secTable</span></a><span class="hs-special">)</span><span>
</span><a name="line-233"></a><span>                          </span><span class="hs-keyword">else</span><span> </span><a href="Elf.html#runGetOrThrow"><span class="hs-identifier hs-var">runGetOrThrow</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">gw32</span><span> </span><a href="#local-6989586621679444783"><span class="hs-identifier hs-var">hdr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LBS.drop</span><span> </span><a href="#local-6989586621679444793"><span class="hs-identifier hs-var">offLink0</span></a><span> </span><a href="#local-6989586621679444784"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span>
</span><a name="line-234"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679444791"><span class="hs-identifier hs-var">secTable</span></a><span>
</span><a name="line-235"></a><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sectionEntryCount</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679444794"><span class="hs-identifier hs-var">entryCount'</span></a><span>
</span><a name="line-236"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sectionNameIndex</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679444795"><span class="hs-identifier hs-var">entryNameIndex'</span></a><span>
</span><a name="line-237"></a><span>        </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-238"></a><span>
</span><a name="line-239"></a><span>
</span><a name="line-240"></a><span class="hs-comment">-- | A section</span><span>
</span><a name="line-241"></a><span class="hs-keyword">data</span><span> </span><a name="Section"><a href="Elf.html#Section"><span class="hs-identifier">Section</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Section"><a href="Elf.html#Section"><span class="hs-identifier">Section</span></a></a><span>
</span><a name="line-242"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="entryName"><a href="Elf.html#entryName"><span class="hs-identifier">entryName</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span>   </span><span class="hs-comment">-- ^ Name of the section</span><span>
</span><a name="line-243"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="entryBS"><a href="Elf.html#entryBS"><span class="hs-identifier">entryBS</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span>   </span><span class="hs-comment">-- ^ Content of the section</span><span>
</span><a name="line-244"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span class="hs-comment">-- | Read a ELF section</span><span>
</span><a name="line-247"></a><span class="hs-identifier">readElfSectionByIndex</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-248"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Elf.html#ElfHeader"><span class="hs-identifier hs-type">ElfHeader</span></a><span>
</span><a name="line-249"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Elf.html#SectionTable"><span class="hs-identifier hs-type">SectionTable</span></a><span>
</span><a name="line-250"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word64</span><span>
</span><a name="line-251"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span>
</span><a name="line-252"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Elf.html#Section"><span class="hs-identifier hs-type">Section</span></a><span class="hs-special">)</span><span>
</span><a name="line-253"></a><span>
</span><a name="line-254"></a><a name="readElfSectionByIndex"><a href="Elf.html#readElfSectionByIndex"><span class="hs-identifier">readElfSectionByIndex</span></a></a><span> </span><a name="local-6989586621679444796"><a href="#local-6989586621679444796"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621679444797"><a href="#local-6989586621679444797"><span class="hs-identifier">hdr</span></a></a><span> </span><a name="local-6989586621679444798"><a href="#local-6989586621679444798"><span class="hs-identifier">secTable</span></a></a><span> </span><a name="local-6989586621679444799"><a href="#local-6989586621679444799"><span class="hs-identifier">i</span></a></a><span> </span><a name="local-6989586621679444800"><a href="#local-6989586621679444800"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679444804"><span class="hs-identifier hs-var">action</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">catchIO</span><span class="hs-special">`</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-255"></a><span>    </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><a href="#local-6989586621679444796"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">3</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-256"></a><span>      </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Unable to read ELF section&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-257"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-258"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-259"></a><span>    </span><span class="hs-comment">-- read an entry from the section table</span><span>
</span><a name="line-260"></a><span>    </span><a name="local-6989586621679444801"><a href="#local-6989586621679444801"><span class="hs-identifier">getEntry</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-261"></a><span>      </span><a name="local-6989586621679444805"><a href="#local-6989586621679444805"><span class="hs-identifier">nameIndex</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">gw32</span><span> </span><a href="#local-6989586621679444797"><span class="hs-identifier hs-var">hdr</span></a><span>
</span><a name="line-262"></a><span>      </span><span class="hs-identifier hs-var">skip</span><span> </span><span class="hs-special">(</span><span class="hs-number">4</span><span class="hs-operator hs-var">+</span><span class="hs-number">2</span><span class="hs-operator hs-var">*</span><span class="hs-identifier">wordSize</span><span> </span><a href="#local-6989586621679444797"><span class="hs-identifier hs-var">hdr</span></a><span class="hs-special">)</span><span>
</span><a name="line-263"></a><span>      </span><a name="local-6989586621679444806"><a href="#local-6989586621679444806"><span class="hs-identifier">offset</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">gwN</span><span> </span><a href="#local-6989586621679444797"><span class="hs-identifier hs-var">hdr</span></a><span>
</span><a name="line-264"></a><span>      </span><a name="local-6989586621679444807"><a href="#local-6989586621679444807"><span class="hs-identifier">size</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">gwN</span><span> </span><a href="#local-6989586621679444797"><span class="hs-identifier hs-var">hdr</span></a><span>
</span><a name="line-265"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679444808"><a href="#local-6989586621679444808"><span class="hs-identifier">bs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">LBS.take</span><span> </span><a href="#local-6989586621679444807"><span class="hs-identifier hs-var">size</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LBS.drop</span><span> </span><a href="#local-6989586621679444806"><span class="hs-identifier hs-var">offset</span></a><span> </span><a href="#local-6989586621679444800"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span>
</span><a name="line-266"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679444805"><span class="hs-identifier hs-var">nameIndex</span></a><span class="hs-special">,</span><a href="#local-6989586621679444808"><span class="hs-identifier hs-var">bs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-267"></a><span>
</span><a name="line-268"></a><span>    </span><span class="hs-comment">-- read the entry with the given index in the section table</span><span>
</span><a name="line-269"></a><span>    </span><a name="local-6989586621679444802"><a href="#local-6989586621679444802"><span class="hs-identifier">getEntryByIndex</span></a></a><span> </span><a name="local-6989586621679444809"><a href="#local-6989586621679444809"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Elf.html#runGetOrThrow"><span class="hs-identifier hs-var">runGetOrThrow</span></a><span> </span><a href="#local-6989586621679444801"><span class="hs-identifier hs-var">getEntry</span></a><span> </span><a href="#local-6989586621679444810"><span class="hs-identifier hs-var">bs'</span></a><span>
</span><a name="line-270"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-271"></a><span>        </span><a name="local-6989586621679444810"><a href="#local-6989586621679444810"><span class="hs-identifier">bs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">LBS.drop</span><span> </span><a href="#local-6989586621679444811"><span class="hs-identifier hs-var">off</span></a><span> </span><a href="#local-6989586621679444800"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-272"></a><span>        </span><a name="local-6989586621679444811"><a href="#local-6989586621679444811"><span class="hs-identifier">off</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">sectionTableOffset</span><span> </span><a href="#local-6989586621679444798"><span class="hs-identifier hs-var">secTable</span></a><span> </span><span class="hs-operator hs-var">+</span><span>
</span><a name="line-273"></a><span>                             </span><a href="#local-6989586621679444809"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sectionEntrySize</span><span> </span><a href="#local-6989586621679444798"><span class="hs-identifier hs-var">secTable</span></a><span class="hs-special">)</span><span>
</span><a name="line-274"></a><span>
</span><a name="line-275"></a><span>    </span><span class="hs-comment">-- Get the name of a section</span><span>
</span><a name="line-276"></a><span>    </span><a name="local-6989586621679444803"><a href="#local-6989586621679444803"><span class="hs-identifier">getEntryName</span></a></a><span> </span><a name="local-6989586621679444812"><a href="#local-6989586621679444812"><span class="hs-identifier">nameIndex</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-277"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679444813"><a href="#local-6989586621679444813"><span class="hs-identifier">idx</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sectionNameIndex</span><span> </span><a href="#local-6989586621679444798"><span class="hs-identifier hs-var">secTable</span></a><span class="hs-special">)</span><span>
</span><a name="line-278"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621679444814"><a href="#local-6989586621679444814"><span class="hs-identifier">nameTable</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679444802"><span class="hs-identifier hs-var">getEntryByIndex</span></a><span> </span><a href="#local-6989586621679444813"><span class="hs-identifier hs-var">idx</span></a><span>
</span><a name="line-279"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679444815"><a href="#local-6989586621679444815"><span class="hs-identifier">bs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">LBS.drop</span><span> </span><a href="#local-6989586621679444812"><span class="hs-identifier hs-var">nameIndex</span></a><span> </span><a href="#local-6989586621679444814"><span class="hs-identifier hs-var">nameTable</span></a><span>
</span><a name="line-280"></a><span>      </span><a href="Elf.html#runGetOrThrow"><span class="hs-identifier hs-var">runGetOrThrow</span></a><span> </span><span class="hs-identifier hs-var">getLazyByteStringNul</span><span> </span><a href="#local-6989586621679444815"><span class="hs-identifier hs-var">bs'</span></a><span>
</span><a name="line-281"></a><span>
</span><a name="line-282"></a><span>    </span><a name="local-6989586621679444804"><a href="#local-6989586621679444804"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-283"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621679444816"><a href="#local-6989586621679444816"><span class="hs-identifier">nameIndex</span></a></a><span class="hs-special">,</span><a name="local-6989586621679444817"><a href="#local-6989586621679444817"><span class="hs-identifier">bs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679444802"><span class="hs-identifier hs-var">getEntryByIndex</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679444799"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span>
</span><a name="line-284"></a><span>      </span><a name="local-6989586621679444818"><a href="#local-6989586621679444818"><span class="hs-identifier">name</span></a></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679444803"><span class="hs-identifier hs-var">getEntryName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679444816"><span class="hs-identifier hs-var">nameIndex</span></a><span class="hs-special">)</span><span>
</span><a name="line-285"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Elf.html#Section"><span class="hs-identifier hs-var">Section</span></a><span> </span><a href="#local-6989586621679444818"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679444817"><span class="hs-identifier hs-var">bs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-286"></a><span>
</span><a name="line-287"></a><span>
</span><a name="line-288"></a><span class="hs-comment">-- | Find a section from its name. Return the section contents.</span><span>
</span><a name="line-289"></a><span class="hs-comment">--</span><span>
</span><a name="line-290"></a><span class="hs-comment">-- We do not perform any check on the section type.</span><span>
</span><a name="line-291"></a><span class="hs-identifier">findSectionFromName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-292"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Elf.html#ElfHeader"><span class="hs-identifier hs-type">ElfHeader</span></a><span>
</span><a name="line-293"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Elf.html#SectionTable"><span class="hs-identifier hs-type">SectionTable</span></a><span>
</span><a name="line-294"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-295"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span>
</span><a name="line-296"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">)</span><span>
</span><a name="line-297"></a><a name="findSectionFromName"><a href="Elf.html#findSectionFromName"><span class="hs-identifier">findSectionFromName</span></a></a><span> </span><a name="local-6989586621679444819"><a href="#local-6989586621679444819"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621679444820"><a href="#local-6989586621679444820"><span class="hs-identifier">hdr</span></a></a><span> </span><a name="local-6989586621679444821"><a href="#local-6989586621679444821"><span class="hs-identifier">secTable</span></a></a><span> </span><a name="local-6989586621679444822"><a href="#local-6989586621679444822"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679444823"><a href="#local-6989586621679444823"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-298"></a><span>    </span><a href="#local-6989586621679444825"><span class="hs-identifier hs-var">rec</span></a><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-identifier">sectionEntryCount</span><span> </span><a href="#local-6989586621679444821"><span class="hs-identifier hs-var">secTable</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">]</span><span>
</span><a name="line-299"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-300"></a><span>    </span><span class="hs-comment">-- convert the required section name into a ByteString to perform</span><span>
</span><a name="line-301"></a><span>    </span><span class="hs-comment">-- ByteString comparison instead of String comparison</span><span>
</span><a name="line-302"></a><span>    </span><a name="local-6989586621679444824"><a href="#local-6989586621679444824"><span class="hs-identifier">name'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">B8.pack</span><span> </span><a href="#local-6989586621679444822"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-303"></a><span>
</span><a name="line-304"></a><span>    </span><span class="hs-comment">-- compare recursively each section name and return the contents of</span><span>
</span><a name="line-305"></a><span>    </span><span class="hs-comment">-- the matching one, if any</span><span>
</span><a name="line-306"></a><span>    </span><a name="local-6989586621679444825"><a href="#local-6989586621679444825"><span class="hs-identifier">rec</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-307"></a><span>    </span><span class="hs-identifier">rec</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679444826"><a href="#local-6989586621679444826"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679444827"><a href="#local-6989586621679444827"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-308"></a><span>      </span><a name="local-6989586621679444828"><a href="#local-6989586621679444828"><span class="hs-identifier">me</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Elf.html#readElfSectionByIndex"><span class="hs-identifier hs-var">readElfSectionByIndex</span></a><span> </span><a href="#local-6989586621679444819"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621679444820"><span class="hs-identifier hs-var">hdr</span></a><span> </span><a href="#local-6989586621679444821"><span class="hs-identifier hs-var">secTable</span></a><span> </span><a href="#local-6989586621679444826"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621679444823"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-309"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679444828"><span class="hs-identifier hs-var">me</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-310"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679444829"><a href="#local-6989586621679444829"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">entryName</span><span> </span><a href="#local-6989586621679444829"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679444824"><span class="hs-identifier hs-var">name'</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">entryBS</span><span> </span><a href="#local-6989586621679444829"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-311"></a><span>        </span><span class="hs-identifier">_</span><span>                             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679444825"><span class="hs-identifier hs-var">rec</span></a><span> </span><a href="#local-6989586621679444827"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-312"></a><span>
</span><a name="line-313"></a><span>
</span><a name="line-314"></a><span class="hs-comment">-- | Given a section name, read its contents as a ByteString.</span><span>
</span><a name="line-315"></a><span class="hs-comment">--</span><span>
</span><a name="line-316"></a><span class="hs-comment">-- If the section isn't found or if there is any parsing error, we return</span><span>
</span><a name="line-317"></a><span class="hs-comment">-- Nothing</span><span>
</span><a name="line-318"></a><span class="hs-identifier">readElfSectionByName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-319"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span>
</span><a name="line-320"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-321"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">LBS.ByteString</span><span class="hs-special">)</span><span>
</span><a name="line-322"></a><span>
</span><a name="line-323"></a><a name="readElfSectionByName"><a href="Elf.html#readElfSectionByName"><span class="hs-identifier">readElfSectionByName</span></a></a><span> </span><a name="local-6989586621679444830"><a href="#local-6989586621679444830"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621679444831"><a href="#local-6989586621679444831"><span class="hs-identifier">bs</span></a></a><span> </span><a name="local-6989586621679444832"><a href="#local-6989586621679444832"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679444833"><span class="hs-identifier hs-var">action</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">catchIO</span><span class="hs-special">`</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-324"></a><span>    </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><a href="#local-6989586621679444830"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">3</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-325"></a><span>      </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Unable to read ELF section \&quot;&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679444832"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;\&quot;&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-326"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-327"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-328"></a><span>    </span><a name="local-6989586621679444833"><a href="#local-6989586621679444833"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">runMaybeT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-329"></a><span>      </span><a name="local-6989586621679445142"><a href="#local-6989586621679445142"><span class="hs-identifier">hdr</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">MaybeT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Elf.html#readElfHeader"><span class="hs-identifier hs-var">readElfHeader</span></a><span> </span><a href="#local-6989586621679444830"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621679444831"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-330"></a><span>      </span><a name="local-6989586621679445143"><a href="#local-6989586621679445143"><span class="hs-identifier">secTable</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">MaybeT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Elf.html#readElfSectionTable"><span class="hs-identifier hs-var">readElfSectionTable</span></a><span> </span><a href="#local-6989586621679444830"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621679445142"><span class="hs-identifier hs-var">hdr</span></a><span> </span><a href="#local-6989586621679444831"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-331"></a><span>      </span><span class="hs-identifier hs-var">MaybeT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Elf.html#findSectionFromName"><span class="hs-identifier hs-var">findSectionFromName</span></a><span> </span><a href="#local-6989586621679444830"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621679445142"><span class="hs-identifier hs-var">hdr</span></a><span> </span><a href="#local-6989586621679445143"><span class="hs-identifier hs-var">secTable</span></a><span> </span><a href="#local-6989586621679444832"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621679444831"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-332"></a><span>
</span><a name="line-333"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-334"></a><span class="hs-comment">-- NOTE SECTIONS</span><span>
</span><a name="line-335"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-336"></a><span>
</span><a name="line-337"></a><span class="hs-comment">-- | read a Note as a ByteString</span><span>
</span><a name="line-338"></a><span class="hs-comment">--</span><span>
</span><a name="line-339"></a><span class="hs-comment">-- If you try to read a note from a section which does not support the Note</span><span>
</span><a name="line-340"></a><span class="hs-comment">-- format, the parsing is likely to fail and Nothing will be returned</span><span>
</span><a name="line-341"></a><span class="hs-identifier">readElfNoteBS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-342"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span>
</span><a name="line-343"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-344"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-345"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">LBS.ByteString</span><span class="hs-special">)</span><span>
</span><a name="line-346"></a><span>
</span><a name="line-347"></a><a name="readElfNoteBS"><a href="Elf.html#readElfNoteBS"><span class="hs-identifier">readElfNoteBS</span></a></a><span> </span><a name="local-6989586621679445144"><a href="#local-6989586621679445144"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621679445145"><a href="#local-6989586621679445145"><span class="hs-identifier">bs</span></a></a><span> </span><a name="local-6989586621679445146"><a href="#local-6989586621679445146"><span class="hs-identifier">sectionName</span></a></a><span> </span><a name="local-6989586621679445147"><a href="#local-6989586621679445147"><span class="hs-identifier">noteId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679445151"><span class="hs-identifier hs-var">action</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">catchIO</span><span class="hs-special">`</span><span>  </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-348"></a><span>    </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><a href="#local-6989586621679445144"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">3</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-349"></a><span>         </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Unable to read ELF note \&quot;&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679445147"><span class="hs-identifier hs-var">noteId</span></a><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-350"></a><span>               </span><span class="hs-string">&quot;\&quot; in section \&quot;&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679445146"><span class="hs-identifier hs-var">sectionName</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;\&quot;&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-351"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-352"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-353"></a><span>    </span><span class="hs-comment">-- align the getter on n bytes</span><span>
</span><a name="line-354"></a><span>    </span><a name="local-6989586621679445148"><a href="#local-6989586621679445148"><span class="hs-identifier">align</span></a></a><span> </span><a name="local-6989586621679445152"><a href="#local-6989586621679445152"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-355"></a><span>      </span><a name="local-6989586621679445153"><a href="#local-6989586621679445153"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">bytesRead</span><span>
</span><a name="line-356"></a><span>      </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679445153"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mod</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679445152"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-357"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-358"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">skip</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><a href="#local-6989586621679445148"><span class="hs-identifier hs-var">align</span></a><span> </span><a href="#local-6989586621679445152"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-359"></a><span>
</span><a name="line-360"></a><span>    </span><span class="hs-comment">-- noteId as a bytestring</span><span>
</span><a name="line-361"></a><span>    </span><a name="local-6989586621679445149"><a href="#local-6989586621679445149"><span class="hs-identifier">noteId'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">B8.pack</span><span> </span><a href="#local-6989586621679445147"><span class="hs-identifier hs-var">noteId</span></a><span>
</span><a name="line-362"></a><span>
</span><a name="line-363"></a><span>    </span><span class="hs-comment">-- read notes recursively until the one with a valid identifier is found</span><span>
</span><a name="line-364"></a><span>    </span><a name="local-6989586621679445150"><a href="#local-6989586621679445150"><span class="hs-identifier">findNote</span></a></a><span> </span><a name="local-6989586621679445154"><a href="#local-6989586621679445154"><span class="hs-identifier">hdr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-365"></a><span>      </span><a href="#local-6989586621679445148"><span class="hs-identifier hs-var">align</span></a><span> </span><span class="hs-number">4</span><span>
</span><a name="line-366"></a><span>      </span><a name="local-6989586621679445155"><a href="#local-6989586621679445155"><span class="hs-identifier">namesz</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">gw32</span><span> </span><a href="#local-6989586621679445154"><span class="hs-identifier hs-var">hdr</span></a><span>
</span><a name="line-367"></a><span>      </span><a name="local-6989586621679445156"><a href="#local-6989586621679445156"><span class="hs-identifier">descsz</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">gw32</span><span> </span><a href="#local-6989586621679445154"><span class="hs-identifier hs-var">hdr</span></a><span>
</span><a name="line-368"></a><span>      </span><span class="hs-identifier">_</span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">gw32</span><span> </span><a href="#local-6989586621679445154"><span class="hs-identifier hs-var">hdr</span></a><span> </span><span class="hs-comment">-- we don't use the note type</span><span>
</span><a name="line-369"></a><span>      </span><a name="local-6989586621679445157"><a href="#local-6989586621679445157"><span class="hs-identifier">name</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679445155"><span class="hs-identifier hs-var">namesz</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-370"></a><span>                  </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">LBS.empty</span><span>
</span><a name="line-371"></a><span>                  </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">getLazyByteStringNul</span><span>
</span><a name="line-372"></a><span>      </span><a href="#local-6989586621679445148"><span class="hs-identifier hs-var">align</span></a><span> </span><span class="hs-number">4</span><span>
</span><a name="line-373"></a><span>      </span><a name="local-6989586621679445158"><a href="#local-6989586621679445158"><span class="hs-identifier">desc</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679445156"><span class="hs-identifier hs-var">descsz</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-374"></a><span>                  </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">LBS.empty</span><span>
</span><a name="line-375"></a><span>                  </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">getLazyByteString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621679445156"><span class="hs-identifier hs-var">descsz</span></a><span class="hs-special">)</span><span>
</span><a name="line-376"></a><span>      </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679445157"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679445149"><span class="hs-identifier hs-var">noteId'</span></a><span>
</span><a name="line-377"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679445158"><span class="hs-identifier hs-var">desc</span></a><span>
</span><a name="line-378"></a><span>        </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679445150"><span class="hs-identifier hs-var">findNote</span></a><span> </span><a href="#local-6989586621679445154"><span class="hs-identifier hs-var">hdr</span></a><span>
</span><a name="line-379"></a><span>
</span><a name="line-380"></a><span>
</span><a name="line-381"></a><span>    </span><a name="local-6989586621679445151"><a href="#local-6989586621679445151"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">runMaybeT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-382"></a><span>      </span><a name="local-6989586621679445159"><a href="#local-6989586621679445159"><span class="hs-identifier">hdr</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">MaybeT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Elf.html#readElfHeader"><span class="hs-identifier hs-var">readElfHeader</span></a><span> </span><a href="#local-6989586621679445144"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621679445145"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-383"></a><span>      </span><a name="local-6989586621679445160"><a href="#local-6989586621679445160"><span class="hs-identifier">sec</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">MaybeT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Elf.html#readElfSectionByName"><span class="hs-identifier hs-var">readElfSectionByName</span></a><span> </span><a href="#local-6989586621679445144"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621679445145"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-6989586621679445146"><span class="hs-identifier hs-var">sectionName</span></a><span>
</span><a name="line-384"></a><span>      </span><span class="hs-identifier hs-var">MaybeT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Elf.html#runGetOrThrow"><span class="hs-identifier hs-var">runGetOrThrow</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679445150"><span class="hs-identifier hs-var">findNote</span></a><span> </span><a href="#local-6989586621679445159"><span class="hs-identifier hs-var">hdr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679445160"><span class="hs-identifier hs-var">sec</span></a><span>
</span><a name="line-385"></a><span>
</span><a name="line-386"></a><span class="hs-comment">-- | read a Note as a String</span><span>
</span><a name="line-387"></a><span class="hs-comment">--</span><span>
</span><a name="line-388"></a><span class="hs-comment">-- If you try to read a note from a section which does not support the Note</span><span>
</span><a name="line-389"></a><span class="hs-comment">-- format, the parsing is likely to fail and Nothing will be returned</span><span>
</span><a name="line-390"></a><span class="hs-identifier">readElfNoteAsString</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-391"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-392"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-393"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-394"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span>
</span><a name="line-395"></a><span>
</span><a name="line-396"></a><a name="readElfNoteAsString"><a href="Elf.html#readElfNoteAsString"><span class="hs-identifier">readElfNoteAsString</span></a></a><span> </span><a name="local-6989586621679445161"><a href="#local-6989586621679445161"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621679445162"><a href="#local-6989586621679445162"><span class="hs-identifier">path</span></a></a><span> </span><a name="local-6989586621679445163"><a href="#local-6989586621679445163"><span class="hs-identifier">sectionName</span></a></a><span> </span><a name="local-6989586621679445164"><a href="#local-6989586621679445164"><span class="hs-identifier">noteId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679445165"><span class="hs-identifier hs-var">action</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">catchIO</span><span class="hs-special">`</span><span>  </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-397"></a><span>    </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><a href="#local-6989586621679445161"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">3</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-398"></a><span>         </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Unable to read ELF note \&quot;&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679445164"><span class="hs-identifier hs-var">noteId</span></a><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-399"></a><span>               </span><span class="hs-string">&quot;\&quot; in section \&quot;&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679445163"><span class="hs-identifier hs-var">sectionName</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;\&quot;&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-400"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-401"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-402"></a><span>    </span><a name="local-6989586621679445165"><a href="#local-6989586621679445165"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-403"></a><span>      </span><a name="local-6989586621679445166"><a href="#local-6989586621679445166"><span class="hs-identifier">bs</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">LBS.readFile</span><span> </span><a href="#local-6989586621679445162"><span class="hs-identifier hs-var">path</span></a><span>
</span><a name="line-404"></a><span>      </span><a name="local-6989586621679445167"><a href="#local-6989586621679445167"><span class="hs-identifier">note</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Elf.html#readElfNoteBS"><span class="hs-identifier hs-var">readElfNoteBS</span></a><span> </span><a href="#local-6989586621679445161"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621679445166"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-6989586621679445163"><span class="hs-identifier hs-var">sectionName</span></a><span> </span><a href="#local-6989586621679445164"><span class="hs-identifier hs-var">noteId</span></a><span>
</span><a name="line-405"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">B8.unpack</span><span> </span><a href="#local-6989586621679445167"><span class="hs-identifier hs-var">note</span></a><span class="hs-special">)</span><span>
</span><a name="line-406"></a><span>
</span><a name="line-407"></a><span>
</span><a name="line-408"></a><span class="hs-comment">-- | Generate the GAS code to create a Note section</span><span>
</span><a name="line-409"></a><span class="hs-comment">--</span><span>
</span><a name="line-410"></a><span class="hs-comment">-- Header fields for notes are 32-bit long (see Note [ELF specification]).</span><span>
</span><a name="line-411"></a><span class="hs-comment">--</span><span>
</span><a name="line-412"></a><span class="hs-comment">-- It seems there is no easy way to force GNU AS to generate a 32-bit word in</span><span>
</span><a name="line-413"></a><span class="hs-comment">-- every case. Hence we use .int directive to create them: however &quot;The byte</span><span>
</span><a name="line-414"></a><span class="hs-comment">-- order and bit size of the number depends on what kind of target the assembly</span><span>
</span><a name="line-415"></a><span class="hs-comment">-- is for.&quot; (https://sourceware.org/binutils/docs/as/Int.html#Int)</span><span>
</span><a name="line-416"></a><span class="hs-comment">--</span><span>
</span><a name="line-417"></a><span class="hs-comment">-- If we add new target platforms, we need to check that the generated words</span><span>
</span><a name="line-418"></a><span class="hs-comment">-- are 32-bit long, otherwise we need to use platform specific directives to</span><span>
</span><a name="line-419"></a><span class="hs-comment">-- force 32-bit .int in asWord32.</span><span>
</span><a name="line-420"></a><span class="hs-identifier">makeElfNote</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word32</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-421"></a><a name="makeElfNote"><a href="Elf.html#makeElfNote"><span class="hs-identifier">makeElfNote</span></a></a><span> </span><a name="local-6989586621679445168"><a href="#local-6989586621679445168"><span class="hs-identifier">sectionName</span></a></a><span> </span><a name="local-6989586621679445169"><a href="#local-6989586621679445169"><span class="hs-identifier">noteName</span></a></a><span> </span><a name="local-6989586621679445170"><a href="#local-6989586621679445170"><span class="hs-identifier">typ</span></a></a><span> </span><a name="local-6989586621679445171"><a href="#local-6989586621679445171"><span class="hs-identifier">contents</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hcat</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-422"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\t.section &quot;</span><span class="hs-special">,</span><span>
</span><a name="line-423"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621679445168"><span class="hs-identifier hs-var">sectionName</span></a><span class="hs-special">,</span><span>
</span><a name="line-424"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;,\&quot;\&quot;,&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-425"></a><span>    </span><a href="AsmUtils.html#sectionType"><span class="hs-identifier hs-var">sectionType</span></a><span> </span><span class="hs-string">&quot;note&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-426"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\n&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-427"></a><span>
</span><a name="line-428"></a><span>    </span><span class="hs-comment">-- note name length (+ 1 for ending \0)</span><span>
</span><a name="line-429"></a><span>    </span><a href="#local-6989586621679445173"><span class="hs-identifier hs-var">asWord32</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679445169"><span class="hs-identifier hs-var">noteName</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-430"></a><span>
</span><a name="line-431"></a><span>    </span><span class="hs-comment">-- note contents size</span><span>
</span><a name="line-432"></a><span>    </span><a href="#local-6989586621679445173"><span class="hs-identifier hs-var">asWord32</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679445171"><span class="hs-identifier hs-var">contents</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-433"></a><span>
</span><a name="line-434"></a><span>    </span><span class="hs-comment">-- note type</span><span>
</span><a name="line-435"></a><span>    </span><a href="#local-6989586621679445173"><span class="hs-identifier hs-var">asWord32</span></a><span> </span><a href="#local-6989586621679445170"><span class="hs-identifier hs-var">typ</span></a><span class="hs-special">,</span><span>
</span><a name="line-436"></a><span>
</span><a name="line-437"></a><span>    </span><span class="hs-comment">-- note name (.asciz for \0 ending string) + padding</span><span>
</span><a name="line-438"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\t.asciz \&quot;&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-439"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621679445169"><span class="hs-identifier hs-var">noteName</span></a><span class="hs-special">,</span><span>
</span><a name="line-440"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\&quot;\n&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-441"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\t.align 4\n&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-442"></a><span>
</span><a name="line-443"></a><span>    </span><span class="hs-comment">-- note contents (.ascii to avoid ending \0) + padding</span><span>
</span><a name="line-444"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\t.ascii \&quot;&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-445"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679445172"><span class="hs-identifier hs-var">escape</span></a><span> </span><a href="#local-6989586621679445171"><span class="hs-identifier hs-var">contents</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-446"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\&quot;\n&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-447"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\t.align 4\n&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-448"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-449"></a><span>    </span><span class="hs-identifier">escape</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-450"></a><span>    </span><a name="local-6989586621679445172"><a href="#local-6989586621679445172"><span class="hs-identifier">escape</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">charToC</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromIntegral</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">ord</span><span class="hs-special">)</span><span>
</span><a name="line-451"></a><span>
</span><a name="line-452"></a><span>    </span><span class="hs-identifier">asWord32</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><a href="#local-6989586621679445174"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679445174"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-453"></a><span>    </span><a name="local-6989586621679445173"><a href="#local-6989586621679445173"><span class="hs-identifier">asWord32</span></a></a><span> </span><a name="local-6989586621679445175"><a href="#local-6989586621679445175"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hcat</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-454"></a><span>      </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\t.int &quot;</span><span class="hs-special">,</span><span>
</span><a name="line-455"></a><span>      </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679445175"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-456"></a><span>      </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\n&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-457"></a><span>
</span><a name="line-458"></a><span>
</span><a name="line-459"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-460"></a><span class="hs-comment">-- Helpers</span><span>
</span><a name="line-461"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-462"></a><span>
</span><a name="line-463"></a><span class="hs-comment">-- | runGet in IO monad that throws an IOException on failure</span><span>
</span><a name="line-464"></a><span class="hs-identifier">runGetOrThrow</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Get</span><span> </span><a href="#local-6989586621679444774"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LBS.ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679444774"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-465"></a><a name="runGetOrThrow"><a href="Elf.html#runGetOrThrow"><span class="hs-identifier">runGetOrThrow</span></a></a><span> </span><a name="local-6989586621679445176"><a href="#local-6989586621679445176"><span class="hs-identifier">g</span></a></a><span> </span><a name="local-6989586621679445177"><a href="#local-6989586621679445177"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">runGetOrFail</span><span> </span><a href="#local-6989586621679445176"><span class="hs-identifier hs-var">g</span></a><span> </span><a href="#local-6989586621679445177"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-466"></a><span>  </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-identifier">_</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Error while reading file&quot;</span><span>
</span><a name="line-467"></a><span>  </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621679445178"><a href="#local-6989586621679445178"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679445178"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-468"></a></pre></body></html>