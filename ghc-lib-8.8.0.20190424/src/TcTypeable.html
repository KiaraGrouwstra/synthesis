<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1999
-}</span><span>
</span><a name="line-5"></a><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">TcTypeable</span><span class="hs-special">(</span><a href="TcTypeable.html#mkTypeableBinds"><span class="hs-identifier hs-var">mkTypeableBinds</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Boxity</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">neverInlinePragma</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SourceText</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><a href="TcBinds.html"><span class="hs-identifier">TcBinds</span></a><span class="hs-special">(</span><span> </span><a href="TcBinds.html#addTypecheckedBinds"><span class="hs-identifier hs-var">addTypecheckedBinds</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><a href="IfaceEnv.html"><span class="hs-identifier">IfaceEnv</span></a><span class="hs-special">(</span><span> </span><a href="IfaceEnv.html#newGlobalBinder"><span class="hs-identifier hs-var">newGlobalBinder</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCoRep</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TyLit</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="TcEnv.html"><span class="hs-identifier">TcEnv</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcEvidence</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkWpTyApps</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">lookupId</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysPrim</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">primTyCons</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysWiredIn</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">tupleTyCon</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">sumTyCon</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">runtimeRepTyCon</span><span>
</span><a name="line-26"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">vecCountTyCon</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">vecElemTyCon</span><span>
</span><a name="line-27"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nilDataCon</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">consDataCon</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Bag</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Var</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">VarBndr</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreMap</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Constants</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Fingerprint</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Fingerprint</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fingerprintString</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fingerprintFingerprints</span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">FastString</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkFastString</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Trans.State</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Trans.Class</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lift</span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Word</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Word64</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-comment">{- Note [Grand plan for Typeable]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The overall plan is this:

1. Generate a binding for each module p:M
   (done in TcTypeable by mkModIdBindings)
       M.$trModule :: GHC.Types.Module
       M.$trModule = Module &quot;p&quot; &quot;M&quot;
   (&quot;tr&quot; is short for &quot;type representation&quot;; see GHC.Types)

   We might want to add the filename too.
   This can be used for the lightweight stack-tracing stuff too

   Record the Name M.$trModule in the tcg_tr_module field of TcGblEnv

2. Generate a binding for every data type declaration T in module M,
       M.$tcT :: GHC.Types.TyCon
       M.$tcT = TyCon ...fingerprint info...
                      $trModule
                      &quot;T&quot;
                      0#
                      kind_rep

   Here 0# is the number of arguments expected by the tycon to fully determine
   its kind. kind_rep is a value of type GHC.Types.KindRep, which gives a
   recipe for computing the kind of an instantiation of the tycon (see
   Note [Representing TyCon kinds: KindRep] later in this file for details).

   We define (in TyCon)

        type TyConRepName = Name

   to use for these M.$tcT &quot;tycon rep names&quot;. Note that these must be
   treated as &quot;never exported&quot; names by Backpack (see
   Note [Handling never-exported TyThings under Backpack]). Consequently
   they get slightly special treatment in RnModIface.rnIfaceDecl.

3. Record the TyConRepName in T's TyCon, including for promoted
   data and type constructors, and kinds like * and #.

   The TyConRepName is not an &quot;implicit Id&quot;.  It's more like a record
   selector: the TyCon knows its name but you have to go to the
   interface file to find its type, value, etc

4. Solve Typeable constraints.  This is done by a custom Typeable solver,
   currently in TcInteract, that use M.$tcT so solve (Typeable T).

There are many wrinkles:

* The timing of when we produce this bindings is rather important: they must be
  defined after the rest of the module has been typechecked since we need to be
  able to lookup Module and TyCon in the type environment and we may be
  currently compiling GHC.Types (where they are defined).

* GHC.Prim doesn't have any associated object code, so we need to put the
  representations for types defined in this module elsewhere. We chose this
  place to be GHC.Types. TcTypeable.mkPrimTypeableBinds is responsible for
  injecting the bindings for the GHC.Prim representions when compiling
  GHC.Types.

* TyCon.tyConRepModOcc is responsible for determining where to find
  the representation binding for a given type. This is where we handle
  the special case for GHC.Prim.

* To save space and reduce dependencies, we need use quite low-level
  representations for TyCon and Module.  See GHC.Types
  Note [Runtime representation of modules and tycons]

* The KindReps can unfortunately get quite large. Moreover, the simplifier will
  float out various pieces of them, resulting in numerous top-level bindings.
  Consequently we mark the KindRep bindings as noinline, ensuring that the
  float-outs don't make it into the interface file. This is important since
  there is generally little benefit to inlining KindReps and they would
  otherwise strongly affect compiler performance.

* In general there are lots of things of kind *, * -&gt; *, and * -&gt; * -&gt; *. To
  reduce the number of bindings we need to produce, we generate their KindReps
  once in GHC.Types. These are referred to as &quot;built-in&quot; KindReps below.

* Even though KindReps aren't inlined, this scheme still has more of an effect on
  compilation time than I'd like. This is especially true in the case of
  families of type constructors (e.g. tuples and unboxed sums). The problem is
  particularly bad in the case of sums, since each arity-N tycon brings with it
  N promoted datacons, each with a KindRep whose size also scales with N.
  Consequently we currently simply don't allow sums to be Typeable.

  In general we might consider moving some or all of this generation logic back
  to the solver since the performance hit we take in doing this at
  type-definition time is non-trivial and Typeable isn't very widely used. This
  is discussed in #13261.

-}</span><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span class="hs-comment">-- | Generate the Typeable bindings for a module. This is the only</span><span>
</span><a name="line-143"></a><span class="hs-comment">-- entry-point of this module and is invoked by the typechecker driver in</span><span>
</span><a name="line-144"></a><span class="hs-comment">-- 'tcRnSrcDecls'.</span><span>
</span><a name="line-145"></a><span class="hs-comment">--</span><span>
</span><a name="line-146"></a><span class="hs-comment">-- See Note [Grand plan for Typeable] in TcTypeable.</span><span>
</span><a name="line-147"></a><span class="hs-identifier">mkTypeableBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-148"></a><a name="mkTypeableBinds"><a href="TcTypeable.html#mkTypeableBinds"><span class="hs-identifier">mkTypeableBinds</span></a></a><span>
</span><a name="line-149"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Create a binding for $trModule.</span><span>
</span><a name="line-150"></a><span>         </span><span class="hs-comment">-- Do this before processing any data type declarations,</span><span>
</span><a name="line-151"></a><span>         </span><span class="hs-comment">-- which need tcg_tr_module to be initialised</span><span>
</span><a name="line-152"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683433253"><a href="#local-6989586621683433253"><span class="hs-identifier">tcg_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTypeable.html#mkModIdBindings"><span class="hs-identifier hs-var">mkModIdBindings</span></a><span>
</span><a name="line-153"></a><span>         </span><span class="hs-comment">-- Now we can generate the TyCon representations...</span><span>
</span><a name="line-154"></a><span>         </span><span class="hs-comment">-- First we handle the primitive TyCons if we are compiling GHC.Types</span><span>
</span><a name="line-155"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683433254"><a href="#local-6989586621683433254"><span class="hs-identifier">tcg_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683433255"><a href="#local-6989586621683433255"><span class="hs-identifier">prim_todos</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><a href="#local-6989586621683433253"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><a href="TcTypeable.html#mkPrimTypeableTodos"><span class="hs-identifier hs-var">mkPrimTypeableTodos</span></a><span>
</span><a name="line-156"></a><span>
</span><a name="line-157"></a><span>         </span><span class="hs-comment">-- Then we produce bindings for the user-defined types in this module.</span><span>
</span><a name="line-158"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><a href="#local-6989586621683433254"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-159"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683433256"><a href="#local-6989586621683433256"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-160"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683433257"><a href="#local-6989586621683433257"><span class="hs-identifier">tycons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621683433251"><span class="hs-identifier hs-var">needs_typeable_binds</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_tcs</span><span> </span><a href="#local-6989586621683433254"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-161"></a><span>             </span><a name="local-6989586621683433258"><a href="#local-6989586621683433258"><span class="hs-identifier">mod_id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">tcg_tr_module</span><span> </span><a href="#local-6989586621683433254"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-keyword">of</span><span>  </span><span class="hs-comment">-- Should be set by now</span><span>
</span><a name="line-162"></a><span>                        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683433259"><a href="#local-6989586621683433259"><span class="hs-identifier">mod_id</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683433259"><span class="hs-identifier hs-var">mod_id</span></a><span>
</span><a name="line-163"></a><span>                        </span><span class="hs-identifier hs-var">Nothing</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;tcMkTypeableBinds&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683433257"><span class="hs-identifier hs-var">tycons</span></a><span class="hs-special">)</span><span>
</span><a name="line-164"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;mkTypeableBinds&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683433257"><span class="hs-identifier hs-var">tycons</span></a><span class="hs-special">)</span><span>
</span><a name="line-165"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683433260"><a href="#local-6989586621683433260"><span class="hs-identifier">this_mod_todos</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTypeable.html#todoForTyCons"><span class="hs-identifier hs-var">todoForTyCons</span></a><span> </span><a href="#local-6989586621683433256"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621683433258"><span class="hs-identifier hs-var">mod_id</span></a><span> </span><a href="#local-6989586621683433257"><span class="hs-identifier hs-var">tycons</span></a><span>
</span><a name="line-166"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcTypeable.html#mkTypeRepTodoBinds"><span class="hs-identifier hs-var">mkTypeRepTodoBinds</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683433260"><span class="hs-identifier hs-var">this_mod_todos</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683433255"><span class="hs-identifier hs-var">prim_todos</span></a><span class="hs-special">)</span><span>
</span><a name="line-167"></a><span>       </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-168"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-169"></a><span>    </span><a name="local-6989586621683433251"><a href="#local-6989586621683433251"><span class="hs-identifier">needs_typeable_binds</span></a></a><span> </span><a name="local-6989586621683433252"><a href="#local-6989586621683433252"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-170"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683433252"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">runtimeRepTyCon</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">vecCountTyCon</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">vecElemTyCon</span><span class="hs-special">]</span><span>
</span><a name="line-171"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-172"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-173"></a><span>          </span><span class="hs-identifier hs-var">isAlgTyCon</span><span> </span><a href="#local-6989586621683433252"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-174"></a><span>       </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">isDataFamilyTyCon</span><span> </span><a href="#local-6989586621683433252"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-175"></a><span>       </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">isClassTyCon</span><span> </span><a href="#local-6989586621683433252"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-176"></a><span>
</span><a name="line-177"></a><span>
</span><a name="line-178"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
            Building top-level binding for $trModule
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a><span class="hs-identifier">mkModIdBindings</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-185"></a><a name="mkModIdBindings"><a href="TcTypeable.html#mkModIdBindings"><span class="hs-identifier">mkModIdBindings</span></a></a><span>
</span><a name="line-186"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683433261"><a href="#local-6989586621683433261"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-187"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683433262"><a href="#local-6989586621683433262"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span>
</span><a name="line-188"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683433263"><a href="#local-6989586621683433263"><span class="hs-identifier">mod_nm</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="IfaceEnv.html#newGlobalBinder"><span class="hs-identifier hs-var">newGlobalBinder</span></a><span> </span><a href="#local-6989586621683433261"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkVarOcc</span><span> </span><span class="hs-string">&quot;$trModule&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683433262"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-189"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683433264"><a href="#local-6989586621683433264"><span class="hs-identifier">trModuleTyCon</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><span class="hs-identifier hs-var">trModuleTyConName</span><span>
</span><a name="line-190"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683433265"><a href="#local-6989586621683433265"><span class="hs-identifier">mod_id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkExportedVanillaId</span><span> </span><a href="#local-6989586621683433263"><span class="hs-identifier hs-var">mod_nm</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683433264"><span class="hs-identifier hs-var">trModuleTyCon</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-191"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683433266"><a href="#local-6989586621683433266"><span class="hs-identifier">mod_bind</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mkVarBind</span><span> </span><a href="#local-6989586621683433265"><span class="hs-identifier hs-var">mod_id</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcTypeable.html#mkModIdRHS"><span class="hs-identifier hs-var">mkModIdRHS</span></a><span> </span><a href="#local-6989586621683433261"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683433267"><a href="#local-6989586621683433267"><span class="hs-identifier">tcg_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcExtendGlobalValEnv"><span class="hs-identifier hs-var">tcExtendGlobalValEnv</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683433265"><span class="hs-identifier hs-var">mod_id</span></a><span class="hs-special">]</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-194"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683433267"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_tr_module</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683433265"><span class="hs-identifier hs-var">mod_id</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-195"></a><span>                 </span><span class="hs-special">`</span><a href="TcBinds.html#addTypecheckedBinds"><span class="hs-identifier hs-var">addTypecheckedBinds</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">unitBag</span><span> </span><a href="#local-6989586621683433266"><span class="hs-identifier hs-var">mod_bind</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-196"></a><span>
</span><a name="line-197"></a><span class="hs-identifier">mkModIdRHS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span>
</span><a name="line-198"></a><a name="mkModIdRHS"><a href="TcTypeable.html#mkModIdRHS"><span class="hs-identifier">mkModIdRHS</span></a></a><span> </span><a name="local-6989586621683433268"><a href="#local-6989586621683433268"><span class="hs-identifier">mod</span></a></a><span>
</span><a name="line-199"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683433269"><a href="#local-6989586621683433269"><span class="hs-identifier">trModuleDataCon</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupDataCon"><span class="hs-identifier hs-var">tcLookupDataCon</span></a><span> </span><span class="hs-identifier hs-var">trModuleDataConName</span><span>
</span><a name="line-200"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683433270"><a href="#local-6989586621683433270"><span class="hs-identifier">trNameLit</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTypeable.html#mkTrNameLit"><span class="hs-identifier hs-var">mkTrNameLit</span></a><span>
</span><a name="line-201"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">nlHsDataCon</span><span> </span><a href="#local-6989586621683433269"><span class="hs-identifier hs-var">trModuleDataCon</span></a><span>
</span><a name="line-202"></a><span>                  </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683433270"><span class="hs-identifier hs-var">trNameLit</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitIdFS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621683433268"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-203"></a><span>                  </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683433270"><span class="hs-identifier hs-var">trNameLit</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">moduleNameFS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621683433268"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-204"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-205"></a><span>
</span><a name="line-206"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
                Building type-representation bindings
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-211"></a><span>
</span><a name="line-212"></a><span class="hs-comment">-- | Information we need about a 'TyCon' to generate its representation. We</span><span>
</span><a name="line-213"></a><span class="hs-comment">-- carry the 'Id' in order to share it between the generation of the @TyCon@ and</span><span>
</span><a name="line-214"></a><span class="hs-comment">-- @KindRep@ bindings.</span><span>
</span><a name="line-215"></a><span class="hs-keyword">data</span><span> </span><a name="TypeableTyCon"><a href="TcTypeable.html#TypeableTyCon"><span class="hs-identifier">TypeableTyCon</span></a></a><span>
</span><a name="line-216"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a name="TypeableTyCon"><a href="TcTypeable.html#TypeableTyCon"><span class="hs-identifier">TypeableTyCon</span></a></a><span>
</span><a name="line-217"></a><span>      </span><span class="hs-special">{</span><span> </span><a name="tycon"><a href="TcTypeable.html#tycon"><span class="hs-identifier">tycon</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">TyCon</span><span>
</span><a name="line-218"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="tycon_rep_id"><a href="TcTypeable.html#tycon_rep_id"><span class="hs-identifier">tycon_rep_id</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-219"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-220"></a><span>
</span><a name="line-221"></a><span class="hs-comment">-- | A group of 'TyCon's in need of type-rep bindings.</span><span>
</span><a name="line-222"></a><span class="hs-keyword">data</span><span> </span><a name="TypeRepTodo"><a href="TcTypeable.html#TypeRepTodo"><span class="hs-identifier">TypeRepTodo</span></a></a><span>
</span><a name="line-223"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a name="TypeRepTodo"><a href="TcTypeable.html#TypeRepTodo"><span class="hs-identifier">TypeRepTodo</span></a></a><span>
</span><a name="line-224"></a><span>      </span><span class="hs-special">{</span><span> </span><a name="mod_rep_expr"><a href="TcTypeable.html#mod_rep_expr"><span class="hs-identifier">mod_rep_expr</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>    </span><span class="hs-comment">-- ^ Module's typerep binding</span><span>
</span><a name="line-225"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="pkg_fingerprint"><a href="TcTypeable.html#pkg_fingerprint"><span class="hs-identifier">pkg_fingerprint</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Fingerprint</span><span>     </span><span class="hs-comment">-- ^ Package name fingerprint</span><span>
</span><a name="line-226"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="mod_fingerprint"><a href="TcTypeable.html#mod_fingerprint"><span class="hs-identifier">mod_fingerprint</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Fingerprint</span><span>     </span><span class="hs-comment">-- ^ Module name fingerprint</span><span>
</span><a name="line-227"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="todo_tycons"><a href="TcTypeable.html#todo_tycons"><span class="hs-identifier">todo_tycons</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcTypeable.html#TypeableTyCon"><span class="hs-identifier hs-type">TypeableTyCon</span></a><span class="hs-special">]</span><span>
</span><a name="line-228"></a><span>        </span><span class="hs-comment">-- ^ The 'TyCon's in need of bindings kinds</span><span>
</span><a name="line-229"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-230"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="ExportedKindRepsTodo"><a href="TcTypeable.html#ExportedKindRepsTodo"><span class="hs-identifier">ExportedKindRepsTodo</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Kind</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-231"></a><span>      </span><span class="hs-comment">-- ^ Build exported 'KindRep' bindings for the given set of kinds.</span><span>
</span><a name="line-232"></a><span>
</span><a name="line-233"></a><span class="hs-identifier">todoForTyCons</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyCon</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="TcTypeable.html#TypeRepTodo"><span class="hs-identifier hs-type">TypeRepTodo</span></a><span>
</span><a name="line-234"></a><a name="todoForTyCons"><a href="TcTypeable.html#todoForTyCons"><span class="hs-identifier">todoForTyCons</span></a></a><span> </span><a name="local-6989586621683433271"><a href="#local-6989586621683433271"><span class="hs-identifier">mod</span></a></a><span> </span><a name="local-6989586621683433272"><a href="#local-6989586621683433272"><span class="hs-identifier">mod_id</span></a></a><span> </span><a name="local-6989586621683433273"><a href="#local-6989586621683433273"><span class="hs-identifier">tycons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-235"></a><span>    </span><a name="local-6989586621683433276"><a href="#local-6989586621683433276"><span class="hs-identifier">trTyConTy</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mkTyConTy</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><span class="hs-identifier hs-var">trTyConTyConName</span><span>
</span><a name="line-236"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">mk_rep_id</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyConRepName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-237"></a><span>        </span><a name="local-6989586621683433277"><a href="#local-6989586621683433277"><span class="hs-identifier">mk_rep_id</span></a></a><span> </span><a name="local-6989586621683433278"><a href="#local-6989586621683433278"><span class="hs-identifier">rep_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkExportedVanillaId</span><span> </span><a href="#local-6989586621683433278"><span class="hs-identifier hs-var">rep_name</span></a><span> </span><a href="#local-6989586621683433276"><span class="hs-identifier hs-var">trTyConTy</span></a><span>
</span><a name="line-238"></a><span>
</span><a name="line-239"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">typeable_tycons</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcTypeable.html#TypeableTyCon"><span class="hs-identifier hs-type">TypeableTyCon</span></a><span class="hs-special">]</span><span>
</span><a name="line-240"></a><span>        </span><a name="local-6989586621683433279"><a href="#local-6989586621683433279"><span class="hs-identifier">typeable_tycons</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-241"></a><span>            </span><span class="hs-special">[</span><span> </span><a href="TcTypeable.html#TypeableTyCon"><span class="hs-identifier hs-var">TypeableTyCon</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tycon</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683433283"><span class="hs-identifier hs-var">tc''</span></a><span>
</span><a name="line-242"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tycon_rep_id</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683433277"><span class="hs-identifier hs-var">mk_rep_id</span></a><span> </span><a href="#local-6989586621683433284"><span class="hs-identifier hs-var">rep_name</span></a><span>
</span><a name="line-243"></a><span>                            </span><span class="hs-special">}</span><span>
</span><a name="line-244"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683433280"><a href="#local-6989586621683433280"><span class="hs-identifier">tc</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683433273"><span class="hs-identifier hs-var">tycons</span></a><span>
</span><a name="line-245"></a><span>            </span><span class="hs-special">,</span><span> </span><a name="local-6989586621683433281"><a href="#local-6989586621683433281"><span class="hs-identifier">tc'</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683433280"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">tyConATs</span><span> </span><a href="#local-6989586621683433280"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-246"></a><span>              </span><span class="hs-comment">-- We need type representations for any associated types</span><span>
</span><a name="line-247"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683433282"><a href="#local-6989586621683433282"><span class="hs-identifier">promoted</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">promoteDataCon</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConDataCons</span><span> </span><a href="#local-6989586621683433281"><span class="hs-identifier hs-var">tc'</span></a><span class="hs-special">)</span><span>
</span><a name="line-248"></a><span>            </span><span class="hs-special">,</span><span> </span><a name="local-6989586621683433283"><a href="#local-6989586621683433283"><span class="hs-identifier">tc''</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683433281"><span class="hs-identifier hs-var">tc'</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683433282"><span class="hs-identifier hs-var">promoted</span></a><span>
</span><a name="line-249"></a><span>              </span><span class="hs-comment">-- Don't make bindings for data-family instance tycons.</span><span>
</span><a name="line-250"></a><span>              </span><span class="hs-comment">-- Do, however, make them for their promoted datacon (see #13915).</span><span>
</span><a name="line-251"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">isFamInstTyCon</span><span> </span><a href="#local-6989586621683433283"><span class="hs-identifier hs-var">tc''</span></a><span>
</span><a name="line-252"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683433284"><a href="#local-6989586621683433284"><span class="hs-identifier">rep_name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">tyConRepName_maybe</span><span> </span><a href="#local-6989586621683433283"><span class="hs-identifier hs-var">tc''</span></a><span>
</span><a name="line-253"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="TcTypeable.html#typeIsTypeable"><span class="hs-identifier hs-var">typeIsTypeable</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">dropForAlls</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">tyConKind</span><span> </span><a href="#local-6989586621683433283"><span class="hs-identifier hs-var">tc''</span></a><span>
</span><a name="line-254"></a><span>            </span><span class="hs-special">]</span><span>
</span><a name="line-255"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="TcTypeable.html#TypeRepTodo"><span class="hs-identifier hs-var">TypeRepTodo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mod_rep_expr</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><a href="#local-6989586621683433272"><span class="hs-identifier hs-var">mod_id</span></a><span>
</span><a name="line-256"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pkg_fingerprint</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683433275"><span class="hs-identifier hs-var">pkg_fpr</span></a><span>
</span><a name="line-257"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mod_fingerprint</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683433274"><span class="hs-identifier hs-var">mod_fpr</span></a><span>
</span><a name="line-258"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">todo_tycons</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683433279"><span class="hs-identifier hs-var">typeable_tycons</span></a><span>
</span><a name="line-259"></a><span>                       </span><span class="hs-special">}</span><span>
</span><a name="line-260"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-261"></a><span>    </span><a name="local-6989586621683433274"><a href="#local-6989586621683433274"><span class="hs-identifier">mod_fpr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fingerprintString</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">moduleNameString</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621683433271"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-262"></a><span>    </span><a name="local-6989586621683433275"><a href="#local-6989586621683433275"><span class="hs-identifier">pkg_fpr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fingerprintString</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unitIdString</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621683433271"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-263"></a><span>
</span><a name="line-264"></a><span class="hs-identifier">todoForExportedKindReps</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Kind</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="TcTypeable.html#TypeRepTodo"><span class="hs-identifier hs-type">TypeRepTodo</span></a><span>
</span><a name="line-265"></a><a name="todoForExportedKindReps"><a href="TcTypeable.html#todoForExportedKindReps"><span class="hs-identifier">todoForExportedKindReps</span></a></a><span> </span><a name="local-6989586621683433285"><a href="#local-6989586621683433285"><span class="hs-identifier">kinds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-266"></a><span>    </span><a name="local-6989586621683433286"><a href="#local-6989586621683433286"><span class="hs-identifier">trKindRepTy</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mkTyConTy</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><span class="hs-identifier hs-var">kindRepTyConName</span><span>
</span><a name="line-267"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683433287"><a href="#local-6989586621683433287"><span class="hs-identifier">mkId</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683433288"><a href="#local-6989586621683433288"><span class="hs-identifier">k</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683433289"><a href="#local-6989586621683433289"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683433288"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkExportedVanillaId</span><span> </span><a href="#local-6989586621683433289"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683433286"><span class="hs-identifier hs-var">trKindRepTy</span></a><span class="hs-special">)</span><span>
</span><a name="line-268"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcTypeable.html#ExportedKindRepsTodo"><span class="hs-identifier hs-var">ExportedKindRepsTodo</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621683433287"><span class="hs-identifier hs-var">mkId</span></a><span> </span><a href="#local-6989586621683433285"><span class="hs-identifier hs-var">kinds</span></a><span>
</span><a name="line-269"></a><span>
</span><a name="line-270"></a><span class="hs-comment">-- | Generate TyCon bindings for a set of type constructors</span><span>
</span><a name="line-271"></a><span class="hs-identifier">mkTypeRepTodoBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcTypeable.html#TypeRepTodo"><span class="hs-identifier hs-type">TypeRepTodo</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-272"></a><a name="mkTypeRepTodoBinds"><a href="TcTypeable.html#mkTypeRepTodoBinds"><span class="hs-identifier">mkTypeRepTodoBinds</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-273"></a><span class="hs-identifier">mkTypeRepTodoBinds</span><span> </span><a name="local-6989586621683433290"><a href="#local-6989586621683433290"><span class="hs-identifier">todos</span></a></a><span>
</span><a name="line-274"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683433291"><a href="#local-6989586621683433291"><span class="hs-identifier">stuff</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTypeable.html#collect_stuff"><span class="hs-identifier hs-var">collect_stuff</span></a><span>
</span><a name="line-275"></a><span>
</span><a name="line-276"></a><span>         </span><span class="hs-comment">-- First extend the type environment with all of the bindings</span><span>
</span><a name="line-277"></a><span>         </span><span class="hs-comment">-- which we are going to produce since we may need to refer to them</span><span>
</span><a name="line-278"></a><span>         </span><span class="hs-comment">-- while generating kind representations (namely, when we want to</span><span>
</span><a name="line-279"></a><span>         </span><span class="hs-comment">-- represent a TyConApp in a kind, we must be able to look up the</span><span>
</span><a name="line-280"></a><span>         </span><span class="hs-comment">-- TyCon associated with the applied type constructor).</span><span>
</span><a name="line-281"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">produced_bndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>
</span><a name="line-282"></a><span>             </span><a name="local-6989586621683433292"><a href="#local-6989586621683433292"><span class="hs-identifier">produced_bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621683433295"><span class="hs-identifier hs-var">tycon_rep_id</span></a><span>
</span><a name="line-283"></a><span>                              </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683433293"><a href="#local-6989586621683433293"><span class="hs-identifier">todo</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcTypeable.html#TypeRepTodo"><span class="hs-identifier hs-var">TypeRepTodo</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683433290"><span class="hs-identifier hs-var">todos</span></a><span>
</span><a name="line-284"></a><span>                              </span><span class="hs-special">,</span><span> </span><a href="TcTypeable.html#TypeableTyCon"><span class="hs-identifier hs-var">TypeableTyCon</span></a><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">todo_tycons</span><span> </span><a href="#local-6989586621683433293"><span class="hs-identifier hs-var">todo</span></a><span>
</span><a name="line-285"></a><span>                              </span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-286"></a><span>                              </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621683433297"><span class="hs-identifier hs-var">rep_id</span></a><span>
</span><a name="line-287"></a><span>                              </span><span class="hs-glyph">|</span><span> </span><a href="TcTypeable.html#ExportedKindRepsTodo"><span class="hs-identifier hs-var">ExportedKindRepsTodo</span></a><span> </span><a name="local-6989586621683433296"><a href="#local-6989586621683433296"><span class="hs-identifier">kinds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683433290"><span class="hs-identifier hs-var">todos</span></a><span>
</span><a name="line-288"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683433297"><a href="#local-6989586621683433297"><span class="hs-identifier">rep_id</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683433296"><span class="hs-identifier hs-var">kinds</span></a><span>
</span><a name="line-289"></a><span>                              </span><span class="hs-special">]</span><span>
</span><a name="line-290"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683433298"><a href="#local-6989586621683433298"><span class="hs-identifier">gbl_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcExtendGlobalValEnv"><span class="hs-identifier hs-var">tcExtendGlobalValEnv</span></a><span> </span><a href="#local-6989586621683433292"><span class="hs-identifier hs-var">produced_bndrs</span></a><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-291"></a><span>
</span><a name="line-292"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">mk_binds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcTypeable.html#TypeRepTodo"><span class="hs-identifier hs-type">TypeRepTodo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTypeable.html#KindRepM"><span class="hs-identifier hs-type">KindRepM</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">]</span><span>
</span><a name="line-293"></a><span>             </span><a name="local-6989586621683433299"><a href="#local-6989586621683433299"><span class="hs-identifier">mk_binds</span></a></a><span> </span><a name="local-6989586621683433300"><a href="#local-6989586621683433300"><span class="hs-identifier">todo</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcTypeable.html#TypeRepTodo"><span class="hs-identifier hs-var">TypeRepTodo</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-294"></a><span>                 </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="TcTypeable.html#mkTyConRepBinds"><span class="hs-identifier hs-var">mkTyConRepBinds</span></a><span> </span><a href="#local-6989586621683433291"><span class="hs-identifier hs-var">stuff</span></a><span> </span><a href="#local-6989586621683433300"><span class="hs-identifier hs-var">todo</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">todo_tycons</span><span> </span><a href="#local-6989586621683433300"><span class="hs-identifier hs-var">todo</span></a><span class="hs-special">)</span><span>
</span><a name="line-295"></a><span>             </span><span class="hs-identifier">mk_binds</span><span> </span><span class="hs-special">(</span><a href="TcTypeable.html#ExportedKindRepsTodo"><span class="hs-identifier hs-var">ExportedKindRepsTodo</span></a><span> </span><a name="local-6989586621683433301"><a href="#local-6989586621683433301"><span class="hs-identifier">kinds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-296"></a><span>                 </span><a href="TcTypeable.html#mkExportedKindReps"><span class="hs-identifier hs-var">mkExportedKindReps</span></a><span> </span><a href="#local-6989586621683433291"><span class="hs-identifier hs-var">stuff</span></a><span> </span><a href="#local-6989586621683433301"><span class="hs-identifier hs-var">kinds</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-297"></a><span>
</span><a name="line-298"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683433302"><a href="#local-6989586621683433302"><span class="hs-identifier">gbl_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683433303"><a href="#local-6989586621683433303"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><a href="#local-6989586621683433298"><span class="hs-identifier hs-var">gbl_env</span></a><span>
</span><a name="line-299"></a><span>                             </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcTypeable.html#runKindRepM"><span class="hs-identifier hs-var">runKindRepM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621683433299"><span class="hs-identifier hs-var">mk_binds</span></a><span> </span><a href="#local-6989586621683433290"><span class="hs-identifier hs-var">todos</span></a><span class="hs-special">)</span><span>
</span><a name="line-300"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683433302"><span class="hs-identifier hs-var">gbl_env</span></a><span> </span><span class="hs-special">`</span><a href="TcBinds.html#addTypecheckedBinds"><span class="hs-identifier hs-var">addTypecheckedBinds</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-6989586621683433303"><span class="hs-identifier hs-var">binds</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-301"></a><span>
</span><a name="line-302"></a><span class="hs-comment">-- | Generate bindings for the type representation of a wired-in 'TyCon's</span><span>
</span><a name="line-303"></a><span class="hs-comment">-- defined by the virtual &quot;GHC.Prim&quot; module. This is where we inject the</span><span>
</span><a name="line-304"></a><span class="hs-comment">-- representation bindings for these primitive types into &quot;GHC.Types&quot;</span><span>
</span><a name="line-305"></a><span class="hs-comment">--</span><span>
</span><a name="line-306"></a><span class="hs-comment">-- See Note [Grand plan for Typeable] in this module.</span><span>
</span><a name="line-307"></a><span class="hs-identifier">mkPrimTypeableTodos</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcGblEnv</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TcTypeable.html#TypeRepTodo"><span class="hs-identifier hs-type">TypeRepTodo</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-308"></a><a name="mkPrimTypeableTodos"><a href="TcTypeable.html#mkPrimTypeableTodos"><span class="hs-identifier">mkPrimTypeableTodos</span></a></a><span>
</span><a name="line-309"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683433304"><a href="#local-6989586621683433304"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-310"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683433304"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">gHC_TYPES</span><span>
</span><a name="line-311"></a><span>           </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Build Module binding for GHC.Prim</span><span>
</span><a name="line-312"></a><span>                     </span><a name="local-6989586621683433305"><a href="#local-6989586621683433305"><span class="hs-identifier">trModuleTyCon</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><span class="hs-identifier hs-var">trModuleTyConName</span><span>
</span><a name="line-313"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683433306"><a href="#local-6989586621683433306"><span class="hs-identifier">ghc_prim_module_id</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-314"></a><span>                             </span><span class="hs-identifier hs-var">mkExportedVanillaId</span><span> </span><span class="hs-identifier hs-var">trGhcPrimModuleName</span><span>
</span><a name="line-315"></a><span>                                                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConTy</span><span> </span><a href="#local-6989586621683433305"><span class="hs-identifier hs-var">trModuleTyCon</span></a><span class="hs-special">)</span><span>
</span><a name="line-316"></a><span>
</span><a name="line-317"></a><span>                   </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683433307"><a href="#local-6989586621683433307"><span class="hs-identifier">ghc_prim_module_bind</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mkVarBind</span><span> </span><a href="#local-6989586621683433306"><span class="hs-identifier hs-var">ghc_prim_module_id</span></a><span>
</span><a name="line-318"></a><span>                                             </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcTypeable.html#mkModIdRHS"><span class="hs-identifier hs-var">mkModIdRHS</span></a><span> </span><span class="hs-identifier hs-var">gHC_PRIM</span><span>
</span><a name="line-319"></a><span>
</span><a name="line-320"></a><span>                     </span><span class="hs-comment">-- Extend our environment with above</span><span>
</span><a name="line-321"></a><span>                   </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683433308"><a href="#local-6989586621683433308"><span class="hs-identifier">gbl_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcExtendGlobalValEnv"><span class="hs-identifier hs-var">tcExtendGlobalValEnv</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683433306"><span class="hs-identifier hs-var">ghc_prim_module_id</span></a><span class="hs-special">]</span><span>
</span><a name="line-322"></a><span>                                                     </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-323"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683433309"><a href="#local-6989586621683433309"><span class="hs-identifier">gbl_env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683433308"><span class="hs-identifier hs-var">gbl_env</span></a><span> </span><span class="hs-special">`</span><a href="TcBinds.html#addTypecheckedBinds"><span class="hs-identifier hs-var">addTypecheckedBinds</span></a><span class="hs-special">`</span><span>
</span><a name="line-324"></a><span>                                    </span><span class="hs-special">[</span><span class="hs-identifier hs-var">unitBag</span><span> </span><a href="#local-6989586621683433307"><span class="hs-identifier hs-var">ghc_prim_module_bind</span></a><span class="hs-special">]</span><span>
</span><a name="line-325"></a><span>
</span><a name="line-326"></a><span>                     </span><span class="hs-comment">-- Build TypeRepTodos for built-in KindReps</span><span>
</span><a name="line-327"></a><span>                   </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683433310"><a href="#local-6989586621683433310"><span class="hs-identifier">todo1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTypeable.html#todoForExportedKindReps"><span class="hs-identifier hs-var">todoForExportedKindReps</span></a><span> </span><a href="TcTypeable.html#builtInKindReps"><span class="hs-identifier hs-var">builtInKindReps</span></a><span>
</span><a name="line-328"></a><span>                     </span><span class="hs-comment">-- Build TypeRepTodos for types in GHC.Prim</span><span>
</span><a name="line-329"></a><span>                   </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683433311"><a href="#local-6989586621683433311"><span class="hs-identifier">todo2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTypeable.html#todoForTyCons"><span class="hs-identifier hs-var">todoForTyCons</span></a><span> </span><span class="hs-identifier hs-var">gHC_PRIM</span><span> </span><a href="#local-6989586621683433306"><span class="hs-identifier hs-var">ghc_prim_module_id</span></a><span>
</span><a name="line-330"></a><span>                                            </span><a href="TcTypeable.html#ghcPrimTypeableTyCons"><span class="hs-identifier hs-var">ghcPrimTypeableTyCons</span></a><span>
</span><a name="line-331"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621683433309"><span class="hs-identifier hs-var">gbl_env'</span></a><span> </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683433310"><span class="hs-identifier hs-var">todo1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683433311"><span class="hs-identifier hs-var">todo2</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-332"></a><span>                   </span><span class="hs-special">}</span><span>
</span><a name="line-333"></a><span>           </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621683433312"><a href="#local-6989586621683433312"><span class="hs-identifier">gbl_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-334"></a><span>                   </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683433312"><span class="hs-identifier hs-var">gbl_env</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-335"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-336"></a><span>
</span><a name="line-337"></a><span class="hs-comment">-- | This is the list of primitive 'TyCon's for which we must generate bindings</span><span>
</span><a name="line-338"></a><span class="hs-comment">-- in &quot;GHC.Types&quot;. This should include all types defined in &quot;GHC.Prim&quot;.</span><span>
</span><a name="line-339"></a><span class="hs-comment">--</span><span>
</span><a name="line-340"></a><span class="hs-comment">-- The majority of the types we need here are contained in 'primTyCons'.</span><span>
</span><a name="line-341"></a><span class="hs-comment">-- However, not all of them: in particular unboxed tuples are absent since we</span><span>
</span><a name="line-342"></a><span class="hs-comment">-- don't want to include them in the original name cache. See</span><span>
</span><a name="line-343"></a><span class="hs-comment">-- Note [Built-in syntax and the OrigNameCache] in IfaceEnv for more.</span><span>
</span><a name="line-344"></a><span class="hs-identifier">ghcPrimTypeableTyCons</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyCon</span><span class="hs-special">]</span><span>
</span><a name="line-345"></a><a name="ghcPrimTypeableTyCons"><a href="TcTypeable.html#ghcPrimTypeableTyCons"><span class="hs-identifier">ghcPrimTypeableTyCons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concat</span><span>
</span><a name="line-346"></a><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">runtimeRepTyCon</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">vecCountTyCon</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">vecElemTyCon</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">funTyCon</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-347"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tupleTyCon</span><span> </span><span class="hs-identifier hs-var">Unboxed</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-identifier hs-var">mAX_TUPLE_SIZE</span><span class="hs-special">]</span><span>
</span><a name="line-348"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">sumTyCon</span><span> </span><span class="hs-special">[</span><span class="hs-number">2</span><span class="hs-glyph">..</span><span class="hs-identifier hs-var">mAX_SUM_SIZE</span><span class="hs-special">]</span><span>
</span><a name="line-349"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">primTyCons</span><span>
</span><a name="line-350"></a><span>    </span><span class="hs-special">]</span><span>
</span><a name="line-351"></a><span>
</span><a name="line-352"></a><span class="hs-keyword">data</span><span> </span><a name="TypeableStuff"><a href="TcTypeable.html#TypeableStuff"><span class="hs-identifier">TypeableStuff</span></a></a><span>
</span><a name="line-353"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a name="Stuff"><a href="TcTypeable.html#Stuff"><span class="hs-identifier">Stuff</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="dflags"><a href="TcTypeable.html#dflags"><span class="hs-identifier">dflags</span></a></a><span>         </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-354"></a><span>            </span><span class="hs-special">,</span><span> </span><a name="trTyConDataCon"><a href="TcTypeable.html#trTyConDataCon"><span class="hs-identifier">trTyConDataCon</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span>         </span><span class="hs-comment">-- ^ of @TyCon@</span><span>
</span><a name="line-355"></a><span>            </span><span class="hs-special">,</span><span> </span><a name="trNameLit"><a href="TcTypeable.html#trNameLit"><span class="hs-identifier">trNameLit</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-356"></a><span>                                                </span><span class="hs-comment">-- ^ To construct @TrName@s</span><span>
</span><a name="line-357"></a><span>              </span><span class="hs-comment">-- The various TyCon and DataCons of KindRep</span><span>
</span><a name="line-358"></a><span>            </span><span class="hs-special">,</span><span> </span><a name="kindRepTyCon"><a href="TcTypeable.html#kindRepTyCon"><span class="hs-identifier">kindRepTyCon</span></a></a><span>           </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span>
</span><a name="line-359"></a><span>            </span><span class="hs-special">,</span><span> </span><a name="kindRepTyConAppDataCon"><a href="TcTypeable.html#kindRepTyConAppDataCon"><span class="hs-identifier">kindRepTyConAppDataCon</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span>
</span><a name="line-360"></a><span>            </span><span class="hs-special">,</span><span> </span><a name="kindRepVarDataCon"><a href="TcTypeable.html#kindRepVarDataCon"><span class="hs-identifier">kindRepVarDataCon</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span>
</span><a name="line-361"></a><span>            </span><span class="hs-special">,</span><span> </span><a name="kindRepAppDataCon"><a href="TcTypeable.html#kindRepAppDataCon"><span class="hs-identifier">kindRepAppDataCon</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span>
</span><a name="line-362"></a><span>            </span><span class="hs-special">,</span><span> </span><a name="kindRepFunDataCon"><a href="TcTypeable.html#kindRepFunDataCon"><span class="hs-identifier">kindRepFunDataCon</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span>
</span><a name="line-363"></a><span>            </span><span class="hs-special">,</span><span> </span><a name="kindRepTYPEDataCon"><a href="TcTypeable.html#kindRepTYPEDataCon"><span class="hs-identifier">kindRepTYPEDataCon</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span>
</span><a name="line-364"></a><span>            </span><span class="hs-special">,</span><span> </span><a name="kindRepTypeLitSDataCon"><a href="TcTypeable.html#kindRepTypeLitSDataCon"><span class="hs-identifier">kindRepTypeLitSDataCon</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span>
</span><a name="line-365"></a><span>            </span><span class="hs-special">,</span><span> </span><a name="typeLitSymbolDataCon"><a href="TcTypeable.html#typeLitSymbolDataCon"><span class="hs-identifier">typeLitSymbolDataCon</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span>
</span><a name="line-366"></a><span>            </span><span class="hs-special">,</span><span> </span><a name="typeLitNatDataCon"><a href="TcTypeable.html#typeLitNatDataCon"><span class="hs-identifier">typeLitNatDataCon</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span>
</span><a name="line-367"></a><span>            </span><span class="hs-special">}</span><span>
</span><a name="line-368"></a><span>
</span><a name="line-369"></a><span class="hs-comment">-- | Collect various tidbits which we'll need to generate TyCon representations.</span><span>
</span><a name="line-370"></a><span class="hs-identifier">collect_stuff</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="TcTypeable.html#TypeableStuff"><span class="hs-identifier hs-type">TypeableStuff</span></a><span>
</span><a name="line-371"></a><a name="collect_stuff"><a href="TcTypeable.html#collect_stuff"><span class="hs-identifier">collect_stuff</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-372"></a><span>    </span><a name="local-6989586621683433313"><a href="#local-6989586621683433313"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-373"></a><span>    </span><a name="local-6989586621683433314"><a href="#local-6989586621683433314"><span class="hs-identifier">trTyConDataCon</span></a></a><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupDataCon"><span class="hs-identifier hs-var">tcLookupDataCon</span></a><span> </span><span class="hs-identifier hs-var">trTyConDataConName</span><span>
</span><a name="line-374"></a><span>    </span><a name="local-6989586621683433315"><a href="#local-6989586621683433315"><span class="hs-identifier">kindRepTyCon</span></a></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span>   </span><span class="hs-identifier hs-var">kindRepTyConName</span><span>
</span><a name="line-375"></a><span>    </span><a name="local-6989586621683433316"><a href="#local-6989586621683433316"><span class="hs-identifier">kindRepTyConAppDataCon</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupDataCon"><span class="hs-identifier hs-var">tcLookupDataCon</span></a><span> </span><span class="hs-identifier hs-var">kindRepTyConAppDataConName</span><span>
</span><a name="line-376"></a><span>    </span><a name="local-6989586621683433317"><a href="#local-6989586621683433317"><span class="hs-identifier">kindRepVarDataCon</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupDataCon"><span class="hs-identifier hs-var">tcLookupDataCon</span></a><span> </span><span class="hs-identifier hs-var">kindRepVarDataConName</span><span>
</span><a name="line-377"></a><span>    </span><a name="local-6989586621683433318"><a href="#local-6989586621683433318"><span class="hs-identifier">kindRepAppDataCon</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupDataCon"><span class="hs-identifier hs-var">tcLookupDataCon</span></a><span> </span><span class="hs-identifier hs-var">kindRepAppDataConName</span><span>
</span><a name="line-378"></a><span>    </span><a name="local-6989586621683433319"><a href="#local-6989586621683433319"><span class="hs-identifier">kindRepFunDataCon</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupDataCon"><span class="hs-identifier hs-var">tcLookupDataCon</span></a><span> </span><span class="hs-identifier hs-var">kindRepFunDataConName</span><span>
</span><a name="line-379"></a><span>    </span><a name="local-6989586621683433320"><a href="#local-6989586621683433320"><span class="hs-identifier">kindRepTYPEDataCon</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupDataCon"><span class="hs-identifier hs-var">tcLookupDataCon</span></a><span> </span><span class="hs-identifier hs-var">kindRepTYPEDataConName</span><span>
</span><a name="line-380"></a><span>    </span><a name="local-6989586621683433321"><a href="#local-6989586621683433321"><span class="hs-identifier">kindRepTypeLitSDataCon</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupDataCon"><span class="hs-identifier hs-var">tcLookupDataCon</span></a><span> </span><span class="hs-identifier hs-var">kindRepTypeLitSDataConName</span><span>
</span><a name="line-381"></a><span>    </span><a name="local-6989586621683433322"><a href="#local-6989586621683433322"><span class="hs-identifier">typeLitSymbolDataCon</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupDataCon"><span class="hs-identifier hs-var">tcLookupDataCon</span></a><span> </span><span class="hs-identifier hs-var">typeLitSymbolDataConName</span><span>
</span><a name="line-382"></a><span>    </span><a name="local-6989586621683433323"><a href="#local-6989586621683433323"><span class="hs-identifier">typeLitNatDataCon</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupDataCon"><span class="hs-identifier hs-var">tcLookupDataCon</span></a><span> </span><span class="hs-identifier hs-var">typeLitNatDataConName</span><span>
</span><a name="line-383"></a><span>    </span><a name="local-6989586621683433324"><a href="#local-6989586621683433324"><span class="hs-identifier">trNameLit</span></a></a><span>              </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTypeable.html#mkTrNameLit"><span class="hs-identifier hs-var">mkTrNameLit</span></a><span>
</span><a name="line-384"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="TcTypeable.html#Stuff"><span class="hs-identifier hs-var">Stuff</span></a><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span>
</span><a name="line-385"></a><span>
</span><a name="line-386"></a><span class="hs-comment">-- | Lookup the necessary pieces to construct the @trNameLit@. We do this so we</span><span>
</span><a name="line-387"></a><span class="hs-comment">-- can save the work of repeating lookups when constructing many TyCon</span><span>
</span><a name="line-388"></a><span class="hs-comment">-- representations.</span><span>
</span><a name="line-389"></a><span class="hs-identifier">mkTrNameLit</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span>
</span><a name="line-390"></a><a name="mkTrNameLit"><a href="TcTypeable.html#mkTrNameLit"><span class="hs-identifier">mkTrNameLit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-391"></a><span>    </span><a name="local-6989586621683433325"><a href="#local-6989586621683433325"><span class="hs-identifier">trNameSDataCon</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupDataCon"><span class="hs-identifier hs-var">tcLookupDataCon</span></a><span> </span><span class="hs-identifier hs-var">trNameSDataConName</span><span>
</span><a name="line-392"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">trNameLit</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-393"></a><span>        </span><a name="local-6989586621683433326"><a href="#local-6989586621683433326"><span class="hs-identifier">trNameLit</span></a></a><span> </span><a name="local-6989586621683433327"><a href="#local-6989586621683433327"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nlHsPar</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">nlHsDataCon</span><span> </span><a href="#local-6989586621683433325"><span class="hs-identifier hs-var">trNameSDataCon</span></a><span>
</span><a name="line-394"></a><span>                       </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">nlHsLit</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsStringPrimLit</span><span> </span><a href="#local-6989586621683433327"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span>
</span><a name="line-395"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683433326"><span class="hs-identifier hs-var">trNameLit</span></a><span>
</span><a name="line-396"></a><span>
</span><a name="line-397"></a><span class="hs-comment">-- | Make Typeable bindings for the given 'TyCon'.</span><span>
</span><a name="line-398"></a><span class="hs-identifier">mkTyConRepBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcTypeable.html#TypeableStuff"><span class="hs-identifier hs-type">TypeableStuff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTypeable.html#TypeRepTodo"><span class="hs-identifier hs-type">TypeRepTodo</span></a><span>
</span><a name="line-399"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTypeable.html#TypeableTyCon"><span class="hs-identifier hs-type">TypeableTyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTypeable.html#KindRepM"><span class="hs-identifier hs-type">KindRepM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span>
</span><a name="line-400"></a><a name="mkTyConRepBinds"><a href="TcTypeable.html#mkTyConRepBinds"><span class="hs-identifier">mkTyConRepBinds</span></a></a><span> </span><a name="local-6989586621683433328"><a href="#local-6989586621683433328"><span class="hs-identifier">stuff</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcTypeable.html#Stuff"><span class="hs-identifier hs-var">Stuff</span></a><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683433341"><a href="#local-6989586621683433341"><span class="hs-identifier">todo</span></a></a><span> </span><span class="hs-special">(</span><a href="TcTypeable.html#TypeableTyCon"><span class="hs-identifier hs-var">TypeableTyCon</span></a><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-401"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- Make a KindRep</span><span>
</span><a name="line-402"></a><span>       </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683433344"><a href="#local-6989586621683433344"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683433345"><a href="#local-6989586621683433345"><span class="hs-identifier">kind</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitForAllVarBndrs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConKind</span><span> </span><a href="#local-6989586621683433342"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span>
</span><a name="line-403"></a><span>       </span><a href="TcTypeable.html#liftTc"><span class="hs-identifier hs-var">liftTc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;mkTyConKindRepBinds&quot;</span><span>
</span><a name="line-404"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683433342"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConKind</span><span> </span><a href="#local-6989586621683433342"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683433345"><span class="hs-identifier hs-var">kind</span></a><span class="hs-special">)</span><span>
</span><a name="line-405"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683433346"><a href="#local-6989586621683433346"><span class="hs-identifier">ctx</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkDeBruijnContext</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">binderVar</span><span> </span><a href="#local-6989586621683433344"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-406"></a><span>       </span><a name="local-6989586621683433347"><a href="#local-6989586621683433347"><span class="hs-identifier">kind_rep</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTypeable.html#getKindRep"><span class="hs-identifier hs-var">getKindRep</span></a><span> </span><a href="#local-6989586621683433328"><span class="hs-identifier hs-var">stuff</span></a><span> </span><a href="#local-6989586621683433346"><span class="hs-identifier hs-var">ctx</span></a><span> </span><a href="#local-6989586621683433345"><span class="hs-identifier hs-var">kind</span></a><span>
</span><a name="line-407"></a><span>
</span><a name="line-408"></a><span>       </span><span class="hs-comment">-- Make the TyCon binding</span><span>
</span><a name="line-409"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683433348"><a href="#local-6989586621683433348"><span class="hs-identifier">tycon_rep_rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcTypeable.html#mkTyConRepTyConRHS"><span class="hs-identifier hs-var">mkTyConRepTyConRHS</span></a><span> </span><a href="#local-6989586621683433328"><span class="hs-identifier hs-var">stuff</span></a><span> </span><a href="#local-6989586621683433341"><span class="hs-identifier hs-var">todo</span></a><span> </span><a href="#local-6989586621683433342"><span class="hs-identifier hs-var">tycon</span></a><span> </span><a href="#local-6989586621683433347"><span class="hs-identifier hs-var">kind_rep</span></a><span>
</span><a name="line-410"></a><span>           </span><a name="local-6989586621683433349"><a href="#local-6989586621683433349"><span class="hs-identifier">tycon_rep_bind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkVarBind</span><span> </span><a href="#local-6989586621683433343"><span class="hs-identifier hs-var">tycon_rep_id</span></a><span> </span><a href="#local-6989586621683433348"><span class="hs-identifier hs-var">tycon_rep_rhs</span></a><span>
</span><a name="line-411"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unitBag</span><span> </span><a href="#local-6989586621683433349"><span class="hs-identifier hs-var">tycon_rep_bind</span></a><span>
</span><a name="line-412"></a><span>
</span><a name="line-413"></a><span class="hs-comment">-- | Here is where we define the set of Typeable types. These exclude type</span><span>
</span><a name="line-414"></a><span class="hs-comment">-- families and polytypes.</span><span>
</span><a name="line-415"></a><span class="hs-identifier">tyConIsTypeable</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-416"></a><a name="tyConIsTypeable"><a href="TcTypeable.html#tyConIsTypeable"><span class="hs-identifier">tyConIsTypeable</span></a></a><span> </span><a name="local-6989586621683433350"><a href="#local-6989586621683433350"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-417"></a><span>       </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConRepName_maybe</span><span> </span><a href="#local-6989586621683433350"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-418"></a><span>    </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="TcTypeable.html#typeIsTypeable"><span class="hs-identifier hs-var">typeIsTypeable</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dropForAlls</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">tyConKind</span><span> </span><a href="#local-6989586621683433350"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-419"></a><span>      </span><span class="hs-comment">-- Ensure that the kind of the TyCon, with its initial foralls removed,</span><span>
</span><a name="line-420"></a><span>      </span><span class="hs-comment">-- is representable (e.g. has no higher-rank polymorphism or type</span><span>
</span><a name="line-421"></a><span>      </span><span class="hs-comment">-- synonyms).</span><span>
</span><a name="line-422"></a><span>
</span><a name="line-423"></a><span class="hs-comment">-- | Is a particular 'Type' representable by @Typeable@? Here we look for</span><span>
</span><a name="line-424"></a><span class="hs-comment">-- polytypes and types containing casts (which may be, for instance, a type</span><span>
</span><a name="line-425"></a><span class="hs-comment">-- family).</span><span>
</span><a name="line-426"></a><span class="hs-identifier">typeIsTypeable</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-427"></a><span class="hs-comment">-- We handle types of the form (TYPE rep) specifically to avoid</span><span>
</span><a name="line-428"></a><span class="hs-comment">-- looping on (tyConIsTypeable RuntimeRep)</span><span>
</span><a name="line-429"></a><a name="typeIsTypeable"><a href="TcTypeable.html#typeIsTypeable"><span class="hs-identifier">typeIsTypeable</span></a></a><span> </span><a name="local-6989586621683433351"><a href="#local-6989586621683433351"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-430"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683433352"><a href="#local-6989586621683433352"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">coreView</span><span> </span><a href="#local-6989586621683433351"><span class="hs-identifier hs-var">ty</span></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="TcTypeable.html#typeIsTypeable"><span class="hs-identifier hs-var">typeIsTypeable</span></a><span> </span><a href="#local-6989586621683433352"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-431"></a><span class="hs-identifier">typeIsTypeable</span><span> </span><a name="local-6989586621683433353"><a href="#local-6989586621683433353"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-432"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">kindRep_maybe</span><span> </span><a href="#local-6989586621683433353"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-433"></a><span class="hs-identifier">typeIsTypeable</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyVarTy</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-434"></a><span class="hs-identifier">typeIsTypeable</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AppTy</span><span> </span><a name="local-6989586621683433354"><a href="#local-6989586621683433354"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621683433355"><a href="#local-6989586621683433355"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="TcTypeable.html#typeIsTypeable"><span class="hs-identifier hs-var">typeIsTypeable</span></a><span> </span><a href="#local-6989586621683433354"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="TcTypeable.html#typeIsTypeable"><span class="hs-identifier hs-var">typeIsTypeable</span></a><span> </span><a href="#local-6989586621683433355"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-435"></a><span class="hs-identifier">typeIsTypeable</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunTy</span><span> </span><a name="local-6989586621683433356"><a href="#local-6989586621683433356"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621683433357"><a href="#local-6989586621683433357"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="TcTypeable.html#typeIsTypeable"><span class="hs-identifier hs-var">typeIsTypeable</span></a><span> </span><a href="#local-6989586621683433356"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="TcTypeable.html#typeIsTypeable"><span class="hs-identifier hs-var">typeIsTypeable</span></a><span> </span><a href="#local-6989586621683433357"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-436"></a><span class="hs-identifier">typeIsTypeable</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyConApp</span><span> </span><a name="local-6989586621683433358"><a href="#local-6989586621683433358"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621683433359"><a href="#local-6989586621683433359"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcTypeable.html#tyConIsTypeable"><span class="hs-identifier hs-var">tyConIsTypeable</span></a><span> </span><a href="#local-6989586621683433358"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-437"></a><span>                                   </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><a href="TcTypeable.html#typeIsTypeable"><span class="hs-identifier hs-var">typeIsTypeable</span></a><span> </span><a href="#local-6989586621683433359"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-438"></a><span class="hs-identifier">typeIsTypeable</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ForAllTy</span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-439"></a><span class="hs-identifier">typeIsTypeable</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitTy</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-440"></a><span class="hs-identifier">typeIsTypeable</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CastTy</span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-441"></a><span class="hs-identifier">typeIsTypeable</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoercionTy</span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-442"></a><span>
</span><a name="line-443"></a><span class="hs-comment">-- | Maps kinds to 'KindRep' bindings. This binding may either be defined in</span><span>
</span><a name="line-444"></a><span class="hs-comment">-- some other module (in which case the @Maybe (LHsExpr Id@ will be 'Nothing')</span><span>
</span><a name="line-445"></a><span class="hs-comment">-- or a binding which we generated in the current module (in which case it will</span><span>
</span><a name="line-446"></a><span class="hs-comment">-- be 'Just' the RHS of the binding).</span><span>
</span><a name="line-447"></a><span class="hs-keyword">type</span><span> </span><a name="KindRepEnv"><a href="TcTypeable.html#KindRepEnv"><span class="hs-identifier">KindRepEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">TypeMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-448"></a><span>
</span><a name="line-449"></a><span class="hs-comment">-- | A monad within which we will generate 'KindRep's. Here we keep an</span><span>
</span><a name="line-450"></a><span class="hs-comment">-- environment containing 'KindRep's which we've already generated so we can</span><span>
</span><a name="line-451"></a><span class="hs-comment">-- re-use them opportunistically.</span><span>
</span><a name="line-452"></a><span class="hs-keyword">newtype</span><span> </span><a name="KindRepM"><a href="TcTypeable.html#KindRepM"><span class="hs-identifier">KindRepM</span></a></a><span> </span><a name="local-6989586621683433248"><a href="#local-6989586621683433248"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="KindRepM"><a href="TcTypeable.html#KindRepM"><span class="hs-identifier">KindRepM</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="unKindRepM"><a href="TcTypeable.html#unKindRepM"><span class="hs-identifier">unKindRepM</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">StateT</span><span> </span><a href="TcTypeable.html#KindRepEnv"><span class="hs-identifier hs-type">KindRepEnv</span></a><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621683433248"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-453"></a><span>                   </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Functor</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Monad</span><span class="hs-special">)</span><span>
</span><a name="line-454"></a><span>
</span><a name="line-455"></a><span class="hs-identifier">liftTc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621683433250"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTypeable.html#KindRepM"><span class="hs-identifier hs-type">KindRepM</span></a><span> </span><a href="#local-6989586621683433250"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-456"></a><a name="liftTc"><a href="TcTypeable.html#liftTc"><span class="hs-identifier">liftTc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcTypeable.html#KindRepM"><span class="hs-identifier hs-var">KindRepM</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">lift</span><span>
</span><a name="line-457"></a><span>
</span><a name="line-458"></a><span class="hs-comment">-- | We generate @KindRep@s for a few common kinds in @GHC.Types@ so that they</span><span>
</span><a name="line-459"></a><span class="hs-comment">-- can be reused across modules.</span><span>
</span><a name="line-460"></a><span class="hs-identifier">builtInKindReps</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Kind</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-461"></a><a name="builtInKindReps"><a href="TcTypeable.html#builtInKindReps"><span class="hs-identifier">builtInKindReps</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-462"></a><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683433360"><span class="hs-identifier hs-var">star</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">starKindRepName</span><span class="hs-special">)</span><span>
</span><a name="line-463"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkFunTy</span><span> </span><a href="#local-6989586621683433360"><span class="hs-identifier hs-var">star</span></a><span> </span><a href="#local-6989586621683433360"><span class="hs-identifier hs-var">star</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">starArrStarKindRepName</span><span class="hs-special">)</span><span>
</span><a name="line-464"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkFunTys</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683433360"><span class="hs-identifier hs-var">star</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683433360"><span class="hs-identifier hs-var">star</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621683433360"><span class="hs-identifier hs-var">star</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">starArrStarArrStarKindRepName</span><span class="hs-special">)</span><span>
</span><a name="line-465"></a><span>    </span><span class="hs-special">]</span><span>
</span><a name="line-466"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-467"></a><span>    </span><a name="local-6989586621683433360"><a href="#local-6989586621683433360"><span class="hs-identifier">star</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-468"></a><span>
</span><a name="line-469"></a><span class="hs-identifier">initialKindRepEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="TcTypeable.html#KindRepEnv"><span class="hs-identifier hs-type">KindRepEnv</span></a><span>
</span><a name="line-470"></a><a name="initialKindRepEnv"><a href="TcTypeable.html#initialKindRepEnv"><span class="hs-identifier">initialKindRepEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldlM</span><span> </span><a href="#local-6989586621683433361"><span class="hs-identifier hs-var">add_kind_rep</span></a><span> </span><span class="hs-identifier hs-var">emptyTypeMap</span><span> </span><a href="TcTypeable.html#builtInKindReps"><span class="hs-identifier hs-var">builtInKindReps</span></a><span>
</span><a name="line-471"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-472"></a><span>    </span><a name="local-6989586621683433361"><a href="#local-6989586621683433361"><span class="hs-identifier">add_kind_rep</span></a></a><span> </span><a name="local-6989586621683433362"><a href="#local-6989586621683433362"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683433363"><a href="#local-6989586621683433363"><span class="hs-identifier">k</span></a></a><span class="hs-special">,</span><a name="local-6989586621683433364"><a href="#local-6989586621683433364"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-473"></a><span>        </span><a name="local-6989586621683433365"><a href="#local-6989586621683433365"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupId"><span class="hs-identifier hs-var">tcLookupId</span></a><span> </span><a href="#local-6989586621683433364"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-474"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><span class="hs-identifier hs-var">extendTypeMap</span><span> </span><a href="#local-6989586621683433362"><span class="hs-identifier hs-var">acc</span></a><span> </span><a href="#local-6989586621683433363"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683433365"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-475"></a><span>
</span><a name="line-476"></a><span class="hs-comment">-- | Performed while compiling &quot;GHC.Types&quot; to generate the built-in 'KindRep's.</span><span>
</span><a name="line-477"></a><span class="hs-identifier">mkExportedKindReps</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcTypeable.html#TypeableStuff"><span class="hs-identifier hs-type">TypeableStuff</span></a><span>
</span><a name="line-478"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Kind</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">)</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- ^ the kinds to generate bindings for</span><span>
</span><a name="line-479"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTypeable.html#KindRepM"><span class="hs-identifier hs-type">KindRepM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-480"></a><a name="mkExportedKindReps"><a href="TcTypeable.html#mkExportedKindReps"><span class="hs-identifier">mkExportedKindReps</span></a></a><span> </span><a name="local-6989586621683433366"><a href="#local-6989586621683433366"><span class="hs-identifier">stuff</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcTypeable.html#Stuff"><span class="hs-identifier hs-var">Stuff</span></a><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="#local-6989586621683433380"><span class="hs-identifier hs-var">kindrep_binding</span></a><span>
</span><a name="line-481"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-482"></a><span>    </span><a name="local-6989586621683433379"><a href="#local-6989586621683433379"><span class="hs-identifier">empty_scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkDeBruijnContext</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-483"></a><span>
</span><a name="line-484"></a><span>    </span><span class="hs-identifier">kindrep_binding</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Kind</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTypeable.html#KindRepM"><span class="hs-identifier hs-type">KindRepM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-485"></a><span>    </span><a name="local-6989586621683433380"><a href="#local-6989586621683433380"><span class="hs-identifier">kindrep_binding</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683433381"><a href="#local-6989586621683433381"><span class="hs-identifier">kind</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683433382"><a href="#local-6989586621683433382"><span class="hs-identifier">rep_bndr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-486"></a><span>        </span><span class="hs-comment">-- We build the binding manually here instead of using mkKindRepRhs</span><span>
</span><a name="line-487"></a><span>        </span><span class="hs-comment">-- since the latter would find the built-in 'KindRep's in the</span><span>
</span><a name="line-488"></a><span>        </span><span class="hs-comment">-- 'KindRepEnv' (by virtue of being in 'initialKindRepEnv').</span><span>
</span><a name="line-489"></a><span>        </span><a name="local-6989586621683433383"><a href="#local-6989586621683433383"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTypeable.html#mkKindRepRhs"><span class="hs-identifier hs-var">mkKindRepRhs</span></a><span> </span><a href="#local-6989586621683433366"><span class="hs-identifier hs-var">stuff</span></a><span> </span><a href="#local-6989586621683433379"><span class="hs-identifier hs-var">empty_scope</span></a><span> </span><a href="#local-6989586621683433381"><span class="hs-identifier hs-var">kind</span></a><span>
</span><a name="line-490"></a><span>        </span><a href="TcTypeable.html#addKindRepBind"><span class="hs-identifier hs-var">addKindRepBind</span></a><span> </span><a href="#local-6989586621683433379"><span class="hs-identifier hs-var">empty_scope</span></a><span> </span><a href="#local-6989586621683433381"><span class="hs-identifier hs-var">kind</span></a><span> </span><a href="#local-6989586621683433382"><span class="hs-identifier hs-var">rep_bndr</span></a><span> </span><a href="#local-6989586621683433383"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-491"></a><span>
</span><a name="line-492"></a><span class="hs-identifier">addKindRepBind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CmEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Kind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTypeable.html#KindRepM"><span class="hs-identifier hs-type">KindRepM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-493"></a><a name="addKindRepBind"><a href="TcTypeable.html#addKindRepBind"><span class="hs-identifier">addKindRepBind</span></a></a><span> </span><a name="local-6989586621683433384"><a href="#local-6989586621683433384"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621683433385"><a href="#local-6989586621683433385"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621683433386"><a href="#local-6989586621683433386"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621683433387"><a href="#local-6989586621683433387"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-494"></a><span>    </span><a href="TcTypeable.html#KindRepM"><span class="hs-identifier hs-var">KindRepM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">modify'</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-495"></a><span>    </span><span class="hs-glyph">\</span><a name="local-6989586621683433388"><a href="#local-6989586621683433388"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">extendTypeMapWithScope</span><span> </span><a href="#local-6989586621683433388"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621683433384"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621683433385"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683433386"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683433387"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-496"></a><span>
</span><a name="line-497"></a><span class="hs-comment">-- | Run a 'KindRepM' and add the produced 'KindRep's to the typechecking</span><span>
</span><a name="line-498"></a><span class="hs-comment">-- environment.</span><span>
</span><a name="line-499"></a><span class="hs-identifier">runKindRepM</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcTypeable.html#KindRepM"><span class="hs-identifier hs-type">KindRepM</span></a><span> </span><a href="#local-6989586621683433249"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcGblEnv</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683433249"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-500"></a><a name="runKindRepM"><a href="TcTypeable.html#runKindRepM"><span class="hs-identifier">runKindRepM</span></a></a><span> </span><span class="hs-special">(</span><a href="TcTypeable.html#KindRepM"><span class="hs-identifier hs-var">KindRepM</span></a><span> </span><a name="local-6989586621683433389"><a href="#local-6989586621683433389"><span class="hs-identifier">action</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-501"></a><span>    </span><a name="local-6989586621683433390"><a href="#local-6989586621683433390"><span class="hs-identifier">kindRepEnv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTypeable.html#initialKindRepEnv"><span class="hs-identifier hs-var">initialKindRepEnv</span></a><span>
</span><a name="line-502"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621683433391"><a href="#local-6989586621683433391"><span class="hs-identifier">res</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683433392"><a href="#local-6989586621683433392"><span class="hs-identifier">reps_env</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">runStateT</span><span> </span><a href="#local-6989586621683433389"><span class="hs-identifier hs-var">action</span></a><span> </span><a href="#local-6989586621683433390"><span class="hs-identifier hs-var">kindRepEnv</span></a><span>
</span><a name="line-503"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683433393"><a href="#local-6989586621683433393"><span class="hs-identifier">rep_binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldTypeMap</span><span> </span><a href="#local-6989586621683433394"><span class="hs-identifier hs-var">to_bind_pair</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621683433392"><span class="hs-identifier hs-var">reps_env</span></a><span>
</span><a name="line-504"></a><span>        </span><a name="local-6989586621683433394"><a href="#local-6989586621683433394"><span class="hs-identifier">to_bind_pair</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683433395"><a href="#local-6989586621683433395"><span class="hs-identifier">bndr</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683433396"><a href="#local-6989586621683433396"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683433397"><a href="#local-6989586621683433397"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683433395"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683433396"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683433397"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-505"></a><span>        </span><span class="hs-identifier">to_bind_pair</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683433398"><a href="#local-6989586621683433398"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683433398"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-506"></a><span>    </span><a name="local-6989586621683433399"><a href="#local-6989586621683433399"><span class="hs-identifier">tcg_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcExtendGlobalValEnv"><span class="hs-identifier hs-var">tcExtendGlobalValEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621683433393"><span class="hs-identifier hs-var">rep_binds</span></a><span class="hs-special">)</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-507"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683433400"><a href="#local-6989586621683433400"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uncurry</span><span> </span><span class="hs-identifier hs-var">mkVarBind</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683433393"><span class="hs-identifier hs-var">rep_binds</span></a><span>
</span><a name="line-508"></a><span>        </span><a name="local-6989586621683433401"><a href="#local-6989586621683433401"><span class="hs-identifier">tcg_env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683433399"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-special">`</span><a href="TcBinds.html#addTypecheckedBinds"><span class="hs-identifier hs-var">addTypecheckedBinds</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">listToBag</span><span> </span><a href="#local-6989586621683433400"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">]</span><span>
</span><a name="line-509"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683433401"><span class="hs-identifier hs-var">tcg_env'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683433391"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span>
</span><a name="line-510"></a><span>
</span><a name="line-511"></a><span class="hs-comment">-- | Produce or find a 'KindRep' for the given kind.</span><span>
</span><a name="line-512"></a><span class="hs-identifier">getKindRep</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcTypeable.html#TypeableStuff"><span class="hs-identifier hs-type">TypeableStuff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CmEnv</span><span>  </span><span class="hs-comment">-- ^ in-scope kind variables</span><span>
</span><a name="line-513"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Kind</span><span>   </span><span class="hs-comment">-- ^ the kind we want a 'KindRep' for</span><span>
</span><a name="line-514"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTypeable.html#KindRepM"><span class="hs-identifier hs-type">KindRepM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span>
</span><a name="line-515"></a><a name="getKindRep"><a href="TcTypeable.html#getKindRep"><span class="hs-identifier">getKindRep</span></a></a><span> </span><a name="local-6989586621683433402"><a href="#local-6989586621683433402"><span class="hs-identifier">stuff</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcTypeable.html#Stuff"><span class="hs-identifier hs-var">Stuff</span></a><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683433415"><a href="#local-6989586621683433415"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683433416"><span class="hs-identifier hs-var">go</span></a><span>
</span><a name="line-516"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-517"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Kind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTypeable.html#KindRepM"><span class="hs-identifier hs-type">KindRepM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span>
</span><a name="line-518"></a><span>    </span><a name="local-6989586621683433416"><a href="#local-6989586621683433416"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcTypeable.html#KindRepM"><span class="hs-identifier hs-var">KindRepM</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">StateT</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621683433417"><span class="hs-identifier hs-var">go'</span></a><span>
</span><a name="line-519"></a><span>
</span><a name="line-520"></a><span>    </span><span class="hs-identifier">go'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Kind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTypeable.html#KindRepEnv"><span class="hs-identifier hs-type">KindRepEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">,</span><span> </span><a href="TcTypeable.html#KindRepEnv"><span class="hs-identifier hs-type">KindRepEnv</span></a><span class="hs-special">)</span><span>
</span><a name="line-521"></a><span>    </span><a name="local-6989586621683433417"><a href="#local-6989586621683433417"><span class="hs-identifier">go'</span></a></a><span> </span><a name="local-6989586621683433418"><a href="#local-6989586621683433418"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621683433419"><a href="#local-6989586621683433419"><span class="hs-identifier">env</span></a></a><span>
</span><a name="line-522"></a><span>        </span><span class="hs-comment">-- Look through type synonyms</span><span>
</span><a name="line-523"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683433420"><a href="#local-6989586621683433420"><span class="hs-identifier">k'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcView</span><span> </span><a href="#local-6989586621683433418"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683433417"><span class="hs-identifier hs-var">go'</span></a><span> </span><a href="#local-6989586621683433420"><span class="hs-identifier hs-var">k'</span></a><span> </span><a href="#local-6989586621683433419"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-524"></a><span>
</span><a name="line-525"></a><span>        </span><span class="hs-comment">-- We've already generated the needed KindRep</span><span>
</span><a name="line-526"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683433421"><a href="#local-6989586621683433421"><span class="hs-identifier">id</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupTypeMapWithScope</span><span> </span><a href="#local-6989586621683433419"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621683433415"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621683433418"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-527"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><a href="#local-6989586621683433421"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683433419"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-528"></a><span>
</span><a name="line-529"></a><span>        </span><span class="hs-comment">-- We need to construct a new KindRep binding</span><span>
</span><a name="line-530"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-531"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- Place a NOINLINE pragma on KindReps since they tend to be quite</span><span>
</span><a name="line-532"></a><span>           </span><span class="hs-comment">-- large and bloat interface files.</span><span>
</span><a name="line-533"></a><span>           </span><a name="local-6989586621683433422"><a href="#local-6989586621683433422"><span class="hs-identifier">rep_bndr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">setInlinePragma</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">neverInlinePragma</span><span class="hs-special">)</span><span>
</span><a name="line-534"></a><span>                   </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcRnMonad.html#newSysLocalId"><span class="hs-identifier hs-var">newSysLocalId</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;$krep&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConTy</span><span> </span><a href="#local-6989586621683433406"><span class="hs-identifier hs-var">kindRepTyCon</span></a><span class="hs-special">)</span><span>
</span><a name="line-535"></a><span>
</span><a name="line-536"></a><span>           </span><span class="hs-comment">-- do we need to tie a knot here?</span><span>
</span><a name="line-537"></a><span>           </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier">runStateT</span><span> </span><a href="#local-6989586621683433419"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">unKindRepM</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-538"></a><span>               </span><a name="local-6989586621683433423"><a href="#local-6989586621683433423"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTypeable.html#mkKindRepRhs"><span class="hs-identifier hs-var">mkKindRepRhs</span></a><span> </span><a href="#local-6989586621683433402"><span class="hs-identifier hs-var">stuff</span></a><span> </span><a href="#local-6989586621683433415"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621683433418"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-539"></a><span>               </span><a href="TcTypeable.html#addKindRepBind"><span class="hs-identifier hs-var">addKindRepBind</span></a><span> </span><a href="#local-6989586621683433415"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621683433418"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621683433422"><span class="hs-identifier hs-var">rep_bndr</span></a><span> </span><a href="#local-6989586621683433423"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-540"></a><span>               </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><a href="#local-6989586621683433422"><span class="hs-identifier hs-var">rep_bndr</span></a><span>
</span><a name="line-541"></a><span>
</span><a name="line-542"></a><span class="hs-comment">-- | Construct the right-hand-side of the 'KindRep' for the given 'Kind' and</span><span>
</span><a name="line-543"></a><span class="hs-comment">-- in-scope kind variable set.</span><span>
</span><a name="line-544"></a><span class="hs-identifier">mkKindRepRhs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcTypeable.html#TypeableStuff"><span class="hs-identifier hs-type">TypeableStuff</span></a><span>
</span><a name="line-545"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CmEnv</span><span>       </span><span class="hs-comment">-- ^ in-scope kind variables</span><span>
</span><a name="line-546"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Kind</span><span>        </span><span class="hs-comment">-- ^ the kind we want a 'KindRep' for</span><span>
</span><a name="line-547"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTypeable.html#KindRepM"><span class="hs-identifier hs-type">KindRepM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ RHS expression</span><span>
</span><a name="line-548"></a><a name="mkKindRepRhs"><a href="TcTypeable.html#mkKindRepRhs"><span class="hs-identifier">mkKindRepRhs</span></a></a><span> </span><a name="local-6989586621683433424"><a href="#local-6989586621683433424"><span class="hs-identifier">stuff</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcTypeable.html#Stuff"><span class="hs-identifier hs-var">Stuff</span></a><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683433437"><a href="#local-6989586621683433437"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683433438"><span class="hs-identifier hs-var">new_kind_rep</span></a><span>
</span><a name="line-549"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-550"></a><span>    </span><a name="local-6989586621683433438"><a href="#local-6989586621683433438"><span class="hs-identifier">new_kind_rep</span></a></a><span> </span><a name="local-6989586621683433439"><a href="#local-6989586621683433439"><span class="hs-identifier">k</span></a></a><span>
</span><a name="line-551"></a><span>        </span><span class="hs-comment">-- We handle (TYPE LiftedRep) etc separately to make it</span><span>
</span><a name="line-552"></a><span>        </span><span class="hs-comment">-- clear to consumers (e.g. serializers) that there is</span><span>
</span><a name="line-553"></a><span>        </span><span class="hs-comment">-- a loop here (as TYPE :: RuntimeRep -&gt; TYPE 'LiftedRep)</span><span>
</span><a name="line-554"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tcIsConstraintKind</span><span> </span><a href="#local-6989586621683433439"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- Typeable respects the Constraint/* distinction</span><span>
</span><a name="line-555"></a><span>                                      </span><span class="hs-comment">-- so do not follow the special case here</span><span>
</span><a name="line-556"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683433440"><a href="#local-6989586621683433440"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">kindRep_maybe</span><span> </span><a href="#local-6989586621683433439"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-557"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683433441"><a href="#local-6989586621683433441"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">splitTyConApp_maybe</span><span> </span><a href="#local-6989586621683433440"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-558"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683433442"><a href="#local-6989586621683433442"><span class="hs-identifier">dc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">isPromotedDataCon_maybe</span><span> </span><a href="#local-6989586621683433441"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-559"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">nlHsDataCon</span><span> </span><a href="#local-6989586621683433433"><span class="hs-identifier hs-var">kindRepTYPEDataCon</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">nlHsDataCon</span><span> </span><a href="#local-6989586621683433442"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-560"></a><span>
</span><a name="line-561"></a><span>    </span><span class="hs-identifier">new_kind_rep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyVarTy</span><span> </span><a name="local-6989586621683433443"><a href="#local-6989586621683433443"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-562"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683433444"><a href="#local-6989586621683433444"><span class="hs-identifier">idx</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupCME</span><span> </span><a href="#local-6989586621683433437"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621683433443"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-563"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">nlHsDataCon</span><span> </span><a href="#local-6989586621683433430"><span class="hs-identifier hs-var">kindRepVarDataCon</span></a><span>
</span><a name="line-564"></a><span>                 </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">nlHsIntLit</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621683433444"><span class="hs-identifier hs-var">idx</span></a><span class="hs-special">)</span><span>
</span><a name="line-565"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-566"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;mkTyConKindRepBinds.go(tyvar)&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683433443"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-567"></a><span>
</span><a name="line-568"></a><span>    </span><span class="hs-identifier">new_kind_rep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AppTy</span><span> </span><a name="local-6989586621683433445"><a href="#local-6989586621683433445"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-6989586621683433446"><a href="#local-6989586621683433446"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-569"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621683433447"><a href="#local-6989586621683433447"><span class="hs-identifier">rep1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTypeable.html#getKindRep"><span class="hs-identifier hs-var">getKindRep</span></a><span> </span><a href="#local-6989586621683433424"><span class="hs-identifier hs-var">stuff</span></a><span> </span><a href="#local-6989586621683433437"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621683433445"><span class="hs-identifier hs-var">t1</span></a><span>
</span><a name="line-570"></a><span>           </span><a name="local-6989586621683433448"><a href="#local-6989586621683433448"><span class="hs-identifier">rep2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTypeable.html#getKindRep"><span class="hs-identifier hs-var">getKindRep</span></a><span> </span><a href="#local-6989586621683433424"><span class="hs-identifier hs-var">stuff</span></a><span> </span><a href="#local-6989586621683433437"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621683433446"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-571"></a><span>           </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">nlHsDataCon</span><span> </span><a href="#local-6989586621683433431"><span class="hs-identifier hs-var">kindRepAppDataCon</span></a><span>
</span><a name="line-572"></a><span>                    </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683433447"><span class="hs-identifier hs-var">rep1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683433448"><span class="hs-identifier hs-var">rep2</span></a><span>
</span><a name="line-573"></a><span>
</span><a name="line-574"></a><span>    </span><span class="hs-identifier">new_kind_rep</span><span> </span><a name="local-6989586621683433449"><a href="#local-6989586621683433449"><span class="hs-identifier">k</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyConApp</span><span> </span><a name="local-6989586621683433450"><a href="#local-6989586621683433450"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621683433451"><a href="#local-6989586621683433451"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-575"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683433452"><a href="#local-6989586621683433452"><span class="hs-identifier">rep_name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tyConRepName_maybe</span><span> </span><a href="#local-6989586621683433450"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-576"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621683433453"><a href="#local-6989586621683433453"><span class="hs-identifier">rep_id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTypeable.html#liftTc"><span class="hs-identifier hs-var">liftTc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">lookupId</span><span> </span><a href="#local-6989586621683433452"><span class="hs-identifier hs-var">rep_name</span></a><span>
</span><a name="line-577"></a><span>           </span><a name="local-6989586621683433454"><a href="#local-6989586621683433454"><span class="hs-identifier">tys'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="TcTypeable.html#getKindRep"><span class="hs-identifier hs-var">getKindRep</span></a><span> </span><a href="#local-6989586621683433424"><span class="hs-identifier hs-var">stuff</span></a><span> </span><a href="#local-6989586621683433437"><span class="hs-identifier hs-var">in_scope</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683433451"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-578"></a><span>           </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">nlHsDataCon</span><span> </span><a href="#local-6989586621683433429"><span class="hs-identifier hs-var">kindRepTyConAppDataCon</span></a><span>
</span><a name="line-579"></a><span>                    </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><a href="#local-6989586621683433453"><span class="hs-identifier hs-var">rep_id</span></a><span>
</span><a name="line-580"></a><span>                    </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span> </span><a href="TcTypeable.html#mkList"><span class="hs-identifier hs-var">mkList</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConTy</span><span> </span><a href="#local-6989586621683433428"><span class="hs-identifier hs-var">kindRepTyCon</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683433454"><span class="hs-identifier hs-var">tys'</span></a><span>
</span><a name="line-581"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-582"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;mkTyConKindRepBinds(TyConApp)&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683433450"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683433449"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span>
</span><a name="line-583"></a><span>
</span><a name="line-584"></a><span>    </span><span class="hs-identifier">new_kind_rep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ForAllTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Bndr</span><span> </span><a name="local-6989586621683433455"><a href="#local-6989586621683433455"><span class="hs-identifier">var</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683433456"><a href="#local-6989586621683433456"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-585"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;mkTyConKindRepBinds(ForAllTy)&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683433455"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683433456"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-586"></a><span>
</span><a name="line-587"></a><span>    </span><span class="hs-identifier">new_kind_rep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunTy</span><span> </span><a name="local-6989586621683433457"><a href="#local-6989586621683433457"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-6989586621683433458"><a href="#local-6989586621683433458"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-588"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621683433459"><a href="#local-6989586621683433459"><span class="hs-identifier">rep1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTypeable.html#getKindRep"><span class="hs-identifier hs-var">getKindRep</span></a><span> </span><a href="#local-6989586621683433424"><span class="hs-identifier hs-var">stuff</span></a><span> </span><a href="#local-6989586621683433437"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621683433457"><span class="hs-identifier hs-var">t1</span></a><span>
</span><a name="line-589"></a><span>           </span><a name="local-6989586621683433460"><a href="#local-6989586621683433460"><span class="hs-identifier">rep2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTypeable.html#getKindRep"><span class="hs-identifier hs-var">getKindRep</span></a><span> </span><a href="#local-6989586621683433424"><span class="hs-identifier hs-var">stuff</span></a><span> </span><a href="#local-6989586621683433437"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621683433458"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-590"></a><span>           </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">nlHsDataCon</span><span> </span><a href="#local-6989586621683433432"><span class="hs-identifier hs-var">kindRepFunDataCon</span></a><span>
</span><a name="line-591"></a><span>                    </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683433459"><span class="hs-identifier hs-var">rep1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683433460"><span class="hs-identifier hs-var">rep2</span></a><span>
</span><a name="line-592"></a><span>
</span><a name="line-593"></a><span>    </span><span class="hs-identifier">new_kind_rep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NumTyLit</span><span> </span><a name="local-6989586621683433461"><a href="#local-6989586621683433461"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-594"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">nlHsDataCon</span><span> </span><a href="#local-6989586621683433434"><span class="hs-identifier hs-var">kindRepTypeLitSDataCon</span></a><span>
</span><a name="line-595"></a><span>                 </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">nlHsDataCon</span><span> </span><a href="#local-6989586621683433436"><span class="hs-identifier hs-var">typeLitNatDataCon</span></a><span>
</span><a name="line-596"></a><span>                 </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">nlHsLit</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsStringPrimLit</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkFastString</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621683433461"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-597"></a><span>
</span><a name="line-598"></a><span>    </span><span class="hs-identifier">new_kind_rep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">StrTyLit</span><span> </span><a name="local-6989586621683433462"><a href="#local-6989586621683433462"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-599"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">nlHsDataCon</span><span> </span><a href="#local-6989586621683433434"><span class="hs-identifier hs-var">kindRepTypeLitSDataCon</span></a><span>
</span><a name="line-600"></a><span>                 </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">nlHsDataCon</span><span> </span><a href="#local-6989586621683433435"><span class="hs-identifier hs-var">typeLitSymbolDataCon</span></a><span>
</span><a name="line-601"></a><span>                 </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">nlHsLit</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsStringPrimLit</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkFastString</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621683433462"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-602"></a><span>
</span><a name="line-603"></a><span>    </span><span class="hs-identifier">new_kind_rep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CastTy</span><span> </span><a name="local-6989586621683433463"><a href="#local-6989586621683433463"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683433464"><a href="#local-6989586621683433464"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-604"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;mkTyConKindRepBinds.go(cast)&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683433463"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683433464"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-605"></a><span>
</span><a name="line-606"></a><span>    </span><span class="hs-identifier">new_kind_rep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoercionTy</span><span> </span><a name="local-6989586621683433465"><a href="#local-6989586621683433465"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-607"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;mkTyConKindRepBinds.go(coercion)&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683433465"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-608"></a><span>
</span><a name="line-609"></a><span class="hs-comment">-- | Produce the right-hand-side of a @TyCon@ representation.</span><span>
</span><a name="line-610"></a><span class="hs-identifier">mkTyConRepTyConRHS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcTypeable.html#TypeableStuff"><span class="hs-identifier hs-type">TypeableStuff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTypeable.html#TypeRepTodo"><span class="hs-identifier hs-type">TypeRepTodo</span></a><span>
</span><a name="line-611"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span>      </span><span class="hs-comment">-- ^ the 'TyCon' we are producing a binding for</span><span>
</span><a name="line-612"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-comment">-- ^ its 'KindRep'</span><span>
</span><a name="line-613"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-614"></a><a name="mkTyConRepTyConRHS"><a href="TcTypeable.html#mkTyConRepTyConRHS"><span class="hs-identifier">mkTyConRepTyConRHS</span></a></a><span> </span><span class="hs-special">(</span><a href="TcTypeable.html#Stuff"><span class="hs-identifier hs-var">Stuff</span></a><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683433478"><a href="#local-6989586621683433478"><span class="hs-identifier">todo</span></a></a><span> </span><a name="local-6989586621683433479"><a href="#local-6989586621683433479"><span class="hs-identifier">tycon</span></a></a><span> </span><a name="local-6989586621683433480"><a href="#local-6989586621683433480"><span class="hs-identifier">kind_rep</span></a></a><span>
</span><a name="line-615"></a><span>  </span><span class="hs-glyph">=</span><span>           </span><span class="hs-identifier hs-var">nlHsDataCon</span><span> </span><a href="#local-6989586621683433467"><span class="hs-identifier hs-var">trTyConDataCon</span></a><span>
</span><a name="line-616"></a><span>    </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">nlHsLit</span><span> </span><span class="hs-special">(</span><a href="TcTypeable.html#word64"><span class="hs-identifier hs-var">word64</span></a><span> </span><a href="#local-6989586621683433466"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621683433484"><span class="hs-identifier hs-var">high</span></a><span class="hs-special">)</span><span>
</span><a name="line-617"></a><span>    </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">nlHsLit</span><span> </span><span class="hs-special">(</span><a href="TcTypeable.html#word64"><span class="hs-identifier hs-var">word64</span></a><span> </span><a href="#local-6989586621683433466"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621683433485"><span class="hs-identifier hs-var">low</span></a><span class="hs-special">)</span><span>
</span><a name="line-618"></a><span>    </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">mod_rep_expr</span><span> </span><a href="#local-6989586621683433478"><span class="hs-identifier hs-var">todo</span></a><span>
</span><a name="line-619"></a><span>    </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683433468"><span class="hs-identifier hs-var">trNameLit</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkFastString</span><span> </span><a href="#local-6989586621683433482"><span class="hs-identifier hs-var">tycon_str</span></a><span class="hs-special">)</span><span>
</span><a name="line-620"></a><span>    </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">nlHsLit</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683433486"><span class="hs-identifier hs-var">int</span></a><span> </span><a href="#local-6989586621683433481"><span class="hs-identifier hs-var">n_kind_vars</span></a><span class="hs-special">)</span><span>
</span><a name="line-621"></a><span>    </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683433480"><span class="hs-identifier hs-var">kind_rep</span></a><span>
</span><a name="line-622"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-623"></a><span>    </span><a name="local-6989586621683433481"><a href="#local-6989586621683433481"><span class="hs-identifier">n_kind_vars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-identifier hs-var">isNamedTyConBinder</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConBinders</span><span> </span><a href="#local-6989586621683433479"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span>
</span><a name="line-624"></a><span>    </span><a name="local-6989586621683433482"><a href="#local-6989586621683433482"><span class="hs-identifier">tycon_str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683433483"><span class="hs-identifier hs-var">add_tick</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">occNameString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOccName</span><span> </span><a href="#local-6989586621683433479"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-625"></a><span>    </span><a name="local-6989586621683433483"><a href="#local-6989586621683433483"><span class="hs-identifier">add_tick</span></a></a><span> </span><a name="local-6989586621683433487"><a href="#local-6989586621683433487"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isPromotedDataCon</span><span> </span><a href="#local-6989586621683433479"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-char">'\''</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683433487"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-626"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>               </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683433487"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-627"></a><span>
</span><a name="line-628"></a><span>    </span><span class="hs-comment">-- This must match the computation done in</span><span>
</span><a name="line-629"></a><span>    </span><span class="hs-comment">-- Data.Typeable.Internal.mkTyConFingerprint.</span><span>
</span><a name="line-630"></a><span>    </span><span class="hs-identifier hs-var">Fingerprint</span><span> </span><a name="local-6989586621683433484"><a href="#local-6989586621683433484"><span class="hs-identifier">high</span></a></a><span> </span><a name="local-6989586621683433485"><a href="#local-6989586621683433485"><span class="hs-identifier">low</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fingerprintFingerprints</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">pkg_fingerprint</span><span> </span><a href="#local-6989586621683433478"><span class="hs-identifier hs-var">todo</span></a><span>
</span><a name="line-631"></a><span>                                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mod_fingerprint</span><span> </span><a href="#local-6989586621683433478"><span class="hs-identifier hs-var">todo</span></a><span>
</span><a name="line-632"></a><span>                                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fingerprintString</span><span> </span><a href="#local-6989586621683433482"><span class="hs-identifier hs-var">tycon_str</span></a><span>
</span><a name="line-633"></a><span>                                                   </span><span class="hs-special">]</span><span>
</span><a name="line-634"></a><span>
</span><a name="line-635"></a><span>    </span><span class="hs-identifier">int</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsLit</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-636"></a><span>    </span><a name="local-6989586621683433486"><a href="#local-6989586621683433486"><span class="hs-identifier">int</span></a></a><span> </span><a name="local-6989586621683433488"><a href="#local-6989586621683433488"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HsIntPrim</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SourceText</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621683433488"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toInteger</span><span> </span><a href="#local-6989586621683433488"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-637"></a><span>
</span><a name="line-638"></a><span class="hs-identifier">word64</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word64</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsLit</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-639"></a><a name="word64"><a href="TcTypeable.html#word64"><span class="hs-identifier">word64</span></a></a><span> </span><a name="local-6989586621683433489"><a href="#local-6989586621683433489"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621683433490"><a href="#local-6989586621683433490"><span class="hs-identifier">n</span></a></a><span>
</span><a name="line-640"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">wORD_SIZE</span><span> </span><a href="#local-6989586621683433489"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HsWord64Prim</span><span> </span><span class="hs-identifier hs-var">NoSourceText</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toInteger</span><span> </span><a href="#local-6989586621683433490"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-641"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HsWordPrim</span><span>   </span><span class="hs-identifier hs-var">NoSourceText</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toInteger</span><span> </span><a href="#local-6989586621683433490"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-642"></a><span>
</span><a name="line-643"></a><span class="hs-comment">{-
Note [Representing TyCon kinds: KindRep]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
One of the operations supported by Typeable is typeRepKind,

    typeRepKind :: TypeRep (a :: k) -&gt; TypeRep k

Implementing this is a bit tricky for poly-kinded types like

    data Proxy (a :: k) :: Type
    -- Proxy :: forall k. k -&gt; Type

The TypeRep encoding of `Proxy Type Int` looks like this:

    $tcProxy :: GHC.Types.TyCon
    $trInt   :: TypeRep Int
    TrType   :: TypeRep Type

    $trProxyType :: TypeRep (Proxy Type :: Type -&gt; Type)
    $trProxyType = TrTyCon $tcProxy
                           [TrType]  -- kind variable instantiation
                           (tyConKind $tcProxy [TrType]) -- The TypeRep of
                                                         -- Type -&gt; Type

    $trProxy :: TypeRep (Proxy Type Int)
    $trProxy = TrApp $trProxyType $trInt TrType

    $tkProxy :: GHC.Types.KindRep
    $tkProxy = KindRepFun (KindRepVar 0)
                          (KindRepTyConApp (KindRepTYPE LiftedRep) [])

Note how $trProxyType cannot use 'TrApp', because TypeRep cannot represent
polymorphic types.  So instead

 * $trProxyType uses 'TrTyCon' to apply Proxy to (the representations)
   of all its kind arguments. We can't represent a tycon that is
   applied to only some of its kind arguments.

 * In $tcProxy, the GHC.Types.TyCon structure for Proxy, we store a
   GHC.Types.KindRep, which represents the polymorphic kind of Proxy
       Proxy :: forall k. k-&gt;Type

 * A KindRep is just a recipe that we can instantiate with the
   argument kinds, using Data.Typeable.Internal.tyConKind and
   store in the relevant 'TypeRep' constructor.

   Data.Typeable.Internal.typeRepKind looks up the stored kinds.

 * In a KindRep, the kind variables are represented by 0-indexed
   de Bruijn numbers:

    type KindBndr = Int   -- de Bruijn index

    data KindRep = KindRepTyConApp TyCon [KindRep]
                 | KindRepVar !KindBndr
                 | KindRepApp KindRep KindRep
                 | KindRepFun KindRep KindRep
                 ...
-}</span><span>
</span><a name="line-702"></a><span>
</span><a name="line-703"></a><span class="hs-identifier">mkList</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-704"></a><a name="mkList"><a href="TcTypeable.html#mkList"><span class="hs-identifier">mkList</span></a></a><span> </span><a name="local-6989586621683433491"><a href="#local-6989586621683433491"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621683433493"><span class="hs-identifier hs-var">consApp</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683433494"><span class="hs-identifier hs-var">nilExpr</span></a><span> </span><a href="#local-6989586621683433491"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-705"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-706"></a><span>    </span><a name="local-6989586621683433492"><a href="#local-6989586621683433492"><span class="hs-identifier">cons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683433495"><span class="hs-identifier hs-var">consExpr</span></a><span> </span><a href="#local-6989586621683433491"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-707"></a><span>    </span><span class="hs-identifier">consApp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-708"></a><span>    </span><a name="local-6989586621683433493"><a href="#local-6989586621683433493"><span class="hs-identifier">consApp</span></a></a><span> </span><a name="local-6989586621683433496"><a href="#local-6989586621683433496"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683433497"><a href="#local-6989586621683433497"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683433492"><span class="hs-identifier hs-var">cons</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683433496"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683433497"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-709"></a><span>
</span><a name="line-710"></a><span>    </span><span class="hs-identifier">nilExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-711"></a><span>    </span><a name="local-6989586621683433494"><a href="#local-6989586621683433494"><span class="hs-identifier">nilExpr</span></a></a><span> </span><a name="local-6989586621683433498"><a href="#local-6989586621683433498"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkLHsWrap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkWpTyApps</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683433498"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsDataCon</span><span> </span><span class="hs-identifier hs-var">nilDataCon</span><span class="hs-special">)</span><span>
</span><a name="line-712"></a><span>
</span><a name="line-713"></a><span>    </span><span class="hs-identifier">consExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-714"></a><span>    </span><a name="local-6989586621683433495"><a href="#local-6989586621683433495"><span class="hs-identifier">consExpr</span></a></a><span> </span><a name="local-6989586621683433499"><a href="#local-6989586621683433499"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkLHsWrap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkWpTyApps</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683433499"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsDataCon</span><span> </span><span class="hs-identifier hs-var">consDataCon</span><span class="hs-special">)</span><span>
</span><a name="line-715"></a></pre></body></html>