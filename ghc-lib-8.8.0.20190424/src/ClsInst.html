<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">ClsInst</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-4"></a><span>     </span><a href="ClsInst.html#matchGlobalInst"><span class="hs-identifier hs-var">matchGlobalInst</span></a><span class="hs-special">,</span><span>
</span><a name="line-5"></a><span>     </span><a href="ClsInst.html#ClsInstResult"><span class="hs-identifier hs-type">ClsInstResult</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-6"></a><span>     </span><a href="ClsInst.html#InstanceWhat"><span class="hs-identifier hs-type">InstanceWhat</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="ClsInst.html#safeOverlap"><span class="hs-identifier hs-var">safeOverlap</span></a><span class="hs-special">,</span><span>
</span><a name="line-7"></a><span>     </span><a href="ClsInst.html#AssocInstInfo"><span class="hs-identifier hs-type">AssocInstInfo</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="ClsInst.html#isNotAssociated"><span class="hs-identifier hs-var">isNotAssociated</span></a><span>
</span><a name="line-8"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><a href="TcEnv.html"><span class="hs-identifier">TcEnv</span></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><a href="TcMType.html"><span class="hs-identifier">TcMType</span></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcEvidence</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="RnEnv.html"><span class="hs-identifier">RnEnv</span></a><span class="hs-special">(</span><span> </span><a href="RnEnv.html#addUsedGRE"><span class="hs-identifier hs-var">addUsedGRE</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RdrName</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">lookupGRE_FieldLabel</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">InstEnv</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="Inst.html"><span class="hs-identifier">Inst</span></a><span class="hs-special">(</span><span> </span><a href="Inst.html#instDFunType"><span class="hs-identifier hs-var">instDFunType</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="FamInst.html"><span class="hs-identifier">FamInst</span></a><span class="hs-special">(</span><span> </span><a href="FamInst.html#tcGetFamInstEnvs"><span class="hs-identifier hs-var">tcGetFamInstEnvs</span></a><span class="hs-special">,</span><span> </span><a href="FamInst.html#tcInstNewTyCon_maybe"><span class="hs-identifier hs-var">tcInstNewTyCon_maybe</span></a><span class="hs-special">,</span><span> </span><a href="FamInst.html#tcLookupDataFamInst"><span class="hs-identifier hs-var">tcLookupDataFamInst</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysWiredIn</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysPrim</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">eqPrimTyCon</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">eqReprPrimTyCon</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MkCore</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkStringExprFS</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkNaturalExpr</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>   </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarEnv</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">VarEnv</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Class</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">splitAtList</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fstOf3</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-comment">{- *******************************************************************
*                                                                    *
              A helper for associated types within
              class instance declarations
*                                                                    *
**********************************************************************-}</span><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span class="hs-comment">-- | Extra information about the parent instance declaration, needed</span><span>
</span><a name="line-51"></a><span class="hs-comment">-- when type-checking associated types. The 'Class' is the enclosing</span><span>
</span><a name="line-52"></a><span class="hs-comment">-- class, the [TyVar] are the /scoped/ type variable of the instance decl.</span><span>
</span><a name="line-53"></a><span class="hs-comment">-- The @VarEnv Type@ maps class variables to their instance types.</span><span>
</span><a name="line-54"></a><span class="hs-keyword">data</span><span> </span><a name="AssocInstInfo"><a href="ClsInst.html#AssocInstInfo"><span class="hs-identifier">AssocInstInfo</span></a></a><span>
</span><a name="line-55"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="NotAssociated"><a href="ClsInst.html#NotAssociated"><span class="hs-identifier">NotAssociated</span></a></a><span>
</span><a name="line-56"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="InClsInst"><a href="ClsInst.html#InClsInst"><span class="hs-identifier">InClsInst</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="ai_class"><a href="ClsInst.html#ai_class"><span class="hs-identifier">ai_class</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Class</span><span>
</span><a name="line-57"></a><span>              </span><span class="hs-special">,</span><span> </span><a name="ai_tyvars"><a href="ClsInst.html#ai_tyvars"><span class="hs-identifier">ai_tyvars</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- ^ The /scoped/ tyvars of the instance</span><span>
</span><a name="line-58"></a><span>                                            </span><span class="hs-comment">-- Why scoped?  See bind_me in</span><span>
</span><a name="line-59"></a><span>                                            </span><span class="hs-comment">-- TcValidity.checkConsistentFamInst</span><span>
</span><a name="line-60"></a><span>              </span><span class="hs-special">,</span><span> </span><a name="ai_inst_env"><a href="ClsInst.html#ai_inst_env"><span class="hs-identifier">ai_inst_env</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">VarEnv</span><span> </span><span class="hs-identifier hs-type">Type</span><span>  </span><span class="hs-comment">-- ^ Maps /class/ tyvars to their instance types</span><span>
</span><a name="line-61"></a><span>                </span><span class="hs-comment">-- See Note [Matching in the consistent-instantation check]</span><span>
</span><a name="line-62"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-63"></a><span>
</span><a name="line-64"></a><span class="hs-identifier">isNotAssociated</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="ClsInst.html#AssocInstInfo"><span class="hs-identifier hs-type">AssocInstInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-65"></a><a name="isNotAssociated"><a href="ClsInst.html#isNotAssociated"><span class="hs-identifier">isNotAssociated</span></a></a><span> </span><a href="ClsInst.html#NotAssociated"><span class="hs-identifier hs-var">NotAssociated</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-66"></a><span class="hs-identifier">isNotAssociated</span><span> </span><span class="hs-special">(</span><a href="ClsInst.html#InClsInst"><span class="hs-identifier hs-var">InClsInst</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-67"></a><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span class="hs-comment">{- *******************************************************************
*                                                                    *
                       Class lookup
*                                                                    *
**********************************************************************-}</span><span>
</span><a name="line-74"></a><span>
</span><a name="line-75"></a><span class="hs-comment">-- | Indicates if Instance met the Safe Haskell overlapping instances safety</span><span>
</span><a name="line-76"></a><span class="hs-comment">-- check.</span><span>
</span><a name="line-77"></a><span class="hs-comment">--</span><span>
</span><a name="line-78"></a><span class="hs-comment">-- See Note [Safe Haskell Overlapping Instances] in TcSimplify</span><span>
</span><a name="line-79"></a><span class="hs-comment">-- See Note [Safe Haskell Overlapping Instances Implementation] in TcSimplify</span><span>
</span><a name="line-80"></a><span class="hs-keyword">type</span><span> </span><a name="SafeOverlapping"><a href="ClsInst.html#SafeOverlapping"><span class="hs-identifier">SafeOverlapping</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-81"></a><span>
</span><a name="line-82"></a><span class="hs-keyword">data</span><span> </span><a name="ClsInstResult"><a href="ClsInst.html#ClsInstResult"><span class="hs-identifier">ClsInstResult</span></a></a><span>
</span><a name="line-83"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="NoInstance"><a href="ClsInst.html#NoInstance"><span class="hs-identifier">NoInstance</span></a></a><span>   </span><span class="hs-comment">-- Definitely no instance</span><span>
</span><a name="line-84"></a><span>
</span><a name="line-85"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="OneInst"><a href="ClsInst.html#OneInst"><span class="hs-identifier">OneInst</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="cir_new_theta"><a href="ClsInst.html#cir_new_theta"><span class="hs-identifier">cir_new_theta</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcPredType</span><span class="hs-special">]</span><span>
</span><a name="line-86"></a><span>            </span><span class="hs-special">,</span><span> </span><a name="cir_mk_ev"><a href="ClsInst.html#cir_mk_ev"><span class="hs-identifier">cir_mk_ev</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">EvExpr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">EvTerm</span><span>
</span><a name="line-87"></a><span>            </span><span class="hs-special">,</span><span> </span><a name="cir_what"><a href="ClsInst.html#cir_what"><span class="hs-identifier">cir_what</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><a href="ClsInst.html#InstanceWhat"><span class="hs-identifier hs-type">InstanceWhat</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-88"></a><span>
</span><a name="line-89"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="NotSure"><a href="ClsInst.html#NotSure"><span class="hs-identifier">NotSure</span></a></a><span>      </span><span class="hs-comment">-- Multiple matches and/or one or more unifiers</span><span>
</span><a name="line-90"></a><span>
</span><a name="line-91"></a><span class="hs-keyword">data</span><span> </span><a name="InstanceWhat"><a href="ClsInst.html#InstanceWhat"><span class="hs-identifier">InstanceWhat</span></a></a><span>
</span><a name="line-92"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="BuiltinInstance"><a href="ClsInst.html#BuiltinInstance"><span class="hs-identifier">BuiltinInstance</span></a></a><span>
</span><a name="line-93"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="LocalInstance"><a href="ClsInst.html#LocalInstance"><span class="hs-identifier">LocalInstance</span></a></a><span>
</span><a name="line-94"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="TopLevInstance"><a href="ClsInst.html#TopLevInstance"><span class="hs-identifier">TopLevInstance</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="iw_dfun_id"><a href="ClsInst.html#iw_dfun_id"><span class="hs-identifier">iw_dfun_id</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DFunId</span><span>
</span><a name="line-95"></a><span>                   </span><span class="hs-special">,</span><span> </span><a name="iw_safe_over"><a href="ClsInst.html#iw_safe_over"><span class="hs-identifier">iw_safe_over</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="ClsInst.html#SafeOverlapping"><span class="hs-identifier hs-type">SafeOverlapping</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-96"></a><span>
</span><a name="line-97"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="ClsInst.html#ClsInstResult"><span class="hs-identifier hs-type">ClsInstResult</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-98"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><a href="ClsInst.html#NoInstance"><span class="hs-identifier hs-var">NoInstance</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;NoInstance&quot;</span><span>
</span><a name="line-99"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><a href="ClsInst.html#NotSure"><span class="hs-identifier hs-var">NotSure</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;NotSure&quot;</span><span>
</span><a name="line-100"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="ClsInst.html#OneInst"><span class="hs-identifier hs-var">OneInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cir_new_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682606514"><a href="#local-6989586621682606514"><span class="hs-identifier">ev</span></a></a><span>
</span><a name="line-101"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cir_what</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682606515"><a href="#local-6989586621682606515"><span class="hs-identifier">what</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-102"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;OneInst&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682606514"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682606515"><span class="hs-identifier hs-var">what</span></a><span class="hs-special">]</span><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="ClsInst.html#InstanceWhat"><span class="hs-identifier hs-type">InstanceWhat</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-105"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><a href="ClsInst.html#BuiltinInstance"><span class="hs-identifier hs-var">BuiltinInstance</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;built-in instance&quot;</span><span>
</span><a name="line-106"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><a href="ClsInst.html#LocalInstance"><span class="hs-identifier hs-var">LocalInstance</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;locally-quantified instance&quot;</span><span>
</span><a name="line-107"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="ClsInst.html#TopLevInstance"><span class="hs-identifier hs-var">TopLevInstance</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">iw_safe_over</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682606513"><a href="#local-6989586621682606513"><span class="hs-identifier">so</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-108"></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;top-level instance&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682606513"><span class="hs-identifier hs-var">so</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-string">&quot;[safe]&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-string">&quot;[unsafe]&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-109"></a><span>
</span><a name="line-110"></a><span class="hs-identifier">safeOverlap</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="ClsInst.html#InstanceWhat"><span class="hs-identifier hs-type">InstanceWhat</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-111"></a><a name="safeOverlap"><a href="ClsInst.html#safeOverlap"><span class="hs-identifier">safeOverlap</span></a></a><span> </span><span class="hs-special">(</span><a href="ClsInst.html#TopLevInstance"><span class="hs-identifier hs-var">TopLevInstance</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">iw_safe_over</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682606516"><a href="#local-6989586621682606516"><span class="hs-identifier">so</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682606516"><span class="hs-identifier hs-var">so</span></a><span>
</span><a name="line-112"></a><span class="hs-identifier">safeOverlap</span><span> </span><span class="hs-identifier">_</span><span>                                      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-113"></a><span>
</span><a name="line-114"></a><span class="hs-identifier">matchGlobalInst</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-115"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>      </span><span class="hs-comment">-- True &lt;=&gt; caller is the short-cut solver</span><span>
</span><a name="line-116"></a><span>                             </span><span class="hs-comment">-- See Note [Shortcut solving: overlap]</span><span>
</span><a name="line-117"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="ClsInst.html#ClsInstResult"><span class="hs-identifier hs-type">ClsInstResult</span></a><span>
</span><a name="line-118"></a><a name="matchGlobalInst"><a href="ClsInst.html#matchGlobalInst"><span class="hs-identifier">matchGlobalInst</span></a></a><span> </span><a name="local-6989586621682606517"><a href="#local-6989586621682606517"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682606518"><a href="#local-6989586621682606518"><span class="hs-identifier">short_cut</span></a></a><span> </span><a name="local-6989586621682606519"><a href="#local-6989586621682606519"><span class="hs-identifier">clas</span></a></a><span> </span><a name="local-6989586621682606520"><a href="#local-6989586621682606520"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-119"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682606521"><span class="hs-identifier hs-var">cls_name</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">knownNatClassName</span><span>
</span><a name="line-120"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="ClsInst.html#matchKnownNat"><span class="hs-identifier hs-var">matchKnownNat</span></a><span>    </span><a href="#local-6989586621682606517"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682606518"><span class="hs-identifier hs-var">short_cut</span></a><span> </span><a href="#local-6989586621682606519"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621682606520"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-121"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682606521"><span class="hs-identifier hs-var">cls_name</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">knownSymbolClassName</span><span>
</span><a name="line-122"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="ClsInst.html#matchKnownSymbol"><span class="hs-identifier hs-var">matchKnownSymbol</span></a><span> </span><a href="#local-6989586621682606517"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682606518"><span class="hs-identifier hs-var">short_cut</span></a><span> </span><a href="#local-6989586621682606519"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621682606520"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-123"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isCTupleClass</span><span> </span><a href="#local-6989586621682606519"><span class="hs-identifier hs-var">clas</span></a><span>                </span><span class="hs-glyph">=</span><span> </span><a href="ClsInst.html#matchCTuple"><span class="hs-identifier hs-var">matchCTuple</span></a><span>          </span><a href="#local-6989586621682606519"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621682606520"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-124"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682606521"><span class="hs-identifier hs-var">cls_name</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">typeableClassName</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="ClsInst.html#matchTypeable"><span class="hs-identifier hs-var">matchTypeable</span></a><span>        </span><a href="#local-6989586621682606519"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621682606520"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-125"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682606519"><span class="hs-identifier hs-var">clas</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">heqTyConKey</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="ClsInst.html#matchHeteroEquality"><span class="hs-identifier hs-var">matchHeteroEquality</span></a><span>       </span><a href="#local-6989586621682606520"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-126"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682606519"><span class="hs-identifier hs-var">clas</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">eqTyConKey</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="ClsInst.html#matchHomoEquality"><span class="hs-identifier hs-var">matchHomoEquality</span></a><span>         </span><a href="#local-6989586621682606520"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-127"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682606519"><span class="hs-identifier hs-var">clas</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">coercibleTyConKey</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="ClsInst.html#matchCoercible"><span class="hs-identifier hs-var">matchCoercible</span></a><span>            </span><a href="#local-6989586621682606520"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-128"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682606521"><span class="hs-identifier hs-var">cls_name</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">hasFieldClassName</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="ClsInst.html#matchHasField"><span class="hs-identifier hs-var">matchHasField</span></a><span> </span><a href="#local-6989586621682606517"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682606518"><span class="hs-identifier hs-var">short_cut</span></a><span> </span><a href="#local-6989586621682606519"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621682606520"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-129"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                         </span><span class="hs-glyph">=</span><span> </span><a href="ClsInst.html#matchInstEnv"><span class="hs-identifier hs-var">matchInstEnv</span></a><span> </span><a href="#local-6989586621682606517"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682606518"><span class="hs-identifier hs-var">short_cut</span></a><span> </span><a href="#local-6989586621682606519"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621682606520"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-130"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-131"></a><span>    </span><a name="local-6989586621682606521"><a href="#local-6989586621682606521"><span class="hs-identifier">cls_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">className</span><span> </span><a href="#local-6989586621682606519"><span class="hs-identifier hs-var">clas</span></a><span>
</span><a name="line-132"></a><span>
</span><a name="line-133"></a><span>
</span><a name="line-134"></a><span class="hs-comment">{- ********************************************************************
*                                                                     *
                   Looking in the instance environment
*                                                                     *
***********************************************************************-}</span><span>
</span><a name="line-139"></a><span>
</span><a name="line-140"></a><span>
</span><a name="line-141"></a><span class="hs-identifier">matchInstEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="ClsInst.html#ClsInstResult"><span class="hs-identifier hs-type">ClsInstResult</span></a><span>
</span><a name="line-142"></a><a name="matchInstEnv"><a href="ClsInst.html#matchInstEnv"><span class="hs-identifier">matchInstEnv</span></a></a><span> </span><a name="local-6989586621682606522"><a href="#local-6989586621682606522"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682606523"><a href="#local-6989586621682606523"><span class="hs-identifier">short_cut_solver</span></a></a><span> </span><a name="local-6989586621682606524"><a href="#local-6989586621682606524"><span class="hs-identifier">clas</span></a></a><span> </span><a name="local-6989586621682606525"><a href="#local-6989586621682606525"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-143"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682606527"><a href="#local-6989586621682606527"><span class="hs-identifier">instEnvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcGetInstEnvs"><span class="hs-identifier hs-var">tcGetInstEnvs</span></a><span>
</span><a name="line-144"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682606528"><a href="#local-6989586621682606528"><span class="hs-identifier">safeOverlapCheck</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">safeHaskell</span><span> </span><a href="#local-6989586621682606522"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Sf_Safe</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Sf_Trustworthy</span><span class="hs-special">]</span><span>
</span><a name="line-145"></a><span>              </span><span class="hs-special">(</span><a name="local-6989586621682606529"><a href="#local-6989586621682606529"><span class="hs-identifier">matches</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682606530"><a href="#local-6989586621682606530"><span class="hs-identifier">unify</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682606531"><a href="#local-6989586621682606531"><span class="hs-identifier">unsafeOverlaps</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupInstEnv</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621682606527"><span class="hs-identifier hs-var">instEnvs</span></a><span> </span><a href="#local-6989586621682606524"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621682606525"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-146"></a><span>              </span><a name="local-6989586621682606532"><a href="#local-6989586621682606532"><span class="hs-identifier">safeHaskFail</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682606528"><span class="hs-identifier hs-var">safeOverlapCheck</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682606531"><span class="hs-identifier hs-var">unsafeOverlaps</span></a><span class="hs-special">)</span><span>
</span><a name="line-147"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;matchInstEnv&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-148"></a><span>            </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;goal:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682606524"><span class="hs-identifier hs-var">clas</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682606525"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-149"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;matches:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682606529"><span class="hs-identifier hs-var">matches</span></a><span>
</span><a name="line-150"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;unify:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682606530"><span class="hs-identifier hs-var">unify</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-151"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682606529"><span class="hs-identifier hs-var">matches</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682606530"><span class="hs-identifier hs-var">unify</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682606532"><span class="hs-identifier hs-var">safeHaskFail</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span>            </span><span class="hs-comment">-- Nothing matches</span><span>
</span><a name="line-154"></a><span>            </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-155"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;matchClass not matching&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682606526"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span>
</span><a name="line-156"></a><span>                      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="ClsInst.html#NoInstance"><span class="hs-identifier hs-var">NoInstance</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-157"></a><span>
</span><a name="line-158"></a><span>            </span><span class="hs-comment">-- A single match (&amp; no safe haskell failure)</span><span>
</span><a name="line-159"></a><span>            </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><a name="local-6989586621682606533"><a href="#local-6989586621682606533"><span class="hs-identifier">ispec</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682606534"><a href="#local-6989586621682606534"><span class="hs-identifier">inst_tys</span></a></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span>
</span><a name="line-160"></a><span>                </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682606523"><span class="hs-identifier hs-var">short_cut_solver</span></a><span>      </span><span class="hs-comment">-- Called from the short-cut solver</span><span>
</span><a name="line-161"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isOverlappable</span><span> </span><a href="#local-6989586621682606533"><span class="hs-identifier hs-var">ispec</span></a><span>
</span><a name="line-162"></a><span>                </span><span class="hs-comment">-- If the instance has OVERLAPPABLE or OVERLAPS or INCOHERENT</span><span>
</span><a name="line-163"></a><span>                </span><span class="hs-comment">-- then don't let the short-cut solver choose it, because a</span><span>
</span><a name="line-164"></a><span>                </span><span class="hs-comment">-- later instance might overlap it.  Trac #14434 is an example</span><span>
</span><a name="line-165"></a><span>                </span><span class="hs-comment">-- See Note [Shortcut solving: overlap]</span><span>
</span><a name="line-166"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;matchClass: ignoring overlappable&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682606526"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span>
</span><a name="line-167"></a><span>                      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="ClsInst.html#NotSure"><span class="hs-identifier hs-var">NotSure</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-168"></a><span>
</span><a name="line-169"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-170"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682606535"><a href="#local-6989586621682606535"><span class="hs-identifier">dfun_id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">instanceDFunId</span><span> </span><a href="#local-6989586621682606533"><span class="hs-identifier hs-var">ispec</span></a><span>
</span><a name="line-171"></a><span>                      </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;matchClass success&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-172"></a><span>                        </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;dict&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682606526"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">,</span><span>
</span><a name="line-173"></a><span>                              </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;witness&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682606535"><span class="hs-identifier hs-var">dfun_id</span></a><span>
</span><a name="line-174"></a><span>                                             </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621682606535"><span class="hs-identifier hs-var">dfun_id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-175"></a><span>                                </span><span class="hs-comment">-- Record that this dfun is needed</span><span>
</span><a name="line-176"></a><span>                      </span><span class="hs-special">;</span><span> </span><a href="ClsInst.html#match_one"><span class="hs-identifier hs-var">match_one</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682606531"><span class="hs-identifier hs-var">unsafeOverlaps</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682606535"><span class="hs-identifier hs-var">dfun_id</span></a><span> </span><a href="#local-6989586621682606534"><span class="hs-identifier hs-var">inst_tys</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-177"></a><span>
</span><a name="line-178"></a><span>            </span><span class="hs-comment">-- More than one matches (or Safe Haskell fail!). Defer any</span><span>
</span><a name="line-179"></a><span>            </span><span class="hs-comment">-- reactions of a multitude until we learn more about the reagent</span><span>
</span><a name="line-180"></a><span>            </span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;matchClass multiple matches, deferring choice&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-181"></a><span>                        </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;dict&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682606526"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">,</span><span>
</span><a name="line-182"></a><span>                              </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;matches&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682606529"><span class="hs-identifier hs-var">matches</span></a><span class="hs-special">]</span><span>
</span><a name="line-183"></a><span>                      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="ClsInst.html#NotSure"><span class="hs-identifier hs-var">NotSure</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-184"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-185"></a><span>     </span><a name="local-6989586621682606526"><a href="#local-6989586621682606526"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkClassPred</span><span> </span><a href="#local-6989586621682606524"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621682606525"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-186"></a><span>
</span><a name="line-187"></a><span class="hs-identifier">match_one</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="ClsInst.html#SafeOverlapping"><span class="hs-identifier hs-type">SafeOverlapping</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DFunId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DFunInstType</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="ClsInst.html#ClsInstResult"><span class="hs-identifier hs-type">ClsInstResult</span></a><span>
</span><a name="line-188"></a><span>             </span><span class="hs-comment">-- See Note [DFunInstType: instantiating types] in InstEnv</span><span>
</span><a name="line-189"></a><a name="match_one"><a href="ClsInst.html#match_one"><span class="hs-identifier">match_one</span></a></a><span> </span><a name="local-6989586621682606536"><a href="#local-6989586621682606536"><span class="hs-identifier">so</span></a></a><span> </span><a name="local-6989586621682606537"><a href="#local-6989586621682606537"><span class="hs-identifier">dfun_id</span></a></a><span> </span><a name="local-6989586621682606538"><a href="#local-6989586621682606538"><span class="hs-identifier">mb_inst_tys</span></a></a><span>
</span><a name="line-190"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;match_one&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682606537"><span class="hs-identifier hs-var">dfun_id</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682606538"><span class="hs-identifier hs-var">mb_inst_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-191"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682606539"><a href="#local-6989586621682606539"><span class="hs-identifier">tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682606540"><a href="#local-6989586621682606540"><span class="hs-identifier">theta</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#instDFunType"><span class="hs-identifier hs-var">instDFunType</span></a><span> </span><a href="#local-6989586621682606537"><span class="hs-identifier hs-var">dfun_id</span></a><span> </span><a href="#local-6989586621682606538"><span class="hs-identifier hs-var">mb_inst_tys</span></a><span>
</span><a name="line-192"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;match_one 2&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682606537"><span class="hs-identifier hs-var">dfun_id</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682606539"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682606540"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">)</span><span>
</span><a name="line-193"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="ClsInst.html#OneInst"><span class="hs-identifier hs-var">OneInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cir_new_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682606540"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-194"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cir_mk_ev</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">evDFunApp</span><span> </span><a href="#local-6989586621682606537"><span class="hs-identifier hs-var">dfun_id</span></a><span> </span><a href="#local-6989586621682606539"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-195"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cir_what</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="ClsInst.html#TopLevInstance"><span class="hs-identifier hs-var">TopLevInstance</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">iw_dfun_id</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682606537"><span class="hs-identifier hs-var">dfun_id</span></a><span>
</span><a name="line-196"></a><span>                                                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">iw_safe_over</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682606536"><span class="hs-identifier hs-var">so</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-197"></a><span>
</span><a name="line-198"></a><span>
</span><a name="line-199"></a><span class="hs-comment">{- Note [Shortcut solving: overlap]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have
  instance {-# OVERLAPPABLE #-} C a where ...
and we are typechecking
  f :: C a =&gt; a -&gt; a
  f = e  -- Gives rise to [W] C a

We don't want to solve the wanted constraint with the overlappable
instance; rather we want to use the supplied (C a)! That was the whole
point of it being overlappable!  Trac #14434 wwas an example.

Alas even if the instance has no overlap flag, thus
  instance C a where ...
there is nothing to stop it being overlapped. GHC provides no way to
declare an instance as &quot;final&quot; so it can't be overlapped.  But really
only final instances are OK for short-cut solving.  Sigh. Trac #15135
was a puzzling example.
-}</span><span>
</span><a name="line-218"></a><span>
</span><a name="line-219"></a><span>
</span><a name="line-220"></a><span class="hs-comment">{- ********************************************************************
*                                                                     *
                   Class lookup for CTuples
*                                                                     *
***********************************************************************-}</span><span>
</span><a name="line-225"></a><span>
</span><a name="line-226"></a><span class="hs-identifier">matchCTuple</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="ClsInst.html#ClsInstResult"><span class="hs-identifier hs-type">ClsInstResult</span></a><span>
</span><a name="line-227"></a><a name="matchCTuple"><a href="ClsInst.html#matchCTuple"><span class="hs-identifier">matchCTuple</span></a></a><span> </span><a name="local-6989586621682606541"><a href="#local-6989586621682606541"><span class="hs-identifier">clas</span></a></a><span> </span><a name="local-6989586621682606542"><a href="#local-6989586621682606542"><span class="hs-identifier">tys</span></a></a><span>   </span><span class="hs-comment">-- (isCTupleClass clas) holds</span><span>
</span><a name="line-228"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="ClsInst.html#OneInst"><span class="hs-identifier hs-var">OneInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cir_new_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682606542"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-229"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cir_mk_ev</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682606544"><span class="hs-identifier hs-var">tuple_ev</span></a><span>
</span><a name="line-230"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cir_what</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="ClsInst.html#BuiltinInstance"><span class="hs-identifier hs-var">BuiltinInstance</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-231"></a><span>            </span><span class="hs-comment">-- The dfun *is* the data constructor!</span><span>
</span><a name="line-232"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-233"></a><span>     </span><a name="local-6989586621682606543"><a href="#local-6989586621682606543"><span class="hs-identifier">data_con</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConSingleDataCon</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">classTyCon</span><span> </span><a href="#local-6989586621682606541"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">)</span><span>
</span><a name="line-234"></a><span>     </span><a name="local-6989586621682606544"><a href="#local-6989586621682606544"><span class="hs-identifier">tuple_ev</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">evDFunApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConWrapId</span><span> </span><a href="#local-6989586621682606543"><span class="hs-identifier hs-var">data_con</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682606542"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-235"></a><span>
</span><a name="line-236"></a><span class="hs-comment">{- ********************************************************************
*                                                                     *
                   Class lookup for Literals
*                                                                     *
***********************************************************************-}</span><span>
</span><a name="line-241"></a><span>
</span><a name="line-242"></a><span class="hs-comment">{-
Note [KnownNat &amp; KnownSymbol and EvLit]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
A part of the type-level literals implementation are the classes
&quot;KnownNat&quot; and &quot;KnownSymbol&quot;, which provide a &quot;smart&quot; constructor for
defining singleton values.  Here is the key stuff from GHC.TypeLits

  class KnownNat (n :: Nat) where
    natSing :: SNat n

  newtype SNat (n :: Nat) = SNat Integer

Conceptually, this class has infinitely many instances:

  instance KnownNat 0       where natSing = SNat 0
  instance KnownNat 1       where natSing = SNat 1
  instance KnownNat 2       where natSing = SNat 2
  ...

In practice, we solve `KnownNat` predicates in the type-checker
(see typecheck/TcInteract.hs) because we can't have infinitely many instances.
The evidence (aka &quot;dictionary&quot;) for `KnownNat` is of the form `EvLit (EvNum n)`.

We make the following assumptions about dictionaries in GHC:
  1. The &quot;dictionary&quot; for classes with a single method---like `KnownNat`---is
     a newtype for the type of the method, so using a evidence amounts
     to a coercion, and
  2. Newtypes use the same representation as their definition types.

So, the evidence for `KnownNat` is just a value of the representation type,
wrapped in two newtype constructors: one to make it into a `SNat` value,
and another to make it into a `KnownNat` dictionary.

Also note that `natSing` and `SNat` are never actually exposed from the
library---they are just an implementation detail.  Instead, users see
a more convenient function, defined in terms of `natSing`:

  natVal :: KnownNat n =&gt; proxy n -&gt; Integer

The reason we don't use this directly in the class is that it is simpler
and more efficient to pass around an integer rather than an entire function,
especially when the `KnowNat` evidence is packaged up in an existential.

The story for kind `Symbol` is analogous:
  * class KnownSymbol
  * newtype SSymbol
  * Evidence: a Core literal (e.g. mkNaturalExpr)


Note [Fabricating Evidence for Literals in Backpack]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Let `T` be a type of kind `Nat`. When solving for a purported instance
of `KnownNat T`, ghc tries to resolve the type `T` to an integer `n`,
in which case the evidence `EvLit (EvNum n)` is generated on the
fly. It might appear that this is sufficient as users cannot define
their own instances of `KnownNat`. However, for backpack module this
would not work (see issue #15379). Consider the signature `Abstract`

&gt; signature Abstract where
&gt;   data T :: Nat
&gt;   instance KnownNat T

and a module `Util` that depends on it:

&gt; module Util where
&gt;  import Abstract
&gt;  printT :: IO ()
&gt;  printT = do print $ natVal (Proxy :: Proxy T)

Clearly, we need to &quot;use&quot; the dictionary associated with `KnownNat T`
in the module `Util`, but it is too early for the compiler to produce
a real dictionary as we still have not fixed what `T` is. Only when we
mixin a concrete module

&gt; module Concrete where
&gt;   type T = 42

do we really get hold of the underlying integer. So the strategy that
we follow is the following

1. If T is indeed available as a type alias for an integer constant,
   generate the dictionary on the fly, failing which

2. Look up the type class environment for the evidence.

Finally actual code gets generate for Util only when a module like
Concrete gets &quot;mixed-in&quot; in place of the signature Abstract. As a
result all things, including the typeclass instances, in Concrete gets
reexported. So `KnownNat` gets resolved the normal way post-Backpack.

A similar generation works for `KnownSymbol` as well

-}</span><span>
</span><a name="line-336"></a><span>
</span><a name="line-337"></a><span class="hs-identifier">matchKnownNat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-338"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>      </span><span class="hs-comment">-- True &lt;=&gt; caller is the short-cut solver</span><span>
</span><a name="line-339"></a><span>                           </span><span class="hs-comment">-- See Note [Shortcut solving: overlap]</span><span>
</span><a name="line-340"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="ClsInst.html#ClsInstResult"><span class="hs-identifier hs-type">ClsInstResult</span></a><span>
</span><a name="line-341"></a><a name="matchKnownNat"><a href="ClsInst.html#matchKnownNat"><span class="hs-identifier">matchKnownNat</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682606545"><a href="#local-6989586621682606545"><span class="hs-identifier">clas</span></a></a><span> </span><span class="hs-special">[</span><a name="local-6989586621682606546"><a href="#local-6989586621682606546"><span class="hs-identifier">ty</span></a></a><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- clas = KnownNat</span><span>
</span><a name="line-342"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682606547"><a href="#local-6989586621682606547"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">isNumLitTy</span><span> </span><a href="#local-6989586621682606546"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-343"></a><span>        </span><a name="local-6989586621682606548"><a href="#local-6989586621682606548"><span class="hs-identifier">et</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mkNaturalExpr</span><span> </span><a href="#local-6989586621682606547"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-344"></a><span>        </span><a href="ClsInst.html#makeLitDict"><span class="hs-identifier hs-var">makeLitDict</span></a><span> </span><a href="#local-6989586621682606545"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621682606546"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621682606548"><span class="hs-identifier hs-var">et</span></a><span>
</span><a name="line-345"></a><span class="hs-identifier">matchKnownNat</span><span> </span><a name="local-6989586621682606549"><a href="#local-6989586621682606549"><span class="hs-identifier">df</span></a></a><span> </span><a name="local-6989586621682606550"><a href="#local-6989586621682606550"><span class="hs-identifier">sc</span></a></a><span> </span><a name="local-6989586621682606551"><a href="#local-6989586621682606551"><span class="hs-identifier">clas</span></a></a><span> </span><a name="local-6989586621682606552"><a href="#local-6989586621682606552"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ClsInst.html#matchInstEnv"><span class="hs-identifier hs-var">matchInstEnv</span></a><span> </span><a href="#local-6989586621682606549"><span class="hs-identifier hs-var">df</span></a><span> </span><a href="#local-6989586621682606550"><span class="hs-identifier hs-var">sc</span></a><span> </span><a href="#local-6989586621682606551"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621682606552"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-346"></a><span> </span><span class="hs-comment">-- See Note [Fabricating Evidence for Literals in Backpack] for why</span><span>
</span><a name="line-347"></a><span> </span><span class="hs-comment">-- this lookup into the instance environment is required.</span><span>
</span><a name="line-348"></a><span>
</span><a name="line-349"></a><span class="hs-identifier">matchKnownSymbol</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-350"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>      </span><span class="hs-comment">-- True &lt;=&gt; caller is the short-cut solver</span><span>
</span><a name="line-351"></a><span>                              </span><span class="hs-comment">-- See Note [Shortcut solving: overlap]</span><span>
</span><a name="line-352"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="ClsInst.html#ClsInstResult"><span class="hs-identifier hs-type">ClsInstResult</span></a><span>
</span><a name="line-353"></a><a name="matchKnownSymbol"><a href="ClsInst.html#matchKnownSymbol"><span class="hs-identifier">matchKnownSymbol</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682606553"><a href="#local-6989586621682606553"><span class="hs-identifier">clas</span></a></a><span> </span><span class="hs-special">[</span><a name="local-6989586621682606554"><a href="#local-6989586621682606554"><span class="hs-identifier">ty</span></a></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- clas = KnownSymbol</span><span>
</span><a name="line-354"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682606555"><a href="#local-6989586621682606555"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">isStrLitTy</span><span> </span><a href="#local-6989586621682606554"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-355"></a><span>        </span><a name="local-6989586621682606556"><a href="#local-6989586621682606556"><span class="hs-identifier">et</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mkStringExprFS</span><span> </span><a href="#local-6989586621682606555"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-356"></a><span>        </span><a href="ClsInst.html#makeLitDict"><span class="hs-identifier hs-var">makeLitDict</span></a><span> </span><a href="#local-6989586621682606553"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621682606554"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621682606556"><span class="hs-identifier hs-var">et</span></a><span>
</span><a name="line-357"></a><span class="hs-identifier">matchKnownSymbol</span><span> </span><a name="local-6989586621682606557"><a href="#local-6989586621682606557"><span class="hs-identifier">df</span></a></a><span> </span><a name="local-6989586621682606558"><a href="#local-6989586621682606558"><span class="hs-identifier">sc</span></a></a><span> </span><a name="local-6989586621682606559"><a href="#local-6989586621682606559"><span class="hs-identifier">clas</span></a></a><span> </span><a name="local-6989586621682606560"><a href="#local-6989586621682606560"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ClsInst.html#matchInstEnv"><span class="hs-identifier hs-var">matchInstEnv</span></a><span> </span><a href="#local-6989586621682606557"><span class="hs-identifier hs-var">df</span></a><span> </span><a href="#local-6989586621682606558"><span class="hs-identifier hs-var">sc</span></a><span> </span><a href="#local-6989586621682606559"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621682606560"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-358"></a><span> </span><span class="hs-comment">-- See Note [Fabricating Evidence for Literals in Backpack] for why</span><span>
</span><a name="line-359"></a><span> </span><span class="hs-comment">-- this lookup into the instance environment is required.</span><span>
</span><a name="line-360"></a><span>
</span><a name="line-361"></a><span class="hs-identifier">makeLitDict</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">EvExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="ClsInst.html#ClsInstResult"><span class="hs-identifier hs-type">ClsInstResult</span></a><span>
</span><a name="line-362"></a><span class="hs-comment">-- makeLitDict adds a coercion that will convert the literal into a dictionary</span><span>
</span><a name="line-363"></a><span class="hs-comment">-- of the appropriate type.  See Note [KnownNat &amp; KnownSymbol and EvLit]</span><span>
</span><a name="line-364"></a><span class="hs-comment">-- in TcEvidence.  The coercion happens in 2 steps:</span><span>
</span><a name="line-365"></a><span class="hs-comment">--</span><span>
</span><a name="line-366"></a><span class="hs-comment">--     Integer -&gt; SNat n     -- representation of literal to singleton</span><span>
</span><a name="line-367"></a><span class="hs-comment">--     SNat n  -&gt; KnownNat n -- singleton to dictionary</span><span>
</span><a name="line-368"></a><span class="hs-comment">--</span><span>
</span><a name="line-369"></a><span class="hs-comment">--     The process is mirrored for Symbols:</span><span>
</span><a name="line-370"></a><span class="hs-comment">--     String    -&gt; SSymbol n</span><span>
</span><a name="line-371"></a><span class="hs-comment">--     SSymbol n -&gt; KnownSymbol n</span><span>
</span><a name="line-372"></a><a name="makeLitDict"><a href="ClsInst.html#makeLitDict"><span class="hs-identifier">makeLitDict</span></a></a><span> </span><a name="local-6989586621682606561"><a href="#local-6989586621682606561"><span class="hs-identifier">clas</span></a></a><span> </span><a name="local-6989586621682606562"><a href="#local-6989586621682606562"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621682606563"><a href="#local-6989586621682606563"><span class="hs-identifier">et</span></a></a><span>
</span><a name="line-373"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682606564"><a href="#local-6989586621682606564"><span class="hs-identifier">co_dict</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#tcInstNewTyCon_maybe"><span class="hs-identifier hs-var">tcInstNewTyCon_maybe</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">classTyCon</span><span> </span><a href="#local-6989586621682606561"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682606562"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-374"></a><span>          </span><span class="hs-comment">-- co_dict :: KnownNat n ~ SNat n</span><span>
</span><a name="line-375"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span> </span><a name="local-6989586621682606565"><a href="#local-6989586621682606565"><span class="hs-identifier">meth</span></a></a><span> </span><span class="hs-special">]</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">classMethods</span><span> </span><a href="#local-6989586621682606561"><span class="hs-identifier hs-var">clas</span></a><span>
</span><a name="line-376"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682606566"><a href="#local-6989586621682606566"><span class="hs-identifier">tcRep</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tyConAppTyCon_maybe</span><span> </span><span class="hs-comment">-- SNat</span><span>
</span><a name="line-377"></a><span>                      </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">funResultTy</span><span>         </span><span class="hs-comment">-- SNat n</span><span>
</span><a name="line-378"></a><span>                      </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">dropForAlls</span><span>         </span><span class="hs-comment">-- KnownNat n =&gt; SNat n</span><span>
</span><a name="line-379"></a><span>                      </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621682606565"><span class="hs-identifier hs-var">meth</span></a><span>         </span><span class="hs-comment">-- forall n. KnownNat n =&gt; SNat n</span><span>
</span><a name="line-380"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682606567"><a href="#local-6989586621682606567"><span class="hs-identifier">co_rep</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#tcInstNewTyCon_maybe"><span class="hs-identifier hs-var">tcInstNewTyCon_maybe</span></a><span> </span><a href="#local-6989586621682606566"><span class="hs-identifier hs-var">tcRep</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621682606562"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-381"></a><span>          </span><span class="hs-comment">-- SNat n ~ Integer</span><span>
</span><a name="line-382"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682606568"><a href="#local-6989586621682606568"><span class="hs-identifier">ev_tm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkEvCast</span><span> </span><a href="#local-6989586621682606563"><span class="hs-identifier hs-var">et</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTcSymCo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTcTransCo</span><span> </span><a href="#local-6989586621682606564"><span class="hs-identifier hs-var">co_dict</span></a><span> </span><a href="#local-6989586621682606567"><span class="hs-identifier hs-var">co_rep</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-383"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="ClsInst.html#OneInst"><span class="hs-identifier hs-var">OneInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cir_new_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-384"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cir_mk_ev</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682606568"><span class="hs-identifier hs-var">ev_tm</span></a><span>
</span><a name="line-385"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cir_what</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="ClsInst.html#BuiltinInstance"><span class="hs-identifier hs-var">BuiltinInstance</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-386"></a><span>
</span><a name="line-387"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-388"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;makeLitDict&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-389"></a><span>      </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Unexpected evidence for&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">className</span><span> </span><a href="#local-6989586621682606561"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">)</span><span>
</span><a name="line-390"></a><span>      </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">idType</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">classMethods</span><span> </span><a href="#local-6989586621682606561"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-391"></a><span>
</span><a name="line-392"></a><span class="hs-comment">{- ********************************************************************
*                                                                     *
                   Class lookup for Typeable
*                                                                     *
***********************************************************************-}</span><span>
</span><a name="line-397"></a><span>
</span><a name="line-398"></a><span class="hs-comment">-- | Assumes that we've checked that this is the 'Typeable' class,</span><span>
</span><a name="line-399"></a><span class="hs-comment">-- and it was applied to the correct argument.</span><span>
</span><a name="line-400"></a><span class="hs-identifier">matchTypeable</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="ClsInst.html#ClsInstResult"><span class="hs-identifier hs-type">ClsInstResult</span></a><span>
</span><a name="line-401"></a><a name="matchTypeable"><a href="ClsInst.html#matchTypeable"><span class="hs-identifier">matchTypeable</span></a></a><span> </span><a name="local-6989586621682606569"><a href="#local-6989586621682606569"><span class="hs-identifier">clas</span></a></a><span> </span><span class="hs-special">[</span><a name="local-6989586621682606570"><a href="#local-6989586621682606570"><span class="hs-identifier">k</span></a></a><span class="hs-special">,</span><a name="local-6989586621682606571"><a href="#local-6989586621682606571"><span class="hs-identifier">t</span></a></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- clas = Typeable</span><span>
</span><a name="line-402"></a><span>  </span><span class="hs-comment">-- For the first two cases, See Note [No Typeable for polytypes or qualified types]</span><span>
</span><a name="line-403"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isForAllTy</span><span> </span><a href="#local-6989586621682606570"><span class="hs-identifier hs-var">k</span></a><span>                      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="ClsInst.html#NoInstance"><span class="hs-identifier hs-var">NoInstance</span></a><span>   </span><span class="hs-comment">-- Polytype</span><span>
</span><a name="line-404"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tcSplitPredFunTy_maybe</span><span> </span><a href="#local-6989586621682606571"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="ClsInst.html#NoInstance"><span class="hs-identifier hs-var">NoInstance</span></a><span>   </span><span class="hs-comment">-- Qualified type</span><span>
</span><a name="line-405"></a><span>
</span><a name="line-406"></a><span>  </span><span class="hs-comment">-- Now cases that do work</span><span>
</span><a name="line-407"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682606570"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">typeNatKind</span><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="ClsInst.html#doTyLit"><span class="hs-identifier hs-var">doTyLit</span></a><span> </span><span class="hs-identifier hs-var">knownNatClassName</span><span>         </span><a href="#local-6989586621682606571"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-408"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682606570"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">typeSymbolKind</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="ClsInst.html#doTyLit"><span class="hs-identifier hs-var">doTyLit</span></a><span> </span><span class="hs-identifier hs-var">knownSymbolClassName</span><span>      </span><a href="#local-6989586621682606571"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-409"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">tcIsConstraintKind</span><span> </span><a href="#local-6989586621682606571"><span class="hs-identifier hs-var">t</span></a><span>                   </span><span class="hs-glyph">=</span><span> </span><a href="ClsInst.html#doTyConApp"><span class="hs-identifier hs-var">doTyConApp</span></a><span> </span><a href="#local-6989586621682606569"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621682606571"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-identifier hs-var">constraintKindTyCon</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-410"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682606572"><a href="#local-6989586621682606572"><span class="hs-identifier">arg</span></a></a><span class="hs-special">,</span><a name="local-6989586621682606573"><a href="#local-6989586621682606573"><span class="hs-identifier">ret</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">splitFunTy_maybe</span><span> </span><a href="#local-6989586621682606571"><span class="hs-identifier hs-var">t</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="ClsInst.html#doFunTy"><span class="hs-identifier hs-var">doFunTy</span></a><span>    </span><a href="#local-6989586621682606569"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621682606571"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621682606572"><span class="hs-identifier hs-var">arg</span></a><span> </span><a href="#local-6989586621682606573"><span class="hs-identifier hs-var">ret</span></a><span>
</span><a name="line-411"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682606574"><a href="#local-6989586621682606574"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682606575"><a href="#local-6989586621682606575"><span class="hs-identifier">ks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">splitTyConApp_maybe</span><span> </span><a href="#local-6989586621682606571"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-comment">-- See Note [Typeable (T a b c)]</span><span>
</span><a name="line-412"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="ClsInst.html#onlyNamedBndrsApplied"><span class="hs-identifier hs-var">onlyNamedBndrsApplied</span></a><span> </span><a href="#local-6989586621682606574"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682606575"><span class="hs-identifier hs-var">ks</span></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="ClsInst.html#doTyConApp"><span class="hs-identifier hs-var">doTyConApp</span></a><span> </span><a href="#local-6989586621682606569"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621682606571"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621682606574"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682606575"><span class="hs-identifier hs-var">ks</span></a><span>
</span><a name="line-413"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682606576"><a href="#local-6989586621682606576"><span class="hs-identifier">f</span></a></a><span class="hs-special">,</span><a name="local-6989586621682606577"><a href="#local-6989586621682606577"><span class="hs-identifier">kt</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">splitAppTy_maybe</span><span> </span><a href="#local-6989586621682606571"><span class="hs-identifier hs-var">t</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="ClsInst.html#doTyApp"><span class="hs-identifier hs-var">doTyApp</span></a><span>    </span><a href="#local-6989586621682606569"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621682606571"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621682606576"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621682606577"><span class="hs-identifier hs-var">kt</span></a><span>
</span><a name="line-414"></a><span>
</span><a name="line-415"></a><span class="hs-identifier">matchTypeable</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="ClsInst.html#NoInstance"><span class="hs-identifier hs-var">NoInstance</span></a><span>
</span><a name="line-416"></a><span>
</span><a name="line-417"></a><span class="hs-comment">-- | Representation for a type @ty@ of the form @arg -&gt; ret@.</span><span>
</span><a name="line-418"></a><span class="hs-identifier">doFunTy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="ClsInst.html#ClsInstResult"><span class="hs-identifier hs-type">ClsInstResult</span></a><span>
</span><a name="line-419"></a><a name="doFunTy"><a href="ClsInst.html#doFunTy"><span class="hs-identifier">doFunTy</span></a></a><span> </span><a name="local-6989586621682606578"><a href="#local-6989586621682606578"><span class="hs-identifier">clas</span></a></a><span> </span><a name="local-6989586621682606579"><a href="#local-6989586621682606579"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621682606580"><a href="#local-6989586621682606580"><span class="hs-identifier">arg_ty</span></a></a><span> </span><a name="local-6989586621682606581"><a href="#local-6989586621682606581"><span class="hs-identifier">ret_ty</span></a></a><span>
</span><a name="line-420"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="ClsInst.html#OneInst"><span class="hs-identifier hs-var">OneInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cir_new_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682606582"><span class="hs-identifier hs-var">preds</span></a><span>
</span><a name="line-421"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cir_mk_ev</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682606583"><span class="hs-identifier hs-var">mk_ev</span></a><span>
</span><a name="line-422"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cir_what</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="ClsInst.html#BuiltinInstance"><span class="hs-identifier hs-var">BuiltinInstance</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-423"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-424"></a><span>    </span><a name="local-6989586621682606582"><a href="#local-6989586621682606582"><span class="hs-identifier">preds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="ClsInst.html#mk_typeable_pred"><span class="hs-identifier hs-var">mk_typeable_pred</span></a><span> </span><a href="#local-6989586621682606578"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682606580"><span class="hs-identifier hs-var">arg_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682606581"><span class="hs-identifier hs-var">ret_ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-425"></a><span>    </span><a name="local-6989586621682606583"><a href="#local-6989586621682606583"><span class="hs-identifier">mk_ev</span></a></a><span> </span><span class="hs-special">[</span><a name="local-6989586621682606584"><a href="#local-6989586621682606584"><span class="hs-identifier">arg_ev</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682606585"><a href="#local-6989586621682606585"><span class="hs-identifier">ret_ev</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">evTypeable</span><span> </span><a href="#local-6989586621682606579"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-426"></a><span>                             </span><span class="hs-identifier hs-var">EvTypeableTrFun</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvExpr</span><span> </span><a href="#local-6989586621682606584"><span class="hs-identifier hs-var">arg_ev</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvExpr</span><span> </span><a href="#local-6989586621682606585"><span class="hs-identifier hs-var">ret_ev</span></a><span class="hs-special">)</span><span>
</span><a name="line-427"></a><span>    </span><span class="hs-identifier">mk_ev</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;TcInteract.doFunTy&quot;</span><span>
</span><a name="line-428"></a><span>
</span><a name="line-429"></a><span>
</span><a name="line-430"></a><span class="hs-comment">-- | Representation for type constructor applied to some kinds.</span><span>
</span><a name="line-431"></a><span class="hs-comment">-- 'onlyNamedBndrsApplied' has ensured that this application results in a type</span><span>
</span><a name="line-432"></a><span class="hs-comment">-- of monomorphic kind (e.g. all kind variables have been instantiated).</span><span>
</span><a name="line-433"></a><span class="hs-identifier">doTyConApp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Kind</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="ClsInst.html#ClsInstResult"><span class="hs-identifier hs-type">ClsInstResult</span></a><span>
</span><a name="line-434"></a><a name="doTyConApp"><a href="ClsInst.html#doTyConApp"><span class="hs-identifier">doTyConApp</span></a></a><span> </span><a name="local-6989586621682606586"><a href="#local-6989586621682606586"><span class="hs-identifier">clas</span></a></a><span> </span><a name="local-6989586621682606587"><a href="#local-6989586621682606587"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621682606588"><a href="#local-6989586621682606588"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682606589"><a href="#local-6989586621682606589"><span class="hs-identifier">kind_args</span></a></a><span>
</span><a name="line-435"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tyConRepName_maybe</span><span> </span><a href="#local-6989586621682606588"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-436"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="ClsInst.html#OneInst"><span class="hs-identifier hs-var">OneInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cir_new_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="ClsInst.html#mk_typeable_pred"><span class="hs-identifier hs-var">mk_typeable_pred</span></a><span> </span><a href="#local-6989586621682606586"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682606589"><span class="hs-identifier hs-var">kind_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-437"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cir_mk_ev</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682606590"><span class="hs-identifier hs-var">mk_ev</span></a><span>
</span><a name="line-438"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cir_what</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="ClsInst.html#BuiltinInstance"><span class="hs-identifier hs-var">BuiltinInstance</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-439"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-440"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="ClsInst.html#NoInstance"><span class="hs-identifier hs-var">NoInstance</span></a><span>
</span><a name="line-441"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-442"></a><span>    </span><a name="local-6989586621682606590"><a href="#local-6989586621682606590"><span class="hs-identifier">mk_ev</span></a></a><span> </span><a name="local-6989586621682606591"><a href="#local-6989586621682606591"><span class="hs-identifier">kinds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">evTypeable</span><span> </span><a href="#local-6989586621682606587"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">EvTypeableTyCon</span><span> </span><a href="#local-6989586621682606588"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">EvExpr</span><span> </span><a href="#local-6989586621682606591"><span class="hs-identifier hs-var">kinds</span></a><span class="hs-special">)</span><span>
</span><a name="line-443"></a><span>
</span><a name="line-444"></a><span class="hs-comment">-- | Representation for TyCon applications of a concrete kind. We just use the</span><span>
</span><a name="line-445"></a><span class="hs-comment">-- kind itself, but first we must make sure that we've instantiated all kind-</span><span>
</span><a name="line-446"></a><span class="hs-comment">-- polymorphism, but no more.</span><span>
</span><a name="line-447"></a><span class="hs-identifier">onlyNamedBndrsApplied</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">KindOrType</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-448"></a><a name="onlyNamedBndrsApplied"><a href="ClsInst.html#onlyNamedBndrsApplied"><span class="hs-identifier">onlyNamedBndrsApplied</span></a></a><span> </span><a name="local-6989586621682606592"><a href="#local-6989586621682606592"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682606593"><a href="#local-6989586621682606593"><span class="hs-identifier">ks</span></a></a><span>
</span><a name="line-449"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-identifier hs-var">isNamedTyConBinder</span><span> </span><a href="#local-6989586621682606595"><span class="hs-identifier hs-var">used_bndrs</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-450"></a><span>   </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-identifier hs-var">isNamedTyConBinder</span><span> </span><a href="#local-6989586621682606596"><span class="hs-identifier hs-var">leftover_bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-451"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-452"></a><span>   </span><a name="local-6989586621682606594"><a href="#local-6989586621682606594"><span class="hs-identifier">bndrs</span></a></a><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConBinders</span><span> </span><a href="#local-6989586621682606592"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-453"></a><span>   </span><span class="hs-special">(</span><a name="local-6989586621682606595"><a href="#local-6989586621682606595"><span class="hs-identifier">used_bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682606596"><a href="#local-6989586621682606596"><span class="hs-identifier">leftover_bndrs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitAtList</span><span> </span><a href="#local-6989586621682606593"><span class="hs-identifier hs-var">ks</span></a><span> </span><a href="#local-6989586621682606594"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-454"></a><span>
</span><a name="line-455"></a><span class="hs-identifier">doTyApp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">KindOrType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="ClsInst.html#ClsInstResult"><span class="hs-identifier hs-type">ClsInstResult</span></a><span>
</span><a name="line-456"></a><span class="hs-comment">-- Representation for an application of a type to a type-or-kind.</span><span>
</span><a name="line-457"></a><span class="hs-comment">--  This may happen when the type expression starts with a type variable.</span><span>
</span><a name="line-458"></a><span class="hs-comment">--  Example (ignoring kind parameter):</span><span>
</span><a name="line-459"></a><span class="hs-comment">--    Typeable (f Int Char)                      --&gt;</span><span>
</span><a name="line-460"></a><span class="hs-comment">--    (Typeable (f Int), Typeable Char)          --&gt;</span><span>
</span><a name="line-461"></a><span class="hs-comment">--    (Typeable f, Typeable Int, Typeable Char)  --&gt; (after some simp. steps)</span><span>
</span><a name="line-462"></a><span class="hs-comment">--    Typeable f</span><span>
</span><a name="line-463"></a><a name="doTyApp"><a href="ClsInst.html#doTyApp"><span class="hs-identifier">doTyApp</span></a></a><span> </span><a name="local-6989586621682606597"><a href="#local-6989586621682606597"><span class="hs-identifier">clas</span></a></a><span> </span><a name="local-6989586621682606598"><a href="#local-6989586621682606598"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621682606599"><a href="#local-6989586621682606599"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621682606600"><a href="#local-6989586621682606600"><span class="hs-identifier">tk</span></a></a><span>
</span><a name="line-464"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isForAllTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tcTypeKind</span><span> </span><a href="#local-6989586621682606599"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-465"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="ClsInst.html#NoInstance"><span class="hs-identifier hs-var">NoInstance</span></a><span> </span><span class="hs-comment">-- We can't solve until we know the ctr.</span><span>
</span><a name="line-466"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-467"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="ClsInst.html#OneInst"><span class="hs-identifier hs-var">OneInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cir_new_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="ClsInst.html#mk_typeable_pred"><span class="hs-identifier hs-var">mk_typeable_pred</span></a><span> </span><a href="#local-6989586621682606597"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682606599"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682606600"><span class="hs-identifier hs-var">tk</span></a><span class="hs-special">]</span><span>
</span><a name="line-468"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cir_mk_ev</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682606601"><span class="hs-identifier hs-var">mk_ev</span></a><span>
</span><a name="line-469"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cir_what</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="ClsInst.html#BuiltinInstance"><span class="hs-identifier hs-var">BuiltinInstance</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-470"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-471"></a><span>    </span><a name="local-6989586621682606601"><a href="#local-6989586621682606601"><span class="hs-identifier">mk_ev</span></a></a><span> </span><span class="hs-special">[</span><a name="local-6989586621682606602"><a href="#local-6989586621682606602"><span class="hs-identifier">t1</span></a></a><span class="hs-special">,</span><a name="local-6989586621682606603"><a href="#local-6989586621682606603"><span class="hs-identifier">t2</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">evTypeable</span><span> </span><a href="#local-6989586621682606598"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">EvTypeableTyApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvExpr</span><span> </span><a href="#local-6989586621682606602"><span class="hs-identifier hs-var">t1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvExpr</span><span> </span><a href="#local-6989586621682606603"><span class="hs-identifier hs-var">t2</span></a><span class="hs-special">)</span><span>
</span><a name="line-472"></a><span>    </span><span class="hs-identifier">mk_ev</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;doTyApp&quot;</span><span>
</span><a name="line-473"></a><span>
</span><a name="line-474"></a><span>
</span><a name="line-475"></a><span class="hs-comment">-- Emit a `Typeable` constraint for the given type.</span><span>
</span><a name="line-476"></a><span class="hs-identifier">mk_typeable_pred</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PredType</span><span>
</span><a name="line-477"></a><a name="mk_typeable_pred"><a href="ClsInst.html#mk_typeable_pred"><span class="hs-identifier">mk_typeable_pred</span></a></a><span> </span><a name="local-6989586621682606604"><a href="#local-6989586621682606604"><span class="hs-identifier">clas</span></a></a><span> </span><a name="local-6989586621682606605"><a href="#local-6989586621682606605"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkClassPred</span><span> </span><a href="#local-6989586621682606604"><span class="hs-identifier hs-var">clas</span></a><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">tcTypeKind</span><span> </span><a href="#local-6989586621682606605"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682606605"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-478"></a><span>
</span><a name="line-479"></a><span>  </span><span class="hs-comment">-- Typeable is implied by KnownNat/KnownSymbol. In the case of a type literal</span><span>
</span><a name="line-480"></a><span>  </span><span class="hs-comment">-- we generate a sub-goal for the appropriate class.</span><span>
</span><a name="line-481"></a><span>  </span><span class="hs-comment">-- See Note [Typeable for Nat and Symbol]</span><span>
</span><a name="line-482"></a><span class="hs-identifier">doTyLit</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="ClsInst.html#ClsInstResult"><span class="hs-identifier hs-type">ClsInstResult</span></a><span>
</span><a name="line-483"></a><a name="doTyLit"><a href="ClsInst.html#doTyLit"><span class="hs-identifier">doTyLit</span></a></a><span> </span><a name="local-6989586621682606606"><a href="#local-6989586621682606606"><span class="hs-identifier">kc</span></a></a><span> </span><a name="local-6989586621682606607"><a href="#local-6989586621682606607"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682606608"><a href="#local-6989586621682606608"><span class="hs-identifier">kc_clas</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupClass"><span class="hs-identifier hs-var">tcLookupClass</span></a><span> </span><a href="#local-6989586621682606606"><span class="hs-identifier hs-var">kc</span></a><span>
</span><a name="line-484"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682606609"><a href="#local-6989586621682606609"><span class="hs-identifier">kc_pred</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkClassPred</span><span> </span><a href="#local-6989586621682606608"><span class="hs-identifier hs-var">kc_clas</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621682606607"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-485"></a><span>                        </span><a name="local-6989586621682606610"><a href="#local-6989586621682606610"><span class="hs-identifier">mk_ev</span></a></a><span> </span><span class="hs-special">[</span><a name="local-6989586621682606611"><a href="#local-6989586621682606611"><span class="hs-identifier">ev</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">evTypeable</span><span> </span><a href="#local-6989586621682606607"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">EvTypeableTyLit</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvExpr</span><span> </span><a href="#local-6989586621682606611"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span>
</span><a name="line-486"></a><span>                        </span><span class="hs-identifier">mk_ev</span><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;doTyLit&quot;</span><span>
</span><a name="line-487"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="ClsInst.html#OneInst"><span class="hs-identifier hs-var">OneInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cir_new_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682606609"><span class="hs-identifier hs-var">kc_pred</span></a><span class="hs-special">]</span><span>
</span><a name="line-488"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cir_mk_ev</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682606610"><span class="hs-identifier hs-var">mk_ev</span></a><span>
</span><a name="line-489"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cir_what</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="ClsInst.html#BuiltinInstance"><span class="hs-identifier hs-var">BuiltinInstance</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-490"></a><span>
</span><a name="line-491"></a><span class="hs-comment">{- Note [Typeable (T a b c)]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For type applications we always decompose using binary application,
via doTyApp, until we get to a *kind* instantiation.  Example
   Proxy :: forall k. k -&gt; *

To solve Typeable (Proxy (* -&gt; *) Maybe) we
  - First decompose with doTyApp,
    to get (Typeable (Proxy (* -&gt; *))) and Typeable Maybe
  - Then solve (Typeable (Proxy (* -&gt; *))) with doTyConApp

If we attempt to short-cut by solving it all at once, via
doTyConApp

(this note is sadly truncated FIXME)


Note [No Typeable for polytypes or qualified types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We do not support impredicative typeable, such as
   Typeable (forall a. a-&gt;a)
   Typeable (Eq a =&gt; a -&gt; a)
   Typeable (() =&gt; Int)
   Typeable (((),()) =&gt; Int)

See Trac #9858.  For forall's the case is clear: we simply don't have
a TypeRep for them.  For qualified but not polymorphic types, like
(Eq a =&gt; a -&gt; a), things are murkier.  But:

 * We don't need a TypeRep for these things.  TypeReps are for
   monotypes only.

 * Perhaps we could treat `=&gt;` as another type constructor for `Typeable`
   purposes, and thus support things like `Eq Int =&gt; Int`, however,
   at the current state of affairs this would be an odd exception as
   no other class works with impredicative types.
   For now we leave it off, until we have a better story for impredicativity.


Note [Typeable for Nat and Symbol]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We have special Typeable instances for Nat and Symbol.  Roughly we
have this instance, implemented here by doTyLit:
      instance KnownNat n =&gt; Typeable (n :: Nat) where
         typeRep = typeNatTypeRep @n
where
   Data.Typeable.Internals.typeNatTypeRep :: KnownNat a =&gt; TypeRep a

Ultimately typeNatTypeRep uses 'natSing' from KnownNat to get a
runtime value 'n'; it turns it into a string with 'show' and uses
that to whiz up a TypeRep TyCon for 'n', with mkTypeLitTyCon.
See #10348.

Because of this rule it's inadvisable (see #15322) to have a constraint
    f :: (Typeable (n :: Nat)) =&gt; blah
in a function signature; it gives rise to overlap problems just as
if you'd written
    f :: Eq [a] =&gt; blah
-}</span><span>
</span><a name="line-550"></a><span>
</span><a name="line-551"></a><span class="hs-comment">{- ********************************************************************
*                                                                     *
                   Class lookup for lifted equality
*                                                                     *
***********************************************************************-}</span><span>
</span><a name="line-556"></a><span>
</span><a name="line-557"></a><span class="hs-comment">-- See also Note [The equality types story] in TysPrim</span><span>
</span><a name="line-558"></a><span class="hs-identifier">matchHeteroEquality</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="ClsInst.html#ClsInstResult"><span class="hs-identifier hs-type">ClsInstResult</span></a><span>
</span><a name="line-559"></a><span class="hs-comment">-- Solves (t1 ~~ t2)</span><span>
</span><a name="line-560"></a><a name="matchHeteroEquality"><a href="ClsInst.html#matchHeteroEquality"><span class="hs-identifier">matchHeteroEquality</span></a></a><span> </span><a name="local-6989586621682606612"><a href="#local-6989586621682606612"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-561"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="ClsInst.html#OneInst"><span class="hs-identifier hs-var">OneInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cir_new_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><span class="hs-identifier hs-var">eqPrimTyCon</span><span> </span><a href="#local-6989586621682606612"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-562"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cir_mk_ev</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">evDataConApp</span><span> </span><span class="hs-identifier hs-var">heqDataCon</span><span> </span><a href="#local-6989586621682606612"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-563"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cir_what</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="ClsInst.html#BuiltinInstance"><span class="hs-identifier hs-var">BuiltinInstance</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-564"></a><span>
</span><a name="line-565"></a><span class="hs-identifier">matchHomoEquality</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="ClsInst.html#ClsInstResult"><span class="hs-identifier hs-type">ClsInstResult</span></a><span>
</span><a name="line-566"></a><span class="hs-comment">-- Solves (t1 ~ t2)</span><span>
</span><a name="line-567"></a><a name="matchHomoEquality"><a href="ClsInst.html#matchHomoEquality"><span class="hs-identifier">matchHomoEquality</span></a></a><span> </span><a name="local-6989586621682606613"><a href="#local-6989586621682606613"><span class="hs-identifier">args</span></a></a><span class="hs-glyph">@</span><span class="hs-special">[</span><a name="local-6989586621682606614"><a href="#local-6989586621682606614"><span class="hs-identifier">k</span></a></a><span class="hs-special">,</span><a name="local-6989586621682606615"><a href="#local-6989586621682606615"><span class="hs-identifier">t1</span></a></a><span class="hs-special">,</span><a name="local-6989586621682606616"><a href="#local-6989586621682606616"><span class="hs-identifier">t2</span></a></a><span class="hs-special">]</span><span>
</span><a name="line-568"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="ClsInst.html#OneInst"><span class="hs-identifier hs-var">OneInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cir_new_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><span class="hs-identifier hs-var">eqPrimTyCon</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682606614"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><a href="#local-6989586621682606614"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><a href="#local-6989586621682606615"><span class="hs-identifier hs-var">t1</span></a><span class="hs-special">,</span><a href="#local-6989586621682606616"><span class="hs-identifier hs-var">t2</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-569"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cir_mk_ev</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">evDataConApp</span><span> </span><span class="hs-identifier hs-var">eqDataCon</span><span> </span><a href="#local-6989586621682606613"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-570"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cir_what</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="ClsInst.html#BuiltinInstance"><span class="hs-identifier hs-var">BuiltinInstance</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-571"></a><span class="hs-identifier">matchHomoEquality</span><span> </span><a name="local-6989586621682606617"><a href="#local-6989586621682606617"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;matchHomoEquality&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682606617"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-572"></a><span>
</span><a name="line-573"></a><span class="hs-comment">-- See also Note [The equality types story] in TysPrim</span><span>
</span><a name="line-574"></a><span class="hs-identifier">matchCoercible</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="ClsInst.html#ClsInstResult"><span class="hs-identifier hs-type">ClsInstResult</span></a><span>
</span><a name="line-575"></a><a name="matchCoercible"><a href="ClsInst.html#matchCoercible"><span class="hs-identifier">matchCoercible</span></a></a><span> </span><a name="local-6989586621682606618"><a href="#local-6989586621682606618"><span class="hs-identifier">args</span></a></a><span class="hs-glyph">@</span><span class="hs-special">[</span><a name="local-6989586621682606619"><a href="#local-6989586621682606619"><span class="hs-identifier">k</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682606620"><a href="#local-6989586621682606620"><span class="hs-identifier">t1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682606621"><a href="#local-6989586621682606621"><span class="hs-identifier">t2</span></a></a><span class="hs-special">]</span><span>
</span><a name="line-576"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="ClsInst.html#OneInst"><span class="hs-identifier hs-var">OneInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cir_new_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><span class="hs-identifier hs-var">eqReprPrimTyCon</span><span> </span><a href="#local-6989586621682606622"><span class="hs-identifier hs-var">args'</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-577"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cir_mk_ev</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">evDataConApp</span><span> </span><span class="hs-identifier hs-var">coercibleDataCon</span><span> </span><a href="#local-6989586621682606618"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-578"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cir_what</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="ClsInst.html#BuiltinInstance"><span class="hs-identifier hs-var">BuiltinInstance</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-579"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-580"></a><span>    </span><a name="local-6989586621682606622"><a href="#local-6989586621682606622"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682606619"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682606619"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682606620"><span class="hs-identifier hs-var">t1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682606621"><span class="hs-identifier hs-var">t2</span></a><span class="hs-special">]</span><span>
</span><a name="line-581"></a><span class="hs-identifier">matchCoercible</span><span> </span><a name="local-6989586621682606623"><a href="#local-6989586621682606623"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;matchLiftedCoercible&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682606623"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-582"></a><span>
</span><a name="line-583"></a><span>
</span><a name="line-584"></a><span class="hs-comment">{- ********************************************************************
*                                                                     *
              Class lookup for overloaded record fields
*                                                                     *
***********************************************************************-}</span><span>
</span><a name="line-589"></a><span>
</span><a name="line-590"></a><span class="hs-comment">{-
Note [HasField instances]
~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have

    data T y = MkT { foo :: [y] }

and `foo` is in scope.  Then GHC will automatically solve a constraint like

    HasField &quot;foo&quot; (T Int) b

by emitting a new wanted

    T alpha -&gt; [alpha] ~# T Int -&gt; b

and building a HasField dictionary out of the selector function `foo`,
appropriately cast.

The HasField class is defined (in GHC.Records) thus:

    class HasField (x :: k) r a | x r -&gt; a where
      getField :: r -&gt; a

Since this is a one-method class, it is represented as a newtype.
Hence we can solve `HasField &quot;foo&quot; (T Int) b` by taking an expression
of type `T Int -&gt; b` and casting it using the newtype coercion.
Note that

    foo :: forall y . T y -&gt; [y]

so the expression we construct is

    foo @alpha |&gt; co

where

    co :: (T alpha -&gt; [alpha]) ~# HasField &quot;foo&quot; (T Int) b

is built from

    co1 :: (T alpha -&gt; [alpha]) ~# (T Int -&gt; b)

which is the new wanted, and

    co2 :: (T Int -&gt; b) ~# HasField &quot;foo&quot; (T Int) b

which can be derived from the newtype coercion.

If `foo` is not in scope, or has a higher-rank or existentially
quantified type, then the constraint is not solved automatically, but
may be solved by a user-supplied HasField instance.  Similarly, if we
encounter a HasField constraint where the field is not a literal
string, or does not belong to the type, then we fall back on the
normal constraint solver behaviour.
-}</span><span>
</span><a name="line-645"></a><span>
</span><a name="line-646"></a><span class="hs-comment">-- See Note [HasField instances]</span><span>
</span><a name="line-647"></a><span class="hs-identifier">matchHasField</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="ClsInst.html#ClsInstResult"><span class="hs-identifier hs-type">ClsInstResult</span></a><span>
</span><a name="line-648"></a><a name="matchHasField"><a href="ClsInst.html#matchHasField"><span class="hs-identifier">matchHasField</span></a></a><span> </span><a name="local-6989586621682606624"><a href="#local-6989586621682606624"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682606625"><a href="#local-6989586621682606625"><span class="hs-identifier">short_cut</span></a></a><span> </span><a name="local-6989586621682606626"><a href="#local-6989586621682606626"><span class="hs-identifier">clas</span></a></a><span> </span><a name="local-6989586621682606627"><a href="#local-6989586621682606627"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-649"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682606628"><a href="#local-6989586621682606628"><span class="hs-identifier">fam_inst_envs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#tcGetFamInstEnvs"><span class="hs-identifier hs-var">tcGetFamInstEnvs</span></a><span>
</span><a name="line-650"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682606629"><a href="#local-6989586621682606629"><span class="hs-identifier">rdr_env</span></a></a><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGlobalRdrEnv"><span class="hs-identifier hs-var">getGlobalRdrEnv</span></a><span>
</span><a name="line-651"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682606627"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-652"></a><span>           </span><span class="hs-comment">-- We are matching HasField {k} x r a...</span><span>
</span><a name="line-653"></a><span>           </span><span class="hs-special">[</span><a name="local-6989586621682606630"><a href="#local-6989586621682606630"><span class="hs-identifier">_k_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682606631"><a href="#local-6989586621682606631"><span class="hs-identifier">x_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682606632"><a href="#local-6989586621682606632"><span class="hs-identifier">r_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682606633"><a href="#local-6989586621682606633"><span class="hs-identifier">a_ty</span></a></a><span class="hs-special">]</span><span>
</span><a name="line-654"></a><span>               </span><span class="hs-comment">-- x should be a literal string</span><span>
</span><a name="line-655"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682606634"><a href="#local-6989586621682606634"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">isStrLitTy</span><span> </span><a href="#local-6989586621682606631"><span class="hs-identifier hs-var">x_ty</span></a><span>
</span><a name="line-656"></a><span>               </span><span class="hs-comment">-- r should be an applied type constructor</span><span>
</span><a name="line-657"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682606635"><a href="#local-6989586621682606635"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682606636"><a href="#local-6989586621682606636"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span><span> </span><a href="#local-6989586621682606632"><span class="hs-identifier hs-var">r_ty</span></a><span>
</span><a name="line-658"></a><span>               </span><span class="hs-comment">-- use representation tycon (if data family); it has the fields</span><span>
</span><a name="line-659"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682606637"><a href="#local-6989586621682606637"><span class="hs-identifier">r_tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fstOf3</span><span> </span><span class="hs-special">(</span><a href="FamInst.html#tcLookupDataFamInst"><span class="hs-identifier hs-var">tcLookupDataFamInst</span></a><span> </span><a href="#local-6989586621682606628"><span class="hs-identifier hs-var">fam_inst_envs</span></a><span> </span><a href="#local-6989586621682606635"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682606636"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-660"></a><span>               </span><span class="hs-comment">-- x should be a field of r</span><span>
</span><a name="line-661"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682606638"><a href="#local-6989586621682606638"><span class="hs-identifier">fl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupTyConFieldLabel</span><span> </span><a href="#local-6989586621682606634"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682606637"><span class="hs-identifier hs-var">r_tc</span></a><span>
</span><a name="line-662"></a><span>               </span><span class="hs-comment">-- the field selector should be in scope</span><span>
</span><a name="line-663"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682606639"><a href="#local-6989586621682606639"><span class="hs-identifier">gre</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupGRE_FieldLabel</span><span> </span><a href="#local-6989586621682606629"><span class="hs-identifier hs-var">rdr_env</span></a><span> </span><a href="#local-6989586621682606638"><span class="hs-identifier hs-var">fl</span></a><span>
</span><a name="line-664"></a><span>
</span><a name="line-665"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682606640"><a href="#local-6989586621682606640"><span class="hs-identifier">sel_id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupId"><span class="hs-identifier hs-var">tcLookupId</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">flSelector</span><span> </span><a href="#local-6989586621682606638"><span class="hs-identifier hs-var">fl</span></a><span class="hs-special">)</span><span>
</span><a name="line-666"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682606641"><a href="#local-6989586621682606641"><span class="hs-identifier">tv_prs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682606642"><a href="#local-6989586621682606642"><span class="hs-identifier">preds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682606643"><a href="#local-6989586621682606643"><span class="hs-identifier">sel_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#tcInstType"><span class="hs-identifier hs-var">tcInstType</span></a><span> </span><a href="TcMType.html#newMetaTyVars"><span class="hs-identifier hs-var">newMetaTyVars</span></a><span> </span><a href="#local-6989586621682606640"><span class="hs-identifier hs-var">sel_id</span></a><span>
</span><a name="line-667"></a><span>
</span><a name="line-668"></a><span>                         </span><span class="hs-comment">-- The first new wanted constraint equates the actual</span><span>
</span><a name="line-669"></a><span>                         </span><span class="hs-comment">-- type of the selector with the type (r -&gt; a) within</span><span>
</span><a name="line-670"></a><span>                         </span><span class="hs-comment">-- the HasField x r a dictionary.  The preds will</span><span>
</span><a name="line-671"></a><span>                         </span><span class="hs-comment">-- typically be empty, but if the datatype has a</span><span>
</span><a name="line-672"></a><span>                         </span><span class="hs-comment">-- &quot;stupid theta&quot; then we have to include it here.</span><span>
</span><a name="line-673"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682606644"><a href="#local-6989586621682606644"><span class="hs-identifier">theta</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkPrimEqPred</span><span> </span><a href="#local-6989586621682606643"><span class="hs-identifier hs-var">sel_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkFunTy</span><span> </span><a href="#local-6989586621682606632"><span class="hs-identifier hs-var">r_ty</span></a><span> </span><a href="#local-6989586621682606633"><span class="hs-identifier hs-var">a_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682606642"><span class="hs-identifier hs-var">preds</span></a><span>
</span><a name="line-674"></a><span>
</span><a name="line-675"></a><span>                         </span><span class="hs-comment">-- Use the equality proof to cast the selector Id to</span><span>
</span><a name="line-676"></a><span>                         </span><span class="hs-comment">-- type (r -&gt; a), then use the newtype coercion to cast</span><span>
</span><a name="line-677"></a><span>                         </span><span class="hs-comment">-- it to a HasField dictionary.</span><span>
</span><a name="line-678"></a><span>                         </span><a name="local-6989586621682606645"><a href="#local-6989586621682606645"><span class="hs-identifier">mk_ev</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682606648"><a href="#local-6989586621682606648"><span class="hs-identifier">ev1</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682606649"><a href="#local-6989586621682606649"><span class="hs-identifier">evs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">evSelector</span><span> </span><a href="#local-6989586621682606640"><span class="hs-identifier hs-var">sel_id</span></a><span> </span><a href="#local-6989586621682606647"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621682606649"><span class="hs-identifier hs-var">evs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">evCast</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682606650"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-679"></a><span>                           </span><span class="hs-keyword">where</span><span>
</span><a name="line-680"></a><span>                             </span><a name="local-6989586621682606650"><a href="#local-6989586621682606650"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcSubCo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">evTermCoercion</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvExpr</span><span> </span><a href="#local-6989586621682606648"><span class="hs-identifier hs-var">ev1</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-681"></a><span>                                      </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkTcTransCo</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">mkTcSymCo</span><span> </span><a href="#local-6989586621682606646"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-682"></a><span>                         </span><span class="hs-identifier">mk_ev</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;matchHasField.mk_ev&quot;</span><span>
</span><a name="line-683"></a><span>
</span><a name="line-684"></a><span>                         </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682606646"><a href="#local-6989586621682606646"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInst.html#tcInstNewTyCon_maybe"><span class="hs-identifier hs-var">tcInstNewTyCon_maybe</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">classTyCon</span><span> </span><a href="#local-6989586621682606626"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">)</span><span>
</span><a name="line-685"></a><span>                                                              </span><a href="#local-6989586621682606627"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-686"></a><span>
</span><a name="line-687"></a><span>                         </span><a name="local-6989586621682606647"><a href="#local-6989586621682606647"><span class="hs-identifier">tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyVarTys</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621682606641"><span class="hs-identifier hs-var">tv_prs</span></a><span class="hs-special">)</span><span>
</span><a name="line-688"></a><span>
</span><a name="line-689"></a><span>                     </span><span class="hs-comment">-- The selector must not be &quot;naughty&quot; (i.e. the field</span><span>
</span><a name="line-690"></a><span>                     </span><span class="hs-comment">-- cannot have an existentially quantified type), and</span><span>
</span><a name="line-691"></a><span>                     </span><span class="hs-comment">-- it must not be higher-rank.</span><span>
</span><a name="line-692"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isNaughtyRecordSelector</span><span> </span><a href="#local-6989586621682606640"><span class="hs-identifier hs-var">sel_id</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isTauTy</span><span> </span><a href="#local-6989586621682606643"><span class="hs-identifier hs-var">sel_ty</span></a><span>
</span><a name="line-693"></a><span>                     </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="RnEnv.html#addUsedGRE"><span class="hs-identifier hs-var">addUsedGRE</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621682606639"><span class="hs-identifier hs-var">gre</span></a><span>
</span><a name="line-694"></a><span>                             </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="ClsInst.html#OneInst"><span class="hs-identifier hs-var">OneInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cir_new_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682606644"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-695"></a><span>                                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cir_mk_ev</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682606645"><span class="hs-identifier hs-var">mk_ev</span></a><span>
</span><a name="line-696"></a><span>                                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cir_what</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="ClsInst.html#BuiltinInstance"><span class="hs-identifier hs-var">BuiltinInstance</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-697"></a><span>                     </span><span class="hs-keyword">else</span><span> </span><a href="ClsInst.html#matchInstEnv"><span class="hs-identifier hs-var">matchInstEnv</span></a><span> </span><a href="#local-6989586621682606624"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682606625"><span class="hs-identifier hs-var">short_cut</span></a><span> </span><a href="#local-6989586621682606626"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621682606627"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-698"></a><span>
</span><a name="line-699"></a><span>           </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="ClsInst.html#matchInstEnv"><span class="hs-identifier hs-var">matchInstEnv</span></a><span> </span><a href="#local-6989586621682606624"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682606625"><span class="hs-identifier hs-var">short_cut</span></a><span> </span><a href="#local-6989586621682606626"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621682606627"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-700"></a></pre></body></html>