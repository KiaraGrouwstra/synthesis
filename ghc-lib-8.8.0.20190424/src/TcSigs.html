<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006-2012
(c) The GRASP Project, Glasgow University, 1992-2002

-}</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">TcSigs</span><span class="hs-special">(</span><span>
</span><a name="line-11"></a><span>       </span><span class="hs-identifier hs-type">TcSigInfo</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-12"></a><span>       </span><span class="hs-identifier hs-type">TcIdSigInfo</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcIdSigInst</span><span class="hs-special">,</span><span>
</span><a name="line-13"></a><span>       </span><span class="hs-identifier hs-type">TcPatSynInfo</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>       </span><span class="hs-identifier hs-type">TcSigFun</span><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span>       </span><span class="hs-identifier hs-var">isPartialSig</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">hasCompleteSig</span><span class="hs-special">,</span><span> </span><a href="TcSigs.html#tcIdSigName"><span class="hs-identifier hs-var">tcIdSigName</span></a><span class="hs-special">,</span><span> </span><a href="TcSigs.html#tcSigInfoName"><span class="hs-identifier hs-var">tcSigInfoName</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>       </span><a href="TcSigs.html#completeSigPolyId_maybe"><span class="hs-identifier hs-var">completeSigPolyId_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span>       </span><a href="TcSigs.html#tcTySigs"><span class="hs-identifier hs-var">tcTySigs</span></a><span class="hs-special">,</span><span> </span><a href="TcSigs.html#tcUserTypeSig"><span class="hs-identifier hs-var">tcUserTypeSig</span></a><span class="hs-special">,</span><span> </span><a href="TcSigs.html#completeSigFromId"><span class="hs-identifier hs-var">completeSigFromId</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>       </span><a href="TcSigs.html#tcInstSig"><span class="hs-identifier hs-var">tcInstSig</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span>       </span><a href="TcSigs.html#TcPragEnv"><span class="hs-identifier hs-type">TcPragEnv</span></a><span class="hs-special">,</span><span> </span><a href="TcSigs.html#emptyPragEnv"><span class="hs-identifier hs-var">emptyPragEnv</span></a><span class="hs-special">,</span><span> </span><a href="TcSigs.html#lookupPragEnv"><span class="hs-identifier hs-var">lookupPragEnv</span></a><span class="hs-special">,</span><span> </span><a href="TcSigs.html#extendPragEnv"><span class="hs-identifier hs-var">extendPragEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>       </span><a href="TcSigs.html#mkPragEnv"><span class="hs-identifier hs-var">mkPragEnv</span></a><span class="hs-special">,</span><span> </span><a href="TcSigs.html#tcSpecPrags"><span class="hs-identifier hs-var">tcSpecPrags</span></a><span class="hs-special">,</span><span> </span><a href="TcSigs.html#tcSpecWrapper"><span class="hs-identifier hs-var">tcSpecWrapper</span></a><span class="hs-special">,</span><span> </span><a href="TcSigs.html#tcImpPrags"><span class="hs-identifier hs-var">tcImpPrags</span></a><span class="hs-special">,</span><span> </span><a href="TcSigs.html#addInlinePrags"><span class="hs-identifier hs-var">addInlinePrags</span></a><span>
</span><a name="line-24"></a><span>   </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="TcHsType.html"><span class="hs-identifier">TcHsType</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcRnTypes</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="TcMType.html"><span class="hs-identifier">TcMType</span></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="TcValidity.html"><span class="hs-identifier">TcValidity</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="TcValidity.html#checkValidType"><span class="hs-identifier hs-var">checkValidType</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="TcUnify.html"><span class="hs-identifier">TcUnify</span></a><span class="hs-special">(</span><span> </span><a href="TcUnify.html#tcSkolemise"><span class="hs-identifier hs-var">tcSkolemise</span></a><span class="hs-special">,</span><span> </span><a href="TcUnify.html#unifyType"><span class="hs-identifier hs-var">unifyType</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="Inst.html"><span class="hs-identifier">Inst</span></a><span class="hs-special">(</span><span> </span><a href="Inst.html#topInstantiate"><span class="hs-identifier hs-var">topInstantiate</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="TcEnv.html"><span class="hs-identifier">TcEnv</span></a><span class="hs-special">(</span><span> </span><a href="TcEnv.html#tcLookupId"><span class="hs-identifier hs-var">tcLookupId</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcEvidence</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">HsWrapper</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;.&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkTyVarBinders</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Var</span><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">tyVarKind</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">idName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">idType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">idInlinePragma</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">setInlinePragma</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkLocalId</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkUnboundName</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Bag</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">foldrBag</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">getModule</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameEnv</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">singleton</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">orElse</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-58"></a><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-comment">{- -------------------------------------------------------------
          Note [Overview of type signatures]
----------------------------------------------------------------
Type signatures, including partial signatures, are jolly tricky,
especially on value bindings.  Here's an overview.

    f :: forall a. [a] -&gt; [a]
    g :: forall b. _ -&gt; b

    f = ...g...
    g = ...f...

* HsSyn: a signature in a binding starts off as a TypeSig, in
  type HsBinds.Sig

* When starting a mutually recursive group, like f/g above, we
  call tcTySig on each signature in the group.

* tcTySig: Sig -&gt; TcIdSigInfo
  - For a /complete/ signature, like 'f' above, tcTySig kind-checks
    the HsType, producing a Type, and wraps it in a CompleteSig, and
    extend the type environment with this polymorphic 'f'.

  - For a /partial/signature, like 'g' above, tcTySig does nothing
    Instead it just wraps the pieces in a PartialSig, to be handled
    later.

* tcInstSig: TcIdSigInfo -&gt; TcIdSigInst
  In tcMonoBinds, when looking at an individual binding, we use
  tcInstSig to instantiate the signature forall's in the signature,
  and attribute that instantiated (monomorphic) type to the
  binder.  You can see this in TcBinds.tcLhsId.

  The instantiation does the obvious thing for complete signatures,
  but for /partial/ signatures it starts from the HsSyn, so it
  has to kind-check it etc: tcHsPartialSigType.  It's convenient
  to do this at the same time as instantiation, because we can
  make the wildcards into unification variables right away, raather
  than somehow quantifying over them.  And the &quot;TcLevel&quot; of those
  unification variables is correct because we are in tcMonoBinds.


Note [Scoped tyvars]
~~~~~~~~~~~~~~~~~~~~
The -XScopedTypeVariables flag brings lexically-scoped type variables
into scope for any explicitly forall-quantified type variables:
        f :: forall a. a -&gt; a
        f x = e
Then 'a' is in scope inside 'e'.

However, we do *not* support this
  - For pattern bindings e.g
        f :: forall a. a-&gt;a
        (f,g) = e

Note [Binding scoped type variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The type variables *brought into lexical scope* by a type signature
may be a subset of the *quantified type variables* of the signatures,
for two reasons:

* With kind polymorphism a signature like
    f :: forall f a. f a -&gt; f a
  may actually give rise to
    f :: forall k. forall (f::k -&gt; *) (a:k). f a -&gt; f a
  So the sig_tvs will be [k,f,a], but only f,a are scoped.
  NB: the scoped ones are not necessarily the *inital* ones!

* Even aside from kind polymorphism, there may be more instantiated
  type variables than lexically-scoped ones.  For example:
        type T a = forall b. b -&gt; (a,b)
        f :: forall c. T c
  Here, the signature for f will have one scoped type variable, c,
  but two instantiated type variables, c' and b'.

However, all of this only applies to the renamer.  The typechecker
just puts all of them into the type environment; any lexical-scope
errors were dealt with by the renamer.

-}</span><span>
</span><a name="line-140"></a><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
             Utility functions for TcSigInfo
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-147"></a><span>
</span><a name="line-148"></a><span class="hs-identifier">tcIdSigName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcIdSigInfo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-149"></a><a name="tcIdSigName"><a href="TcSigs.html#tcIdSigName"><span class="hs-identifier">tcIdSigName</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CompleteSig</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sig_bndr</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683193948"><a href="#local-6989586621683193948"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621683193948"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-150"></a><span class="hs-identifier">tcIdSigName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PartialSig</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">psig_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683193949"><a href="#local-6989586621683193949"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683193949"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-151"></a><span>
</span><a name="line-152"></a><span class="hs-identifier">tcSigInfoName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcSigInfo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-153"></a><a name="tcSigInfoName"><a href="TcSigs.html#tcSigInfoName"><span class="hs-identifier">tcSigInfoName</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TcIdSig</span><span>     </span><a name="local-6989586621683193950"><a href="#local-6989586621683193950"><span class="hs-identifier">idsi</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSigs.html#tcIdSigName"><span class="hs-identifier hs-var">tcIdSigName</span></a><span> </span><a href="#local-6989586621683193950"><span class="hs-identifier hs-var">idsi</span></a><span>
</span><a name="line-154"></a><span class="hs-identifier">tcSigInfoName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TcPatSynSig</span><span> </span><a name="local-6989586621683193951"><a href="#local-6989586621683193951"><span class="hs-identifier">tpsi</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">patsig_name</span><span> </span><a href="#local-6989586621683193951"><span class="hs-identifier hs-var">tpsi</span></a><span>
</span><a name="line-155"></a><span>
</span><a name="line-156"></a><span class="hs-identifier">completeSigPolyId_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcSigInfo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TcId</span><span>
</span><a name="line-157"></a><a name="completeSigPolyId_maybe"><a href="TcSigs.html#completeSigPolyId_maybe"><span class="hs-identifier">completeSigPolyId_maybe</span></a></a><span> </span><a name="local-6989586621683193952"><a href="#local-6989586621683193952"><span class="hs-identifier">sig</span></a></a><span>
</span><a name="line-158"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">TcIdSig</span><span> </span><a name="local-6989586621683193953"><a href="#local-6989586621683193953"><span class="hs-identifier">sig_info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683193952"><span class="hs-identifier hs-var">sig</span></a><span>
</span><a name="line-159"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">CompleteSig</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sig_bndr</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683193954"><a href="#local-6989586621683193954"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683193953"><span class="hs-identifier hs-var">sig_info</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683193954"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-160"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span>
</span><a name="line-163"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
               Typechecking user signatures
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-168"></a><span>
</span><a name="line-169"></a><span class="hs-identifier">tcTySigs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LSig</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcId</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcSigFun</span><span class="hs-special">)</span><span>
</span><a name="line-170"></a><a name="tcTySigs"><a href="TcSigs.html#tcTySigs"><span class="hs-identifier">tcTySigs</span></a></a><span> </span><a name="local-6989586621683193955"><a href="#local-6989586621683193955"><span class="hs-identifier">hs_sigs</span></a></a><span>
</span><a name="line-171"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>   </span><span class="hs-comment">-- See Note [Fail eagerly on bad signatures]</span><span>
</span><a name="line-172"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683193956"><a href="#local-6989586621683193956"><span class="hs-identifier">ty_sigs_s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#mapAndRecoverM"><span class="hs-identifier hs-var">mapAndRecoverM</span></a><span> </span><a href="TcSigs.html#tcTySig"><span class="hs-identifier hs-var">tcTySig</span></a><span> </span><a href="#local-6989586621683193955"><span class="hs-identifier hs-var">hs_sigs</span></a><span>
</span><a name="line-173"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683193957"><a href="#local-6989586621683193957"><span class="hs-identifier">ty_sigs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-6989586621683193956"><span class="hs-identifier hs-var">ty_sigs_s</span></a><span>
</span><a name="line-174"></a><span>             </span><a name="local-6989586621683193958"><a href="#local-6989586621683193958"><span class="hs-identifier">poly_ids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><a href="TcSigs.html#completeSigPolyId_maybe"><span class="hs-identifier hs-var">completeSigPolyId_maybe</span></a><span> </span><a href="#local-6989586621683193957"><span class="hs-identifier hs-var">ty_sigs</span></a><span>
</span><a name="line-175"></a><span>                        </span><span class="hs-comment">-- The returned [TcId] are the ones for which we have</span><span>
</span><a name="line-176"></a><span>                        </span><span class="hs-comment">-- a complete type signature.</span><span>
</span><a name="line-177"></a><span>                        </span><span class="hs-comment">-- See Note [Complete and partial type signatures]</span><span>
</span><a name="line-178"></a><span>             </span><a name="local-6989586621683193959"><a href="#local-6989586621683193959"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkNameEnv</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="TcSigs.html#tcSigInfoName"><span class="hs-identifier hs-var">tcSigInfoName</span></a><span> </span><a href="#local-6989586621683193960"><span class="hs-identifier hs-var">sig</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683193960"><span class="hs-identifier hs-var">sig</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683193960"><a href="#local-6989586621683193960"><span class="hs-identifier">sig</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683193957"><span class="hs-identifier hs-var">ty_sigs</span></a><span class="hs-special">]</span><span>
</span><a name="line-179"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683193958"><span class="hs-identifier hs-var">poly_ids</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">lookupNameEnv</span><span> </span><a href="#local-6989586621683193959"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-180"></a><span>
</span><a name="line-181"></a><span class="hs-identifier">tcTySig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LSig</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcSigInfo</span><span class="hs-special">]</span><span>
</span><a name="line-182"></a><a name="tcTySig"><a href="TcSigs.html#tcTySig"><span class="hs-identifier">tcTySig</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IdSig</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683193961"><a href="#local-6989586621683193961"><span class="hs-identifier">id</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-183"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683193962"><a href="#local-6989586621683193962"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">FunSigCtxt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621683193961"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-184"></a><span>                    </span><span class="hs-comment">-- False: do not report redundant constraints</span><span>
</span><a name="line-185"></a><span>                    </span><span class="hs-comment">-- The user has no control over the signature!</span><span>
</span><a name="line-186"></a><span>             </span><a name="local-6989586621683193963"><a href="#local-6989586621683193963"><span class="hs-identifier">sig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSigs.html#completeSigFromId"><span class="hs-identifier hs-var">completeSigFromId</span></a><span> </span><a href="#local-6989586621683193962"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621683193961"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-187"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">TcIdSig</span><span> </span><a href="#local-6989586621683193963"><span class="hs-identifier hs-var">sig</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-188"></a><span>
</span><a name="line-189"></a><span class="hs-identifier">tcTySig</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683193964"><a href="#local-6989586621683193964"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TypeSig</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683193965"><a href="#local-6989586621683193965"><span class="hs-identifier">names</span></a></a><span> </span><a name="local-6989586621683193966"><a href="#local-6989586621683193966"><span class="hs-identifier">sig_ty</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-190"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683193964"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-191"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683193968"><a href="#local-6989586621683193968"><span class="hs-identifier">sigs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">sequence</span><span> </span><span class="hs-special">[</span><span> </span><a href="TcSigs.html#tcUserTypeSig"><span class="hs-identifier hs-var">tcUserTypeSig</span></a><span> </span><a href="#local-6989586621683193964"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683193966"><span class="hs-identifier hs-var">sig_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683193967"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-192"></a><span>                          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683193967"><a href="#local-6989586621683193967"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683193965"><span class="hs-identifier hs-var">names</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-193"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">TcIdSig</span><span> </span><a href="#local-6989586621683193968"><span class="hs-identifier hs-var">sigs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-194"></a><span>
</span><a name="line-195"></a><span class="hs-identifier">tcTySig</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683193969"><a href="#local-6989586621683193969"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PatSynSig</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683193970"><a href="#local-6989586621683193970"><span class="hs-identifier">names</span></a></a><span> </span><a name="local-6989586621683193971"><a href="#local-6989586621683193971"><span class="hs-identifier">sig_ty</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-196"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683193969"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-197"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683193973"><a href="#local-6989586621683193973"><span class="hs-identifier">tpsigs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">sequence</span><span> </span><span class="hs-special">[</span><span> </span><a href="TcSigs.html#tcPatSynSig"><span class="hs-identifier hs-var">tcPatSynSig</span></a><span> </span><a href="#local-6989586621683193972"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683193971"><span class="hs-identifier hs-var">sig_ty</span></a><span>
</span><a name="line-198"></a><span>                            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683193972"><a href="#local-6989586621683193972"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683193970"><span class="hs-identifier hs-var">names</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-199"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">TcPatSynSig</span><span> </span><a href="#local-6989586621683193973"><span class="hs-identifier hs-var">tpsigs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-200"></a><span>
</span><a name="line-201"></a><span class="hs-identifier">tcTySig</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-202"></a><span>
</span><a name="line-203"></a><span>
</span><a name="line-204"></a><span class="hs-identifier">tcUserTypeSig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsSigWcType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-205"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcIdSigInfo</span><span>
</span><a name="line-206"></a><span class="hs-comment">-- A function or expression type signature</span><span>
</span><a name="line-207"></a><span class="hs-comment">-- Returns a fully quantified type signature; even the wildcards</span><span>
</span><a name="line-208"></a><span class="hs-comment">-- are quantified with ordinary skolems that should be instantiated</span><span>
</span><a name="line-209"></a><span class="hs-comment">--</span><span>
</span><a name="line-210"></a><span class="hs-comment">-- The SrcSpan is what to declare as the binding site of the</span><span>
</span><a name="line-211"></a><span class="hs-comment">-- any skolems in the signature. For function signatures we</span><span>
</span><a name="line-212"></a><span class="hs-comment">-- use the whole `f :: ty' signature; for expression signatures</span><span>
</span><a name="line-213"></a><span class="hs-comment">-- just the type part.</span><span>
</span><a name="line-214"></a><span class="hs-comment">--</span><span>
</span><a name="line-215"></a><span class="hs-comment">-- Just n  =&gt; Function type signature       name :: type</span><span>
</span><a name="line-216"></a><span class="hs-comment">-- Nothing =&gt; Expression type signature   &lt;expr&gt; :: type</span><span>
</span><a name="line-217"></a><a name="tcUserTypeSig"><a href="TcSigs.html#tcUserTypeSig"><span class="hs-identifier">tcUserTypeSig</span></a></a><span> </span><a name="local-6989586621683193974"><a href="#local-6989586621683193974"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621683193975"><a href="#local-6989586621683193975"><span class="hs-identifier">hs_sig_ty</span></a></a><span> </span><a name="local-6989586621683193976"><a href="#local-6989586621683193976"><span class="hs-identifier">mb_name</span></a></a><span>
</span><a name="line-218"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TcSigs.html#isCompleteHsSig"><span class="hs-identifier hs-var">isCompleteHsSig</span></a><span> </span><a href="#local-6989586621683193975"><span class="hs-identifier hs-var">hs_sig_ty</span></a><span>
</span><a name="line-219"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683193983"><a href="#local-6989586621683193983"><span class="hs-identifier">sigma_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcHsSigWcType"><span class="hs-identifier hs-var">tcHsSigWcType</span></a><span> </span><a href="#local-6989586621683193978"><span class="hs-identifier hs-var">ctxt_F</span></a><span> </span><a href="#local-6989586621683193975"><span class="hs-identifier hs-var">hs_sig_ty</span></a><span>
</span><a name="line-220"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-221"></a><span>         </span><span class="hs-identifier hs-var">CompleteSig</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sig_bndr</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkLocalId</span><span> </span><a href="#local-6989586621683193977"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683193983"><span class="hs-identifier hs-var">sigma_ty</span></a><span>
</span><a name="line-222"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_ctxt</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683193979"><span class="hs-identifier hs-var">ctxt_T</span></a><span>
</span><a name="line-223"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_loc</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683193974"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-224"></a><span>                       </span><span class="hs-comment">-- Location of the &lt;type&gt; in   f :: &lt;type&gt;</span><span>
</span><a name="line-225"></a><span>
</span><a name="line-226"></a><span>  </span><span class="hs-comment">-- Partial sig with wildcards</span><span>
</span><a name="line-227"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-228"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PartialSig</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">psig_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683193977"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">psig_hs_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683193975"><span class="hs-identifier hs-var">hs_sig_ty</span></a><span>
</span><a name="line-229"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683193978"><span class="hs-identifier hs-var">ctxt_F</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683193974"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-230"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-231"></a><span>    </span><a name="local-6989586621683193977"><a href="#local-6989586621683193977"><span class="hs-identifier">name</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683193976"><span class="hs-identifier hs-var">mb_name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-232"></a><span>               </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683193980"><a href="#local-6989586621683193980"><span class="hs-identifier">n</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683193980"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-233"></a><span>               </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">mkUnboundName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkVarOcc</span><span> </span><span class="hs-string">&quot;&lt;expression&gt;&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-234"></a><span>    </span><a name="local-6989586621683193978"><a href="#local-6989586621683193978"><span class="hs-identifier">ctxt_F</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683193976"><span class="hs-identifier hs-var">mb_name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-235"></a><span>               </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683193981"><a href="#local-6989586621683193981"><span class="hs-identifier">n</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">FunSigCtxt</span><span> </span><a href="#local-6989586621683193981"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-236"></a><span>               </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">ExprSigCtxt</span><span>
</span><a name="line-237"></a><span>    </span><a name="local-6989586621683193979"><a href="#local-6989586621683193979"><span class="hs-identifier">ctxt_T</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683193976"><span class="hs-identifier hs-var">mb_name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-238"></a><span>               </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683193982"><a href="#local-6989586621683193982"><span class="hs-identifier">n</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">FunSigCtxt</span><span> </span><a href="#local-6989586621683193982"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-239"></a><span>               </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">ExprSigCtxt</span><span>
</span><a name="line-240"></a><span>
</span><a name="line-241"></a><span>
</span><a name="line-242"></a><span>
</span><a name="line-243"></a><span class="hs-identifier">completeSigFromId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UserTypeCtxt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcIdSigInfo</span><span>
</span><a name="line-244"></a><span class="hs-comment">-- Used for instance methods and record selectors</span><span>
</span><a name="line-245"></a><a name="completeSigFromId"><a href="TcSigs.html#completeSigFromId"><span class="hs-identifier">completeSigFromId</span></a></a><span> </span><a name="local-6989586621683193984"><a href="#local-6989586621683193984"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621683193985"><a href="#local-6989586621683193985"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-246"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CompleteSig</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sig_bndr</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683193985"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-247"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683193984"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-248"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_loc</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getSrcSpan</span><span> </span><a href="#local-6989586621683193985"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-249"></a><span>
</span><a name="line-250"></a><span class="hs-identifier">isCompleteHsSig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsSigWcType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-251"></a><span class="hs-comment">-- ^ If there are no wildcards, return a LHsSigType</span><span>
</span><a name="line-252"></a><a name="isCompleteHsSig"><a href="TcSigs.html#isCompleteHsSig"><span class="hs-identifier">isCompleteHsSig</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsWC</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hswc_ext</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683193986"><a href="#local-6989586621683193986"><span class="hs-identifier">wcs</span></a></a><span>
</span><a name="line-253"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hswc_body</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HsIB</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsib_body</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683193987"><a href="#local-6989586621683193987"><span class="hs-identifier">hs_ty</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-254"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683193986"><span class="hs-identifier hs-var">wcs</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="TcSigs.html#no_anon_wc"><span class="hs-identifier hs-var">no_anon_wc</span></a><span> </span><a href="#local-6989586621683193987"><span class="hs-identifier hs-var">hs_ty</span></a><span>
</span><a name="line-255"></a><span class="hs-identifier">isCompleteHsSig</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsWC</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsImplicitBndrs</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;isCompleteHsSig&quot;</span><span>
</span><a name="line-256"></a><span class="hs-identifier">isCompleteHsSig</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsWildCardBndrs</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;isCompleteHsSig&quot;</span><span>
</span><a name="line-257"></a><span>
</span><a name="line-258"></a><span class="hs-identifier">no_anon_wc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-259"></a><a name="no_anon_wc"><a href="TcSigs.html#no_anon_wc"><span class="hs-identifier">no_anon_wc</span></a></a><span> </span><a name="local-6989586621683193988"><a href="#local-6989586621683193988"><span class="hs-identifier">lty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683193989"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683193988"><span class="hs-identifier hs-var">lty</span></a><span>
</span><a name="line-260"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-261"></a><span>    </span><a name="local-6989586621683193989"><a href="#local-6989586621683193989"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683193991"><a href="#local-6989586621683193991"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683193991"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-262"></a><span>      </span><span class="hs-identifier hs-var">HsWildCardTy</span><span> </span><span class="hs-identifier">_</span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-263"></a><span>      </span><span class="hs-identifier hs-var">HsAppTy</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683193992"><a href="#local-6989586621683193992"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621683193993"><a href="#local-6989586621683193993"><span class="hs-identifier">ty2</span></a></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683193989"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683193992"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621683193989"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683193993"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-264"></a><span>      </span><span class="hs-identifier hs-var">HsAppKindTy</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683193994"><a href="#local-6989586621683193994"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683193995"><a href="#local-6989586621683193995"><span class="hs-identifier">ki</span></a></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683193989"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683193994"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621683193989"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683193995"><span class="hs-identifier hs-var">ki</span></a><span>
</span><a name="line-265"></a><span>      </span><span class="hs-identifier hs-var">HsFunTy</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683193996"><a href="#local-6989586621683193996"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621683193997"><a href="#local-6989586621683193997"><span class="hs-identifier">ty2</span></a></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683193989"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683193996"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621683193989"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683193997"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-266"></a><span>      </span><span class="hs-identifier hs-var">HsListTy</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683193998"><a href="#local-6989586621683193998"><span class="hs-identifier">ty</span></a></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683193989"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683193998"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-267"></a><span>      </span><span class="hs-identifier hs-var">HsTupleTy</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683193999"><a href="#local-6989586621683193999"><span class="hs-identifier">tys</span></a></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683193990"><span class="hs-identifier hs-var">gos</span></a><span> </span><a href="#local-6989586621683193999"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-268"></a><span>      </span><span class="hs-identifier hs-var">HsSumTy</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683194000"><a href="#local-6989586621683194000"><span class="hs-identifier">tys</span></a></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683193990"><span class="hs-identifier hs-var">gos</span></a><span> </span><a href="#local-6989586621683194000"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-269"></a><span>      </span><span class="hs-identifier hs-var">HsOpTy</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683194001"><a href="#local-6989586621683194001"><span class="hs-identifier">ty1</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683194002"><a href="#local-6989586621683194002"><span class="hs-identifier">ty2</span></a></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683193989"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683194001"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621683193989"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683194002"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-270"></a><span>      </span><span class="hs-identifier hs-var">HsParTy</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683194003"><a href="#local-6989586621683194003"><span class="hs-identifier">ty</span></a></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683193989"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683194003"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-271"></a><span>      </span><span class="hs-identifier hs-var">HsIParamTy</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683194004"><a href="#local-6989586621683194004"><span class="hs-identifier">ty</span></a></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683193989"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683194004"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-272"></a><span>      </span><span class="hs-identifier hs-var">HsKindSig</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683194005"><a href="#local-6989586621683194005"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683194006"><a href="#local-6989586621683194006"><span class="hs-identifier">kind</span></a></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683193989"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683194005"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621683193989"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683194006"><span class="hs-identifier hs-var">kind</span></a><span>
</span><a name="line-273"></a><span>      </span><span class="hs-identifier hs-var">HsDocTy</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683194007"><a href="#local-6989586621683194007"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-identifier">_</span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683193989"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683194007"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-274"></a><span>      </span><span class="hs-identifier hs-var">HsBangTy</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683194008"><a href="#local-6989586621683194008"><span class="hs-identifier">ty</span></a></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683193989"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683194008"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-275"></a><span>      </span><span class="hs-identifier hs-var">HsRecTy</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683194009"><a href="#local-6989586621683194009"><span class="hs-identifier">flds</span></a></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683193990"><span class="hs-identifier hs-var">gos</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cd_fld_type</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683194009"><span class="hs-identifier hs-var">flds</span></a><span>
</span><a name="line-276"></a><span>      </span><span class="hs-identifier hs-var">HsExplicitListTy</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683194010"><a href="#local-6989586621683194010"><span class="hs-identifier">tys</span></a></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683193990"><span class="hs-identifier hs-var">gos</span></a><span> </span><a href="#local-6989586621683194010"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-277"></a><span>      </span><span class="hs-identifier hs-var">HsExplicitTupleTy</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683194011"><a href="#local-6989586621683194011"><span class="hs-identifier">tys</span></a></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683193990"><span class="hs-identifier hs-var">gos</span></a><span> </span><a href="#local-6989586621683194011"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-278"></a><span>      </span><span class="hs-identifier hs-var">HsForAllTy</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hst_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683194012"><a href="#local-6989586621683194012"><span class="hs-identifier">bndrs</span></a></a><span>
</span><a name="line-279"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hst_body</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683194013"><a href="#local-6989586621683194013"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSigs.html#no_anon_wc_bndrs"><span class="hs-identifier hs-var">no_anon_wc_bndrs</span></a><span> </span><a href="#local-6989586621683194012"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-280"></a><span>                                        </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621683193989"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683194013"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-281"></a><span>      </span><span class="hs-identifier hs-var">HsQualTy</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hst_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683194014"><a href="#local-6989586621683194014"><span class="hs-identifier">ctxt</span></a></a><span>
</span><a name="line-282"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hst_body</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683194015"><a href="#local-6989586621683194015"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683193990"><span class="hs-identifier hs-var">gos</span></a><span> </span><a href="#local-6989586621683194014"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621683193989"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683194015"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-283"></a><span>      </span><span class="hs-identifier hs-var">HsSpliceTy</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSpliced</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSplicedTy</span><span> </span><a name="local-6989586621683194016"><a href="#local-6989586621683194016"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683193989"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier hs-var">noSrcSpan</span><span> </span><a href="#local-6989586621683194016"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-284"></a><span>      </span><span class="hs-identifier hs-var">HsSpliceTy</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-285"></a><span>      </span><span class="hs-identifier hs-var">HsTyLit</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-286"></a><span>      </span><span class="hs-identifier hs-var">HsTyVar</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-287"></a><span>      </span><span class="hs-identifier hs-var">HsStarTy</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-288"></a><span>      </span><span class="hs-identifier hs-var">XHsType</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>      </span><span class="hs-comment">-- Core type, which does not have any wildcard</span><span>
</span><a name="line-289"></a><span>
</span><a name="line-290"></a><span>    </span><a name="local-6989586621683193990"><a href="#local-6989586621683193990"><span class="hs-identifier">gos</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><a href="#local-6989586621683193989"><span class="hs-identifier hs-var">go</span></a><span>
</span><a name="line-291"></a><span>
</span><a name="line-292"></a><span class="hs-identifier">no_anon_wc_bndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsTyVarBndr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-293"></a><a name="no_anon_wc_bndrs"><a href="TcSigs.html#no_anon_wc_bndrs"><span class="hs-identifier">no_anon_wc_bndrs</span></a></a><span> </span><a name="local-6989586621683194017"><a href="#local-6989586621683194017"><span class="hs-identifier">ltvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683194018"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683194017"><span class="hs-identifier hs-var">ltvs</span></a><span>
</span><a name="line-294"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-295"></a><span>    </span><a name="local-6989586621683194018"><a href="#local-6989586621683194018"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">UserTyVar</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-296"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">KindedTyVar</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683194019"><a href="#local-6989586621683194019"><span class="hs-identifier">ki</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSigs.html#no_anon_wc"><span class="hs-identifier hs-var">no_anon_wc</span></a><span> </span><a href="#local-6989586621683194019"><span class="hs-identifier hs-var">ki</span></a><span>
</span><a name="line-297"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XTyVarBndr</span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;no_anon_wc_bndrs&quot;</span><span>
</span><a name="line-298"></a><span>
</span><a name="line-299"></a><span class="hs-comment">{- Note [Fail eagerly on bad signatures]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If a type signature is wrong, fail immediately:

 * the type sigs may bind type variables, so proceeding without them
   can lead to a cascade of errors

 * the type signature might be ambiguous, in which case checking
   the code against the signature will give a very similar error
   to the ambiguity error.

ToDo: this means we fall over if any type sig
is wrong (eg at the top level of the module),
which is over-conservative
-}</span><span>
</span><a name="line-314"></a><span>
</span><a name="line-315"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
        Type checking a pattern synonym signature
*                                                                      *
************************************************************************

Note [Pattern synonym signatures]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Pattern synonym signatures are surprisingly tricky (see Trac #11224 for example).
In general they look like this:

   pattern P :: forall univ_tvs. req_theta
             =&gt; forall ex_tvs. prov_theta
             =&gt; arg1 -&gt; .. -&gt; argn -&gt; res_ty

For parsing and renaming we treat the signature as an ordinary LHsSigType.

Once we get to type checking, we decompose it into its parts, in tcPatSynSig.

* Note that 'forall univ_tvs' and 'req_theta =&gt;'
        and 'forall ex_tvs'   and 'prov_theta =&gt;'
  are all optional.  We gather the pieces at the top of tcPatSynSig

* Initially the implicitly-bound tyvars (added by the renamer) include both
  universal and existential vars.

* After we kind-check the pieces and convert to Types, we do kind generalisation.

Note [solveEqualities in tcPatSynSig]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's important that we solve /all/ the equalities in a pattern
synonym signature, because we are going to zonk the signature to
a Type (not a TcType), in TcPatSyn.tc_patsyn_finish, and that
fails if there are un-filled-in coercion variables mentioned
in the type (Trac #15694).

The best thing is simply to use solveEqualities to solve all the
equalites, rather than leaving them in the ambient constraints
to be solved later.  Pattern synonyms are top-level, so there's
no problem with completely solving them.

(NB: this solveEqualities wraps newImplicitTKBndrs, which itself
does a solveLocalEqualities; so solveEqualities isn't going to
make any further progress; it'll just report any unsolved ones,
and fail, as it should.)
-}</span><span>
</span><a name="line-361"></a><span>
</span><a name="line-362"></a><span class="hs-identifier">tcPatSynSig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsSigType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcPatSynInfo</span><span>
</span><a name="line-363"></a><span class="hs-comment">-- See Note [Pattern synonym signatures]</span><span>
</span><a name="line-364"></a><span class="hs-comment">-- See Note [Recipe for checking a signature] in TcHsType</span><span>
</span><a name="line-365"></a><a name="tcPatSynSig"><a href="TcSigs.html#tcPatSynSig"><span class="hs-identifier">tcPatSynSig</span></a></a><span> </span><a name="local-6989586621683194020"><a href="#local-6989586621683194020"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621683194021"><a href="#local-6989586621683194021"><span class="hs-identifier">sig_ty</span></a></a><span>
</span><a name="line-366"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">HsIB</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsib_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683194031"><a href="#local-6989586621683194031"><span class="hs-identifier">implicit_hs_tvs</span></a></a><span>
</span><a name="line-367"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsib_body</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683194032"><a href="#local-6989586621683194032"><span class="hs-identifier">hs_ty</span></a></a><span> </span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683194021"><span class="hs-identifier hs-var">sig_ty</span></a><span>
</span><a name="line-368"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683194033"><a href="#local-6989586621683194033"><span class="hs-identifier">univ_hs_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683194034"><a href="#local-6989586621683194034"><span class="hs-identifier">hs_req</span></a></a><span class="hs-special">,</span><span>  </span><a name="local-6989586621683194035"><a href="#local-6989586621683194035"><span class="hs-identifier">hs_ty1</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">splitLHsSigmaTy</span><span> </span><a href="#local-6989586621683194032"><span class="hs-identifier hs-var">hs_ty</span></a><span>
</span><a name="line-369"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683194036"><a href="#local-6989586621683194036"><span class="hs-identifier">ex_hs_tvs</span></a></a><span class="hs-special">,</span><span>   </span><a name="local-6989586621683194037"><a href="#local-6989586621683194037"><span class="hs-identifier">hs_prov</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683194038"><a href="#local-6989586621683194038"><span class="hs-identifier">hs_body_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">splitLHsSigmaTy</span><span> </span><a href="#local-6989586621683194035"><span class="hs-identifier hs-var">hs_ty1</span></a><span>
</span><a name="line-370"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>  </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcPatSynSig 1&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683194021"><span class="hs-identifier hs-var">sig_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-371"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683194042"><a href="#local-6989586621683194042"><span class="hs-identifier">implicit_tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683194043"><a href="#local-6989586621683194043"><span class="hs-identifier">univ_tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683194044"><a href="#local-6989586621683194044"><span class="hs-identifier">ex_tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683194045"><a href="#local-6989586621683194045"><span class="hs-identifier">req</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683194046"><a href="#local-6989586621683194046"><span class="hs-identifier">prov</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683194047"><a href="#local-6989586621683194047"><span class="hs-identifier">body_ty</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-372"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#pushTcLevelM_"><span class="hs-identifier hs-var">pushTcLevelM_</span></a><span>   </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-373"></a><span>              </span><a href="TcSimplify.html#solveEqualities"><span class="hs-identifier hs-var">solveEqualities</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-comment">-- See Note [solveEqualities in tcPatSynSig]</span><span>
</span><a name="line-374"></a><span>              </span><a href="TcHsType.html#bindImplicitTKBndrs_Skol"><span class="hs-identifier hs-var">bindImplicitTKBndrs_Skol</span></a><span> </span><a href="#local-6989586621683194031"><span class="hs-identifier hs-var">implicit_hs_tvs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-375"></a><span>              </span><a href="TcHsType.html#bindExplicitTKBndrs_Skol"><span class="hs-identifier hs-var">bindExplicitTKBndrs_Skol</span></a><span> </span><a href="#local-6989586621683194033"><span class="hs-identifier hs-var">univ_hs_tvs</span></a><span>     </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-376"></a><span>              </span><a href="TcHsType.html#bindExplicitTKBndrs_Skol"><span class="hs-identifier hs-var">bindExplicitTKBndrs_Skol</span></a><span> </span><a href="#local-6989586621683194036"><span class="hs-identifier hs-var">ex_hs_tvs</span></a><span>       </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-377"></a><span>              </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683194039"><a href="#local-6989586621683194039"><span class="hs-identifier">req</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcHsContext"><span class="hs-identifier hs-var">tcHsContext</span></a><span> </span><a href="#local-6989586621683194034"><span class="hs-identifier hs-var">hs_req</span></a><span>
</span><a name="line-378"></a><span>                 </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683194040"><a href="#local-6989586621683194040"><span class="hs-identifier">prov</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcHsContext"><span class="hs-identifier hs-var">tcHsContext</span></a><span> </span><a href="#local-6989586621683194037"><span class="hs-identifier hs-var">hs_prov</span></a><span>
</span><a name="line-379"></a><span>                 </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683194041"><a href="#local-6989586621683194041"><span class="hs-identifier">body_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcHsOpenType"><span class="hs-identifier hs-var">tcHsOpenType</span></a><span> </span><a href="#local-6989586621683194038"><span class="hs-identifier hs-var">hs_body_ty</span></a><span>
</span><a name="line-380"></a><span>                     </span><span class="hs-comment">-- A (literal) pattern can be unlifted;</span><span>
</span><a name="line-381"></a><span>                     </span><span class="hs-comment">-- e.g. pattern Zero &lt;- 0#   (Trac #12094)</span><span>
</span><a name="line-382"></a><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683194039"><span class="hs-identifier hs-var">req</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683194040"><span class="hs-identifier hs-var">prov</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683194041"><span class="hs-identifier hs-var">body_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-383"></a><span>
</span><a name="line-384"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683194048"><a href="#local-6989586621683194048"><span class="hs-identifier">ungen_patsyn_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683194023"><span class="hs-identifier hs-var">build_patsyn_type</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621683194042"><span class="hs-identifier hs-var">implicit_tvs</span></a><span> </span><a href="#local-6989586621683194043"><span class="hs-identifier hs-var">univ_tvs</span></a><span> </span><a href="#local-6989586621683194045"><span class="hs-identifier hs-var">req</span></a><span>
</span><a name="line-385"></a><span>                                                 </span><a href="#local-6989586621683194044"><span class="hs-identifier hs-var">ex_tvs</span></a><span> </span><a href="#local-6989586621683194046"><span class="hs-identifier hs-var">prov</span></a><span> </span><a href="#local-6989586621683194047"><span class="hs-identifier hs-var">body_ty</span></a><span>
</span><a name="line-386"></a><span>
</span><a name="line-387"></a><span>       </span><span class="hs-comment">-- Kind generalisation</span><span>
</span><a name="line-388"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683194049"><a href="#local-6989586621683194049"><span class="hs-identifier">kvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#kindGeneralize"><span class="hs-identifier hs-var">kindGeneralize</span></a><span> </span><a href="#local-6989586621683194048"><span class="hs-identifier hs-var">ungen_patsyn_ty</span></a><span>
</span><a name="line-389"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcPatSynSig&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683194048"><span class="hs-identifier hs-var">ungen_patsyn_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-390"></a><span>
</span><a name="line-391"></a><span>       </span><span class="hs-comment">-- These are /signatures/ so we zonk to squeeze out any kind</span><span>
</span><a name="line-392"></a><span>       </span><span class="hs-comment">-- unification variables.  Do this after kindGeneralize which may</span><span>
</span><a name="line-393"></a><span>       </span><span class="hs-comment">-- default kind variables to *.</span><span>
</span><a name="line-394"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683194050"><a href="#local-6989586621683194050"><span class="hs-identifier">implicit_tvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#zonkAndScopedSort"><span class="hs-identifier hs-var">zonkAndScopedSort</span></a><span> </span><a href="#local-6989586621683194042"><span class="hs-identifier hs-var">implicit_tvs</span></a><span>
</span><a name="line-395"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683194051"><a href="#local-6989586621683194051"><span class="hs-identifier">univ_tvs</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="TcMType.html#zonkTyCoVarKind"><span class="hs-identifier hs-var">zonkTyCoVarKind</span></a><span> </span><a href="#local-6989586621683194043"><span class="hs-identifier hs-var">univ_tvs</span></a><span>
</span><a name="line-396"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683194052"><a href="#local-6989586621683194052"><span class="hs-identifier">ex_tvs</span></a></a><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="TcMType.html#zonkTyCoVarKind"><span class="hs-identifier hs-var">zonkTyCoVarKind</span></a><span> </span><a href="#local-6989586621683194044"><span class="hs-identifier hs-var">ex_tvs</span></a><span>
</span><a name="line-397"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683194053"><a href="#local-6989586621683194053"><span class="hs-identifier">req</span></a></a><span>          </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcTypes"><span class="hs-identifier hs-var">zonkTcTypes</span></a><span> </span><a href="#local-6989586621683194045"><span class="hs-identifier hs-var">req</span></a><span>
</span><a name="line-398"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683194054"><a href="#local-6989586621683194054"><span class="hs-identifier">prov</span></a></a><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcTypes"><span class="hs-identifier hs-var">zonkTcTypes</span></a><span> </span><a href="#local-6989586621683194046"><span class="hs-identifier hs-var">prov</span></a><span>
</span><a name="line-399"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683194055"><a href="#local-6989586621683194055"><span class="hs-identifier">body_ty</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span>  </span><a href="#local-6989586621683194047"><span class="hs-identifier hs-var">body_ty</span></a><span>
</span><a name="line-400"></a><span>
</span><a name="line-401"></a><span>       </span><span class="hs-comment">-- Skolems have TcLevels too, though they're used only for debugging.</span><span>
</span><a name="line-402"></a><span>       </span><span class="hs-comment">-- If you don't do this, the debugging checks fail in TcPatSyn.</span><span>
</span><a name="line-403"></a><span>       </span><span class="hs-comment">-- Test case: patsyn/should_compile/T13441</span><span>
</span><a name="line-404"></a><span class="hs-comment">{-
       ; tclvl &lt;- getTcLevel
       ; let env0                  = mkEmptyTCvSubst $ mkInScopeSet $ mkVarSet kvs
             (env1, implicit_tvs') = promoteSkolemsX tclvl env0 implicit_tvs
             (env2, univ_tvs')     = promoteSkolemsX tclvl env1 univ_tvs
             (env3, ex_tvs')       = promoteSkolemsX tclvl env2 ex_tvs
             req'                  = substTys env3 req
             prov'                 = substTys env3 prov
             body_ty'              = substTy  env3 body_ty
-}</span><span>
</span><a name="line-414"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683194056"><a href="#local-6989586621683194056"><span class="hs-identifier">implicit_tvs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683194050"><span class="hs-identifier hs-var">implicit_tvs</span></a><span>
</span><a name="line-415"></a><span>            </span><a name="local-6989586621683194057"><a href="#local-6989586621683194057"><span class="hs-identifier">univ_tvs'</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683194051"><span class="hs-identifier hs-var">univ_tvs</span></a><span>
</span><a name="line-416"></a><span>            </span><a name="local-6989586621683194058"><a href="#local-6989586621683194058"><span class="hs-identifier">ex_tvs'</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683194052"><span class="hs-identifier hs-var">ex_tvs</span></a><span>
</span><a name="line-417"></a><span>            </span><a name="local-6989586621683194059"><a href="#local-6989586621683194059"><span class="hs-identifier">req'</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683194053"><span class="hs-identifier hs-var">req</span></a><span>
</span><a name="line-418"></a><span>            </span><a name="local-6989586621683194060"><a href="#local-6989586621683194060"><span class="hs-identifier">prov'</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683194054"><span class="hs-identifier hs-var">prov</span></a><span>
</span><a name="line-419"></a><span>            </span><a name="local-6989586621683194061"><a href="#local-6989586621683194061"><span class="hs-identifier">body_ty'</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683194055"><span class="hs-identifier hs-var">body_ty</span></a><span>
</span><a name="line-420"></a><span>
</span><a name="line-421"></a><span>       </span><span class="hs-comment">-- Now do validity checking</span><span>
</span><a name="line-422"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#checkValidType"><span class="hs-identifier hs-var">checkValidType</span></a><span> </span><a href="#local-6989586621683194022"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-423"></a><span>         </span><a href="#local-6989586621683194023"><span class="hs-identifier hs-var">build_patsyn_type</span></a><span> </span><a href="#local-6989586621683194049"><span class="hs-identifier hs-var">kvs</span></a><span> </span><a href="#local-6989586621683194056"><span class="hs-identifier hs-var">implicit_tvs'</span></a><span> </span><a href="#local-6989586621683194057"><span class="hs-identifier hs-var">univ_tvs'</span></a><span> </span><a href="#local-6989586621683194059"><span class="hs-identifier hs-var">req'</span></a><span> </span><a href="#local-6989586621683194058"><span class="hs-identifier hs-var">ex_tvs'</span></a><span> </span><a href="#local-6989586621683194060"><span class="hs-identifier hs-var">prov'</span></a><span> </span><a href="#local-6989586621683194061"><span class="hs-identifier hs-var">body_ty'</span></a><span>
</span><a name="line-424"></a><span>
</span><a name="line-425"></a><span>       </span><span class="hs-comment">-- arguments become the types of binders. We thus cannot allow</span><span>
</span><a name="line-426"></a><span>       </span><span class="hs-comment">-- levity polymorphism here</span><span>
</span><a name="line-427"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683194062"><a href="#local-6989586621683194062"><span class="hs-identifier">arg_tys</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitFunTys</span><span> </span><a href="#local-6989586621683194061"><span class="hs-identifier hs-var">body_ty'</span></a><span>
</span><a name="line-428"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="TcMType.html#checkForLevPoly"><span class="hs-identifier hs-var">checkForLevPoly</span></a><span> </span><span class="hs-identifier hs-var">empty</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683194062"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-429"></a><span>
</span><a name="line-430"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcTySig }&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-431"></a><span>         </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;implicit_tvs&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="TcSigs.html#ppr_tvs"><span class="hs-identifier hs-var">ppr_tvs</span></a><span> </span><a href="#local-6989586621683194056"><span class="hs-identifier hs-var">implicit_tvs'</span></a><span>
</span><a name="line-432"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;kvs&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="TcSigs.html#ppr_tvs"><span class="hs-identifier hs-var">ppr_tvs</span></a><span> </span><a href="#local-6989586621683194049"><span class="hs-identifier hs-var">kvs</span></a><span>
</span><a name="line-433"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;univ_tvs&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="TcSigs.html#ppr_tvs"><span class="hs-identifier hs-var">ppr_tvs</span></a><span> </span><a href="#local-6989586621683194057"><span class="hs-identifier hs-var">univ_tvs'</span></a><span>
</span><a name="line-434"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;req&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683194059"><span class="hs-identifier hs-var">req'</span></a><span>
</span><a name="line-435"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;ex_tvs&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="TcSigs.html#ppr_tvs"><span class="hs-identifier hs-var">ppr_tvs</span></a><span> </span><a href="#local-6989586621683194058"><span class="hs-identifier hs-var">ex_tvs'</span></a><span>
</span><a name="line-436"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;prov&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683194060"><span class="hs-identifier hs-var">prov'</span></a><span>
</span><a name="line-437"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;body_ty&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683194061"><span class="hs-identifier hs-var">body_ty'</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-438"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TPSI</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">patsig_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683194020"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-439"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">patsig_implicit_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyVarBinders</span><span> </span><span class="hs-identifier hs-var">Inferred</span><span>  </span><a href="#local-6989586621683194049"><span class="hs-identifier hs-var">kvs</span></a><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-440"></a><span>                                                </span><span class="hs-identifier hs-var">mkTyVarBinders</span><span> </span><span class="hs-identifier hs-var">Specified</span><span> </span><a href="#local-6989586621683194056"><span class="hs-identifier hs-var">implicit_tvs'</span></a><span>
</span><a name="line-441"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">patsig_univ_bndrs</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683194057"><span class="hs-identifier hs-var">univ_tvs'</span></a><span>
</span><a name="line-442"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">patsig_req</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683194059"><span class="hs-identifier hs-var">req'</span></a><span>
</span><a name="line-443"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">patsig_ex_bndrs</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683194058"><span class="hs-identifier hs-var">ex_tvs'</span></a><span>
</span><a name="line-444"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">patsig_prov</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683194060"><span class="hs-identifier hs-var">prov'</span></a><span>
</span><a name="line-445"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">patsig_body_ty</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683194061"><span class="hs-identifier hs-var">body_ty'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-446"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-447"></a><span>    </span><a name="local-6989586621683194022"><a href="#local-6989586621683194022"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">PatSynCtxt</span><span> </span><a href="#local-6989586621683194020"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-448"></a><span>
</span><a name="line-449"></a><span>    </span><a name="local-6989586621683194023"><a href="#local-6989586621683194023"><span class="hs-identifier">build_patsyn_type</span></a></a><span> </span><a name="local-6989586621683194024"><a href="#local-6989586621683194024"><span class="hs-identifier">kvs</span></a></a><span> </span><a name="local-6989586621683194025"><a href="#local-6989586621683194025"><span class="hs-identifier">imp</span></a></a><span> </span><a name="local-6989586621683194026"><a href="#local-6989586621683194026"><span class="hs-identifier">univ</span></a></a><span> </span><a name="local-6989586621683194027"><a href="#local-6989586621683194027"><span class="hs-identifier">req</span></a></a><span> </span><a name="local-6989586621683194028"><a href="#local-6989586621683194028"><span class="hs-identifier">ex</span></a></a><span> </span><a name="local-6989586621683194029"><a href="#local-6989586621683194029"><span class="hs-identifier">prov</span></a></a><span> </span><a name="local-6989586621683194030"><a href="#local-6989586621683194030"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-450"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkInvForAllTys</span><span> </span><a href="#local-6989586621683194024"><span class="hs-identifier hs-var">kvs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-451"></a><span>        </span><span class="hs-identifier hs-var">mkSpecForAllTys</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683194025"><span class="hs-identifier hs-var">imp</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683194026"><span class="hs-identifier hs-var">univ</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-452"></a><span>        </span><span class="hs-identifier hs-var">mkFunTys</span><span> </span><a href="#local-6989586621683194027"><span class="hs-identifier hs-var">req</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-453"></a><span>        </span><span class="hs-identifier hs-var">mkSpecForAllTys</span><span> </span><a href="#local-6989586621683194028"><span class="hs-identifier hs-var">ex</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-454"></a><span>        </span><span class="hs-identifier hs-var">mkFunTys</span><span> </span><a href="#local-6989586621683194029"><span class="hs-identifier hs-var">prov</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-455"></a><span>        </span><a href="#local-6989586621683194030"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-456"></a><span class="hs-identifier">tcPatSynSig</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsImplicitBndrs</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcPatSynSig&quot;</span><span>
</span><a name="line-457"></a><span>
</span><a name="line-458"></a><span class="hs-identifier">ppr_tvs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-459"></a><a name="ppr_tvs"><a href="TcSigs.html#ppr_tvs"><span class="hs-identifier">ppr_tvs</span></a></a><span> </span><a name="local-6989586621683194063"><a href="#local-6989586621683194063"><span class="hs-identifier">tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">braces</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683194064"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyVarKind</span><span> </span><a href="#local-6989586621683194064"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-460"></a><span>                           </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683194064"><a href="#local-6989586621683194064"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683194063"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-461"></a><span>
</span><a name="line-462"></a><span>
</span><a name="line-463"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
               Instantiating user signatures
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-468"></a><span>
</span><a name="line-469"></a><span>
</span><a name="line-470"></a><span class="hs-identifier">tcInstSig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcIdSigInfo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcIdSigInst</span><span>
</span><a name="line-471"></a><span class="hs-comment">-- Instantiate a type signature; only used with plan InferGen</span><span>
</span><a name="line-472"></a><a name="tcInstSig"><a href="TcSigs.html#tcInstSig"><span class="hs-identifier">tcInstSig</span></a></a><span> </span><a name="local-6989586621683194065"><a href="#local-6989586621683194065"><span class="hs-identifier">sig</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">CompleteSig</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sig_bndr</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683194066"><a href="#local-6989586621683194066"><span class="hs-identifier">poly_id</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683194067"><a href="#local-6989586621683194067"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-473"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683194067"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>  </span><span class="hs-comment">-- Set the binding site of the tyvars</span><span>
</span><a name="line-474"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683194068"><a href="#local-6989586621683194068"><span class="hs-identifier">tv_prs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683194069"><a href="#local-6989586621683194069"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683194070"><a href="#local-6989586621683194070"><span class="hs-identifier">tau</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#tcInstType"><span class="hs-identifier hs-var">tcInstType</span></a><span> </span><a href="TcMType.html#newMetaTyVarTyVars"><span class="hs-identifier hs-var">newMetaTyVarTyVars</span></a><span> </span><a href="#local-6989586621683194066"><span class="hs-identifier hs-var">poly_id</span></a><span>
</span><a name="line-475"></a><span>              </span><span class="hs-comment">-- See Note [Pattern bindings and complete signatures]</span><span>
</span><a name="line-476"></a><span>
</span><a name="line-477"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TISI</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sig_inst_sig</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683194065"><span class="hs-identifier hs-var">sig</span></a><span>
</span><a name="line-478"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_inst_skols</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683194068"><span class="hs-identifier hs-var">tv_prs</span></a><span>
</span><a name="line-479"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_inst_wcs</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-480"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_inst_wcx</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-481"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_inst_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683194069"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-482"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_inst_tau</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683194070"><span class="hs-identifier hs-var">tau</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-483"></a><span>
</span><a name="line-484"></a><span class="hs-identifier">tcInstSig</span><span> </span><a name="local-6989586621683194071"><a href="#local-6989586621683194071"><span class="hs-identifier">hs_sig</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">PartialSig</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">psig_hs_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683194072"><a href="#local-6989586621683194072"><span class="hs-identifier">hs_ty</span></a></a><span>
</span><a name="line-485"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683194073"><a href="#local-6989586621683194073"><span class="hs-identifier">ctxt</span></a></a><span>
</span><a name="line-486"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683194074"><a href="#local-6989586621683194074"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-487"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683194074"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>  </span><span class="hs-comment">-- Set the binding site of the tyvars</span><span>
</span><a name="line-488"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Staring partial sig {&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683194071"><span class="hs-identifier hs-var">hs_sig</span></a><span class="hs-special">)</span><span>
</span><a name="line-489"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683194075"><a href="#local-6989586621683194075"><span class="hs-identifier">wcs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683194076"><a href="#local-6989586621683194076"><span class="hs-identifier">wcx</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683194077"><a href="#local-6989586621683194077"><span class="hs-identifier">tv_names</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683194078"><a href="#local-6989586621683194078"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683194079"><a href="#local-6989586621683194079"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683194080"><a href="#local-6989586621683194080"><span class="hs-identifier">tau</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcHsPartialSigType"><span class="hs-identifier hs-var">tcHsPartialSigType</span></a><span> </span><a href="#local-6989586621683194073"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621683194072"><span class="hs-identifier hs-var">hs_ty</span></a><span>
</span><a name="line-490"></a><span>
</span><a name="line-491"></a><span>        </span><span class="hs-comment">-- Clone the quantified tyvars</span><span>
</span><a name="line-492"></a><span>        </span><span class="hs-comment">-- Reason: we might have    f, g :: forall a. a -&gt; _ -&gt; a</span><span>
</span><a name="line-493"></a><span>        </span><span class="hs-comment">--         and we want it to behave exactly as if there were</span><span>
</span><a name="line-494"></a><span>        </span><span class="hs-comment">--         two separate signatures.  Cloning here seems like</span><span>
</span><a name="line-495"></a><span>        </span><span class="hs-comment">--         the easiest way to do so, and is very similar to</span><span>
</span><a name="line-496"></a><span>        </span><span class="hs-comment">--         the tcInstType in the CompleteSig case</span><span>
</span><a name="line-497"></a><span>        </span><span class="hs-comment">-- See Trac #14643</span><span>
</span><a name="line-498"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683194081"><a href="#local-6989586621683194081"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683194082"><a href="#local-6989586621683194082"><span class="hs-identifier">tvs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newMetaTyVarTyVars"><span class="hs-identifier hs-var">newMetaTyVarTyVars</span></a><span> </span><a href="#local-6989586621683194078"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-499"></a><span>                         </span><span class="hs-comment">-- Why newMetaTyVarTyVars?  See TcBinds</span><span>
</span><a name="line-500"></a><span>                         </span><span class="hs-comment">-- Note [Quantified variables in partial type signatures]</span><span>
</span><a name="line-501"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683194083"><a href="#local-6989586621683194083"><span class="hs-identifier">tv_prs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683194077"><span class="hs-identifier hs-var">tv_names</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683194082"><span class="hs-identifier hs-var">tvs'</span></a><span>
</span><a name="line-502"></a><span>             </span><a name="local-6989586621683194084"><a href="#local-6989586621683194084"><span class="hs-identifier">inst_sig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TISI</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sig_inst_sig</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683194071"><span class="hs-identifier hs-var">hs_sig</span></a><span>
</span><a name="line-503"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_inst_skols</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683194083"><span class="hs-identifier hs-var">tv_prs</span></a><span>
</span><a name="line-504"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_inst_wcs</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683194075"><span class="hs-identifier hs-var">wcs</span></a><span>
</span><a name="line-505"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_inst_wcx</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683194076"><span class="hs-identifier hs-var">wcx</span></a><span>
</span><a name="line-506"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_inst_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTys</span><span> </span><a href="#local-6989586621683194081"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621683194079"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-507"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sig_inst_tau</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTy</span><span>  </span><a href="#local-6989586621683194081"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621683194080"><span class="hs-identifier hs-var">tau</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-508"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;End partial sig }&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683194084"><span class="hs-identifier hs-var">inst_sig</span></a><span class="hs-special">)</span><span>
</span><a name="line-509"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683194084"><span class="hs-identifier hs-var">inst_sig</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-510"></a><span>
</span><a name="line-511"></a><span>
</span><a name="line-512"></a><span class="hs-comment">{- Note [Pattern bindings and complete signatures]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
      data T a = MkT a a
      f :: forall a. a-&gt;a
      g :: forall b. b-&gt;b
      MkT f g = MkT (\x-&gt;x) (\y-&gt;y)
Here we'll infer a type from the pattern of 'T a', but if we feed in
the signature types for f and g, we'll end up unifying 'a' and 'b'

So we instantiate f and g's signature with TyVarTv skolems
(newMetaTyVarTyVars) that can unify with each other.  If too much
unification takes place, we'll find out when we do the final
impedance-matching check in TcBinds.mkExport

See Note [Signature skolems] in TcType

None of this applies to a function binding with a complete
signature, which doesn't use tcInstSig.  See TcBinds.tcPolyCheck.
-}</span><span>
</span><a name="line-532"></a><span>
</span><a name="line-533"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
                   Pragmas and PragEnv
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-538"></a><span>
</span><a name="line-539"></a><span class="hs-keyword">type</span><span> </span><a name="TcPragEnv"><a href="TcSigs.html#TcPragEnv"><span class="hs-identifier">TcPragEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">NameEnv</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LSig</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>
</span><a name="line-540"></a><span>
</span><a name="line-541"></a><span class="hs-identifier">emptyPragEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSigs.html#TcPragEnv"><span class="hs-identifier hs-type">TcPragEnv</span></a><span>
</span><a name="line-542"></a><a name="emptyPragEnv"><a href="TcSigs.html#emptyPragEnv"><span class="hs-identifier">emptyPragEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyNameEnv</span><span>
</span><a name="line-543"></a><span>
</span><a name="line-544"></a><span class="hs-identifier">lookupPragEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSigs.html#TcPragEnv"><span class="hs-identifier hs-type">TcPragEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LSig</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>
</span><a name="line-545"></a><a name="lookupPragEnv"><a href="TcSigs.html#lookupPragEnv"><span class="hs-identifier">lookupPragEnv</span></a></a><span> </span><a name="local-6989586621683194085"><a href="#local-6989586621683194085"><span class="hs-identifier">prag_fn</span></a></a><span> </span><a name="local-6989586621683194086"><a href="#local-6989586621683194086"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupNameEnv</span><span> </span><a href="#local-6989586621683194085"><span class="hs-identifier hs-var">prag_fn</span></a><span> </span><a href="#local-6989586621683194086"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">orElse</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-546"></a><span>
</span><a name="line-547"></a><span class="hs-identifier">extendPragEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSigs.html#TcPragEnv"><span class="hs-identifier hs-type">TcPragEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">LSig</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSigs.html#TcPragEnv"><span class="hs-identifier hs-type">TcPragEnv</span></a><span>
</span><a name="line-548"></a><a name="extendPragEnv"><a href="TcSigs.html#extendPragEnv"><span class="hs-identifier">extendPragEnv</span></a></a><span> </span><a name="local-6989586621683194087"><a href="#local-6989586621683194087"><span class="hs-identifier">prag_fn</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683194088"><a href="#local-6989586621683194088"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683194089"><a href="#local-6989586621683194089"><span class="hs-identifier">sig</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendNameEnv_Acc</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">singleton</span><span> </span><a href="#local-6989586621683194087"><span class="hs-identifier hs-var">prag_fn</span></a><span> </span><a href="#local-6989586621683194088"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621683194089"><span class="hs-identifier hs-var">sig</span></a><span>
</span><a name="line-549"></a><span>
</span><a name="line-550"></a><span class="hs-comment">---------------</span><span>
</span><a name="line-551"></a><span class="hs-identifier">mkPragEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LSig</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSigs.html#TcPragEnv"><span class="hs-identifier hs-type">TcPragEnv</span></a><span>
</span><a name="line-552"></a><a name="mkPragEnv"><a href="TcSigs.html#mkPragEnv"><span class="hs-identifier">mkPragEnv</span></a></a><span> </span><a name="local-6989586621683194090"><a href="#local-6989586621683194090"><span class="hs-identifier">sigs</span></a></a><span> </span><a name="local-6989586621683194091"><a href="#local-6989586621683194091"><span class="hs-identifier">binds</span></a></a><span>
</span><a name="line-553"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="TcSigs.html#extendPragEnv"><span class="hs-identifier hs-var">extendPragEnv</span></a><span> </span><span class="hs-identifier hs-var">emptyNameEnv</span><span> </span><a href="#local-6989586621683194092"><span class="hs-identifier hs-var">prs</span></a><span>
</span><a name="line-554"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-555"></a><span>    </span><a name="local-6989586621683194092"><a href="#local-6989586621683194092"><span class="hs-identifier">prs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><a href="#local-6989586621683194093"><span class="hs-identifier hs-var">get_sig</span></a><span> </span><a href="#local-6989586621683194090"><span class="hs-identifier hs-var">sigs</span></a><span>
</span><a name="line-556"></a><span>
</span><a name="line-557"></a><span>    </span><span class="hs-identifier">get_sig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LSig</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">LSig</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span>
</span><a name="line-558"></a><span>    </span><a name="local-6989586621683194093"><a href="#local-6989586621683194093"><span class="hs-identifier">get_sig</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683194096"><a href="#local-6989586621683194096"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SpecSig</span><span> </span><a name="local-6989586621683194097"><a href="#local-6989586621683194097"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683194098"><a href="#local-6989586621683194098"><span class="hs-identifier">lnm</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683194099"><a href="#local-6989586621683194099"><span class="hs-identifier">nm</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683194100"><a href="#local-6989586621683194100"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683194101"><a href="#local-6989586621683194101"><span class="hs-identifier">inl</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-559"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683194099"><span class="hs-identifier hs-var">nm</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683194096"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">SpecSig</span><span>   </span><a href="#local-6989586621683194097"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683194098"><span class="hs-identifier hs-var">lnm</span></a><span> </span><a href="#local-6989586621683194100"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683194094"><span class="hs-identifier hs-var">add_arity</span></a><span> </span><a href="#local-6989586621683194099"><span class="hs-identifier hs-var">nm</span></a><span> </span><a href="#local-6989586621683194101"><span class="hs-identifier hs-var">inl</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-560"></a><span>    </span><span class="hs-identifier">get_sig</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683194102"><a href="#local-6989586621683194102"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">InlineSig</span><span> </span><a name="local-6989586621683194103"><a href="#local-6989586621683194103"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683194104"><a href="#local-6989586621683194104"><span class="hs-identifier">lnm</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683194105"><a href="#local-6989586621683194105"><span class="hs-identifier">nm</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683194106"><a href="#local-6989586621683194106"><span class="hs-identifier">inl</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-561"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683194105"><span class="hs-identifier hs-var">nm</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683194102"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">InlineSig</span><span> </span><a href="#local-6989586621683194103"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683194104"><span class="hs-identifier hs-var">lnm</span></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621683194094"><span class="hs-identifier hs-var">add_arity</span></a><span> </span><a href="#local-6989586621683194105"><span class="hs-identifier hs-var">nm</span></a><span> </span><a href="#local-6989586621683194106"><span class="hs-identifier hs-var">inl</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-562"></a><span>    </span><span class="hs-identifier">get_sig</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683194107"><a href="#local-6989586621683194107"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SCCFunSig</span><span> </span><a name="local-6989586621683194108"><a href="#local-6989586621683194108"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683194109"><a href="#local-6989586621683194109"><span class="hs-identifier">st</span></a></a><span> </span><a name="local-6989586621683194110"><a href="#local-6989586621683194110"><span class="hs-identifier">lnm</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683194111"><a href="#local-6989586621683194111"><span class="hs-identifier">nm</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683194112"><a href="#local-6989586621683194112"><span class="hs-identifier">str</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-563"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683194111"><span class="hs-identifier hs-var">nm</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683194107"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">SCCFunSig</span><span> </span><a href="#local-6989586621683194108"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683194109"><span class="hs-identifier hs-var">st</span></a><span> </span><a href="#local-6989586621683194110"><span class="hs-identifier hs-var">lnm</span></a><span> </span><a href="#local-6989586621683194112"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">)</span><span>
</span><a name="line-564"></a><span>    </span><span class="hs-identifier">get_sig</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-565"></a><span>
</span><a name="line-566"></a><span>    </span><a name="local-6989586621683194094"><a href="#local-6989586621683194094"><span class="hs-identifier">add_arity</span></a></a><span> </span><a name="local-6989586621683194113"><a href="#local-6989586621683194113"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621683194114"><a href="#local-6989586621683194114"><span class="hs-identifier">inl_prag</span></a></a><span>   </span><span class="hs-comment">-- Adjust inl_sat field to match visible arity of function</span><span>
</span><a name="line-567"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Inline</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">inl_inline</span><span> </span><a href="#local-6989586621683194114"><span class="hs-identifier hs-var">inl_prag</span></a><span>
</span><a name="line-568"></a><span>        </span><span class="hs-comment">-- add arity only for real INLINE pragmas, not INLINABLE</span><span>
</span><a name="line-569"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupNameEnv</span><span> </span><a href="#local-6989586621683194095"><span class="hs-identifier hs-var">ar_env</span></a><span> </span><a href="#local-6989586621683194113"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-570"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683194115"><a href="#local-6989586621683194115"><span class="hs-identifier">ar</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683194114"><span class="hs-identifier hs-var">inl_prag</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inl_sat</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683194115"><span class="hs-identifier hs-var">ar</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-571"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">WARN</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;mkPragEnv no arity&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">n</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-572"></a><span>                     </span><span class="hs-comment">-- There really should be a binding for every INLINE pragma</span><span>
</span><a name="line-573"></a><span>                     </span><a href="#local-6989586621683194114"><span class="hs-identifier hs-var">inl_prag</span></a><span>
</span><a name="line-574"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-575"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683194114"><span class="hs-identifier hs-var">inl_prag</span></a><span>
</span><a name="line-576"></a><span>
</span><a name="line-577"></a><span>    </span><span class="hs-comment">-- ar_env maps a local to the arity of its definition</span><span>
</span><a name="line-578"></a><span>    </span><span class="hs-identifier">ar_env</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NameEnv</span><span> </span><span class="hs-identifier hs-type">Arity</span><span>
</span><a name="line-579"></a><span>    </span><a name="local-6989586621683194095"><a href="#local-6989586621683194095"><span class="hs-identifier">ar_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldrBag</span><span> </span><a href="TcSigs.html#lhsBindArity"><span class="hs-identifier hs-var">lhsBindArity</span></a><span> </span><span class="hs-identifier hs-var">emptyNameEnv</span><span> </span><a href="#local-6989586621683194091"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-580"></a><span>
</span><a name="line-581"></a><span class="hs-identifier">lhsBindArity</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsBind</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NameEnv</span><span> </span><span class="hs-identifier hs-type">Arity</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NameEnv</span><span> </span><span class="hs-identifier hs-type">Arity</span><span>
</span><a name="line-582"></a><a name="lhsBindArity"><a href="TcSigs.html#lhsBindArity"><span class="hs-identifier">lhsBindArity</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunBind</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fun_id</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683194116"><a href="#local-6989586621683194116"><span class="hs-identifier">id</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">fun_matches</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683194117"><a href="#local-6989586621683194117"><span class="hs-identifier">ms</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683194118"><a href="#local-6989586621683194118"><span class="hs-identifier">env</span></a></a><span>
</span><a name="line-583"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendNameEnv</span><span> </span><a href="#local-6989586621683194118"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683194116"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">matchGroupArity</span><span> </span><a href="#local-6989586621683194117"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">)</span><span>
</span><a name="line-584"></a><span class="hs-identifier">lhsBindArity</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683194119"><a href="#local-6989586621683194119"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683194119"><span class="hs-identifier hs-var">env</span></a><span>        </span><span class="hs-comment">-- PatBind/VarBind</span><span>
</span><a name="line-585"></a><span>
</span><a name="line-586"></a><span>
</span><a name="line-587"></a><span class="hs-comment">-----------------</span><span>
</span><a name="line-588"></a><span class="hs-identifier">addInlinePrags</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LSig</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcId</span><span>
</span><a name="line-589"></a><a name="addInlinePrags"><a href="TcSigs.html#addInlinePrags"><span class="hs-identifier">addInlinePrags</span></a></a><span> </span><a name="local-6989586621683194120"><a href="#local-6989586621683194120"><span class="hs-identifier">poly_id</span></a></a><span> </span><a name="local-6989586621683194121"><a href="#local-6989586621683194121"><span class="hs-identifier">prags_for_me</span></a></a><span>
</span><a name="line-590"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683194135"><a href="#local-6989586621683194135"><span class="hs-identifier">inl</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683194136"><a href="#local-6989586621683194136"><span class="hs-identifier">prag</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683194137"><a href="#local-6989586621683194137"><span class="hs-identifier">inls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683194122"><span class="hs-identifier hs-var">inl_prags</span></a><span>
</span><a name="line-591"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;addInlinePrag&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683194120"><span class="hs-identifier hs-var">poly_id</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683194136"><span class="hs-identifier hs-var">prag</span></a><span class="hs-special">)</span><span>
</span><a name="line-592"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683194137"><span class="hs-identifier hs-var">inls</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683194123"><span class="hs-identifier hs-var">warn_multiple_inlines</span></a><span> </span><a href="#local-6989586621683194135"><span class="hs-identifier hs-var">inl</span></a><span> </span><a href="#local-6989586621683194137"><span class="hs-identifier hs-var">inls</span></a><span class="hs-special">)</span><span>
</span><a name="line-593"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683194120"><span class="hs-identifier hs-var">poly_id</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setInlinePragma</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683194136"><span class="hs-identifier hs-var">prag</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-594"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-595"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683194120"><span class="hs-identifier hs-var">poly_id</span></a><span>
</span><a name="line-596"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-597"></a><span>    </span><a name="local-6989586621683194122"><a href="#local-6989586621683194122"><span class="hs-identifier">inl_prags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683194125"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683194126"><span class="hs-identifier hs-var">prag</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683194125"><a href="#local-6989586621683194125"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">InlineSig</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683194126"><a href="#local-6989586621683194126"><span class="hs-identifier">prag</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683194121"><span class="hs-identifier hs-var">prags_for_me</span></a><span class="hs-special">]</span><span>
</span><a name="line-598"></a><span>
</span><a name="line-599"></a><span>    </span><a name="local-6989586621683194123"><a href="#local-6989586621683194123"><span class="hs-identifier">warn_multiple_inlines</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-600"></a><span>
</span><a name="line-601"></a><span>    </span><span class="hs-identifier">warn_multiple_inlines</span><span> </span><a name="local-6989586621683194127"><a href="#local-6989586621683194127"><span class="hs-identifier">inl1</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683194128"><a href="#local-6989586621683194128"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621683194129"><a href="#local-6989586621683194129"><span class="hs-identifier">prag1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683194130"><a href="#local-6989586621683194130"><span class="hs-identifier">inl2</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683194131"><a href="#local-6989586621683194131"><span class="hs-identifier">prag2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683194132"><a href="#local-6989586621683194132"><span class="hs-identifier">inls</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-602"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">inlinePragmaActivation</span><span> </span><a href="#local-6989586621683194129"><span class="hs-identifier hs-var">prag1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">inlinePragmaActivation</span><span> </span><a href="#local-6989586621683194131"><span class="hs-identifier hs-var">prag2</span></a><span>
</span><a name="line-603"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">noUserInlineSpec</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">inlinePragmaSpec</span><span> </span><a href="#local-6989586621683194129"><span class="hs-identifier hs-var">prag1</span></a><span class="hs-special">)</span><span>
</span><a name="line-604"></a><span>       </span><span class="hs-glyph">=</span><span>    </span><span class="hs-comment">-- Tiresome: inl1 is put there by virtue of being in a hs-boot loop</span><span>
</span><a name="line-605"></a><span>            </span><span class="hs-comment">-- and inl2 is a user NOINLINE pragma; we don't want to complain</span><span>
</span><a name="line-606"></a><span>         </span><a href="#local-6989586621683194123"><span class="hs-identifier hs-var">warn_multiple_inlines</span></a><span> </span><a href="#local-6989586621683194130"><span class="hs-identifier hs-var">inl2</span></a><span> </span><a href="#local-6989586621683194132"><span class="hs-identifier hs-var">inls</span></a><span>
</span><a name="line-607"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-608"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683194128"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-609"></a><span>         </span><a href="TcRnMonad.html#addWarnTc"><span class="hs-identifier hs-var">addWarnTc</span></a><span> </span><span class="hs-identifier hs-var">NoReason</span><span>
</span><a name="line-610"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Multiple INLINE pragmas for&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683194120"><span class="hs-identifier hs-var">poly_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-611"></a><span>                       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Ignoring all but the first&quot;</span><span>
</span><a name="line-612"></a><span>                                </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621683194124"><span class="hs-identifier hs-var">pp_inl</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683194127"><span class="hs-identifier hs-var">inl1</span></a><span class="hs-glyph">:</span><a href="#local-6989586621683194130"><span class="hs-identifier hs-var">inl2</span></a><span class="hs-glyph">:</span><a href="#local-6989586621683194132"><span class="hs-identifier hs-var">inls</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-613"></a><span>
</span><a name="line-614"></a><span>    </span><a name="local-6989586621683194124"><a href="#local-6989586621683194124"><span class="hs-identifier">pp_inl</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683194133"><a href="#local-6989586621683194133"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621683194134"><a href="#local-6989586621683194134"><span class="hs-identifier">prag</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683194134"><span class="hs-identifier hs-var">prag</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683194133"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">)</span><span>
</span><a name="line-615"></a><span>
</span><a name="line-616"></a><span>
</span><a name="line-617"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
                   SPECIALISE pragmas
*                                                                      *
************************************************************************

Note [Handling SPECIALISE pragmas]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The basic idea is this:

   foo :: Num a =&gt; a -&gt; b -&gt; a
   {-# SPECIALISE foo :: Int -&gt; b -&gt; Int #-}

We check that
   (forall a b. Num a =&gt; a -&gt; b -&gt; a)
      is more polymorphic than
   forall b. Int -&gt; b -&gt; Int
(for which we could use tcSubType, but see below), generating a HsWrapper
to connect the two, something like
      wrap = /\b. &lt;hole&gt; Int b dNumInt
This wrapper is put in the TcSpecPrag, in the ABExport record of
the AbsBinds.


        f :: (Eq a, Ix b) =&gt; a -&gt; b -&gt; Bool
        {-# SPECIALISE f :: (Ix p, Ix q) =&gt; Int -&gt; (p,q) -&gt; Bool #-}
        f = &lt;poly_rhs&gt;

From this the typechecker generates

    AbsBinds [ab] [d1,d2] [([ab], f, f_mono, prags)] binds

    SpecPrag (wrap_fn :: forall a b. (Eq a, Ix b) =&gt; XXX
                      -&gt; forall p q. (Ix p, Ix q) =&gt; XXX[ Int/a, (p,q)/b ])

From these we generate:

    Rule:       forall p, q, (dp:Ix p), (dq:Ix q).
                    f Int (p,q) dInt ($dfInPair dp dq) = f_spec p q dp dq

    Spec bind:  f_spec = wrap_fn &lt;poly_rhs&gt;

Note that

  * The LHS of the rule may mention dictionary *expressions* (eg
    $dfIxPair dp dq), and that is essential because the dp, dq are
    needed on the RHS.

  * The RHS of f_spec, &lt;poly_rhs&gt; has a *copy* of 'binds', so that it
    can fully specialise it.



From the TcSpecPrag, in DsBinds we generate a binding for f_spec and a RULE:

   f_spec :: Int -&gt; b -&gt; Int
   f_spec = wrap&lt;f rhs&gt;

   RULE: forall b (d:Num b). f b d = f_spec b

The RULE is generated by taking apart the HsWrapper, which is a little
delicate, but works.

Some wrinkles

1. We don't use full-on tcSubType, because that does co and contra
   variance and that in turn will generate too complex a LHS for the
   RULE.  So we use a single invocation of skolemise /
   topInstantiate in tcSpecWrapper.  (Actually I think that even
   the &quot;deeply&quot; stuff may be too much, because it introduces lambdas,
   though I think it can be made to work without too much trouble.)

2. We need to take care with type families (Trac #5821).  Consider
      type instance F Int = Bool
      f :: Num a =&gt; a -&gt; F a
      {-# SPECIALISE foo :: Int -&gt; Bool #-}

  We *could* try to generate an f_spec with precisely the declared type:
      f_spec :: Int -&gt; Bool
      f_spec = &lt;f rhs&gt; Int dNumInt |&gt; co

      RULE: forall d. f Int d = f_spec |&gt; sym co

  but the 'co' and 'sym co' are (a) playing no useful role, and (b) are
  hard to generate.  At all costs we must avoid this:
      RULE: forall d. f Int d |&gt; co = f_spec
  because the LHS will never match (indeed it's rejected in
  decomposeRuleLhs).

  So we simply do this:
    - Generate a constraint to check that the specialised type (after
      skolemiseation) is equal to the instantiated function type.
    - But *discard* the evidence (coercion) for that constraint,
      so that we ultimately generate the simpler code
          f_spec :: Int -&gt; F Int
          f_spec = &lt;f rhs&gt; Int dNumInt

          RULE: forall d. f Int d = f_spec
      You can see this discarding happening in

3. Note that the HsWrapper can transform *any* function with the right
   type prefix
       forall ab. (Eq a, Ix b) =&gt; XXX
   regardless of XXX.  It's sort of polymorphic in XXX.  This is
   useful: we use the same wrapper to transform each of the class ops, as
   well as the dict.  That's what goes on in TcInstDcls.mk_meth_spec_prags
-}</span><span>
</span><a name="line-724"></a><span>
</span><a name="line-725"></a><span class="hs-identifier">tcSpecPrags</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LSig</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>
</span><a name="line-726"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LTcSpecPrag</span><span class="hs-special">]</span><span>
</span><a name="line-727"></a><span class="hs-comment">-- Add INLINE and SPECIALSE pragmas</span><span>
</span><a name="line-728"></a><span class="hs-comment">--    INLINE prags are added to the (polymorphic) Id directly</span><span>
</span><a name="line-729"></a><span class="hs-comment">--    SPECIALISE prags are passed to the desugarer via TcSpecPrags</span><span>
</span><a name="line-730"></a><span class="hs-comment">-- Pre-condition: the poly_id is zonked</span><span>
</span><a name="line-731"></a><span class="hs-comment">-- Reason: required by tcSubExp</span><span>
</span><a name="line-732"></a><a name="tcSpecPrags"><a href="TcSigs.html#tcSpecPrags"><span class="hs-identifier">tcSpecPrags</span></a></a><span> </span><a name="local-6989586621683194138"><a href="#local-6989586621683194138"><span class="hs-identifier">poly_id</span></a></a><span> </span><a name="local-6989586621683194139"><a href="#local-6989586621683194139"><span class="hs-identifier">prag_sigs</span></a></a><span>
</span><a name="line-733"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcSpecPrags&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683194138"><span class="hs-identifier hs-var">poly_id</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683194140"><span class="hs-identifier hs-var">spec_sigs</span></a><span class="hs-special">)</span><span>
</span><a name="line-734"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683194141"><span class="hs-identifier hs-var">bad_sigs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683194143"><span class="hs-identifier hs-var">warn_discarded_sigs</span></a><span>
</span><a name="line-735"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683194145"><a href="#local-6989586621683194145"><span class="hs-identifier">pss</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#mapAndRecoverM"><span class="hs-identifier hs-var">mapAndRecoverM</span></a><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#wrapLocM"><span class="hs-identifier hs-var">wrapLocM</span></a><span> </span><span class="hs-special">(</span><a href="TcSigs.html#tcSpecPrag"><span class="hs-identifier hs-var">tcSpecPrag</span></a><span> </span><a href="#local-6989586621683194138"><span class="hs-identifier hs-var">poly_id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683194140"><span class="hs-identifier hs-var">spec_sigs</span></a><span>
</span><a name="line-736"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683194146"><a href="#local-6989586621683194146"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621683194147"><a href="#local-6989586621683194147"><span class="hs-identifier">ps</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683194146"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683194147"><span class="hs-identifier hs-var">ps</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683194145"><span class="hs-identifier hs-var">pss</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-737"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-738"></a><span>    </span><a name="local-6989586621683194140"><a href="#local-6989586621683194140"><span class="hs-identifier">spec_sigs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-identifier hs-var">isSpecLSig</span><span> </span><a href="#local-6989586621683194139"><span class="hs-identifier hs-var">prag_sigs</span></a><span>
</span><a name="line-739"></a><span>    </span><a name="local-6989586621683194141"><a href="#local-6989586621683194141"><span class="hs-identifier">bad_sigs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621683194142"><span class="hs-identifier hs-var">is_bad_sig</span></a><span> </span><a href="#local-6989586621683194139"><span class="hs-identifier hs-var">prag_sigs</span></a><span>
</span><a name="line-740"></a><span>    </span><a name="local-6989586621683194142"><a href="#local-6989586621683194142"><span class="hs-identifier">is_bad_sig</span></a></a><span> </span><a name="local-6989586621683194144"><a href="#local-6989586621683194144"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isSpecLSig</span><span> </span><a href="#local-6989586621683194144"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">isInlineLSig</span><span> </span><a href="#local-6989586621683194144"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">isSCCFunSig</span><span> </span><a href="#local-6989586621683194144"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-741"></a><span>
</span><a name="line-742"></a><span>    </span><a name="local-6989586621683194143"><a href="#local-6989586621683194143"><span class="hs-identifier">warn_discarded_sigs</span></a></a><span>
</span><a name="line-743"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addWarnTc"><span class="hs-identifier hs-var">addWarnTc</span></a><span> </span><span class="hs-identifier hs-var">NoReason</span><span>
</span><a name="line-744"></a><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Discarding unexpected pragmas for&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683194138"><span class="hs-identifier hs-var">poly_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-745"></a><span>                      </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">getLoc</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683194141"><span class="hs-identifier hs-var">bad_sigs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-746"></a><span>
</span><a name="line-747"></a><span class="hs-comment">--------------</span><span>
</span><a name="line-748"></a><span class="hs-identifier">tcSpecPrag</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Sig</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcSpecPrag</span><span class="hs-special">]</span><span>
</span><a name="line-749"></a><a name="tcSpecPrag"><a href="TcSigs.html#tcSpecPrag"><span class="hs-identifier">tcSpecPrag</span></a></a><span> </span><a name="local-6989586621683194148"><a href="#local-6989586621683194148"><span class="hs-identifier">poly_id</span></a></a><span> </span><a name="local-6989586621683194149"><a href="#local-6989586621683194149"><span class="hs-identifier">prag</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">SpecSig</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683194150"><a href="#local-6989586621683194150"><span class="hs-identifier">fun_name</span></a></a><span> </span><a name="local-6989586621683194151"><a href="#local-6989586621683194151"><span class="hs-identifier">hs_tys</span></a></a><span> </span><a name="local-6989586621683194152"><a href="#local-6989586621683194152"><span class="hs-identifier">inl</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-750"></a><span class="hs-comment">-- See Note [Handling SPECIALISE pragmas]</span><span>
</span><a name="line-751"></a><span class="hs-comment">--</span><span>
</span><a name="line-752"></a><span class="hs-comment">-- The Name fun_name in the SpecSig may not be the same as that of the poly_id</span><span>
</span><a name="line-753"></a><span class="hs-comment">-- Example: SPECIALISE for a class method: the Name in the SpecSig is</span><span>
</span><a name="line-754"></a><span class="hs-comment">--          for the selector Id, but the poly_id is something like $cop</span><span>
</span><a name="line-755"></a><span class="hs-comment">-- However we want to use fun_name in the error message, since that is</span><span>
</span><a name="line-756"></a><span class="hs-comment">-- what the user wrote (Trac #8537)</span><span>
</span><a name="line-757"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683194155"><span class="hs-identifier hs-var">spec_ctxt</span></a><span> </span><a href="#local-6989586621683194149"><span class="hs-identifier hs-var">prag</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-758"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#warnIf"><span class="hs-identifier hs-var">warnIf</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isOverloadedTy</span><span> </span><a href="#local-6989586621683194154"><span class="hs-identifier hs-var">poly_ty</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">isInlinePragma</span><span> </span><a href="#local-6989586621683194152"><span class="hs-identifier hs-var">inl</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-759"></a><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;SPECIALISE pragma for non-overloaded function&quot;</span><span>
</span><a name="line-760"></a><span>                  </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683194150"><span class="hs-identifier hs-var">fun_name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-761"></a><span>                  </span><span class="hs-comment">-- Note [SPECIALISE pragmas]</span><span>
</span><a name="line-762"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683194161"><a href="#local-6989586621683194161"><span class="hs-identifier">spec_prags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621683194156"><span class="hs-identifier hs-var">tc_one</span></a><span> </span><a href="#local-6989586621683194151"><span class="hs-identifier hs-var">hs_tys</span></a><span>
</span><a name="line-763"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcSpecPrag&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683194148"><span class="hs-identifier hs-var">poly_id</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683194161"><span class="hs-identifier hs-var">spec_prags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-764"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683194161"><span class="hs-identifier hs-var">spec_prags</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-765"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-766"></a><span>    </span><a name="local-6989586621683194153"><a href="#local-6989586621683194153"><span class="hs-identifier">name</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621683194148"><span class="hs-identifier hs-var">poly_id</span></a><span>
</span><a name="line-767"></a><span>    </span><a name="local-6989586621683194154"><a href="#local-6989586621683194154"><span class="hs-identifier">poly_ty</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683194148"><span class="hs-identifier hs-var">poly_id</span></a><span>
</span><a name="line-768"></a><span>    </span><a name="local-6989586621683194155"><a href="#local-6989586621683194155"><span class="hs-identifier">spec_ctxt</span></a></a><span> </span><a name="local-6989586621683194157"><a href="#local-6989586621683194157"><span class="hs-identifier">prag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;In the SPECIALISE pragma&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683194157"><span class="hs-identifier hs-var">prag</span></a><span class="hs-special">)</span><span>
</span><a name="line-769"></a><span>
</span><a name="line-770"></a><span>    </span><a name="local-6989586621683194156"><a href="#local-6989586621683194156"><span class="hs-identifier">tc_one</span></a></a><span> </span><a name="local-6989586621683194158"><a href="#local-6989586621683194158"><span class="hs-identifier">hs_ty</span></a></a><span>
</span><a name="line-771"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683194159"><a href="#local-6989586621683194159"><span class="hs-identifier">spec_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcHsSigType"><span class="hs-identifier hs-var">tcHsSigType</span></a><span>   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunSigCtxt</span><span> </span><a href="#local-6989586621683194153"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683194158"><span class="hs-identifier hs-var">hs_ty</span></a><span>
</span><a name="line-772"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683194160"><a href="#local-6989586621683194160"><span class="hs-identifier">wrap</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSigs.html#tcSpecWrapper"><span class="hs-identifier hs-var">tcSpecWrapper</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunSigCtxt</span><span> </span><a href="#local-6989586621683194153"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>  </span><a href="#local-6989586621683194154"><span class="hs-identifier hs-var">poly_ty</span></a><span> </span><a href="#local-6989586621683194159"><span class="hs-identifier hs-var">spec_ty</span></a><span>
</span><a name="line-773"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SpecPrag</span><span> </span><a href="#local-6989586621683194148"><span class="hs-identifier hs-var">poly_id</span></a><span> </span><a href="#local-6989586621683194160"><span class="hs-identifier hs-var">wrap</span></a><span> </span><a href="#local-6989586621683194152"><span class="hs-identifier hs-var">inl</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-774"></a><span>
</span><a name="line-775"></a><span class="hs-identifier">tcSpecPrag</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683194162"><a href="#local-6989586621683194162"><span class="hs-identifier">prag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;tcSpecPrag&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683194162"><span class="hs-identifier hs-var">prag</span></a><span class="hs-special">)</span><span>
</span><a name="line-776"></a><span>
</span><a name="line-777"></a><span class="hs-comment">--------------</span><span>
</span><a name="line-778"></a><span class="hs-identifier">tcSpecWrapper</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UserTypeCtxt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">HsWrapper</span><span>
</span><a name="line-779"></a><span class="hs-comment">-- A simpler variant of tcSubType, used for SPECIALISE pragmas</span><span>
</span><a name="line-780"></a><span class="hs-comment">-- See Note [Handling SPECIALISE pragmas], wrinkle 1</span><span>
</span><a name="line-781"></a><a name="tcSpecWrapper"><a href="TcSigs.html#tcSpecWrapper"><span class="hs-identifier">tcSpecWrapper</span></a></a><span> </span><a name="local-6989586621683194163"><a href="#local-6989586621683194163"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621683194164"><a href="#local-6989586621683194164"><span class="hs-identifier">poly_ty</span></a></a><span> </span><a name="local-6989586621683194165"><a href="#local-6989586621683194165"><span class="hs-identifier">spec_ty</span></a></a><span>
</span><a name="line-782"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683194170"><a href="#local-6989586621683194170"><span class="hs-identifier">sk_wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683194171"><a href="#local-6989586621683194171"><span class="hs-identifier">inst_wrap</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-783"></a><span>               </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#tcSkolemise"><span class="hs-identifier hs-var">tcSkolemise</span></a><span> </span><a href="#local-6989586621683194163"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621683194165"><span class="hs-identifier hs-var">spec_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683194167"><a href="#local-6989586621683194167"><span class="hs-identifier">spec_tau</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-784"></a><span>                  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683194168"><a href="#local-6989586621683194168"><span class="hs-identifier">inst_wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683194169"><a href="#local-6989586621683194169"><span class="hs-identifier">tau</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#topInstantiate"><span class="hs-identifier hs-var">topInstantiate</span></a><span> </span><a href="#local-6989586621683194166"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621683194164"><span class="hs-identifier hs-var">poly_ty</span></a><span>
</span><a name="line-785"></a><span>                     </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#unifyType"><span class="hs-identifier hs-var">unifyType</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621683194167"><span class="hs-identifier hs-var">spec_tau</span></a><span> </span><a href="#local-6989586621683194169"><span class="hs-identifier hs-var">tau</span></a><span>
</span><a name="line-786"></a><span>                            </span><span class="hs-comment">-- Deliberately ignore the evidence</span><span>
</span><a name="line-787"></a><span>                            </span><span class="hs-comment">-- See Note [Handling SPECIALISE pragmas],</span><span>
</span><a name="line-788"></a><span>                            </span><span class="hs-comment">--   wrinkle (2)</span><span>
</span><a name="line-789"></a><span>                     </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683194168"><span class="hs-identifier hs-var">inst_wrap</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-790"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683194170"><span class="hs-identifier hs-var">sk_wrap</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><a href="#local-6989586621683194171"><span class="hs-identifier hs-var">inst_wrap</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-791"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-792"></a><span>    </span><a name="local-6989586621683194166"><a href="#local-6989586621683194166"><span class="hs-identifier">orig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">SpecPragOrigin</span><span> </span><a href="#local-6989586621683194163"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-793"></a><span>
</span><a name="line-794"></a><span class="hs-comment">--------------</span><span>
</span><a name="line-795"></a><span class="hs-identifier">tcImpPrags</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LSig</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LTcSpecPrag</span><span class="hs-special">]</span><span>
</span><a name="line-796"></a><span class="hs-comment">-- SPECIALISE pragmas for imported things</span><span>
</span><a name="line-797"></a><a name="tcImpPrags"><a href="TcSigs.html#tcImpPrags"><span class="hs-identifier">tcImpPrags</span></a></a><span> </span><a name="local-6989586621683194172"><a href="#local-6989586621683194172"><span class="hs-identifier">prags</span></a></a><span>
</span><a name="line-798"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683194176"><a href="#local-6989586621683194176"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-799"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683194177"><a href="#local-6989586621683194177"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-800"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683194173"><span class="hs-identifier hs-var">not_specialising</span></a><span> </span><a href="#local-6989586621683194177"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-801"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-802"></a><span>         </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-803"></a><span>            </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683194181"><a href="#local-6989586621683194181"><span class="hs-identifier">pss</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#mapAndRecoverM"><span class="hs-identifier hs-var">mapAndRecoverM</span></a><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#wrapLocM"><span class="hs-identifier hs-var">wrapLocM</span></a><span> </span><a href="TcSigs.html#tcImpSpec"><span class="hs-identifier hs-var">tcImpSpec</span></a><span class="hs-special">)</span><span>
</span><a name="line-804"></a><span>                     </span><span class="hs-special">[</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683194178"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683194180"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><a href="#local-6989586621683194179"><span class="hs-identifier hs-var">prag</span></a><span class="hs-special">)</span><span>
</span><a name="line-805"></a><span>                             </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683194178"><a href="#local-6989586621683194178"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621683194179"><a href="#local-6989586621683194179"><span class="hs-identifier">prag</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">SpecSig</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683194180"><a href="#local-6989586621683194180"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683194172"><span class="hs-identifier hs-var">prags</span></a><span>
</span><a name="line-806"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameIsLocalOrFrom</span><span> </span><a href="#local-6989586621683194176"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621683194180"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-807"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683194182"><a href="#local-6989586621683194182"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621683194183"><a href="#local-6989586621683194183"><span class="hs-identifier">ps</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683194182"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683194183"><span class="hs-identifier hs-var">ps</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683194181"><span class="hs-identifier hs-var">pss</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-808"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-809"></a><span>    </span><span class="hs-comment">-- Ignore SPECIALISE pragmas for imported things</span><span>
</span><a name="line-810"></a><span>    </span><span class="hs-comment">-- when we aren't specialising, or when we aren't generating</span><span>
</span><a name="line-811"></a><span>    </span><span class="hs-comment">-- code.  The latter happens when Haddocking the base library;</span><span>
</span><a name="line-812"></a><span>    </span><span class="hs-comment">-- we don't want complaints about lack of INLINABLE pragmas</span><span>
</span><a name="line-813"></a><span>    </span><a name="local-6989586621683194173"><a href="#local-6989586621683194173"><span class="hs-identifier">not_specialising</span></a></a><span> </span><a name="local-6989586621683194174"><a href="#local-6989586621683194174"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-814"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_Specialise</span><span> </span><a href="#local-6989586621683194174"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-815"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">hscTarget</span><span> </span><a href="#local-6989586621683194174"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-816"></a><span>                      </span><span class="hs-identifier hs-var">HscNothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-817"></a><span>                      </span><span class="hs-identifier hs-var">HscInterpreted</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-818"></a><span>                      </span><a name="local-6989586621683194175"><a href="#local-6989586621683194175"><span class="hs-identifier">_other</span></a></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-819"></a><span>
</span><a name="line-820"></a><span class="hs-identifier">tcImpSpec</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Sig</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcSpecPrag</span><span class="hs-special">]</span><span>
</span><a name="line-821"></a><a name="tcImpSpec"><a href="TcSigs.html#tcImpSpec"><span class="hs-identifier">tcImpSpec</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683194184"><a href="#local-6989586621683194184"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683194185"><a href="#local-6989586621683194185"><span class="hs-identifier">prag</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-822"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683194186"><a href="#local-6989586621683194186"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupId"><span class="hs-identifier hs-var">tcLookupId</span></a><span> </span><a href="#local-6989586621683194184"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-823"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isAnyInlinePragma</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idInlinePragma</span><span> </span><a href="#local-6989586621683194186"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-824"></a><span>               </span><span class="hs-special">(</span><a href="TcRnMonad.html#addWarnTc"><span class="hs-identifier hs-var">addWarnTc</span></a><span> </span><span class="hs-identifier hs-var">NoReason</span><span> </span><span class="hs-special">(</span><a href="TcSigs.html#impSpecErr"><span class="hs-identifier hs-var">impSpecErr</span></a><span> </span><a href="#local-6989586621683194184"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-825"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="TcSigs.html#tcSpecPrag"><span class="hs-identifier hs-var">tcSpecPrag</span></a><span> </span><a href="#local-6989586621683194186"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621683194185"><span class="hs-identifier hs-var">prag</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-826"></a><span>
</span><a name="line-827"></a><span class="hs-identifier">impSpecErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-828"></a><a name="impSpecErr"><a href="TcSigs.html#impSpecErr"><span class="hs-identifier">impSpecErr</span></a></a><span> </span><a name="local-6989586621683194187"><a href="#local-6989586621683194187"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-829"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;You cannot SPECIALISE&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683194187"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-830"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;because its definition has no INLINE/INLINABLE pragma&quot;</span><span>
</span><a name="line-831"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">sep</span><span>
</span><a name="line-832"></a><span>                   </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;or its defining module&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683194188"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-833"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;was compiled without -O&quot;</span><span class="hs-special">]</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-834"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-835"></a><span>    </span><a name="local-6989586621683194188"><a href="#local-6989586621683194188"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameModule</span><span> </span><a href="#local-6989586621683194187"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-836"></a></pre></body></html>