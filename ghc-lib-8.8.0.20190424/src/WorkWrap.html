<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The GRASP/AQUA Project, Glasgow University, 1993-1998

\section[WorkWrap]{Worker/wrapper-generating back-end of strictness analyser}
-}</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-8"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">WorkWrap</span><span> </span><span class="hs-special">(</span><span> </span><a href="WorkWrap.html#wwTopBinds"><span class="hs-identifier hs-var">wwTopBinds</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreSyn</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreUnfold</span><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">certainlyWillInline</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkWwInlineRule</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkWorkerUnfolding</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreUtils</span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">exprType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">exprIsHNF</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreFVs</span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">exprFreeVars</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Var</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">IdInfo</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSupply</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Demand</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="WwLib.html"><span class="hs-identifier">WwLib</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FamInstEnv</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MonadUtils</span><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-32"></a><span class="hs-comment">{-
We take Core bindings whose binders have:

\begin{enumerate}

\item Strictness attached (by the front-end of the strictness
analyser), and / or

\item Constructed Product Result information attached by the CPR
analysis pass.

\end{enumerate}

and we return some ``plain'' bindings which have been
worker/wrapper-ified, meaning:

\begin{enumerate}

\item Functions have been split into workers and wrappers where
appropriate.  If a function has both strictness and CPR properties
then only one worker/wrapper doing both transformations is produced;

\item Binders' @IdInfos@ have been updated to reflect the existence of
these workers/wrappers (this is where we get STRICTNESS and CPR pragma
info for exported values).
\end{enumerate}
-}</span><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-identifier">wwTopBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FamInstEnvs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreProgram</span><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><a name="wwTopBinds"><a href="WorkWrap.html#wwTopBinds"><span class="hs-identifier">wwTopBinds</span></a></a><span> </span><a name="local-6989586621684316933"><a href="#local-6989586621684316933"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684316934"><a href="#local-6989586621684316934"><span class="hs-identifier">fam_envs</span></a></a><span> </span><a name="local-6989586621684316935"><a href="#local-6989586621684316935"><span class="hs-identifier">us</span></a></a><span> </span><a name="local-6989586621684316936"><a href="#local-6989586621684316936"><span class="hs-identifier">top_binds</span></a></a><span>
</span><a name="line-63"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">initUs_</span><span> </span><a href="#local-6989586621684316935"><span class="hs-identifier hs-var">us</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-64"></a><span>    </span><a name="local-6989586621684316937"><a href="#local-6989586621684316937"><span class="hs-identifier">top_binds'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="WorkWrap.html#wwBind"><span class="hs-identifier hs-var">wwBind</span></a><span> </span><a href="#local-6989586621684316933"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684316934"><span class="hs-identifier hs-var">fam_envs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684316936"><span class="hs-identifier hs-var">top_binds</span></a><span>
</span><a name="line-65"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-6989586621684316937"><span class="hs-identifier hs-var">top_binds'</span></a><span class="hs-special">)</span><span>
</span><a name="line-66"></a><span>
</span><a name="line-67"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection[wwBind-wwExpr]{@wwBind@ and @wwExpr@}
*                                                                      *
************************************************************************

@wwBind@ works on a binding, trying each \tr{(binder, expr)} pair in
turn.  Non-recursive case first, then recursive...
-}</span><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span class="hs-identifier">wwBind</span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-79"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FamInstEnvs</span><span>
</span><a name="line-80"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreBind</span><span>
</span><a name="line-81"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreBind</span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- returns a WwBinding intermediate form;</span><span>
</span><a name="line-82"></a><span>                                </span><span class="hs-comment">-- the caller will convert to Expr/Binding,</span><span>
</span><a name="line-83"></a><span>                                </span><span class="hs-comment">-- as appropriate.</span><span>
</span><a name="line-84"></a><span>
</span><a name="line-85"></a><a name="wwBind"><a href="WorkWrap.html#wwBind"><span class="hs-identifier">wwBind</span></a></a><span> </span><a name="local-6989586621684316938"><a href="#local-6989586621684316938"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684316939"><a href="#local-6989586621684316939"><span class="hs-identifier">fam_envs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a name="local-6989586621684316940"><a href="#local-6989586621684316940"><span class="hs-identifier">binder</span></a></a><span> </span><a name="local-6989586621684316941"><a href="#local-6989586621684316941"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-86"></a><span>    </span><a name="local-6989586621684316942"><a href="#local-6989586621684316942"><span class="hs-identifier">new_rhs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a><span> </span><a href="#local-6989586621684316938"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684316939"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><a href="#local-6989586621684316941"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-87"></a><span>    </span><a name="local-6989586621684316943"><a href="#local-6989586621684316943"><span class="hs-identifier">new_pairs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="WorkWrap.html#tryWW"><span class="hs-identifier hs-var">tryWW</span></a><span> </span><a href="#local-6989586621684316938"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684316939"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><span class="hs-identifier hs-var">NonRecursive</span><span> </span><a href="#local-6989586621684316940"><span class="hs-identifier hs-var">binder</span></a><span> </span><a href="#local-6989586621684316942"><span class="hs-identifier hs-var">new_rhs</span></a><span>
</span><a name="line-88"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621684316944"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621684316945"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684316944"><a href="#local-6989586621684316944"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><a name="local-6989586621684316945"><a href="#local-6989586621684316945"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684316943"><span class="hs-identifier hs-var">new_pairs</span></a><span class="hs-special">]</span><span>
</span><a name="line-89"></a><span>      </span><span class="hs-comment">-- Generated bindings must be non-recursive</span><span>
</span><a name="line-90"></a><span>      </span><span class="hs-comment">-- because the original binding was.</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span class="hs-identifier">wwBind</span><span> </span><a name="local-6989586621684316946"><a href="#local-6989586621684316946"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684316947"><a href="#local-6989586621684316947"><span class="hs-identifier">fam_envs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><a name="local-6989586621684316948"><a href="#local-6989586621684316948"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-93"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Rec</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">concatMapM</span><span> </span><a href="#local-6989586621684316949"><span class="hs-identifier hs-var">do_one</span></a><span> </span><a href="#local-6989586621684316948"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-94"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-95"></a><span>    </span><a name="local-6989586621684316949"><a href="#local-6989586621684316949"><span class="hs-identifier">do_one</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684316950"><a href="#local-6989586621684316950"><span class="hs-identifier">binder</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684316951"><a href="#local-6989586621684316951"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621684316952"><a href="#local-6989586621684316952"><span class="hs-identifier">new_rhs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a><span> </span><a href="#local-6989586621684316946"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684316947"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><a href="#local-6989586621684316951"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-96"></a><span>                              </span><a href="WorkWrap.html#tryWW"><span class="hs-identifier hs-var">tryWW</span></a><span> </span><a href="#local-6989586621684316946"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684316947"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><span class="hs-identifier hs-var">Recursive</span><span> </span><a href="#local-6989586621684316950"><span class="hs-identifier hs-var">binder</span></a><span> </span><a href="#local-6989586621684316952"><span class="hs-identifier hs-var">new_rhs</span></a><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span class="hs-comment">{-
@wwExpr@ basically just walks the tree, looking for appropriate
annotations that can be used. Remember it is @wwBind@ that does the
matching by looking for strict arguments of the correct type.
@wwExpr@ is a version that just returns the ``Plain'' Tree.
-}</span><span>
</span><a name="line-104"></a><span>
</span><a name="line-105"></a><span class="hs-identifier">wwExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FamInstEnvs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><a name="wwExpr"><a href="WorkWrap.html#wwExpr"><span class="hs-identifier">wwExpr</span></a></a><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684316953"><a href="#local-6989586621684316953"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Type</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684316953"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-108"></a><span class="hs-identifier">wwExpr</span><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684316954"><a href="#local-6989586621684316954"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Coercion</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684316954"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-109"></a><span class="hs-identifier">wwExpr</span><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684316955"><a href="#local-6989586621684316955"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Lit</span><span>  </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684316955"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-110"></a><span class="hs-identifier">wwExpr</span><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684316956"><a href="#local-6989586621684316956"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span>  </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684316956"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-111"></a><span>
</span><a name="line-112"></a><span class="hs-identifier">wwExpr</span><span> </span><a name="local-6989586621684316957"><a href="#local-6989586621684316957"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684316958"><a href="#local-6989586621684316958"><span class="hs-identifier">fam_envs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Lam</span><span> </span><a name="local-6989586621684316959"><a href="#local-6989586621684316959"><span class="hs-identifier">binder</span></a></a><span> </span><a name="local-6989586621684316960"><a href="#local-6989586621684316960"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-113"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Lam</span><span> </span><a href="#local-6989586621684316961"><span class="hs-identifier hs-var">new_binder</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a><span> </span><a href="#local-6989586621684316957"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684316958"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><a href="#local-6989586621684316960"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-114"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621684316961"><a href="#local-6989586621684316961"><span class="hs-identifier">new_binder</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isId</span><span> </span><a href="#local-6989586621684316959"><span class="hs-identifier hs-var">binder</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zapIdUsedOnceInfo</span><span> </span><a href="#local-6989586621684316959"><span class="hs-identifier hs-var">binder</span></a><span>
</span><a name="line-115"></a><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684316959"><span class="hs-identifier hs-var">binder</span></a><span>
</span><a name="line-116"></a><span>  </span><span class="hs-comment">-- See Note [Zapping Used Once info in WorkWrap]</span><span>
</span><a name="line-117"></a><span>
</span><a name="line-118"></a><span class="hs-identifier">wwExpr</span><span> </span><a name="local-6989586621684316962"><a href="#local-6989586621684316962"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684316963"><a href="#local-6989586621684316963"><span class="hs-identifier">fam_envs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">App</span><span> </span><a name="local-6989586621684316964"><a href="#local-6989586621684316964"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621684316965"><a href="#local-6989586621684316965"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-119"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">App</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a><span> </span><a href="#local-6989586621684316962"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684316963"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><a href="#local-6989586621684316964"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a><span> </span><a href="#local-6989586621684316962"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684316963"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><a href="#local-6989586621684316965"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-120"></a><span>
</span><a name="line-121"></a><span class="hs-identifier">wwExpr</span><span> </span><a name="local-6989586621684316966"><a href="#local-6989586621684316966"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684316967"><a href="#local-6989586621684316967"><span class="hs-identifier">fam_envs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Tick</span><span> </span><a name="local-6989586621684316968"><a href="#local-6989586621684316968"><span class="hs-identifier">note</span></a></a><span> </span><a name="local-6989586621684316969"><a href="#local-6989586621684316969"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-122"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Tick</span><span> </span><a href="#local-6989586621684316968"><span class="hs-identifier hs-var">note</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a><span> </span><a href="#local-6989586621684316966"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684316967"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><a href="#local-6989586621684316969"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-identifier">wwExpr</span><span> </span><a name="local-6989586621684316970"><a href="#local-6989586621684316970"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684316971"><a href="#local-6989586621684316971"><span class="hs-identifier">fam_envs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Cast</span><span> </span><a name="local-6989586621684316972"><a href="#local-6989586621684316972"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621684316973"><a href="#local-6989586621684316973"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-125"></a><span>    </span><a name="local-6989586621684316974"><a href="#local-6989586621684316974"><span class="hs-identifier">new_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a><span> </span><a href="#local-6989586621684316970"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684316971"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><a href="#local-6989586621684316972"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-126"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Cast</span><span> </span><a href="#local-6989586621684316974"><span class="hs-identifier hs-var">new_expr</span></a><span> </span><a href="#local-6989586621684316973"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-127"></a><span>
</span><a name="line-128"></a><span class="hs-identifier">wwExpr</span><span> </span><a name="local-6989586621684316975"><a href="#local-6989586621684316975"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684316976"><a href="#local-6989586621684316976"><span class="hs-identifier">fam_envs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Let</span><span> </span><a name="local-6989586621684316977"><a href="#local-6989586621684316977"><span class="hs-identifier">bind</span></a></a><span> </span><a name="local-6989586621684316978"><a href="#local-6989586621684316978"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-129"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkLets</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="WorkWrap.html#wwBind"><span class="hs-identifier hs-var">wwBind</span></a><span> </span><a href="#local-6989586621684316975"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684316976"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><a href="#local-6989586621684316977"><span class="hs-identifier hs-var">bind</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a><span> </span><a href="#local-6989586621684316975"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684316976"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><a href="#local-6989586621684316978"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><span class="hs-identifier">wwExpr</span><span> </span><a name="local-6989586621684316979"><a href="#local-6989586621684316979"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684316980"><a href="#local-6989586621684316980"><span class="hs-identifier">fam_envs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Case</span><span> </span><a name="local-6989586621684316981"><a href="#local-6989586621684316981"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621684316982"><a href="#local-6989586621684316982"><span class="hs-identifier">binder</span></a></a><span> </span><a name="local-6989586621684316983"><a href="#local-6989586621684316983"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621684316984"><a href="#local-6989586621684316984"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-132"></a><span>    </span><a name="local-6989586621684316992"><a href="#local-6989586621684316992"><span class="hs-identifier">new_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a><span> </span><a href="#local-6989586621684316979"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684316980"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><a href="#local-6989586621684316981"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-133"></a><span>    </span><a name="local-6989586621684316993"><a href="#local-6989586621684316993"><span class="hs-identifier">new_alts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621684316985"><span class="hs-identifier hs-var">ww_alt</span></a><span> </span><a href="#local-6989586621684316984"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-134"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684316994"><a href="#local-6989586621684316994"><span class="hs-identifier">new_binder</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zapIdUsedOnceInfo</span><span> </span><a href="#local-6989586621684316982"><span class="hs-identifier hs-var">binder</span></a><span>
</span><a name="line-135"></a><span>      </span><span class="hs-comment">-- See Note [Zapping Used Once info in WorkWrap]</span><span>
</span><a name="line-136"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Case</span><span> </span><a href="#local-6989586621684316992"><span class="hs-identifier hs-var">new_expr</span></a><span> </span><a href="#local-6989586621684316994"><span class="hs-identifier hs-var">new_binder</span></a><span> </span><a href="#local-6989586621684316983"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621684316993"><span class="hs-identifier hs-var">new_alts</span></a><span class="hs-special">)</span><span>
</span><a name="line-137"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-138"></a><span>    </span><a name="local-6989586621684316985"><a href="#local-6989586621684316985"><span class="hs-identifier">ww_alt</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684316986"><a href="#local-6989586621684316986"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684316987"><a href="#local-6989586621684316987"><span class="hs-identifier">binders</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684316988"><a href="#local-6989586621684316988"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-139"></a><span>        </span><a name="local-6989586621684316989"><a href="#local-6989586621684316989"><span class="hs-identifier">new_rhs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="WorkWrap.html#wwExpr"><span class="hs-identifier hs-var">wwExpr</span></a><span> </span><a href="#local-6989586621684316979"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684316980"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><a href="#local-6989586621684316988"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-140"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684316990"><a href="#local-6989586621684316990"><span class="hs-identifier">new_binders</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isId</span><span> </span><a href="#local-6989586621684316991"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">zapIdUsedOnceInfo</span><span> </span><a href="#local-6989586621684316991"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621684316991"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-141"></a><span>                          </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621684316991"><a href="#local-6989586621684316991"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684316987"><span class="hs-identifier hs-var">binders</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-142"></a><span>           </span><span class="hs-comment">-- See Note [Zapping Used Once info in WorkWrap]</span><span>
</span><a name="line-143"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684316986"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684316990"><span class="hs-identifier hs-var">new_binders</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684316989"><span class="hs-identifier hs-var">new_rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-144"></a><span>
</span><a name="line-145"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection[tryWW]{@tryWW@: attempt a worker/wrapper pair}
*                                                                      *
************************************************************************

@tryWW@ just accumulates arguments, converts strictness info from the
front-end into the proper form, then calls @mkWwBodies@ to do
the business.

The only reason this is monadised is for the unique supply.

Note [Don't w/w INLINE things]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's very important to refrain from w/w-ing an INLINE function (ie one
with a stable unfolding) because the wrapper will then overwrite the
old stable unfolding with the wrapper code.

Furthermore, if the programmer has marked something as INLINE,
we may lose by w/w'ing it.

If the strictness analyser is run twice, this test also prevents
wrappers (which are INLINEd) from being re-done.  (You can end up with
several liked-named Ids bouncing around at the same time---absolute
mischief.)

Notice that we refrain from w/w'ing an INLINE function even if it is
in a recursive group.  It might not be the loop breaker.  (We could
test for loop-breaker-hood, but I'm not sure that ever matters.)

Note [Worker-wrapper for INLINABLE functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we have
  {-# INLINABLE f #-}
  f :: Ord a =&gt; [a] -&gt; Int -&gt; a
  f x y = ....f....

where f is strict in y, we might get a more efficient loop by w/w'ing
f.  But that would make a new unfolding which would overwrite the old
one! So the function would no longer be INLNABLE, and in particular
will not be specialised at call sites in other modules.

This comes in practice (Trac #6056).

Solution: do the w/w for strictness analysis, but transfer the Stable
unfolding to the *worker*.  So we will get something like this:

  {-# INLINE[0] f #-}
  f :: Ord a =&gt; [a] -&gt; Int -&gt; a
  f d x y = case y of I# y' -&gt; fw d x y'

  {-# INLINABLE[0] fw #-}
  fw :: Ord a =&gt; [a] -&gt; Int# -&gt; a
  fw d x y' = let y = I# y' in ...f...

How do we &quot;transfer the unfolding&quot;? Easy: by using the old one, wrapped
in work_fn! See CoreUnfold.mkWorkerUnfolding.

Note [Worker-wrapper for NOINLINE functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We used to disable worker/wrapper for NOINLINE things, but it turns out
this can cause unnecessary reboxing of values. Consider

  {-# NOINLINE f #-}
  f :: Int -&gt; a
  f x = error (show x)

  g :: Bool -&gt; Bool -&gt; Int -&gt; Int
  g True  True  p = f p
  g False True  p = p + 1
  g b     False p = g b True p

the strictness analysis will discover f and g are strict, but because f
has no wrapper, the worker for g will rebox p. So we get

  $wg x y p# =
    let p = I# p# in  -- Yikes! Reboxing!
    case x of
      False -&gt;
        case y of
          False -&gt; $wg False True p#
          True -&gt; +# p# 1#
      True -&gt;
        case y of
          False -&gt; $wg True True p#
          True -&gt; case f p of { }

  g x y p = case p of (I# p#) -&gt; $wg x y p#

Now, in this case the reboxing will float into the True branch, and so
the allocation will only happen on the error path. But it won't float
inwards if there are multiple branches that call (f p), so the reboxing
will happen on every call of g. Disaster.

Solution: do worker/wrapper even on NOINLINE things; but move the
NOINLINE pragma to the worker.

(See Trac #13143 for a real-world example.)

Note [Worker activation]
~~~~~~~~~~~~~~~~~~~~~~~~
Follows on from Note [Worker-wrapper for INLINABLE functions]

It is *vital* that if the worker gets an INLINABLE pragma (from the
original function), then the worker has the same phase activation as
the wrapper (or later).  That is necessary to allow the wrapper to
inline into the worker's unfolding: see SimplUtils
Note [Simplifying inside stable unfoldings].

If the original is NOINLINE, it's important that the work inherit the
original activation. Consider

  {-# NOINLINE expensive #-}
  expensive x = x + 1

  f y = let z = expensive y in ...

If expensive's worker inherits the wrapper's activation,
we'll get this (because of the compromise in point (2) of
Note [Wrapper activation])

  {-# NOINLINE[0] $wexpensive #-}
  $wexpensive x = x + 1
  {-# INLINE[0] expensive #-}
  expensive x = $wexpensive x

  f y = let z = expensive y in ...

and $wexpensive will be immediately inlined into expensive, followed by
expensive into f. This effectively removes the original NOINLINE!

Otherwise, nothing is lost by giving the worker the same activation as the
wrapper, because the worker won't have any chance of inlining until the
wrapper does; there's no point in giving it an earlier activation.

Note [Don't w/w inline small non-loop-breaker things]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In general, we refrain from w/w-ing *small* functions, which are not
loop breakers, because they'll inline anyway.  But we must take care:
it may look small now, but get to be big later after other inlining
has happened.  So we take the precaution of adding an INLINE pragma to
any such functions.

I made this change when I observed a big function at the end of
compilation with a useful strictness signature but no w-w.  (It was
small during demand analysis, we refrained from w/w, and then got big
when something was inlined in its rhs.) When I measured it on nofib,
it didn't make much difference; just a few percent improved allocation
on one benchmark (bspt/Euclid.space).  But nothing got worse.

There is an infelicity though.  We may get something like
      f = g val
==&gt;
      g x = case gw x of r -&gt; I# r

      f {- InlineStable, Template = g val -}
      f = case gw x of r -&gt; I# r

The code for f duplicates that for g, without any real benefit. It
won't really be executed, because calls to f will go via the inlining.

Note [Don't CPR join points]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

There's no point in doing CPR on a join point. If the whole function is getting
CPR'd, then the case expression around the worker function will get pushed into
the join point by the simplifier, which will have the same effect that CPR would
have - the result will be returned in an unboxed tuple.

  f z = let join j x y = (x+1, y+1)
        in case z of A -&gt; j 1 2
                     B -&gt; j 2 3

  =&gt;

  f z = case $wf z of (# a, b #) -&gt; (a, b)
  $wf z = case (let join j x y = (x+1, y+1)
                in case z of A -&gt; j 1 2
                             B -&gt; j 2 3) of (a, b) -&gt; (# a, b #)

  =&gt;

  f z = case $wf z of (# a, b #) -&gt; (a, b)
  $wf z = let join j x y = (# x+1, y+1 #)
          in case z of A -&gt; j 1 2
                       B -&gt; j 2 3

Doing CPR on a join point would be tricky anyway, as the worker could not be
a join point because it would not be tail-called. However, doing the *argument*
part of W/W still works for join points, since the wrapper body will make a tail
call:

  f z = let join j x y = x + y
        in ...

  =&gt;

  f z = let join $wj x# y# = x# +# y#
                 j x y = case x of I# x# -&gt;
                         case y of I# y# -&gt;
                         $wj x# y#
        in ...

Note [Wrapper activation]
~~~~~~~~~~~~~~~~~~~~~~~~~
When should the wrapper inlining be active?

1. It must not be active earlier than the current Activation of the
   Id

2. It should be active at some point, despite (1) because of
   Note [Worker-wrapper for NOINLINE functions]

3. For ordinary functions with no pragmas we want to inline the
   wrapper as early as possible (Trac #15056).  Suppose another module
   defines    f x = g x x
   and suppose there is some RULE for (g True True).  Then if we have
   a call (f True), we'd expect to inline 'f' and the RULE will fire.
   But if f is w/w'd (which it might be), we want the inlining to
   occur just as if it hadn't been.

   (This only matters if f's RHS is big enough to w/w, but small
   enough to inline given the call site, but that can happen.)

4. We do not want to inline the wrapper before specialisation.
         module Foo where
           f :: Num a =&gt; a -&gt; Int -&gt; a
           f n 0 = n              -- Strict in the Int, hence wrapper
           f n x = f (n+n) (x-1)

           g :: Int -&gt; Int
           g x = f x x            -- Provokes a specialisation for f

         module Bar where
           import Foo

           h :: Int -&gt; Int
           h x = f 3 x

   In module Bar we want to give specialisations a chance to fire
   before inlining f's wrapper.

Reminder: Note [Don't w/w INLINE things], so we don't need to worry
          about INLINE things here.

Conclusion:
  - If the user said NOINLINE[n], respect that
  - If the user said NOINLINE, inline the wrapper as late as
    poss (phase 0). This is a compromise driven by (2) above
  - Otherwise inline wrapper in phase 2.  That allows the
    'gentle' simplification pass to apply specialisation rules

Historical note: At one stage I tried making the wrapper inlining
always-active, and that had a very bad effect on nofib/imaginary/x2n1;
a wrapper was inlined before the specialisation fired.

Note [Wrapper NoUserInline]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
The use an inl_inline of NoUserInline on the wrapper distinguishes
this pragma from one that was given by the user. In particular, CSE
will not happen if there is a user-specified pragma, but should happen
for w/w&#8217;ed things (#14186).
-}</span><span>
</span><a name="line-409"></a><span>
</span><a name="line-410"></a><span class="hs-identifier">tryWW</span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-411"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FamInstEnvs</span><span>
</span><a name="line-412"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RecFlag</span><span>
</span><a name="line-413"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span>                           </span><span class="hs-comment">-- The fn binder</span><span>
</span><a name="line-414"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>                     </span><span class="hs-comment">-- The bound rhs; its innards</span><span>
</span><a name="line-415"></a><span>                                        </span><span class="hs-comment">--   are already ww'd</span><span>
</span><a name="line-416"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- either *one* or *two* pairs;</span><span>
</span><a name="line-417"></a><span>                                        </span><span class="hs-comment">-- if one, then no worker (only</span><span>
</span><a name="line-418"></a><span>                                        </span><span class="hs-comment">-- the orig &quot;wrapper&quot; lives on);</span><span>
</span><a name="line-419"></a><span>                                        </span><span class="hs-comment">-- if two, then a worker and a</span><span>
</span><a name="line-420"></a><span>                                        </span><span class="hs-comment">-- wrapper.</span><span>
</span><a name="line-421"></a><a name="tryWW"><a href="WorkWrap.html#tryWW"><span class="hs-identifier">tryWW</span></a></a><span> </span><a name="local-6989586621684316995"><a href="#local-6989586621684316995"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684316996"><a href="#local-6989586621684316996"><span class="hs-identifier">fam_envs</span></a></a><span> </span><a name="local-6989586621684316997"><a href="#local-6989586621684316997"><span class="hs-identifier">is_rec</span></a></a><span> </span><a name="local-6989586621684316998"><a href="#local-6989586621684316998"><span class="hs-identifier">fn_id</span></a></a><span> </span><a name="local-6989586621684316999"><a href="#local-6989586621684316999"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-422"></a><span>  </span><span class="hs-comment">-- See Note [Worker-wrapper for NOINLINE functions]</span><span>
</span><a name="line-423"></a><span>
</span><a name="line-424"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684317006"><a href="#local-6989586621684317006"><span class="hs-identifier">stable_unf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">certainlyWillInline</span><span> </span><a href="#local-6989586621684316995"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684317000"><span class="hs-identifier hs-var">fn_info</span></a><span>
</span><a name="line-425"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684316998"><span class="hs-identifier hs-var">fn_id</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setIdUnfolding</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684317006"><span class="hs-identifier hs-var">stable_unf</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684316999"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-426"></a><span>        </span><span class="hs-comment">-- See Note [Don't w/w INLINE things]</span><span>
</span><a name="line-427"></a><span>        </span><span class="hs-comment">-- See Note [Don't w/w inline small non-loop-breaker things]</span><span>
</span><a name="line-428"></a><span>
</span><a name="line-429"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684317004"><span class="hs-identifier hs-var">is_fun</span></a><span>
</span><a name="line-430"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="WorkWrap.html#splitFun"><span class="hs-identifier hs-var">splitFun</span></a><span> </span><a href="#local-6989586621684316995"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684316996"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><a href="#local-6989586621684317003"><span class="hs-identifier hs-var">new_fn_id</span></a><span> </span><a href="#local-6989586621684317000"><span class="hs-identifier hs-var">fn_info</span></a><span> </span><a href="#local-6989586621684317001"><span class="hs-identifier hs-var">wrap_dmds</span></a><span> </span><a href="#local-6989586621684317002"><span class="hs-identifier hs-var">res_info</span></a><span> </span><a href="#local-6989586621684316999"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-431"></a><span>
</span><a name="line-432"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684317005"><span class="hs-identifier hs-var">is_thunk</span></a><span>                                   </span><span class="hs-comment">-- See Note [Thunk splitting]</span><span>
</span><a name="line-433"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="WorkWrap.html#splitThunk"><span class="hs-identifier hs-var">splitThunk</span></a><span> </span><a href="#local-6989586621684316995"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684316996"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><a href="#local-6989586621684316997"><span class="hs-identifier hs-var">is_rec</span></a><span> </span><a href="#local-6989586621684317003"><span class="hs-identifier hs-var">new_fn_id</span></a><span> </span><a href="#local-6989586621684316999"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-434"></a><span>
</span><a name="line-435"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-436"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684317003"><span class="hs-identifier hs-var">new_fn_id</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684316999"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-437"></a><span>
</span><a name="line-438"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-439"></a><span>    </span><a name="local-6989586621684317000"><a href="#local-6989586621684317000"><span class="hs-identifier">fn_info</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idInfo</span><span> </span><a href="#local-6989586621684316998"><span class="hs-identifier hs-var">fn_id</span></a><span>
</span><a name="line-440"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684317001"><a href="#local-6989586621684317001"><span class="hs-identifier">wrap_dmds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684317002"><a href="#local-6989586621684317002"><span class="hs-identifier">res_info</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitStrictSig</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">strictnessInfo</span><span> </span><a href="#local-6989586621684317000"><span class="hs-identifier hs-var">fn_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-441"></a><span>
</span><a name="line-442"></a><span>    </span><a name="local-6989586621684317003"><a href="#local-6989586621684317003"><span class="hs-identifier">new_fn_id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zapIdUsedOnceInfo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zapIdUsageEnvInfo</span><span> </span><a href="#local-6989586621684316998"><span class="hs-identifier hs-var">fn_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-443"></a><span>        </span><span class="hs-comment">-- See Note [Zapping DmdEnv after Demand Analyzer] and</span><span>
</span><a name="line-444"></a><span>        </span><span class="hs-comment">-- See Note [Zapping Used Once info in WorkWrap]</span><span>
</span><a name="line-445"></a><span>
</span><a name="line-446"></a><span>    </span><a name="local-6989586621684317004"><a href="#local-6989586621684317004"><span class="hs-identifier">is_fun</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">notNull</span><span> </span><a href="#local-6989586621684317001"><span class="hs-identifier hs-var">wrap_dmds</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">isJoinId</span><span> </span><a href="#local-6989586621684316998"><span class="hs-identifier hs-var">fn_id</span></a><span>
</span><a name="line-447"></a><span>    </span><a name="local-6989586621684317005"><a href="#local-6989586621684317005"><span class="hs-identifier">is_thunk</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621684317004"><span class="hs-identifier hs-var">is_fun</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprIsHNF</span><span> </span><a href="#local-6989586621684316999"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isJoinId</span><span> </span><a href="#local-6989586621684316998"><span class="hs-identifier hs-var">fn_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-448"></a><span>                           </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isUnliftedType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621684316998"><span class="hs-identifier hs-var">fn_id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-449"></a><span>
</span><a name="line-450"></a><span class="hs-comment">{-
Note [Zapping DmdEnv after Demand Analyzer]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In the worker-wrapper pass we zap the DmdEnv.  Why?
 (a) it is never used again
 (b) it wastes space
 (c) it becomes incorrect as things are cloned, because
     we don't push the substitution into it

Why here?
 * Because we don&#8217;t want to do it in the Demand Analyzer, as we never know
   there when we are doing the last pass.
 * We want them to be still there at the end of DmdAnal, so that
   -ddump-str-anal contains them.
 * We don&#8217;t want a second pass just for that.
 * WorkWrap looks at all bindings anyway.

We also need to do it in TidyCore.tidyLetBndr to clean up after the
final, worker/wrapper-less run of the demand analyser (see
Note [Final Demand Analyser run] in DmdAnal).

Note [Zapping Used Once info in WorkWrap]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In the worker-wrapper pass we zap the used once info in demands and in
strictness signatures.

Why?
 * The simplifier may happen to transform code in a way that invalidates the
   data (see #11731 for an example).
 * It is not used in later passes, up to code generation.

So as the data is useless and possibly wrong, we want to remove it. The most
convenient place to do that is the worker wrapper phase, as it runs after every
run of the demand analyser besides the very last one (which is the one where we
want to _keep_ the info for the code generator).

We do not do it in the demand analyser for the same reasons outlined in
Note [Zapping DmdEnv after Demand Analyzer] above.
-}</span><span>
</span><a name="line-489"></a><span>
</span><a name="line-490"></a><span>
</span><a name="line-491"></a><span class="hs-comment">---------------------</span><span>
</span><a name="line-492"></a><span class="hs-identifier">splitFun</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FamInstEnvs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IdInfo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Demand</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DmdResult</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-493"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-494"></a><a name="splitFun"><a href="WorkWrap.html#splitFun"><span class="hs-identifier">splitFun</span></a></a><span> </span><a name="local-6989586621684317007"><a href="#local-6989586621684317007"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684317008"><a href="#local-6989586621684317008"><span class="hs-identifier">fam_envs</span></a></a><span> </span><a name="local-6989586621684317009"><a href="#local-6989586621684317009"><span class="hs-identifier">fn_id</span></a></a><span> </span><a name="local-6989586621684317010"><a href="#local-6989586621684317010"><span class="hs-identifier">fn_info</span></a></a><span> </span><a name="local-6989586621684317011"><a href="#local-6989586621684317011"><span class="hs-identifier">wrap_dmds</span></a></a><span> </span><a name="local-6989586621684317012"><a href="#local-6989586621684317012"><span class="hs-identifier">res_info</span></a></a><span> </span><a name="local-6989586621684317013"><a href="#local-6989586621684317013"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-495"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">WARN</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">wrap_dmds</span><span> </span><span class="hs-special">`</span><a href="#local-6989586621684317011"><span class="hs-identifier hs-var">lengthIs</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">arity</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">fn_id</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">arity</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">wrap_dmds</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">res_info</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-496"></a><span>    </span><span class="hs-comment">-- The arity should match the signature</span><span>
</span><a name="line-497"></a><span>    </span><a name="local-6989586621684317023"><a href="#local-6989586621684317023"><span class="hs-identifier">stuff</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="WwLib.html#mkWwBodies"><span class="hs-identifier hs-var">mkWwBodies</span></a><span> </span><a href="#local-6989586621684317007"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684317008"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><a href="#local-6989586621684317014"><span class="hs-identifier hs-var">rhs_fvs</span></a><span> </span><a href="#local-6989586621684317009"><span class="hs-identifier hs-var">fn_id</span></a><span> </span><a href="#local-6989586621684317011"><span class="hs-identifier hs-var">wrap_dmds</span></a><span> </span><a href="#local-6989586621684317021"><span class="hs-identifier hs-var">use_res_info</span></a><span>
</span><a name="line-498"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684317023"><span class="hs-identifier hs-var">stuff</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-499"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684317024"><a href="#local-6989586621684317024"><span class="hs-identifier">work_demands</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684317025"><a href="#local-6989586621684317025"><span class="hs-identifier">join_arity</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684317026"><a href="#local-6989586621684317026"><span class="hs-identifier">wrap_fn</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684317027"><a href="#local-6989586621684317027"><span class="hs-identifier">work_fn</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-500"></a><span>        </span><a name="local-6989586621684317028"><a href="#local-6989586621684317028"><span class="hs-identifier">work_uniq</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getUniqueM</span><span>
</span><a name="line-501"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684317029"><a href="#local-6989586621684317029"><span class="hs-identifier">work_rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684317027"><span class="hs-identifier hs-var">work_fn</span></a><span> </span><a href="#local-6989586621684317013"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-502"></a><span>            </span><a name="local-6989586621684317030"><a href="#local-6989586621684317030"><span class="hs-identifier">work_act</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684317016"><span class="hs-identifier hs-var">fn_inline_spec</span></a><span> </span><span class="hs-keyword">of</span><span>  </span><span class="hs-comment">-- See Note [Worker activation]</span><span>
</span><a name="line-503"></a><span>                          </span><span class="hs-identifier hs-var">NoInline</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684317017"><span class="hs-identifier hs-var">fn_act</span></a><span>
</span><a name="line-504"></a><span>                          </span><span class="hs-identifier">_</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684317038"><span class="hs-identifier hs-var">wrap_act</span></a><span>
</span><a name="line-505"></a><span>
</span><a name="line-506"></a><span>            </span><a name="local-6989586621684317031"><a href="#local-6989586621684317031"><span class="hs-identifier">work_prag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">InlinePragma</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inl_src</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">SourceText</span><span> </span><span class="hs-string">&quot;{-# INLINE&quot;</span><span>
</span><a name="line-507"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inl_inline</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684317016"><span class="hs-identifier hs-var">fn_inline_spec</span></a><span>
</span><a name="line-508"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inl_sat</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-509"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inl_act</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684317030"><span class="hs-identifier hs-var">work_act</span></a><span>
</span><a name="line-510"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inl_rule</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">FunLike</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-511"></a><span>              </span><span class="hs-comment">-- inl_inline: copy from fn_id; see Note [Worker-wrapper for INLINABLE functions]</span><span>
</span><a name="line-512"></a><span>              </span><span class="hs-comment">-- inl_act:    see Note [Worker activation]</span><span>
</span><a name="line-513"></a><span>              </span><span class="hs-comment">-- inl_rule:   it does not make sense for workers to be constructorlike.</span><span>
</span><a name="line-514"></a><span>
</span><a name="line-515"></a><span>            </span><a name="local-6989586621684317032"><a href="#local-6989586621684317032"><span class="hs-identifier">work_join_arity</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isJoinId</span><span> </span><a href="#local-6989586621684317009"><span class="hs-identifier hs-var">fn_id</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621684317025"><span class="hs-identifier hs-var">join_arity</span></a><span>
</span><a name="line-516"></a><span>                            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-517"></a><span>              </span><span class="hs-comment">-- worker is join point iff wrapper is join point</span><span>
</span><a name="line-518"></a><span>              </span><span class="hs-comment">-- (see Note [Don't CPR join points])</span><span>
</span><a name="line-519"></a><span>
</span><a name="line-520"></a><span>            </span><a name="local-6989586621684317033"><a href="#local-6989586621684317033"><span class="hs-identifier">work_id</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkWorkerId</span><span> </span><a href="#local-6989586621684317028"><span class="hs-identifier hs-var">work_uniq</span></a><span> </span><a href="#local-6989586621684317009"><span class="hs-identifier hs-var">fn_id</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprType</span><span> </span><a href="#local-6989586621684317029"><span class="hs-identifier hs-var">work_rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-521"></a><span>                        </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setIdOccInfo</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">occInfo</span><span> </span><a href="#local-6989586621684317010"><span class="hs-identifier hs-var">fn_info</span></a><span>
</span><a name="line-522"></a><span>                                </span><span class="hs-comment">-- Copy over occurrence info from parent</span><span>
</span><a name="line-523"></a><span>                                </span><span class="hs-comment">-- Notably whether it's a loop breaker</span><span>
</span><a name="line-524"></a><span>                                </span><span class="hs-comment">-- Doesn't matter much, since we will simplify next, but</span><span>
</span><a name="line-525"></a><span>                                </span><span class="hs-comment">-- seems right-er to do so</span><span>
</span><a name="line-526"></a><span>
</span><a name="line-527"></a><span>                        </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setInlinePragma</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684317031"><span class="hs-identifier hs-var">work_prag</span></a><span>
</span><a name="line-528"></a><span>
</span><a name="line-529"></a><span>                        </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setIdUnfolding</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">mkWorkerUnfolding</span><span> </span><a href="#local-6989586621684317007"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684317027"><span class="hs-identifier hs-var">work_fn</span></a><span> </span><a href="#local-6989586621684317019"><span class="hs-identifier hs-var">fn_unfolding</span></a><span>
</span><a name="line-530"></a><span>                                </span><span class="hs-comment">-- See Note [Worker-wrapper for INLINABLE functions]</span><span>
</span><a name="line-531"></a><span>
</span><a name="line-532"></a><span>                        </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setIdStrictness</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">mkClosedStrictSig</span><span> </span><a href="#local-6989586621684317024"><span class="hs-identifier hs-var">work_demands</span></a><span> </span><a href="#local-6989586621684317022"><span class="hs-identifier hs-var">work_res_info</span></a><span>
</span><a name="line-533"></a><span>                                </span><span class="hs-comment">-- Even though we may not be at top level,</span><span>
</span><a name="line-534"></a><span>                                </span><span class="hs-comment">-- it's ok to give it an empty DmdEnv</span><span>
</span><a name="line-535"></a><span>
</span><a name="line-536"></a><span>                        </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setIdDemandInfo</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684317036"><span class="hs-identifier hs-var">worker_demand</span></a><span>
</span><a name="line-537"></a><span>
</span><a name="line-538"></a><span>                        </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setIdArity</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684317034"><span class="hs-identifier hs-var">work_arity</span></a><span>
</span><a name="line-539"></a><span>                                </span><span class="hs-comment">-- Set the arity so that the Core Lint check that the</span><span>
</span><a name="line-540"></a><span>                                </span><span class="hs-comment">-- arity is consistent with the demand type goes</span><span>
</span><a name="line-541"></a><span>                                </span><span class="hs-comment">-- through</span><span>
</span><a name="line-542"></a><span>                        </span><span class="hs-special">`</span><span class="hs-identifier hs-var">asJoinId_maybe</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684317032"><span class="hs-identifier hs-var">work_join_arity</span></a><span>
</span><a name="line-543"></a><span>
</span><a name="line-544"></a><span>            </span><a name="local-6989586621684317034"><a href="#local-6989586621684317034"><span class="hs-identifier">work_arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621684317024"><span class="hs-identifier hs-var">work_demands</span></a><span>
</span><a name="line-545"></a><span>
</span><a name="line-546"></a><span>            </span><span class="hs-comment">-- See Note [Demand on the Worker]</span><span>
</span><a name="line-547"></a><span>            </span><a name="local-6989586621684317035"><a href="#local-6989586621684317035"><span class="hs-identifier">single_call</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">saturatedByOneShots</span><span> </span><a href="#local-6989586621684317020"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">demandInfo</span><span> </span><a href="#local-6989586621684317010"><span class="hs-identifier hs-var">fn_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-548"></a><span>            </span><a name="local-6989586621684317036"><a href="#local-6989586621684317036"><span class="hs-identifier">worker_demand</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684317035"><span class="hs-identifier hs-var">single_call</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkWorkerDemand</span><span> </span><a href="#local-6989586621684317034"><span class="hs-identifier hs-var">work_arity</span></a><span>
</span><a name="line-549"></a><span>                          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">topDmd</span><span>
</span><a name="line-550"></a><span>
</span><a name="line-551"></a><span>            </span><a name="local-6989586621684317037"><a href="#local-6989586621684317037"><span class="hs-identifier">wrap_rhs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684317026"><span class="hs-identifier hs-var">wrap_fn</span></a><span> </span><a href="#local-6989586621684317033"><span class="hs-identifier hs-var">work_id</span></a><span>
</span><a name="line-552"></a><span>            </span><a name="local-6989586621684317038"><a href="#local-6989586621684317038"><span class="hs-identifier">wrap_act</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684317017"><span class="hs-identifier hs-var">fn_act</span></a><span> </span><span class="hs-keyword">of</span><span>  </span><span class="hs-comment">-- See Note [Wrapper activation]</span><span>
</span><a name="line-553"></a><span>                           </span><span class="hs-identifier hs-var">ActiveAfter</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684317017"><span class="hs-identifier hs-var">fn_act</span></a><span>
</span><a name="line-554"></a><span>                           </span><span class="hs-identifier hs-var">NeverActive</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">activeDuringFinal</span><span>
</span><a name="line-555"></a><span>                           </span><span class="hs-identifier">_</span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">activeAfterInitial</span><span>
</span><a name="line-556"></a><span>            </span><a name="local-6989586621684317039"><a href="#local-6989586621684317039"><span class="hs-identifier">wrap_prag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">InlinePragma</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inl_src</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">SourceText</span><span> </span><span class="hs-string">&quot;{-# INLINE&quot;</span><span>
</span><a name="line-557"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inl_inline</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NoUserInline</span><span>
</span><a name="line-558"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inl_sat</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-559"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inl_act</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684317038"><span class="hs-identifier hs-var">wrap_act</span></a><span>
</span><a name="line-560"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inl_rule</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684317018"><span class="hs-identifier hs-var">rule_match_info</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-561"></a><span>                </span><span class="hs-comment">-- inl_act:    see Note [Wrapper activation]</span><span>
</span><a name="line-562"></a><span>                </span><span class="hs-comment">-- inl_inline: see Note [Wrapper NoUserInline]</span><span>
</span><a name="line-563"></a><span>                </span><span class="hs-comment">-- inl_rule:   RuleMatchInfo is (and must be) unaffected</span><span>
</span><a name="line-564"></a><span>
</span><a name="line-565"></a><span>            </span><a name="local-6989586621684317040"><a href="#local-6989586621684317040"><span class="hs-identifier">wrap_id</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684317009"><span class="hs-identifier hs-var">fn_id</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setIdUnfolding</span><span class="hs-special">`</span><span>  </span><span class="hs-identifier hs-var">mkWwInlineRule</span><span> </span><a href="#local-6989586621684317007"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684317037"><span class="hs-identifier hs-var">wrap_rhs</span></a><span> </span><a href="#local-6989586621684317020"><span class="hs-identifier hs-var">arity</span></a><span>
</span><a name="line-566"></a><span>                              </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setInlinePragma</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684317039"><span class="hs-identifier hs-var">wrap_prag</span></a><span>
</span><a name="line-567"></a><span>                              </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setIdOccInfo</span><span class="hs-special">`</span><span>    </span><span class="hs-identifier hs-var">noOccInfo</span><span>
</span><a name="line-568"></a><span>                                </span><span class="hs-comment">-- Zap any loop-breaker-ness, to avoid bleating from Lint</span><span>
</span><a name="line-569"></a><span>                                </span><span class="hs-comment">-- about a loop breaker with an INLINE rule</span><span>
</span><a name="line-570"></a><span>
</span><a name="line-571"></a><span>
</span><a name="line-572"></a><span>
</span><a name="line-573"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621684317033"><span class="hs-identifier hs-var">work_id</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684317029"><span class="hs-identifier hs-var">work_rhs</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684317040"><span class="hs-identifier hs-var">wrap_id</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684317037"><span class="hs-identifier hs-var">wrap_rhs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-574"></a><span>            </span><span class="hs-comment">-- Worker first, because wrapper mentions it</span><span>
</span><a name="line-575"></a><span>
</span><a name="line-576"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621684317009"><span class="hs-identifier hs-var">fn_id</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684317013"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-577"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-578"></a><span>    </span><a name="local-6989586621684317014"><a href="#local-6989586621684317014"><span class="hs-identifier">rhs_fvs</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">exprFreeVars</span><span> </span><a href="#local-6989586621684317013"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-579"></a><span>    </span><a name="local-6989586621684317015"><a href="#local-6989586621684317015"><span class="hs-identifier">fn_inl_prag</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">inlinePragInfo</span><span> </span><a href="#local-6989586621684317010"><span class="hs-identifier hs-var">fn_info</span></a><span>
</span><a name="line-580"></a><span>    </span><a name="local-6989586621684317016"><a href="#local-6989586621684317016"><span class="hs-identifier">fn_inline_spec</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">inl_inline</span><span> </span><a href="#local-6989586621684317015"><span class="hs-identifier hs-var">fn_inl_prag</span></a><span>
</span><a name="line-581"></a><span>    </span><a name="local-6989586621684317017"><a href="#local-6989586621684317017"><span class="hs-identifier">fn_act</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">inl_act</span><span> </span><a href="#local-6989586621684317015"><span class="hs-identifier hs-var">fn_inl_prag</span></a><span>
</span><a name="line-582"></a><span>    </span><a name="local-6989586621684317018"><a href="#local-6989586621684317018"><span class="hs-identifier">rule_match_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">inlinePragmaRuleMatchInfo</span><span> </span><a href="#local-6989586621684317015"><span class="hs-identifier hs-var">fn_inl_prag</span></a><span>
</span><a name="line-583"></a><span>    </span><a name="local-6989586621684317019"><a href="#local-6989586621684317019"><span class="hs-identifier">fn_unfolding</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">unfoldingInfo</span><span> </span><a href="#local-6989586621684317010"><span class="hs-identifier hs-var">fn_info</span></a><span>
</span><a name="line-584"></a><span>    </span><a name="local-6989586621684317020"><a href="#local-6989586621684317020"><span class="hs-identifier">arity</span></a></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">arityInfo</span><span> </span><a href="#local-6989586621684317010"><span class="hs-identifier hs-var">fn_info</span></a><span>
</span><a name="line-585"></a><span>                    </span><span class="hs-comment">-- The arity is set by the simplifier using exprEtaExpandArity</span><span>
</span><a name="line-586"></a><span>                    </span><span class="hs-comment">-- So it may be more than the number of top-level-visible lambdas</span><span>
</span><a name="line-587"></a><span>
</span><a name="line-588"></a><span>    </span><a name="local-6989586621684317021"><a href="#local-6989586621684317021"><span class="hs-identifier">use_res_info</span></a></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isJoinId</span><span> </span><a href="#local-6989586621684317009"><span class="hs-identifier hs-var">fn_id</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">topRes</span><span> </span><span class="hs-comment">-- Note [Don't CPR join points]</span><span>
</span><a name="line-589"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684317012"><span class="hs-identifier hs-var">res_info</span></a><span>
</span><a name="line-590"></a><span>    </span><a name="local-6989586621684317022"><a href="#local-6989586621684317022"><span class="hs-identifier">work_res_info</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isJoinId</span><span> </span><a href="#local-6989586621684317009"><span class="hs-identifier hs-var">fn_id</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684317012"><span class="hs-identifier hs-var">res_info</span></a><span> </span><span class="hs-comment">-- Worker remains CPR-able</span><span>
</span><a name="line-591"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-592"></a><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">returnsCPR_maybe</span><span> </span><a href="#local-6989586621684317012"><span class="hs-identifier hs-var">res_info</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-593"></a><span>                       </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">topRes</span><span>    </span><span class="hs-comment">-- Cpr stuff done by wrapper; kill it here</span><span>
</span><a name="line-594"></a><span>                       </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684317012"><span class="hs-identifier hs-var">res_info</span></a><span>  </span><span class="hs-comment">-- Preserve exception/divergence</span><span>
</span><a name="line-595"></a><span>
</span><a name="line-596"></a><span>
</span><a name="line-597"></a><span class="hs-comment">{-
Note [Demand on the worker]
~~~~~~~~~~~~~~~~~~~~~~~~~~~

If the original function is called once, according to its demand info, then
so is the worker. This is important so that the occurrence analyser can
attach OneShot annotations to the worker&#8217;s lambda binders.


Example:

  -- Original function
  f [Demand=&lt;L,1*C1(U)&gt;] :: (a,a) -&gt; a
  f = \p -&gt; ...

  -- Wrapper
  f [Demand=&lt;L,1*C1(U)&gt;] :: a -&gt; a -&gt; a
  f = \p -&gt; case p of (a,b) -&gt; $wf a b

  -- Worker
  $wf [Demand=&lt;L,1*C1(C1(U))&gt;] :: Int -&gt; Int
  $wf = \a b -&gt; ...

We need to check whether the original function is called once, with
sufficiently many arguments. This is done using saturatedByOneShots, which
takes the arity of the original function (resp. the wrapper) and the demand on
the original function.

The demand on the worker is then calculated using mkWorkerDemand, and always of
the form [Demand=&lt;L,1*(C1(...(C1(U))))&gt;]


Note [Do not split void functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this rather common form of binding:
        $j = \x:Void# -&gt; ...no use of x...

Since x is not used it'll be marked as absent.  But there is no point
in w/w-ing because we'll simply add (\y:Void#), see WwLib.mkWorerArgs.

If x has a more interesting type (eg Int, or Int#), there *is* a point
in w/w so that we don't pass the argument at all.

Note [Thunk splitting]
~~~~~~~~~~~~~~~~~~~~~~
Suppose x is used strictly (never mind whether it has the CPR
property).

      let
        x* = x-rhs
      in body

splitThunk transforms like this:

      let
        x* = case x-rhs of { I# a -&gt; I# a }
      in body

Now simplifier will transform to

      case x-rhs of
        I# a -&gt; let x* = I# a
                in body

which is what we want. Now suppose x-rhs is itself a case:

        x-rhs = case e of { T -&gt; I# a; F -&gt; I# b }

The join point will abstract over a, rather than over (which is
what would have happened before) which is fine.

Notice that x certainly has the CPR property now!

In fact, splitThunk uses the function argument w/w splitting
function, so that if x's demand is deeper (say U(U(L,L),L))
then the splitting will go deeper too.
-}</span><span>
</span><a name="line-674"></a><span>
</span><a name="line-675"></a><span class="hs-comment">-- See Note [Thunk splitting]</span><span>
</span><a name="line-676"></a><span class="hs-comment">-- splitThunk converts the *non-recursive* binding</span><span>
</span><a name="line-677"></a><span class="hs-comment">--      x = e</span><span>
</span><a name="line-678"></a><span class="hs-comment">-- into</span><span>
</span><a name="line-679"></a><span class="hs-comment">--      x = let x = e</span><span>
</span><a name="line-680"></a><span class="hs-comment">--          in case x of</span><span>
</span><a name="line-681"></a><span class="hs-comment">--               I# y -&gt; let x = I# y in x }</span><span>
</span><a name="line-682"></a><span class="hs-comment">-- See comments above. Is it not beautifully short?</span><span>
</span><a name="line-683"></a><span class="hs-comment">-- Moreover, it works just as well when there are</span><span>
</span><a name="line-684"></a><span class="hs-comment">-- several binders, and if the binders are lifted</span><span>
</span><a name="line-685"></a><span class="hs-comment">-- E.g.     x = e</span><span>
</span><a name="line-686"></a><span class="hs-comment">--     --&gt;  x = let x = e in</span><span>
</span><a name="line-687"></a><span class="hs-comment">--              case x of (a,b) -&gt; let x = (a,b)  in x</span><span>
</span><a name="line-688"></a><span>
</span><a name="line-689"></a><span class="hs-identifier">splitThunk</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FamInstEnvs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RecFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Var</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Expr</span><span> </span><span class="hs-identifier hs-type">Var</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Var</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Expr</span><span> </span><span class="hs-identifier hs-type">Var</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-690"></a><a name="splitThunk"><a href="WorkWrap.html#splitThunk"><span class="hs-identifier">splitThunk</span></a></a><span> </span><a name="local-6989586621684317041"><a href="#local-6989586621684317041"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684317042"><a href="#local-6989586621684317042"><span class="hs-identifier">fam_envs</span></a></a><span> </span><a name="local-6989586621684317043"><a href="#local-6989586621684317043"><span class="hs-identifier">is_rec</span></a></a><span> </span><a name="local-6989586621684317044"><a href="#local-6989586621684317044"><span class="hs-identifier">fn_id</span></a></a><span> </span><a name="local-6989586621684317045"><a href="#local-6989586621684317045"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-691"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isJoinId</span><span> </span><span class="hs-identifier">fn_id</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-692"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684317046"><a href="#local-6989586621684317046"><span class="hs-identifier">useful</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684317047"><a href="#local-6989586621684317047"><span class="hs-identifier">wrap_fn</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684317048"><a href="#local-6989586621684317048"><span class="hs-identifier">work_fn</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="WwLib.html#mkWWstr"><span class="hs-identifier hs-var">mkWWstr</span></a><span> </span><a href="#local-6989586621684317041"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684317042"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684317044"><span class="hs-identifier hs-var">fn_id</span></a><span class="hs-special">]</span><span>
</span><a name="line-693"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684317049"><a href="#local-6989586621684317049"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684317044"><span class="hs-identifier hs-var">fn_id</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621684317044"><span class="hs-identifier hs-var">fn_id</span></a><span> </span><a href="#local-6989586621684317045"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684317047"><span class="hs-identifier hs-var">wrap_fn</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684317048"><span class="hs-identifier hs-var">work_fn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684317044"><span class="hs-identifier hs-var">fn_id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-694"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621684317046"><span class="hs-identifier hs-var">useful</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isNonRec</span><span> </span><span class="hs-identifier">is_rec</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-identifier">fn_id</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- The thunk must be non-recursive</span><span>
</span><a name="line-695"></a><span>                   </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684317049"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-696"></a><span>                   </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621684317044"><span class="hs-identifier hs-var">fn_id</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684317045"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-697"></a></pre></body></html>