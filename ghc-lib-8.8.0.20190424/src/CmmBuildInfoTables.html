<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE GADTs, BangPatterns, RecordWildCards,
    GeneralizedNewtypeDeriving, NondecreasingIndentation, TupleSections #-}</span><span>
</span><a name="line-3"></a><span>
</span><a name="line-4"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">CmmBuildInfoTables</span><span>
</span><a name="line-5"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="CmmBuildInfoTables.html#CAFSet"><span class="hs-identifier hs-type">CAFSet</span></a><span class="hs-special">,</span><span> </span><a href="CmmBuildInfoTables.html#CAFEnv"><span class="hs-identifier hs-type">CAFEnv</span></a><span class="hs-special">,</span><span> </span><a href="CmmBuildInfoTables.html#cafAnal"><span class="hs-identifier hs-var">cafAnal</span></a><span>
</span><a name="line-6"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="CmmBuildInfoTables.html#doSRTs"><span class="hs-identifier hs-var">doSRTs</span></a><span class="hs-special">,</span><span> </span><a href="CmmBuildInfoTables.html#ModuleSRTInfo"><span class="hs-identifier hs-type">ModuleSRTInfo</span></a><span class="hs-special">,</span><span> </span><a href="CmmBuildInfoTables.html#emptySRT"><span class="hs-identifier hs-var">emptySRT</span></a><span>
</span><a name="line-7"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">succ</span><span class="hs-special">)</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><a href="BlockId.html"><span class="hs-identifier">BlockId</span></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Block.html"><span class="hs-identifier">Hoopl.Block</span></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Graph.html"><span class="hs-identifier">Hoopl.Graph</span></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Label.html"><span class="hs-identifier">Hoopl.Label</span></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Collections.html"><span class="hs-identifier">Hoopl.Collections</span></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Dataflow.html"><span class="hs-identifier">Hoopl.Dataflow</span></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Platform</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Digraph</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="CLabel.html"><span class="hs-identifier">CLabel</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="PprCmmDecl.html"><span class="hs-identifier">PprCmmDecl</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="Cmm.html"><span class="hs-identifier">Cmm</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="CmmUtils.html"><span class="hs-identifier">CmmUtils</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="SMRep.html"><span class="hs-identifier">SMRep</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSupply</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CostCentre</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmHeap.html"><span class="hs-identifier">StgCmmHeap</span></a><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="PprCmm.html"><span class="hs-identifier">PprCmm</span></a><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Set</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Tuple</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Trans.State</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Trans.Class</span><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span>
</span><a name="line-44"></a><span class="hs-comment">{- Note [SRTs]

SRTs are the mechanism by which the garbage collector can determine
the live CAFs in the program.

Representation
^^^^^^^^^^^^^^

+------+
| info |
|      |     +-----+---+---+---+
|   --------&gt;|SRT_2| | | | | 0 |
|------|     +-----+-|-+-|-+---+
|      |             |   |
| code |             |   |
|      |             v   v

An SRT is simply an object in the program's data segment. It has the
same representation as a static constructor.  There are 16
pre-compiled SRT info tables: stg_SRT_1_info, .. stg_SRT_16_info,
representing SRT objects with 1-16 pointers, respectively.

The entries of an SRT object point to static closures, which are either
- FUN_STATIC, THUNK_STATIC or CONSTR
- Another SRT (actually just a CONSTR)

The final field of the SRT is the static link field, used by the
garbage collector to chain together static closures that it visits and
to determine whether a static closure has been visited or not. (see
Note [STATIC_LINK fields])

By traversing the transitive closure of an SRT, the GC will reach all
of the CAFs that are reachable from the code associated with this SRT.

If we need to create an SRT with more than 16 entries, we build a
chain of SRT objects with all but the last having 16 entries.

+-----+---+- -+---+---+
|SRT16| | |   | | | 0 |
+-----+-|-+- -+-|-+---+
        |       |
        v       v
              +----+---+---+---+
              |SRT2| | | | | 0 |
              +----+-|-+-|-+---+
                     |   |
                     |   |
                     v   v

Referring to an SRT from the info table
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

The following things have SRTs:

- Static functions (FUN)
- Static thunks (THUNK), ie. CAFs
- Continuations (RET_SMALL, etc.)

In each case, the info table points to the SRT.

- info-&gt;srt is zero if there's no SRT, otherwise:
- info-&gt;srt == 1 and info-&gt;f.srt_offset points to the SRT

e.g. for a FUN with an SRT:

StgFunInfoTable       +------+
  info-&gt;f.srt_offset  |  ------------&gt; offset to SRT object
StgStdInfoTable       +------+
  info-&gt;layout.ptrs   | ...  |
  info-&gt;layout.nptrs  | ...  |
  info-&gt;srt           |  1   |
  info-&gt;type          | ...  |
                      |------|

On x86_64, we optimise the info table representation further.  The
offset to the SRT can be stored in 32 bits (all code lives within a
2GB region in x86_64's small memory model), so we can save a word in
the info table by storing the srt_offset in the srt field, which is
half a word.

On x86_64 with TABLES_NEXT_TO_CODE (except on MachO, due to #15169):

- info-&gt;srt is zero if there's no SRT, otherwise:
- info-&gt;srt is an offset from the info pointer to the SRT object

StgStdInfoTable       +------+
  info-&gt;layout.ptrs   |      |
  info-&gt;layout.nptrs  |      |
  info-&gt;srt           |  ------------&gt; offset to SRT object
                      |------|


EXAMPLE
^^^^^^^

f = \x. ... g ...
  where
    g = \y. ... h ... c1 ...
    h = \z. ... c2 ...

c1 &amp; c2 are CAFs

g and h are local functions, but they have no static closures.  When
we generate code for f, we start with a CmmGroup of four CmmDecls:

   [ f_closure, f_entry, g_entry, h_entry ]

we process each CmmDecl separately in cpsTop, giving us a list of
CmmDecls. e.g. for f_entry, we might end up with

   [ f_entry, f1_ret, f2_proc ]

where f1_ret is a return point, and f2_proc is a proc-point.  We have
a CAFSet for each of these CmmDecls, let's suppose they are

   [ f_entry{g_info}, f1_ret{g_info}, f2_proc{} ]
   [ g_entry{h_info, c1_closure} ]
   [ h_entry{c2_closure} ]

Next, we make an SRT for each of these functions:

  f_srt : [g_info]
  g_srt : [h_info, c1_closure]
  h_srt : [c2_closure]

Now, for g_info and h_info, we want to refer to the SRTs for g and h
respectively, which we'll label g_srt and h_srt:

  f_srt : [g_srt]
  g_srt : [h_srt, c1_closure]
  h_srt : [c2_closure]

Now, when an SRT has a single entry, we don't actually generate an SRT
closure for it, instead we just replace references to it with its
single element.  So, since h_srt == c2_closure, we have

  f_srt : [g_srt]
  g_srt : [c2_closure, c1_closure]
  h_srt : [c2_closure]

and the only SRT closure we generate is

  g_srt = SRT_2 [c2_closure, c1_closure]


Optimisations
^^^^^^^^^^^^^

To reduce the code size overhead and the cost of traversing SRTs in
the GC, we want to simplify SRTs where possible. We therefore apply
the following optimisations.  Each has a [keyword]; search for the
keyword in the code below to see where the optimisation is
implemented.

1. [Inline] we never create an SRT with a single entry, instead we
   point to the single entry directly from the info table.

   i.e. instead of

    +------+
    | info |
    |      |     +-----+---+---+
    |   --------&gt;|SRT_1| | | 0 |
    |------|     +-----+-|-+---+
    |      |             |
    | code |             |
    |      |             v
                         C

   we can point directly to the closure:

    +------+
    | info |
    |      |
    |   --------&gt;C
    |------|
    |      |
    | code |
    |      |


   Furthermore, the SRT for any code that refers to this info table
   can point directly to C.

   The exception to this is when we're doing dynamic linking. In that
   case, if the closure is not locally defined then we can't point to
   it directly from the info table, because this is the text section
   which cannot contain runtime relocations. In this case we skip this
   optimisation and generate the singleton SRT, becase SRTs are in the
   data section and *can* have relocatable references.

2. [FUN] A static function closure can also be an SRT, we simply put
   the SRT entries as fields in the static closure.  This makes a lot
   of sense: the static references are just like the free variables of
   the FUN closure.

   i.e. instead of

   f_closure:
   +-----+---+
   |  |  | 0 |
   +- |--+---+
      |            +------+
      |            | info |     f_srt:
      |            |      |     +-----+---+---+---+
      |            |   --------&gt;|SRT_2| | | | + 0 |
      `-----------&gt;|------|     +-----+-|-+-|-+---+
                   |      |             |   |
                   | code |             |   |
                   |      |             v   v


   We can generate:

   f_closure:
   +-----+---+---+---+
   |  |  | | | | | 0 |
   +- |--+-|-+-|-+---+
      |    |   |   +------+
      |    v   v   | info |
      |            |      |
      |            |   0  |
      `-----------&gt;|------|
                   |      |
                   | code |
                   |      |


   (note: we can't do this for THUNKs, because the thunk gets
   overwritten when it is entered, so we wouldn't be able to share
   this SRT with other info tables that want to refer to it (see
   [Common] below). FUNs are immutable so don't have this problem.)

3. [Common] Identical SRTs can be commoned up.

4. [Filter] If an SRT A refers to an SRT B and a closure C, and B also
   refers to C (perhaps transitively), then we can omit the reference
   to C from A.


Note that there are many other optimisations that we could do, but
aren't implemented. In general, we could omit any reference from an
SRT if everything reachable from it is also reachable from the other
fields in the SRT. Our [Filter] optimisation is a special case of
this.

Another opportunity we don't exploit is this:

A = {X,Y,Z}
B = {Y,Z}
C = {X,B}

Here we could use C = {A} and therefore [Inline] C = A.
-}</span><span>
</span><a name="line-298"></a><span>
</span><a name="line-299"></a><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><a name="line-300"></a><span class="hs-comment">{- Note [Invalid optimisation: shortcutting]

You might think that if we have something like

A's SRT = {B}
B's SRT = {X}

that we could replace the reference to B in A's SRT with X.

A's SRT = {X}
B's SRT = {X}

and thereby perhaps save a little work at runtime, because we don't
have to visit B.

But this is NOT valid.

Consider these cases:

0. B can't be a constructor, because constructors don't have SRTs

1. B is a CAF. This is the easy one. Obviously we want A's SRT to
   point to B, so that it keeps B alive.

2. B is a function.  This is the tricky one. The reason we can't
shortcut in this case is that we aren't allowed to resurrect static
objects.

== How does this cause a problem? ==

The particular case that cropped up when we tried this was #15544.
- A is a thunk
- B is a static function
- X is a CAF
- suppose we GC when A is alive, and B is not otherwise reachable.
- B is &quot;collected&quot;, meaning that it doesn't make it onto the static
  objects list during this GC, but nothing bad happens yet.
- Next, suppose we enter A, and then call B. (remember that A refers to B)
  At the entry point to B, we GC. This puts B on the stack, as part of the
  RET_FUN stack frame that gets pushed when we GC at a function entry point.
- This GC will now reach B
- But because B was previous &quot;collected&quot;, it breaks the assumption
  that static objects are never resurrected. See Note [STATIC_LINK
  fields] in rts/sm/Storage.h for why this is bad.
- In practice, the GC thinks that B has already been visited, and so
  doesn't visit X, and catastrophe ensues.

== Isn't this caused by the RET_FUN business? ==

Maybe, but could you prove that RET_FUN is the only way that
resurrection can occur?

So, no shortcutting.
-}</span><span>
</span><a name="line-354"></a><span>
</span><a name="line-355"></a><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><a name="line-356"></a><span class="hs-comment">-- Label types</span><span>
</span><a name="line-357"></a><span>
</span><a name="line-358"></a><span class="hs-comment">-- Labels that come from cafAnal can be:</span><span>
</span><a name="line-359"></a><span class="hs-comment">--   - _closure labels for static functions or CAFs</span><span>
</span><a name="line-360"></a><span class="hs-comment">--   - _info labels for dynamic functions, thunks, or continuations</span><span>
</span><a name="line-361"></a><span class="hs-comment">--   - _entry labels for functions or thunks</span><span>
</span><a name="line-362"></a><span class="hs-comment">--</span><span>
</span><a name="line-363"></a><span class="hs-comment">-- Meanwhile the labels on top-level blocks are _entry labels.</span><span>
</span><a name="line-364"></a><span class="hs-comment">--</span><span>
</span><a name="line-365"></a><span class="hs-comment">-- To put everything in the same namespace we convert all labels to</span><span>
</span><a name="line-366"></a><span class="hs-comment">-- closure labels using toClosureLbl.  Note that some of these</span><span>
</span><a name="line-367"></a><span class="hs-comment">-- labels will not actually exist; that's ok because we're going to</span><span>
</span><a name="line-368"></a><span class="hs-comment">-- map them to SRTEntry later, which ranges over labels that do exist.</span><span>
</span><a name="line-369"></a><span class="hs-comment">--</span><span>
</span><a name="line-370"></a><span class="hs-keyword">newtype</span><span> </span><a name="CAFLabel"><a href="CmmBuildInfoTables.html#CAFLabel"><span class="hs-identifier">CAFLabel</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="CAFLabel"><a href="CmmBuildInfoTables.html#CAFLabel"><span class="hs-identifier">CAFLabel</span></a></a><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span>
</span><a name="line-371"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Outputable</span><span class="hs-special">)</span><span>
</span><a name="line-372"></a><span>
</span><a name="line-373"></a><span class="hs-keyword">type</span><span> </span><a name="CAFSet"><a href="CmmBuildInfoTables.html#CAFSet"><span class="hs-identifier">CAFSet</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Set</span><span> </span><a href="CmmBuildInfoTables.html#CAFLabel"><span class="hs-identifier hs-type">CAFLabel</span></a><span>
</span><a name="line-374"></a><span class="hs-keyword">type</span><span> </span><a name="CAFEnv"><a href="CmmBuildInfoTables.html#CAFEnv"><span class="hs-identifier">CAFEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CmmBuildInfoTables.html#CAFSet"><span class="hs-identifier hs-type">CAFSet</span></a><span>
</span><a name="line-375"></a><span>
</span><a name="line-376"></a><span class="hs-identifier">mkCAFLabel</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmBuildInfoTables.html#CAFLabel"><span class="hs-identifier hs-type">CAFLabel</span></a><span>
</span><a name="line-377"></a><a name="mkCAFLabel"><a href="CmmBuildInfoTables.html#mkCAFLabel"><span class="hs-identifier">mkCAFLabel</span></a></a><span> </span><a name="local-6989586621680948699"><a href="#local-6989586621680948699"><span class="hs-identifier">lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmBuildInfoTables.html#CAFLabel"><span class="hs-identifier hs-var">CAFLabel</span></a><span> </span><span class="hs-special">(</span><a href="CLabel.html#toClosureLbl"><span class="hs-identifier hs-var">toClosureLbl</span></a><span> </span><a href="#local-6989586621680948699"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-378"></a><span>
</span><a name="line-379"></a><span class="hs-comment">-- This is a label that we can put in an SRT.  It *must* be a closure label,</span><span>
</span><a name="line-380"></a><span class="hs-comment">-- pointing to either a FUN_STATIC, THUNK_STATIC, or CONSTR.</span><span>
</span><a name="line-381"></a><span class="hs-keyword">newtype</span><span> </span><a name="SRTEntry"><a href="CmmBuildInfoTables.html#SRTEntry"><span class="hs-identifier">SRTEntry</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="SRTEntry"><a href="CmmBuildInfoTables.html#SRTEntry"><span class="hs-identifier">SRTEntry</span></a></a><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span>
</span><a name="line-382"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span class="hs-special">)</span><span>
</span><a name="line-383"></a><span>
</span><a name="line-384"></a><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><a name="line-385"></a><span class="hs-comment">-- CAF analysis</span><span>
</span><a name="line-386"></a><span>
</span><a name="line-387"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-388"></a><span class="hs-comment">-- For each code block:</span><span>
</span><a name="line-389"></a><span class="hs-comment">--   - collect the references reachable from this code block to FUN,</span><span>
</span><a name="line-390"></a><span class="hs-comment">--     THUNK or RET labels for which hasCAF == True</span><span>
</span><a name="line-391"></a><span class="hs-comment">--</span><span>
</span><a name="line-392"></a><span class="hs-comment">-- This gives us a `CAFEnv`: a mapping from code block to sets of labels</span><span>
</span><a name="line-393"></a><span class="hs-comment">--</span><span>
</span><a name="line-394"></a><span class="hs-identifier">cafAnal</span><span>
</span><a name="line-395"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a><span>   </span><span class="hs-comment">-- The blocks representing continuations, ie. those</span><span>
</span><a name="line-396"></a><span>                </span><span class="hs-comment">-- that will get RET info tables.  These labels will</span><span>
</span><a name="line-397"></a><span>                </span><span class="hs-comment">-- get their own SRTs, so we don't aggregate CAFs from</span><span>
</span><a name="line-398"></a><span>                </span><span class="hs-comment">-- references to these labels, we just use the label.</span><span>
</span><a name="line-399"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span>     </span><span class="hs-comment">-- The top label of the proc</span><span>
</span><a name="line-400"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#CmmGraph"><span class="hs-identifier hs-type">CmmGraph</span></a><span>
</span><a name="line-401"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmBuildInfoTables.html#CAFEnv"><span class="hs-identifier hs-type">CAFEnv</span></a><span>
</span><a name="line-402"></a><a name="cafAnal"><a href="CmmBuildInfoTables.html#cafAnal"><span class="hs-identifier">cafAnal</span></a></a><span> </span><a name="local-6989586621680948700"><a href="#local-6989586621680948700"><span class="hs-identifier">contLbls</span></a></a><span> </span><a name="local-6989586621680948701"><a href="#local-6989586621680948701"><span class="hs-identifier">topLbl</span></a></a><span> </span><a name="local-6989586621680948702"><a href="#local-6989586621680948702"><span class="hs-identifier">cmmGraph</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-403"></a><span>  </span><a href="Hoopl.Dataflow.html#analyzeCmmBwd"><span class="hs-identifier hs-var">analyzeCmmBwd</span></a><span> </span><a href="CmmBuildInfoTables.html#cafLattice"><span class="hs-identifier hs-var">cafLattice</span></a><span>
</span><a name="line-404"></a><span>    </span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#cafTransfers"><span class="hs-identifier hs-var">cafTransfers</span></a><span> </span><a href="#local-6989586621680948700"><span class="hs-identifier hs-var">contLbls</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">g_entry</span><span> </span><a href="#local-6989586621680948702"><span class="hs-identifier hs-var">cmmGraph</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680948701"><span class="hs-identifier hs-var">topLbl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680948702"><span class="hs-identifier hs-var">cmmGraph</span></a><span> </span><a href="Hoopl.Collections.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a><span>
</span><a name="line-405"></a><span>
</span><a name="line-406"></a><span>
</span><a name="line-407"></a><span class="hs-identifier">cafLattice</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Dataflow.html#DataflowLattice"><span class="hs-identifier hs-type">DataflowLattice</span></a><span> </span><a href="CmmBuildInfoTables.html#CAFSet"><span class="hs-identifier hs-type">CAFSet</span></a><span>
</span><a name="line-408"></a><a name="cafLattice"><a href="CmmBuildInfoTables.html#cafLattice"><span class="hs-identifier">cafLattice</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Dataflow.html#DataflowLattice"><span class="hs-identifier hs-var">DataflowLattice</span></a><span> </span><span class="hs-identifier hs-var">Set.empty</span><span> </span><a href="#local-6989586621680948703"><span class="hs-identifier hs-var">add</span></a><span>
</span><a name="line-409"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-410"></a><span>    </span><a name="local-6989586621680948703"><a href="#local-6989586621680948703"><span class="hs-identifier">add</span></a></a><span> </span><span class="hs-special">(</span><a href="Hoopl.Dataflow.html#OldFact"><span class="hs-identifier hs-var">OldFact</span></a><span> </span><a name="local-6989586621680948704"><a href="#local-6989586621680948704"><span class="hs-identifier">old</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Dataflow.html#NewFact"><span class="hs-identifier hs-var">NewFact</span></a><span> </span><a name="local-6989586621680948705"><a href="#local-6989586621680948705"><span class="hs-identifier">new</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-411"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621680948706"><a href="#local-6989586621680948706"><span class="hs-identifier">new'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680948704"><span class="hs-identifier hs-var">old</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Set.union</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680948705"><span class="hs-identifier hs-var">new</span></a><span>
</span><a name="line-412"></a><span>        </span><span class="hs-keyword">in</span><span> </span><a href="Hoopl.Dataflow.html#changedIf"><span class="hs-identifier hs-var">changedIf</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.size</span><span> </span><a href="#local-6989586621680948706"><span class="hs-identifier hs-var">new'</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-identifier hs-var">Set.size</span><span> </span><a href="#local-6989586621680948704"><span class="hs-identifier hs-var">old</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680948706"><span class="hs-identifier hs-var">new'</span></a><span>
</span><a name="line-413"></a><span>
</span><a name="line-414"></a><span>
</span><a name="line-415"></a><span class="hs-identifier">cafTransfers</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Dataflow.html#TransferFun"><span class="hs-identifier hs-type">TransferFun</span></a><span> </span><a href="CmmBuildInfoTables.html#CAFSet"><span class="hs-identifier hs-type">CAFSet</span></a><span>
</span><a name="line-416"></a><a name="cafTransfers"><a href="CmmBuildInfoTables.html#cafTransfers"><span class="hs-identifier">cafTransfers</span></a></a><span> </span><a name="local-6989586621680948707"><a href="#local-6989586621680948707"><span class="hs-identifier">contLbls</span></a></a><span> </span><a name="local-6989586621680948708"><a href="#local-6989586621680948708"><span class="hs-identifier">entry</span></a></a><span> </span><a name="local-6989586621680948709"><a href="#local-6989586621680948709"><span class="hs-identifier">topLbl</span></a></a><span>
</span><a name="line-417"></a><span>  </span><span class="hs-special">(</span><a href="Hoopl.Block.html#BlockCC"><span class="hs-identifier hs-var">BlockCC</span></a><span> </span><a name="local-6989586621680948710"><a href="#local-6989586621680948710"><span class="hs-identifier">eNode</span></a></a><span> </span><a name="local-6989586621680948711"><a href="#local-6989586621680948711"><span class="hs-identifier">middle</span></a></a><span> </span><a name="local-6989586621680948712"><a href="#local-6989586621680948712"><span class="hs-identifier">xNode</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680948713"><a href="#local-6989586621680948713"><span class="hs-identifier">fBase</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-418"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680948714"><a href="#local-6989586621680948714"><span class="hs-identifier">joined</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680948719"><span class="hs-identifier hs-var">cafsInNode</span></a><span> </span><a href="#local-6989586621680948712"><span class="hs-identifier hs-var">xNode</span></a><span> </span><span class="hs-operator hs-var">$!</span><span> </span><a href="#local-6989586621680948717"><span class="hs-identifier hs-var">live'</span></a><span>
</span><a name="line-419"></a><span>        </span><span class="hs-glyph">!</span><a name="local-6989586621680948715"><a href="#local-6989586621680948715"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Dataflow.html#foldNodesBwdOO"><span class="hs-identifier hs-var">foldNodesBwdOO</span></a><span> </span><a href="#local-6989586621680948719"><span class="hs-identifier hs-var">cafsInNode</span></a><span> </span><a href="#local-6989586621680948711"><span class="hs-identifier hs-var">middle</span></a><span> </span><a href="#local-6989586621680948714"><span class="hs-identifier hs-var">joined</span></a><span>
</span><a name="line-420"></a><span>
</span><a name="line-421"></a><span>        </span><a name="local-6989586621680948716"><a href="#local-6989586621680948716"><span class="hs-identifier">facts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><a href="#local-6989586621680948718"><span class="hs-identifier hs-var">successorFact</span></a><span> </span><span class="hs-special">(</span><a href="Hoopl.Graph.html#successors"><span class="hs-identifier hs-var">successors</span></a><span> </span><a href="#local-6989586621680948712"><span class="hs-identifier hs-var">xNode</span></a><span class="hs-special">)</span><span>
</span><a name="line-422"></a><span>        </span><a name="local-6989586621680948717"><a href="#local-6989586621680948717"><span class="hs-identifier">live'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Dataflow.html#joinFacts"><span class="hs-identifier hs-var">joinFacts</span></a><span> </span><a href="CmmBuildInfoTables.html#cafLattice"><span class="hs-identifier hs-var">cafLattice</span></a><span> </span><a href="#local-6989586621680948716"><span class="hs-identifier hs-var">facts</span></a><span>
</span><a name="line-423"></a><span>
</span><a name="line-424"></a><span>        </span><a name="local-6989586621680948718"><a href="#local-6989586621680948718"><span class="hs-identifier">successorFact</span></a></a><span> </span><a name="local-6989586621680948724"><a href="#local-6989586621680948724"><span class="hs-identifier">s</span></a></a><span>
</span><a name="line-425"></a><span>          </span><span class="hs-comment">-- If this is a loop back to the entry, we can refer to the</span><span>
</span><a name="line-426"></a><span>          </span><span class="hs-comment">-- entry label.</span><span>
</span><a name="line-427"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680948724"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680948708"><span class="hs-identifier hs-var">entry</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680948721"><span class="hs-identifier hs-var">add</span></a><span> </span><a href="#local-6989586621680948709"><span class="hs-identifier hs-var">topLbl</span></a><span> </span><span class="hs-identifier hs-var">Set.empty</span><span class="hs-special">)</span><span>
</span><a name="line-428"></a><span>          </span><span class="hs-comment">-- If this is a continuation, we want to refer to the</span><span>
</span><a name="line-429"></a><span>          </span><span class="hs-comment">-- SRT for the continuation's info table</span><span>
</span><a name="line-430"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680948724"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">`</span><a href="Hoopl.Collections.html#setMember"><span class="hs-identifier hs-var">setMember</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680948707"><span class="hs-identifier hs-var">contLbls</span></a><span>
</span><a name="line-431"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.singleton</span><span> </span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#mkCAFLabel"><span class="hs-identifier hs-var">mkCAFLabel</span></a><span> </span><span class="hs-special">(</span><a href="BlockId.html#infoTblLbl"><span class="hs-identifier hs-var">infoTblLbl</span></a><span> </span><a href="#local-6989586621680948724"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-432"></a><span>          </span><span class="hs-comment">-- Otherwise, takes the CAF references from the destination</span><span>
</span><a name="line-433"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-434"></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Label.html#lookupFact"><span class="hs-identifier hs-var">lookupFact</span></a><span> </span><a href="#local-6989586621680948724"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621680948713"><span class="hs-identifier hs-var">fBase</span></a><span>
</span><a name="line-435"></a><span>
</span><a name="line-436"></a><span>        </span><span class="hs-identifier">cafsInNode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="#local-6989586621680948722"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621680948723"><span class="hs-identifier hs-type">x</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmBuildInfoTables.html#CAFSet"><span class="hs-identifier hs-type">CAFSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmBuildInfoTables.html#CAFSet"><span class="hs-identifier hs-type">CAFSet</span></a><span>
</span><a name="line-437"></a><span>        </span><a name="local-6989586621680948719"><a href="#local-6989586621680948719"><span class="hs-identifier">cafsInNode</span></a></a><span> </span><a name="local-6989586621680948725"><a href="#local-6989586621680948725"><span class="hs-identifier">node</span></a></a><span> </span><a name="local-6989586621680948726"><a href="#local-6989586621680948726"><span class="hs-identifier">set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#foldExpDeep"><span class="hs-identifier hs-var">foldExpDeep</span></a><span> </span><a href="#local-6989586621680948720"><span class="hs-identifier hs-var">addCaf</span></a><span> </span><a href="#local-6989586621680948725"><span class="hs-identifier hs-var">node</span></a><span> </span><a href="#local-6989586621680948726"><span class="hs-identifier hs-var">set</span></a><span>
</span><a name="line-438"></a><span>
</span><a name="line-439"></a><span>        </span><a name="local-6989586621680948720"><a href="#local-6989586621680948720"><span class="hs-identifier">addCaf</span></a></a><span> </span><a name="local-6989586621680948727"><a href="#local-6989586621680948727"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621680948728"><a href="#local-6989586621680948728"><span class="hs-identifier">set</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-440"></a><span>          </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680948727"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-441"></a><span>              </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLabel"><span class="hs-identifier hs-var">CmmLabel</span></a><span> </span><a name="local-6989586621680948729"><a href="#local-6989586621680948729"><span class="hs-identifier">c</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680948721"><span class="hs-identifier hs-var">add</span></a><span> </span><a href="#local-6989586621680948729"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-6989586621680948728"><span class="hs-identifier hs-var">set</span></a><span>
</span><a name="line-442"></a><span>              </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLabelOff"><span class="hs-identifier hs-var">CmmLabelOff</span></a><span> </span><a name="local-6989586621680948730"><a href="#local-6989586621680948730"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680948721"><span class="hs-identifier hs-var">add</span></a><span> </span><a href="#local-6989586621680948730"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-6989586621680948728"><span class="hs-identifier hs-var">set</span></a><span>
</span><a name="line-443"></a><span>              </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLabelDiffOff"><span class="hs-identifier hs-var">CmmLabelDiffOff</span></a><span> </span><a name="local-6989586621680948731"><a href="#local-6989586621680948731"><span class="hs-identifier">c1</span></a></a><span> </span><a name="local-6989586621680948732"><a href="#local-6989586621680948732"><span class="hs-identifier">c2</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680948721"><span class="hs-identifier hs-var">add</span></a><span> </span><a href="#local-6989586621680948731"><span class="hs-identifier hs-var">c1</span></a><span> </span><span class="hs-operator hs-var">$!</span><span> </span><a href="#local-6989586621680948721"><span class="hs-identifier hs-var">add</span></a><span> </span><a href="#local-6989586621680948732"><span class="hs-identifier hs-var">c2</span></a><span> </span><a href="#local-6989586621680948728"><span class="hs-identifier hs-var">set</span></a><span>
</span><a name="line-444"></a><span>              </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680948728"><span class="hs-identifier hs-var">set</span></a><span>
</span><a name="line-445"></a><span>        </span><a name="local-6989586621680948721"><a href="#local-6989586621680948721"><span class="hs-identifier">add</span></a></a><span> </span><a name="local-6989586621680948733"><a href="#local-6989586621680948733"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621680948734"><a href="#local-6989586621680948734"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="CLabel.html#hasCAF"><span class="hs-identifier hs-var">hasCAF</span></a><span> </span><a href="#local-6989586621680948733"><span class="hs-identifier hs-var">l</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.insert</span><span> </span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#mkCAFLabel"><span class="hs-identifier hs-var">mkCAFLabel</span></a><span> </span><a href="#local-6989586621680948733"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680948734"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-446"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680948734"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-447"></a><span>
</span><a name="line-448"></a><span>    </span><span class="hs-keyword">in</span><span> </span><a href="Hoopl.Collections.html#mapSingleton"><span class="hs-identifier hs-var">mapSingleton</span></a><span> </span><span class="hs-special">(</span><a href="Hoopl.Graph.html#entryLabel"><span class="hs-identifier hs-var">entryLabel</span></a><span> </span><a href="#local-6989586621680948710"><span class="hs-identifier hs-var">eNode</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680948715"><span class="hs-identifier hs-var">result</span></a><span>
</span><a name="line-449"></a><span>
</span><a name="line-450"></a><span>
</span><a name="line-451"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-452"></a><span class="hs-comment">-- ModuleSRTInfo</span><span>
</span><a name="line-453"></a><span>
</span><a name="line-454"></a><span class="hs-keyword">data</span><span> </span><a name="ModuleSRTInfo"><a href="CmmBuildInfoTables.html#ModuleSRTInfo"><span class="hs-identifier">ModuleSRTInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="ModuleSRTInfo"><a href="CmmBuildInfoTables.html#ModuleSRTInfo"><span class="hs-identifier">ModuleSRTInfo</span></a></a><span>
</span><a name="line-455"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="thisModule"><a href="CmmBuildInfoTables.html#thisModule"><span class="hs-identifier">thisModule</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Module</span><span>
</span><a name="line-456"></a><span>    </span><span class="hs-comment">-- ^ Current module being compiled. Required for calling labelDynamic.</span><span>
</span><a name="line-457"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="dedupSRTs"><a href="CmmBuildInfoTables.html#dedupSRTs"><span class="hs-identifier">dedupSRTs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><a href="CmmBuildInfoTables.html#SRTEntry"><span class="hs-identifier hs-type">SRTEntry</span></a><span class="hs-special">)</span><span> </span><a href="CmmBuildInfoTables.html#SRTEntry"><span class="hs-identifier hs-type">SRTEntry</span></a><span>
</span><a name="line-458"></a><span>    </span><span class="hs-comment">-- ^ previous SRTs we've emitted, so we can de-duplicate.</span><span>
</span><a name="line-459"></a><span>    </span><span class="hs-comment">-- Used to implement the [Common] optimisation.</span><span>
</span><a name="line-460"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="flatSRTs"><a href="CmmBuildInfoTables.html#flatSRTs"><span class="hs-identifier">flatSRTs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="CmmBuildInfoTables.html#SRTEntry"><span class="hs-identifier hs-type">SRTEntry</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><a href="CmmBuildInfoTables.html#SRTEntry"><span class="hs-identifier hs-type">SRTEntry</span></a><span class="hs-special">)</span><span>
</span><a name="line-461"></a><span>    </span><span class="hs-comment">-- ^ The reverse mapping, so that we can remove redundant</span><span>
</span><a name="line-462"></a><span>    </span><span class="hs-comment">-- entries. e.g.  if we have an SRT [a,b,c], and we know that b</span><span>
</span><a name="line-463"></a><span>    </span><span class="hs-comment">-- points to [c,d], we can omit c and emit [a,b].</span><span>
</span><a name="line-464"></a><span>    </span><span class="hs-comment">-- Used to implement the [Filter] optimisation.</span><span>
</span><a name="line-465"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-466"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="CmmBuildInfoTables.html#ModuleSRTInfo"><span class="hs-identifier hs-type">ModuleSRTInfo</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-467"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><a href="CmmBuildInfoTables.html#ModuleSRTInfo"><span class="hs-identifier hs-var">ModuleSRTInfo</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-468"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;ModuleSRTInfo:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680948561"><span class="hs-identifier hs-var">dedupSRTs</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680948562"><span class="hs-identifier hs-var">flatSRTs</span></a><span>
</span><a name="line-469"></a><span>
</span><a name="line-470"></a><span class="hs-identifier">emptySRT</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmBuildInfoTables.html#ModuleSRTInfo"><span class="hs-identifier hs-type">ModuleSRTInfo</span></a><span>
</span><a name="line-471"></a><a name="emptySRT"><a href="CmmBuildInfoTables.html#emptySRT"><span class="hs-identifier">emptySRT</span></a></a><span> </span><a name="local-6989586621680948735"><a href="#local-6989586621680948735"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-472"></a><span>  </span><a href="CmmBuildInfoTables.html#ModuleSRTInfo"><span class="hs-identifier hs-var">ModuleSRTInfo</span></a><span>
</span><a name="line-473"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">thisModule</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680948735"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-474"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dedupSRTs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span>
</span><a name="line-475"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">flatSRTs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-476"></a><span>
</span><a name="line-477"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-478"></a><span class="hs-comment">-- Constructing SRTs</span><span>
</span><a name="line-479"></a><span>
</span><a name="line-480"></a><span class="hs-comment">{- Implementation notes

- In each CmmDecl there is a mapping info_tbls from Label -&gt; CmmInfoTable

- The entry in info_tbls corresponding to g_entry is the closure info
  table, the rest are continuations.

- Each entry in info_tbls possibly needs an SRT.  We need to make a
  label for each of these.

- We get the CAFSet for each entry from the CAFEnv

-}</span><span>
</span><a name="line-493"></a><span>
</span><a name="line-494"></a><span class="hs-comment">-- | Return a (Label,CLabel) pair for each labelled block of a CmmDecl,</span><span>
</span><a name="line-495"></a><span class="hs-comment">--   where the label is</span><span>
</span><a name="line-496"></a><span class="hs-comment">--   - the info label for a continuation or dynamic closure</span><span>
</span><a name="line-497"></a><span class="hs-comment">--   - the closure label for a top-level function (not a CAF)</span><span>
</span><a name="line-498"></a><span class="hs-identifier">getLabelledBlocks</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span class="hs-special">,</span><span> </span><a href="CmmBuildInfoTables.html#CAFLabel"><span class="hs-identifier hs-type">CAFLabel</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-499"></a><a name="getLabelledBlocks"><a href="CmmBuildInfoTables.html#getLabelledBlocks"><span class="hs-identifier">getLabelledBlocks</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmData"><span class="hs-identifier hs-var">CmmData</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-500"></a><span class="hs-identifier">getLabelledBlocks</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a name="local-6989586621680948736"><a href="#local-6989586621680948736"><span class="hs-identifier">top_info</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-501"></a><span>  </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680948737"><span class="hs-identifier hs-var">blockId</span></a><span class="hs-special">,</span><span> </span><a href="CmmBuildInfoTables.html#mkCAFLabel"><span class="hs-identifier hs-var">mkCAFLabel</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">cit_lbl</span><span> </span><a href="#local-6989586621680948738"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-502"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680948737"><a href="#local-6989586621680948737"><span class="hs-identifier">blockId</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680948738"><a href="#local-6989586621680948738"><span class="hs-identifier">info</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Hoopl.Collections.html#mapToList"><span class="hs-identifier hs-var">mapToList</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">info_tbls</span><span> </span><a href="#local-6989586621680948736"><span class="hs-identifier hs-var">top_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-503"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680948739"><a href="#local-6989586621680948739"><span class="hs-identifier">rep</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cit_rep</span><span> </span><a href="#local-6989586621680948738"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-504"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="SMRep.html#isStaticRep"><span class="hs-identifier hs-var">isStaticRep</span></a><span> </span><a href="#local-6989586621680948739"><span class="hs-identifier hs-var">rep</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="SMRep.html#isThunkRep"><span class="hs-identifier hs-var">isThunkRep</span></a><span> </span><a href="#local-6989586621680948739"><span class="hs-identifier hs-var">rep</span></a><span class="hs-special">)</span><span>
</span><a name="line-505"></a><span>  </span><span class="hs-special">]</span><span>
</span><a name="line-506"></a><span>
</span><a name="line-507"></a><span>
</span><a name="line-508"></a><span class="hs-comment">-- | Put the labelled blocks that we will be annotating with SRTs into</span><span>
</span><a name="line-509"></a><span class="hs-comment">-- dependency order.  This is so that we can process them one at a</span><span>
</span><a name="line-510"></a><span class="hs-comment">-- time, resolving references to earlier blocks to point to their</span><span>
</span><a name="line-511"></a><span class="hs-comment">-- SRTs. CAFs themselves are not included here; see getCAFs below.</span><span>
</span><a name="line-512"></a><span class="hs-identifier">depAnalSRTs</span><span>
</span><a name="line-513"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="CmmBuildInfoTables.html#CAFEnv"><span class="hs-identifier hs-type">CAFEnv</span></a><span>
</span><a name="line-514"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span class="hs-special">]</span><span>
</span><a name="line-515"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SCC</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span class="hs-special">,</span><span> </span><a href="CmmBuildInfoTables.html#CAFLabel"><span class="hs-identifier hs-type">CAFLabel</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Set</span><span> </span><a href="CmmBuildInfoTables.html#CAFLabel"><span class="hs-identifier hs-type">CAFLabel</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-516"></a><a name="depAnalSRTs"><a href="CmmBuildInfoTables.html#depAnalSRTs"><span class="hs-identifier">depAnalSRTs</span></a></a><span> </span><a name="local-6989586621680948740"><a href="#local-6989586621680948740"><span class="hs-identifier">cafEnv</span></a></a><span> </span><a name="local-6989586621680948741"><a href="#local-6989586621680948741"><span class="hs-identifier">decls</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-517"></a><span>  </span><a href="CmmBuildInfoTables.html#srtTrace"><span class="hs-identifier hs-var">srtTrace</span></a><span> </span><span class="hs-string">&quot;depAnalSRTs&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680948744"><span class="hs-identifier hs-var">graph</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680948744"><span class="hs-identifier hs-var">graph</span></a><span>
</span><a name="line-518"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-519"></a><span>  </span><a name="local-6989586621680948742"><a href="#local-6989586621680948742"><span class="hs-identifier">labelledBlocks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="CmmBuildInfoTables.html#getLabelledBlocks"><span class="hs-identifier hs-var">getLabelledBlocks</span></a><span> </span><a href="#local-6989586621680948741"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-520"></a><span>  </span><a name="local-6989586621680948743"><a href="#local-6989586621680948743"><span class="hs-identifier">labelToBlock</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">swap</span><span> </span><a href="#local-6989586621680948742"><span class="hs-identifier hs-var">labelledBlocks</span></a><span class="hs-special">)</span><span>
</span><a name="line-521"></a><span>  </span><a name="local-6989586621680948744"><a href="#local-6989586621680948744"><span class="hs-identifier">graph</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">stronglyConnCompFromEdgedVerticesOrd</span><span>
</span><a name="line-522"></a><span>             </span><span class="hs-special">[</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680948748"><a href="#local-6989586621680948748"><span class="hs-identifier">cafs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.delete</span><span> </span><a href="#local-6989586621680948746"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621680948747"><span class="hs-identifier hs-var">cafs</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-523"></a><span>               </span><span class="hs-identifier hs-var">DigraphNode</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680948745"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">,</span><a href="#local-6989586621680948746"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">,</span><a href="#local-6989586621680948748"><span class="hs-identifier hs-var">cafs'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680948745"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-524"></a><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621680948743"><span class="hs-identifier hs-var">labelToBlock</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.toList</span><span> </span><a href="#local-6989586621680948748"><span class="hs-identifier hs-var">cafs'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-525"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680948745"><a href="#local-6989586621680948745"><span class="hs-identifier">l</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680948746"><a href="#local-6989586621680948746"><span class="hs-identifier">lbl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680948742"><span class="hs-identifier hs-var">labelledBlocks</span></a><span>
</span><a name="line-526"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680948747"><a href="#local-6989586621680948747"><span class="hs-identifier">cafs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621680948745"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621680948740"><span class="hs-identifier hs-var">cafEnv</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-527"></a><span>
</span><a name="line-528"></a><span>
</span><a name="line-529"></a><span class="hs-comment">-- | Get (Label, CAFLabel, Set CAFLabel) for each block that represents a CAF.</span><span>
</span><a name="line-530"></a><span class="hs-comment">-- These are treated differently from other labelled blocks:</span><span>
</span><a name="line-531"></a><span class="hs-comment">--  - we never shortcut a reference to a CAF to the contents of its</span><span>
</span><a name="line-532"></a><span class="hs-comment">--    SRT, since the point of SRTs is to keep CAFs alive.</span><span>
</span><a name="line-533"></a><span class="hs-comment">--  - CAFs therefore don't take part in the dependency analysis in depAnalSRTs.</span><span>
</span><a name="line-534"></a><span class="hs-comment">--    instead we generate their SRTs after everything else.</span><span>
</span><a name="line-535"></a><span class="hs-identifier">getCAFs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmBuildInfoTables.html#CAFEnv"><span class="hs-identifier hs-type">CAFEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span class="hs-special">,</span><span> </span><a href="CmmBuildInfoTables.html#CAFLabel"><span class="hs-identifier hs-type">CAFLabel</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Set</span><span> </span><a href="CmmBuildInfoTables.html#CAFLabel"><span class="hs-identifier hs-type">CAFLabel</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-536"></a><a name="getCAFs"><a href="CmmBuildInfoTables.html#getCAFs"><span class="hs-identifier">getCAFs</span></a></a><span> </span><a name="local-6989586621680948749"><a href="#local-6989586621680948749"><span class="hs-identifier">cafEnv</span></a></a><span> </span><a name="local-6989586621680948750"><a href="#local-6989586621680948750"><span class="hs-identifier">decls</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-537"></a><span>  </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">g_entry</span><span> </span><a href="#local-6989586621680948753"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">,</span><span> </span><a href="CmmBuildInfoTables.html#mkCAFLabel"><span class="hs-identifier hs-var">mkCAFLabel</span></a><span> </span><a href="#local-6989586621680948752"><span class="hs-identifier hs-var">topLbl</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680948756"><span class="hs-identifier hs-var">cafs</span></a><span class="hs-special">)</span><span>
</span><a name="line-538"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a name="local-6989586621680948751"><a href="#local-6989586621680948751"><span class="hs-identifier">top_info</span></a></a><span> </span><a name="local-6989586621680948752"><a href="#local-6989586621680948752"><span class="hs-identifier">topLbl</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680948753"><a href="#local-6989586621680948753"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680948750"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-539"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680948754"><a href="#local-6989586621680948754"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">g_entry</span><span> </span><a href="#local-6989586621680948753"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">info_tbls</span><span> </span><a href="#local-6989586621680948751"><span class="hs-identifier hs-var">top_info</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-540"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680948755"><a href="#local-6989586621680948755"><span class="hs-identifier">rep</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cit_rep</span><span> </span><a href="#local-6989586621680948754"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-541"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="SMRep.html#isStaticRep"><span class="hs-identifier hs-var">isStaticRep</span></a><span> </span><a href="#local-6989586621680948755"><span class="hs-identifier hs-var">rep</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="SMRep.html#isThunkRep"><span class="hs-identifier hs-var">isThunkRep</span></a><span> </span><a href="#local-6989586621680948755"><span class="hs-identifier hs-var">rep</span></a><span>
</span><a name="line-542"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680948756"><a href="#local-6989586621680948756"><span class="hs-identifier">cafs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">g_entry</span><span> </span><a href="#local-6989586621680948753"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680948749"><span class="hs-identifier hs-var">cafEnv</span></a><span class="hs-special">]</span><span>
</span><a name="line-543"></a><span>  </span><span class="hs-special">]</span><span>
</span><a name="line-544"></a><span>
</span><a name="line-545"></a><span>
</span><a name="line-546"></a><span class="hs-comment">-- | Get the list of blocks that correspond to the entry points for</span><span>
</span><a name="line-547"></a><span class="hs-comment">-- FUN_STATIC closures.  These are the blocks for which if we have an</span><span>
</span><a name="line-548"></a><span class="hs-comment">-- SRT we can merge it with the static closure. [FUN]</span><span>
</span><a name="line-549"></a><span class="hs-identifier">getStaticFuns</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-550"></a><a name="getStaticFuns"><a href="CmmBuildInfoTables.html#getStaticFuns"><span class="hs-identifier">getStaticFuns</span></a></a><span> </span><a name="local-6989586621680948757"><a href="#local-6989586621680948757"><span class="hs-identifier">decls</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-551"></a><span>  </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">g_entry</span><span> </span><a href="#local-6989586621680948759"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680948763"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-552"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a name="local-6989586621680948758"><a href="#local-6989586621680948758"><span class="hs-identifier">top_info</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680948759"><a href="#local-6989586621680948759"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680948757"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-553"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680948760"><a href="#local-6989586621680948760"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">g_entry</span><span> </span><a href="#local-6989586621680948759"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">info_tbls</span><span> </span><a href="#local-6989586621680948758"><span class="hs-identifier hs-var">top_info</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-554"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680948761"><a href="#local-6989586621680948761"><span class="hs-identifier">id</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">cit_clo</span><span> </span><a href="#local-6989586621680948760"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">]</span><span>
</span><a name="line-555"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680948762"><a href="#local-6989586621680948762"><span class="hs-identifier">rep</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cit_rep</span><span> </span><a href="#local-6989586621680948760"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-556"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="SMRep.html#isStaticRep"><span class="hs-identifier hs-var">isStaticRep</span></a><span> </span><a href="#local-6989586621680948762"><span class="hs-identifier hs-var">rep</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="SMRep.html#isFunRep"><span class="hs-identifier hs-var">isFunRep</span></a><span> </span><a href="#local-6989586621680948762"><span class="hs-identifier hs-var">rep</span></a><span>
</span><a name="line-557"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680948763"><a href="#local-6989586621680948763"><span class="hs-identifier">lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkLocalClosureLabel"><span class="hs-identifier hs-var">mkLocalClosureLabel</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621680948761"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idCafInfo</span><span> </span><a href="#local-6989586621680948761"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-558"></a><span>  </span><span class="hs-special">]</span><span>
</span><a name="line-559"></a><span>
</span><a name="line-560"></a><span>
</span><a name="line-561"></a><span class="hs-comment">-- | Maps labels from 'cafAnal' to the final CLabel that will appear</span><span>
</span><a name="line-562"></a><span class="hs-comment">-- in the SRT.</span><span>
</span><a name="line-563"></a><span class="hs-comment">--   - closures with singleton SRTs resolve to their single entry</span><span>
</span><a name="line-564"></a><span class="hs-comment">--   - closures with larger SRTs map to the label for that SRT</span><span>
</span><a name="line-565"></a><span class="hs-comment">--   - CAFs must not map to anything!</span><span>
</span><a name="line-566"></a><span class="hs-comment">--   - if a labels maps to Nothing, we found that this label's SRT</span><span>
</span><a name="line-567"></a><span class="hs-comment">--     is empty, so we don't need to refer to it from other SRTs.</span><span>
</span><a name="line-568"></a><span class="hs-keyword">type</span><span> </span><a name="SRTMap"><a href="CmmBuildInfoTables.html#SRTMap"><span class="hs-identifier">SRTMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="CmmBuildInfoTables.html#CAFLabel"><span class="hs-identifier hs-type">CAFLabel</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CmmBuildInfoTables.html#SRTEntry"><span class="hs-identifier hs-type">SRTEntry</span></a><span class="hs-special">)</span><span>
</span><a name="line-569"></a><span>
</span><a name="line-570"></a><span class="hs-comment">-- | resolve a CAFLabel to its SRTEntry using the SRTMap</span><span>
</span><a name="line-571"></a><span class="hs-identifier">resolveCAF</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmBuildInfoTables.html#SRTMap"><span class="hs-identifier hs-type">SRTMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmBuildInfoTables.html#CAFLabel"><span class="hs-identifier hs-type">CAFLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CmmBuildInfoTables.html#SRTEntry"><span class="hs-identifier hs-type">SRTEntry</span></a><span>
</span><a name="line-572"></a><a name="resolveCAF"><a href="CmmBuildInfoTables.html#resolveCAF"><span class="hs-identifier">resolveCAF</span></a></a><span> </span><a name="local-6989586621680948764"><a href="#local-6989586621680948764"><span class="hs-identifier">srtMap</span></a></a><span> </span><a name="local-6989586621680948765"><a href="#local-6989586621680948765"><span class="hs-identifier">lbl</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#CAFLabel"><span class="hs-identifier hs-var">CAFLabel</span></a><span> </span><a name="local-6989586621680948766"><a href="#local-6989586621680948766"><span class="hs-identifier">l</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-573"></a><span>  </span><span class="hs-identifier hs-var">Map.findWithDefault</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#SRTEntry"><span class="hs-identifier hs-var">SRTEntry</span></a><span> </span><span class="hs-special">(</span><a href="CLabel.html#toClosureLbl"><span class="hs-identifier hs-var">toClosureLbl</span></a><span> </span><a href="#local-6989586621680948766"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680948765"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621680948764"><span class="hs-identifier hs-var">srtMap</span></a><span>
</span><a name="line-574"></a><span>
</span><a name="line-575"></a><span>
</span><a name="line-576"></a><span class="hs-comment">-- | Attach SRTs to all info tables in the CmmDecls, and add SRT</span><span>
</span><a name="line-577"></a><span class="hs-comment">-- declarations to the ModuleSRTInfo.</span><span>
</span><a name="line-578"></a><span class="hs-comment">--</span><span>
</span><a name="line-579"></a><span class="hs-identifier">doSRTs</span><span>
</span><a name="line-580"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-581"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmBuildInfoTables.html#ModuleSRTInfo"><span class="hs-identifier hs-type">ModuleSRTInfo</span></a><span>
</span><a name="line-582"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#CAFEnv"><span class="hs-identifier hs-type">CAFEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-583"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#ModuleSRTInfo"><span class="hs-identifier hs-type">ModuleSRTInfo</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-584"></a><span>
</span><a name="line-585"></a><a name="doSRTs"><a href="CmmBuildInfoTables.html#doSRTs"><span class="hs-identifier">doSRTs</span></a></a><span> </span><a name="local-6989586621680948767"><a href="#local-6989586621680948767"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680948768"><a href="#local-6989586621680948768"><span class="hs-identifier">moduleSRTInfo</span></a></a><span> </span><a name="local-6989586621680948769"><a href="#local-6989586621680948769"><span class="hs-identifier">tops</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-586"></a><span>  </span><a name="local-6989586621680948770"><a href="#local-6989586621680948770"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mkSplitUniqSupply</span><span> </span><span class="hs-char">'u'</span><span>
</span><a name="line-587"></a><span>
</span><a name="line-588"></a><span>  </span><span class="hs-comment">-- Ignore the original grouping of decls, and combine all the</span><span>
</span><a name="line-589"></a><span>  </span><span class="hs-comment">-- CAFEnvs into a single CAFEnv.</span><span>
</span><a name="line-590"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680948771"><a href="#local-6989586621680948771"><span class="hs-identifier">cafEnvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680948772"><a href="#local-6989586621680948772"><span class="hs-identifier">declss</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621680948769"><span class="hs-identifier hs-var">tops</span></a><span>
</span><a name="line-591"></a><span>      </span><a name="local-6989586621680948773"><a href="#local-6989586621680948773"><span class="hs-identifier">cafEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapUnions"><span class="hs-identifier hs-var">mapUnions</span></a><span> </span><a href="#local-6989586621680948771"><span class="hs-identifier hs-var">cafEnvs</span></a><span>
</span><a name="line-592"></a><span>      </span><a name="local-6989586621680948774"><a href="#local-6989586621680948774"><span class="hs-identifier">decls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-6989586621680948772"><span class="hs-identifier hs-var">declss</span></a><span>
</span><a name="line-593"></a><span>      </span><a name="local-6989586621680948775"><a href="#local-6989586621680948775"><span class="hs-identifier">staticFuns</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapFromList"><span class="hs-identifier hs-var">mapFromList</span></a><span> </span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#getStaticFuns"><span class="hs-identifier hs-var">getStaticFuns</span></a><span> </span><a href="#local-6989586621680948774"><span class="hs-identifier hs-var">decls</span></a><span class="hs-special">)</span><span>
</span><a name="line-594"></a><span>
</span><a name="line-595"></a><span>  </span><span class="hs-comment">-- Put the decls in dependency order. Why? So that we can implement</span><span>
</span><a name="line-596"></a><span>  </span><span class="hs-comment">-- [Inline] and [Filter].  If we need to refer to an SRT that has</span><span>
</span><a name="line-597"></a><span>  </span><span class="hs-comment">-- a single entry, we use the entry itself, which means that we</span><span>
</span><a name="line-598"></a><span>  </span><span class="hs-comment">-- don't need to generate the singleton SRT in the first place.  But</span><span>
</span><a name="line-599"></a><span>  </span><span class="hs-comment">-- to do this we need to process blocks before things that depend on</span><span>
</span><a name="line-600"></a><span>  </span><span class="hs-comment">-- them.</span><span>
</span><a name="line-601"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-602"></a><span>    </span><a name="local-6989586621680948776"><a href="#local-6989586621680948776"><span class="hs-identifier">sccs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmBuildInfoTables.html#depAnalSRTs"><span class="hs-identifier hs-var">depAnalSRTs</span></a><span> </span><a href="#local-6989586621680948773"><span class="hs-identifier hs-var">cafEnv</span></a><span> </span><a href="#local-6989586621680948774"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-603"></a><span>    </span><a name="local-6989586621680948777"><a href="#local-6989586621680948777"><span class="hs-identifier">cafsWithSRTs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmBuildInfoTables.html#getCAFs"><span class="hs-identifier hs-var">getCAFs</span></a><span> </span><a href="#local-6989586621680948773"><span class="hs-identifier hs-var">cafEnv</span></a><span> </span><a href="#local-6989586621680948774"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-604"></a><span>
</span><a name="line-605"></a><span>  </span><span class="hs-comment">-- On each strongly-connected group of decls, construct the SRT</span><span>
</span><a name="line-606"></a><span>  </span><span class="hs-comment">-- closures and the SRT fields for info tables.</span><span>
</span><a name="line-607"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">result</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-608"></a><span>        </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span class="hs-special">]</span><span>              </span><span class="hs-comment">-- generated SRTs</span><span>
</span><a name="line-609"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span class="hs-special">,</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- SRT fields for info tables</span><span>
</span><a name="line-610"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CmmBuildInfoTables.html#SRTEntry"><span class="hs-identifier hs-type">SRTEntry</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- SRTs to attach to static functions</span><span>
</span><a name="line-611"></a><span>          </span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-612"></a><span>      </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621680948778"><a href="#local-6989586621680948778"><span class="hs-identifier">result</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680948779"><a href="#local-6989586621680948779"><span class="hs-identifier">_srtMap</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680948780"><a href="#local-6989586621680948780"><span class="hs-identifier">moduleSRTInfo'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-613"></a><span>        </span><span class="hs-identifier hs-var">initUs_</span><span> </span><a href="#local-6989586621680948770"><span class="hs-identifier hs-var">us</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-614"></a><span>        </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier">runStateT</span><span> </span><a href="#local-6989586621680948768"><span class="hs-identifier hs-var">moduleSRTInfo</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-615"></a><span>        </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier">runStateT</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-616"></a><span>          </span><a name="local-6989586621680948784"><a href="#local-6989586621680948784"><span class="hs-identifier">nonCAFs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#doSCC"><span class="hs-identifier hs-var">doSCC</span></a><span> </span><a href="#local-6989586621680948767"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680948775"><span class="hs-identifier hs-var">staticFuns</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680948776"><span class="hs-identifier hs-var">sccs</span></a><span>
</span><a name="line-617"></a><span>          </span><a name="local-6989586621680948788"><a href="#local-6989586621680948788"><span class="hs-identifier">cAFs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">forM</span><span> </span><a href="#local-6989586621680948777"><span class="hs-identifier hs-var">cafsWithSRTs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621680948785"><a href="#local-6989586621680948785"><span class="hs-identifier">l</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680948786"><a href="#local-6989586621680948786"><span class="hs-identifier">cafLbl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680948787"><a href="#local-6989586621680948787"><span class="hs-identifier">cafs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-618"></a><span>            </span><a href="CmmBuildInfoTables.html#oneSRT"><span class="hs-identifier hs-var">oneSRT</span></a><span> </span><a href="#local-6989586621680948767"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680948775"><span class="hs-identifier hs-var">staticFuns</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621680948785"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680948786"><span class="hs-identifier hs-var">cafLbl</span></a><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-comment">{-is a CAF-}</span><span> </span><a href="#local-6989586621680948787"><span class="hs-identifier hs-var">cafs</span></a><span>
</span><a name="line-619"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680948784"><span class="hs-identifier hs-var">nonCAFs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621680948788"><span class="hs-identifier hs-var">cAFs</span></a><span class="hs-special">)</span><span>
</span><a name="line-620"></a><span>
</span><a name="line-621"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621680948781"><a href="#local-6989586621680948781"><span class="hs-identifier">declss</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680948782"><a href="#local-6989586621680948782"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680948783"><a href="#local-6989586621680948783"><span class="hs-identifier">funSRTs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip3</span><span> </span><a href="#local-6989586621680948778"><span class="hs-identifier hs-var">result</span></a><span>
</span><a name="line-622"></a><span>
</span><a name="line-623"></a><span>  </span><span class="hs-comment">-- Next, update the info tables with the SRTs</span><span>
</span><a name="line-624"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-625"></a><span>    </span><a name="local-6989586621680948789"><a href="#local-6989586621680948789"><span class="hs-identifier">srtFieldMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapFromList"><span class="hs-identifier hs-var">mapFromList</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-6989586621680948782"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">)</span><span>
</span><a name="line-626"></a><span>    </span><a name="local-6989586621680948790"><a href="#local-6989586621680948790"><span class="hs-identifier">funSRTMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapFromList"><span class="hs-identifier hs-var">mapFromList</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-6989586621680948783"><span class="hs-identifier hs-var">funSRTs</span></a><span class="hs-special">)</span><span>
</span><a name="line-627"></a><span>    </span><a name="local-6989586621680948791"><a href="#local-6989586621680948791"><span class="hs-identifier">decls'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#updInfoSRTs"><span class="hs-identifier hs-var">updInfoSRTs</span></a><span> </span><a href="#local-6989586621680948767"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680948789"><span class="hs-identifier hs-var">srtFieldMap</span></a><span> </span><a href="#local-6989586621680948790"><span class="hs-identifier hs-var">funSRTMap</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680948774"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-628"></a><span>
</span><a name="line-629"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680948780"><span class="hs-identifier hs-var">moduleSRTInfo'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-6989586621680948781"><span class="hs-identifier hs-var">declss</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621680948791"><span class="hs-identifier hs-var">decls'</span></a><span class="hs-special">)</span><span>
</span><a name="line-630"></a><span>
</span><a name="line-631"></a><span>
</span><a name="line-632"></a><span class="hs-comment">-- | Build the SRT for a strongly-connected component of blocks</span><span>
</span><a name="line-633"></a><span class="hs-identifier">doSCC</span><span>
</span><a name="line-634"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-635"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span>           </span><span class="hs-comment">-- which blocks are static function entry points</span><span>
</span><a name="line-636"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SCC</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span class="hs-special">,</span><span> </span><a href="CmmBuildInfoTables.html#CAFLabel"><span class="hs-identifier hs-type">CAFLabel</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Set</span><span> </span><a href="CmmBuildInfoTables.html#CAFLabel"><span class="hs-identifier hs-type">CAFLabel</span></a><span class="hs-special">)</span><span>
</span><a name="line-637"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">StateT</span><span> </span><a href="CmmBuildInfoTables.html#SRTMap"><span class="hs-identifier hs-type">SRTMap</span></a><span>
</span><a name="line-638"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-type">StateT</span><span> </span><a href="CmmBuildInfoTables.html#ModuleSRTInfo"><span class="hs-identifier hs-type">ModuleSRTInfo</span></a><span> </span><span class="hs-identifier hs-type">UniqSM</span><span class="hs-special">)</span><span>
</span><a name="line-639"></a><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span class="hs-special">]</span><span>              </span><span class="hs-comment">-- generated SRTs</span><span>
</span><a name="line-640"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span class="hs-special">,</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- SRT fields for info tables</span><span>
</span><a name="line-641"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CmmBuildInfoTables.html#SRTEntry"><span class="hs-identifier hs-type">SRTEntry</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- SRTs to attach to static functions</span><span>
</span><a name="line-642"></a><span>        </span><span class="hs-special">)</span><span>
</span><a name="line-643"></a><span>
</span><a name="line-644"></a><a name="doSCC"><a href="CmmBuildInfoTables.html#doSCC"><span class="hs-identifier">doSCC</span></a></a><span> </span><a name="local-6989586621680948792"><a href="#local-6989586621680948792"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680948793"><a href="#local-6989586621680948793"><span class="hs-identifier">staticFuns</span></a></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AcyclicSCC</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680948794"><a href="#local-6989586621680948794"><span class="hs-identifier">l</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680948795"><a href="#local-6989586621680948795"><span class="hs-identifier">cafLbl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680948796"><a href="#local-6989586621680948796"><span class="hs-identifier">cafs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-645"></a><span>  </span><a href="CmmBuildInfoTables.html#oneSRT"><span class="hs-identifier hs-var">oneSRT</span></a><span> </span><a href="#local-6989586621680948792"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680948793"><span class="hs-identifier hs-var">staticFuns</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621680948794"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680948795"><span class="hs-identifier hs-var">cafLbl</span></a><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621680948796"><span class="hs-identifier hs-var">cafs</span></a><span>
</span><a name="line-646"></a><span>
</span><a name="line-647"></a><span class="hs-identifier">doSCC</span><span> </span><a name="local-6989586621680948797"><a href="#local-6989586621680948797"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680948798"><a href="#local-6989586621680948798"><span class="hs-identifier">staticFuns</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CyclicSCC</span><span> </span><a name="local-6989586621680948799"><a href="#local-6989586621680948799"><span class="hs-identifier">nodes</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-648"></a><span>  </span><span class="hs-comment">-- build a single SRT for the whole cycle, see Note [recursive SRTs]</span><span>
</span><a name="line-649"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680948800"><a href="#local-6989586621680948800"><span class="hs-identifier">blockids</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680948801"><a href="#local-6989586621680948801"><span class="hs-identifier">lbls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680948802"><a href="#local-6989586621680948802"><span class="hs-identifier">cafsets</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip3</span><span> </span><a href="#local-6989586621680948799"><span class="hs-identifier hs-var">nodes</span></a><span>
</span><a name="line-650"></a><span>      </span><a name="local-6989586621680948803"><a href="#local-6989586621680948803"><span class="hs-identifier">cafs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.unions</span><span> </span><a href="#local-6989586621680948802"><span class="hs-identifier hs-var">cafsets</span></a><span>
</span><a name="line-651"></a><span>  </span><a href="CmmBuildInfoTables.html#oneSRT"><span class="hs-identifier hs-var">oneSRT</span></a><span> </span><a href="#local-6989586621680948797"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680948798"><span class="hs-identifier hs-var">staticFuns</span></a><span> </span><a href="#local-6989586621680948800"><span class="hs-identifier hs-var">blockids</span></a><span> </span><a href="#local-6989586621680948801"><span class="hs-identifier hs-var">lbls</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621680948803"><span class="hs-identifier hs-var">cafs</span></a><span>
</span><a name="line-652"></a><span>
</span><a name="line-653"></a><span>
</span><a name="line-654"></a><span class="hs-comment">{- Note [recursive SRTs]

If the dependency analyser has found us a recursive group of
declarations, then we build a single SRT for the whole group, on the
grounds that everything in the group is reachable from everything
else, so we lose nothing by having a single SRT.

However, there are a couple of wrinkles to be aware of.

* The Set CAFLabel for this SRT will contain labels in the group
itself. The SRTMap will therefore not contain entries for these labels
yet, so we can't turn them into SRTEntries using resolveCAF. BUT we
can just remove recursive references from the Set CAFLabel before
generating the SRT - the SRT will still contain all the CAFLabels that
we need to refer to from this group's SRT.

* That is, EXCEPT for static function closures. For the same reason
described in Note [Invalid optimisation: shortcutting], we cannot omit
references to static function closures.
  - But, since we will merge the SRT with one of the static function
    closures (see [FUN]), we can omit references to *that* static
    function closure from the SRT.
-}</span><span>
</span><a name="line-677"></a><span>
</span><a name="line-678"></a><span class="hs-comment">-- | Build an SRT for a set of blocks</span><span>
</span><a name="line-679"></a><span class="hs-identifier">oneSRT</span><span>
</span><a name="line-680"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-681"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span>            </span><span class="hs-comment">-- which blocks are static function entry points</span><span>
</span><a name="line-682"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span class="hs-special">]</span><span>                    </span><span class="hs-comment">-- blocks in this set</span><span>
</span><a name="line-683"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmBuildInfoTables.html#CAFLabel"><span class="hs-identifier hs-type">CAFLabel</span></a><span class="hs-special">]</span><span>                 </span><span class="hs-comment">-- labels for those blocks</span><span>
</span><a name="line-684"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>                       </span><span class="hs-comment">-- True &lt;=&gt; this SRT is for a CAF</span><span>
</span><a name="line-685"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Set</span><span> </span><a href="CmmBuildInfoTables.html#CAFLabel"><span class="hs-identifier hs-type">CAFLabel</span></a><span>               </span><span class="hs-comment">-- SRT for this set</span><span>
</span><a name="line-686"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">StateT</span><span> </span><a href="CmmBuildInfoTables.html#SRTMap"><span class="hs-identifier hs-type">SRTMap</span></a><span>
</span><a name="line-687"></a><span>       </span><span class="hs-special">(</span><span class="hs-identifier hs-type">StateT</span><span> </span><a href="CmmBuildInfoTables.html#ModuleSRTInfo"><span class="hs-identifier hs-type">ModuleSRTInfo</span></a><span> </span><span class="hs-identifier hs-type">UniqSM</span><span class="hs-special">)</span><span>
</span><a name="line-688"></a><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span class="hs-special">]</span><span>                    </span><span class="hs-comment">-- SRT objects we built</span><span>
</span><a name="line-689"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span class="hs-special">,</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>            </span><span class="hs-comment">-- SRT fields for these blocks' itbls</span><span>
</span><a name="line-690"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CmmBuildInfoTables.html#SRTEntry"><span class="hs-identifier hs-type">SRTEntry</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- SRTs to attach to static functions</span><span>
</span><a name="line-691"></a><span>       </span><span class="hs-special">)</span><span>
</span><a name="line-692"></a><span>
</span><a name="line-693"></a><a name="oneSRT"><a href="CmmBuildInfoTables.html#oneSRT"><span class="hs-identifier">oneSRT</span></a></a><span> </span><a name="local-6989586621680948804"><a href="#local-6989586621680948804"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680948805"><a href="#local-6989586621680948805"><span class="hs-identifier">staticFuns</span></a></a><span> </span><a name="local-6989586621680948806"><a href="#local-6989586621680948806"><span class="hs-identifier">blockids</span></a></a><span> </span><a name="local-6989586621680948807"><a href="#local-6989586621680948807"><span class="hs-identifier">lbls</span></a></a><span> </span><a name="local-6989586621680948808"><a href="#local-6989586621680948808"><span class="hs-identifier">isCAF</span></a></a><span> </span><a name="local-6989586621680948809"><a href="#local-6989586621680948809"><span class="hs-identifier">cafs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-694"></a><span>  </span><a name="local-6989586621680948810"><a href="#local-6989586621680948810"><span class="hs-identifier">srtMap</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">get</span><span>
</span><a name="line-695"></a><span>  </span><a name="local-6989586621680948811"><a href="#local-6989586621680948811"><span class="hs-identifier">topSRT</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-identifier hs-var">get</span><span>
</span><a name="line-696"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-697"></a><span>    </span><span class="hs-comment">-- Can we merge this SRT with a FUN_STATIC closure?</span><span>
</span><a name="line-698"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680948812"><a href="#local-6989586621680948812"><span class="hs-identifier">maybeFunClosure</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680948813"><a href="#local-6989586621680948813"><span class="hs-identifier">otherFunLabels</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-699"></a><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680948819"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">,</span><a href="#local-6989586621680948818"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621680948818"><a href="#local-6989586621680948818"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680948806"><span class="hs-identifier hs-var">blockids</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680948819"><a href="#local-6989586621680948819"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621680948818"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621680948805"><span class="hs-identifier hs-var">staticFuns</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-700"></a><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-701"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621680948820"><a href="#local-6989586621680948820"><span class="hs-identifier">l</span></a></a><span class="hs-special">,</span><a name="local-6989586621680948821"><a href="#local-6989586621680948821"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621680948822"><a href="#local-6989586621680948822"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680948820"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">,</span><a href="#local-6989586621680948821"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#mkCAFLabel"><span class="hs-identifier hs-var">mkCAFLabel</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680948822"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-702"></a><span>
</span><a name="line-703"></a><span>    </span><span class="hs-comment">-- Remove recursive references from the SRT, except for (all but</span><span>
</span><a name="line-704"></a><span>    </span><span class="hs-comment">-- one of the) static functions. See Note [recursive SRTs].</span><span>
</span><a name="line-705"></a><span>    </span><a name="local-6989586621680948814"><a href="#local-6989586621680948814"><span class="hs-identifier">nonRec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680948809"><span class="hs-identifier hs-var">cafs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Set.difference</span><span class="hs-special">`</span><span>
</span><a name="line-706"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.fromList</span><span> </span><a href="#local-6989586621680948807"><span class="hs-identifier hs-var">lbls</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Set.difference</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">Set.fromList</span><span> </span><a href="#local-6989586621680948813"><span class="hs-identifier hs-var">otherFunLabels</span></a><span class="hs-special">)</span><span>
</span><a name="line-707"></a><span>
</span><a name="line-708"></a><span>    </span><span class="hs-comment">-- First resolve all the CAFLabels to SRTEntries</span><span>
</span><a name="line-709"></a><span>    </span><span class="hs-comment">-- Implements the [Inline] optimisation.</span><span>
</span><a name="line-710"></a><span>    </span><a name="local-6989586621680948815"><a href="#local-6989586621680948815"><span class="hs-identifier">resolved</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-711"></a><span>       </span><span class="hs-identifier hs-var">Set.fromList</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-712"></a><span>       </span><span class="hs-identifier hs-var">catMaybes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#resolveCAF"><span class="hs-identifier hs-var">resolveCAF</span></a><span> </span><a href="#local-6989586621680948810"><span class="hs-identifier hs-var">srtMap</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.toList</span><span> </span><a href="#local-6989586621680948814"><span class="hs-identifier hs-var">nonRec</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-713"></a><span>
</span><a name="line-714"></a><span>    </span><span class="hs-comment">-- The set of all SRTEntries in SRTs that we refer to from here.</span><span>
</span><a name="line-715"></a><span>    </span><a name="local-6989586621680948816"><a href="#local-6989586621680948816"><span class="hs-identifier">allBelow</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-716"></a><span>      </span><span class="hs-identifier hs-var">Set.unions</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621680948824"><span class="hs-identifier hs-var">lbls</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621680948823"><a href="#local-6989586621680948823"><span class="hs-identifier">caf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Set.toList</span><span> </span><a href="#local-6989586621680948815"><span class="hs-identifier hs-var">resolved</span></a><span>
</span><a name="line-717"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680948824"><a href="#local-6989586621680948824"><span class="hs-identifier">lbls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621680948823"><span class="hs-identifier hs-var">caf</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">flatSRTs</span><span> </span><a href="#local-6989586621680948811"><span class="hs-identifier hs-var">topSRT</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-718"></a><span>
</span><a name="line-719"></a><span>    </span><span class="hs-comment">-- Remove SRTEntries that are also in an SRT that we refer to.</span><span>
</span><a name="line-720"></a><span>    </span><span class="hs-comment">-- Implements the [Filter] optimisation.</span><span>
</span><a name="line-721"></a><span>    </span><a name="local-6989586621680948817"><a href="#local-6989586621680948817"><span class="hs-identifier">filtered</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.difference</span><span> </span><a href="#local-6989586621680948815"><span class="hs-identifier hs-var">resolved</span></a><span> </span><a href="#local-6989586621680948816"><span class="hs-identifier hs-var">allBelow</span></a><span>
</span><a name="line-722"></a><span>
</span><a name="line-723"></a><span>  </span><a href="CmmBuildInfoTables.html#srtTrace"><span class="hs-identifier hs-var">srtTrace</span></a><span> </span><span class="hs-string">&quot;oneSRT:&quot;</span><span>
</span><a name="line-724"></a><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680948809"><span class="hs-identifier hs-var">cafs</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680948815"><span class="hs-identifier hs-var">resolved</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680948816"><span class="hs-identifier hs-var">allBelow</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680948817"><span class="hs-identifier hs-var">filtered</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-725"></a><span>
</span><a name="line-726"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-727"></a><span>    </span><a name="local-6989586621680948825"><a href="#local-6989586621680948825"><span class="hs-identifier">isStaticFun</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><a href="#local-6989586621680948812"><span class="hs-identifier hs-var">maybeFunClosure</span></a><span>
</span><a name="line-728"></a><span>
</span><a name="line-729"></a><span>    </span><span class="hs-comment">-- For a label without a closure (e.g. a continuation), we must</span><span>
</span><a name="line-730"></a><span>    </span><span class="hs-comment">-- update the SRTMap for the label to point to a closure. It's</span><span>
</span><a name="line-731"></a><span>    </span><span class="hs-comment">-- important that we don't do this for static functions or CAFs,</span><span>
</span><a name="line-732"></a><span>    </span><span class="hs-comment">-- see Note [Invalid optimisation: shortcutting].</span><span>
</span><a name="line-733"></a><span>    </span><a name="local-6989586621680948826"><a href="#local-6989586621680948826"><span class="hs-identifier">updateSRTMap</span></a></a><span> </span><a name="local-6989586621680948828"><a href="#local-6989586621680948828"><span class="hs-identifier">srtEntry</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-734"></a><span>      </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680948808"><span class="hs-identifier hs-var">isCAF</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680948825"><span class="hs-identifier hs-var">isStaticFun</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-735"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680948829"><a href="#local-6989586621680948829"><span class="hs-identifier">newSRTMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621680948830"><span class="hs-identifier hs-var">cafLbl</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680948828"><span class="hs-identifier hs-var">srtEntry</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621680948830"><a href="#local-6989586621680948830"><span class="hs-identifier">cafLbl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680948807"><span class="hs-identifier hs-var">lbls</span></a><span class="hs-special">]</span><span>
</span><a name="line-736"></a><span>        </span><span class="hs-identifier hs-var">put</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.union</span><span> </span><a href="#local-6989586621680948829"><span class="hs-identifier hs-var">newSRTMap</span></a><span> </span><a href="#local-6989586621680948810"><span class="hs-identifier hs-var">srtMap</span></a><span class="hs-special">)</span><span>
</span><a name="line-737"></a><span>
</span><a name="line-738"></a><span>    </span><a name="local-6989586621680948827"><a href="#local-6989586621680948827"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">thisModule</span><span> </span><a href="#local-6989586621680948811"><span class="hs-identifier hs-var">topSRT</span></a><span>
</span><a name="line-739"></a><span>
</span><a name="line-740"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Set.toList</span><span> </span><a href="#local-6989586621680948817"><span class="hs-identifier hs-var">filtered</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-741"></a><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-742"></a><span>      </span><a href="CmmBuildInfoTables.html#srtTrace"><span class="hs-identifier hs-var">srtTrace</span></a><span> </span><span class="hs-string">&quot;oneSRT: empty&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680948807"><span class="hs-identifier hs-var">lbls</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-743"></a><span>      </span><a href="#local-6989586621680948826"><span class="hs-identifier hs-var">updateSRTMap</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-744"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-745"></a><span>
</span><a name="line-746"></a><span>    </span><span class="hs-comment">-- [Inline] - when we have only one entry there is no need to</span><span>
</span><a name="line-747"></a><span>    </span><span class="hs-comment">-- build an SRT object at all, instead we put the singleton SRT</span><span>
</span><a name="line-748"></a><span>    </span><span class="hs-comment">-- entry in the info table.</span><span>
</span><a name="line-749"></a><span>    </span><span class="hs-special">[</span><a name="local-6989586621680948831"><a href="#local-6989586621680948831"><span class="hs-identifier">one</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#SRTEntry"><span class="hs-identifier hs-var">SRTEntry</span></a><span> </span><a name="local-6989586621680948832"><a href="#local-6989586621680948832"><span class="hs-identifier">lbl</span></a></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-750"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- Info tables refer to SRTs by offset (as noted in the section</span><span>
</span><a name="line-751"></a><span>        </span><span class="hs-comment">-- &quot;Referring to an SRT from the info table&quot; of Note [SRTs]). However,</span><span>
</span><a name="line-752"></a><span>        </span><span class="hs-comment">-- when dynamic linking is used we cannot guarantee that the offset</span><span>
</span><a name="line-753"></a><span>        </span><span class="hs-comment">-- between the SRT and the info table will fit in the offset field.</span><span>
</span><a name="line-754"></a><span>        </span><span class="hs-comment">-- Consequently we build a singleton SRT in in this case.</span><span>
</span><a name="line-755"></a><span>        </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CLabel.html#labelDynamic"><span class="hs-identifier hs-var">labelDynamic</span></a><span> </span><a href="#local-6989586621680948804"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680948827"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621680948832"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-756"></a><span>
</span><a name="line-757"></a><span>        </span><span class="hs-comment">-- MachO relocations can't express offsets between compilation units at</span><span>
</span><a name="line-758"></a><span>        </span><span class="hs-comment">-- all, so we are always forced to build a singleton SRT in this case.</span><span>
</span><a name="line-759"></a><span>          </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">osMachOTarget</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">platformOS</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621680948804"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-760"></a><span>             </span><span class="hs-operator hs-var">||</span><span> </span><a href="CLabel.html#isLocalCLabel"><span class="hs-identifier hs-var">isLocalCLabel</span></a><span> </span><a href="#local-6989586621680948827"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621680948832"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-761"></a><span>
</span><a name="line-762"></a><span>        </span><span class="hs-comment">-- If we have a static function closure, then it becomes the</span><span>
</span><a name="line-763"></a><span>        </span><span class="hs-comment">-- SRT object, and everything else points to it. (the only way</span><span>
</span><a name="line-764"></a><span>        </span><span class="hs-comment">-- we could have multiple labels here is if this is a</span><span>
</span><a name="line-765"></a><span>        </span><span class="hs-comment">-- recursive group, see Note [recursive SRTs])</span><span>
</span><a name="line-766"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680948812"><span class="hs-identifier hs-var">maybeFunClosure</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-767"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680948833"><a href="#local-6989586621680948833"><span class="hs-identifier">staticFunLbl</span></a></a><span class="hs-special">,</span><a name="local-6989586621680948834"><a href="#local-6989586621680948834"><span class="hs-identifier">staticFunBlock</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680948835"><span class="hs-identifier hs-var">withLabels</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-768"></a><span>            </span><span class="hs-keyword">where</span><span>
</span><a name="line-769"></a><span>              </span><a name="local-6989586621680948835"><a href="#local-6989586621680948835"><span class="hs-identifier">withLabels</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-770"></a><span>                </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680948836"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621680948836"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680948834"><span class="hs-identifier hs-var">staticFunBlock</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621680948832"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621680948833"><span class="hs-identifier hs-var">staticFunLbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-771"></a><span>                </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621680948836"><a href="#local-6989586621680948836"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680948806"><span class="hs-identifier hs-var">blockids</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-772"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-773"></a><span>            </span><a href="#local-6989586621680948826"><span class="hs-identifier hs-var">updateSRTMap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680948831"><span class="hs-identifier hs-var">one</span></a><span class="hs-special">)</span><span>
</span><a name="line-774"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><a href="#local-6989586621680948832"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680948806"><span class="hs-identifier hs-var">blockids</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-775"></a><span>
</span><a name="line-776"></a><span>    </span><a name="local-6989586621680948837"><a href="#local-6989586621680948837"><span class="hs-identifier">cafList</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-777"></a><span>      </span><span class="hs-comment">-- Check whether an SRT with the same entries has been emitted already.</span><span>
</span><a name="line-778"></a><span>      </span><span class="hs-comment">-- Implements the [Common] optimisation.</span><span>
</span><a name="line-779"></a><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621680948817"><span class="hs-identifier hs-var">filtered</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">dedupSRTs</span><span> </span><a href="#local-6989586621680948811"><span class="hs-identifier hs-var">topSRT</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-780"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680948838"><a href="#local-6989586621680948838"><span class="hs-identifier">srtEntry</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#SRTEntry"><span class="hs-identifier hs-var">SRTEntry</span></a><span> </span><a name="local-6989586621680948839"><a href="#local-6989586621680948839"><span class="hs-identifier">srtLbl</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-781"></a><span>          </span><a href="CmmBuildInfoTables.html#srtTrace"><span class="hs-identifier hs-var">srtTrace</span></a><span> </span><span class="hs-string">&quot;oneSRT [Common]&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680948807"><span class="hs-identifier hs-var">lbls</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680948839"><span class="hs-identifier hs-var">srtLbl</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-782"></a><span>          </span><a href="#local-6989586621680948826"><span class="hs-identifier hs-var">updateSRTMap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680948838"><span class="hs-identifier hs-var">srtEntry</span></a><span class="hs-special">)</span><span>
</span><a name="line-783"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><a href="#local-6989586621680948839"><span class="hs-identifier hs-var">srtLbl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680948806"><span class="hs-identifier hs-var">blockids</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-784"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-785"></a><span>          </span><span class="hs-comment">-- No duplicates: we have to build a new SRT object</span><span>
</span><a name="line-786"></a><span>          </span><a href="CmmBuildInfoTables.html#srtTrace"><span class="hs-identifier hs-var">srtTrace</span></a><span> </span><span class="hs-string">&quot;oneSRT: new&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680948807"><span class="hs-identifier hs-var">lbls</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680948817"><span class="hs-identifier hs-var">filtered</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-787"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621680948844"><a href="#local-6989586621680948844"><span class="hs-identifier">decls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680948845"><a href="#local-6989586621680948845"><span class="hs-identifier">funSRTs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680948846"><a href="#local-6989586621680948846"><span class="hs-identifier">srtEntry</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-788"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680948812"><span class="hs-identifier hs-var">maybeFunClosure</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-789"></a><span>              </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680948840"><a href="#local-6989586621680948840"><span class="hs-identifier">fun</span></a></a><span class="hs-special">,</span><a name="local-6989586621680948841"><a href="#local-6989586621680948841"><span class="hs-identifier">block</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-790"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621680948841"><span class="hs-identifier hs-var">block</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680948837"><span class="hs-identifier hs-var">cafList</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="CmmBuildInfoTables.html#SRTEntry"><span class="hs-identifier hs-var">SRTEntry</span></a><span> </span><a href="#local-6989586621680948840"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-791"></a><span>              </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-792"></a><span>                </span><span class="hs-special">(</span><a name="local-6989586621680948842"><a href="#local-6989586621680948842"><span class="hs-identifier">decls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680948843"><a href="#local-6989586621680948843"><span class="hs-identifier">entry</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmBuildInfoTables.html#buildSRTChain"><span class="hs-identifier hs-var">buildSRTChain</span></a><span> </span><a href="#local-6989586621680948804"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680948837"><span class="hs-identifier hs-var">cafList</span></a><span>
</span><a name="line-793"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680948842"><span class="hs-identifier hs-var">decls</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680948843"><span class="hs-identifier hs-var">entry</span></a><span class="hs-special">)</span><span>
</span><a name="line-794"></a><span>          </span><a href="#local-6989586621680948826"><span class="hs-identifier hs-var">updateSRTMap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680948846"><span class="hs-identifier hs-var">srtEntry</span></a><span class="hs-special">)</span><span>
</span><a name="line-795"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680948847"><a href="#local-6989586621680948847"><span class="hs-identifier">allBelowThis</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.union</span><span> </span><a href="#local-6989586621680948816"><span class="hs-identifier hs-var">allBelow</span></a><span> </span><a href="#local-6989586621680948817"><span class="hs-identifier hs-var">filtered</span></a><span>
</span><a name="line-796"></a><span>              </span><a name="local-6989586621680948848"><a href="#local-6989586621680948848"><span class="hs-identifier">oldFlatSRTs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">flatSRTs</span><span> </span><a href="#local-6989586621680948811"><span class="hs-identifier hs-var">topSRT</span></a><span>
</span><a name="line-797"></a><span>              </span><a name="local-6989586621680948849"><a href="#local-6989586621680948849"><span class="hs-identifier">newFlatSRTs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.insert</span><span> </span><a href="#local-6989586621680948846"><span class="hs-identifier hs-var">srtEntry</span></a><span> </span><a href="#local-6989586621680948847"><span class="hs-identifier hs-var">allBelowThis</span></a><span> </span><a href="#local-6989586621680948848"><span class="hs-identifier hs-var">oldFlatSRTs</span></a><span>
</span><a name="line-798"></a><span>              </span><a name="local-6989586621680948850"><a href="#local-6989586621680948850"><span class="hs-identifier">newDedupSRTs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.insert</span><span> </span><a href="#local-6989586621680948817"><span class="hs-identifier hs-var">filtered</span></a><span> </span><a href="#local-6989586621680948846"><span class="hs-identifier hs-var">srtEntry</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">dedupSRTs</span><span> </span><a href="#local-6989586621680948811"><span class="hs-identifier hs-var">topSRT</span></a><span class="hs-special">)</span><span>
</span><a name="line-799"></a><span>          </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">put</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680948811"><span class="hs-identifier hs-var">topSRT</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dedupSRTs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680948850"><span class="hs-identifier hs-var">newDedupSRTs</span></a><span>
</span><a name="line-800"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">flatSRTs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680948849"><span class="hs-identifier hs-var">newFlatSRTs</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-801"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a href="CmmBuildInfoTables.html#SRTEntry"><span class="hs-identifier hs-var">SRTEntry</span></a><span> </span><a name="local-6989586621680948851"><a href="#local-6989586621680948851"><span class="hs-identifier">lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680948846"><span class="hs-identifier hs-var">srtEntry</span></a><span>
</span><a name="line-802"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680948844"><span class="hs-identifier hs-var">decls</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><a href="#local-6989586621680948851"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680948806"><span class="hs-identifier hs-var">blockids</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680948845"><span class="hs-identifier hs-var">funSRTs</span></a><span class="hs-special">)</span><span>
</span><a name="line-803"></a><span>
</span><a name="line-804"></a><span>
</span><a name="line-805"></a><span class="hs-comment">-- | build a static SRT object (or a chain of objects) from a list of</span><span>
</span><a name="line-806"></a><span class="hs-comment">-- SRTEntries.</span><span>
</span><a name="line-807"></a><span class="hs-identifier">buildSRTChain</span><span>
</span><a name="line-808"></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-809"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmBuildInfoTables.html#SRTEntry"><span class="hs-identifier hs-type">SRTEntry</span></a><span class="hs-special">]</span><span>
</span><a name="line-810"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span>
</span><a name="line-811"></a><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- The SRT object(s)</span><span>
</span><a name="line-812"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="CmmBuildInfoTables.html#SRTEntry"><span class="hs-identifier hs-type">SRTEntry</span></a><span>     </span><span class="hs-comment">-- label to use in the info table</span><span>
</span><a name="line-813"></a><span>        </span><span class="hs-special">)</span><span>
</span><a name="line-814"></a><a name="buildSRTChain"><a href="CmmBuildInfoTables.html#buildSRTChain"><span class="hs-identifier">buildSRTChain</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;buildSRT: empty&quot;</span><span>
</span><a name="line-815"></a><span class="hs-identifier">buildSRTChain</span><span> </span><a name="local-6989586621680948852"><a href="#local-6989586621680948852"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680948853"><a href="#local-6989586621680948853"><span class="hs-identifier">cafSet</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-816"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">splitAt</span><span> </span><a href="#local-6989586621680948854"><span class="hs-identifier hs-var">mAX_SRT_SIZE</span></a><span> </span><a href="#local-6989586621680948853"><span class="hs-identifier hs-var">cafSet</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-817"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680948855"><a href="#local-6989586621680948855"><span class="hs-identifier">these</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-818"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621680948856"><a href="#local-6989586621680948856"><span class="hs-identifier">decl</span></a></a><span class="hs-special">,</span><a name="local-6989586621680948857"><a href="#local-6989586621680948857"><span class="hs-identifier">lbl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CmmBuildInfoTables.html#buildSRT"><span class="hs-identifier hs-var">buildSRT</span></a><span> </span><a href="#local-6989586621680948852"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680948855"><span class="hs-identifier hs-var">these</span></a><span>
</span><a name="line-819"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="#local-6989586621680948856"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680948857"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-820"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680948858"><a href="#local-6989586621680948858"><span class="hs-identifier">these</span></a></a><span class="hs-special">,</span><a name="local-6989586621680948859"><a href="#local-6989586621680948859"><span class="hs-identifier">those</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-821"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621680948860"><a href="#local-6989586621680948860"><span class="hs-identifier">rest</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680948861"><a href="#local-6989586621680948861"><span class="hs-identifier">rest_lbl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CmmBuildInfoTables.html#buildSRTChain"><span class="hs-identifier hs-var">buildSRTChain</span></a><span> </span><a href="#local-6989586621680948852"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621680948858"><span class="hs-identifier hs-var">these</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680948859"><span class="hs-identifier hs-var">those</span></a><span class="hs-special">)</span><span>
</span><a name="line-822"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621680948862"><a href="#local-6989586621680948862"><span class="hs-identifier">decl</span></a></a><span class="hs-special">,</span><a name="local-6989586621680948863"><a href="#local-6989586621680948863"><span class="hs-identifier">lbl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CmmBuildInfoTables.html#buildSRT"><span class="hs-identifier hs-var">buildSRT</span></a><span> </span><a href="#local-6989586621680948852"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680948861"><span class="hs-identifier hs-var">rest_lbl</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">tail</span><span> </span><a href="#local-6989586621680948858"><span class="hs-identifier hs-var">these</span></a><span class="hs-special">)</span><span>
</span><a name="line-823"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680948862"><span class="hs-identifier hs-var">decl</span></a><span class="hs-glyph">:</span><a href="#local-6989586621680948860"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680948863"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-824"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-825"></a><span>    </span><a name="local-6989586621680948854"><a href="#local-6989586621680948854"><span class="hs-identifier">mAX_SRT_SIZE</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">16</span><span>
</span><a name="line-826"></a><span>
</span><a name="line-827"></a><span>
</span><a name="line-828"></a><span class="hs-identifier">buildSRT</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmBuildInfoTables.html#SRTEntry"><span class="hs-identifier hs-type">SRTEntry</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span class="hs-special">,</span><span> </span><a href="CmmBuildInfoTables.html#SRTEntry"><span class="hs-identifier hs-type">SRTEntry</span></a><span class="hs-special">)</span><span>
</span><a name="line-829"></a><a name="buildSRT"><a href="CmmBuildInfoTables.html#buildSRT"><span class="hs-identifier">buildSRT</span></a></a><span> </span><a name="local-6989586621680948864"><a href="#local-6989586621680948864"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680948865"><a href="#local-6989586621680948865"><span class="hs-identifier">refs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-830"></a><span>  </span><a name="local-6989586621680948866"><a href="#local-6989586621680948866"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getUniqueM</span><span>
</span><a name="line-831"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-832"></a><span>    </span><a name="local-6989586621680948867"><a href="#local-6989586621680948867"><span class="hs-identifier">lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkSRTLabel"><span class="hs-identifier hs-var">mkSRTLabel</span></a><span> </span><a href="#local-6989586621680948866"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-833"></a><span>    </span><a name="local-6989586621680948868"><a href="#local-6989586621680948868"><span class="hs-identifier">srt_n_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkSRTInfoLabel"><span class="hs-identifier hs-var">mkSRTInfoLabel</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621680948865"><span class="hs-identifier hs-var">refs</span></a><span class="hs-special">)</span><span>
</span><a name="line-834"></a><span>    </span><a name="local-6989586621680948869"><a href="#local-6989586621680948869"><span class="hs-identifier">fields</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-835"></a><span>      </span><a href="StgCmmHeap.html#mkStaticClosure"><span class="hs-identifier hs-var">mkStaticClosure</span></a><span> </span><a href="#local-6989586621680948864"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680948868"><span class="hs-identifier hs-var">srt_n_info</span></a><span> </span><span class="hs-identifier hs-var">dontCareCCS</span><span>
</span><a name="line-836"></a><span>        </span><span class="hs-special">[</span><span> </span><a href="CmmExpr.html#CmmLabel"><span class="hs-identifier hs-var">CmmLabel</span></a><span> </span><a href="#local-6989586621680948870"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="CmmBuildInfoTables.html#SRTEntry"><span class="hs-identifier hs-var">SRTEntry</span></a><span> </span><a name="local-6989586621680948870"><a href="#local-6989586621680948870"><span class="hs-identifier">lbl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680948865"><span class="hs-identifier hs-var">refs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-837"></a><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- no padding</span><span>
</span><a name="line-838"></a><span>        </span><span class="hs-special">[</span><a href="CmmUtils.html#mkIntCLit"><span class="hs-identifier hs-var">mkIntCLit</span></a><span> </span><a href="#local-6989586621680948864"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- link field</span><span>
</span><a name="line-839"></a><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- no saved info</span><span>
</span><a name="line-840"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#mkDataLits"><span class="hs-identifier hs-var">mkDataLits</span></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#Section"><span class="hs-identifier hs-var">Section</span></a><span> </span><a href="Cmm.html#Data"><span class="hs-identifier hs-var">Data</span></a><span> </span><a href="#local-6989586621680948867"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680948867"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621680948869"><span class="hs-identifier hs-var">fields</span></a><span class="hs-special">,</span><span> </span><a href="CmmBuildInfoTables.html#SRTEntry"><span class="hs-identifier hs-var">SRTEntry</span></a><span> </span><a href="#local-6989586621680948867"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-841"></a><span>
</span><a name="line-842"></a><span>
</span><a name="line-843"></a><span class="hs-comment">-- | Update info tables with references to their SRTs. Also generate</span><span>
</span><a name="line-844"></a><span class="hs-comment">-- static closures, splicing in SRT fields as necessary.</span><span>
</span><a name="line-845"></a><span class="hs-identifier">updInfoSRTs</span><span>
</span><a name="line-846"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-847"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span>               </span><span class="hs-comment">-- SRT labels for each block</span><span>
</span><a name="line-848"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><span class="hs-special">[</span><a href="CmmBuildInfoTables.html#SRTEntry"><span class="hs-identifier hs-type">SRTEntry</span></a><span class="hs-special">]</span><span>           </span><span class="hs-comment">-- SRTs to merge into FUN_STATIC closures</span><span>
</span><a name="line-849"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span>
</span><a name="line-850"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span class="hs-special">]</span><span>
</span><a name="line-851"></a><span>
</span><a name="line-852"></a><a name="updInfoSRTs"><a href="CmmBuildInfoTables.html#updInfoSRTs"><span class="hs-identifier">updInfoSRTs</span></a></a><span> </span><a name="local-6989586621680948871"><a href="#local-6989586621680948871"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680948872"><a href="#local-6989586621680948872"><span class="hs-identifier">srt_env</span></a></a><span> </span><a name="local-6989586621680948873"><a href="#local-6989586621680948873"><span class="hs-identifier">funSRTEnv</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a name="local-6989586621680948874"><a href="#local-6989586621680948874"><span class="hs-identifier">top_info</span></a></a><span> </span><a name="local-6989586621680948875"><a href="#local-6989586621680948875"><span class="hs-identifier">top_l</span></a></a><span> </span><a name="local-6989586621680948876"><a href="#local-6989586621680948876"><span class="hs-identifier">live</span></a></a><span> </span><a name="local-6989586621680948877"><a href="#local-6989586621680948877"><span class="hs-identifier">g</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-853"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621680948906"><a href="#local-6989586621680948906"><span class="hs-identifier">closure</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680948881"><span class="hs-identifier hs-var">maybeStaticClosure</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621680948878"><span class="hs-identifier hs-var">proc</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680948906"><span class="hs-identifier hs-var">closure</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-854"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621680948878"><span class="hs-identifier hs-var">proc</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-855"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-856"></a><span>    </span><a name="local-6989586621680948878"><a href="#local-6989586621680948878"><span class="hs-identifier">proc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a href="#local-6989586621680948874"><span class="hs-identifier hs-var">top_info</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">info_tbls</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680948879"><span class="hs-identifier hs-var">newTopInfo</span></a><span> </span><span class="hs-special">}</span><span> </span><a href="#local-6989586621680948875"><span class="hs-identifier hs-var">top_l</span></a><span> </span><a href="#local-6989586621680948876"><span class="hs-identifier hs-var">live</span></a><span> </span><a href="#local-6989586621680948877"><span class="hs-identifier hs-var">g</span></a><span>
</span><a name="line-857"></a><span>    </span><a name="local-6989586621680948879"><a href="#local-6989586621680948879"><span class="hs-identifier">newTopInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapMapWithKey"><span class="hs-identifier hs-var">mapMapWithKey</span></a><span> </span><a href="#local-6989586621680948880"><span class="hs-identifier hs-var">updInfoTbl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">info_tbls</span><span> </span><a href="#local-6989586621680948874"><span class="hs-identifier hs-var">top_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-858"></a><span>    </span><a name="local-6989586621680948880"><a href="#local-6989586621680948880"><span class="hs-identifier">updInfoTbl</span></a></a><span> </span><a name="local-6989586621680948882"><a href="#local-6989586621680948882"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621680948883"><a href="#local-6989586621680948883"><span class="hs-identifier">info_tbl</span></a></a><span>
</span><a name="line-859"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680948882"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">g_entry</span><span> </span><a href="#local-6989586621680948877"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680948884"><a href="#local-6989586621680948884"><span class="hs-identifier">inf</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680948881"><span class="hs-identifier hs-var">maybeStaticClosure</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680948884"><span class="hs-identifier hs-var">inf</span></a><span>
</span><a name="line-860"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680948883"><span class="hs-identifier hs-var">info_tbl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cit_srt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621680948882"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621680948872"><span class="hs-identifier hs-var">srt_env</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-861"></a><span>
</span><a name="line-862"></a><span>    </span><span class="hs-comment">-- Generate static closures [FUN].  Note that this also generates</span><span>
</span><a name="line-863"></a><span>    </span><span class="hs-comment">-- static closures for thunks (CAFs), because it's easier to treat</span><span>
</span><a name="line-864"></a><span>    </span><span class="hs-comment">-- them uniformly in the code generator.</span><span>
</span><a name="line-865"></a><span>    </span><span class="hs-identifier">maybeStaticClosure</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmInfoTable"><span class="hs-identifier hs-type">CmmInfoTable</span></a><span class="hs-special">,</span><span> </span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span class="hs-special">)</span><span>
</span><a name="line-866"></a><span>    </span><a name="local-6989586621680948881"><a href="#local-6989586621680948881"><span class="hs-identifier">maybeStaticClosure</span></a></a><span>
</span><a name="line-867"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680948885"><a href="#local-6989586621680948885"><span class="hs-identifier">info_tbl</span></a></a><span class="hs-glyph">@</span><a href="Cmm.html#CmmInfoTable"><span class="hs-identifier hs-var">CmmInfoTable</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-868"></a><span>           </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">g_entry</span><span> </span><a href="#local-6989586621680948877"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">info_tbls</span><span> </span><a href="#local-6989586621680948874"><span class="hs-identifier hs-var">top_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-869"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680948891"><a href="#local-6989586621680948891"><span class="hs-identifier">id</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680948892"><a href="#local-6989586621680948892"><span class="hs-identifier">ccs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680948890"><span class="hs-identifier hs-var">cit_clo</span></a><span>
</span><a name="line-870"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="SMRep.html#isStaticRep"><span class="hs-identifier hs-var">isStaticRep</span></a><span> </span><a href="#local-6989586621680948887"><span class="hs-identifier hs-var">cit_rep</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-871"></a><span>        </span><span class="hs-keyword">let</span><span>
</span><a name="line-872"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621680948893"><a href="#local-6989586621680948893"><span class="hs-identifier">newInfo</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680948894"><a href="#local-6989586621680948894"><span class="hs-identifier">srtEntries</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">g_entry</span><span> </span><a href="#local-6989586621680948877"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680948873"><span class="hs-identifier hs-var">funSRTEnv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-873"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-874"></a><span>              </span><span class="hs-comment">-- if we don't add SRT entries to this closure, then we</span><span>
</span><a name="line-875"></a><span>              </span><span class="hs-comment">-- want to set the srt field in its info table as usual</span><span>
</span><a name="line-876"></a><span>              </span><span class="hs-special">(</span><a href="#local-6989586621680948885"><span class="hs-identifier hs-var">info_tbl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cit_srt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">g_entry</span><span> </span><a href="#local-6989586621680948877"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680948872"><span class="hs-identifier hs-var">srt_env</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-877"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680948898"><a href="#local-6989586621680948898"><span class="hs-identifier">srtEntries</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmBuildInfoTables.html#srtTrace"><span class="hs-identifier hs-var">srtTrace</span></a><span> </span><span class="hs-string">&quot;maybeStaticFun&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680948899"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span>
</span><a name="line-878"></a><span>              </span><span class="hs-special">(</span><a href="#local-6989586621680948885"><span class="hs-identifier hs-var">info_tbl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cit_rep</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680948896"><span class="hs-identifier hs-var">new_rep</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680948899"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span>
</span><a name="line-879"></a><span>              </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621680948899"><a href="#local-6989586621680948899"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="CmmExpr.html#CmmLabel"><span class="hs-identifier hs-var">CmmLabel</span></a><span> </span><a href="#local-6989586621680948900"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="CmmBuildInfoTables.html#SRTEntry"><span class="hs-identifier hs-var">SRTEntry</span></a><span> </span><a name="local-6989586621680948900"><a href="#local-6989586621680948900"><span class="hs-identifier">lbl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680948898"><span class="hs-identifier hs-var">srtEntries</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-880"></a><span>          </span><a name="local-6989586621680948895"><a href="#local-6989586621680948895"><span class="hs-identifier">fields</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmHeap.html#mkStaticClosureFields"><span class="hs-identifier hs-var">mkStaticClosureFields</span></a><span> </span><a href="#local-6989586621680948871"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680948885"><span class="hs-identifier hs-var">info_tbl</span></a><span> </span><a href="#local-6989586621680948892"><span class="hs-identifier hs-var">ccs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idCafInfo</span><span> </span><a href="#local-6989586621680948891"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-881"></a><span>            </span><a href="#local-6989586621680948894"><span class="hs-identifier hs-var">srtEntries</span></a><span>
</span><a name="line-882"></a><span>          </span><a name="local-6989586621680948896"><a href="#local-6989586621680948896"><span class="hs-identifier">new_rep</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680948887"><span class="hs-identifier hs-var">cit_rep</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-883"></a><span>             </span><a href="SMRep.html#HeapRep"><span class="hs-identifier hs-var">HeapRep</span></a><span> </span><a name="local-6989586621680948901"><a href="#local-6989586621680948901"><span class="hs-identifier">sta</span></a></a><span> </span><a name="local-6989586621680948902"><a href="#local-6989586621680948902"><span class="hs-identifier">ptrs</span></a></a><span> </span><a name="local-6989586621680948903"><a href="#local-6989586621680948903"><span class="hs-identifier">nptrs</span></a></a><span> </span><a name="local-6989586621680948904"><a href="#local-6989586621680948904"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-884"></a><span>               </span><a href="SMRep.html#HeapRep"><span class="hs-identifier hs-var">HeapRep</span></a><span> </span><a href="#local-6989586621680948901"><span class="hs-identifier hs-var">sta</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680948902"><span class="hs-identifier hs-var">ptrs</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621680948894"><span class="hs-identifier hs-var">srtEntries</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680948903"><span class="hs-identifier hs-var">nptrs</span></a><span> </span><a href="#local-6989586621680948904"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-885"></a><span>             </span><a name="local-6989586621680948905"><a href="#local-6989586621680948905"><span class="hs-identifier">_other</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;maybeStaticFun&quot;</span><span>
</span><a name="line-886"></a><span>          </span><a name="local-6989586621680948897"><a href="#local-6989586621680948897"><span class="hs-identifier">lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkLocalClosureLabel"><span class="hs-identifier hs-var">mkLocalClosureLabel</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621680948891"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idCafInfo</span><span> </span><a href="#local-6989586621680948891"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-887"></a><span>        </span><span class="hs-keyword">in</span><span>
</span><a name="line-888"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680948893"><span class="hs-identifier hs-var">newInfo</span></a><span class="hs-special">,</span><span> </span><a href="CmmUtils.html#mkDataLits"><span class="hs-identifier hs-var">mkDataLits</span></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#Section"><span class="hs-identifier hs-var">Section</span></a><span> </span><a href="Cmm.html#Data"><span class="hs-identifier hs-var">Data</span></a><span> </span><a href="#local-6989586621680948897"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680948897"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621680948895"><span class="hs-identifier hs-var">fields</span></a><span class="hs-special">)</span><span>
</span><a name="line-889"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-890"></a><span>
</span><a name="line-891"></a><span class="hs-identifier">updInfoSRTs</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680948907"><a href="#local-6989586621680948907"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680948907"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">]</span><span>
</span><a name="line-892"></a><span>
</span><a name="line-893"></a><span>
</span><a name="line-894"></a><span class="hs-identifier">srtTrace</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680948563"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680948563"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-895"></a><span class="hs-comment">-- srtTrace = pprTrace</span><span>
</span><a name="line-896"></a><a name="srtTrace"><a href="CmmBuildInfoTables.html#srtTrace"><span class="hs-identifier">srtTrace</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680948908"><a href="#local-6989586621680948908"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680948908"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-897"></a></pre></body></html>