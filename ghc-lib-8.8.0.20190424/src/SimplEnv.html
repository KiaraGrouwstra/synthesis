<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The AQUA Project, Glasgow University, 1993-1998

\section[SimplMonad]{The simplifier Monad}
-}</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">SimplEnv</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-10"></a><span>        </span><span class="hs-comment">-- * The simplifier mode</span><span>
</span><a name="line-11"></a><span>        </span><a href="SimplEnv.html#setMode"><span class="hs-identifier hs-var">setMode</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#getMode"><span class="hs-identifier hs-var">getMode</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#updMode"><span class="hs-identifier hs-var">updMode</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#seDynFlags"><span class="hs-identifier hs-var">seDynFlags</span></a><span class="hs-special">,</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span>        </span><span class="hs-comment">-- * Environments</span><span>
</span><a name="line-14"></a><span>        </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#pprSimplEnv"><span class="hs-identifier hs-var">pprSimplEnv</span></a><span class="hs-special">,</span><span>   </span><span class="hs-comment">-- Temp not abstract</span><span>
</span><a name="line-15"></a><span>        </span><a href="SimplEnv.html#mkSimplEnv"><span class="hs-identifier hs-var">mkSimplEnv</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#extendIdSubst"><span class="hs-identifier hs-var">extendIdSubst</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>        </span><a href="SimplEnv.html#extendTvSubst"><span class="hs-identifier hs-var">SimplEnv.extendTvSubst</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#extendCvSubst"><span class="hs-identifier hs-var">SimplEnv.extendCvSubst</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>        </span><a href="SimplEnv.html#zapSubstEnv"><span class="hs-identifier hs-var">zapSubstEnv</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#setSubstEnv"><span class="hs-identifier hs-var">setSubstEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>        </span><a href="SimplEnv.html#getInScope"><span class="hs-identifier hs-var">getInScope</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#setInScopeFromE"><span class="hs-identifier hs-var">setInScopeFromE</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#setInScopeFromF"><span class="hs-identifier hs-var">setInScopeFromF</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>        </span><a href="SimplEnv.html#setInScopeSet"><span class="hs-identifier hs-var">setInScopeSet</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#modifyInScope"><span class="hs-identifier hs-var">modifyInScope</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#addNewInScopeIds"><span class="hs-identifier hs-var">addNewInScopeIds</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>        </span><a href="SimplMonad.html#getSimplRules"><span class="hs-identifier hs-var">getSimplRules</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span>        </span><span class="hs-comment">-- * Substitution results</span><span>
</span><a name="line-23"></a><span>        </span><a href="SimplEnv.html#SimplSR"><span class="hs-identifier hs-type">SimplSR</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#mkContEx"><span class="hs-identifier hs-var">mkContEx</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#substId"><span class="hs-identifier hs-var">substId</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#lookupRecBndr"><span class="hs-identifier hs-var">lookupRecBndr</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#refineFromInScope"><span class="hs-identifier hs-var">refineFromInScope</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span>        </span><span class="hs-comment">-- * Simplifying 'Id' binders</span><span>
</span><a name="line-26"></a><span>        </span><a href="SimplEnv.html#simplNonRecBndr"><span class="hs-identifier hs-var">simplNonRecBndr</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#simplNonRecJoinBndr"><span class="hs-identifier hs-var">simplNonRecJoinBndr</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#simplRecBndrs"><span class="hs-identifier hs-var">simplRecBndrs</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#simplRecJoinBndrs"><span class="hs-identifier hs-var">simplRecJoinBndrs</span></a><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>        </span><a href="SimplEnv.html#simplBinder"><span class="hs-identifier hs-var">simplBinder</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#simplBinders"><span class="hs-identifier hs-var">simplBinders</span></a><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>        </span><a href="SimplEnv.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#substTyVar"><span class="hs-identifier hs-var">substTyVar</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#getTCvSubst"><span class="hs-identifier hs-var">getTCvSubst</span></a><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>        </span><a href="SimplEnv.html#substCo"><span class="hs-identifier hs-var">substCo</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#substCoVar"><span class="hs-identifier hs-var">substCoVar</span></a><span class="hs-special">,</span><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span>        </span><span class="hs-comment">-- * Floats</span><span>
</span><a name="line-32"></a><span>        </span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#emptyFloats"><span class="hs-identifier hs-var">emptyFloats</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#mkRecFloats"><span class="hs-identifier hs-var">mkRecFloats</span></a><span class="hs-special">,</span><span>
</span><a name="line-33"></a><span>        </span><a href="SimplEnv.html#mkFloatBind"><span class="hs-identifier hs-var">mkFloatBind</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#addLetFloats"><span class="hs-identifier hs-var">addLetFloats</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#addJoinFloats"><span class="hs-identifier hs-var">addJoinFloats</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#addFloats"><span class="hs-identifier hs-var">addFloats</span></a><span class="hs-special">,</span><span>
</span><a name="line-34"></a><span>        </span><a href="SimplEnv.html#extendFloats"><span class="hs-identifier hs-var">extendFloats</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#wrapFloats"><span class="hs-identifier hs-var">wrapFloats</span></a><span class="hs-special">,</span><span>
</span><a name="line-35"></a><span>        </span><a href="SimplEnv.html#doFloatFromRhs"><span class="hs-identifier hs-var">doFloatFromRhs</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#getTopFloatBinds"><span class="hs-identifier hs-var">getTopFloatBinds</span></a><span class="hs-special">,</span><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span>        </span><span class="hs-comment">-- * LetFloats</span><span>
</span><a name="line-38"></a><span>        </span><a href="SimplEnv.html#LetFloats"><span class="hs-identifier hs-type">LetFloats</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#letFloatBinds"><span class="hs-identifier hs-var">letFloatBinds</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#emptyLetFloats"><span class="hs-identifier hs-var">emptyLetFloats</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#unitLetFloat"><span class="hs-identifier hs-var">unitLetFloat</span></a><span class="hs-special">,</span><span>
</span><a name="line-39"></a><span>        </span><a href="SimplEnv.html#addLetFlts"><span class="hs-identifier hs-var">addLetFlts</span></a><span class="hs-special">,</span><span>  </span><a href="SimplEnv.html#mapLetFloats"><span class="hs-identifier hs-var">mapLetFloats</span></a><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span>        </span><span class="hs-comment">-- * JoinFloats</span><span>
</span><a name="line-42"></a><span>        </span><a href="SimplEnv.html#JoinFloat"><span class="hs-identifier hs-type">JoinFloat</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#JoinFloats"><span class="hs-identifier hs-type">JoinFloats</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#emptyJoinFloats"><span class="hs-identifier hs-var">emptyJoinFloats</span></a><span class="hs-special">,</span><span>
</span><a name="line-43"></a><span>        </span><a href="SimplEnv.html#wrapJoinFloats"><span class="hs-identifier hs-var">wrapJoinFloats</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#wrapJoinFloatsX"><span class="hs-identifier hs-var">wrapJoinFloatsX</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#unitJoinFloat"><span class="hs-identifier hs-var">unitJoinFloat</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#addJoinFlts"><span class="hs-identifier hs-var">addJoinFlts</span></a><span>
</span><a name="line-44"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><a href="SimplMonad.html"><span class="hs-identifier">SimplMonad</span></a><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreMonad</span><span>                </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">SimplMode</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreSyn</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreUtils</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Var</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarEnv</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarSet</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">OrdList</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MkCore</span><span>                   </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkWildValBinder</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>                 </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysWiredIn</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span> </span><span class="hs-keyword">hiding</span><span>              </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">substTy</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">substTyVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">substTyVarBndr</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Coercion</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Coercion</span><span> </span><span class="hs-keyword">hiding</span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">substCo</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">substCoVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">substCoVarBndr</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MonadUtils</span><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqFM</span><span>                   </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">pprUniqFM</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-73"></a><span>
</span><a name="line-74"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsubsection{The @SimplEnv@ type}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-81"></a><span>
</span><a name="line-82"></a><span class="hs-keyword">data</span><span> </span><a name="SimplEnv"><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier">SimplEnv</span></a></a><span>
</span><a name="line-83"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="SimplEnv"><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier">SimplEnv</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-84"></a><span>     </span><span class="hs-comment">----------- Static part of the environment -----------</span><span>
</span><a name="line-85"></a><span>     </span><span class="hs-comment">-- Static in the sense of lexically scoped,</span><span>
</span><a name="line-86"></a><span>     </span><span class="hs-comment">-- wrt the original expression</span><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span>        </span><a name="seMode"><a href="SimplEnv.html#seMode"><span class="hs-identifier">seMode</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SimplMode</span><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span>        </span><span class="hs-comment">-- The current substitution</span><span>
</span><a name="line-91"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="seTvSubst"><a href="SimplEnv.html#seTvSubst"><span class="hs-identifier">seTvSubst</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TvSubstEnv</span><span>      </span><span class="hs-comment">-- InTyVar |--&gt; OutType</span><span>
</span><a name="line-92"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="seCvSubst"><a href="SimplEnv.html#seCvSubst"><span class="hs-identifier">seCvSubst</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CvSubstEnv</span><span>      </span><span class="hs-comment">-- InCoVar |--&gt; OutCoercion</span><span>
</span><a name="line-93"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="seIdSubst"><a href="SimplEnv.html#seIdSubst"><span class="hs-identifier">seIdSubst</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplIdSubst"><span class="hs-identifier hs-type">SimplIdSubst</span></a><span>    </span><span class="hs-comment">-- InId    |--&gt; OutExpr</span><span>
</span><a name="line-94"></a><span>
</span><a name="line-95"></a><span>     </span><span class="hs-comment">----------- Dynamic part of the environment -----------</span><span>
</span><a name="line-96"></a><span>     </span><span class="hs-comment">-- Dynamic in the sense of describing the setup where</span><span>
</span><a name="line-97"></a><span>     </span><span class="hs-comment">-- the expression finally ends up</span><span>
</span><a name="line-98"></a><span>
</span><a name="line-99"></a><span>        </span><span class="hs-comment">-- The current set of in-scope variables</span><span>
</span><a name="line-100"></a><span>        </span><span class="hs-comment">-- They are all OutVars, and all bound in this module</span><span>
</span><a name="line-101"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="seInScope"><a href="SimplEnv.html#seInScope"><span class="hs-identifier">seInScope</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">InScopeSet</span><span>       </span><span class="hs-comment">-- OutVars only</span><span>
</span><a name="line-102"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span class="hs-keyword">data</span><span> </span><a name="SimplFloats"><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier">SimplFloats</span></a></a><span>
</span><a name="line-105"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="SimplFloats"><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier">SimplFloats</span></a></a><span>
</span><a name="line-106"></a><span>      </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Ordinary let bindings</span><span>
</span><a name="line-107"></a><span>        </span><a name="sfLetFloats"><a href="SimplEnv.html#sfLetFloats"><span class="hs-identifier">sfLetFloats</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#LetFloats"><span class="hs-identifier hs-type">LetFloats</span></a><span>
</span><a name="line-108"></a><span>                </span><span class="hs-comment">-- See Note [LetFloats]</span><span>
</span><a name="line-109"></a><span>
</span><a name="line-110"></a><span>        </span><span class="hs-comment">-- Join points</span><span>
</span><a name="line-111"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="sfJoinFloats"><a href="SimplEnv.html#sfJoinFloats"><span class="hs-identifier">sfJoinFloats</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#JoinFloats"><span class="hs-identifier hs-type">JoinFloats</span></a><span>
</span><a name="line-112"></a><span>                </span><span class="hs-comment">-- Handled separately; they don't go very far</span><span>
</span><a name="line-113"></a><span>                </span><span class="hs-comment">-- We consider these to be /inside/ sfLetFloats</span><span>
</span><a name="line-114"></a><span>                </span><span class="hs-comment">-- because join points can refer to ordinary bindings,</span><span>
</span><a name="line-115"></a><span>                </span><span class="hs-comment">-- but not vice versa</span><span>
</span><a name="line-116"></a><span>
</span><a name="line-117"></a><span>        </span><span class="hs-comment">-- Includes all variables bound by sfLetFloats and</span><span>
</span><a name="line-118"></a><span>        </span><span class="hs-comment">-- sfJoinFloats, plus at least whatever is in scope where</span><span>
</span><a name="line-119"></a><span>        </span><span class="hs-comment">-- these bindings land up.</span><span>
</span><a name="line-120"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="sfInScope"><a href="SimplEnv.html#sfInScope"><span class="hs-identifier">sfInScope</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">InScopeSet</span><span>  </span><span class="hs-comment">-- All OutVars</span><span>
</span><a name="line-121"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-122"></a><span>
</span><a name="line-123"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-124"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-var">SimplFloats</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sfLetFloats</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421622"><a href="#local-6989586621680421622"><span class="hs-identifier">lf</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sfJoinFloats</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421623"><a href="#local-6989586621680421623"><span class="hs-identifier">jf</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sfInScope</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421624"><a href="#local-6989586621680421624"><span class="hs-identifier">is</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-125"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;SimplFloats&quot;</span><span>
</span><a name="line-126"></a><span>      </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">braces</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;lets: &quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680421622"><span class="hs-identifier hs-var">lf</span></a><span>
</span><a name="line-127"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;joins:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680421623"><span class="hs-identifier hs-var">jf</span></a><span>
</span><a name="line-128"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;in_scope:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680421624"><span class="hs-identifier hs-var">is</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-129"></a><span>
</span><a name="line-130"></a><span class="hs-identifier">emptyFloats</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a><span>
</span><a name="line-131"></a><a name="emptyFloats"><a href="SimplEnv.html#emptyFloats"><span class="hs-identifier">emptyFloats</span></a></a><span> </span><a name="local-6989586621680421625"><a href="#local-6989586621680421625"><span class="hs-identifier">env</span></a></a><span>
</span><a name="line-132"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-var">SimplFloats</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sfLetFloats</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#emptyLetFloats"><span class="hs-identifier hs-var">emptyLetFloats</span></a><span>
</span><a name="line-133"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sfJoinFloats</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#emptyJoinFloats"><span class="hs-identifier hs-var">emptyJoinFloats</span></a><span>
</span><a name="line-134"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sfInScope</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">seInScope</span><span> </span><a href="#local-6989586621680421625"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-135"></a><span>
</span><a name="line-136"></a><span class="hs-identifier">pprSimplEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-137"></a><span class="hs-comment">-- Used for debugging; selective</span><span>
</span><a name="line-138"></a><a name="pprSimplEnv"><a href="SimplEnv.html#pprSimplEnv"><span class="hs-identifier">pprSimplEnv</span></a></a><span> </span><a name="local-6989586621680421626"><a href="#local-6989586621680421626"><span class="hs-identifier">env</span></a></a><span>
</span><a name="line-139"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;TvSubst:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">seTvSubst</span><span> </span><a href="#local-6989586621680421626"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-140"></a><span>          </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;CvSubst:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">seCvSubst</span><span> </span><a href="#local-6989586621680421626"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-141"></a><span>          </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;IdSubst:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621680421627"><span class="hs-identifier hs-var">id_subst_doc</span></a><span class="hs-special">,</span><span>
</span><a name="line-142"></a><span>          </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;InScope:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621680421628"><span class="hs-identifier hs-var">in_scope_vars_doc</span></a><span>
</span><a name="line-143"></a><span>    </span><span class="hs-special">]</span><span>
</span><a name="line-144"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-145"></a><span>   </span><a name="local-6989586621680421627"><a href="#local-6989586621680421627"><span class="hs-identifier">id_subst_doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprUniqFM</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">seIdSubst</span><span> </span><a href="#local-6989586621680421626"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-146"></a><span>   </span><a name="local-6989586621680421628"><a href="#local-6989586621680421628"><span class="hs-identifier">in_scope_vars_doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprVarSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getInScopeVars</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">seInScope</span><span> </span><a href="#local-6989586621680421626"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-147"></a><span>                                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621680421629"><span class="hs-identifier hs-var">ppr_one</span></a><span class="hs-special">)</span><span>
</span><a name="line-148"></a><span>   </span><a name="local-6989586621680421629"><a href="#local-6989586621680421629"><span class="hs-identifier">ppr_one</span></a></a><span> </span><a name="local-6989586621680421630"><a href="#local-6989586621680421630"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isId</span><span> </span><a href="#local-6989586621680421630"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680421630"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idUnfolding</span><span> </span><a href="#local-6989586621680421630"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-149"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680421630"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-150"></a><span>
</span><a name="line-151"></a><span class="hs-keyword">type</span><span> </span><a name="SimplIdSubst"><a href="SimplEnv.html#SimplIdSubst"><span class="hs-identifier">SimplIdSubst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">IdEnv</span><span> </span><a href="SimplEnv.html#SimplSR"><span class="hs-identifier hs-type">SimplSR</span></a><span> </span><span class="hs-comment">-- IdId |--&gt; OutExpr</span><span>
</span><a name="line-152"></a><span>        </span><span class="hs-comment">-- See Note [Extending the Subst] in CoreSubst</span><span>
</span><a name="line-153"></a><span>
</span><a name="line-154"></a><span class="hs-comment">-- | A substitution result.</span><span>
</span><a name="line-155"></a><span class="hs-keyword">data</span><span> </span><a name="SimplSR"><a href="SimplEnv.html#SimplSR"><span class="hs-identifier">SimplSR</span></a></a><span>
</span><a name="line-156"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="DoneEx"><a href="SimplEnv.html#DoneEx"><span class="hs-identifier">DoneEx</span></a></a><span> </span><span class="hs-identifier hs-type">OutExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">JoinArity</span><span class="hs-special">)</span><span>
</span><a name="line-157"></a><span>       </span><span class="hs-comment">-- If  x :-&gt; DoneEx e ja   is in the SimplIdSubst</span><span>
</span><a name="line-158"></a><span>       </span><span class="hs-comment">-- then replace occurrences of x by e</span><span>
</span><a name="line-159"></a><span>       </span><span class="hs-comment">-- and  ja = Just a &lt;=&gt; x is a join-point of arity a</span><span>
</span><a name="line-160"></a><span>       </span><span class="hs-comment">-- See Note [Join arity in SimplIdSubst]</span><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span>
</span><a name="line-163"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="DoneId"><a href="SimplEnv.html#DoneId"><span class="hs-identifier">DoneId</span></a></a><span> </span><span class="hs-identifier hs-type">OutId</span><span>
</span><a name="line-164"></a><span>       </span><span class="hs-comment">-- If  x :-&gt; DoneId v   is in the SimplIdSubst</span><span>
</span><a name="line-165"></a><span>       </span><span class="hs-comment">-- then replace occurrences of x by v</span><span>
</span><a name="line-166"></a><span>       </span><span class="hs-comment">-- and  v is a join-point of arity a</span><span>
</span><a name="line-167"></a><span>       </span><span class="hs-comment">--      &lt;=&gt; x is a join-point of arity a</span><span>
</span><a name="line-168"></a><span>
</span><a name="line-169"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="ContEx"><a href="SimplEnv.html#ContEx"><span class="hs-identifier">ContEx</span></a></a><span> </span><span class="hs-identifier hs-type">TvSubstEnv</span><span>                 </span><span class="hs-comment">-- A suspended substitution</span><span>
</span><a name="line-170"></a><span>           </span><span class="hs-identifier hs-type">CvSubstEnv</span><span>
</span><a name="line-171"></a><span>           </span><a href="SimplEnv.html#SimplIdSubst"><span class="hs-identifier hs-type">SimplIdSubst</span></a><span>
</span><a name="line-172"></a><span>           </span><span class="hs-identifier hs-type">InExpr</span><span>
</span><a name="line-173"></a><span>      </span><span class="hs-comment">-- If   x :-&gt; ContEx tv cv id e   is in the SimplISubst</span><span>
</span><a name="line-174"></a><span>      </span><span class="hs-comment">-- then replace occurrences of x by (subst (tv,cv,id) e)</span><span>
</span><a name="line-175"></a><span>
</span><a name="line-176"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="SimplEnv.html#SimplSR"><span class="hs-identifier hs-type">SimplSR</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-177"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#DoneId"><span class="hs-identifier hs-var">DoneId</span></a><span> </span><a name="local-6989586621680421613"><a href="#local-6989586621680421613"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;DoneId&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680421613"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-178"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#DoneEx"><span class="hs-identifier hs-var">DoneEx</span></a><span> </span><a name="local-6989586621680421614"><a href="#local-6989586621680421614"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621680421615"><a href="#local-6989586621680421615"><span class="hs-identifier">mj</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;DoneEx&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621680421616"><span class="hs-identifier hs-var">pp_mj</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680421614"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-179"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-180"></a><span>      </span><a name="local-6989586621680421616"><a href="#local-6989586621680421616"><span class="hs-identifier">pp_mj</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680421615"><span class="hs-identifier hs-var">mj</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-181"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-182"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680421617"><a href="#local-6989586621680421617"><span class="hs-identifier">n</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">int</span><span> </span><a href="#local-6989586621680421617"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#ContEx"><span class="hs-identifier hs-var">ContEx</span></a><span> </span><a name="local-6989586621680421618"><a href="#local-6989586621680421618"><span class="hs-identifier">_tv</span></a></a><span> </span><a name="local-6989586621680421619"><a href="#local-6989586621680421619"><span class="hs-identifier">_cv</span></a></a><span> </span><a name="local-6989586621680421620"><a href="#local-6989586621680421620"><span class="hs-identifier">_id</span></a></a><span> </span><a name="local-6989586621680421621"><a href="#local-6989586621680421621"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;ContEx&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680421621"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-comment">{-,
                                ppr (filter_env tv), ppr (filter_env id) -}</span><span class="hs-special">]</span><span>
</span><a name="line-186"></a><span>        </span><span class="hs-comment">-- where</span><span>
</span><a name="line-187"></a><span>        </span><span class="hs-comment">-- fvs = exprFreeVars e</span><span>
</span><a name="line-188"></a><span>        </span><span class="hs-comment">-- filter_env env = filterVarEnv_Directly keep env</span><span>
</span><a name="line-189"></a><span>        </span><span class="hs-comment">-- keep uniq _ = uniq `elemUFM_Directly` fvs</span><span>
</span><a name="line-190"></a><span>
</span><a name="line-191"></a><span class="hs-comment">{-
Note [SimplEnv invariants]
~~~~~~~~~~~~~~~~~~~~~~~~~~
seInScope:
        The in-scope part of Subst includes *all* in-scope TyVars and Ids
        The elements of the set may have better IdInfo than the
        occurrences of in-scope Ids, and (more important) they will
        have a correctly-substituted type.  So we use a lookup in this
        set to replace occurrences

        The Ids in the InScopeSet are replete with their Rules,
        and as we gather info about the unfolding of an Id, we replace
        it in the in-scope set.

        The in-scope set is actually a mapping OutVar -&gt; OutVar, and
        in case expressions we sometimes bind

seIdSubst:
        The substitution is *apply-once* only, because InIds and OutIds
        can overlap.
        For example, we generally omit mappings
                a77 -&gt; a77
        from the substitution, when we decide not to clone a77, but it's quite
        legitimate to put the mapping in the substitution anyway.

        Furthermore, consider
                let x = case k of I# x77 -&gt; ... in
                let y = case k of I# x77 -&gt; ... in ...
        and suppose the body is strict in both x and y.  Then the simplifier
        will pull the first (case k) to the top; so the second (case k) will
        cancel out, mapping x77 to, well, x77!  But one is an in-Id and the
        other is an out-Id.

        Of course, the substitution *must* applied! Things in its domain
        simply aren't necessarily bound in the result.

* substId adds a binding (DoneId new_id) to the substitution if
        the Id's unique has changed

  Note, though that the substitution isn't necessarily extended
  if the type of the Id changes.  Why not?  Because of the next point:

* We *always, always* finish by looking up in the in-scope set
  any variable that doesn't get a DoneEx or DoneVar hit in the substitution.
  Reason: so that we never finish up with a &quot;old&quot; Id in the result.
  An old Id might point to an old unfolding and so on... which gives a space
  leak.

  [The DoneEx and DoneVar hits map to &quot;new&quot; stuff.]

* It follows that substExpr must not do a no-op if the substitution is empty.
  substType is free to do so, however.

* When we come to a let-binding (say) we generate new IdInfo, including an
  unfolding, attach it to the binder, and add this newly adorned binder to
  the in-scope set.  So all subsequent occurrences of the binder will get
  mapped to the full-adorned binder, which is also the one put in the
  binding site.

* The in-scope &quot;set&quot; usually maps x-&gt;x; we use it simply for its domain.
  But sometimes we have two in-scope Ids that are synomyms, and should
  map to the same target:  x-&gt;x, y-&gt;x.  Notably:
        case y of x { ... }
  That's why the &quot;set&quot; is actually a VarEnv Var

Note [Join arity in SimplIdSubst]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We have to remember which incoming variables are join points: the occurrences
may not be marked correctly yet, and we're in change of propagating the change if
OccurAnal makes something a join point).

Normally the in-scope set is where we keep the latest information, but
the in-scope set tracks only OutVars; if a binding is unconditionally
inlined (via DoneEx), it never makes it into the in-scope set, and we
need to know at the occurrence site that the variable is a join point
so that we know to drop the context. Thus we remember which join
points we're substituting. -}</span><span>
</span><a name="line-268"></a><span>
</span><a name="line-269"></a><span class="hs-identifier">mkSimplEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SimplMode</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-270"></a><a name="mkSimplEnv"><a href="SimplEnv.html#mkSimplEnv"><span class="hs-identifier">mkSimplEnv</span></a></a><span> </span><a name="local-6989586621680421631"><a href="#local-6989586621680421631"><span class="hs-identifier">mode</span></a></a><span>
</span><a name="line-271"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-var">SimplEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">seMode</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421631"><span class="hs-identifier hs-var">mode</span></a><span>
</span><a name="line-272"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">seInScope</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#init_in_scope"><span class="hs-identifier hs-var">init_in_scope</span></a><span>
</span><a name="line-273"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">seTvSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyVarEnv</span><span>
</span><a name="line-274"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">seCvSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyVarEnv</span><span>
</span><a name="line-275"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">seIdSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyVarEnv</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-276"></a><span>        </span><span class="hs-comment">-- The top level &quot;enclosing CC&quot; is &quot;SUBSUMED&quot;.</span><span>
</span><a name="line-277"></a><span>
</span><a name="line-278"></a><span class="hs-identifier">init_in_scope</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">InScopeSet</span><span>
</span><a name="line-279"></a><a name="init_in_scope"><a href="SimplEnv.html#init_in_scope"><span class="hs-identifier">init_in_scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkInScopeSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitVarSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkWildValBinder</span><span> </span><span class="hs-identifier hs-var">unitTy</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-280"></a><span>              </span><span class="hs-comment">-- See Note [WildCard binders]</span><span>
</span><a name="line-281"></a><span>
</span><a name="line-282"></a><span class="hs-comment">{-
Note [WildCard binders]
~~~~~~~~~~~~~~~~~~~~~~~
The program to be simplified may have wild binders
    case e of wild { p -&gt; ... }
We want to *rename* them away, so that there are no
occurrences of 'wild-id' (with wildCardKey).  The easy
way to do that is to start of with a representative
Id in the in-scope set

There can be *occurrences* of wild-id.  For example,
MkCore.mkCoreApp transforms
   e (a /# b)   --&gt;   case (a /# b) of wild { DEFAULT -&gt; e wild }
This is ok provided 'wild' isn't free in 'e', and that's the delicate
thing. Generally, you want to run the simplifier to get rid of the
wild-ids before doing much else.

It's a very dark corner of GHC.  Maybe it should be cleaned up.
-}</span><span>
</span><a name="line-301"></a><span>
</span><a name="line-302"></a><span class="hs-identifier">getMode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SimplMode</span><span>
</span><a name="line-303"></a><a name="getMode"><a href="SimplEnv.html#getMode"><span class="hs-identifier">getMode</span></a></a><span> </span><a name="local-6989586621680421632"><a href="#local-6989586621680421632"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">seMode</span><span> </span><a href="#local-6989586621680421632"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-304"></a><span>
</span><a name="line-305"></a><span class="hs-identifier">seDynFlags</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-306"></a><a name="seDynFlags"><a href="SimplEnv.html#seDynFlags"><span class="hs-identifier">seDynFlags</span></a></a><span> </span><a name="local-6989586621680421633"><a href="#local-6989586621680421633"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sm_dflags</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">seMode</span><span> </span><a href="#local-6989586621680421633"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-307"></a><span>
</span><a name="line-308"></a><span class="hs-identifier">setMode</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SimplMode</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-309"></a><a name="setMode"><a href="SimplEnv.html#setMode"><span class="hs-identifier">setMode</span></a></a><span> </span><a name="local-6989586621680421634"><a href="#local-6989586621680421634"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621680421635"><a href="#local-6989586621680421635"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421635"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">seMode</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421634"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-310"></a><span>
</span><a name="line-311"></a><span class="hs-identifier">updMode</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SimplMode</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SimplMode</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-312"></a><a name="updMode"><a href="SimplEnv.html#updMode"><span class="hs-identifier">updMode</span></a></a><span> </span><a name="local-6989586621680421636"><a href="#local-6989586621680421636"><span class="hs-identifier">upd</span></a></a><span> </span><a name="local-6989586621680421637"><a href="#local-6989586621680421637"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421637"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">seMode</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421636"><span class="hs-identifier hs-var">upd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">seMode</span><span> </span><a href="#local-6989586621680421637"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-313"></a><span>
</span><a name="line-314"></a><span class="hs-comment">---------------------</span><span>
</span><a name="line-315"></a><span class="hs-identifier">extendIdSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplSR"><span class="hs-identifier hs-type">SimplSR</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-316"></a><a name="extendIdSubst"><a href="SimplEnv.html#extendIdSubst"><span class="hs-identifier">extendIdSubst</span></a></a><span> </span><a name="local-6989586621680421638"><a href="#local-6989586621680421638"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-var">SimplEnv</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">seIdSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421639"><a href="#local-6989586621680421639"><span class="hs-identifier">subst</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680421640"><a href="#local-6989586621680421640"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621680421641"><a href="#local-6989586621680421641"><span class="hs-identifier">res</span></a></a><span>
</span><a name="line-317"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isId</span><span> </span><span class="hs-identifier">var</span><span> </span><span class="hs-operator">&amp;&amp;</span><span> </span><span class="hs-identifier">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isCoVar</span><span> </span><span class="hs-identifier hs-var">var</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-identifier">var</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-318"></a><span>    </span><a href="#local-6989586621680421638"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">seIdSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendVarEnv</span><span> </span><a href="#local-6989586621680421639"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621680421640"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621680421641"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-319"></a><span>
</span><a name="line-320"></a><span class="hs-identifier">extendTvSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-321"></a><a name="extendTvSubst"><a href="SimplEnv.html#extendTvSubst"><span class="hs-identifier">extendTvSubst</span></a></a><span> </span><a name="local-6989586621680421642"><a href="#local-6989586621680421642"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-var">SimplEnv</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">seTvSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421643"><a href="#local-6989586621680421643"><span class="hs-identifier">tsubst</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680421644"><a href="#local-6989586621680421644"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621680421645"><a href="#local-6989586621680421645"><span class="hs-identifier">res</span></a></a><span>
</span><a name="line-322"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isTyVar</span><span> </span><span class="hs-identifier">var</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-identifier hs-var">var</span><span> </span><a href="#local-6989586621680421644"><span class="hs-operator hs-var">$$</span></a><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">res</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-323"></a><span>    </span><a href="#local-6989586621680421642"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">seTvSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendVarEnv</span><span> </span><a href="#local-6989586621680421643"><span class="hs-identifier hs-var">tsubst</span></a><span> </span><a href="#local-6989586621680421644"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621680421645"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">}</span><span>
</span><a name="line-324"></a><span>
</span><a name="line-325"></a><span class="hs-identifier">extendCvSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Coercion</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-326"></a><a name="extendCvSubst"><a href="SimplEnv.html#extendCvSubst"><span class="hs-identifier">extendCvSubst</span></a></a><span> </span><a name="local-6989586621680421646"><a href="#local-6989586621680421646"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-var">SimplEnv</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">seCvSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421647"><a href="#local-6989586621680421647"><span class="hs-identifier">csubst</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680421648"><a href="#local-6989586621680421648"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621680421649"><a href="#local-6989586621680421649"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-327"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isCoVar</span><span> </span><span class="hs-identifier hs-var">var</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-328"></a><span>    </span><a href="#local-6989586621680421646"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">seCvSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendVarEnv</span><span> </span><a href="#local-6989586621680421647"><span class="hs-identifier hs-var">csubst</span></a><span> </span><a href="#local-6989586621680421648"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621680421649"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">}</span><span>
</span><a name="line-329"></a><span>
</span><a name="line-330"></a><span class="hs-comment">---------------------</span><span>
</span><a name="line-331"></a><span class="hs-identifier">getInScope</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">InScopeSet</span><span>
</span><a name="line-332"></a><a name="getInScope"><a href="SimplEnv.html#getInScope"><span class="hs-identifier">getInScope</span></a></a><span> </span><a name="local-6989586621680421650"><a href="#local-6989586621680421650"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">seInScope</span><span> </span><a href="#local-6989586621680421650"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-333"></a><span>
</span><a name="line-334"></a><span class="hs-identifier">setInScopeSet</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">InScopeSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-335"></a><a name="setInScopeSet"><a href="SimplEnv.html#setInScopeSet"><span class="hs-identifier">setInScopeSet</span></a></a><span> </span><a name="local-6989586621680421651"><a href="#local-6989586621680421651"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680421652"><a href="#local-6989586621680421652"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421651"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">seInScope</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421652"><span class="hs-identifier hs-var">in_scope</span></a><span class="hs-special">}</span><span>
</span><a name="line-336"></a><span>
</span><a name="line-337"></a><span class="hs-identifier">setInScopeFromE</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-338"></a><span class="hs-comment">-- See Note [Setting the right in-scope set]</span><span>
</span><a name="line-339"></a><a name="setInScopeFromE"><a href="SimplEnv.html#setInScopeFromE"><span class="hs-identifier">setInScopeFromE</span></a></a><span> </span><a name="local-6989586621680421653"><a href="#local-6989586621680421653"><span class="hs-identifier">rhs_env</span></a></a><span> </span><a name="local-6989586621680421654"><a href="#local-6989586621680421654"><span class="hs-identifier">here_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421653"><span class="hs-identifier hs-var">rhs_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">seInScope</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">seInScope</span><span> </span><a href="#local-6989586621680421654"><span class="hs-identifier hs-var">here_env</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-340"></a><span>
</span><a name="line-341"></a><span class="hs-identifier">setInScopeFromF</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-342"></a><a name="setInScopeFromF"><a href="SimplEnv.html#setInScopeFromF"><span class="hs-identifier">setInScopeFromF</span></a></a><span> </span><a name="local-6989586621680421655"><a href="#local-6989586621680421655"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680421656"><a href="#local-6989586621680421656"><span class="hs-identifier">floats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421655"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">seInScope</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sfInScope</span><span> </span><a href="#local-6989586621680421656"><span class="hs-identifier hs-var">floats</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-343"></a><span>
</span><a name="line-344"></a><span class="hs-identifier">addNewInScopeIds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreBndr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-345"></a><span>        </span><span class="hs-comment">-- The new Ids are guaranteed to be freshly allocated</span><span>
</span><a name="line-346"></a><a name="addNewInScopeIds"><a href="SimplEnv.html#addNewInScopeIds"><span class="hs-identifier">addNewInScopeIds</span></a></a><span> </span><a name="local-6989586621680421657"><a href="#local-6989586621680421657"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-var">SimplEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">seInScope</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421658"><a href="#local-6989586621680421658"><span class="hs-identifier">in_scope</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">seIdSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421659"><a href="#local-6989586621680421659"><span class="hs-identifier">id_subst</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680421660"><a href="#local-6989586621680421660"><span class="hs-identifier">vs</span></a></a><span>
</span><a name="line-347"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421657"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">seInScope</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421658"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">extendInScopeSetList</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680421660"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">,</span><span>
</span><a name="line-348"></a><span>          </span><span class="hs-identifier">seIdSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421659"><span class="hs-identifier hs-var">id_subst</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">delVarEnvList</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680421660"><span class="hs-identifier hs-var">vs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-349"></a><span>        </span><span class="hs-comment">-- Why delete?  Consider</span><span>
</span><a name="line-350"></a><span>        </span><span class="hs-comment">--      let x = a*b in (x, \x -&gt; x+3)</span><span>
</span><a name="line-351"></a><span>        </span><span class="hs-comment">-- We add [x |-&gt; a*b] to the substitution, but we must</span><span>
</span><a name="line-352"></a><span>        </span><span class="hs-comment">-- _delete_ it from the substitution when going inside</span><span>
</span><a name="line-353"></a><span>        </span><span class="hs-comment">-- the (\x -&gt; ...)!</span><span>
</span><a name="line-354"></a><span>
</span><a name="line-355"></a><span class="hs-identifier">modifyInScope</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreBndr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-356"></a><span class="hs-comment">-- The variable should already be in scope, but</span><span>
</span><a name="line-357"></a><span class="hs-comment">-- replace the existing version with this new one</span><span>
</span><a name="line-358"></a><span class="hs-comment">-- which has more information</span><span>
</span><a name="line-359"></a><a name="modifyInScope"><a href="SimplEnv.html#modifyInScope"><span class="hs-identifier">modifyInScope</span></a></a><span> </span><a name="local-6989586621680421661"><a href="#local-6989586621680421661"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-var">SimplEnv</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">seInScope</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421662"><a href="#local-6989586621680421662"><span class="hs-identifier">in_scope</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680421663"><a href="#local-6989586621680421663"><span class="hs-identifier">v</span></a></a><span>
</span><a name="line-360"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421661"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">seInScope</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendInScopeSet</span><span> </span><a href="#local-6989586621680421662"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621680421663"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">}</span><span>
</span><a name="line-361"></a><span>
</span><a name="line-362"></a><span class="hs-comment">{- Note [Setting the right in-scope set]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
  \x. (let x = e in b) arg[x]
where the let shadows the lambda.  Really this means something like
  \x1. (let x2 = e in b) arg[x1]

- When we capture the 'arg' in an ApplyToVal continuation, we capture
  the environment, which says what 'x' is bound to, namely x1

- Then that continuation gets pushed under the let

- Finally we simplify 'arg'.  We want
     - the static, lexical environment bindig x :-&gt; x1
     - the in-scopeset from &quot;here&quot;, under the 'let' which includes
       both x1 and x2

It's important to have the right in-scope set, else we may rename a
variable to one that is already in scope.  So we must pick up the
in-scope set from &quot;here&quot;, but otherwise use the environment we
captured along with 'arg'.  This transfer of in-scope set is done by
setInScopeFromE.
-}</span><span>
</span><a name="line-385"></a><span>
</span><a name="line-386"></a><span class="hs-comment">---------------------</span><span>
</span><a name="line-387"></a><span class="hs-identifier">zapSubstEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-388"></a><a name="zapSubstEnv"><a href="SimplEnv.html#zapSubstEnv"><span class="hs-identifier">zapSubstEnv</span></a></a><span> </span><a name="local-6989586621680421664"><a href="#local-6989586621680421664"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421664"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">seTvSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyVarEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">seCvSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyVarEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">seIdSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyVarEnv</span><span class="hs-special">}</span><span>
</span><a name="line-389"></a><span>
</span><a name="line-390"></a><span class="hs-identifier">setSubstEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TvSubstEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CvSubstEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplIdSubst"><span class="hs-identifier hs-type">SimplIdSubst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-391"></a><a name="setSubstEnv"><a href="SimplEnv.html#setSubstEnv"><span class="hs-identifier">setSubstEnv</span></a></a><span> </span><a name="local-6989586621680421665"><a href="#local-6989586621680421665"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680421666"><a href="#local-6989586621680421666"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621680421667"><a href="#local-6989586621680421667"><span class="hs-identifier">cvs</span></a></a><span> </span><a name="local-6989586621680421668"><a href="#local-6989586621680421668"><span class="hs-identifier">ids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421665"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">seTvSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421666"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">seCvSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421667"><span class="hs-identifier hs-var">cvs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">seIdSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421668"><span class="hs-identifier hs-var">ids</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-392"></a><span>
</span><a name="line-393"></a><span class="hs-identifier">mkContEx</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">InExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplSR"><span class="hs-identifier hs-type">SimplSR</span></a><span>
</span><a name="line-394"></a><a name="mkContEx"><a href="SimplEnv.html#mkContEx"><span class="hs-identifier">mkContEx</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-var">SimplEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">seTvSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421669"><a href="#local-6989586621680421669"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">seCvSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421670"><a href="#local-6989586621680421670"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">seIdSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421671"><a href="#local-6989586621680421671"><span class="hs-identifier">ids</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680421672"><a href="#local-6989586621680421672"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#ContEx"><span class="hs-identifier hs-var">ContEx</span></a><span> </span><a href="#local-6989586621680421669"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621680421670"><span class="hs-identifier hs-var">cvs</span></a><span> </span><a href="#local-6989586621680421671"><span class="hs-identifier hs-var">ids</span></a><span> </span><a href="#local-6989586621680421672"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-395"></a><span>
</span><a name="line-396"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{LetFloats}
*                                                                      *
************************************************************************

Note [LetFloats]
~~~~~~~~~~~~~~~~
The LetFloats is a bunch of bindings, classified by a FloatFlag.

* All of them satisfy the let/app invariant

Examples

  NonRec x (y:ys)       FltLifted
  Rec [(x,rhs)]         FltLifted

  NonRec x* (p:q)       FltOKSpec   -- RHS is WHNF.  Question: why not FltLifted?
  NonRec x# (y +# 3)    FltOkSpec   -- Unboxed, but ok-for-spec'n

  NonRec x* (f y)       FltCareful  -- Strict binding; might fail or diverge

Can't happen:
  NonRec x# (a /# b)    -- Might fail; does not satisfy let/app
  NonRec x# (f y)       -- Might diverge; does not satisfy let/app
-}</span><span>
</span><a name="line-423"></a><span>
</span><a name="line-424"></a><span class="hs-keyword">data</span><span> </span><a name="LetFloats"><a href="SimplEnv.html#LetFloats"><span class="hs-identifier">LetFloats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="LetFloats"><a href="SimplEnv.html#LetFloats"><span class="hs-identifier">LetFloats</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OrdList</span><span> </span><span class="hs-identifier hs-type">OutBind</span><span class="hs-special">)</span><span> </span><a href="SimplEnv.html#FloatFlag"><span class="hs-identifier hs-type">FloatFlag</span></a><span>
</span><a name="line-425"></a><span>                 </span><span class="hs-comment">-- See Note [LetFloats]</span><span>
</span><a name="line-426"></a><span>
</span><a name="line-427"></a><span class="hs-keyword">type</span><span> </span><a name="JoinFloat"><a href="SimplEnv.html#JoinFloat"><span class="hs-identifier">JoinFloat</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">OutBind</span><span>
</span><a name="line-428"></a><span class="hs-keyword">type</span><span> </span><a name="JoinFloats"><a href="SimplEnv.html#JoinFloats"><span class="hs-identifier">JoinFloats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">OrdList</span><span> </span><a href="SimplEnv.html#JoinFloat"><span class="hs-identifier hs-type">JoinFloat</span></a><span>
</span><a name="line-429"></a><span>
</span><a name="line-430"></a><span class="hs-keyword">data</span><span> </span><a name="FloatFlag"><a href="SimplEnv.html#FloatFlag"><span class="hs-identifier">FloatFlag</span></a></a><span>
</span><a name="line-431"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="FltLifted"><a href="SimplEnv.html#FltLifted"><span class="hs-identifier">FltLifted</span></a></a><span>   </span><span class="hs-comment">-- All bindings are lifted and lazy *or*</span><span>
</span><a name="line-432"></a><span>                </span><span class="hs-comment">--     consist of a single primitive string literal</span><span>
</span><a name="line-433"></a><span>                </span><span class="hs-comment">--  Hence ok to float to top level, or recursive</span><span>
</span><a name="line-434"></a><span>
</span><a name="line-435"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="FltOkSpec"><a href="SimplEnv.html#FltOkSpec"><span class="hs-identifier">FltOkSpec</span></a></a><span>   </span><span class="hs-comment">-- All bindings are FltLifted *or*</span><span>
</span><a name="line-436"></a><span>                </span><span class="hs-comment">--      strict (perhaps because unlifted,</span><span>
</span><a name="line-437"></a><span>                </span><span class="hs-comment">--      perhaps because of a strict binder),</span><span>
</span><a name="line-438"></a><span>                </span><span class="hs-comment">--        *and* ok-for-speculation</span><span>
</span><a name="line-439"></a><span>                </span><span class="hs-comment">--  Hence ok to float out of the RHS</span><span>
</span><a name="line-440"></a><span>                </span><span class="hs-comment">--  of a lazy non-recursive let binding</span><span>
</span><a name="line-441"></a><span>                </span><span class="hs-comment">--  (but not to top level, or into a rec group)</span><span>
</span><a name="line-442"></a><span>
</span><a name="line-443"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="FltCareful"><a href="SimplEnv.html#FltCareful"><span class="hs-identifier">FltCareful</span></a></a><span>  </span><span class="hs-comment">-- At least one binding is strict (or unlifted)</span><span>
</span><a name="line-444"></a><span>                </span><span class="hs-comment">--      and not guaranteed cheap</span><span>
</span><a name="line-445"></a><span>                </span><span class="hs-comment">--      Do not float these bindings out of a lazy let</span><span>
</span><a name="line-446"></a><span>
</span><a name="line-447"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="SimplEnv.html#LetFloats"><span class="hs-identifier hs-type">LetFloats</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-448"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#LetFloats"><span class="hs-identifier hs-var">LetFloats</span></a><span> </span><a name="local-6989586621680421611"><a href="#local-6989586621680421611"><span class="hs-identifier">binds</span></a></a><span> </span><a name="local-6989586621680421612"><a href="#local-6989586621680421612"><span class="hs-identifier">ff</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680421612"><span class="hs-identifier hs-var">ff</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromOL</span><span> </span><a href="#local-6989586621680421611"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-449"></a><span>
</span><a name="line-450"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="SimplEnv.html#FloatFlag"><span class="hs-identifier hs-type">FloatFlag</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-451"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><a href="SimplEnv.html#FltLifted"><span class="hs-identifier hs-var">FltLifted</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;FltLifted&quot;</span><span>
</span><a name="line-452"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><a href="SimplEnv.html#FltOkSpec"><span class="hs-identifier hs-var">FltOkSpec</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;FltOkSpec&quot;</span><span>
</span><a name="line-453"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><a href="SimplEnv.html#FltCareful"><span class="hs-identifier hs-var">FltCareful</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;FltCareful&quot;</span><span>
</span><a name="line-454"></a><span>
</span><a name="line-455"></a><span class="hs-identifier">andFF</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#FloatFlag"><span class="hs-identifier hs-type">FloatFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#FloatFlag"><span class="hs-identifier hs-type">FloatFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#FloatFlag"><span class="hs-identifier hs-type">FloatFlag</span></a><span>
</span><a name="line-456"></a><a name="andFF"><a href="SimplEnv.html#andFF"><span class="hs-identifier">andFF</span></a></a><span> </span><a href="SimplEnv.html#FltCareful"><span class="hs-identifier hs-var">FltCareful</span></a><span> </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#FltCareful"><span class="hs-identifier hs-var">FltCareful</span></a><span>
</span><a name="line-457"></a><span class="hs-identifier">andFF</span><span> </span><a href="SimplEnv.html#FltOkSpec"><span class="hs-identifier hs-var">FltOkSpec</span></a><span>  </span><a href="SimplEnv.html#FltCareful"><span class="hs-identifier hs-var">FltCareful</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#FltCareful"><span class="hs-identifier hs-var">FltCareful</span></a><span>
</span><a name="line-458"></a><span class="hs-identifier">andFF</span><span> </span><a href="SimplEnv.html#FltOkSpec"><span class="hs-identifier hs-var">FltOkSpec</span></a><span>  </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#FltOkSpec"><span class="hs-identifier hs-var">FltOkSpec</span></a><span>
</span><a name="line-459"></a><span class="hs-identifier">andFF</span><span> </span><a href="SimplEnv.html#FltLifted"><span class="hs-identifier hs-var">FltLifted</span></a><span>  </span><a name="local-6989586621680421673"><a href="#local-6989586621680421673"><span class="hs-identifier">flt</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421673"><span class="hs-identifier hs-var">flt</span></a><span>
</span><a name="line-460"></a><span>
</span><a name="line-461"></a><span class="hs-identifier">doFloatFromRhs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RecFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-462"></a><span class="hs-comment">-- If you change this function look also at FloatIn.noFloatFromRhs</span><span>
</span><a name="line-463"></a><a name="doFloatFromRhs"><a href="SimplEnv.html#doFloatFromRhs"><span class="hs-identifier">doFloatFromRhs</span></a></a><span> </span><a name="local-6989586621680421674"><a href="#local-6989586621680421674"><span class="hs-identifier">lvl</span></a></a><span> </span><a name="local-6989586621680421675"><a href="#local-6989586621680421675"><span class="hs-identifier">rec</span></a></a><span> </span><a name="local-6989586621680421676"><a href="#local-6989586621680421676"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-var">SimplFloats</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sfLetFloats</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#LetFloats"><span class="hs-identifier hs-var">LetFloats</span></a><span> </span><a name="local-6989586621680421677"><a href="#local-6989586621680421677"><span class="hs-identifier">fs</span></a></a><span> </span><a name="local-6989586621680421678"><a href="#local-6989586621680421678"><span class="hs-identifier">ff</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680421679"><a href="#local-6989586621680421679"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-464"></a><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isNilOL</span><span> </span><a href="#local-6989586621680421677"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621680421680"><span class="hs-identifier hs-var">want_to_float</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621680421681"><span class="hs-identifier hs-var">can_float</span></a><span>
</span><a name="line-465"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-466"></a><span>     </span><a name="local-6989586621680421680"><a href="#local-6989586621680421680"><span class="hs-identifier">want_to_float</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isTopLevel</span><span> </span><a href="#local-6989586621680421674"><span class="hs-identifier hs-var">lvl</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">exprIsCheap</span><span> </span><a href="#local-6989586621680421679"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">exprIsExpandable</span><span> </span><a href="#local-6989586621680421679"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-467"></a><span>                     </span><span class="hs-comment">-- See Note [Float when cheap or expandable]</span><span>
</span><a name="line-468"></a><span>     </span><a name="local-6989586621680421681"><a href="#local-6989586621680421681"><span class="hs-identifier">can_float</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680421678"><span class="hs-identifier hs-var">ff</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-469"></a><span>                   </span><a href="SimplEnv.html#FltLifted"><span class="hs-identifier hs-var">FltLifted</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-470"></a><span>                   </span><a href="SimplEnv.html#FltOkSpec"><span class="hs-identifier hs-var">FltOkSpec</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">isNotTopLevel</span><span> </span><a href="#local-6989586621680421674"><span class="hs-identifier hs-var">lvl</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isNonRec</span><span> </span><a href="#local-6989586621680421675"><span class="hs-identifier hs-var">rec</span></a><span>
</span><a name="line-471"></a><span>                   </span><a href="SimplEnv.html#FltCareful"><span class="hs-identifier hs-var">FltCareful</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">isNotTopLevel</span><span> </span><a href="#local-6989586621680421674"><span class="hs-identifier hs-var">lvl</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isNonRec</span><span> </span><a href="#local-6989586621680421675"><span class="hs-identifier hs-var">rec</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621680421676"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-472"></a><span>
</span><a name="line-473"></a><span class="hs-comment">{-
Note [Float when cheap or expandable]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We want to float a let from a let if the residual RHS is
   a) cheap, such as (\x. blah)
   b) expandable, such as (f b) if f is CONLIKE
But there are
  - cheap things that are not expandable (eg \x. expensive)
  - expandable things that are not cheap (eg (f b) where b is CONLIKE)
so we must take the 'or' of the two.
-}</span><span>
</span><a name="line-484"></a><span>
</span><a name="line-485"></a><span class="hs-identifier">emptyLetFloats</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#LetFloats"><span class="hs-identifier hs-type">LetFloats</span></a><span>
</span><a name="line-486"></a><a name="emptyLetFloats"><a href="SimplEnv.html#emptyLetFloats"><span class="hs-identifier">emptyLetFloats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#LetFloats"><span class="hs-identifier hs-var">LetFloats</span></a><span> </span><span class="hs-identifier hs-var">nilOL</span><span> </span><a href="SimplEnv.html#FltLifted"><span class="hs-identifier hs-var">FltLifted</span></a><span>
</span><a name="line-487"></a><span>
</span><a name="line-488"></a><span class="hs-identifier">emptyJoinFloats</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#JoinFloats"><span class="hs-identifier hs-type">JoinFloats</span></a><span>
</span><a name="line-489"></a><a name="emptyJoinFloats"><a href="SimplEnv.html#emptyJoinFloats"><span class="hs-identifier">emptyJoinFloats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nilOL</span><span>
</span><a name="line-490"></a><span>
</span><a name="line-491"></a><span class="hs-identifier">unitLetFloat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OutBind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#LetFloats"><span class="hs-identifier hs-type">LetFloats</span></a><span>
</span><a name="line-492"></a><span class="hs-comment">-- This key function constructs a singleton float with the right form</span><span>
</span><a name="line-493"></a><a name="unitLetFloat"><a href="SimplEnv.html#unitLetFloat"><span class="hs-identifier">unitLetFloat</span></a></a><span> </span><a name="local-6989586621680421682"><a href="#local-6989586621680421682"><span class="hs-identifier">bind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">isJoinId</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">bindersOf</span><span> </span><span class="hs-identifier">bind</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-494"></a><span>                    </span><a href="SimplEnv.html#LetFloats"><span class="hs-identifier hs-var">LetFloats</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitOL</span><span> </span><a href="#local-6989586621680421682"><span class="hs-identifier hs-var">bind</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680421683"><span class="hs-identifier hs-var">flag</span></a><span> </span><a href="#local-6989586621680421682"><span class="hs-identifier hs-var">bind</span></a><span class="hs-special">)</span><span>
</span><a name="line-495"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-496"></a><span>    </span><a name="local-6989586621680421683"><a href="#local-6989586621680421683"><span class="hs-identifier">flag</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>                </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#FltLifted"><span class="hs-identifier hs-var">FltLifted</span></a><span>
</span><a name="line-497"></a><span>    </span><span class="hs-identifier">flag</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a name="local-6989586621680421684"><a href="#local-6989586621680421684"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621680421685"><a href="#local-6989586621680421685"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-498"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isStrictId</span><span> </span><a href="#local-6989586621680421684"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#FltLifted"><span class="hs-identifier hs-var">FltLifted</span></a><span>
</span><a name="line-499"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">exprIsTickedString</span><span> </span><a href="#local-6989586621680421685"><span class="hs-identifier hs-var">rhs</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#FltLifted"><span class="hs-identifier hs-var">FltLifted</span></a><span>
</span><a name="line-500"></a><span>          </span><span class="hs-comment">-- String literals can be floated freely.</span><span>
</span><a name="line-501"></a><span>          </span><span class="hs-comment">-- See Note [CoreSyn top-level string literals] in CoreSyn.</span><span>
</span><a name="line-502"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">exprOkForSpeculation</span><span> </span><a href="#local-6989586621680421685"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#FltOkSpec"><span class="hs-identifier hs-var">FltOkSpec</span></a><span>  </span><span class="hs-comment">-- Unlifted, and lifted but ok-for-spec (eg HNF)</span><span>
</span><a name="line-503"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isUnliftedType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><span class="hs-identifier hs-var">bndr</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-identifier">bndr</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-504"></a><span>                                   </span><a href="SimplEnv.html#FltCareful"><span class="hs-identifier hs-var">FltCareful</span></a><span>
</span><a name="line-505"></a><span>      </span><span class="hs-comment">-- Unlifted binders can only be let-bound if exprOkForSpeculation holds</span><span>
</span><a name="line-506"></a><span>
</span><a name="line-507"></a><span class="hs-identifier">unitJoinFloat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OutBind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#JoinFloats"><span class="hs-identifier hs-type">JoinFloats</span></a><span>
</span><a name="line-508"></a><a name="unitJoinFloat"><a href="SimplEnv.html#unitJoinFloat"><span class="hs-identifier">unitJoinFloat</span></a></a><span> </span><a name="local-6989586621680421686"><a href="#local-6989586621680421686"><span class="hs-identifier">bind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-identifier">isJoinId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">bindersOf</span><span> </span><span class="hs-identifier">bind</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-509"></a><span>                     </span><span class="hs-identifier hs-var">unitOL</span><span> </span><a href="#local-6989586621680421686"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-510"></a><span>
</span><a name="line-511"></a><span class="hs-identifier">mkFloatBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutBind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">)</span><span>
</span><a name="line-512"></a><span class="hs-comment">-- Make a singleton SimplFloats, and</span><span>
</span><a name="line-513"></a><span class="hs-comment">-- extend the incoming SimplEnv's in-scope set with its binders</span><span>
</span><a name="line-514"></a><span class="hs-comment">-- These binders may already be in the in-scope set,</span><span>
</span><a name="line-515"></a><span class="hs-comment">-- but may have by now been augmented with more IdInfo</span><span>
</span><a name="line-516"></a><a name="mkFloatBind"><a href="SimplEnv.html#mkFloatBind"><span class="hs-identifier">mkFloatBind</span></a></a><span> </span><a name="local-6989586621680421687"><a href="#local-6989586621680421687"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680421688"><a href="#local-6989586621680421688"><span class="hs-identifier">bind</span></a></a><span>
</span><a name="line-517"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680421689"><span class="hs-identifier hs-var">floats</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680421687"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">seInScope</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421690"><span class="hs-identifier hs-var">in_scope'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-518"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-519"></a><span>    </span><a name="local-6989586621680421689"><a href="#local-6989586621680421689"><span class="hs-identifier">floats</span></a></a><span>
</span><a name="line-520"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isJoinBind</span><span> </span><a href="#local-6989586621680421688"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-521"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-var">SimplFloats</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sfLetFloats</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#emptyLetFloats"><span class="hs-identifier hs-var">emptyLetFloats</span></a><span>
</span><a name="line-522"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sfJoinFloats</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#unitJoinFloat"><span class="hs-identifier hs-var">unitJoinFloat</span></a><span> </span><a href="#local-6989586621680421688"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-523"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sfInScope</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421690"><span class="hs-identifier hs-var">in_scope'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-524"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-525"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-var">SimplFloats</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sfLetFloats</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#unitLetFloat"><span class="hs-identifier hs-var">unitLetFloat</span></a><span> </span><a href="#local-6989586621680421688"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-526"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sfJoinFloats</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#emptyJoinFloats"><span class="hs-identifier hs-var">emptyJoinFloats</span></a><span>
</span><a name="line-527"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sfInScope</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421690"><span class="hs-identifier hs-var">in_scope'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-528"></a><span>
</span><a name="line-529"></a><span>    </span><a name="local-6989586621680421690"><a href="#local-6989586621680421690"><span class="hs-identifier">in_scope'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">seInScope</span><span> </span><a href="#local-6989586621680421687"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">`</span><a href="SimplEnv.html#extendInScopeSetBind"><span class="hs-identifier hs-var">extendInScopeSetBind</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680421688"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-530"></a><span>
</span><a name="line-531"></a><span class="hs-identifier">extendFloats</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutBind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a><span>
</span><a name="line-532"></a><span class="hs-comment">-- Add this binding to the floats, and extend the in-scope env too</span><span>
</span><a name="line-533"></a><a name="extendFloats"><a href="SimplEnv.html#extendFloats"><span class="hs-identifier">extendFloats</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-var">SimplFloats</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sfLetFloats</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421691"><a href="#local-6989586621680421691"><span class="hs-identifier">floats</span></a></a><span>
</span><a name="line-534"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sfJoinFloats</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421692"><a href="#local-6989586621680421692"><span class="hs-identifier">jfloats</span></a></a><span>
</span><a name="line-535"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sfInScope</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421693"><a href="#local-6989586621680421693"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-536"></a><span>             </span><a name="local-6989586621680421694"><a href="#local-6989586621680421694"><span class="hs-identifier">bind</span></a></a><span>
</span><a name="line-537"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isJoinBind</span><span> </span><a href="#local-6989586621680421694"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-538"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-var">SimplFloats</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sfInScope</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421695"><span class="hs-identifier hs-var">in_scope'</span></a><span>
</span><a name="line-539"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sfLetFloats</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421691"><span class="hs-identifier hs-var">floats</span></a><span>
</span><a name="line-540"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sfJoinFloats</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421697"><span class="hs-identifier hs-var">jfloats'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-541"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-542"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-var">SimplFloats</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sfInScope</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421695"><span class="hs-identifier hs-var">in_scope'</span></a><span>
</span><a name="line-543"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sfLetFloats</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421696"><span class="hs-identifier hs-var">floats'</span></a><span>
</span><a name="line-544"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sfJoinFloats</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421692"><span class="hs-identifier hs-var">jfloats</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-545"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-546"></a><span>    </span><a name="local-6989586621680421695"><a href="#local-6989586621680421695"><span class="hs-identifier">in_scope'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421693"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">`</span><a href="SimplEnv.html#extendInScopeSetBind"><span class="hs-identifier hs-var">extendInScopeSetBind</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680421694"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-547"></a><span>    </span><a name="local-6989586621680421696"><a href="#local-6989586621680421696"><span class="hs-identifier">floats'</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421691"><span class="hs-identifier hs-var">floats</span></a><span>  </span><span class="hs-special">`</span><a href="SimplEnv.html#addLetFlts"><span class="hs-identifier hs-var">addLetFlts</span></a><span class="hs-special">`</span><span>  </span><a href="SimplEnv.html#unitLetFloat"><span class="hs-identifier hs-var">unitLetFloat</span></a><span> </span><a href="#local-6989586621680421694"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-548"></a><span>    </span><a name="local-6989586621680421697"><a href="#local-6989586621680421697"><span class="hs-identifier">jfloats'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421692"><span class="hs-identifier hs-var">jfloats</span></a><span> </span><span class="hs-special">`</span><a href="SimplEnv.html#addJoinFlts"><span class="hs-identifier hs-var">addJoinFlts</span></a><span class="hs-special">`</span><span> </span><a href="SimplEnv.html#unitJoinFloat"><span class="hs-identifier hs-var">unitJoinFloat</span></a><span> </span><a href="#local-6989586621680421694"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-549"></a><span>
</span><a name="line-550"></a><span class="hs-identifier">addLetFloats</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#LetFloats"><span class="hs-identifier hs-type">LetFloats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a><span>
</span><a name="line-551"></a><span class="hs-comment">-- Add the let-floats for env2 to env1;</span><span>
</span><a name="line-552"></a><span class="hs-comment">-- *plus* the in-scope set for env2, which is bigger</span><span>
</span><a name="line-553"></a><span class="hs-comment">-- than that for env1</span><span>
</span><a name="line-554"></a><a name="addLetFloats"><a href="SimplEnv.html#addLetFloats"><span class="hs-identifier">addLetFloats</span></a></a><span> </span><a name="local-6989586621680421698"><a href="#local-6989586621680421698"><span class="hs-identifier">floats</span></a></a><span> </span><a name="local-6989586621680421699"><a href="#local-6989586621680421699"><span class="hs-identifier">let_floats</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SimplEnv.html#LetFloats"><span class="hs-identifier hs-var">LetFloats</span></a><span> </span><a name="local-6989586621680421700"><a href="#local-6989586621680421700"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-555"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421698"><span class="hs-identifier hs-var">floats</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sfLetFloats</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sfLetFloats</span><span> </span><a href="#local-6989586621680421698"><span class="hs-identifier hs-var">floats</span></a><span> </span><span class="hs-special">`</span><a href="SimplEnv.html#addLetFlts"><span class="hs-identifier hs-var">addLetFlts</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680421699"><span class="hs-identifier hs-var">let_floats</span></a><span>
</span><a name="line-556"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sfInScope</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldlOL</span><span> </span><a href="SimplEnv.html#extendInScopeSetBind"><span class="hs-identifier hs-var">extendInScopeSetBind</span></a><span>
</span><a name="line-557"></a><span>                                   </span><span class="hs-special">(</span><span class="hs-identifier">sfInScope</span><span> </span><a href="#local-6989586621680421698"><span class="hs-identifier hs-var">floats</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680421700"><span class="hs-identifier hs-var">binds</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-558"></a><span>
</span><a name="line-559"></a><span class="hs-identifier">addJoinFloats</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#JoinFloats"><span class="hs-identifier hs-type">JoinFloats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a><span>
</span><a name="line-560"></a><a name="addJoinFloats"><a href="SimplEnv.html#addJoinFloats"><span class="hs-identifier">addJoinFloats</span></a></a><span> </span><a name="local-6989586621680421701"><a href="#local-6989586621680421701"><span class="hs-identifier">floats</span></a></a><span> </span><a name="local-6989586621680421702"><a href="#local-6989586621680421702"><span class="hs-identifier">join_floats</span></a></a><span>
</span><a name="line-561"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421701"><span class="hs-identifier hs-var">floats</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sfJoinFloats</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sfJoinFloats</span><span> </span><a href="#local-6989586621680421701"><span class="hs-identifier hs-var">floats</span></a><span> </span><span class="hs-special">`</span><a href="SimplEnv.html#addJoinFlts"><span class="hs-identifier hs-var">addJoinFlts</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680421702"><span class="hs-identifier hs-var">join_floats</span></a><span>
</span><a name="line-562"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sfInScope</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldlOL</span><span> </span><a href="SimplEnv.html#extendInScopeSetBind"><span class="hs-identifier hs-var">extendInScopeSetBind</span></a><span>
</span><a name="line-563"></a><span>                                    </span><span class="hs-special">(</span><span class="hs-identifier">sfInScope</span><span> </span><a href="#local-6989586621680421701"><span class="hs-identifier hs-var">floats</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680421702"><span class="hs-identifier hs-var">join_floats</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-564"></a><span>
</span><a name="line-565"></a><span class="hs-identifier">extendInScopeSetBind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">InScopeSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreBind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">InScopeSet</span><span>
</span><a name="line-566"></a><a name="extendInScopeSetBind"><a href="SimplEnv.html#extendInScopeSetBind"><span class="hs-identifier">extendInScopeSetBind</span></a></a><span> </span><a name="local-6989586621680421703"><a href="#local-6989586621680421703"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621680421704"><a href="#local-6989586621680421704"><span class="hs-identifier">bind</span></a></a><span>
</span><a name="line-567"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendInScopeSetList</span><span> </span><a href="#local-6989586621680421703"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bindersOf</span><span> </span><a href="#local-6989586621680421704"><span class="hs-identifier hs-var">bind</span></a><span class="hs-special">)</span><span>
</span><a name="line-568"></a><span>
</span><a name="line-569"></a><span class="hs-identifier">addFloats</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a><span>
</span><a name="line-570"></a><span class="hs-comment">-- Add both let-floats and join-floats for env2 to env1;</span><span>
</span><a name="line-571"></a><span class="hs-comment">-- *plus* the in-scope set for env2, which is bigger</span><span>
</span><a name="line-572"></a><span class="hs-comment">-- than that for env1</span><span>
</span><a name="line-573"></a><a name="addFloats"><a href="SimplEnv.html#addFloats"><span class="hs-identifier">addFloats</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-var">SimplFloats</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sfLetFloats</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421705"><a href="#local-6989586621680421705"><span class="hs-identifier">lf1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sfJoinFloats</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421706"><a href="#local-6989586621680421706"><span class="hs-identifier">jf1</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-574"></a><span>          </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-var">SimplFloats</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sfLetFloats</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421707"><a href="#local-6989586621680421707"><span class="hs-identifier">lf2</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sfJoinFloats</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421708"><a href="#local-6989586621680421708"><span class="hs-identifier">jf2</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sfInScope</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421709"><a href="#local-6989586621680421709"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-575"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-var">SimplFloats</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sfLetFloats</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421705"><span class="hs-identifier hs-var">lf1</span></a><span> </span><span class="hs-special">`</span><a href="SimplEnv.html#addLetFlts"><span class="hs-identifier hs-var">addLetFlts</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680421707"><span class="hs-identifier hs-var">lf2</span></a><span>
</span><a name="line-576"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sfJoinFloats</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421706"><span class="hs-identifier hs-var">jf1</span></a><span> </span><span class="hs-special">`</span><a href="SimplEnv.html#addJoinFlts"><span class="hs-identifier hs-var">addJoinFlts</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680421708"><span class="hs-identifier hs-var">jf2</span></a><span>
</span><a name="line-577"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sfInScope</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421709"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-578"></a><span>
</span><a name="line-579"></a><span class="hs-identifier">addLetFlts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#LetFloats"><span class="hs-identifier hs-type">LetFloats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#LetFloats"><span class="hs-identifier hs-type">LetFloats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#LetFloats"><span class="hs-identifier hs-type">LetFloats</span></a><span>
</span><a name="line-580"></a><a name="addLetFlts"><a href="SimplEnv.html#addLetFlts"><span class="hs-identifier">addLetFlts</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#LetFloats"><span class="hs-identifier hs-var">LetFloats</span></a><span> </span><a name="local-6989586621680421710"><a href="#local-6989586621680421710"><span class="hs-identifier">bs1</span></a></a><span> </span><a name="local-6989586621680421711"><a href="#local-6989586621680421711"><span class="hs-identifier">l1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#LetFloats"><span class="hs-identifier hs-var">LetFloats</span></a><span> </span><a name="local-6989586621680421712"><a href="#local-6989586621680421712"><span class="hs-identifier">bs2</span></a></a><span> </span><a name="local-6989586621680421713"><a href="#local-6989586621680421713"><span class="hs-identifier">l2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-581"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#LetFloats"><span class="hs-identifier hs-var">LetFloats</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680421710"><span class="hs-identifier hs-var">bs1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">appOL</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680421712"><span class="hs-identifier hs-var">bs2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680421711"><span class="hs-identifier hs-var">l1</span></a><span> </span><span class="hs-special">`</span><a href="SimplEnv.html#andFF"><span class="hs-identifier hs-var">andFF</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680421713"><span class="hs-identifier hs-var">l2</span></a><span class="hs-special">)</span><span>
</span><a name="line-582"></a><span>
</span><a name="line-583"></a><span class="hs-identifier">letFloatBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#LetFloats"><span class="hs-identifier hs-type">LetFloats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreBind</span><span class="hs-special">]</span><span>
</span><a name="line-584"></a><a name="letFloatBinds"><a href="SimplEnv.html#letFloatBinds"><span class="hs-identifier">letFloatBinds</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#LetFloats"><span class="hs-identifier hs-var">LetFloats</span></a><span> </span><a name="local-6989586621680421714"><a href="#local-6989586621680421714"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromOL</span><span> </span><a href="#local-6989586621680421714"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-585"></a><span>
</span><a name="line-586"></a><span class="hs-identifier">addJoinFlts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#JoinFloats"><span class="hs-identifier hs-type">JoinFloats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#JoinFloats"><span class="hs-identifier hs-type">JoinFloats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#JoinFloats"><span class="hs-identifier hs-type">JoinFloats</span></a><span>
</span><a name="line-587"></a><a name="addJoinFlts"><a href="SimplEnv.html#addJoinFlts"><span class="hs-identifier">addJoinFlts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">appOL</span><span>
</span><a name="line-588"></a><span>
</span><a name="line-589"></a><span class="hs-identifier">mkRecFloats</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a><span>
</span><a name="line-590"></a><span class="hs-comment">-- Flattens the floats from env2 into a single Rec group,</span><span>
</span><a name="line-591"></a><span class="hs-comment">-- They must either all be lifted LetFloats or all JoinFloats</span><span>
</span><a name="line-592"></a><a name="mkRecFloats"><a href="SimplEnv.html#mkRecFloats"><span class="hs-identifier">mkRecFloats</span></a></a><span> </span><a name="local-6989586621680421715"><a href="#local-6989586621680421715"><span class="hs-identifier">floats</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-var">SimplFloats</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sfLetFloats</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#LetFloats"><span class="hs-identifier hs-var">LetFloats</span></a><span> </span><a name="local-6989586621680421716"><a href="#local-6989586621680421716"><span class="hs-identifier">bs</span></a></a><span> </span><a name="local-6989586621680421717"><a href="#local-6989586621680421717"><span class="hs-identifier">ff</span></a></a><span>
</span><a name="line-593"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sfJoinFloats</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421718"><a href="#local-6989586621680421718"><span class="hs-identifier">jbs</span></a></a><span>
</span><a name="line-594"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sfInScope</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421719"><a href="#local-6989586621680421719"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-595"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">ff</span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">FltLifted</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#FltLifted"><span class="hs-identifier hs-var">True</span></a><span class="hs-special">;</span><span> </span><a href="SimplEnv.html#FltLifted"><span class="hs-identifier hs-var">_</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">False</span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fromOL</span><span> </span><span class="hs-identifier">bs</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-596"></a><span>    </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isNilOL</span><span> </span><span class="hs-identifier hs-var">bs</span><span> </span><span class="hs-operator">||</span><span> </span><span class="hs-identifier">isNilOL</span><span> </span><span class="hs-identifier">jbs</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-identifier">floats</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-597"></a><span>    </span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-var">SimplFloats</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sfLetFloats</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421720"><span class="hs-identifier hs-var">floats'</span></a><span>
</span><a name="line-598"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sfJoinFloats</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421721"><span class="hs-identifier hs-var">jfloats'</span></a><span>
</span><a name="line-599"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sfInScope</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421719"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-600"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-601"></a><span>    </span><a name="local-6989586621680421720"><a href="#local-6989586621680421720"><span class="hs-identifier">floats'</span></a></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isNilOL</span><span> </span><a href="#local-6989586621680421716"><span class="hs-identifier hs-var">bs</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#emptyLetFloats"><span class="hs-identifier hs-var">emptyLetFloats</span></a><span>
</span><a name="line-602"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#unitLetFloat"><span class="hs-identifier hs-var">unitLetFloat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flattenBinds</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromOL</span><span> </span><a href="#local-6989586621680421716"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-603"></a><span>    </span><a name="local-6989586621680421721"><a href="#local-6989586621680421721"><span class="hs-identifier">jfloats'</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isNilOL</span><span> </span><a href="#local-6989586621680421718"><span class="hs-identifier hs-var">jbs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#emptyJoinFloats"><span class="hs-identifier hs-var">emptyJoinFloats</span></a><span>
</span><a name="line-604"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#unitJoinFloat"><span class="hs-identifier hs-var">unitJoinFloat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flattenBinds</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromOL</span><span> </span><a href="#local-6989586621680421718"><span class="hs-identifier hs-var">jbs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-605"></a><span>
</span><a name="line-606"></a><span class="hs-identifier">wrapFloats</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutExpr</span><span>
</span><a name="line-607"></a><span class="hs-comment">-- Wrap the floats around the expression; they should all</span><span>
</span><a name="line-608"></a><span class="hs-comment">-- satisfy the let/app invariant, so mkLets should do the job just fine</span><span>
</span><a name="line-609"></a><a name="wrapFloats"><a href="SimplEnv.html#wrapFloats"><span class="hs-identifier">wrapFloats</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-var">SimplFloats</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sfLetFloats</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#LetFloats"><span class="hs-identifier hs-var">LetFloats</span></a><span> </span><a name="local-6989586621680421722"><a href="#local-6989586621680421722"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-610"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sfJoinFloats</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421723"><a href="#local-6989586621680421723"><span class="hs-identifier">jbs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680421724"><a href="#local-6989586621680421724"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-611"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldrOL</span><span> </span><span class="hs-identifier hs-var">Let</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#wrapJoinFloats"><span class="hs-identifier hs-var">wrapJoinFloats</span></a><span> </span><a href="#local-6989586621680421723"><span class="hs-identifier hs-var">jbs</span></a><span> </span><a href="#local-6989586621680421724"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680421722"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-612"></a><span>     </span><span class="hs-comment">-- Note: Always safe to put the joins on the inside</span><span>
</span><a name="line-613"></a><span>     </span><span class="hs-comment">-- since the values can't refer to them</span><span>
</span><a name="line-614"></a><span>
</span><a name="line-615"></a><span class="hs-identifier">wrapJoinFloatsX</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">OutExpr</span><span class="hs-special">)</span><span>
</span><a name="line-616"></a><span class="hs-comment">-- Wrap the sfJoinFloats of the env around the expression,</span><span>
</span><a name="line-617"></a><span class="hs-comment">-- and take them out of the SimplEnv</span><span>
</span><a name="line-618"></a><a name="wrapJoinFloatsX"><a href="SimplEnv.html#wrapJoinFloatsX"><span class="hs-identifier">wrapJoinFloatsX</span></a></a><span> </span><a name="local-6989586621680421725"><a href="#local-6989586621680421725"><span class="hs-identifier">floats</span></a></a><span> </span><a name="local-6989586621680421726"><a href="#local-6989586621680421726"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-619"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621680421725"><span class="hs-identifier hs-var">floats</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sfJoinFloats</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#emptyJoinFloats"><span class="hs-identifier hs-var">emptyJoinFloats</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-620"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="SimplEnv.html#wrapJoinFloats"><span class="hs-identifier hs-var">wrapJoinFloats</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">sfJoinFloats</span><span> </span><a href="#local-6989586621680421725"><span class="hs-identifier hs-var">floats</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680421726"><span class="hs-identifier hs-var">body</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-621"></a><span>
</span><a name="line-622"></a><span class="hs-identifier">wrapJoinFloats</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#JoinFloats"><span class="hs-identifier hs-type">JoinFloats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutExpr</span><span>
</span><a name="line-623"></a><span class="hs-comment">-- Wrap the sfJoinFloats of the env around the expression,</span><span>
</span><a name="line-624"></a><span class="hs-comment">-- and take them out of the SimplEnv</span><span>
</span><a name="line-625"></a><a name="wrapJoinFloats"><a href="SimplEnv.html#wrapJoinFloats"><span class="hs-identifier">wrapJoinFloats</span></a></a><span> </span><a name="local-6989586621680421727"><a href="#local-6989586621680421727"><span class="hs-identifier">join_floats</span></a></a><span> </span><a name="local-6989586621680421728"><a href="#local-6989586621680421728"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-626"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldrOL</span><span> </span><span class="hs-identifier hs-var">Let</span><span> </span><a href="#local-6989586621680421728"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621680421727"><span class="hs-identifier hs-var">join_floats</span></a><span>
</span><a name="line-627"></a><span>
</span><a name="line-628"></a><span class="hs-identifier">getTopFloatBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-type">SimplFloats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreBind</span><span class="hs-special">]</span><span>
</span><a name="line-629"></a><a name="getTopFloatBinds"><a href="SimplEnv.html#getTopFloatBinds"><span class="hs-identifier">getTopFloatBinds</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplFloats"><span class="hs-identifier hs-var">SimplFloats</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sfLetFloats</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421729"><a href="#local-6989586621680421729"><span class="hs-identifier">lbs</span></a></a><span>
</span><a name="line-630"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sfJoinFloats</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421730"><a href="#local-6989586621680421730"><span class="hs-identifier">jbs</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-631"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isNilOL</span><span> </span><span class="hs-identifier hs-var">jbs</span><span> </span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Can't be any top-level join bindings</span><span>
</span><a name="line-632"></a><span>    </span><a href="SimplEnv.html#letFloatBinds"><span class="hs-identifier hs-var">letFloatBinds</span></a><span> </span><a href="#local-6989586621680421729"><span class="hs-identifier hs-var">lbs</span></a><span>
</span><a name="line-633"></a><span>
</span><a name="line-634"></a><span class="hs-identifier">mapLetFloats</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#LetFloats"><span class="hs-identifier hs-type">LetFloats</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#LetFloats"><span class="hs-identifier hs-type">LetFloats</span></a><span>
</span><a name="line-635"></a><a name="mapLetFloats"><a href="SimplEnv.html#mapLetFloats"><span class="hs-identifier">mapLetFloats</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#LetFloats"><span class="hs-identifier hs-var">LetFloats</span></a><span> </span><a name="local-6989586621680421731"><a href="#local-6989586621680421731"><span class="hs-identifier">fs</span></a></a><span> </span><a name="local-6989586621680421732"><a href="#local-6989586621680421732"><span class="hs-identifier">ff</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680421733"><a href="#local-6989586621680421733"><span class="hs-identifier">fun</span></a></a><span>
</span><a name="line-636"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#LetFloats"><span class="hs-identifier hs-var">LetFloats</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapOL</span><span> </span><a href="#local-6989586621680421734"><span class="hs-identifier hs-var">app</span></a><span> </span><a href="#local-6989586621680421731"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680421732"><span class="hs-identifier hs-var">ff</span></a><span>
</span><a name="line-637"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-638"></a><span>    </span><a name="local-6989586621680421734"><a href="#local-6989586621680421734"><span class="hs-identifier">app</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a name="local-6989586621680421735"><a href="#local-6989586621680421735"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621680421736"><a href="#local-6989586621680421736"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680421733"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680421735"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><a href="#local-6989586621680421736"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680421737"><a href="#local-6989586621680421737"><span class="hs-identifier">b'</span></a></a><span class="hs-special">,</span><a name="local-6989586621680421738"><a href="#local-6989586621680421738"><span class="hs-identifier">e'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621680421737"><span class="hs-identifier hs-var">b'</span></a><span> </span><a href="#local-6989586621680421738"><span class="hs-identifier hs-var">e'</span></a><span>
</span><a name="line-639"></a><span>    </span><span class="hs-identifier">app</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><a name="local-6989586621680421739"><a href="#local-6989586621680421739"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Rec</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621680421733"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621680421739"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span>
</span><a name="line-640"></a><span>
</span><a name="line-641"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Substitution of Vars
*                                                                      *
************************************************************************

Note [Global Ids in the substitution]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We look up even a global (eg imported) Id in the substitution. Consider
   case X.g_34 of b { (a,b) -&gt;  ... case X.g_34 of { (p,q) -&gt; ...} ... }
The binder-swap in the occurrence analyser will add a binding
for a LocalId version of g (with the same unique though):
   case X.g_34 of b { (a,b) -&gt;  let g_34 = b in
                                ... case X.g_34 of { (p,q) -&gt; ...} ... }
So we want to look up the inner X.g_34 in the substitution, where we'll
find that it has been substituted by b.  (Or conceivably cloned.)
-}</span><span>
</span><a name="line-659"></a><span>
</span><a name="line-660"></a><span class="hs-identifier">substId</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">InId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplSR"><span class="hs-identifier hs-type">SimplSR</span></a><span>
</span><a name="line-661"></a><span class="hs-comment">-- Returns DoneEx only on a non-Var expression</span><span>
</span><a name="line-662"></a><a name="substId"><a href="SimplEnv.html#substId"><span class="hs-identifier">substId</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-var">SimplEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">seInScope</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421740"><a href="#local-6989586621680421740"><span class="hs-identifier">in_scope</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">seIdSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421741"><a href="#local-6989586621680421741"><span class="hs-identifier">ids</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680421742"><a href="#local-6989586621680421742"><span class="hs-identifier">v</span></a></a><span>
</span><a name="line-663"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupVarEnv</span><span> </span><a href="#local-6989586621680421741"><span class="hs-identifier hs-var">ids</span></a><span> </span><a href="#local-6989586621680421742"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-keyword">of</span><span>  </span><span class="hs-comment">-- Note [Global Ids in the substitution]</span><span>
</span><a name="line-664"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#DoneId"><span class="hs-identifier hs-var">DoneId</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#refineFromInScope"><span class="hs-identifier hs-var">refineFromInScope</span></a><span> </span><a href="#local-6989586621680421740"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621680421742"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-665"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#DoneId"><span class="hs-identifier hs-var">DoneId</span></a><span> </span><a name="local-6989586621680421743"><a href="#local-6989586621680421743"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#DoneId"><span class="hs-identifier hs-var">DoneId</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#refineFromInScope"><span class="hs-identifier hs-var">refineFromInScope</span></a><span> </span><a href="#local-6989586621680421740"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621680421743"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-666"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680421744"><a href="#local-6989586621680421744"><span class="hs-identifier">res</span></a></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680421744"><span class="hs-identifier hs-var">res</span></a><span>    </span><span class="hs-comment">-- DoneEx non-var, or ContEx</span><span>
</span><a name="line-667"></a><span>
</span><a name="line-668"></a><span>        </span><span class="hs-comment">-- Get the most up-to-date thing from the in-scope set</span><span>
</span><a name="line-669"></a><span>        </span><span class="hs-comment">-- Even though it isn't in the substitution, it may be in</span><span>
</span><a name="line-670"></a><span>        </span><span class="hs-comment">-- the in-scope set with better IdInfo</span><span>
</span><a name="line-671"></a><span>
</span><a name="line-672"></a><span class="hs-identifier">refineFromInScope</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">InScopeSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Var</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Var</span><span>
</span><a name="line-673"></a><a name="refineFromInScope"><a href="SimplEnv.html#refineFromInScope"><span class="hs-identifier">refineFromInScope</span></a></a><span> </span><a name="local-6989586621680421745"><a href="#local-6989586621680421745"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621680421746"><a href="#local-6989586621680421746"><span class="hs-identifier">v</span></a></a><span>
</span><a name="line-674"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isLocalId</span><span> </span><a href="#local-6989586621680421746"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupInScope</span><span> </span><a href="#local-6989586621680421745"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621680421746"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-675"></a><span>                  </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680421747"><a href="#local-6989586621680421747"><span class="hs-identifier">v'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680421747"><span class="hs-identifier hs-var">v'</span></a><span>
</span><a name="line-676"></a><span>                  </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">WARN</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier hs-var">v</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">v</span><span>  </span><span class="hs-comment">-- This is an error!</span><span>
</span><a name="line-677"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421746"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-678"></a><span>
</span><a name="line-679"></a><span class="hs-identifier">lookupRecBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">InId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutId</span><span>
</span><a name="line-680"></a><span class="hs-comment">-- Look up an Id which has been put into the envt by simplRecBndrs,</span><span>
</span><a name="line-681"></a><span class="hs-comment">-- but where we have not yet done its RHS</span><span>
</span><a name="line-682"></a><a name="lookupRecBndr"><a href="SimplEnv.html#lookupRecBndr"><span class="hs-identifier">lookupRecBndr</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-var">SimplEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">seInScope</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421748"><a href="#local-6989586621680421748"><span class="hs-identifier">in_scope</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">seIdSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421749"><a href="#local-6989586621680421749"><span class="hs-identifier">ids</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680421750"><a href="#local-6989586621680421750"><span class="hs-identifier">v</span></a></a><span>
</span><a name="line-683"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupVarEnv</span><span> </span><a href="#local-6989586621680421749"><span class="hs-identifier hs-var">ids</span></a><span> </span><a href="#local-6989586621680421750"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-684"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#DoneId"><span class="hs-identifier hs-var">DoneId</span></a><span> </span><a name="local-6989586621680421751"><a href="#local-6989586621680421751"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680421751"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-685"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;lookupRecBndr&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680421750"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-686"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#refineFromInScope"><span class="hs-identifier hs-var">refineFromInScope</span></a><span> </span><a href="#local-6989586621680421748"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621680421750"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-687"></a><span>
</span><a name="line-688"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\section{Substituting an Id binder}
*                                                                      *
************************************************************************


These functions are in the monad only so that they can be made strict via seq.

Note [Return type for join points]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider

   (join j :: Char -&gt; Int -&gt; Int) 77
   (     j x = \y. y + ord x    )
   (in case v of                )
   (     A -&gt; j 'x'             )
   (     B -&gt; j 'y'             )
   (     C -&gt; &lt;blah&gt;            )

The simplifier pushes the &quot;apply to 77&quot; continuation inwards to give

   join j :: Char -&gt; Int
        j x = (\y. y + ord x) 77
   in case v of
        A -&gt; j 'x'
        B -&gt; j 'y'
        C -&gt; &lt;blah&gt; 77

Notice that the &quot;apply to 77&quot; continuation went into the RHS of the
join point.  And that meant that the return type of the join point
changed!!

That's why we pass res_ty into simplNonRecJoinBndr, and substIdBndr
takes a (Just res_ty) argument so that it knows to do the type-changing
thing.
-}</span><span>
</span><a name="line-726"></a><span>
</span><a name="line-727"></a><span class="hs-identifier">simplBinders</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">InBndr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">OutBndr</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-728"></a><a name="simplBinders"><a href="SimplEnv.html#simplBinders"><span class="hs-identifier">simplBinders</span></a></a><span>  </span><a name="local-6989586621680421752"><a href="#local-6989586621680421752"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680421753"><a href="#local-6989586621680421753"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAccumLM</span><span> </span><a href="SimplEnv.html#simplBinder"><span class="hs-identifier hs-var">simplBinder</span></a><span>  </span><a href="#local-6989586621680421752"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680421753"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-729"></a><span>
</span><a name="line-730"></a><span class="hs-comment">-------------</span><span>
</span><a name="line-731"></a><span class="hs-identifier">simplBinder</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">InBndr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">OutBndr</span><span class="hs-special">)</span><span>
</span><a name="line-732"></a><span class="hs-comment">-- Used for lambda and case-bound variables</span><span>
</span><a name="line-733"></a><span class="hs-comment">-- Clone Id if necessary, substitute type</span><span>
</span><a name="line-734"></a><span class="hs-comment">-- Return with IdInfo already substituted, but (fragile) occurrence info zapped</span><span>
</span><a name="line-735"></a><span class="hs-comment">-- The substitution is extended only if the variable is cloned, because</span><span>
</span><a name="line-736"></a><span class="hs-comment">-- we *don't* need to use it to track occurrence info.</span><span>
</span><a name="line-737"></a><a name="simplBinder"><a href="SimplEnv.html#simplBinder"><span class="hs-identifier">simplBinder</span></a></a><span> </span><a name="local-6989586621680421754"><a href="#local-6989586621680421754"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680421755"><a href="#local-6989586621680421755"><span class="hs-identifier">bndr</span></a></a><span>
</span><a name="line-738"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTyVar</span><span> </span><a href="#local-6989586621680421755"><span class="hs-identifier hs-var">bndr</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680421756"><a href="#local-6989586621680421756"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680421757"><a href="#local-6989586621680421757"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#substTyVarBndr"><span class="hs-identifier hs-var">substTyVarBndr</span></a><span> </span><a href="#local-6989586621680421754"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680421755"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-739"></a><span>                        </span><span class="hs-special">;</span><span> </span><a href="SimplEnv.html#seqTyVar"><span class="hs-identifier hs-var">seqTyVar</span></a><span> </span><a href="#local-6989586621680421757"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680421756"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680421757"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-740"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680421758"><a href="#local-6989586621680421758"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680421759"><a href="#local-6989586621680421759"><span class="hs-identifier">id</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#substIdBndr"><span class="hs-identifier hs-var">substIdBndr</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621680421754"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680421755"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-741"></a><span>                        </span><span class="hs-special">;</span><span> </span><a href="SimplEnv.html#seqId"><span class="hs-identifier hs-var">seqId</span></a><span> </span><a href="#local-6989586621680421759"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680421758"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680421759"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-742"></a><span>
</span><a name="line-743"></a><span class="hs-comment">---------------</span><span>
</span><a name="line-744"></a><span class="hs-identifier">simplNonRecBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">InBndr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">OutBndr</span><span class="hs-special">)</span><span>
</span><a name="line-745"></a><span class="hs-comment">-- A non-recursive let binder</span><span>
</span><a name="line-746"></a><a name="simplNonRecBndr"><a href="SimplEnv.html#simplNonRecBndr"><span class="hs-identifier">simplNonRecBndr</span></a></a><span> </span><a name="local-6989586621680421760"><a href="#local-6989586621680421760"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680421761"><a href="#local-6989586621680421761"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-747"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680421762"><a href="#local-6989586621680421762"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680421763"><a href="#local-6989586621680421763"><span class="hs-identifier">id1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#substIdBndr"><span class="hs-identifier hs-var">substIdBndr</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621680421760"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680421761"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-748"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="SimplEnv.html#seqId"><span class="hs-identifier hs-var">seqId</span></a><span> </span><a href="#local-6989586621680421763"><span class="hs-identifier hs-var">id1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680421762"><span class="hs-identifier hs-var">env1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680421763"><span class="hs-identifier hs-var">id1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-749"></a><span>
</span><a name="line-750"></a><span class="hs-comment">---------------</span><span>
</span><a name="line-751"></a><span class="hs-identifier">simplNonRecJoinBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">InBndr</span><span>
</span><a name="line-752"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">OutBndr</span><span class="hs-special">)</span><span>
</span><a name="line-753"></a><span class="hs-comment">-- A non-recursive let binder for a join point;</span><span>
</span><a name="line-754"></a><span class="hs-comment">-- context being pushed inward may change the type</span><span>
</span><a name="line-755"></a><span class="hs-comment">-- See Note [Return type for join points]</span><span>
</span><a name="line-756"></a><a name="simplNonRecJoinBndr"><a href="SimplEnv.html#simplNonRecJoinBndr"><span class="hs-identifier">simplNonRecJoinBndr</span></a></a><span> </span><a name="local-6989586621680421764"><a href="#local-6989586621680421764"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680421765"><a href="#local-6989586621680421765"><span class="hs-identifier">res_ty</span></a></a><span> </span><a name="local-6989586621680421766"><a href="#local-6989586621680421766"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-757"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680421767"><a href="#local-6989586621680421767"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680421768"><a href="#local-6989586621680421768"><span class="hs-identifier">id1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#substIdBndr"><span class="hs-identifier hs-var">substIdBndr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680421765"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680421764"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680421766"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-758"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="SimplEnv.html#seqId"><span class="hs-identifier hs-var">seqId</span></a><span> </span><a href="#local-6989586621680421768"><span class="hs-identifier hs-var">id1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680421767"><span class="hs-identifier hs-var">env1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680421768"><span class="hs-identifier hs-var">id1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-759"></a><span>
</span><a name="line-760"></a><span class="hs-comment">---------------</span><span>
</span><a name="line-761"></a><span class="hs-identifier">simplRecBndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">InBndr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-762"></a><span class="hs-comment">-- Recursive let binders</span><span>
</span><a name="line-763"></a><a name="simplRecBndrs"><a href="SimplEnv.html#simplRecBndrs"><span class="hs-identifier">simplRecBndrs</span></a></a><span> </span><a name="local-6989586621680421769"><a href="#local-6989586621680421769"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-var">SimplEnv</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680421770"><a href="#local-6989586621680421770"><span class="hs-identifier">ids</span></a></a><span>
</span><a name="line-764"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">isJoinId</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">ids</span><span class="hs-special">)</span><span>
</span><a name="line-765"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680421771"><a href="#local-6989586621680421771"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680421772"><a href="#local-6989586621680421772"><span class="hs-identifier">ids1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#substIdBndr"><span class="hs-identifier hs-var">substIdBndr</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680421769"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680421770"><span class="hs-identifier hs-var">ids</span></a><span>
</span><a name="line-766"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="SimplEnv.html#seqIds"><span class="hs-identifier hs-var">seqIds</span></a><span> </span><a href="#local-6989586621680421772"><span class="hs-identifier hs-var">ids1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680421771"><span class="hs-identifier hs-var">env1</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-767"></a><span>
</span><a name="line-768"></a><span class="hs-comment">---------------</span><span>
</span><a name="line-769"></a><span class="hs-identifier">simplRecJoinBndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">InBndr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplMonad.html#SimplM"><span class="hs-identifier hs-type">SimplM</span></a><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-770"></a><span class="hs-comment">-- Recursive let binders for join points;</span><span>
</span><a name="line-771"></a><span class="hs-comment">-- context being pushed inward may change types</span><span>
</span><a name="line-772"></a><span class="hs-comment">-- See Note [Return type for join points]</span><span>
</span><a name="line-773"></a><a name="simplRecJoinBndrs"><a href="SimplEnv.html#simplRecJoinBndrs"><span class="hs-identifier">simplRecJoinBndrs</span></a></a><span> </span><a name="local-6989586621680421773"><a href="#local-6989586621680421773"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-var">SimplEnv</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680421774"><a href="#local-6989586621680421774"><span class="hs-identifier">res_ty</span></a></a><span> </span><a name="local-6989586621680421775"><a href="#local-6989586621680421775"><span class="hs-identifier">ids</span></a></a><span>
</span><a name="line-774"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-identifier">isJoinId</span><span> </span><span class="hs-identifier">ids</span><span class="hs-special">)</span><span>
</span><a name="line-775"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680421776"><a href="#local-6989586621680421776"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680421777"><a href="#local-6989586621680421777"><span class="hs-identifier">ids1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#substIdBndr"><span class="hs-identifier hs-var">substIdBndr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680421774"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680421773"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680421775"><span class="hs-identifier hs-var">ids</span></a><span>
</span><a name="line-776"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="SimplEnv.html#seqIds"><span class="hs-identifier hs-var">seqIds</span></a><span> </span><a href="#local-6989586621680421777"><span class="hs-identifier hs-var">ids1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680421776"><span class="hs-identifier hs-var">env1</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-777"></a><span>
</span><a name="line-778"></a><span class="hs-comment">---------------</span><span>
</span><a name="line-779"></a><span class="hs-identifier">substIdBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">OutType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">InBndr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">OutBndr</span><span class="hs-special">)</span><span>
</span><a name="line-780"></a><span class="hs-comment">-- Might be a coercion variable</span><span>
</span><a name="line-781"></a><a name="substIdBndr"><a href="SimplEnv.html#substIdBndr"><span class="hs-identifier">substIdBndr</span></a></a><span> </span><a name="local-6989586621680421778"><a href="#local-6989586621680421778"><span class="hs-identifier">new_res_ty</span></a></a><span> </span><a name="local-6989586621680421779"><a href="#local-6989586621680421779"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680421780"><a href="#local-6989586621680421780"><span class="hs-identifier">bndr</span></a></a><span>
</span><a name="line-782"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isCoVar</span><span> </span><a href="#local-6989586621680421780"><span class="hs-identifier hs-var">bndr</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#substCoVarBndr"><span class="hs-identifier hs-var">substCoVarBndr</span></a><span> </span><a href="#local-6989586621680421779"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680421780"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-783"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#substNonCoVarIdBndr"><span class="hs-identifier hs-var">substNonCoVarIdBndr</span></a><span> </span><a href="#local-6989586621680421778"><span class="hs-identifier hs-var">new_res_ty</span></a><span> </span><a href="#local-6989586621680421779"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680421780"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-784"></a><span>
</span><a name="line-785"></a><span class="hs-comment">---------------</span><span>
</span><a name="line-786"></a><span class="hs-identifier">substNonCoVarIdBndr</span><span>
</span><a name="line-787"></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">OutType</span><span> </span><span class="hs-comment">-- New result type, if a join binder</span><span>
</span><a name="line-788"></a><span>                    </span><span class="hs-comment">-- See Note [Return type for join points]</span><span>
</span><a name="line-789"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span>
</span><a name="line-790"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">InBndr</span><span>    </span><span class="hs-comment">-- Env and binder to transform</span><span>
</span><a name="line-791"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">OutBndr</span><span class="hs-special">)</span><span>
</span><a name="line-792"></a><span class="hs-comment">-- Clone Id if necessary, substitute its type</span><span>
</span><a name="line-793"></a><span class="hs-comment">-- Return an Id with its</span><span>
</span><a name="line-794"></a><span class="hs-comment">--      * Type substituted</span><span>
</span><a name="line-795"></a><span class="hs-comment">--      * UnfoldingInfo, Rules, WorkerInfo zapped</span><span>
</span><a name="line-796"></a><span class="hs-comment">--      * Fragile OccInfo (only) zapped: Note [Robust OccInfo]</span><span>
</span><a name="line-797"></a><span class="hs-comment">--      * Robust info, retained especially arity and demand info,</span><span>
</span><a name="line-798"></a><span class="hs-comment">--         so that they are available to occurrences that occur in an</span><span>
</span><a name="line-799"></a><span class="hs-comment">--         earlier binding of a letrec</span><span>
</span><a name="line-800"></a><span class="hs-comment">--</span><span>
</span><a name="line-801"></a><span class="hs-comment">-- For the robust info, see Note [Arity robustness]</span><span>
</span><a name="line-802"></a><span class="hs-comment">--</span><span>
</span><a name="line-803"></a><span class="hs-comment">-- Augment the substitution  if the unique changed</span><span>
</span><a name="line-804"></a><span class="hs-comment">-- Extend the in-scope set with the new Id</span><span>
</span><a name="line-805"></a><span class="hs-comment">--</span><span>
</span><a name="line-806"></a><span class="hs-comment">-- Similar to CoreSubst.substIdBndr, except that</span><span>
</span><a name="line-807"></a><span class="hs-comment">--      the type of id_subst differs</span><span>
</span><a name="line-808"></a><span class="hs-comment">--      all fragile info is zapped</span><span>
</span><a name="line-809"></a><a name="substNonCoVarIdBndr"><a href="SimplEnv.html#substNonCoVarIdBndr"><span class="hs-identifier">substNonCoVarIdBndr</span></a></a><span> </span><a name="local-6989586621680421781"><a href="#local-6989586621680421781"><span class="hs-identifier">new_res_ty</span></a></a><span>
</span><a name="line-810"></a><span>                    </span><a name="local-6989586621680421782"><a href="#local-6989586621680421782"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-var">SimplEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">seInScope</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421783"><a href="#local-6989586621680421783"><span class="hs-identifier">in_scope</span></a></a><span>
</span><a name="line-811"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">seIdSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421784"><a href="#local-6989586621680421784"><span class="hs-identifier">id_subst</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-812"></a><span>                    </span><a name="local-6989586621680421785"><a href="#local-6989586621680421785"><span class="hs-identifier">old_id</span></a></a><span>
</span><a name="line-813"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isCoVar</span><span> </span><span class="hs-identifier">old_id</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621680421785"><span class="hs-identifier hs-var">old_id</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-814"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621680421782"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">seInScope</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421783"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">extendInScopeSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680421789"><span class="hs-identifier hs-var">new_id</span></a><span class="hs-special">,</span><span>
</span><a name="line-815"></a><span>           </span><span class="hs-identifier">seIdSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421790"><span class="hs-identifier hs-var">new_subst</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680421789"><span class="hs-identifier hs-var">new_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-816"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-817"></a><span>    </span><a name="local-6989586621680421786"><a href="#local-6989586621680421786"><span class="hs-identifier">id1</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">uniqAway</span><span> </span><a href="#local-6989586621680421783"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621680421785"><span class="hs-identifier hs-var">old_id</span></a><span>
</span><a name="line-818"></a><span>    </span><a name="local-6989586621680421787"><a href="#local-6989586621680421787"><span class="hs-identifier">id2</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#substIdType"><span class="hs-identifier hs-var">substIdType</span></a><span> </span><a href="#local-6989586621680421782"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680421786"><span class="hs-identifier hs-var">id1</span></a><span>
</span><a name="line-819"></a><span>
</span><a name="line-820"></a><span>    </span><a name="local-6989586621680421788"><a href="#local-6989586621680421788"><span class="hs-identifier">id3</span></a></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680421791"><a href="#local-6989586621680421791"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680421781"><span class="hs-identifier hs-var">new_res_ty</span></a><span>
</span><a name="line-821"></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421787"><span class="hs-identifier hs-var">id2</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">setIdType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">setJoinResTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idJoinArity</span><span> </span><a href="#local-6989586621680421787"><span class="hs-identifier hs-var">id2</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680421791"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621680421787"><span class="hs-identifier hs-var">id2</span></a><span class="hs-special">)</span><span>
</span><a name="line-822"></a><span>                             </span><span class="hs-comment">-- See Note [Return type for join points]</span><span>
</span><a name="line-823"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-824"></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421787"><span class="hs-identifier hs-var">id2</span></a><span>
</span><a name="line-825"></a><span>
</span><a name="line-826"></a><span>    </span><a name="local-6989586621680421789"><a href="#local-6989586621680421789"><span class="hs-identifier">new_id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zapFragileIdInfo</span><span> </span><a href="#local-6989586621680421788"><span class="hs-identifier hs-var">id3</span></a><span>       </span><span class="hs-comment">-- Zaps rules, worker-info, unfolding</span><span>
</span><a name="line-827"></a><span>                                        </span><span class="hs-comment">-- and fragile OccInfo</span><span>
</span><a name="line-828"></a><span>
</span><a name="line-829"></a><span>        </span><span class="hs-comment">-- Extend the substitution if the unique has changed,</span><span>
</span><a name="line-830"></a><span>        </span><span class="hs-comment">-- or there's some useful occurrence information</span><span>
</span><a name="line-831"></a><span>        </span><span class="hs-comment">-- See the notes with substTyVarBndr for the delSubstEnv</span><span>
</span><a name="line-832"></a><span>    </span><a name="local-6989586621680421790"><a href="#local-6989586621680421790"><span class="hs-identifier">new_subst</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680421789"><span class="hs-identifier hs-var">new_id</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621680421785"><span class="hs-identifier hs-var">old_id</span></a><span>
</span><a name="line-833"></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendVarEnv</span><span> </span><a href="#local-6989586621680421784"><span class="hs-identifier hs-var">id_subst</span></a><span> </span><a href="#local-6989586621680421785"><span class="hs-identifier hs-var">old_id</span></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#DoneId"><span class="hs-identifier hs-var">DoneId</span></a><span> </span><a href="#local-6989586621680421789"><span class="hs-identifier hs-var">new_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-834"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-835"></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">delVarEnv</span><span> </span><a href="#local-6989586621680421784"><span class="hs-identifier hs-var">id_subst</span></a><span> </span><a href="#local-6989586621680421785"><span class="hs-identifier hs-var">old_id</span></a><span>
</span><a name="line-836"></a><span>
</span><a name="line-837"></a><span class="hs-comment">------------------------------------</span><span>
</span><a name="line-838"></a><span class="hs-identifier">seqTyVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-839"></a><a name="seqTyVar"><a href="SimplEnv.html#seqTyVar"><span class="hs-identifier">seqTyVar</span></a></a><span> </span><a name="local-6989586621680421792"><a href="#local-6989586621680421792"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421792"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-840"></a><span>
</span><a name="line-841"></a><span class="hs-identifier">seqId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-842"></a><a name="seqId"><a href="SimplEnv.html#seqId"><span class="hs-identifier">seqId</span></a></a><span> </span><a name="local-6989586621680421793"><a href="#local-6989586621680421793"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">seqType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621680421793"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>  </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span>
</span><a name="line-843"></a><span>           </span><span class="hs-identifier hs-var">idInfo</span><span> </span><a href="#local-6989586621680421793"><span class="hs-identifier hs-var">id</span></a><span>            </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span>
</span><a name="line-844"></a><span>           </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-845"></a><span>
</span><a name="line-846"></a><span class="hs-identifier">seqIds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-847"></a><a name="seqIds"><a href="SimplEnv.html#seqIds"><span class="hs-identifier">seqIds</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-848"></a><span class="hs-identifier">seqIds</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680421794"><a href="#local-6989586621680421794"><span class="hs-identifier">id</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621680421795"><a href="#local-6989586621680421795"><span class="hs-identifier">ids</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SimplEnv.html#seqId"><span class="hs-identifier hs-var">seqId</span></a><span> </span><a href="#local-6989586621680421794"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="SimplEnv.html#seqIds"><span class="hs-identifier hs-var">seqIds</span></a><span> </span><a href="#local-6989586621680421795"><span class="hs-identifier hs-var">ids</span></a><span>
</span><a name="line-849"></a><span>
</span><a name="line-850"></a><span class="hs-comment">{-
Note [Arity robustness]
~~~~~~~~~~~~~~~~~~~~~~~
We *do* transfer the arity from from the in_id of a let binding to the
out_id.  This is important, so that the arity of an Id is visible in
its own RHS.  For example:
        f = \x. ....g (\y. f y)....
We can eta-reduce the arg to g, because f is a value.  But that
needs to be visible.

This interacts with the 'state hack' too:
        f :: Bool -&gt; IO Int
        f = \x. case x of
                  True  -&gt; f y
                  False -&gt; \s -&gt; ...
Can we eta-expand f?  Only if we see that f has arity 1, and then we
take advantage of the 'state hack' on the result of
(f y) :: State# -&gt; (State#, Int) to expand the arity one more.

There is a disadvantage though.  Making the arity visible in the RHS
allows us to eta-reduce
        f = \x -&gt; f x
to
        f = f
which technically is not sound.   This is very much a corner case, so
I'm not worried about it.  Another idea is to ensure that f's arity
never decreases; its arity started as 1, and we should never eta-reduce
below that.


Note [Robust OccInfo]
~~~~~~~~~~~~~~~~~~~~~
It's important that we *do* retain the loop-breaker OccInfo, because
that's what stops the Id getting inlined infinitely, in the body of
the letrec.
-}</span><span>
</span><a name="line-886"></a><span>
</span><a name="line-887"></a><span>
</span><a name="line-888"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Impedance matching to type substitution
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-895"></a><span>
</span><a name="line-896"></a><span class="hs-identifier">getTCvSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TCvSubst</span><span>
</span><a name="line-897"></a><a name="getTCvSubst"><a href="SimplEnv.html#getTCvSubst"><span class="hs-identifier">getTCvSubst</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-var">SimplEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">seInScope</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421796"><a href="#local-6989586621680421796"><span class="hs-identifier">in_scope</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">seTvSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421797"><a href="#local-6989586621680421797"><span class="hs-identifier">tv_env</span></a></a><span>
</span><a name="line-898"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">seCvSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421798"><a href="#local-6989586621680421798"><span class="hs-identifier">cv_env</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-899"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTCvSubst</span><span> </span><a href="#local-6989586621680421796"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680421797"><span class="hs-identifier hs-var">tv_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680421798"><span class="hs-identifier hs-var">cv_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-900"></a><span>
</span><a name="line-901"></a><span class="hs-identifier">substTy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-902"></a><a name="substTy"><a href="SimplEnv.html#substTy"><span class="hs-identifier">substTy</span></a></a><span> </span><a name="local-6989586621680421799"><a href="#local-6989586621680421799"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680421800"><a href="#local-6989586621680421800"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Type.substTy</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#getTCvSubst"><span class="hs-identifier hs-var">getTCvSubst</span></a><span> </span><a href="#local-6989586621680421799"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680421800"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-903"></a><span>
</span><a name="line-904"></a><span class="hs-identifier">substTyVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-905"></a><a name="substTyVar"><a href="SimplEnv.html#substTyVar"><span class="hs-identifier">substTyVar</span></a></a><span> </span><a name="local-6989586621680421801"><a href="#local-6989586621680421801"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680421802"><a href="#local-6989586621680421802"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Type.substTyVar</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#getTCvSubst"><span class="hs-identifier hs-var">getTCvSubst</span></a><span> </span><a href="#local-6989586621680421801"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680421802"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-906"></a><span>
</span><a name="line-907"></a><span class="hs-identifier">substTyVarBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">)</span><span>
</span><a name="line-908"></a><a name="substTyVarBndr"><a href="SimplEnv.html#substTyVarBndr"><span class="hs-identifier">substTyVarBndr</span></a></a><span> </span><a name="local-6989586621680421803"><a href="#local-6989586621680421803"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680421804"><a href="#local-6989586621680421804"><span class="hs-identifier">tv</span></a></a><span>
</span><a name="line-909"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Type.substTyVarBndr</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#getTCvSubst"><span class="hs-identifier hs-var">getTCvSubst</span></a><span> </span><a href="#local-6989586621680421803"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680421804"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-910"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TCvSubst</span><span> </span><a name="local-6989586621680421805"><a href="#local-6989586621680421805"><span class="hs-identifier">in_scope'</span></a></a><span> </span><a name="local-6989586621680421806"><a href="#local-6989586621680421806"><span class="hs-identifier">tv_env'</span></a></a><span> </span><a name="local-6989586621680421807"><a href="#local-6989586621680421807"><span class="hs-identifier">cv_env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680421808"><a href="#local-6989586621680421808"><span class="hs-identifier">tv'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-911"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680421803"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">seInScope</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421805"><span class="hs-identifier hs-var">in_scope'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">seTvSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421806"><span class="hs-identifier hs-var">tv_env'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">seCvSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421807"><span class="hs-identifier hs-var">cv_env'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680421808"><span class="hs-identifier hs-var">tv'</span></a><span class="hs-special">)</span><span>
</span><a name="line-912"></a><span>
</span><a name="line-913"></a><span class="hs-identifier">substCoVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Coercion</span><span>
</span><a name="line-914"></a><a name="substCoVar"><a href="SimplEnv.html#substCoVar"><span class="hs-identifier">substCoVar</span></a></a><span> </span><a name="local-6989586621680421809"><a href="#local-6989586621680421809"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680421810"><a href="#local-6989586621680421810"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Coercion.substCoVar</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#getTCvSubst"><span class="hs-identifier hs-var">getTCvSubst</span></a><span> </span><a href="#local-6989586621680421809"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680421810"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-915"></a><span>
</span><a name="line-916"></a><span class="hs-identifier">substCoVarBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CoVar</span><span class="hs-special">)</span><span>
</span><a name="line-917"></a><a name="substCoVarBndr"><a href="SimplEnv.html#substCoVarBndr"><span class="hs-identifier">substCoVarBndr</span></a></a><span> </span><a name="local-6989586621680421811"><a href="#local-6989586621680421811"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680421812"><a href="#local-6989586621680421812"><span class="hs-identifier">cv</span></a></a><span>
</span><a name="line-918"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Coercion.substCoVarBndr</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#getTCvSubst"><span class="hs-identifier hs-var">getTCvSubst</span></a><span> </span><a href="#local-6989586621680421811"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680421812"><span class="hs-identifier hs-var">cv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-919"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TCvSubst</span><span> </span><a name="local-6989586621680421813"><a href="#local-6989586621680421813"><span class="hs-identifier">in_scope'</span></a></a><span> </span><a name="local-6989586621680421814"><a href="#local-6989586621680421814"><span class="hs-identifier">tv_env'</span></a></a><span> </span><a name="local-6989586621680421815"><a href="#local-6989586621680421815"><span class="hs-identifier">cv_env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680421816"><a href="#local-6989586621680421816"><span class="hs-identifier">cv'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-920"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680421811"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">seInScope</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421813"><span class="hs-identifier hs-var">in_scope'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">seTvSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421814"><span class="hs-identifier hs-var">tv_env'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">seCvSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421815"><span class="hs-identifier hs-var">cv_env'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680421816"><span class="hs-identifier hs-var">cv'</span></a><span class="hs-special">)</span><span>
</span><a name="line-921"></a><span>
</span><a name="line-922"></a><span class="hs-identifier">substCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Coercion</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Coercion</span><span>
</span><a name="line-923"></a><a name="substCo"><a href="SimplEnv.html#substCo"><span class="hs-identifier">substCo</span></a></a><span> </span><a name="local-6989586621680421817"><a href="#local-6989586621680421817"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680421818"><a href="#local-6989586621680421818"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Coercion.substCo</span><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#getTCvSubst"><span class="hs-identifier hs-var">getTCvSubst</span></a><span> </span><a href="#local-6989586621680421817"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680421818"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-924"></a><span>
</span><a name="line-925"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-926"></a><span class="hs-identifier">substIdType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-type">SimplEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-927"></a><a name="substIdType"><a href="SimplEnv.html#substIdType"><span class="hs-identifier">substIdType</span></a></a><span> </span><span class="hs-special">(</span><a href="SimplEnv.html#SimplEnv"><span class="hs-identifier hs-var">SimplEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">seInScope</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421819"><a href="#local-6989586621680421819"><span class="hs-identifier">in_scope</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">seTvSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421820"><a href="#local-6989586621680421820"><span class="hs-identifier">tv_env</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">seCvSubst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680421821"><a href="#local-6989586621680421821"><span class="hs-identifier">cv_env</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680421822"><a href="#local-6989586621680421822"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-928"></a><span>  </span><span class="hs-glyph">|</span><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isEmptyVarEnv</span><span> </span><a href="#local-6989586621680421820"><span class="hs-identifier hs-var">tv_env</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isEmptyVarEnv</span><span> </span><a href="#local-6989586621680421821"><span class="hs-identifier hs-var">cv_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-929"></a><span>  </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">noFreeVarsOfType</span><span> </span><a href="#local-6989586621680421823"><span class="hs-identifier hs-var">old_ty</span></a><span>
</span><a name="line-930"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680421822"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-931"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Id.setIdType</span><span> </span><a href="#local-6989586621680421822"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Type.substTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TCvSubst</span><span> </span><a href="#local-6989586621680421819"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621680421820"><span class="hs-identifier hs-var">tv_env</span></a><span> </span><a href="#local-6989586621680421821"><span class="hs-identifier hs-var">cv_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680421823"><span class="hs-identifier hs-var">old_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-932"></a><span>                </span><span class="hs-comment">-- The tyCoVarsOfType is cheaper than it looks</span><span>
</span><a name="line-933"></a><span>                </span><span class="hs-comment">-- because we cache the free tyvars of the type</span><span>
</span><a name="line-934"></a><span>                </span><span class="hs-comment">-- in a Note in the id's type itself</span><span>
</span><a name="line-935"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-936"></a><span>    </span><a name="local-6989586621680421823"><a href="#local-6989586621680421823"><span class="hs-identifier">old_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621680421822"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-937"></a></pre></body></html>