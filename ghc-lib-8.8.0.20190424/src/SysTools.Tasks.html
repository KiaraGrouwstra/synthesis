<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-2"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-3"></a><span class="hs-comment">--</span><span>
</span><a name="line-4"></a><span class="hs-comment">-- Tasks running external programs for SysTools</span><span>
</span><a name="line-5"></a><span class="hs-comment">--</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- (c) The GHC Team 2017</span><span>
</span><a name="line-7"></a><span class="hs-comment">--</span><span>
</span><a name="line-8"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-9"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">SysTools.Tasks</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Exception</span><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Platform</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Char</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.IO</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Process</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="LlvmCodeGen.Base.html"><span class="hs-identifier">LlvmCodeGen.Base</span></a><span> </span><span class="hs-special">(</span><a href="LlvmCodeGen.Base.html#llvmVersionStr"><span class="hs-identifier hs-var">llvmVersionStr</span></a><span class="hs-special">,</span><span> </span><a href="LlvmCodeGen.Base.html#supportedLlvmVersion"><span class="hs-identifier hs-var">supportedLlvmVersion</span></a><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="SysTools.Process.html"><span class="hs-identifier">SysTools.Process</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="SysTools.Info.html"><span class="hs-identifier">SysTools.Info</span></a><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Running an external program}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span class="hs-identifier">runUnlit</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Option</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><a name="runUnlit"><a href="SysTools.Tasks.html#runUnlit"><span class="hs-identifier">runUnlit</span></a></a><span> </span><a name="local-6989586621681237956"><a href="#local-6989586621681237956"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681237957"><a href="#local-6989586621681237957"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-40"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681237958"><a href="#local-6989586621681237958"><span class="hs-identifier">prog</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pgm_L</span><span> </span><a href="#local-6989586621681237956"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-41"></a><span>      </span><a name="local-6989586621681237959"><a href="#local-6989586621681237959"><span class="hs-identifier">opts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getOpts</span><span> </span><a href="#local-6989586621681237956"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">opt_L</span><span>
</span><a name="line-42"></a><span>  </span><a href="SysTools.Process.html#runSomething"><span class="hs-identifier hs-var">runSomething</span></a><span> </span><a href="#local-6989586621681237956"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-string">&quot;Literate pre-processor&quot;</span><span> </span><a href="#local-6989586621681237958"><span class="hs-identifier hs-var">prog</span></a><span>
</span><a name="line-43"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><a href="#local-6989586621681237959"><span class="hs-identifier hs-var">opts</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681237957"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span>
</span><a name="line-45"></a><span class="hs-identifier">runCpp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Option</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><a name="runCpp"><a href="SysTools.Tasks.html#runCpp"><span class="hs-identifier">runCpp</span></a></a><span> </span><a name="local-6989586621681237960"><a href="#local-6989586621681237960"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681237961"><a href="#local-6989586621681237961"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span>   </span><span class="hs-keyword">do</span><span>
</span><a name="line-47"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681237962"><a href="#local-6989586621681237962"><span class="hs-identifier">p</span></a></a><span class="hs-special">,</span><a name="local-6989586621681237963"><a href="#local-6989586621681237963"><span class="hs-identifier">args0</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pgm_P</span><span> </span><a href="#local-6989586621681237960"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-48"></a><span>      </span><a name="local-6989586621681237964"><a href="#local-6989586621681237964"><span class="hs-identifier">args1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOpts</span><span> </span><a href="#local-6989586621681237960"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">opt_P</span><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span>      </span><a name="local-6989586621681237965"><a href="#local-6989586621681237965"><span class="hs-identifier">args2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-string">&quot;-Werror&quot;</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_WarnIsError</span><span> </span><a href="#local-6989586621681237960"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">]</span><span>
</span><a name="line-50"></a><span>                </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-string">&quot;-Wundef&quot;</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">wopt</span><span> </span><span class="hs-identifier hs-var">Opt_WarnCPPUndef</span><span> </span><a href="#local-6989586621681237960"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">]</span><span>
</span><a name="line-51"></a><span>  </span><a name="local-6989586621681237966"><a href="#local-6989586621681237966"><span class="hs-identifier">mb_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SysTools.Process.html#getGccEnv"><span class="hs-identifier hs-var">getGccEnv</span></a><span> </span><a href="#local-6989586621681237965"><span class="hs-identifier hs-var">args2</span></a><span>
</span><a name="line-52"></a><span>  </span><a href="SysTools.Process.html#runSomethingFiltered"><span class="hs-identifier hs-var">runSomethingFiltered</span></a><span> </span><a href="#local-6989586621681237960"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">id</span><span>  </span><span class="hs-string">&quot;C pre-processor&quot;</span><span> </span><a href="#local-6989586621681237962"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-53"></a><span>                       </span><span class="hs-special">(</span><a href="#local-6989586621681237963"><span class="hs-identifier hs-var">args0</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681237964"><span class="hs-identifier hs-var">args1</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681237965"><span class="hs-identifier hs-var">args2</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681237961"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621681237966"><span class="hs-identifier hs-var">mb_env</span></a><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span class="hs-identifier">runPp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Option</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-56"></a><a name="runPp"><a href="SysTools.Tasks.html#runPp"><span class="hs-identifier">runPp</span></a></a><span> </span><a name="local-6989586621681237967"><a href="#local-6989586621681237967"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681237968"><a href="#local-6989586621681237968"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span>   </span><span class="hs-keyword">do</span><span>
</span><a name="line-57"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681237969"><a href="#local-6989586621681237969"><span class="hs-identifier">prog</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pgm_F</span><span> </span><a href="#local-6989586621681237967"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-58"></a><span>      </span><a name="local-6989586621681237970"><a href="#local-6989586621681237970"><span class="hs-identifier">opts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOpts</span><span> </span><a href="#local-6989586621681237967"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">opt_F</span><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span>  </span><a href="SysTools.Process.html#runSomething"><span class="hs-identifier hs-var">runSomething</span></a><span> </span><a href="#local-6989586621681237967"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-string">&quot;Haskell pre-processor&quot;</span><span> </span><a href="#local-6989586621681237969"><span class="hs-identifier hs-var">prog</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681237968"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681237970"><span class="hs-identifier hs-var">opts</span></a><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span>
</span><a name="line-61"></a><span class="hs-identifier">runCc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Option</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-62"></a><a name="runCc"><a href="SysTools.Tasks.html#runCc"><span class="hs-identifier">runCc</span></a></a><span> </span><a name="local-6989586621681237971"><a href="#local-6989586621681237971"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681237972"><a href="#local-6989586621681237972"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span>   </span><span class="hs-keyword">do</span><span>
</span><a name="line-63"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681238001"><a href="#local-6989586621681238001"><span class="hs-identifier">p</span></a></a><span class="hs-special">,</span><a name="local-6989586621681238002"><a href="#local-6989586621681238002"><span class="hs-identifier">args0</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pgm_c</span><span> </span><a href="#local-6989586621681237971"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-64"></a><span>      </span><a name="local-6989586621681238003"><a href="#local-6989586621681238003"><span class="hs-identifier">args1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOpts</span><span> </span><a href="#local-6989586621681237971"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">opt_c</span><span class="hs-special">)</span><span>
</span><a name="line-65"></a><span>      </span><a name="local-6989586621681238004"><a href="#local-6989586621681238004"><span class="hs-identifier">args2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681238002"><span class="hs-identifier hs-var">args0</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681237972"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681238003"><span class="hs-identifier hs-var">args1</span></a><span>
</span><a name="line-66"></a><span>      </span><span class="hs-comment">-- We take care to pass -optc flags in args1 last to ensure that the</span><span>
</span><a name="line-67"></a><span>      </span><span class="hs-comment">-- user can override flags passed by GHC. See #14452.</span><span>
</span><a name="line-68"></a><span>  </span><a name="local-6989586621681238005"><a href="#local-6989586621681238005"><span class="hs-identifier">mb_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SysTools.Process.html#getGccEnv"><span class="hs-identifier hs-var">getGccEnv</span></a><span> </span><a href="#local-6989586621681238004"><span class="hs-identifier hs-var">args2</span></a><span>
</span><a name="line-69"></a><span>  </span><a href="SysTools.Process.html#runSomethingResponseFile"><span class="hs-identifier hs-var">runSomethingResponseFile</span></a><span> </span><a href="#local-6989586621681237971"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681237973"><span class="hs-identifier hs-var">cc_filter</span></a><span> </span><span class="hs-string">&quot;C Compiler&quot;</span><span> </span><a href="#local-6989586621681238001"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681238004"><span class="hs-identifier hs-var">args2</span></a><span> </span><a href="#local-6989586621681238005"><span class="hs-identifier hs-var">mb_env</span></a><span>
</span><a name="line-70"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-71"></a><span>  </span><span class="hs-comment">-- discard some harmless warnings from gcc that we can't turn off</span><span>
</span><a name="line-72"></a><span>  </span><a name="local-6989586621681237973"><a href="#local-6989586621681237973"><span class="hs-identifier">cc_filter</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unlines</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621681237974"><span class="hs-identifier hs-var">doFilter</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">lines</span><span>
</span><a name="line-73"></a><span>
</span><a name="line-74"></a><span>  </span><span class="hs-comment">{-
  gcc gives warnings in chunks like so:
      In file included from /foo/bar/baz.h:11,
                       from /foo/bar/baz2.h:22,
                       from wibble.c:33:
      /foo/flibble:14: global register variable ...
      /foo/flibble:15: warning: call-clobbered r...
  We break it up into its chunks, remove any call-clobbered register
  warnings from each chunk, and then delete any chunks that we have
  emptied of warnings.
  -}</span><span>
</span><a name="line-85"></a><span>  </span><a name="local-6989586621681237974"><a href="#local-6989586621681237974"><span class="hs-identifier">doFilter</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681237977"><span class="hs-identifier hs-var">unChunkWarnings</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621681237976"><span class="hs-identifier hs-var">filterWarnings</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621681237975"><span class="hs-identifier hs-var">chunkWarnings</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-86"></a><span>  </span><span class="hs-comment">-- We can't assume that the output will start with an &quot;In file inc...&quot;</span><span>
</span><a name="line-87"></a><span>  </span><span class="hs-comment">-- line, so we start off expecting a list of warnings rather than a</span><span>
</span><a name="line-88"></a><span>  </span><span class="hs-comment">-- location stack.</span><span>
</span><a name="line-89"></a><span>  </span><span class="hs-identifier">chunkWarnings</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- The location stack to use for the next</span><span>
</span><a name="line-90"></a><span>                            </span><span class="hs-comment">-- list of warnings</span><span>
</span><a name="line-91"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- The remaining lines to look at</span><span>
</span><a name="line-92"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-93"></a><span>  </span><a name="local-6989586621681237975"><a href="#local-6989586621681237975"><span class="hs-identifier">chunkWarnings</span></a></a><span> </span><a name="local-6989586621681237981"><a href="#local-6989586621681237981"><span class="hs-identifier">loc_stack</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621681237981"><span class="hs-identifier hs-var">loc_stack</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-94"></a><span>  </span><span class="hs-identifier">chunkWarnings</span><span> </span><a name="local-6989586621681237982"><a href="#local-6989586621681237982"><span class="hs-identifier">loc_stack</span></a></a><span> </span><a name="local-6989586621681237983"><a href="#local-6989586621681237983"><span class="hs-identifier">xs</span></a></a><span>
</span><a name="line-95"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">break</span><span> </span><a href="#local-6989586621681237978"><span class="hs-identifier hs-var">loc_stack_start</span></a><span> </span><a href="#local-6989586621681237983"><span class="hs-identifier hs-var">xs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-96"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621681237984"><a href="#local-6989586621681237984"><span class="hs-identifier">warnings</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681237985"><a href="#local-6989586621681237985"><span class="hs-identifier">lss</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621681237986"><a href="#local-6989586621681237986"><span class="hs-identifier">xs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-97"></a><span>            </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">span</span><span> </span><a href="#local-6989586621681237979"><span class="hs-identifier hs-var">loc_start_continuation</span></a><span> </span><a href="#local-6989586621681237986"><span class="hs-identifier hs-var">xs'</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-98"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621681237987"><a href="#local-6989586621681237987"><span class="hs-identifier">lsc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681237988"><a href="#local-6989586621681237988"><span class="hs-identifier">xs''</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-99"></a><span>                </span><span class="hs-special">(</span><a href="#local-6989586621681237982"><span class="hs-identifier hs-var">loc_stack</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681237984"><span class="hs-identifier hs-var">warnings</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621681237975"><span class="hs-identifier hs-var">chunkWarnings</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681237985"><span class="hs-identifier hs-var">lss</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621681237987"><span class="hs-identifier hs-var">lsc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681237988"><span class="hs-identifier hs-var">xs''</span></a><span>
</span><a name="line-100"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621681237982"><span class="hs-identifier hs-var">loc_stack</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681237983"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span>  </span><span class="hs-identifier">filterWarnings</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-103"></a><span>  </span><a name="local-6989586621681237976"><a href="#local-6989586621681237976"><span class="hs-identifier">filterWarnings</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-104"></a><span>  </span><span class="hs-comment">-- If the warnings are already empty then we are probably doing</span><span>
</span><a name="line-105"></a><span>  </span><span class="hs-comment">-- something wrong, so don't delete anything</span><span>
</span><a name="line-106"></a><span>  </span><span class="hs-identifier">filterWarnings</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621681237989"><a href="#local-6989586621681237989"><span class="hs-identifier">xs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621681237990"><a href="#local-6989586621681237990"><span class="hs-identifier">zs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681237989"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621681237976"><span class="hs-identifier hs-var">filterWarnings</span></a><span> </span><a href="#local-6989586621681237990"><span class="hs-identifier hs-var">zs</span></a><span>
</span><a name="line-107"></a><span>  </span><span class="hs-identifier">filterWarnings</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621681237991"><a href="#local-6989586621681237991"><span class="hs-identifier">xs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681237992"><a href="#local-6989586621681237992"><span class="hs-identifier">ys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621681237993"><a href="#local-6989586621681237993"><span class="hs-identifier">zs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621681237980"><span class="hs-identifier hs-var">wantedWarning</span></a><span> </span><a href="#local-6989586621681237992"><span class="hs-identifier hs-var">ys</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-108"></a><span>                                       </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681237976"><span class="hs-identifier hs-var">filterWarnings</span></a><span> </span><a href="#local-6989586621681237993"><span class="hs-identifier hs-var">zs</span></a><span>
</span><a name="line-109"></a><span>                                       </span><a name="local-6989586621681237994"><a href="#local-6989586621681237994"><span class="hs-identifier">ys'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681237991"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681237994"><span class="hs-identifier hs-var">ys'</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621681237976"><span class="hs-identifier hs-var">filterWarnings</span></a><span> </span><a href="#local-6989586621681237993"><span class="hs-identifier hs-var">zs</span></a><span>
</span><a name="line-110"></a><span>
</span><a name="line-111"></a><span>  </span><span class="hs-identifier">unChunkWarnings</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span>
</span><a name="line-112"></a><span>  </span><a name="local-6989586621681237977"><a href="#local-6989586621681237977"><span class="hs-identifier">unChunkWarnings</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-113"></a><span>  </span><span class="hs-identifier">unChunkWarnings</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621681237995"><a href="#local-6989586621681237995"><span class="hs-identifier">xs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681237996"><a href="#local-6989586621681237996"><span class="hs-identifier">ys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621681237997"><a href="#local-6989586621681237997"><span class="hs-identifier">zs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681237995"><span class="hs-identifier hs-var">xs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681237996"><span class="hs-identifier hs-var">ys</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681237977"><span class="hs-identifier hs-var">unChunkWarnings</span></a><span> </span><a href="#local-6989586621681237997"><span class="hs-identifier hs-var">zs</span></a><span>
</span><a name="line-114"></a><span>
</span><a name="line-115"></a><span>  </span><a name="local-6989586621681237978"><a href="#local-6989586621681237978"><span class="hs-identifier">loc_stack_start</span></a></a><span>        </span><a name="local-6989586621681237998"><a href="#local-6989586621681237998"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;In file included from &quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">isPrefixOf</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681237998"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-116"></a><span>  </span><a name="local-6989586621681237979"><a href="#local-6989586621681237979"><span class="hs-identifier">loc_start_continuation</span></a></a><span> </span><a name="local-6989586621681237999"><a href="#local-6989586621681237999"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;                 from &quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">isPrefixOf</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681237999"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-117"></a><span>  </span><a name="local-6989586621681237980"><a href="#local-6989586621681237980"><span class="hs-identifier">wantedWarning</span></a></a><span> </span><a name="local-6989586621681238000"><a href="#local-6989586621681238000"><span class="hs-identifier">w</span></a></a><span>
</span><a name="line-118"></a><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-string">&quot;warning: call-clobbered register used&quot;</span><span> </span><span class="hs-special">`</span><a href="SysTools.Tasks.html#isContainedIn"><span class="hs-identifier hs-var">isContainedIn</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621681238000"><span class="hs-identifier hs-var">w</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-119"></a><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-120"></a><span>
</span><a name="line-121"></a><span class="hs-identifier">isContainedIn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-122"></a><a name="local-6989586621681238006"><a href="#local-6989586621681238006"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-special">`</span><a name="isContainedIn"><a href="SysTools.Tasks.html#isContainedIn"><span class="hs-identifier">isContainedIn</span></a></a><span class="hs-special">`</span><span> </span><a name="local-6989586621681238007"><a href="#local-6989586621681238007"><span class="hs-identifier">ys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681238006"><span class="hs-identifier hs-var">xs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">isPrefixOf</span><span class="hs-special">`</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tails</span><span> </span><a href="#local-6989586621681238007"><span class="hs-identifier hs-var">ys</span></a><span class="hs-special">)</span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-comment">-- | Run the linker with some arguments and return the output</span><span>
</span><a name="line-125"></a><span class="hs-identifier">askLd</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Option</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-126"></a><a name="askLd"><a href="SysTools.Tasks.html#askLd"><span class="hs-identifier">askLd</span></a></a><span> </span><a name="local-6989586621681238008"><a href="#local-6989586621681238008"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681238009"><a href="#local-6989586621681238009"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-127"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681238010"><a href="#local-6989586621681238010"><span class="hs-identifier">p</span></a></a><span class="hs-special">,</span><a name="local-6989586621681238011"><a href="#local-6989586621681238011"><span class="hs-identifier">args0</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pgm_l</span><span> </span><a href="#local-6989586621681238008"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-128"></a><span>      </span><a name="local-6989586621681238012"><a href="#local-6989586621681238012"><span class="hs-identifier">args1</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOpts</span><span> </span><a href="#local-6989586621681238008"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">opt_l</span><span class="hs-special">)</span><span>
</span><a name="line-129"></a><span>      </span><a name="local-6989586621681238013"><a href="#local-6989586621681238013"><span class="hs-identifier">args2</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681238011"><span class="hs-identifier hs-var">args0</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681238012"><span class="hs-identifier hs-var">args1</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681238009"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-130"></a><span>  </span><a name="local-6989586621681238014"><a href="#local-6989586621681238014"><span class="hs-identifier">mb_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SysTools.Process.html#getGccEnv"><span class="hs-identifier hs-var">getGccEnv</span></a><span> </span><a href="#local-6989586621681238013"><span class="hs-identifier hs-var">args2</span></a><span>
</span><a name="line-131"></a><span>  </span><a href="SysTools.Process.html#runSomethingWith"><span class="hs-identifier hs-var">runSomethingWith</span></a><span> </span><a href="#local-6989586621681238008"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-string">&quot;gcc&quot;</span><span> </span><a href="#local-6989586621681238010"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681238013"><span class="hs-identifier hs-var">args2</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681238015"><a href="#local-6989586621681238015"><span class="hs-identifier">real_args</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-132"></a><span>    </span><a href="SysTools.Process.html#readCreateProcessWithExitCode%27"><span class="hs-identifier hs-var">readCreateProcessWithExitCode'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">proc</span><span> </span><a href="#local-6989586621681238010"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681238015"><span class="hs-identifier hs-var">real_args</span></a><span class="hs-special">)</span><span class="hs-special">{</span><span> </span><span class="hs-identifier">env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681238014"><span class="hs-identifier hs-var">mb_env</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-133"></a><span>
</span><a name="line-134"></a><span class="hs-identifier">runSplit</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Option</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-135"></a><a name="runSplit"><a href="SysTools.Tasks.html#runSplit"><span class="hs-identifier">runSplit</span></a></a><span> </span><a name="local-6989586621681238016"><a href="#local-6989586621681238016"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681238017"><a href="#local-6989586621681238017"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-136"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681238018"><a href="#local-6989586621681238018"><span class="hs-identifier">p</span></a></a><span class="hs-special">,</span><a name="local-6989586621681238019"><a href="#local-6989586621681238019"><span class="hs-identifier">args0</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pgm_s</span><span> </span><a href="#local-6989586621681238016"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-137"></a><span>  </span><a href="SysTools.Process.html#runSomething"><span class="hs-identifier hs-var">runSomething</span></a><span> </span><a href="#local-6989586621681238016"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-string">&quot;Splitter&quot;</span><span> </span><a href="#local-6989586621681238018"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681238019"><span class="hs-identifier hs-var">args0</span></a><span class="hs-operator hs-var">++</span><a href="#local-6989586621681238017"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-138"></a><span>
</span><a name="line-139"></a><span class="hs-identifier">runAs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Option</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-140"></a><a name="runAs"><a href="SysTools.Tasks.html#runAs"><span class="hs-identifier">runAs</span></a></a><span> </span><a name="local-6989586621681238020"><a href="#local-6989586621681238020"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681238021"><a href="#local-6989586621681238021"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-141"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681238022"><a href="#local-6989586621681238022"><span class="hs-identifier">p</span></a></a><span class="hs-special">,</span><a name="local-6989586621681238023"><a href="#local-6989586621681238023"><span class="hs-identifier">args0</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pgm_a</span><span> </span><a href="#local-6989586621681238020"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-142"></a><span>      </span><a name="local-6989586621681238024"><a href="#local-6989586621681238024"><span class="hs-identifier">args1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOpts</span><span> </span><a href="#local-6989586621681238020"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">opt_a</span><span class="hs-special">)</span><span>
</span><a name="line-143"></a><span>      </span><a name="local-6989586621681238025"><a href="#local-6989586621681238025"><span class="hs-identifier">args2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681238023"><span class="hs-identifier hs-var">args0</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681238024"><span class="hs-identifier hs-var">args1</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681238021"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-144"></a><span>  </span><a name="local-6989586621681238026"><a href="#local-6989586621681238026"><span class="hs-identifier">mb_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SysTools.Process.html#getGccEnv"><span class="hs-identifier hs-var">getGccEnv</span></a><span> </span><a href="#local-6989586621681238025"><span class="hs-identifier hs-var">args2</span></a><span>
</span><a name="line-145"></a><span>  </span><a href="SysTools.Process.html#runSomethingFiltered"><span class="hs-identifier hs-var">runSomethingFiltered</span></a><span> </span><a href="#local-6989586621681238020"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-string">&quot;Assembler&quot;</span><span> </span><a href="#local-6989586621681238022"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681238025"><span class="hs-identifier hs-var">args2</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621681238026"><span class="hs-identifier hs-var">mb_env</span></a><span>
</span><a name="line-146"></a><span>
</span><a name="line-147"></a><span class="hs-comment">-- | Run the LLVM Optimiser</span><span>
</span><a name="line-148"></a><span class="hs-identifier">runLlvmOpt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Option</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-149"></a><a name="runLlvmOpt"><a href="SysTools.Tasks.html#runLlvmOpt"><span class="hs-identifier">runLlvmOpt</span></a></a><span> </span><a name="local-6989586621681238027"><a href="#local-6989586621681238027"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681238028"><a href="#local-6989586621681238028"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-150"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681238029"><a href="#local-6989586621681238029"><span class="hs-identifier">p</span></a></a><span class="hs-special">,</span><a name="local-6989586621681238030"><a href="#local-6989586621681238030"><span class="hs-identifier">args0</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pgm_lo</span><span> </span><a href="#local-6989586621681238027"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-151"></a><span>      </span><a name="local-6989586621681238031"><a href="#local-6989586621681238031"><span class="hs-identifier">args1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOpts</span><span> </span><a href="#local-6989586621681238027"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">opt_lo</span><span class="hs-special">)</span><span>
</span><a name="line-152"></a><span>      </span><span class="hs-comment">-- We take care to pass -optlo flags (e.g. args0) last to ensure that the</span><span>
</span><a name="line-153"></a><span>      </span><span class="hs-comment">-- user can override flags passed by GHC. See #14821.</span><span>
</span><a name="line-154"></a><span>  </span><a href="SysTools.Process.html#runSomething"><span class="hs-identifier hs-var">runSomething</span></a><span> </span><a href="#local-6989586621681238027"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-string">&quot;LLVM Optimiser&quot;</span><span> </span><a href="#local-6989586621681238029"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681238031"><span class="hs-identifier hs-var">args1</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681238028"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681238030"><span class="hs-identifier hs-var">args0</span></a><span class="hs-special">)</span><span>
</span><a name="line-155"></a><span>
</span><a name="line-156"></a><span class="hs-comment">-- | Run the LLVM Compiler</span><span>
</span><a name="line-157"></a><span class="hs-identifier">runLlvmLlc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Option</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-158"></a><a name="runLlvmLlc"><a href="SysTools.Tasks.html#runLlvmLlc"><span class="hs-identifier">runLlvmLlc</span></a></a><span> </span><a name="local-6989586621681238032"><a href="#local-6989586621681238032"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681238033"><a href="#local-6989586621681238033"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-159"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681238034"><a href="#local-6989586621681238034"><span class="hs-identifier">p</span></a></a><span class="hs-special">,</span><a name="local-6989586621681238035"><a href="#local-6989586621681238035"><span class="hs-identifier">args0</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pgm_lc</span><span> </span><a href="#local-6989586621681238032"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-160"></a><span>      </span><a name="local-6989586621681238036"><a href="#local-6989586621681238036"><span class="hs-identifier">args1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOpts</span><span> </span><a href="#local-6989586621681238032"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">opt_lc</span><span class="hs-special">)</span><span>
</span><a name="line-161"></a><span>  </span><a href="SysTools.Process.html#runSomething"><span class="hs-identifier hs-var">runSomething</span></a><span> </span><a href="#local-6989586621681238032"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-string">&quot;LLVM Compiler&quot;</span><span> </span><a href="#local-6989586621681238034"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681238035"><span class="hs-identifier hs-var">args0</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681238036"><span class="hs-identifier hs-var">args1</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681238033"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-162"></a><span>
</span><a name="line-163"></a><span class="hs-comment">-- | Run the clang compiler (used as an assembler for the LLVM</span><span>
</span><a name="line-164"></a><span class="hs-comment">-- backend on OS X as LLVM doesn't support the OS X system</span><span>
</span><a name="line-165"></a><span class="hs-comment">-- assembler)</span><span>
</span><a name="line-166"></a><span class="hs-identifier">runClang</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Option</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-167"></a><a name="runClang"><a href="SysTools.Tasks.html#runClang"><span class="hs-identifier">runClang</span></a></a><span> </span><a name="local-6989586621681238037"><a href="#local-6989586621681238037"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681238038"><a href="#local-6989586621681238038"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-168"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681238039"><a href="#local-6989586621681238039"><span class="hs-identifier">clang</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pgm_lcc</span><span> </span><a href="#local-6989586621681238037"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-169"></a><span>      </span><span class="hs-comment">-- be careful what options we call clang with</span><span>
</span><a name="line-170"></a><span>      </span><span class="hs-comment">-- see #5903 and #7617 for bugs caused by this.</span><span>
</span><a name="line-171"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621681238040"><a href="#local-6989586621681238040"><span class="hs-identifier">args0</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pgm_a</span><span> </span><a href="#local-6989586621681238037"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-172"></a><span>      </span><a name="local-6989586621681238041"><a href="#local-6989586621681238041"><span class="hs-identifier">args1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOpts</span><span> </span><a href="#local-6989586621681238037"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">opt_a</span><span class="hs-special">)</span><span>
</span><a name="line-173"></a><span>      </span><a name="local-6989586621681238042"><a href="#local-6989586621681238042"><span class="hs-identifier">args2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681238040"><span class="hs-identifier hs-var">args0</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681238041"><span class="hs-identifier hs-var">args1</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681238038"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-174"></a><span>  </span><a name="local-6989586621681238043"><a href="#local-6989586621681238043"><span class="hs-identifier">mb_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SysTools.Process.html#getGccEnv"><span class="hs-identifier hs-var">getGccEnv</span></a><span> </span><a href="#local-6989586621681238042"><span class="hs-identifier hs-var">args2</span></a><span>
</span><a name="line-175"></a><span>  </span><span class="hs-identifier hs-var">Exception.catch</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span>
</span><a name="line-176"></a><span>        </span><a href="SysTools.Process.html#runSomethingFiltered"><span class="hs-identifier hs-var">runSomethingFiltered</span></a><span> </span><a href="#local-6989586621681238037"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-string">&quot;Clang (Assembler)&quot;</span><span> </span><a href="#local-6989586621681238039"><span class="hs-identifier hs-var">clang</span></a><span> </span><a href="#local-6989586621681238042"><span class="hs-identifier hs-var">args2</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621681238043"><span class="hs-identifier hs-var">mb_env</span></a><span>
</span><a name="line-177"></a><span>    </span><span class="hs-special">)</span><span>
</span><a name="line-178"></a><span>    </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621681238044"><a href="#local-6989586621681238044"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-179"></a><span>        </span><span class="hs-identifier hs-var">errorMsg</span><span> </span><a href="#local-6989586621681238037"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-180"></a><span>            </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Error running clang! you need clang installed to use the&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-181"></a><span>                  </span><span class="hs-string">&quot; LLVM backend&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$+$</span><span>
</span><a name="line-182"></a><span>            </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;(or GHC tried to execute clang incorrectly)&quot;</span><span>
</span><a name="line-183"></a><span>        </span><span class="hs-identifier hs-var">throwIO</span><span> </span><a href="#local-6989586621681238044"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-184"></a><span>    </span><span class="hs-special">)</span><span>
</span><a name="line-185"></a><span>
</span><a name="line-186"></a><span class="hs-comment">-- | Figure out which version of LLVM we are running this session</span><span>
</span><a name="line-187"></a><span class="hs-identifier">figureLlvmVersion</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-188"></a><a name="figureLlvmVersion"><a href="SysTools.Tasks.html#figureLlvmVersion"><span class="hs-identifier">figureLlvmVersion</span></a></a><span> </span><a name="local-6989586621681238045"><a href="#local-6989586621681238045"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-189"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681238046"><a href="#local-6989586621681238046"><span class="hs-identifier">pgm</span></a></a><span class="hs-special">,</span><a name="local-6989586621681238047"><a href="#local-6989586621681238047"><span class="hs-identifier">opts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pgm_lc</span><span> </span><a href="#local-6989586621681238045"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-190"></a><span>      </span><a name="local-6989586621681238048"><a href="#local-6989586621681238048"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-identifier hs-var">notNull</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">showOpt</span><span> </span><a href="#local-6989586621681238047"><span class="hs-identifier hs-var">opts</span></a><span class="hs-special">)</span><span>
</span><a name="line-191"></a><span>      </span><span class="hs-comment">-- we grab the args even though they should be useless just in</span><span>
</span><a name="line-192"></a><span>      </span><span class="hs-comment">-- case the user is using a customised 'llc' that requires some</span><span>
</span><a name="line-193"></a><span>      </span><span class="hs-comment">-- of the options they've specified. llc doesn't care what other</span><span>
</span><a name="line-194"></a><span>      </span><span class="hs-comment">-- options are specified when '-version' is used.</span><span>
</span><a name="line-195"></a><span>      </span><a name="local-6989586621681238049"><a href="#local-6989586621681238049"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681238048"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;-version&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-196"></a><span>  </span><a name="local-6989586621681238058"><a href="#local-6989586621681238058"><span class="hs-identifier">ver</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">catchIO</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span>
</span><a name="line-197"></a><span>              </span><span class="hs-special">(</span><a name="local-6989586621681238050"><a href="#local-6989586621681238050"><span class="hs-identifier">pin</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681238051"><a href="#local-6989586621681238051"><span class="hs-identifier">pout</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681238052"><a href="#local-6989586621681238052"><span class="hs-identifier">perr</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">runInteractiveProcess</span><span> </span><a href="#local-6989586621681238046"><span class="hs-identifier hs-var">pgm</span></a><span> </span><a href="#local-6989586621681238049"><span class="hs-identifier hs-var">args'</span></a><span>
</span><a name="line-198"></a><span>                                              </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-199"></a><span>              </span><span class="hs-comment">{- &gt; llc -version
                  LLVM (http://llvm.org/):
                    LLVM version 3.5.2
                    ...
              -}</span><span>
</span><a name="line-204"></a><span>              </span><span class="hs-identifier hs-var">hSetBinaryMode</span><span> </span><a href="#local-6989586621681238051"><span class="hs-identifier hs-var">pout</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-205"></a><span>              </span><span class="hs-identifier">_</span><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">hGetLine</span><span> </span><a href="#local-6989586621681238051"><span class="hs-identifier hs-var">pout</span></a><span>
</span><a name="line-206"></a><span>              </span><a name="local-6989586621681238053"><a href="#local-6989586621681238053"><span class="hs-identifier">vline</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">dropWhile</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">isDigit</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">hGetLine</span><span> </span><a href="#local-6989586621681238051"><span class="hs-identifier hs-var">pout</span></a><span>
</span><a name="line-207"></a><span>              </span><a name="local-6989586621681238056"><a href="#local-6989586621681238056"><span class="hs-identifier">v</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">span</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-char">'.'</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681238053"><span class="hs-identifier hs-var">vline</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-208"></a><span>                        </span><span class="hs-special">(</span><span class="hs-string">&quot;&quot;</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;no digits!&quot;</span><span>
</span><a name="line-209"></a><span>                        </span><span class="hs-special">(</span><a name="local-6989586621681238054"><a href="#local-6989586621681238054"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><a name="local-6989586621681238055"><a href="#local-6989586621681238055"><span class="hs-identifier">y</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">read</span><span> </span><a href="#local-6989586621681238054"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-210"></a><span>                                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">read</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-identifier hs-var">isDigit</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">drop</span><span> </span><span class="hs-number">1</span><span> </span><a href="#local-6989586621681238055"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span>
</span><a name="line-211"></a><span>
</span><a name="line-212"></a><span>              </span><span class="hs-identifier hs-var">hClose</span><span> </span><a href="#local-6989586621681238050"><span class="hs-identifier hs-var">pin</span></a><span>
</span><a name="line-213"></a><span>              </span><span class="hs-identifier hs-var">hClose</span><span> </span><a href="#local-6989586621681238051"><span class="hs-identifier hs-var">pout</span></a><span>
</span><a name="line-214"></a><span>              </span><span class="hs-identifier hs-var">hClose</span><span> </span><a href="#local-6989586621681238052"><span class="hs-identifier hs-var">perr</span></a><span>
</span><a name="line-215"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681238056"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-216"></a><span>            </span><span class="hs-special">)</span><span>
</span><a name="line-217"></a><span>            </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681238057"><a href="#local-6989586621681238057"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-218"></a><span>                </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><a href="#local-6989586621681238045"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">2</span><span>
</span><a name="line-219"></a><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Error (figuring out LLVM version):&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-220"></a><span>                      </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681238057"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-221"></a><span>                </span><span class="hs-identifier hs-var">errorMsg</span><span> </span><a href="#local-6989586621681238045"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">vcat</span><span>
</span><a name="line-222"></a><span>                    </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Warning:&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">9</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-223"></a><span>                          </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Couldn't figure out LLVM version!&quot;</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-224"></a><span>                          </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Make sure you have installed LLVM &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-225"></a><span>                                </span><a href="LlvmCodeGen.Base.html#llvmVersionStr"><span class="hs-identifier hs-var">llvmVersionStr</span></a><span> </span><a href="LlvmCodeGen.Base.html#supportedLlvmVersion"><span class="hs-identifier hs-var">supportedLlvmVersion</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-226"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-227"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681238058"><span class="hs-identifier hs-var">ver</span></a><span>
</span><a name="line-228"></a><span>
</span><a name="line-229"></a><span>
</span><a name="line-230"></a><span class="hs-identifier">runLink</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Option</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-231"></a><a name="runLink"><a href="SysTools.Tasks.html#runLink"><span class="hs-identifier">runLink</span></a></a><span> </span><a name="local-6989586621681238059"><a href="#local-6989586621681238059"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681238060"><a href="#local-6989586621681238060"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-232"></a><span>  </span><span class="hs-comment">-- See Note [Run-time linker info]</span><span>
</span><a name="line-233"></a><span>  </span><a name="local-6989586621681238073"><a href="#local-6989586621681238073"><span class="hs-identifier">linkargs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SysTools.Info.html#neededLinkArgs"><span class="hs-identifier hs-var">neededLinkArgs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><a href="SysTools.Info.html#getLinkerInfo"><span class="hs-identifier hs-var">getLinkerInfo</span></a><span> </span><a href="#local-6989586621681238059"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-234"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681238074"><a href="#local-6989586621681238074"><span class="hs-identifier">p</span></a></a><span class="hs-special">,</span><a name="local-6989586621681238075"><a href="#local-6989586621681238075"><span class="hs-identifier">args0</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pgm_l</span><span> </span><a href="#local-6989586621681238059"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-235"></a><span>      </span><a name="local-6989586621681238076"><a href="#local-6989586621681238076"><span class="hs-identifier">args1</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOpts</span><span> </span><a href="#local-6989586621681238059"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">opt_l</span><span class="hs-special">)</span><span>
</span><a name="line-236"></a><span>      </span><a name="local-6989586621681238077"><a href="#local-6989586621681238077"><span class="hs-identifier">args2</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681238075"><span class="hs-identifier hs-var">args0</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681238073"><span class="hs-identifier hs-var">linkargs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681238076"><span class="hs-identifier hs-var">args1</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681238060"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-237"></a><span>  </span><a name="local-6989586621681238078"><a href="#local-6989586621681238078"><span class="hs-identifier">mb_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SysTools.Process.html#getGccEnv"><span class="hs-identifier hs-var">getGccEnv</span></a><span> </span><a href="#local-6989586621681238077"><span class="hs-identifier hs-var">args2</span></a><span>
</span><a name="line-238"></a><span>  </span><a href="SysTools.Process.html#runSomethingResponseFile"><span class="hs-identifier hs-var">runSomethingResponseFile</span></a><span> </span><a href="#local-6989586621681238059"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681238061"><span class="hs-identifier hs-var">ld_filter</span></a><span> </span><span class="hs-string">&quot;Linker&quot;</span><span> </span><a href="#local-6989586621681238074"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681238077"><span class="hs-identifier hs-var">args2</span></a><span> </span><a href="#local-6989586621681238078"><span class="hs-identifier hs-var">mb_env</span></a><span>
</span><a name="line-239"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-240"></a><span>    </span><a name="local-6989586621681238061"><a href="#local-6989586621681238061"><span class="hs-identifier">ld_filter</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">platformOS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621681238059"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-241"></a><span>                  </span><span class="hs-identifier hs-var">OSSolaris2</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681238062"><span class="hs-identifier hs-var">sunos_ld_filter</span></a><span>
</span><a name="line-242"></a><span>                  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-243"></a><span class="hs-comment">{-
  SunOS/Solaris ld emits harmless warning messages about unresolved
  symbols in case of compiling into shared library when we do not
  link against all the required libs. That is the case of GHC which
  does not link against RTS library explicitly in order to be able to
  choose the library later based on binary application linking
  parameters. The warnings look like:

Undefined                       first referenced
  symbol                             in file
stg_ap_n_fast                       ./T2386_Lib.o
stg_upd_frame_info                  ./T2386_Lib.o
templatezmhaskell_LanguageziHaskellziTHziLib_litE_closure ./T2386_Lib.o
templatezmhaskell_LanguageziHaskellziTHziLib_appE_closure ./T2386_Lib.o
templatezmhaskell_LanguageziHaskellziTHziLib_conE_closure ./T2386_Lib.o
templatezmhaskell_LanguageziHaskellziTHziSyntax_mkNameGzud_closure ./T2386_Lib.o
newCAF                              ./T2386_Lib.o
stg_bh_upd_frame_info               ./T2386_Lib.o
stg_ap_ppp_fast                     ./T2386_Lib.o
templatezmhaskell_LanguageziHaskellziTHziLib_stringL_closure ./T2386_Lib.o
stg_ap_p_fast                       ./T2386_Lib.o
stg_ap_pp_fast                      ./T2386_Lib.o
ld: warning: symbol referencing errors

  this is actually coming from T2386 testcase. The emitting of those
  warnings is also a reason why so many TH testcases fail on Solaris.

  Following filter code is SunOS/Solaris linker specific and should
  filter out only linker warnings. Please note that the logic is a
  little bit more complex due to the simple reason that we need to preserve
  any other linker emitted messages. If there are any. Simply speaking
  if we see &quot;Undefined&quot; and later &quot;ld: warning:...&quot; then we omit all
  text between (including) the marks. Otherwise we copy the whole output.
-}</span><span>
</span><a name="line-277"></a><span>    </span><span class="hs-identifier">sunos_ld_filter</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-278"></a><span>    </span><a name="local-6989586621681238062"><a href="#local-6989586621681238062"><span class="hs-identifier">sunos_ld_filter</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unlines</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621681238063"><span class="hs-identifier hs-var">sunos_ld_filter'</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">lines</span><span>
</span><a name="line-279"></a><span>    </span><a name="local-6989586621681238063"><a href="#local-6989586621681238063"><span class="hs-identifier">sunos_ld_filter'</span></a></a><span> </span><a name="local-6989586621681238070"><a href="#local-6989586621681238070"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681238066"><span class="hs-identifier hs-var">undefined_found</span></a><span> </span><a href="#local-6989586621681238070"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621681238069"><span class="hs-identifier hs-var">ld_warning_found</span></a><span> </span><a href="#local-6989586621681238070"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-280"></a><span>                          </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681238065"><span class="hs-identifier hs-var">ld_prefix</span></a><span> </span><a href="#local-6989586621681238070"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681238068"><span class="hs-identifier hs-var">ld_postfix</span></a><span> </span><a href="#local-6989586621681238070"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-281"></a><span>                          </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621681238070"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-282"></a><span>    </span><a name="local-6989586621681238064"><a href="#local-6989586621681238064"><span class="hs-identifier">breakStartsWith</span></a></a><span> </span><a name="local-6989586621681238071"><a href="#local-6989586621681238071"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621681238072"><a href="#local-6989586621681238072"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">break</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isPrefixOf</span><span> </span><a href="#local-6989586621681238071"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681238072"><span class="hs-identifier hs-var">y</span></a><span>
</span><a name="line-283"></a><span>    </span><a name="local-6989586621681238065"><a href="#local-6989586621681238065"><span class="hs-identifier">ld_prefix</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621681238064"><span class="hs-identifier hs-var">breakStartsWith</span></a><span> </span><span class="hs-string">&quot;Undefined&quot;</span><span>
</span><a name="line-284"></a><span>    </span><a name="local-6989586621681238066"><a href="#local-6989586621681238066"><span class="hs-identifier">undefined_found</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621681238064"><span class="hs-identifier hs-var">breakStartsWith</span></a><span> </span><span class="hs-string">&quot;Undefined&quot;</span><span>
</span><a name="line-285"></a><span>    </span><a name="local-6989586621681238067"><a href="#local-6989586621681238067"><span class="hs-identifier">ld_warn_break</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681238064"><span class="hs-identifier hs-var">breakStartsWith</span></a><span> </span><span class="hs-string">&quot;ld: warning: symbol referencing errors&quot;</span><span>
</span><a name="line-286"></a><span>    </span><a name="local-6989586621681238068"><a href="#local-6989586621681238068"><span class="hs-identifier">ld_postfix</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tail</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621681238067"><span class="hs-identifier hs-var">ld_warn_break</span></a><span>
</span><a name="line-287"></a><span>    </span><a name="local-6989586621681238069"><a href="#local-6989586621681238069"><span class="hs-identifier">ld_warning_found</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621681238067"><span class="hs-identifier hs-var">ld_warn_break</span></a><span>
</span><a name="line-288"></a><span>
</span><a name="line-289"></a><span>
</span><a name="line-290"></a><span class="hs-identifier">runLibtool</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Option</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-291"></a><a name="runLibtool"><a href="SysTools.Tasks.html#runLibtool"><span class="hs-identifier">runLibtool</span></a></a><span> </span><a name="local-6989586621681238079"><a href="#local-6989586621681238079"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681238080"><a href="#local-6989586621681238080"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-292"></a><span>  </span><a name="local-6989586621681238081"><a href="#local-6989586621681238081"><span class="hs-identifier">linkargs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SysTools.Info.html#neededLinkArgs"><span class="hs-identifier hs-var">neededLinkArgs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><a href="SysTools.Info.html#getLinkerInfo"><span class="hs-identifier hs-var">getLinkerInfo</span></a><span> </span><a href="#local-6989586621681238079"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-293"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681238082"><a href="#local-6989586621681238082"><span class="hs-identifier">args1</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOpts</span><span> </span><a href="#local-6989586621681238079"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">opt_l</span><span class="hs-special">)</span><span>
</span><a name="line-294"></a><span>      </span><a name="local-6989586621681238083"><a href="#local-6989586621681238083"><span class="hs-identifier">args2</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-string">&quot;-static&quot;</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681238082"><span class="hs-identifier hs-var">args1</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681238080"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681238081"><span class="hs-identifier hs-var">linkargs</span></a><span>
</span><a name="line-295"></a><span>      </span><a name="local-6989586621681238084"><a href="#local-6989586621681238084"><span class="hs-identifier">libtool</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pgm_libtool</span><span> </span><a href="#local-6989586621681238079"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-296"></a><span>  </span><a name="local-6989586621681238085"><a href="#local-6989586621681238085"><span class="hs-identifier">mb_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SysTools.Process.html#getGccEnv"><span class="hs-identifier hs-var">getGccEnv</span></a><span> </span><a href="#local-6989586621681238083"><span class="hs-identifier hs-var">args2</span></a><span>
</span><a name="line-297"></a><span>  </span><a href="SysTools.Process.html#runSomethingFiltered"><span class="hs-identifier hs-var">runSomethingFiltered</span></a><span> </span><a href="#local-6989586621681238079"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-string">&quot;Linker&quot;</span><span> </span><a href="#local-6989586621681238084"><span class="hs-identifier hs-var">libtool</span></a><span> </span><a href="#local-6989586621681238083"><span class="hs-identifier hs-var">args2</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621681238085"><span class="hs-identifier hs-var">mb_env</span></a><span>
</span><a name="line-298"></a><span>
</span><a name="line-299"></a><span class="hs-identifier">runAr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Option</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-300"></a><a name="runAr"><a href="SysTools.Tasks.html#runAr"><span class="hs-identifier">runAr</span></a></a><span> </span><a name="local-6989586621681238086"><a href="#local-6989586621681238086"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681238087"><a href="#local-6989586621681238087"><span class="hs-identifier">cwd</span></a></a><span> </span><a name="local-6989586621681238088"><a href="#local-6989586621681238088"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-301"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681238089"><a href="#local-6989586621681238089"><span class="hs-identifier">ar</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pgm_ar</span><span> </span><a href="#local-6989586621681238086"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-302"></a><span>  </span><a href="SysTools.Process.html#runSomethingFiltered"><span class="hs-identifier hs-var">runSomethingFiltered</span></a><span> </span><a href="#local-6989586621681238086"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-string">&quot;Ar&quot;</span><span> </span><a href="#local-6989586621681238089"><span class="hs-identifier hs-var">ar</span></a><span> </span><a href="#local-6989586621681238088"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621681238087"><span class="hs-identifier hs-var">cwd</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-303"></a><span>
</span><a name="line-304"></a><span class="hs-identifier">askAr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Option</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-305"></a><a name="askAr"><a href="SysTools.Tasks.html#askAr"><span class="hs-identifier">askAr</span></a></a><span> </span><a name="local-6989586621681238090"><a href="#local-6989586621681238090"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681238091"><a href="#local-6989586621681238091"><span class="hs-identifier">mb_cwd</span></a></a><span> </span><a name="local-6989586621681238092"><a href="#local-6989586621681238092"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-306"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681238093"><a href="#local-6989586621681238093"><span class="hs-identifier">ar</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pgm_ar</span><span> </span><a href="#local-6989586621681238090"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-307"></a><span>  </span><a href="SysTools.Process.html#runSomethingWith"><span class="hs-identifier hs-var">runSomethingWith</span></a><span> </span><a href="#local-6989586621681238090"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-string">&quot;Ar&quot;</span><span> </span><a href="#local-6989586621681238093"><span class="hs-identifier hs-var">ar</span></a><span> </span><a href="#local-6989586621681238092"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681238094"><a href="#local-6989586621681238094"><span class="hs-identifier">real_args</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-308"></a><span>    </span><a href="SysTools.Process.html#readCreateProcessWithExitCode%27"><span class="hs-identifier hs-var">readCreateProcessWithExitCode'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">proc</span><span> </span><a href="#local-6989586621681238093"><span class="hs-identifier hs-var">ar</span></a><span> </span><a href="#local-6989586621681238094"><span class="hs-identifier hs-var">real_args</span></a><span class="hs-special">)</span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cwd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681238091"><span class="hs-identifier hs-var">mb_cwd</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-309"></a><span>
</span><a name="line-310"></a><span class="hs-identifier">runRanlib</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Option</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-311"></a><a name="runRanlib"><a href="SysTools.Tasks.html#runRanlib"><span class="hs-identifier">runRanlib</span></a></a><span> </span><a name="local-6989586621681238095"><a href="#local-6989586621681238095"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681238096"><a href="#local-6989586621681238096"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-312"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681238097"><a href="#local-6989586621681238097"><span class="hs-identifier">ranlib</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pgm_ranlib</span><span> </span><a href="#local-6989586621681238095"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-313"></a><span>  </span><a href="SysTools.Process.html#runSomethingFiltered"><span class="hs-identifier hs-var">runSomethingFiltered</span></a><span> </span><a href="#local-6989586621681238095"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-string">&quot;Ranlib&quot;</span><span> </span><a href="#local-6989586621681238097"><span class="hs-identifier hs-var">ranlib</span></a><span> </span><a href="#local-6989586621681238096"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-314"></a><span>
</span><a name="line-315"></a><span class="hs-identifier">runMkDLL</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Option</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-316"></a><a name="runMkDLL"><a href="SysTools.Tasks.html#runMkDLL"><span class="hs-identifier">runMkDLL</span></a></a><span> </span><a name="local-6989586621681238098"><a href="#local-6989586621681238098"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681238099"><a href="#local-6989586621681238099"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-317"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681238100"><a href="#local-6989586621681238100"><span class="hs-identifier">p</span></a></a><span class="hs-special">,</span><a name="local-6989586621681238101"><a href="#local-6989586621681238101"><span class="hs-identifier">args0</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pgm_dll</span><span> </span><a href="#local-6989586621681238098"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-318"></a><span>      </span><a name="local-6989586621681238102"><a href="#local-6989586621681238102"><span class="hs-identifier">args1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681238101"><span class="hs-identifier hs-var">args0</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681238099"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-319"></a><span>  </span><a name="local-6989586621681238103"><a href="#local-6989586621681238103"><span class="hs-identifier">mb_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SysTools.Process.html#getGccEnv"><span class="hs-identifier hs-var">getGccEnv</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681238101"><span class="hs-identifier hs-var">args0</span></a><span class="hs-operator hs-var">++</span><a href="#local-6989586621681238099"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-320"></a><span>  </span><a href="SysTools.Process.html#runSomethingFiltered"><span class="hs-identifier hs-var">runSomethingFiltered</span></a><span> </span><a href="#local-6989586621681238098"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-string">&quot;Make DLL&quot;</span><span> </span><a href="#local-6989586621681238100"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621681238102"><span class="hs-identifier hs-var">args1</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621681238103"><span class="hs-identifier hs-var">mb_env</span></a><span>
</span><a name="line-321"></a><span>
</span><a name="line-322"></a><span class="hs-identifier">runWindres</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Option</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-323"></a><a name="runWindres"><a href="SysTools.Tasks.html#runWindres"><span class="hs-identifier">runWindres</span></a></a><span> </span><a name="local-6989586621681238104"><a href="#local-6989586621681238104"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681238105"><a href="#local-6989586621681238105"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-324"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681238106"><a href="#local-6989586621681238106"><span class="hs-identifier">gcc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681238107"><a href="#local-6989586621681238107"><span class="hs-identifier">gcc_args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pgm_c</span><span> </span><a href="#local-6989586621681238104"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-325"></a><span>      </span><a name="local-6989586621681238108"><a href="#local-6989586621681238108"><span class="hs-identifier">windres</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pgm_windres</span><span> </span><a href="#local-6989586621681238104"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-326"></a><span>      </span><a name="local-6989586621681238109"><a href="#local-6989586621681238109"><span class="hs-identifier">opts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOpts</span><span> </span><a href="#local-6989586621681238104"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">opt_windres</span><span class="hs-special">)</span><span>
</span><a name="line-327"></a><span>      </span><a name="local-6989586621681238110"><a href="#local-6989586621681238110"><span class="hs-identifier">quote</span></a></a><span> </span><a name="local-6989586621681238112"><a href="#local-6989586621681238112"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;\&quot;&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681238112"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;\&quot;&quot;</span><span>
</span><a name="line-328"></a><span>      </span><a name="local-6989586621681238111"><a href="#local-6989586621681238111"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- If windres.exe and gcc.exe are in a directory containing</span><span>
</span><a name="line-329"></a><span>              </span><span class="hs-comment">-- spaces then windres fails to run gcc. We therefore need</span><span>
</span><a name="line-330"></a><span>              </span><span class="hs-comment">-- to tell it what command to use...</span><span>
</span><a name="line-331"></a><span>              </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;--preprocessor=&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-332"></a><span>                      </span><span class="hs-identifier hs-var">unwords</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621681238110"><span class="hs-identifier hs-var">quote</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681238106"><span class="hs-identifier hs-var">gcc</span></a><span> </span><span class="hs-glyph">:</span><span>
</span><a name="line-333"></a><span>                                          </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">showOpt</span><span> </span><a href="#local-6989586621681238107"><span class="hs-identifier hs-var">gcc_args</span></a><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-334"></a><span>                                          </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">showOpt</span><span> </span><a href="#local-6989586621681238109"><span class="hs-identifier hs-var">opts</span></a><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-335"></a><span>                                          </span><span class="hs-special">[</span><span class="hs-string">&quot;-E&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;-xc&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;-DRC_INVOKED&quot;</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-336"></a><span>              </span><span class="hs-comment">-- ...but if we do that then if windres calls popen then</span><span>
</span><a name="line-337"></a><span>              </span><span class="hs-comment">-- it can't understand the quoting, so we have to use</span><span>
</span><a name="line-338"></a><span>              </span><span class="hs-comment">-- --use-temp-file so that it interprets it correctly.</span><span>
</span><a name="line-339"></a><span>              </span><span class="hs-comment">-- See #1828.</span><span>
</span><a name="line-340"></a><span>            </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-string">&quot;--use-temp-file&quot;</span><span>
</span><a name="line-341"></a><span>            </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621681238105"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-342"></a><span>  </span><a name="local-6989586621681238113"><a href="#local-6989586621681238113"><span class="hs-identifier">mb_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SysTools.Process.html#getGccEnv"><span class="hs-identifier hs-var">getGccEnv</span></a><span> </span><a href="#local-6989586621681238107"><span class="hs-identifier hs-var">gcc_args</span></a><span>
</span><a name="line-343"></a><span>  </span><a href="SysTools.Process.html#runSomethingFiltered"><span class="hs-identifier hs-var">runSomethingFiltered</span></a><span> </span><a href="#local-6989586621681238104"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-string">&quot;Windres&quot;</span><span> </span><a href="#local-6989586621681238108"><span class="hs-identifier hs-var">windres</span></a><span> </span><a href="#local-6989586621681238111"><span class="hs-identifier hs-var">args'</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621681238113"><span class="hs-identifier hs-var">mb_env</span></a><span>
</span><a name="line-344"></a><span>
</span><a name="line-345"></a><span class="hs-identifier">touch</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-346"></a><a name="touch"><a href="SysTools.Tasks.html#touch"><span class="hs-identifier">touch</span></a></a><span> </span><a name="local-6989586621681238114"><a href="#local-6989586621681238114"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681238115"><a href="#local-6989586621681238115"><span class="hs-identifier">purpose</span></a></a><span> </span><a name="local-6989586621681238116"><a href="#local-6989586621681238116"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-347"></a><span>  </span><a href="SysTools.Process.html#runSomething"><span class="hs-identifier hs-var">runSomething</span></a><span> </span><a href="#local-6989586621681238114"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681238115"><span class="hs-identifier hs-var">purpose</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pgm_T</span><span> </span><a href="#local-6989586621681238114"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621681238116"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">]</span><span>
</span><a name="line-348"></a></pre></body></html>