<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1999


Analysis functions over data types.  Specifically, detecting recursive types.

This stuff is only used for source-code decls; it's recorded in interface
files for imported data types.
-}</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-13"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-14"></a><span class="hs-pragma">{-# LANGUAGE ViewPatterns #-}</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">TcTyDecls</span><span class="hs-special">(</span><span>
</span><a name="line-17"></a><span>        </span><a href="TcTyDecls.html#RolesInfo"><span class="hs-identifier hs-type">RolesInfo</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>        </span><a href="TcTyDecls.html#inferRoles"><span class="hs-identifier hs-var">inferRoles</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>        </span><a href="TcTyDecls.html#checkSynCycles"><span class="hs-identifier hs-var">checkSynCycles</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>        </span><a href="TcTyDecls.html#checkClassCycles"><span class="hs-identifier hs-var">checkClassCycles</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span>        </span><span class="hs-comment">-- * Implicits</span><span>
</span><a name="line-23"></a><span>        </span><a href="TcTyDecls.html#addTyConsToGblEnv"><span class="hs-identifier hs-var">addTyConsToGblEnv</span></a><span class="hs-special">,</span><span> </span><a href="TcTyDecls.html#mkDefaultMethodType"><span class="hs-identifier hs-var">mkDefaultMethodType</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span>        </span><span class="hs-comment">-- * Record selectors</span><span>
</span><a name="line-26"></a><span>        </span><a href="TcTyDecls.html#tcRecSelBinds"><span class="hs-identifier hs-var">tcRecSelBinds</span></a><span class="hs-special">,</span><span> </span><a href="TcTyDecls.html#mkRecSelBinds"><span class="hs-identifier hs-var">mkRecSelBinds</span></a><span class="hs-special">,</span><span> </span><a href="TcTyDecls.html#mkOneRecordSelector"><span class="hs-identifier hs-var">mkOneRecordSelector</span></a><span>
</span><a name="line-27"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="TcEnv.html"><span class="hs-identifier">TcEnv</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="TcBinds.html"><span class="hs-identifier">TcBinds</span></a><span class="hs-special">(</span><span> </span><a href="TcBinds.html#tcValBinds"><span class="hs-identifier hs-var">tcValBinds</span></a><span class="hs-special">,</span><span> </span><a href="TcBinds.html#addTypecheckedBinds"><span class="hs-identifier hs-var">addTypecheckedBinds</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCoRep</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Coercion</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MCoercion</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">UnivCoProvenance</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysWiredIn</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">unitTy</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MkCore</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">rEC_SEL_ERROR_ID</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Class</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ConLike</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameEnv</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameSet</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitFV</span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RdrName</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkVarUnqual</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">IdInfo</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarEnv</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarSet</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Coercion</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">ltRole</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Unique</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkBuiltinUnique</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Bag</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FV</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-66"></a><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Cycles in type synonym declarations
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span class="hs-identifier">synonymTyConsOfType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyCon</span><span class="hs-special">]</span><span>
</span><a name="line-78"></a><span class="hs-comment">-- Does not look through type synonyms at all</span><span>
</span><a name="line-79"></a><span class="hs-comment">-- Return a list of synonym tycons</span><span>
</span><a name="line-80"></a><span class="hs-comment">-- Keep this synchronized with 'expandTypeSynonyms'</span><span>
</span><a name="line-81"></a><a name="synonymTyConsOfType"><a href="TcTyDecls.html#synonymTyConsOfType"><span class="hs-identifier">synonymTyConsOfType</span></a></a><span> </span><a name="local-6989586621683454086"><a href="#local-6989586621683454086"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-82"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameEnvElts</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454087"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683454086"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-83"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-84"></a><span>     </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NameEnv</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span>  </span><span class="hs-comment">-- The NameEnv does duplicate elim</span><span>
</span><a name="line-85"></a><span>     </span><a name="local-6989586621683454087"><a href="#local-6989586621683454087"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyConApp</span><span> </span><a name="local-6989586621683454094"><a href="#local-6989586621683454094"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621683454095"><a href="#local-6989586621683454095"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454091"><span class="hs-identifier hs-var">go_tc</span></a><span> </span><a href="#local-6989586621683454094"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusNameEnv</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683454092"><span class="hs-identifier hs-var">go_s</span></a><span> </span><a href="#local-6989586621683454095"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-86"></a><span>     </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitTy</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyNameEnv</span><span>
</span><a name="line-87"></a><span>     </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyVarTy</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyNameEnv</span><span>
</span><a name="line-88"></a><span>     </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AppTy</span><span> </span><a name="local-6989586621683454096"><a href="#local-6989586621683454096"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621683454097"><a href="#local-6989586621683454097"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span>               </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454087"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683454096"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusNameEnv</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683454087"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683454097"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-89"></a><span>     </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunTy</span><span> </span><a name="local-6989586621683454098"><a href="#local-6989586621683454098"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621683454099"><a href="#local-6989586621683454099"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span>               </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454087"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683454098"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusNameEnv</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683454087"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683454099"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-90"></a><span>     </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ForAllTy</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683454100"><a href="#local-6989586621683454100"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454087"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683454100"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-91"></a><span>     </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CastTy</span><span> </span><a name="local-6989586621683454101"><a href="#local-6989586621683454101"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683454102"><a href="#local-6989586621683454102"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454087"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683454101"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusNameEnv</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683454089"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621683454102"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-92"></a><span>     </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoercionTy</span><span> </span><a name="local-6989586621683454103"><a href="#local-6989586621683454103"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454089"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621683454103"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span>     </span><span class="hs-comment">-- Note [TyCon cycles through coercions?!]</span><span>
</span><a name="line-95"></a><span>     </span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-96"></a><span>     </span><span class="hs-comment">-- Although, in principle, it's possible for a type synonym loop</span><span>
</span><a name="line-97"></a><span>     </span><span class="hs-comment">-- could go through a coercion (since a coercion can refer to</span><span>
</span><a name="line-98"></a><span>     </span><span class="hs-comment">-- a TyCon or Type), it doesn't seem possible to actually construct</span><span>
</span><a name="line-99"></a><span>     </span><span class="hs-comment">-- a Haskell program which tickles this case.  Here is an example</span><span>
</span><a name="line-100"></a><span>     </span><span class="hs-comment">-- program which causes a coercion:</span><span>
</span><a name="line-101"></a><span>     </span><span class="hs-comment">--</span><span>
</span><a name="line-102"></a><span>     </span><span class="hs-comment">--   type family Star where</span><span>
</span><a name="line-103"></a><span>     </span><span class="hs-comment">--       Star = Type</span><span>
</span><a name="line-104"></a><span>     </span><span class="hs-comment">--</span><span>
</span><a name="line-105"></a><span>     </span><span class="hs-comment">--   data T :: Star -&gt; Type</span><span>
</span><a name="line-106"></a><span>     </span><span class="hs-comment">--   data S :: forall (a :: Type). T a -&gt; Type</span><span>
</span><a name="line-107"></a><span>     </span><span class="hs-comment">--</span><span>
</span><a name="line-108"></a><span>     </span><span class="hs-comment">-- Here, the application 'T a' must first coerce a :: Type to a :: Star,</span><span>
</span><a name="line-109"></a><span>     </span><span class="hs-comment">-- witnessed by the type family.  But if we now try to make Type refer</span><span>
</span><a name="line-110"></a><span>     </span><span class="hs-comment">-- to a type synonym which in turn refers to Star, we'll run into</span><span>
</span><a name="line-111"></a><span>     </span><span class="hs-comment">-- trouble: we're trying to define and use the type constructor</span><span>
</span><a name="line-112"></a><span>     </span><span class="hs-comment">-- in the same recursive group.  Possibly this restriction will be</span><span>
</span><a name="line-113"></a><span>     </span><span class="hs-comment">-- lifted in the future but for now, this code is &quot;just for completeness</span><span>
</span><a name="line-114"></a><span>     </span><span class="hs-comment">-- sake&quot;.</span><span>
</span><a name="line-115"></a><span>     </span><a name="local-6989586621683454088"><a href="#local-6989586621683454088"><span class="hs-identifier">go_mco</span></a></a><span> </span><span class="hs-identifier hs-var">MRefl</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyNameEnv</span><span>
</span><a name="line-116"></a><span>     </span><span class="hs-identifier">go_mco</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">MCo</span><span> </span><a name="local-6989586621683454104"><a href="#local-6989586621683454104"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454089"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621683454104"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-117"></a><span>
</span><a name="line-118"></a><span>     </span><a name="local-6989586621683454089"><a href="#local-6989586621683454089"><span class="hs-identifier">go_co</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Refl</span><span> </span><a name="local-6989586621683454105"><a href="#local-6989586621683454105"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454087"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683454105"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-119"></a><span>     </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GRefl</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683454106"><a href="#local-6989586621683454106"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683454107"><a href="#local-6989586621683454107"><span class="hs-identifier">mco</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454087"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683454106"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusNameEnv</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683454088"><span class="hs-identifier hs-var">go_mco</span></a><span> </span><a href="#local-6989586621683454107"><span class="hs-identifier hs-var">mco</span></a><span>
</span><a name="line-120"></a><span>     </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyConAppCo</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683454108"><a href="#local-6989586621683454108"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621683454109"><a href="#local-6989586621683454109"><span class="hs-identifier">cs</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454091"><span class="hs-identifier hs-var">go_tc</span></a><span> </span><a href="#local-6989586621683454108"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusNameEnv</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683454093"><span class="hs-identifier hs-var">go_co_s</span></a><span> </span><a href="#local-6989586621683454109"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-121"></a><span>     </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AppCo</span><span> </span><a name="local-6989586621683454110"><a href="#local-6989586621683454110"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621683454111"><a href="#local-6989586621683454111"><span class="hs-identifier">co'</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454089"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621683454110"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusNameEnv</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683454089"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621683454111"><span class="hs-identifier hs-var">co'</span></a><span>
</span><a name="line-122"></a><span>     </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ForAllCo</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683454112"><a href="#local-6989586621683454112"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621683454113"><a href="#local-6989586621683454113"><span class="hs-identifier">co'</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454089"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621683454112"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusNameEnv</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683454089"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621683454113"><span class="hs-identifier hs-var">co'</span></a><span>
</span><a name="line-123"></a><span>     </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunCo</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683454114"><a href="#local-6989586621683454114"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621683454115"><a href="#local-6989586621683454115"><span class="hs-identifier">co'</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454089"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621683454114"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusNameEnv</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683454089"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621683454115"><span class="hs-identifier hs-var">co'</span></a><span>
</span><a name="line-124"></a><span>     </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoVarCo</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyNameEnv</span><span>
</span><a name="line-125"></a><span>     </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HoleCo</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyNameEnv</span><span>
</span><a name="line-126"></a><span>     </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AxiomInstCo</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683454116"><a href="#local-6989586621683454116"><span class="hs-identifier">cs</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454093"><span class="hs-identifier hs-var">go_co_s</span></a><span> </span><a href="#local-6989586621683454116"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-127"></a><span>     </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">UnivCo</span><span> </span><a name="local-6989586621683454117"><a href="#local-6989586621683454117"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683454118"><a href="#local-6989586621683454118"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683454119"><a href="#local-6989586621683454119"><span class="hs-identifier">ty'</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454090"><span class="hs-identifier hs-var">go_prov</span></a><span> </span><a href="#local-6989586621683454117"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusNameEnv</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683454087"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683454118"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusNameEnv</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683454087"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683454119"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-128"></a><span>     </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SymCo</span><span> </span><a name="local-6989586621683454120"><a href="#local-6989586621683454120"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454089"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621683454120"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-129"></a><span>     </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TransCo</span><span> </span><a name="local-6989586621683454121"><a href="#local-6989586621683454121"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621683454122"><a href="#local-6989586621683454122"><span class="hs-identifier">co'</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454089"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621683454121"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusNameEnv</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683454089"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621683454122"><span class="hs-identifier hs-var">co'</span></a><span>
</span><a name="line-130"></a><span>     </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NthCo</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683454123"><a href="#local-6989586621683454123"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454089"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621683454123"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-131"></a><span>     </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LRCo</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683454124"><a href="#local-6989586621683454124"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454089"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621683454124"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-132"></a><span>     </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">InstCo</span><span> </span><a name="local-6989586621683454125"><a href="#local-6989586621683454125"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621683454126"><a href="#local-6989586621683454126"><span class="hs-identifier">co'</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454089"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621683454125"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusNameEnv</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683454089"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621683454126"><span class="hs-identifier hs-var">co'</span></a><span>
</span><a name="line-133"></a><span>     </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">KindCo</span><span> </span><a name="local-6989586621683454127"><a href="#local-6989586621683454127"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454089"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621683454127"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-134"></a><span>     </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SubCo</span><span> </span><a name="local-6989586621683454128"><a href="#local-6989586621683454128"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454089"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621683454128"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-135"></a><span>     </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AxiomRuleCo</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683454129"><a href="#local-6989586621683454129"><span class="hs-identifier">cs</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454093"><span class="hs-identifier hs-var">go_co_s</span></a><span> </span><a href="#local-6989586621683454129"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-136"></a><span>
</span><a name="line-137"></a><span>     </span><a name="local-6989586621683454090"><a href="#local-6989586621683454090"><span class="hs-identifier">go_prov</span></a></a><span> </span><span class="hs-identifier hs-var">UnsafeCoerceProv</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyNameEnv</span><span>
</span><a name="line-138"></a><span>     </span><span class="hs-identifier">go_prov</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PhantomProv</span><span> </span><a name="local-6989586621683454130"><a href="#local-6989586621683454130"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454089"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621683454130"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-139"></a><span>     </span><span class="hs-identifier">go_prov</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ProofIrrelProv</span><span> </span><a name="local-6989586621683454131"><a href="#local-6989586621683454131"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454089"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621683454131"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-140"></a><span>     </span><span class="hs-identifier">go_prov</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PluginProv</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyNameEnv</span><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span>     </span><a name="local-6989586621683454091"><a href="#local-6989586621683454091"><span class="hs-identifier">go_tc</span></a></a><span> </span><a name="local-6989586621683454132"><a href="#local-6989586621683454132"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTypeSynonymTyCon</span><span> </span><a href="#local-6989586621683454132"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unitNameEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621683454132"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683454132"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-143"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyNameEnv</span><span>
</span><a name="line-144"></a><span>     </span><a name="local-6989586621683454092"><a href="#local-6989586621683454092"><span class="hs-identifier">go_s</span></a></a><span> </span><a name="local-6989586621683454133"><a href="#local-6989586621683454133"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">plusNameEnv</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621683454087"><span class="hs-identifier hs-var">go</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">emptyNameEnv</span><span> </span><a href="#local-6989586621683454133"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-145"></a><span>     </span><a name="local-6989586621683454093"><a href="#local-6989586621683454093"><span class="hs-identifier">go_co_s</span></a></a><span> </span><a name="local-6989586621683454134"><a href="#local-6989586621683454134"><span class="hs-identifier">cos</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">plusNameEnv</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621683454089"><span class="hs-identifier hs-var">go_co</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">emptyNameEnv</span><span> </span><a href="#local-6989586621683454134"><span class="hs-identifier hs-var">cos</span></a><span>
</span><a name="line-146"></a><span>
</span><a name="line-147"></a><span class="hs-comment">-- | A monad for type synonym cycle checking, which keeps</span><span>
</span><a name="line-148"></a><span class="hs-comment">-- track of the TyCons which are known to be acyclic, or</span><span>
</span><a name="line-149"></a><span class="hs-comment">-- a failure message reporting that a cycle was found.</span><span>
</span><a name="line-150"></a><span class="hs-keyword">newtype</span><span> </span><a name="SynCycleM"><a href="TcTyDecls.html#SynCycleM"><span class="hs-identifier">SynCycleM</span></a></a><span> </span><a name="local-6989586621683454062"><a href="#local-6989586621683454062"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="SynCycleM"><a href="TcTyDecls.html#SynCycleM"><span class="hs-identifier">SynCycleM</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-151"></a><span>    </span><a name="runSynCycleM"><a href="TcTyDecls.html#runSynCycleM"><span class="hs-identifier">runSynCycleM</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcTyDecls.html#SynCycleState"><span class="hs-identifier hs-type">SynCycleState</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SrcSpan</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454062"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="TcTyDecls.html#SynCycleState"><span class="hs-identifier hs-type">SynCycleState</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span class="hs-keyword">type</span><span> </span><a name="SynCycleState"><a href="TcTyDecls.html#SynCycleState"><span class="hs-identifier">SynCycleState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span>
</span><a name="line-154"></a><span>
</span><a name="line-155"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="TcTyDecls.html#SynCycleM"><span class="hs-identifier hs-type">SynCycleM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-156"></a><span>    </span><a name="local-3458764513820541101"><span class="hs-identifier">fmap</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftM</span><span>
</span><a name="line-157"></a><span>
</span><a name="line-158"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span> </span><a href="TcTyDecls.html#SynCycleM"><span class="hs-identifier hs-type">SynCycleM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-159"></a><span>    </span><a name="local-3458764513820541680"><span class="hs-identifier">pure</span></a><span> </span><a name="local-6989586621683454079"><a href="#local-6989586621683454079"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcTyDecls.html#SynCycleM"><span class="hs-identifier hs-var">SynCycleM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683454080"><a href="#local-6989586621683454080"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454079"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683454080"><span class="hs-identifier hs-var">state</span></a><span class="hs-special">)</span><span>
</span><a name="line-160"></a><span>    </span><span class="hs-special">(</span><a name="local-3458764513820541679"><span class="hs-operator">&lt;*&gt;</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ap</span><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="TcTyDecls.html#SynCycleM"><span class="hs-identifier hs-type">SynCycleM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-163"></a><span>    </span><a name="local-6989586621683454073"><a href="#local-6989586621683454073"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-3458764513820541099"><span class="hs-operator">&gt;&gt;=</span></a><span> </span><a name="local-6989586621683454074"><a href="#local-6989586621683454074"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcTyDecls.html#SynCycleM"><span class="hs-identifier hs-var">SynCycleM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683454075"><a href="#local-6989586621683454075"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-164"></a><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">runSynCycleM</span><span> </span><a href="#local-6989586621683454073"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621683454075"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-165"></a><span>            </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683454076"><a href="#local-6989586621683454076"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683454077"><a href="#local-6989586621683454077"><span class="hs-identifier">state'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-166"></a><span>                </span><span class="hs-identifier">runSynCycleM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454074"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621683454076"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683454077"><span class="hs-identifier hs-var">state'</span></a><span>
</span><a name="line-167"></a><span>            </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621683454078"><a href="#local-6989586621683454078"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621683454078"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-168"></a><span>
</span><a name="line-169"></a><span class="hs-identifier">failSynCycleM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#SynCycleM"><span class="hs-identifier hs-type">SynCycleM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-170"></a><a name="failSynCycleM"><a href="TcTyDecls.html#failSynCycleM"><span class="hs-identifier">failSynCycleM</span></a></a><span> </span><a name="local-6989586621683454135"><a href="#local-6989586621683454135"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621683454136"><a href="#local-6989586621683454136"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcTyDecls.html#SynCycleM"><span class="hs-identifier hs-var">SynCycleM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454135"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683454136"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-171"></a><span>
</span><a name="line-172"></a><span class="hs-comment">-- | Test if a 'Name' is acyclic, short-circuiting if we've</span><span>
</span><a name="line-173"></a><span class="hs-comment">-- seen it already.</span><span>
</span><a name="line-174"></a><span class="hs-identifier">checkNameIsAcyclic</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#SynCycleM"><span class="hs-identifier hs-type">SynCycleM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#SynCycleM"><span class="hs-identifier hs-type">SynCycleM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-175"></a><a name="checkNameIsAcyclic"><a href="TcTyDecls.html#checkNameIsAcyclic"><span class="hs-identifier">checkNameIsAcyclic</span></a></a><span> </span><a name="local-6989586621683454137"><a href="#local-6989586621683454137"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621683454138"><a href="#local-6989586621683454138"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcTyDecls.html#SynCycleM"><span class="hs-identifier hs-var">SynCycleM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683454139"><a href="#local-6989586621683454139"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-176"></a><span>    </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683454137"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683454139"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-177"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683454139"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- short circuit</span><span>
</span><a name="line-178"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">runSynCycleM</span><span> </span><a href="#local-6989586621683454138"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621683454139"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-179"></a><span>                </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683454140"><a href="#local-6989586621683454140"><span class="hs-identifier">s'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">extendNameSet</span><span> </span><a href="#local-6989586621683454140"><span class="hs-identifier hs-var">s'</span></a><span> </span><a href="#local-6989586621683454137"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-180"></a><span>                </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621683454141"><a href="#local-6989586621683454141"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621683454141"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-181"></a><span>
</span><a name="line-182"></a><span class="hs-comment">-- | Checks if any of the passed in 'TyCon's have cycles.</span><span>
</span><a name="line-183"></a><span class="hs-comment">-- Takes the 'UnitId' of the home package (as we can avoid</span><span>
</span><a name="line-184"></a><span class="hs-comment">-- checking those TyCons: cycles never go through foreign packages) and</span><span>
</span><a name="line-185"></a><span class="hs-comment">-- the corresponding @LTyClDecl Name@ for each 'TyCon', so we</span><span>
</span><a name="line-186"></a><span class="hs-comment">-- can give better error messages.</span><span>
</span><a name="line-187"></a><span class="hs-identifier">checkSynCycles</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UnitId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyCon</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LTyClDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-188"></a><a name="checkSynCycles"><a href="TcTyDecls.html#checkSynCycles"><span class="hs-identifier">checkSynCycles</span></a></a><span> </span><a name="local-6989586621683454142"><a href="#local-6989586621683454142"><span class="hs-identifier">this_uid</span></a></a><span> </span><a name="local-6989586621683454143"><a href="#local-6989586621683454143"><span class="hs-identifier">tcs</span></a></a><span> </span><a name="local-6989586621683454144"><a href="#local-6989586621683454144"><span class="hs-identifier">tyclds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-189"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">runSynCycleM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454146"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683454143"><span class="hs-identifier hs-var">tcs</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-190"></a><span>        </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683454166"><a href="#local-6989586621683454166"><span class="hs-identifier">loc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683454167"><a href="#local-6989586621683454167"><span class="hs-identifier">err</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683454166"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><a href="#local-6989586621683454167"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-191"></a><span>        </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-192"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-193"></a><span>    </span><span class="hs-comment">-- Try our best to print the LTyClDecl for locally defined things</span><span>
</span><a name="line-194"></a><span>    </span><a name="local-6989586621683454145"><a href="#local-6989586621683454145"><span class="hs-identifier">lcl_decls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkNameEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621683454143"><span class="hs-identifier hs-var">tcs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683454144"><span class="hs-identifier hs-var">tyclds</span></a><span class="hs-special">)</span><span>
</span><a name="line-195"></a><span>
</span><a name="line-196"></a><span>    </span><span class="hs-comment">-- Short circuit if we've already seen this Name and concluded</span><span>
</span><a name="line-197"></a><span>    </span><span class="hs-comment">-- it was acyclic.</span><span>
</span><a name="line-198"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyCon</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#SynCycleM"><span class="hs-identifier hs-type">SynCycleM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-199"></a><span>    </span><a name="local-6989586621683454146"><a href="#local-6989586621683454146"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621683454149"><a href="#local-6989586621683454149"><span class="hs-identifier">so_far</span></a></a><span> </span><a name="local-6989586621683454150"><a href="#local-6989586621683454150"><span class="hs-identifier">seen_tcs</span></a></a><span> </span><a name="local-6989586621683454151"><a href="#local-6989586621683454151"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-200"></a><span>        </span><a href="TcTyDecls.html#checkNameIsAcyclic"><span class="hs-identifier hs-var">checkNameIsAcyclic</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621683454151"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683454147"><span class="hs-identifier hs-var">go'</span></a><span> </span><a href="#local-6989586621683454149"><span class="hs-identifier hs-var">so_far</span></a><span> </span><a href="#local-6989586621683454150"><span class="hs-identifier hs-var">seen_tcs</span></a><span> </span><a href="#local-6989586621683454151"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span>    </span><span class="hs-comment">-- Expand type synonyms, complaining if you find the same</span><span>
</span><a name="line-203"></a><span>    </span><span class="hs-comment">-- type synonym a second time.</span><span>
</span><a name="line-204"></a><span>    </span><span class="hs-identifier">go'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyCon</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#SynCycleM"><span class="hs-identifier hs-type">SynCycleM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-205"></a><span>    </span><a name="local-6989586621683454147"><a href="#local-6989586621683454147"><span class="hs-identifier">go'</span></a></a><span> </span><a name="local-6989586621683454152"><a href="#local-6989586621683454152"><span class="hs-identifier">so_far</span></a></a><span> </span><a name="local-6989586621683454153"><a href="#local-6989586621683454153"><span class="hs-identifier">seen_tcs</span></a></a><span> </span><a name="local-6989586621683454154"><a href="#local-6989586621683454154"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-206"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683454155"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683454152"><span class="hs-identifier hs-var">so_far</span></a><span>
</span><a name="line-207"></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="TcTyDecls.html#failSynCycleM"><span class="hs-identifier hs-var">failSynCycleM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getSrcSpan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621683454153"><span class="hs-identifier hs-var">seen_tcs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-208"></a><span>                  </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Cycle in type synonym declarations:&quot;</span><span>
</span><a name="line-209"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621683454157"><span class="hs-identifier hs-var">ppr_decl</span></a><span> </span><a href="#local-6989586621683454153"><span class="hs-identifier hs-var">seen_tcs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-210"></a><span>        </span><span class="hs-comment">-- Optimization: we don't allow cycles through external packages,</span><span>
</span><a name="line-211"></a><span>        </span><span class="hs-comment">-- so once we find a non-local name we are guaranteed to not</span><span>
</span><a name="line-212"></a><span>        </span><span class="hs-comment">-- have a cycle.</span><span>
</span><a name="line-213"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-214"></a><span>        </span><span class="hs-comment">-- This won't hold once we get recursive packages with Backpack,</span><span>
</span><a name="line-215"></a><span>        </span><span class="hs-comment">-- but for now it's fine.</span><span>
</span><a name="line-216"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isHoleModule</span><span> </span><a href="#local-6989586621683454156"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-217"></a><span>               </span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621683454156"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621683454142"><span class="hs-identifier hs-var">this_uid</span></a><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-218"></a><span>               </span><span class="hs-identifier hs-var">isInteractiveModule</span><span> </span><a href="#local-6989586621683454156"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-219"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-220"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683454162"><a href="#local-6989586621683454162"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">synTyConRhs_maybe</span><span> </span><a href="#local-6989586621683454154"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-221"></a><span>            </span><a href="#local-6989586621683454148"><span class="hs-identifier hs-var">go_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">extendNameSet</span><span> </span><a href="#local-6989586621683454152"><span class="hs-identifier hs-var">so_far</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621683454154"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454154"><span class="hs-identifier hs-var">tc</span></a><span class="hs-glyph">:</span><a href="#local-6989586621683454153"><span class="hs-identifier hs-var">seen_tcs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683454162"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-222"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-223"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-224"></a><span>        </span><a name="local-6989586621683454155"><a href="#local-6989586621683454155"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621683454154"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-225"></a><span>        </span><a name="local-6989586621683454156"><a href="#local-6989586621683454156"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameModule</span><span> </span><a href="#local-6989586621683454155"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-226"></a><span>        </span><a name="local-6989586621683454157"><a href="#local-6989586621683454157"><span class="hs-identifier">ppr_decl</span></a></a><span> </span><a name="local-6989586621683454158"><a href="#local-6989586621683454158"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-227"></a><span>          </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupNameEnv</span><span> </span><a href="#local-6989586621683454145"><span class="hs-identifier hs-var">lcl_decls</span></a><span> </span><a href="#local-6989586621683454159"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-228"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683454160"><a href="#local-6989586621683454160"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621683454161"><a href="#local-6989586621683454161"><span class="hs-identifier">decl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683454160"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">colon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683454161"><span class="hs-identifier hs-var">decl</span></a><span>
</span><a name="line-229"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getSrcSpan</span><span> </span><a href="#local-6989586621683454159"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">colon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683454159"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-230"></a><span>                       </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;from external module&quot;</span><span>
</span><a name="line-231"></a><span>         </span><span class="hs-keyword">where</span><span>
</span><a name="line-232"></a><span>          </span><a name="local-6989586621683454159"><a href="#local-6989586621683454159"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621683454158"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-233"></a><span>
</span><a name="line-234"></a><span>    </span><span class="hs-identifier">go_ty</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyCon</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#SynCycleM"><span class="hs-identifier hs-type">SynCycleM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-235"></a><span>    </span><a name="local-6989586621683454148"><a href="#local-6989586621683454148"><span class="hs-identifier">go_ty</span></a></a><span> </span><a name="local-6989586621683454163"><a href="#local-6989586621683454163"><span class="hs-identifier">so_far</span></a></a><span> </span><a name="local-6989586621683454164"><a href="#local-6989586621683454164"><span class="hs-identifier">seen_tcs</span></a></a><span> </span><a name="local-6989586621683454165"><a href="#local-6989586621683454165"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-236"></a><span>        </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454146"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683454163"><span class="hs-identifier hs-var">so_far</span></a><span> </span><a href="#local-6989586621683454164"><span class="hs-identifier hs-var">seen_tcs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcTyDecls.html#synonymTyConsOfType"><span class="hs-identifier hs-var">synonymTyConsOfType</span></a><span> </span><a href="#local-6989586621683454165"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-237"></a><span>
</span><a name="line-238"></a><span class="hs-comment">{- Note [Superclass cycle check]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The superclass cycle check for C decides if we can statically
guarantee that expanding C's superclass cycles transitively is
guaranteed to terminate.  This is a Haskell98 requirement,
but one that we lift with -XUndecidableSuperClasses.

The worry is that a superclass cycle could make the type checker loop.
More precisely, with a constraint (Given or Wanted)
    C ty1 .. tyn
one approach is to instantiate all of C's superclasses, transitively.
We can only do so if that set is finite.

This potential loop occurs only through superclasses.  This, for
example, is fine
  class C a where
    op :: C b =&gt; a -&gt; b -&gt; b
even though C's full definition uses C.

Making the check static also makes it conservative.  Eg
  type family F a
  class F a =&gt; C a
Here an instance of (F a) might mention C:
  type instance F [a] = C a
and now we'd have a loop.

The static check works like this, starting with C
  * Look at C's superclass predicates
  * If any is a type-function application,
    or is headed by a type variable, fail
  * If any has C at the head, fail
  * If any has a type class D at the head,
    make the same test with D

A tricky point is: what if there is a type variable at the head?
Consider this:
   class f (C f) =&gt; C f
   class c       =&gt; Id c
and now expand superclasses for constraint (C Id):
     C Id
 --&gt; Id (C Id)
 --&gt; C Id
 --&gt; ....
Each step expands superclasses one layer, and clearly does not terminate.
-}</span><span>
</span><a name="line-283"></a><span>
</span><a name="line-284"></a><span class="hs-identifier">checkClassCycles</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-285"></a><span class="hs-comment">-- Nothing  &lt;=&gt; ok</span><span>
</span><a name="line-286"></a><span class="hs-comment">-- Just err &lt;=&gt; possible cycle error</span><span>
</span><a name="line-287"></a><a name="checkClassCycles"><a href="TcTyDecls.html#checkClassCycles"><span class="hs-identifier">checkClassCycles</span></a></a><span> </span><a name="local-6989586621683454168"><a href="#local-6989586621683454168"><span class="hs-identifier">cls</span></a></a><span>
</span><a name="line-288"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683454192"><a href="#local-6989586621683454192"><span class="hs-identifier">definite_cycle</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683454193"><a href="#local-6989586621683454193"><span class="hs-identifier">err</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683454170"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitNameSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621683454168"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-289"></a><span>                                     </span><a href="#local-6989586621683454168"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarTys</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">classTyVars</span><span> </span><a href="#local-6989586621683454168"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-290"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683454194"><a href="#local-6989586621683454194"><span class="hs-identifier">herald</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683454192"><span class="hs-identifier hs-var">definite_cycle</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Superclass cycle for&quot;</span><span>
</span><a name="line-291"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Potential superclass cycle for&quot;</span><span>
</span><a name="line-292"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621683454194"><span class="hs-identifier hs-var">herald</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683454168"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-293"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><a href="#local-6989586621683454193"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683454169"><span class="hs-identifier hs-var">hint</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-294"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-295"></a><span>    </span><a name="local-6989586621683454169"><a href="#local-6989586621683454169"><span class="hs-identifier">hint</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Use UndecidableSuperClasses to accept this&quot;</span><span>
</span><a name="line-296"></a><span>
</span><a name="line-297"></a><span>    </span><span class="hs-comment">-- Expand superclasses starting with (C a b), complaining</span><span>
</span><a name="line-298"></a><span>    </span><span class="hs-comment">-- if you find the same class a second time, or a type function</span><span>
</span><a name="line-299"></a><span>    </span><span class="hs-comment">-- or predicate headed by a type variable</span><span>
</span><a name="line-300"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-301"></a><span>    </span><span class="hs-comment">-- NB: this code duplicates TcType.transSuperClasses, but</span><span>
</span><a name="line-302"></a><span>    </span><span class="hs-comment">--     with more error message generation clobber</span><span>
</span><a name="line-303"></a><span>    </span><span class="hs-comment">-- Make sure the two stay in sync.</span><span>
</span><a name="line-304"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">)</span><span>
</span><a name="line-305"></a><span>    </span><a name="local-6989586621683454170"><a href="#local-6989586621683454170"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621683454174"><a href="#local-6989586621683454174"><span class="hs-identifier">so_far</span></a></a><span> </span><a name="local-6989586621683454175"><a href="#local-6989586621683454175"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621683454176"><a href="#local-6989586621683454176"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">firstJusts</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-306"></a><span>                        </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454171"><span class="hs-identifier hs-var">go_pred</span></a><span> </span><a href="#local-6989586621683454174"><span class="hs-identifier hs-var">so_far</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-307"></a><span>                        </span><span class="hs-identifier hs-var">immSuperClasses</span><span> </span><a href="#local-6989586621683454175"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621683454176"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-308"></a><span>
</span><a name="line-309"></a><span>    </span><span class="hs-identifier">go_pred</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PredType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">)</span><span>
</span><a name="line-310"></a><span>       </span><span class="hs-comment">-- Nothing &lt;=&gt; ok</span><span>
</span><a name="line-311"></a><span>       </span><span class="hs-comment">-- Just (True, err)  &lt;=&gt; definite cycle</span><span>
</span><a name="line-312"></a><span>       </span><span class="hs-comment">-- Just (False, err) &lt;=&gt; possible cycle</span><span>
</span><a name="line-313"></a><span>    </span><a name="local-6989586621683454171"><a href="#local-6989586621683454171"><span class="hs-identifier">go_pred</span></a></a><span> </span><a name="local-6989586621683454177"><a href="#local-6989586621683454177"><span class="hs-identifier">so_far</span></a></a><span> </span><a name="local-6989586621683454178"><a href="#local-6989586621683454178"><span class="hs-identifier">pred</span></a></a><span>  </span><span class="hs-comment">-- NB: tcSplitTyConApp looks through synonyms</span><span>
</span><a name="line-314"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683454179"><a href="#local-6989586621683454179"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683454180"><a href="#local-6989586621683454180"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span><span> </span><a href="#local-6989586621683454178"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-315"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454172"><span class="hs-identifier hs-var">go_tc</span></a><span> </span><a href="#local-6989586621683454177"><span class="hs-identifier hs-var">so_far</span></a><span> </span><a href="#local-6989586621683454178"><span class="hs-identifier hs-var">pred</span></a><span> </span><a href="#local-6989586621683454179"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621683454180"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-316"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">hasTyVarHead</span><span> </span><a href="#local-6989586621683454178"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-317"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;one of whose superclass constraints is headed by a type variable:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-318"></a><span>                         </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683454178"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-319"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-320"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-321"></a><span>
</span><a name="line-322"></a><span>    </span><span class="hs-identifier">go_tc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PredType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">)</span><span>
</span><a name="line-323"></a><span>    </span><a name="local-6989586621683454172"><a href="#local-6989586621683454172"><span class="hs-identifier">go_tc</span></a></a><span> </span><a name="local-6989586621683454181"><a href="#local-6989586621683454181"><span class="hs-identifier">so_far</span></a></a><span> </span><a name="local-6989586621683454182"><a href="#local-6989586621683454182"><span class="hs-identifier">pred</span></a></a><span> </span><a name="local-6989586621683454183"><a href="#local-6989586621683454183"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621683454184"><a href="#local-6989586621683454184"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-324"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isFamilyTyCon</span><span> </span><a href="#local-6989586621683454183"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-325"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;one of whose superclass constraints is headed by a type family:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-326"></a><span>                        </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683454182"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-327"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683454185"><a href="#local-6989586621683454185"><span class="hs-identifier">cls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tyConClass_maybe</span><span> </span><a href="#local-6989586621683454183"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-328"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454173"><span class="hs-identifier hs-var">go_cls</span></a><span> </span><a href="#local-6989586621683454181"><span class="hs-identifier hs-var">so_far</span></a><span> </span><a href="#local-6989586621683454185"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621683454184"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-329"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-comment">-- Equality predicate, for example</span><span>
</span><a name="line-330"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-331"></a><span>
</span><a name="line-332"></a><span>    </span><span class="hs-identifier">go_cls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">)</span><span>
</span><a name="line-333"></a><span>    </span><a name="local-6989586621683454173"><a href="#local-6989586621683454173"><span class="hs-identifier">go_cls</span></a></a><span> </span><a name="local-6989586621683454186"><a href="#local-6989586621683454186"><span class="hs-identifier">so_far</span></a></a><span> </span><a name="local-6989586621683454187"><a href="#local-6989586621683454187"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621683454188"><a href="#local-6989586621683454188"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-334"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683454189"><span class="hs-identifier hs-var">cls_nm</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683454186"><span class="hs-identifier hs-var">so_far</span></a><span>
</span><a name="line-335"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;one of whose superclasses is&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683454187"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-336"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isCTupleClass</span><span> </span><a href="#local-6989586621683454187"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-337"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454170"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683454186"><span class="hs-identifier hs-var">so_far</span></a><span> </span><a href="#local-6989586621683454187"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621683454188"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-338"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-339"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683454190"><a href="#local-6989586621683454190"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><a name="local-6989586621683454191"><a href="#local-6989586621683454191"><span class="hs-identifier">err</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683454170"><span class="hs-identifier hs-var">go</span></a><span>  </span><span class="hs-special">(</span><a href="#local-6989586621683454186"><span class="hs-identifier hs-var">so_far</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">extendNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683454189"><span class="hs-identifier hs-var">cls_nm</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683454187"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621683454188"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-340"></a><span>          </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454190"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;one of whose superclasses is&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683454187"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-341"></a><span>                       </span><span class="hs-operator hs-var">$$</span><span> </span><a href="#local-6989586621683454191"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-342"></a><span>       </span><span class="hs-keyword">where</span><span>
</span><a name="line-343"></a><span>         </span><a name="local-6989586621683454189"><a href="#local-6989586621683454189"><span class="hs-identifier">cls_nm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621683454187"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-344"></a><span>
</span><a name="line-345"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Role inference
*                                                                      *
************************************************************************

Note [Role inference]
~~~~~~~~~~~~~~~~~~~~~
The role inference algorithm datatype definitions to infer the roles on the
parameters. Although these roles are stored in the tycons, we can perform this
algorithm on the built tycons, as long as we don't peek at an as-yet-unknown
roles field! Ah, the magic of laziness.

First, we choose appropriate initial roles. For families and classes, roles
(including initial roles) are N. For datatypes, we start with the role in the
role annotation (if any), or otherwise use Phantom. This is done in
initialRoleEnv1.

The function irGroup then propagates role information until it reaches a
fixpoint, preferring N over (R or P) and R over P. To aid in this, we have a
monad RoleM, which is a combination reader and state monad. In its state are
the current RoleEnv, which gets updated by role propagation, and an update
bit, which we use to know whether or not we've reached the fixpoint. The
environment of RoleM contains the tycon whose parameters we are inferring, and
a VarEnv from parameters to their positions, so we can update the RoleEnv.
Between tycons, this reader information is missing; it is added by
addRoleInferenceInfo.

There are two kinds of tycons to consider: algebraic ones (excluding classes)
and type synonyms. (Remember, families don't participate -- all their parameters
are N.) An algebraic tycon processes each of its datacons, in turn. Note that
a datacon's universally quantified parameters might be different from the parent
tycon's parameters, so we use the datacon's univ parameters in the mapping from
vars to positions. Note also that we don't want to infer roles for existentials
(they're all at N, too), so we put them in the set of local variables. As an
optimisation, we skip any tycons whose roles are already all Nominal, as there
nowhere else for them to go. For synonyms, we just analyse their right-hand sides.

irType walks through a type, looking for uses of a variable of interest and
propagating role information. Because anything used under a phantom position
is at phantom and anything used under a nominal position is at nominal, the
irType function can assume that anything it sees is at representational. (The
other possibilities are pruned when they're encountered.)

The rest of the code is just plumbing.

How do we know that this algorithm is correct? It should meet the following
specification:

Let Z be a role context -- a mapping from variables to roles. The following
rules define the property (Z |- t : r), where t is a type and r is a role:

Z(a) = r'        r' &lt;= r
------------------------- RCVar
Z |- a : r

---------- RCConst
Z |- T : r               -- T is a type constructor

Z |- t1 : r
Z |- t2 : N
-------------- RCApp
Z |- t1 t2 : r

forall i&lt;=n. (r_i is R or N) implies Z |- t_i : r_i
roles(T) = r_1 .. r_n
---------------------------------------------------- RCDApp
Z |- T t_1 .. t_n : R

Z, a:N |- t : r
---------------------- RCAll
Z |- forall a:k.t : r


We also have the following rules:

For all datacon_i in type T, where a_1 .. a_n are universally quantified
and b_1 .. b_m are existentially quantified, and the arguments are t_1 .. t_p,
then if forall j&lt;=p, a_1 : r_1 .. a_n : r_n, b_1 : N .. b_m : N |- t_j : R,
then roles(T) = r_1 .. r_n

roles(-&gt;) = R, R
roles(~#) = N, N

With -dcore-lint on, the output of this algorithm is checked in checkValidRoles,
called from checkValidTycon.

Note [Role-checking data constructor arguments]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
  data T a where
    MkT :: Eq b =&gt; F a -&gt; (a-&gt;a) -&gt; T (G a)

Then we want to check the roles at which 'a' is used
in MkT's type.  We want to work on the user-written type,
so we need to take into account
  * the arguments:   (F a) and (a-&gt;a)
  * the context:     C a b
  * the result type: (G a)   -- this is in the eq_spec


Note [Coercions in role inference]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Is (t |&gt; co1) representationally equal to (t |&gt; co2)? Of course they are! Changing
the kind of a type is totally irrelevant to the representation of that type. So,
we want to totally ignore coercions when doing role inference. This includes omitting
any type variables that appear in nominal positions but only within coercions.
-}</span><span>
</span><a name="line-454"></a><span>
</span><a name="line-455"></a><span class="hs-keyword">type</span><span> </span><a name="RolesInfo"><a href="TcTyDecls.html#RolesInfo"><span class="hs-identifier">RolesInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Role</span><span class="hs-special">]</span><span>
</span><a name="line-456"></a><span>
</span><a name="line-457"></a><span class="hs-keyword">type</span><span> </span><a name="RoleEnv"><a href="TcTyDecls.html#RoleEnv"><span class="hs-identifier">RoleEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">NameEnv</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Role</span><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- from tycon names to roles</span><span>
</span><a name="line-458"></a><span>
</span><a name="line-459"></a><span class="hs-comment">-- This, and any of the functions it calls, must *not* look at the roles</span><span>
</span><a name="line-460"></a><span class="hs-comment">-- field of a tycon we are inferring roles about!</span><span>
</span><a name="line-461"></a><span class="hs-comment">-- See Note [Role inference]</span><span>
</span><a name="line-462"></a><span class="hs-identifier">inferRoles</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscSource</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RoleAnnotEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyCon</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Role</span><span class="hs-special">]</span><span>
</span><a name="line-463"></a><a name="inferRoles"><a href="TcTyDecls.html#inferRoles"><span class="hs-identifier">inferRoles</span></a></a><span> </span><a name="local-6989586621683454195"><a href="#local-6989586621683454195"><span class="hs-identifier">hsc_src</span></a></a><span> </span><a name="local-6989586621683454196"><a href="#local-6989586621683454196"><span class="hs-identifier">annots</span></a></a><span> </span><a name="local-6989586621683454197"><a href="#local-6989586621683454197"><span class="hs-identifier">tycons</span></a></a><span>
</span><a name="line-464"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683454198"><a href="#local-6989586621683454198"><span class="hs-identifier">role_env</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcTyDecls.html#initialRoleEnv"><span class="hs-identifier hs-var">initialRoleEnv</span></a><span> </span><a href="#local-6989586621683454195"><span class="hs-identifier hs-var">hsc_src</span></a><span> </span><a href="#local-6989586621683454196"><span class="hs-identifier hs-var">annots</span></a><span> </span><a href="#local-6989586621683454197"><span class="hs-identifier hs-var">tycons</span></a><span>
</span><a name="line-465"></a><span>        </span><a name="local-6989586621683454199"><a href="#local-6989586621683454199"><span class="hs-identifier">role_env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcTyDecls.html#irGroup"><span class="hs-identifier hs-var">irGroup</span></a><span> </span><a href="#local-6989586621683454198"><span class="hs-identifier hs-var">role_env</span></a><span> </span><a href="#local-6989586621683454197"><span class="hs-identifier hs-var">tycons</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-466"></a><span>    </span><span class="hs-glyph">\</span><a name="local-6989586621683454200"><a href="#local-6989586621683454200"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupNameEnv</span><span> </span><a href="#local-6989586621683454199"><span class="hs-identifier hs-var">role_env'</span></a><span> </span><a href="#local-6989586621683454200"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-467"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683454201"><a href="#local-6989586621683454201"><span class="hs-identifier">roles</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683454201"><span class="hs-identifier hs-var">roles</span></a><span>
</span><a name="line-468"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;inferRoles&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683454200"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-469"></a><span>
</span><a name="line-470"></a><span class="hs-identifier">initialRoleEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscSource</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RoleAnnotEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyCon</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#RoleEnv"><span class="hs-identifier hs-type">RoleEnv</span></a><span>
</span><a name="line-471"></a><a name="initialRoleEnv"><a href="TcTyDecls.html#initialRoleEnv"><span class="hs-identifier">initialRoleEnv</span></a></a><span> </span><a name="local-6989586621683454202"><a href="#local-6989586621683454202"><span class="hs-identifier">hsc_src</span></a></a><span> </span><a name="local-6989586621683454203"><a href="#local-6989586621683454203"><span class="hs-identifier">annots</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendNameEnvList</span><span> </span><span class="hs-identifier hs-var">emptyNameEnv</span><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-472"></a><span>                                </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="TcTyDecls.html#initialRoleEnv1"><span class="hs-identifier hs-var">initialRoleEnv1</span></a><span> </span><a href="#local-6989586621683454202"><span class="hs-identifier hs-var">hsc_src</span></a><span> </span><a href="#local-6989586621683454203"><span class="hs-identifier hs-var">annots</span></a><span class="hs-special">)</span><span>
</span><a name="line-473"></a><span>
</span><a name="line-474"></a><span class="hs-identifier">initialRoleEnv1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscSource</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RoleAnnotEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Role</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-475"></a><a name="initialRoleEnv1"><a href="TcTyDecls.html#initialRoleEnv1"><span class="hs-identifier">initialRoleEnv1</span></a></a><span> </span><a name="local-6989586621683454204"><a href="#local-6989586621683454204"><span class="hs-identifier">hsc_src</span></a></a><span> </span><a name="local-6989586621683454205"><a href="#local-6989586621683454205"><span class="hs-identifier">annots_env</span></a></a><span> </span><a name="local-6989586621683454206"><a href="#local-6989586621683454206"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-476"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isFamilyTyCon</span><span> </span><a href="#local-6989586621683454206"><span class="hs-identifier hs-var">tc</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454207"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-identifier hs-var">Nominal</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683454208"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-477"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isAlgTyCon</span><span> </span><a href="#local-6989586621683454206"><span class="hs-identifier hs-var">tc</span></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454207"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683454212"><span class="hs-identifier hs-var">default_roles</span></a><span class="hs-special">)</span><span>
</span><a name="line-478"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTypeSynonymTyCon</span><span> </span><a href="#local-6989586621683454206"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454207"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683454212"><span class="hs-identifier hs-var">default_roles</span></a><span class="hs-special">)</span><span>
</span><a name="line-479"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;initialRoleEnv1&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683454206"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-480"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621683454207"><a href="#local-6989586621683454207"><span class="hs-identifier">name</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621683454206"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-481"></a><span>        </span><a name="local-6989586621683454208"><a href="#local-6989586621683454208"><span class="hs-identifier">bndrs</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConBinders</span><span> </span><a href="#local-6989586621683454206"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-482"></a><span>        </span><a name="local-6989586621683454209"><a href="#local-6989586621683454209"><span class="hs-identifier">argflags</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">tyConBinderArgFlag</span><span> </span><a href="#local-6989586621683454208"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-483"></a><span>        </span><a name="local-6989586621683454210"><a href="#local-6989586621683454210"><span class="hs-identifier">num_exps</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">count</span><span> </span><span class="hs-identifier hs-var">isVisibleArgFlag</span><span> </span><a href="#local-6989586621683454209"><span class="hs-identifier hs-var">argflags</span></a><span>
</span><a name="line-484"></a><span>
</span><a name="line-485"></a><span>          </span><span class="hs-comment">-- if the number of annotations in the role annotation decl</span><span>
</span><a name="line-486"></a><span>          </span><span class="hs-comment">-- is wrong, just ignore it. We check this in the validity check.</span><span>
</span><a name="line-487"></a><span>        </span><a name="local-6989586621683454211"><a href="#local-6989586621683454211"><span class="hs-identifier">role_annots</span></a></a><span>
</span><a name="line-488"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupRoleAnnot</span><span> </span><a href="#local-6989586621683454205"><span class="hs-identifier hs-var">annots_env</span></a><span> </span><a href="#local-6989586621683454207"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-489"></a><span>              </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RoleAnnotDecl</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683454215"><a href="#local-6989586621683454215"><span class="hs-identifier">annots</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-490"></a><span>                </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683454215"><span class="hs-identifier hs-var">annots</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">lengthIs</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683454210"><span class="hs-identifier hs-var">num_exps</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683454215"><span class="hs-identifier hs-var">annots</span></a><span>
</span><a name="line-491"></a><span>              </span><span class="hs-identifier">_</span><span>                              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">replicate</span><span> </span><a href="#local-6989586621683454210"><span class="hs-identifier hs-var">num_exps</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-492"></a><span>        </span><a name="local-6989586621683454212"><a href="#local-6989586621683454212"><span class="hs-identifier">default_roles</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454213"><span class="hs-identifier hs-var">build_default_roles</span></a><span> </span><a href="#local-6989586621683454209"><span class="hs-identifier hs-var">argflags</span></a><span> </span><a href="#local-6989586621683454211"><span class="hs-identifier hs-var">role_annots</span></a><span>
</span><a name="line-493"></a><span>
</span><a name="line-494"></a><span>        </span><a name="local-6989586621683454213"><a href="#local-6989586621683454213"><span class="hs-identifier">build_default_roles</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683454216"><a href="#local-6989586621683454216"><span class="hs-identifier">argf</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683454217"><a href="#local-6989586621683454217"><span class="hs-identifier">argfs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683454218"><a href="#local-6989586621683454218"><span class="hs-identifier">m_annot</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683454219"><a href="#local-6989586621683454219"><span class="hs-identifier">ras</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-495"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isVisibleArgFlag</span><span> </span><a href="#local-6989586621683454216"><span class="hs-identifier hs-var">argf</span></a><span>
</span><a name="line-496"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454218"><span class="hs-identifier hs-var">m_annot</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">orElse</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683454214"><span class="hs-identifier hs-var">default_role</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683454213"><span class="hs-identifier hs-var">build_default_roles</span></a><span> </span><a href="#local-6989586621683454217"><span class="hs-identifier hs-var">argfs</span></a><span> </span><a href="#local-6989586621683454219"><span class="hs-identifier hs-var">ras</span></a><span>
</span><a name="line-497"></a><span>        </span><span class="hs-identifier">build_default_roles</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683454220"><a href="#local-6989586621683454220"><span class="hs-identifier">_argf</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683454221"><a href="#local-6989586621683454221"><span class="hs-identifier">argfs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683454222"><a href="#local-6989586621683454222"><span class="hs-identifier">ras</span></a></a><span>
</span><a name="line-498"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nominal</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683454213"><span class="hs-identifier hs-var">build_default_roles</span></a><span> </span><a href="#local-6989586621683454221"><span class="hs-identifier hs-var">argfs</span></a><span> </span><a href="#local-6989586621683454222"><span class="hs-identifier hs-var">ras</span></a><span>
</span><a name="line-499"></a><span>        </span><span class="hs-identifier">build_default_roles</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-500"></a><span>        </span><span class="hs-identifier">build_default_roles</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;initialRoleEnv1 (2)&quot;</span><span>
</span><a name="line-501"></a><span>                                           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683454206"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683454211"><span class="hs-identifier hs-var">role_annots</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-502"></a><span>
</span><a name="line-503"></a><span>        </span><a name="local-6989586621683454214"><a href="#local-6989586621683454214"><span class="hs-identifier">default_role</span></a></a><span>
</span><a name="line-504"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isClassTyCon</span><span> </span><a href="#local-6989586621683454206"><span class="hs-identifier hs-var">tc</span></a><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nominal</span><span>
</span><a name="line-505"></a><span>          </span><span class="hs-comment">-- Note [Default roles for abstract TyCons in hs-boot/hsig]</span><span>
</span><a name="line-506"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">HsBootFile</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683454204"><span class="hs-identifier hs-var">hsc_src</span></a><span>
</span><a name="line-507"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isAbstractTyCon</span><span> </span><a href="#local-6989586621683454206"><span class="hs-identifier hs-var">tc</span></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Representational</span><span>
</span><a name="line-508"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">HsigFile</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683454204"><span class="hs-identifier hs-var">hsc_src</span></a><span>
</span><a name="line-509"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isAbstractTyCon</span><span> </span><a href="#local-6989586621683454206"><span class="hs-identifier hs-var">tc</span></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nominal</span><span>
</span><a name="line-510"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Phantom</span><span>
</span><a name="line-511"></a><span>
</span><a name="line-512"></a><span class="hs-comment">-- Note [Default roles for abstract TyCons in hs-boot/hsig]</span><span>
</span><a name="line-513"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-514"></a><span class="hs-comment">-- What should the default role for an abstract TyCon be?</span><span>
</span><a name="line-515"></a><span class="hs-comment">--</span><span>
</span><a name="line-516"></a><span class="hs-comment">-- Originally, we inferred phantom role for abstract TyCons</span><span>
</span><a name="line-517"></a><span class="hs-comment">-- in hs-boot files, because the type variables were never used.</span><span>
</span><a name="line-518"></a><span class="hs-comment">--</span><span>
</span><a name="line-519"></a><span class="hs-comment">-- This was silly, because the role of the abstract TyCon</span><span>
</span><a name="line-520"></a><span class="hs-comment">-- was required to match the implementation, and the roles of</span><span>
</span><a name="line-521"></a><span class="hs-comment">-- data types are almost never phantom.  Thus, in ticket #9204,</span><span>
</span><a name="line-522"></a><span class="hs-comment">-- the default was changed so be representational (the most common case).  If</span><span>
</span><a name="line-523"></a><span class="hs-comment">-- the implementing data type was actually nominal, you'd get an easy</span><span>
</span><a name="line-524"></a><span class="hs-comment">-- to understand error, and add the role annotation yourself.</span><span>
</span><a name="line-525"></a><span class="hs-comment">--</span><span>
</span><a name="line-526"></a><span class="hs-comment">-- Then Backpack was added, and with it we added role *subtyping*</span><span>
</span><a name="line-527"></a><span class="hs-comment">-- the matching judgment: if an abstract TyCon has a nominal</span><span>
</span><a name="line-528"></a><span class="hs-comment">-- parameter, it's OK to implement it with a representational</span><span>
</span><a name="line-529"></a><span class="hs-comment">-- parameter.  But now, the representational default is not a good</span><span>
</span><a name="line-530"></a><span class="hs-comment">-- one, because you should *only* request representational if</span><span>
</span><a name="line-531"></a><span class="hs-comment">-- you're planning to do coercions. To be maximally flexible</span><span>
</span><a name="line-532"></a><span class="hs-comment">-- with what data types you will accept, you want the default</span><span>
</span><a name="line-533"></a><span class="hs-comment">-- for hsig files is nominal.  We don't allow role subtyping</span><span>
</span><a name="line-534"></a><span class="hs-comment">-- with hs-boot files (it's good practice to give an exactly</span><span>
</span><a name="line-535"></a><span class="hs-comment">-- accurate role here, because any types that use the abstract</span><span>
</span><a name="line-536"></a><span class="hs-comment">-- type will propagate the role information.)</span><span>
</span><a name="line-537"></a><span>
</span><a name="line-538"></a><span class="hs-identifier">irGroup</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcTyDecls.html#RoleEnv"><span class="hs-identifier hs-type">RoleEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyCon</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#RoleEnv"><span class="hs-identifier hs-type">RoleEnv</span></a><span>
</span><a name="line-539"></a><a name="irGroup"><a href="TcTyDecls.html#irGroup"><span class="hs-identifier">irGroup</span></a></a><span> </span><a name="local-6989586621683454223"><a href="#local-6989586621683454223"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621683454224"><a href="#local-6989586621683454224"><span class="hs-identifier">tcs</span></a></a><span>
</span><a name="line-540"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683454225"><a href="#local-6989586621683454225"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683454226"><a href="#local-6989586621683454226"><span class="hs-identifier">update</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcTyDecls.html#runRoleM"><span class="hs-identifier hs-var">runRoleM</span></a><span> </span><a href="#local-6989586621683454223"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="TcTyDecls.html#irTyCon"><span class="hs-identifier hs-var">irTyCon</span></a><span> </span><a href="#local-6989586621683454224"><span class="hs-identifier hs-var">tcs</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-541"></a><span>    </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683454226"><span class="hs-identifier hs-var">update</span></a><span>
</span><a name="line-542"></a><span>    </span><span class="hs-keyword">then</span><span> </span><a href="TcTyDecls.html#irGroup"><span class="hs-identifier hs-var">irGroup</span></a><span> </span><a href="#local-6989586621683454225"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621683454224"><span class="hs-identifier hs-var">tcs</span></a><span>
</span><a name="line-543"></a><span>    </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621683454225"><span class="hs-identifier hs-var">env'</span></a><span>
</span><a name="line-544"></a><span>
</span><a name="line-545"></a><span class="hs-identifier">irTyCon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#RoleM"><span class="hs-identifier hs-type">RoleM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-546"></a><a name="irTyCon"><a href="TcTyDecls.html#irTyCon"><span class="hs-identifier">irTyCon</span></a></a><span> </span><a name="local-6989586621683454227"><a href="#local-6989586621683454227"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-547"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isAlgTyCon</span><span> </span><a href="#local-6989586621683454227"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-548"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683454228"><a href="#local-6989586621683454228"><span class="hs-identifier">old_roles</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyDecls.html#lookupRoles"><span class="hs-identifier hs-var">lookupRoles</span></a><span> </span><a href="#local-6989586621683454227"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-549"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">Nominal</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683454228"><span class="hs-identifier hs-var">old_roles</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>  </span><span class="hs-comment">-- also catches data families,</span><span>
</span><a name="line-550"></a><span>                                                </span><span class="hs-comment">-- which don't want or need role inference</span><span>
</span><a name="line-551"></a><span>         </span><a href="TcTyDecls.html#irTcTyVars"><span class="hs-identifier hs-var">irTcTyVars</span></a><span> </span><a href="#local-6989586621683454227"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-552"></a><span>         </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="TcTyDecls.html#irType"><span class="hs-identifier hs-var">irType</span></a><span> </span><span class="hs-identifier hs-var">emptyVarSet</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConStupidTheta</span><span> </span><a href="#local-6989586621683454227"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- See #8958</span><span>
</span><a name="line-553"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">whenIsJust</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConClass_maybe</span><span> </span><a href="#local-6989586621683454227"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><a href="TcTyDecls.html#irClass"><span class="hs-identifier hs-var">irClass</span></a><span>
</span><a name="line-554"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="TcTyDecls.html#irDataCon"><span class="hs-identifier hs-var">irDataCon</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">visibleDataCons</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">algTyConRhs</span><span> </span><a href="#local-6989586621683454227"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-555"></a><span>
</span><a name="line-556"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683454229"><a href="#local-6989586621683454229"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">synTyConRhs_maybe</span><span> </span><a href="#local-6989586621683454227"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-557"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcTyDecls.html#irTcTyVars"><span class="hs-identifier hs-var">irTcTyVars</span></a><span> </span><a href="#local-6989586621683454227"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-558"></a><span>    </span><a href="TcTyDecls.html#irType"><span class="hs-identifier hs-var">irType</span></a><span> </span><span class="hs-identifier hs-var">emptyVarSet</span><span> </span><a href="#local-6989586621683454229"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-559"></a><span>
</span><a name="line-560"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-561"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-562"></a><span>
</span><a name="line-563"></a><span class="hs-comment">-- any type variable used in an associated type must be Nominal</span><span>
</span><a name="line-564"></a><span class="hs-identifier">irClass</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#RoleM"><span class="hs-identifier hs-type">RoleM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-565"></a><a name="irClass"><a href="TcTyDecls.html#irClass"><span class="hs-identifier">irClass</span></a></a><span> </span><a name="local-6989586621683454230"><a href="#local-6989586621683454230"><span class="hs-identifier">cls</span></a></a><span>
</span><a name="line-566"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="#local-6989586621683454233"><span class="hs-identifier hs-var">ir_at</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">classATs</span><span> </span><a href="#local-6989586621683454230"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-567"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-568"></a><span>    </span><a name="local-6989586621683454231"><a href="#local-6989586621683454231"><span class="hs-identifier">cls_tvs</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">classTyVars</span><span> </span><a href="#local-6989586621683454230"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-569"></a><span>    </span><a name="local-6989586621683454232"><a href="#local-6989586621683454232"><span class="hs-identifier">cls_tv_set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkVarSet</span><span> </span><a href="#local-6989586621683454231"><span class="hs-identifier hs-var">cls_tvs</span></a><span>
</span><a name="line-570"></a><span>
</span><a name="line-571"></a><span>    </span><a name="local-6989586621683454233"><a href="#local-6989586621683454233"><span class="hs-identifier">ir_at</span></a></a><span> </span><a name="local-6989586621683454234"><a href="#local-6989586621683454234"><span class="hs-identifier">at_tc</span></a></a><span>
</span><a name="line-572"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="TcTyDecls.html#updateRole"><span class="hs-identifier hs-var">updateRole</span></a><span> </span><span class="hs-identifier hs-var">Nominal</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683454235"><span class="hs-identifier hs-var">nvars</span></a><span>
</span><a name="line-573"></a><span>      </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621683454235"><a href="#local-6989586621683454235"><span class="hs-identifier">nvars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683454232"><span class="hs-identifier hs-var">cls_tv_set</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">tyConTyVars</span><span> </span><a href="#local-6989586621683454234"><span class="hs-identifier hs-var">at_tc</span></a><span>
</span><a name="line-574"></a><span>
</span><a name="line-575"></a><span class="hs-comment">-- See Note [Role inference]</span><span>
</span><a name="line-576"></a><span class="hs-identifier">irDataCon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#RoleM"><span class="hs-identifier hs-type">RoleM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-577"></a><a name="irDataCon"><a href="TcTyDecls.html#irDataCon"><span class="hs-identifier">irDataCon</span></a></a><span> </span><a name="local-6989586621683454236"><a href="#local-6989586621683454236"><span class="hs-identifier">datacon</span></a></a><span>
</span><a name="line-578"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcTyDecls.html#setRoleInferenceVars"><span class="hs-identifier hs-var">setRoleInferenceVars</span></a><span> </span><a href="#local-6989586621683454237"><span class="hs-identifier hs-var">univ_tvs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-579"></a><span>    </span><a href="TcTyDecls.html#irExTyVars"><span class="hs-identifier hs-var">irExTyVars</span></a><span> </span><a href="#local-6989586621683454238"><span class="hs-identifier hs-var">ex_tvs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621683454243"><a href="#local-6989586621683454243"><span class="hs-identifier">ex_var_set</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-580"></a><span>    </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="TcTyDecls.html#irType"><span class="hs-identifier hs-var">irType</span></a><span> </span><a href="#local-6989586621683454243"><span class="hs-identifier hs-var">ex_var_set</span></a><span class="hs-special">)</span><span>
</span><a name="line-581"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">tyVarKind</span><span> </span><a href="#local-6989586621683454238"><span class="hs-identifier hs-var">ex_tvs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">eqSpecPreds</span><span> </span><a href="#local-6989586621683454239"><span class="hs-identifier hs-var">eq_spec</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683454240"><span class="hs-identifier hs-var">theta</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683454241"><span class="hs-identifier hs-var">arg_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-582"></a><span>      </span><span class="hs-comment">-- See Note [Role-checking data constructor arguments]</span><span>
</span><a name="line-583"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-584"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621683454237"><a href="#local-6989586621683454237"><span class="hs-identifier">univ_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683454238"><a href="#local-6989586621683454238"><span class="hs-identifier">ex_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683454239"><a href="#local-6989586621683454239"><span class="hs-identifier">eq_spec</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683454240"><a href="#local-6989586621683454240"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683454241"><a href="#local-6989586621683454241"><span class="hs-identifier">arg_tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683454242"><a href="#local-6989586621683454242"><span class="hs-identifier">_res_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-585"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConFullSig</span><span> </span><a href="#local-6989586621683454236"><span class="hs-identifier hs-var">datacon</span></a><span>
</span><a name="line-586"></a><span>
</span><a name="line-587"></a><span class="hs-identifier">irType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">VarSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#RoleM"><span class="hs-identifier hs-type">RoleM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-588"></a><a name="irType"><a href="TcTyDecls.html#irType"><span class="hs-identifier">irType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454244"><span class="hs-identifier hs-var">go</span></a><span>
</span><a name="line-589"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-590"></a><span>    </span><a name="local-6989586621683454244"><a href="#local-6989586621683454244"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621683454246"><a href="#local-6989586621683454246"><span class="hs-identifier">lcls</span></a></a><span> </span><a name="local-6989586621683454247"><a href="#local-6989586621683454247"><span class="hs-identifier">ty</span></a></a><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683454248"><a href="#local-6989586621683454248"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">coreView</span><span> </span><a href="#local-6989586621683454247"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-comment">-- #14101</span><span>
</span><a name="line-591"></a><span>                               </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454244"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683454246"><span class="hs-identifier hs-var">lcls</span></a><span> </span><a href="#local-6989586621683454248"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-592"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621683454249"><a href="#local-6989586621683454249"><span class="hs-identifier">lcls</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyVarTy</span><span> </span><a name="local-6989586621683454250"><a href="#local-6989586621683454250"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454250"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683454249"><span class="hs-identifier hs-var">lcls</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-593"></a><span>                                 </span><a href="TcTyDecls.html#updateRole"><span class="hs-identifier hs-var">updateRole</span></a><span> </span><span class="hs-identifier hs-var">Representational</span><span> </span><a href="#local-6989586621683454250"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-594"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621683454251"><a href="#local-6989586621683454251"><span class="hs-identifier">lcls</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AppTy</span><span> </span><a name="local-6989586621683454252"><a href="#local-6989586621683454252"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-6989586621683454253"><a href="#local-6989586621683454253"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454244"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683454251"><span class="hs-identifier hs-var">lcls</span></a><span> </span><a href="#local-6989586621683454252"><span class="hs-identifier hs-var">t1</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><a href="TcTyDecls.html#markNominal"><span class="hs-identifier hs-var">markNominal</span></a><span> </span><a href="#local-6989586621683454251"><span class="hs-identifier hs-var">lcls</span></a><span> </span><a href="#local-6989586621683454253"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-595"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621683454254"><a href="#local-6989586621683454254"><span class="hs-identifier">lcls</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyConApp</span><span> </span><a name="local-6989586621683454255"><a href="#local-6989586621683454255"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621683454256"><a href="#local-6989586621683454256"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683454257"><a href="#local-6989586621683454257"><span class="hs-identifier">roles</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyDecls.html#lookupRolesX"><span class="hs-identifier hs-var">lookupRolesX</span></a><span> </span><a href="#local-6989586621683454255"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-596"></a><span>                                    </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">zipWithM_</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454245"><span class="hs-identifier hs-var">go_app</span></a><span> </span><a href="#local-6989586621683454254"><span class="hs-identifier hs-var">lcls</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683454257"><span class="hs-identifier hs-var">roles</span></a><span> </span><a href="#local-6989586621683454256"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-597"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621683454258"><a href="#local-6989586621683454258"><span class="hs-identifier">lcls</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ForAllTy</span><span> </span><a name="local-6989586621683454259"><a href="#local-6989586621683454259"><span class="hs-identifier">tvb</span></a></a><span> </span><a name="local-6989586621683454260"><a href="#local-6989586621683454260"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683454261"><a href="#local-6989586621683454261"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">binderVar</span><span> </span><a href="#local-6989586621683454259"><span class="hs-identifier hs-var">tvb</span></a><span>
</span><a name="line-598"></a><span>                                          </span><a name="local-6989586621683454262"><a href="#local-6989586621683454262"><span class="hs-identifier">lcls'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendVarSet</span><span> </span><a href="#local-6989586621683454258"><span class="hs-identifier hs-var">lcls</span></a><span> </span><a href="#local-6989586621683454261"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-599"></a><span>                                    </span><span class="hs-special">;</span><span> </span><a href="TcTyDecls.html#markNominal"><span class="hs-identifier hs-var">markNominal</span></a><span> </span><a href="#local-6989586621683454258"><span class="hs-identifier hs-var">lcls</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyVarKind</span><span> </span><a href="#local-6989586621683454261"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-600"></a><span>                                    </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621683454244"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683454262"><span class="hs-identifier hs-var">lcls'</span></a><span> </span><a href="#local-6989586621683454260"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-601"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621683454263"><a href="#local-6989586621683454263"><span class="hs-identifier">lcls</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunTy</span><span> </span><a name="local-6989586621683454264"><a href="#local-6989586621683454264"><span class="hs-identifier">arg</span></a></a><span> </span><a name="local-6989586621683454265"><a href="#local-6989586621683454265"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454244"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683454263"><span class="hs-identifier hs-var">lcls</span></a><span> </span><a href="#local-6989586621683454264"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><a href="#local-6989586621683454244"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683454263"><span class="hs-identifier hs-var">lcls</span></a><span> </span><a href="#local-6989586621683454265"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-602"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitTy</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-603"></a><span>      </span><span class="hs-comment">-- See Note [Coercions in role inference]</span><span>
</span><a name="line-604"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621683454266"><a href="#local-6989586621683454266"><span class="hs-identifier">lcls</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CastTy</span><span> </span><a name="local-6989586621683454267"><a href="#local-6989586621683454267"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454244"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683454266"><span class="hs-identifier hs-var">lcls</span></a><span> </span><a href="#local-6989586621683454267"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-605"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoercionTy</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-606"></a><span>
</span><a name="line-607"></a><span>    </span><a name="local-6989586621683454245"><a href="#local-6989586621683454245"><span class="hs-identifier">go_app</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">Phantom</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>                 </span><span class="hs-comment">-- nothing to do here</span><span>
</span><a name="line-608"></a><span>    </span><span class="hs-identifier">go_app</span><span> </span><a name="local-6989586621683454268"><a href="#local-6989586621683454268"><span class="hs-identifier">lcls</span></a></a><span> </span><span class="hs-identifier hs-var">Nominal</span><span> </span><a name="local-6989586621683454269"><a href="#local-6989586621683454269"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcTyDecls.html#markNominal"><span class="hs-identifier hs-var">markNominal</span></a><span> </span><a href="#local-6989586621683454268"><span class="hs-identifier hs-var">lcls</span></a><span> </span><a href="#local-6989586621683454269"><span class="hs-identifier hs-var">ty</span></a><span>  </span><span class="hs-comment">-- all vars below here are N</span><span>
</span><a name="line-609"></a><span>    </span><span class="hs-identifier">go_app</span><span> </span><a name="local-6989586621683454270"><a href="#local-6989586621683454270"><span class="hs-identifier">lcls</span></a></a><span> </span><span class="hs-identifier hs-var">Representational</span><span> </span><a name="local-6989586621683454271"><a href="#local-6989586621683454271"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454244"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683454270"><span class="hs-identifier hs-var">lcls</span></a><span> </span><a href="#local-6989586621683454271"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-610"></a><span>
</span><a name="line-611"></a><span class="hs-identifier">irTcTyVars</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#RoleM"><span class="hs-identifier hs-type">RoleM</span></a><span> </span><a href="#local-6989586621683454085"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#RoleM"><span class="hs-identifier hs-type">RoleM</span></a><span> </span><a href="#local-6989586621683454085"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-612"></a><a name="irTcTyVars"><a href="TcTyDecls.html#irTcTyVars"><span class="hs-identifier">irTcTyVars</span></a></a><span> </span><a name="local-6989586621683454272"><a href="#local-6989586621683454272"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621683454273"><a href="#local-6989586621683454273"><span class="hs-identifier">thing</span></a></a><span>
</span><a name="line-613"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcTyDecls.html#setRoleInferenceTc"><span class="hs-identifier hs-var">setRoleInferenceTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621683454272"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683454274"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConTyVars</span><span> </span><a href="#local-6989586621683454272"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-614"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-615"></a><span>    </span><a name="local-6989586621683454274"><a href="#local-6989586621683454274"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454273"><span class="hs-identifier hs-var">thing</span></a><span>
</span><a name="line-616"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683454275"><a href="#local-6989586621683454275"><span class="hs-identifier">tv</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621683454276"><a href="#local-6989586621683454276"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcTyDecls.html#markNominal"><span class="hs-identifier hs-var">markNominal</span></a><span> </span><span class="hs-identifier hs-var">emptyVarSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyVarKind</span><span> </span><a href="#local-6989586621683454275"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-617"></a><span>                     </span><span class="hs-special">;</span><span> </span><a href="TcTyDecls.html#addRoleInferenceVar"><span class="hs-identifier hs-var">addRoleInferenceVar</span></a><span> </span><a href="#local-6989586621683454275"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683454274"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683454276"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-618"></a><span>
</span><a name="line-619"></a><span class="hs-identifier">irExTyVars</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TyVarSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#RoleM"><span class="hs-identifier hs-type">RoleM</span></a><span> </span><a href="#local-6989586621683454084"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#RoleM"><span class="hs-identifier hs-type">RoleM</span></a><span> </span><a href="#local-6989586621683454084"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-620"></a><a name="irExTyVars"><a href="TcTyDecls.html#irExTyVars"><span class="hs-identifier">irExTyVars</span></a></a><span> </span><a name="local-6989586621683454277"><a href="#local-6989586621683454277"><span class="hs-identifier">orig_tvs</span></a></a><span> </span><a name="local-6989586621683454278"><a href="#local-6989586621683454278"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454279"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-identifier hs-var">emptyVarSet</span><span> </span><a href="#local-6989586621683454277"><span class="hs-identifier hs-var">orig_tvs</span></a><span>
</span><a name="line-621"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-622"></a><span>    </span><a name="local-6989586621683454279"><a href="#local-6989586621683454279"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621683454280"><a href="#local-6989586621683454280"><span class="hs-identifier">lcls</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454278"><span class="hs-identifier hs-var">thing</span></a><span> </span><a href="#local-6989586621683454280"><span class="hs-identifier hs-var">lcls</span></a><span>
</span><a name="line-623"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621683454281"><a href="#local-6989586621683454281"><span class="hs-identifier">lcls</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683454282"><a href="#local-6989586621683454282"><span class="hs-identifier">tv</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621683454283"><a href="#local-6989586621683454283"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcTyDecls.html#markNominal"><span class="hs-identifier hs-var">markNominal</span></a><span> </span><a href="#local-6989586621683454281"><span class="hs-identifier hs-var">lcls</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyVarKind</span><span> </span><a href="#local-6989586621683454282"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-624"></a><span>                          </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621683454279"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">extendVarSet</span><span> </span><a href="#local-6989586621683454281"><span class="hs-identifier hs-var">lcls</span></a><span> </span><a href="#local-6989586621683454282"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683454283"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-625"></a><span>
</span><a name="line-626"></a><span class="hs-identifier">markNominal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyVarSet</span><span>   </span><span class="hs-comment">-- local variables</span><span>
</span><a name="line-627"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#RoleM"><span class="hs-identifier hs-type">RoleM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-628"></a><a name="markNominal"><a href="TcTyDecls.html#markNominal"><span class="hs-identifier">markNominal</span></a></a><span> </span><a name="local-6989586621683454284"><a href="#local-6989586621683454284"><span class="hs-identifier">lcls</span></a></a><span> </span><a name="local-6989586621683454285"><a href="#local-6989586621683454285"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683454296"><a href="#local-6989586621683454296"><span class="hs-identifier">nvars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fvVarList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FV.delFVs</span><span> </span><a href="#local-6989586621683454284"><span class="hs-identifier hs-var">lcls</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683454286"><span class="hs-identifier hs-var">get_ty_vars</span></a><span> </span><a href="#local-6989586621683454285"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-629"></a><span>                      </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="TcTyDecls.html#updateRole"><span class="hs-identifier hs-var">updateRole</span></a><span> </span><span class="hs-identifier hs-var">Nominal</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683454296"><span class="hs-identifier hs-var">nvars</span></a><span>
</span><a name="line-630"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-631"></a><span>     </span><span class="hs-comment">-- get_ty_vars gets all the tyvars (no covars!) from a type *without*</span><span>
</span><a name="line-632"></a><span>     </span><span class="hs-comment">-- recurring into coercions. Recall: coercions are totally ignored during</span><span>
</span><a name="line-633"></a><span>     </span><span class="hs-comment">-- role inference. See [Coercions in role inference]</span><span>
</span><a name="line-634"></a><span>    </span><span class="hs-identifier">get_ty_vars</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FV</span><span>
</span><a name="line-635"></a><span>    </span><a name="local-6989586621683454286"><a href="#local-6989586621683454286"><span class="hs-identifier">get_ty_vars</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyVarTy</span><span> </span><a name="local-6989586621683454287"><a href="#local-6989586621683454287"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unitFV</span><span> </span><a href="#local-6989586621683454287"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-636"></a><span>    </span><span class="hs-identifier">get_ty_vars</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AppTy</span><span> </span><a name="local-6989586621683454288"><a href="#local-6989586621683454288"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-6989586621683454289"><a href="#local-6989586621683454289"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454286"><span class="hs-identifier hs-var">get_ty_vars</span></a><span> </span><a href="#local-6989586621683454288"><span class="hs-identifier hs-var">t1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683454286"><span class="hs-identifier hs-var">get_ty_vars</span></a><span> </span><a href="#local-6989586621683454289"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-637"></a><span>    </span><span class="hs-identifier">get_ty_vars</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunTy</span><span> </span><a name="local-6989586621683454290"><a href="#local-6989586621683454290"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-6989586621683454291"><a href="#local-6989586621683454291"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454286"><span class="hs-identifier hs-var">get_ty_vars</span></a><span> </span><a href="#local-6989586621683454290"><span class="hs-identifier hs-var">t1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683454286"><span class="hs-identifier hs-var">get_ty_vars</span></a><span> </span><a href="#local-6989586621683454291"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-638"></a><span>    </span><span class="hs-identifier">get_ty_vars</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyConApp</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683454292"><a href="#local-6989586621683454292"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapUnionFV</span><span> </span><a href="#local-6989586621683454286"><span class="hs-identifier hs-var">get_ty_vars</span></a><span> </span><a href="#local-6989586621683454292"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-639"></a><span>    </span><span class="hs-identifier">get_ty_vars</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ForAllTy</span><span> </span><a name="local-6989586621683454293"><a href="#local-6989586621683454293"><span class="hs-identifier">tvb</span></a></a><span> </span><a name="local-6989586621683454294"><a href="#local-6989586621683454294"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyCoFVsBndr</span><span> </span><a href="#local-6989586621683454293"><span class="hs-identifier hs-var">tvb</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454286"><span class="hs-identifier hs-var">get_ty_vars</span></a><span> </span><a href="#local-6989586621683454294"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-640"></a><span>    </span><span class="hs-identifier">get_ty_vars</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitTy</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyFV</span><span>
</span><a name="line-641"></a><span>    </span><span class="hs-identifier">get_ty_vars</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CastTy</span><span> </span><a name="local-6989586621683454295"><a href="#local-6989586621683454295"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454286"><span class="hs-identifier hs-var">get_ty_vars</span></a><span> </span><a href="#local-6989586621683454295"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-642"></a><span>    </span><span class="hs-identifier">get_ty_vars</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoercionTy</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyFV</span><span>
</span><a name="line-643"></a><span>
</span><a name="line-644"></a><span class="hs-comment">-- like lookupRoles, but with Nominal tags at the end for oversaturated TyConApps</span><span>
</span><a name="line-645"></a><span class="hs-identifier">lookupRolesX</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#RoleM"><span class="hs-identifier hs-type">RoleM</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Role</span><span class="hs-special">]</span><span>
</span><a name="line-646"></a><a name="lookupRolesX"><a href="TcTyDecls.html#lookupRolesX"><span class="hs-identifier">lookupRolesX</span></a></a><span> </span><a name="local-6989586621683454297"><a href="#local-6989586621683454297"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-647"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683454298"><a href="#local-6989586621683454298"><span class="hs-identifier">roles</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyDecls.html#lookupRoles"><span class="hs-identifier hs-var">lookupRoles</span></a><span> </span><a href="#local-6989586621683454297"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-648"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683454298"><span class="hs-identifier hs-var">roles</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">repeat</span><span> </span><span class="hs-identifier hs-var">Nominal</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-649"></a><span>
</span><a name="line-650"></a><span class="hs-comment">-- gets the roles either from the environment or the tycon</span><span>
</span><a name="line-651"></a><span class="hs-identifier">lookupRoles</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#RoleM"><span class="hs-identifier hs-type">RoleM</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Role</span><span class="hs-special">]</span><span>
</span><a name="line-652"></a><a name="lookupRoles"><a href="TcTyDecls.html#lookupRoles"><span class="hs-identifier">lookupRoles</span></a></a><span> </span><a name="local-6989586621683454299"><a href="#local-6989586621683454299"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-653"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683454300"><a href="#local-6989586621683454300"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyDecls.html#getRoleEnv"><span class="hs-identifier hs-var">getRoleEnv</span></a><span>
</span><a name="line-654"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupNameEnv</span><span> </span><a href="#local-6989586621683454300"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621683454299"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-655"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683454301"><a href="#local-6989586621683454301"><span class="hs-identifier">roles</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683454301"><span class="hs-identifier hs-var">roles</span></a><span>
</span><a name="line-656"></a><span>           </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">tyConRoles</span><span> </span><a href="#local-6989586621683454299"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-657"></a><span>
</span><a name="line-658"></a><span class="hs-comment">-- tries to update a role; won't ever update a role &quot;downwards&quot;</span><span>
</span><a name="line-659"></a><span class="hs-identifier">updateRole</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Role</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#RoleM"><span class="hs-identifier hs-type">RoleM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-660"></a><a name="updateRole"><a href="TcTyDecls.html#updateRole"><span class="hs-identifier">updateRole</span></a></a><span> </span><span class="hs-keyword">role</span><span> </span><a name="local-6989586621683454303"><a href="#local-6989586621683454303"><span class="hs-identifier">tv</span></a></a><span>
</span><a name="line-661"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683454304"><a href="#local-6989586621683454304"><span class="hs-identifier">var_ns</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyDecls.html#getVarNs"><span class="hs-identifier hs-var">getVarNs</span></a><span>
</span><a name="line-662"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683454305"><a href="#local-6989586621683454305"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyDecls.html#getTyConName"><span class="hs-identifier hs-var">getTyConName</span></a><span>
</span><a name="line-663"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupVarEnv</span><span> </span><a href="#local-6989586621683454304"><span class="hs-identifier hs-var">var_ns</span></a><span> </span><a href="#local-6989586621683454303"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-664"></a><span>           </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;updateRole&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683454305"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683454303"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683454304"><span class="hs-identifier hs-var">var_ns</span></a><span class="hs-special">)</span><span>
</span><a name="line-665"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683454306"><a href="#local-6989586621683454306"><span class="hs-identifier">n</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#updateRoleEnv"><span class="hs-identifier hs-var">updateRoleEnv</span></a><span> </span><a href="#local-6989586621683454305"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683454306"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-keyword">role</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-666"></a><span>
</span><a name="line-667"></a><span class="hs-comment">-- the state in the RoleM monad</span><span>
</span><a name="line-668"></a><span class="hs-keyword">data</span><span> </span><a name="RoleInferenceState"><a href="TcTyDecls.html#RoleInferenceState"><span class="hs-identifier">RoleInferenceState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="RIS"><a href="TcTyDecls.html#RIS"><span class="hs-identifier">RIS</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="role_env"><a href="TcTyDecls.html#role_env"><span class="hs-identifier">role_env</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="TcTyDecls.html#RoleEnv"><span class="hs-identifier hs-type">RoleEnv</span></a><span>
</span><a name="line-669"></a><span>                              </span><span class="hs-special">,</span><span> </span><a name="update"><a href="TcTyDecls.html#update"><span class="hs-identifier">update</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-670"></a><span>
</span><a name="line-671"></a><span class="hs-comment">-- the environment in the RoleM monad</span><span>
</span><a name="line-672"></a><span class="hs-keyword">type</span><span> </span><a name="VarPositions"><a href="TcTyDecls.html#VarPositions"><span class="hs-identifier">VarPositions</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">VarEnv</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-673"></a><span>
</span><a name="line-674"></a><span class="hs-comment">-- See [Role inference]</span><span>
</span><a name="line-675"></a><span class="hs-keyword">newtype</span><span> </span><a name="RoleM"><a href="TcTyDecls.html#RoleM"><span class="hs-identifier">RoleM</span></a></a><span> </span><a name="local-6989586621683454061"><a href="#local-6989586621683454061"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="RM"><a href="TcTyDecls.html#RM"><span class="hs-identifier">RM</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="unRM"><a href="TcTyDecls.html#unRM"><span class="hs-identifier">unRM</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-comment">-- of the tycon</span><span>
</span><a name="line-676"></a><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#VarPositions"><span class="hs-identifier hs-type">VarPositions</span></a><span>
</span><a name="line-677"></a><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>          </span><span class="hs-comment">-- size of VarPositions</span><span>
</span><a name="line-678"></a><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#RoleInferenceState"><span class="hs-identifier hs-type">RoleInferenceState</span></a><span>
</span><a name="line-679"></a><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454061"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="TcTyDecls.html#RoleInferenceState"><span class="hs-identifier hs-type">RoleInferenceState</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-680"></a><span>
</span><a name="line-681"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="TcTyDecls.html#RoleM"><span class="hs-identifier hs-type">RoleM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-682"></a><span>    </span><a name="local-3458764513820541101"><span class="hs-identifier">fmap</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftM</span><span>
</span><a name="line-683"></a><span>
</span><a name="line-684"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span> </span><a href="TcTyDecls.html#RoleM"><span class="hs-identifier hs-type">RoleM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-685"></a><span>    </span><a name="local-3458764513820541680"><span class="hs-identifier">pure</span></a><span> </span><a name="local-6989586621683454071"><a href="#local-6989586621683454071"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcTyDecls.html#RM"><span class="hs-identifier hs-var">RM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683454072"><a href="#local-6989586621683454072"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454071"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683454072"><span class="hs-identifier hs-var">state</span></a><span class="hs-special">)</span><span>
</span><a name="line-686"></a><span>    </span><span class="hs-special">(</span><a name="local-3458764513820541679"><span class="hs-operator">&lt;*&gt;</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ap</span><span>
</span><a name="line-687"></a><span>
</span><a name="line-688"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="TcTyDecls.html#RoleM"><span class="hs-identifier hs-type">RoleM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-689"></a><span>  </span><a name="local-6989586621683454063"><a href="#local-6989586621683454063"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-3458764513820541099"><span class="hs-operator">&gt;&gt;=</span></a><span> </span><a name="local-6989586621683454064"><a href="#local-6989586621683454064"><span class="hs-identifier">f</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcTyDecls.html#RM"><span class="hs-identifier hs-var">RM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683454065"><a href="#local-6989586621683454065"><span class="hs-identifier">m_info</span></a></a><span> </span><a name="local-6989586621683454066"><a href="#local-6989586621683454066"><span class="hs-identifier">vps</span></a></a><span> </span><a name="local-6989586621683454067"><a href="#local-6989586621683454067"><span class="hs-identifier">nvps</span></a></a><span> </span><a name="local-6989586621683454068"><a href="#local-6989586621683454068"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-690"></a><span>                  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683454069"><a href="#local-6989586621683454069"><span class="hs-identifier">a'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683454070"><a href="#local-6989586621683454070"><span class="hs-identifier">state'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">unRM</span><span> </span><a href="#local-6989586621683454063"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621683454065"><span class="hs-identifier hs-var">m_info</span></a><span> </span><a href="#local-6989586621683454066"><span class="hs-identifier hs-var">vps</span></a><span> </span><a href="#local-6989586621683454067"><span class="hs-identifier hs-var">nvps</span></a><span> </span><a href="#local-6989586621683454068"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-691"></a><span>                  </span><span class="hs-identifier">unRM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454064"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621683454069"><span class="hs-identifier hs-var">a'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683454065"><span class="hs-identifier hs-var">m_info</span></a><span> </span><a href="#local-6989586621683454066"><span class="hs-identifier hs-var">vps</span></a><span> </span><a href="#local-6989586621683454067"><span class="hs-identifier hs-var">nvps</span></a><span> </span><a href="#local-6989586621683454070"><span class="hs-identifier hs-var">state'</span></a><span>
</span><a name="line-692"></a><span>
</span><a name="line-693"></a><span class="hs-identifier">runRoleM</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcTyDecls.html#RoleEnv"><span class="hs-identifier hs-type">RoleEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#RoleM"><span class="hs-identifier hs-type">RoleM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="TcTyDecls.html#RoleEnv"><span class="hs-identifier hs-type">RoleEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>
</span><a name="line-694"></a><a name="runRoleM"><a href="TcTyDecls.html#runRoleM"><span class="hs-identifier">runRoleM</span></a></a><span> </span><a name="local-6989586621683454307"><a href="#local-6989586621683454307"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621683454308"><a href="#local-6989586621683454308"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454309"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683454310"><span class="hs-identifier hs-var">update</span></a><span class="hs-special">)</span><span>
</span><a name="line-695"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a href="TcTyDecls.html#RIS"><span class="hs-identifier hs-var">RIS</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">role_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683454309"><a href="#local-6989586621683454309"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">update</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683454310"><a href="#local-6989586621683454310"><span class="hs-identifier">update</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-696"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">unRM</span><span> </span><a href="#local-6989586621683454308"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-identifier hs-var">emptyVarEnv</span><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621683454311"><span class="hs-identifier hs-var">state</span></a><span>
</span><a name="line-697"></a><span>        </span><a name="local-6989586621683454311"><a href="#local-6989586621683454311"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcTyDecls.html#RIS"><span class="hs-identifier hs-var">RIS</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">role_env</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454307"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-698"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">update</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-699"></a><span>
</span><a name="line-700"></a><span class="hs-identifier">setRoleInferenceTc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#RoleM"><span class="hs-identifier hs-type">RoleM</span></a><span> </span><a href="#local-6989586621683454083"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#RoleM"><span class="hs-identifier hs-type">RoleM</span></a><span> </span><a href="#local-6989586621683454083"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-701"></a><a name="setRoleInferenceTc"><a href="TcTyDecls.html#setRoleInferenceTc"><span class="hs-identifier">setRoleInferenceTc</span></a></a><span> </span><a name="local-6989586621683454312"><a href="#local-6989586621683454312"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621683454313"><a href="#local-6989586621683454313"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcTyDecls.html#RM"><span class="hs-identifier hs-var">RM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683454314"><a href="#local-6989586621683454314"><span class="hs-identifier">m_name</span></a></a><span> </span><a name="local-6989586621683454315"><a href="#local-6989586621683454315"><span class="hs-identifier">vps</span></a></a><span> </span><a name="local-6989586621683454316"><a href="#local-6989586621683454316"><span class="hs-identifier">nvps</span></a></a><span> </span><a name="local-6989586621683454317"><a href="#local-6989586621683454317"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-702"></a><span>                                </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isNothing</span><span> </span><span class="hs-identifier">m_name</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-703"></a><span>                                </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isEmptyVarEnv</span><span> </span><span class="hs-identifier hs-var">vps</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-704"></a><span>                                </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">nvps</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-705"></a><span>                                </span><span class="hs-identifier">unRM</span><span> </span><a href="#local-6989586621683454313"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683454312"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683454315"><span class="hs-identifier hs-var">vps</span></a><span> </span><a href="#local-6989586621683454316"><span class="hs-identifier hs-var">nvps</span></a><span> </span><a href="#local-6989586621683454317"><span class="hs-identifier hs-var">state</span></a><span>
</span><a name="line-706"></a><span>
</span><a name="line-707"></a><span class="hs-identifier">addRoleInferenceVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#RoleM"><span class="hs-identifier hs-type">RoleM</span></a><span> </span><a href="#local-6989586621683454082"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#RoleM"><span class="hs-identifier hs-type">RoleM</span></a><span> </span><a href="#local-6989586621683454082"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-708"></a><a name="addRoleInferenceVar"><a href="TcTyDecls.html#addRoleInferenceVar"><span class="hs-identifier">addRoleInferenceVar</span></a></a><span> </span><a name="local-6989586621683454318"><a href="#local-6989586621683454318"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-6989586621683454319"><a href="#local-6989586621683454319"><span class="hs-identifier">thing</span></a></a><span>
</span><a name="line-709"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcTyDecls.html#RM"><span class="hs-identifier hs-var">RM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683454320"><a href="#local-6989586621683454320"><span class="hs-identifier">m_name</span></a></a><span> </span><a name="local-6989586621683454321"><a href="#local-6989586621683454321"><span class="hs-identifier">vps</span></a></a><span> </span><a name="local-6989586621683454322"><a href="#local-6989586621683454322"><span class="hs-identifier">nvps</span></a></a><span> </span><a name="local-6989586621683454323"><a href="#local-6989586621683454323"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-710"></a><span>    </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isJust</span><span> </span><span class="hs-identifier">m_name</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-711"></a><span>    </span><span class="hs-identifier">unRM</span><span> </span><a href="#local-6989586621683454319"><span class="hs-identifier hs-var">thing</span></a><span> </span><a href="#local-6989586621683454320"><span class="hs-identifier hs-var">m_name</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">extendVarEnv</span><span> </span><a href="#local-6989586621683454321"><span class="hs-identifier hs-var">vps</span></a><span> </span><a href="#local-6989586621683454318"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-6989586621683454322"><span class="hs-identifier hs-var">nvps</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454322"><span class="hs-identifier hs-var">nvps</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683454323"><span class="hs-identifier hs-var">state</span></a><span>
</span><a name="line-712"></a><span>
</span><a name="line-713"></a><span class="hs-identifier">setRoleInferenceVars</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#RoleM"><span class="hs-identifier hs-type">RoleM</span></a><span> </span><a href="#local-6989586621683454081"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#RoleM"><span class="hs-identifier hs-type">RoleM</span></a><span> </span><a href="#local-6989586621683454081"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-714"></a><a name="setRoleInferenceVars"><a href="TcTyDecls.html#setRoleInferenceVars"><span class="hs-identifier">setRoleInferenceVars</span></a></a><span> </span><a name="local-6989586621683454324"><a href="#local-6989586621683454324"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621683454325"><a href="#local-6989586621683454325"><span class="hs-identifier">thing</span></a></a><span>
</span><a name="line-715"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcTyDecls.html#RM"><span class="hs-identifier hs-var">RM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683454326"><a href="#local-6989586621683454326"><span class="hs-identifier">m_name</span></a></a><span> </span><a name="local-6989586621683454327"><a href="#local-6989586621683454327"><span class="hs-identifier">_vps</span></a></a><span> </span><a name="local-6989586621683454328"><a href="#local-6989586621683454328"><span class="hs-identifier">_nvps</span></a></a><span> </span><a name="local-6989586621683454329"><a href="#local-6989586621683454329"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-716"></a><span>    </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isJust</span><span> </span><span class="hs-identifier">m_name</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-717"></a><span>    </span><span class="hs-identifier">unRM</span><span> </span><a href="#local-6989586621683454325"><span class="hs-identifier hs-var">thing</span></a><span> </span><a href="#local-6989586621683454326"><span class="hs-identifier hs-var">m_name</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkVarEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621683454324"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;setRoleInferenceVars&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-718"></a><span>         </span><a href="#local-6989586621683454329"><span class="hs-identifier hs-var">state</span></a><span>
</span><a name="line-719"></a><span>
</span><a name="line-720"></a><span class="hs-identifier">getRoleEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcTyDecls.html#RoleM"><span class="hs-identifier hs-type">RoleM</span></a><span> </span><a href="TcTyDecls.html#RoleEnv"><span class="hs-identifier hs-type">RoleEnv</span></a><span>
</span><a name="line-721"></a><a name="getRoleEnv"><a href="TcTyDecls.html#getRoleEnv"><span class="hs-identifier">getRoleEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcTyDecls.html#RM"><span class="hs-identifier hs-var">RM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683454330"><a href="#local-6989586621683454330"><span class="hs-identifier">state</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcTyDecls.html#RIS"><span class="hs-identifier hs-var">RIS</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">role_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683454331"><a href="#local-6989586621683454331"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454331"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683454330"><span class="hs-identifier hs-var">state</span></a><span class="hs-special">)</span><span>
</span><a name="line-722"></a><span>
</span><a name="line-723"></a><span class="hs-identifier">getVarNs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcTyDecls.html#RoleM"><span class="hs-identifier hs-type">RoleM</span></a><span> </span><a href="TcTyDecls.html#VarPositions"><span class="hs-identifier hs-type">VarPositions</span></a><span>
</span><a name="line-724"></a><a name="getVarNs"><a href="TcTyDecls.html#getVarNs"><span class="hs-identifier">getVarNs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcTyDecls.html#RM"><span class="hs-identifier hs-var">RM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683454332"><a href="#local-6989586621683454332"><span class="hs-identifier">vps</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683454333"><a href="#local-6989586621683454333"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454332"><span class="hs-identifier hs-var">vps</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683454333"><span class="hs-identifier hs-var">state</span></a><span class="hs-special">)</span><span>
</span><a name="line-725"></a><span>
</span><a name="line-726"></a><span class="hs-identifier">getTyConName</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcTyDecls.html#RoleM"><span class="hs-identifier hs-type">RoleM</span></a><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-727"></a><a name="getTyConName"><a href="TcTyDecls.html#getTyConName"><span class="hs-identifier">getTyConName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcTyDecls.html#RM"><span class="hs-identifier hs-var">RM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683454334"><a href="#local-6989586621683454334"><span class="hs-identifier">m_name</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683454335"><a href="#local-6989586621683454335"><span class="hs-identifier">state</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-728"></a><span>                    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683454334"><span class="hs-identifier hs-var">m_name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-729"></a><span>                      </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;getTyConName&quot;</span><span>
</span><a name="line-730"></a><span>                      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683454336"><a href="#local-6989586621683454336"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454336"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683454335"><span class="hs-identifier hs-var">state</span></a><span class="hs-special">)</span><span>
</span><a name="line-731"></a><span>
</span><a name="line-732"></a><span class="hs-identifier">updateRoleEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Role</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#RoleM"><span class="hs-identifier hs-type">RoleM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-733"></a><a name="updateRoleEnv"><a href="TcTyDecls.html#updateRoleEnv"><span class="hs-identifier">updateRoleEnv</span></a></a><span> </span><a name="local-6989586621683454337"><a href="#local-6989586621683454337"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621683454338"><a href="#local-6989586621683454338"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-keyword">role</span><span>
</span><a name="line-734"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcTyDecls.html#RM"><span class="hs-identifier hs-var">RM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683454340"><a href="#local-6989586621683454340"><span class="hs-identifier">state</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcTyDecls.html#RIS"><span class="hs-identifier hs-var">RIS</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">role_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683454341"><a href="#local-6989586621683454341"><span class="hs-identifier">role_env</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-735"></a><span>         </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupNameEnv</span><span> </span><a href="#local-6989586621683454341"><span class="hs-identifier hs-var">role_env</span></a><span> </span><a href="#local-6989586621683454337"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-736"></a><span>           </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;updateRoleEnv&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683454337"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-737"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683454342"><a href="#local-6989586621683454342"><span class="hs-identifier">roles</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683454343"><a href="#local-6989586621683454343"><span class="hs-identifier">before</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683454344"><a href="#local-6989586621683454344"><span class="hs-identifier">old_role</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683454345"><a href="#local-6989586621683454345"><span class="hs-identifier">after</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitAt</span><span> </span><a href="#local-6989586621683454338"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621683454342"><span class="hs-identifier hs-var">roles</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-738"></a><span>                         </span><span class="hs-keyword">if</span><span> </span><span class="hs-keyword">role</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">ltRole</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683454344"><span class="hs-identifier hs-var">old_role</span></a><span>
</span><a name="line-739"></a><span>                         </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683454346"><a href="#local-6989586621683454346"><span class="hs-identifier">roles'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454343"><span class="hs-identifier hs-var">before</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-keyword">role</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683454345"><span class="hs-identifier hs-var">after</span></a><span>
</span><a name="line-740"></a><span>                                  </span><a name="local-6989586621683454347"><a href="#local-6989586621683454347"><span class="hs-identifier">role_env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendNameEnv</span><span> </span><a href="#local-6989586621683454341"><span class="hs-identifier hs-var">role_env</span></a><span> </span><a href="#local-6989586621683454337"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683454346"><span class="hs-identifier hs-var">roles'</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-741"></a><span>                              </span><a href="TcTyDecls.html#RIS"><span class="hs-identifier hs-var">RIS</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">role_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454347"><span class="hs-identifier hs-var">role_env'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">update</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-742"></a><span>                         </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621683454340"><span class="hs-identifier hs-var">state</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-743"></a><span>
</span><a name="line-744"></a><span>
</span><a name="line-745"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
                Building implicits
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-750"></a><span>
</span><a name="line-751"></a><span class="hs-identifier">addTyConsToGblEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyCon</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-752"></a><span class="hs-comment">-- Given a [TyCon], add to the TcGblEnv</span><span>
</span><a name="line-753"></a><span class="hs-comment">--   * extend the TypeEnv with the tycons</span><span>
</span><a name="line-754"></a><span class="hs-comment">--   * extend the TypeEnv with their implicitTyThings</span><span>
</span><a name="line-755"></a><span class="hs-comment">--   * extend the TypeEnv with any default method Ids</span><span>
</span><a name="line-756"></a><span class="hs-comment">--   * add bindings for record selectors</span><span>
</span><a name="line-757"></a><a name="addTyConsToGblEnv"><a href="TcTyDecls.html#addTyConsToGblEnv"><span class="hs-identifier">addTyConsToGblEnv</span></a></a><span> </span><a name="local-6989586621683454348"><a href="#local-6989586621683454348"><span class="hs-identifier">tyclss</span></a></a><span>
</span><a name="line-758"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#tcExtendTyConEnv"><span class="hs-identifier hs-var">tcExtendTyConEnv</span></a><span> </span><a href="#local-6989586621683454348"><span class="hs-identifier hs-var">tyclss</span></a><span>                    </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-759"></a><span>    </span><a href="TcEnv.html#tcExtendGlobalEnvImplicit"><span class="hs-identifier hs-var">tcExtendGlobalEnvImplicit</span></a><span> </span><a href="#local-6989586621683454349"><span class="hs-identifier hs-var">implicit_things</span></a><span>  </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-760"></a><span>    </span><a href="TcEnv.html#tcExtendGlobalValEnv"><span class="hs-identifier hs-var">tcExtendGlobalValEnv</span></a><span> </span><a href="#local-6989586621683454350"><span class="hs-identifier hs-var">def_meth_ids</span></a><span>          </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-761"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcAddTyCons&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">vcat</span><span>
</span><a name="line-762"></a><span>            </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;tycons&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683454348"><span class="hs-identifier hs-var">tyclss</span></a><span>
</span><a name="line-763"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;implicits&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683454349"><span class="hs-identifier hs-var">implicit_things</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-764"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683454351"><a href="#local-6989586621683454351"><span class="hs-identifier">gbl_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyDecls.html#tcRecSelBinds"><span class="hs-identifier hs-var">tcRecSelBinds</span></a><span> </span><span class="hs-special">(</span><a href="TcTyDecls.html#mkRecSelBinds"><span class="hs-identifier hs-var">mkRecSelBinds</span></a><span> </span><a href="#local-6989586621683454348"><span class="hs-identifier hs-var">tyclss</span></a><span class="hs-special">)</span><span>
</span><a name="line-765"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683454351"><span class="hs-identifier hs-var">gbl_env</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-766"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-767"></a><span>   </span><a name="local-6989586621683454349"><a href="#local-6989586621683454349"><span class="hs-identifier">implicit_things</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-identifier hs-var">implicitTyConThings</span><span> </span><a href="#local-6989586621683454348"><span class="hs-identifier hs-var">tyclss</span></a><span>
</span><a name="line-768"></a><span>   </span><a name="local-6989586621683454350"><a href="#local-6989586621683454350"><span class="hs-identifier">def_meth_ids</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="TcTyDecls.html#mkDefaultMethodIds"><span class="hs-identifier hs-var">mkDefaultMethodIds</span></a><span> </span><a href="#local-6989586621683454348"><span class="hs-identifier hs-var">tyclss</span></a><span>
</span><a name="line-769"></a><span>
</span><a name="line-770"></a><span class="hs-identifier">mkDefaultMethodIds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyCon</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>
</span><a name="line-771"></a><span class="hs-comment">-- We want to put the default-method Ids (both vanilla and generic)</span><span>
</span><a name="line-772"></a><span class="hs-comment">-- into the type environment so that they are found when we typecheck</span><span>
</span><a name="line-773"></a><span class="hs-comment">-- the filled-in default methods of each instance declaration</span><span>
</span><a name="line-774"></a><span class="hs-comment">-- See Note [Default method Ids and Template Haskell]</span><span>
</span><a name="line-775"></a><a name="mkDefaultMethodIds"><a href="TcTyDecls.html#mkDefaultMethodIds"><span class="hs-identifier">mkDefaultMethodIds</span></a></a><span> </span><a name="local-6989586621683454352"><a href="#local-6989586621683454352"><span class="hs-identifier">tycons</span></a></a><span>
</span><a name="line-776"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">mkExportedVanillaId</span><span> </span><a href="#local-6989586621683454356"><span class="hs-identifier hs-var">dm_name</span></a><span> </span><span class="hs-special">(</span><a href="TcTyDecls.html#mkDefaultMethodType"><span class="hs-identifier hs-var">mkDefaultMethodType</span></a><span> </span><a href="#local-6989586621683454354"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621683454355"><span class="hs-identifier hs-var">sel_id</span></a><span> </span><a href="#local-6989586621683454357"><span class="hs-identifier hs-var">dm_spec</span></a><span class="hs-special">)</span><span>
</span><a name="line-777"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683454353"><a href="#local-6989586621683454353"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683454352"><span class="hs-identifier hs-var">tycons</span></a><span>
</span><a name="line-778"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683454354"><a href="#local-6989586621683454354"><span class="hs-identifier">cls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">tyConClass_maybe</span><span> </span><a href="#local-6989586621683454353"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">]</span><span>
</span><a name="line-779"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683454355"><a href="#local-6989586621683454355"><span class="hs-identifier">sel_id</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683454356"><a href="#local-6989586621683454356"><span class="hs-identifier">dm_name</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683454357"><a href="#local-6989586621683454357"><span class="hs-identifier">dm_spec</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">classOpItems</span><span> </span><a href="#local-6989586621683454354"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-780"></a><span>
</span><a name="line-781"></a><span class="hs-identifier">mkDefaultMethodType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DefMethSpec</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-782"></a><span class="hs-comment">-- Returns the top-level type of the default method</span><span>
</span><a name="line-783"></a><a name="mkDefaultMethodType"><a href="TcTyDecls.html#mkDefaultMethodType"><span class="hs-identifier">mkDefaultMethodType</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683454358"><a href="#local-6989586621683454358"><span class="hs-identifier">sel_id</span></a></a><span> </span><span class="hs-identifier hs-var">VanillaDM</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683454358"><span class="hs-identifier hs-var">sel_id</span></a><span>
</span><a name="line-784"></a><span class="hs-identifier">mkDefaultMethodType</span><span> </span><a name="local-6989586621683454359"><a href="#local-6989586621683454359"><span class="hs-identifier">cls</span></a></a><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GenericDM</span><span> </span><a name="local-6989586621683454360"><a href="#local-6989586621683454360"><span class="hs-identifier">dm_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkSigmaTy</span><span> </span><a href="#local-6989586621683454363"><span class="hs-identifier hs-var">tv_bndrs</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683454361"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621683454360"><span class="hs-identifier hs-var">dm_ty</span></a><span>
</span><a name="line-785"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-786"></a><span>     </span><a name="local-6989586621683454361"><a href="#local-6989586621683454361"><span class="hs-identifier">pred</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkClassPred</span><span> </span><a href="#local-6989586621683454359"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarTys</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">binderVars</span><span> </span><a href="#local-6989586621683454362"><span class="hs-identifier hs-var">cls_bndrs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-787"></a><span>     </span><a name="local-6989586621683454362"><a href="#local-6989586621683454362"><span class="hs-identifier">cls_bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConBinders</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">classTyCon</span><span> </span><a href="#local-6989586621683454359"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-788"></a><span>     </span><a name="local-6989586621683454363"><a href="#local-6989586621683454363"><span class="hs-identifier">tv_bndrs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConTyVarBinders</span><span> </span><a href="#local-6989586621683454362"><span class="hs-identifier hs-var">cls_bndrs</span></a><span>
</span><a name="line-789"></a><span>     </span><span class="hs-comment">-- NB: the Class doesn't have TyConBinders; we reach into its</span><span>
</span><a name="line-790"></a><span>     </span><span class="hs-comment">--     TyCon to get those.  We /do/ need the TyConBinders because</span><span>
</span><a name="line-791"></a><span>     </span><span class="hs-comment">--     we need the correct visibility: these default methods are</span><span>
</span><a name="line-792"></a><span>     </span><span class="hs-comment">--     used in code generated by the fill-in for missing</span><span>
</span><a name="line-793"></a><span>     </span><span class="hs-comment">--     methods in instances (TcInstDcls.mkDefMethBind), and</span><span>
</span><a name="line-794"></a><span>     </span><span class="hs-comment">--     then typechecked.  So we need the right visibilty info</span><span>
</span><a name="line-795"></a><span>     </span><span class="hs-comment">--     (Trac #13998)</span><span>
</span><a name="line-796"></a><span>
</span><a name="line-797"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Building record selectors
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-804"></a><span>
</span><a name="line-805"></a><span class="hs-comment">{-
Note [Default method Ids and Template Haskell]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this (Trac #4169):
   class Numeric a where
     fromIntegerNum :: a
     fromIntegerNum = ...

   ast :: Q [Dec]
   ast = [d| instance Numeric Int |]

When we typecheck 'ast' we have done the first pass over the class decl
(in tcTyClDecls), but we have not yet typechecked the default-method
declarations (because they can mention value declarations).  So we
must bring the default method Ids into scope first (so they can be seen
when typechecking the [d| .. |] quote, and typecheck them later.
-}</span><span>
</span><a name="line-822"></a><span>
</span><a name="line-823"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Building record selectors
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-830"></a><span>
</span><a name="line-831"></a><span class="hs-identifier">tcRecSelBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">LHsBind</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-832"></a><a name="tcRecSelBinds"><a href="TcTyDecls.html#tcRecSelBinds"><span class="hs-identifier">tcRecSelBinds</span></a></a><span> </span><a name="local-6989586621683454364"><a href="#local-6989586621683454364"><span class="hs-identifier">sel_bind_prs</span></a></a><span>
</span><a name="line-833"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#tcExtendGlobalValEnv"><span class="hs-identifier hs-var">tcExtendGlobalValEnv</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683454370"><span class="hs-identifier hs-var">sel_id</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IdSig</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683454370"><a href="#local-6989586621683454370"><span class="hs-identifier">sel_id</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683454365"><span class="hs-identifier hs-var">sigs</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-834"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683454371"><a href="#local-6989586621683454371"><span class="hs-identifier">rec_sel_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683454372"><a href="#local-6989586621683454372"><span class="hs-identifier">tcg_env</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#discardWarnings"><span class="hs-identifier hs-var">discardWarnings</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-835"></a><span>                                     </span><a href="TcBinds.html#tcValBinds"><span class="hs-identifier hs-var">tcValBinds</span></a><span> </span><span class="hs-identifier hs-var">TopLevel</span><span> </span><a href="#local-6989586621683454366"><span class="hs-identifier hs-var">binds</span></a><span> </span><a href="#local-6989586621683454365"><span class="hs-identifier hs-var">sigs</span></a><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-836"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454372"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-special">`</span><a href="TcBinds.html#addTypecheckedBinds"><span class="hs-identifier hs-var">addTypecheckedBinds</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621683454371"><span class="hs-identifier hs-var">rec_sel_binds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-837"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-838"></a><span>    </span><a name="local-6989586621683454365"><a href="#local-6989586621683454365"><span class="hs-identifier">sigs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683454368"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IdSig</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621683454367"><span class="hs-identifier hs-var">sel_id</span></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683454367"><a href="#local-6989586621683454367"><span class="hs-identifier">sel_id</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683454364"><span class="hs-identifier hs-var">sel_bind_prs</span></a><span>
</span><a name="line-839"></a><span>                                          </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683454368"><a href="#local-6989586621683454368"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getSrcSpan</span><span> </span><a href="#local-6989586621683454367"><span class="hs-identifier hs-var">sel_id</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-840"></a><span>    </span><a name="local-6989586621683454366"><a href="#local-6989586621683454366"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRecursive</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unitBag</span><span> </span><a href="#local-6989586621683454369"><span class="hs-identifier hs-var">bind</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683454369"><a href="#local-6989586621683454369"><span class="hs-identifier">bind</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683454364"><span class="hs-identifier hs-var">sel_bind_prs</span></a><span class="hs-special">]</span><span>
</span><a name="line-841"></a><span>
</span><a name="line-842"></a><span class="hs-identifier">mkRecSelBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyCon</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">LHsBind</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-843"></a><span class="hs-comment">-- NB We produce *un-typechecked* bindings, rather like 'deriving'</span><span>
</span><a name="line-844"></a><span class="hs-comment">--    This makes life easier, because the later type checking will add</span><span>
</span><a name="line-845"></a><span class="hs-comment">--    all necessary type abstractions and applications</span><span>
</span><a name="line-846"></a><a name="mkRecSelBinds"><a href="TcTyDecls.html#mkRecSelBinds"><span class="hs-identifier">mkRecSelBinds</span></a></a><span> </span><a name="local-6989586621683454373"><a href="#local-6989586621683454373"><span class="hs-identifier">tycons</span></a></a><span>
</span><a name="line-847"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="TcTyDecls.html#mkRecSelBind"><span class="hs-identifier hs-var">mkRecSelBind</span></a><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454374"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">,</span><a href="#local-6989586621683454375"><span class="hs-identifier hs-var">fld</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683454374"><a href="#local-6989586621683454374"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683454373"><span class="hs-identifier hs-var">tycons</span></a><span>
</span><a name="line-848"></a><span>                                </span><span class="hs-special">,</span><span> </span><a name="local-6989586621683454375"><a href="#local-6989586621683454375"><span class="hs-identifier">fld</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tyConFieldLabels</span><span> </span><a href="#local-6989586621683454374"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-849"></a><span>
</span><a name="line-850"></a><span class="hs-identifier">mkRecSelBind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TyCon</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FieldLabel</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">LHsBind</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span>
</span><a name="line-851"></a><a name="mkRecSelBind"><a href="TcTyDecls.html#mkRecSelBind"><span class="hs-identifier">mkRecSelBind</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683454376"><a href="#local-6989586621683454376"><span class="hs-identifier">tycon</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683454377"><a href="#local-6989586621683454377"><span class="hs-identifier">fl</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-852"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcTyDecls.html#mkOneRecordSelector"><span class="hs-identifier hs-var">mkOneRecordSelector</span></a><span> </span><a href="#local-6989586621683454378"><span class="hs-identifier hs-var">all_cons</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecSelData</span><span> </span><a href="#local-6989586621683454376"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683454377"><span class="hs-identifier hs-var">fl</span></a><span>
</span><a name="line-853"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-854"></a><span>    </span><a name="local-6989586621683454378"><a href="#local-6989586621683454378"><span class="hs-identifier">all_cons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">RealDataCon</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConDataCons</span><span> </span><a href="#local-6989586621683454376"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span>
</span><a name="line-855"></a><span>
</span><a name="line-856"></a><span class="hs-identifier">mkOneRecordSelector</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ConLike</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RecSelParent</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FieldLabel</span><span>
</span><a name="line-857"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">LHsBind</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span>
</span><a name="line-858"></a><a name="mkOneRecordSelector"><a href="TcTyDecls.html#mkOneRecordSelector"><span class="hs-identifier">mkOneRecordSelector</span></a></a><span> </span><a name="local-6989586621683454379"><a href="#local-6989586621683454379"><span class="hs-identifier">all_cons</span></a></a><span> </span><a name="local-6989586621683454380"><a href="#local-6989586621683454380"><span class="hs-identifier">idDetails</span></a></a><span> </span><a name="local-6989586621683454381"><a href="#local-6989586621683454381"><span class="hs-identifier">fl</span></a></a><span>
</span><a name="line-859"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454385"><span class="hs-identifier hs-var">sel_id</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683454382"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683454397"><span class="hs-identifier hs-var">sel_bind</span></a><span class="hs-special">)</span><span>
</span><a name="line-860"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-861"></a><span>    </span><a name="local-6989586621683454382"><a href="#local-6989586621683454382"><span class="hs-identifier">loc</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getSrcSpan</span><span> </span><a href="#local-6989586621683454384"><span class="hs-identifier hs-var">sel_name</span></a><span>
</span><a name="line-862"></a><span>    </span><a name="local-6989586621683454383"><a href="#local-6989586621683454383"><span class="hs-identifier">lbl</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">flLabel</span><span> </span><a href="#local-6989586621683454381"><span class="hs-identifier hs-var">fl</span></a><span>
</span><a name="line-863"></a><span>    </span><a name="local-6989586621683454384"><a href="#local-6989586621683454384"><span class="hs-identifier">sel_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">flSelector</span><span> </span><a href="#local-6989586621683454381"><span class="hs-identifier hs-var">fl</span></a><span>
</span><a name="line-864"></a><span>
</span><a name="line-865"></a><span>    </span><a name="local-6989586621683454385"><a href="#local-6989586621683454385"><span class="hs-identifier">sel_id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkExportedLocalId</span><span> </span><a href="#local-6989586621683454386"><span class="hs-identifier hs-var">rec_details</span></a><span> </span><a href="#local-6989586621683454384"><span class="hs-identifier hs-var">sel_name</span></a><span> </span><a href="#local-6989586621683454396"><span class="hs-identifier hs-var">sel_ty</span></a><span>
</span><a name="line-866"></a><span>    </span><a name="local-6989586621683454386"><a href="#local-6989586621683454386"><span class="hs-identifier">rec_details</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">RecSelId</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sel_tycon</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454380"><span class="hs-identifier hs-var">idDetails</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sel_naughty</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683454392"><span class="hs-identifier hs-var">is_naughty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-867"></a><span>
</span><a name="line-868"></a><span>    </span><span class="hs-comment">-- Find a representative constructor, con1</span><span>
</span><a name="line-869"></a><span>    </span><a name="local-6989586621683454387"><a href="#local-6989586621683454387"><span class="hs-identifier">cons_w_field</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">conLikesWithFields</span><span> </span><a href="#local-6989586621683454379"><span class="hs-identifier hs-var">all_cons</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683454383"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">]</span><span>
</span><a name="line-870"></a><span>    </span><a name="local-6989586621683454388"><a href="#local-6989586621683454388"><span class="hs-identifier">con1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">null</span><span> </span><span class="hs-identifier">cons_w_field</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683454387"><span class="hs-identifier hs-var">head</span></a><span> </span><span class="hs-identifier">cons_w_field</span><span>
</span><a name="line-871"></a><span>
</span><a name="line-872"></a><span>    </span><span class="hs-comment">-- Selector type; Note [Polymorphic selectors]</span><span>
</span><a name="line-873"></a><span>    </span><a name="local-6989586621683454389"><a href="#local-6989586621683454389"><span class="hs-identifier">field_ty</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">conLikeFieldType</span><span> </span><a href="#local-6989586621683454388"><span class="hs-identifier hs-var">con1</span></a><span> </span><a href="#local-6989586621683454383"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-874"></a><span>    </span><a name="local-6989586621683454390"><a href="#local-6989586621683454390"><span class="hs-identifier">data_tvs</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyCoVarsOfTypesWellScoped</span><span> </span><a href="#local-6989586621683454411"><span class="hs-identifier hs-var">inst_tys</span></a><span>
</span><a name="line-875"></a><span>    </span><a name="local-6989586621683454391"><a href="#local-6989586621683454391"><span class="hs-identifier">data_tv_set</span></a></a><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkVarSet</span><span> </span><a href="#local-6989586621683454390"><span class="hs-identifier hs-var">data_tvs</span></a><span>
</span><a name="line-876"></a><span>    </span><a name="local-6989586621683454392"><a href="#local-6989586621683454392"><span class="hs-identifier">is_naughty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyCoVarsOfType</span><span> </span><a href="#local-6989586621683454389"><span class="hs-identifier hs-var">field_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">subVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683454391"><span class="hs-identifier hs-var">data_tv_set</span></a><span class="hs-special">)</span><span>
</span><a name="line-877"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621683454393"><a href="#local-6989586621683454393"><span class="hs-identifier">field_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683454394"><a href="#local-6989586621683454394"><span class="hs-identifier">field_theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683454395"><a href="#local-6989586621683454395"><span class="hs-identifier">field_tau</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitSigmaTy</span><span> </span><a href="#local-6989586621683454389"><span class="hs-identifier hs-var">field_ty</span></a><span>
</span><a name="line-878"></a><span>    </span><a name="local-6989586621683454396"><a href="#local-6989586621683454396"><span class="hs-identifier">sel_ty</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683454392"><span class="hs-identifier hs-var">is_naughty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unitTy</span><span>  </span><span class="hs-comment">-- See Note [Naughty record selectors]</span><span>
</span><a name="line-879"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkSpecForAllTys</span><span> </span><a href="#local-6989586621683454390"><span class="hs-identifier hs-var">data_tvs</span></a><span>          </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-880"></a><span>                          </span><span class="hs-identifier hs-var">mkPhiTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">conLikeStupidTheta</span><span> </span><a href="#local-6989586621683454388"><span class="hs-identifier hs-var">con1</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>   </span><span class="hs-comment">-- Urgh!</span><span>
</span><a name="line-881"></a><span>                          </span><span class="hs-identifier hs-var">mkFunTy</span><span> </span><a href="#local-6989586621683454409"><span class="hs-identifier hs-var">data_ty</span></a><span>                   </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-882"></a><span>                          </span><span class="hs-identifier hs-var">mkSpecForAllTys</span><span> </span><a href="#local-6989586621683454393"><span class="hs-identifier hs-var">field_tvs</span></a><span>         </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-883"></a><span>                          </span><span class="hs-identifier hs-var">mkPhiTy</span><span> </span><a href="#local-6989586621683454394"><span class="hs-identifier hs-var">field_theta</span></a><span>               </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-884"></a><span>                          </span><span class="hs-comment">-- req_theta is empty for normal DataCon</span><span>
</span><a name="line-885"></a><span>                          </span><span class="hs-identifier hs-var">mkPhiTy</span><span> </span><a href="#local-6989586621683454408"><span class="hs-identifier hs-var">req_theta</span></a><span>                 </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-886"></a><span>                          </span><a href="#local-6989586621683454395"><span class="hs-identifier hs-var">field_tau</span></a><span>
</span><a name="line-887"></a><span>
</span><a name="line-888"></a><span>    </span><span class="hs-comment">-- Make the binding: sel (C2 { fld = x }) = x</span><span>
</span><a name="line-889"></a><span>    </span><span class="hs-comment">--                   sel (C7 { fld = x }) = x</span><span>
</span><a name="line-890"></a><span>    </span><span class="hs-comment">--    where cons_w_field = [C2,C7]</span><span>
</span><a name="line-891"></a><span>    </span><a name="local-6989586621683454397"><a href="#local-6989586621683454397"><span class="hs-identifier">sel_bind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTopFunBind</span><span> </span><span class="hs-identifier hs-var">Generated</span><span> </span><a href="#local-6989586621683454402"><span class="hs-identifier hs-var">sel_lname</span></a><span> </span><a href="#local-6989586621683454414"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-892"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-893"></a><span>        </span><a name="local-6989586621683454414"><a href="#local-6989586621683454414"><span class="hs-identifier">alts</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683454392"><span class="hs-identifier hs-var">is_naughty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">mkSimpleMatch</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkPrefixFunRhs</span><span> </span><a href="#local-6989586621683454402"><span class="hs-identifier hs-var">sel_lname</span></a><span class="hs-special">)</span><span>
</span><a name="line-894"></a><span>                                           </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621683454412"><span class="hs-identifier hs-var">unit_rhs</span></a><span class="hs-special">]</span><span>
</span><a name="line-895"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621683454398"><span class="hs-identifier hs-var">mk_match</span></a><span> </span><a href="#local-6989586621683454387"><span class="hs-identifier hs-var">cons_w_field</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683454404"><span class="hs-identifier hs-var">deflt</span></a><span>
</span><a name="line-896"></a><span>    </span><a name="local-6989586621683454398"><a href="#local-6989586621683454398"><span class="hs-identifier">mk_match</span></a></a><span> </span><a name="local-6989586621683454415"><a href="#local-6989586621683454415"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkSimpleMatch</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkPrefixFunRhs</span><span> </span><a href="#local-6989586621683454402"><span class="hs-identifier hs-var">sel_lname</span></a><span class="hs-special">)</span><span>
</span><a name="line-897"></a><span>                                 </span><span class="hs-special">[</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683454382"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683454399"><span class="hs-identifier hs-var">mk_sel_pat</span></a><span> </span><a href="#local-6989586621683454415"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-898"></a><span>                                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683454382"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683454382"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683454403"><span class="hs-identifier hs-var">field_var</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-899"></a><span>    </span><a name="local-6989586621683454399"><a href="#local-6989586621683454399"><span class="hs-identifier">mk_sel_pat</span></a></a><span> </span><a name="local-6989586621683454416"><a href="#local-6989586621683454416"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ConPatIn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683454382"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621683454416"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecCon</span><span> </span><a href="#local-6989586621683454400"><span class="hs-identifier hs-var">rec_fields</span></a><span class="hs-special">)</span><span>
</span><a name="line-900"></a><span>    </span><a name="local-6989586621683454400"><a href="#local-6989586621683454400"><span class="hs-identifier">rec_fields</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HsRecFields</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rec_flds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683454401"><span class="hs-identifier hs-var">rec_field</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rec_dotdot</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-901"></a><span>    </span><a name="local-6989586621683454401"><a href="#local-6989586621683454401"><span class="hs-identifier">rec_field</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRecField</span><span>
</span><a name="line-902"></a><span>                        </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsRecFieldLbl</span><span>
</span><a name="line-903"></a><span>                           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683454382"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FieldOcc</span><span> </span><a href="#local-6989586621683454384"><span class="hs-identifier hs-var">sel_name</span></a><span>
</span><a name="line-904"></a><span>                                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683454382"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkVarUnqual</span><span> </span><a href="#local-6989586621683454383"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-905"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsRecFieldArg</span><span>
</span><a name="line-906"></a><span>                           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683454382"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarPat</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683454382"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683454403"><span class="hs-identifier hs-var">field_var</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-907"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsRecPun</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-908"></a><span>    </span><a name="local-6989586621683454402"><a href="#local-6989586621683454402"><span class="hs-identifier">sel_lname</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683454382"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683454384"><span class="hs-identifier hs-var">sel_name</span></a><span>
</span><a name="line-909"></a><span>    </span><a name="local-6989586621683454403"><a href="#local-6989586621683454403"><span class="hs-identifier">field_var</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkInternalName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkBuiltinUnique</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOccName</span><span> </span><a href="#local-6989586621683454384"><span class="hs-identifier hs-var">sel_name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683454382"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-910"></a><span>
</span><a name="line-911"></a><span>    </span><span class="hs-comment">-- Add catch-all default case unless the case is exhaustive</span><span>
</span><a name="line-912"></a><span>    </span><span class="hs-comment">-- We do this explicitly so that we get a nice error message that</span><span>
</span><a name="line-913"></a><span>    </span><span class="hs-comment">-- mentions this particular record selector</span><span>
</span><a name="line-914"></a><span>    </span><a name="local-6989586621683454404"><a href="#local-6989586621683454404"><span class="hs-identifier">deflt</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><a href="#local-6989586621683454405"><span class="hs-identifier hs-var">dealt_with</span></a><span> </span><a href="#local-6989586621683454379"><span class="hs-identifier hs-var">all_cons</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-915"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">mkSimpleMatch</span><span> </span><span class="hs-identifier hs-var">CaseAlt</span><span>
</span><a name="line-916"></a><span>                            </span><span class="hs-special">[</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683454382"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WildPat</span><span> </span><span class="hs-identifier hs-var">noExt</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-917"></a><span>                            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683454382"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-918"></a><span>                                         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683454382"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getName</span><span> </span><span class="hs-identifier hs-var">rEC_SEL_ERROR_ID</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-919"></a><span>                                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683454382"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsLit</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621683454413"><span class="hs-identifier hs-var">msg_lit</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-920"></a><span>
</span><a name="line-921"></a><span>        </span><span class="hs-comment">-- Do not add a default case unless there are unmatched</span><span>
</span><a name="line-922"></a><span>        </span><span class="hs-comment">-- constructors.  We must take account of GADTs, else we</span><span>
</span><a name="line-923"></a><span>        </span><span class="hs-comment">-- get overlap warning messages from the pattern-match checker</span><span>
</span><a name="line-924"></a><span>        </span><span class="hs-comment">-- NB: we need to pass type args for the *representation* TyCon</span><span>
</span><a name="line-925"></a><span>        </span><span class="hs-comment">--     to dataConCannotMatch, hence the calculation of inst_tys</span><span>
</span><a name="line-926"></a><span>        </span><span class="hs-comment">--     This matters in data families</span><span>
</span><a name="line-927"></a><span>        </span><span class="hs-comment">--              data instance T Int a where</span><span>
</span><a name="line-928"></a><span>        </span><span class="hs-comment">--                 A :: { fld :: Int } -&gt; T Int Bool</span><span>
</span><a name="line-929"></a><span>        </span><span class="hs-comment">--                 B :: { fld :: Int } -&gt; T Int Char</span><span>
</span><a name="line-930"></a><span>    </span><span class="hs-identifier">dealt_with</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ConLike</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-931"></a><span>    </span><a name="local-6989586621683454405"><a href="#local-6989586621683454405"><span class="hs-identifier">dealt_with</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PatSynCon</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-comment">-- We can't predict overlap</span><span>
</span><a name="line-932"></a><span>    </span><span class="hs-identifier">dealt_with</span><span> </span><a name="local-6989586621683454417"><a href="#local-6989586621683454417"><span class="hs-identifier">con</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealDataCon</span><span> </span><a name="local-6989586621683454418"><a href="#local-6989586621683454418"><span class="hs-identifier">dc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-933"></a><span>      </span><a href="#local-6989586621683454417"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683454387"><span class="hs-identifier hs-var">cons_w_field</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">dataConCannotMatch</span><span> </span><a href="#local-6989586621683454411"><span class="hs-identifier hs-var">inst_tys</span></a><span> </span><a href="#local-6989586621683454418"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-934"></a><span>
</span><a name="line-935"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621683454406"><a href="#local-6989586621683454406"><span class="hs-identifier">univ_tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683454407"><a href="#local-6989586621683454407"><span class="hs-identifier">eq_spec</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683454408"><a href="#local-6989586621683454408"><span class="hs-identifier">req_theta</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683454409"><a href="#local-6989586621683454409"><span class="hs-identifier">data_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">conLikeFullSig</span><span> </span><a href="#local-6989586621683454388"><span class="hs-identifier hs-var">con1</span></a><span>
</span><a name="line-936"></a><span>
</span><a name="line-937"></a><span>    </span><a name="local-6989586621683454410"><a href="#local-6989586621683454410"><span class="hs-identifier">eq_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTvSubstPrs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">eqSpecPair</span><span> </span><a href="#local-6989586621683454407"><span class="hs-identifier hs-var">eq_spec</span></a><span class="hs-special">)</span><span>
</span><a name="line-938"></a><span>    </span><a name="local-6989586621683454411"><a href="#local-6989586621683454411"><span class="hs-identifier">inst_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTyVars</span><span> </span><a href="#local-6989586621683454410"><span class="hs-identifier hs-var">eq_subst</span></a><span> </span><a href="#local-6989586621683454406"><span class="hs-identifier hs-var">univ_tvs</span></a><span>
</span><a name="line-939"></a><span>
</span><a name="line-940"></a><span>    </span><a name="local-6989586621683454412"><a href="#local-6989586621683454412"><span class="hs-identifier">unit_rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkLHsTupleExpr</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-941"></a><span>    </span><a name="local-6989586621683454413"><a href="#local-6989586621683454413"><span class="hs-identifier">msg_lit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HsStringPrim</span><span> </span><span class="hs-identifier hs-var">NoSourceText</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fastStringToByteString</span><span> </span><a href="#local-6989586621683454383"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-942"></a><span>
</span><a name="line-943"></a><span class="hs-comment">{-
Note [Polymorphic selectors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We take care to build the type of a polymorphic selector in the right
order, so that visible type application works.

  data Ord a =&gt; T a = MkT { field :: forall b. (Num a, Show b) =&gt; (a, b) }

We want

  field :: forall a. Ord a =&gt; T a -&gt; forall b. (Num a, Show b) =&gt; (a, b)

Note [Naughty record selectors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
A &quot;naughty&quot; field is one for which we can't define a record
selector, because an existential type variable would escape.  For example:
        data T = forall a. MkT { x,y::a }
We obviously can't define
        x (MkT v _) = v
Nevertheless we *do* put a RecSelId into the type environment
so that if the user tries to use 'x' as a selector we can bleat
helpfully, rather than saying unhelpfully that 'x' is not in scope.
Hence the sel_naughty flag, to identify record selectors that don't really exist.

In general, a field is &quot;naughty&quot; if its type mentions a type variable that
isn't in the result type of the constructor.  Note that this *allows*
GADT record selectors (Note [GADT record selectors]) whose types may look
like     sel :: T [a] -&gt; a

For naughty selectors we make a dummy binding
   sel = ()
so that the later type-check will add them to the environment, and they'll be
exported.  The function is never called, because the typechecker spots the
sel_naughty field.

Note [GADT record selectors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For GADTs, we require that all constructors with a common field 'f' have the same
result type (modulo alpha conversion).  [Checked in TcTyClsDecls.checkValidTyCon]
E.g.
        data T where
          T1 { f :: Maybe a } :: T [a]
          T2 { f :: Maybe a, y :: b  } :: T [a]
          T3 :: T Int

and now the selector takes that result type as its argument:
   f :: forall a. T [a] -&gt; Maybe a

Details: the &quot;real&quot; types of T1,T2 are:
   T1 :: forall r a.   (r~[a]) =&gt; a -&gt; T r
   T2 :: forall r a b. (r~[a]) =&gt; a -&gt; b -&gt; T r

So the selector loooks like this:
   f :: forall a. T [a] -&gt; Maybe a
   f (a:*) (t:T [a])
     = case t of
         T1 c   (g:[a]~[c]) (v:Maybe c)       -&gt; v `cast` Maybe (right (sym g))
         T2 c d (g:[a]~[c]) (v:Maybe c) (w:d) -&gt; v `cast` Maybe (right (sym g))
         T3 -&gt; error &quot;T3 does not have field f&quot;

Note the forall'd tyvars of the selector are just the free tyvars
of the result type; there may be other tyvars in the constructor's
type (e.g. 'b' in T2).

Note the need for casts in the result!

Note [Selector running example]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's OK to combine GADTs and type families.  Here's a running example:

        data instance T [a] where
          T1 { fld :: b } :: T [Maybe b]

The representation type looks like this
        data :R7T a where
          T1 { fld :: b } :: :R7T (Maybe b)

and there's coercion from the family type to the representation type
        :CoR7T a :: T [a] ~ :R7T a

The selector we want for fld looks like this:

        fld :: forall b. T [Maybe b] -&gt; b
        fld = /\b. \(d::T [Maybe b]).
              case d `cast` :CoR7T (Maybe b) of
                T1 (x::b) -&gt; x

The scrutinee of the case has type :R7T (Maybe b), which can be
gotten by appying the eq_spec to the univ_tvs of the data con.

-}</span><span>
</span><a name="line-1034"></a></pre></body></html>