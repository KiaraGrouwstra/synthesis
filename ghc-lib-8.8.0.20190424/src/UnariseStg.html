<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The GRASP/AQUA Project, Glasgow University, 1992-2012

Note [Unarisation]
~~~~~~~~~~~~~~~~~~
The idea of this pass is to translate away *all* unboxed-tuple and unboxed-sum
binders. So for example:

  f (x :: (# Int, Bool #)) = f x + f (# 1, True #)

  ==&gt;

  f (x1 :: Int) (x2 :: Bool) = f x1 x2 + f 1 True

It is important that we do this at the STG level and NOT at the Core level
because it would be very hard to make this pass Core-type-preserving. In this
example the type of 'f' changes, for example.

STG fed to the code generators *must* be unarised because the code generators do
not support unboxed tuple and unboxed sum binders natively.

In more detail: (see next note for unboxed sums)

Suppose that a variable x : (# t1, t2 #).

  * At the binding site for x, make up fresh vars  x1:t1, x2:t2

  * Extend the UnariseEnv   x :-&gt; MultiVal [x1,x2]

  * Replace the binding with a curried binding for x1,x2

       Lambda:   \x.e                ==&gt;   \x1 x2. e
       Case alt: MkT a b x c d -&gt; e  ==&gt;   MkT a b x1 x2 c d -&gt; e

  * Replace argument occurrences with a sequence of args via a lookup in
    UnariseEnv

       f a b x c d   ==&gt;   f a b x1 x2 c d

  * Replace tail-call occurrences with an unboxed tuple via a lookup in
    UnariseEnv

       x  ==&gt;  (# x1, x2 #)

    So, for example

       f x = x    ==&gt;   f x1 x2 = (# x1, x2 #)

  * We /always/ eliminate a case expression when

       - It scrutinises an unboxed tuple or unboxed sum

       - The scrutinee is a variable (or when it is an explicit tuple, but the
         simplifier eliminates those)

    The case alternative (there can be only one) can be one of these two
    things:

      - An unboxed tuple pattern. e.g.

          case v of x { (# x1, x2, x3 #) -&gt; ... }

        Scrutinee has to be in form `(# t1, t2, t3 #)` so we just extend the
        environment with

          x :-&gt; MultiVal [t1,t2,t3]
          x1 :-&gt; UnaryVal t1, x2 :-&gt; UnaryVal t2, x3 :-&gt; UnaryVal t3

      - A DEFAULT alternative. Just the same, without the bindings for x1,x2,x3

By the end of this pass, we only have unboxed tuples in return positions.
Unboxed sums are completely eliminated, see next note.

Note [Translating unboxed sums to unboxed tuples]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Unarise also eliminates unboxed sum binders, and translates unboxed sums in
return positions to unboxed tuples. We want to overlap fields of a sum when
translating it to a tuple to have efficient memory layout. When translating a
sum pattern to a tuple pattern, we need to translate it so that binders of sum
alternatives will be mapped to right arguments after the term translation. So
translation of sum DataCon applications to tuple DataCon applications and
translation of sum patterns to tuple patterns need to be in sync.

These translations work like this. Suppose we have

  (# x1 | | ... #) :: (# t1 | t2 | ... #)

remember that t1, t2 ... can be sums and tuples too. So we first generate
layouts of those. Then we &quot;merge&quot; layouts of each alternative, which gives us a
sum layout with best overlapping possible.

Layout of a flat type 'ty1' is just [ty1].
Layout of a tuple is just concatenation of layouts of its fields.

For layout of a sum type,

  - We first get layouts of all alternatives.
  - We sort these layouts based on their &quot;slot types&quot;.
  - We merge all the alternatives.

For example, say we have (# (# Int#, Char #) | (# Int#, Int# #) | Int# #)

  - Layouts of alternatives: [ [Word, Ptr], [Word, Word], [Word] ]
  - Sorted: [ [Ptr, Word], [Word, Word], [Word] ]
  - Merge all alternatives together: [ Ptr, Word, Word ]

We add a slot for the tag to the first position. So our tuple type is

  (# Tag#, Any, Word#, Word# #)
  (we use Any for pointer slots)

Now, any term of this sum type needs to generate a tuple of this type instead.
The translation works by simply putting arguments to first slots that they fit
in. Suppose we had

  (# (# 42#, 'c' #) | | #)

42# fits in Word#, 'c' fits in Any, so we generate this application:

  (# 1#, 'c', 42#, rubbish #)

Another example using the same type: (# | (# 2#, 3# #) | #). 2# fits in Word#,
3# fits in Word #, so we get:

  (# 2#, rubbish, 2#, 3# #).

Note [Types in StgConApp]
~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have this unboxed sum term:

  (# 123 | #)

What will be the unboxed tuple representation? We can't tell without knowing the
type of this term. For example, these are all valid tuples for this:

  (# 1#, 123 #)          -- when type is (# Int | String #)
  (# 1#, 123, rubbish #) -- when type is (# Int | Float# #)
  (# 1#, 123, rubbish, rubbish #)
                         -- when type is (# Int | (# Int, Int, Int #) #)

So we pass type arguments of the DataCon's TyCon in StgConApp to decide what
layout to use. Note that unlifted values can't be let-bound, so we don't need
types in StgRhsCon.

Note [UnariseEnv can map to literals]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
To avoid redundant case expressions when unarising unboxed sums, UnariseEnv
needs to map variables to literals too. Suppose we have this Core:

  f (# x | #)

  ==&gt; (CorePrep)

  case (# x | #) of y {
    _ -&gt; f y
  }

  ==&gt; (MultiVal)

  case (# 1#, x #) of [x1, x2] {
    _ -&gt; f x1 x2
  }

To eliminate this case expression we need to map x1 to 1# in UnariseEnv:

  x1 :-&gt; UnaryVal 1#, x2 :-&gt; UnaryVal x

so that `f x1 x2` becomes `f 1# x`.

Note [Unarisation and arity]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Because of unarisation, the arity that will be recorded in the generated info
table for an Id may be larger than the idArity. Instead we record what we call
the RepArity, which is the Arity taking into account any expanded arguments, and
corresponds to the number of (possibly-void) *registers* arguments will arrive
in.

Note [Post-unarisation invariants]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
STG programs after unarisation have these invariants:

  * No unboxed sums at all.

  * No unboxed tuple binders. Tuples only appear in return position.

  * DataCon applications (StgRhsCon and StgConApp) don't have void arguments.
    This means that it's safe to wrap `StgArg`s of DataCon applications with
    `StgCmmEnv.NonVoid`, for example.

  * Alt binders (binders in patterns) are always non-void.
-}</span><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span class="hs-pragma">{-# LANGUAGE CPP, TupleSections #-}</span><span>
</span><a name="line-194"></a><span>
</span><a name="line-195"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">UnariseStg</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#unarise"><span class="hs-identifier hs-var">unarise</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-196"></a><span>
</span><a name="line-197"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-199"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-200"></a><span>
</span><a name="line-201"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-202"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreSyn</span><span>
</span><a name="line-203"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span>
</span><a name="line-204"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">FastString</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkFastString</span><span class="hs-special">)</span><span>
</span><a name="line-205"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-206"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Literal</span><span>
</span><a name="line-207"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MkCore</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">aBSENT_SUM_FIELD_ERROR_ID</span><span class="hs-special">)</span><span>
</span><a name="line-208"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MkId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">voidPrimId</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">voidArgId</span><span class="hs-special">)</span><span>
</span><a name="line-209"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MonadUtils</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapAccumLM</span><span class="hs-special">)</span><span>
</span><a name="line-210"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-211"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RepType</span><span>
</span><a name="line-212"></a><span class="hs-keyword">import</span><span> </span><a href="StgSyn.html"><span class="hs-identifier">StgSyn</span></a><span>
</span><a name="line-213"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-214"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysPrim</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">intPrimTy</span><span class="hs-special">,</span><span class="hs-identifier hs-var">wordPrimTy</span><span class="hs-special">,</span><span class="hs-identifier hs-var">word64PrimTy</span><span class="hs-special">)</span><span>
</span><a name="line-215"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysWiredIn</span><span>
</span><a name="line-216"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSupply</span><span>
</span><a name="line-217"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-218"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarEnv</span><span>
</span><a name="line-219"></a><span>
</span><a name="line-220"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Bifunctor</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">second</span><span class="hs-special">)</span><span>
</span><a name="line-221"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapMaybe</span><span class="hs-special">)</span><span>
</span><a name="line-222"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.IntMap</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">IM</span><span>
</span><a name="line-223"></a><span>
</span><a name="line-224"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-225"></a><span>
</span><a name="line-226"></a><span class="hs-comment">-- | A mapping from binders to the Ids they were expanded/renamed to.</span><span>
</span><a name="line-227"></a><span class="hs-comment">--</span><span>
</span><a name="line-228"></a><span class="hs-comment">--   x :-&gt; MultiVal [a,b,c] in rho</span><span>
</span><a name="line-229"></a><span class="hs-comment">--</span><span>
</span><a name="line-230"></a><span class="hs-comment">-- iff  x's typePrimRep is not a singleton, or equivalently</span><span>
</span><a name="line-231"></a><span class="hs-comment">--      x's type is an unboxed tuple, sum or void.</span><span>
</span><a name="line-232"></a><span class="hs-comment">--</span><span>
</span><a name="line-233"></a><span class="hs-comment">--    x :-&gt; UnaryVal x'</span><span>
</span><a name="line-234"></a><span class="hs-comment">--</span><span>
</span><a name="line-235"></a><span class="hs-comment">-- iff x's RepType is UnaryRep or equivalently</span><span>
</span><a name="line-236"></a><span class="hs-comment">--     x's type is not unboxed tuple, sum or void.</span><span>
</span><a name="line-237"></a><span class="hs-comment">--</span><span>
</span><a name="line-238"></a><span class="hs-comment">-- So</span><span>
</span><a name="line-239"></a><span class="hs-comment">--     x :-&gt; MultiVal [a] in rho</span><span>
</span><a name="line-240"></a><span class="hs-comment">-- means x is represented by singleton tuple.</span><span>
</span><a name="line-241"></a><span class="hs-comment">--</span><span>
</span><a name="line-242"></a><span class="hs-comment">--     x :-&gt; MultiVal [] in rho</span><span>
</span><a name="line-243"></a><span class="hs-comment">-- means x is void.</span><span>
</span><a name="line-244"></a><span class="hs-comment">--</span><span>
</span><a name="line-245"></a><span class="hs-comment">-- INVARIANT: OutStgArgs in the range only have NvUnaryTypes</span><span>
</span><a name="line-246"></a><span class="hs-comment">--            (i.e. no unboxed tuples, sums or voids)</span><span>
</span><a name="line-247"></a><span class="hs-comment">--</span><span>
</span><a name="line-248"></a><span class="hs-keyword">type</span><span> </span><a name="UnariseEnv"><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier">UnariseEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">VarEnv</span><span> </span><a href="UnariseStg.html#UnariseVal"><span class="hs-identifier hs-type">UnariseVal</span></a><span>
</span><a name="line-249"></a><span>
</span><a name="line-250"></a><span class="hs-keyword">data</span><span> </span><a name="UnariseVal"><a href="UnariseStg.html#UnariseVal"><span class="hs-identifier">UnariseVal</span></a></a><span>
</span><a name="line-251"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="MultiVal"><a href="UnariseStg.html#MultiVal"><span class="hs-identifier">MultiVal</span></a></a><span> </span><span class="hs-special">[</span><a href="StgSyn.html#OutStgArg"><span class="hs-identifier hs-type">OutStgArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- MultiVal to tuple. Can be empty list (void).</span><span>
</span><a name="line-252"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="UnaryVal"><a href="UnariseStg.html#UnaryVal"><span class="hs-identifier">UnaryVal</span></a></a><span> </span><a href="StgSyn.html#OutStgArg"><span class="hs-identifier hs-type">OutStgArg</span></a><span>   </span><span class="hs-comment">-- See NOTE [Renaming during unarisation].</span><span>
</span><a name="line-253"></a><span>
</span><a name="line-254"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="UnariseStg.html#UnariseVal"><span class="hs-identifier hs-type">UnariseVal</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-255"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#MultiVal"><span class="hs-identifier hs-var">MultiVal</span></a><span> </span><a name="local-6989586621684273023"><a href="#local-6989586621684273023"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;MultiVal&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684273023"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-256"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#UnaryVal"><span class="hs-identifier hs-var">UnaryVal</span></a><span> </span><a name="local-6989586621684273024"><a href="#local-6989586621684273024"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;UnaryVal&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684273024"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-257"></a><span>
</span><a name="line-258"></a><span class="hs-comment">-- | Extend the environment, checking the UnariseEnv invariant.</span><span>
</span><a name="line-259"></a><span class="hs-identifier">extendRho</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnariseStg.html#UnariseVal"><span class="hs-identifier hs-type">UnariseVal</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span>
</span><a name="line-260"></a><a name="extendRho"><a href="UnariseStg.html#extendRho"><span class="hs-identifier">extendRho</span></a></a><span> </span><a name="local-6989586621684273025"><a href="#local-6989586621684273025"><span class="hs-identifier">rho</span></a></a><span> </span><a name="local-6989586621684273026"><a href="#local-6989586621684273026"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#MultiVal"><span class="hs-identifier hs-var">MultiVal</span></a><span> </span><a name="local-6989586621684273027"><a href="#local-6989586621684273027"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-261"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isNvUnaryType</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">stgArgType</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">args</span><span class="hs-special">)</span><span>
</span><a name="line-262"></a><span>    </span><span class="hs-identifier hs-var">extendVarEnv</span><span> </span><a href="#local-6989586621684273025"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273026"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#MultiVal"><span class="hs-identifier hs-var">MultiVal</span></a><span> </span><a href="#local-6989586621684273027"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-263"></a><span class="hs-identifier">extendRho</span><span> </span><a name="local-6989586621684273028"><a href="#local-6989586621684273028"><span class="hs-identifier">rho</span></a></a><span> </span><a name="local-6989586621684273029"><a href="#local-6989586621684273029"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#UnaryVal"><span class="hs-identifier hs-var">UnaryVal</span></a><span> </span><a name="local-6989586621684273030"><a href="#local-6989586621684273030"><span class="hs-identifier">val</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-264"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier">isNvUnaryType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">stgArgType</span><span> </span><span class="hs-identifier">val</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-265"></a><span>    </span><span class="hs-identifier hs-var">extendVarEnv</span><span> </span><a href="#local-6989586621684273028"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273029"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#UnaryVal"><span class="hs-identifier hs-var">UnaryVal</span></a><span> </span><a href="#local-6989586621684273030"><span class="hs-identifier hs-var">val</span></a><span class="hs-special">)</span><span>
</span><a name="line-266"></a><span>
</span><a name="line-267"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-268"></a><span>
</span><a name="line-269"></a><span class="hs-identifier">unarise</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgTopBinding"><span class="hs-identifier hs-type">StgTopBinding</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgTopBinding"><span class="hs-identifier hs-type">StgTopBinding</span></a><span class="hs-special">]</span><span>
</span><a name="line-270"></a><a name="unarise"><a href="UnariseStg.html#unarise"><span class="hs-identifier">unarise</span></a></a><span> </span><a name="local-6989586621684273031"><a href="#local-6989586621684273031"><span class="hs-identifier">us</span></a></a><span> </span><a name="local-6989586621684273032"><a href="#local-6989586621684273032"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">initUs_</span><span> </span><a href="#local-6989586621684273031"><span class="hs-identifier hs-var">us</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#unariseTopBinding"><span class="hs-identifier hs-var">unariseTopBinding</span></a><span> </span><span class="hs-identifier hs-var">emptyVarEnv</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684273032"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-271"></a><span>
</span><a name="line-272"></a><span class="hs-identifier">unariseTopBinding</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#StgTopBinding"><span class="hs-identifier hs-type">StgTopBinding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><a href="StgSyn.html#StgTopBinding"><span class="hs-identifier hs-type">StgTopBinding</span></a><span>
</span><a name="line-273"></a><a name="unariseTopBinding"><a href="UnariseStg.html#unariseTopBinding"><span class="hs-identifier">unariseTopBinding</span></a></a><span> </span><a name="local-6989586621684273033"><a href="#local-6989586621684273033"><span class="hs-identifier">rho</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgTopLifted"><span class="hs-identifier hs-var">StgTopLifted</span></a><span> </span><a name="local-6989586621684273034"><a href="#local-6989586621684273034"><span class="hs-identifier">bind</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-274"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgTopLifted"><span class="hs-identifier hs-var">StgTopLifted</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="UnariseStg.html#unariseBinding"><span class="hs-identifier hs-var">unariseBinding</span></a><span> </span><a href="#local-6989586621684273033"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273034"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-275"></a><span class="hs-identifier">unariseTopBinding</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684273035"><a href="#local-6989586621684273035"><span class="hs-identifier">bind</span></a></a><span class="hs-glyph">@</span><a href="StgSyn.html#StgTopStringLit"><span class="hs-identifier hs-var">StgTopStringLit</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684273035"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-276"></a><span>
</span><a name="line-277"></a><span class="hs-identifier">unariseBinding</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#StgBinding"><span class="hs-identifier hs-type">StgBinding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><a href="StgSyn.html#StgBinding"><span class="hs-identifier hs-type">StgBinding</span></a><span>
</span><a name="line-278"></a><a name="unariseBinding"><a href="UnariseStg.html#unariseBinding"><span class="hs-identifier">unariseBinding</span></a></a><span> </span><a name="local-6989586621684273036"><a href="#local-6989586621684273036"><span class="hs-identifier">rho</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgNonRec"><span class="hs-identifier hs-var">StgNonRec</span></a><span> </span><a name="local-6989586621684273037"><a href="#local-6989586621684273037"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621684273038"><a href="#local-6989586621684273038"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-279"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgNonRec"><span class="hs-identifier hs-var">StgNonRec</span></a><span> </span><a href="#local-6989586621684273037"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="UnariseStg.html#unariseRhs"><span class="hs-identifier hs-var">unariseRhs</span></a><span> </span><a href="#local-6989586621684273036"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273038"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-280"></a><span class="hs-identifier">unariseBinding</span><span> </span><a name="local-6989586621684273039"><a href="#local-6989586621684273039"><span class="hs-identifier">rho</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRec"><span class="hs-identifier hs-var">StgRec</span></a><span> </span><a name="local-6989586621684273040"><a href="#local-6989586621684273040"><span class="hs-identifier">xrhss</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-281"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgRec"><span class="hs-identifier hs-var">StgRec</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621684273041"><a href="#local-6989586621684273041"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684273042"><a href="#local-6989586621684273042"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684273041"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="UnariseStg.html#unariseRhs"><span class="hs-identifier hs-var">unariseRhs</span></a><span> </span><a href="#local-6989586621684273039"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273042"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684273040"><span class="hs-identifier hs-var">xrhss</span></a><span>
</span><a name="line-282"></a><span>
</span><a name="line-283"></a><span class="hs-identifier">unariseRhs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#StgRhs"><span class="hs-identifier hs-type">StgRhs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><a href="StgSyn.html#StgRhs"><span class="hs-identifier hs-type">StgRhs</span></a><span>
</span><a name="line-284"></a><a name="unariseRhs"><a href="UnariseStg.html#unariseRhs"><span class="hs-identifier">unariseRhs</span></a></a><span> </span><a name="local-6989586621684273043"><a href="#local-6989586621684273043"><span class="hs-identifier">rho</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRhsClosure"><span class="hs-identifier hs-var">StgRhsClosure</span></a><span> </span><a name="local-6989586621684273044"><a href="#local-6989586621684273044"><span class="hs-identifier">ext</span></a></a><span> </span><a name="local-6989586621684273045"><a href="#local-6989586621684273045"><span class="hs-identifier">ccs</span></a></a><span> </span><a name="local-6989586621684273046"><a href="#local-6989586621684273046"><span class="hs-identifier">update_flag</span></a></a><span> </span><a name="local-6989586621684273047"><a href="#local-6989586621684273047"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621684273048"><a href="#local-6989586621684273048"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-285"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684273049"><a href="#local-6989586621684273049"><span class="hs-identifier">rho'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684273050"><a href="#local-6989586621684273050"><span class="hs-identifier">args1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UnariseStg.html#unariseFunArgBinders"><span class="hs-identifier hs-var">unariseFunArgBinders</span></a><span> </span><a href="#local-6989586621684273043"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273047"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-286"></a><span>       </span><a name="local-6989586621684273051"><a href="#local-6989586621684273051"><span class="hs-identifier">expr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UnariseStg.html#unariseExpr"><span class="hs-identifier hs-var">unariseExpr</span></a><span> </span><a href="#local-6989586621684273049"><span class="hs-identifier hs-var">rho'</span></a><span> </span><a href="#local-6989586621684273048"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-287"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRhsClosure"><span class="hs-identifier hs-var">StgRhsClosure</span></a><span> </span><a href="#local-6989586621684273044"><span class="hs-identifier hs-var">ext</span></a><span> </span><a href="#local-6989586621684273045"><span class="hs-identifier hs-var">ccs</span></a><span> </span><a href="#local-6989586621684273046"><span class="hs-identifier hs-var">update_flag</span></a><span> </span><a href="#local-6989586621684273050"><span class="hs-identifier hs-var">args1</span></a><span> </span><a href="#local-6989586621684273051"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">)</span><span>
</span><a name="line-288"></a><span>
</span><a name="line-289"></a><span class="hs-identifier">unariseRhs</span><span> </span><a name="local-6989586621684273052"><a href="#local-6989586621684273052"><span class="hs-identifier">rho</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRhsCon"><span class="hs-identifier hs-var">StgRhsCon</span></a><span> </span><a name="local-6989586621684273053"><a href="#local-6989586621684273053"><span class="hs-identifier">ccs</span></a></a><span> </span><a name="local-6989586621684273054"><a href="#local-6989586621684273054"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-6989586621684273055"><a href="#local-6989586621684273055"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-290"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isUnboxedTupleCon</span><span> </span><span class="hs-identifier hs-var">con</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier">isUnboxedSumCon</span><span> </span><span class="hs-identifier hs-var">con</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-291"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRhsCon"><span class="hs-identifier hs-var">StgRhsCon</span></a><span> </span><a href="#local-6989586621684273053"><span class="hs-identifier hs-var">ccs</span></a><span> </span><a href="#local-6989586621684273054"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#unariseConArgs"><span class="hs-identifier hs-var">unariseConArgs</span></a><span> </span><a href="#local-6989586621684273052"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273055"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-292"></a><span>
</span><a name="line-293"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-294"></a><span>
</span><a name="line-295"></a><span class="hs-identifier">unariseExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#StgExpr"><span class="hs-identifier hs-type">StgExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><a href="StgSyn.html#StgExpr"><span class="hs-identifier hs-type">StgExpr</span></a><span>
</span><a name="line-296"></a><span>
</span><a name="line-297"></a><a name="unariseExpr"><a href="UnariseStg.html#unariseExpr"><span class="hs-identifier">unariseExpr</span></a></a><span> </span><a name="local-6989586621684273056"><a href="#local-6989586621684273056"><span class="hs-identifier">rho</span></a></a><span> </span><a name="local-6989586621684273057"><a href="#local-6989586621684273057"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="StgSyn.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a><span> </span><a name="local-6989586621684273058"><a href="#local-6989586621684273058"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-298"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupVarEnv</span><span> </span><a href="#local-6989586621684273056"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273058"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-299"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#MultiVal"><span class="hs-identifier hs-var">MultiVal</span></a><span> </span><a name="local-6989586621684273059"><a href="#local-6989586621684273059"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Including empty tuples</span><span>
</span><a name="line-300"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#mkTuple"><span class="hs-identifier hs-var">mkTuple</span></a><span> </span><a href="#local-6989586621684273059"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-301"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#UnaryVal"><span class="hs-identifier hs-var">UnaryVal</span></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a name="local-6989586621684273060"><a href="#local-6989586621684273060"><span class="hs-identifier">f'</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-302"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a><span> </span><a href="#local-6989586621684273060"><span class="hs-identifier hs-var">f'</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-303"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#UnaryVal"><span class="hs-identifier hs-var">UnaryVal</span></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgLitArg"><span class="hs-identifier hs-var">StgLitArg</span></a><span> </span><a name="local-6989586621684273061"><a href="#local-6989586621684273061"><span class="hs-identifier">f'</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-304"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgLit"><span class="hs-identifier hs-var">StgLit</span></a><span> </span><a href="#local-6989586621684273061"><span class="hs-identifier hs-var">f'</span></a><span class="hs-special">)</span><span>
</span><a name="line-305"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-306"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684273057"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-307"></a><span>
</span><a name="line-308"></a><span class="hs-identifier">unariseExpr</span><span> </span><a name="local-6989586621684273062"><a href="#local-6989586621684273062"><span class="hs-identifier">rho</span></a></a><span> </span><a name="local-6989586621684273063"><a href="#local-6989586621684273063"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="StgSyn.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a><span> </span><a name="local-6989586621684273064"><a href="#local-6989586621684273064"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621684273065"><a href="#local-6989586621684273065"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-309"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a><span> </span><a href="#local-6989586621684273066"><span class="hs-identifier hs-var">f'</span></a><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#unariseFunArgs"><span class="hs-identifier hs-var">unariseFunArgs</span></a><span> </span><a href="#local-6989586621684273062"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273065"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-310"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-311"></a><span>    </span><a name="local-6989586621684273066"><a href="#local-6989586621684273066"><span class="hs-identifier">f'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupVarEnv</span><span> </span><a href="#local-6989586621684273062"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273064"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-312"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#UnaryVal"><span class="hs-identifier hs-var">UnaryVal</span></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a name="local-6989586621684273067"><a href="#local-6989586621684273067"><span class="hs-identifier">f'</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684273067"><span class="hs-identifier hs-var">f'</span></a><span>
</span><a name="line-313"></a><span>           </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684273064"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-314"></a><span>           </span><a name="local-6989586621684273068"><a href="#local-6989586621684273068"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;unariseExpr - app2&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684273063"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684273068"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-315"></a><span>               </span><span class="hs-comment">-- Can't happen because 'args' is non-empty, and</span><span>
</span><a name="line-316"></a><span>               </span><span class="hs-comment">-- a tuple or sum cannot be applied to anything</span><span>
</span><a name="line-317"></a><span>
</span><a name="line-318"></a><span class="hs-identifier">unariseExpr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgLit"><span class="hs-identifier hs-var">StgLit</span></a><span> </span><a name="local-6989586621684273069"><a href="#local-6989586621684273069"><span class="hs-identifier">l</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-319"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgLit"><span class="hs-identifier hs-var">StgLit</span></a><span> </span><a href="#local-6989586621684273069"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span>
</span><a name="line-320"></a><span>
</span><a name="line-321"></a><span class="hs-identifier">unariseExpr</span><span> </span><a name="local-6989586621684273070"><a href="#local-6989586621684273070"><span class="hs-identifier">rho</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgConApp"><span class="hs-identifier hs-var">StgConApp</span></a><span> </span><a name="local-6989586621684273071"><a href="#local-6989586621684273071"><span class="hs-identifier">dc</span></a></a><span> </span><a name="local-6989586621684273072"><a href="#local-6989586621684273072"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621684273073"><a href="#local-6989586621684273073"><span class="hs-identifier">ty_args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-322"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684273074"><a href="#local-6989586621684273074"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UnariseStg.html#unariseMulti_maybe"><span class="hs-identifier hs-var">unariseMulti_maybe</span></a><span> </span><a href="#local-6989586621684273070"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273071"><span class="hs-identifier hs-var">dc</span></a><span> </span><a href="#local-6989586621684273072"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621684273073"><span class="hs-identifier hs-var">ty_args</span></a><span>
</span><a name="line-323"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#mkTuple"><span class="hs-identifier hs-var">mkTuple</span></a><span> </span><a href="#local-6989586621684273074"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">)</span><span>
</span><a name="line-324"></a><span>
</span><a name="line-325"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-326"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684273075"><a href="#local-6989586621684273075"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UnariseStg.html#unariseConArgs"><span class="hs-identifier hs-var">unariseConArgs</span></a><span> </span><a href="#local-6989586621684273070"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273072"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-327"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgConApp"><span class="hs-identifier hs-var">StgConApp</span></a><span> </span><a href="#local-6989586621684273071"><span class="hs-identifier hs-var">dc</span></a><span> </span><a href="#local-6989586621684273075"><span class="hs-identifier hs-var">args'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="StgSyn.html#stgArgType"><span class="hs-identifier hs-var">stgArgType</span></a><span> </span><a href="#local-6989586621684273075"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-328"></a><span>
</span><a name="line-329"></a><span class="hs-identifier">unariseExpr</span><span> </span><a name="local-6989586621684273076"><a href="#local-6989586621684273076"><span class="hs-identifier">rho</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgOpApp"><span class="hs-identifier hs-var">StgOpApp</span></a><span> </span><a name="local-6989586621684273077"><a href="#local-6989586621684273077"><span class="hs-identifier">op</span></a></a><span> </span><a name="local-6989586621684273078"><a href="#local-6989586621684273078"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621684273079"><a href="#local-6989586621684273079"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-330"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgOpApp"><span class="hs-identifier hs-var">StgOpApp</span></a><span> </span><a href="#local-6989586621684273077"><span class="hs-identifier hs-var">op</span></a><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#unariseFunArgs"><span class="hs-identifier hs-var">unariseFunArgs</span></a><span> </span><a href="#local-6989586621684273076"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273078"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684273079"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-331"></a><span>
</span><a name="line-332"></a><span class="hs-identifier">unariseExpr</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684273080"><a href="#local-6989586621684273080"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><a href="StgSyn.html#StgLam"><span class="hs-identifier hs-var">StgLam</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>
</span><a name="line-333"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;unariseExpr: found lambda&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684273080"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-334"></a><span>
</span><a name="line-335"></a><span class="hs-identifier">unariseExpr</span><span> </span><a name="local-6989586621684273081"><a href="#local-6989586621684273081"><span class="hs-identifier">rho</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgCase"><span class="hs-identifier hs-var">StgCase</span></a><span> </span><a name="local-6989586621684273082"><a href="#local-6989586621684273082"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621684273083"><a href="#local-6989586621684273083"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621684273084"><a href="#local-6989586621684273084"><span class="hs-identifier">alt_ty</span></a></a><span> </span><a name="local-6989586621684273085"><a href="#local-6989586621684273085"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-336"></a><span>  </span><span class="hs-comment">-- tuple/sum binders in the scrutinee can always be eliminated</span><span>
</span><a name="line-337"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="StgSyn.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a><span> </span><a name="local-6989586621684273086"><a href="#local-6989586621684273086"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684273082"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-338"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#MultiVal"><span class="hs-identifier hs-var">MultiVal</span></a><span> </span><a name="local-6989586621684273087"><a href="#local-6989586621684273087"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupVarEnv</span><span> </span><a href="#local-6989586621684273081"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273086"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-339"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="UnariseStg.html#elimCase"><span class="hs-identifier hs-var">elimCase</span></a><span> </span><a href="#local-6989586621684273081"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273087"><span class="hs-identifier hs-var">xs</span></a><span> </span><a href="#local-6989586621684273083"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621684273084"><span class="hs-identifier hs-var">alt_ty</span></a><span> </span><a href="#local-6989586621684273085"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-340"></a><span>
</span><a name="line-341"></a><span>  </span><span class="hs-comment">-- Handle strict lets for tuples and sums:</span><span>
</span><a name="line-342"></a><span>  </span><span class="hs-comment">--   case (# a,b #) of r -&gt; rhs</span><span>
</span><a name="line-343"></a><span>  </span><span class="hs-comment">-- and analogously for sums</span><span>
</span><a name="line-344"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="StgSyn.html#StgConApp"><span class="hs-identifier hs-var">StgConApp</span></a><span> </span><a name="local-6989586621684273088"><a href="#local-6989586621684273088"><span class="hs-identifier">dc</span></a></a><span> </span><a name="local-6989586621684273089"><a href="#local-6989586621684273089"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621684273090"><a href="#local-6989586621684273090"><span class="hs-identifier">ty_args</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684273082"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-345"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684273091"><a href="#local-6989586621684273091"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UnariseStg.html#unariseMulti_maybe"><span class="hs-identifier hs-var">unariseMulti_maybe</span></a><span> </span><a href="#local-6989586621684273081"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273088"><span class="hs-identifier hs-var">dc</span></a><span> </span><a href="#local-6989586621684273089"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621684273090"><span class="hs-identifier hs-var">ty_args</span></a><span>
</span><a name="line-346"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="UnariseStg.html#elimCase"><span class="hs-identifier hs-var">elimCase</span></a><span> </span><a href="#local-6989586621684273081"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273091"><span class="hs-identifier hs-var">args'</span></a><span> </span><a href="#local-6989586621684273083"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621684273084"><span class="hs-identifier hs-var">alt_ty</span></a><span> </span><a href="#local-6989586621684273085"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-347"></a><span>
</span><a name="line-348"></a><span>  </span><span class="hs-comment">-- general case</span><span>
</span><a name="line-349"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-350"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621684273092"><a href="#local-6989586621684273092"><span class="hs-identifier">scrut'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UnariseStg.html#unariseExpr"><span class="hs-identifier hs-var">unariseExpr</span></a><span> </span><a href="#local-6989586621684273081"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273082"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-351"></a><span>       </span><a name="local-6989586621684273093"><a href="#local-6989586621684273093"><span class="hs-identifier">alts'</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UnariseStg.html#unariseAlts"><span class="hs-identifier hs-var">unariseAlts</span></a><span> </span><a href="#local-6989586621684273081"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273084"><span class="hs-identifier hs-var">alt_ty</span></a><span> </span><a href="#local-6989586621684273083"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621684273085"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-352"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgCase"><span class="hs-identifier hs-var">StgCase</span></a><span> </span><a href="#local-6989586621684273092"><span class="hs-identifier hs-var">scrut'</span></a><span> </span><a href="#local-6989586621684273083"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621684273084"><span class="hs-identifier hs-var">alt_ty</span></a><span> </span><a href="#local-6989586621684273093"><span class="hs-identifier hs-var">alts'</span></a><span class="hs-special">)</span><span>
</span><a name="line-353"></a><span>                       </span><span class="hs-comment">-- bndr may have a unboxed sum/tuple type but it will be</span><span>
</span><a name="line-354"></a><span>                       </span><span class="hs-comment">-- dead after unarise (checked in StgLint)</span><span>
</span><a name="line-355"></a><span>
</span><a name="line-356"></a><span class="hs-identifier">unariseExpr</span><span> </span><a name="local-6989586621684273094"><a href="#local-6989586621684273094"><span class="hs-identifier">rho</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgLet"><span class="hs-identifier hs-var">StgLet</span></a><span> </span><a name="local-6989586621684273095"><a href="#local-6989586621684273095"><span class="hs-identifier">ext</span></a></a><span> </span><a name="local-6989586621684273096"><a href="#local-6989586621684273096"><span class="hs-identifier">bind</span></a></a><span> </span><a name="local-6989586621684273097"><a href="#local-6989586621684273097"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-357"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgLet"><span class="hs-identifier hs-var">StgLet</span></a><span> </span><a href="#local-6989586621684273095"><span class="hs-identifier hs-var">ext</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="UnariseStg.html#unariseBinding"><span class="hs-identifier hs-var">unariseBinding</span></a><span> </span><a href="#local-6989586621684273094"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273096"><span class="hs-identifier hs-var">bind</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="UnariseStg.html#unariseExpr"><span class="hs-identifier hs-var">unariseExpr</span></a><span> </span><a href="#local-6989586621684273094"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273097"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-358"></a><span>
</span><a name="line-359"></a><span class="hs-identifier">unariseExpr</span><span> </span><a name="local-6989586621684273098"><a href="#local-6989586621684273098"><span class="hs-identifier">rho</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgLetNoEscape"><span class="hs-identifier hs-var">StgLetNoEscape</span></a><span> </span><a name="local-6989586621684273099"><a href="#local-6989586621684273099"><span class="hs-identifier">ext</span></a></a><span> </span><a name="local-6989586621684273100"><a href="#local-6989586621684273100"><span class="hs-identifier">bind</span></a></a><span> </span><a name="local-6989586621684273101"><a href="#local-6989586621684273101"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-360"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgLetNoEscape"><span class="hs-identifier hs-var">StgLetNoEscape</span></a><span> </span><a href="#local-6989586621684273099"><span class="hs-identifier hs-var">ext</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="UnariseStg.html#unariseBinding"><span class="hs-identifier hs-var">unariseBinding</span></a><span> </span><a href="#local-6989586621684273098"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273100"><span class="hs-identifier hs-var">bind</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="UnariseStg.html#unariseExpr"><span class="hs-identifier hs-var">unariseExpr</span></a><span> </span><a href="#local-6989586621684273098"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273101"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-361"></a><span>
</span><a name="line-362"></a><span class="hs-identifier">unariseExpr</span><span> </span><a name="local-6989586621684273102"><a href="#local-6989586621684273102"><span class="hs-identifier">rho</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgTick"><span class="hs-identifier hs-var">StgTick</span></a><span> </span><a name="local-6989586621684273103"><a href="#local-6989586621684273103"><span class="hs-identifier">tick</span></a></a><span> </span><a name="local-6989586621684273104"><a href="#local-6989586621684273104"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-363"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgTick"><span class="hs-identifier hs-var">StgTick</span></a><span> </span><a href="#local-6989586621684273103"><span class="hs-identifier hs-var">tick</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="UnariseStg.html#unariseExpr"><span class="hs-identifier hs-var">unariseExpr</span></a><span> </span><a href="#local-6989586621684273102"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273104"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-364"></a><span>
</span><a name="line-365"></a><span class="hs-comment">-- Doesn't return void args.</span><span>
</span><a name="line-366"></a><span class="hs-identifier">unariseMulti_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#InStgArg"><span class="hs-identifier hs-type">InStgArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#OutStgArg"><span class="hs-identifier hs-type">OutStgArg</span></a><span class="hs-special">]</span><span>
</span><a name="line-367"></a><a name="unariseMulti_maybe"><a href="UnariseStg.html#unariseMulti_maybe"><span class="hs-identifier">unariseMulti_maybe</span></a></a><span> </span><a name="local-6989586621684273105"><a href="#local-6989586621684273105"><span class="hs-identifier">rho</span></a></a><span> </span><a name="local-6989586621684273106"><a href="#local-6989586621684273106"><span class="hs-identifier">dc</span></a></a><span> </span><a name="local-6989586621684273107"><a href="#local-6989586621684273107"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621684273108"><a href="#local-6989586621684273108"><span class="hs-identifier">ty_args</span></a></a><span>
</span><a name="line-368"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isUnboxedTupleCon</span><span> </span><a href="#local-6989586621684273106"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-369"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#unariseConArgs"><span class="hs-identifier hs-var">unariseConArgs</span></a><span> </span><a href="#local-6989586621684273105"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273107"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-370"></a><span>
</span><a name="line-371"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isUnboxedSumCon</span><span> </span><a href="#local-6989586621684273106"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-372"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684273109"><a href="#local-6989586621684273109"><span class="hs-identifier">args1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier">isSingleton</span><span> </span><span class="hs-identifier">args</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">unariseConArgs</span><span> </span><span class="hs-identifier">rho</span><span> </span><span class="hs-identifier hs-var">args</span><span class="hs-special">)</span><span>
</span><a name="line-373"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#mkUbxSum"><span class="hs-identifier hs-var">mkUbxSum</span></a><span> </span><a href="#local-6989586621684273106"><span class="hs-identifier hs-var">dc</span></a><span> </span><a href="#local-6989586621684273108"><span class="hs-identifier hs-var">ty_args</span></a><span> </span><a href="#local-6989586621684273109"><span class="hs-identifier hs-var">args1</span></a><span class="hs-special">)</span><span>
</span><a name="line-374"></a><span>
</span><a name="line-375"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-376"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-377"></a><span>
</span><a name="line-378"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-379"></a><span>
</span><a name="line-380"></a><span class="hs-identifier">elimCase</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span>
</span><a name="line-381"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#OutStgArg"><span class="hs-identifier hs-type">OutStgArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- non-void args</span><span>
</span><a name="line-382"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">InId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#AltType"><span class="hs-identifier hs-type">AltType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#InStgAlt"><span class="hs-identifier hs-type">InStgAlt</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><a href="StgSyn.html#OutStgExpr"><span class="hs-identifier hs-type">OutStgExpr</span></a><span>
</span><a name="line-383"></a><span>
</span><a name="line-384"></a><a name="elimCase"><a href="UnariseStg.html#elimCase"><span class="hs-identifier">elimCase</span></a></a><span> </span><a name="local-6989586621684273110"><a href="#local-6989586621684273110"><span class="hs-identifier">rho</span></a></a><span> </span><a name="local-6989586621684273111"><a href="#local-6989586621684273111"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621684273112"><a href="#local-6989586621684273112"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#MultiValAlt"><span class="hs-identifier hs-var">MultiValAlt</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684273113"><a href="#local-6989586621684273113"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684273114"><a href="#local-6989586621684273114"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-385"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684273115"><a href="#local-6989586621684273115"><span class="hs-identifier">rho1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UnariseStg.html#extendRho"><span class="hs-identifier hs-var">extendRho</span></a><span> </span><a href="#local-6989586621684273110"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273112"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#MultiVal"><span class="hs-identifier hs-var">MultiVal</span></a><span> </span><a href="#local-6989586621684273111"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-386"></a><span>           </span><a name="local-6989586621684273116"><a href="#local-6989586621684273116"><span class="hs-identifier">rho2</span></a></a><span>
</span><a name="line-387"></a><span>             </span><span class="hs-glyph">|</span><span> </span><a href="UnariseStg.html#isUnboxedTupleBndr"><span class="hs-identifier hs-var">isUnboxedTupleBndr</span></a><span> </span><a href="#local-6989586621684273112"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-388"></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="UnariseStg.html#mapTupleIdBinders"><span class="hs-identifier hs-var">mapTupleIdBinders</span></a><span> </span><a href="#local-6989586621684273113"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621684273111"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621684273115"><span class="hs-identifier hs-var">rho1</span></a><span>
</span><a name="line-389"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-390"></a><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier">isUnboxedSumBndr</span><span> </span><a href="UnariseStg.html#isUnboxedSumBndr"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-391"></a><span>               </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621684273113"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621684273115"><span class="hs-identifier hs-var">rho1</span></a><span>
</span><a name="line-392"></a><span>                             </span><span class="hs-keyword">else</span><span> </span><a href="UnariseStg.html#mapSumIdBinders"><span class="hs-identifier hs-var">mapSumIdBinders</span></a><span> </span><a href="#local-6989586621684273113"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621684273111"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621684273115"><span class="hs-identifier hs-var">rho1</span></a><span>
</span><a name="line-393"></a><span>
</span><a name="line-394"></a><span>       </span><a href="UnariseStg.html#unariseExpr"><span class="hs-identifier hs-var">unariseExpr</span></a><span> </span><a href="#local-6989586621684273116"><span class="hs-identifier hs-var">rho2</span></a><span> </span><a href="#local-6989586621684273114"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-395"></a><span>
</span><a name="line-396"></a><span class="hs-identifier">elimCase</span><span> </span><a name="local-6989586621684273117"><a href="#local-6989586621684273117"><span class="hs-identifier">rho</span></a></a><span> </span><a name="local-6989586621684273118"><a href="#local-6989586621684273118"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621684273119"><a href="#local-6989586621684273119"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#MultiValAlt"><span class="hs-identifier hs-var">MultiValAlt</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684273120"><a href="#local-6989586621684273120"><span class="hs-identifier">alts</span></a></a><span>
</span><a name="line-397"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="UnariseStg.html#isUnboxedSumBndr"><span class="hs-identifier hs-var">isUnboxedSumBndr</span></a><span> </span><a href="#local-6989586621684273119"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-398"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684273121"><a href="#local-6989586621684273121"><span class="hs-identifier">tag_arg</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684273122"><a href="#local-6989586621684273122"><span class="hs-identifier">real_args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684273118"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-399"></a><span>       </span><a name="local-6989586621684273123"><a href="#local-6989586621684273123"><span class="hs-identifier">tag_bndr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UnariseStg.html#mkId"><span class="hs-identifier hs-var">mkId</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkFastString</span><span> </span><span class="hs-string">&quot;tag&quot;</span><span class="hs-special">)</span><span> </span><a href="UnariseStg.html#tagTy"><span class="hs-identifier hs-var">tagTy</span></a><span>
</span><a name="line-400"></a><span>          </span><span class="hs-comment">-- this won't be used but we need a binder anyway</span><span>
</span><a name="line-401"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684273124"><a href="#local-6989586621684273124"><span class="hs-identifier">rho1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UnariseStg.html#extendRho"><span class="hs-identifier hs-var">extendRho</span></a><span> </span><a href="#local-6989586621684273117"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273119"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#MultiVal"><span class="hs-identifier hs-var">MultiVal</span></a><span> </span><a href="#local-6989586621684273118"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-402"></a><span>           </span><a name="local-6989586621684273125"><a href="#local-6989586621684273125"><span class="hs-identifier">scrut'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684273121"><span class="hs-identifier hs-var">tag_arg</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-403"></a><span>                      </span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a name="local-6989586621684273126"><a href="#local-6989586621684273126"><span class="hs-identifier">v</span></a></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a><span> </span><a href="#local-6989586621684273126"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-404"></a><span>                      </span><a href="StgSyn.html#StgLitArg"><span class="hs-identifier hs-var">StgLitArg</span></a><span> </span><a name="local-6989586621684273127"><a href="#local-6989586621684273127"><span class="hs-identifier">l</span></a></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#StgLit"><span class="hs-identifier hs-var">StgLit</span></a><span> </span><a href="#local-6989586621684273127"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-405"></a><span>
</span><a name="line-406"></a><span>       </span><a name="local-6989586621684273128"><a href="#local-6989586621684273128"><span class="hs-identifier">alts'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UnariseStg.html#unariseSumAlts"><span class="hs-identifier hs-var">unariseSumAlts</span></a><span> </span><a href="#local-6989586621684273124"><span class="hs-identifier hs-var">rho1</span></a><span> </span><a href="#local-6989586621684273122"><span class="hs-identifier hs-var">real_args</span></a><span> </span><a href="#local-6989586621684273120"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-407"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgCase"><span class="hs-identifier hs-var">StgCase</span></a><span> </span><a href="#local-6989586621684273125"><span class="hs-identifier hs-var">scrut'</span></a><span> </span><a href="#local-6989586621684273123"><span class="hs-identifier hs-var">tag_bndr</span></a><span> </span><a href="UnariseStg.html#tagAltTy"><span class="hs-identifier hs-var">tagAltTy</span></a><span> </span><a href="#local-6989586621684273128"><span class="hs-identifier hs-var">alts'</span></a><span class="hs-special">)</span><span>
</span><a name="line-408"></a><span>
</span><a name="line-409"></a><span class="hs-identifier">elimCase</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684273129"><a href="#local-6989586621684273129"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621684273130"><a href="#local-6989586621684273130"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621684273131"><a href="#local-6989586621684273131"><span class="hs-identifier">alt_ty</span></a></a><span> </span><a name="local-6989586621684273132"><a href="#local-6989586621684273132"><span class="hs-identifier">alts</span></a></a><span>
</span><a name="line-410"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;elimCase - unhandled case&quot;</span><span>
</span><a name="line-411"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684273129"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684273130"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684273131"><span class="hs-identifier hs-var">alt_ty</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684273132"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">)</span><span>
</span><a name="line-412"></a><span>
</span><a name="line-413"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-414"></a><span>
</span><a name="line-415"></a><span class="hs-identifier">unariseAlts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#AltType"><span class="hs-identifier hs-type">AltType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">InId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgAlt"><span class="hs-identifier hs-type">StgAlt</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgAlt"><span class="hs-identifier hs-type">StgAlt</span></a><span class="hs-special">]</span><span>
</span><a name="line-416"></a><a name="unariseAlts"><a href="UnariseStg.html#unariseAlts"><span class="hs-identifier">unariseAlts</span></a></a><span> </span><a name="local-6989586621684273133"><a href="#local-6989586621684273133"><span class="hs-identifier">rho</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#MultiValAlt"><span class="hs-identifier hs-var">MultiValAlt</span></a><span> </span><a name="local-6989586621684273134"><a href="#local-6989586621684273134"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684273135"><a href="#local-6989586621684273135"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DEFAULT</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684273136"><a href="#local-6989586621684273136"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-417"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="UnariseStg.html#isUnboxedTupleBndr"><span class="hs-identifier hs-var">isUnboxedTupleBndr</span></a><span> </span><a href="#local-6989586621684273135"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-418"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684273137"><a href="#local-6989586621684273137"><span class="hs-identifier">rho'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684273138"><a href="#local-6989586621684273138"><span class="hs-identifier">ys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UnariseStg.html#unariseConArgBinder"><span class="hs-identifier hs-var">unariseConArgBinder</span></a><span> </span><a href="#local-6989586621684273133"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273135"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-419"></a><span>       </span><a name="local-6989586621684273139"><a href="#local-6989586621684273139"><span class="hs-identifier">e'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UnariseStg.html#unariseExpr"><span class="hs-identifier hs-var">unariseExpr</span></a><span> </span><a href="#local-6989586621684273137"><span class="hs-identifier hs-var">rho'</span></a><span> </span><a href="#local-6989586621684273136"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-420"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataAlt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tupleDataCon</span><span> </span><span class="hs-identifier hs-var">Unboxed</span><span> </span><a href="#local-6989586621684273134"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684273138"><span class="hs-identifier hs-var">ys</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684273139"><span class="hs-identifier hs-var">e'</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-421"></a><span>
</span><a name="line-422"></a><span class="hs-identifier">unariseAlts</span><span> </span><a name="local-6989586621684273140"><a href="#local-6989586621684273140"><span class="hs-identifier">rho</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#MultiValAlt"><span class="hs-identifier hs-var">MultiValAlt</span></a><span> </span><a name="local-6989586621684273141"><a href="#local-6989586621684273141"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684273142"><a href="#local-6989586621684273142"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataAlt</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684273143"><a href="#local-6989586621684273143"><span class="hs-identifier">ys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684273144"><a href="#local-6989586621684273144"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-423"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="UnariseStg.html#isUnboxedTupleBndr"><span class="hs-identifier hs-var">isUnboxedTupleBndr</span></a><span> </span><a href="#local-6989586621684273142"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-424"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684273145"><a href="#local-6989586621684273145"><span class="hs-identifier">rho'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684273146"><a href="#local-6989586621684273146"><span class="hs-identifier">ys1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UnariseStg.html#unariseConArgBinders"><span class="hs-identifier hs-var">unariseConArgBinders</span></a><span> </span><a href="#local-6989586621684273140"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273143"><span class="hs-identifier hs-var">ys</span></a><span>
</span><a name="line-425"></a><span>       </span><span class="hs-identifier">MASSERT</span><span class="hs-special">(</span><span class="hs-identifier hs-var">ys1</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">lengthIs</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684273146"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-426"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684273147"><a href="#local-6989586621684273147"><span class="hs-identifier">rho''</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UnariseStg.html#extendRho"><span class="hs-identifier hs-var">extendRho</span></a><span> </span><a href="#local-6989586621684273145"><span class="hs-identifier hs-var">rho'</span></a><span> </span><a href="#local-6989586621684273142"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#MultiVal"><span class="hs-identifier hs-var">MultiVal</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a href="#local-6989586621684273146"><span class="hs-identifier hs-var">ys1</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-427"></a><span>       </span><a name="local-6989586621684273148"><a href="#local-6989586621684273148"><span class="hs-identifier">e'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UnariseStg.html#unariseExpr"><span class="hs-identifier hs-var">unariseExpr</span></a><span> </span><a href="#local-6989586621684273147"><span class="hs-identifier hs-var">rho''</span></a><span> </span><a href="#local-6989586621684273144"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-428"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataAlt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tupleDataCon</span><span> </span><span class="hs-identifier hs-var">Unboxed</span><span> </span><a href="#local-6989586621684273141"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684273146"><span class="hs-identifier hs-var">ys1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684273148"><span class="hs-identifier hs-var">e'</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-429"></a><span>
</span><a name="line-430"></a><span class="hs-identifier">unariseAlts</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#MultiValAlt"><span class="hs-identifier hs-var">MultiValAlt</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684273149"><a href="#local-6989586621684273149"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621684273150"><a href="#local-6989586621684273150"><span class="hs-identifier">alts</span></a></a><span>
</span><a name="line-431"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="UnariseStg.html#isUnboxedTupleBndr"><span class="hs-identifier hs-var">isUnboxedTupleBndr</span></a><span> </span><a href="#local-6989586621684273149"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-432"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;unariseExpr: strange multi val alts&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684273150"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">)</span><span>
</span><a name="line-433"></a><span>
</span><a name="line-434"></a><span class="hs-comment">-- In this case we don't need to scrutinize the tag bit</span><span>
</span><a name="line-435"></a><span class="hs-identifier">unariseAlts</span><span> </span><a name="local-6989586621684273151"><a href="#local-6989586621684273151"><span class="hs-identifier">rho</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#MultiValAlt"><span class="hs-identifier hs-var">MultiValAlt</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684273152"><a href="#local-6989586621684273152"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DEFAULT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684273153"><a href="#local-6989586621684273153"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-436"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="UnariseStg.html#isUnboxedSumBndr"><span class="hs-identifier hs-var">isUnboxedSumBndr</span></a><span> </span><a href="#local-6989586621684273152"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-437"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684273154"><a href="#local-6989586621684273154"><span class="hs-identifier">rho_sum_bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684273155"><a href="#local-6989586621684273155"><span class="hs-identifier">sum_bndrs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UnariseStg.html#unariseConArgBinder"><span class="hs-identifier hs-var">unariseConArgBinder</span></a><span> </span><a href="#local-6989586621684273151"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273152"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-438"></a><span>       </span><a name="local-6989586621684273156"><a href="#local-6989586621684273156"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UnariseStg.html#unariseExpr"><span class="hs-identifier hs-var">unariseExpr</span></a><span> </span><a href="#local-6989586621684273154"><span class="hs-identifier hs-var">rho_sum_bndrs</span></a><span> </span><a href="#local-6989586621684273153"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-439"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataAlt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tupleDataCon</span><span> </span><span class="hs-identifier hs-var">Unboxed</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621684273155"><span class="hs-identifier hs-var">sum_bndrs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684273155"><span class="hs-identifier hs-var">sum_bndrs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684273156"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-440"></a><span>
</span><a name="line-441"></a><span class="hs-identifier">unariseAlts</span><span> </span><a name="local-6989586621684273157"><a href="#local-6989586621684273157"><span class="hs-identifier">rho</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#MultiValAlt"><span class="hs-identifier hs-var">MultiValAlt</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684273158"><a href="#local-6989586621684273158"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621684273159"><a href="#local-6989586621684273159"><span class="hs-identifier">alts</span></a></a><span>
</span><a name="line-442"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="UnariseStg.html#isUnboxedSumBndr"><span class="hs-identifier hs-var">isUnboxedSumBndr</span></a><span> </span><a href="#local-6989586621684273158"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-443"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684273160"><a href="#local-6989586621684273160"><span class="hs-identifier">rho_sum_bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684273161"><a href="#local-6989586621684273161"><span class="hs-identifier">scrt_bndrs</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621684273162"><a href="#local-6989586621684273162"><span class="hs-identifier">tag_bndr</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684273163"><a href="#local-6989586621684273163"><span class="hs-identifier">real_bndrs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UnariseStg.html#unariseConArgBinder"><span class="hs-identifier hs-var">unariseConArgBinder</span></a><span> </span><a href="#local-6989586621684273157"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273158"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-444"></a><span>       </span><a name="local-6989586621684273164"><a href="#local-6989586621684273164"><span class="hs-identifier">alts'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UnariseStg.html#unariseSumAlts"><span class="hs-identifier hs-var">unariseSumAlts</span></a><span> </span><a href="#local-6989586621684273160"><span class="hs-identifier hs-var">rho_sum_bndrs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a href="#local-6989586621684273163"><span class="hs-identifier hs-var">real_bndrs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684273159"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-445"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684273165"><a href="#local-6989586621684273165"><span class="hs-identifier">inner_case</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgCase"><span class="hs-identifier hs-var">StgCase</span></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a><span> </span><a href="#local-6989586621684273162"><span class="hs-identifier hs-var">tag_bndr</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684273162"><span class="hs-identifier hs-var">tag_bndr</span></a><span> </span><a href="UnariseStg.html#tagAltTy"><span class="hs-identifier hs-var">tagAltTy</span></a><span> </span><a href="#local-6989586621684273164"><span class="hs-identifier hs-var">alts'</span></a><span>
</span><a name="line-446"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataAlt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tupleDataCon</span><span> </span><span class="hs-identifier hs-var">Unboxed</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621684273161"><span class="hs-identifier hs-var">scrt_bndrs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-447"></a><span>                 </span><a href="#local-6989586621684273161"><span class="hs-identifier hs-var">scrt_bndrs</span></a><span class="hs-special">,</span><span>
</span><a name="line-448"></a><span>                 </span><a href="#local-6989586621684273165"><span class="hs-identifier hs-var">inner_case</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-449"></a><span>
</span><a name="line-450"></a><span class="hs-identifier">unariseAlts</span><span> </span><a name="local-6989586621684273166"><a href="#local-6989586621684273166"><span class="hs-identifier">rho</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684273167"><a href="#local-6989586621684273167"><span class="hs-identifier">alts</span></a></a><span>
</span><a name="line-451"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684273168"><a href="#local-6989586621684273168"><span class="hs-identifier">alt</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnariseStg.html#unariseAlt"><span class="hs-identifier hs-var">unariseAlt</span></a><span> </span><a href="#local-6989586621684273166"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273168"><span class="hs-identifier hs-var">alt</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684273167"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-452"></a><span>
</span><a name="line-453"></a><span class="hs-identifier">unariseAlt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#StgAlt"><span class="hs-identifier hs-type">StgAlt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><a href="StgSyn.html#StgAlt"><span class="hs-identifier hs-type">StgAlt</span></a><span>
</span><a name="line-454"></a><a name="unariseAlt"><a href="UnariseStg.html#unariseAlt"><span class="hs-identifier">unariseAlt</span></a></a><span> </span><a name="local-6989586621684273169"><a href="#local-6989586621684273169"><span class="hs-identifier">rho</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684273170"><a href="#local-6989586621684273170"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684273171"><a href="#local-6989586621684273171"><span class="hs-identifier">xs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684273172"><a href="#local-6989586621684273172"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-455"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684273173"><a href="#local-6989586621684273173"><span class="hs-identifier">rho'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684273174"><a href="#local-6989586621684273174"><span class="hs-identifier">xs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UnariseStg.html#unariseConArgBinders"><span class="hs-identifier hs-var">unariseConArgBinders</span></a><span> </span><a href="#local-6989586621684273169"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273171"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-456"></a><span>       </span><span class="hs-special">(</span><a href="#local-6989586621684273170"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684273174"><span class="hs-identifier hs-var">xs'</span></a><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="UnariseStg.html#unariseExpr"><span class="hs-identifier hs-var">unariseExpr</span></a><span> </span><a href="#local-6989586621684273173"><span class="hs-identifier hs-var">rho'</span></a><span> </span><a href="#local-6989586621684273172"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-457"></a><span>
</span><a name="line-458"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-459"></a><span>
</span><a name="line-460"></a><span class="hs-comment">-- | Make alternatives that match on the tag of a sum</span><span>
</span><a name="line-461"></a><span class="hs-comment">-- (i.e. generate LitAlts for the tag)</span><span>
</span><a name="line-462"></a><span class="hs-identifier">unariseSumAlts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span>
</span><a name="line-463"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- sum components _excluding_ the tag bit.</span><span>
</span><a name="line-464"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgAlt"><span class="hs-identifier hs-type">StgAlt</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- original alternative with sum LHS</span><span>
</span><a name="line-465"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgAlt"><span class="hs-identifier hs-type">StgAlt</span></a><span class="hs-special">]</span><span>
</span><a name="line-466"></a><a name="unariseSumAlts"><a href="UnariseStg.html#unariseSumAlts"><span class="hs-identifier">unariseSumAlts</span></a></a><span> </span><a name="local-6989586621684273175"><a href="#local-6989586621684273175"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684273176"><a href="#local-6989586621684273176"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621684273177"><a href="#local-6989586621684273177"><span class="hs-identifier">alts</span></a></a><span>
</span><a name="line-467"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621684273178"><a href="#local-6989586621684273178"><span class="hs-identifier">alts'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#unariseSumAlt"><span class="hs-identifier hs-var">unariseSumAlt</span></a><span> </span><a href="#local-6989586621684273175"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684273176"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684273177"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-468"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#mkDefaultLitAlt"><span class="hs-identifier hs-var">mkDefaultLitAlt</span></a><span> </span><a href="#local-6989586621684273178"><span class="hs-identifier hs-var">alts'</span></a><span class="hs-special">)</span><span>
</span><a name="line-469"></a><span>
</span><a name="line-470"></a><span class="hs-identifier">unariseSumAlt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span>
</span><a name="line-471"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- sum components _excluding_ the tag bit.</span><span>
</span><a name="line-472"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#StgAlt"><span class="hs-identifier hs-type">StgAlt</span></a><span>   </span><span class="hs-comment">-- original alternative with sum LHS</span><span>
</span><a name="line-473"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><a href="StgSyn.html#StgAlt"><span class="hs-identifier hs-type">StgAlt</span></a><span>
</span><a name="line-474"></a><a name="unariseSumAlt"><a href="UnariseStg.html#unariseSumAlt"><span class="hs-identifier">unariseSumAlt</span></a></a><span> </span><a name="local-6989586621684273179"><a href="#local-6989586621684273179"><span class="hs-identifier">rho</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DEFAULT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684273180"><a href="#local-6989586621684273180"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-475"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">DEFAULT</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="UnariseStg.html#unariseExpr"><span class="hs-identifier hs-var">unariseExpr</span></a><span> </span><a href="#local-6989586621684273179"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273180"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-476"></a><span>
</span><a name="line-477"></a><span class="hs-identifier">unariseSumAlt</span><span> </span><a name="local-6989586621684273181"><a href="#local-6989586621684273181"><span class="hs-identifier">rho</span></a></a><span> </span><a name="local-6989586621684273182"><a href="#local-6989586621684273182"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataAlt</span><span> </span><a name="local-6989586621684273183"><a href="#local-6989586621684273183"><span class="hs-identifier">sumCon</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684273184"><a href="#local-6989586621684273184"><span class="hs-identifier">bs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684273185"><a href="#local-6989586621684273185"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-478"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684273186"><a href="#local-6989586621684273186"><span class="hs-identifier">rho'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UnariseStg.html#mapSumIdBinders"><span class="hs-identifier hs-var">mapSumIdBinders</span></a><span> </span><a href="#local-6989586621684273184"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-6989586621684273182"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621684273181"><span class="hs-identifier hs-var">rho</span></a><span>
</span><a name="line-479"></a><span>       </span><a name="local-6989586621684273187"><a href="#local-6989586621684273187"><span class="hs-identifier">e'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UnariseStg.html#unariseExpr"><span class="hs-identifier hs-var">unariseExpr</span></a><span> </span><a href="#local-6989586621684273186"><span class="hs-identifier hs-var">rho'</span></a><span> </span><a href="#local-6989586621684273185"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-480"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">LitAlt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitNumber</span><span> </span><span class="hs-identifier hs-var">LitNumInt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConTag</span><span> </span><a href="#local-6989586621684273183"><span class="hs-identifier hs-var">sumCon</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">intPrimTy</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684273187"><span class="hs-identifier hs-var">e'</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-481"></a><span>
</span><a name="line-482"></a><span class="hs-identifier">unariseSumAlt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684273188"><a href="#local-6989586621684273188"><span class="hs-identifier">scrt</span></a></a><span> </span><a name="local-6989586621684273189"><a href="#local-6989586621684273189"><span class="hs-identifier">alt</span></a></a><span>
</span><a name="line-483"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;unariseSumAlt&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684273188"><span class="hs-identifier hs-var">scrt</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684273189"><span class="hs-identifier hs-var">alt</span></a><span class="hs-special">)</span><span>
</span><a name="line-484"></a><span>
</span><a name="line-485"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-486"></a><span>
</span><a name="line-487"></a><span class="hs-identifier">mapTupleIdBinders</span><span>
</span><a name="line-488"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">InId</span><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- Un-processed binders of a tuple alternative.</span><span>
</span><a name="line-489"></a><span>                  </span><span class="hs-comment">-- Can have void binders.</span><span>
</span><a name="line-490"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#OutStgArg"><span class="hs-identifier hs-type">OutStgArg</span></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Arguments that form the tuple (after unarisation).</span><span>
</span><a name="line-491"></a><span>                  </span><span class="hs-comment">-- Can't have void args.</span><span>
</span><a name="line-492"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span>
</span><a name="line-493"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span>
</span><a name="line-494"></a><a name="mapTupleIdBinders"><a href="UnariseStg.html#mapTupleIdBinders"><span class="hs-identifier">mapTupleIdBinders</span></a></a><span> </span><a name="local-6989586621684273190"><a href="#local-6989586621684273190"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-6989586621684273191"><a href="#local-6989586621684273191"><span class="hs-identifier">args0</span></a></a><span> </span><a name="local-6989586621684273192"><a href="#local-6989586621684273192"><span class="hs-identifier">rho0</span></a></a><span>
</span><a name="line-495"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">any</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isVoidTy</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">stgArgType</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">args0</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-496"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-497"></a><span>      </span><span class="hs-identifier">ids_unarised</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">PrimRep</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-498"></a><span>      </span><a name="local-6989586621684273193"><a href="#local-6989586621684273193"><span class="hs-identifier">ids_unarised</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684273195"><a href="#local-6989586621684273195"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684273195"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">typePrimRep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621684273195"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684273190"><span class="hs-identifier hs-var">ids</span></a><span>
</span><a name="line-499"></a><span>
</span><a name="line-500"></a><span>      </span><span class="hs-identifier">map_ids</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">PrimRep</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span>
</span><a name="line-501"></a><span>      </span><a name="local-6989586621684273194"><a href="#local-6989586621684273194"><span class="hs-identifier">map_ids</span></a></a><span> </span><a name="local-6989586621684273196"><a href="#local-6989586621684273196"><span class="hs-identifier">rho</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684273196"><span class="hs-identifier hs-var">rho</span></a><span>
</span><a name="line-502"></a><span>      </span><span class="hs-identifier">map_ids</span><span> </span><a name="local-6989586621684273197"><a href="#local-6989586621684273197"><span class="hs-identifier">rho</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621684273198"><a href="#local-6989586621684273198"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684273199"><a href="#local-6989586621684273199"><span class="hs-identifier">x_reps</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684273200"><a href="#local-6989586621684273200"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684273201"><a href="#local-6989586621684273201"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-503"></a><span>        </span><span class="hs-keyword">let</span><span>
</span><a name="line-504"></a><span>          </span><a name="local-6989586621684273202"><a href="#local-6989586621684273202"><span class="hs-identifier">x_arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621684273199"><span class="hs-identifier hs-var">x_reps</span></a><span>
</span><a name="line-505"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621684273203"><a href="#local-6989586621684273203"><span class="hs-identifier">x_args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684273204"><a href="#local-6989586621684273204"><span class="hs-identifier">args'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-506"></a><span>            </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier hs-var">args</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">lengthAtLeast</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">x_arity</span><span class="hs-special">)</span><span>
</span><a name="line-507"></a><span>            </span><span class="hs-identifier hs-var">splitAt</span><span> </span><a href="#local-6989586621684273202"><span class="hs-identifier hs-var">x_arity</span></a><span> </span><a href="#local-6989586621684273201"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-508"></a><span>
</span><a name="line-509"></a><span>          </span><a name="local-6989586621684273205"><a href="#local-6989586621684273205"><span class="hs-identifier">rho'</span></a></a><span>
</span><a name="line-510"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684273202"><span class="hs-identifier hs-var">x_arity</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-511"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier">x_args</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">lengthIs</span><span class="hs-special">`</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-512"></a><span>              </span><a href="UnariseStg.html#extendRho"><span class="hs-identifier hs-var">extendRho</span></a><span> </span><a href="#local-6989586621684273197"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273198"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#UnaryVal"><span class="hs-identifier hs-var">UnaryVal</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621684273203"><span class="hs-identifier hs-var">x_args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-513"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-514"></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="UnariseStg.html#extendRho"><span class="hs-identifier hs-var">extendRho</span></a><span> </span><a href="#local-6989586621684273197"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273198"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#MultiVal"><span class="hs-identifier hs-var">MultiVal</span></a><span> </span><a href="#local-6989586621684273203"><span class="hs-identifier hs-var">x_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-515"></a><span>        </span><span class="hs-keyword">in</span><span>
</span><a name="line-516"></a><span>          </span><a href="#local-6989586621684273194"><span class="hs-identifier hs-var">map_ids</span></a><span> </span><a href="#local-6989586621684273205"><span class="hs-identifier hs-var">rho'</span></a><span> </span><a href="#local-6989586621684273200"><span class="hs-identifier hs-var">xs</span></a><span> </span><a href="#local-6989586621684273204"><span class="hs-identifier hs-var">args'</span></a><span>
</span><a name="line-517"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-518"></a><span>      </span><a href="#local-6989586621684273194"><span class="hs-identifier hs-var">map_ids</span></a><span> </span><a href="#local-6989586621684273192"><span class="hs-identifier hs-var">rho0</span></a><span> </span><a href="#local-6989586621684273193"><span class="hs-identifier hs-var">ids_unarised</span></a><span> </span><a href="#local-6989586621684273191"><span class="hs-identifier hs-var">args0</span></a><span>
</span><a name="line-519"></a><span>
</span><a name="line-520"></a><span class="hs-identifier">mapSumIdBinders</span><span>
</span><a name="line-521"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">InId</span><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- Binder of a sum alternative (remember that sum patterns</span><span>
</span><a name="line-522"></a><span>                 </span><span class="hs-comment">-- only have one binder, so this list should be a singleton)</span><span>
</span><a name="line-523"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#OutStgArg"><span class="hs-identifier hs-type">OutStgArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- Arguments that form the sum (NOT including the tag).</span><span>
</span><a name="line-524"></a><span>                 </span><span class="hs-comment">-- Can't have void args.</span><span>
</span><a name="line-525"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span>
</span><a name="line-526"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span>
</span><a name="line-527"></a><span>
</span><a name="line-528"></a><a name="mapSumIdBinders"><a href="UnariseStg.html#mapSumIdBinders"><span class="hs-identifier">mapSumIdBinders</span></a></a><span> </span><span class="hs-special">[</span><a name="local-6989586621684273206"><a href="#local-6989586621684273206"><span class="hs-identifier">id</span></a></a><span class="hs-special">]</span><span> </span><a name="local-6989586621684273207"><a href="#local-6989586621684273207"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621684273208"><a href="#local-6989586621684273208"><span class="hs-identifier">rho0</span></a></a><span>
</span><a name="line-529"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">any</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isVoidTy</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">stgArgType</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">args</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-530"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-531"></a><span>      </span><a name="local-6989586621684273209"><a href="#local-6989586621684273209"><span class="hs-identifier">arg_slots</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">primRepSlot</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">typePrimRep</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="StgSyn.html#stgArgType"><span class="hs-identifier hs-var">stgArgType</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684273207"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-532"></a><span>      </span><a name="local-6989586621684273210"><a href="#local-6989586621684273210"><span class="hs-identifier">id_slots</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">primRepSlot</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">typePrimRep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621684273206"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-533"></a><span>      </span><a name="local-6989586621684273211"><a href="#local-6989586621684273211"><span class="hs-identifier">layout1</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">layoutUbxSum</span><span> </span><a href="#local-6989586621684273209"><span class="hs-identifier hs-var">arg_slots</span></a><span> </span><a href="#local-6989586621684273210"><span class="hs-identifier hs-var">id_slots</span></a><span>
</span><a name="line-534"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-535"></a><span>      </span><span class="hs-keyword">if</span><span> </span><a href="UnariseStg.html#isMultiValBndr"><span class="hs-identifier hs-var">isMultiValBndr</span></a><span> </span><a href="#local-6989586621684273206"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-536"></a><span>        </span><span class="hs-keyword">then</span><span> </span><a href="UnariseStg.html#extendRho"><span class="hs-identifier hs-var">extendRho</span></a><span> </span><a href="#local-6989586621684273208"><span class="hs-identifier hs-var">rho0</span></a><span> </span><a href="#local-6989586621684273206"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#MultiVal"><span class="hs-identifier hs-var">MultiVal</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621684273207"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-operator hs-var">!!</span><span> </span><a href="#local-6989586621684273212"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621684273212"><a href="#local-6989586621684273212"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684273211"><span class="hs-identifier hs-var">layout1</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-537"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier">layout1</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">lengthIs</span><span class="hs-special">`</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-538"></a><span>             </span><a href="UnariseStg.html#extendRho"><span class="hs-identifier hs-var">extendRho</span></a><span> </span><a href="#local-6989586621684273208"><span class="hs-identifier hs-var">rho0</span></a><span> </span><a href="#local-6989586621684273206"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#UnaryVal"><span class="hs-identifier hs-var">UnaryVal</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684273207"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-operator hs-var">!!</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621684273211"><span class="hs-identifier hs-var">layout1</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-539"></a><span>
</span><a name="line-540"></a><span class="hs-identifier">mapSumIdBinders</span><span> </span><a name="local-6989586621684273213"><a href="#local-6989586621684273213"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-6989586621684273214"><a href="#local-6989586621684273214"><span class="hs-identifier">sum_args</span></a></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-541"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;mapSumIdBinders&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684273213"><span class="hs-identifier hs-var">ids</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684273214"><span class="hs-identifier hs-var">sum_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-542"></a><span>
</span><a name="line-543"></a><span class="hs-comment">-- | Build a unboxed sum term from arguments of an alternative.</span><span>
</span><a name="line-544"></a><span class="hs-comment">--</span><span>
</span><a name="line-545"></a><span class="hs-comment">-- Example, for (# x | #) :: (# (# #) | Int #) we call</span><span>
</span><a name="line-546"></a><span class="hs-comment">--</span><span>
</span><a name="line-547"></a><span class="hs-comment">--   mkUbxSum (# _ | #) [ (# #), Int ] [ voidPrimId ]</span><span>
</span><a name="line-548"></a><span class="hs-comment">--</span><span>
</span><a name="line-549"></a><span class="hs-comment">-- which returns</span><span>
</span><a name="line-550"></a><span class="hs-comment">--</span><span>
</span><a name="line-551"></a><span class="hs-comment">--   [ 1#, rubbish ]</span><span>
</span><a name="line-552"></a><span class="hs-comment">--</span><span>
</span><a name="line-553"></a><span class="hs-identifier">mkUbxSum</span><span>
</span><a name="line-554"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span>      </span><span class="hs-comment">-- Sum data con</span><span>
</span><a name="line-555"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- Type arguments of the sum data con</span><span>
</span><a name="line-556"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#OutStgArg"><span class="hs-identifier hs-type">OutStgArg</span></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Actual arguments of the alternative.</span><span>
</span><a name="line-557"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#OutStgArg"><span class="hs-identifier hs-type">OutStgArg</span></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Final tuple arguments</span><span>
</span><a name="line-558"></a><a name="mkUbxSum"><a href="UnariseStg.html#mkUbxSum"><span class="hs-identifier">mkUbxSum</span></a></a><span> </span><a name="local-6989586621684273215"><a href="#local-6989586621684273215"><span class="hs-identifier">dc</span></a></a><span> </span><a name="local-6989586621684273216"><a href="#local-6989586621684273216"><span class="hs-identifier">ty_args</span></a></a><span> </span><a name="local-6989586621684273217"><a href="#local-6989586621684273217"><span class="hs-identifier">args0</span></a></a><span>
</span><a name="line-559"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-560"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684273218"><a href="#local-6989586621684273218"><span class="hs-identifier">sum_slots</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ubxSumRepType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">typePrimRep</span><span> </span><a href="#local-6989586621684273216"><span class="hs-identifier hs-var">ty_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-561"></a><span>        </span><span class="hs-comment">-- drop tag slot</span><span>
</span><a name="line-562"></a><span>
</span><a name="line-563"></a><span>      </span><a name="local-6989586621684273219"><a href="#local-6989586621684273219"><span class="hs-identifier">tag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConTag</span><span> </span><a href="#local-6989586621684273215"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-564"></a><span>
</span><a name="line-565"></a><span>      </span><a name="local-6989586621684273220"><a href="#local-6989586621684273220"><span class="hs-identifier">layout'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">layoutUbxSum</span><span> </span><a href="#local-6989586621684273218"><span class="hs-identifier hs-var">sum_slots</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">typeSlotTy</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="StgSyn.html#stgArgType"><span class="hs-identifier hs-var">stgArgType</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684273217"><span class="hs-identifier hs-var">args0</span></a><span class="hs-special">)</span><span>
</span><a name="line-566"></a><span>      </span><a name="local-6989586621684273221"><a href="#local-6989586621684273221"><span class="hs-identifier">tag_arg</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgLitArg"><span class="hs-identifier hs-var">StgLitArg</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitNumber</span><span> </span><span class="hs-identifier hs-var">LitNumInt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621684273219"><span class="hs-identifier hs-var">tag</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">intPrimTy</span><span class="hs-special">)</span><span>
</span><a name="line-567"></a><span>      </span><a name="local-6989586621684273222"><a href="#local-6989586621684273222"><span class="hs-identifier">arg_idxs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IM.fromList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipEqual</span><span> </span><span class="hs-string">&quot;mkUbxSum&quot;</span><span> </span><a href="#local-6989586621684273220"><span class="hs-identifier hs-var">layout'</span></a><span> </span><a href="#local-6989586621684273217"><span class="hs-identifier hs-var">args0</span></a><span class="hs-special">)</span><span>
</span><a name="line-568"></a><span>
</span><a name="line-569"></a><span>      </span><span class="hs-identifier">mkTupArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SlotTy</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IM.IntMap</span><span> </span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span class="hs-special">]</span><span>
</span><a name="line-570"></a><span>      </span><a name="local-6989586621684273223"><a href="#local-6989586621684273223"><span class="hs-identifier">mkTupArgs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-571"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-572"></a><span>      </span><span class="hs-identifier">mkTupArgs</span><span> </span><a name="local-6989586621684273225"><a href="#local-6989586621684273225"><span class="hs-identifier">arg_idx</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684273226"><a href="#local-6989586621684273226"><span class="hs-identifier">slot</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684273227"><a href="#local-6989586621684273227"><span class="hs-identifier">slots_left</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684273228"><a href="#local-6989586621684273228"><span class="hs-identifier">arg_map</span></a></a><span>
</span><a name="line-573"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684273229"><a href="#local-6989586621684273229"><span class="hs-identifier">stg_arg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">IM.lookup</span><span> </span><a href="#local-6989586621684273225"><span class="hs-identifier hs-var">arg_idx</span></a><span> </span><a href="#local-6989586621684273228"><span class="hs-identifier hs-var">arg_map</span></a><span>
</span><a name="line-574"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684273229"><span class="hs-identifier hs-var">stg_arg</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684273223"><span class="hs-identifier hs-var">mkTupArgs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684273225"><span class="hs-identifier hs-var">arg_idx</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684273227"><span class="hs-identifier hs-var">slots_left</span></a><span> </span><a href="#local-6989586621684273228"><span class="hs-identifier hs-var">arg_map</span></a><span>
</span><a name="line-575"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-576"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684273224"><span class="hs-identifier hs-var">slotRubbishArg</span></a><span> </span><a href="#local-6989586621684273226"><span class="hs-identifier hs-var">slot</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684273223"><span class="hs-identifier hs-var">mkTupArgs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684273225"><span class="hs-identifier hs-var">arg_idx</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684273227"><span class="hs-identifier hs-var">slots_left</span></a><span> </span><a href="#local-6989586621684273228"><span class="hs-identifier hs-var">arg_map</span></a><span>
</span><a name="line-577"></a><span>
</span><a name="line-578"></a><span>      </span><span class="hs-identifier">slotRubbishArg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SlotTy</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span>
</span><a name="line-579"></a><span>      </span><a name="local-6989586621684273224"><a href="#local-6989586621684273224"><span class="hs-identifier">slotRubbishArg</span></a></a><span> </span><span class="hs-identifier hs-var">PtrSlot</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><span class="hs-identifier hs-var">aBSENT_SUM_FIELD_ERROR_ID</span><span>
</span><a name="line-580"></a><span>                         </span><span class="hs-comment">-- See Note [aBSENT_SUM_FIELD_ERROR_ID] in MkCore</span><span>
</span><a name="line-581"></a><span>      </span><span class="hs-identifier">slotRubbishArg</span><span> </span><span class="hs-identifier hs-var">WordSlot</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgLitArg"><span class="hs-identifier hs-var">StgLitArg</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitNumber</span><span> </span><span class="hs-identifier hs-var">LitNumWord</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier hs-var">wordPrimTy</span><span class="hs-special">)</span><span>
</span><a name="line-582"></a><span>      </span><span class="hs-identifier">slotRubbishArg</span><span> </span><span class="hs-identifier hs-var">Word64Slot</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgLitArg"><span class="hs-identifier hs-var">StgLitArg</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitNumber</span><span> </span><span class="hs-identifier hs-var">LitNumWord64</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier hs-var">word64PrimTy</span><span class="hs-special">)</span><span>
</span><a name="line-583"></a><span>      </span><span class="hs-identifier">slotRubbishArg</span><span> </span><span class="hs-identifier hs-var">FloatSlot</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgLitArg"><span class="hs-identifier hs-var">StgLitArg</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitFloat</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-584"></a><span>      </span><span class="hs-identifier">slotRubbishArg</span><span> </span><span class="hs-identifier hs-var">DoubleSlot</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgLitArg"><span class="hs-identifier hs-var">StgLitArg</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitDouble</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-585"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-586"></a><span>      </span><a href="#local-6989586621684273221"><span class="hs-identifier hs-var">tag_arg</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684273223"><span class="hs-identifier hs-var">mkTupArgs</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621684273218"><span class="hs-identifier hs-var">sum_slots</span></a><span> </span><a href="#local-6989586621684273222"><span class="hs-identifier hs-var">arg_idxs</span></a><span>
</span><a name="line-587"></a><span>
</span><a name="line-588"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-589"></a><span>
</span><a name="line-590"></a><span class="hs-comment">{-
For arguments (StgArg) and binders (Id) we have two kind of unarisation:

  - When unarising function arg binders and arguments, we don't want to remove
    void binders and arguments. For example,

      f :: (# (# #), (# #) #) -&gt; Void# -&gt; RealWorld# -&gt; ...
      f x y z = &lt;body&gt;

    Here after unarise we should still get a function with arity 3. Similarly
    in the call site we shouldn't remove void arguments:

      f (# (# #), (# #) #) voidId rw

    When unarising &lt;body&gt;, we extend the environment with these binders:

      x :-&gt; MultiVal [], y :-&gt; MultiVal [], z :-&gt; MultiVal []

    Because their rep types are `MultiRep []` (aka. void). This means that when
    we see `x` in a function argument position, we actually replace it with a
    void argument. When we see it in a DataCon argument position, we just get
    rid of it, because DataCon applications in STG are always saturated.

  - When unarising case alternative binders we remove void binders, but we
    still update the environment the same way, because those binders may be
    used in the RHS. Example:

      case x of y {
        (# x1, x2, x3 #) -&gt; &lt;RHS&gt;
      }

    We know that y can't be void, because we don't scrutinize voids, so x will
    be unarised to some number of arguments, and those arguments will have at
    least one non-void thing. So in the rho we will have something like:

      x :-&gt; MultiVal [xu1, xu2]

    Now, after we eliminate void binders in the pattern, we get exactly the same
    number of binders, and extend rho again with these:

      x1 :-&gt; UnaryVal xu1
      x2 :-&gt; MultiVal [] -- x2 is void
      x3 :-&gt; UnaryVal xu2

    Now when we see x2 in a function argument position or in return position, we
    generate void#. In constructor argument position, we just remove it.

So in short, when we have a void id,

  - We keep it if it's a lambda argument binder or
                       in argument position of an application.

  - We remove it if it's a DataCon field binder or
                         in argument position of a DataCon application.
-}</span><span>
</span><a name="line-645"></a><span>
</span><a name="line-646"></a><span class="hs-identifier">unariseArgBinder</span><span>
</span><a name="line-647"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-comment">-- data con arg?</span><span>
</span><a name="line-648"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-649"></a><a name="unariseArgBinder"><a href="UnariseStg.html#unariseArgBinder"><span class="hs-identifier">unariseArgBinder</span></a></a><span> </span><a name="local-6989586621684273230"><a href="#local-6989586621684273230"><span class="hs-identifier">is_con_arg</span></a></a><span> </span><a name="local-6989586621684273231"><a href="#local-6989586621684273231"><span class="hs-identifier">rho</span></a></a><span> </span><a name="local-6989586621684273232"><a href="#local-6989586621684273232"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-650"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">typePrimRep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621684273232"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-651"></a><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-652"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684273230"><span class="hs-identifier hs-var">is_con_arg</span></a><span>
</span><a name="line-653"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#extendRho"><span class="hs-identifier hs-var">extendRho</span></a><span> </span><a href="#local-6989586621684273231"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273232"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#MultiVal"><span class="hs-identifier hs-var">MultiVal</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-654"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-comment">-- fun arg, do not remove void binders</span><span>
</span><a name="line-655"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#extendRho"><span class="hs-identifier hs-var">extendRho</span></a><span> </span><a href="#local-6989586621684273231"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273232"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#MultiVal"><span class="hs-identifier hs-var">MultiVal</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">voidArgId</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-656"></a><span>
</span><a name="line-657"></a><span>    </span><span class="hs-special">[</span><a name="local-6989586621684273233"><a href="#local-6989586621684273233"><span class="hs-identifier">rep</span></a></a><span class="hs-special">]</span><span>
</span><a name="line-658"></a><span>      </span><span class="hs-comment">-- Arg represented as single variable, but original type may still be an</span><span>
</span><a name="line-659"></a><span>      </span><span class="hs-comment">-- unboxed sum/tuple, e.g. (# Void# | Void# #).</span><span>
</span><a name="line-660"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-661"></a><span>      </span><span class="hs-comment">-- While not unarising the binder in this case does not break any programs</span><span>
</span><a name="line-662"></a><span>      </span><span class="hs-comment">-- (because it unarises to a single variable), it triggers StgLint as we</span><span>
</span><a name="line-663"></a><span>      </span><span class="hs-comment">-- break the the post-unarisation invariant that says unboxed tuple/sum</span><span>
</span><a name="line-664"></a><span>      </span><span class="hs-comment">-- binders should vanish. See Note [Post-unarisation invariants].</span><span>
</span><a name="line-665"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isUnboxedSumType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621684273232"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">isUnboxedTupleType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621684273232"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-666"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621684273234"><a href="#local-6989586621684273234"><span class="hs-identifier">x'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UnariseStg.html#mkId"><span class="hs-identifier hs-var">mkId</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkFastString</span><span> </span><span class="hs-string">&quot;us&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">primRepToType</span><span> </span><a href="#local-6989586621684273233"><span class="hs-identifier hs-var">rep</span></a><span class="hs-special">)</span><span>
</span><a name="line-667"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#extendRho"><span class="hs-identifier hs-var">extendRho</span></a><span> </span><a href="#local-6989586621684273231"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273232"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#MultiVal"><span class="hs-identifier hs-var">MultiVal</span></a><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a href="#local-6989586621684273234"><span class="hs-identifier hs-var">x'</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684273234"><span class="hs-identifier hs-var">x'</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-668"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-669"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684273231"><span class="hs-identifier hs-var">rho</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684273232"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-670"></a><span>
</span><a name="line-671"></a><span>    </span><a name="local-6989586621684273235"><a href="#local-6989586621684273235"><span class="hs-identifier">reps</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-672"></a><span>      </span><a name="local-6989586621684273236"><a href="#local-6989586621684273236"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UnariseStg.html#mkIds"><span class="hs-identifier hs-var">mkIds</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkFastString</span><span> </span><span class="hs-string">&quot;us&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">primRepToType</span><span> </span><a href="#local-6989586621684273235"><span class="hs-identifier hs-var">reps</span></a><span class="hs-special">)</span><span>
</span><a name="line-673"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#extendRho"><span class="hs-identifier hs-var">extendRho</span></a><span> </span><a href="#local-6989586621684273231"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273232"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#MultiVal"><span class="hs-identifier hs-var">MultiVal</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a href="#local-6989586621684273236"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684273236"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-674"></a><span>
</span><a name="line-675"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-676"></a><span>
</span><a name="line-677"></a><span class="hs-comment">-- | MultiVal a function argument. Never returns an empty list.</span><span>
</span><a name="line-678"></a><span class="hs-identifier">unariseFunArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span class="hs-special">]</span><span>
</span><a name="line-679"></a><a name="unariseFunArg"><a href="UnariseStg.html#unariseFunArg"><span class="hs-identifier">unariseFunArg</span></a></a><span> </span><a name="local-6989586621684273237"><a href="#local-6989586621684273237"><span class="hs-identifier">rho</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a name="local-6989586621684273238"><a href="#local-6989586621684273238"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-680"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupVarEnv</span><span> </span><a href="#local-6989586621684273237"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273238"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-681"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#MultiVal"><span class="hs-identifier hs-var">MultiVal</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="UnariseStg.html#voidArg"><span class="hs-identifier hs-var">voidArg</span></a><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- NB: do not remove void args</span><span>
</span><a name="line-682"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#MultiVal"><span class="hs-identifier hs-var">MultiVal</span></a><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-683"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#UnaryVal"><span class="hs-identifier hs-var">UnaryVal</span></a><span> </span><a name="local-6989586621684273240"><a href="#local-6989586621684273240"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684273240"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">]</span><span>
</span><a name="line-684"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a href="#local-6989586621684273238"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">]</span><span>
</span><a name="line-685"></a><span class="hs-identifier">unariseFunArg</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684273241"><a href="#local-6989586621684273241"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684273241"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">]</span><span>
</span><a name="line-686"></a><span>
</span><a name="line-687"></a><span class="hs-identifier">unariseFunArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span class="hs-special">]</span><span>
</span><a name="line-688"></a><a name="unariseFunArgs"><a href="UnariseStg.html#unariseFunArgs"><span class="hs-identifier">unariseFunArgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="UnariseStg.html#unariseFunArg"><span class="hs-identifier hs-var">unariseFunArg</span></a><span>
</span><a name="line-689"></a><span>
</span><a name="line-690"></a><span class="hs-identifier">unariseFunArgBinders</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-691"></a><a name="unariseFunArgBinders"><a href="UnariseStg.html#unariseFunArgBinders"><span class="hs-identifier">unariseFunArgBinders</span></a></a><span> </span><a name="local-6989586621684273242"><a href="#local-6989586621684273242"><span class="hs-identifier">rho</span></a></a><span> </span><a name="local-6989586621684273243"><a href="#local-6989586621684273243"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">second</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">mapAccumLM</span><span> </span><a href="UnariseStg.html#unariseFunArgBinder"><span class="hs-identifier hs-var">unariseFunArgBinder</span></a><span> </span><a href="#local-6989586621684273242"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273243"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-692"></a><span>
</span><a name="line-693"></a><span class="hs-comment">-- Result list of binders is never empty</span><span>
</span><a name="line-694"></a><span class="hs-identifier">unariseFunArgBinder</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-695"></a><a name="unariseFunArgBinder"><a href="UnariseStg.html#unariseFunArgBinder"><span class="hs-identifier">unariseFunArgBinder</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UnariseStg.html#unariseArgBinder"><span class="hs-identifier hs-var">unariseArgBinder</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-696"></a><span>
</span><a name="line-697"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-698"></a><span>
</span><a name="line-699"></a><span class="hs-comment">-- | MultiVal a DataCon argument. Returns an empty list when argument is void.</span><span>
</span><a name="line-700"></a><span class="hs-identifier">unariseConArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#InStgArg"><span class="hs-identifier hs-type">InStgArg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#OutStgArg"><span class="hs-identifier hs-type">OutStgArg</span></a><span class="hs-special">]</span><span>
</span><a name="line-701"></a><a name="unariseConArg"><a href="UnariseStg.html#unariseConArg"><span class="hs-identifier">unariseConArg</span></a></a><span> </span><a name="local-6989586621684273244"><a href="#local-6989586621684273244"><span class="hs-identifier">rho</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a name="local-6989586621684273245"><a href="#local-6989586621684273245"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-702"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupVarEnv</span><span> </span><a href="#local-6989586621684273244"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273245"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-703"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#UnaryVal"><span class="hs-identifier hs-var">UnaryVal</span></a><span> </span><a name="local-6989586621684273246"><a href="#local-6989586621684273246"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684273246"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">]</span><span>
</span><a name="line-704"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#MultiVal"><span class="hs-identifier hs-var">MultiVal</span></a><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">as</span><span>      </span><span class="hs-comment">-- 'as' can be empty</span><span>
</span><a name="line-705"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-706"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isVoidTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621684273245"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- e.g. C realWorld#</span><span>
</span><a name="line-707"></a><span>                                  </span><span class="hs-comment">-- Here realWorld# is not in the envt, but</span><span>
</span><a name="line-708"></a><span>                                  </span><span class="hs-comment">-- is a void, and so should be eliminated</span><span>
</span><a name="line-709"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a href="#local-6989586621684273245"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">]</span><span>
</span><a name="line-710"></a><span class="hs-identifier">unariseConArg</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684273248"><a href="#local-6989586621684273248"><span class="hs-identifier">arg</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="StgSyn.html#StgLitArg"><span class="hs-identifier hs-var">StgLitArg</span></a><span> </span><a name="local-6989586621684273249"><a href="#local-6989586621684273249"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-711"></a><span>    </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isVoidTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">literalType</span><span> </span><span class="hs-identifier">lit</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- We have no void literals</span><span>
</span><a name="line-712"></a><span>    </span><span class="hs-special">[</span><a href="#local-6989586621684273248"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">]</span><span>
</span><a name="line-713"></a><span>
</span><a name="line-714"></a><span class="hs-identifier">unariseConArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#InStgArg"><span class="hs-identifier hs-type">InStgArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#OutStgArg"><span class="hs-identifier hs-type">OutStgArg</span></a><span class="hs-special">]</span><span>
</span><a name="line-715"></a><a name="unariseConArgs"><a href="UnariseStg.html#unariseConArgs"><span class="hs-identifier">unariseConArgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="UnariseStg.html#unariseConArg"><span class="hs-identifier hs-var">unariseConArg</span></a><span>
</span><a name="line-716"></a><span>
</span><a name="line-717"></a><span class="hs-identifier">unariseConArgBinders</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-718"></a><a name="unariseConArgBinders"><a href="UnariseStg.html#unariseConArgBinders"><span class="hs-identifier">unariseConArgBinders</span></a></a><span> </span><a name="local-6989586621684273250"><a href="#local-6989586621684273250"><span class="hs-identifier">rho</span></a></a><span> </span><a name="local-6989586621684273251"><a href="#local-6989586621684273251"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">second</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">mapAccumLM</span><span> </span><a href="UnariseStg.html#unariseConArgBinder"><span class="hs-identifier hs-var">unariseConArgBinder</span></a><span> </span><a href="#local-6989586621684273250"><span class="hs-identifier hs-var">rho</span></a><span> </span><a href="#local-6989586621684273251"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-719"></a><span>
</span><a name="line-720"></a><span class="hs-comment">-- Different from `unariseFunArgBinder`: result list of binders may be empty.</span><span>
</span><a name="line-721"></a><span class="hs-comment">-- See DataCon applications case in Note [Post-unarisation invariants].</span><span>
</span><a name="line-722"></a><span class="hs-identifier">unariseConArgBinder</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#UnariseEnv"><span class="hs-identifier hs-type">UnariseEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-723"></a><a name="unariseConArgBinder"><a href="UnariseStg.html#unariseConArgBinder"><span class="hs-identifier">unariseConArgBinder</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UnariseStg.html#unariseArgBinder"><span class="hs-identifier hs-var">unariseArgBinder</span></a><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-724"></a><span>
</span><a name="line-725"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-726"></a><span>
</span><a name="line-727"></a><span class="hs-identifier">mkIds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">UnaryType</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>
</span><a name="line-728"></a><a name="mkIds"><a href="UnariseStg.html#mkIds"><span class="hs-identifier">mkIds</span></a></a><span> </span><a name="local-6989586621684273252"><a href="#local-6989586621684273252"><span class="hs-identifier">fs</span></a></a><span> </span><a name="local-6989586621684273253"><a href="#local-6989586621684273253"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="UnariseStg.html#mkId"><span class="hs-identifier hs-var">mkId</span></a><span> </span><a href="#local-6989586621684273252"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684273253"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-729"></a><span>
</span><a name="line-730"></a><span class="hs-identifier">mkId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UnaryType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-731"></a><a name="mkId"><a href="UnariseStg.html#mkId"><span class="hs-identifier">mkId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkSysLocalOrCoVarM</span><span>
</span><a name="line-732"></a><span>
</span><a name="line-733"></a><span class="hs-identifier">isMultiValBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-734"></a><a name="isMultiValBndr"><a href="UnariseStg.html#isMultiValBndr"><span class="hs-identifier">isMultiValBndr</span></a></a><span> </span><a name="local-6989586621684273254"><a href="#local-6989586621684273254"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-735"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">_</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">typePrimRep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621684273254"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-736"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-737"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-738"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-739"></a><span>
</span><a name="line-740"></a><span class="hs-identifier">isUnboxedSumBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-741"></a><a name="isUnboxedSumBndr"><a href="UnariseStg.html#isUnboxedSumBndr"><span class="hs-identifier">isUnboxedSumBndr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isUnboxedSumType</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">idType</span><span>
</span><a name="line-742"></a><span>
</span><a name="line-743"></a><span class="hs-identifier">isUnboxedTupleBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-744"></a><a name="isUnboxedTupleBndr"><a href="UnariseStg.html#isUnboxedTupleBndr"><span class="hs-identifier">isUnboxedTupleBndr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isUnboxedTupleType</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">idType</span><span>
</span><a name="line-745"></a><span>
</span><a name="line-746"></a><span class="hs-identifier">mkTuple</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#StgExpr"><span class="hs-identifier hs-type">StgExpr</span></a><span>
</span><a name="line-747"></a><a name="mkTuple"><a href="UnariseStg.html#mkTuple"><span class="hs-identifier">mkTuple</span></a></a><span> </span><a name="local-6989586621684273255"><a href="#local-6989586621684273255"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgConApp"><span class="hs-identifier hs-var">StgConApp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tupleDataCon</span><span> </span><span class="hs-identifier hs-var">Unboxed</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621684273255"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684273255"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="StgSyn.html#stgArgType"><span class="hs-identifier hs-var">stgArgType</span></a><span> </span><a href="#local-6989586621684273255"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-748"></a><span>
</span><a name="line-749"></a><span class="hs-identifier">tagAltTy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgSyn.html#AltType"><span class="hs-identifier hs-type">AltType</span></a><span>
</span><a name="line-750"></a><a name="tagAltTy"><a href="UnariseStg.html#tagAltTy"><span class="hs-identifier">tagAltTy</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#PrimAlt"><span class="hs-identifier hs-var">PrimAlt</span></a><span> </span><span class="hs-identifier hs-var">IntRep</span><span>
</span><a name="line-751"></a><span>
</span><a name="line-752"></a><span class="hs-identifier">tagTy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-753"></a><a name="tagTy"><a href="UnariseStg.html#tagTy"><span class="hs-identifier">tagTy</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">intPrimTy</span><span>
</span><a name="line-754"></a><span>
</span><a name="line-755"></a><span class="hs-identifier">voidArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span>
</span><a name="line-756"></a><a name="voidArg"><a href="UnariseStg.html#voidArg"><span class="hs-identifier">voidArg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><span class="hs-identifier hs-var">voidPrimId</span><span>
</span><a name="line-757"></a><span>
</span><a name="line-758"></a><span class="hs-identifier">mkDefaultLitAlt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgAlt"><span class="hs-identifier hs-type">StgAlt</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgAlt"><span class="hs-identifier hs-type">StgAlt</span></a><span class="hs-special">]</span><span>
</span><a name="line-759"></a><span class="hs-comment">-- We have an exhauseive list of literal alternatives</span><span>
</span><a name="line-760"></a><span class="hs-comment">--    1# -&gt; e1</span><span>
</span><a name="line-761"></a><span class="hs-comment">--    2# -&gt; e2</span><span>
</span><a name="line-762"></a><span class="hs-comment">-- Since they are exhaustive, we can replace one with DEFAULT, to avoid</span><span>
</span><a name="line-763"></a><span class="hs-comment">-- generating a final test. Remember, the DEFAULT comes first if it exists.</span><span>
</span><a name="line-764"></a><a name="mkDefaultLitAlt"><a href="UnariseStg.html#mkDefaultLitAlt"><span class="hs-identifier">mkDefaultLitAlt</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;elimUbxSumExpr.mkDefaultAlt&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Empty alts&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-765"></a><span class="hs-identifier">mkDefaultLitAlt</span><span> </span><a name="local-6989586621684273256"><a href="#local-6989586621684273256"><span class="hs-identifier">alts</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DEFAULT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684273256"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-766"></a><span class="hs-identifier">mkDefaultLitAlt</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitAlt</span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684273257"><a href="#local-6989586621684273257"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684273258"><a href="#local-6989586621684273258"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DEFAULT</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684273257"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684273258"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-767"></a><span class="hs-identifier">mkDefaultLitAlt</span><span> </span><a name="local-6989586621684273259"><a href="#local-6989586621684273259"><span class="hs-identifier">alts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;mkDefaultLitAlt&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Not a lit alt:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684273259"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">)</span><span>
</span><a name="line-768"></a></pre></body></html>