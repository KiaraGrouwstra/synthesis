<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns, CPP, ScopedTypeVariables #-}</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-4"></a><span class="hs-comment">--</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- The register allocator</span><span>
</span><a name="line-6"></a><span class="hs-comment">--</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- (c) The University of Glasgow 2004</span><span>
</span><a name="line-8"></a><span class="hs-comment">--</span><span>
</span><a name="line-9"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-comment">{-
The algorithm is roughly:

  1) Compute strongly connected components of the basic block list.

  2) Compute liveness (mapping from pseudo register to
     point(s) of death?).

  3) Walk instructions in each basic block.  We keep track of
        (a) Free real registers (a bitmap?)
        (b) Current assignment of temporaries to machine registers and/or
            spill slots (call this the &quot;assignment&quot;).
        (c) Partial mapping from basic block ids to a virt-to-loc mapping.
            When we first encounter a branch to a basic block,
            we fill in its entry in this table with the current mapping.

     For each instruction:
        (a) For each temporary *read* by the instruction:
            If the temporary does not have a real register allocation:
                - Allocate a real register from the free list.  If
                  the list is empty:
                  - Find a temporary to spill.  Pick one that is
                    not used in this instruction (ToDo: not
                    used for a while...)
                  - generate a spill instruction
                - If the temporary was previously spilled,
                  generate an instruction to read the temp from its spill loc.
            (optimisation: if we can see that a real register is going to
            be used soon, then don't use it for allocation).

        (b) For each real register clobbered by this instruction:
            If a temporary resides in it,
                If the temporary is live after this instruction,
                    Move the temporary to another (non-clobbered &amp; free) reg,
                    or spill it to memory.  Mark the temporary as residing
                    in both memory and a register if it was spilled (it might
                    need to be read by this instruction).

            (ToDo: this is wrong for jump instructions?)

            We do this after step (a), because if we start with
               movq v1, %rsi
            which is an instruction that clobbers %rsi, if v1 currently resides
            in %rsi we want to get
               movq %rsi, %freereg
               movq %rsi, %rsi     -- will disappear
            instead of
               movq %rsi, %freereg
               movq %freereg, %rsi

        (c) Update the current assignment

        (d) If the instruction is a branch:
              if the destination block already has a register assignment,
                Generate a new block with fixup code and redirect the
                jump to the new block.
              else,
                Update the block id-&gt;assignment mapping with the current
                assignment.

        (e) Delete all register assignments for temps which are read
            (only) and die here.  Update the free register list.

        (f) Mark all registers clobbered by this instruction as not free,
            and mark temporaries which have been spilled due to clobbering
            as in memory (step (a) marks then as in both mem &amp; reg).

        (g) For each temporary *written* by this instruction:
            Allocate a real register as for (b), spilling something
            else if necessary.
                - except when updating the assignment, drop any memory
                  locations that the temporary was previously in, since
                  they will be no longer valid after this instruction.

        (h) Delete all register assignments for temps which are
            written and die here (there should rarely be any).  Update
            the free register list.

        (i) Rewrite the instruction with the new mapping.

        (j) For each spilled reg known to be now dead, re-add its stack slot
            to the free list.

-}</span><span>
</span><a name="line-95"></a><span>
</span><a name="line-96"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">RegAlloc.Linear.Main</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-97"></a><span>        </span><a href="RegAlloc.Linear.Main.html#regAlloc"><span class="hs-identifier hs-var">regAlloc</span></a><span class="hs-special">,</span><span>
</span><a name="line-98"></a><span>        </span><span class="hs-keyword">module</span><span>  </span><a href="RegAlloc.Linear.Base.html"><span class="hs-identifier">RegAlloc.Linear.Base</span></a><span class="hs-special">,</span><span>
</span><a name="line-99"></a><span>        </span><span class="hs-keyword">module</span><span>  </span><a href="RegAlloc.Linear.Stats.html"><span class="hs-identifier">RegAlloc.Linear.Stats</span></a><span>
</span><a name="line-100"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-104"></a><span>
</span><a name="line-105"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span class="hs-keyword">import</span><span> </span><a href="RegAlloc.Linear.State.html"><span class="hs-identifier">RegAlloc.Linear.State</span></a><span>
</span><a name="line-108"></a><span class="hs-keyword">import</span><span> </span><a href="RegAlloc.Linear.Base.html"><span class="hs-identifier">RegAlloc.Linear.Base</span></a><span>
</span><a name="line-109"></a><span class="hs-keyword">import</span><span> </span><a href="RegAlloc.Linear.StackMap.html"><span class="hs-identifier">RegAlloc.Linear.StackMap</span></a><span>
</span><a name="line-110"></a><span class="hs-keyword">import</span><span> </span><a href="RegAlloc.Linear.FreeRegs.html"><span class="hs-identifier">RegAlloc.Linear.FreeRegs</span></a><span>
</span><a name="line-111"></a><span class="hs-keyword">import</span><span> </span><a href="RegAlloc.Linear.Stats.html"><span class="hs-identifier">RegAlloc.Linear.Stats</span></a><span>
</span><a name="line-112"></a><span class="hs-keyword">import</span><span> </span><a href="RegAlloc.Linear.JoinToTargets.html"><span class="hs-identifier">RegAlloc.Linear.JoinToTargets</span></a><span>
</span><a name="line-113"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="RegAlloc.Linear.PPC.FreeRegs.html"><span class="hs-identifier">RegAlloc.Linear.PPC.FreeRegs</span></a><span>    </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">PPC</span><span>
</span><a name="line-114"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="RegAlloc.Linear.SPARC.FreeRegs.html"><span class="hs-identifier">RegAlloc.Linear.SPARC.FreeRegs</span></a><span>  </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">SPARC</span><span>
</span><a name="line-115"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="RegAlloc.Linear.X86.FreeRegs.html"><span class="hs-identifier">RegAlloc.Linear.X86.FreeRegs</span></a><span>    </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">X86</span><span>
</span><a name="line-116"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="RegAlloc.Linear.X86_64.FreeRegs.html"><span class="hs-identifier">RegAlloc.Linear.X86_64.FreeRegs</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">X86_64</span><span>
</span><a name="line-117"></a><span class="hs-keyword">import</span><span> </span><a href="TargetReg.html"><span class="hs-identifier">TargetReg</span></a><span>
</span><a name="line-118"></a><span class="hs-keyword">import</span><span> </span><a href="RegAlloc.Liveness.html"><span class="hs-identifier">RegAlloc.Liveness</span></a><span>
</span><a name="line-119"></a><span class="hs-keyword">import</span><span> </span><a href="Instruction.html"><span class="hs-identifier">Instruction</span></a><span>
</span><a name="line-120"></a><span class="hs-keyword">import</span><span> </span><a href="Reg.html"><span class="hs-identifier">Reg</span></a><span>
</span><a name="line-121"></a><span>
</span><a name="line-122"></a><span class="hs-keyword">import</span><span> </span><a href="BlockId.html"><span class="hs-identifier">BlockId</span></a><span>
</span><a name="line-123"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Collections.html"><span class="hs-identifier">Hoopl.Collections</span></a><span>
</span><a name="line-124"></a><span class="hs-keyword">import</span><span> </span><a href="Cmm.html"><span class="hs-identifier">Cmm</span></a><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#RegSet"><span class="hs-identifier hs-type">RegSet</span></a><span class="hs-special">)</span><span>
</span><a name="line-125"></a><span>
</span><a name="line-126"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Digraph</span><span>
</span><a name="line-127"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-128"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Unique</span><span>
</span><a name="line-129"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSet</span><span>
</span><a name="line-130"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqFM</span><span>
</span><a name="line-131"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSupply</span><span>
</span><a name="line-132"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-133"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Platform</span><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span>
</span><a name="line-136"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-137"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-138"></a><span>
</span><a name="line-139"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-140"></a><span class="hs-comment">-- Top level of the register allocator</span><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span class="hs-comment">-- Allocate registers</span><span>
</span><a name="line-143"></a><span class="hs-identifier">regAlloc</span><span>
</span><a name="line-144"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684901417"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">,</span><span> </span><a href="Instruction.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a><span> </span><a href="#local-6989586621684901417"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">)</span><span>
</span><a name="line-145"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-146"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RegAlloc.Liveness.html#LiveCmmDecl"><span class="hs-identifier hs-type">LiveCmmDecl</span></a><span> </span><a href="#local-6989586621684901418"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684901417"><span class="hs-identifier hs-type">instr</span></a><span>
</span><a name="line-147"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">(</span><span> </span><a href="Instruction.html#NatCmmDecl"><span class="hs-identifier hs-type">NatCmmDecl</span></a><span> </span><a href="#local-6989586621684901418"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684901417"><span class="hs-identifier hs-type">instr</span></a><span>
</span><a name="line-148"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span>  </span><span class="hs-comment">-- number of extra stack slots required,</span><span>
</span><a name="line-149"></a><span>                               </span><span class="hs-comment">-- beyond maxSpillSlots</span><span>
</span><a name="line-150"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="RegAlloc.Linear.Base.html#RegAllocStats"><span class="hs-identifier hs-type">RegAllocStats</span></a><span>
</span><a name="line-151"></a><span>                  </span><span class="hs-special">)</span><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><a name="regAlloc"><a href="RegAlloc.Linear.Main.html#regAlloc"><span class="hs-identifier">regAlloc</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmData"><span class="hs-identifier hs-var">CmmData</span></a><span> </span><a name="local-6989586621684901419"><a href="#local-6989586621684901419"><span class="hs-identifier">sec</span></a></a><span> </span><a name="local-6989586621684901420"><a href="#local-6989586621684901420"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-154"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span>
</span><a name="line-155"></a><span>                </span><span class="hs-special">(</span><span> </span><a href="Cmm.html#CmmData"><span class="hs-identifier hs-var">CmmData</span></a><span> </span><a href="#local-6989586621684901419"><span class="hs-identifier hs-var">sec</span></a><span> </span><a href="#local-6989586621684901420"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-156"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-157"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-158"></a><span>
</span><a name="line-159"></a><span class="hs-identifier">regAlloc</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><span class="hs-special">(</span><a href="RegAlloc.Liveness.html#LiveInfo"><span class="hs-identifier hs-var">LiveInfo</span></a><span> </span><a name="local-6989586621684901421"><a href="#local-6989586621684901421"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684901422"><a href="#local-6989586621684901422"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621684901423"><a href="#local-6989586621684901423"><span class="hs-identifier">live</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-160"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a href="#local-6989586621684901421"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621684901422"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621684901423"><span class="hs-identifier hs-var">live</span></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-var">ListGraph</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-161"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-162"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-163"></a><span>
</span><a name="line-164"></a><span class="hs-identifier">regAlloc</span><span> </span><a name="local-6989586621684901424"><a href="#local-6989586621684901424"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a name="local-6989586621684901425"><a href="#local-6989586621684901425"><span class="hs-identifier">static</span></a></a><span> </span><a name="local-6989586621684901426"><a href="#local-6989586621684901426"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621684901427"><a href="#local-6989586621684901427"><span class="hs-identifier">live</span></a></a><span> </span><a name="local-6989586621684901428"><a href="#local-6989586621684901428"><span class="hs-identifier">sccs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-165"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="RegAlloc.Liveness.html#LiveInfo"><span class="hs-identifier hs-var">LiveInfo</span></a><span> </span><a name="local-6989586621684901429"><a href="#local-6989586621684901429"><span class="hs-identifier">info</span></a></a><span> </span><a name="local-6989586621684901430"><a href="#local-6989586621684901430"><span class="hs-identifier">entry_ids</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621684901431"><a href="#local-6989586621684901431"><span class="hs-identifier">first_id</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684901432"><a href="#local-6989586621684901432"><span class="hs-identifier">block_live</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684901425"><span class="hs-identifier hs-var">static</span></a><span>
</span><a name="line-166"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-167"></a><span>                </span><span class="hs-comment">-- do register allocation on each component.</span><span>
</span><a name="line-168"></a><span>                </span><span class="hs-special">(</span><a name="local-6989586621684901433"><a href="#local-6989586621684901433"><span class="hs-identifier">final_blocks</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684901434"><a href="#local-6989586621684901434"><span class="hs-identifier">stats</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684901435"><a href="#local-6989586621684901435"><span class="hs-identifier">stack_use</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-169"></a><span>                        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RegAlloc.Linear.Main.html#linearRegAlloc"><span class="hs-identifier hs-var">linearRegAlloc</span></a><span> </span><a href="#local-6989586621684901424"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684901430"><span class="hs-identifier hs-var">entry_ids</span></a><span> </span><a href="#local-6989586621684901432"><span class="hs-identifier hs-var">block_live</span></a><span> </span><a href="#local-6989586621684901428"><span class="hs-identifier hs-var">sccs</span></a><span>
</span><a name="line-170"></a><span>
</span><a name="line-171"></a><span>                </span><span class="hs-comment">-- make sure the block that was first in the input list</span><span>
</span><a name="line-172"></a><span>                </span><span class="hs-comment">--      stays at the front of the output</span><span>
</span><a name="line-173"></a><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621684901436"><a href="#local-6989586621684901436"><span class="hs-identifier">first'</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684901437"><a href="#local-6989586621684901437"><span class="hs-identifier">rest'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-174"></a><span>                                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partition</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684901431"><span class="hs-identifier hs-var">first_id</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Cmm.html#blockId"><span class="hs-identifier hs-var">blockId</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684901433"><span class="hs-identifier hs-var">final_blocks</span></a><span>
</span><a name="line-175"></a><span>
</span><a name="line-176"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901438"><a href="#local-6989586621684901438"><span class="hs-identifier">max_spill_slots</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RegAlloc.Linear.FreeRegs.html#maxSpillSlots"><span class="hs-identifier hs-var">maxSpillSlots</span></a><span> </span><a href="#local-6989586621684901424"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-177"></a><span>                    </span><a name="local-6989586621684901439"><a href="#local-6989586621684901439"><span class="hs-identifier">extra_stack</span></a></a><span>
</span><a name="line-178"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684901435"><span class="hs-identifier hs-var">stack_use</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621684901438"><span class="hs-identifier hs-var">max_spill_slots</span></a><span>
</span><a name="line-179"></a><span>                      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684901435"><span class="hs-identifier hs-var">stack_use</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621684901438"><span class="hs-identifier hs-var">max_spill_slots</span></a><span class="hs-special">)</span><span>
</span><a name="line-180"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-181"></a><span>                      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-182"></a><span>
</span><a name="line-183"></a><span>                </span><span class="hs-identifier hs-var">return</span><span>  </span><span class="hs-special">(</span><span> </span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a href="#local-6989586621684901429"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621684901426"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621684901427"><span class="hs-identifier hs-var">live</span></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-var">ListGraph</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684901436"><span class="hs-identifier hs-var">first'</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684901437"><span class="hs-identifier hs-var">rest'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-184"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684901439"><span class="hs-identifier hs-var">extra_stack</span></a><span>
</span><a name="line-185"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621684901434"><span class="hs-identifier hs-var">stats</span></a><span class="hs-special">)</span><span>
</span><a name="line-186"></a><span>
</span><a name="line-187"></a><span class="hs-comment">-- bogus. to make non-exhaustive match warning go away.</span><span>
</span><a name="line-188"></a><span class="hs-identifier">regAlloc</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-189"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;RegAllocLinear.regAlloc: no match&quot;</span><span>
</span><a name="line-190"></a><span>
</span><a name="line-191"></a><span>
</span><a name="line-192"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-193"></a><span class="hs-comment">-- Linear sweep to allocate registers</span><span>
</span><a name="line-194"></a><span>
</span><a name="line-195"></a><span>
</span><a name="line-196"></a><span class="hs-comment">-- | Do register allocation on some basic blocks.</span><span>
</span><a name="line-197"></a><span class="hs-comment">--   But be careful to allocate a block in an SCC only if it has</span><span>
</span><a name="line-198"></a><span class="hs-comment">--   an entry in the block map or it is the first block.</span><span>
</span><a name="line-199"></a><span class="hs-comment">--</span><span>
</span><a name="line-200"></a><span class="hs-identifier">linearRegAlloc</span><span>
</span><a name="line-201"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684901416"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">,</span><span> </span><a href="Instruction.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a><span> </span><a href="#local-6989586621684901416"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">)</span><span>
</span><a name="line-202"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-203"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- ^ entry points</span><span>
</span><a name="line-204"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RegAlloc.Liveness.html#BlockMap"><span class="hs-identifier hs-type">BlockMap</span></a><span> </span><a href="RegAlloc.Liveness.html#RegSet"><span class="hs-identifier hs-type">RegSet</span></a><span>
</span><a name="line-205"></a><span>              </span><span class="hs-comment">-- ^ live regs on entry to each basic block</span><span>
</span><a name="line-206"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SCC</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Liveness.html#LiveBasicBlock"><span class="hs-identifier hs-type">LiveBasicBlock</span></a><span> </span><a href="#local-6989586621684901416"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-207"></a><span>              </span><span class="hs-comment">-- ^ instructions annotated with &quot;deaths&quot;</span><span>
</span><a name="line-208"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Instruction.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a><span> </span><a href="#local-6989586621684901416"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="RegAlloc.Linear.Base.html#RegAllocStats"><span class="hs-identifier hs-type">RegAllocStats</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-209"></a><span>
</span><a name="line-210"></a><a name="linearRegAlloc"><a href="RegAlloc.Linear.Main.html#linearRegAlloc"><span class="hs-identifier">linearRegAlloc</span></a></a><span> </span><a name="local-6989586621684901440"><a href="#local-6989586621684901440"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684901441"><a href="#local-6989586621684901441"><span class="hs-identifier">entry_ids</span></a></a><span> </span><a name="local-6989586621684901442"><a href="#local-6989586621684901442"><span class="hs-identifier">block_live</span></a></a><span> </span><a name="local-6989586621684901443"><a href="#local-6989586621684901443"><span class="hs-identifier">sccs</span></a></a><span>
</span><a name="line-211"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">platformArch</span><span> </span><a href="#local-6989586621684901445"><span class="hs-identifier hs-var">platform</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-212"></a><span>      </span><span class="hs-identifier hs-var">ArchX86</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684901444"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.FreeRegs.html#frInitFreeRegs"><span class="hs-identifier hs-var">frInitFreeRegs</span></a><span> </span><a href="#local-6989586621684901445"><span class="hs-identifier hs-var">platform</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="RegAlloc.Linear.X86.FreeRegs.html#FreeRegs"><span class="hs-identifier hs-type">X86.FreeRegs</span></a><span class="hs-special">)</span><span>
</span><a name="line-213"></a><span>      </span><span class="hs-identifier hs-var">ArchX86_64</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684901444"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.FreeRegs.html#frInitFreeRegs"><span class="hs-identifier hs-var">frInitFreeRegs</span></a><span> </span><a href="#local-6989586621684901445"><span class="hs-identifier hs-var">platform</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="RegAlloc.Linear.X86_64.FreeRegs.html#FreeRegs"><span class="hs-identifier hs-type">X86_64.FreeRegs</span></a><span class="hs-special">)</span><span>
</span><a name="line-214"></a><span>      </span><span class="hs-identifier hs-var">ArchSPARC</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684901444"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.FreeRegs.html#frInitFreeRegs"><span class="hs-identifier hs-var">frInitFreeRegs</span></a><span> </span><a href="#local-6989586621684901445"><span class="hs-identifier hs-var">platform</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="RegAlloc.Linear.SPARC.FreeRegs.html#FreeRegs"><span class="hs-identifier hs-type">SPARC.FreeRegs</span></a><span class="hs-special">)</span><span>
</span><a name="line-215"></a><span>      </span><span class="hs-identifier hs-var">ArchSPARC64</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;linearRegAlloc ArchSPARC64&quot;</span><span>
</span><a name="line-216"></a><span>      </span><span class="hs-identifier hs-var">ArchPPC</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684901444"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.FreeRegs.html#frInitFreeRegs"><span class="hs-identifier hs-var">frInitFreeRegs</span></a><span> </span><a href="#local-6989586621684901445"><span class="hs-identifier hs-var">platform</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="RegAlloc.Linear.PPC.FreeRegs.html#FreeRegs"><span class="hs-identifier hs-type">PPC.FreeRegs</span></a><span class="hs-special">)</span><span>
</span><a name="line-217"></a><span>      </span><span class="hs-identifier hs-var">ArchARM</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;linearRegAlloc ArchARM&quot;</span><span>
</span><a name="line-218"></a><span>      </span><span class="hs-identifier hs-var">ArchARM64</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;linearRegAlloc ArchARM64&quot;</span><span>
</span><a name="line-219"></a><span>      </span><span class="hs-identifier hs-var">ArchPPC_64</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684901444"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.FreeRegs.html#frInitFreeRegs"><span class="hs-identifier hs-var">frInitFreeRegs</span></a><span> </span><a href="#local-6989586621684901445"><span class="hs-identifier hs-var">platform</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="RegAlloc.Linear.PPC.FreeRegs.html#FreeRegs"><span class="hs-identifier hs-type">PPC.FreeRegs</span></a><span class="hs-special">)</span><span>
</span><a name="line-220"></a><span>      </span><span class="hs-identifier hs-var">ArchAlpha</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;linearRegAlloc ArchAlpha&quot;</span><span>
</span><a name="line-221"></a><span>      </span><span class="hs-identifier hs-var">ArchMipseb</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;linearRegAlloc ArchMipseb&quot;</span><span>
</span><a name="line-222"></a><span>      </span><span class="hs-identifier hs-var">ArchMipsel</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;linearRegAlloc ArchMipsel&quot;</span><span>
</span><a name="line-223"></a><span>      </span><span class="hs-identifier hs-var">ArchJavaScript</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;linearRegAlloc ArchJavaScript&quot;</span><span>
</span><a name="line-224"></a><span>      </span><span class="hs-identifier hs-var">ArchUnknown</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;linearRegAlloc ArchUnknown&quot;</span><span>
</span><a name="line-225"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-226"></a><span>  </span><a name="local-6989586621684901444"><a href="#local-6989586621684901444"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621684901446"><a href="#local-6989586621684901446"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RegAlloc.Linear.Main.html#linearRegAlloc%27"><span class="hs-identifier hs-var">linearRegAlloc'</span></a><span> </span><a href="#local-6989586621684901440"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684901446"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621684901441"><span class="hs-identifier hs-var">entry_ids</span></a><span> </span><a href="#local-6989586621684901442"><span class="hs-identifier hs-var">block_live</span></a><span> </span><a href="#local-6989586621684901443"><span class="hs-identifier hs-var">sccs</span></a><span>
</span><a name="line-227"></a><span>  </span><a name="local-6989586621684901445"><a href="#local-6989586621684901445"><span class="hs-identifier">platform</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621684901440"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-228"></a><span>
</span><a name="line-229"></a><span class="hs-identifier">linearRegAlloc'</span><span>
</span><a name="line-230"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.FreeRegs.html#FR"><span class="hs-identifier hs-type">FR</span></a><span> </span><a href="#local-6989586621684901414"><span class="hs-identifier hs-type">freeRegs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684901415"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">,</span><span> </span><a href="Instruction.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a><span> </span><a href="#local-6989586621684901415"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">)</span><span>
</span><a name="line-231"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-232"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684901414"><span class="hs-identifier hs-type">freeRegs</span></a><span>
</span><a name="line-233"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">]</span><span>                    </span><span class="hs-comment">-- ^ entry points</span><span>
</span><a name="line-234"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RegAlloc.Liveness.html#BlockMap"><span class="hs-identifier hs-type">BlockMap</span></a><span> </span><a href="RegAlloc.Liveness.html#RegSet"><span class="hs-identifier hs-type">RegSet</span></a><span>              </span><span class="hs-comment">-- ^ live regs on entry to each basic block</span><span>
</span><a name="line-235"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SCC</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Liveness.html#LiveBasicBlock"><span class="hs-identifier hs-type">LiveBasicBlock</span></a><span> </span><a href="#local-6989586621684901415"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- ^ instructions annotated with &quot;deaths&quot;</span><span>
</span><a name="line-236"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Instruction.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a><span> </span><a href="#local-6989586621684901415"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="RegAlloc.Linear.Base.html#RegAllocStats"><span class="hs-identifier hs-type">RegAllocStats</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-237"></a><span>
</span><a name="line-238"></a><a name="linearRegAlloc%27"><a href="RegAlloc.Linear.Main.html#linearRegAlloc%27"><span class="hs-identifier">linearRegAlloc'</span></a></a><span> </span><a name="local-6989586621684901447"><a href="#local-6989586621684901447"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684901448"><a href="#local-6989586621684901448"><span class="hs-identifier">initFreeRegs</span></a></a><span> </span><a name="local-6989586621684901449"><a href="#local-6989586621684901449"><span class="hs-identifier">entry_ids</span></a></a><span> </span><a name="local-6989586621684901450"><a href="#local-6989586621684901450"><span class="hs-identifier">block_live</span></a></a><span> </span><a name="local-6989586621684901451"><a href="#local-6989586621684901451"><span class="hs-identifier">sccs</span></a></a><span>
</span><a name="line-239"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>   </span><a name="local-6989586621684901452"><a href="#local-6989586621684901452"><span class="hs-identifier">us</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getUniqueSupplyM</span><span>
</span><a name="line-240"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684901453"><a href="#local-6989586621684901453"><span class="hs-identifier">stack</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684901454"><a href="#local-6989586621684901454"><span class="hs-identifier">stats</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684901455"><a href="#local-6989586621684901455"><span class="hs-identifier">blocks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-241"></a><span>                </span><a href="RegAlloc.Linear.State.html#runR"><span class="hs-identifier hs-var">runR</span></a><span> </span><a href="#local-6989586621684901447"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="Hoopl.Collections.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a><span> </span><a href="#local-6989586621684901448"><span class="hs-identifier hs-var">initFreeRegs</span></a><span> </span><a href="RegAlloc.Liveness.html#emptyRegMap"><span class="hs-identifier hs-var">emptyRegMap</span></a><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.StackMap.html#emptyStackMap"><span class="hs-identifier hs-var">emptyStackMap</span></a><span> </span><a href="#local-6989586621684901447"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684901452"><span class="hs-identifier hs-var">us</span></a><span>
</span><a name="line-242"></a><span>                    </span><span class="hs-operator hs-var">$</span><span> </span><a href="RegAlloc.Linear.Main.html#linearRA_SCCs"><span class="hs-identifier hs-var">linearRA_SCCs</span></a><span> </span><a href="#local-6989586621684901449"><span class="hs-identifier hs-var">entry_ids</span></a><span> </span><a href="#local-6989586621684901450"><span class="hs-identifier hs-var">block_live</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621684901451"><span class="hs-identifier hs-var">sccs</span></a><span>
</span><a name="line-243"></a><span>        </span><span class="hs-identifier hs-var">return</span><span>  </span><span class="hs-special">(</span><a href="#local-6989586621684901455"><span class="hs-identifier hs-var">blocks</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684901454"><span class="hs-identifier hs-var">stats</span></a><span class="hs-special">,</span><span> </span><a href="RegAlloc.Linear.StackMap.html#getStackUse"><span class="hs-identifier hs-var">getStackUse</span></a><span> </span><a href="#local-6989586621684901453"><span class="hs-identifier hs-var">stack</span></a><span class="hs-special">)</span><span>
</span><a name="line-244"></a><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span class="hs-identifier">linearRA_SCCs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.FreeRegs.html#FR"><span class="hs-identifier hs-type">FR</span></a><span> </span><a href="#local-6989586621684901412"><span class="hs-identifier hs-type">freeRegs</span></a><span class="hs-special">,</span><span> </span><a href="Instruction.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a><span> </span><a href="#local-6989586621684901413"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684901413"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">)</span><span>
</span><a name="line-247"></a><span>              </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">]</span><span>
</span><a name="line-248"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RegAlloc.Liveness.html#BlockMap"><span class="hs-identifier hs-type">BlockMap</span></a><span> </span><a href="RegAlloc.Liveness.html#RegSet"><span class="hs-identifier hs-type">RegSet</span></a><span>
</span><a name="line-249"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Instruction.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a><span> </span><a href="#local-6989586621684901413"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span>
</span><a name="line-250"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SCC</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Liveness.html#LiveBasicBlock"><span class="hs-identifier hs-type">LiveBasicBlock</span></a><span> </span><a href="#local-6989586621684901413"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-251"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RegAlloc.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a><span> </span><a href="#local-6989586621684901412"><span class="hs-identifier hs-type">freeRegs</span></a><span> </span><span class="hs-special">[</span><a href="Instruction.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a><span> </span><a href="#local-6989586621684901413"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span>
</span><a name="line-252"></a><span>
</span><a name="line-253"></a><a name="linearRA_SCCs"><a href="RegAlloc.Linear.Main.html#linearRA_SCCs"><span class="hs-identifier">linearRA_SCCs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684901456"><a href="#local-6989586621684901456"><span class="hs-identifier">blocksAcc</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-254"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621684901456"><span class="hs-identifier hs-var">blocksAcc</span></a><span>
</span><a name="line-255"></a><span>
</span><a name="line-256"></a><span class="hs-identifier">linearRA_SCCs</span><span> </span><a name="local-6989586621684901457"><a href="#local-6989586621684901457"><span class="hs-identifier">entry_ids</span></a></a><span> </span><a name="local-6989586621684901458"><a href="#local-6989586621684901458"><span class="hs-identifier">block_live</span></a></a><span> </span><a name="local-6989586621684901459"><a href="#local-6989586621684901459"><span class="hs-identifier">blocksAcc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AcyclicSCC</span><span> </span><a name="local-6989586621684901460"><a href="#local-6989586621684901460"><span class="hs-identifier">block</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684901461"><a href="#local-6989586621684901461"><span class="hs-identifier">sccs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-257"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>   </span><a name="local-6989586621684901462"><a href="#local-6989586621684901462"><span class="hs-identifier">blocks'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RegAlloc.Linear.Main.html#processBlock"><span class="hs-identifier hs-var">processBlock</span></a><span> </span><a href="#local-6989586621684901458"><span class="hs-identifier hs-var">block_live</span></a><span> </span><a href="#local-6989586621684901460"><span class="hs-identifier hs-var">block</span></a><span>
</span><a name="line-258"></a><span>        </span><a href="RegAlloc.Linear.Main.html#linearRA_SCCs"><span class="hs-identifier hs-var">linearRA_SCCs</span></a><span> </span><a href="#local-6989586621684901457"><span class="hs-identifier hs-var">entry_ids</span></a><span> </span><a href="#local-6989586621684901458"><span class="hs-identifier hs-var">block_live</span></a><span>
</span><a name="line-259"></a><span>                </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621684901462"><span class="hs-identifier hs-var">blocks'</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684901459"><span class="hs-identifier hs-var">blocksAcc</span></a><span class="hs-special">)</span><span>
</span><a name="line-260"></a><span>                </span><a href="#local-6989586621684901461"><span class="hs-identifier hs-var">sccs</span></a><span>
</span><a name="line-261"></a><span>
</span><a name="line-262"></a><span class="hs-identifier">linearRA_SCCs</span><span> </span><a name="local-6989586621684901463"><a href="#local-6989586621684901463"><span class="hs-identifier">entry_ids</span></a></a><span> </span><a name="local-6989586621684901464"><a href="#local-6989586621684901464"><span class="hs-identifier">block_live</span></a></a><span> </span><a name="local-6989586621684901465"><a href="#local-6989586621684901465"><span class="hs-identifier">blocksAcc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CyclicSCC</span><span> </span><a name="local-6989586621684901466"><a href="#local-6989586621684901466"><span class="hs-identifier">blocks</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684901467"><a href="#local-6989586621684901467"><span class="hs-identifier">sccs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-263"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-264"></a><span>        </span><a name="local-6989586621684901468"><a href="#local-6989586621684901468"><span class="hs-identifier">blockss'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RegAlloc.Linear.Main.html#process"><span class="hs-identifier hs-var">process</span></a><span> </span><a href="#local-6989586621684901463"><span class="hs-identifier hs-var">entry_ids</span></a><span> </span><a href="#local-6989586621684901464"><span class="hs-identifier hs-var">block_live</span></a><span> </span><a href="#local-6989586621684901466"><span class="hs-identifier hs-var">blocks</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-265"></a><span>        </span><a href="RegAlloc.Linear.Main.html#linearRA_SCCs"><span class="hs-identifier hs-var">linearRA_SCCs</span></a><span> </span><a href="#local-6989586621684901463"><span class="hs-identifier hs-var">entry_ids</span></a><span> </span><a href="#local-6989586621684901464"><span class="hs-identifier hs-var">block_live</span></a><span>
</span><a name="line-266"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-6989586621684901468"><span class="hs-identifier hs-var">blockss'</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684901465"><span class="hs-identifier hs-var">blocksAcc</span></a><span class="hs-special">)</span><span>
</span><a name="line-267"></a><span>                </span><a href="#local-6989586621684901467"><span class="hs-identifier hs-var">sccs</span></a><span>
</span><a name="line-268"></a><span>
</span><a name="line-269"></a><span class="hs-comment">{- from John Dias's patch 2008/10/16:
   The linear-scan allocator sometimes allocates a block
   before allocating one of its predecessors, which could lead to
   inconsistent allocations. Make it so a block is only allocated
   if a predecessor has set the &quot;incoming&quot; assignments for the block, or
   if it's the procedure's entry block.

   BL 2009/02: Careful. If the assignment for a block doesn't get set for
   some reason then this function will loop. We should probably do some
   more sanity checking to guard against this eventuality.
-}</span><span>
</span><a name="line-280"></a><span>
</span><a name="line-281"></a><span class="hs-identifier">process</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.FreeRegs.html#FR"><span class="hs-identifier hs-type">FR</span></a><span> </span><a href="#local-6989586621684901410"><span class="hs-identifier hs-type">freeRegs</span></a><span class="hs-special">,</span><span> </span><a href="Instruction.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a><span> </span><a href="#local-6989586621684901411"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684901411"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">)</span><span>
</span><a name="line-282"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">]</span><span>
</span><a name="line-283"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RegAlloc.Liveness.html#BlockMap"><span class="hs-identifier hs-type">BlockMap</span></a><span> </span><a href="RegAlloc.Liveness.html#RegSet"><span class="hs-identifier hs-type">RegSet</span></a><span>
</span><a name="line-284"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#GenBasicBlock"><span class="hs-identifier hs-type">GenBasicBlock</span></a><span> </span><span class="hs-special">(</span><a href="RegAlloc.Liveness.html#LiveInstr"><span class="hs-identifier hs-type">LiveInstr</span></a><span> </span><a href="#local-6989586621684901411"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-285"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#GenBasicBlock"><span class="hs-identifier hs-type">GenBasicBlock</span></a><span> </span><span class="hs-special">(</span><a href="RegAlloc.Liveness.html#LiveInstr"><span class="hs-identifier hs-type">LiveInstr</span></a><span> </span><a href="#local-6989586621684901411"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-286"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><a href="Instruction.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a><span> </span><a href="#local-6989586621684901411"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-287"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-288"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RegAlloc.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a><span> </span><a href="#local-6989586621684901410"><span class="hs-identifier hs-type">freeRegs</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><a href="Instruction.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a><span> </span><a href="#local-6989586621684901411"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-289"></a><span>
</span><a name="line-290"></a><a name="process"><a href="RegAlloc.Linear.Main.html#process"><span class="hs-identifier">process</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>         </span><a name="local-6989586621684901469"><a href="#local-6989586621684901469"><span class="hs-identifier">accum</span></a></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-291"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621684901469"><span class="hs-identifier hs-var">accum</span></a><span>
</span><a name="line-292"></a><span>
</span><a name="line-293"></a><span class="hs-identifier">process</span><span> </span><a name="local-6989586621684901470"><a href="#local-6989586621684901470"><span class="hs-identifier">entry_ids</span></a></a><span> </span><a name="local-6989586621684901471"><a href="#local-6989586621684901471"><span class="hs-identifier">block_live</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621684901472"><a href="#local-6989586621684901472"><span class="hs-identifier">next_round</span></a></a><span> </span><a name="local-6989586621684901473"><a href="#local-6989586621684901473"><span class="hs-identifier">accum</span></a></a><span> </span><a name="local-6989586621684901474"><a href="#local-6989586621684901474"><span class="hs-identifier">madeProgress</span></a></a><span>
</span><a name="line-294"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621684901474"><span class="hs-identifier hs-var">madeProgress</span></a><span>
</span><a name="line-295"></a><span>
</span><a name="line-296"></a><span>          </span><span class="hs-comment">{- BUGS: There are so many unreachable blocks in the code the warnings are overwhelming.
             pprTrace &quot;RegAlloc.Linear.Main.process: no progress made, bailing out.&quot;
                (  text &quot;Unreachable blocks:&quot;
                $$ vcat (map ppr next_round)) -}</span><span>
</span><a name="line-300"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621684901473"><span class="hs-identifier hs-var">accum</span></a><span>
</span><a name="line-301"></a><span>
</span><a name="line-302"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-303"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="RegAlloc.Linear.Main.html#process"><span class="hs-identifier hs-var">process</span></a><span> </span><a href="#local-6989586621684901470"><span class="hs-identifier hs-var">entry_ids</span></a><span> </span><a href="#local-6989586621684901471"><span class="hs-identifier hs-var">block_live</span></a><span>
</span><a name="line-304"></a><span>                  </span><a href="#local-6989586621684901472"><span class="hs-identifier hs-var">next_round</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621684901473"><span class="hs-identifier hs-var">accum</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-305"></a><span>
</span><a name="line-306"></a><span class="hs-identifier">process</span><span> </span><a name="local-6989586621684901475"><a href="#local-6989586621684901475"><span class="hs-identifier">entry_ids</span></a></a><span> </span><a name="local-6989586621684901476"><a href="#local-6989586621684901476"><span class="hs-identifier">block_live</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684901477"><a href="#local-6989586621684901477"><span class="hs-identifier">b</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Cmm.html#BasicBlock"><span class="hs-identifier hs-var">BasicBlock</span></a><span> </span><a name="local-6989586621684901478"><a href="#local-6989586621684901478"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684901479"><a href="#local-6989586621684901479"><span class="hs-identifier">blocks</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-307"></a><span>        </span><a name="local-6989586621684901480"><a href="#local-6989586621684901480"><span class="hs-identifier">next_round</span></a></a><span> </span><a name="local-6989586621684901481"><a href="#local-6989586621684901481"><span class="hs-identifier">accum</span></a></a><span> </span><a name="local-6989586621684901482"><a href="#local-6989586621684901482"><span class="hs-identifier">madeProgress</span></a></a><span>
</span><a name="line-308"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-309"></a><span>        </span><a name="local-6989586621684901483"><a href="#local-6989586621684901483"><span class="hs-identifier">block_assig</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RegAlloc.Linear.State.html#getBlockAssigR"><span class="hs-identifier hs-var">getBlockAssigR</span></a><span>
</span><a name="line-310"></a><span>
</span><a name="line-311"></a><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621684901478"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684901483"><span class="hs-identifier hs-var">block_assig</span></a><span class="hs-special">)</span><span>
</span><a name="line-312"></a><span>             </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621684901478"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684901475"><span class="hs-identifier hs-var">entry_ids</span></a><span>
</span><a name="line-313"></a><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-314"></a><span>                </span><a name="local-6989586621684901484"><a href="#local-6989586621684901484"><span class="hs-identifier">b'</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RegAlloc.Linear.Main.html#processBlock"><span class="hs-identifier hs-var">processBlock</span></a><span> </span><a href="#local-6989586621684901476"><span class="hs-identifier hs-var">block_live</span></a><span> </span><a href="#local-6989586621684901477"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-315"></a><span>                </span><a href="RegAlloc.Linear.Main.html#process"><span class="hs-identifier hs-var">process</span></a><span> </span><a href="#local-6989586621684901475"><span class="hs-identifier hs-var">entry_ids</span></a><span> </span><a href="#local-6989586621684901476"><span class="hs-identifier hs-var">block_live</span></a><span> </span><a href="#local-6989586621684901479"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-316"></a><span>                        </span><a href="#local-6989586621684901480"><span class="hs-identifier hs-var">next_round</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684901484"><span class="hs-identifier hs-var">b'</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684901481"><span class="hs-identifier hs-var">accum</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-317"></a><span>
</span><a name="line-318"></a><span>         </span><span class="hs-keyword">else</span><span>   </span><a href="RegAlloc.Linear.Main.html#process"><span class="hs-identifier hs-var">process</span></a><span> </span><a href="#local-6989586621684901475"><span class="hs-identifier hs-var">entry_ids</span></a><span> </span><a href="#local-6989586621684901476"><span class="hs-identifier hs-var">block_live</span></a><span> </span><a href="#local-6989586621684901479"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-319"></a><span>                        </span><span class="hs-special">(</span><a href="#local-6989586621684901477"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684901480"><span class="hs-identifier hs-var">next_round</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684901481"><span class="hs-identifier hs-var">accum</span></a><span> </span><a href="#local-6989586621684901482"><span class="hs-identifier hs-var">madeProgress</span></a><span>
</span><a name="line-320"></a><span>
</span><a name="line-321"></a><span>
</span><a name="line-322"></a><span class="hs-comment">-- | Do register allocation on this basic block</span><span>
</span><a name="line-323"></a><span class="hs-comment">--</span><span>
</span><a name="line-324"></a><span class="hs-identifier">processBlock</span><span>
</span><a name="line-325"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.FreeRegs.html#FR"><span class="hs-identifier hs-type">FR</span></a><span> </span><a href="#local-6989586621684901408"><span class="hs-identifier hs-type">freeRegs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684901409"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">,</span><span> </span><a href="Instruction.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a><span> </span><a href="#local-6989586621684901409"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">)</span><span>
</span><a name="line-326"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><a href="RegAlloc.Liveness.html#BlockMap"><span class="hs-identifier hs-type">BlockMap</span></a><span> </span><a href="RegAlloc.Liveness.html#RegSet"><span class="hs-identifier hs-type">RegSet</span></a><span>              </span><span class="hs-comment">-- ^ live regs on entry to each basic block</span><span>
</span><a name="line-327"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RegAlloc.Liveness.html#LiveBasicBlock"><span class="hs-identifier hs-type">LiveBasicBlock</span></a><span> </span><a href="#local-6989586621684901409"><span class="hs-identifier hs-type">instr</span></a><span>         </span><span class="hs-comment">-- ^ block to do register allocation on</span><span>
</span><a name="line-328"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RegAlloc.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a><span> </span><a href="#local-6989586621684901408"><span class="hs-identifier hs-type">freeRegs</span></a><span> </span><span class="hs-special">[</span><a href="Instruction.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a><span> </span><a href="#local-6989586621684901409"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- ^ block with registers allocated</span><span>
</span><a name="line-329"></a><span>
</span><a name="line-330"></a><a name="processBlock"><a href="RegAlloc.Linear.Main.html#processBlock"><span class="hs-identifier">processBlock</span></a></a><span> </span><a name="local-6989586621684901485"><a href="#local-6989586621684901485"><span class="hs-identifier">block_live</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#BasicBlock"><span class="hs-identifier hs-var">BasicBlock</span></a><span> </span><a name="local-6989586621684901486"><a href="#local-6989586621684901486"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621684901487"><a href="#local-6989586621684901487"><span class="hs-identifier">instrs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-331"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>   </span><a href="RegAlloc.Linear.Main.html#initBlock"><span class="hs-identifier hs-var">initBlock</span></a><span> </span><a href="#local-6989586621684901486"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684901485"><span class="hs-identifier hs-var">block_live</span></a><span>
</span><a name="line-332"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684901488"><a href="#local-6989586621684901488"><span class="hs-identifier">instrs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684901489"><a href="#local-6989586621684901489"><span class="hs-identifier">fixups</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-333"></a><span>                </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RegAlloc.Linear.Main.html#linearRA"><span class="hs-identifier hs-var">linearRA</span></a><span> </span><a href="#local-6989586621684901485"><span class="hs-identifier hs-var">block_live</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621684901486"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684901487"><span class="hs-identifier hs-var">instrs</span></a><span>
</span><a name="line-334"></a><span>        </span><span class="hs-identifier hs-var">return</span><span>  </span><span class="hs-operator hs-var">$</span><span> </span><a href="Cmm.html#BasicBlock"><span class="hs-identifier hs-var">BasicBlock</span></a><span> </span><a href="#local-6989586621684901486"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684901488"><span class="hs-identifier hs-var">instrs'</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684901489"><span class="hs-identifier hs-var">fixups</span></a><span>
</span><a name="line-335"></a><span>
</span><a name="line-336"></a><span>
</span><a name="line-337"></a><span class="hs-comment">-- | Load the freeregs and current reg assignment into the RegM state</span><span>
</span><a name="line-338"></a><span class="hs-comment">--      for the basic block with this BlockId.</span><span>
</span><a name="line-339"></a><span class="hs-identifier">initBlock</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RegAlloc.Linear.FreeRegs.html#FR"><span class="hs-identifier hs-type">FR</span></a><span> </span><a href="#local-6989586621684901407"><span class="hs-identifier hs-type">freeRegs</span></a><span>
</span><a name="line-340"></a><span>          </span><span class="hs-glyph">=&gt;</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RegAlloc.Liveness.html#BlockMap"><span class="hs-identifier hs-type">BlockMap</span></a><span> </span><a href="RegAlloc.Liveness.html#RegSet"><span class="hs-identifier hs-type">RegSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RegAlloc.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a><span> </span><a href="#local-6989586621684901407"><span class="hs-identifier hs-type">freeRegs</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-341"></a><a name="initBlock"><a href="RegAlloc.Linear.Main.html#initBlock"><span class="hs-identifier">initBlock</span></a></a><span> </span><a name="local-6989586621684901490"><a href="#local-6989586621684901490"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621684901491"><a href="#local-6989586621684901491"><span class="hs-identifier">block_live</span></a></a><span>
</span><a name="line-342"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>   </span><a name="local-6989586621684901492"><a href="#local-6989586621684901492"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-343"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901493"><a href="#local-6989586621684901493"><span class="hs-identifier">platform</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621684901492"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-344"></a><span>        </span><a name="local-6989586621684901494"><a href="#local-6989586621684901494"><span class="hs-identifier">block_assig</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RegAlloc.Linear.State.html#getBlockAssigR"><span class="hs-identifier hs-var">getBlockAssigR</span></a><span>
</span><a name="line-345"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621684901490"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684901494"><span class="hs-identifier hs-var">block_assig</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-346"></a><span>                </span><span class="hs-comment">-- no prior info about this block: we must consider</span><span>
</span><a name="line-347"></a><span>                </span><span class="hs-comment">-- any fixed regs to be allocated, but we can ignore</span><span>
</span><a name="line-348"></a><span>                </span><span class="hs-comment">-- virtual regs (presumably this is part of a loop,</span><span>
</span><a name="line-349"></a><span>                </span><span class="hs-comment">-- and we'll iterate again).  The assignment begins</span><span>
</span><a name="line-350"></a><span>                </span><span class="hs-comment">-- empty.</span><span>
</span><a name="line-351"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-352"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-comment">-- pprTrace &quot;initFreeRegs&quot; (text $ show initFreeRegs) (return ())</span><span>
</span><a name="line-353"></a><span>                        </span><span class="hs-keyword">case</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621684901490"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684901491"><span class="hs-identifier hs-var">block_live</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-354"></a><span>                          </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-355"></a><span>                            </span><a href="RegAlloc.Linear.State.html#setFreeRegsR"><span class="hs-identifier hs-var">setFreeRegsR</span></a><span>    </span><span class="hs-special">(</span><a href="RegAlloc.Linear.FreeRegs.html#frInitFreeRegs"><span class="hs-identifier hs-var">frInitFreeRegs</span></a><span> </span><a href="#local-6989586621684901493"><span class="hs-identifier hs-var">platform</span></a><span class="hs-special">)</span><span>
</span><a name="line-356"></a><span>                          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684901495"><a href="#local-6989586621684901495"><span class="hs-identifier">live</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-357"></a><span>                            </span><a href="RegAlloc.Linear.State.html#setFreeRegsR"><span class="hs-identifier hs-var">setFreeRegsR</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="RegAlloc.Linear.FreeRegs.html#frAllocateReg"><span class="hs-identifier hs-var">frAllocateReg</span></a><span> </span><a href="#local-6989586621684901493"><span class="hs-identifier hs-var">platform</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.FreeRegs.html#frInitFreeRegs"><span class="hs-identifier hs-var">frInitFreeRegs</span></a><span> </span><a href="#local-6989586621684901493"><span class="hs-identifier hs-var">platform</span></a><span class="hs-special">)</span><span>
</span><a name="line-358"></a><span>                                                  </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621684901496"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="Reg.html#RegReal"><span class="hs-identifier hs-var">RegReal</span></a><span> </span><a name="local-6989586621684901496"><a href="#local-6989586621684901496"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">nonDetEltsUniqSet</span><span> </span><a href="#local-6989586621684901495"><span class="hs-identifier hs-var">live</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-359"></a><span>                            </span><span class="hs-comment">-- See Note [Unique Determinism and code generation]</span><span>
</span><a name="line-360"></a><span>                        </span><a href="RegAlloc.Linear.State.html#setAssigR"><span class="hs-identifier hs-var">setAssigR</span></a><span>       </span><a href="RegAlloc.Liveness.html#emptyRegMap"><span class="hs-identifier hs-var">emptyRegMap</span></a><span>
</span><a name="line-361"></a><span>
</span><a name="line-362"></a><span>                </span><span class="hs-comment">-- load info about register assignments leading into this block.</span><span>
</span><a name="line-363"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684901497"><a href="#local-6989586621684901497"><span class="hs-identifier">freeregs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684901498"><a href="#local-6989586621684901498"><span class="hs-identifier">assig</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-364"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>  </span><a href="RegAlloc.Linear.State.html#setFreeRegsR"><span class="hs-identifier hs-var">setFreeRegsR</span></a><span>    </span><a href="#local-6989586621684901497"><span class="hs-identifier hs-var">freeregs</span></a><span>
</span><a name="line-365"></a><span>                        </span><a href="RegAlloc.Linear.State.html#setAssigR"><span class="hs-identifier hs-var">setAssigR</span></a><span>       </span><a href="#local-6989586621684901498"><span class="hs-identifier hs-var">assig</span></a><span>
</span><a name="line-366"></a><span>
</span><a name="line-367"></a><span>
</span><a name="line-368"></a><span class="hs-comment">-- | Do allocation for a sequence of instructions.</span><span>
</span><a name="line-369"></a><span class="hs-identifier">linearRA</span><span>
</span><a name="line-370"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.FreeRegs.html#FR"><span class="hs-identifier hs-type">FR</span></a><span> </span><a href="#local-6989586621684901405"><span class="hs-identifier hs-type">freeRegs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684901406"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">,</span><span> </span><a href="Instruction.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a><span> </span><a href="#local-6989586621684901406"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">)</span><span>
</span><a name="line-371"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><a href="RegAlloc.Liveness.html#BlockMap"><span class="hs-identifier hs-type">BlockMap</span></a><span> </span><a href="RegAlloc.Liveness.html#RegSet"><span class="hs-identifier hs-type">RegSet</span></a><span>                      </span><span class="hs-comment">-- ^ map of what vregs are live on entry to each block.</span><span>
</span><a name="line-372"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684901406"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span>                              </span><span class="hs-comment">-- ^ accumulator for instructions already processed.</span><span>
</span><a name="line-373"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Instruction.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a><span> </span><a href="#local-6989586621684901406"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span>                </span><span class="hs-comment">-- ^ accumulator for blocks of fixup code.</span><span>
</span><a name="line-374"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span>                              </span><span class="hs-comment">-- ^ id of the current block, for debugging.</span><span>
</span><a name="line-375"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="RegAlloc.Liveness.html#LiveInstr"><span class="hs-identifier hs-type">LiveInstr</span></a><span> </span><a href="#local-6989586621684901406"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span>                    </span><span class="hs-comment">-- ^ liveness annotated instructions in this block.</span><span>
</span><a name="line-376"></a><span>
</span><a name="line-377"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RegAlloc.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a><span> </span><a href="#local-6989586621684901405"><span class="hs-identifier hs-type">freeRegs</span></a><span>
</span><a name="line-378"></a><span>                </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684901406"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span>                       </span><span class="hs-comment">--   instructions after register allocation</span><span>
</span><a name="line-379"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Instruction.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a><span> </span><a href="#local-6989586621684901406"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>        </span><span class="hs-comment">--   fresh blocks of fixup code.</span><span>
</span><a name="line-380"></a><span>
</span><a name="line-381"></a><span>
</span><a name="line-382"></a><a name="linearRA"><a href="RegAlloc.Linear.Main.html#linearRA"><span class="hs-identifier">linearRA</span></a></a><span> </span><span class="hs-identifier">_</span><span>          </span><a name="local-6989586621684901499"><a href="#local-6989586621684901499"><span class="hs-identifier">accInstr</span></a></a><span> </span><a name="local-6989586621684901500"><a href="#local-6989586621684901500"><span class="hs-identifier">accFixup</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-383"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span>
</span><a name="line-384"></a><span>                </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621684901499"><span class="hs-identifier hs-var">accInstr</span></a><span>              </span><span class="hs-comment">-- instrs need to be returned in the correct order.</span><span>
</span><a name="line-385"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684901500"><span class="hs-identifier hs-var">accFixup</span></a><span class="hs-special">)</span><span>                     </span><span class="hs-comment">-- it doesn't matter what order the fixup blocks are returned in.</span><span>
</span><a name="line-386"></a><span>
</span><a name="line-387"></a><span>
</span><a name="line-388"></a><span class="hs-identifier">linearRA</span><span> </span><a name="local-6989586621684901501"><a href="#local-6989586621684901501"><span class="hs-identifier">block_live</span></a></a><span> </span><a name="local-6989586621684901502"><a href="#local-6989586621684901502"><span class="hs-identifier">accInstr</span></a></a><span> </span><a name="local-6989586621684901503"><a href="#local-6989586621684901503"><span class="hs-identifier">accFixups</span></a></a><span> </span><a name="local-6989586621684901504"><a href="#local-6989586621684901504"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684901505"><a href="#local-6989586621684901505"><span class="hs-identifier">instr</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684901506"><a href="#local-6989586621684901506"><span class="hs-identifier">instrs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-389"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-390"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684901507"><a href="#local-6989586621684901507"><span class="hs-identifier">accInstr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684901508"><a href="#local-6989586621684901508"><span class="hs-identifier">new_fixups</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RegAlloc.Linear.Main.html#raInsn"><span class="hs-identifier hs-var">raInsn</span></a><span> </span><a href="#local-6989586621684901501"><span class="hs-identifier hs-var">block_live</span></a><span> </span><a href="#local-6989586621684901502"><span class="hs-identifier hs-var">accInstr</span></a><span> </span><a href="#local-6989586621684901504"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684901505"><span class="hs-identifier hs-var">instr</span></a><span>
</span><a name="line-391"></a><span>
</span><a name="line-392"></a><span>        </span><a href="RegAlloc.Linear.Main.html#linearRA"><span class="hs-identifier hs-var">linearRA</span></a><span> </span><a href="#local-6989586621684901501"><span class="hs-identifier hs-var">block_live</span></a><span> </span><a href="#local-6989586621684901507"><span class="hs-identifier hs-var">accInstr'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684901508"><span class="hs-identifier hs-var">new_fixups</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684901503"><span class="hs-identifier hs-var">accFixups</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684901504"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684901506"><span class="hs-identifier hs-var">instrs</span></a><span>
</span><a name="line-393"></a><span>
</span><a name="line-394"></a><span>
</span><a name="line-395"></a><span class="hs-comment">-- | Do allocation for a single instruction.</span><span>
</span><a name="line-396"></a><span class="hs-identifier">raInsn</span><span>
</span><a name="line-397"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.FreeRegs.html#FR"><span class="hs-identifier hs-type">FR</span></a><span> </span><a href="#local-6989586621684901403"><span class="hs-identifier hs-type">freeRegs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684901404"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">,</span><span> </span><a href="Instruction.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a><span> </span><a href="#local-6989586621684901404"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">)</span><span>
</span><a name="line-398"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><a href="RegAlloc.Liveness.html#BlockMap"><span class="hs-identifier hs-type">BlockMap</span></a><span> </span><a href="RegAlloc.Liveness.html#RegSet"><span class="hs-identifier hs-type">RegSet</span></a><span>                      </span><span class="hs-comment">-- ^ map of what vregs are love on entry to each block.</span><span>
</span><a name="line-399"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684901404"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span>                              </span><span class="hs-comment">-- ^ accumulator for instructions already processed.</span><span>
</span><a name="line-400"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span>                              </span><span class="hs-comment">-- ^ the id of the current block, for debugging</span><span>
</span><a name="line-401"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RegAlloc.Liveness.html#LiveInstr"><span class="hs-identifier hs-type">LiveInstr</span></a><span> </span><a href="#local-6989586621684901404"><span class="hs-identifier hs-type">instr</span></a><span>                      </span><span class="hs-comment">-- ^ the instr to have its regs allocated, with liveness info.</span><span>
</span><a name="line-402"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RegAlloc.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a><span> </span><a href="#local-6989586621684901403"><span class="hs-identifier hs-type">freeRegs</span></a><span>
</span><a name="line-403"></a><span>                </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684901404"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span>                       </span><span class="hs-comment">-- new instructions</span><span>
</span><a name="line-404"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Instruction.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a><span> </span><a href="#local-6989586621684901404"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- extra fixup blocks</span><span>
</span><a name="line-405"></a><span>
</span><a name="line-406"></a><a name="raInsn"><a href="RegAlloc.Linear.Main.html#raInsn"><span class="hs-identifier">raInsn</span></a></a><span> </span><span class="hs-identifier">_</span><span>     </span><a name="local-6989586621684901509"><a href="#local-6989586621684901509"><span class="hs-identifier">new_instrs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Liveness.html#LiveInstr"><span class="hs-identifier hs-var">LiveInstr</span></a><span> </span><a name="local-6989586621684901510"><a href="#local-6989586621684901510"><span class="hs-identifier">ii</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-407"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684901511"><a href="#local-6989586621684901511"><span class="hs-identifier">n</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Instruction.html#takeDeltaInstr"><span class="hs-identifier hs-var">takeDeltaInstr</span></a><span> </span><a href="#local-6989586621684901510"><span class="hs-identifier hs-var">ii</span></a><span>
</span><a name="line-408"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>    </span><a href="RegAlloc.Linear.State.html#setDeltaR"><span class="hs-identifier hs-var">setDeltaR</span></a><span> </span><a href="#local-6989586621684901511"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-409"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684901509"><span class="hs-identifier hs-var">new_instrs</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-410"></a><span>
</span><a name="line-411"></a><span class="hs-identifier">raInsn</span><span> </span><span class="hs-identifier">_</span><span>     </span><a name="local-6989586621684901512"><a href="#local-6989586621684901512"><span class="hs-identifier">new_instrs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Liveness.html#LiveInstr"><span class="hs-identifier hs-var">LiveInstr</span></a><span> </span><a name="local-6989586621684901513"><a href="#local-6989586621684901513"><span class="hs-identifier">ii</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="RegAlloc.Liveness.html#Instr"><span class="hs-identifier hs-var">Instr</span></a><span> </span><a name="local-6989586621684901514"><a href="#local-6989586621684901514"><span class="hs-identifier">i</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-412"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="Instruction.html#isMetaInstr"><span class="hs-identifier hs-var">isMetaInstr</span></a><span> </span><a href="#local-6989586621684901513"><span class="hs-identifier hs-var">ii</span></a><span>
</span><a name="line-413"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684901514"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684901512"><span class="hs-identifier hs-var">new_instrs</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-414"></a><span>
</span><a name="line-415"></a><span>
</span><a name="line-416"></a><span class="hs-identifier">raInsn</span><span> </span><a name="local-6989586621684901515"><a href="#local-6989586621684901515"><span class="hs-identifier">block_live</span></a></a><span> </span><a name="local-6989586621684901516"><a href="#local-6989586621684901516"><span class="hs-identifier">new_instrs</span></a></a><span> </span><a name="local-6989586621684901517"><a href="#local-6989586621684901517"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-special">(</span><a href="RegAlloc.Liveness.html#LiveInstr"><span class="hs-identifier hs-var">LiveInstr</span></a><span> </span><span class="hs-special">(</span><a href="RegAlloc.Liveness.html#Instr"><span class="hs-identifier hs-var">Instr</span></a><span> </span><a name="local-6989586621684901518"><a href="#local-6989586621684901518"><span class="hs-identifier">instr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684901519"><a href="#local-6989586621684901519"><span class="hs-identifier">live</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-417"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-418"></a><span>    </span><a name="local-6989586621684901520"><a href="#local-6989586621684901520"><span class="hs-identifier">assig</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RegAlloc.Linear.State.html#getAssigR"><span class="hs-identifier hs-var">getAssigR</span></a><span>
</span><a name="line-419"></a><span>
</span><a name="line-420"></a><span>    </span><span class="hs-comment">-- If we have a reg-&gt;reg move between virtual registers, where the</span><span>
</span><a name="line-421"></a><span>    </span><span class="hs-comment">-- src register is not live after this instruction, and the dst</span><span>
</span><a name="line-422"></a><span>    </span><span class="hs-comment">-- register does not already have an assignment,</span><span>
</span><a name="line-423"></a><span>    </span><span class="hs-comment">-- and the source register is assigned to a register, not to a spill slot,</span><span>
</span><a name="line-424"></a><span>    </span><span class="hs-comment">-- then we can eliminate the instruction.</span><span>
</span><a name="line-425"></a><span>    </span><span class="hs-comment">-- (we can't eliminate it if the source register is on the stack, because</span><span>
</span><a name="line-426"></a><span>    </span><span class="hs-comment">--  we do not want to use one spill slot for different virtual registers)</span><span>
</span><a name="line-427"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="Instruction.html#takeRegRegMoveInstr"><span class="hs-identifier hs-var">takeRegRegMoveInstr</span></a><span> </span><a href="#local-6989586621684901518"><span class="hs-identifier hs-var">instr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-428"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684901521"><a href="#local-6989586621684901521"><span class="hs-identifier">src</span></a></a><span class="hs-special">,</span><a name="local-6989586621684901522"><a href="#local-6989586621684901522"><span class="hs-identifier">dst</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684901521"><span class="hs-identifier hs-var">src</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elementOfUniqSet</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">liveDieRead</span><span> </span><a href="#local-6989586621684901519"><span class="hs-identifier hs-var">live</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-429"></a><span>                          </span><a href="Reg.html#isVirtualReg"><span class="hs-identifier hs-var">isVirtualReg</span></a><span> </span><a href="#local-6989586621684901522"><span class="hs-identifier hs-var">dst</span></a><span class="hs-special">,</span><span>
</span><a name="line-430"></a><span>                          </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684901522"><span class="hs-identifier hs-var">dst</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemUFM</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684901520"><span class="hs-identifier hs-var">assig</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-431"></a><span>                          </span><a href="Reg.html#isRealReg"><span class="hs-identifier hs-var">isRealReg</span></a><span> </span><a href="#local-6989586621684901521"><span class="hs-identifier hs-var">src</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="RegAlloc.Linear.Main.html#isInReg"><span class="hs-identifier hs-var">isInReg</span></a><span> </span><a href="#local-6989586621684901521"><span class="hs-identifier hs-var">src</span></a><span> </span><a href="#local-6989586621684901520"><span class="hs-identifier hs-var">assig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-432"></a><span>           </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684901521"><span class="hs-identifier hs-var">src</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-433"></a><span>              </span><span class="hs-special">(</span><a href="Reg.html#RegReal"><span class="hs-identifier hs-var">RegReal</span></a><span> </span><a name="local-6989586621684901523"><a href="#local-6989586621684901523"><span class="hs-identifier">rr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RegAlloc.Linear.State.html#setAssigR"><span class="hs-identifier hs-var">setAssigR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">addToUFM</span><span> </span><a href="#local-6989586621684901520"><span class="hs-identifier hs-var">assig</span></a><span> </span><a href="#local-6989586621684901522"><span class="hs-identifier hs-var">dst</span></a><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.Base.html#InReg"><span class="hs-identifier hs-var">InReg</span></a><span> </span><a href="#local-6989586621684901523"><span class="hs-identifier hs-var">rr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-434"></a><span>                </span><span class="hs-comment">-- if src is a fixed reg, then we just map dest to this</span><span>
</span><a name="line-435"></a><span>                </span><span class="hs-comment">-- reg in the assignment.  src must be an allocatable reg,</span><span>
</span><a name="line-436"></a><span>                </span><span class="hs-comment">-- otherwise it wouldn't be in r_dying.</span><span>
</span><a name="line-437"></a><span>              </span><a name="local-6989586621684901524"><a href="#local-6989586621684901524"><span class="hs-identifier">_virt</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupUFM</span><span> </span><a href="#local-6989586621684901520"><span class="hs-identifier hs-var">assig</span></a><span> </span><a href="#local-6989586621684901521"><span class="hs-identifier hs-var">src</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-438"></a><span>                         </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;raInsn&quot;</span><span>
</span><a name="line-439"></a><span>                         </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684901525"><a href="#local-6989586621684901525"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-440"></a><span>                           </span><a href="RegAlloc.Linear.State.html#setAssigR"><span class="hs-identifier hs-var">setAssigR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">addToUFM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">delFromUFM</span><span> </span><a href="#local-6989586621684901520"><span class="hs-identifier hs-var">assig</span></a><span> </span><a href="#local-6989586621684901521"><span class="hs-identifier hs-var">src</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684901522"><span class="hs-identifier hs-var">dst</span></a><span> </span><a href="#local-6989586621684901525"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">)</span><span>
</span><a name="line-441"></a><span>
</span><a name="line-442"></a><span>           </span><span class="hs-comment">-- we have eliminated this instruction</span><span>
</span><a name="line-443"></a><span>          </span><span class="hs-comment">{-
          freeregs &lt;- getFreeRegsR
          assig &lt;- getAssigR
          pprTrace &quot;raInsn&quot; (text &quot;ELIMINATED: &quot; &lt;&gt; docToSDoc (pprInstr instr)
                        $$ ppr r_dying &lt;+&gt; ppr w_dying $$ text (show freeregs) $$ ppr assig) $ do
          -}</span><span>
</span><a name="line-449"></a><span>           </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684901516"><span class="hs-identifier hs-var">new_instrs</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-450"></a><span>
</span><a name="line-451"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RegAlloc.Linear.Main.html#genRaInsn"><span class="hs-identifier hs-var">genRaInsn</span></a><span> </span><a href="#local-6989586621684901515"><span class="hs-identifier hs-var">block_live</span></a><span> </span><a href="#local-6989586621684901516"><span class="hs-identifier hs-var">new_instrs</span></a><span> </span><a href="#local-6989586621684901517"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684901518"><span class="hs-identifier hs-var">instr</span></a><span>
</span><a name="line-452"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nonDetEltsUniqSet</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">liveDieRead</span><span> </span><a href="#local-6989586621684901519"><span class="hs-identifier hs-var">live</span></a><span class="hs-special">)</span><span>
</span><a name="line-453"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nonDetEltsUniqSet</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">liveDieWrite</span><span> </span><a href="#local-6989586621684901519"><span class="hs-identifier hs-var">live</span></a><span class="hs-special">)</span><span>
</span><a name="line-454"></a><span>                        </span><span class="hs-comment">-- See Note [Unique Determinism and code generation]</span><span>
</span><a name="line-455"></a><span>
</span><a name="line-456"></a><span class="hs-identifier">raInsn</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684901526"><a href="#local-6989586621684901526"><span class="hs-identifier">instr</span></a></a><span>
</span><a name="line-457"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;raInsn&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;no match for:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684901526"><span class="hs-identifier hs-var">instr</span></a><span class="hs-special">)</span><span>
</span><a name="line-458"></a><span>
</span><a name="line-459"></a><span class="hs-comment">-- ToDo: what can we do about</span><span>
</span><a name="line-460"></a><span class="hs-comment">--</span><span>
</span><a name="line-461"></a><span class="hs-comment">--     R1 = x</span><span>
</span><a name="line-462"></a><span class="hs-comment">--     jump I64[x] // [R1]</span><span>
</span><a name="line-463"></a><span class="hs-comment">--</span><span>
</span><a name="line-464"></a><span class="hs-comment">-- where x is mapped to the same reg as R1.  We want to coalesce x and</span><span>
</span><a name="line-465"></a><span class="hs-comment">-- R1, but the register allocator doesn't know whether x will be</span><span>
</span><a name="line-466"></a><span class="hs-comment">-- assigned to again later, in which case x and R1 should be in</span><span>
</span><a name="line-467"></a><span class="hs-comment">-- different registers.  Right now we assume the worst, and the</span><span>
</span><a name="line-468"></a><span class="hs-comment">-- assignment to R1 will clobber x, so we'll spill x into another reg,</span><span>
</span><a name="line-469"></a><span class="hs-comment">-- generating another reg-&gt;reg move.</span><span>
</span><a name="line-470"></a><span>
</span><a name="line-471"></a><span>
</span><a name="line-472"></a><span class="hs-identifier">isInReg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Reg.html#Reg"><span class="hs-identifier hs-type">Reg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RegAlloc.Liveness.html#RegMap"><span class="hs-identifier hs-type">RegMap</span></a><span> </span><a href="RegAlloc.Linear.Base.html#Loc"><span class="hs-identifier hs-type">Loc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-473"></a><a name="isInReg"><a href="RegAlloc.Linear.Main.html#isInReg"><span class="hs-identifier">isInReg</span></a></a><span> </span><a name="local-6989586621684901527"><a href="#local-6989586621684901527"><span class="hs-identifier">src</span></a></a><span> </span><a name="local-6989586621684901528"><a href="#local-6989586621684901528"><span class="hs-identifier">assig</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.Base.html#InReg"><span class="hs-identifier hs-var">InReg</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupUFM</span><span> </span><a href="#local-6989586621684901528"><span class="hs-identifier hs-var">assig</span></a><span> </span><a href="#local-6989586621684901527"><span class="hs-identifier hs-var">src</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-474"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-475"></a><span>
</span><a name="line-476"></a><span>
</span><a name="line-477"></a><span class="hs-identifier">genRaInsn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.FreeRegs.html#FR"><span class="hs-identifier hs-type">FR</span></a><span> </span><a href="#local-6989586621684901401"><span class="hs-identifier hs-type">freeRegs</span></a><span class="hs-special">,</span><span> </span><a href="Instruction.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a><span> </span><a href="#local-6989586621684901402"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684901402"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">)</span><span>
</span><a name="line-478"></a><span>          </span><span class="hs-glyph">=&gt;</span><span> </span><a href="RegAlloc.Liveness.html#BlockMap"><span class="hs-identifier hs-type">BlockMap</span></a><span> </span><a href="RegAlloc.Liveness.html#RegSet"><span class="hs-identifier hs-type">RegSet</span></a><span>
</span><a name="line-479"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684901402"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span>
</span><a name="line-480"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span>
</span><a name="line-481"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684901402"><span class="hs-identifier hs-type">instr</span></a><span>
</span><a name="line-482"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Reg.html#Reg"><span class="hs-identifier hs-type">Reg</span></a><span class="hs-special">]</span><span>
</span><a name="line-483"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Reg.html#Reg"><span class="hs-identifier hs-type">Reg</span></a><span class="hs-special">]</span><span>
</span><a name="line-484"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RegAlloc.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a><span> </span><a href="#local-6989586621684901401"><span class="hs-identifier hs-type">freeRegs</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="#local-6989586621684901402"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Instruction.html#NatBasicBlock"><span class="hs-identifier hs-type">NatBasicBlock</span></a><span> </span><a href="#local-6989586621684901402"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-485"></a><span>
</span><a name="line-486"></a><a name="genRaInsn"><a href="RegAlloc.Linear.Main.html#genRaInsn"><span class="hs-identifier">genRaInsn</span></a></a><span> </span><a name="local-6989586621684901529"><a href="#local-6989586621684901529"><span class="hs-identifier">block_live</span></a></a><span> </span><a name="local-6989586621684901530"><a href="#local-6989586621684901530"><span class="hs-identifier">new_instrs</span></a></a><span> </span><a name="local-6989586621684901531"><a href="#local-6989586621684901531"><span class="hs-identifier">block_id</span></a></a><span> </span><a name="local-6989586621684901532"><a href="#local-6989586621684901532"><span class="hs-identifier">instr</span></a></a><span> </span><a name="local-6989586621684901533"><a href="#local-6989586621684901533"><span class="hs-identifier">r_dying</span></a></a><span> </span><a name="local-6989586621684901534"><a href="#local-6989586621684901534"><span class="hs-identifier">w_dying</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-487"></a><span>  </span><a name="local-6989586621684901535"><a href="#local-6989586621684901535"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-488"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901536"><a href="#local-6989586621684901536"><span class="hs-identifier">platform</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621684901535"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-489"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="Instruction.html#regUsageOfInstr"><span class="hs-identifier hs-var">regUsageOfInstr</span></a><span> </span><a href="#local-6989586621684901536"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684901532"><span class="hs-identifier hs-var">instr</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><a href="Instruction.html#RU"><span class="hs-identifier hs-var">RU</span></a><span> </span><a name="local-6989586621684901537"><a href="#local-6989586621684901537"><span class="hs-identifier">read</span></a></a><span> </span><a name="local-6989586621684901538"><a href="#local-6989586621684901538"><span class="hs-identifier">written</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-490"></a><span>    </span><span class="hs-keyword">do</span><span>
</span><a name="line-491"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901539"><a href="#local-6989586621684901539"><span class="hs-identifier">real_written</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621684901540"><span class="hs-identifier hs-var">rr</span></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a href="Reg.html#RegReal"><span class="hs-identifier hs-var">RegReal</span></a><span>     </span><a name="local-6989586621684901540"><a href="#local-6989586621684901540"><span class="hs-identifier">rr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684901538"><span class="hs-identifier hs-var">written</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-492"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901541"><a href="#local-6989586621684901541"><span class="hs-identifier">virt_written</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621684901542"><span class="hs-identifier hs-var">vr</span></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a href="Reg.html#RegVirtual"><span class="hs-identifier hs-var">RegVirtual</span></a><span>  </span><a name="local-6989586621684901542"><a href="#local-6989586621684901542"><span class="hs-identifier">vr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684901538"><span class="hs-identifier hs-var">written</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-493"></a><span>
</span><a name="line-494"></a><span>    </span><span class="hs-comment">-- we don't need to do anything with real registers that are</span><span>
</span><a name="line-495"></a><span>    </span><span class="hs-comment">-- only read by this instr.  (the list is typically ~2 elements,</span><span>
</span><a name="line-496"></a><span>    </span><span class="hs-comment">-- so using nub isn't a problem).</span><span>
</span><a name="line-497"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901543"><a href="#local-6989586621684901543"><span class="hs-identifier">virt_read</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nub</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621684901544"><span class="hs-identifier hs-var">vr</span></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a href="Reg.html#RegVirtual"><span class="hs-identifier hs-var">RegVirtual</span></a><span> </span><a name="local-6989586621684901544"><a href="#local-6989586621684901544"><span class="hs-identifier">vr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684901537"><span class="hs-identifier hs-var">read</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-498"></a><span>
</span><a name="line-499"></a><span>    </span><span class="hs-comment">-- debugging</span><span>
</span><a name="line-500"></a><span class="hs-comment">{-    freeregs &lt;- getFreeRegsR
    assig    &lt;- getAssigR
    pprDebugAndThen (defaultDynFlags Settings{ sTargetPlatform=platform } undefined) trace &quot;genRaInsn&quot;
        (ppr instr
                $$ text &quot;r_dying      = &quot; &lt;+&gt; ppr r_dying
                $$ text &quot;w_dying      = &quot; &lt;+&gt; ppr w_dying
                $$ text &quot;virt_read    = &quot; &lt;+&gt; ppr virt_read
                $$ text &quot;virt_written = &quot; &lt;+&gt; ppr virt_written
                $$ text &quot;freeregs     = &quot; &lt;+&gt; text (show freeregs)
                $$ text &quot;assig        = &quot; &lt;+&gt; ppr assig)
        $ do
-}</span><span>
</span><a name="line-512"></a><span>
</span><a name="line-513"></a><span>    </span><span class="hs-comment">-- (a), (b) allocate real regs for all regs read by this instruction.</span><span>
</span><a name="line-514"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684901545"><a href="#local-6989586621684901545"><span class="hs-identifier">r_spills</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684901546"><a href="#local-6989586621684901546"><span class="hs-identifier">r_allocd</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-515"></a><span>        </span><a href="RegAlloc.Linear.Main.html#allocateRegsAndSpill"><span class="hs-identifier hs-var">allocateRegsAndSpill</span></a><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-comment">{-reading-}</span><span> </span><a href="#local-6989586621684901543"><span class="hs-identifier hs-var">virt_read</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621684901543"><span class="hs-identifier hs-var">virt_read</span></a><span>
</span><a name="line-516"></a><span>
</span><a name="line-517"></a><span>    </span><span class="hs-comment">-- (c) save any temporaries which will be clobbered by this instruction</span><span>
</span><a name="line-518"></a><span>    </span><a name="local-6989586621684901547"><a href="#local-6989586621684901547"><span class="hs-identifier">clobber_saves</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RegAlloc.Linear.Main.html#saveClobberedTemps"><span class="hs-identifier hs-var">saveClobberedTemps</span></a><span> </span><a href="#local-6989586621684901539"><span class="hs-identifier hs-var">real_written</span></a><span> </span><a href="#local-6989586621684901533"><span class="hs-identifier hs-var">r_dying</span></a><span>
</span><a name="line-519"></a><span>
</span><a name="line-520"></a><span>    </span><span class="hs-comment">-- (d) Update block map for new destinations</span><span>
</span><a name="line-521"></a><span>    </span><span class="hs-comment">-- NB. do this before removing dead regs from the assignment, because</span><span>
</span><a name="line-522"></a><span>    </span><span class="hs-comment">-- these dead regs might in fact be live in the jump targets (they're</span><span>
</span><a name="line-523"></a><span>    </span><span class="hs-comment">-- only dead in the code that follows in the current basic block).</span><span>
</span><a name="line-524"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684901548"><a href="#local-6989586621684901548"><span class="hs-identifier">fixup_blocks</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684901549"><a href="#local-6989586621684901549"><span class="hs-identifier">adjusted_instr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-525"></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RegAlloc.Linear.JoinToTargets.html#joinToTargets"><span class="hs-identifier hs-var">joinToTargets</span></a><span> </span><a href="#local-6989586621684901529"><span class="hs-identifier hs-var">block_live</span></a><span> </span><a href="#local-6989586621684901531"><span class="hs-identifier hs-var">block_id</span></a><span> </span><a href="#local-6989586621684901532"><span class="hs-identifier hs-var">instr</span></a><span>
</span><a name="line-526"></a><span>
</span><a name="line-527"></a><span>    </span><span class="hs-comment">-- Debugging - show places where the reg alloc inserted</span><span>
</span><a name="line-528"></a><span>    </span><span class="hs-comment">-- assignment fixup blocks.</span><span>
</span><a name="line-529"></a><span>    </span><span class="hs-comment">-- when (not $ null fixup_blocks) $</span><span>
</span><a name="line-530"></a><span>    </span><span class="hs-comment">--    pprTrace &quot;fixup_blocks&quot; (ppr fixup_blocks) (return ())</span><span>
</span><a name="line-531"></a><span>
</span><a name="line-532"></a><span>    </span><span class="hs-comment">-- (e) Delete all register assignments for temps which are read</span><span>
</span><a name="line-533"></a><span>    </span><span class="hs-comment">--     (only) and die here.  Update the free register list.</span><span>
</span><a name="line-534"></a><span>    </span><a href="RegAlloc.Linear.Main.html#releaseRegs"><span class="hs-identifier hs-var">releaseRegs</span></a><span> </span><a href="#local-6989586621684901533"><span class="hs-identifier hs-var">r_dying</span></a><span>
</span><a name="line-535"></a><span>
</span><a name="line-536"></a><span>    </span><span class="hs-comment">-- (f) Mark regs which are clobbered as unallocatable</span><span>
</span><a name="line-537"></a><span>    </span><a href="RegAlloc.Linear.Main.html#clobberRegs"><span class="hs-identifier hs-var">clobberRegs</span></a><span> </span><a href="#local-6989586621684901539"><span class="hs-identifier hs-var">real_written</span></a><span>
</span><a name="line-538"></a><span>
</span><a name="line-539"></a><span>    </span><span class="hs-comment">-- (g) Allocate registers for temporaries *written* (only)</span><span>
</span><a name="line-540"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684901550"><a href="#local-6989586621684901550"><span class="hs-identifier">w_spills</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684901551"><a href="#local-6989586621684901551"><span class="hs-identifier">w_allocd</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-541"></a><span>        </span><a href="RegAlloc.Linear.Main.html#allocateRegsAndSpill"><span class="hs-identifier hs-var">allocateRegsAndSpill</span></a><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-comment">{-writing-}</span><span> </span><a href="#local-6989586621684901541"><span class="hs-identifier hs-var">virt_written</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621684901541"><span class="hs-identifier hs-var">virt_written</span></a><span>
</span><a name="line-542"></a><span>
</span><a name="line-543"></a><span>    </span><span class="hs-comment">-- (h) Release registers for temps which are written here and not</span><span>
</span><a name="line-544"></a><span>    </span><span class="hs-comment">-- used again.</span><span>
</span><a name="line-545"></a><span>    </span><a href="RegAlloc.Linear.Main.html#releaseRegs"><span class="hs-identifier hs-var">releaseRegs</span></a><span> </span><a href="#local-6989586621684901534"><span class="hs-identifier hs-var">w_dying</span></a><span>
</span><a name="line-546"></a><span>
</span><a name="line-547"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-548"></a><span>        </span><span class="hs-comment">-- (i) Patch the instruction</span><span>
</span><a name="line-549"></a><span>        </span><a name="local-6989586621684901552"><a href="#local-6989586621684901552"><span class="hs-identifier">patch_map</span></a></a><span>
</span><a name="line-550"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">listToUFM</span><span>
</span><a name="line-551"></a><span>                        </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684901555"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">,</span><span> </span><a href="Reg.html#RegReal"><span class="hs-identifier hs-var">RegReal</span></a><span> </span><a href="#local-6989586621684901556"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-552"></a><span>                                </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684901555"><a href="#local-6989586621684901555"><span class="hs-identifier">t</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684901556"><a href="#local-6989586621684901556"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621684901543"><span class="hs-identifier hs-var">virt_read</span></a><span>    </span><a href="#local-6989586621684901546"><span class="hs-identifier hs-var">r_allocd</span></a><span>
</span><a name="line-553"></a><span>                                         </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621684901541"><span class="hs-identifier hs-var">virt_written</span></a><span> </span><a href="#local-6989586621684901551"><span class="hs-identifier hs-var">w_allocd</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-554"></a><span>
</span><a name="line-555"></a><span>        </span><a name="local-6989586621684901553"><a href="#local-6989586621684901553"><span class="hs-identifier">patched_instr</span></a></a><span>
</span><a name="line-556"></a><span>                </span><span class="hs-glyph">=</span><span> </span><a href="Instruction.html#patchRegsOfInstr"><span class="hs-identifier hs-var">patchRegsOfInstr</span></a><span> </span><a href="#local-6989586621684901549"><span class="hs-identifier hs-var">adjusted_instr</span></a><span> </span><a href="#local-6989586621684901554"><span class="hs-identifier hs-var">patchLookup</span></a><span>
</span><a name="line-557"></a><span>
</span><a name="line-558"></a><span>        </span><a name="local-6989586621684901554"><a href="#local-6989586621684901554"><span class="hs-identifier">patchLookup</span></a></a><span> </span><a name="local-6989586621684901557"><a href="#local-6989586621684901557"><span class="hs-identifier">x</span></a></a><span>
</span><a name="line-559"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupUFM</span><span> </span><a href="#local-6989586621684901552"><span class="hs-identifier hs-var">patch_map</span></a><span> </span><a href="#local-6989586621684901557"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-560"></a><span>                        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684901557"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-561"></a><span>                        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684901558"><a href="#local-6989586621684901558"><span class="hs-identifier">y</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684901558"><span class="hs-identifier hs-var">y</span></a><span>
</span><a name="line-562"></a><span>
</span><a name="line-563"></a><span>
</span><a name="line-564"></a><span>    </span><span class="hs-comment">-- (j) free up stack slots for dead spilled regs</span><span>
</span><a name="line-565"></a><span>    </span><span class="hs-comment">-- TODO (can't be bothered right now)</span><span>
</span><a name="line-566"></a><span>
</span><a name="line-567"></a><span>    </span><span class="hs-comment">-- erase reg-&gt;reg moves where the source and destination are the same.</span><span>
</span><a name="line-568"></a><span>    </span><span class="hs-comment">--  If the src temp didn't die in this instr but happened to be allocated</span><span>
</span><a name="line-569"></a><span>    </span><span class="hs-comment">--  to the same real reg as the destination, then we can erase the move anyway.</span><span>
</span><a name="line-570"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901559"><a href="#local-6989586621684901559"><span class="hs-identifier">squashed_instr</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Instruction.html#takeRegRegMoveInstr"><span class="hs-identifier hs-var">takeRegRegMoveInstr</span></a><span> </span><a href="#local-6989586621684901553"><span class="hs-identifier hs-var">patched_instr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-571"></a><span>                                </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684901560"><a href="#local-6989586621684901560"><span class="hs-identifier">src</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684901561"><a href="#local-6989586621684901561"><span class="hs-identifier">dst</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-572"></a><span>                                 </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684901560"><span class="hs-identifier hs-var">src</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684901561"><span class="hs-identifier hs-var">dst</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-573"></a><span>                                </span><span class="hs-identifier">_</span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684901553"><span class="hs-identifier hs-var">patched_instr</span></a><span class="hs-special">]</span><span>
</span><a name="line-574"></a><span>
</span><a name="line-575"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901562"><a href="#local-6989586621684901562"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684901559"><span class="hs-identifier hs-var">squashed_instr</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684901550"><span class="hs-identifier hs-var">w_spills</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621684901545"><span class="hs-identifier hs-var">r_spills</span></a><span>
</span><a name="line-576"></a><span>                </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684901547"><span class="hs-identifier hs-var">clobber_saves</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684901530"><span class="hs-identifier hs-var">new_instrs</span></a><span>
</span><a name="line-577"></a><span>
</span><a name="line-578"></a><span class="hs-comment">--    pprTrace &quot;patched-code&quot; ((vcat $ map (docToSDoc . pprInstr) code)) $ do</span><span>
</span><a name="line-579"></a><span class="hs-comment">--    pprTrace &quot;pached-fixup&quot; ((ppr fixup_blocks)) $ do</span><span>
</span><a name="line-580"></a><span>
</span><a name="line-581"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684901562"><span class="hs-identifier hs-var">code</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684901548"><span class="hs-identifier hs-var">fixup_blocks</span></a><span class="hs-special">)</span><span>
</span><a name="line-582"></a><span>
</span><a name="line-583"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-584"></a><span>
</span><a name="line-585"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-586"></a><span class="hs-comment">-- releaseRegs</span><span>
</span><a name="line-587"></a><span>
</span><a name="line-588"></a><span class="hs-identifier">releaseRegs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RegAlloc.Linear.FreeRegs.html#FR"><span class="hs-identifier hs-type">FR</span></a><span> </span><a href="#local-6989586621684901400"><span class="hs-identifier hs-type">freeRegs</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><a href="Reg.html#Reg"><span class="hs-identifier hs-type">Reg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RegAlloc.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a><span> </span><a href="#local-6989586621684901400"><span class="hs-identifier hs-type">freeRegs</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-589"></a><a name="releaseRegs"><a href="RegAlloc.Linear.Main.html#releaseRegs"><span class="hs-identifier">releaseRegs</span></a></a><span> </span><a name="local-6989586621684901563"><a href="#local-6989586621684901563"><span class="hs-identifier">regs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-590"></a><span>  </span><a name="local-6989586621684901564"><a href="#local-6989586621684901564"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-591"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901565"><a href="#local-6989586621684901565"><span class="hs-identifier">platform</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621684901564"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-592"></a><span>  </span><a name="local-6989586621684901566"><a href="#local-6989586621684901566"><span class="hs-identifier">assig</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RegAlloc.Linear.State.html#getAssigR"><span class="hs-identifier hs-var">getAssigR</span></a><span>
</span><a name="line-593"></a><span>  </span><a name="local-6989586621684901567"><a href="#local-6989586621684901567"><span class="hs-identifier">free</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RegAlloc.Linear.State.html#getFreeRegsR"><span class="hs-identifier hs-var">getFreeRegsR</span></a><span>
</span><a name="line-594"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901568"><a href="#local-6989586621684901568"><span class="hs-identifier">loop</span></a></a><span> </span><a name="local-6989586621684901569"><a href="#local-6989586621684901569"><span class="hs-identifier">assig</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621684901570"><a href="#local-6989586621684901570"><span class="hs-identifier">free</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="RegAlloc.Linear.State.html#setAssigR"><span class="hs-identifier hs-var">setAssigR</span></a><span> </span><a href="#local-6989586621684901569"><span class="hs-identifier hs-var">assig</span></a><span class="hs-special">;</span><span> </span><a href="RegAlloc.Linear.State.html#setFreeRegsR"><span class="hs-identifier hs-var">setFreeRegsR</span></a><span> </span><a href="#local-6989586621684901570"><span class="hs-identifier hs-var">free</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-595"></a><span>      </span><span class="hs-identifier">loop</span><span> </span><a name="local-6989586621684901571"><a href="#local-6989586621684901571"><span class="hs-identifier">assig</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621684901572"><a href="#local-6989586621684901572"><span class="hs-identifier">free</span></a></a><span> </span><span class="hs-special">(</span><a href="Reg.html#RegReal"><span class="hs-identifier hs-var">RegReal</span></a><span> </span><a name="local-6989586621684901573"><a href="#local-6989586621684901573"><span class="hs-identifier">rr</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684901574"><a href="#local-6989586621684901574"><span class="hs-identifier">rs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684901568"><span class="hs-identifier hs-var">loop</span></a><span> </span><a href="#local-6989586621684901571"><span class="hs-identifier hs-var">assig</span></a><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.FreeRegs.html#frReleaseReg"><span class="hs-identifier hs-var">frReleaseReg</span></a><span> </span><a href="#local-6989586621684901565"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684901573"><span class="hs-identifier hs-var">rr</span></a><span> </span><a href="#local-6989586621684901572"><span class="hs-identifier hs-var">free</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684901574"><span class="hs-identifier hs-var">rs</span></a><span>
</span><a name="line-596"></a><span>      </span><span class="hs-identifier">loop</span><span> </span><a name="local-6989586621684901575"><a href="#local-6989586621684901575"><span class="hs-identifier">assig</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621684901576"><a href="#local-6989586621684901576"><span class="hs-identifier">free</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684901577"><a href="#local-6989586621684901577"><span class="hs-identifier">r</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684901578"><a href="#local-6989586621684901578"><span class="hs-identifier">rs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-597"></a><span>         </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupUFM</span><span> </span><a href="#local-6989586621684901575"><span class="hs-identifier hs-var">assig</span></a><span> </span><a href="#local-6989586621684901577"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-598"></a><span>         </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.Base.html#InBoth"><span class="hs-identifier hs-var">InBoth</span></a><span> </span><a name="local-6989586621684901579"><a href="#local-6989586621684901579"><span class="hs-identifier">real</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684901568"><span class="hs-identifier hs-var">loop</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">delFromUFM</span><span> </span><a href="#local-6989586621684901575"><span class="hs-identifier hs-var">assig</span></a><span> </span><a href="#local-6989586621684901577"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-599"></a><span>                                      </span><span class="hs-special">(</span><a href="RegAlloc.Linear.FreeRegs.html#frReleaseReg"><span class="hs-identifier hs-var">frReleaseReg</span></a><span> </span><a href="#local-6989586621684901565"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684901579"><span class="hs-identifier hs-var">real</span></a><span> </span><a href="#local-6989586621684901576"><span class="hs-identifier hs-var">free</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684901578"><span class="hs-identifier hs-var">rs</span></a><span>
</span><a name="line-600"></a><span>         </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.Base.html#InReg"><span class="hs-identifier hs-var">InReg</span></a><span> </span><a name="local-6989586621684901580"><a href="#local-6989586621684901580"><span class="hs-identifier">real</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684901568"><span class="hs-identifier hs-var">loop</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">delFromUFM</span><span> </span><a href="#local-6989586621684901575"><span class="hs-identifier hs-var">assig</span></a><span> </span><a href="#local-6989586621684901577"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-601"></a><span>                                      </span><span class="hs-special">(</span><a href="RegAlloc.Linear.FreeRegs.html#frReleaseReg"><span class="hs-identifier hs-var">frReleaseReg</span></a><span> </span><a href="#local-6989586621684901565"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684901580"><span class="hs-identifier hs-var">real</span></a><span> </span><a href="#local-6989586621684901576"><span class="hs-identifier hs-var">free</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684901578"><span class="hs-identifier hs-var">rs</span></a><span>
</span><a name="line-602"></a><span>         </span><span class="hs-identifier">_</span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684901568"><span class="hs-identifier hs-var">loop</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">delFromUFM</span><span> </span><a href="#local-6989586621684901575"><span class="hs-identifier hs-var">assig</span></a><span> </span><a href="#local-6989586621684901577"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684901576"><span class="hs-identifier hs-var">free</span></a><span> </span><a href="#local-6989586621684901578"><span class="hs-identifier hs-var">rs</span></a><span>
</span><a name="line-603"></a><span>  </span><a href="#local-6989586621684901568"><span class="hs-identifier hs-var">loop</span></a><span> </span><a href="#local-6989586621684901566"><span class="hs-identifier hs-var">assig</span></a><span> </span><a href="#local-6989586621684901567"><span class="hs-identifier hs-var">free</span></a><span> </span><a href="#local-6989586621684901563"><span class="hs-identifier hs-var">regs</span></a><span>
</span><a name="line-604"></a><span>
</span><a name="line-605"></a><span>
</span><a name="line-606"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-607"></a><span class="hs-comment">-- Clobber real registers</span><span>
</span><a name="line-608"></a><span>
</span><a name="line-609"></a><span class="hs-comment">-- For each temp in a register that is going to be clobbered:</span><span>
</span><a name="line-610"></a><span class="hs-comment">--      - if the temp dies after this instruction, do nothing</span><span>
</span><a name="line-611"></a><span class="hs-comment">--      - otherwise, put it somewhere safe (another reg if possible,</span><span>
</span><a name="line-612"></a><span class="hs-comment">--              otherwise spill and record InBoth in the assignment).</span><span>
</span><a name="line-613"></a><span class="hs-comment">--      - for allocateRegs on the temps *read*,</span><span>
</span><a name="line-614"></a><span class="hs-comment">--      - clobbered regs are allocatable.</span><span>
</span><a name="line-615"></a><span class="hs-comment">--</span><span>
</span><a name="line-616"></a><span class="hs-comment">--      for allocateRegs on the temps *written*,</span><span>
</span><a name="line-617"></a><span class="hs-comment">--        - clobbered regs are not allocatable.</span><span>
</span><a name="line-618"></a><span class="hs-comment">--</span><span>
</span><a name="line-619"></a><span>
</span><a name="line-620"></a><span class="hs-identifier">saveClobberedTemps</span><span>
</span><a name="line-621"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Instruction.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a><span> </span><a href="#local-6989586621684901398"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">,</span><span> </span><a href="RegAlloc.Linear.FreeRegs.html#FR"><span class="hs-identifier hs-type">FR</span></a><span> </span><a href="#local-6989586621684901399"><span class="hs-identifier hs-type">freeRegs</span></a><span class="hs-special">)</span><span>
</span><a name="line-622"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><a href="Reg.html#RealReg"><span class="hs-identifier hs-type">RealReg</span></a><span class="hs-special">]</span><span>            </span><span class="hs-comment">-- real registers clobbered by this instruction</span><span>
</span><a name="line-623"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Reg.html#Reg"><span class="hs-identifier hs-type">Reg</span></a><span class="hs-special">]</span><span>                </span><span class="hs-comment">-- registers which are no longer live after this insn</span><span>
</span><a name="line-624"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RegAlloc.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a><span> </span><a href="#local-6989586621684901399"><span class="hs-identifier hs-type">freeRegs</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684901398"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span>         </span><span class="hs-comment">-- return: instructions to spill any temps that will</span><span>
</span><a name="line-625"></a><span>                                </span><span class="hs-comment">-- be clobbered.</span><span>
</span><a name="line-626"></a><span>
</span><a name="line-627"></a><a name="saveClobberedTemps"><a href="RegAlloc.Linear.Main.html#saveClobberedTemps"><span class="hs-identifier">saveClobberedTemps</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-628"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-629"></a><span>
</span><a name="line-630"></a><span class="hs-identifier">saveClobberedTemps</span><span> </span><a name="local-6989586621684901581"><a href="#local-6989586621684901581"><span class="hs-identifier">clobbered</span></a></a><span> </span><a name="local-6989586621684901582"><a href="#local-6989586621684901582"><span class="hs-identifier">dying</span></a></a><span>
</span><a name="line-631"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-632"></a><span>        </span><a name="local-6989586621684901602"><a href="#local-6989586621684901602"><span class="hs-identifier">assig</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RegAlloc.Linear.State.html#getAssigR"><span class="hs-identifier hs-var">getAssigR</span></a><span>
</span><a name="line-633"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901603"><a href="#local-6989586621684901603"><span class="hs-identifier">to_spill</span></a></a><span>
</span><a name="line-634"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684901604"><span class="hs-identifier hs-var">temp</span></a><span class="hs-special">,</span><a href="#local-6989586621684901605"><span class="hs-identifier hs-var">reg</span></a><span class="hs-special">)</span><span>
</span><a name="line-635"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684901604"><a href="#local-6989586621684901604"><span class="hs-identifier">temp</span></a></a><span class="hs-special">,</span><span> </span><a href="RegAlloc.Linear.Base.html#InReg"><span class="hs-identifier hs-var">InReg</span></a><span> </span><a name="local-6989586621684901605"><a href="#local-6989586621684901605"><span class="hs-identifier">reg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">nonDetUFMToList</span><span> </span><a href="#local-6989586621684901602"><span class="hs-identifier hs-var">assig</span></a><span>
</span><a name="line-636"></a><span>                        </span><span class="hs-comment">-- This is non-deterministic but we do not</span><span>
</span><a name="line-637"></a><span>                        </span><span class="hs-comment">-- currently support deterministic code-generation.</span><span>
</span><a name="line-638"></a><span>                        </span><span class="hs-comment">-- See Note [Unique Determinism and code generation]</span><span>
</span><a name="line-639"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><a href="Reg.html#realRegsAlias"><span class="hs-identifier hs-var">realRegsAlias</span></a><span> </span><a href="#local-6989586621684901605"><span class="hs-identifier hs-var">reg</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684901581"><span class="hs-identifier hs-var">clobbered</span></a><span>
</span><a name="line-640"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684901604"><span class="hs-identifier hs-var">temp</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">notElem</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">getUnique</span><span> </span><a href="#local-6989586621684901582"><span class="hs-identifier hs-var">dying</span></a><span>  </span><span class="hs-special">]</span><span>
</span><a name="line-641"></a><span>
</span><a name="line-642"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684901606"><a href="#local-6989586621684901606"><span class="hs-identifier">instrs</span></a></a><span class="hs-special">,</span><a name="local-6989586621684901607"><a href="#local-6989586621684901607"><span class="hs-identifier">assig'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684901583"><span class="hs-identifier hs-var">clobber</span></a><span> </span><a href="#local-6989586621684901602"><span class="hs-identifier hs-var">assig</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621684901603"><span class="hs-identifier hs-var">to_spill</span></a><span>
</span><a name="line-643"></a><span>        </span><a href="RegAlloc.Linear.State.html#setAssigR"><span class="hs-identifier hs-var">setAssigR</span></a><span> </span><a href="#local-6989586621684901607"><span class="hs-identifier hs-var">assig'</span></a><span>
</span><a name="line-644"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684901606"><span class="hs-identifier hs-var">instrs</span></a><span>
</span><a name="line-645"></a><span>
</span><a name="line-646"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-647"></a><span>     </span><a name="local-6989586621684901583"><a href="#local-6989586621684901583"><span class="hs-identifier">clobber</span></a></a><span> </span><a name="local-6989586621684901584"><a href="#local-6989586621684901584"><span class="hs-identifier">assig</span></a></a><span> </span><a name="local-6989586621684901585"><a href="#local-6989586621684901585"><span class="hs-identifier">instrs</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-648"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684901585"><span class="hs-identifier hs-var">instrs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684901584"><span class="hs-identifier hs-var">assig</span></a><span class="hs-special">)</span><span>
</span><a name="line-649"></a><span>
</span><a name="line-650"></a><span>     </span><span class="hs-identifier">clobber</span><span> </span><a name="local-6989586621684901586"><a href="#local-6989586621684901586"><span class="hs-identifier">assig</span></a></a><span> </span><a name="local-6989586621684901587"><a href="#local-6989586621684901587"><span class="hs-identifier">instrs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621684901588"><a href="#local-6989586621684901588"><span class="hs-identifier">temp</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684901589"><a href="#local-6989586621684901589"><span class="hs-identifier">reg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684901590"><a href="#local-6989586621684901590"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-651"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621684901591"><a href="#local-6989586621684901591"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-652"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901592"><a href="#local-6989586621684901592"><span class="hs-identifier">platform</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621684901591"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-653"></a><span>
</span><a name="line-654"></a><span>            </span><a name="local-6989586621684901593"><a href="#local-6989586621684901593"><span class="hs-identifier">freeRegs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RegAlloc.Linear.State.html#getFreeRegsR"><span class="hs-identifier hs-var">getFreeRegsR</span></a><span>
</span><a name="line-655"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901594"><a href="#local-6989586621684901594"><span class="hs-identifier">regclass</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TargetReg.html#targetClassOfRealReg"><span class="hs-identifier hs-var">targetClassOfRealReg</span></a><span> </span><a href="#local-6989586621684901592"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684901589"><span class="hs-identifier hs-var">reg</span></a><span>
</span><a name="line-656"></a><span>                </span><a name="local-6989586621684901595"><a href="#local-6989586621684901595"><span class="hs-identifier">freeRegs_thisClass</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RegAlloc.Linear.FreeRegs.html#frGetFreeRegs"><span class="hs-identifier hs-var">frGetFreeRegs</span></a><span> </span><a href="#local-6989586621684901592"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684901594"><span class="hs-identifier hs-var">regclass</span></a><span> </span><a href="#local-6989586621684901593"><span class="hs-identifier hs-var">freeRegs</span></a><span>
</span><a name="line-657"></a><span>
</span><a name="line-658"></a><span>            </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">notElem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684901581"><span class="hs-identifier hs-var">clobbered</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684901595"><span class="hs-identifier hs-var">freeRegs_thisClass</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-659"></a><span>
</span><a name="line-660"></a><span>              </span><span class="hs-comment">-- (1) we have a free reg of the right class that isn't</span><span>
</span><a name="line-661"></a><span>              </span><span class="hs-comment">-- clobbered by this instruction; use it to save the</span><span>
</span><a name="line-662"></a><span>              </span><span class="hs-comment">-- clobbered value.</span><span>
</span><a name="line-663"></a><span>              </span><span class="hs-special">(</span><a name="local-6989586621684901596"><a href="#local-6989586621684901596"><span class="hs-identifier">my_reg</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-664"></a><span>                  </span><a href="RegAlloc.Linear.State.html#setFreeRegsR"><span class="hs-identifier hs-var">setFreeRegsR</span></a><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.FreeRegs.html#frAllocateReg"><span class="hs-identifier hs-var">frAllocateReg</span></a><span> </span><a href="#local-6989586621684901592"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684901596"><span class="hs-identifier hs-var">my_reg</span></a><span> </span><a href="#local-6989586621684901593"><span class="hs-identifier hs-var">freeRegs</span></a><span class="hs-special">)</span><span>
</span><a name="line-665"></a><span>
</span><a name="line-666"></a><span>                  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901597"><a href="#local-6989586621684901597"><span class="hs-identifier">new_assign</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addToUFM</span><span> </span><a href="#local-6989586621684901586"><span class="hs-identifier hs-var">assig</span></a><span> </span><a href="#local-6989586621684901588"><span class="hs-identifier hs-var">temp</span></a><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.Base.html#InReg"><span class="hs-identifier hs-var">InReg</span></a><span> </span><a href="#local-6989586621684901596"><span class="hs-identifier hs-var">my_reg</span></a><span class="hs-special">)</span><span>
</span><a name="line-667"></a><span>                  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901598"><a href="#local-6989586621684901598"><span class="hs-identifier">instr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Instruction.html#mkRegRegMoveInstr"><span class="hs-identifier hs-var">mkRegRegMoveInstr</span></a><span> </span><a href="#local-6989586621684901592"><span class="hs-identifier hs-var">platform</span></a><span>
</span><a name="line-668"></a><span>                                  </span><span class="hs-special">(</span><a href="Reg.html#RegReal"><span class="hs-identifier hs-var">RegReal</span></a><span> </span><a href="#local-6989586621684901589"><span class="hs-identifier hs-var">reg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Reg.html#RegReal"><span class="hs-identifier hs-var">RegReal</span></a><span> </span><a href="#local-6989586621684901596"><span class="hs-identifier hs-var">my_reg</span></a><span class="hs-special">)</span><span>
</span><a name="line-669"></a><span>
</span><a name="line-670"></a><span>                  </span><a href="#local-6989586621684901583"><span class="hs-identifier hs-var">clobber</span></a><span> </span><a href="#local-6989586621684901597"><span class="hs-identifier hs-var">new_assign</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684901598"><span class="hs-identifier hs-var">instr</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684901587"><span class="hs-identifier hs-var">instrs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684901590"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-671"></a><span>
</span><a name="line-672"></a><span>              </span><span class="hs-comment">-- (2) no free registers: spill the value</span><span>
</span><a name="line-673"></a><span>              </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-674"></a><span>                  </span><span class="hs-special">(</span><a name="local-6989586621684901599"><a href="#local-6989586621684901599"><span class="hs-identifier">spill</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684901600"><a href="#local-6989586621684901600"><span class="hs-identifier">slot</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RegAlloc.Linear.State.html#spillR"><span class="hs-identifier hs-var">spillR</span></a><span> </span><span class="hs-special">(</span><a href="Reg.html#RegReal"><span class="hs-identifier hs-var">RegReal</span></a><span> </span><a href="#local-6989586621684901589"><span class="hs-identifier hs-var">reg</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684901588"><span class="hs-identifier hs-var">temp</span></a><span>
</span><a name="line-675"></a><span>
</span><a name="line-676"></a><span>                  </span><span class="hs-comment">-- record why this reg was spilled for profiling</span><span>
</span><a name="line-677"></a><span>                  </span><a href="RegAlloc.Linear.State.html#recordSpill"><span class="hs-identifier hs-var">recordSpill</span></a><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.Base.html#SpillClobber"><span class="hs-identifier hs-var">SpillClobber</span></a><span> </span><a href="#local-6989586621684901588"><span class="hs-identifier hs-var">temp</span></a><span class="hs-special">)</span><span>
</span><a name="line-678"></a><span>
</span><a name="line-679"></a><span>                  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901601"><a href="#local-6989586621684901601"><span class="hs-identifier">new_assign</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addToUFM</span><span> </span><a href="#local-6989586621684901586"><span class="hs-identifier hs-var">assig</span></a><span> </span><a href="#local-6989586621684901588"><span class="hs-identifier hs-var">temp</span></a><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.Base.html#InBoth"><span class="hs-identifier hs-var">InBoth</span></a><span> </span><a href="#local-6989586621684901589"><span class="hs-identifier hs-var">reg</span></a><span> </span><a href="#local-6989586621684901600"><span class="hs-identifier hs-var">slot</span></a><span class="hs-special">)</span><span>
</span><a name="line-680"></a><span>
</span><a name="line-681"></a><span>                  </span><a href="#local-6989586621684901583"><span class="hs-identifier hs-var">clobber</span></a><span> </span><a href="#local-6989586621684901601"><span class="hs-identifier hs-var">new_assign</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684901599"><span class="hs-identifier hs-var">spill</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684901587"><span class="hs-identifier hs-var">instrs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684901590"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-682"></a><span>
</span><a name="line-683"></a><span>
</span><a name="line-684"></a><span>
</span><a name="line-685"></a><span class="hs-comment">-- | Mark all these real regs as allocated,</span><span>
</span><a name="line-686"></a><span class="hs-comment">--      and kick out their vreg assignments.</span><span>
</span><a name="line-687"></a><span class="hs-comment">--</span><span>
</span><a name="line-688"></a><span class="hs-identifier">clobberRegs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RegAlloc.Linear.FreeRegs.html#FR"><span class="hs-identifier hs-type">FR</span></a><span> </span><a href="#local-6989586621684901397"><span class="hs-identifier hs-type">freeRegs</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><a href="Reg.html#RealReg"><span class="hs-identifier hs-type">RealReg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RegAlloc.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a><span> </span><a href="#local-6989586621684901397"><span class="hs-identifier hs-type">freeRegs</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-689"></a><a name="clobberRegs"><a href="RegAlloc.Linear.Main.html#clobberRegs"><span class="hs-identifier">clobberRegs</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-690"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-691"></a><span>
</span><a name="line-692"></a><span class="hs-identifier">clobberRegs</span><span> </span><a name="local-6989586621684901608"><a href="#local-6989586621684901608"><span class="hs-identifier">clobbered</span></a></a><span>
</span><a name="line-693"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>   </span><a name="local-6989586621684901618"><a href="#local-6989586621684901618"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-694"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901619"><a href="#local-6989586621684901619"><span class="hs-identifier">platform</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621684901618"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-695"></a><span>
</span><a name="line-696"></a><span>        </span><a name="local-6989586621684901620"><a href="#local-6989586621684901620"><span class="hs-identifier">freeregs</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RegAlloc.Linear.State.html#getFreeRegsR"><span class="hs-identifier hs-var">getFreeRegsR</span></a><span>
</span><a name="line-697"></a><span>        </span><a href="RegAlloc.Linear.State.html#setFreeRegsR"><span class="hs-identifier hs-var">setFreeRegsR</span></a><span> </span><span class="hs-operator hs-var">$!</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="RegAlloc.Linear.FreeRegs.html#frAllocateReg"><span class="hs-identifier hs-var">frAllocateReg</span></a><span> </span><a href="#local-6989586621684901619"><span class="hs-identifier hs-var">platform</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684901620"><span class="hs-identifier hs-var">freeregs</span></a><span> </span><a href="#local-6989586621684901608"><span class="hs-identifier hs-var">clobbered</span></a><span>
</span><a name="line-698"></a><span>
</span><a name="line-699"></a><span>        </span><a name="local-6989586621684901621"><a href="#local-6989586621684901621"><span class="hs-identifier">assig</span></a></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RegAlloc.Linear.State.html#getAssigR"><span class="hs-identifier hs-var">getAssigR</span></a><span>
</span><a name="line-700"></a><span>        </span><a href="RegAlloc.Linear.State.html#setAssigR"><span class="hs-identifier hs-var">setAssigR</span></a><span> </span><span class="hs-operator hs-var">$!</span><span> </span><a href="#local-6989586621684901609"><span class="hs-identifier hs-var">clobber</span></a><span> </span><a href="#local-6989586621684901621"><span class="hs-identifier hs-var">assig</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nonDetUFMToList</span><span> </span><a href="#local-6989586621684901621"><span class="hs-identifier hs-var">assig</span></a><span class="hs-special">)</span><span>
</span><a name="line-701"></a><span>          </span><span class="hs-comment">-- This is non-deterministic but we do not</span><span>
</span><a name="line-702"></a><span>          </span><span class="hs-comment">-- currently support deterministic code-generation.</span><span>
</span><a name="line-703"></a><span>          </span><span class="hs-comment">-- See Note [Unique Determinism and code generation]</span><span>
</span><a name="line-704"></a><span>
</span><a name="line-705"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-706"></a><span>        </span><span class="hs-comment">-- if the temp was InReg and clobbered, then we will have</span><span>
</span><a name="line-707"></a><span>        </span><span class="hs-comment">-- saved it in saveClobberedTemps above.  So the only case</span><span>
</span><a name="line-708"></a><span>        </span><span class="hs-comment">-- we have to worry about here is InBoth.  Note that this</span><span>
</span><a name="line-709"></a><span>        </span><span class="hs-comment">-- also catches temps which were loaded up during allocation</span><span>
</span><a name="line-710"></a><span>        </span><span class="hs-comment">-- of read registers, not just those saved in saveClobberedTemps.</span><span>
</span><a name="line-711"></a><span>
</span><a name="line-712"></a><span>        </span><a name="local-6989586621684901609"><a href="#local-6989586621684901609"><span class="hs-identifier">clobber</span></a></a><span> </span><a name="local-6989586621684901610"><a href="#local-6989586621684901610"><span class="hs-identifier">assig</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-713"></a><span>                </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684901610"><span class="hs-identifier hs-var">assig</span></a><span>
</span><a name="line-714"></a><span>
</span><a name="line-715"></a><span>        </span><span class="hs-identifier">clobber</span><span> </span><a name="local-6989586621684901611"><a href="#local-6989586621684901611"><span class="hs-identifier">assig</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621684901612"><a href="#local-6989586621684901612"><span class="hs-identifier">temp</span></a></a><span class="hs-special">,</span><span> </span><a href="RegAlloc.Linear.Base.html#InBoth"><span class="hs-identifier hs-var">InBoth</span></a><span> </span><a name="local-6989586621684901613"><a href="#local-6989586621684901613"><span class="hs-identifier">reg</span></a></a><span> </span><a name="local-6989586621684901614"><a href="#local-6989586621684901614"><span class="hs-identifier">slot</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684901615"><a href="#local-6989586621684901615"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-716"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><a href="Reg.html#realRegsAlias"><span class="hs-identifier hs-var">realRegsAlias</span></a><span> </span><a href="#local-6989586621684901613"><span class="hs-identifier hs-var">reg</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684901608"><span class="hs-identifier hs-var">clobbered</span></a><span>
</span><a name="line-717"></a><span>                </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684901609"><span class="hs-identifier hs-var">clobber</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">addToUFM</span><span> </span><a href="#local-6989586621684901611"><span class="hs-identifier hs-var">assig</span></a><span> </span><a href="#local-6989586621684901612"><span class="hs-identifier hs-var">temp</span></a><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.Base.html#InMem"><span class="hs-identifier hs-var">InMem</span></a><span> </span><a href="#local-6989586621684901614"><span class="hs-identifier hs-var">slot</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684901615"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-718"></a><span>
</span><a name="line-719"></a><span>        </span><span class="hs-identifier">clobber</span><span> </span><a name="local-6989586621684901616"><a href="#local-6989586621684901616"><span class="hs-identifier">assig</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><a name="local-6989586621684901617"><a href="#local-6989586621684901617"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-720"></a><span>                </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684901609"><span class="hs-identifier hs-var">clobber</span></a><span> </span><a href="#local-6989586621684901616"><span class="hs-identifier hs-var">assig</span></a><span> </span><a href="#local-6989586621684901617"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-721"></a><span>
</span><a name="line-722"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-723"></a><span class="hs-comment">-- allocateRegsAndSpill</span><span>
</span><a name="line-724"></a><span>
</span><a name="line-725"></a><span class="hs-comment">-- Why are we performing a spill?</span><span>
</span><a name="line-726"></a><span class="hs-keyword">data</span><span> </span><a name="SpillLoc"><a href="RegAlloc.Linear.Main.html#SpillLoc"><span class="hs-identifier">SpillLoc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="ReadMem"><a href="RegAlloc.Linear.Main.html#ReadMem"><span class="hs-identifier">ReadMem</span></a></a><span> </span><a href="RegAlloc.Linear.StackMap.html#StackSlot"><span class="hs-identifier hs-type">StackSlot</span></a><span>  </span><span class="hs-comment">-- reading from register only in memory</span><span>
</span><a name="line-727"></a><span>              </span><span class="hs-glyph">|</span><span> </span><a name="WriteNew"><a href="RegAlloc.Linear.Main.html#WriteNew"><span class="hs-identifier">WriteNew</span></a></a><span>           </span><span class="hs-comment">-- writing to a new variable</span><span>
</span><a name="line-728"></a><span>              </span><span class="hs-glyph">|</span><span> </span><a name="WriteMem"><a href="RegAlloc.Linear.Main.html#WriteMem"><span class="hs-identifier">WriteMem</span></a></a><span>           </span><span class="hs-comment">-- writing to register only in memory</span><span>
</span><a name="line-729"></a><span class="hs-comment">-- Note that ReadNew is not valid, since you don't want to be reading</span><span>
</span><a name="line-730"></a><span class="hs-comment">-- from an uninitialized register.  We also don't need the location of</span><span>
</span><a name="line-731"></a><span class="hs-comment">-- the register in memory, since that will be invalidated by the write.</span><span>
</span><a name="line-732"></a><span class="hs-comment">-- Technically, we could coalesce WriteNew and WriteMem into a single</span><span>
</span><a name="line-733"></a><span class="hs-comment">-- entry as well. -- EZY</span><span>
</span><a name="line-734"></a><span>
</span><a name="line-735"></a><span class="hs-comment">-- This function does several things:</span><span>
</span><a name="line-736"></a><span class="hs-comment">--   For each temporary referred to by this instruction,</span><span>
</span><a name="line-737"></a><span class="hs-comment">--   we allocate a real register (spilling another temporary if necessary).</span><span>
</span><a name="line-738"></a><span class="hs-comment">--   We load the temporary up from memory if necessary.</span><span>
</span><a name="line-739"></a><span class="hs-comment">--   We also update the register assignment in the process, and</span><span>
</span><a name="line-740"></a><span class="hs-comment">--   the list of free registers and free stack slots.</span><span>
</span><a name="line-741"></a><span>
</span><a name="line-742"></a><span class="hs-identifier">allocateRegsAndSpill</span><span>
</span><a name="line-743"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.FreeRegs.html#FR"><span class="hs-identifier hs-type">FR</span></a><span> </span><a href="#local-6989586621684901395"><span class="hs-identifier hs-type">freeRegs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684901396"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">,</span><span> </span><a href="Instruction.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a><span> </span><a href="#local-6989586621684901396"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">)</span><span>
</span><a name="line-744"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>                 </span><span class="hs-comment">-- True &lt;=&gt; reading (load up spilled regs)</span><span>
</span><a name="line-745"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Reg.html#VirtualReg"><span class="hs-identifier hs-type">VirtualReg</span></a><span class="hs-special">]</span><span>         </span><span class="hs-comment">-- don't push these out</span><span>
</span><a name="line-746"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684901396"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span>              </span><span class="hs-comment">-- spill insns</span><span>
</span><a name="line-747"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Reg.html#RealReg"><span class="hs-identifier hs-type">RealReg</span></a><span class="hs-special">]</span><span>            </span><span class="hs-comment">-- real registers allocated (accum.)</span><span>
</span><a name="line-748"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Reg.html#VirtualReg"><span class="hs-identifier hs-type">VirtualReg</span></a><span class="hs-special">]</span><span>         </span><span class="hs-comment">-- temps to allocate</span><span>
</span><a name="line-749"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RegAlloc.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a><span> </span><a href="#local-6989586621684901395"><span class="hs-identifier hs-type">freeRegs</span></a><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684901396"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Reg.html#RealReg"><span class="hs-identifier hs-type">RealReg</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-750"></a><span>
</span><a name="line-751"></a><a name="allocateRegsAndSpill"><a href="RegAlloc.Linear.Main.html#allocateRegsAndSpill"><span class="hs-identifier">allocateRegsAndSpill</span></a></a><span> </span><span class="hs-identifier">_</span><span>       </span><span class="hs-identifier">_</span><span>    </span><a name="local-6989586621684901622"><a href="#local-6989586621684901622"><span class="hs-identifier">spills</span></a></a><span> </span><a name="local-6989586621684901623"><a href="#local-6989586621684901623"><span class="hs-identifier">alloc</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-752"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684901622"><span class="hs-identifier hs-var">spills</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621684901623"><span class="hs-identifier hs-var">alloc</span></a><span class="hs-special">)</span><span>
</span><a name="line-753"></a><span>
</span><a name="line-754"></a><span class="hs-identifier">allocateRegsAndSpill</span><span> </span><a name="local-6989586621684901624"><a href="#local-6989586621684901624"><span class="hs-identifier">reading</span></a></a><span> </span><a name="local-6989586621684901625"><a href="#local-6989586621684901625"><span class="hs-identifier">keep</span></a></a><span> </span><a name="local-6989586621684901626"><a href="#local-6989586621684901626"><span class="hs-identifier">spills</span></a></a><span> </span><a name="local-6989586621684901627"><a href="#local-6989586621684901627"><span class="hs-identifier">alloc</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684901628"><a href="#local-6989586621684901628"><span class="hs-identifier">r</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684901629"><a href="#local-6989586621684901629"><span class="hs-identifier">rs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-755"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>   </span><a name="local-6989586621684901630"><a href="#local-6989586621684901630"><span class="hs-identifier">assig</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RegAlloc.Linear.State.html#getAssigR"><span class="hs-identifier hs-var">getAssigR</span></a><span>
</span><a name="line-756"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901631"><a href="#local-6989586621684901631"><span class="hs-identifier">doSpill</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RegAlloc.Linear.Main.html#allocRegsAndSpill_spill"><span class="hs-identifier hs-var">allocRegsAndSpill_spill</span></a><span> </span><a href="#local-6989586621684901624"><span class="hs-identifier hs-var">reading</span></a><span> </span><a href="#local-6989586621684901625"><span class="hs-identifier hs-var">keep</span></a><span> </span><a href="#local-6989586621684901626"><span class="hs-identifier hs-var">spills</span></a><span> </span><a href="#local-6989586621684901627"><span class="hs-identifier hs-var">alloc</span></a><span> </span><a href="#local-6989586621684901628"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621684901629"><span class="hs-identifier hs-var">rs</span></a><span> </span><a href="#local-6989586621684901630"><span class="hs-identifier hs-var">assig</span></a><span>
</span><a name="line-757"></a><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupUFM</span><span> </span><a href="#local-6989586621684901630"><span class="hs-identifier hs-var">assig</span></a><span> </span><a href="#local-6989586621684901628"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-758"></a><span>                </span><span class="hs-comment">-- case (1a): already in a register</span><span>
</span><a name="line-759"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.Base.html#InReg"><span class="hs-identifier hs-var">InReg</span></a><span> </span><a name="local-6989586621684901632"><a href="#local-6989586621684901632"><span class="hs-identifier">my_reg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-760"></a><span>                        </span><a href="RegAlloc.Linear.Main.html#allocateRegsAndSpill"><span class="hs-identifier hs-var">allocateRegsAndSpill</span></a><span> </span><a href="#local-6989586621684901624"><span class="hs-identifier hs-var">reading</span></a><span> </span><a href="#local-6989586621684901625"><span class="hs-identifier hs-var">keep</span></a><span> </span><a href="#local-6989586621684901626"><span class="hs-identifier hs-var">spills</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684901632"><span class="hs-identifier hs-var">my_reg</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684901627"><span class="hs-identifier hs-var">alloc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684901629"><span class="hs-identifier hs-var">rs</span></a><span>
</span><a name="line-761"></a><span>
</span><a name="line-762"></a><span>                </span><span class="hs-comment">-- case (1b): already in a register (and memory)</span><span>
</span><a name="line-763"></a><span>                </span><span class="hs-comment">-- NB1. if we're writing this register, update its assignment to be</span><span>
</span><a name="line-764"></a><span>                </span><span class="hs-comment">-- InReg, because the memory value is no longer valid.</span><span>
</span><a name="line-765"></a><span>                </span><span class="hs-comment">-- NB2. This is why we must process written registers here, even if they</span><span>
</span><a name="line-766"></a><span>                </span><span class="hs-comment">-- are also read by the same instruction.</span><span>
</span><a name="line-767"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.Base.html#InBoth"><span class="hs-identifier hs-var">InBoth</span></a><span> </span><a name="local-6989586621684901633"><a href="#local-6989586621684901633"><span class="hs-identifier">my_reg</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-768"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621684901624"><span class="hs-identifier hs-var">reading</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.State.html#setAssigR"><span class="hs-identifier hs-var">setAssigR</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">addToUFM</span><span> </span><a href="#local-6989586621684901630"><span class="hs-identifier hs-var">assig</span></a><span> </span><a href="#local-6989586621684901628"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.Base.html#InReg"><span class="hs-identifier hs-var">InReg</span></a><span> </span><a href="#local-6989586621684901633"><span class="hs-identifier hs-var">my_reg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-769"></a><span>                        </span><a href="RegAlloc.Linear.Main.html#allocateRegsAndSpill"><span class="hs-identifier hs-var">allocateRegsAndSpill</span></a><span> </span><a href="#local-6989586621684901624"><span class="hs-identifier hs-var">reading</span></a><span> </span><a href="#local-6989586621684901625"><span class="hs-identifier hs-var">keep</span></a><span> </span><a href="#local-6989586621684901626"><span class="hs-identifier hs-var">spills</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684901633"><span class="hs-identifier hs-var">my_reg</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684901627"><span class="hs-identifier hs-var">alloc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684901629"><span class="hs-identifier hs-var">rs</span></a><span>
</span><a name="line-770"></a><span>
</span><a name="line-771"></a><span>                </span><span class="hs-comment">-- Not already in a register, so we need to find a free one...</span><span>
</span><a name="line-772"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.Base.html#InMem"><span class="hs-identifier hs-var">InMem</span></a><span> </span><a name="local-6989586621684901634"><a href="#local-6989586621684901634"><span class="hs-identifier">slot</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684901624"><span class="hs-identifier hs-var">reading</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684901631"><span class="hs-identifier hs-var">doSpill</span></a><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.Main.html#ReadMem"><span class="hs-identifier hs-var">ReadMem</span></a><span> </span><a href="#local-6989586621684901634"><span class="hs-identifier hs-var">slot</span></a><span class="hs-special">)</span><span>
</span><a name="line-773"></a><span>                                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684901631"><span class="hs-identifier hs-var">doSpill</span></a><span> </span><a href="RegAlloc.Linear.Main.html#WriteMem"><span class="hs-identifier hs-var">WriteMem</span></a><span>
</span><a name="line-774"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684901624"><span class="hs-identifier hs-var">reading</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-775"></a><span>                   </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;allocateRegsAndSpill: Cannot read from uninitialized register&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684901628"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-776"></a><span>                   </span><span class="hs-comment">-- NOTE: if the input to the NCG contains some</span><span>
</span><a name="line-777"></a><span>                   </span><span class="hs-comment">-- unreachable blocks with junk code, this panic</span><span>
</span><a name="line-778"></a><span>                   </span><span class="hs-comment">-- might be triggered.  Make sure you only feed</span><span>
</span><a name="line-779"></a><span>                   </span><span class="hs-comment">-- sensible code into the NCG.  In CmmPipeline we</span><span>
</span><a name="line-780"></a><span>                   </span><span class="hs-comment">-- call removeUnreachableBlocks at the end for this</span><span>
</span><a name="line-781"></a><span>                   </span><span class="hs-comment">-- reason.</span><span>
</span><a name="line-782"></a><span>
</span><a name="line-783"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684901631"><span class="hs-identifier hs-var">doSpill</span></a><span> </span><a href="RegAlloc.Linear.Main.html#WriteNew"><span class="hs-identifier hs-var">WriteNew</span></a><span>
</span><a name="line-784"></a><span>
</span><a name="line-785"></a><span>
</span><a name="line-786"></a><span class="hs-comment">-- reading is redundant with reason, but we keep it around because it's</span><span>
</span><a name="line-787"></a><span class="hs-comment">-- convenient and it maintains the recursive structure of the allocator. -- EZY</span><span>
</span><a name="line-788"></a><span class="hs-identifier">allocRegsAndSpill_spill</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.FreeRegs.html#FR"><span class="hs-identifier hs-type">FR</span></a><span> </span><a href="#local-6989586621684901393"><span class="hs-identifier hs-type">freeRegs</span></a><span class="hs-special">,</span><span> </span><a href="Instruction.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a><span> </span><a href="#local-6989586621684901394"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684901394"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">)</span><span>
</span><a name="line-789"></a><span>                        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-790"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Reg.html#VirtualReg"><span class="hs-identifier hs-type">VirtualReg</span></a><span class="hs-special">]</span><span>
</span><a name="line-791"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684901394"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span>
</span><a name="line-792"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Reg.html#RealReg"><span class="hs-identifier hs-type">RealReg</span></a><span class="hs-special">]</span><span>
</span><a name="line-793"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reg.html#VirtualReg"><span class="hs-identifier hs-type">VirtualReg</span></a><span>
</span><a name="line-794"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Reg.html#VirtualReg"><span class="hs-identifier hs-type">VirtualReg</span></a><span class="hs-special">]</span><span>
</span><a name="line-795"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqFM</span><span> </span><a href="RegAlloc.Linear.Base.html#Loc"><span class="hs-identifier hs-type">Loc</span></a><span>
</span><a name="line-796"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RegAlloc.Linear.Main.html#SpillLoc"><span class="hs-identifier hs-type">SpillLoc</span></a><span>
</span><a name="line-797"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RegAlloc.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a><span> </span><a href="#local-6989586621684901393"><span class="hs-identifier hs-type">freeRegs</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="#local-6989586621684901394"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Reg.html#RealReg"><span class="hs-identifier hs-type">RealReg</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-798"></a><a name="allocRegsAndSpill_spill"><a href="RegAlloc.Linear.Main.html#allocRegsAndSpill_spill"><span class="hs-identifier">allocRegsAndSpill_spill</span></a></a><span> </span><a name="local-6989586621684901635"><a href="#local-6989586621684901635"><span class="hs-identifier">reading</span></a></a><span> </span><a name="local-6989586621684901636"><a href="#local-6989586621684901636"><span class="hs-identifier">keep</span></a></a><span> </span><a name="local-6989586621684901637"><a href="#local-6989586621684901637"><span class="hs-identifier">spills</span></a></a><span> </span><a name="local-6989586621684901638"><a href="#local-6989586621684901638"><span class="hs-identifier">alloc</span></a></a><span> </span><a name="local-6989586621684901639"><a href="#local-6989586621684901639"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621684901640"><a href="#local-6989586621684901640"><span class="hs-identifier">rs</span></a></a><span> </span><a name="local-6989586621684901641"><a href="#local-6989586621684901641"><span class="hs-identifier">assig</span></a></a><span> </span><a name="local-6989586621684901642"><a href="#local-6989586621684901642"><span class="hs-identifier">spill_loc</span></a></a><span>
</span><a name="line-799"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>   </span><a name="local-6989586621684901643"><a href="#local-6989586621684901643"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-800"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901644"><a href="#local-6989586621684901644"><span class="hs-identifier">platform</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621684901643"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-801"></a><span>        </span><a name="local-6989586621684901645"><a href="#local-6989586621684901645"><span class="hs-identifier">freeRegs</span></a></a><span>                </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RegAlloc.Linear.State.html#getFreeRegsR"><span class="hs-identifier hs-var">getFreeRegsR</span></a><span>
</span><a name="line-802"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901646"><a href="#local-6989586621684901646"><span class="hs-identifier">freeRegs_thisClass</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RegAlloc.Linear.FreeRegs.html#frGetFreeRegs"><span class="hs-identifier hs-var">frGetFreeRegs</span></a><span> </span><a href="#local-6989586621684901644"><span class="hs-identifier hs-var">platform</span></a><span> </span><span class="hs-special">(</span><a href="Reg.html#classOfVirtualReg"><span class="hs-identifier hs-var">classOfVirtualReg</span></a><span> </span><a href="#local-6989586621684901639"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684901645"><span class="hs-identifier hs-var">freeRegs</span></a><span>
</span><a name="line-803"></a><span>
</span><a name="line-804"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684901646"><span class="hs-identifier hs-var">freeRegs_thisClass</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-805"></a><span>
</span><a name="line-806"></a><span>         </span><span class="hs-comment">-- case (2): we have a free register</span><span>
</span><a name="line-807"></a><span>         </span><span class="hs-special">(</span><a name="local-6989586621684901647"><a href="#local-6989586621684901647"><span class="hs-identifier">my_reg</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-808"></a><span>           </span><span class="hs-keyword">do</span><span>   </span><a name="local-6989586621684901648"><a href="#local-6989586621684901648"><span class="hs-identifier">spills'</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RegAlloc.Linear.Main.html#loadTemp"><span class="hs-identifier hs-var">loadTemp</span></a><span> </span><a href="#local-6989586621684901639"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621684901642"><span class="hs-identifier hs-var">spill_loc</span></a><span> </span><a href="#local-6989586621684901647"><span class="hs-identifier hs-var">my_reg</span></a><span> </span><a href="#local-6989586621684901637"><span class="hs-identifier hs-var">spills</span></a><span>
</span><a name="line-809"></a><span>
</span><a name="line-810"></a><span>                </span><a href="RegAlloc.Linear.State.html#setAssigR"><span class="hs-identifier hs-var">setAssigR</span></a><span>       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">addToUFM</span><span> </span><a href="#local-6989586621684901641"><span class="hs-identifier hs-var">assig</span></a><span> </span><a href="#local-6989586621684901639"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">$!</span><span> </span><a href="RegAlloc.Linear.Main.html#newLocation"><span class="hs-identifier hs-var">newLocation</span></a><span> </span><a href="#local-6989586621684901642"><span class="hs-identifier hs-var">spill_loc</span></a><span> </span><a href="#local-6989586621684901647"><span class="hs-identifier hs-var">my_reg</span></a><span class="hs-special">)</span><span>
</span><a name="line-811"></a><span>                </span><a href="RegAlloc.Linear.State.html#setFreeRegsR"><span class="hs-identifier hs-var">setFreeRegsR</span></a><span> </span><span class="hs-operator hs-var">$</span><span>  </span><a href="RegAlloc.Linear.FreeRegs.html#frAllocateReg"><span class="hs-identifier hs-var">frAllocateReg</span></a><span> </span><a href="#local-6989586621684901644"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684901647"><span class="hs-identifier hs-var">my_reg</span></a><span> </span><a href="#local-6989586621684901645"><span class="hs-identifier hs-var">freeRegs</span></a><span>
</span><a name="line-812"></a><span>
</span><a name="line-813"></a><span>                </span><a href="RegAlloc.Linear.Main.html#allocateRegsAndSpill"><span class="hs-identifier hs-var">allocateRegsAndSpill</span></a><span> </span><a href="#local-6989586621684901635"><span class="hs-identifier hs-var">reading</span></a><span> </span><a href="#local-6989586621684901636"><span class="hs-identifier hs-var">keep</span></a><span> </span><a href="#local-6989586621684901648"><span class="hs-identifier hs-var">spills'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684901647"><span class="hs-identifier hs-var">my_reg</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684901638"><span class="hs-identifier hs-var">alloc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684901640"><span class="hs-identifier hs-var">rs</span></a><span>
</span><a name="line-814"></a><span>
</span><a name="line-815"></a><span>
</span><a name="line-816"></a><span>          </span><span class="hs-comment">-- case (3): we need to push something out to free up a register</span><span>
</span><a name="line-817"></a><span>         </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-818"></a><span>           </span><span class="hs-keyword">do</span><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901649"><a href="#local-6989586621684901649"><span class="hs-identifier">inRegOrBoth</span></a></a><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.Base.html#InReg"><span class="hs-identifier hs-var">InReg</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-819"></a><span>                    </span><span class="hs-identifier">inRegOrBoth</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.Base.html#InBoth"><span class="hs-identifier hs-var">InBoth</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-820"></a><span>                    </span><span class="hs-identifier">inRegOrBoth</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-821"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901650"><a href="#local-6989586621684901650"><span class="hs-identifier">candidates'</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-822"></a><span>                      </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier hs-var">delListFromUFM</span><span> </span><a href="#local-6989586621684901636"><span class="hs-identifier hs-var">keep</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-823"></a><span>                      </span><span class="hs-identifier hs-var">filterUFM</span><span> </span><a href="#local-6989586621684901649"><span class="hs-identifier hs-var">inRegOrBoth</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-824"></a><span>                      </span><a href="#local-6989586621684901641"><span class="hs-identifier hs-var">assig</span></a><span>
</span><a name="line-825"></a><span>                      </span><span class="hs-comment">-- This is non-deterministic but we do not</span><span>
</span><a name="line-826"></a><span>                      </span><span class="hs-comment">-- currently support deterministic code-generation.</span><span>
</span><a name="line-827"></a><span>                      </span><span class="hs-comment">-- See Note [Unique Determinism and code generation]</span><span>
</span><a name="line-828"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901651"><a href="#local-6989586621684901651"><span class="hs-identifier">candidates</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nonDetUFMToList</span><span> </span><a href="#local-6989586621684901650"><span class="hs-identifier hs-var">candidates'</span></a><span>
</span><a name="line-829"></a><span>
</span><a name="line-830"></a><span>                </span><span class="hs-comment">-- the vregs we could kick out that are already in a slot</span><span>
</span><a name="line-831"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901652"><a href="#local-6989586621684901652"><span class="hs-identifier">candidates_inBoth</span></a></a><span>
</span><a name="line-832"></a><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684901653"><span class="hs-identifier hs-var">temp</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684901654"><span class="hs-identifier hs-var">reg</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684901655"><span class="hs-identifier hs-var">mem</span></a><span class="hs-special">)</span><span>
</span><a name="line-833"></a><span>                          </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684901653"><a href="#local-6989586621684901653"><span class="hs-identifier">temp</span></a></a><span class="hs-special">,</span><span> </span><a href="RegAlloc.Linear.Base.html#InBoth"><span class="hs-identifier hs-var">InBoth</span></a><span> </span><a name="local-6989586621684901654"><a href="#local-6989586621684901654"><span class="hs-identifier">reg</span></a></a><span> </span><a name="local-6989586621684901655"><a href="#local-6989586621684901655"><span class="hs-identifier">mem</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684901651"><span class="hs-identifier hs-var">candidates</span></a><span>
</span><a name="line-834"></a><span>                          </span><span class="hs-special">,</span><span> </span><a href="TargetReg.html#targetClassOfRealReg"><span class="hs-identifier hs-var">targetClassOfRealReg</span></a><span> </span><a href="#local-6989586621684901644"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684901654"><span class="hs-identifier hs-var">reg</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Reg.html#classOfVirtualReg"><span class="hs-identifier hs-var">classOfVirtualReg</span></a><span> </span><a href="#local-6989586621684901639"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-835"></a><span>
</span><a name="line-836"></a><span>                </span><span class="hs-comment">-- the vregs we could kick out that are only in a reg</span><span>
</span><a name="line-837"></a><span>                </span><span class="hs-comment">--      this would require writing the reg to a new slot before using it.</span><span>
</span><a name="line-838"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901656"><a href="#local-6989586621684901656"><span class="hs-identifier">candidates_inReg</span></a></a><span>
</span><a name="line-839"></a><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684901657"><span class="hs-identifier hs-var">temp</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684901658"><span class="hs-identifier hs-var">reg</span></a><span class="hs-special">)</span><span>
</span><a name="line-840"></a><span>                          </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684901657"><a href="#local-6989586621684901657"><span class="hs-identifier">temp</span></a></a><span class="hs-special">,</span><span> </span><a href="RegAlloc.Linear.Base.html#InReg"><span class="hs-identifier hs-var">InReg</span></a><span> </span><a name="local-6989586621684901658"><a href="#local-6989586621684901658"><span class="hs-identifier">reg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684901651"><span class="hs-identifier hs-var">candidates</span></a><span>
</span><a name="line-841"></a><span>                          </span><span class="hs-special">,</span><span> </span><a href="TargetReg.html#targetClassOfRealReg"><span class="hs-identifier hs-var">targetClassOfRealReg</span></a><span> </span><a href="#local-6989586621684901644"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684901658"><span class="hs-identifier hs-var">reg</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Reg.html#classOfVirtualReg"><span class="hs-identifier hs-var">classOfVirtualReg</span></a><span> </span><a href="#local-6989586621684901639"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-842"></a><span>
</span><a name="line-843"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901659"><a href="#local-6989586621684901659"><span class="hs-identifier">result</span></a></a><span>
</span><a name="line-844"></a><span>
</span><a name="line-845"></a><span>                        </span><span class="hs-comment">-- we have a temporary that is in both register and mem,</span><span>
</span><a name="line-846"></a><span>                        </span><span class="hs-comment">-- just free up its register for use.</span><span>
</span><a name="line-847"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684901660"><a href="#local-6989586621684901660"><span class="hs-identifier">temp</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684901661"><a href="#local-6989586621684901661"><span class="hs-identifier">my_reg</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684901662"><a href="#local-6989586621684901662"><span class="hs-identifier">slot</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684901652"><span class="hs-identifier hs-var">candidates_inBoth</span></a><span>
</span><a name="line-848"></a><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>    </span><a name="local-6989586621684901663"><a href="#local-6989586621684901663"><span class="hs-identifier">spills'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RegAlloc.Linear.Main.html#loadTemp"><span class="hs-identifier hs-var">loadTemp</span></a><span> </span><a href="#local-6989586621684901639"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621684901642"><span class="hs-identifier hs-var">spill_loc</span></a><span> </span><a href="#local-6989586621684901661"><span class="hs-identifier hs-var">my_reg</span></a><span> </span><a href="#local-6989586621684901637"><span class="hs-identifier hs-var">spills</span></a><span>
</span><a name="line-849"></a><span>                                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901664"><a href="#local-6989586621684901664"><span class="hs-identifier">assig1</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addToUFM</span><span> </span><a href="#local-6989586621684901641"><span class="hs-identifier hs-var">assig</span></a><span> </span><a href="#local-6989586621684901660"><span class="hs-identifier hs-var">temp</span></a><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.Base.html#InMem"><span class="hs-identifier hs-var">InMem</span></a><span> </span><a href="#local-6989586621684901662"><span class="hs-identifier hs-var">slot</span></a><span class="hs-special">)</span><span>
</span><a name="line-850"></a><span>                                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901665"><a href="#local-6989586621684901665"><span class="hs-identifier">assig2</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addToUFM</span><span> </span><a href="#local-6989586621684901664"><span class="hs-identifier hs-var">assig1</span></a><span> </span><a href="#local-6989586621684901639"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">$!</span><span> </span><a href="RegAlloc.Linear.Main.html#newLocation"><span class="hs-identifier hs-var">newLocation</span></a><span> </span><a href="#local-6989586621684901642"><span class="hs-identifier hs-var">spill_loc</span></a><span> </span><a href="#local-6989586621684901661"><span class="hs-identifier hs-var">my_reg</span></a><span>
</span><a name="line-851"></a><span>
</span><a name="line-852"></a><span>                                </span><a href="RegAlloc.Linear.State.html#setAssigR"><span class="hs-identifier hs-var">setAssigR</span></a><span> </span><a href="#local-6989586621684901665"><span class="hs-identifier hs-var">assig2</span></a><span>
</span><a name="line-853"></a><span>                                </span><a href="RegAlloc.Linear.Main.html#allocateRegsAndSpill"><span class="hs-identifier hs-var">allocateRegsAndSpill</span></a><span> </span><a href="#local-6989586621684901635"><span class="hs-identifier hs-var">reading</span></a><span> </span><a href="#local-6989586621684901636"><span class="hs-identifier hs-var">keep</span></a><span> </span><a href="#local-6989586621684901663"><span class="hs-identifier hs-var">spills'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684901661"><span class="hs-identifier hs-var">my_reg</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684901638"><span class="hs-identifier hs-var">alloc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684901640"><span class="hs-identifier hs-var">rs</span></a><span>
</span><a name="line-854"></a><span>
</span><a name="line-855"></a><span>                        </span><span class="hs-comment">-- otherwise, we need to spill a temporary that currently</span><span>
</span><a name="line-856"></a><span>                        </span><span class="hs-comment">-- resides in a register.</span><span>
</span><a name="line-857"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684901666"><a href="#local-6989586621684901666"><span class="hs-identifier">temp_to_push_out</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684901667"><a href="#local-6989586621684901667"><span class="hs-identifier">my_reg</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Reg.html#RealReg"><span class="hs-identifier hs-type">RealReg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-858"></a><span>                                        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684901656"><span class="hs-identifier hs-var">candidates_inReg</span></a><span>
</span><a name="line-859"></a><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-860"></a><span>                                </span><span class="hs-special">(</span><a name="local-6989586621684901668"><a href="#local-6989586621684901668"><span class="hs-identifier">spill_insn</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684901669"><a href="#local-6989586621684901669"><span class="hs-identifier">slot</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RegAlloc.Linear.State.html#spillR"><span class="hs-identifier hs-var">spillR</span></a><span> </span><span class="hs-special">(</span><a href="Reg.html#RegReal"><span class="hs-identifier hs-var">RegReal</span></a><span> </span><a href="#local-6989586621684901667"><span class="hs-identifier hs-var">my_reg</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684901666"><span class="hs-identifier hs-var">temp_to_push_out</span></a><span>
</span><a name="line-861"></a><span>                                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901670"><a href="#local-6989586621684901670"><span class="hs-identifier">spill_store</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621684901635"><span class="hs-identifier hs-var">reading</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">reverse</span><span class="hs-special">)</span><span>
</span><a name="line-862"></a><span>                                                        </span><span class="hs-special">[</span><span> </span><span class="hs-comment">-- COMMENT (fsLit &quot;spill alloc&quot;)</span><span>
</span><a name="line-863"></a><span>                                                           </span><a href="#local-6989586621684901668"><span class="hs-identifier hs-var">spill_insn</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-864"></a><span>
</span><a name="line-865"></a><span>                                </span><span class="hs-comment">-- record that this temp was spilled</span><span>
</span><a name="line-866"></a><span>                                </span><a href="RegAlloc.Linear.State.html#recordSpill"><span class="hs-identifier hs-var">recordSpill</span></a><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.Base.html#SpillAlloc"><span class="hs-identifier hs-var">SpillAlloc</span></a><span> </span><a href="#local-6989586621684901666"><span class="hs-identifier hs-var">temp_to_push_out</span></a><span class="hs-special">)</span><span>
</span><a name="line-867"></a><span>
</span><a name="line-868"></a><span>                                </span><span class="hs-comment">-- update the register assignment</span><span>
</span><a name="line-869"></a><span>                                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901671"><a href="#local-6989586621684901671"><span class="hs-identifier">assig1</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addToUFM</span><span> </span><a href="#local-6989586621684901641"><span class="hs-identifier hs-var">assig</span></a><span> </span><a href="#local-6989586621684901666"><span class="hs-identifier hs-var">temp_to_push_out</span></a><span>   </span><span class="hs-special">(</span><a href="RegAlloc.Linear.Base.html#InMem"><span class="hs-identifier hs-var">InMem</span></a><span> </span><a href="#local-6989586621684901669"><span class="hs-identifier hs-var">slot</span></a><span class="hs-special">)</span><span>
</span><a name="line-870"></a><span>                                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684901672"><a href="#local-6989586621684901672"><span class="hs-identifier">assig2</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addToUFM</span><span> </span><a href="#local-6989586621684901671"><span class="hs-identifier hs-var">assig1</span></a><span> </span><a href="#local-6989586621684901639"><span class="hs-identifier hs-var">r</span></a><span>                 </span><span class="hs-operator hs-var">$!</span><span> </span><a href="RegAlloc.Linear.Main.html#newLocation"><span class="hs-identifier hs-var">newLocation</span></a><span> </span><a href="#local-6989586621684901642"><span class="hs-identifier hs-var">spill_loc</span></a><span> </span><a href="#local-6989586621684901667"><span class="hs-identifier hs-var">my_reg</span></a><span>
</span><a name="line-871"></a><span>                                </span><a href="RegAlloc.Linear.State.html#setAssigR"><span class="hs-identifier hs-var">setAssigR</span></a><span> </span><a href="#local-6989586621684901672"><span class="hs-identifier hs-var">assig2</span></a><span>
</span><a name="line-872"></a><span>
</span><a name="line-873"></a><span>                                </span><span class="hs-comment">-- if need be, load up a spilled temp into the reg we've just freed up.</span><span>
</span><a name="line-874"></a><span>                                </span><a name="local-6989586621684901673"><a href="#local-6989586621684901673"><span class="hs-identifier">spills'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RegAlloc.Linear.Main.html#loadTemp"><span class="hs-identifier hs-var">loadTemp</span></a><span> </span><a href="#local-6989586621684901639"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621684901642"><span class="hs-identifier hs-var">spill_loc</span></a><span> </span><a href="#local-6989586621684901667"><span class="hs-identifier hs-var">my_reg</span></a><span> </span><a href="#local-6989586621684901637"><span class="hs-identifier hs-var">spills</span></a><span>
</span><a name="line-875"></a><span>
</span><a name="line-876"></a><span>                                </span><a href="RegAlloc.Linear.Main.html#allocateRegsAndSpill"><span class="hs-identifier hs-var">allocateRegsAndSpill</span></a><span> </span><a href="#local-6989586621684901635"><span class="hs-identifier hs-var">reading</span></a><span> </span><a href="#local-6989586621684901636"><span class="hs-identifier hs-var">keep</span></a><span>
</span><a name="line-877"></a><span>                                        </span><span class="hs-special">(</span><a href="#local-6989586621684901670"><span class="hs-identifier hs-var">spill_store</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684901673"><span class="hs-identifier hs-var">spills'</span></a><span class="hs-special">)</span><span>
</span><a name="line-878"></a><span>                                        </span><span class="hs-special">(</span><a href="#local-6989586621684901667"><span class="hs-identifier hs-var">my_reg</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684901638"><span class="hs-identifier hs-var">alloc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684901640"><span class="hs-identifier hs-var">rs</span></a><span>
</span><a name="line-879"></a><span>
</span><a name="line-880"></a><span>
</span><a name="line-881"></a><span>                        </span><span class="hs-comment">-- there wasn't anything to spill, so we're screwed.</span><span>
</span><a name="line-882"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-883"></a><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;RegAllocLinear.allocRegsAndSpill: no spill candidates\n&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-884"></a><span>                        </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">vcat</span><span>
</span><a name="line-885"></a><span>                                </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;allocating vreg:  &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621684901639"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-886"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;assignment:       &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684901641"><span class="hs-identifier hs-var">assig</span></a><span>
</span><a name="line-887"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;freeRegs:         &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621684901645"><span class="hs-identifier hs-var">freeRegs</span></a><span class="hs-special">)</span><span>
</span><a name="line-888"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;initFreeRegs:     &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.FreeRegs.html#frInitFreeRegs"><span class="hs-identifier hs-var">frInitFreeRegs</span></a><span> </span><a href="#local-6989586621684901644"><span class="hs-identifier hs-var">platform</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">asTypeOf</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684901645"><span class="hs-identifier hs-var">freeRegs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-889"></a><span>
</span><a name="line-890"></a><span>                </span><a href="#local-6989586621684901659"><span class="hs-identifier hs-var">result</span></a><span>
</span><a name="line-891"></a><span>
</span><a name="line-892"></a><span>
</span><a name="line-893"></a><span class="hs-comment">-- | Calculate a new location after a register has been loaded.</span><span>
</span><a name="line-894"></a><span class="hs-identifier">newLocation</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RegAlloc.Linear.Main.html#SpillLoc"><span class="hs-identifier hs-type">SpillLoc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reg.html#RealReg"><span class="hs-identifier hs-type">RealReg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RegAlloc.Linear.Base.html#Loc"><span class="hs-identifier hs-type">Loc</span></a><span>
</span><a name="line-895"></a><span class="hs-comment">-- if the tmp was read from a slot, then now its in a reg as well</span><span>
</span><a name="line-896"></a><a name="newLocation"><a href="RegAlloc.Linear.Main.html#newLocation"><span class="hs-identifier">newLocation</span></a></a><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.Main.html#ReadMem"><span class="hs-identifier hs-var">ReadMem</span></a><span> </span><a name="local-6989586621684901674"><a href="#local-6989586621684901674"><span class="hs-identifier">slot</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684901675"><a href="#local-6989586621684901675"><span class="hs-identifier">my_reg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RegAlloc.Linear.Base.html#InBoth"><span class="hs-identifier hs-var">InBoth</span></a><span> </span><a href="#local-6989586621684901675"><span class="hs-identifier hs-var">my_reg</span></a><span> </span><a href="#local-6989586621684901674"><span class="hs-identifier hs-var">slot</span></a><span>
</span><a name="line-897"></a><span class="hs-comment">-- writes will always result in only the register being available</span><span>
</span><a name="line-898"></a><span class="hs-identifier">newLocation</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684901676"><a href="#local-6989586621684901676"><span class="hs-identifier">my_reg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RegAlloc.Linear.Base.html#InReg"><span class="hs-identifier hs-var">InReg</span></a><span> </span><a href="#local-6989586621684901676"><span class="hs-identifier hs-var">my_reg</span></a><span>
</span><a name="line-899"></a><span>
</span><a name="line-900"></a><span class="hs-comment">-- | Load up a spilled temporary if we need to (read from memory).</span><span>
</span><a name="line-901"></a><span class="hs-identifier">loadTemp</span><span>
</span><a name="line-902"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Instruction.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a><span> </span><a href="#local-6989586621684901391"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">)</span><span>
</span><a name="line-903"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Reg.html#VirtualReg"><span class="hs-identifier hs-type">VirtualReg</span></a><span>   </span><span class="hs-comment">-- the temp being loaded</span><span>
</span><a name="line-904"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RegAlloc.Linear.Main.html#SpillLoc"><span class="hs-identifier hs-type">SpillLoc</span></a><span>     </span><span class="hs-comment">-- the current location of this temp</span><span>
</span><a name="line-905"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Reg.html#RealReg"><span class="hs-identifier hs-type">RealReg</span></a><span>      </span><span class="hs-comment">-- the hreg to load the temp into</span><span>
</span><a name="line-906"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684901391"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span>
</span><a name="line-907"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RegAlloc.Linear.State.html#RegM"><span class="hs-identifier hs-type">RegM</span></a><span> </span><a href="#local-6989586621684901392"><span class="hs-identifier hs-type">freeRegs</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684901391"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span>
</span><a name="line-908"></a><span>
</span><a name="line-909"></a><a name="loadTemp"><a href="RegAlloc.Linear.Main.html#loadTemp"><span class="hs-identifier">loadTemp</span></a></a><span> </span><a name="local-6989586621684901677"><a href="#local-6989586621684901677"><span class="hs-identifier">vreg</span></a></a><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.Main.html#ReadMem"><span class="hs-identifier hs-var">ReadMem</span></a><span> </span><a name="local-6989586621684901678"><a href="#local-6989586621684901678"><span class="hs-identifier">slot</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684901679"><a href="#local-6989586621684901679"><span class="hs-identifier">hreg</span></a></a><span> </span><a name="local-6989586621684901680"><a href="#local-6989586621684901680"><span class="hs-identifier">spills</span></a></a><span>
</span><a name="line-910"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-911"></a><span>        </span><a name="local-6989586621684901681"><a href="#local-6989586621684901681"><span class="hs-identifier">insn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RegAlloc.Linear.State.html#loadR"><span class="hs-identifier hs-var">loadR</span></a><span> </span><span class="hs-special">(</span><a href="Reg.html#RegReal"><span class="hs-identifier hs-var">RegReal</span></a><span> </span><a href="#local-6989586621684901679"><span class="hs-identifier hs-var">hreg</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684901678"><span class="hs-identifier hs-var">slot</span></a><span>
</span><a name="line-912"></a><span>        </span><a href="RegAlloc.Linear.State.html#recordSpill"><span class="hs-identifier hs-var">recordSpill</span></a><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.Base.html#SpillLoad"><span class="hs-identifier hs-var">SpillLoad</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">getUnique</span><span> </span><a href="#local-6989586621684901677"><span class="hs-identifier hs-var">vreg</span></a><span class="hs-special">)</span><span>
</span><a name="line-913"></a><span>        </span><span class="hs-identifier hs-var">return</span><span>  </span><span class="hs-operator hs-var">$</span><span>  </span><span class="hs-comment">{- COMMENT (fsLit &quot;spill load&quot;) : -}</span><span> </span><a href="#local-6989586621684901681"><span class="hs-identifier hs-var">insn</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684901680"><span class="hs-identifier hs-var">spills</span></a><span>
</span><a name="line-914"></a><span>
</span><a name="line-915"></a><span class="hs-identifier">loadTemp</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684901682"><a href="#local-6989586621684901682"><span class="hs-identifier">spills</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-916"></a><span>   </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684901682"><span class="hs-identifier hs-var">spills</span></a><span>
</span><a name="line-917"></a><span>
</span><a name="line-918"></a></pre></body></html>